<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 5791:c2c24182c9312dddfe5c85a5be5eb5fe23995845</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ c2c24182c9312dddfe5c85a5be5eb5fe23995845" />
<meta property="og:url" content="/comm-central/rev/c2c24182c9312dddfe5c85a5be5eb5fe23995845" />
<meta property="og:description" content="Bug 377319 Convert mailnews/imap to the external API r=Neil sr=bienvenu" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / c2c24182c9312dddfe5c85a5be5eb5fe23995845 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/c2c24182c9312dddfe5c85a5be5eb5fe23995845">shortlog</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/c2c24182c9312dddfe5c85a5be5eb5fe23995845">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845">files</a> |
changeset |
<a href="/comm-central/raw-rev/c2c24182c9312dddfe5c85a5be5eb5fe23995845">raw</a>  | <a href="/comm-central/archive/c2c24182c9312dddfe5c85a5be5eb5fe23995845.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=377319">Bug 377319</a> Convert mailnews/imap to the external API r=Neil sr=bienvenu
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#74;&#97;&#110;&#32;&#72;&#111;&#114;&#97;&#107;&#32;&#60;&#106;&#104;&#111;&#114;&#97;&#107;&#64;&#114;&#101;&#100;&#104;&#97;&#116;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 10 Jun 2010 11:10:27 +0100</td></tr>

<tr>
 <td>changeset 5791</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/c2c24182c9312dddfe5c85a5be5eb5fe23995845">c2c24182c9312dddfe5c85a5be5eb5fe23995845</a></td>
</tr>



<tr>
<td>parent 5790</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/49782a242a72683dbe6b8780f8b320fb6ac56f1f">49782a242a72683dbe6b8780f8b320fb6ac56f1f</a>
</td>
</tr>

<tr>
<td>child 5792</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7d85c2f48e77ebf2752a9de10dc4b9a6a67d2a9d">7d85c2f48e77ebf2752a9de10dc4b9a6a67d2a9d</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=c2c24182c9312dddfe5c85a5be5eb5fe23995845">4489</a></td></tr>
<tr><td>push user</td><td>neil@parkwaycc.co.uk</td></tr>
<tr><td>push date</td><td class="date age">Thu, 10 Jun 2010 10:10:37 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@c2c24182c931 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c2c24182c9312dddfe5c85a5be5eb5fe23995845">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=c2c24182c9312dddfe5c85a5be5eb5fe23995845&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c2c24182c9312dddfe5c85a5be5eb5fe23995845&newProject=comm-central&newRevision=12981f9325ed8d19fe8c6b3cf355770419e15b65&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c2c24182c9312dddfe5c85a5be5eb5fe23995845&newProject=comm-central&newRevision=12981f9325ed8d19fe8c6b3cf355770419e15b65&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=c2c24182c9312dddfe5c85a5be5eb5fe23995845&newProject=comm-central&newRevision=12981f9325ed8d19fe8c6b3cf355770419e15b65&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Neil%29&revcount=50">Neil</a>, <a href="/comm-central/log?rev=reviewer%28bienvenu%29&revcount=50">bienvenu</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=377319">377319</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=377319">Bug 377319</a> Convert mailnews/imap to the external API r=Neil sr=bienvenu</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncManager.cpp">mailnews/imap/src/nsAutoSyncManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncManager.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncManager.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncManager.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncManager.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncManager.h">mailnews/imap/src/nsAutoSyncManager.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncManager.h">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncManager.h">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncManager.h">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncManager.h">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncManager.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncState.cpp">mailnews/imap/src/nsAutoSyncState.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncState.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncState.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncState.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncState.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncState.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncState.h">mailnews/imap/src/nsAutoSyncState.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncState.h">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncState.h">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncState.h">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncState.h">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsAutoSyncState.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPBodyShell.cpp">mailnews/imap/src/nsIMAPBodyShell.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPBodyShell.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPBodyShell.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPBodyShell.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPBodyShell.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPBodyShell.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPBodyShell.h">mailnews/imap/src/nsIMAPBodyShell.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPBodyShell.h">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPBodyShell.h">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPBodyShell.h">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPBodyShell.h">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPBodyShell.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPGenericParser.cpp">mailnews/imap/src/nsIMAPGenericParser.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPGenericParser.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPGenericParser.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPGenericParser.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPGenericParser.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPGenericParser.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPHostSessionList.cpp">mailnews/imap/src/nsIMAPHostSessionList.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPHostSessionList.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPHostSessionList.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPHostSessionList.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPHostSessionList.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPHostSessionList.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPNamespace.cpp">mailnews/imap/src/nsIMAPNamespace.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPNamespace.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPNamespace.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPNamespace.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPNamespace.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsIMAPNamespace.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapIncomingServer.cpp">mailnews/imap/src/nsImapIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapOfflineSync.cpp">mailnews/imap/src/nsImapOfflineSync.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapOfflineSync.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapOfflineSync.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapOfflineSync.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapOfflineSync.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapOfflineSync.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapProtocol.h">mailnews/imap/src/nsImapProtocol.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapProtocol.h">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapProtocol.h">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapProtocol.h">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapProtocol.h">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapProtocol.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapSearchResults.cpp">mailnews/imap/src/nsImapSearchResults.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapSearchResults.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapSearchResults.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapSearchResults.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapSearchResults.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapSearchResults.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapServerResponseParser.cpp">mailnews/imap/src/nsImapServerResponseParser.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapServerResponseParser.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapServerResponseParser.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapServerResponseParser.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapServerResponseParser.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapServerResponseParser.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapServerResponseParser.h">mailnews/imap/src/nsImapServerResponseParser.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapServerResponseParser.h">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapServerResponseParser.h">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapServerResponseParser.h">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapServerResponseParser.h">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapServerResponseParser.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapStringBundle.cpp">mailnews/imap/src/nsImapStringBundle.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapStringBundle.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapStringBundle.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapStringBundle.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapStringBundle.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapStringBundle.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUndoTxn.cpp">mailnews/imap/src/nsImapUndoTxn.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUndoTxn.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUndoTxn.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUndoTxn.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUndoTxn.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUndoTxn.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUrl.cpp">mailnews/imap/src/nsImapUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUrl.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUrl.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUrl.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUrl.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUtils.cpp">mailnews/imap/src/nsImapUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUtils.cpp">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUtils.cpp">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUtils.cpp">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUtils.cpp">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUtils.h">mailnews/imap/src/nsImapUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUtils.h">file</a> |
<a href="/comm-central/annotate/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUtils.h">annotate</a> |
<a href="/comm-central/diff/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUtils.h">diff</a> |
<a href="/comm-central/comparison/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUtils.h">comparison</a> |
<a href="/comm-central/log/c2c24182c9312dddfe5c85a5be5eb5fe23995845/mailnews/imap/src/nsImapUtils.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/imap/src/nsAutoSyncManager.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/imap/src/nsAutoSyncManager.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -47,16 +47,18 @@</span>
<a href="#l1.4"></a><span id="l1.4"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l1.5"></a><span id="l1.5"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l1.6"></a><span id="l1.6"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l1.7"></a><span id="l1.7"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l1.8"></a><span id="l1.8"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l1.9"></a><span id="l1.9"> #include &quot;nsImapIncomingServer.h&quot;</span>
<a href="#l1.10"></a><span id="l1.10"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l1.11"></a><span id="l1.11"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15"> NS_IMPL_ISUPPORTS1(nsDefaultAutoSyncMsgStrategy, nsIAutoSyncMsgStrategy)</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> const char* kAppIdleNotification = &quot;mail:appIdle&quot;;</span>
<a href="#l1.18"></a><span id="l1.18"> const char* kStartupDoneNotification = &quot;mail-startup-done&quot;;</span>
<a href="#l1.19"></a><span id="l1.19"> PRLogModuleInfo *gAutoSyncLog;</span>
<a href="#l1.20"></a><span id="l1.20"> </span>
<a href="#l1.21"></a><span id="l1.21"> // recommended size of each group of messages per download</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/imap/src/nsAutoSyncManager.h</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/imap/src/nsAutoSyncManager.h</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -33,17 +33,17 @@</span>
<a href="#l2.4"></a><span id="l2.4">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l2.5"></a><span id="l2.5">  *</span>
<a href="#l2.6"></a><span id="l2.6">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> #ifndef nsAutoSyncManager_h__</span>
<a href="#l2.9"></a><span id="l2.9"> #define nsAutoSyncManager_h__</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l2.14"></a><span id="l2.14"> #include &quot;nsCOMArray.h&quot;</span>
<a href="#l2.15"></a><span id="l2.15"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l2.16"></a><span id="l2.16"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l2.17"></a><span id="l2.17"> #include &quot;nsITimer.h&quot;</span>
<a href="#l2.18"></a><span id="l2.18"> #include &quot;nsTObserverArray.h&quot;</span>
<a href="#l2.19"></a><span id="l2.19"> #include &quot;nsIAutoSyncManager.h&quot;</span>
<a href="#l2.20"></a><span id="l2.20"> #include &quot;nsIAutoSyncMsgStrategy.h&quot;</span>
<a href="#l2.21"></a><span id="l2.21"> #include &quot;nsIAutoSyncFolderStrategy.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/imap/src/nsAutoSyncState.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/imap/src/nsAutoSyncState.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -38,16 +38,18 @@</span>
<a href="#l3.4"></a><span id="l3.4"> #include &quot;nsImapMailFolder.h&quot;</span>
<a href="#l3.5"></a><span id="l3.5"> #include &quot;nsMsgImapCID.h&quot;</span>
<a href="#l3.6"></a><span id="l3.6"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l3.7"></a><span id="l3.7"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l3.8"></a><span id="l3.8"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l3.9"></a><span id="l3.9"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l3.10"></a><span id="l3.10"> #include &quot;nsIAutoSyncManager.h&quot;</span>
<a href="#l3.11"></a><span id="l3.11"> #include &quot;nsIAutoSyncMsgStrategy.h&quot;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l3.14"></a><span id="l3.14"> </span>
<a href="#l3.15"></a><span id="l3.15"> extern PRLogModuleInfo *gAutoSyncLog;</span>
<a href="#l3.16"></a><span id="l3.16"> </span>
<a href="#l3.17"></a><span id="l3.17"> MsgStrategyComparatorAdaptor::MsgStrategyComparatorAdaptor(nsIAutoSyncMsgStrategy* aStrategy, </span>
<a href="#l3.18"></a><span id="l3.18">   nsIMsgFolder *aFolder, nsIMsgDatabase *aDatabase) : mStrategy(aStrategy), mFolder(aFolder), </span>
<a href="#l3.19"></a><span id="l3.19">     mDatabase(aDatabase)</span>
<a href="#l3.20"></a><span id="l3.20"> {</span>
<a href="#l3.21"></a><span id="l3.21"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/imap/src/nsAutoSyncState.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/imap/src/nsAutoSyncState.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -39,16 +39,17 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsIAutoSyncState.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsIAutoSyncManager.h&quot; </span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsWeakPtr.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsTArray.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;prlog.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+#include &quot;nsIWeakReferenceUtils.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13"> </span>
<a href="#l4.14"></a><span id="l4.14"> class nsImapMailFolder;</span>
<a href="#l4.15"></a><span id="l4.15"> class nsIAutoSyncMsgStrategy;</span>
<a href="#l4.16"></a><span id="l4.16"> class nsIMsgDatabase;</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18"> /**</span>
<a href="#l4.19"></a><span id="l4.19">  * An adaptor class to make msg strategy nsTArray.Sort()</span>
<a href="#l4.20"></a><span id="l4.20">  * compatible.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/imap/src/nsIMAPBodyShell.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/imap/src/nsIMAPBodyShell.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -39,16 +39,17 @@</span>
<a href="#l5.4"></a><span id="l5.4"> #include &quot;nsIMAPHostSessionList.h&quot;</span>
<a href="#l5.5"></a><span id="l5.5"> #include &quot;nsIMAPBodyShell.h&quot;</span>
<a href="#l5.6"></a><span id="l5.6"> #include &quot;nsImapProtocol.h&quot;</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> #include &quot;nsMimeTypes.h&quot;</span>
<a href="#l5.9"></a><span id="l5.9"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l5.11"></a><span id="l5.11"> #include &quot;nsITransport.h&quot;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l5.13"></a><span id="l5.13"> </span>
<a href="#l5.14"></a><span id="l5.14"> // need to talk to Rich about this...</span>
<a href="#l5.15"></a><span id="l5.15"> #define	IMAP_EXTERNAL_CONTENT_HEADER &quot;X-Mozilla-IMAP-Part&quot;</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17"> // imapbody.cpp</span>
<a href="#l5.18"></a><span id="l5.18"> // Implementation of the nsIMAPBodyShell and associated classes</span>
<a href="#l5.19"></a><span id="l5.19"> // These are used to parse IMAP BODYSTRUCTURE responses, and intelligently (?)</span>
<a href="#l5.20"></a><span id="l5.20"> // figure out what parts we need to display inline.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/imap/src/nsIMAPBodyShell.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/imap/src/nsIMAPBodyShell.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -38,17 +38,17 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* </span>
<a href="#l6.5"></a><span id="l6.5"> nsIMAPBodyShell and associated classes</span>
<a href="#l6.6"></a><span id="l6.6"> */ </span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> #ifndef IMAPBODY_H</span>
<a href="#l6.9"></a><span id="l6.9"> #define IMAPBODY_H</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11"> #include &quot;nsImapCore.h&quot;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l6.14"></a><span id="l6.14"> #include &quot;nsClassHashtable.h&quot;</span>
<a href="#l6.15"></a><span id="l6.15"> </span>
<a href="#l6.16"></a><span id="l6.16"> class nsImapProtocol;</span>
<a href="#l6.17"></a><span id="l6.17"> </span>
<a href="#l6.18"></a><span id="l6.18"> typedef enum _nsIMAPBodypartType {</span>
<a href="#l6.19"></a><span id="l6.19"> 	IMAP_BODY_MESSAGE_RFC822,</span>
<a href="#l6.20"></a><span id="l6.20"> 	IMAP_BODY_MESSAGE_HEADER,</span>
<a href="#l6.21"></a><span id="l6.21"> 	IMAP_BODY_LEAF,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/imap/src/nsIMAPGenericParser.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/imap/src/nsIMAPGenericParser.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -36,18 +36,17 @@</span>
<a href="#l7.4"></a><span id="l7.4">  *</span>
<a href="#l7.5"></a><span id="l7.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> #include &quot;msgCore.h&quot;  // for pre-compiled headers</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> #include &quot;nsImapCore.h&quot;</span>
<a href="#l7.10"></a><span id="l7.10"> #include &quot;nsImapProtocol.h&quot;</span>
<a href="#l7.11"></a><span id="l7.11"> #include &quot;nsIMAPGenericParser.h&quot;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l7.15"></a><span id="l7.15"> </span>
<a href="#l7.16"></a><span id="l7.16"> ////////////////// nsIMAPGenericParser /////////////////////////</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18"> </span>
<a href="#l7.19"></a><span id="l7.19"> nsIMAPGenericParser::nsIMAPGenericParser() :</span>
<a href="#l7.20"></a><span id="l7.20"> fNextToken(nsnull),</span>
<a href="#l7.21"></a><span id="l7.21"> fCurrentLine(nsnull),</span>
<a href="#l7.22"></a><span id="l7.22"> fLineOfTokens(nsnull),</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineat">@@ -366,17 +365,17 @@ char *nsIMAPGenericParser::CreateQuoted(</span>
<a href="#l7.24"></a><span id="l7.24">       returnString.Cut(charIndex, 1);</span>
<a href="#l7.25"></a><span id="l7.25">       escapeCharsCut++;</span>
<a href="#l7.26"></a><span id="l7.26">     }</span>
<a href="#l7.27"></a><span id="l7.27">   }</span>
<a href="#l7.28"></a><span id="l7.28">   // +2 because of the start and end quotes</span>
<a href="#l7.29"></a><span id="l7.29">   AdvanceTokenizerStartingPoint((fNextToken - fLineOfTokens) +</span>
<a href="#l7.30"></a><span id="l7.30">                                 charIndex + escapeCharsCut + 2);</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-  returnString.Truncate(charIndex);</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+  returnString.SetLength(charIndex);</span>
<a href="#l7.34"></a><span id="l7.34">   return ToNewCString(returnString);</span>
<a href="#l7.35"></a><span id="l7.35"> }</span>
<a href="#l7.36"></a><span id="l7.36"> </span>
<a href="#l7.37"></a><span id="l7.37"> </span>
<a href="#l7.38"></a><span id="l7.38"> // This function leaves us off with fCurrentTokenPlaceHolder immediately after</span>
<a href="#l7.39"></a><span id="l7.39"> // the end of the literal string.  Call AdvanceToNextToken() to get the token</span>
<a href="#l7.40"></a><span id="l7.40"> // after the literal string.</span>
<a href="#l7.41"></a><span id="l7.41"> // RFC3501:  literal = &quot;{&quot; number &quot;}&quot; CRLF *CHAR8</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/src/nsIMAPHostSessionList.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/src/nsIMAPHostSessionList.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -40,16 +40,18 @@</span>
<a href="#l8.4"></a><span id="l8.4"> #include &quot;nsIMAPHostSessionList.h&quot;</span>
<a href="#l8.5"></a><span id="l8.5"> #include &quot;nsIMAPBodyShell.h&quot;</span>
<a href="#l8.6"></a><span id="l8.6"> #include &quot;nsIMAPNamespace.h&quot;</span>
<a href="#l8.7"></a><span id="l8.7"> #include &quot;nsISupportsUtils.h&quot;</span>
<a href="#l8.8"></a><span id="l8.8"> #include &quot;nsIImapIncomingServer.h&quot;</span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l8.11"></a><span id="l8.11"> #include &quot;nsIObserverService.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14"> </span>
<a href="#l8.15"></a><span id="l8.15"> nsIMAPHostInfo::nsIMAPHostInfo(const char *serverKey,</span>
<a href="#l8.16"></a><span id="l8.16">                                nsIImapIncomingServer *server)</span>
<a href="#l8.17"></a><span id="l8.17"> {</span>
<a href="#l8.18"></a><span id="l8.18">   fServerKey = serverKey;</span>
<a href="#l8.19"></a><span id="l8.19">   NS_ASSERTION(server, &quot;*** Fatal null imap incoming server...\n&quot;);</span>
<a href="#l8.20"></a><span id="l8.20">   server-&gt;GetServerDirectory(fOnlineDir);</span>
<a href="#l8.21"></a><span id="l8.21">   fNextHost = NULL;</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineat">@@ -204,17 +206,17 @@ NS_IMETHODIMP nsIMAPHostSessionList::Set</span>
<a href="#l8.23"></a><span id="l8.23">   return (host == NULL) ? NS_ERROR_ILLEGAL_VALUE : NS_OK;</span>
<a href="#l8.24"></a><span id="l8.24"> }</span>
<a href="#l8.25"></a><span id="l8.25"> </span>
<a href="#l8.26"></a><span id="l8.26"> NS_IMETHODIMP nsIMAPHostSessionList::GetPasswordForHost(const char *serverKey, nsString &amp;result)</span>
<a href="#l8.27"></a><span id="l8.27"> {</span>
<a href="#l8.28"></a><span id="l8.28">   PR_EnterMonitor(gCachedHostInfoMonitor);</span>
<a href="#l8.29"></a><span id="l8.29">   nsIMAPHostInfo *host = FindHost(serverKey);</span>
<a href="#l8.30"></a><span id="l8.30">   if (host)</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineminus">-    CopyASCIItoUTF16(host-&gt;fCachedPassword, result);</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+    CopyASCIItoUTF16(nsDependentCString(host-&gt;fCachedPassword), result);</span>
<a href="#l8.33"></a><span id="l8.33">   PR_ExitMonitor(gCachedHostInfoMonitor);</span>
<a href="#l8.34"></a><span id="l8.34">   return (host == NULL) ? NS_ERROR_ILLEGAL_VALUE : NS_OK;</span>
<a href="#l8.35"></a><span id="l8.35"> }</span>
<a href="#l8.36"></a><span id="l8.36"> </span>
<a href="#l8.37"></a><span id="l8.37"> NS_IMETHODIMP nsIMAPHostSessionList::SetPasswordForHost(const char *serverKey, const char *password)</span>
<a href="#l8.38"></a><span id="l8.38"> {</span>
<a href="#l8.39"></a><span id="l8.39">   PR_EnterMonitor(gCachedHostInfoMonitor);</span>
<a href="#l8.40"></a><span id="l8.40">   nsIMAPHostInfo *host = FindHost(serverKey);</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineat">@@ -652,22 +654,22 @@ NS_IMETHODIMP nsIMAPHostSessionList::Get</span>
<a href="#l8.42"></a><span id="l8.42">   PR_EnterMonitor(gCachedHostInfoMonitor);</span>
<a href="#l8.43"></a><span id="l8.43">   nsIMAPHostInfo *host = FindHost(serverKey);</span>
<a href="#l8.44"></a><span id="l8.44">   if (host)</span>
<a href="#l8.45"></a><span id="l8.45">   {</span>
<a href="#l8.46"></a><span id="l8.46">     nsIMAPNamespace *ns = NULL;</span>
<a href="#l8.47"></a><span id="l8.47">     ns = host-&gt;fNamespaceList-&gt;GetDefaultNamespaceOfType(kPersonalNamespace);</span>
<a href="#l8.48"></a><span id="l8.48">     if (ns)</span>
<a href="#l8.49"></a><span id="l8.49">     {</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineminus">-      CopyASCIItoUTF16(ns-&gt;GetPrefix(), result);</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+      CopyASCIItoUTF16(nsDependentCString(ns-&gt;GetPrefix()), result);</span>
<a href="#l8.52"></a><span id="l8.52">       result.AppendLiteral(&quot;INBOX&quot;);</span>
<a href="#l8.53"></a><span id="l8.53">     }</span>
<a href="#l8.54"></a><span id="l8.54">   }</span>
<a href="#l8.55"></a><span id="l8.55">   else</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-    result.SetLength(0);</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+    result.Truncate();</span>
<a href="#l8.58"></a><span id="l8.58">   PR_ExitMonitor(gCachedHostInfoMonitor);</span>
<a href="#l8.59"></a><span id="l8.59">   return (host == NULL) ? NS_ERROR_ILLEGAL_VALUE : NS_OK;</span>
<a href="#l8.60"></a><span id="l8.60"> }</span>
<a href="#l8.61"></a><span id="l8.61"> </span>
<a href="#l8.62"></a><span id="l8.62"> NS_IMETHODIMP nsIMAPHostSessionList::GetShouldAlwaysListInboxForHost(const char* /*serverKey*/, PRBool &amp;result)</span>
<a href="#l8.63"></a><span id="l8.63"> {</span>
<a href="#l8.64"></a><span id="l8.64"> 	result = PR_TRUE;</span>
<a href="#l8.65"></a><span id="l8.65"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/imap/src/nsIMAPNamespace.cpp</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/imap/src/nsIMAPNamespace.cpp</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -37,17 +37,18 @@</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> #include &quot;msgCore.h&quot;  // for pre-compiled headers</span>
<a href="#l9.6"></a><span id="l9.6"> </span>
<a href="#l9.7"></a><span id="l9.7"> #include &quot;nsImapCore.h&quot;</span>
<a href="#l9.8"></a><span id="l9.8"> #include &quot;nsIMAPNamespace.h&quot;</span>
<a href="#l9.9"></a><span id="l9.9"> #include &quot;nsImapProtocol.h&quot;</span>
<a href="#l9.10"></a><span id="l9.10"> #include &quot;nsMsgImapCID.h&quot;</span>
<a href="#l9.11"></a><span id="l9.11"> #include &quot;nsImapUrl.h&quot;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16"> //////////////////// nsIMAPNamespace  /////////////////////////////////////////////////////////////</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18"> static NS_DEFINE_CID(kCImapHostSessionListCID, NS_IIMAPHOSTSESSIONLIST_CID);</span>
<a href="#l9.19"></a><span id="l9.19"> </span>
<a href="#l9.20"></a><span id="l9.20"> nsIMAPNamespace::nsIMAPNamespace(EIMAPNamespaceType type, const char *prefix, char delimiter, PRBool from_prefs)</span>
<a href="#l9.21"></a><span id="l9.21"> {</span>
<a href="#l9.22"></a><span id="l9.22"> 	m_namespaceType = type;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapIncomingServer.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -77,16 +77,19 @@</span>
<a href="#l10.4"></a><span id="l10.4"> #include &quot;nsImapUrl.h&quot;</span>
<a href="#l10.5"></a><span id="l10.5"> #include &quot;nsIMsgProtocolInfo.h&quot;</span>
<a href="#l10.6"></a><span id="l10.6"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l10.7"></a><span id="l10.7"> #include &quot;nsIMAPNamespace.h&quot;</span>
<a href="#l10.8"></a><span id="l10.8"> #include &quot;nsISignatureVerifier.h&quot;</span>
<a href="#l10.9"></a><span id="l10.9"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l10.10"></a><span id="l10.10"> #include &quot;nsITimer.h&quot;</span>
<a href="#l10.11"></a><span id="l10.11"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+#include &quot;nsCRTGlue.h&quot;</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16"> #define PREF_TRASH_FOLDER_NAME &quot;trash_folder_name&quot;</span>
<a href="#l10.17"></a><span id="l10.17"> #define DEFAULT_TRASH_FOLDER_NAME &quot;Trash&quot;</span>
<a href="#l10.18"></a><span id="l10.18"> </span>
<a href="#l10.19"></a><span id="l10.19"> static NS_DEFINE_CID(kImapProtocolCID, NS_IMAPPROTOCOL_CID);</span>
<a href="#l10.20"></a><span id="l10.20"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l10.21"></a><span id="l10.21"> static NS_DEFINE_CID(kSubscribableServerCID, NS_SUBSCRIBABLESERVER_CID);</span>
<a href="#l10.22"></a><span id="l10.22"> static NS_DEFINE_CID(kCImapHostSessionListCID, NS_IIMAPHOSTSESSIONLIST_CID);</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineat">@@ -471,17 +474,18 @@ nsImapIncomingServer::PrepareToRetryUrl(</span>
<a href="#l10.24"></a><span id="l10.24"> NS_IMETHODIMP</span>
<a href="#l10.25"></a><span id="l10.25"> nsImapIncomingServer::RetryUrl(nsIImapUrl *aImapUrl, nsIImapMockChannel *aChannel)</span>
<a href="#l10.26"></a><span id="l10.26"> {</span>
<a href="#l10.27"></a><span id="l10.27">   nsresult rv;</span>
<a href="#l10.28"></a><span id="l10.28">   // Get current thread envent queue</span>
<a href="#l10.29"></a><span id="l10.29">   aImapUrl-&gt;SetMockChannel(aChannel);</span>
<a href="#l10.30"></a><span id="l10.30">   nsCOMPtr &lt;nsIImapProtocol&gt; protocolInstance;</span>
<a href="#l10.31"></a><span id="l10.31">   nsImapProtocol::LogImapUrl(&quot;creating protocol instance to retry queued url&quot;, aImapUrl);</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-  rv = GetImapConnection(NS_GetCurrentThread(), aImapUrl, getter_AddRefs(protocolInstance));</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineplus">+  nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+  rv = GetImapConnection(thread, aImapUrl, getter_AddRefs(protocolInstance));</span>
<a href="#l10.35"></a><span id="l10.35">   if (NS_SUCCEEDED(rv) &amp;&amp; protocolInstance)</span>
<a href="#l10.36"></a><span id="l10.36">   {</span>
<a href="#l10.37"></a><span id="l10.37">     nsCOMPtr&lt;nsIURI&gt; url = do_QueryInterface(aImapUrl, &amp;rv);</span>
<a href="#l10.38"></a><span id="l10.38">     if (NS_SUCCEEDED(rv) &amp;&amp; url)</span>
<a href="#l10.39"></a><span id="l10.39">     {</span>
<a href="#l10.40"></a><span id="l10.40">       nsImapProtocol::LogImapUrl(&quot;retrying  url&quot;, aImapUrl);</span>
<a href="#l10.41"></a><span id="l10.41">       rv = protocolInstance-&gt;LoadImapUrl(url, nsnull); // ### need to save the display consumer.</span>
<a href="#l10.42"></a><span id="l10.42">       NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed running queued url&quot;);</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineat">@@ -953,17 +957,18 @@ nsImapIncomingServer::PerformExpand(nsIM</span>
<a href="#l10.44"></a><span id="l10.44">   nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l10.45"></a><span id="l10.45">   rv = GetRootFolder(getter_AddRefs(rootMsgFolder));</span>
<a href="#l10.46"></a><span id="l10.46">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.47"></a><span id="l10.47">   </span>
<a href="#l10.48"></a><span id="l10.48">   if (!rootMsgFolder) return NS_ERROR_FAILURE;</span>
<a href="#l10.49"></a><span id="l10.49"> </span>
<a href="#l10.50"></a><span id="l10.50">   nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.51"></a><span id="l10.51">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-  rv = imapService-&gt;DiscoverAllFolders(NS_GetCurrentThread(), rootMsgFolder,</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+  nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineplus">+  rv = imapService-&gt;DiscoverAllFolders(thread, rootMsgFolder,</span>
<a href="#l10.55"></a><span id="l10.55">                                        this, aMsgWindow, nsnull);</span>
<a href="#l10.56"></a><span id="l10.56">   return rv;</span>
<a href="#l10.57"></a><span id="l10.57"> }</span>
<a href="#l10.58"></a><span id="l10.58"> </span>
<a href="#l10.59"></a><span id="l10.59"> NS_IMETHODIMP</span>
<a href="#l10.60"></a><span id="l10.60"> nsImapIncomingServer::VerifyLogon(nsIUrlListener *aUrlListener,</span>
<a href="#l10.61"></a><span id="l10.61">                                   nsIMsgWindow *aMsgWindow, nsIURI **aURL)</span>
<a href="#l10.62"></a><span id="l10.62"> {</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineat">@@ -1086,18 +1091,18 @@ NS_IMETHODIMP nsImapIncomingServer::Poss</span>
<a href="#l10.64"></a><span id="l10.64">   if (NS_FAILED(rv))</span>
<a href="#l10.65"></a><span id="l10.65">     return rv;</span>
<a href="#l10.66"></a><span id="l10.66"> </span>
<a href="#l10.67"></a><span id="l10.67">   nsCAutoString tempFolderName(dupFolderPath);</span>
<a href="#l10.68"></a><span id="l10.68">   nsCAutoString tokenStr, remStr, changedStr;</span>
<a href="#l10.69"></a><span id="l10.69">   PRInt32 slashPos = tempFolderName.FindChar('/');</span>
<a href="#l10.70"></a><span id="l10.70">   if (slashPos &gt; 0)</span>
<a href="#l10.71"></a><span id="l10.71">   {</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-    tempFolderName.Left(tokenStr,slashPos);</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-    tempFolderName.Right(remStr, tempFolderName.Length()-slashPos);</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineplus">+    tokenStr = StringHead(tempFolderName, slashPos);</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineplus">+    remStr = Substring(tempFolderName, slashPos);</span>
<a href="#l10.76"></a><span id="l10.76">   }</span>
<a href="#l10.77"></a><span id="l10.77">   else</span>
<a href="#l10.78"></a><span id="l10.78">     tokenStr.Assign(tempFolderName);</span>
<a href="#l10.79"></a><span id="l10.79"> </span>
<a href="#l10.80"></a><span id="l10.80">   if ((PRInt32(PL_strcasecmp(tokenStr.get(), &quot;INBOX&quot;))==0) &amp;&amp; (strcmp(tokenStr.get(), &quot;INBOX&quot;) != 0))</span>
<a href="#l10.81"></a><span id="l10.81">     changedStr.Append(&quot;INBOX&quot;);</span>
<a href="#l10.82"></a><span id="l10.82">   else</span>
<a href="#l10.83"></a><span id="l10.83">     changedStr.Append(tokenStr);</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineat">@@ -1115,58 +1120,58 @@ NS_IMETHODIMP nsImapIncomingServer::Poss</span>
<a href="#l10.85"></a><span id="l10.85">   PRInt32 leafPos = folderName.RFindChar('/');</span>
<a href="#l10.86"></a><span id="l10.86">   nsCAutoString parentName(folderName);</span>
<a href="#l10.87"></a><span id="l10.87">   nsCAutoString parentUri(uri);</span>
<a href="#l10.88"></a><span id="l10.88"> </span>
<a href="#l10.89"></a><span id="l10.89">   if (leafPos &gt; 0)</span>
<a href="#l10.90"></a><span id="l10.90">   {</span>
<a href="#l10.91"></a><span id="l10.91">     // If there is a hierarchy, there is a parent.</span>
<a href="#l10.92"></a><span id="l10.92">     // Don't strip off slash if it's the first character</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-    parentName.Truncate(leafPos);</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineplus">+    parentName.SetLength(leafPos);</span>
<a href="#l10.95"></a><span id="l10.95">     folderName.Cut(0, leafPos + 1);	// get rid of the parent name</span>
<a href="#l10.96"></a><span id="l10.96">     haveParent = PR_TRUE;</span>
<a href="#l10.97"></a><span id="l10.97">     parentUri.Append('/');</span>
<a href="#l10.98"></a><span id="l10.98">     parentUri.Append(parentName);</span>
<a href="#l10.99"></a><span id="l10.99">   }</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-  if (folderPath.LowerCaseEqualsLiteral(&quot;inbox&quot;) &amp;&amp;</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineplus">+  if (MsgLowerCaseEqualsLiteral(folderPath, &quot;inbox&quot;) &amp;&amp;</span>
<a href="#l10.102"></a><span id="l10.102">     hierarchyDelimiter == kOnlineHierarchySeparatorNil)</span>
<a href="#l10.103"></a><span id="l10.103">   {</span>
<a href="#l10.104"></a><span id="l10.104">     hierarchyDelimiter = '/'; // set to default in this case (as in 4.x)</span>
<a href="#l10.105"></a><span id="l10.105">     hostFolder-&gt;SetHierarchyDelimiter(hierarchyDelimiter);</span>
<a href="#l10.106"></a><span id="l10.106">   }</span>
<a href="#l10.107"></a><span id="l10.107"> </span>
<a href="#l10.108"></a><span id="l10.108">   nsCOMPtr &lt;nsIMsgFolder&gt; child;</span>
<a href="#l10.109"></a><span id="l10.109"> </span>
<a href="#l10.110"></a><span id="l10.110">   // nsCString possibleName(aSpec-&gt;allocatedPathName);</span>
<a href="#l10.111"></a><span id="l10.111">   uri.Append('/');</span>
<a href="#l10.112"></a><span id="l10.112">   uri.Append(dupFolderPath);</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-  PRBool caseInsensitive = dupFolderPath.LowerCaseEqualsLiteral(&quot;inbox&quot;);</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+  PRBool caseInsensitive = MsgLowerCaseEqualsLiteral(dupFolderPath, &quot;inbox&quot;);</span>
<a href="#l10.115"></a><span id="l10.115">   a_nsIFolder-&gt;GetChildWithURI(uri, PR_TRUE, caseInsensitive, getter_AddRefs(child));</span>
<a href="#l10.116"></a><span id="l10.116">   // if we couldn't find this folder by URI, tell the imap code it's a new folder to us</span>
<a href="#l10.117"></a><span id="l10.117">   *aNewFolder = !child;</span>
<a href="#l10.118"></a><span id="l10.118">   if (child)</span>
<a href="#l10.119"></a><span id="l10.119">     found = PR_TRUE;</span>
<a href="#l10.120"></a><span id="l10.120">   if (!found)</span>
<a href="#l10.121"></a><span id="l10.121">   {</span>
<a href="#l10.122"></a><span id="l10.122">     // trying to find/discover the parent</span>
<a href="#l10.123"></a><span id="l10.123">     if (haveParent)</span>
<a href="#l10.124"></a><span id="l10.124">     {</span>
<a href="#l10.125"></a><span id="l10.125">       nsCOMPtr &lt;nsIMsgFolder&gt; parent;</span>
<a href="#l10.126"></a><span id="l10.126">       PRBool parentIsNew;</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-      caseInsensitive = parentName.LowerCaseEqualsLiteral(&quot;inbox&quot;);</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineplus">+      caseInsensitive = MsgLowerCaseEqualsLiteral(parentName, &quot;inbox&quot;);</span>
<a href="#l10.129"></a><span id="l10.129">       a_nsIFolder-&gt;GetChildWithURI(parentUri, PR_TRUE, caseInsensitive, getter_AddRefs(parent));</span>
<a href="#l10.130"></a><span id="l10.130">       if (!parent /* || parentFolder-&gt;GetFolderNeedsAdded()*/)</span>
<a href="#l10.131"></a><span id="l10.131">       {</span>
<a href="#l10.132"></a><span id="l10.132">         PossibleImapMailbox(parentName, hierarchyDelimiter, kNoselect | // be defensive</span>
<a href="#l10.133"></a><span id="l10.133">           ((boxFlags  &amp; //only inherit certain flags from the child</span>
<a href="#l10.134"></a><span id="l10.134">           (kPublicMailbox | kOtherUsersMailbox | kPersonalMailbox))), &amp;parentIsNew);</span>
<a href="#l10.135"></a><span id="l10.135">       }</span>
<a href="#l10.136"></a><span id="l10.136">     }</span>
<a href="#l10.137"></a><span id="l10.137">     hostFolder-&gt;CreateClientSubfolderInfo(dupFolderPath, hierarchyDelimiter,boxFlags, PR_FALSE);</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-    caseInsensitive = dupFolderPath.LowerCaseEqualsLiteral(&quot;inbox&quot;);</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineplus">+    caseInsensitive = MsgLowerCaseEqualsLiteral(dupFolderPath, &quot;inbox&quot;);</span>
<a href="#l10.140"></a><span id="l10.140">     a_nsIFolder-&gt;GetChildWithURI(uri, PR_TRUE, caseInsensitive, getter_AddRefs(child));</span>
<a href="#l10.141"></a><span id="l10.141">   }</span>
<a href="#l10.142"></a><span id="l10.142">   if (child)</span>
<a href="#l10.143"></a><span id="l10.143">   {</span>
<a href="#l10.144"></a><span id="l10.144">     nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(child);</span>
<a href="#l10.145"></a><span id="l10.145">     if (imapFolder)</span>
<a href="#l10.146"></a><span id="l10.146">     {</span>
<a href="#l10.147"></a><span id="l10.147">       nsCAutoString onlineName;</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineat">@@ -1185,17 +1190,17 @@ NS_IMETHODIMP nsImapIncomingServer::Poss</span>
<a href="#l10.149"></a><span id="l10.149">         SetIsGMailServer(PR_TRUE);</span>
<a href="#l10.150"></a><span id="l10.150"> </span>
<a href="#l10.151"></a><span id="l10.151">       imapFolder-&gt;SetBoxFlags(boxFlags);</span>
<a href="#l10.152"></a><span id="l10.152">       imapFolder-&gt;SetExplicitlyVerify(explicitlyVerify);</span>
<a href="#l10.153"></a><span id="l10.153">       imapFolder-&gt;GetOnlineName(onlineName);</span>
<a href="#l10.154"></a><span id="l10.154">       </span>
<a href="#l10.155"></a><span id="l10.155">       // online name needs to use the correct hierarchy delimiter (I think...)</span>
<a href="#l10.156"></a><span id="l10.156">       // or the canonical path - one or the other, but be consistent.</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineminus">-      dupFolderPath.ReplaceChar('/', hierarchyDelimiter);</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineplus">+      MsgReplaceChar(dupFolderPath, '/', hierarchyDelimiter);</span>
<a href="#l10.159"></a><span id="l10.159">       if (hierarchyDelimiter != '/')</span>
<a href="#l10.160"></a><span id="l10.160">         nsImapUrl::UnescapeSlashes(dupFolderPath.BeginWriting());</span>
<a href="#l10.161"></a><span id="l10.161"> </span>
<a href="#l10.162"></a><span id="l10.162">       // GMail gives us a localized name for the inbox but doesn't let </span>
<a href="#l10.163"></a><span id="l10.163">       // us select that localized name.</span>
<a href="#l10.164"></a><span id="l10.164">       if (boxFlags &amp; kImapInbox)</span>
<a href="#l10.165"></a><span id="l10.165">         imapFolder-&gt;SetOnlineName(NS_LITERAL_CSTRING(&quot;INBOX&quot;));</span>
<a href="#l10.166"></a><span id="l10.166">       else if (onlineName.IsEmpty() || !onlineName.Equals(dupFolderPath))</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineat">@@ -1324,23 +1329,21 @@ NS_IMETHODIMP nsImapIncomingServer::Onli</span>
<a href="#l10.168"></a><span id="l10.168">   if (!newName.IsEmpty())</span>
<a href="#l10.169"></a><span id="l10.169">   {</span>
<a href="#l10.170"></a><span id="l10.170">     nsCOMPtr&lt;nsIMsgFolder&gt; me;</span>
<a href="#l10.171"></a><span id="l10.171">     rv = GetFolder(oldName, getter_AddRefs(me));</span>
<a href="#l10.172"></a><span id="l10.172">     if (NS_FAILED(rv))</span>
<a href="#l10.173"></a><span id="l10.173">       return rv;</span>
<a href="#l10.174"></a><span id="l10.174"> </span>
<a href="#l10.175"></a><span id="l10.175">     nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineminus">-    nsCAutoString parentName;</span>
<a href="#l10.177"></a><span id="l10.177">     nsCString tmpNewName (newName);</span>
<a href="#l10.178"></a><span id="l10.178">     PRInt32 folderStart = tmpNewName.RFindChar('/');</span>
<a href="#l10.179"></a><span id="l10.179">     if (folderStart &gt; 0)</span>
<a href="#l10.180"></a><span id="l10.180">     {</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineminus">-      tmpNewName.Left(parentName, folderStart);</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineminus">-      rv = GetFolder(parentName, getter_AddRefs(parent));</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineplus">+      rv = GetFolder(StringHead(tmpNewName, folderStart), getter_AddRefs(parent));</span>
<a href="#l10.184"></a><span id="l10.184">     }</span>
<a href="#l10.185"></a><span id="l10.185">     else  // root is the parent</span>
<a href="#l10.186"></a><span id="l10.186">       rv = GetRootFolder(getter_AddRefs(parent));</span>
<a href="#l10.187"></a><span id="l10.187">     if (NS_SUCCEEDED(rv) &amp;&amp; parent)</span>
<a href="#l10.188"></a><span id="l10.188">     {</span>
<a href="#l10.189"></a><span id="l10.189">       nsCOMPtr&lt;nsIMsgImapMailFolder&gt; folder;</span>
<a href="#l10.190"></a><span id="l10.190">       folder = do_QueryInterface(me, &amp;rv);</span>
<a href="#l10.191"></a><span id="l10.191">       if (NS_SUCCEEDED(rv))</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineat">@@ -1355,17 +1358,17 @@ NS_IMETHODIMP nsImapIncomingServer::Onli</span>
<a href="#l10.193"></a><span id="l10.193">         nsString unicodeNewName;</span>
<a href="#l10.194"></a><span id="l10.194">         // tmpNewName is imap mod utf7. It needs to be convert to utf8.</span>
<a href="#l10.195"></a><span id="l10.195">         CopyMUTF7toUTF16(tmpNewName, unicodeNewName);</span>
<a href="#l10.196"></a><span id="l10.196">         CopyUTF16toUTF8(unicodeNewName, tmpNewName);</span>
<a href="#l10.197"></a><span id="l10.197">         rv = GetFolder(tmpNewName, getter_AddRefs(newFolder));</span>
<a href="#l10.198"></a><span id="l10.198">         if (NS_SUCCEEDED(rv))</span>
<a href="#l10.199"></a><span id="l10.199">         {</span>
<a href="#l10.200"></a><span id="l10.200">           nsCOMPtr &lt;nsIAtom&gt; folderRenameAtom;</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineminus">-          folderRenameAtom = do_GetAtom(&quot;RenameCompleted&quot;);</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineplus">+          folderRenameAtom = MsgGetAtom(&quot;RenameCompleted&quot;);</span>
<a href="#l10.203"></a><span id="l10.203">           newFolder-&gt;NotifyFolderEvent(folderRenameAtom);</span>
<a href="#l10.204"></a><span id="l10.204">         }</span>
<a href="#l10.205"></a><span id="l10.205">       }</span>
<a href="#l10.206"></a><span id="l10.206">     }</span>
<a href="#l10.207"></a><span id="l10.207">   }</span>
<a href="#l10.208"></a><span id="l10.208">   return rv;</span>
<a href="#l10.209"></a><span id="l10.209"> }</span>
<a href="#l10.210"></a><span id="l10.210"> </span>
<a href="#l10.211"></a><span id="l10.211" class="difflineat">@@ -1942,17 +1945,19 @@ nsresult nsImapIncomingServer::GetString</span>
<a href="#l10.212"></a><span id="l10.212"> </span>
<a href="#l10.213"></a><span id="l10.213"> NS_IMETHODIMP</span>
<a href="#l10.214"></a><span id="l10.214"> nsImapIncomingServer::GetImapStringByID(PRInt32 aMsgId, nsAString&amp; aString)</span>
<a href="#l10.215"></a><span id="l10.215"> {</span>
<a href="#l10.216"></a><span id="l10.216">   nsresult res = NS_OK;</span>
<a href="#l10.217"></a><span id="l10.217">   GetStringBundle();</span>
<a href="#l10.218"></a><span id="l10.218">   if (m_stringBundle)</span>
<a href="#l10.219"></a><span id="l10.219">   {</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineminus">-    res = m_stringBundle-&gt;GetStringFromID(aMsgId, getter_Copies(aString));</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineplus">+    nsString res_str;</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineplus">+    res = m_stringBundle-&gt;GetStringFromID(aMsgId, getter_Copies(res_str));</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineplus">+    aString.Assign(res_str);</span>
<a href="#l10.224"></a><span id="l10.224">     if (NS_SUCCEEDED(res))</span>
<a href="#l10.225"></a><span id="l10.225">       return res;</span>
<a href="#l10.226"></a><span id="l10.226">   }</span>
<a href="#l10.227"></a><span id="l10.227">   aString.AssignLiteral(&quot;String ID &quot;);</span>
<a href="#l10.228"></a><span id="l10.228">   // mscott: FIX ME</span>
<a href="#l10.229"></a><span id="l10.229">   nsString tmpIntStr;</span>
<a href="#l10.230"></a><span id="l10.230">   tmpIntStr.AppendInt(aMsgId);</span>
<a href="#l10.231"></a><span id="l10.231">   aString.Append(tmpIntStr);</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineat">@@ -2418,20 +2423,20 @@ nsImapIncomingServer::AddTo(const nsACSt</span>
<a href="#l10.233"></a><span id="l10.233">                             PRBool aSubscribable, PRBool changeIfExists)</span>
<a href="#l10.234"></a><span id="l10.234"> {</span>
<a href="#l10.235"></a><span id="l10.235">   nsresult rv = EnsureInner();</span>
<a href="#l10.236"></a><span id="l10.236">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l10.237"></a><span id="l10.237"> </span>
<a href="#l10.238"></a><span id="l10.238">   // RFC 3501 allows UTF-8 in addition to modified UTF-7</span>
<a href="#l10.239"></a><span id="l10.239">   // If it's not UTF-8, it cannot be MUTF7, either. We just ignore it.</span>
<a href="#l10.240"></a><span id="l10.240">   // (otherwise we'll crash. see #63186)</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineminus">-  if (!IsUTF8(aName))</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineplus">+  if (!MsgIsUTF8(aName))</span>
<a href="#l10.243"></a><span id="l10.243">     return NS_OK;</span>
<a href="#l10.244"></a><span id="l10.244"> </span>
<a href="#l10.245"></a><span id="l10.245" class="difflineminus">-  if (!IsASCII(aName)) {</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineplus">+  if (!NS_IsAscii(aName.BeginReading(), aName.Length())) {</span>
<a href="#l10.247"></a><span id="l10.247">     nsCAutoString name;</span>
<a href="#l10.248"></a><span id="l10.248">     CopyUTF16toMUTF7(NS_ConvertUTF8toUTF16(aName), name);</span>
<a href="#l10.249"></a><span id="l10.249">     return mInner-&gt;AddTo(name, addAsSubscribed, aSubscribable, changeIfExists);</span>
<a href="#l10.250"></a><span id="l10.250">   }</span>
<a href="#l10.251"></a><span id="l10.251">   return mInner-&gt;AddTo(aName, addAsSubscribed, aSubscribable, changeIfExists);</span>
<a href="#l10.252"></a><span id="l10.252"> }</span>
<a href="#l10.253"></a><span id="l10.253"> </span>
<a href="#l10.254"></a><span id="l10.254"> NS_IMETHODIMP</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineat">@@ -2499,17 +2504,17 @@ nsImapIncomingServer::SubscribeToFolder(</span>
<a href="#l10.256"></a><span id="l10.256">   // folder pathnames, otherwise root's (ie, '^') is used and this is wrong.</span>
<a href="#l10.257"></a><span id="l10.257"> </span>
<a href="#l10.258"></a><span id="l10.258">   // aName is not a genuine UTF-16 but just a zero-padded modified UTF-7</span>
<a href="#l10.259"></a><span id="l10.259">   NS_LossyConvertUTF16toASCII folderCName(aName);</span>
<a href="#l10.260"></a><span id="l10.260">   nsCOMPtr&lt;nsIMsgFolder&gt; msgFolder;</span>
<a href="#l10.261"></a><span id="l10.261">   if (rootMsgFolder &amp;&amp; !aName.IsEmpty())</span>
<a href="#l10.262"></a><span id="l10.262">     rv = rootMsgFolder-&gt;FindSubFolder(folderCName, getter_AddRefs(msgFolder));</span>
<a href="#l10.263"></a><span id="l10.263"> </span>
<a href="#l10.264"></a><span id="l10.264" class="difflineminus">-  nsIThread *thread = NS_GetCurrentThread();</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineplus">+  nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l10.266"></a><span id="l10.266"> </span>
<a href="#l10.267"></a><span id="l10.267">   nsAutoString unicodeName;</span>
<a href="#l10.268"></a><span id="l10.268">   rv = CopyMUTF7toUTF16(folderCName, unicodeName);</span>
<a href="#l10.269"></a><span id="l10.269">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l10.270"></a><span id="l10.270"> </span>
<a href="#l10.271"></a><span id="l10.271">   if (subscribe)</span>
<a href="#l10.272"></a><span id="l10.272">     rv = imapService-&gt;SubscribeFolder(thread, msgFolder, unicodeName, nsnull, aUri);</span>
<a href="#l10.273"></a><span id="l10.273">   else</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineat">@@ -2850,17 +2855,17 @@ nsImapIncomingServer::GeneratePrettyName</span>
<a href="#l10.275"></a><span id="l10.275">   if (((serverPort == defaultServerPort) &amp;&amp; !isSecure)||</span>
<a href="#l10.276"></a><span id="l10.276">       ((serverPort == defaultSecureServerPort) &amp;&amp; isSecure))</span>
<a href="#l10.277"></a><span id="l10.277">       isItDefaultPort = PR_TRUE;</span>
<a href="#l10.278"></a><span id="l10.278"> </span>
<a href="#l10.279"></a><span id="l10.279">   // Construct pretty name from username and hostname</span>
<a href="#l10.280"></a><span id="l10.280">   nsAutoString constructedPrettyName;</span>
<a href="#l10.281"></a><span id="l10.281">   CopyASCIItoUTF16(userName,constructedPrettyName);</span>
<a href="#l10.282"></a><span id="l10.282">   constructedPrettyName.Append('@');</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineminus">-  AppendASCIItoUTF16(hostName, constructedPrettyName);</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineplus">+  constructedPrettyName.Append(NS_ConvertASCIItoUTF16(hostName));</span>
<a href="#l10.285"></a><span id="l10.285">   </span>
<a href="#l10.286"></a><span id="l10.286">   // If the port is valid and not default, add port value to the pretty name</span>
<a href="#l10.287"></a><span id="l10.287">   if ((serverPort &gt; 0) &amp;&amp; (!isItDefaultPort)) {</span>
<a href="#l10.288"></a><span id="l10.288">     constructedPrettyName.Append(':');</span>
<a href="#l10.289"></a><span id="l10.289">     constructedPrettyName.AppendInt(serverPort);</span>
<a href="#l10.290"></a><span id="l10.290">   }</span>
<a href="#l10.291"></a><span id="l10.291"> </span>
<a href="#l10.292"></a><span id="l10.292">   // Format the pretty name</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineat">@@ -2874,19 +2879,21 @@ nsImapIncomingServer::GetFormattedString</span>
<a href="#l10.294"></a><span id="l10.294">   if (m_stringBundle)</span>
<a href="#l10.295"></a><span id="l10.295">   {</span>
<a href="#l10.296"></a><span id="l10.296">     nsString tmpVal (aValue);</span>
<a href="#l10.297"></a><span id="l10.297">     const PRUnichar *formatStrings[] =</span>
<a href="#l10.298"></a><span id="l10.298">     {</span>
<a href="#l10.299"></a><span id="l10.299">       tmpVal.get(),</span>
<a href="#l10.300"></a><span id="l10.300">     };</span>
<a href="#l10.301"></a><span id="l10.301"> </span>
<a href="#l10.302"></a><span id="l10.302" class="difflineplus">+    nsString result;</span>
<a href="#l10.303"></a><span id="l10.303">     rv = m_stringBundle-&gt;FormatStringFromID(aID,</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineminus">-                                formatStrings, 1,</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineminus">-                                getter_Copies(aResult));</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineplus">+                                            formatStrings, 1,</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineplus">+                                            getter_Copies(result));</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineplus">+    aResult.Assign(result);</span>
<a href="#l10.309"></a><span id="l10.309">   }</span>
<a href="#l10.310"></a><span id="l10.310">   return rv;</span>
<a href="#l10.311"></a><span id="l10.311"> }</span>
<a href="#l10.312"></a><span id="l10.312"> </span>
<a href="#l10.313"></a><span id="l10.313"> nsresult</span>
<a href="#l10.314"></a><span id="l10.314"> nsImapIncomingServer::GetPrefForServerAttribute(const char *prefSuffix, PRBool *prefValue)</span>
<a href="#l10.315"></a><span id="l10.315"> {</span>
<a href="#l10.316"></a><span id="l10.316">   // Any caller of this function must initialize prefValue with a default value</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineat">@@ -3122,26 +3129,26 @@ nsImapIncomingServer::GetUriWithNamespac</span>
<a href="#l10.318"></a><span id="l10.318">       {</span>
<a href="#l10.319"></a><span id="l10.319">         char delimiter = ns-&gt;GetDelimiter();</span>
<a href="#l10.320"></a><span id="l10.320">           if ( onlineDir.Last() != delimiter )</span>
<a href="#l10.321"></a><span id="l10.321">             onlineDir += delimiter;</span>
<a href="#l10.322"></a><span id="l10.322">           if (onlineDir.Equals(namespacePrefix))</span>
<a href="#l10.323"></a><span id="l10.323">             return NS_OK;</span>
<a href="#l10.324"></a><span id="l10.324">       }</span>
<a href="#l10.325"></a><span id="l10.325"> </span>
<a href="#l10.326"></a><span id="l10.326" class="difflineminus">-      namespacePrefix.ReplaceChar(ns-&gt;GetDelimiter(), '/'); // use canonical format</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineplus">+      MsgReplaceChar(namespacePrefix, ns-&gt;GetDelimiter(), '/'); // use canonical format</span>
<a href="#l10.328"></a><span id="l10.328">       nsCString uri(originalUri);</span>
<a href="#l10.329"></a><span id="l10.329">       PRInt32 index = uri.Find(&quot;//&quot;);           // find scheme</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineminus">-      index = uri.Find(&quot;/&quot;, PR_FALSE, index+2); // find '/' after scheme</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineplus">+      index = uri.FindChar('/', index + 2);       // find '/' after scheme</span>
<a href="#l10.332"></a><span id="l10.332">       // it may be the case that this is the INBOX uri, in which case</span>
<a href="#l10.333"></a><span id="l10.333">       // we don't want to prepend the namespace. In that case, the uri ends with &quot;INBOX&quot;,</span>
<a href="#l10.334"></a><span id="l10.334">       // but the namespace is &quot;INBOX/&quot;, so they don't match.</span>
<a href="#l10.335"></a><span id="l10.335" class="difflineminus">-      if (uri.Find(namespacePrefix, PR_FALSE, index+1) != index+1</span>
<a href="#l10.336"></a><span id="l10.336" class="difflineminus">-        &amp;&amp; !Substring(uri, index + 1, uri.Length() - index - 1).LowerCaseEqualsLiteral(&quot;inbox&quot;))</span>
<a href="#l10.337"></a><span id="l10.337" class="difflineminus">-        uri.Insert(namespacePrefix, index+1);   // insert namespace prefix</span>
<a href="#l10.338"></a><span id="l10.338" class="difflineplus">+      if (MsgFind(uri, namespacePrefix, PR_FALSE, index + 1) != index + 1 &amp;&amp;</span>
<a href="#l10.339"></a><span id="l10.339" class="difflineplus">+          !MsgLowerCaseEqualsLiteral(Substring(uri, index + 1), &quot;inbox&quot;))</span>
<a href="#l10.340"></a><span id="l10.340" class="difflineplus">+        uri.Insert(namespacePrefix, index + 1);   // insert namespace prefix</span>
<a href="#l10.341"></a><span id="l10.341">       convertedUri = uri;</span>
<a href="#l10.342"></a><span id="l10.342">     }</span>
<a href="#l10.343"></a><span id="l10.343">   }</span>
<a href="#l10.344"></a><span id="l10.344">   return rv;</span>
<a href="#l10.345"></a><span id="l10.345"> }</span>
<a href="#l10.346"></a><span id="l10.346"> </span>
<a href="#l10.347"></a><span id="l10.347"> NS_IMETHODIMP nsImapIncomingServer::GetTrashFolderName(nsAString&amp; retval)</span>
<a href="#l10.348"></a><span id="l10.348"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -68,28 +68,26 @@</span>
<a href="#l11.4"></a><span id="l11.4"> #include &quot;nsICopyMsgStreamListener.h&quot;</span>
<a href="#l11.5"></a><span id="l11.5"> #include &quot;nsImapStringBundle.h&quot;</span>
<a href="#l11.6"></a><span id="l11.6"> #include &quot;nsIMsgFolderCacheElement.h&quot;</span>
<a href="#l11.7"></a><span id="l11.7"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l11.8"></a><span id="l11.8"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l11.9"></a><span id="l11.9"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l11.10"></a><span id="l11.10"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l11.11"></a><span id="l11.11"> #include &quot;nsICacheSession.h&quot;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-#include &quot;nsEscape.h&quot;</span>
<a href="#l11.13"></a><span id="l11.13"> #include &quot;nsIDOMWindowInternal.h&quot;</span>
<a href="#l11.14"></a><span id="l11.14"> #include &quot;nsIMsgFilter.h&quot;</span>
<a href="#l11.15"></a><span id="l11.15"> #include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> #include &quot;nsIMsgSearchCustomTerm.h&quot;</span>
<a href="#l11.17"></a><span id="l11.17"> #include &quot;nsImapMoveCoalescer.h&quot;</span>
<a href="#l11.18"></a><span id="l11.18"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l11.19"></a><span id="l11.19"> #include &quot;nsIPromptService.h&quot;</span>
<a href="#l11.20"></a><span id="l11.20"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l11.21"></a><span id="l11.21"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l11.22"></a><span id="l11.22"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l11.24"></a><span id="l11.24"> #include &quot;nsUnicharUtils.h&quot;</span>
<a href="#l11.25"></a><span id="l11.25"> #include &quot;nsIImapFlagAndUidState.h&quot;</span>
<a href="#l11.26"></a><span id="l11.26"> #include &quot;nsIImapHeaderXferInfo.h&quot;</span>
<a href="#l11.27"></a><span id="l11.27"> #include &quot;nsIMessenger.h&quot;</span>
<a href="#l11.28"></a><span id="l11.28"> #include &quot;nsIMsgSearchAdapter.h&quot;</span>
<a href="#l11.29"></a><span id="l11.29"> #include &quot;nsIImapMockChannel.h&quot;</span>
<a href="#l11.30"></a><span id="l11.30"> #include &quot;nsIProgressEventSink.h&quot;</span>
<a href="#l11.31"></a><span id="l11.31"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineat">@@ -123,18 +121,18 @@</span>
<a href="#l11.33"></a><span id="l11.33"> #include &quot;prprf.h&quot;</span>
<a href="#l11.34"></a><span id="l11.34"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l11.35"></a><span id="l11.35"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l11.36"></a><span id="l11.36"> #include &quot;nsArrayEnumerator.h&quot;</span>
<a href="#l11.37"></a><span id="l11.37"> #include &quot;nsAutoSyncManager.h&quot;</span>
<a href="#l11.38"></a><span id="l11.38"> #include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l11.39"></a><span id="l11.39"> #include &quot;nsMsgReadStateTxn.h&quot;</span>
<a href="#l11.40"></a><span id="l11.40"> #include &quot;nsIStringEnumerator.h&quot;</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-#include &quot;nsStringEnumerator.h&quot;</span>
<a href="#l11.42"></a><span id="l11.42"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+#include &quot;nsAlgorithm.h&quot;</span>
<a href="#l11.44"></a><span id="l11.44"> </span>
<a href="#l11.45"></a><span id="l11.45"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l11.46"></a><span id="l11.46"> static NS_DEFINE_CID(kParseMailMsgStateCID, NS_PARSEMAILMSGSTATE_CID);</span>
<a href="#l11.47"></a><span id="l11.47"> static NS_DEFINE_CID(kCImapHostSessionList, NS_IIMAPHOSTSESSIONLIST_CID);</span>
<a href="#l11.48"></a><span id="l11.48"> </span>
<a href="#l11.49"></a><span id="l11.49"> nsIAtom* nsImapMailFolder::mImapHdrDownloadedAtom = nsnull;</span>
<a href="#l11.50"></a><span id="l11.50"> </span>
<a href="#l11.51"></a><span id="l11.51"> extern PRLogModuleInfo *gAutoSyncLog;</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineat">@@ -230,17 +228,17 @@ nsImapMailFolder::nsImapMailFolder() :</span>
<a href="#l11.53"></a><span id="l11.53">     m_compactingOfflineStore(PR_FALSE),</span>
<a href="#l11.54"></a><span id="l11.54">     m_expunging(PR_FALSE),</span>
<a href="#l11.55"></a><span id="l11.55">     m_applyIncomingFilters(PR_FALSE),</span>
<a href="#l11.56"></a><span id="l11.56">     m_filterListRequiresBody(PR_FALSE)</span>
<a href="#l11.57"></a><span id="l11.57"> {</span>
<a href="#l11.58"></a><span id="l11.58">   MOZ_COUNT_CTOR(nsImapMailFolder); // double count these for now.</span>
<a href="#l11.59"></a><span id="l11.59"> </span>
<a href="#l11.60"></a><span id="l11.60">   if (mImapHdrDownloadedAtom == nsnull)</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-    mImapHdrDownloadedAtom = NS_NewAtom(&quot;ImapHdrDownloaded&quot;);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+    mImapHdrDownloadedAtom = MsgNewAtom(&quot;ImapHdrDownloaded&quot;);</span>
<a href="#l11.63"></a><span id="l11.63">   m_appendMsgMonitor = nsnull;  // since we're not using this (yet?) make it null.</span>
<a href="#l11.64"></a><span id="l11.64">   // if we do start using it, it should be created lazily</span>
<a href="#l11.65"></a><span id="l11.65"> </span>
<a href="#l11.66"></a><span id="l11.66">   m_thread = do_GetCurrentThread();</span>
<a href="#l11.67"></a><span id="l11.67">   m_moveCoalescer = nsnull;</span>
<a href="#l11.68"></a><span id="l11.68">   m_boxFlags = 0;</span>
<a href="#l11.69"></a><span id="l11.69">   m_uidValidity = kUidUnknown;</span>
<a href="#l11.70"></a><span id="l11.70">   m_highestModSeq = 0;</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineat">@@ -483,49 +481,47 @@ nsresult nsImapMailFolder::CreateSubFold</span>
<a href="#l11.72"></a><span id="l11.72">   nsresult rv = NS_OK;</span>
<a href="#l11.73"></a><span id="l11.73">   nsAutoString currentFolderNameStr;    // online name</span>
<a href="#l11.74"></a><span id="l11.74">   nsAutoString currentFolderDBNameStr;  // possibly munged name</span>
<a href="#l11.75"></a><span id="l11.75">   nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l11.76"></a><span id="l11.76">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l11.77"></a><span id="l11.77">   rv = GetServer(getter_AddRefs(server));</span>
<a href="#l11.78"></a><span id="l11.78">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.79"></a><span id="l11.79"> </span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-  nsCAutoString folderName;</span>
<a href="#l11.81"></a><span id="l11.81">   nsCOMPtr &lt;nsISimpleEnumerator&gt; children;</span>
<a href="#l11.82"></a><span id="l11.82">   rv = path-&gt;GetDirectoryEntries(getter_AddRefs(children));</span>
<a href="#l11.83"></a><span id="l11.83">   PRBool more = PR_FALSE;</span>
<a href="#l11.84"></a><span id="l11.84">   if (children)</span>
<a href="#l11.85"></a><span id="l11.85">     children-&gt;HasMoreElements(&amp;more);</span>
<a href="#l11.86"></a><span id="l11.86">   nsCOMPtr&lt;nsIFile&gt; dirEntry;</span>
<a href="#l11.87"></a><span id="l11.87"> </span>
<a href="#l11.88"></a><span id="l11.88">   while (more)</span>
<a href="#l11.89"></a><span id="l11.89">   {</span>
<a href="#l11.90"></a><span id="l11.90">     rv = children-&gt;GetNext((nsISupports**) getter_AddRefs(dirEntry));</span>
<a href="#l11.91"></a><span id="l11.91">     if (NS_FAILED(rv))</span>
<a href="#l11.92"></a><span id="l11.92">       break;</span>
<a href="#l11.93"></a><span id="l11.93">     rv = children-&gt;HasMoreElements(&amp;more);</span>
<a href="#l11.94"></a><span id="l11.94">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l11.95"></a><span id="l11.95"> </span>
<a href="#l11.96"></a><span id="l11.96">     nsCOMPtr &lt;nsILocalFile&gt; currentFolderPath = do_QueryInterface(dirEntry);</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-    currentFolderPath-&gt;GetNativeLeafName(folderName);</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineminus">-    NS_CopyNativeToUnicode(folderName, currentFolderNameStr);</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+    currentFolderPath-&gt;GetLeafName(currentFolderNameStr);</span>
<a href="#l11.100"></a><span id="l11.100">     if (nsShouldIgnoreFile(currentFolderNameStr))</span>
<a href="#l11.101"></a><span id="l11.101">       continue;</span>
<a href="#l11.102"></a><span id="l11.102"> </span>
<a href="#l11.103"></a><span id="l11.103">     // OK, here we need to get the online name from the folder cache if we can.</span>
<a href="#l11.104"></a><span id="l11.104">     // If we can, use that to create the sub-folder</span>
<a href="#l11.105"></a><span id="l11.105">     nsCOMPtr &lt;nsIMsgFolderCacheElement&gt; cacheElement;</span>
<a href="#l11.106"></a><span id="l11.106">     nsCOMPtr &lt;nsILocalFile&gt; curFolder = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l11.107"></a><span id="l11.107">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.108"></a><span id="l11.108">     nsCOMPtr &lt;nsILocalFile&gt; dbFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l11.109"></a><span id="l11.109">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.110"></a><span id="l11.110">     dbFile-&gt;InitWithFile(currentFolderPath);</span>
<a href="#l11.111"></a><span id="l11.111">     curFolder-&gt;InitWithFile(currentFolderPath);</span>
<a href="#l11.112"></a><span id="l11.112">     // don't strip off the .msf in currentFolderPath.</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineminus">-    currentFolderPath-&gt;SetNativeLeafName(folderName);</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+    currentFolderPath-&gt;SetLeafName(currentFolderNameStr);</span>
<a href="#l11.115"></a><span id="l11.115">     currentFolderDBNameStr = currentFolderNameStr;</span>
<a href="#l11.116"></a><span id="l11.116">     nsAutoString utf7LeafName = currentFolderNameStr;</span>
<a href="#l11.117"></a><span id="l11.117"> </span>
<a href="#l11.118"></a><span id="l11.118">     if (curFolder)</span>
<a href="#l11.119"></a><span id="l11.119">     {</span>
<a href="#l11.120"></a><span id="l11.120">       rv = GetFolderCacheElemFromFile(dbFile, getter_AddRefs(cacheElement));</span>
<a href="#l11.121"></a><span id="l11.121">       if (NS_SUCCEEDED(rv) &amp;&amp; cacheElement)</span>
<a href="#l11.122"></a><span id="l11.122">       {</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineat">@@ -556,26 +552,24 @@ nsresult nsImapMailFolder::CreateSubFold</span>
<a href="#l11.124"></a><span id="l11.124">           CopyASCIItoUTF16(onlineFullUtf7Name, utf7LeafName);</span>
<a href="#l11.125"></a><span id="l11.125">           leafPos = utf7LeafName.RFindChar(delimiter);</span>
<a href="#l11.126"></a><span id="l11.126">           if (leafPos &gt; 0)</span>
<a href="#l11.127"></a><span id="l11.127">             utf7LeafName.Cut(0, leafPos + 1);</span>
<a href="#l11.128"></a><span id="l11.128">         }</span>
<a href="#l11.129"></a><span id="l11.129">       }</span>
<a href="#l11.130"></a><span id="l11.130">     }</span>
<a href="#l11.131"></a><span id="l11.131">       // make the imap folder remember the file spec it was created with.</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineminus">-    nsCAutoString leafName;</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineminus">-    NS_CopyUnicodeToNative(currentFolderDBNameStr, leafName);</span>
<a href="#l11.134"></a><span id="l11.134">     nsCOMPtr &lt;nsILocalFile&gt; msfFilePath = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l11.135"></a><span id="l11.135">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.136"></a><span id="l11.136">     msfFilePath-&gt;InitWithFile(currentFolderPath);</span>
<a href="#l11.137"></a><span id="l11.137">     if (NS_SUCCEEDED(rv) &amp;&amp; msfFilePath)</span>
<a href="#l11.138"></a><span id="l11.138">     {</span>
<a href="#l11.139"></a><span id="l11.139">       // leaf name is the db name w/o .msf (nsShouldIgnoreFile strips it off)</span>
<a href="#l11.140"></a><span id="l11.140">       // so this trims the .msf off the file spec.</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineminus">-      msfFilePath-&gt;SetNativeLeafName(leafName);</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+      msfFilePath-&gt;SetLeafName(currentFolderDBNameStr);</span>
<a href="#l11.143"></a><span id="l11.143">     }</span>
<a href="#l11.144"></a><span id="l11.144">     // use the utf7 name as the uri for the folder.</span>
<a href="#l11.145"></a><span id="l11.145">     AddSubfolderWithPath(utf7LeafName, msfFilePath, getter_AddRefs(child));</span>
<a href="#l11.146"></a><span id="l11.146">     if (child)</span>
<a href="#l11.147"></a><span id="l11.147">     {</span>
<a href="#l11.148"></a><span id="l11.148">       // use the unicode name as the &quot;pretty&quot; name. Set it so it won't be</span>
<a href="#l11.149"></a><span id="l11.149">       // automatically computed from the URI, which is in utf7 form.</span>
<a href="#l11.150"></a><span id="l11.150">       if (!currentFolderNameStr.IsEmpty())</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineat">@@ -956,24 +950,24 @@ NS_IMETHODIMP nsImapMailFolder::CreateCl</span>
<a href="#l11.152"></a><span id="l11.152">   PRInt32 folderStart = leafName.RFindChar('/');</span>
<a href="#l11.153"></a><span id="l11.153">   if (folderStart &gt; 0)</span>
<a href="#l11.154"></a><span id="l11.154">   {</span>
<a href="#l11.155"></a><span id="l11.155">     nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l11.156"></a><span id="l11.156">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.157"></a><span id="l11.157">     nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l11.158"></a><span id="l11.158">     nsCOMPtr&lt;nsIMsgImapMailFolder&gt; parentFolder;</span>
<a href="#l11.159"></a><span id="l11.159">     nsCAutoString uri (mURI);</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-    parentName.Right(leafName, leafName.Length() - folderStart - 1);</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineminus">-    parentName.Truncate(folderStart);</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+    leafName.Assign(Substring(parentName, folderStart + 1));</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+    parentName.SetLength(folderStart);</span>
<a href="#l11.164"></a><span id="l11.164"> </span>
<a href="#l11.165"></a><span id="l11.165">     rv = CreateDirectoryForFolder(getter_AddRefs(path));</span>
<a href="#l11.166"></a><span id="l11.166">     if (NS_FAILED(rv))</span>
<a href="#l11.167"></a><span id="l11.167">       return rv;</span>
<a href="#l11.168"></a><span id="l11.168">     uri.Append('/');</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-    LossyAppendUTF16toASCII(parentName, uri);</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+    uri.Append(NS_LossyConvertUTF16toASCII(parentName));</span>
<a href="#l11.171"></a><span id="l11.171">     rv = rdf-&gt;GetResource(uri, getter_AddRefs(res));</span>
<a href="#l11.172"></a><span id="l11.172">     if (NS_FAILED(rv))</span>
<a href="#l11.173"></a><span id="l11.173">       return rv;</span>
<a href="#l11.174"></a><span id="l11.174">     parentFolder = do_QueryInterface(res, &amp;rv);</span>
<a href="#l11.175"></a><span id="l11.175">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.176"></a><span id="l11.176">     nsCAutoString leafnameC;</span>
<a href="#l11.177"></a><span id="l11.177">     LossyCopyUTF16toASCII(leafName, leafnameC);</span>
<a href="#l11.178"></a><span id="l11.178">     return parentFolder-&gt;CreateClientSubfolderInfo(leafnameC, hierarchyDelimiter,flags, suppressNotification);</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineat">@@ -1008,17 +1002,17 @@ NS_IMETHODIMP nsImapMailFolder::CreateCl</span>
<a href="#l11.180"></a><span id="l11.180">     nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l11.181"></a><span id="l11.181">     rv = unusedDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l11.182"></a><span id="l11.182">     nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapFolder = do_QueryInterface(child, &amp;rv);</span>
<a href="#l11.183"></a><span id="l11.183">     if (NS_SUCCEEDED(rv))</span>
<a href="#l11.184"></a><span id="l11.184">     {</span>
<a href="#l11.185"></a><span id="l11.185">       nsCAutoString onlineName(m_onlineFolderName);</span>
<a href="#l11.186"></a><span id="l11.186">       if (!onlineName.IsEmpty())</span>
<a href="#l11.187"></a><span id="l11.187">         onlineName.Append(hierarchyDelimiter);</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineminus">-      LossyAppendUTF16toASCII(folderNameStr, onlineName);</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+      onlineName.Append(NS_LossyConvertUTF16toASCII(folderNameStr));</span>
<a href="#l11.190"></a><span id="l11.190">       imapFolder-&gt;SetVerifiedAsOnlineFolder(PR_TRUE);</span>
<a href="#l11.191"></a><span id="l11.191">       imapFolder-&gt;SetOnlineName(onlineName);</span>
<a href="#l11.192"></a><span id="l11.192">       imapFolder-&gt;SetHierarchyDelimiter(hierarchyDelimiter);</span>
<a href="#l11.193"></a><span id="l11.193">       imapFolder-&gt;SetBoxFlags(flags);</span>
<a href="#l11.194"></a><span id="l11.194"> </span>
<a href="#l11.195"></a><span id="l11.195">       child-&gt;SetFlag(nsMsgFolderFlags::Elided);</span>
<a href="#l11.196"></a><span id="l11.196">       nsString unicodeName;</span>
<a href="#l11.197"></a><span id="l11.197">       rv = CopyMUTF7toUTF16(nsCString(folderName), unicodeName);</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineat">@@ -1040,25 +1034,25 @@ NS_IMETHODIMP nsImapMailFolder::CreateCl</span>
<a href="#l11.199"></a><span id="l11.199">   }</span>
<a href="#l11.200"></a><span id="l11.200"> </span>
<a href="#l11.201"></a><span id="l11.201">   if (!suppressNotification)</span>
<a href="#l11.202"></a><span id="l11.202">   {</span>
<a href="#l11.203"></a><span id="l11.203">     nsCOMPtr &lt;nsIAtom&gt; folderCreateAtom;</span>
<a href="#l11.204"></a><span id="l11.204">     if(NS_SUCCEEDED(rv) &amp;&amp; child)</span>
<a href="#l11.205"></a><span id="l11.205">     {</span>
<a href="#l11.206"></a><span id="l11.206">       NotifyItemAdded(child);</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineminus">-      folderCreateAtom = do_GetAtom(&quot;FolderCreateCompleted&quot;);</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+      folderCreateAtom = MsgGetAtom(&quot;FolderCreateCompleted&quot;);</span>
<a href="#l11.209"></a><span id="l11.209">       child-&gt;NotifyFolderEvent(folderCreateAtom);</span>
<a href="#l11.210"></a><span id="l11.210">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l11.211"></a><span id="l11.211">       if (notifier)</span>
<a href="#l11.212"></a><span id="l11.212">         notifier-&gt;NotifyFolderAdded(child);</span>
<a href="#l11.213"></a><span id="l11.213">     }</span>
<a href="#l11.214"></a><span id="l11.214">     else</span>
<a href="#l11.215"></a><span id="l11.215">     {</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineminus">-      folderCreateAtom = do_GetAtom(&quot;FolderCreateFailed&quot;);</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+      folderCreateAtom = MsgGetAtom(&quot;FolderCreateFailed&quot;);</span>
<a href="#l11.218"></a><span id="l11.218">       NotifyFolderEvent(folderCreateAtom);</span>
<a href="#l11.219"></a><span id="l11.219">     }</span>
<a href="#l11.220"></a><span id="l11.220">   }</span>
<a href="#l11.221"></a><span id="l11.221">   return rv;</span>
<a href="#l11.222"></a><span id="l11.222"> }</span>
<a href="#l11.223"></a><span id="l11.223"> </span>
<a href="#l11.224"></a><span id="l11.224"> NS_IMETHODIMP nsImapMailFolder::List()</span>
<a href="#l11.225"></a><span id="l11.225"> {</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineat">@@ -1095,17 +1089,17 @@ NS_IMETHODIMP nsImapMailFolder::CreateSt</span>
<a href="#l11.227"></a><span id="l11.227"> </span>
<a href="#l11.228"></a><span id="l11.228">     PRInt32 leafPos = folderName.RFindChar('/');</span>
<a href="#l11.229"></a><span id="l11.229">     nsCAutoString parentName(folderName);</span>
<a href="#l11.230"></a><span id="l11.230"> </span>
<a href="#l11.231"></a><span id="l11.231">     if (leafPos &gt; 0)</span>
<a href="#l11.232"></a><span id="l11.232">     {</span>
<a href="#l11.233"></a><span id="l11.233">       // If there is a hierarchy, there is a parent.</span>
<a href="#l11.234"></a><span id="l11.234">       // Don't strip off slash if it's the first character</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineminus">-      parentName.Truncate(leafPos);</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+      parentName.SetLength(leafPos);</span>
<a href="#l11.237"></a><span id="l11.237">       // get the corresponding RDF resource</span>
<a href="#l11.238"></a><span id="l11.238">       // RDF will create the folder resource if it doesn't already exist</span>
<a href="#l11.239"></a><span id="l11.239">       nsCOMPtr&lt;nsIRDFService&gt; rdf(do_GetService(kRDFServiceCID, &amp;rv));</span>
<a href="#l11.240"></a><span id="l11.240">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.241"></a><span id="l11.241">       nsCOMPtr&lt;nsIRDFResource&gt; resource;</span>
<a href="#l11.242"></a><span id="l11.242">       rv = rdf-&gt;GetResource(parentName, getter_AddRefs(resource));</span>
<a href="#l11.243"></a><span id="l11.243">       if (NS_FAILED(rv)) return rv;</span>
<a href="#l11.244"></a><span id="l11.244">       msgParent = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineat">@@ -1158,20 +1152,19 @@ NS_IMETHODIMP nsImapMailFolder::SetVerif</span>
<a href="#l11.246"></a><span id="l11.246">     while (parent);</span>
<a href="#l11.247"></a><span id="l11.247">   }</span>
<a href="#l11.248"></a><span id="l11.248">   return NS_OK;</span>
<a href="#l11.249"></a><span id="l11.249"> }</span>
<a href="#l11.250"></a><span id="l11.250"> </span>
<a href="#l11.251"></a><span id="l11.251"> NS_IMETHODIMP nsImapMailFolder::GetOnlineDelimiter(char** onlineDelimiter)</span>
<a href="#l11.252"></a><span id="l11.252"> {</span>
<a href="#l11.253"></a><span id="l11.253">   NS_ENSURE_ARG_POINTER(onlineDelimiter);</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineminus">-  char delimiter = 0;</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineminus">-  GetHierarchyDelimiter(&amp;delimiter);</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineminus">-  nsAutoString str(delimiter);</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineminus">-  *onlineDelimiter = ToNewCString(str);</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+  char delimiter[2] = {0, 0};</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineplus">+  GetHierarchyDelimiter(delimiter);</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+  *onlineDelimiter = NS_strdup(delimiter);</span>
<a href="#l11.261"></a><span id="l11.261">   return NS_OK;</span>
<a href="#l11.262"></a><span id="l11.262"> }</span>
<a href="#l11.263"></a><span id="l11.263"> </span>
<a href="#l11.264"></a><span id="l11.264"> NS_IMETHODIMP nsImapMailFolder::SetHierarchyDelimiter(char aHierarchyDelimiter)</span>
<a href="#l11.265"></a><span id="l11.265"> {</span>
<a href="#l11.266"></a><span id="l11.266">   m_hierarchyDelimiter = aHierarchyDelimiter;</span>
<a href="#l11.267"></a><span id="l11.267">   return NS_OK;</span>
<a href="#l11.268"></a><span id="l11.268"> }</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineat">@@ -2158,17 +2151,17 @@ nsImapMailFolder::GetDBFolderInfoAndDB(n</span>
<a href="#l11.270"></a><span id="l11.270"> </span>
<a href="#l11.271"></a><span id="l11.271">       nsCString hostname;</span>
<a href="#l11.272"></a><span id="l11.272">       rv = GetHostname(hostname);</span>
<a href="#l11.273"></a><span id="l11.273">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.274"></a><span id="l11.274"> </span>
<a href="#l11.275"></a><span id="l11.275">       nsCString onlineCName;</span>
<a href="#l11.276"></a><span id="l11.276">       rv = nsImapURI2FullName(kImapRootURI, hostname.get(), uri.get(), getter_Copies(onlineCName));</span>
<a href="#l11.277"></a><span id="l11.277">       if (m_hierarchyDelimiter != '/')</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineminus">-        onlineCName.ReplaceChar('/',  m_hierarchyDelimiter);</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineplus">+        MsgReplaceChar(onlineCName, '/', m_hierarchyDelimiter);</span>
<a href="#l11.280"></a><span id="l11.280">       m_onlineFolderName.Assign(onlineCName);</span>
<a href="#l11.281"></a><span id="l11.281">       CopyASCIItoUTF16(onlineCName, autoOnlineName);</span>
<a href="#l11.282"></a><span id="l11.282">     }</span>
<a href="#l11.283"></a><span id="l11.283">     (*folderInfo)-&gt;SetProperty(&quot;onlineName&quot;, autoOnlineName);</span>
<a href="#l11.284"></a><span id="l11.284">   }</span>
<a href="#l11.285"></a><span id="l11.285">   return rv;</span>
<a href="#l11.286"></a><span id="l11.286"> }</span>
<a href="#l11.287"></a><span id="l11.287"> </span>
<a href="#l11.288"></a><span id="l11.288" class="difflineat">@@ -4655,24 +4648,25 @@ nsImapMailFolder::BeginMessageUpload()</span>
<a href="#l11.289"></a><span id="l11.289"> nsresult nsImapMailFolder::HandleCustomFlags(nsMsgKey uidOfMessage,</span>
<a href="#l11.290"></a><span id="l11.290">                                              nsIMsgDBHdr *dbHdr,</span>
<a href="#l11.291"></a><span id="l11.291">                                              PRUint16 userFlags,</span>
<a href="#l11.292"></a><span id="l11.292">                                              nsCString &amp;keywords)</span>
<a href="#l11.293"></a><span id="l11.293"> {</span>
<a href="#l11.294"></a><span id="l11.294">   ToLowerCase(keywords);</span>
<a href="#l11.295"></a><span id="l11.295">   PRBool messageClassified = PR_TRUE;</span>
<a href="#l11.296"></a><span id="l11.296">   // Mac Mail uses &quot;NotJunk&quot;</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineminus">-  if (keywords.Find(&quot;NonJunk&quot;, PR_TRUE /* ignore case */) != -1 || keywords.Find(&quot;NotJunk&quot;, PR_TRUE /* ignore case */) != -1)</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineplus">+  if (keywords.Find(&quot;NonJunk&quot;, CaseInsensitiveCompare) != -1 ||</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineplus">+      keywords.Find(&quot;NotJunk&quot;, CaseInsensitiveCompare) != -1)</span>
<a href="#l11.300"></a><span id="l11.300">   {</span>
<a href="#l11.301"></a><span id="l11.301">     nsCAutoString msgJunkScore;</span>
<a href="#l11.302"></a><span id="l11.302">     msgJunkScore.AppendInt(nsIJunkMailPlugin::IS_HAM_SCORE);</span>
<a href="#l11.303"></a><span id="l11.303">     mDatabase-&gt;SetStringProperty(uidOfMessage, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l11.304"></a><span id="l11.304">   }</span>
<a href="#l11.305"></a><span id="l11.305">   // ### TODO: we really should parse the keywords into space delimited keywords before checking</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineminus">-  else if (keywords.Find(&quot;Junk&quot;, PR_TRUE /* ignore case */) != -1)</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineplus">+  else if (keywords.Find(&quot;Junk&quot;, CaseInsensitiveCompare) != -1)</span>
<a href="#l11.308"></a><span id="l11.308">   {</span>
<a href="#l11.309"></a><span id="l11.309">     PRUint32 newFlags;</span>
<a href="#l11.310"></a><span id="l11.310">     dbHdr-&gt;AndFlags(~nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l11.311"></a><span id="l11.311">     nsCAutoString msgJunkScore;</span>
<a href="#l11.312"></a><span id="l11.312">     msgJunkScore.AppendInt(nsIJunkMailPlugin::IS_SPAM_SCORE);</span>
<a href="#l11.313"></a><span id="l11.313">     mDatabase-&gt;SetStringProperty(uidOfMessage, &quot;junkscore&quot;, msgJunkScore.get());</span>
<a href="#l11.314"></a><span id="l11.314">   }</span>
<a href="#l11.315"></a><span id="l11.315">   else</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineat">@@ -5309,17 +5303,17 @@ nsImapMailFolder::OnStopRunningUrl(nsIUR</span>
<a href="#l11.317"></a><span id="l11.317">           }</span>
<a href="#l11.318"></a><span id="l11.318">           m_copyState = nsnull;</span>
<a href="#l11.319"></a><span id="l11.319">         }</span>
<a href="#l11.320"></a><span id="l11.320">         break;</span>
<a href="#l11.321"></a><span id="l11.321">       case nsIImapUrl::nsImapRenameFolder:</span>
<a href="#l11.322"></a><span id="l11.322">         if (NS_FAILED(aExitCode))</span>
<a href="#l11.323"></a><span id="l11.323">         {</span>
<a href="#l11.324"></a><span id="l11.324">           nsCOMPtr &lt;nsIAtom&gt; folderRenameAtom;</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineminus">-          folderRenameAtom = do_GetAtom(&quot;RenameCompleted&quot;);</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineplus">+          folderRenameAtom = MsgGetAtom(&quot;RenameCompleted&quot;);</span>
<a href="#l11.327"></a><span id="l11.327">           NotifyFolderEvent(folderRenameAtom);</span>
<a href="#l11.328"></a><span id="l11.328">         }</span>
<a href="#l11.329"></a><span id="l11.329">         break;</span>
<a href="#l11.330"></a><span id="l11.330">       case nsIImapUrl::nsImapDeleteAllMsgs:</span>
<a href="#l11.331"></a><span id="l11.331">           if (NS_SUCCEEDED(aExitCode))</span>
<a href="#l11.332"></a><span id="l11.332">           {</span>
<a href="#l11.333"></a><span id="l11.333">             if (folderOpen)</span>
<a href="#l11.334"></a><span id="l11.334">               UpdateFolder(msgWindow);</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineat">@@ -5355,17 +5349,17 @@ nsImapMailFolder::OnStopRunningUrl(nsIUR</span>
<a href="#l11.336"></a><span id="l11.336">         // we finished getting an admin url for the folder.</span>
<a href="#l11.337"></a><span id="l11.337">           if (!m_adminUrl.IsEmpty())</span>
<a href="#l11.338"></a><span id="l11.338">             FolderPrivileges(msgWindow);</span>
<a href="#l11.339"></a><span id="l11.339">           break;</span>
<a href="#l11.340"></a><span id="l11.340">       case nsIImapUrl::nsImapCreateFolder:</span>
<a href="#l11.341"></a><span id="l11.341">         if (NS_FAILED(aExitCode))  //if success notification already done</span>
<a href="#l11.342"></a><span id="l11.342">         {</span>
<a href="#l11.343"></a><span id="l11.343">           nsCOMPtr &lt;nsIAtom&gt; folderCreateAtom;</span>
<a href="#l11.344"></a><span id="l11.344" class="difflineminus">-          folderCreateAtom = do_GetAtom(&quot;FolderCreateFailed&quot;);</span>
<a href="#l11.345"></a><span id="l11.345" class="difflineplus">+          folderCreateAtom = MsgGetAtom(&quot;FolderCreateFailed&quot;);</span>
<a href="#l11.346"></a><span id="l11.346">           NotifyFolderEvent(folderCreateAtom);</span>
<a href="#l11.347"></a><span id="l11.347">         }</span>
<a href="#l11.348"></a><span id="l11.348">         break;</span>
<a href="#l11.349"></a><span id="l11.349">       case nsIImapUrl::nsImapSubscribe:</span>
<a href="#l11.350"></a><span id="l11.350">         if (NS_SUCCEEDED(aExitCode) &amp;&amp; msgWindow)</span>
<a href="#l11.351"></a><span id="l11.351">         {</span>
<a href="#l11.352"></a><span id="l11.352">           nsCString canonicalFolderName;</span>
<a href="#l11.353"></a><span id="l11.353">           imapUrl-&gt;CreateCanonicalSourceFolderPathString(getter_Copies(canonicalFolderName));</span>
<a href="#l11.354"></a><span id="l11.354" class="difflineat">@@ -6176,24 +6170,62 @@ static PLDHashOperator fillArrayWithKeys</span>
<a href="#l11.355"></a><span id="l11.355"> }</span>
<a href="#l11.356"></a><span id="l11.356"> </span>
<a href="#l11.357"></a><span id="l11.357"> NS_IMETHODIMP nsImapMailFolder::GetOtherUsersWithAccess(</span>
<a href="#l11.358"></a><span id="l11.358">         nsIUTF8StringEnumerator** aResult)</span>
<a href="#l11.359"></a><span id="l11.359"> {</span>
<a href="#l11.360"></a><span id="l11.360">   return GetFolderACL()-&gt;GetOtherUsers(aResult);</span>
<a href="#l11.361"></a><span id="l11.361"> }</span>
<a href="#l11.362"></a><span id="l11.362"> </span>
<a href="#l11.363"></a><span id="l11.363" class="difflineplus">+class AdoptUTF8StringEnumerator : public nsIUTF8StringEnumerator</span>
<a href="#l11.364"></a><span id="l11.364" class="difflineplus">+{</span>
<a href="#l11.365"></a><span id="l11.365" class="difflineplus">+public:</span>
<a href="#l11.366"></a><span id="l11.366" class="difflineplus">+  AdoptUTF8StringEnumerator(nsTArray&lt;nsCString&gt;* array) :</span>
<a href="#l11.367"></a><span id="l11.367" class="difflineplus">+    mIndex(0), mStrings(array)</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineplus">+  {}</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineplus">+  ~AdoptUTF8StringEnumerator()</span>
<a href="#l11.370"></a><span id="l11.370" class="difflineplus">+  {</span>
<a href="#l11.371"></a><span id="l11.371" class="difflineplus">+    delete mStrings;</span>
<a href="#l11.372"></a><span id="l11.372" class="difflineplus">+  }</span>
<a href="#l11.373"></a><span id="l11.373" class="difflineplus">+</span>
<a href="#l11.374"></a><span id="l11.374" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l11.375"></a><span id="l11.375" class="difflineplus">+  NS_DECL_NSIUTF8STRINGENUMERATOR</span>
<a href="#l11.376"></a><span id="l11.376" class="difflineplus">+private:</span>
<a href="#l11.377"></a><span id="l11.377" class="difflineplus">+  nsTArray&lt;nsCString&gt;* mStrings;</span>
<a href="#l11.378"></a><span id="l11.378" class="difflineplus">+  PRUint32             mIndex;</span>
<a href="#l11.379"></a><span id="l11.379" class="difflineplus">+};</span>
<a href="#l11.380"></a><span id="l11.380" class="difflineplus">+</span>
<a href="#l11.381"></a><span id="l11.381" class="difflineplus">+NS_IMPL_ISUPPORTS1(AdoptUTF8StringEnumerator, nsIUTF8StringEnumerator)</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineplus">+</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l11.384"></a><span id="l11.384" class="difflineplus">+AdoptUTF8StringEnumerator::HasMore(PRBool *aResult)</span>
<a href="#l11.385"></a><span id="l11.385" class="difflineplus">+{</span>
<a href="#l11.386"></a><span id="l11.386" class="difflineplus">+  *aResult = mIndex &lt; mStrings-&gt;Length();</span>
<a href="#l11.387"></a><span id="l11.387" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.388"></a><span id="l11.388" class="difflineplus">+}</span>
<a href="#l11.389"></a><span id="l11.389" class="difflineplus">+</span>
<a href="#l11.390"></a><span id="l11.390" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l11.391"></a><span id="l11.391" class="difflineplus">+AdoptUTF8StringEnumerator::GetNext(nsACString&amp; aResult)</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineplus">+{</span>
<a href="#l11.393"></a><span id="l11.393" class="difflineplus">+  if (mIndex &gt;= mStrings-&gt;Length())</span>
<a href="#l11.394"></a><span id="l11.394" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l11.395"></a><span id="l11.395" class="difflineplus">+</span>
<a href="#l11.396"></a><span id="l11.396" class="difflineplus">+  aResult.Assign((*mStrings)[mIndex]);</span>
<a href="#l11.397"></a><span id="l11.397" class="difflineplus">+  ++mIndex;</span>
<a href="#l11.398"></a><span id="l11.398" class="difflineplus">+  return NS_OK;</span>
<a href="#l11.399"></a><span id="l11.399" class="difflineplus">+}</span>
<a href="#l11.400"></a><span id="l11.400" class="difflineplus">+</span>
<a href="#l11.401"></a><span id="l11.401"> nsresult nsMsgIMAPFolderACL::GetOtherUsers(nsIUTF8StringEnumerator** aResult)</span>
<a href="#l11.402"></a><span id="l11.402"> {</span>
<a href="#l11.403"></a><span id="l11.403">   nsTArray&lt;nsCString&gt;* resultArray = new nsTArray&lt;nsCString&gt;;</span>
<a href="#l11.404"></a><span id="l11.404">   // Note: make cast in fillArrayWithKeys() match</span>
<a href="#l11.405"></a><span id="l11.405">   m_rightsHash.EnumerateRead(fillArrayWithKeys, resultArray);</span>
<a href="#l11.406"></a><span id="l11.406"> </span>
<a href="#l11.407"></a><span id="l11.407">   // enumerator will free resultArray</span>
<a href="#l11.408"></a><span id="l11.408" class="difflineminus">-  NS_NewAdoptingUTF8StringEnumerator(aResult, resultArray);</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineplus">+  *aResult = new AdoptUTF8StringEnumerator(resultArray);</span>
<a href="#l11.410"></a><span id="l11.410">   return NS_OK;</span>
<a href="#l11.411"></a><span id="l11.411"> }</span>
<a href="#l11.412"></a><span id="l11.412"> </span>
<a href="#l11.413"></a><span id="l11.413"> nsresult nsImapMailFolder::GetPermissionsForUser(const nsACString&amp; otherUser,</span>
<a href="#l11.414"></a><span id="l11.414">         nsACString&amp; aResult)</span>
<a href="#l11.415"></a><span id="l11.415"> {</span>
<a href="#l11.416"></a><span id="l11.416">   nsCString str;</span>
<a href="#l11.417"></a><span id="l11.417">   nsresult rv = GetFolderACL()-&gt;GetRightsStringForUser(otherUser, str);</span>
<a href="#l11.418"></a><span id="l11.418" class="difflineat">@@ -6373,18 +6405,22 @@ PRBool nsMsgIMAPFolderACL::GetDoIHaveFul</span>
<a href="#l11.419"></a><span id="l11.419"> // Returns a newly allocated string describing these rights</span>
<a href="#l11.420"></a><span id="l11.420"> nsresult nsMsgIMAPFolderACL::CreateACLRightsString(nsAString&amp; aRightsString)</span>
<a href="#l11.421"></a><span id="l11.421"> {</span>
<a href="#l11.422"></a><span id="l11.422">   nsString curRight;</span>
<a href="#l11.423"></a><span id="l11.423">   nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l11.424"></a><span id="l11.424">   nsresult rv = IMAPGetStringBundle(getter_AddRefs(bundle));</span>
<a href="#l11.425"></a><span id="l11.425">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.426"></a><span id="l11.426"> </span>
<a href="#l11.427"></a><span id="l11.427" class="difflineminus">-  if (GetDoIHaveFullRightsForFolder())</span>
<a href="#l11.428"></a><span id="l11.428" class="difflineminus">-    return bundle-&gt;GetStringFromID(IMAP_ACL_FULL_RIGHTS, getter_Copies(aRightsString));</span>
<a href="#l11.429"></a><span id="l11.429" class="difflineplus">+  if (GetDoIHaveFullRightsForFolder()) {</span>
<a href="#l11.430"></a><span id="l11.430" class="difflineplus">+    nsAutoString result;</span>
<a href="#l11.431"></a><span id="l11.431" class="difflineplus">+    rv = bundle-&gt;GetStringFromID(IMAP_ACL_FULL_RIGHTS, getter_Copies(result));</span>
<a href="#l11.432"></a><span id="l11.432" class="difflineplus">+    aRightsString.Assign(result);</span>
<a href="#l11.433"></a><span id="l11.433" class="difflineplus">+    return rv;</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineplus">+  }</span>
<a href="#l11.435"></a><span id="l11.435">   else</span>
<a href="#l11.436"></a><span id="l11.436">   {</span>
<a href="#l11.437"></a><span id="l11.437">     if (GetCanIReadFolder())</span>
<a href="#l11.438"></a><span id="l11.438">     {</span>
<a href="#l11.439"></a><span id="l11.439">       bundle-&gt;GetStringFromID(IMAP_ACL_READ_RIGHT, getter_Copies(curRight));</span>
<a href="#l11.440"></a><span id="l11.440">       aRightsString.Append(curRight);</span>
<a href="#l11.441"></a><span id="l11.441">     }</span>
<a href="#l11.442"></a><span id="l11.442">     if (GetCanIWriteFolder())</span>
<a href="#l11.443"></a><span id="l11.443" class="difflineat">@@ -7435,20 +7471,21 @@ nsImapFolderCopyState::StartNextCopy()</span>
<a href="#l11.444"></a><span id="l11.444"> {</span>
<a href="#l11.445"></a><span id="l11.445">   nsresult rv;</span>
<a href="#l11.446"></a><span id="l11.446">   // first make sure dest folder exists.</span>
<a href="#l11.447"></a><span id="l11.447">   nsCOMPtr &lt;nsIImapService&gt; imapService = do_GetService (NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l11.448"></a><span id="l11.448">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.449"></a><span id="l11.449">   nsString folderName;</span>
<a href="#l11.450"></a><span id="l11.450">   m_curSrcFolder-&gt;GetName(folderName);</span>
<a href="#l11.451"></a><span id="l11.451"> </span>
<a href="#l11.452"></a><span id="l11.452" class="difflineminus">-  return imapService-&gt;EnsureFolderExists(NS_GetCurrentThread(),</span>
<a href="#l11.453"></a><span id="l11.453" class="difflineminus">-                                       m_curDestParent,</span>
<a href="#l11.454"></a><span id="l11.454" class="difflineminus">-                                       folderName,</span>
<a href="#l11.455"></a><span id="l11.455" class="difflineminus">-                                       this, nsnull);</span>
<a href="#l11.456"></a><span id="l11.456" class="difflineplus">+  nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineplus">+  return imapService-&gt;EnsureFolderExists(thread,</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineplus">+                                         m_curDestParent,</span>
<a href="#l11.459"></a><span id="l11.459" class="difflineplus">+                                         folderName,</span>
<a href="#l11.460"></a><span id="l11.460" class="difflineplus">+                                         this, nsnull);</span>
<a href="#l11.461"></a><span id="l11.461"> }</span>
<a href="#l11.462"></a><span id="l11.462"> </span>
<a href="#l11.463"></a><span id="l11.463"> nsresult nsImapFolderCopyState::AdvanceToNextFolder(nsresult aStatus)</span>
<a href="#l11.464"></a><span id="l11.464"> {</span>
<a href="#l11.465"></a><span id="l11.465">   nsresult rv;</span>
<a href="#l11.466"></a><span id="l11.466">   m_childIndex++;</span>
<a href="#l11.467"></a><span id="l11.467">   PRUint32 childCount = 0;</span>
<a href="#l11.468"></a><span id="l11.468">   if (m_srcChildFolders)</span>
<a href="#l11.469"></a><span id="l11.469" class="difflineat">@@ -8000,17 +8037,19 @@ NS_IMETHODIMP nsImapMailFolder::GetFolde</span>
<a href="#l11.470"></a><span id="l11.470"> {</span>
<a href="#l11.471"></a><span id="l11.471">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l11.472"></a><span id="l11.472">   nsresult rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l11.473"></a><span id="l11.473">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.474"></a><span id="l11.474">   rootFolder-&gt;GetURI(aFolderURL);</span>
<a href="#l11.475"></a><span id="l11.475"> </span>
<a href="#l11.476"></a><span id="l11.476">   NS_ASSERTION(mURI.Length() &gt; aFolderURL.Length(), &quot;Should match with a folder name!&quot;);</span>
<a href="#l11.477"></a><span id="l11.477">   nsCString escapedName;</span>
<a href="#l11.478"></a><span id="l11.478" class="difflineminus">-  escapedName.Adopt(nsEscape(mURI.get() + aFolderURL.Length(), url_Path));</span>
<a href="#l11.479"></a><span id="l11.479" class="difflineplus">+  MsgEscapeString(Substring(mURI, aFolderURL.Length()),</span>
<a href="#l11.480"></a><span id="l11.480" class="difflineplus">+                  nsINetUtil::ESCAPE_URL_PATH,</span>
<a href="#l11.481"></a><span id="l11.481" class="difflineplus">+                  escapedName);</span>
<a href="#l11.482"></a><span id="l11.482">   if (escapedName.IsEmpty())</span>
<a href="#l11.483"></a><span id="l11.483">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l11.484"></a><span id="l11.484">   aFolderURL.Append(escapedName);</span>
<a href="#l11.485"></a><span id="l11.485">   return NS_OK;</span>
<a href="#l11.486"></a><span id="l11.486"> }</span>
<a href="#l11.487"></a><span id="l11.487"> </span>
<a href="#l11.488"></a><span id="l11.488"> NS_IMETHODIMP nsImapMailFolder::GetFolderNeedsSubscribing(PRBool *bVal)</span>
<a href="#l11.489"></a><span id="l11.489"> {</span>
<a href="#l11.490"></a><span id="l11.490" class="difflineat">@@ -8267,17 +8306,17 @@ NS_IMETHODIMP nsImapMailFolder::RenameCl</span>
<a href="#l11.491"></a><span id="l11.491">   rv = CopyMUTF7toUTF16(PromiseFlatCString(newName), newNameString);</span>
<a href="#l11.492"></a><span id="l11.492">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l11.493"></a><span id="l11.493">   newLeafName = newNameString;</span>
<a href="#l11.494"></a><span id="l11.494">   nsAutoString parentName;</span>
<a href="#l11.495"></a><span id="l11.495">   nsAutoString folderNameStr;</span>
<a href="#l11.496"></a><span id="l11.496">   PRInt32 folderStart = newLeafName.RFindChar('/');  //internal use of hierarchyDelimiter is always '/'</span>
<a href="#l11.497"></a><span id="l11.497">   if (folderStart &gt; 0)</span>
<a href="#l11.498"></a><span id="l11.498">   {</span>
<a href="#l11.499"></a><span id="l11.499" class="difflineminus">-    newNameString.Right(newLeafName, newLeafName.Length() - folderStart - 1);</span>
<a href="#l11.500"></a><span id="l11.500" class="difflineplus">+    newLeafName = Substring(newNameString, folderStart + 1);</span>
<a href="#l11.501"></a><span id="l11.501">     CreateDirectoryForFolder(getter_AddRefs(pathFile));    //needed when we move a folder to a folder with no subfolders.</span>
<a href="#l11.502"></a><span id="l11.502">   }</span>
<a href="#l11.503"></a><span id="l11.503"> </span>
<a href="#l11.504"></a><span id="l11.504">   // if we get here, it's really a leaf, and &quot;this&quot; is the parent.</span>
<a href="#l11.505"></a><span id="l11.505">   folderNameStr = newLeafName;</span>
<a href="#l11.506"></a><span id="l11.506"> </span>
<a href="#l11.507"></a><span id="l11.507">   // Create an empty database for this mail folder, set its name from the user</span>
<a href="#l11.508"></a><span id="l11.508">   nsCOMPtr&lt;nsIMsgDatabase&gt; mailDBFactory;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapOfflineSync.cpp</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -50,16 +50,17 @@</span>
<a href="#l12.4"></a><span id="l12.4"> #include &quot;nsIRequestObserver.h&quot;</span>
<a href="#l12.5"></a><span id="l12.5"> #include &quot;nsDirectoryServiceDefs.h&quot;</span>
<a href="#l12.6"></a><span id="l12.6"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l12.7"></a><span id="l12.7"> #include &quot;nsIMsgCopyService.h&quot;</span>
<a href="#l12.8"></a><span id="l12.8"> #include &quot;nsImapProtocol.h&quot;</span>
<a href="#l12.9"></a><span id="l12.9"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l12.10"></a><span id="l12.10"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l12.11"></a><span id="l12.11"> #include &quot;nsIAutoSyncManager.h&quot;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+#include &quot;nsAlgorithm.h&quot;</span>
<a href="#l12.13"></a><span id="l12.13"> </span>
<a href="#l12.14"></a><span id="l12.14"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l12.15"></a><span id="l12.15"> </span>
<a href="#l12.16"></a><span id="l12.16"> NS_IMPL_ISUPPORTS3(nsImapOfflineSync, nsIUrlListener, nsIMsgCopyServiceListener, nsIDBChangeListener)</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18"> nsImapOfflineSync::nsImapOfflineSync(nsIMsgWindow *window, nsIUrlListener *listener, nsIMsgFolder *singleFolderOnly, PRBool isPseudoOffline)</span>
<a href="#l12.19"></a><span id="l12.19"> {</span>
<a href="#l12.20"></a><span id="l12.20">   m_singleFolderToUpdate = singleFolderOnly;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -46,17 +46,16 @@</span>
<a href="#l13.4"></a><span id="l13.4"> </span>
<a href="#l13.5"></a><span id="l13.5"> // as does this</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;msgCore.h&quot;  // for pre-compiled headers</span>
<a href="#l13.7"></a><span id="l13.7"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l13.8"></a><span id="l13.8"> </span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nsICharsetConverterManager.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l13.13"></a><span id="l13.13"> </span>
<a href="#l13.14"></a><span id="l13.14"> #include &quot;nsMsgImapCID.h&quot;</span>
<a href="#l13.15"></a><span id="l13.15"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l13.16"></a><span id="l13.16"> #include &quot;nsISupportsObsolete.h&quot;</span>
<a href="#l13.17"></a><span id="l13.17"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l13.18"></a><span id="l13.18"> #include &quot;nsImapCore.h&quot;</span>
<a href="#l13.19"></a><span id="l13.19"> #include &quot;nsImapProtocol.h&quot;</span>
<a href="#l13.20"></a><span id="l13.20"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineat">@@ -66,28 +65,26 @@</span>
<a href="#l13.22"></a><span id="l13.22"> #include &quot;nsImapServerResponseParser.h&quot;</span>
<a href="#l13.23"></a><span id="l13.23"> #include &quot;nspr.h&quot;</span>
<a href="#l13.24"></a><span id="l13.24"> #include &quot;plbase64.h&quot;</span>
<a href="#l13.25"></a><span id="l13.25"> #include &quot;nsIImapService.h&quot;</span>
<a href="#l13.26"></a><span id="l13.26"> #include &quot;nsISocketTransportService.h&quot;</span>
<a href="#l13.27"></a><span id="l13.27"> #include &quot;nsIStreamListenerTee.h&quot;</span>
<a href="#l13.28"></a><span id="l13.28"> #include &quot;nsXPCOMCIDInternal.h&quot;</span>
<a href="#l13.29"></a><span id="l13.29"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l13.31"></a><span id="l13.31"> #include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l13.32"></a><span id="l13.32"> #include &quot;nsIPipe.h&quot;</span>
<a href="#l13.33"></a><span id="l13.33"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l13.34"></a><span id="l13.34"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l13.35"></a><span id="l13.35"> #include &quot;nsImapStringBundle.h&quot;</span>
<a href="#l13.36"></a><span id="l13.36"> #include &quot;nsICopyMsgStreamListener.h&quot;</span>
<a href="#l13.37"></a><span id="l13.37"> #include &quot;nsTextFormatter.h&quot;</span>
<a href="#l13.38"></a><span id="l13.38"> #include &quot;nsAutoLock.h&quot;</span>
<a href="#l13.39"></a><span id="l13.39"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l13.40"></a><span id="l13.40"> #include &quot;nsMsgI18N.h&quot;</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-#include &quot;nsEscape.h&quot;</span>
<a href="#l13.42"></a><span id="l13.42"> // for the memory cache...</span>
<a href="#l13.43"></a><span id="l13.43"> #include &quot;nsICacheEntryDescriptor.h&quot;</span>
<a href="#l13.44"></a><span id="l13.44"> #include &quot;nsICacheSession.h&quot;</span>
<a href="#l13.45"></a><span id="l13.45"> #include &quot;nsIPrompt.h&quot;</span>
<a href="#l13.46"></a><span id="l13.46"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l13.47"></a><span id="l13.47"> #include &quot;nsIDocShellLoadInfo.h&quot;</span>
<a href="#l13.48"></a><span id="l13.48"> #include &quot;nsIDOMWindowInternal.h&quot;</span>
<a href="#l13.49"></a><span id="l13.49"> #include &quot;nsIMessengerWindowService.h&quot;</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineat">@@ -110,16 +107,17 @@ PRLogModuleInfo *IMAP;</span>
<a href="#l13.51"></a><span id="l13.51"> #include &quot;nsIProxyObjectManager.h&quot;</span>
<a href="#l13.52"></a><span id="l13.52"> #include &quot;nsIStreamConverterService.h&quot;</span>
<a href="#l13.53"></a><span id="l13.53"> #include &quot;nsIProxyInfo.h&quot;</span>
<a href="#l13.54"></a><span id="l13.54"> #include &quot;nsISSLSocketControl.h&quot;</span>
<a href="#l13.55"></a><span id="l13.55"> #include &quot;nsProxyRelease.h&quot;</span>
<a href="#l13.56"></a><span id="l13.56"> #include &quot;nsDebug.h&quot;</span>
<a href="#l13.57"></a><span id="l13.57"> #include &quot;nsMsgCompressIStream.h&quot;</span>
<a href="#l13.58"></a><span id="l13.58"> #include &quot;nsMsgCompressOStream.h&quot;</span>
<a href="#l13.59"></a><span id="l13.59" class="difflineplus">+#include &quot;nsAlgorithm.h&quot;</span>
<a href="#l13.60"></a><span id="l13.60"> </span>
<a href="#l13.61"></a><span id="l13.61"> #define ONE_SECOND ((PRUint32)1000)    // one second</span>
<a href="#l13.62"></a><span id="l13.62"> </span>
<a href="#l13.63"></a><span id="l13.63"> </span>
<a href="#l13.64"></a><span id="l13.64"> #define OUTPUT_BUFFER_SIZE (4096*2) // mscott - i should be able to remove this if I can use nsMsgLineBuffer???</span>
<a href="#l13.65"></a><span id="l13.65"> </span>
<a href="#l13.66"></a><span id="l13.66"> #define IMAP_ENV_HEADERS &quot;From To Cc Bcc Subject Date Message-ID &quot;</span>
<a href="#l13.67"></a><span id="l13.67"> #define IMAP_DB_HEADERS &quot;Priority X-Priority References Newsgroups In-Reply-To Content-Type&quot;</span>
<a href="#l13.68"></a><span id="l13.68" class="difflineat">@@ -691,17 +689,17 @@ static void SetSecurityCallbacksFromChan</span>
<a href="#l13.69"></a><span id="l13.69"> {</span>
<a href="#l13.70"></a><span id="l13.70">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; callbacks;</span>
<a href="#l13.71"></a><span id="l13.71">   aChannel-&gt;GetNotificationCallbacks(getter_AddRefs(callbacks));</span>
<a href="#l13.72"></a><span id="l13.72"> </span>
<a href="#l13.73"></a><span id="l13.73">   nsCOMPtr&lt;nsILoadGroup&gt; loadGroup;</span>
<a href="#l13.74"></a><span id="l13.74">   aChannel-&gt;GetLoadGroup(getter_AddRefs(loadGroup));</span>
<a href="#l13.75"></a><span id="l13.75"> </span>
<a href="#l13.76"></a><span id="l13.76">   nsCOMPtr&lt;nsIInterfaceRequestor&gt; securityCallbacks;</span>
<a href="#l13.77"></a><span id="l13.77" class="difflineminus">-  NS_NewNotificationCallbacksAggregation(callbacks, loadGroup,</span>
<a href="#l13.78"></a><span id="l13.78" class="difflineplus">+  MsgNewNotificationCallbacksAggregation(callbacks, loadGroup,</span>
<a href="#l13.79"></a><span id="l13.79">                                          getter_AddRefs(securityCallbacks));</span>
<a href="#l13.80"></a><span id="l13.80">   if (securityCallbacks)</span>
<a href="#l13.81"></a><span id="l13.81">     aTrans-&gt;SetSecurityCallbacks(securityCallbacks);</span>
<a href="#l13.82"></a><span id="l13.82"> }</span>
<a href="#l13.83"></a><span id="l13.83"> </span>
<a href="#l13.84"></a><span id="l13.84"> // Setup With Url is intended to set up data which is held on a PER URL basis and not</span>
<a href="#l13.85"></a><span id="l13.85"> // a per connection basis. If you have data which is independent of the url we are currently</span>
<a href="#l13.86"></a><span id="l13.86"> // running, then you should put it in Initialize().</span>
<a href="#l13.87"></a><span id="l13.87" class="difflineat">@@ -790,17 +788,17 @@ nsresult nsImapProtocol::SetupWithUrl(ns</span>
<a href="#l13.88"></a><span id="l13.88">     }</span>
<a href="#l13.89"></a><span id="l13.89"> </span>
<a href="#l13.90"></a><span id="l13.90">     // since we'll be making calls directly from the imap thread to the channel listener,</span>
<a href="#l13.91"></a><span id="l13.91">     // we need to turn it into a proxy object....we'll assume that the listener is on the same thread</span>
<a href="#l13.92"></a><span id="l13.92">     // as the event sink queue</span>
<a href="#l13.93"></a><span id="l13.93">     if (aRealStreamListener)</span>
<a href="#l13.94"></a><span id="l13.94">     {</span>
<a href="#l13.95"></a><span id="l13.95">       NS_ASSERTION(!m_channelListener, &quot;shouldn't already have a channel listener&quot;);</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineminus">-      rv = NS_GetProxyForObject(m_sinkEventTarget,</span>
<a href="#l13.97"></a><span id="l13.97" class="difflineplus">+      rv = MsgGetProxyForObject(m_sinkEventTarget,</span>
<a href="#l13.98"></a><span id="l13.98">                                 NS_GET_IID(nsIStreamListener),</span>
<a href="#l13.99"></a><span id="l13.99">                                 aRealStreamListener,</span>
<a href="#l13.100"></a><span id="l13.100">                                 NS_PROXY_SYNC | NS_PROXY_ALWAYS,</span>
<a href="#l13.101"></a><span id="l13.101">                                 getter_AddRefs(m_channelListener));</span>
<a href="#l13.102"></a><span id="l13.102">       if (NS_FAILED(rv)) return rv;</span>
<a href="#l13.103"></a><span id="l13.103">     }</span>
<a href="#l13.104"></a><span id="l13.104"> </span>
<a href="#l13.105"></a><span id="l13.105">     PRUint32 capability = kCapabilityUndefined;</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineat">@@ -3305,17 +3303,17 @@ nsImapProtocol::FetchMessage(const nsCSt</span>
<a href="#l13.107"></a><span id="l13.107">       {</span>
<a href="#l13.108"></a><span id="l13.108">         char *headersToDL = nsnull;</span>
<a href="#l13.109"></a><span id="l13.109">         char *what = nsnull;</span>
<a href="#l13.110"></a><span id="l13.110">         const char *dbHeaders = (gUseEnvelopeCmd) ? IMAP_DB_HEADERS : IMAP_ENV_AND_DB_HEADERS;</span>
<a href="#l13.111"></a><span id="l13.111">         nsCString arbitraryHeaders;</span>
<a href="#l13.112"></a><span id="l13.112">         GetArbitraryHeadersToDownload(arbitraryHeaders);</span>
<a href="#l13.113"></a><span id="l13.113">         for (PRUint32 i = 0; i &lt; mCustomDBHeaders.Length(); i++)</span>
<a href="#l13.114"></a><span id="l13.114">         {</span>
<a href="#l13.115"></a><span id="l13.115" class="difflineminus">-          if (arbitraryHeaders.Find(mCustomDBHeaders[i], PR_TRUE) == kNotFound)</span>
<a href="#l13.116"></a><span id="l13.116" class="difflineplus">+          if (arbitraryHeaders.Find(mCustomDBHeaders[i], CaseInsensitiveCompare) == kNotFound)</span>
<a href="#l13.117"></a><span id="l13.117">           {</span>
<a href="#l13.118"></a><span id="l13.118">             if (!arbitraryHeaders.IsEmpty())</span>
<a href="#l13.119"></a><span id="l13.119">               arbitraryHeaders.Append(' ');</span>
<a href="#l13.120"></a><span id="l13.120">             arbitraryHeaders.Append(mCustomDBHeaders[i]);</span>
<a href="#l13.121"></a><span id="l13.121">           }</span>
<a href="#l13.122"></a><span id="l13.122">         }</span>
<a href="#l13.123"></a><span id="l13.123">         if (arbitraryHeaders.IsEmpty())</span>
<a href="#l13.124"></a><span id="l13.124">           headersToDL = strdup(dbHeaders);</span>
<a href="#l13.125"></a><span id="l13.125" class="difflineat">@@ -4278,20 +4276,20 @@ PRBool nsImapProtocol::CheckNewMail()</span>
<a href="#l13.126"></a><span id="l13.126">   if (!IMAP)</span>
<a href="#l13.127"></a><span id="l13.127">     IMAP = PR_NewLogModule(&quot;IMAP&quot;);</span>
<a href="#l13.128"></a><span id="l13.128"> </span>
<a href="#l13.129"></a><span id="l13.129">   if (PR_LOG_TEST(IMAP, PR_LOG_ALWAYS))</span>
<a href="#l13.130"></a><span id="l13.130">   {</span>
<a href="#l13.131"></a><span id="l13.131">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l13.132"></a><span id="l13.132">     if (mailnewsUrl)</span>
<a href="#l13.133"></a><span id="l13.133">     {</span>
<a href="#l13.134"></a><span id="l13.134" class="difflineminus">-      nsCAutoString urlSpec;</span>
<a href="#l13.135"></a><span id="l13.135" class="difflineplus">+      nsCAutoString urlSpec, unescapedUrlSpec;</span>
<a href="#l13.136"></a><span id="l13.136">       mailnewsUrl-&gt;GetSpec(urlSpec);</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineminus">-      nsUnescape(urlSpec.BeginWriting());</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-      PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;%s:%s&quot;, logMsg, urlSpec.get()));</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+      MsgUnescapeString(urlSpec, 0, unescapedUrlSpec);</span>
<a href="#l13.140"></a><span id="l13.140" class="difflineplus">+      PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;%s:%s&quot;, logMsg, unescapedUrlSpec.get()));</span>
<a href="#l13.141"></a><span id="l13.141">     }</span>
<a href="#l13.142"></a><span id="l13.142">   }</span>
<a href="#l13.143"></a><span id="l13.143"> }</span>
<a href="#l13.144"></a><span id="l13.144"> </span>
<a href="#l13.145"></a><span id="l13.145"> // log info including current state...</span>
<a href="#l13.146"></a><span id="l13.146"> void nsImapProtocol::Log(const char *logSubName, const char *extraInfo, const char *logData)</span>
<a href="#l13.147"></a><span id="l13.147"> {</span>
<a href="#l13.148"></a><span id="l13.148">   if (PR_LOG_TEST(IMAP, PR_LOG_ALWAYS))</span>
<a href="#l13.149"></a><span id="l13.149" class="difflineat">@@ -4308,17 +4306,17 @@ void nsImapProtocol::Log(const char *log</span>
<a href="#l13.150"></a><span id="l13.150"> </span>
<a href="#l13.151"></a><span id="l13.151">     const int kLogDataChunkSize = 400; // nspr line length is 512, and we</span>
<a href="#l13.152"></a><span id="l13.152">                                        // allow some space for the log preamble.</span>
<a href="#l13.153"></a><span id="l13.153"> </span>
<a href="#l13.154"></a><span id="l13.154">     // break up buffers &gt; 400 bytes on line boundaries.</span>
<a href="#l13.155"></a><span id="l13.155">     if (logDataLen &gt; kLogDataChunkSize)</span>
<a href="#l13.156"></a><span id="l13.156">     {</span>
<a href="#l13.157"></a><span id="l13.157">       logDataLines.Assign(logData);</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineminus">-      lastLineEnd = logDataLines.RFindChar('\n', kLogDataChunkSize);</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+      lastLineEnd = MsgRFindChar(logDataLines, '\n', kLogDataChunkSize);</span>
<a href="#l13.160"></a><span id="l13.160">       // null terminate the last line</span>
<a href="#l13.161"></a><span id="l13.161">       if (lastLineEnd == kNotFound)</span>
<a href="#l13.162"></a><span id="l13.162">         lastLineEnd = kLogDataChunkSize - 1;</span>
<a href="#l13.163"></a><span id="l13.163"> </span>
<a href="#l13.164"></a><span id="l13.164">       logDataLines.Insert( '\0', lastLineEnd + 1);</span>
<a href="#l13.165"></a><span id="l13.165">       logDataToLog = logDataLines.get();</span>
<a href="#l13.166"></a><span id="l13.166">     }</span>
<a href="#l13.167"></a><span id="l13.167">     else</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineat">@@ -4353,18 +4351,17 @@ void nsImapProtocol::Log(const char *log</span>
<a href="#l13.169"></a><span id="l13.169">     }</span>
<a href="#l13.170"></a><span id="l13.170">     }</span>
<a href="#l13.171"></a><span id="l13.171"> </span>
<a href="#l13.172"></a><span id="l13.172">     // dump the rest of the string in &lt; 400 byte chunks</span>
<a href="#l13.173"></a><span id="l13.173">     while (logDataLen &gt; kLogDataChunkSize)</span>
<a href="#l13.174"></a><span id="l13.174">     {</span>
<a href="#l13.175"></a><span id="l13.175">       logDataLines.Cut(0, lastLineEnd + 2); // + 2 to account for the LF and the '\0' we added</span>
<a href="#l13.176"></a><span id="l13.176">       logDataLen = logDataLines.Length();</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineminus">-      lastLineEnd = (logDataLen &gt; kLogDataChunkSize)</span>
<a href="#l13.178"></a><span id="l13.178" class="difflineminus">-                    ? logDataLines.RFindChar('\n', kLogDataChunkSize) : kNotFound;</span>
<a href="#l13.179"></a><span id="l13.179" class="difflineplus">+      lastLineEnd = (logDataLen &gt; kLogDataChunkSize) ? MsgRFindChar(logDataLines, '\n', kLogDataChunkSize) : kNotFound;</span>
<a href="#l13.180"></a><span id="l13.180">       // null terminate the last line</span>
<a href="#l13.181"></a><span id="l13.181">       if (lastLineEnd == kNotFound)</span>
<a href="#l13.182"></a><span id="l13.182">         lastLineEnd = kLogDataChunkSize - 1;</span>
<a href="#l13.183"></a><span id="l13.183">       logDataLines.Insert( '\0', lastLineEnd + 1);</span>
<a href="#l13.184"></a><span id="l13.184">       logDataToLog = logDataLines.get();</span>
<a href="#l13.185"></a><span id="l13.185">       PR_LOG(IMAP, PR_LOG_ALWAYS, (&quot;%.400s&quot;, logDataToLog));</span>
<a href="#l13.186"></a><span id="l13.186">     }</span>
<a href="#l13.187"></a><span id="l13.187">   }</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineat">@@ -4413,17 +4410,17 @@ PRUint32 nsImapProtocol::GetMessageSize(</span>
<a href="#l13.189"></a><span id="l13.189">     return rv;</span>
<a href="#l13.190"></a><span id="l13.190">   }</span>
<a href="#l13.191"></a><span id="l13.191">   return 0;</span>
<a href="#l13.192"></a><span id="l13.192"> }</span>
<a href="#l13.193"></a><span id="l13.193"> </span>
<a href="#l13.194"></a><span id="l13.194"> // message id string utility functions</span>
<a href="#l13.195"></a><span id="l13.195"> /* static */PRBool nsImapProtocol::HandlingMultipleMessages(const nsCString &amp; messageIdString)</span>
<a href="#l13.196"></a><span id="l13.196"> {</span>
<a href="#l13.197"></a><span id="l13.197" class="difflineminus">-  return (messageIdString.FindCharInSet(&quot;,:&quot;) != kNotFound);</span>
<a href="#l13.198"></a><span id="l13.198" class="difflineplus">+  return (MsgFindCharInSet(messageIdString, &quot;,:&quot;) != kNotFound);</span>
<a href="#l13.199"></a><span id="l13.199"> }</span>
<a href="#l13.200"></a><span id="l13.200"> </span>
<a href="#l13.201"></a><span id="l13.201"> PRUint32 nsImapProtocol::CountMessagesInIdString(const char *idString)</span>
<a href="#l13.202"></a><span id="l13.202"> {</span>
<a href="#l13.203"></a><span id="l13.203">   PRUint32 numberOfMessages = 0;</span>
<a href="#l13.204"></a><span id="l13.204">   char *uidString = PL_strdup(idString);</span>
<a href="#l13.205"></a><span id="l13.205"> </span>
<a href="#l13.206"></a><span id="l13.206">   if (uidString)</span>
<a href="#l13.207"></a><span id="l13.207" class="difflineat">@@ -5395,17 +5392,17 @@ void nsImapProtocol::Language()</span>
<a href="#l13.208"></a><span id="l13.208">     // we need to parse out the first language out of this comma separated list....</span>
<a href="#l13.209"></a><span id="l13.209">     // i.e if we have en,ja we only want to send en to the server.</span>
<a href="#l13.210"></a><span id="l13.210">     if (mAcceptLanguages.get())</span>
<a href="#l13.211"></a><span id="l13.211">     {</span>
<a href="#l13.212"></a><span id="l13.212">       nsCAutoString extractedLanguage;</span>
<a href="#l13.213"></a><span id="l13.213">       LossyCopyUTF16toASCII(mAcceptLanguages, extractedLanguage);</span>
<a href="#l13.214"></a><span id="l13.214">       PRInt32 pos = extractedLanguage.FindChar(',');</span>
<a href="#l13.215"></a><span id="l13.215">       if (pos &gt; 0) // we have a comma separated list of languages...</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineminus">-        extractedLanguage.Truncate(pos); // truncate everything after the first comma (including the comma)</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+        extractedLanguage.SetLength(pos); // truncate everything after the first comma (including the comma)</span>
<a href="#l13.218"></a><span id="l13.218"> </span>
<a href="#l13.219"></a><span id="l13.219">       if (extractedLanguage.IsEmpty())</span>
<a href="#l13.220"></a><span id="l13.220">         return;</span>
<a href="#l13.221"></a><span id="l13.221"> </span>
<a href="#l13.222"></a><span id="l13.222">       command.Append(&quot; LANGUAGE &quot;);</span>
<a href="#l13.223"></a><span id="l13.223">       command.Append(extractedLanguage);</span>
<a href="#l13.224"></a><span id="l13.224">       command.Append(CRLF);</span>
<a href="#l13.225"></a><span id="l13.225"> </span>
<a href="#l13.226"></a><span id="l13.226" class="difflineat">@@ -6279,17 +6276,17 @@ void nsImapProtocol::OnRefreshAllACLs()</span>
<a href="#l13.227"></a><span id="l13.227">   PRInt32 total = m_listedMailboxList.Count(), count = 0;</span>
<a href="#l13.228"></a><span id="l13.228">   GetServerStateParser().SetReportingErrors(PR_FALSE);</span>
<a href="#l13.229"></a><span id="l13.229">   for (PRInt32 i = 0; i &lt; total; i++)</span>
<a href="#l13.230"></a><span id="l13.230">   {</span>
<a href="#l13.231"></a><span id="l13.231">     mb = (nsIMAPMailboxInfo *) m_listedMailboxList.ElementAt(i);</span>
<a href="#l13.232"></a><span id="l13.232">     if (mb) // paranoia</span>
<a href="#l13.233"></a><span id="l13.233">     {</span>
<a href="#l13.234"></a><span id="l13.234">       char *onlineName = nsnull;</span>
<a href="#l13.235"></a><span id="l13.235" class="difflineminus">-      m_runningUrl-&gt;AllocateServerPath(nsPromiseFlatCString(mb-&gt;GetMailboxName()).get(), mb-&gt;GetDelimiter(), &amp;onlineName);</span>
<a href="#l13.236"></a><span id="l13.236" class="difflineplus">+      m_runningUrl-&gt;AllocateServerPath(PromiseFlatCString(mb-&gt;GetMailboxName()).get(), mb-&gt;GetDelimiter(), &amp;onlineName);</span>
<a href="#l13.237"></a><span id="l13.237">       if (onlineName)</span>
<a href="#l13.238"></a><span id="l13.238">       {</span>
<a href="#l13.239"></a><span id="l13.239">         RefreshACLForFolder(onlineName);</span>
<a href="#l13.240"></a><span id="l13.240">         NS_Free(onlineName);</span>
<a href="#l13.241"></a><span id="l13.241">       }</span>
<a href="#l13.242"></a><span id="l13.242">       PercentProgressUpdateEvent(NULL, count, total);</span>
<a href="#l13.243"></a><span id="l13.243">       delete mb;</span>
<a href="#l13.244"></a><span id="l13.244">       count++;</span>
<a href="#l13.245"></a><span id="l13.245" class="difflineat">@@ -6940,23 +6937,22 @@ void nsImapProtocol::OnMoveFolderHierarc</span>
<a href="#l13.246"></a><span id="l13.246">         nsCString newBoxName;</span>
<a href="#l13.247"></a><span id="l13.247">         char onlineDirSeparator = kOnlineHierarchySeparatorUnknown;</span>
<a href="#l13.248"></a><span id="l13.248"> </span>
<a href="#l13.249"></a><span id="l13.249">         m_runningUrl-&gt;GetOnlineSubDirSeparator(&amp;onlineDirSeparator);</span>
<a href="#l13.250"></a><span id="l13.250">         newBoxName = destinationMailbox;</span>
<a href="#l13.251"></a><span id="l13.251"> </span>
<a href="#l13.252"></a><span id="l13.252">         nsCString oldBoxName(sourceMailbox);</span>
<a href="#l13.253"></a><span id="l13.253">         PRInt32 leafStart = oldBoxName.RFindChar(onlineDirSeparator);</span>
<a href="#l13.254"></a><span id="l13.254" class="difflineminus">-        PRInt32 length = oldBoxName.Length();</span>
<a href="#l13.255"></a><span id="l13.255">         nsCString leafName;</span>
<a href="#l13.256"></a><span id="l13.256"> </span>
<a href="#l13.257"></a><span id="l13.257">         if (-1 == leafStart)</span>
<a href="#l13.258"></a><span id="l13.258">             leafName = oldBoxName;  // this is a root level box</span>
<a href="#l13.259"></a><span id="l13.259">         else</span>
<a href="#l13.260"></a><span id="l13.260" class="difflineminus">-            oldBoxName.Right(leafName, length-(leafStart+1));</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineplus">+            leafName = Substring(oldBoxName, leafStart+1);</span>
<a href="#l13.262"></a><span id="l13.262"> </span>
<a href="#l13.263"></a><span id="l13.263">         if ( !newBoxName.IsEmpty() )</span>
<a href="#l13.264"></a><span id="l13.264">              newBoxName.Append(onlineDirSeparator);</span>
<a href="#l13.265"></a><span id="l13.265">         newBoxName.Append(leafName);</span>
<a href="#l13.266"></a><span id="l13.266">         PRBool  renamed = RenameHierarchyByHand(sourceMailbox,</span>
<a href="#l13.267"></a><span id="l13.267">                                                 newBoxName.get());</span>
<a href="#l13.268"></a><span id="l13.268">         if (renamed)</span>
<a href="#l13.269"></a><span id="l13.269">             FolderRenamed(sourceMailbox, newBoxName.get());</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineat">@@ -7251,20 +7247,20 @@ void nsImapProtocol::DiscoverMailboxList</span>
<a href="#l13.271"></a><span id="l13.271">       {</span>
<a href="#l13.272"></a><span id="l13.272">         if (m_listedMailboxList.Count() == 0)</span>
<a href="#l13.273"></a><span id="l13.273">             break;</span>
<a href="#l13.274"></a><span id="l13.274"> </span>
<a href="#l13.275"></a><span id="l13.275">         mb = (nsIMAPMailboxInfo *) m_listedMailboxList[0]; // get top element</span>
<a href="#l13.276"></a><span id="l13.276">         m_listedMailboxList.RemoveElementAt(0); // XP_ListRemoveTopObject(fListedMailboxList);</span>
<a href="#l13.277"></a><span id="l13.277">         if (mb)</span>
<a href="#l13.278"></a><span id="l13.278">         {</span>
<a href="#l13.279"></a><span id="l13.279" class="difflineminus">-          if (FolderNeedsACLInitialized(nsPromiseFlatCString(mb-&gt;GetMailboxName()).get()))</span>
<a href="#l13.280"></a><span id="l13.280" class="difflineplus">+          if (FolderNeedsACLInitialized(PromiseFlatCString(mb-&gt;GetMailboxName()).get()))</span>
<a href="#l13.281"></a><span id="l13.281">           {</span>
<a href="#l13.282"></a><span id="l13.282">             char *onlineName = nsnull;</span>
<a href="#l13.283"></a><span id="l13.283" class="difflineminus">-            m_runningUrl-&gt;AllocateServerPath(nsPromiseFlatCString(mb-&gt;GetMailboxName()).get(), </span>
<a href="#l13.284"></a><span id="l13.284" class="difflineplus">+            m_runningUrl-&gt;AllocateServerPath(PromiseFlatCString(mb-&gt;GetMailboxName()).get(),</span>
<a href="#l13.285"></a><span id="l13.285">                                              mb-&gt;GetDelimiter(), &amp;onlineName);</span>
<a href="#l13.286"></a><span id="l13.286">             if (onlineName)</span>
<a href="#l13.287"></a><span id="l13.287">             {</span>
<a href="#l13.288"></a><span id="l13.288">               RefreshACLForFolder(onlineName);</span>
<a href="#l13.289"></a><span id="l13.289">               PR_Free(onlineName);</span>
<a href="#l13.290"></a><span id="l13.290">             }</span>
<a href="#l13.291"></a><span id="l13.291">           }</span>
<a href="#l13.292"></a><span id="l13.292">           PercentProgressUpdateEvent(NULL, cnt, total);</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineat">@@ -7388,17 +7384,17 @@ void nsImapProtocol::CreateMailbox(const</span>
<a href="#l13.294"></a><span id="l13.294">   {</span>
<a href="#l13.295"></a><span id="l13.295">     // Figure out parent folder name.</span>
<a href="#l13.296"></a><span id="l13.296">     nsCString parentName(mailboxName);</span>
<a href="#l13.297"></a><span id="l13.297">     char hierarchyDelimiter;</span>
<a href="#l13.298"></a><span id="l13.298">     m_runningUrl-&gt;GetOnlineSubDirSeparator(&amp;hierarchyDelimiter);</span>
<a href="#l13.299"></a><span id="l13.299">     PRInt32 leafPos = parentName.RFindChar(hierarchyDelimiter);</span>
<a href="#l13.300"></a><span id="l13.300">     if (leafPos &gt; 0)</span>
<a href="#l13.301"></a><span id="l13.301">     {</span>
<a href="#l13.302"></a><span id="l13.302" class="difflineminus">-      parentName.Truncate(leafPos);</span>
<a href="#l13.303"></a><span id="l13.303" class="difflineplus">+      parentName.SetLength(leafPos);</span>
<a href="#l13.304"></a><span id="l13.304">       List(parentName.get(), PR_FALSE);</span>
<a href="#l13.305"></a><span id="l13.305">       // We still want the caller to know the create failed, so restore that.</span>
<a href="#l13.306"></a><span id="l13.306">       GetServerStateParser().SetCommandFailed(PR_TRUE);</span>
<a href="#l13.307"></a><span id="l13.307">     }</span>
<a href="#l13.308"></a><span id="l13.308">   }</span>
<a href="#l13.309"></a><span id="l13.309"> }</span>
<a href="#l13.310"></a><span id="l13.310"> </span>
<a href="#l13.311"></a><span id="l13.311"> void nsImapProtocol::DeleteMailbox(const char *mailboxName)</span>
<a href="#l13.312"></a><span id="l13.312" class="difflineat">@@ -7635,17 +7631,17 @@ void nsImapProtocol::Search(const char *</span>
<a href="#l13.313"></a><span id="l13.313">   // the search criteria can contain string literals, which means we</span>
<a href="#l13.314"></a><span id="l13.314">   // need to break up the protocol string by CRLF's, and after sending CRLF,</span>
<a href="#l13.315"></a><span id="l13.315">   // wait for the server to respond OK before sending more data</span>
<a href="#l13.316"></a><span id="l13.316">   nsresult rv;</span>
<a href="#l13.317"></a><span id="l13.317">   PRInt32 crlfIndex;</span>
<a href="#l13.318"></a><span id="l13.318">   while (crlfIndex = protocolString.Find(CRLF), crlfIndex != kNotFound &amp;&amp; !DeathSignalReceived())</span>
<a href="#l13.319"></a><span id="l13.319">   {</span>
<a href="#l13.320"></a><span id="l13.320">     nsCAutoString tempProtocolString;</span>
<a href="#l13.321"></a><span id="l13.321" class="difflineminus">-    protocolString.Left(tempProtocolString, crlfIndex + 2);</span>
<a href="#l13.322"></a><span id="l13.322" class="difflineplus">+    tempProtocolString = StringHead(protocolString, crlfIndex + 2);</span>
<a href="#l13.323"></a><span id="l13.323">     rv = SendData(tempProtocolString.get());</span>
<a href="#l13.324"></a><span id="l13.324">     if (NS_FAILED(rv))</span>
<a href="#l13.325"></a><span id="l13.325">       return;</span>
<a href="#l13.326"></a><span id="l13.326">     ParseIMAPandCheckForNewMail();</span>
<a href="#l13.327"></a><span id="l13.327">     protocolString.Cut(0, crlfIndex + 2);</span>
<a href="#l13.328"></a><span id="l13.328">   }</span>
<a href="#l13.329"></a><span id="l13.329">   protocolString.Append(CRLF);</span>
<a href="#l13.330"></a><span id="l13.330"> </span>
<a href="#l13.331"></a><span id="l13.331" class="difflineat">@@ -7862,17 +7858,17 @@ void nsImapProtocol::ProcessAfterAuthent</span>
<a href="#l13.332"></a><span id="l13.332">         // we've tried to ask for it, so don't try again this session.</span>
<a href="#l13.333"></a><span id="l13.333">         m_hostSessionList-&gt;SetHostHasAdminURL(GetImapServerKey(), PR_TRUE);</span>
<a href="#l13.334"></a><span id="l13.334">       }</span>
<a href="#l13.335"></a><span id="l13.335">     }</span>
<a href="#l13.336"></a><span id="l13.336">     else if (GetServerStateParser().ServerIsNetscape3xServer())</span>
<a href="#l13.337"></a><span id="l13.337">     {</span>
<a href="#l13.338"></a><span id="l13.338">       Netscape();</span>
<a href="#l13.339"></a><span id="l13.339">       if (GetServerStateParser().LastCommandSuccessful() &amp;&amp; m_imapServerSink)</span>
<a href="#l13.340"></a><span id="l13.340" class="difflineminus">-        m_imapServerSink-&gt;SetMailServerUrls(nsDependentCString(GetServerStateParser().GetMailAccountUrl()),</span>
<a href="#l13.341"></a><span id="l13.341" class="difflineplus">+        m_imapServerSink-&gt;SetMailServerUrls(GetServerStateParser().GetMailAccountUrl(),</span>
<a href="#l13.342"></a><span id="l13.342">                                             EmptyCString(), EmptyCString());</span>
<a href="#l13.343"></a><span id="l13.343">     }</span>
<a href="#l13.344"></a><span id="l13.344">   }</span>
<a href="#l13.345"></a><span id="l13.345"> </span>
<a href="#l13.346"></a><span id="l13.346">   if (GetServerStateParser().ServerHasNamespaceCapability())</span>
<a href="#l13.347"></a><span id="l13.347">   {</span>
<a href="#l13.348"></a><span id="l13.348">     PRBool nameSpacesOverridable = PR_FALSE;</span>
<a href="#l13.349"></a><span id="l13.349">     PRBool haveNameSpacesForHost = PR_FALSE;</span>
<a href="#l13.350"></a><span id="l13.350" class="difflineat">@@ -8399,21 +8395,20 @@ void nsImapProtocol::GetQuotaDataIfSuppo</span>
<a href="#l13.351"></a><span id="l13.351">   if (NS_FAILED(rv))</span>
<a href="#l13.352"></a><span id="l13.352">     return;</span>
<a href="#l13.353"></a><span id="l13.353"> </span>
<a href="#l13.354"></a><span id="l13.354">   nsCString escapedName;</span>
<a href="#l13.355"></a><span id="l13.355">   CreateEscapedMailboxName(aBoxName, escapedName);</span>
<a href="#l13.356"></a><span id="l13.356"> </span>
<a href="#l13.357"></a><span id="l13.357">   IncrementCommandTagNumber();</span>
<a href="#l13.358"></a><span id="l13.358"> </span>
<a href="#l13.359"></a><span id="l13.359" class="difflineminus">-  nsCAutoString quotacommand;</span>
<a href="#l13.360"></a><span id="l13.360" class="difflineminus">-  quotacommand = nsDependentCString(GetServerCommandTag())</span>
<a href="#l13.361"></a><span id="l13.361" class="difflineminus">-               + NS_LITERAL_CSTRING(&quot; getquotaroot \&quot;&quot;)</span>
<a href="#l13.362"></a><span id="l13.362" class="difflineminus">-               + escapedName</span>
<a href="#l13.363"></a><span id="l13.363" class="difflineminus">-               + NS_LITERAL_CSTRING(&quot;\&quot;&quot; CRLF);</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineplus">+  nsCAutoString quotacommand(GetServerCommandTag());</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineplus">+  quotacommand.Append(NS_LITERAL_CSTRING(&quot; getquotaroot \&quot;&quot;));</span>
<a href="#l13.366"></a><span id="l13.366" class="difflineplus">+  quotacommand.Append(escapedName);</span>
<a href="#l13.367"></a><span id="l13.367" class="difflineplus">+  quotacommand.Append(NS_LITERAL_CSTRING(&quot;\&quot;&quot; CRLF));</span>
<a href="#l13.368"></a><span id="l13.368"> </span>
<a href="#l13.369"></a><span id="l13.369">   NS_ASSERTION(m_imapMailFolderSink, &quot;m_imapMailFolderSink is null!&quot;);</span>
<a href="#l13.370"></a><span id="l13.370">   if (m_imapMailFolderSink)</span>
<a href="#l13.371"></a><span id="l13.371">     m_imapMailFolderSink-&gt;SetFolderQuotaCommandIssued(PR_TRUE);</span>
<a href="#l13.372"></a><span id="l13.372"> </span>
<a href="#l13.373"></a><span id="l13.373">   nsresult quotarv = SendData(quotacommand.get());</span>
<a href="#l13.374"></a><span id="l13.374">   if (NS_SUCCEEDED(quotarv))</span>
<a href="#l13.375"></a><span id="l13.375">     ParseIMAPandCheckForNewMail(nsnull, PR_TRUE); // don't display errors.</span>
<a href="#l13.376"></a><span id="l13.376" class="difflineat">@@ -8435,17 +8430,17 @@ nsImapProtocol::GetShowDeletedMessages()</span>
<a href="#l13.377"></a><span id="l13.377">     PRBool rv = PR_FALSE;</span>
<a href="#l13.378"></a><span id="l13.378">     if (m_hostSessionList)</span>
<a href="#l13.379"></a><span id="l13.379">         m_hostSessionList-&gt;GetShowDeletedMessagesForHost(GetImapServerKey(), rv);</span>
<a href="#l13.380"></a><span id="l13.380">     return rv;</span>
<a href="#l13.381"></a><span id="l13.381"> }</span>
<a href="#l13.382"></a><span id="l13.382"> </span>
<a href="#l13.383"></a><span id="l13.383"> NS_IMETHODIMP nsImapProtocol::OverrideConnectionInfo(const PRUnichar *pHost, PRUint16 pPort, const char *pCookieData)</span>
<a href="#l13.384"></a><span id="l13.384"> {</span>
<a href="#l13.385"></a><span id="l13.385" class="difflineminus">-  LossyCopyUTF16toASCII(pHost, m_logonHost);</span>
<a href="#l13.386"></a><span id="l13.386" class="difflineplus">+  m_logonHost = NS_LossyConvertUTF16toASCII(pHost);</span>
<a href="#l13.387"></a><span id="l13.387">   m_logonPort = pPort;</span>
<a href="#l13.388"></a><span id="l13.388">   m_logonCookie = pCookieData;</span>
<a href="#l13.389"></a><span id="l13.389">   m_overRideUrlConnectionInfo = PR_TRUE;</span>
<a href="#l13.390"></a><span id="l13.390">   return NS_OK;</span>
<a href="#l13.391"></a><span id="l13.391"> }</span>
<a href="#l13.392"></a><span id="l13.392"> </span>
<a href="#l13.393"></a><span id="l13.393"> PRBool nsImapProtocol::CheckNeeded()</span>
<a href="#l13.394"></a><span id="l13.394"> {</span>
<a href="#l13.395"></a><span id="l13.395" class="difflineat">@@ -8886,29 +8881,29 @@ nsresult nsImapMockChannel::OpenCacheEnt</span>
<a href="#l13.396"></a><span id="l13.396">   // for now, truncate of the query part so we don't duplicate urls in the cache...</span>
<a href="#l13.397"></a><span id="l13.397">   PRInt32 anchorIndex = urlSpec.RFindChar('?');</span>
<a href="#l13.398"></a><span id="l13.398">   if (anchorIndex &gt; 0)</span>
<a href="#l13.399"></a><span id="l13.399">   {</span>
<a href="#l13.400"></a><span id="l13.400">     // if we were trying to read a part, we failed - fall back and look for whole msg</span>
<a href="#l13.401"></a><span id="l13.401">     if (mTryingToReadPart)</span>
<a href="#l13.402"></a><span id="l13.402">     {</span>
<a href="#l13.403"></a><span id="l13.403">       mTryingToReadPart = PR_FALSE;</span>
<a href="#l13.404"></a><span id="l13.404" class="difflineminus">-      urlSpec.Truncate(anchorIndex);</span>
<a href="#l13.405"></a><span id="l13.405" class="difflineplus">+      urlSpec.SetLength(anchorIndex);</span>
<a href="#l13.406"></a><span id="l13.406">     }</span>
<a href="#l13.407"></a><span id="l13.407">     else</span>
<a href="#l13.408"></a><span id="l13.408">     {</span>
<a href="#l13.409"></a><span id="l13.409">       // check if this is a filter plugin requesting the message. In that case,we're not</span>
<a href="#l13.410"></a><span id="l13.410">       // fetching a part, and we want the cache key to be just the uri.</span>
<a href="#l13.411"></a><span id="l13.411">       nsCAutoString anchor(Substring(urlSpec, anchorIndex));</span>
<a href="#l13.412"></a><span id="l13.412"> </span>
<a href="#l13.413"></a><span id="l13.413">       if (!anchor.EqualsLiteral(&quot;?header=filter&quot;)</span>
<a href="#l13.414"></a><span id="l13.414">         &amp;&amp; !anchor.EqualsLiteral(&quot;?header=attach&quot;) &amp;&amp; !anchor.EqualsLiteral(&quot;?header=src&quot;))</span>
<a href="#l13.415"></a><span id="l13.415">         mTryingToReadPart = PR_TRUE;</span>
<a href="#l13.416"></a><span id="l13.416">       else</span>
<a href="#l13.417"></a><span id="l13.417" class="difflineminus">-        urlSpec.Truncate(anchorIndex);</span>
<a href="#l13.418"></a><span id="l13.418" class="difflineplus">+        urlSpec.SetLength(anchorIndex);</span>
<a href="#l13.419"></a><span id="l13.419">     }</span>
<a href="#l13.420"></a><span id="l13.420">   }</span>
<a href="#l13.421"></a><span id="l13.421">   PRInt32 uidValidity = -1;</span>
<a href="#l13.422"></a><span id="l13.422">   nsCOMPtr &lt;nsIImapUrl&gt; imapUrl = do_QueryInterface(m_url, &amp;rv);</span>
<a href="#l13.423"></a><span id="l13.423">   if (imapUrl)</span>
<a href="#l13.424"></a><span id="l13.424">   {</span>
<a href="#l13.425"></a><span id="l13.425">     nsCOMPtr &lt;nsIImapMailFolderSink&gt; folderSink;</span>
<a href="#l13.426"></a><span id="l13.426">     rv = imapUrl-&gt;GetImapMailFolderSink(getter_AddRefs(folderSink));</span>
<a href="#l13.427"></a><span id="l13.427" class="difflineat">@@ -9027,18 +9022,20 @@ nsresult nsImapMockChannel::ReadFromImap</span>
<a href="#l13.428"></a><span id="l13.428"> </span>
<a href="#l13.429"></a><span id="l13.429">   // loading the url consists of asking the server to add the url to it's imap event queue....</span>
<a href="#l13.430"></a><span id="l13.430">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l13.431"></a><span id="l13.431">   rv = mailnewsUrl-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l13.432"></a><span id="l13.432">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.433"></a><span id="l13.433">   nsCOMPtr&lt;nsIImapIncomingServer&gt; imapServer (do_QueryInterface(server, &amp;rv));</span>
<a href="#l13.434"></a><span id="l13.434">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.435"></a><span id="l13.435"> </span>
<a href="#l13.436"></a><span id="l13.436" class="difflineplus">+  nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l13.437"></a><span id="l13.437" class="difflineplus">+</span>
<a href="#l13.438"></a><span id="l13.438">   // Assume AsyncRead is always called from the UI thread.....</span>
<a href="#l13.439"></a><span id="l13.439" class="difflineminus">-  rv = imapServer-&gt;GetImapConnectionAndLoadUrl(NS_GetCurrentThread(), imapUrl,</span>
<a href="#l13.440"></a><span id="l13.440" class="difflineplus">+  rv = imapServer-&gt;GetImapConnectionAndLoadUrl(thread, imapUrl,</span>
<a href="#l13.441"></a><span id="l13.441">                                                nsnull);</span>
<a href="#l13.442"></a><span id="l13.442">   return rv;</span>
<a href="#l13.443"></a><span id="l13.443"> }</span>
<a href="#l13.444"></a><span id="l13.444"> </span>
<a href="#l13.445"></a><span id="l13.445"> // for messages stored in our offline cache, we have special code to handle that...</span>
<a href="#l13.446"></a><span id="l13.446"> // If it's in the local cache, we return true and we can abort the download because</span>
<a href="#l13.447"></a><span id="l13.447"> // this method does the rest of the work.</span>
<a href="#l13.448"></a><span id="l13.448"> PRBool nsImapMockChannel::ReadFromLocalCache()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.h</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -43,17 +43,17 @@</span>
<a href="#l14.4"></a><span id="l14.4"> #include &quot;nsIImapUrl.h&quot;</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> #include &quot;nsMsgProtocol.h&quot;</span>
<a href="#l14.7"></a><span id="l14.7"> #include &quot;nsIEventTarget.h&quot;</span>
<a href="#l14.8"></a><span id="l14.8"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l14.9"></a><span id="l14.9"> #include &quot;nsIAsyncOutputStream.h&quot;</span>
<a href="#l14.10"></a><span id="l14.10"> #include &quot;nsIAsyncInputStream.h&quot;</span>
<a href="#l14.11"></a><span id="l14.11"> #include &quot;nsImapCore.h&quot;</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l14.14"></a><span id="l14.14"> #include &quot;nsIProgressEventSink.h&quot;</span>
<a href="#l14.15"></a><span id="l14.15"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l14.16"></a><span id="l14.16"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l14.17"></a><span id="l14.17"> #include &quot;nsISocketTransport.h&quot;</span>
<a href="#l14.18"></a><span id="l14.18"> #include &quot;nsIInputStreamPump.h&quot;</span>
<a href="#l14.19"></a><span id="l14.19"> </span>
<a href="#l14.20"></a><span id="l14.20"> // imap event sinks</span>
<a href="#l14.21"></a><span id="l14.21"> #include &quot;nsIImapMailFolderSink.h&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/imap/src/nsImapSearchResults.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapSearchResults.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -35,16 +35,17 @@</span>
<a href="#l15.4"></a><span id="l15.4">  *</span>
<a href="#l15.5"></a><span id="l15.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7"> #include &quot;msgCore.h&quot;  // for pre-compiled headers</span>
<a href="#l15.8"></a><span id="l15.8"> </span>
<a href="#l15.9"></a><span id="l15.9"> #include &quot;nsImapCore.h&quot;</span>
<a href="#l15.10"></a><span id="l15.10"> #include &quot;nsImapSearchResults.h&quot;</span>
<a href="#l15.11"></a><span id="l15.11"> #include &quot;prmem.h&quot;</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineplus">+#include &quot;nsCRT.h&quot;</span>
<a href="#l15.13"></a><span id="l15.13"> </span>
<a href="#l15.14"></a><span id="l15.14"> nsImapSearchResultSequence::nsImapSearchResultSequence()</span>
<a href="#l15.15"></a><span id="l15.15"> {</span>
<a href="#l15.16"></a><span id="l15.16"> }</span>
<a href="#l15.17"></a><span id="l15.17"> </span>
<a href="#l15.18"></a><span id="l15.18"> nsImapSearchResultSequence *nsImapSearchResultSequence::CreateSearchResultSequence()</span>
<a href="#l15.19"></a><span id="l15.19"> {</span>
<a href="#l15.20"></a><span id="l15.20">   return new nsImapSearchResultSequence;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapServerResponseParser.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -48,16 +48,17 @@</span>
<a href="#l16.4"></a><span id="l16.4"> #include &quot;nsImapCore.h&quot;</span>
<a href="#l16.5"></a><span id="l16.5"> #include &quot;nsImapProtocol.h&quot;</span>
<a href="#l16.6"></a><span id="l16.6"> #include &quot;nsImapServerResponseParser.h&quot;</span>
<a href="#l16.7"></a><span id="l16.7"> #include &quot;nsIMAPBodyShell.h&quot;</span>
<a href="#l16.8"></a><span id="l16.8"> #include &quot;nsImapFlagAndUidState.h&quot;</span>
<a href="#l16.9"></a><span id="l16.9"> #include &quot;nsIMAPNamespace.h&quot;</span>
<a href="#l16.10"></a><span id="l16.10"> #include &quot;nsImapStringBundle.h&quot;</span>
<a href="#l16.11"></a><span id="l16.11"> #include &quot;nsImapUtils.h&quot;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineplus">+#include &quot;nsCRT.h&quot;</span>
<a href="#l16.13"></a><span id="l16.13"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l16.14"></a><span id="l16.14"> </span>
<a href="#l16.15"></a><span id="l16.15"> ////////////////// nsImapServerResponseParser /////////////////////////</span>
<a href="#l16.16"></a><span id="l16.16"> </span>
<a href="#l16.17"></a><span id="l16.17"> extern PRLogModuleInfo* IMAP;</span>
<a href="#l16.18"></a><span id="l16.18"> </span>
<a href="#l16.19"></a><span id="l16.19"> nsImapServerResponseParser::nsImapServerResponseParser(nsImapProtocol &amp;imapProtocolConnection) </span>
<a href="#l16.20"></a><span id="l16.20">                             : nsIMAPGenericParser(),</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineat">@@ -543,25 +544,25 @@ void nsImapServerResponseParser::Process</span>
<a href="#l16.22"></a><span id="l16.22"> void nsImapServerResponseParser::response_data()</span>
<a href="#l16.23"></a><span id="l16.23"> {</span>
<a href="#l16.24"></a><span id="l16.24">   AdvanceToNextToken();</span>
<a href="#l16.25"></a><span id="l16.25">   </span>
<a href="#l16.26"></a><span id="l16.26">   if (ContinueParse())</span>
<a href="#l16.27"></a><span id="l16.27">   {</span>
<a href="#l16.28"></a><span id="l16.28">     // Instead of comparing lots of strings and make function calls, try to</span>
<a href="#l16.29"></a><span id="l16.29">     // pre-flight the possibilities based on the first letter of the token.</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-    switch (toupper(fNextToken[0]))</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+    switch (NS_ToUpper(fNextToken[0]))</span>
<a href="#l16.32"></a><span id="l16.32">     {</span>
<a href="#l16.33"></a><span id="l16.33">     case 'O':   // OK</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineminus">-      if (toupper(fNextToken[1]) == 'K')</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+      if (NS_ToUpper(fNextToken[1]) == 'K')</span>
<a href="#l16.36"></a><span id="l16.36">         resp_cond_state(PR_FALSE);</span>
<a href="#l16.37"></a><span id="l16.37">       else SetSyntaxError(PR_TRUE);</span>
<a href="#l16.38"></a><span id="l16.38">       break;</span>
<a href="#l16.39"></a><span id="l16.39">     case 'N':   // NO</span>
<a href="#l16.40"></a><span id="l16.40" class="difflineminus">-      if (toupper(fNextToken[1]) == 'O')</span>
<a href="#l16.41"></a><span id="l16.41" class="difflineplus">+      if (NS_ToUpper(fNextToken[1]) == 'O')</span>
<a href="#l16.42"></a><span id="l16.42">         resp_cond_state(PR_FALSE);</span>
<a href="#l16.43"></a><span id="l16.43">       else if (!PL_strcasecmp(fNextToken, &quot;NAMESPACE&quot;))</span>
<a href="#l16.44"></a><span id="l16.44">         namespace_data();</span>
<a href="#l16.45"></a><span id="l16.45">       else SetSyntaxError(PR_TRUE);</span>
<a href="#l16.46"></a><span id="l16.46">       break;</span>
<a href="#l16.47"></a><span id="l16.47">     case 'B':   // BAD</span>
<a href="#l16.48"></a><span id="l16.48">       if (!PL_strcasecmp(fNextToken, &quot;BAD&quot;))</span>
<a href="#l16.49"></a><span id="l16.49">         resp_cond_state(PR_FALSE);</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineat">@@ -1513,17 +1514,19 @@ void nsImapServerResponseParser::xaolenv</span>
<a href="#l16.51"></a><span id="l16.51">       if (ContinueParse())</span>
<a href="#l16.52"></a><span id="l16.52">       {</span>
<a href="#l16.53"></a><span id="l16.53">         nsCAutoString fromLine;</span>
<a href="#l16.54"></a><span id="l16.54">         if (!strcmp(GetSelectedMailboxName(), &quot;Sent Items&quot;))</span>
<a href="#l16.55"></a><span id="l16.55">         {</span>
<a href="#l16.56"></a><span id="l16.56">           // xaol envelope switches the From with the To, so we switch them back and</span>
<a href="#l16.57"></a><span id="l16.57">           // create a fake from line From: user@aol.com</span>
<a href="#l16.58"></a><span id="l16.58">           fromLine.Append(&quot;To: &quot;);</span>
<a href="#l16.59"></a><span id="l16.59" class="difflineminus">-          nsCAutoString fakeFromLine(NS_LITERAL_CSTRING(&quot;From: &quot;) + nsDependentCString(fServerConnection.GetImapUserName()) + NS_LITERAL_CSTRING(&quot;@aol.com&quot;));</span>
<a href="#l16.60"></a><span id="l16.60" class="difflineplus">+          nsCAutoString fakeFromLine(NS_LITERAL_CSTRING(&quot;From: &quot;));</span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+          fakeFromLine.Append(fServerConnection.GetImapUserName());</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+          fakeFromLine.Append(NS_LITERAL_CSTRING(&quot;@aol.com&quot;));</span>
<a href="#l16.63"></a><span id="l16.63">           fServerConnection.HandleMessageDownLoadLine(fakeFromLine.get(), PR_FALSE);</span>
<a href="#l16.64"></a><span id="l16.64">         }</span>
<a href="#l16.65"></a><span id="l16.65">         else</span>
<a href="#l16.66"></a><span id="l16.66">         {</span>
<a href="#l16.67"></a><span id="l16.67">           fromLine.Append(&quot;From: &quot;);</span>
<a href="#l16.68"></a><span id="l16.68">         }</span>
<a href="#l16.69"></a><span id="l16.69">         parse_address(fromLine);</span>
<a href="#l16.70"></a><span id="l16.70">         fServerConnection.HandleMessageDownLoadLine(fromLine.get(), PR_FALSE);</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineat">@@ -1648,17 +1651,17 @@ void nsImapServerResponseParser::flags()</span>
<a href="#l16.72"></a><span id="l16.72"> </span>
<a href="#l16.73"></a><span id="l16.73">   // eat the opening '('</span>
<a href="#l16.74"></a><span id="l16.74">   fNextToken++;</span>
<a href="#l16.75"></a><span id="l16.75">   while (ContinueParse() &amp;&amp; (*fNextToken != ')'))</span>
<a href="#l16.76"></a><span id="l16.76">   {</span>
<a href="#l16.77"></a><span id="l16.77">     PRBool knownFlag = PR_FALSE;					     </span>
<a href="#l16.78"></a><span id="l16.78">     if (*fNextToken == '\\')</span>
<a href="#l16.79"></a><span id="l16.79">     {</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineminus">-      switch (toupper(fNextToken[1])) {</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+      switch (NS_ToUpper(fNextToken[1])) {</span>
<a href="#l16.82"></a><span id="l16.82">       case 'S':</span>
<a href="#l16.83"></a><span id="l16.83">         if (!PL_strncasecmp(fNextToken, &quot;\\Seen&quot;,5))</span>
<a href="#l16.84"></a><span id="l16.84">         {</span>
<a href="#l16.85"></a><span id="l16.85">           messageFlags |= kImapMsgSeenFlag;</span>
<a href="#l16.86"></a><span id="l16.86">           knownFlag = PR_TRUE;</span>
<a href="#l16.87"></a><span id="l16.87">         }</span>
<a href="#l16.88"></a><span id="l16.88">         break;</span>
<a href="#l16.89"></a><span id="l16.89">       case 'A':</span>
<a href="#l16.90"></a><span id="l16.90" class="difflineat">@@ -1695,17 +1698,17 @@ void nsImapServerResponseParser::flags()</span>
<a href="#l16.91"></a><span id="l16.91">         }</span>
<a href="#l16.92"></a><span id="l16.92">         break;</span>
<a href="#l16.93"></a><span id="l16.93">       default:</span>
<a href="#l16.94"></a><span id="l16.94">         break;</span>
<a href="#l16.95"></a><span id="l16.95">       }</span>
<a href="#l16.96"></a><span id="l16.96">     }</span>
<a href="#l16.97"></a><span id="l16.97">     else if (*fNextToken == '$')</span>
<a href="#l16.98"></a><span id="l16.98">     {</span>
<a href="#l16.99"></a><span id="l16.99" class="difflineminus">-      switch (toupper(fNextToken[1])) {</span>
<a href="#l16.100"></a><span id="l16.100" class="difflineplus">+      switch (NS_ToUpper(fNextToken[1])) {</span>
<a href="#l16.101"></a><span id="l16.101">       case 'M':</span>
<a href="#l16.102"></a><span id="l16.102">         if ((fSupportsUserDefinedFlags &amp; (kImapMsgSupportUserFlag |</span>
<a href="#l16.103"></a><span id="l16.103">           kImapMsgSupportMDNSentFlag))</span>
<a href="#l16.104"></a><span id="l16.104">           &amp;&amp; !PL_strncasecmp(fNextToken, &quot;$MDNSent&quot;,8))</span>
<a href="#l16.105"></a><span id="l16.105">         {</span>
<a href="#l16.106"></a><span id="l16.106">           messageFlags |= kImapMsgMDNSentFlag;</span>
<a href="#l16.107"></a><span id="l16.107">           knownFlag = PR_TRUE;</span>
<a href="#l16.108"></a><span id="l16.108">         }</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineat">@@ -1723,17 +1726,17 @@ void nsImapServerResponseParser::flags()</span>
<a href="#l16.110"></a><span id="l16.110">         break;</span>
<a href="#l16.111"></a><span id="l16.111">       }</span>
<a href="#l16.112"></a><span id="l16.112">     }</span>
<a href="#l16.113"></a><span id="l16.113">     if (!knownFlag &amp;&amp; fFlagState)</span>
<a href="#l16.114"></a><span id="l16.114">     {</span>
<a href="#l16.115"></a><span id="l16.115">       nsCAutoString flag(fNextToken);</span>
<a href="#l16.116"></a><span id="l16.116">       PRInt32 parenIndex = flag.FindChar(')');</span>
<a href="#l16.117"></a><span id="l16.117">       if (parenIndex &gt; 0)</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineminus">-        flag.Truncate(parenIndex);</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineplus">+        flag.SetLength(parenIndex);</span>
<a href="#l16.120"></a><span id="l16.120">       messageFlags |= kImapMsgCustomKeywordFlag;</span>
<a href="#l16.121"></a><span id="l16.121">       if (CurrentResponseUID() != nsMsgKey_None)</span>
<a href="#l16.122"></a><span id="l16.122">         fFlagState-&gt;AddUidCustomFlagPair(CurrentResponseUID(), flag.get());</span>
<a href="#l16.123"></a><span id="l16.123">       else</span>
<a href="#l16.124"></a><span id="l16.124">         fCustomFlags.AppendCString(flag);</span>
<a href="#l16.125"></a><span id="l16.125">     }</span>
<a href="#l16.126"></a><span id="l16.126">     if (PL_strcasestr(fNextToken, &quot;)&quot;))</span>
<a href="#l16.127"></a><span id="l16.127">     {</span>
<a href="#l16.128"></a><span id="l16.128" class="difflineat">@@ -2198,17 +2201,17 @@ void nsImapServerResponseParser::capabil</span>
<a href="#l16.129"></a><span id="l16.129">   PRInt32 endToken = -1;</span>
<a href="#l16.130"></a><span id="l16.130">   fCapabilityFlag = kCapabilityDefined | kHasAuthOldLoginCapability;</span>
<a href="#l16.131"></a><span id="l16.131">   do {</span>
<a href="#l16.132"></a><span id="l16.132">     AdvanceToNextToken();</span>
<a href="#l16.133"></a><span id="l16.133">     if (fNextToken) {</span>
<a href="#l16.134"></a><span id="l16.134">       nsCString token(fNextToken);</span>
<a href="#l16.135"></a><span id="l16.135">       endToken = token.FindChar(']');</span>
<a href="#l16.136"></a><span id="l16.136">       if (endToken &gt;= 0)</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineminus">-        token.Truncate(endToken);</span>
<a href="#l16.138"></a><span id="l16.138" class="difflineplus">+        token.SetLength(endToken);</span>
<a href="#l16.139"></a><span id="l16.139"> </span>
<a href="#l16.140"></a><span id="l16.140">       if(token.Equals(&quot;AUTH=LOGIN&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l16.141"></a><span id="l16.141">         fCapabilityFlag |= kHasAuthLoginCapability;</span>
<a href="#l16.142"></a><span id="l16.142">       else if(token.Equals(&quot;AUTH=PLAIN&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l16.143"></a><span id="l16.143">         fCapabilityFlag |= kHasAuthPlainCapability;</span>
<a href="#l16.144"></a><span id="l16.144">       else if (token.Equals(&quot;AUTH=CRAM-MD5&quot;, nsCaseInsensitiveCStringComparator()))</span>
<a href="#l16.145"></a><span id="l16.145">         fCapabilityFlag |= kHasCRAMCapability;</span>
<a href="#l16.146"></a><span id="l16.146">       else if (token.Equals(&quot;AUTH=NTLM&quot;, nsCaseInsensitiveCStringComparator()))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/imap/src/nsImapServerResponseParser.h</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapServerResponseParser.h</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -36,17 +36,17 @@</span>
<a href="#l17.4"></a><span id="l17.4">  *</span>
<a href="#l17.5"></a><span id="l17.5">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l17.6"></a><span id="l17.6"> </span>
<a href="#l17.7"></a><span id="l17.7"> #ifndef _nsIMAPServerResponseParser_H_</span>
<a href="#l17.8"></a><span id="l17.8"> #define _nsIMAPServerResponseParser_H_</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;nsIMAPHostSessionList.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> #include &quot;nsImapSearchResults.h&quot;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l17.14"></a><span id="l17.14"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l17.15"></a><span id="l17.15"> #include &quot;nsTArray.h&quot;</span>
<a href="#l17.16"></a><span id="l17.16"> #include &quot;nsImapUtils.h&quot;</span>
<a href="#l17.17"></a><span id="l17.17"> </span>
<a href="#l17.18"></a><span id="l17.18"> class nsIMAPNamespace;</span>
<a href="#l17.19"></a><span id="l17.19"> class nsIMAPNamespaceList;</span>
<a href="#l17.20"></a><span id="l17.20"> class nsIMAPBodyShell;</span>
<a href="#l17.21"></a><span id="l17.21"> class nsIMAPBodypart;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -54,19 +54,17 @@</span>
<a href="#l18.4"></a><span id="l18.4"> #include &quot;nsIMsgImapMailFolder.h&quot;</span>
<a href="#l18.5"></a><span id="l18.5"> #include &quot;nsIImapIncomingServer.h&quot;</span>
<a href="#l18.6"></a><span id="l18.6"> #include &quot;nsIImapServerSink.h&quot;</span>
<a href="#l18.7"></a><span id="l18.7"> #include &quot;nsIImapMockChannel.h&quot;</span>
<a href="#l18.8"></a><span id="l18.8"> #include &quot;nsImapUtils.h&quot;</span>
<a href="#l18.9"></a><span id="l18.9"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l18.10"></a><span id="l18.10"> #include &quot;nsIDocShellLoadInfo.h&quot;</span>
<a href="#l18.11"></a><span id="l18.11"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l18.13"></a><span id="l18.13"> #include &quot;nsRDFCID.h&quot;</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-#include &quot;nsEscape.h&quot;</span>
<a href="#l18.15"></a><span id="l18.15"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l18.16"></a><span id="l18.16"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l18.17"></a><span id="l18.17"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l18.18"></a><span id="l18.18"> #include &quot;nsILoadGroup.h&quot;</span>
<a href="#l18.19"></a><span id="l18.19"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l18.20"></a><span id="l18.20"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l18.21"></a><span id="l18.21"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l18.22"></a><span id="l18.22"> #include &quot;nsISubscribableServer.h&quot;</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineat">@@ -200,17 +198,17 @@ nsresult nsImapService::GetFolderName(ns</span>
<a href="#l18.24"></a><span id="l18.24">   if (escapeSlashes &amp;&amp; !onlineName.IsEmpty())</span>
<a href="#l18.25"></a><span id="l18.25">   {</span>
<a href="#l18.26"></a><span id="l18.26">     char* escapedOnlineName;</span>
<a href="#l18.27"></a><span id="l18.27">     rv = nsImapUrl::EscapeSlashes(onlineName.get(), &amp;escapedOnlineName);</span>
<a href="#l18.28"></a><span id="l18.28">     if (NS_SUCCEEDED(rv))</span>
<a href="#l18.29"></a><span id="l18.29">       onlineName.Adopt(escapedOnlineName);</span>
<a href="#l18.30"></a><span id="l18.30">   }</span>
<a href="#l18.31"></a><span id="l18.31">   // need to escape everything else</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineminus">-  aFolderName.Adopt(nsEscape(onlineName.get(), url_Path));</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+  MsgEscapeString(onlineName, nsINetUtil::ESCAPE_URL_PATH, aFolderName);</span>
<a href="#l18.34"></a><span id="l18.34">   return rv;</span>
<a href="#l18.35"></a><span id="l18.35"> }</span>
<a href="#l18.36"></a><span id="l18.36"> </span>
<a href="#l18.37"></a><span id="l18.37"> NS_IMETHODIMP nsImapService::SelectFolder(nsIEventTarget *aClientEventTarget, </span>
<a href="#l18.38"></a><span id="l18.38">                                           nsIMsgFolder *aImapMailFolder, </span>
<a href="#l18.39"></a><span id="l18.39">                                           nsIUrlListener *aUrlListener, </span>
<a href="#l18.40"></a><span id="l18.40">                                           nsIMsgWindow *aMsgWindow,</span>
<a href="#l18.41"></a><span id="l18.41">                                           nsIURI **aURL)</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineat">@@ -331,27 +329,24 @@ NS_IMETHODIMP nsImapService::OpenAttachm</span>
<a href="#l18.43"></a><span id="l18.43"> {</span>
<a href="#l18.44"></a><span id="l18.44">   nsresult rv = NS_OK;</span>
<a href="#l18.45"></a><span id="l18.45">   // okay this is a little tricky....we may have to fetch the mime part</span>
<a href="#l18.46"></a><span id="l18.46">   // or it may already be downloaded for us....the only way i can tell to </span>
<a href="#l18.47"></a><span id="l18.47">   // distinguish the two events is to search for ?section or ?part</span>
<a href="#l18.48"></a><span id="l18.48">   </span>
<a href="#l18.49"></a><span id="l18.49">   nsCAutoString uri(aMessageUri);</span>
<a href="#l18.50"></a><span id="l18.50">   nsCAutoString urlString(aUrl);</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineminus">-  urlString.ReplaceSubstring(&quot;/;section&quot;, &quot;?section&quot;);</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+  MsgReplaceSubstring(urlString, &quot;/;section&quot;, &quot;?section&quot;);</span>
<a href="#l18.53"></a><span id="l18.53">   </span>
<a href="#l18.54"></a><span id="l18.54">   // more stuff i don't understand</span>
<a href="#l18.55"></a><span id="l18.55">   PRInt32 sectionPos = urlString.Find(&quot;?section&quot;);</span>
<a href="#l18.56"></a><span id="l18.56">   // if we have a section field then we must be dealing with a mime part we need to fetchf</span>
<a href="#l18.57"></a><span id="l18.57">   if (sectionPos &gt; 0)</span>
<a href="#l18.58"></a><span id="l18.58">   {</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-    nsCAutoString mimePart;</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-    </span>
<a href="#l18.61"></a><span id="l18.61" class="difflineminus">-    urlString.Right(mimePart, urlString.Length() - sectionPos); </span>
<a href="#l18.62"></a><span id="l18.62" class="difflineminus">-    uri.Append(mimePart);</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+    uri.Append(Substring(urlString, sectionPos));</span>
<a href="#l18.64"></a><span id="l18.64">     uri += &quot;&amp;type=&quot;;</span>
<a href="#l18.65"></a><span id="l18.65">     uri += aContentType;</span>
<a href="#l18.66"></a><span id="l18.66">     uri += &quot;&amp;filename=&quot;;</span>
<a href="#l18.67"></a><span id="l18.67">     uri += aFileName;</span>
<a href="#l18.68"></a><span id="l18.68">   }</span>
<a href="#l18.69"></a><span id="l18.69">   else</span>
<a href="#l18.70"></a><span id="l18.70">   {</span>
<a href="#l18.71"></a><span id="l18.71">     // try to extract the specific part number out from the url string</span>
<a href="#l18.72"></a><span id="l18.72" class="difflineat">@@ -541,19 +536,18 @@ NS_IMETHODIMP nsImapService::DisplayMess</span>
<a href="#l18.73"></a><span id="l18.73">         if (NS_SUCCEEDED(rv) &amp;&amp; aImapServer)</span>
<a href="#l18.74"></a><span id="l18.74">           aImapServer-&gt;GetMimePartsOnDemand(&amp;useMimePartsOnDemand);</span>
<a href="#l18.75"></a><span id="l18.75">       }</span>
<a href="#l18.76"></a><span id="l18.76"> </span>
<a href="#l18.77"></a><span id="l18.77">       nsCAutoString uriStr(aMessageURI);</span>
<a href="#l18.78"></a><span id="l18.78">       PRInt32 keySeparator = uriStr.RFindChar('#');</span>
<a href="#l18.79"></a><span id="l18.79">       if(keySeparator != -1)</span>
<a href="#l18.80"></a><span id="l18.80">       {</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineminus">-        PRInt32 keyEndSeparator = uriStr.FindCharInSet(&quot;/?&amp;&quot;, </span>
<a href="#l18.82"></a><span id="l18.82" class="difflineminus">-                                                       keySeparator); </span>
<a href="#l18.83"></a><span id="l18.83" class="difflineminus">-        PRInt32 mpodFetchPos = uriStr.Find(&quot;fetchCompleteMessage=true&quot;, PR_FALSE, keyEndSeparator);</span>
<a href="#l18.84"></a><span id="l18.84" class="difflineplus">+        PRInt32 keyEndSeparator = MsgFindCharInSet(uriStr, &quot;/?&amp;&quot;, keySeparator);</span>
<a href="#l18.85"></a><span id="l18.85" class="difflineplus">+        PRInt32 mpodFetchPos = MsgFind(uriStr, &quot;fetchCompleteMessage=true&quot;, PR_FALSE, keyEndSeparator);</span>
<a href="#l18.86"></a><span id="l18.86">         if (mpodFetchPos != -1)</span>
<a href="#l18.87"></a><span id="l18.87">           useMimePartsOnDemand = PR_FALSE;</span>
<a href="#l18.88"></a><span id="l18.88">       }</span>
<a href="#l18.89"></a><span id="l18.89"> </span>
<a href="#l18.90"></a><span id="l18.90">       if (folder)</span>
<a href="#l18.91"></a><span id="l18.91">       {</span>
<a href="#l18.92"></a><span id="l18.92">         folder-&gt;ShouldStoreMsgOffline(key, &amp;shouldStoreMsgOffline);</span>
<a href="#l18.93"></a><span id="l18.93">         folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineat">@@ -578,17 +572,17 @@ NS_IMETHODIMP nsImapService::DisplayMess</span>
<a href="#l18.95"></a><span id="l18.95">         prefBranch-&gt;GetBoolPref(&quot;mailnews.mark_message_read.auto&quot;, &amp;markReadAuto);</span>
<a href="#l18.96"></a><span id="l18.96">         PRBool markReadDelay = PR_FALSE;</span>
<a href="#l18.97"></a><span id="l18.97">         prefBranch-&gt;GetBoolPref(&quot;mailnews.mark_message_read.delay&quot;, &amp;markReadDelay);</span>
<a href="#l18.98"></a><span id="l18.98">         forcePeek = (!markReadAuto || markReadDelay);</span>
<a href="#l18.99"></a><span id="l18.99">       }</span>
<a href="#l18.100"></a><span id="l18.100"> </span>
<a href="#l18.101"></a><span id="l18.101">       rv = FetchMessage(imapUrl, forcePeek ? nsIImapUrl::nsImapMsgFetchPeek : nsIImapUrl::nsImapMsgFetch, </span>
<a href="#l18.102"></a><span id="l18.102">                         folder, imapMessageSink, aMsgWindow, aDisplayConsumer, msgKey, PR_FALSE, </span>
<a href="#l18.103"></a><span id="l18.103" class="difflineminus">-                        (mPrintingOperation) ? NS_LITERAL_CSTRING(&quot;print&quot;) : EmptyCString(), aURL);</span>
<a href="#l18.104"></a><span id="l18.104" class="difflineplus">+                        (mPrintingOperation) ? NS_LITERAL_CSTRING(&quot;print&quot;) : NS_LITERAL_CSTRING(&quot;&quot;), aURL);</span>
<a href="#l18.105"></a><span id="l18.105">     }</span>
<a href="#l18.106"></a><span id="l18.106">   }</span>
<a href="#l18.107"></a><span id="l18.107">   return rv;</span>
<a href="#l18.108"></a><span id="l18.108"> }</span>
<a href="#l18.109"></a><span id="l18.109"> </span>
<a href="#l18.110"></a><span id="l18.110"> </span>
<a href="#l18.111"></a><span id="l18.111"> nsresult nsImapService::FetchMimePart(nsIImapUrl *aImapUrl,</span>
<a href="#l18.112"></a><span id="l18.112">                                       nsImapAction aImapAction,</span>
<a href="#l18.113"></a><span id="l18.113" class="difflineat">@@ -695,17 +689,19 @@ nsresult nsImapService::FetchMimePart(ns</span>
<a href="#l18.114"></a><span id="l18.114">       else // do what we used to do before</span>
<a href="#l18.115"></a><span id="l18.115">       {</span>
<a href="#l18.116"></a><span id="l18.116">         // I'd like to get rid of this code as I believe that we always get a docshell</span>
<a href="#l18.117"></a><span id="l18.117">         // or stream listener passed into us in this method but i'm not sure yet...</span>
<a href="#l18.118"></a><span id="l18.118">         // I'm going to use an assert for now to figure out if this is ever getting called</span>
<a href="#l18.119"></a><span id="l18.119"> #if defined(DEBUG_mscott) || defined(DEBUG_bienvenu)</span>
<a href="#l18.120"></a><span id="l18.120">         NS_ERROR(&quot;oops...someone still is reaching this part of the code&quot;);</span>
<a href="#l18.121"></a><span id="l18.121"> #endif</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineminus">-        rv = GetImapConnectionAndLoadUrl(NS_GetCurrentThread(), aImapUrl,</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+        nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l18.124"></a><span id="l18.124" class="difflineplus">+</span>
<a href="#l18.125"></a><span id="l18.125" class="difflineplus">+        rv = GetImapConnectionAndLoadUrl(thread, aImapUrl,</span>
<a href="#l18.126"></a><span id="l18.126">                                          aDisplayConsumer, aURL);</span>
<a href="#l18.127"></a><span id="l18.127">       }</span>
<a href="#l18.128"></a><span id="l18.128">     }</span>
<a href="#l18.129"></a><span id="l18.129">   }</span>
<a href="#l18.130"></a><span id="l18.130">   return rv;</span>
<a href="#l18.131"></a><span id="l18.131"> }</span>
<a href="#l18.132"></a><span id="l18.132"> </span>
<a href="#l18.133"></a><span id="l18.133"> //</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineat">@@ -857,22 +853,25 @@ NS_IMETHODIMP nsImapService::Search(nsIM</span>
<a href="#l18.135"></a><span id="l18.135"> </span>
<a href="#l18.136"></a><span id="l18.136">     urlSpec.Append(&quot;/search&gt;UID&gt;&quot;);</span>
<a href="#l18.137"></a><span id="l18.137">     urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l18.138"></a><span id="l18.138">     urlSpec.Append(folderName);</span>
<a href="#l18.139"></a><span id="l18.139">     urlSpec.Append('&gt;');</span>
<a href="#l18.140"></a><span id="l18.140">     // escape aSearchUri so that IMAP special characters (i.e. '\')</span>
<a href="#l18.141"></a><span id="l18.141">     // won't be replaced with '/' in NECKO.</span>
<a href="#l18.142"></a><span id="l18.142">     // it will be unescaped in nsImapUrl::ParseUrl().</span>
<a href="#l18.143"></a><span id="l18.143" class="difflineminus">-    char *search_cmd = nsEscape((char *)aSearchUri, url_XAlphas);</span>
<a href="#l18.144"></a><span id="l18.144" class="difflineminus">-    urlSpec.Append(search_cmd);</span>
<a href="#l18.145"></a><span id="l18.145" class="difflineminus">-    NS_Free(search_cmd);</span>
<a href="#l18.146"></a><span id="l18.146" class="difflineplus">+    nsCString escapedSearchUri;</span>
<a href="#l18.147"></a><span id="l18.147" class="difflineplus">+</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineplus">+    MsgEscapeString(nsDependentCString(aSearchUri), nsINetUtil::ESCAPE_XALPHAS, escapedSearchUri);</span>
<a href="#l18.149"></a><span id="l18.149" class="difflineplus">+    urlSpec.Append(escapedSearchUri);</span>
<a href="#l18.150"></a><span id="l18.150">     rv = mailNewsUrl-&gt;SetSpec(urlSpec);</span>
<a href="#l18.151"></a><span id="l18.151" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l18.152"></a><span id="l18.152" class="difflineminus">-      rv = GetImapConnectionAndLoadUrl(NS_GetCurrentThread(), imapUrl, nsnull, nsnull);</span>
<a href="#l18.153"></a><span id="l18.153" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l18.154"></a><span id="l18.154" class="difflineplus">+      nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l18.155"></a><span id="l18.155" class="difflineplus">+      rv = GetImapConnectionAndLoadUrl(thread, imapUrl, nsnull, nsnull);</span>
<a href="#l18.156"></a><span id="l18.156" class="difflineplus">+    }</span>
<a href="#l18.157"></a><span id="l18.157">   }</span>
<a href="#l18.158"></a><span id="l18.158">   return rv;</span>
<a href="#l18.159"></a><span id="l18.159"> }</span>
<a href="#l18.160"></a><span id="l18.160"> </span>
<a href="#l18.161"></a><span id="l18.161"> // just a helper method to break down imap message URIs....</span>
<a href="#l18.162"></a><span id="l18.162"> nsresult nsImapService::DecomposeImapURI(const nsACString &amp;aMessageURI, </span>
<a href="#l18.163"></a><span id="l18.163">                                          nsIMsgFolder **aFolder, </span>
<a href="#l18.164"></a><span id="l18.164">                                          nsACString &amp;aMsgKey)</span>
<a href="#l18.165"></a><span id="l18.165" class="difflineat">@@ -896,17 +895,17 @@ nsresult nsImapService::DecomposeImapURI</span>
<a href="#l18.166"></a><span id="l18.166">                                          nsIMsgFolder **aFolder, </span>
<a href="#l18.167"></a><span id="l18.167">                                          nsMsgKey *aMsgKey)</span>
<a href="#l18.168"></a><span id="l18.168"> {</span>
<a href="#l18.169"></a><span id="l18.169">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l18.170"></a><span id="l18.170">   NS_ENSURE_ARG_POINTER(aMsgKey);</span>
<a href="#l18.171"></a><span id="l18.171">   </span>
<a href="#l18.172"></a><span id="l18.172">   nsresult rv = NS_OK;</span>
<a href="#l18.173"></a><span id="l18.173">   nsCAutoString folderURI;</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineminus">-  rv = nsParseImapMessageURI(nsDependentCString(aMessageURI).get(), folderURI, aMsgKey, nsnull);</span>
<a href="#l18.175"></a><span id="l18.175" class="difflineplus">+  rv = nsParseImapMessageURI(PromiseFlatCString(aMessageURI).get(), folderURI, aMsgKey, nsnull);</span>
<a href="#l18.176"></a><span id="l18.176">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.177"></a><span id="l18.177">   </span>
<a href="#l18.178"></a><span id="l18.178">   nsCOMPtr &lt;nsIRDFService&gt; rdf = do_GetService(&quot;@mozilla.org/rdf/rdf-service;1&quot;,&amp;rv);</span>
<a href="#l18.179"></a><span id="l18.179">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.180"></a><span id="l18.180">   </span>
<a href="#l18.181"></a><span id="l18.181">   nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l18.182"></a><span id="l18.182">   rv = rdf-&gt;GetResource(folderURI, getter_AddRefs(res));</span>
<a href="#l18.183"></a><span id="l18.183">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l18.184"></a><span id="l18.184" class="difflineat">@@ -1134,17 +1133,18 @@ nsresult nsImapService::GetMessageFromUr</span>
<a href="#l18.185"></a><span id="l18.185">     else // do what we used to do before</span>
<a href="#l18.186"></a><span id="l18.186">     {</span>
<a href="#l18.187"></a><span id="l18.187">       // I'd like to get rid of this code as I believe that we always get a docshell</span>
<a href="#l18.188"></a><span id="l18.188">       // or stream listener passed into us in this method but i'm not sure yet...</span>
<a href="#l18.189"></a><span id="l18.189">       // I'm going to use an assert for now to figure out if this is ever getting called</span>
<a href="#l18.190"></a><span id="l18.190"> #if defined(DEBUG_mscott) || defined(DEBUG_bienvenu)</span>
<a href="#l18.191"></a><span id="l18.191">       NS_ERROR(&quot;oops...someone still is reaching this part of the code&quot;);</span>
<a href="#l18.192"></a><span id="l18.192"> #endif</span>
<a href="#l18.193"></a><span id="l18.193" class="difflineminus">-      rv = GetImapConnectionAndLoadUrl(NS_GetCurrentThread(), aImapUrl,</span>
<a href="#l18.194"></a><span id="l18.194" class="difflineplus">+      nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l18.195"></a><span id="l18.195" class="difflineplus">+      rv = GetImapConnectionAndLoadUrl(thread, aImapUrl,</span>
<a href="#l18.196"></a><span id="l18.196">                                        aDisplayConsumer, aURL);</span>
<a href="#l18.197"></a><span id="l18.197">     }</span>
<a href="#l18.198"></a><span id="l18.198">   }</span>
<a href="#l18.199"></a><span id="l18.199">   return rv;</span>
<a href="#l18.200"></a><span id="l18.200"> }</span>
<a href="#l18.201"></a><span id="l18.201"> </span>
<a href="#l18.202"></a><span id="l18.202"> // this method streams a message to the passed in consumer, with an optional stream converter</span>
<a href="#l18.203"></a><span id="l18.203"> // and additional header (e.g., &quot;header=filter&quot;)</span>
<a href="#l18.204"></a><span id="l18.204" class="difflineat">@@ -1281,17 +1281,17 @@ nsresult nsImapService::CreateStartOfIma</span>
<a href="#l18.205"></a><span id="l18.205">   nsCString escapedUsername;</span>
<a href="#l18.206"></a><span id="l18.206"> </span>
<a href="#l18.207"></a><span id="l18.207">   rv = aImapMailFolder-&gt;GetHostname(hostname);</span>
<a href="#l18.208"></a><span id="l18.208">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.209"></a><span id="l18.209">   rv = aImapMailFolder-&gt;GetUsername(username);</span>
<a href="#l18.210"></a><span id="l18.210">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.211"></a><span id="l18.211"> </span>
<a href="#l18.212"></a><span id="l18.212">   if (!username.IsEmpty())</span>
<a href="#l18.213"></a><span id="l18.213" class="difflineminus">-    *((char **)getter_Copies(escapedUsername)) = nsEscape(username.get(), url_XAlphas);</span>
<a href="#l18.214"></a><span id="l18.214" class="difflineplus">+    MsgEscapeString(username, nsINetUtil::ESCAPE_XALPHAS, escapedUsername);</span>
<a href="#l18.215"></a><span id="l18.215"> </span>
<a href="#l18.216"></a><span id="l18.216">   PRInt32 port = nsIImapUrl::DEFAULT_IMAP_PORT;</span>
<a href="#l18.217"></a><span id="l18.217">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l18.218"></a><span id="l18.218">   rv = aImapMailFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l18.219"></a><span id="l18.219">   if (NS_SUCCEEDED(rv)) </span>
<a href="#l18.220"></a><span id="l18.220">   {</span>
<a href="#l18.221"></a><span id="l18.221">     server-&gt;GetPort(&amp;port);</span>
<a href="#l18.222"></a><span id="l18.222">     if (port == -1 || port == 0) port = nsIImapUrl::DEFAULT_IMAP_PORT;</span>
<a href="#l18.223"></a><span id="l18.223" class="difflineat">@@ -1302,17 +1302,17 @@ nsresult nsImapService::CreateStartOfIma</span>
<a href="#l18.224"></a><span id="l18.224">   rv = CallCreateInstance(kImapUrlCID, imapUrl);</span>
<a href="#l18.225"></a><span id="l18.225">   if (NS_SUCCEEDED(rv) &amp;&amp; *imapUrl)</span>
<a href="#l18.226"></a><span id="l18.226">   {</span>
<a href="#l18.227"></a><span id="l18.227">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailnewsUrl = do_QueryInterface(*imapUrl, &amp;rv);</span>
<a href="#l18.228"></a><span id="l18.228">     if (NS_SUCCEEDED(rv) &amp;&amp; mailnewsUrl &amp;&amp; aUrlListener)</span>
<a href="#l18.229"></a><span id="l18.229">       mailnewsUrl-&gt;RegisterListener(aUrlListener);</span>
<a href="#l18.230"></a><span id="l18.230">     nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgurl(do_QueryInterface(*imapUrl));</span>
<a href="#l18.231"></a><span id="l18.231">     (*imapUrl)-&gt;SetExternalLinkUrl(PR_FALSE);</span>
<a href="#l18.232"></a><span id="l18.232" class="difflineminus">-    msgurl-&gt;SetUri(nsDependentCString(aImapURI).get());</span>
<a href="#l18.233"></a><span id="l18.233" class="difflineplus">+    msgurl-&gt;SetUri(PromiseFlatCString(aImapURI).get());</span>
<a href="#l18.234"></a><span id="l18.234"> </span>
<a href="#l18.235"></a><span id="l18.235">     urlSpec = &quot;imap://&quot;;</span>
<a href="#l18.236"></a><span id="l18.236">     urlSpec.Append(escapedUsername);</span>
<a href="#l18.237"></a><span id="l18.237">     urlSpec.Append('@');</span>
<a href="#l18.238"></a><span id="l18.238">     urlSpec.Append(hostname);</span>
<a href="#l18.239"></a><span id="l18.239">     urlSpec.Append(':');</span>
<a href="#l18.240"></a><span id="l18.240"> </span>
<a href="#l18.241"></a><span id="l18.241">     nsCAutoString portStr;</span>
<a href="#l18.242"></a><span id="l18.242" class="difflineat">@@ -1492,18 +1492,20 @@ nsImapService::VerifyLogon(nsIMsgFolder </span>
<a href="#l18.243"></a><span id="l18.243">     nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l18.244"></a><span id="l18.244"> </span>
<a href="#l18.245"></a><span id="l18.245">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailNewsUrl = do_QueryInterface(imapUrl);</span>
<a href="#l18.246"></a><span id="l18.246">     mailNewsUrl-&gt;SetSuppressErrorMsgs(PR_TRUE);</span>
<a href="#l18.247"></a><span id="l18.247">     mailNewsUrl-&gt;SetMsgWindow(aMsgWindow);</span>
<a href="#l18.248"></a><span id="l18.248">     rv = SetImapUrlSink(aFolder, imapUrl);</span>
<a href="#l18.249"></a><span id="l18.249">     urlSpec.Append(&quot;/verifyLogon&quot;);</span>
<a href="#l18.250"></a><span id="l18.250">     rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l18.251"></a><span id="l18.251" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l18.252"></a><span id="l18.252" class="difflineminus">-      rv = GetImapConnectionAndLoadUrl(NS_GetCurrentThread(), imapUrl, nsnull, nsnull);</span>
<a href="#l18.253"></a><span id="l18.253" class="difflineplus">+    if (NS_SUCCEEDED(rv)) {</span>
<a href="#l18.254"></a><span id="l18.254" class="difflineplus">+      nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l18.255"></a><span id="l18.255" class="difflineplus">+      rv = GetImapConnectionAndLoadUrl(thread, imapUrl, nsnull, nsnull);</span>
<a href="#l18.256"></a><span id="l18.256" class="difflineplus">+    }</span>
<a href="#l18.257"></a><span id="l18.257">     if (aURL)</span>
<a href="#l18.258"></a><span id="l18.258">       uri.forget(aURL);</span>
<a href="#l18.259"></a><span id="l18.259">   }</span>
<a href="#l18.260"></a><span id="l18.260">   return rv;</span>
<a href="#l18.261"></a><span id="l18.261"> }</span>
<a href="#l18.262"></a><span id="l18.262"> </span>
<a href="#l18.263"></a><span id="l18.263"> // Noop, used to update a folder (causes server to send changes).</span>
<a href="#l18.264"></a><span id="l18.264"> NS_IMETHODIMP nsImapService::Noop(nsIEventTarget *aClientEventTarget, </span>
<a href="#l18.265"></a><span id="l18.265" class="difflineat">@@ -2271,34 +2273,33 @@ NS_IMETHODIMP nsImapService::RenameLeaf(</span>
<a href="#l18.266"></a><span id="l18.266">         mailNewsUrl-&gt;SetMsgWindow(msgWindow);</span>
<a href="#l18.267"></a><span id="l18.267">       nsCString folderName;</span>
<a href="#l18.268"></a><span id="l18.268">       GetFolderName(srcFolder, folderName);</span>
<a href="#l18.269"></a><span id="l18.269">       urlSpec.Append(&quot;/rename&gt;&quot;);</span>
<a href="#l18.270"></a><span id="l18.270">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l18.271"></a><span id="l18.271">       urlSpec.Append(folderName);</span>
<a href="#l18.272"></a><span id="l18.272">       urlSpec.Append('&gt;');</span>
<a href="#l18.273"></a><span id="l18.273">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l18.274"></a><span id="l18.274" class="difflineminus">-      nsCAutoString cStrFolderName(folderName);</span>
<a href="#l18.275"></a><span id="l18.275" class="difflineplus">+      nsCAutoString cStrFolderName;</span>
<a href="#l18.276"></a><span id="l18.276">       // Unescape the name before looking for parent path</span>
<a href="#l18.277"></a><span id="l18.277" class="difflineminus">-      nsUnescape(cStrFolderName.BeginWriting());</span>
<a href="#l18.278"></a><span id="l18.278" class="difflineplus">+      MsgUnescapeString(folderName, 0, cStrFolderName);</span>
<a href="#l18.279"></a><span id="l18.279">       PRInt32 leafNameStart = cStrFolderName.RFindChar(hierarchyDelimiter);</span>
<a href="#l18.280"></a><span id="l18.280">       if (leafNameStart != -1)</span>
<a href="#l18.281"></a><span id="l18.281">       {</span>
<a href="#l18.282"></a><span id="l18.282">         cStrFolderName.SetLength(leafNameStart+1);</span>
<a href="#l18.283"></a><span id="l18.283">         urlSpec.Append(cStrFolderName);</span>
<a href="#l18.284"></a><span id="l18.284">       }</span>
<a href="#l18.285"></a><span id="l18.285"> </span>
<a href="#l18.286"></a><span id="l18.286">       nsCAutoString utfNewName;</span>
<a href="#l18.287"></a><span id="l18.287" class="difflineminus">-      CopyUTF16toMUTF7(nsDependentString(newLeafName), utfNewName);</span>
<a href="#l18.288"></a><span id="l18.288" class="difflineminus">-      char* escapedNewName = nsEscape(utfNewName.get(), url_Path);</span>
<a href="#l18.289"></a><span id="l18.289" class="difflineminus">-      NS_ENSURE_TRUE(escapedNewName, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l18.290"></a><span id="l18.290" class="difflineplus">+      CopyUTF16toMUTF7(PromiseFlatString(newLeafName), utfNewName);</span>
<a href="#l18.291"></a><span id="l18.291" class="difflineplus">+      nsCString escapedNewName;</span>
<a href="#l18.292"></a><span id="l18.292" class="difflineplus">+      MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH, escapedNewName);</span>
<a href="#l18.293"></a><span id="l18.293">       nsCString escapedSlashName;</span>
<a href="#l18.294"></a><span id="l18.294" class="difflineminus">-      rv = nsImapUrl::EscapeSlashes(escapedNewName, getter_Copies(escapedSlashName));</span>
<a href="#l18.295"></a><span id="l18.295" class="difflineplus">+      rv = nsImapUrl::EscapeSlashes(escapedNewName.get(), getter_Copies(escapedSlashName));</span>
<a href="#l18.296"></a><span id="l18.296">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.297"></a><span id="l18.297" class="difflineminus">-      NS_Free(escapedNewName);</span>
<a href="#l18.298"></a><span id="l18.298">       urlSpec.Append(escapedSlashName);</span>
<a href="#l18.299"></a><span id="l18.299"> </span>
<a href="#l18.300"></a><span id="l18.300">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l18.301"></a><span id="l18.301">       if (NS_SUCCEEDED(rv))</span>
<a href="#l18.302"></a><span id="l18.302">         rv = GetImapConnectionAndLoadUrl(eventTarget, imapUrl, nsnull, url);</span>
<a href="#l18.303"></a><span id="l18.303">     } // if (NS_SUCCEEDED(rv))</span>
<a href="#l18.304"></a><span id="l18.304">   } // if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l18.305"></a><span id="l18.305">   return rv;</span>
<a href="#l18.306"></a><span id="l18.306" class="difflineat">@@ -2337,21 +2338,21 @@ NS_IMETHODIMP nsImapService::CreateFolde</span>
<a href="#l18.307"></a><span id="l18.307">         nsImapUrl::ConvertToCanonicalFormat(folderName.get(),</span>
<a href="#l18.308"></a><span id="l18.308">                                             hierarchyDelimiter,</span>
<a href="#l18.309"></a><span id="l18.309">                                             getter_Copies(canonicalName));</span>
<a href="#l18.310"></a><span id="l18.310">         urlSpec.Append(canonicalName);</span>
<a href="#l18.311"></a><span id="l18.311">         urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l18.312"></a><span id="l18.312">       }</span>
<a href="#l18.313"></a><span id="l18.313"> </span>
<a href="#l18.314"></a><span id="l18.314">       nsCAutoString utfNewName;</span>
<a href="#l18.315"></a><span id="l18.315" class="difflineminus">-      rv = CopyUTF16toMUTF7(nsDependentString(newFolderName), utfNewName);</span>
<a href="#l18.316"></a><span id="l18.316" class="difflineplus">+      rv = CopyUTF16toMUTF7(PromiseFlatString(newFolderName), utfNewName);</span>
<a href="#l18.317"></a><span id="l18.317">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.318"></a><span id="l18.318" class="difflineminus">-      char* escapedFolderName = nsEscape(utfNewName.get(), url_Path);</span>
<a href="#l18.319"></a><span id="l18.319" class="difflineplus">+      nsCString escapedFolderName;</span>
<a href="#l18.320"></a><span id="l18.320" class="difflineplus">+      MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH, escapedFolderName);</span>
<a href="#l18.321"></a><span id="l18.321">       urlSpec.Append(escapedFolderName);</span>
<a href="#l18.322"></a><span id="l18.322" class="difflineminus">-      NS_Free(escapedFolderName);</span>
<a href="#l18.323"></a><span id="l18.323"> </span>
<a href="#l18.324"></a><span id="l18.324">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l18.325"></a><span id="l18.325">       if (NS_SUCCEEDED(rv))</span>
<a href="#l18.326"></a><span id="l18.326">         rv = GetImapConnectionAndLoadUrl(eventTarget, imapUrl, nsnull, url);</span>
<a href="#l18.327"></a><span id="l18.327">     } // if (NS_SUCCEEDED(rv))</span>
<a href="#l18.328"></a><span id="l18.328">   } // if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l18.329"></a><span id="l18.329">   return rv;</span>
<a href="#l18.330"></a><span id="l18.330"> }</span>
<a href="#l18.331"></a><span id="l18.331" class="difflineat">@@ -2383,20 +2384,20 @@ NS_IMETHODIMP nsImapService::EnsureFolde</span>
<a href="#l18.332"></a><span id="l18.332">       urlSpec.Append(&quot;/ensureExists&gt;&quot;);</span>
<a href="#l18.333"></a><span id="l18.333">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l18.334"></a><span id="l18.334">       if (!folderName.IsEmpty())</span>
<a href="#l18.335"></a><span id="l18.335">       {</span>
<a href="#l18.336"></a><span id="l18.336">         urlSpec.Append(folderName);</span>
<a href="#l18.337"></a><span id="l18.337">         urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l18.338"></a><span id="l18.338">       }</span>
<a href="#l18.339"></a><span id="l18.339">       nsCAutoString utfNewName; </span>
<a href="#l18.340"></a><span id="l18.340" class="difflineminus">-      CopyUTF16toMUTF7(nsDependentString(newFolderName), utfNewName);</span>
<a href="#l18.341"></a><span id="l18.341" class="difflineminus">-      char* escapedFolderName = nsEscape(utfNewName.get(), url_Path);</span>
<a href="#l18.342"></a><span id="l18.342" class="difflineplus">+      CopyUTF16toMUTF7(PromiseFlatString(newFolderName), utfNewName);</span>
<a href="#l18.343"></a><span id="l18.343" class="difflineplus">+      nsCString escapedFolderName;</span>
<a href="#l18.344"></a><span id="l18.344" class="difflineplus">+      MsgEscapeString(utfNewName, nsINetUtil::ESCAPE_URL_PATH, escapedFolderName);</span>
<a href="#l18.345"></a><span id="l18.345">       urlSpec.Append(escapedFolderName);</span>
<a href="#l18.346"></a><span id="l18.346" class="difflineminus">-      NS_Free(escapedFolderName);</span>
<a href="#l18.347"></a><span id="l18.347"> </span>
<a href="#l18.348"></a><span id="l18.348">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l18.349"></a><span id="l18.349">       if (NS_SUCCEEDED(rv))</span>
<a href="#l18.350"></a><span id="l18.350">         rv = GetImapConnectionAndLoadUrl(eventTarget, imapUrl, nsnull, url);</span>
<a href="#l18.351"></a><span id="l18.351">     } // if (NS_SUCCEEDED(rv))</span>
<a href="#l18.352"></a><span id="l18.352">   } // if (NS_SUCCEEDED(rv) &amp;&amp; imapUrl)</span>
<a href="#l18.353"></a><span id="l18.353">   return rv;</span>
<a href="#l18.354"></a><span id="l18.354"> }</span>
<a href="#l18.355"></a><span id="l18.355" class="difflineat">@@ -2638,19 +2639,21 @@ NS_IMETHODIMP nsImapService::NewChannel(</span>
<a href="#l18.356"></a><span id="l18.356">     // which we can tell by seeing if the sinks have been setup on the url or not.</span>
<a href="#l18.357"></a><span id="l18.357">     nsCOMPtr &lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l18.358"></a><span id="l18.358">     rv = GetServerFromUrl(imapUrl, getter_AddRefs(server));</span>
<a href="#l18.359"></a><span id="l18.359">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.360"></a><span id="l18.360">     nsCString folderName;</span>
<a href="#l18.361"></a><span id="l18.361">     imapUrl-&gt;CreateCanonicalSourceFolderPathString(getter_Copies(folderName));</span>
<a href="#l18.362"></a><span id="l18.362">     if (folderName.IsEmpty())</span>
<a href="#l18.363"></a><span id="l18.363">     {</span>
<a href="#l18.364"></a><span id="l18.364" class="difflineminus">-      rv = mailnewsUrl-&gt;GetFileName(folderName);</span>
<a href="#l18.365"></a><span id="l18.365" class="difflineminus">-      if (!folderName.IsEmpty())</span>
<a href="#l18.366"></a><span id="l18.366" class="difflineminus">-        NS_UnescapeURL(folderName);</span>
<a href="#l18.367"></a><span id="l18.367" class="difflineplus">+      nsCString escapedFolderName;</span>
<a href="#l18.368"></a><span id="l18.368" class="difflineplus">+      rv = mailnewsUrl-&gt;GetFileName(escapedFolderName);</span>
<a href="#l18.369"></a><span id="l18.369" class="difflineplus">+      if (!escapedFolderName.IsEmpty()) {</span>
<a href="#l18.370"></a><span id="l18.370" class="difflineplus">+        MsgUnescapeString(escapedFolderName, 0, folderName);</span>
<a href="#l18.371"></a><span id="l18.371" class="difflineplus">+      }</span>
<a href="#l18.372"></a><span id="l18.372">     }</span>
<a href="#l18.373"></a><span id="l18.373">     // if the parent is null, then the folder doesn't really exist, so see if the user</span>
<a href="#l18.374"></a><span id="l18.374">     // wants to subscribe to it./</span>
<a href="#l18.375"></a><span id="l18.375">     nsCOMPtr&lt;nsIMsgFolder&gt; aFolder;</span>
<a href="#l18.376"></a><span id="l18.376">     // now try to get the folder in question...</span>
<a href="#l18.377"></a><span id="l18.377">     nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l18.378"></a><span id="l18.378">     server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l18.379"></a><span id="l18.379">     nsCOMPtr &lt;nsIMsgImapMailFolder&gt; imapRoot = do_QueryInterface(rootFolder);</span>
<a href="#l18.380"></a><span id="l18.380" class="difflineat">@@ -2932,34 +2935,35 @@ NS_IMETHODIMP nsImapService::GetListOfFo</span>
<a href="#l18.381"></a><span id="l18.381">   {</span>
<a href="#l18.382"></a><span id="l18.382">     // If the folder path contains 'INBOX' of any forms, we need to convert it to uppercase</span>
<a href="#l18.383"></a><span id="l18.383">     // before finding it under the root folder. We do the same in PossibleImapMailbox().</span>
<a href="#l18.384"></a><span id="l18.384">     nsCAutoString tempFolderName(folderPath);</span>
<a href="#l18.385"></a><span id="l18.385">     nsCAutoString tokenStr, remStr, changedStr;</span>
<a href="#l18.386"></a><span id="l18.386">     PRInt32 slashPos = tempFolderName.FindChar('/');</span>
<a href="#l18.387"></a><span id="l18.387">     if (slashPos &gt; 0)</span>
<a href="#l18.388"></a><span id="l18.388">     {</span>
<a href="#l18.389"></a><span id="l18.389" class="difflineminus">-      tempFolderName.Left(tokenStr,slashPos);</span>
<a href="#l18.390"></a><span id="l18.390" class="difflineminus">-      tempFolderName.Right(remStr, tempFolderName.Length()-slashPos);</span>
<a href="#l18.391"></a><span id="l18.391" class="difflineplus">+      tokenStr = StringHead(tempFolderName, slashPos);</span>
<a href="#l18.392"></a><span id="l18.392" class="difflineplus">+      remStr = Substring(tempFolderName, slashPos);</span>
<a href="#l18.393"></a><span id="l18.393">     }</span>
<a href="#l18.394"></a><span id="l18.394">     else</span>
<a href="#l18.395"></a><span id="l18.395">       tokenStr.Assign(tempFolderName);</span>
<a href="#l18.396"></a><span id="l18.396"> </span>
<a href="#l18.397"></a><span id="l18.397">     if (tokenStr.Equals(NS_LITERAL_CSTRING(&quot;INBOX&quot;), nsCaseInsensitiveCStringComparator()) &amp;&amp; </span>
<a href="#l18.398"></a><span id="l18.398">         !tokenStr.Equals(NS_LITERAL_CSTRING(&quot;INBOX&quot;)))</span>
<a href="#l18.399"></a><span id="l18.399">       changedStr.Append(&quot;INBOX&quot;);</span>
<a href="#l18.400"></a><span id="l18.400">     else</span>
<a href="#l18.401"></a><span id="l18.401">       changedStr.Append(tokenStr);</span>
<a href="#l18.402"></a><span id="l18.402"> </span>
<a href="#l18.403"></a><span id="l18.403">     if (slashPos &gt; 0 ) </span>
<a href="#l18.404"></a><span id="l18.404">       changedStr.Append(remStr);</span>
<a href="#l18.405"></a><span id="l18.405"> </span>
<a href="#l18.406"></a><span id="l18.406">     rv = rootMsgFolder-&gt;FindSubFolder(changedStr, getter_AddRefs(msgFolder));</span>
<a href="#l18.407"></a><span id="l18.407">   }</span>
<a href="#l18.408"></a><span id="l18.408" class="difflineminus">-  return DiscoverChildren(NS_GetCurrentThread(), msgFolder, listener, folderPath, nsnull);</span>
<a href="#l18.409"></a><span id="l18.409" class="difflineplus">+  nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l18.410"></a><span id="l18.410" class="difflineplus">+  return DiscoverChildren(thread, msgFolder, listener, folderPath, nsnull);</span>
<a href="#l18.411"></a><span id="l18.411"> }</span>
<a href="#l18.412"></a><span id="l18.412"> </span>
<a href="#l18.413"></a><span id="l18.413"> NS_IMETHODIMP nsImapService::GetListOfFoldersOnServer(nsIImapIncomingServer *aServer, </span>
<a href="#l18.414"></a><span id="l18.414">                                                       nsIMsgWindow *aMsgWindow)</span>
<a href="#l18.415"></a><span id="l18.415"> {</span>
<a href="#l18.416"></a><span id="l18.416">   nsresult rv;</span>
<a href="#l18.417"></a><span id="l18.417"> </span>
<a href="#l18.418"></a><span id="l18.418">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(aServer);</span>
<a href="#l18.419"></a><span id="l18.419" class="difflineat">@@ -2971,17 +2975,18 @@ NS_IMETHODIMP nsImapService::GetListOfFo</span>
<a href="#l18.420"></a><span id="l18.420"> </span>
<a href="#l18.421"></a><span id="l18.421">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.422"></a><span id="l18.422">   if (!rootMsgFolder) </span>
<a href="#l18.423"></a><span id="l18.423">     return NS_ERROR_FAILURE;</span>
<a href="#l18.424"></a><span id="l18.424"> </span>
<a href="#l18.425"></a><span id="l18.425">   nsCOMPtr&lt;nsIUrlListener&gt; listener = do_QueryInterface(aServer, &amp;rv);</span>
<a href="#l18.426"></a><span id="l18.426">   NS_ENSURE_TRUE(NS_SUCCEEDED(rv) &amp;&amp; listener, NS_ERROR_FAILURE);</span>
<a href="#l18.427"></a><span id="l18.427"> </span>
<a href="#l18.428"></a><span id="l18.428" class="difflineminus">-  return DiscoverAllAndSubscribedFolders(NS_GetCurrentThread(), rootMsgFolder, listener, nsnull);</span>
<a href="#l18.429"></a><span id="l18.429" class="difflineplus">+  nsCOMPtr&lt;nsIThread&gt; thread(do_GetCurrentThread());</span>
<a href="#l18.430"></a><span id="l18.430" class="difflineplus">+  return DiscoverAllAndSubscribedFolders(thread, rootMsgFolder, listener, nsnull);</span>
<a href="#l18.431"></a><span id="l18.431"> } </span>
<a href="#l18.432"></a><span id="l18.432"> </span>
<a href="#l18.433"></a><span id="l18.433"> NS_IMETHODIMP nsImapService::SubscribeFolder(nsIEventTarget *eventTarget, </span>
<a href="#l18.434"></a><span id="l18.434">                                              nsIMsgFolder *aFolder,</span>
<a href="#l18.435"></a><span id="l18.435">                                              const nsAString &amp;aFolderName, </span>
<a href="#l18.436"></a><span id="l18.436">                                              nsIUrlListener *urlListener, </span>
<a href="#l18.437"></a><span id="l18.437">                                              nsIURI **url)</span>
<a href="#l18.438"></a><span id="l18.438"> {</span>
<a href="#l18.439"></a><span id="l18.439" class="difflineat">@@ -3009,21 +3014,21 @@ nsresult nsImapService::ChangeFolderSubs</span>
<a href="#l18.440"></a><span id="l18.440">   {</span>
<a href="#l18.441"></a><span id="l18.441">     rv = SetImapUrlSink(folder, imapUrl);</span>
<a href="#l18.442"></a><span id="l18.442">     if (NS_SUCCEEDED(rv))</span>
<a href="#l18.443"></a><span id="l18.443">     {</span>
<a href="#l18.444"></a><span id="l18.444">       nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(imapUrl);</span>
<a href="#l18.445"></a><span id="l18.445">       urlSpec.Append(command);</span>
<a href="#l18.446"></a><span id="l18.446">       urlSpec.Append(hierarchyDelimiter);</span>
<a href="#l18.447"></a><span id="l18.447">       nsCAutoString utfFolderName;</span>
<a href="#l18.448"></a><span id="l18.448" class="difflineminus">-      rv = CopyUTF16toMUTF7(nsDependentString(folderName), utfFolderName);</span>
<a href="#l18.449"></a><span id="l18.449" class="difflineplus">+      rv = CopyUTF16toMUTF7(PromiseFlatString(folderName), utfFolderName);</span>
<a href="#l18.450"></a><span id="l18.450">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.451"></a><span id="l18.451" class="difflineminus">-      char* escapedFolderName = nsEscape(utfFolderName.get(), url_Path);</span>
<a href="#l18.452"></a><span id="l18.452" class="difflineplus">+      nsCString escapedFolderName;</span>
<a href="#l18.453"></a><span id="l18.453" class="difflineplus">+      MsgEscapeString(utfFolderName, nsINetUtil::ESCAPE_URL_PATH, escapedFolderName);</span>
<a href="#l18.454"></a><span id="l18.454">       urlSpec.Append(escapedFolderName);</span>
<a href="#l18.455"></a><span id="l18.455" class="difflineminus">-      NS_Free(escapedFolderName);</span>
<a href="#l18.456"></a><span id="l18.456">       rv = uri-&gt;SetSpec(urlSpec);</span>
<a href="#l18.457"></a><span id="l18.457">       if (NS_SUCCEEDED(rv))</span>
<a href="#l18.458"></a><span id="l18.458">         rv = GetImapConnectionAndLoadUrl(eventTarget, imapUrl, nsnull, url);</span>
<a href="#l18.459"></a><span id="l18.459">     }</span>
<a href="#l18.460"></a><span id="l18.460">   }</span>
<a href="#l18.461"></a><span id="l18.461">   return rv;</span>
<a href="#l18.462"></a><span id="l18.462"> }</span>
<a href="#l18.463"></a><span id="l18.463"> </span>
<a href="#l18.464"></a><span id="l18.464" class="difflineat">@@ -3313,21 +3318,22 @@ NS_IMETHODIMP nsImapService::HandleConte</span>
<a href="#l18.465"></a><span id="l18.465">       request-&gt;Cancel(NS_BINDING_ABORTED);</span>
<a href="#l18.466"></a><span id="l18.466">       nsCOMPtr&lt;nsIWindowMediator&gt; mediator(do_GetService(NS_WINDOWMEDIATOR_CONTRACTID, &amp;rv));</span>
<a href="#l18.467"></a><span id="l18.467">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.468"></a><span id="l18.468">       nsCAutoString uriStr;</span>
<a href="#l18.469"></a><span id="l18.469"> </span>
<a href="#l18.470"></a><span id="l18.470">       uri-&gt;GetSpec(uriStr);</span>
<a href="#l18.471"></a><span id="l18.471"> </span>
<a href="#l18.472"></a><span id="l18.472">       // imap uri's are unescaped, so unescape the url.</span>
<a href="#l18.473"></a><span id="l18.473" class="difflineminus">-      NS_UnescapeURL(uriStr);</span>
<a href="#l18.474"></a><span id="l18.474" class="difflineplus">+      nsCString unescapedUriStr;</span>
<a href="#l18.475"></a><span id="l18.475" class="difflineplus">+      MsgUnescapeString(uriStr, 0, unescapedUriStr);</span>
<a href="#l18.476"></a><span id="l18.476">       nsCOMPtr &lt;nsIMessengerWindowService&gt; messengerWindowService = do_GetService(NS_MESSENGERWINDOWSERVICE_CONTRACTID,&amp;rv);</span>
<a href="#l18.477"></a><span id="l18.477">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.478"></a><span id="l18.478"> </span>
<a href="#l18.479"></a><span id="l18.479" class="difflineminus">-      rv = messengerWindowService-&gt;OpenMessengerWindowWithUri(&quot;mail:3pane&quot;, uriStr.get(), nsMsgKey_None);</span>
<a href="#l18.480"></a><span id="l18.480" class="difflineplus">+      rv = messengerWindowService-&gt;OpenMessengerWindowWithUri(&quot;mail:3pane&quot;, unescapedUriStr.get(), nsMsgKey_None);</span>
<a href="#l18.481"></a><span id="l18.481">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l18.482"></a><span id="l18.482">     }</span>
<a href="#l18.483"></a><span id="l18.483">   } </span>
<a href="#l18.484"></a><span id="l18.484">   else </span>
<a href="#l18.485"></a><span id="l18.485">   {</span>
<a href="#l18.486"></a><span id="l18.486">     // The content-type was not x-application-imapfolder</span>
<a href="#l18.487"></a><span id="l18.487">     return NS_ERROR_WONT_HANDLE_CONTENT;</span>
<a href="#l18.488"></a><span id="l18.488">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/imap/src/nsImapStringBundle.cpp</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapStringBundle.cpp</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -32,21 +32,22 @@</span>
<a href="#l19.4"></a><span id="l19.4">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l19.5"></a><span id="l19.5">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l19.6"></a><span id="l19.6">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l19.7"></a><span id="l19.7">  *</span>
<a href="#l19.8"></a><span id="l19.8">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l19.9"></a><span id="l19.9"> #include &quot;prprf.h&quot;</span>
<a href="#l19.10"></a><span id="l19.10"> #include &quot;prmem.h&quot;</span>
<a href="#l19.11"></a><span id="l19.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l19.14"></a><span id="l19.14"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l19.15"></a><span id="l19.15"> #include &quot;nsImapStringBundle.h&quot;</span>
<a href="#l19.16"></a><span id="l19.16"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l19.17"></a><span id="l19.17"> #include &quot;nsIURI.h&quot;</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20"> #define IMAP_MSGS_URL       &quot;chrome://messenger/locale/imapMsgs.properties&quot;</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22"> extern &quot;C&quot; </span>
<a href="#l19.23"></a><span id="l19.23"> nsresult</span>
<a href="#l19.24"></a><span id="l19.24"> IMAPGetStringByID(PRInt32 stringID, PRUnichar **aString)</span>
<a href="#l19.25"></a><span id="l19.25"> {</span>
<a href="#l19.26"></a><span id="l19.26">   nsresult res=NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUndoTxn.cpp</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUndoTxn.cpp</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -44,16 +44,18 @@</span>
<a href="#l20.4"></a><span id="l20.4"> #include &quot;nsIIMAPHostSessionList.h&quot;</span>
<a href="#l20.5"></a><span id="l20.5"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l20.6"></a><span id="l20.6"> #include &quot;nsImapMailFolder.h&quot;</span>
<a href="#l20.7"></a><span id="l20.7"> #include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l20.8"></a><span id="l20.8"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l20.9"></a><span id="l20.9"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> #include &quot;nsISupportsArray.h&quot;</span>
<a href="#l20.11"></a><span id="l20.11"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+#include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l20.14"></a><span id="l20.14"> </span>
<a href="#l20.15"></a><span id="l20.15"> nsImapMoveCopyMsgTxn::nsImapMoveCopyMsgTxn() :</span>
<a href="#l20.16"></a><span id="l20.16">     m_idsAreUids(PR_FALSE), m_isMove(PR_FALSE), m_srcIsPop3(PR_FALSE)</span>
<a href="#l20.17"></a><span id="l20.17"> {</span>
<a href="#l20.18"></a><span id="l20.18"> }</span>
<a href="#l20.19"></a><span id="l20.19"> </span>
<a href="#l20.20"></a><span id="l20.20"> nsresult</span>
<a href="#l20.21"></a><span id="l20.21"> nsImapMoveCopyMsgTxn::Init(nsIMsgFolder* srcFolder, nsTArray&lt;nsMsgKey&gt;* srcKeyArray, </span>
<a href="#l20.22"></a><span id="l20.22" class="difflineat">@@ -86,17 +88,17 @@ nsImapMoveCopyMsgTxn::Init(nsIMsgFolder*</span>
<a href="#l20.23"></a><span id="l20.23">   for (i = 0; i &lt; count; i++)</span>
<a href="#l20.24"></a><span id="l20.24">   {</span>
<a href="#l20.25"></a><span id="l20.25">     nsMsgKey pseudoKey;</span>
<a href="#l20.26"></a><span id="l20.26">     rv = srcDB-&gt;GetMsgHdrForKey(m_srcKeyArray[i],</span>
<a href="#l20.27"></a><span id="l20.27">       getter_AddRefs(srcHdr));</span>
<a href="#l20.28"></a><span id="l20.28">     if (NS_SUCCEEDED(rv))</span>
<a href="#l20.29"></a><span id="l20.29">     {</span>
<a href="#l20.30"></a><span id="l20.30">       // ** jt -- only do this for mailbox protocol</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineminus">-      if (protocolType.LowerCaseEqualsLiteral(&quot;mailbox&quot;))</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+      if (MsgLowerCaseEqualsLiteral(protocolType, &quot;mailbox&quot;))</span>
<a href="#l20.33"></a><span id="l20.33">       {</span>
<a href="#l20.34"></a><span id="l20.34">         m_srcIsPop3 = PR_TRUE;</span>
<a href="#l20.35"></a><span id="l20.35">         PRUint32 msgSize;</span>
<a href="#l20.36"></a><span id="l20.36">         rv = srcHdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l20.37"></a><span id="l20.37">         if (NS_SUCCEEDED(rv))</span>
<a href="#l20.38"></a><span id="l20.38">           m_srcSizeArray.AppendElement(msgSize);</span>
<a href="#l20.39"></a><span id="l20.39">         if (isMove)</span>
<a href="#l20.40"></a><span id="l20.40">         {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUrl.cpp</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUrl.cpp</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -38,38 +38,38 @@</span>
<a href="#l21.4"></a><span id="l21.4"> </span>
<a href="#l21.5"></a><span id="l21.5"> #include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l21.6"></a><span id="l21.6"> #include &quot;nsMsgImapCID.h&quot;</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8"> #include &quot;nsIURL.h&quot;</span>
<a href="#l21.9"></a><span id="l21.9"> #include &quot;nsImapUrl.h&quot;</span>
<a href="#l21.10"></a><span id="l21.10"> #include &quot;nsIIMAPHostSessionList.h&quot;</span>
<a href="#l21.11"></a><span id="l21.11"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l21.14"></a><span id="l21.14"> #include &quot;prmem.h&quot;</span>
<a href="#l21.15"></a><span id="l21.15"> #include &quot;plstr.h&quot;</span>
<a href="#l21.16"></a><span id="l21.16"> #include &quot;prprf.h&quot;</span>
<a href="#l21.17"></a><span id="l21.17"> #include &quot;nsCRT.h&quot;</span>
<a href="#l21.18"></a><span id="l21.18"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l21.19"></a><span id="l21.19"> #include &quot;nsIImapIncomingServer.h&quot;</span>
<a href="#l21.20"></a><span id="l21.20"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l21.21"></a><span id="l21.21"> #include &quot;nsImapUtils.h&quot;</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l21.23"></a><span id="l21.23"> #include &quot;nsAutoLock.h&quot;</span>
<a href="#l21.24"></a><span id="l21.24"> #include &quot;nsIMAPNamespace.h&quot;</span>
<a href="#l21.25"></a><span id="l21.25"> #include &quot;nsICacheEntryDescriptor.h&quot;</span>
<a href="#l21.26"></a><span id="l21.26"> #include &quot;nsISupportsObsolete.h&quot;</span>
<a href="#l21.27"></a><span id="l21.27"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l21.28"></a><span id="l21.28"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l21.29"></a><span id="l21.29"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l21.30"></a><span id="l21.30"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l21.31"></a><span id="l21.31"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l21.32"></a><span id="l21.32"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l21.33"></a><span id="l21.33"> #include &quot;nsIProgressEventSink.h&quot;</span>
<a href="#l21.34"></a><span id="l21.34" class="difflineminus">-#include &quot;nsEscape.h&quot;</span>
<a href="#l21.35"></a><span id="l21.35" class="difflineplus">+#include &quot;nsAlgorithm.h&quot;</span>
<a href="#l21.36"></a><span id="l21.36" class="difflineplus">+#include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l21.37"></a><span id="l21.37"> </span>
<a href="#l21.38"></a><span id="l21.38"> static NS_DEFINE_CID(kCImapHostSessionListCID, NS_IIMAPHOSTSESSIONLIST_CID);</span>
<a href="#l21.39"></a><span id="l21.39"> </span>
<a href="#l21.40"></a><span id="l21.40"> nsImapUrl::nsImapUrl()</span>
<a href="#l21.41"></a><span id="l21.41"> {</span>
<a href="#l21.42"></a><span id="l21.42">   m_listOfMessageIds = nsnull;</span>
<a href="#l21.43"></a><span id="l21.43">   m_sourceCanonicalFolderPathSubString = nsnull;</span>
<a href="#l21.44"></a><span id="l21.44">   m_destinationCanonicalFolderPathSubString = nsnull;</span>
<a href="#l21.45"></a><span id="l21.45" class="difflineat">@@ -258,20 +258,21 @@ NS_IMETHODIMP nsImapUrl::SetQuery(const </span>
<a href="#l21.46"></a><span id="l21.46"> nsresult nsImapUrl::ParseUrl()</span>
<a href="#l21.47"></a><span id="l21.47"> {</span>
<a href="#l21.48"></a><span id="l21.48">   nsresult rv = NS_OK;</span>
<a href="#l21.49"></a><span id="l21.49">   // extract the user name</span>
<a href="#l21.50"></a><span id="l21.50">   GetUserPass(m_userName);</span>
<a href="#l21.51"></a><span id="l21.51"> </span>
<a href="#l21.52"></a><span id="l21.52">   nsCAutoString imapPartOfUrl;</span>
<a href="#l21.53"></a><span id="l21.53">   rv = GetPath(imapPartOfUrl);</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-  NS_UnescapeURL(imapPartOfUrl);</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !imapPartOfUrl.IsEmpty())</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+  nsCAutoString unescapedImapPartOfUrl;</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+  MsgUnescapeString(imapPartOfUrl, 0, unescapedImapPartOfUrl);</span>
<a href="#l21.58"></a><span id="l21.58" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !unescapedImapPartOfUrl.IsEmpty())</span>
<a href="#l21.59"></a><span id="l21.59">   {</span>
<a href="#l21.60"></a><span id="l21.60" class="difflineminus">-    ParseImapPart(imapPartOfUrl.BeginWriting()+1);  // GetPath leaves leading '/' in the path!!!</span>
<a href="#l21.61"></a><span id="l21.61" class="difflineplus">+    ParseImapPart(unescapedImapPartOfUrl.BeginWriting()+1);  // GetPath leaves leading '/' in the path!!!</span>
<a href="#l21.62"></a><span id="l21.62">   }</span>
<a href="#l21.63"></a><span id="l21.63"> </span>
<a href="#l21.64"></a><span id="l21.64">   return NS_OK;</span>
<a href="#l21.65"></a><span id="l21.65"> }</span>
<a href="#l21.66"></a><span id="l21.66"> </span>
<a href="#l21.67"></a><span id="l21.67"> NS_IMETHODIMP nsImapUrl::CreateSearchCriteriaString(char ** aResult)</span>
<a href="#l21.68"></a><span id="l21.68"> {</span>
<a href="#l21.69"></a><span id="l21.69">   // this method should only be called from the imap thread...</span>
<a href="#l21.70"></a><span id="l21.70" class="difflineat">@@ -793,17 +794,17 @@ NS_IMETHODIMP nsImapUrl::AddOnlineDirect</span>
<a href="#l21.71"></a><span id="l21.71">       nsCAutoString onlineDirWithDelimiter(onlineDir);</span>
<a href="#l21.72"></a><span id="l21.72">       // make sure the onlineDir ends with the hierarchy delimiter</span>
<a href="#l21.73"></a><span id="l21.73">       if (ns)</span>
<a href="#l21.74"></a><span id="l21.74">       {</span>
<a href="#l21.75"></a><span id="l21.75">         char delimiter = ns-&gt;GetDelimiter();</span>
<a href="#l21.76"></a><span id="l21.76">         if ( delimiter &amp;&amp; delimiter != kOnlineHierarchySeparatorUnknown )</span>
<a href="#l21.77"></a><span id="l21.77">         {</span>
<a href="#l21.78"></a><span id="l21.78">           // try to change the canonical online dir name to real dir name first</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineminus">-          onlineDirWithDelimiter.ReplaceChar('/', delimiter);</span>
<a href="#l21.80"></a><span id="l21.80" class="difflineplus">+          MsgReplaceChar(onlineDirWithDelimiter, '/', delimiter);</span>
<a href="#l21.81"></a><span id="l21.81">           // make sure the last character is the delimiter</span>
<a href="#l21.82"></a><span id="l21.82">           if ( onlineDirWithDelimiter.Last() != delimiter )</span>
<a href="#l21.83"></a><span id="l21.83">             onlineDirWithDelimiter += delimiter;</span>
<a href="#l21.84"></a><span id="l21.84">           if ( !*onlineMailboxName )</span>
<a href="#l21.85"></a><span id="l21.85">             onlineDirWithDelimiter.SetLength(onlineDirWithDelimiter.Length()-1);</span>
<a href="#l21.86"></a><span id="l21.86">         }</span>
<a href="#l21.87"></a><span id="l21.87">       }</span>
<a href="#l21.88"></a><span id="l21.88">       if (ns &amp;&amp; (PL_strlen(ns-&gt;GetPrefix()) != 0) &amp;&amp; !onlineDirWithDelimiter.Equals(ns-&gt;GetPrefix()))</span>
<a href="#l21.89"></a><span id="l21.89" class="difflineat">@@ -990,25 +991,25 @@ NS_IMETHODIMP nsImapUrl::AllocateCanonic</span>
<a href="#l21.90"></a><span id="l21.90"> </span>
<a href="#l21.91"></a><span id="l21.91">   if (!serverPath || NS_FAILED(rv))</span>
<a href="#l21.92"></a><span id="l21.92">     goto done;</span>
<a href="#l21.93"></a><span id="l21.93"> </span>
<a href="#l21.94"></a><span id="l21.94">   hostSessionList-&gt;GetOnlineDirForHost(m_serverKey.get(), aString);</span>
<a href="#l21.95"></a><span id="l21.95">   // First we have to check to see if we should strip off an online server</span>
<a href="#l21.96"></a><span id="l21.96">   // subdirectory</span>
<a href="#l21.97"></a><span id="l21.97">   // If this host has an online server directory configured</span>
<a href="#l21.98"></a><span id="l21.98" class="difflineminus">-  onlineDir = (char *)(!aString.IsEmpty() ? ToNewCString(aString) : nsnull);</span>
<a href="#l21.99"></a><span id="l21.99" class="difflineplus">+  LossyCopyUTF16toASCII(aString, onlineDir);</span>
<a href="#l21.100"></a><span id="l21.100"> </span>
<a href="#l21.101"></a><span id="l21.101">   if (currentPath &amp;&amp; !onlineDir.IsEmpty())</span>
<a href="#l21.102"></a><span id="l21.102">   {</span>
<a href="#l21.103"></a><span id="l21.103">     // By definition, the online dir must be at the root.</span>
<a href="#l21.104"></a><span id="l21.104">     if (delimiterToUse &amp;&amp; delimiterToUse != kOnlineHierarchySeparatorUnknown)</span>
<a href="#l21.105"></a><span id="l21.105">     {</span>
<a href="#l21.106"></a><span id="l21.106">       // try to change the canonical online dir name to real dir name first</span>
<a href="#l21.107"></a><span id="l21.107" class="difflineminus">-      onlineDir.ReplaceChar('/', delimiterToUse);</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineplus">+      MsgReplaceChar(onlineDir, '/', delimiterToUse);</span>
<a href="#l21.109"></a><span id="l21.109">       // Add the delimiter</span>
<a href="#l21.110"></a><span id="l21.110">       if (onlineDir.Last() != delimiterToUse)</span>
<a href="#l21.111"></a><span id="l21.111">         onlineDir += delimiterToUse;</span>
<a href="#l21.112"></a><span id="l21.112">     }</span>
<a href="#l21.113"></a><span id="l21.113">     int len = onlineDir.Length();</span>
<a href="#l21.114"></a><span id="l21.114">     if (!PL_strncmp(onlineDir.get(), currentPath, len))</span>
<a href="#l21.115"></a><span id="l21.115">     {</span>
<a href="#l21.116"></a><span id="l21.116">       // This online path begins with the server sub directory</span>
<a href="#l21.117"></a><span id="l21.117" class="difflineat">@@ -1347,18 +1348,19 @@ void nsImapUrl::ParseFolderPath(char **r</span>
<a href="#l21.118"></a><span id="l21.118">   {</span>
<a href="#l21.119"></a><span id="l21.119">     m_validUrl = PR_FALSE;</span>
<a href="#l21.120"></a><span id="l21.120">     return;</span>
<a href="#l21.121"></a><span id="l21.121">   }</span>
<a href="#l21.122"></a><span id="l21.122">   NS_ASSERTION(*resultingCanonicalPath == nsnull, &quot;whoops, mem leak&quot;);</span>
<a href="#l21.123"></a><span id="l21.123"> </span>
<a href="#l21.124"></a><span id="l21.124">   char dirSeparator = *resultPath;</span>
<a href="#l21.125"></a><span id="l21.125"> </span>
<a href="#l21.126"></a><span id="l21.126" class="difflineminus">-  *resultingCanonicalPath = PL_strdup(resultPath + 1);</span>
<a href="#l21.127"></a><span id="l21.127" class="difflineminus">-  nsUnescape(*resultingCanonicalPath);</span>
<a href="#l21.128"></a><span id="l21.128" class="difflineplus">+  nsCString unescapedResultingCanonicalPath;</span>
<a href="#l21.129"></a><span id="l21.129" class="difflineplus">+  MsgUnescapeString(nsDependentCString(resultPath + 1), 0, unescapedResultingCanonicalPath);</span>
<a href="#l21.130"></a><span id="l21.130" class="difflineplus">+  *resultingCanonicalPath = ToNewCString(unescapedResultingCanonicalPath);</span>
<a href="#l21.131"></a><span id="l21.131">   // The delimiter will be set for a given URL, but will not be statically available</span>
<a href="#l21.132"></a><span id="l21.132">   // from an arbitrary URL.  It is the creator's responsibility to fill in the correct</span>
<a href="#l21.133"></a><span id="l21.133">   // delimiter from the folder's namespace when creating the URL.</span>
<a href="#l21.134"></a><span id="l21.134">   if (dirSeparator != kOnlineHierarchySeparatorUnknown)</span>
<a href="#l21.135"></a><span id="l21.135">     SetOnlineSubDirSeparator( dirSeparator);</span>
<a href="#l21.136"></a><span id="l21.136"> </span>
<a href="#l21.137"></a><span id="l21.137">   // if dirSeparator == kOnlineHierarchySeparatorUnknown, then this must be a create</span>
<a href="#l21.138"></a><span id="l21.138">   // of a top level imap box.  If there is an online subdir, we will automatically</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUtils.cpp</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUtils.cpp</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -34,21 +34,19 @@</span>
<a href="#l22.4"></a><span id="l22.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l22.5"></a><span id="l22.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l22.6"></a><span id="l22.6">  *</span>
<a href="#l22.7"></a><span id="l22.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9"> #include &quot;msgCore.h&quot;</span>
<a href="#l22.10"></a><span id="l22.10"> #include &quot;nsImapUtils.h&quot;</span>
<a href="#l22.11"></a><span id="l22.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-#include &quot;nsReadableUtils.h&quot;</span>
<a href="#l22.13"></a><span id="l22.13"> #include &quot;nsIServiceManager.h&quot;</span>
<a href="#l22.14"></a><span id="l22.14"> #include &quot;prsystem.h&quot;</span>
<a href="#l22.15"></a><span id="l22.15"> #include &quot;prprf.h&quot;</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-#include &quot;nsEscape.h&quot;</span>
<a href="#l22.17"></a><span id="l22.17"> #include &quot;nsNetCID.h&quot;</span>
<a href="#l22.18"></a><span id="l22.18"> </span>
<a href="#l22.19"></a><span id="l22.19"> // stuff for temporary root folder hack</span>
<a href="#l22.20"></a><span id="l22.20"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l22.21"></a><span id="l22.21"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l22.22"></a><span id="l22.22"> #include &quot;nsIImapIncomingServer.h&quot;</span>
<a href="#l22.23"></a><span id="l22.23"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l22.24"></a><span id="l22.24"> #include &quot;nsImapCore.h&quot;</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineat">@@ -57,32 +55,31 @@</span>
<a href="#l22.26"></a><span id="l22.26"> #include &quot;nsISupportsObsolete.h&quot;</span>
<a href="#l22.27"></a><span id="l22.27"> #include &quot;nsIMAPNamespace.h&quot;</span>
<a href="#l22.28"></a><span id="l22.28"> #include &quot;nsIImapFlagAndUidState.h&quot;</span>
<a href="#l22.29"></a><span id="l22.29"> </span>
<a href="#l22.30"></a><span id="l22.30"> nsresult</span>
<a href="#l22.31"></a><span id="l22.31"> nsImapURI2FullName(const char* rootURI, const char* hostName, const char* uriStr,</span>
<a href="#l22.32"></a><span id="l22.32">                    char **name)</span>
<a href="#l22.33"></a><span id="l22.33"> {</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-    nsAutoString uri;</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-    CopyASCIItoUTF16(uriStr, uri);</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-    nsAutoString fullName;</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineplus">+    nsCAutoString uri(uriStr);</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineplus">+    nsCAutoString fullName;</span>
<a href="#l22.39"></a><span id="l22.39">     if (uri.Find(rootURI) != 0)</span>
<a href="#l22.40"></a><span id="l22.40">       return NS_ERROR_FAILURE;</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-    uri.Right(fullName, uri.Length() - strlen(rootURI));</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineplus">+    fullName = Substring(uri, strlen(rootURI));</span>
<a href="#l22.43"></a><span id="l22.43">     uri = fullName;</span>
<a href="#l22.44"></a><span id="l22.44">     PRInt32 hostStart = uri.Find(hostName);</span>
<a href="#l22.45"></a><span id="l22.45">     if (hostStart &lt;= 0) </span>
<a href="#l22.46"></a><span id="l22.46">       return NS_ERROR_FAILURE;</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-    uri.Right(fullName, uri.Length() - hostStart);</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineplus">+    fullName = Substring(uri, hostStart);</span>
<a href="#l22.49"></a><span id="l22.49">     uri = fullName;</span>
<a href="#l22.50"></a><span id="l22.50">     PRInt32 hostEnd = uri.FindChar('/');</span>
<a href="#l22.51"></a><span id="l22.51">     if (hostEnd &lt;= 0) </span>
<a href="#l22.52"></a><span id="l22.52">       return NS_ERROR_FAILURE;</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-    uri.Right(fullName, uri.Length() - hostEnd - 1);</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+    fullName = Substring(uri, hostEnd + 1);</span>
<a href="#l22.55"></a><span id="l22.55">     if (fullName.IsEmpty())</span>
<a href="#l22.56"></a><span id="l22.56">       return NS_ERROR_FAILURE;</span>
<a href="#l22.57"></a><span id="l22.57">     *name = ToNewCString(fullName);</span>
<a href="#l22.58"></a><span id="l22.58">     return NS_OK;</span>
<a href="#l22.59"></a><span id="l22.59"> }</span>
<a href="#l22.60"></a><span id="l22.60"> </span>
<a href="#l22.61"></a><span id="l22.61"> /* parses ImapMessageURI */</span>
<a href="#l22.62"></a><span id="l22.62"> nsresult nsParseImapMessageURI(const char* uri, nsCString&amp; folderURI, PRUint32 *key, char **part)</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineat">@@ -94,23 +91,22 @@ nsresult nsParseImapMessageURI(const cha</span>
<a href="#l22.64"></a><span id="l22.64">   PRInt32 folderEnd = -1;</span>
<a href="#l22.65"></a><span id="l22.65">   // imap-message uri's can have imap:// url strings tacked on the end,</span>
<a href="#l22.66"></a><span id="l22.66">   // e.g., when opening/saving attachments. We don't want to look for '#'</span>
<a href="#l22.67"></a><span id="l22.67">   // in that part of the uri, if the attachment name contains '#',</span>
<a href="#l22.68"></a><span id="l22.68">   // so check for that here.</span>
<a href="#l22.69"></a><span id="l22.69">   if (StringBeginsWith(uriStr, NS_LITERAL_CSTRING(&quot;imap-message&quot;)))</span>
<a href="#l22.70"></a><span id="l22.70">     folderEnd = uriStr.Find(&quot;imap://&quot;);</span>
<a href="#l22.71"></a><span id="l22.71"> </span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-  PRInt32 keySeparator = uriStr.RFindChar('#', folderEnd);</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineplus">+  PRInt32 keySeparator = MsgRFindChar(uriStr, '#', folderEnd);</span>
<a href="#l22.74"></a><span id="l22.74">   if(keySeparator != -1)</span>
<a href="#l22.75"></a><span id="l22.75">   {</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-    PRInt32 keyEndSeparator = uriStr.FindCharInSet(&quot;/?&amp;&quot;,</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineminus">-                                                   keySeparator);</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineplus">+    PRInt32 keyEndSeparator = MsgFindCharInSet(uriStr, &quot;/?&amp;&quot;, keySeparator);</span>
<a href="#l22.79"></a><span id="l22.79">     nsAutoString folderPath;</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineminus">-    uriStr.Left(folderURI, keySeparator);</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineplus">+    folderURI = StringHead(uriStr, keySeparator);</span>
<a href="#l22.82"></a><span id="l22.82">     folderURI.Cut(4, 8); // cut out the _message part of imap-message:</span>
<a href="#l22.83"></a><span id="l22.83">     // folder uri's don't have fully escaped usernames.</span>
<a href="#l22.84"></a><span id="l22.84">     PRInt32 atPos = folderURI.FindChar('@');</span>
<a href="#l22.85"></a><span id="l22.85">     if (atPos != -1)</span>
<a href="#l22.86"></a><span id="l22.86">     {</span>
<a href="#l22.87"></a><span id="l22.87">       nsCString unescapedName, escapedName;</span>
<a href="#l22.88"></a><span id="l22.88">       PRInt32 userNamePos = folderURI.Find(&quot;//&quot;) + 2;</span>
<a href="#l22.89"></a><span id="l22.89">       PRUint32 origUserNameLen = atPos - userNamePos;</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineat">@@ -121,31 +117,29 @@ nsresult nsParseImapMessageURI(const cha</span>
<a href="#l22.91"></a><span id="l22.91">         // Re-escape the username, matching the way we do it in uris, not the</span>
<a href="#l22.92"></a><span id="l22.92">         // way necko escapes urls. See nsMsgIncomingServer::GetServerURI.</span>
<a href="#l22.93"></a><span id="l22.93">         MsgEscapeString(unescapedName, nsINetUtil::ESCAPE_XALPHAS, escapedName);</span>
<a href="#l22.94"></a><span id="l22.94">         folderURI.Replace(userNamePos, origUserNameLen, escapedName);</span>
<a href="#l22.95"></a><span id="l22.95">       }</span>
<a href="#l22.96"></a><span id="l22.96">     }</span>
<a href="#l22.97"></a><span id="l22.97">     nsCAutoString keyStr;</span>
<a href="#l22.98"></a><span id="l22.98">     if (keyEndSeparator != -1)</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineminus">-      uriStr.Mid(keyStr, keySeparator+1,</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineminus">-                 keyEndSeparator-(keySeparator+1));</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineplus">+      keyStr = Substring(uriStr, keySeparator + 1, keyEndSeparator - (keySeparator + 1));</span>
<a href="#l22.102"></a><span id="l22.102">     else</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineminus">-      uriStr.Right(keyStr, uriStr.Length() - (keySeparator + 1));</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineminus">-    PRInt32 errorCode;</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineplus">+      keyStr = Substring(uriStr, keySeparator + 1);</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineplus">+</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineplus">+    nsresult errorCode;</span>
<a href="#l22.108"></a><span id="l22.108">     *key = keyStr.ToInteger(&amp;errorCode, 10);</span>
<a href="#l22.109"></a><span id="l22.109"> </span>
<a href="#l22.110"></a><span id="l22.110">     if (part &amp;&amp; keyEndSeparator != -1)</span>
<a href="#l22.111"></a><span id="l22.111">     {</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineminus">-      PRInt32 partPos = uriStr.Find(&quot;part=&quot;, PR_FALSE, keyEndSeparator);</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineplus">+      PRInt32 partPos = MsgFind(uriStr, &quot;part=&quot;, PR_FALSE, keyEndSeparator);</span>
<a href="#l22.114"></a><span id="l22.114">       if (partPos != -1)</span>
<a href="#l22.115"></a><span id="l22.115">       {</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineminus">-        nsCString partSubStr;</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineminus">-        uriStr.Right(partSubStr, uriStr.Length() - keyEndSeparator);</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineminus">-        *part = ToNewCString(partSubStr);</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineplus">+        *part = ToNewCString(Substring(uriStr, keyEndSeparator));</span>
<a href="#l22.120"></a><span id="l22.120">       }</span>
<a href="#l22.121"></a><span id="l22.121">     }</span>
<a href="#l22.122"></a><span id="l22.122">   }</span>
<a href="#l22.123"></a><span id="l22.123">   return NS_OK;</span>
<a href="#l22.124"></a><span id="l22.124"> }</span>
<a href="#l22.125"></a><span id="l22.125"> </span>
<a href="#l22.126"></a><span id="l22.126"> nsresult nsBuildImapMessageURI(const char *baseURI, PRUint32 key, nsCString&amp; uri)</span>
<a href="#l22.127"></a><span id="l22.127"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/imap/src/nsImapUtils.h</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapUtils.h</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -33,21 +33,22 @@</span>
<a href="#l23.4"></a><span id="l23.4">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l23.5"></a><span id="l23.5">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l23.6"></a><span id="l23.6">  *</span>
<a href="#l23.7"></a><span id="l23.7">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l23.8"></a><span id="l23.8"> </span>
<a href="#l23.9"></a><span id="l23.9"> #ifndef NS_IMAPUTILS_H</span>
<a href="#l23.10"></a><span id="l23.10"> #define NS_IMAPUTILS_H</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-#include &quot;nsString.h&quot;</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l23.14"></a><span id="l23.14"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l23.15"></a><span id="l23.15"> #include &quot;MailNewsTypes.h&quot;</span>
<a href="#l23.16"></a><span id="l23.16"> #include &quot;nsTArray.h&quot;</span>
<a href="#l23.17"></a><span id="l23.17"> #include &quot;nsIMailboxSpec.h&quot;</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineplus">+#include &quot;nsCOMPtr.h&quot;</span>
<a href="#l23.19"></a><span id="l23.19"> </span>
<a href="#l23.20"></a><span id="l23.20"> class nsImapFlagAndUidState;</span>
<a href="#l23.21"></a><span id="l23.21"> class nsImapProtocol;</span>
<a href="#l23.22"></a><span id="l23.22"> </span>
<a href="#l23.23"></a><span id="l23.23"> static const char kImapRootURI[] = &quot;imap:/&quot;;</span>
<a href="#l23.24"></a><span id="l23.24"> static const char kImapMessageRootURI[] = &quot;imap-message:/&quot;;</span>
<a href="#l23.25"></a><span id="l23.25"> static const char kModSeqPropertyName[] = &quot;highestModSeq&quot;;</span>
<a href="#l23.26"></a><span id="l23.26"> static const char kHighestRecordedUIDPropertyName[] = &quot;highestRecordedUID&quot;;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

