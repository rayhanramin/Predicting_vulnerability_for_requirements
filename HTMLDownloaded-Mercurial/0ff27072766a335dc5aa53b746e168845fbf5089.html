<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26663:0ff27072766a335dc5aa53b746e168845fbf5089</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 0ff27072766a335dc5aa53b746e168845fbf5089" />
<meta property="og:url" content="/comm-central/rev/0ff27072766a335dc5aa53b746e168845fbf5089" />
<meta property="og:description" content="Bug 1550674 - Turn on ESLint in mail/test/mozmill; r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 0ff27072766a335dc5aa53b746e168845fbf5089 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/0ff27072766a335dc5aa53b746e168845fbf5089">shortlog</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/0ff27072766a335dc5aa53b746e168845fbf5089">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089">files</a> |
changeset |
<a href="/comm-central/raw-rev/0ff27072766a335dc5aa53b746e168845fbf5089">raw</a>  | <a href="/comm-central/archive/0ff27072766a335dc5aa53b746e168845fbf5089.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1550674">Bug 1550674</a> - Turn on ESLint in mail/test/mozmill; r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 20 May 2019 17:41:23 +1200</td></tr>

<tr>
 <td>changeset 26663</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/0ff27072766a335dc5aa53b746e168845fbf5089">0ff27072766a335dc5aa53b746e168845fbf5089</a></td>
</tr>



<tr>
<td>parent 26662</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/67542c5ca9f20d811e9683a5fa2390ab30828f9d">67542c5ca9f20d811e9683a5fa2390ab30828f9d</a>
</td>
</tr>

<tr>
<td>child 26664</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b800b4a19b7f83c14800bbdb8471975be80a0aed">b800b4a19b7f83c14800bbdb8471975be80a0aed</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=0ff27072766a335dc5aa53b746e168845fbf5089">15939</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 20 May 2019 06:00:46 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@42218a907154 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=42218a9071546f0bbd8e16dbd73df43e537ad998">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=42218a9071546f0bbd8e16dbd73df43e537ad998&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=42218a9071546f0bbd8e16dbd73df43e537ad998&newProject=comm-central&newRevision=67542c5ca9f20d811e9683a5fa2390ab30828f9d&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=42218a9071546f0bbd8e16dbd73df43e537ad998&newProject=comm-central&newRevision=67542c5ca9f20d811e9683a5fa2390ab30828f9d&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=42218a9071546f0bbd8e16dbd73df43e537ad998&newProject=comm-central&newRevision=67542c5ca9f20d811e9683a5fa2390ab30828f9d&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1550674">1550674</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1550674">Bug 1550674</a> - Turn on ESLint in mail/test/mozmill; r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/.eslintignore">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/.eslintignore">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/.eslintignore">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/.eslintignore">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/.eslintrc.js">mail/test/mozmill/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-ab-whitelist.js">mail/test/mozmill/account/test-ab-whitelist.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-ab-whitelist.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-ab-whitelist.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-ab-whitelist.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-ab-whitelist.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-ab-whitelist.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-actions.js">mail/test/mozmill/account/test-account-actions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-actions.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-actions.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-actions.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-actions.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-actions.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-deletion.js">mail/test/mozmill/account/test-account-deletion.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-deletion.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-deletion.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-deletion.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-deletion.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-deletion.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-port-setting.js">mail/test/mozmill/account/test-account-port-setting.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-port-setting.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-port-setting.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-port-setting.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-port-setting.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-port-setting.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-settings-infrastructure.js">mail/test/mozmill/account/test-account-settings-infrastructure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-settings-infrastructure.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-settings-infrastructure.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-settings-infrastructure.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-settings-infrastructure.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-settings-infrastructure.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-tree.js">mail/test/mozmill/account/test-account-tree.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-tree.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-tree.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-tree.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-tree.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-tree.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-values.js">mail/test/mozmill/account/test-account-values.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-values.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-values.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-values.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-values.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-account-values.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-archive-options.js">mail/test/mozmill/account/test-archive-options.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-archive-options.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-archive-options.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-archive-options.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-archive-options.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-archive-options.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-mail-account-setup-wizard.js">mail/test/mozmill/account/test-mail-account-setup-wizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-mail-account-setup-wizard.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-mail-account-setup-wizard.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-mail-account-setup-wizard.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-mail-account-setup-wizard.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-mail-account-setup-wizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-retest-config.js">mail/test/mozmill/account/test-retest-config.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-retest-config.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-retest-config.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-retest-config.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-retest-config.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/account/test-retest-config.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-address-book-panes.js">mail/test/mozmill/addrbook/test-address-book-panes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-address-book-panes.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-address-book-panes.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-address-book-panes.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-address-book-panes.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-address-book-panes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-address-book.js">mail/test/mozmill/addrbook/test-address-book.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-address-book.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-address-book.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-address-book.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-address-book.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-address-book.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-update-mailing-list.js">mail/test/mozmill/addrbook/test-update-mailing-list.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-update-mailing-list.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-update-mailing-list.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-update-mailing-list.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-update-mailing-list.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/addrbook/test-update-mailing-list.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-events.js">mail/test/mozmill/attachment/test-attachment-events.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-events.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-events.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-events.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-events.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-events.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js">mail/test/mozmill/attachment/test-attachment-in-plain-msg.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-menus.js">mail/test/mozmill/attachment/test-attachment-menus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-menus.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-menus.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-menus.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-menus.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-menus.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-size.js">mail/test/mozmill/attachment/test-attachment-size.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-size.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-size.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-size.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-size.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment-size.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment.js">mail/test/mozmill/attachment/test-attachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/attachment/test-attachment.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js">mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">mail/test/mozmill/cloudfile/test-cloudfile-manager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-address-widgets.js">mail/test/mozmill/composition/test-address-widgets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-address-widgets.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-address-widgets.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-address-widgets.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-address-widgets.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-address-widgets.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-attachment-reminder.js">mail/test/mozmill/composition/test-attachment-reminder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-attachment-reminder.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-attachment-reminder.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-attachment-reminder.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-attachment-reminder.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-attachment-reminder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-attachment.js">mail/test/mozmill/composition/test-attachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-attachment.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-attachment.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-attachment.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-attachment.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-attachment.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-base64-display.js">mail/test/mozmill/composition/test-base64-display.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-base64-display.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-base64-display.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-base64-display.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-base64-display.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-base64-display.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-blocked-content.js">mail/test/mozmill/composition/test-blocked-content.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-blocked-content.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-blocked-content.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-blocked-content.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-blocked-content.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-blocked-content.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-charset-edit.js">mail/test/mozmill/composition/test-charset-edit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-charset-edit.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-charset-edit.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-charset-edit.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-charset-edit.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-charset-edit.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-charset-upgrade.js">mail/test/mozmill/composition/test-charset-upgrade.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-charset-upgrade.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-charset-upgrade.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-charset-upgrade.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-charset-upgrade.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-charset-upgrade.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-cp932-display.js">mail/test/mozmill/composition/test-cp932-display.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-cp932-display.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-cp932-display.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-cp932-display.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-cp932-display.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-cp932-display.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-draft-identity.js">mail/test/mozmill/composition/test-draft-identity.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-draft-identity.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-draft-identity.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-draft-identity.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-draft-identity.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-draft-identity.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-drafts.js">mail/test/mozmill/composition/test-drafts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-drafts.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-drafts.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-drafts.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-drafts.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-drafts.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-eml-actions.js">mail/test/mozmill/composition/test-eml-actions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-eml-actions.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-eml-actions.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-eml-actions.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-eml-actions.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-eml-actions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-focus.js">mail/test/mozmill/composition/test-focus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-focus.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-focus.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-focus.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-focus.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-focus.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-headers.js">mail/test/mozmill/composition/test-forward-headers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-headers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-headers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-headers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-headers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-headers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-rfc822-attach.js">mail/test/mozmill/composition/test-forward-rfc822-attach.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-rfc822-attach.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-rfc822-attach.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-rfc822-attach.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-rfc822-attach.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-rfc822-attach.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-utf8.js">mail/test/mozmill/composition/test-forward-utf8.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-utf8.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-utf8.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-utf8.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-utf8.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forward-utf8.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forwarded-content.js">mail/test/mozmill/composition/test-forwarded-content.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forwarded-content.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forwarded-content.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forwarded-content.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forwarded-content.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forwarded-content.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forwarded-eml-actions.js">mail/test/mozmill/composition/test-forwarded-eml-actions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forwarded-eml-actions.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forwarded-eml-actions.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forwarded-eml-actions.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forwarded-eml-actions.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-forwarded-eml-actions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-image-display.js">mail/test/mozmill/composition/test-image-display.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-image-display.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-image-display.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-image-display.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-image-display.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-image-display.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-image-insertion-dialog.js">mail/test/mozmill/composition/test-image-insertion-dialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-image-insertion-dialog.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-image-insertion-dialog.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-image-insertion-dialog.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-image-insertion-dialog.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-image-insertion-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-multipart-related.js">mail/test/mozmill/composition/test-multipart-related.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-multipart-related.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-multipart-related.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-multipart-related.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-multipart-related.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-multipart-related.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-newmsg-compose-identity.js">mail/test/mozmill/composition/test-newmsg-compose-identity.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-newmsg-compose-identity.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-newmsg-compose-identity.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-newmsg-compose-identity.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-newmsg-compose-identity.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-newmsg-compose-identity.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-addresses.js">mail/test/mozmill/composition/test-reply-addresses.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-addresses.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-addresses.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-addresses.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-addresses.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-addresses.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-format-flowed.js">mail/test/mozmill/composition/test-reply-format-flowed.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-format-flowed.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-format-flowed.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-format-flowed.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-format-flowed.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-format-flowed.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-multipart-charset.js">mail/test/mozmill/composition/test-reply-multipart-charset.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-multipart-charset.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-multipart-charset.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-multipart-charset.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-multipart-charset.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-multipart-charset.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-signature.js">mail/test/mozmill/composition/test-reply-signature.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-signature.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-signature.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-signature.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-signature.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-reply-signature.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-save-changes-on-quit.js">mail/test/mozmill/composition/test-save-changes-on-quit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-save-changes-on-quit.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-save-changes-on-quit.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-save-changes-on-quit.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-save-changes-on-quit.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-save-changes-on-quit.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-send-button.js">mail/test/mozmill/composition/test-send-button.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-send-button.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-send-button.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-send-button.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-send-button.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-send-button.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-send-format.js">mail/test/mozmill/composition/test-send-format.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-send-format.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-send-format.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-send-format.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-send-format.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-send-format.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-signature-init.js">mail/test/mozmill/composition/test-signature-init.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-signature-init.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-signature-init.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-signature-init.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-signature-init.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-signature-init.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-signature-updating.js">mail/test/mozmill/composition/test-signature-updating.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-signature-updating.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-signature-updating.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-signature-updating.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-signature-updating.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/composition/test-signature-updating.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-compose-mailto.js">mail/test/mozmill/content-policy/test-compose-mailto.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-compose-mailto.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-compose-mailto.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-compose-mailto.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-compose-mailto.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-compose-mailto.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-dns-prefetch.js">mail/test/mozmill/content-policy/test-dns-prefetch.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-dns-prefetch.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-dns-prefetch.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-dns-prefetch.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-dns-prefetch.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-dns-prefetch.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js">mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-general-content-policy.js">mail/test/mozmill/content-policy/test-general-content-policy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-general-content-policy.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-general-content-policy.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-general-content-policy.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-general-content-policy.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-general-content-policy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-js-content-policy.js">mail/test/mozmill/content-policy/test-js-content-policy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-js-content-policy.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-js-content-policy.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-js-content-policy.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-js-content-policy.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-js-content-policy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-plugins-policy.js">mail/test/mozmill/content-policy/test-plugins-policy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-plugins-policy.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-plugins-policy.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-plugins-policy.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-plugins-policy.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-plugins-policy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-view-source.js">mail/test/mozmill/content-policy/test-view-source.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-view-source.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-view-source.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-view-source.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-view-source.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-policy/test-view-source.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/html/test-lwthemes.html">mail/test/mozmill/content-tabs/html/test-lwthemes.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/html/test-lwthemes.html">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/html/test-lwthemes.html">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/html/test-lwthemes.html">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/html/test-lwthemes.html">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/html/test-lwthemes.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-about-support.js">mail/test/mozmill/content-tabs/test-about-support.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-about-support.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-about-support.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-about-support.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-about-support.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-about-support.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-addons-mgr.js">mail/test/mozmill/content-tabs/test-addons-mgr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-addons-mgr.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-addons-mgr.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-addons-mgr.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-addons-mgr.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-addons-mgr.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-content-tab.js">mail/test/mozmill/content-tabs/test-content-tab.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-content-tab.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-content-tab.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-content-tab.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-content-tab.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-content-tab.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-install-xpi.js">mail/test/mozmill/content-tabs/test-install-xpi.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-install-xpi.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-install-xpi.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-install-xpi.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-install-xpi.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/content-tabs/test-install-xpi.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cookies/test-cookies.js">mail/test/mozmill/cookies/test-cookies.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cookies/test-cookies.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cookies/test-cookies.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cookies/test-cookies.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cookies/test-cookies.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/cookies/test-cookies.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/downloads/test-about-downloads.js">mail/test/mozmill/downloads/test-about-downloads.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/downloads/test-about-downloads.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/downloads/test-about-downloads.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/downloads/test-about-downloads.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/downloads/test-about-downloads.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/downloads/test-about-downloads.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-archive-messages.js">mail/test/mozmill/folder-display/test-archive-messages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-archive-messages.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-archive-messages.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-archive-messages.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-archive-messages.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-archive-messages.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-close-window-on-delete.js">mail/test/mozmill/folder-display/test-close-window-on-delete.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-close-window-on-delete.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-close-window-on-delete.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-close-window-on-delete.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-close-window-on-delete.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-close-window-on-delete.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-columns.js">mail/test/mozmill/folder-display/test-columns.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-columns.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-columns.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-columns.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-columns.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-columns.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js">mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-display-name.js">mail/test/mozmill/folder-display/test-display-name.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-display-name.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-display-name.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-display-name.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-display-name.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-display-name.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js">mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-folder-pane-visibility.js">mail/test/mozmill/folder-display/test-folder-pane-visibility.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-folder-pane-visibility.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-folder-pane-visibility.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-folder-pane-visibility.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-folder-pane-visibility.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-folder-pane-visibility.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-folder-toolbar.js">mail/test/mozmill/folder-display/test-folder-toolbar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-folder-toolbar.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-folder-toolbar.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-folder-toolbar.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-folder-toolbar.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-folder-toolbar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js">mail/test/mozmill/folder-display/test-invalid-db-folder-load.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-mail-views.js">mail/test/mozmill/folder-display/test-mail-views.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-mail-views.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-mail-views.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-mail-views.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-mail-views.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-mail-views.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js">mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-commands.js">mail/test/mozmill/folder-display/test-message-commands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-commands.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-commands.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-commands.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-commands.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-commands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-pane-visibility.js">mail/test/mozmill/folder-display/test-message-pane-visibility.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-pane-visibility.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-pane-visibility.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-pane-visibility.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-pane-visibility.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-pane-visibility.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-reloads.js">mail/test/mozmill/folder-display/test-message-reloads.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-reloads.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-reloads.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-reloads.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-reloads.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-reloads.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-size.js">mail/test/mozmill/folder-display/test-message-size.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-size.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-size.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-size.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-size.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-size.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-window.js">mail/test/mozmill/folder-display/test-message-window.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-window.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-window.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-window.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-window.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-message-window.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-opening-messages-without-a-backing-view.js">mail/test/mozmill/folder-display/test-opening-messages-without-a-backing-view.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-opening-messages-without-a-backing-view.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-opening-messages-without-a-backing-view.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-opening-messages-without-a-backing-view.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-opening-messages-without-a-backing-view.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-opening-messages-without-a-backing-view.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-opening-messages.js">mail/test/mozmill/folder-display/test-opening-messages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-opening-messages.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-opening-messages.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-opening-messages.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-opening-messages.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-opening-messages.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-pane-focus.js">mail/test/mozmill/folder-display/test-pane-focus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-pane-focus.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-pane-focus.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-pane-focus.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-pane-focus.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-pane-focus.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-recent-menu.js">mail/test/mozmill/folder-display/test-recent-menu.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-recent-menu.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-recent-menu.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-recent-menu.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-recent-menu.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-recent-menu.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js">mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-selection.js">mail/test/mozmill/folder-display/test-selection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-selection.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-selection.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-selection.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-selection.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-selection.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-summarization.js">mail/test/mozmill/folder-display/test-summarization.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-summarization.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-summarization.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-summarization.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-summarization.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-summarization.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-tabs-simple.js">mail/test/mozmill/folder-display/test-tabs-simple.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-tabs-simple.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-tabs-simple.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-tabs-simple.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-tabs-simple.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-tabs-simple.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-virtual-folder-commands.js">mail/test/mozmill/folder-display/test-virtual-folder-commands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-virtual-folder-commands.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-virtual-folder-commands.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-virtual-folder-commands.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-virtual-folder-commands.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-virtual-folder-commands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-watch-ignore-thread.js">mail/test/mozmill/folder-display/test-watch-ignore-thread.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-watch-ignore-thread.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-watch-ignore-thread.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-watch-ignore-thread.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-watch-ignore-thread.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-display/test-watch-ignore-thread.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-display-message-with-folder-modes.js">mail/test/mozmill/folder-pane/test-display-message-with-folder-modes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-display-message-with-folder-modes.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-display-message-with-folder-modes.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-display-message-with-folder-modes.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-display-message-with-folder-modes.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-display-message-with-folder-modes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-names-in-recent-mode.js">mail/test/mozmill/folder-pane/test-folder-names-in-recent-mode.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-names-in-recent-mode.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-names-in-recent-mode.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-names-in-recent-mode.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-names-in-recent-mode.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-names-in-recent-mode.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-pane-consumers.js">mail/test/mozmill/folder-pane/test-folder-pane-consumers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-pane-consumers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-pane-consumers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-pane-consumers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-pane-consumers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-pane-consumers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-pane.js">mail/test/mozmill/folder-pane/test-folder-pane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-pane.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-pane.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-pane.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-pane.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-pane/test-folder-pane.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-custom-smart-folder.js">mail/test/mozmill/folder-tree-modes/test-custom-smart-folder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-custom-smart-folder.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-custom-smart-folder.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-custom-smart-folder.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-custom-smart-folder.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-custom-smart-folder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-extension/bootstrap.js">mail/test/mozmill/folder-tree-modes/test-extension/bootstrap.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-extension/bootstrap.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-extension/bootstrap.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-extension/bootstrap.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-extension/bootstrap.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-extension/bootstrap.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-mode-switching.js">mail/test/mozmill/folder-tree-modes/test-mode-switching.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-mode-switching.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-mode-switching.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-mode-switching.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-mode-switching.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-mode-switching.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-smart-folders.js">mail/test/mozmill/folder-tree-modes/test-smart-folders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-smart-folders.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-smart-folders.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-smart-folders.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-smart-folders.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-smart-folders.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-unread-folders.js">mail/test/mozmill/folder-tree-modes/test-unread-folders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-unread-folders.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-unread-folders.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-unread-folders.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-unread-folders.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-tree-modes/test-unread-folders.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-widget/test-message-filters.js">mail/test/mozmill/folder-widget/test-message-filters.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-widget/test-message-filters.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-widget/test-message-filters.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-widget/test-message-filters.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-widget/test-message-filters.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/folder-widget/test-message-filters.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/im/test-chat-tab-restore.js">mail/test/mozmill/im/test-chat-tab-restore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/im/test-chat-tab-restore.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/im/test-chat-tab-restore.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/im/test-chat-tab-restore.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/im/test-chat-tab-restore.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/im/test-chat-tab-restore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/im/test-toolbar-buttons.js">mail/test/mozmill/im/test-toolbar-buttons.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/im/test-toolbar-buttons.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/im/test-toolbar-buttons.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/im/test-toolbar-buttons.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/im/test-toolbar-buttons.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/im/test-toolbar-buttons.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/instrumentation/test-instrument-setup.js">mail/test/mozmill/instrumentation/test-instrument-setup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/instrumentation/test-instrument-setup.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/instrumentation/test-instrument-setup.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/instrumentation/test-instrument-setup.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/instrumentation/test-instrument-setup.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/instrumentation/test-instrument-setup.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/junk-commands/test-junk-commands.js">mail/test/mozmill/junk-commands/test-junk-commands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/junk-commands/test-junk-commands.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/junk-commands/test-junk-commands.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/junk-commands/test-junk-commands.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/junk-commands/test-junk-commands.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/junk-commands/test-junk-commands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/keyboard/test-spacehit.js">mail/test/mozmill/keyboard/test-spacehit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/keyboard/test-spacehit.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/keyboard/test-spacehit.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/keyboard/test-spacehit.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/keyboard/test-spacehit.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/keyboard/test-spacehit.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-message-header.js">mail/test/mozmill/message-header/test-message-header.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-message-header.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-message-header.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-message-header.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-message-header.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-message-header.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-phishing-bar.js">mail/test/mozmill/message-header/test-phishing-bar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-phishing-bar.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-phishing-bar.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-phishing-bar.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-phishing-bar.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-phishing-bar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-reply-identity.js">mail/test/mozmill/message-header/test-reply-identity.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-reply-identity.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-reply-identity.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-reply-identity.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-reply-identity.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-reply-identity.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-return-receipt.js">mail/test/mozmill/message-header/test-return-receipt.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-return-receipt.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-return-receipt.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-return-receipt.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-return-receipt.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-header/test-return-receipt.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-reader/test-bug594646.js">mail/test/mozmill/message-reader/test-bug594646.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-reader/test-bug594646.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-reader/test-bug594646.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-reader/test-bug594646.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-reader/test-bug594646.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-reader/test-bug594646.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-autohide-menubar.js">mail/test/mozmill/message-window/test-autohide-menubar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-autohide-menubar.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-autohide-menubar.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-autohide-menubar.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-autohide-menubar.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-autohide-menubar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-commands.js">mail/test/mozmill/message-window/test-commands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-commands.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-commands.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-commands.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-commands.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-commands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-eml-subject.js">mail/test/mozmill/message-window/test-eml-subject.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-eml-subject.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-eml-subject.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-eml-subject.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-eml-subject.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-eml-subject.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-message-sidebar.js">mail/test/mozmill/message-window/test-message-sidebar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-message-sidebar.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-message-sidebar.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-message-sidebar.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-message-sidebar.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-message-sidebar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-vcard-actions.js">mail/test/mozmill/message-window/test-vcard-actions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-vcard-actions.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-vcard-actions.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-vcard-actions.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-vcard-actions.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-vcard-actions.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-view-plaintext.js">mail/test/mozmill/message-window/test-view-plaintext.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-view-plaintext.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-view-plaintext.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-view-plaintext.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-view-plaintext.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/message-window/test-view-plaintext.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/multiple-identities/test-display-names.js">mail/test/mozmill/multiple-identities/test-display-names.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/multiple-identities/test-display-names.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/multiple-identities/test-display-names.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/multiple-identities/test-display-names.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/multiple-identities/test-display-names.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/multiple-identities/test-display-names.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/newmailaccount/test-newmailaccount.js">mail/test/mozmill/newmailaccount/test-newmailaccount.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/newmailaccount/test-newmailaccount.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/newmailaccount/test-newmailaccount.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/newmailaccount/test-newmailaccount.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/newmailaccount/test-newmailaccount.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/newmailaccount/test-newmailaccount.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/notification/test-notification.js">mail/test/mozmill/notification/test-notification.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/notification/test-notification.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/notification/test-notification.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/notification/test-notification.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/notification/test-notification.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/notification/test-notification.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/override-main-menu-collapse/test-override-mainmenu-collapse.js">mail/test/mozmill/override-main-menu-collapse/test-override-mainmenu-collapse.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/override-main-menu-collapse/test-override-mainmenu-collapse.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/override-main-menu-collapse/test-override-mainmenu-collapse.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/override-main-menu-collapse/test-override-mainmenu-collapse.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/override-main-menu-collapse/test-override-mainmenu-collapse.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/override-main-menu-collapse/test-override-mainmenu-collapse.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/pref-window/test-attachments-pane.js">mail/test/mozmill/pref-window/test-attachments-pane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/pref-window/test-attachments-pane.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/pref-window/test-attachments-pane.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/pref-window/test-attachments-pane.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/pref-window/test-attachments-pane.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/pref-window/test-attachments-pane.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/pref-window/test-font-chooser.js">mail/test/mozmill/pref-window/test-font-chooser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/pref-window/test-font-chooser.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/pref-window/test-font-chooser.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/pref-window/test-font-chooser.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/pref-window/test-font-chooser.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/pref-window/test-font-chooser.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-display-issues.js">mail/test/mozmill/quick-filter-bar/test-display-issues.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-display-issues.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-display-issues.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-display-issues.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-display-issues.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-display-issues.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-filter-logic.js">mail/test/mozmill/quick-filter-bar/test-filter-logic.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-filter-logic.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-filter-logic.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-filter-logic.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-filter-logic.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-filter-logic.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js">mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js">mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-toggle-bar.js">mail/test/mozmill/quick-filter-bar/test-toggle-bar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-toggle-bar.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-toggle-bar.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-toggle-bar.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-toggle-bar.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/quick-filter-bar/test-toggle-bar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-multiple-search-windows.js">mail/test/mozmill/search-window/test-multiple-search-windows.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-multiple-search-windows.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-multiple-search-windows.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-multiple-search-windows.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-multiple-search-windows.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-multiple-search-windows.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-right-click-to-open-search-window.js">mail/test/mozmill/search-window/test-right-click-to-open-search-window.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-right-click-to-open-search-window.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-right-click-to-open-search-window.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-right-click-to-open-search-window.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-right-click-to-open-search-window.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-right-click-to-open-search-window.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-search-window.js">mail/test/mozmill/search-window/test-search-window.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-search-window.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-search-window.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-search-window.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-search-window.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/search-window/test-search-window.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/session-store/test-session-store.js">mail/test/mozmill/session-store/test-session-store.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/session-store/test-session-store.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/session-store/test-session-store.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/session-store/test-session-store.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/session-store/test-session-store.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/session-store/test-session-store.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">mail/test/mozmill/shared-modules/test-account-manager-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-account-manager-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-address-book-helpers.js">mail/test/mozmill/shared-modules/test-address-book-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-address-book-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-address-book-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-address-book-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-address-book-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-address-book-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-attachment-helpers.js">mail/test/mozmill/shared-modules/test-attachment-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-attachment-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-attachment-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-attachment-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-attachment-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-attachment-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-compose-helpers.js">mail/test/mozmill/shared-modules/test-compose-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-compose-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-compose-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-compose-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-compose-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-compose-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">mail/test/mozmill/shared-modules/test-content-tab-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-content-tab-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-customization-helpers.js">mail/test/mozmill/shared-modules/test-customization-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-customization-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-customization-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-customization-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-customization-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-customization-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-dom-helpers.js">mail/test/mozmill/shared-modules/test-dom-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-dom-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-dom-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-dom-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-dom-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-dom-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-junk-helpers.js">mail/test/mozmill/shared-modules/test-junk-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-junk-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-junk-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-junk-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-junk-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-junk-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-keyboard-helpers.js">mail/test/mozmill/shared-modules/test-keyboard-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-keyboard-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-keyboard-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-keyboard-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-keyboard-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-keyboard-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-message-helpers.js">mail/test/mozmill/shared-modules/test-message-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-message-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-message-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-message-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-message-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-message-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-mock-object-helpers.js">mail/test/mozmill/shared-modules/test-mock-object-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-mock-object-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-mock-object-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-mock-object-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-mock-object-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-mock-object-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-mouse-event-helpers.js">mail/test/mozmill/shared-modules/test-mouse-event-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-mouse-event-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-mouse-event-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-mouse-event-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-mouse-event-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-mouse-event-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-nntp-helpers.js">mail/test/mozmill/shared-modules/test-nntp-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-nntp-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-nntp-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-nntp-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-nntp-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-nntp-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-notificationbox-helpers.js">mail/test/mozmill/shared-modules/test-notificationbox-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-notificationbox-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-notificationbox-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-notificationbox-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-notificationbox-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-notificationbox-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-observer-helpers.js">mail/test/mozmill/shared-modules/test-observer-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-observer-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-observer-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-observer-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-observer-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-observer-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">mail/test/mozmill/shared-modules/test-pref-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-pref-window-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-prompt-helpers.js">mail/test/mozmill/shared-modules/test-prompt-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-prompt-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-prompt-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-prompt-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-prompt-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-prompt-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-quick-filter-bar-helper.js">mail/test/mozmill/shared-modules/test-quick-filter-bar-helper.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-quick-filter-bar-helper.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-quick-filter-bar-helper.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-quick-filter-bar-helper.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-quick-filter-bar-helpers.js">mail/test/mozmill/shared-modules/test-quick-filter-bar-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-quick-filter-bar-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-quick-filter-bar-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-quick-filter-bar-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-quick-filter-bar-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-quick-filter-bar-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-search-window-helpers.js">mail/test/mozmill/shared-modules/test-search-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-search-window-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-search-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-search-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-search-window-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-search-window-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-subscribe-window-helper.js">mail/test/mozmill/shared-modules/test-subscribe-window-helper.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-subscribe-window-helper.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-subscribe-window-helper.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-subscribe-window-helper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-subscribe-window-helpers.js">mail/test/mozmill/shared-modules/test-subscribe-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-subscribe-window-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-subscribe-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-subscribe-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-subscribe-window-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-subscribe-window-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-window-helpers.js">mail/test/mozmill/shared-modules/test-window-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-window-helpers.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-window-helpers.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-window-helpers.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-window-helpers.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/shared-modules/test-window-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/startup-firstrun/test-menubar-collapsed.js">mail/test/mozmill/startup-firstrun/test-menubar-collapsed.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/startup-firstrun/test-menubar-collapsed.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/startup-firstrun/test-menubar-collapsed.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/startup-firstrun/test-menubar-collapsed.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/startup-firstrun/test-menubar-collapsed.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/startup-firstrun/test-menubar-collapsed.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/subscribe/test-subscribe-news-filter.js">mail/test/mozmill/subscribe/test-subscribe-news-filter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/subscribe/test-subscribe-news-filter.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/subscribe/test-subscribe-news-filter.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/subscribe/test-subscribe-news-filter.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/subscribe/test-subscribe-news-filter.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/subscribe/test-subscribe-news-filter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-closing.js">mail/test/mozmill/tabmail/test-tabmail-closing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-closing.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-closing.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-closing.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-closing.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-closing.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-customize.js">mail/test/mozmill/tabmail/test-tabmail-customize.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-customize.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-customize.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-customize.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-customize.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-customize.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">mail/test/mozmill/tabmail/test-tabmail-dragndrop.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/html/collections.html">mail/test/mozmill/utils/html/collections.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/html/collections.html">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/html/collections.html">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/html/collections.html">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/html/collections.html">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/html/collections.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/test-extensionSupport.js">mail/test/mozmill/utils/test-extensionSupport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/test-extensionSupport.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/test-extensionSupport.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/test-extensionSupport.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/test-extensionSupport.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/test-extensionSupport.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/test-iteratorUtils.js">mail/test/mozmill/utils/test-iteratorUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/test-iteratorUtils.js">file</a> |
<a href="/comm-central/annotate/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/test-iteratorUtils.js">annotate</a> |
<a href="/comm-central/diff/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/test-iteratorUtils.js">diff</a> |
<a href="/comm-central/comparison/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/test-iteratorUtils.js">comparison</a> |
<a href="/comm-central/log/0ff27072766a335dc5aa53b746e168845fbf5089/mail/test/mozmill/utils/test-iteratorUtils.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -73,17 +73,16 @@ mail/base/content/protovis-r2.6-modded.j</span>
<a href="#l1.4"></a><span id="l1.4"> mail/branding/nightly/thunderbird-branding.js</span>
<a href="#l1.5"></a><span id="l1.5"> mail/branding/thunderbird/thunderbird-branding.js</span>
<a href="#l1.6"></a><span id="l1.6"> # This file is split into two in order to keep it as a valid json file</span>
<a href="#l1.7"></a><span id="l1.7"> # for documentation purposes (policies.json) but to be accessed by the</span>
<a href="#l1.8"></a><span id="l1.8"> # code as a .jsm (schema.jsm)</span>
<a href="#l1.9"></a><span id="l1.9"> mail/components/enterprisepolicies/schemas/schema.jsm</span>
<a href="#l1.10"></a><span id="l1.10"> mail/components/im/all-im.js</span>
<a href="#l1.11"></a><span id="l1.11"> mail/locales/en-US/all-l10n.js</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mail/test/mozmill/**</span>
<a href="#l1.13"></a><span id="l1.13"> </span>
<a href="#l1.14"></a><span id="l1.14"> # calendar/ exclusions</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16"> # prefs files</span>
<a href="#l1.17"></a><span id="l1.17"> calendar/lightning/content/lightning.js</span>
<a href="#l1.18"></a><span id="l1.18"> calendar/providers/gdata/defaults/preferences.js</span>
<a href="#l1.19"></a><span id="l1.19"> calendar/timezones/preferences.js</span>
<a href="#l1.20"></a><span id="l1.20"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mail/test/mozmill/.eslintrc.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,13 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+module.exports = {</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+  globals: {</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+    __file__: true,</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+    collector: true,</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+    elementslib: true,</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+    mozmill: true,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  },</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+  rules: {</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    &quot;func-names&quot;: &quot;off&quot;,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+  },</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/account/test-ab-whitelist.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-ab-whitelist.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,19 +1,27 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8"> &quot;use strict&quot;;</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+/* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-keyboard-helpers.js */</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+</span>
<a href="#l3.15"></a><span id="l3.15"> var MODULE_NAME = &quot;test-ab-whitelist&quot;;</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-</span>
<a href="#l3.17"></a><span id="l3.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-                       &quot;account-manager-helpers&quot;, &quot;keyboard-helpers&quot; ];</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+  &quot;account-manager-helpers&quot;,</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  &quot;keyboard-helpers&quot;,</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+];</span>
<a href="#l3.26"></a><span id="l3.26"> </span>
<a href="#l3.27"></a><span id="l3.27"> var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.jsm&quot;);</span>
<a href="#l3.28"></a><span id="l3.28"> var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l3.29"></a><span id="l3.29"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31"> var gOldWhiteList = null;</span>
<a href="#l3.32"></a><span id="l3.32"> var gKeyString = null;</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34" class="difflineat">@@ -108,17 +116,17 @@ function subtest_check_whitelist_load_cl</span>
<a href="#l3.35"></a><span id="l3.35">   let whiteListURIs = &quot;&quot;;</span>
<a href="#l3.36"></a><span id="l3.36"> </span>
<a href="#l3.37"></a><span id="l3.37">   try {</span>
<a href="#l3.38"></a><span id="l3.38">     whiteListURIs = Services.prefs.getCharPref(gKeyString);</span>
<a href="#l3.39"></a><span id="l3.39">     // We should have failed here, because the pref should have been cleared</span>
<a href="#l3.40"></a><span id="l3.40">     // out.</span>
<a href="#l3.41"></a><span id="l3.41">     throw Error(&quot;The whitelist preference for this server wasn't properly &quot;</span>
<a href="#l3.42"></a><span id="l3.42">                 + &quot;cleared.&quot;);</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-  } catch(e) {</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  } catch (e) {</span>
<a href="#l3.45"></a><span id="l3.45">   }</span>
<a href="#l3.46"></a><span id="l3.46"> </span>
<a href="#l3.47"></a><span id="l3.47">   for (let i = 0; i &lt; list.getRowCount(); i++) {</span>
<a href="#l3.48"></a><span id="l3.48">     let abNode = list.getItemAtIndex(i);</span>
<a href="#l3.49"></a><span id="l3.49">     assert_equals(&quot;false&quot;, abNode.firstChild.getAttribute(&quot;checked&quot;),</span>
<a href="#l3.50"></a><span id="l3.50">                   &quot;Should not have been checked&quot;);</span>
<a href="#l3.51"></a><span id="l3.51">     // Also ensure that the address book URI was properly cleared in the</span>
<a href="#l3.52"></a><span id="l3.52">     // prefs</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/account/test-account-actions.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-account-actions.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -1,19 +1,21 @@</span>
<a href="#l4.4"></a><span id="l4.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.5"></a><span id="l4.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l4.6"></a><span id="l4.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.7"></a><span id="l4.7"> </span>
<a href="#l4.8"></a><span id="l4.8"> &quot;use strict&quot;;</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+/* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+</span>
<a href="#l4.14"></a><span id="l4.14"> var MODULE_NAME = &quot;test-account-actions&quot;;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineminus">-</span>
<a href="#l4.16"></a><span id="l4.16"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineminus">-                         &quot;account-manager-helpers&quot;];</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;account-manager-helpers&quot;];</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21"> var imapAccount, nntpAccount, originalAccountCount;</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23"> function setupModule(module) {</span>
<a href="#l4.24"></a><span id="l4.24">   collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l4.25"></a><span id="l4.25">   collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l4.26"></a><span id="l4.26">   collector.getModule(&quot;account-manager-helpers&quot;).installInto(module);</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28" class="difflineat">@@ -64,18 +66,17 @@ function teardownModule(module) {</span>
<a href="#l4.29"></a><span id="l4.29">  * @param amc          the account options controller</span>
<a href="#l4.30"></a><span id="l4.30">  * @param aAccountKey  the key of the account to select</span>
<a href="#l4.31"></a><span id="l4.31">  * @param aIsSetAsDefaultEnabled  true if the menuitem should be enabled, false otherwise</span>
<a href="#l4.32"></a><span id="l4.32">  * @param aIsRemoveEnabled        true if the menuitem should be enabled, false otherwise</span>
<a href="#l4.33"></a><span id="l4.33">  * @param aIsAddAccountEnabled    true if the menuitems (Add Mail Account+Add Other Account)</span>
<a href="#l4.34"></a><span id="l4.34">  *                                should be enabled, false otherwise</span>
<a href="#l4.35"></a><span id="l4.35">  */</span>
<a href="#l4.36"></a><span id="l4.36"> function subtest_check_account_actions(amc, aAccountKey, aIsSetAsDefaultEnabled,</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-                                       aIsRemoveEnabled, aIsAddAccountEnabled)</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineminus">-{</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+                                       aIsRemoveEnabled, aIsAddAccountEnabled) {</span>
<a href="#l4.40"></a><span id="l4.40">   let accountRow = get_account_tree_row(aAccountKey, null, amc);</span>
<a href="#l4.41"></a><span id="l4.41">   click_account_tree_row(amc, accountRow);</span>
<a href="#l4.42"></a><span id="l4.42"> </span>
<a href="#l4.43"></a><span id="l4.43">   // click the Actions Button to bring up the popup with menuitems to test</span>
<a href="#l4.44"></a><span id="l4.44">   amc.click(amc.eid(&quot;accountActionsButton&quot;), 5, 5);</span>
<a href="#l4.45"></a><span id="l4.45">   wait_for_popup_to_open(amc.e(&quot;accountActionsDropdown&quot;));</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47">   let actionAddMailAccount = amc.e(&quot;accountActionsAddMailAccount&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/test/mozmill/account/test-account-deletion.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-account-deletion.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -3,21 +3,23 @@</span>
<a href="#l5.4"></a><span id="l5.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> /**</span>
<a href="#l5.7"></a><span id="l5.7">  * This test checks proper deletion of an account from the Account manager.</span>
<a href="#l5.8"></a><span id="l5.8">  */</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10"> &quot;use strict&quot;;</span>
<a href="#l5.11"></a><span id="l5.11"> </span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+</span>
<a href="#l5.16"></a><span id="l5.16"> var MODULE_NAME = &quot;test-account-deletion&quot;;</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-</span>
<a href="#l5.18"></a><span id="l5.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-                       &quot;account-manager-helpers&quot;];</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;account-manager-helpers&quot;];</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23"> var gPopAccount, gImapAccount, gNntpAccount, gOriginalAccountCount;</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25"> function setupModule(module) {</span>
<a href="#l5.26"></a><span id="l5.26">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l5.27"></a><span id="l5.27">     collector.getModule(lib).installInto(module);</span>
<a href="#l5.28"></a><span id="l5.28">   }</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30" class="difflineat">@@ -67,18 +69,17 @@ function test_account_data_deletion() {</span>
<a href="#l5.31"></a><span id="l5.31"> }</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33"> /**</span>
<a href="#l5.34"></a><span id="l5.34">  * Bug 274452</span>
<a href="#l5.35"></a><span id="l5.35">  * Check if files of an account are preserved.</span>
<a href="#l5.36"></a><span id="l5.36">  *</span>
<a href="#l5.37"></a><span id="l5.37">  * @param amc  The account options controller.</span>
<a href="#l5.38"></a><span id="l5.38">  */</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-function subtest_account_data_deletion1(amc)</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineminus">-{</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+function subtest_account_data_deletion1(amc) {</span>
<a href="#l5.42"></a><span id="l5.42">   let accountDir = gPopAccount.incomingServer.localPath;</span>
<a href="#l5.43"></a><span id="l5.43">   assert_true(accountDir.isDirectory());</span>
<a href="#l5.44"></a><span id="l5.44"> </span>
<a href="#l5.45"></a><span id="l5.45">   // Get some existing file in the POP3 account data dir.</span>
<a href="#l5.46"></a><span id="l5.46">   let inboxFile = accountDir.clone();</span>
<a href="#l5.47"></a><span id="l5.47">   inboxFile.append(&quot;Inbox.msf&quot;);</span>
<a href="#l5.48"></a><span id="l5.48">   assert_true(inboxFile.isFile());</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50" class="difflineat">@@ -87,18 +88,17 @@ function subtest_account_data_deletion1(</span>
<a href="#l5.51"></a><span id="l5.51"> }</span>
<a href="#l5.52"></a><span id="l5.52"> </span>
<a href="#l5.53"></a><span id="l5.53"> /**</span>
<a href="#l5.54"></a><span id="l5.54">  * Bug 274452</span>
<a href="#l5.55"></a><span id="l5.55">  * Check if files of an account can be deleted.</span>
<a href="#l5.56"></a><span id="l5.56">  *</span>
<a href="#l5.57"></a><span id="l5.57">  * @param amc  The account options controller.</span>
<a href="#l5.58"></a><span id="l5.58">  */</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-function subtest_account_data_deletion2(amc)</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-{</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+function subtest_account_data_deletion2(amc) {</span>
<a href="#l5.62"></a><span id="l5.62">   let accountDir = gImapAccount.incomingServer.localPath;</span>
<a href="#l5.63"></a><span id="l5.63">   assert_true(accountDir.isDirectory());</span>
<a href="#l5.64"></a><span id="l5.64"> </span>
<a href="#l5.65"></a><span id="l5.65">   // Get some file in the IMAP account data dir.</span>
<a href="#l5.66"></a><span id="l5.66">   let inboxFile = accountDir.clone();</span>
<a href="#l5.67"></a><span id="l5.67">   inboxFile.append(&quot;INBOX.msf&quot;);</span>
<a href="#l5.68"></a><span id="l5.68">   assert_true(inboxFile.isFile());</span>
<a href="#l5.69"></a><span id="l5.69"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/test/mozmill/account/test-account-port-setting.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-account-port-setting.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1,28 +1,36 @@</span>
<a href="#l6.4"></a><span id="l6.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.5"></a><span id="l6.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.6"></a><span id="l6.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8"> &quot;use strict&quot;;</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10" class="difflineplus">+/* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-keyboard-helpers.js */</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+</span>
<a href="#l6.15"></a><span id="l6.15"> var MODULE_NAME = &quot;test-account-port-setting&quot;;</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-</span>
<a href="#l6.17"></a><span id="l6.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l6.19"></a><span id="l6.19" class="difflineminus">-                       &quot;account-manager-helpers&quot;, &quot;keyboard-helpers&quot; ];</span>
<a href="#l6.20"></a><span id="l6.20" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+  &quot;account-manager-helpers&quot;,</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineplus">+  &quot;keyboard-helpers&quot;,</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+];</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l6.28"></a><span id="l6.28"> </span>
<a href="#l6.29"></a><span id="l6.29"> var PORT_NUMBERS_TO_TEST =</span>
<a href="#l6.30"></a><span id="l6.30">   [</span>
<a href="#l6.31"></a><span id="l6.31">     &quot;110&quot;, // The original port number. We don't input this though.</span>
<a href="#l6.32"></a><span id="l6.32">     &quot;456&quot;, // Random port number.</span>
<a href="#l6.33"></a><span id="l6.33">     &quot;995&quot;, // The SSL port number.</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-    &quot;110&quot;  // Back to the original.</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+    &quot;110&quot;, // Back to the original.</span>
<a href="#l6.36"></a><span id="l6.36">   ];</span>
<a href="#l6.37"></a><span id="l6.37"> </span>
<a href="#l6.38"></a><span id="l6.38"> var gTestNumber;</span>
<a href="#l6.39"></a><span id="l6.39"> </span>
<a href="#l6.40"></a><span id="l6.40"> function subtest_check_set_port_number(amc, aDontSet) {</span>
<a href="#l6.41"></a><span id="l6.41">   // This test expects the following POP account to exist by default</span>
<a href="#l6.42"></a><span id="l6.42">   // with port number 110 and no security.</span>
<a href="#l6.43"></a><span id="l6.43">   let server = MailServices.accounts</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/test/mozmill/account/test-account-settings-infrastructure.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-account-settings-infrastructure.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -7,21 +7,23 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * in the Account manager. E.g. if the values of elements are properly stored when</span>
<a href="#l7.5"></a><span id="l7.5">  * panes are switched.</span>
<a href="#l7.6"></a><span id="l7.6">  *</span>
<a href="#l7.7"></a><span id="l7.7">  * New checks can be added to it as needed.</span>
<a href="#l7.8"></a><span id="l7.8">  */</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> &quot;use strict&quot;;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+</span>
<a href="#l7.16"></a><span id="l7.16"> var MODULE_NAME = &quot;test-account-settings-infrastructure&quot;;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-</span>
<a href="#l7.18"></a><span id="l7.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-                         &quot;account-manager-helpers&quot;];</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;account-manager-helpers&quot;];</span>
<a href="#l7.22"></a><span id="l7.22"> </span>
<a href="#l7.23"></a><span id="l7.23"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l7.24"></a><span id="l7.24"> </span>
<a href="#l7.25"></a><span id="l7.25"> var gPopAccount, gImapAccount, gOriginalAccountCount;</span>
<a href="#l7.26"></a><span id="l7.26"> </span>
<a href="#l7.27"></a><span id="l7.27"> function setupModule(module) {</span>
<a href="#l7.28"></a><span id="l7.28">   collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l7.29"></a><span id="l7.29">   collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineat">@@ -80,18 +82,17 @@ function test_account_dot_IDs() {</span>
<a href="#l7.31"></a><span id="l7.31"> </span>
<a href="#l7.32"></a><span id="l7.32"> /**</span>
<a href="#l7.33"></a><span id="l7.33">  * Check that the options in the server pane are stored even if the id</span>
<a href="#l7.34"></a><span id="l7.34">  * of the element contains multiple dots (not used in standard TB yet</span>
<a href="#l7.35"></a><span id="l7.35">  * but extensions may want it).</span>
<a href="#l7.36"></a><span id="l7.36">  *</span>
<a href="#l7.37"></a><span id="l7.37">  * @param amc  the account options controller</span>
<a href="#l7.38"></a><span id="l7.38">  */</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineminus">-function subtest_check_account_dot_IDs(amc)</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineminus">-{</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+function subtest_check_account_dot_IDs(amc) {</span>
<a href="#l7.42"></a><span id="l7.42">   let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l7.43"></a><span id="l7.43">   click_account_tree_row(amc, accountRow);</span>
<a href="#l7.44"></a><span id="l7.44"> </span>
<a href="#l7.45"></a><span id="l7.45">   let iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l7.46"></a><span id="l7.46">   // Check whether a standard element with &quot;server.loginAtStartUp&quot; stores its</span>
<a href="#l7.47"></a><span id="l7.47">   // value properly.</span>
<a href="#l7.48"></a><span id="l7.48">   let loginCheck = iframe.getElementById(&quot;server.loginAtStartUp&quot;);</span>
<a href="#l7.49"></a><span id="l7.49">   assert_false(loginCheck.checked);</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineat">@@ -161,18 +162,17 @@ function test_account_locked_prefs() {</span>
<a href="#l7.51"></a><span id="l7.51"> }</span>
<a href="#l7.52"></a><span id="l7.52"> </span>
<a href="#l7.53"></a><span id="l7.53"> /**</span>
<a href="#l7.54"></a><span id="l7.54">  * Check that the LDAP server selection elements (radio group) are properly</span>
<a href="#l7.55"></a><span id="l7.55">  * disabled when their attached pref (prefstring attribute) is locked.</span>
<a href="#l7.56"></a><span id="l7.56">  *</span>
<a href="#l7.57"></a><span id="l7.57">  * @param amc  the account options controller</span>
<a href="#l7.58"></a><span id="l7.58">  */</span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-function subtest_check_locked_prefs_addressing(amc)</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineminus">-{</span>
<a href="#l7.61"></a><span id="l7.61" class="difflineplus">+function subtest_check_locked_prefs_addressing(amc) {</span>
<a href="#l7.62"></a><span id="l7.62">   let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-addressing.xul&quot;, amc);</span>
<a href="#l7.63"></a><span id="l7.63">   click_account_tree_row(amc, accountRow);</span>
<a href="#l7.64"></a><span id="l7.64"> </span>
<a href="#l7.65"></a><span id="l7.65">   let iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l7.66"></a><span id="l7.66"> </span>
<a href="#l7.67"></a><span id="l7.67">   // By default, 'use global LDAP server preferences' is set, not the</span>
<a href="#l7.68"></a><span id="l7.68">   // 'different LDAP server'.</span>
<a href="#l7.69"></a><span id="l7.69">   let useLDAPdirectory = iframe.getElementById(&quot;directories&quot;);</span>
<a href="#l7.70"></a><span id="l7.70" class="difflineat">@@ -229,18 +229,17 @@ function subtest_check_locked_prefs_addr</span>
<a href="#l7.71"></a><span id="l7.71"> </span>
<a href="#l7.72"></a><span id="l7.72"> /**</span>
<a href="#l7.73"></a><span id="l7.73">  * Check that the POP3 'keep on server' settings elements (2-level</span>
<a href="#l7.74"></a><span id="l7.74">  * checkboxes + textbox) are properly disabled when their attached pref</span>
<a href="#l7.75"></a><span id="l7.75">  * (prefstring attribute) is locked.</span>
<a href="#l7.76"></a><span id="l7.76">  *</span>
<a href="#l7.77"></a><span id="l7.77">  * @param amc  the account options controller</span>
<a href="#l7.78"></a><span id="l7.78">  */</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-function subtest_check_locked_prefs_server(amc)</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineminus">-{</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+function subtest_check_locked_prefs_server(amc) {</span>
<a href="#l7.82"></a><span id="l7.82">   let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l7.83"></a><span id="l7.83">   click_account_tree_row(amc, accountRow);</span>
<a href="#l7.84"></a><span id="l7.84"> </span>
<a href="#l7.85"></a><span id="l7.85">   let iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l7.86"></a><span id="l7.86"> </span>
<a href="#l7.87"></a><span id="l7.87">   // Top level leaveOnServer checkbox, disabled by default.</span>
<a href="#l7.88"></a><span id="l7.88">   let leaveOnServer = iframe.getElementById(&quot;pop3.leaveMessagesOnServer&quot;);</span>
<a href="#l7.89"></a><span id="l7.89">   assert_false(leaveOnServer.disabled);</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineat">@@ -322,18 +321,17 @@ function test_replyTo_leak() {</span>
<a href="#l7.91"></a><span id="l7.91">   open_advanced_settings(function(amc) {</span>
<a href="#l7.92"></a><span id="l7.92">     subtest_check_replyTo_leak(amc);</span>
<a href="#l7.93"></a><span id="l7.93">   });</span>
<a href="#l7.94"></a><span id="l7.94"> }</span>
<a href="#l7.95"></a><span id="l7.95"> </span>
<a href="#l7.96"></a><span id="l7.96"> /**</span>
<a href="#l7.97"></a><span id="l7.97">  * @param amc  the account options controller</span>
<a href="#l7.98"></a><span id="l7.98">  */</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineminus">-function subtest_check_replyTo_leak(amc)</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineminus">-{</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+function subtest_check_replyTo_leak(amc) {</span>
<a href="#l7.102"></a><span id="l7.102">   let accountRow = get_account_tree_row(gPopAccount.key, null, amc);</span>
<a href="#l7.103"></a><span id="l7.103">   click_account_tree_row(amc, accountRow);</span>
<a href="#l7.104"></a><span id="l7.104"> </span>
<a href="#l7.105"></a><span id="l7.105">   let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l7.106"></a><span id="l7.106"> </span>
<a href="#l7.107"></a><span id="l7.107">   // The Reply-To field should be empty.</span>
<a href="#l7.108"></a><span id="l7.108">   let replyAddress = iframe.contentDocument.getElementById(&quot;identity.replyTo&quot;);</span>
<a href="#l7.109"></a><span id="l7.109">   assert_equals(replyAddress.value, &quot;&quot;);</span>
<a href="#l7.110"></a><span id="l7.110" class="difflineat">@@ -365,18 +363,17 @@ function test_account_onchange_handler()</span>
<a href="#l7.111"></a><span id="l7.111">   });</span>
<a href="#l7.112"></a><span id="l7.112"> }</span>
<a href="#l7.113"></a><span id="l7.113"> </span>
<a href="#l7.114"></a><span id="l7.114"> /**</span>
<a href="#l7.115"></a><span id="l7.115">  * Check if onchange handlers are properly executed when panes are switched.</span>
<a href="#l7.116"></a><span id="l7.116">  *</span>
<a href="#l7.117"></a><span id="l7.117">  * @param amc  the account options controller</span>
<a href="#l7.118"></a><span id="l7.118">  */</span>
<a href="#l7.119"></a><span id="l7.119" class="difflineminus">-function subtest_check_onchange_handler(amc)</span>
<a href="#l7.120"></a><span id="l7.120" class="difflineminus">-{</span>
<a href="#l7.121"></a><span id="l7.121" class="difflineplus">+function subtest_check_onchange_handler(amc) {</span>
<a href="#l7.122"></a><span id="l7.122">   let accountRow = get_account_tree_row(gImapAccount.key, &quot;am-offline.xul&quot;, amc);</span>
<a href="#l7.123"></a><span id="l7.123">   click_account_tree_row(amc, accountRow);</span>
<a href="#l7.124"></a><span id="l7.124"> </span>
<a href="#l7.125"></a><span id="l7.125">   let iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l7.126"></a><span id="l7.126"> </span>
<a href="#l7.127"></a><span id="l7.127">   let autoSync = iframe.getElementById(&quot;autosyncValue&quot;);</span>
<a href="#l7.128"></a><span id="l7.128">   // 30 is the default value so check if we are in clean state.</span>
<a href="#l7.129"></a><span id="l7.129">   assert_equals(autoSync.value, 30);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/test/mozmill/account/test-account-tree.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-account-tree.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -3,21 +3,23 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.5"></a><span id="l8.5"> </span>
<a href="#l8.6"></a><span id="l8.6"> /**</span>
<a href="#l8.7"></a><span id="l8.7">  * This test checks proper operation of the account tree in the Account manager.</span>
<a href="#l8.8"></a><span id="l8.8">  */</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> &quot;use strict&quot;;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+</span>
<a href="#l8.16"></a><span id="l8.16"> var MODULE_NAME = &quot;test-account-tree&quot;;</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-</span>
<a href="#l8.18"></a><span id="l8.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineminus">-                         &quot;account-manager-helpers&quot;];</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;account-manager-helpers&quot;];</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23"> var gPopAccount, gOriginalAccountCount;</span>
<a href="#l8.24"></a><span id="l8.24"> </span>
<a href="#l8.25"></a><span id="l8.25"> function setupModule(module) {</span>
<a href="#l8.26"></a><span id="l8.26">   collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l8.27"></a><span id="l8.27">   collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l8.28"></a><span id="l8.28">   collector.getModule(&quot;account-manager-helpers&quot;).installInto(module);</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30" class="difflineat">@@ -62,18 +64,17 @@ function test_account_open_state() {</span>
<a href="#l8.31"></a><span id="l8.31"> }</span>
<a href="#l8.32"></a><span id="l8.32"> </span>
<a href="#l8.33"></a><span id="l8.33"> /**</span>
<a href="#l8.34"></a><span id="l8.34">  * Check if the open state of accounts is in the wished state.</span>
<a href="#l8.35"></a><span id="l8.35">  *</span>
<a href="#l8.36"></a><span id="l8.36">  * @param amc           The account options controller.</span>
<a href="#l8.37"></a><span id="l8.37">  * @param aWishedState  The open state in which the account row should be found (bool).</span>
<a href="#l8.38"></a><span id="l8.38">  */</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineminus">-function subtest_check_account_open_state(amc, aWishedState)</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineminus">-{</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+function subtest_check_account_open_state(amc, aWishedState) {</span>
<a href="#l8.42"></a><span id="l8.42">   let accountRow = get_account_tree_row(gPopAccount.key, null, amc);</span>
<a href="#l8.43"></a><span id="l8.43">   click_account_tree_row(amc, accountRow);</span>
<a href="#l8.44"></a><span id="l8.44"> </span>
<a href="#l8.45"></a><span id="l8.45">   // See if the account row is in the wished open state.</span>
<a href="#l8.46"></a><span id="l8.46">   let accountTree = amc.e(&quot;accounttree&quot;);</span>
<a href="#l8.47"></a><span id="l8.47">   assert_equals(accountRow, accountTree.view.selection.currentIndex);</span>
<a href="#l8.48"></a><span id="l8.48">   assert_equals(accountTree.view.isContainerOpen(accountRow), aWishedState);</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50" class="difflineat">@@ -101,18 +102,17 @@ function test_default_account_highlight(</span>
<a href="#l8.51"></a><span id="l8.51">   });</span>
<a href="#l8.52"></a><span id="l8.52"> }</span>
<a href="#l8.53"></a><span id="l8.53"> </span>
<a href="#l8.54"></a><span id="l8.54"> /**</span>
<a href="#l8.55"></a><span id="l8.55">  * Check if the default account is styled in bold and another account is not.</span>
<a href="#l8.56"></a><span id="l8.56">  *</span>
<a href="#l8.57"></a><span id="l8.57">  * @param amc           The account options controller.</span>
<a href="#l8.58"></a><span id="l8.58">  */</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-function subtest_check_default_account_highlight(amc)</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineminus">-{</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+function subtest_check_default_account_highlight(amc) {</span>
<a href="#l8.62"></a><span id="l8.62">   // Select the default account.</span>
<a href="#l8.63"></a><span id="l8.63">   let accountRow = get_account_tree_row(MailServices.accounts.defaultAccount.key, null, amc);</span>
<a href="#l8.64"></a><span id="l8.64">   click_account_tree_row(amc, accountRow);</span>
<a href="#l8.65"></a><span id="l8.65"> </span>
<a href="#l8.66"></a><span id="l8.66">   let accountTree = amc.e(&quot;accounttree&quot;);</span>
<a href="#l8.67"></a><span id="l8.67">   assert_equals(accountRow, accountTree.view.selection.currentIndex);</span>
<a href="#l8.68"></a><span id="l8.68">   let cell = accountTree.view.getItemAtIndex(accountRow).firstChild.firstChild;</span>
<a href="#l8.69"></a><span id="l8.69">   assert_equals(cell.tagName, &quot;treecell&quot;);</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineat">@@ -146,18 +146,17 @@ function test_selection_after_account_de</span>
<a href="#l8.71"></a><span id="l8.71">   });</span>
<a href="#l8.72"></a><span id="l8.72"> }</span>
<a href="#l8.73"></a><span id="l8.73"> </span>
<a href="#l8.74"></a><span id="l8.74"> /**</span>
<a href="#l8.75"></a><span id="l8.75">  * Check if after deleting an account the next one is selected.</span>
<a href="#l8.76"></a><span id="l8.76">  *</span>
<a href="#l8.77"></a><span id="l8.77">  * @param amc           The account options controller.</span>
<a href="#l8.78"></a><span id="l8.78">  */</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineminus">-function subtest_check_selection_after_account_deletion(amc)</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-{</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+function subtest_check_selection_after_account_deletion(amc) {</span>
<a href="#l8.82"></a><span id="l8.82">   let accountList = [];</span>
<a href="#l8.83"></a><span id="l8.83">   let accountTreeNode = amc.e(&quot;account-tree-children&quot;);</span>
<a href="#l8.84"></a><span id="l8.84">   // Build the list of accounts in the account tree (order is important).</span>
<a href="#l8.85"></a><span id="l8.85">   for (let i = 0; i &lt; accountTreeNode.childNodes.length; i++) {</span>
<a href="#l8.86"></a><span id="l8.86">     if (&quot;_account&quot; in accountTreeNode.childNodes[i]) {</span>
<a href="#l8.87"></a><span id="l8.87">       let curAccount = accountTreeNode.childNodes[i]._account;</span>
<a href="#l8.88"></a><span id="l8.88">       if (!accountList.includes(curAccount))</span>
<a href="#l8.89"></a><span id="l8.89">         accountList.push(curAccount);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/test/mozmill/account/test-account-values.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-account-values.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -4,21 +4,29 @@</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5"> /**</span>
<a href="#l9.6"></a><span id="l9.6">  * This test checks proper operation of the account settings panes</span>
<a href="#l9.7"></a><span id="l9.7">  * when certain special or invalid values are entered into the fields.</span>
<a href="#l9.8"></a><span id="l9.8">  */</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> &quot;use strict&quot;;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-keyboard-helpers.js */</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineplus">+</span>
<a href="#l9.17"></a><span id="l9.17"> var MODULE_NAME = &quot;test-account-values&quot;;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-</span>
<a href="#l9.19"></a><span id="l9.19"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-                       &quot;account-manager-helpers&quot;, &quot;keyboard-helpers&quot;];</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineplus">+  &quot;account-manager-helpers&quot;,</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineplus">+  &quot;keyboard-helpers&quot;,</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineplus">+];</span>
<a href="#l9.28"></a><span id="l9.28"> </span>
<a href="#l9.29"></a><span id="l9.29"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l9.30"></a><span id="l9.30"> </span>
<a href="#l9.31"></a><span id="l9.31"> var gPopAccount, gOriginalAccountCount;</span>
<a href="#l9.32"></a><span id="l9.32"> </span>
<a href="#l9.33"></a><span id="l9.33"> function setupModule(module) {</span>
<a href="#l9.34"></a><span id="l9.34">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l9.35"></a><span id="l9.35">     collector.getModule(lib).installInto(module);</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineat">@@ -62,18 +70,17 @@ function test_default_CC_address() {</span>
<a href="#l9.37"></a><span id="l9.37"> }</span>
<a href="#l9.38"></a><span id="l9.38"> </span>
<a href="#l9.39"></a><span id="l9.39"> /**</span>
<a href="#l9.40"></a><span id="l9.40">  * Check that if the CC field is empty, enabling CC will automatically</span>
<a href="#l9.41"></a><span id="l9.41">  * prefill the currently default email address.</span>
<a href="#l9.42"></a><span id="l9.42">  *</span>
<a href="#l9.43"></a><span id="l9.43">  * @param amc  the account options controller</span>
<a href="#l9.44"></a><span id="l9.44">  */</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineminus">-function subtest_check_default_CC_address(amc)</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-{</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+function subtest_check_default_CC_address(amc) {</span>
<a href="#l9.48"></a><span id="l9.48">   let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-copies.xul&quot;, amc);</span>
<a href="#l9.49"></a><span id="l9.49">   click_account_tree_row(amc, accountRow);</span>
<a href="#l9.50"></a><span id="l9.50"> </span>
<a href="#l9.51"></a><span id="l9.51">   let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l9.52"></a><span id="l9.52"> </span>
<a href="#l9.53"></a><span id="l9.53">   let defaultAddress = iframe.contentDocument.getElementById(&quot;identity.email&quot;).value;</span>
<a href="#l9.54"></a><span id="l9.54">   let ccCheck = iframe.contentDocument.getElementById(&quot;identity.doCc&quot;);</span>
<a href="#l9.55"></a><span id="l9.55">   let ccAddress = iframe.contentDocument.getElementById(&quot;identity.doCcList&quot;);</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineat">@@ -179,18 +186,17 @@ function test_account_name() {</span>
<a href="#l9.57"></a><span id="l9.57"> /**</span>
<a href="#l9.58"></a><span id="l9.58">  * Changes the user name and hostname to the supplied values.</span>
<a href="#l9.59"></a><span id="l9.59">  *</span>
<a href="#l9.60"></a><span id="l9.60">  * @param aAccount      the account to change</span>
<a href="#l9.61"></a><span id="l9.61">  * @param aNewHostname  the hostname value to set</span>
<a href="#l9.62"></a><span id="l9.62">  * @param aNewUsername  the username value to set</span>
<a href="#l9.63"></a><span id="l9.63">  * @param amc           the account options controller</span>
<a href="#l9.64"></a><span id="l9.64">  */</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineminus">-function subtest_check_account_name(aAccount, aNewHostname, aNewUsername, amc)</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineminus">-{</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+function subtest_check_account_name(aAccount, aNewHostname, aNewUsername, amc) {</span>
<a href="#l9.68"></a><span id="l9.68">   let accountRow = get_account_tree_row(aAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l9.69"></a><span id="l9.69">   click_account_tree_row(amc, accountRow);</span>
<a href="#l9.70"></a><span id="l9.70"> </span>
<a href="#l9.71"></a><span id="l9.71">   let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l9.72"></a><span id="l9.72"> </span>
<a href="#l9.73"></a><span id="l9.73">   if (aNewHostname) {</span>
<a href="#l9.74"></a><span id="l9.74">     let hostname = iframe.contentDocument.getElementById(&quot;server.realHostName&quot;);</span>
<a href="#l9.75"></a><span id="l9.75">     assert_equals(hostname.value, aAccount.incomingServer.realHostName);</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineat">@@ -231,36 +237,31 @@ function test_invalid_junk_target() {</span>
<a href="#l9.77"></a><span id="l9.77">   branch.setCharPref(&quot;spamActionTargetFolder&quot;, &quot;some random non-existent URI&quot;);</span>
<a href="#l9.78"></a><span id="l9.78">   let moveOnSpam = true;</span>
<a href="#l9.79"></a><span id="l9.79">   branch.setBoolPref(&quot;moveOnSpam&quot;, moveOnSpam);</span>
<a href="#l9.80"></a><span id="l9.80">   open_advanced_settings(function(amc) {</span>
<a href="#l9.81"></a><span id="l9.81">     subtest_check_invalid_junk_target(amc);</span>
<a href="#l9.82"></a><span id="l9.82">   });</span>
<a href="#l9.83"></a><span id="l9.83"> </span>
<a href="#l9.84"></a><span id="l9.84">   // The pref has no default so its non-existence means it was cleared.</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineminus">-  try {</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineminus">-    moveOnSpam = branch.getBoolPref(&quot;moveOnSpam&quot;);</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineminus">-  } catch (e) {</span>
<a href="#l9.88"></a><span id="l9.88" class="difflineminus">-    moveOnSpam = false;</span>
<a href="#l9.89"></a><span id="l9.89" class="difflineminus">-  }</span>
<a href="#l9.90"></a><span id="l9.90" class="difflineplus">+  moveOnSpam = branch.getBoolPref(&quot;moveOnSpam&quot;, false);</span>
<a href="#l9.91"></a><span id="l9.91">   assert_false(moveOnSpam);</span>
<a href="#l9.92"></a><span id="l9.92">   // The targets should point to the same pop account now.</span>
<a href="#l9.93"></a><span id="l9.93">   let targetAccount = branch.getCharPref(&quot;spamActionTargetAccount&quot;);</span>
<a href="#l9.94"></a><span id="l9.94">   assert_equals(targetAccount, gPopAccount.incomingServer.serverURI);</span>
<a href="#l9.95"></a><span id="l9.95">   let targetFolder = branch.getCharPref(&quot;spamActionTargetFolder&quot;);</span>
<a href="#l9.96"></a><span id="l9.96">   assert_equals(targetFolder, gPopAccount.incomingServer.serverURI + &quot;/Junk&quot;);</span>
<a href="#l9.97"></a><span id="l9.97"> }</span>
<a href="#l9.98"></a><span id="l9.98"> </span>
<a href="#l9.99"></a><span id="l9.99"> /**</span>
<a href="#l9.100"></a><span id="l9.100">  * Just show the Junk settings pane and let it fix the values.</span>
<a href="#l9.101"></a><span id="l9.101">  *</span>
<a href="#l9.102"></a><span id="l9.102">  * @param amc  the account options controller</span>
<a href="#l9.103"></a><span id="l9.103">  */</span>
<a href="#l9.104"></a><span id="l9.104" class="difflineminus">-function subtest_check_invalid_junk_target(amc)</span>
<a href="#l9.105"></a><span id="l9.105" class="difflineminus">-{</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+function subtest_check_invalid_junk_target(amc) {</span>
<a href="#l9.107"></a><span id="l9.107">   let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l9.108"></a><span id="l9.108">   click_account_tree_row(amc, accountRow);</span>
<a href="#l9.109"></a><span id="l9.109"> </span>
<a href="#l9.110"></a><span id="l9.110">   // We need to save the new fixed values so click OK on the Account settings.</span>
<a href="#l9.111"></a><span id="l9.111">   amc.window.document.documentElement.acceptDialog();</span>
<a href="#l9.112"></a><span id="l9.112"> }</span>
<a href="#l9.113"></a><span id="l9.113"> </span>
<a href="#l9.114"></a><span id="l9.114"> /**</span>
<a href="#l9.115"></a><span id="l9.115" class="difflineat">@@ -285,18 +286,17 @@ function test_invalid_hostname() {</span>
<a href="#l9.116"></a><span id="l9.116"> </span>
<a href="#l9.117"></a><span id="l9.117"> /**</span>
<a href="#l9.118"></a><span id="l9.118">  * Set the hostname to an invalid value and check if it gets fixed.</span>
<a href="#l9.119"></a><span id="l9.119">  *</span>
<a href="#l9.120"></a><span id="l9.120">  * @param amc                the account options controller</span>
<a href="#l9.121"></a><span id="l9.121">  * @param aExitSettings      Attempt to close the Account settings dialog.</span>
<a href="#l9.122"></a><span id="l9.122">  * @param aOriginalHostname  Original hostname of this server.</span>
<a href="#l9.123"></a><span id="l9.123">  */</span>
<a href="#l9.124"></a><span id="l9.124" class="difflineminus">-function subtest_check_invalid_hostname(amc, aExitSettings, aOriginalHostname)</span>
<a href="#l9.125"></a><span id="l9.125" class="difflineminus">-{</span>
<a href="#l9.126"></a><span id="l9.126" class="difflineplus">+function subtest_check_invalid_hostname(amc, aExitSettings, aOriginalHostname) {</span>
<a href="#l9.127"></a><span id="l9.127">   let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l9.128"></a><span id="l9.128">   click_account_tree_row(amc, accountRow);</span>
<a href="#l9.129"></a><span id="l9.129"> </span>
<a href="#l9.130"></a><span id="l9.130">   let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l9.131"></a><span id="l9.131">   let hostname = iframe.contentDocument.getElementById(&quot;server.realHostName&quot;);</span>
<a href="#l9.132"></a><span id="l9.132">   assert_equals(hostname.value, aOriginalHostname);</span>
<a href="#l9.133"></a><span id="l9.133"> </span>
<a href="#l9.134"></a><span id="l9.134">   hostname.value = &quot;some_invalid+host&amp;domain*in&gt;invalid&quot;;</span>
<a href="#l9.135"></a><span id="l9.135" class="difflineat">@@ -343,18 +343,17 @@ function test_trailing_spaces() {</span>
<a href="#l9.136"></a><span id="l9.136"> }</span>
<a href="#l9.137"></a><span id="l9.137"> </span>
<a href="#l9.138"></a><span id="l9.138"> /**</span>
<a href="#l9.139"></a><span id="l9.139">  * Check that the AM will trim user added spaces around text values</span>
<a href="#l9.140"></a><span id="l9.140">  * when storing them into the account.</span>
<a href="#l9.141"></a><span id="l9.141">  *</span>
<a href="#l9.142"></a><span id="l9.142">  * @param amc  the account options controller</span>
<a href="#l9.143"></a><span id="l9.143">  */</span>
<a href="#l9.144"></a><span id="l9.144" class="difflineminus">-function subtest_check_trailing_spaces(amc)</span>
<a href="#l9.145"></a><span id="l9.145" class="difflineminus">-{</span>
<a href="#l9.146"></a><span id="l9.146" class="difflineplus">+function subtest_check_trailing_spaces(amc) {</span>
<a href="#l9.147"></a><span id="l9.147">   let accountRow = get_account_tree_row(gPopAccount.key, null, amc);</span>
<a href="#l9.148"></a><span id="l9.148">   click_account_tree_row(amc, accountRow);</span>
<a href="#l9.149"></a><span id="l9.149"> </span>
<a href="#l9.150"></a><span id="l9.150">   let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l9.151"></a><span id="l9.151"> </span>
<a href="#l9.152"></a><span id="l9.152">   let accountName = iframe.contentDocument.getElementById(&quot;server.prettyName&quot;);</span>
<a href="#l9.153"></a><span id="l9.153">   let defaultAddress = iframe.contentDocument.getElementById(&quot;identity.email&quot;);</span>
<a href="#l9.154"></a><span id="l9.154">   delete_all_existing(amc, new elib.Elem(accountName));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/test/mozmill/account/test-archive-options.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-archive-options.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1,19 +1,21 @@</span>
<a href="#l10.4"></a><span id="l10.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.5"></a><span id="l10.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.6"></a><span id="l10.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8"> &quot;use strict&quot;;</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10" class="difflineplus">+/* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+</span>
<a href="#l10.14"></a><span id="l10.14"> var MODULE_NAME = &quot;test-archive-options&quot;;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-</span>
<a href="#l10.16"></a><span id="l10.16"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-                       &quot;account-manager-helpers&quot;];</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;account-manager-helpers&quot;];</span>
<a href="#l10.20"></a><span id="l10.20"> </span>
<a href="#l10.21"></a><span id="l10.21"> var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.jsm&quot;);</span>
<a href="#l10.22"></a><span id="l10.22"> var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l10.23"></a><span id="l10.23"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l10.24"></a><span id="l10.24"> </span>
<a href="#l10.25"></a><span id="l10.25"> var defaultIdentity;</span>
<a href="#l10.26"></a><span id="l10.26"> </span>
<a href="#l10.27"></a><span id="l10.27"> function setupModule(module) {</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineat">@@ -168,9 +170,9 @@ function subtest_disable_archive(amc) {</span>
<a href="#l10.29"></a><span id="l10.29">   assert_false(defaultIdentity.archiveEnabled);</span>
<a href="#l10.30"></a><span id="l10.30"> }</span>
<a href="#l10.31"></a><span id="l10.31"> </span>
<a href="#l10.32"></a><span id="l10.32"> function test_disable_archive() {</span>
<a href="#l10.33"></a><span id="l10.33">   open_advanced_settings(subtest_disable_archive);</span>
<a href="#l10.34"></a><span id="l10.34"> }</span>
<a href="#l10.35"></a><span id="l10.35"> // Disable test on Windows since for some yet unknown reason clicking the checkbox</span>
<a href="#l10.36"></a><span id="l10.36"> // doesn't have the desired result. See bug 1461173 for details.</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-test_disable_archive.EXCLUDED_PLATFORMS = ['winnt'];</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineplus">+test_disable_archive.EXCLUDED_PLATFORMS = [&quot;winnt&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mail/test/mozmill/account/test-mail-account-setup-wizard.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-mail-account-setup-wizard.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,19 +1,27 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.5"></a><span id="l11.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.6"></a><span id="l11.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.7"></a><span id="l11.7"> </span>
<a href="#l11.8"></a><span id="l11.8"> &quot;use strict&quot;;</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+/* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-keyboard-helpers.js */</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+</span>
<a href="#l11.15"></a><span id="l11.15"> var MODULE_NAME = &quot;test-mail-account-setup-wizard&quot;;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-</span>
<a href="#l11.17"></a><span id="l11.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-                       &quot;account-manager-helpers&quot;, &quot;keyboard-helpers&quot;];</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+  &quot;account-manager-helpers&quot;,</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+  &quot;keyboard-helpers&quot;,</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+];</span>
<a href="#l11.26"></a><span id="l11.26"> </span>
<a href="#l11.27"></a><span id="l11.27"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.28"></a><span id="l11.28"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l11.31"></a><span id="l11.31"> </span>
<a href="#l11.32"></a><span id="l11.32"> var user = {</span>
<a href="#l11.33"></a><span id="l11.33">   name: &quot;Yamato Nadeshiko&quot;,</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineat">@@ -53,17 +61,17 @@ function test_mail_account_setup() {</span>
<a href="#l11.35"></a><span id="l11.35">   // Set the pref to load a local autoconfig file.</span>
<a href="#l11.36"></a><span id="l11.36">   let pref_name = &quot;mailnews.auto_config_url&quot;;</span>
<a href="#l11.37"></a><span id="l11.37">   let url = collector.addHttpResource(&quot;../account/xml&quot;, &quot;autoconfig&quot;);</span>
<a href="#l11.38"></a><span id="l11.38">   Services.prefs.setCharPref(pref_name, url);</span>
<a href="#l11.39"></a><span id="l11.39"> </span>
<a href="#l11.40"></a><span id="l11.40">   // Force .com MIME-Type to text/xml</span>
<a href="#l11.41"></a><span id="l11.41">   collector.httpd.registerContentType(&quot;com&quot;, &quot;text/xml&quot;);</span>
<a href="#l11.42"></a><span id="l11.42"> </span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-  open_mail_account_setup_wizard(function (awc) {</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+  open_mail_account_setup_wizard(function(awc) {</span>
<a href="#l11.45"></a><span id="l11.45">     // Input user's account information</span>
<a href="#l11.46"></a><span id="l11.46">     awc.click(awc.eid(&quot;realname&quot;));</span>
<a href="#l11.47"></a><span id="l11.47">     if (awc.e(&quot;realname&quot;).value) {</span>
<a href="#l11.48"></a><span id="l11.48">       // If any realname is already filled, clear it out, we have our own.</span>
<a href="#l11.49"></a><span id="l11.49">       delete_all_existing(awc, awc.eid(&quot;realname&quot;));</span>
<a href="#l11.50"></a><span id="l11.50">     }</span>
<a href="#l11.51"></a><span id="l11.51">     input_value(awc, user.name);</span>
<a href="#l11.52"></a><span id="l11.52">     awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineat">@@ -94,31 +102,31 @@ function subtest_verify_account(amc) {</span>
<a href="#l11.54"></a><span id="l11.54">               &quot;Timeout waiting for currentAccount to become non-null&quot;);</span>
<a href="#l11.55"></a><span id="l11.55">   let account = amc.window.currentAccount;</span>
<a href="#l11.56"></a><span id="l11.56">   let identity = account.defaultIdentity;</span>
<a href="#l11.57"></a><span id="l11.57">   let incoming = account.incomingServer;</span>
<a href="#l11.58"></a><span id="l11.58">   let outgoing = MailServices.smtp.getServerByKey(identity.smtpServerKey);</span>
<a href="#l11.59"></a><span id="l11.59"> </span>
<a href="#l11.60"></a><span id="l11.60">   let config = {</span>
<a href="#l11.61"></a><span id="l11.61">     &quot;incoming server username&quot;: {</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-      actual: incoming.username, expected: user.email.split(&quot;@&quot;)[0]</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+      actual: incoming.username, expected: user.email.split(&quot;@&quot;)[0],</span>
<a href="#l11.64"></a><span id="l11.64">     },</span>
<a href="#l11.65"></a><span id="l11.65">     &quot;outgoing server username&quot;: {</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-      actual: outgoing.username, expected: user.email</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+      actual: outgoing.username, expected: user.email,</span>
<a href="#l11.68"></a><span id="l11.68">     },</span>
<a href="#l11.69"></a><span id="l11.69">     &quot;incoming server hostname&quot;: {</span>
<a href="#l11.70"></a><span id="l11.70">       // Note: N in the hostName is uppercase</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineminus">-      actual: incoming.hostName, expected: user.incomingHost</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+      actual: incoming.hostName, expected: user.incomingHost,</span>
<a href="#l11.73"></a><span id="l11.73">     },</span>
<a href="#l11.74"></a><span id="l11.74">     &quot;outgoing server hostname&quot;: {</span>
<a href="#l11.75"></a><span id="l11.75">       // And this is lowercase</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-      actual: outgoing.hostname, expected: user.outgoingHost</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+      actual: outgoing.hostname, expected: user.outgoingHost,</span>
<a href="#l11.78"></a><span id="l11.78">     },</span>
<a href="#l11.79"></a><span id="l11.79">     &quot;user real name&quot;: { actual: identity.fullName, expected: user.name },</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-    &quot;user email address&quot;: { actual: identity.email, expected: user.email }</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+    &quot;user email address&quot;: { actual: identity.email, expected: user.email },</span>
<a href="#l11.82"></a><span id="l11.82">   };</span>
<a href="#l11.83"></a><span id="l11.83"> </span>
<a href="#l11.84"></a><span id="l11.84">   try {</span>
<a href="#l11.85"></a><span id="l11.85">     for (let i in config) {</span>
<a href="#l11.86"></a><span id="l11.86">       if (config[i].actual != config[i].expected) {</span>
<a href="#l11.87"></a><span id="l11.87">         throw new Error(&quot;Configured &quot; + i + &quot; is &quot; + config[i].actual +</span>
<a href="#l11.88"></a><span id="l11.88">                         &quot;. It should be &quot; + config[i].expected + &quot;.&quot;);</span>
<a href="#l11.89"></a><span id="l11.89">       }</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineat">@@ -139,41 +147,39 @@ function test_bad_password_uses_old_sett</span>
<a href="#l11.91"></a><span id="l11.91">   let pref_name = &quot;mailnews.auto_config_url&quot;;</span>
<a href="#l11.92"></a><span id="l11.92">   let url = collector.addHttpResource(&quot;../account/xml&quot;, &quot;autoconfig&quot;);</span>
<a href="#l11.93"></a><span id="l11.93">   Services.prefs.setCharPref(pref_name, url);</span>
<a href="#l11.94"></a><span id="l11.94"> </span>
<a href="#l11.95"></a><span id="l11.95">   // Force .com MIME-Type to text/xml</span>
<a href="#l11.96"></a><span id="l11.96">   collector.httpd.registerContentType(&quot;com&quot;, &quot;text/xml&quot;);</span>
<a href="#l11.97"></a><span id="l11.97"> </span>
<a href="#l11.98"></a><span id="l11.98">   mc.sleep(0);</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineminus">-  open_mail_account_setup_wizard(function (awc) {</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+  open_mail_account_setup_wizard(function(awc) {</span>
<a href="#l11.101"></a><span id="l11.101">     try {</span>
<a href="#l11.102"></a><span id="l11.102">       // Input user's account information</span>
<a href="#l11.103"></a><span id="l11.103">       awc.click(awc.eid(&quot;realname&quot;));</span>
<a href="#l11.104"></a><span id="l11.104">       if (awc.e(&quot;realname&quot;).value) {</span>
<a href="#l11.105"></a><span id="l11.105">         // If any realname is already filled, clear it out, we have our own.</span>
<a href="#l11.106"></a><span id="l11.106">         delete_all_existing(awc, awc.eid(&quot;realname&quot;));</span>
<a href="#l11.107"></a><span id="l11.107">       }</span>
<a href="#l11.108"></a><span id="l11.108">       input_value(awc, user.name);</span>
<a href="#l11.109"></a><span id="l11.109">       awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l11.110"></a><span id="l11.110">       input_value(awc, user.email);</span>
<a href="#l11.111"></a><span id="l11.111">       awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l11.112"></a><span id="l11.112">       input_value(awc, user.password);</span>
<a href="#l11.113"></a><span id="l11.113"> </span>
<a href="#l11.114"></a><span id="l11.114">       // Load the autoconfig file from http://localhost:433**/autoconfig/example.com</span>
<a href="#l11.115"></a><span id="l11.115">       awc.e(&quot;next_button&quot;).click();</span>
<a href="#l11.116"></a><span id="l11.116"> </span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-      let config = null;</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineminus">-      awc.waitFor(function() { return this.disabled == false &amp;&amp; this.hidden == false; },</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+      awc.waitFor(function() { return !this.disabled &amp;&amp; !this.hidden; },</span>
<a href="#l11.121"></a><span id="l11.121">                   &quot;Timeout waiting for create button to be visible and active&quot;,</span>
<a href="#l11.122"></a><span id="l11.122">                   8000, 600, awc.e(&quot;create_button&quot;));</span>
<a href="#l11.123"></a><span id="l11.123">       awc.e(&quot;create_button&quot;).click();</span>
<a href="#l11.124"></a><span id="l11.124"> </span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-      awc.waitFor(function() { return this.disabled == false; },</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+      awc.waitFor(function() { return !this.disabled; },</span>
<a href="#l11.127"></a><span id="l11.127">                   &quot;Timeout waiting for create button to be visible and active&quot;,</span>
<a href="#l11.128"></a><span id="l11.128">                   8000, 600, awc.e(&quot;create_button&quot;));</span>
<a href="#l11.129"></a><span id="l11.129">       awc.e(&quot;create_button&quot;).click();</span>
<a href="#l11.130"></a><span id="l11.130">       awc.e(&quot;manual-edit_button&quot;).click();</span>
<a href="#l11.131"></a><span id="l11.131"> </span>
<a href="#l11.132"></a><span id="l11.132">       // Make sure all the values are the same as in the user object.</span>
<a href="#l11.133"></a><span id="l11.133">       awc.sleep(1000);</span>
<a href="#l11.134"></a><span id="l11.134">       assert_equals(awc.e(&quot;outgoing_hostname&quot;).value, user.outgoingHost,</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineat">@@ -201,31 +207,30 @@ function remember_password_test(aPrefVal</span>
<a href="#l11.136"></a><span id="l11.136">   // save the pref for backup purpose</span>
<a href="#l11.137"></a><span id="l11.137">   let rememberSignons_pref_save =</span>
<a href="#l11.138"></a><span id="l11.138">       Services.prefs.getBoolPref(&quot;signon.rememberSignons&quot;, true);</span>
<a href="#l11.139"></a><span id="l11.139"> </span>
<a href="#l11.140"></a><span id="l11.140">   Services.prefs.setBoolPref(&quot;signon.rememberSignons&quot;, aPrefValue);</span>
<a href="#l11.141"></a><span id="l11.141"> </span>
<a href="#l11.142"></a><span id="l11.142">   // without this, it breaks the test, don't know why</span>
<a href="#l11.143"></a><span id="l11.143">   mc.sleep(0);</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-  open_mail_account_setup_wizard(function (awc) {</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+  open_mail_account_setup_wizard(function(awc) {</span>
<a href="#l11.146"></a><span id="l11.146">     try {</span>
<a href="#l11.147"></a><span id="l11.147">       let password = new elementslib.ID(awc.window.document, &quot;password&quot;);</span>
<a href="#l11.148"></a><span id="l11.148">       let rememberPassword =</span>
<a href="#l11.149"></a><span id="l11.149">           new elementslib.ID(awc.window.document, &quot;remember_password&quot;);</span>
<a href="#l11.150"></a><span id="l11.150"> </span>
<a href="#l11.151"></a><span id="l11.151">       // type something in the password field</span>
<a href="#l11.152"></a><span id="l11.152">       awc.e(&quot;password&quot;).focus();</span>
<a href="#l11.153"></a><span id="l11.153">       input_value(awc, &quot;testing&quot;);</span>
<a href="#l11.154"></a><span id="l11.154"> </span>
<a href="#l11.155"></a><span id="l11.155">       awc.assertProperty(rememberPassword, &quot;disabled&quot;, !aPrefValue);</span>
<a href="#l11.156"></a><span id="l11.156">       if (aPrefValue) {</span>
<a href="#l11.157"></a><span id="l11.157">         awc.assertChecked(rememberPassword);</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineminus">-      }</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-      else {</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+      } else {</span>
<a href="#l11.161"></a><span id="l11.161">         awc.assertNotChecked(rememberPassword);</span>
<a href="#l11.162"></a><span id="l11.162">       }</span>
<a href="#l11.163"></a><span id="l11.163"> </span>
<a href="#l11.164"></a><span id="l11.164">       // empty the password field</span>
<a href="#l11.165"></a><span id="l11.165">       delete_all_existing(awc, password);</span>
<a href="#l11.166"></a><span id="l11.166"> </span>
<a href="#l11.167"></a><span id="l11.167">       // restore the saved signon.rememberSignons value</span>
<a href="#l11.168"></a><span id="l11.168">       Services.prefs.setBoolPref(&quot;signon.rememberSignons&quot;, rememberSignons_pref_save);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/test/mozmill/account/test-retest-config.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/test/mozmill/account/test-retest-config.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,27 +1,35 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.5"></a><span id="l12.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.6"></a><span id="l12.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8"> &quot;use strict&quot;;</span>
<a href="#l12.9"></a><span id="l12.9"> </span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+/* import-globals-from ../shared-modules/test-account-manager-helpers.js */</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-keyboard-helpers.js */</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+</span>
<a href="#l12.15"></a><span id="l12.15"> var MODULE_NAME = &quot;test-retest-config&quot;;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-</span>
<a href="#l12.17"></a><span id="l12.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-                       &quot;keyboard-helpers&quot;, &quot;account-manager-helpers&quot;];</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+  &quot;keyboard-helpers&quot;,</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+  &quot;account-manager-helpers&quot;,</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+];</span>
<a href="#l12.26"></a><span id="l12.26"> </span>
<a href="#l12.27"></a><span id="l12.27"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l12.28"></a><span id="l12.28"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30"> var user = {</span>
<a href="#l12.31"></a><span id="l12.31">   name: &quot;test&quot;,</span>
<a href="#l12.32"></a><span id="l12.32">   email: &quot;test@momo.invalid&quot;,</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineminus">-  altEmail: &quot;test2@momo.invalid&quot;</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+  altEmail: &quot;test2@momo.invalid&quot;,</span>
<a href="#l12.35"></a><span id="l12.35"> };</span>
<a href="#l12.36"></a><span id="l12.36"> </span>
<a href="#l12.37"></a><span id="l12.37"> function setupModule(module) {</span>
<a href="#l12.38"></a><span id="l12.38">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l12.39"></a><span id="l12.39">     collector.getModule(lib).installInto(module);</span>
<a href="#l12.40"></a><span id="l12.40">   }</span>
<a href="#l12.41"></a><span id="l12.41">   Services.prefs.setCharPref(&quot;mail.wizard.logging.dump&quot;, &quot;All&quot;);</span>
<a href="#l12.42"></a><span id="l12.42"> </span>
<a href="#l12.43"></a><span id="l12.43" class="difflineat">@@ -34,54 +42,54 @@ function tearDownModule(module) {</span>
<a href="#l12.44"></a><span id="l12.44">   Services.prefs.clearUserPref(&quot;mailnews.auto_config_url&quot;);</span>
<a href="#l12.45"></a><span id="l12.45">   Services.prefs.clearUserPref(&quot;mail.wizard.logging.dump&quot;);</span>
<a href="#l12.46"></a><span id="l12.46"> }</span>
<a href="#l12.47"></a><span id="l12.47"> </span>
<a href="#l12.48"></a><span id="l12.48"> function test_re_test_config() {</span>
<a href="#l12.49"></a><span id="l12.49">   // Opening multiple windows in the same run seems to require letting the stack</span>
<a href="#l12.50"></a><span id="l12.50">   // unwind before opening the next one, so do that here.</span>
<a href="#l12.51"></a><span id="l12.51">   mc.sleep(0);</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineminus">-  open_mail_account_setup_wizard(function (awc) {</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+  open_mail_account_setup_wizard(function(awc) {</span>
<a href="#l12.54"></a><span id="l12.54">     // Input user's account information</span>
<a href="#l12.55"></a><span id="l12.55">     awc.click(awc.eid(&quot;realname&quot;));</span>
<a href="#l12.56"></a><span id="l12.56">     if (awc.e(&quot;realname&quot;).value) {</span>
<a href="#l12.57"></a><span id="l12.57">       // If any realname is already filled, clear it out, we have our own.</span>
<a href="#l12.58"></a><span id="l12.58">       delete_all_existing(awc, awc.eid(&quot;realname&quot;));</span>
<a href="#l12.59"></a><span id="l12.59">     }</span>
<a href="#l12.60"></a><span id="l12.60">     input_value(awc, user.name);</span>
<a href="#l12.61"></a><span id="l12.61">     awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l12.62"></a><span id="l12.62">     input_value(awc, user.email);</span>
<a href="#l12.63"></a><span id="l12.63"> </span>
<a href="#l12.64"></a><span id="l12.64">     // Click &quot;continue&quot; button</span>
<a href="#l12.65"></a><span id="l12.65">     awc.e(&quot;next_button&quot;).click();</span>
<a href="#l12.66"></a><span id="l12.66"> </span>
<a href="#l12.67"></a><span id="l12.67">     // Wait for 'edit' button to be enabled</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineminus">-    awc.waitFor(function() { return this.disabled == false &amp;&amp; this.hidden == false; },</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+    awc.waitFor(function() { return !this.disabled &amp;&amp; !this.hidden; },</span>
<a href="#l12.70"></a><span id="l12.70">                 &quot;Timeout waiting for edit button to be enabled&quot;,</span>
<a href="#l12.71"></a><span id="l12.71">                 8000, 600, awc.e(&quot;create_button&quot;));</span>
<a href="#l12.72"></a><span id="l12.72"> </span>
<a href="#l12.73"></a><span id="l12.73">     awc.e(&quot;manual-edit_button&quot;).click();</span>
<a href="#l12.74"></a><span id="l12.74"> </span>
<a href="#l12.75"></a><span id="l12.75">     // Click &quot;re-test&quot; button</span>
<a href="#l12.76"></a><span id="l12.76">     awc.e(&quot;half-manual-test_button&quot;).click();</span>
<a href="#l12.77"></a><span id="l12.77"> </span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-    awc.waitFor(function () { return this.disabled == false; },</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+    awc.waitFor(function() { return !this.disabled; },</span>
<a href="#l12.80"></a><span id="l12.80">                 &quot;Timeout waiting for re-test button to be enabled&quot;,</span>
<a href="#l12.81"></a><span id="l12.81">                 20000, 600, awc.e(&quot;half-manual-test_button&quot;));</span>
<a href="#l12.82"></a><span id="l12.82"> </span>
<a href="#l12.83"></a><span id="l12.83">     // There used to be a &quot;start over&quot; button (line commented out below). Now just</span>
<a href="#l12.84"></a><span id="l12.84">     // changing the value of the email field does the trick.</span>
<a href="#l12.85"></a><span id="l12.85">     awc.e(&quot;realname&quot;).focus();</span>
<a href="#l12.86"></a><span id="l12.86">     awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l12.87"></a><span id="l12.87">     input_value(awc, user.altEmail);</span>
<a href="#l12.88"></a><span id="l12.88">     awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l12.89"></a><span id="l12.89"> </span>
<a href="#l12.90"></a><span id="l12.90">     // Wait for the &quot;continue&quot; button to be back, which means we're back to the</span>
<a href="#l12.91"></a><span id="l12.91">     // original state.</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-    awc.waitFor(function() { return this.hidden == false; },</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+    awc.waitFor(function() { return !this.hidden; },</span>
<a href="#l12.94"></a><span id="l12.94">                 &quot;Timeout waiting for continue button to be visible&quot;,</span>
<a href="#l12.95"></a><span id="l12.95">                 20000, 600, awc.e(&quot;next_button&quot;));</span>
<a href="#l12.96"></a><span id="l12.96"> </span>
<a href="#l12.97"></a><span id="l12.97">     awc.e(&quot;next_button&quot;).click();</span>
<a href="#l12.98"></a><span id="l12.98"> </span>
<a href="#l12.99"></a><span id="l12.99">     // Previously, we'd switched to the manual editing state. Now we've started</span>
<a href="#l12.100"></a><span id="l12.100">     // over, we should make sure the information is presented back in its original</span>
<a href="#l12.101"></a><span id="l12.101">     // &quot;automatic&quot; mode.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mail/test/mozmill/addrbook/test-address-book-panes.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mail/test/mozmill/addrbook/test-address-book-panes.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -3,18 +3,20 @@</span>
<a href="#l13.4"></a><span id="l13.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l13.5"></a><span id="l13.5"> </span>
<a href="#l13.6"></a><span id="l13.6"> /*</span>
<a href="#l13.7"></a><span id="l13.7">  * Tests for the address book.</span>
<a href="#l13.8"></a><span id="l13.8">  */</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> &quot;use strict&quot;;</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-address-book-helpers.js */</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+</span>
<a href="#l13.15"></a><span id="l13.15"> var MODULE_NAME = &quot;test-address-book-panes&quot;;</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-</span>
<a href="#l13.17"></a><span id="l13.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l13.18"></a><span id="l13.18"> var MODULE_REQUIRES = [&quot;address-book-helpers&quot;, &quot;folder-display-helpers&quot;];</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20"> var abController;</span>
<a href="#l13.21"></a><span id="l13.21"> </span>
<a href="#l13.22"></a><span id="l13.22"> function setupModule(module) {</span>
<a href="#l13.23"></a><span id="l13.23">   // We need this to get mc which is needed in open_address_book_window.</span>
<a href="#l13.24"></a><span id="l13.24">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineat">@@ -56,17 +58,16 @@ function _help_assert_pane_visibility(pa</span>
<a href="#l13.26"></a><span id="l13.26">   if (abController.e(paneId).collapsed == visible)</span>
<a href="#l13.27"></a><span id="l13.27">     throw new Error(paneId + &quot; pane should be &quot; +</span>
<a href="#l13.28"></a><span id="l13.28">                     (visible ? &quot;visible&quot; : &quot;hidden&quot;));</span>
<a href="#l13.29"></a><span id="l13.29"> </span>
<a href="#l13.30"></a><span id="l13.30">   abController.window.InitViewLayoutMenuPopup();</span>
<a href="#l13.31"></a><span id="l13.31">   if ((abController.e(menuitemId).getAttribute(&quot;checked&quot;) == &quot;true&quot;) != visible)</span>
<a href="#l13.32"></a><span id="l13.32">     throw new Error(menuitemId + &quot; menuitem should be &quot; +</span>
<a href="#l13.33"></a><span id="l13.33">                     (visible ? &quot;checked&quot; : &quot;unchecked&quot;));</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-</span>
<a href="#l13.35"></a><span id="l13.35"> }</span>
<a href="#l13.36"></a><span id="l13.36"> </span>
<a href="#l13.37"></a><span id="l13.37"> /**</span>
<a href="#l13.38"></a><span id="l13.38">  * Toggle the directory pane.</span>
<a href="#l13.39"></a><span id="l13.39">  */</span>
<a href="#l13.40"></a><span id="l13.40"> function toggle_directory_pane() {</span>
<a href="#l13.41"></a><span id="l13.41">   _help_toggle_pane(&quot;dirTree-splitter&quot;);</span>
<a href="#l13.42"></a><span id="l13.42"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mail/test/mozmill/addrbook/test-address-book.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mail/test/mozmill/addrbook/test-address-book.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -3,33 +3,41 @@</span>
<a href="#l14.4"></a><span id="l14.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> /*</span>
<a href="#l14.7"></a><span id="l14.7">  * Tests for the address book.</span>
<a href="#l14.8"></a><span id="l14.8">  */</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> &quot;use strict&quot;;</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-var MODULE_NAME = 'test-address-book';</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-address-book-helpers.js */</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l14.16"></a><span id="l14.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-prompt-helpers.js */</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;address-book-helpers&quot;,</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-                       'compose-helpers', 'window-helpers',</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-                       'prompt-helpers'];</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+var MODULE_NAME = &quot;test-address-book&quot;;</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+  &quot;address-book-helpers&quot;,</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+  &quot;prompt-helpers&quot;,</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+];</span>
<a href="#l14.32"></a><span id="l14.32"> </span>
<a href="#l14.33"></a><span id="l14.33"> var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l14.34"></a><span id="l14.34"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.35"></a><span id="l14.35"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l14.36"></a><span id="l14.36"> </span>
<a href="#l14.37"></a><span id="l14.37"> var abController = null;</span>
<a href="#l14.38"></a><span id="l14.38"> var addrBook1, addrBook2, addrBook3, addrBook4, ldapBook;</span>
<a href="#l14.39"></a><span id="l14.39"> var mListA, mListB, mListC, mListD, mListE;</span>
<a href="#l14.40"></a><span id="l14.40"> </span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-function setupModule(module)</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-{</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineplus">+function setupModule(module) {</span>
<a href="#l14.44"></a><span id="l14.44">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l14.45"></a><span id="l14.45">     collector.getModule(lib).installInto(module);</span>
<a href="#l14.46"></a><span id="l14.46">   }</span>
<a href="#l14.47"></a><span id="l14.47"> </span>
<a href="#l14.48"></a><span id="l14.48">   // Open the address book main window</span>
<a href="#l14.49"></a><span id="l14.49">   abController = open_address_book_window();</span>
<a href="#l14.50"></a><span id="l14.50"> </span>
<a href="#l14.51"></a><span id="l14.51">   // Let's add some new address books.  I'll add them</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineat">@@ -83,111 +91,107 @@ function setupModule(module)</span>
<a href="#l14.53"></a><span id="l14.53">  *    ML B</span>
<a href="#l14.54"></a><span id="l14.54">  * AB 3</span>
<a href="#l14.55"></a><span id="l14.55">  *    ML C</span>
<a href="#l14.56"></a><span id="l14.56">  *    ML D</span>
<a href="#l14.57"></a><span id="l14.57">  * AB 4</span>
<a href="#l14.58"></a><span id="l14.58">  * LDAP Book</span>
<a href="#l14.59"></a><span id="l14.59">  * Collected Address Book</span>
<a href="#l14.60"></a><span id="l14.60">  **/</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineminus">-function test_order_of_address_books()</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineminus">-{</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+function test_order_of_address_books() {</span>
<a href="#l14.64"></a><span id="l14.64">   const EXPECTED_AB_ORDER = [&quot;All Address Books&quot;,</span>
<a href="#l14.65"></a><span id="l14.65">                              &quot;Personal Address Book&quot;, &quot;AB 1&quot;, &quot;AB 2&quot;,</span>
<a href="#l14.66"></a><span id="l14.66">                              &quot;AB 3&quot;, &quot;AB 4&quot;, &quot;LDAP Book&quot;,</span>
<a href="#l14.67"></a><span id="l14.67">                              &quot;Collected Addresses&quot;];</span>
<a href="#l14.68"></a><span id="l14.68"> </span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-  for (let i = 0; i &lt; EXPECTED_AB_ORDER.length; i++)</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-  {</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+  for (let i = 0; i &lt; EXPECTED_AB_ORDER.length; i++) {</span>
<a href="#l14.72"></a><span id="l14.72">     let abName = get_name_of_address_book_element_at(i);</span>
<a href="#l14.73"></a><span id="l14.73">     assert_equals(abName, EXPECTED_AB_ORDER[i],</span>
<a href="#l14.74"></a><span id="l14.74">                   &quot;The address books are out of order.&quot;);</span>
<a href="#l14.75"></a><span id="l14.75">   }</span>
<a href="#l14.76"></a><span id="l14.76"> }</span>
<a href="#l14.77"></a><span id="l14.77"> </span>
<a href="#l14.78"></a><span id="l14.78"> /* Test that the expanded and collapsed states of address books</span>
<a href="#l14.79"></a><span id="l14.79">  * in the tree persist state when closing and re-opening the</span>
<a href="#l14.80"></a><span id="l14.80">  * address book manager</span>
<a href="#l14.81"></a><span id="l14.81">  */</span>
<a href="#l14.82"></a><span id="l14.82" class="difflineminus">-function test_persist_collapsed_and_expanded_states()</span>
<a href="#l14.83"></a><span id="l14.83" class="difflineminus">-{</span>
<a href="#l14.84"></a><span id="l14.84" class="difflineplus">+function test_persist_collapsed_and_expanded_states() {</span>
<a href="#l14.85"></a><span id="l14.85">   // Set the state of address books 1 and 3 to expanded</span>
<a href="#l14.86"></a><span id="l14.86">   set_address_books_expanded([addrBook1, addrBook3]);</span>
<a href="#l14.87"></a><span id="l14.87"> </span>
<a href="#l14.88"></a><span id="l14.88">   // Set address book 2 to be collapsed</span>
<a href="#l14.89"></a><span id="l14.89" class="difflineminus">-  set_address_book_collapsed(addrBook2);</span>
<a href="#l14.90"></a><span id="l14.90" class="difflineplus">+  set_address_books_collapsed(addrBook2);</span>
<a href="#l14.91"></a><span id="l14.91"> </span>
<a href="#l14.92"></a><span id="l14.92">   // Now close and re-open the address book</span>
<a href="#l14.93"></a><span id="l14.93">   close_address_book_window(abController);</span>
<a href="#l14.94"></a><span id="l14.94">   abController = open_address_book_window();</span>
<a href="#l14.95"></a><span id="l14.95"> </span>
<a href="#l14.96"></a><span id="l14.96">   assert_true(is_address_book_collapsed(addrBook2));</span>
<a href="#l14.97"></a><span id="l14.97">   assert_true(!is_address_book_collapsed(addrBook1));</span>
<a href="#l14.98"></a><span id="l14.98">   assert_true(!is_address_book_collapsed(addrBook3));</span>
<a href="#l14.99"></a><span id="l14.99"> </span>
<a href="#l14.100"></a><span id="l14.100">   // Now set the state of address books 1 and 3 to collapsed</span>
<a href="#l14.101"></a><span id="l14.101">   // and make sure 2 is expanded</span>
<a href="#l14.102"></a><span id="l14.102">   set_address_books_collapsed([addrBook1, addrBook3]);</span>
<a href="#l14.103"></a><span id="l14.103" class="difflineminus">-  set_address_book_expanded(addrBook2);</span>
<a href="#l14.104"></a><span id="l14.104" class="difflineplus">+  set_address_books_expanded(addrBook2);</span>
<a href="#l14.105"></a><span id="l14.105"> </span>
<a href="#l14.106"></a><span id="l14.106">   // Now close and re-open the address book</span>
<a href="#l14.107"></a><span id="l14.107">   close_address_book_window(abController);</span>
<a href="#l14.108"></a><span id="l14.108">   abController = open_address_book_window();</span>
<a href="#l14.109"></a><span id="l14.109"> </span>
<a href="#l14.110"></a><span id="l14.110">   assert_true(!is_address_book_collapsed(addrBook2));</span>
<a href="#l14.111"></a><span id="l14.111">   assert_true(is_address_book_collapsed(addrBook1));</span>
<a href="#l14.112"></a><span id="l14.112">   assert_true(is_address_book_collapsed(addrBook3));</span>
<a href="#l14.113"></a><span id="l14.113"> }</span>
<a href="#l14.114"></a><span id="l14.114"> </span>
<a href="#l14.115"></a><span id="l14.115"> /* Test that if we try to delete a contact, that we are given</span>
<a href="#l14.116"></a><span id="l14.116">  * a confirm prompt.</span>
<a href="#l14.117"></a><span id="l14.117">  */</span>
<a href="#l14.118"></a><span id="l14.118" class="difflineminus">-function test_deleting_contact_causes_confirm_prompt()</span>
<a href="#l14.119"></a><span id="l14.119" class="difflineminus">-{</span>
<a href="#l14.120"></a><span id="l14.120" class="difflineplus">+function test_deleting_contact_causes_confirm_prompt() {</span>
<a href="#l14.121"></a><span id="l14.121">   // Register the Mock Prompt Service</span>
<a href="#l14.122"></a><span id="l14.122">   gMockPromptService.register();</span>
<a href="#l14.123"></a><span id="l14.123"> </span>
<a href="#l14.124"></a><span id="l14.124">   // Create a contact that we'll try to delete</span>
<a href="#l14.125"></a><span id="l14.125">   let contact1 = create_contact(&quot;test@example.com&quot;, &quot;Sammy Jenkis&quot;, true);</span>
<a href="#l14.126"></a><span id="l14.126">   let toDelete = [contact1];</span>
<a href="#l14.127"></a><span id="l14.127"> </span>
<a href="#l14.128"></a><span id="l14.128">   let bundle = Services.strings</span>
<a href="#l14.129"></a><span id="l14.129" class="difflineminus">-                       .createBundle(&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;)</span>
<a href="#l14.130"></a><span id="l14.130" class="difflineplus">+                       .createBundle(&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;);</span>
<a href="#l14.131"></a><span id="l14.131">   let confirmSingle = bundle.GetStringFromName(&quot;confirmDeleteThisContact&quot;);</span>
<a href="#l14.132"></a><span id="l14.132">   confirmSingle = confirmSingle.replace(&quot;#1&quot;, &quot;Sammy Jenkis&quot;);</span>
<a href="#l14.133"></a><span id="l14.133"> </span>
<a href="#l14.134"></a><span id="l14.134">   // Add some contacts to the address book</span>
<a href="#l14.135"></a><span id="l14.135">   load_contacts_into_address_book(addrBook1, toDelete);</span>
<a href="#l14.136"></a><span id="l14.136">   select_address_book(addrBook1);</span>
<a href="#l14.137"></a><span id="l14.137"> </span>
<a href="#l14.138"></a><span id="l14.138">   let totalEntries = abController.window.gAbView.rowCount;</span>
<a href="#l14.139"></a><span id="l14.139"> </span>
<a href="#l14.140"></a><span id="l14.140">   // Set the mock prompt to return false, so that the</span>
<a href="#l14.141"></a><span id="l14.141">   // contact should not be deleted.</span>
<a href="#l14.142"></a><span id="l14.142">   gMockPromptService.returnValue = false;</span>
<a href="#l14.143"></a><span id="l14.143"> </span>
<a href="#l14.144"></a><span id="l14.144">   // Now attempt to delete the contact</span>
<a href="#l14.145"></a><span id="l14.145" class="difflineminus">-  select_contact(toDelete);</span>
<a href="#l14.146"></a><span id="l14.146" class="difflineplus">+  select_contacts(toDelete);</span>
<a href="#l14.147"></a><span id="l14.147">   abController.keypress(null, &quot;VK_DELETE&quot;, {});</span>
<a href="#l14.148"></a><span id="l14.148"> </span>
<a href="#l14.149"></a><span id="l14.149">   let promptState = gMockPromptService.promptState;</span>
<a href="#l14.150"></a><span id="l14.150">   assert_not_equals(null, promptState, &quot;Expected a prompt state&quot;);</span>
<a href="#l14.151"></a><span id="l14.151">   // Was a confirm displayed?</span>
<a href="#l14.152"></a><span id="l14.152">   assert_equals(&quot;confirm&quot;, promptState.method);</span>
<a href="#l14.153"></a><span id="l14.153">   // Was the right message displayed?</span>
<a href="#l14.154"></a><span id="l14.154">   assert_equals(confirmSingle, promptState.text);</span>
<a href="#l14.155"></a><span id="l14.155">   // The contact should not have been deleted.</span>
<a href="#l14.156"></a><span id="l14.156">   assert_equals(abController.window.gAbView.rowCount, totalEntries);</span>
<a href="#l14.157"></a><span id="l14.157"> </span>
<a href="#l14.158"></a><span id="l14.158">   gMockPromptService.reset();</span>
<a href="#l14.159"></a><span id="l14.159"> </span>
<a href="#l14.160"></a><span id="l14.160">   // Now we'll return true on confirm so that</span>
<a href="#l14.161"></a><span id="l14.161">   // the contact is deleted.</span>
<a href="#l14.162"></a><span id="l14.162">   gMockPromptService.returnValue = true;</span>
<a href="#l14.163"></a><span id="l14.163" class="difflineminus">-  select_contact(toDelete);</span>
<a href="#l14.164"></a><span id="l14.164" class="difflineplus">+  select_contacts(toDelete);</span>
<a href="#l14.165"></a><span id="l14.165">   abController.keypress(null, &quot;VK_DELETE&quot;, {});</span>
<a href="#l14.166"></a><span id="l14.166"> </span>
<a href="#l14.167"></a><span id="l14.167">   promptState = gMockPromptService.promptState;</span>
<a href="#l14.168"></a><span id="l14.168">   assert_not_equals(null, promptState, &quot;Expected a prompt state&quot;);</span>
<a href="#l14.169"></a><span id="l14.169">   // Was a confirm displayed?</span>
<a href="#l14.170"></a><span id="l14.170">   assert_equals(&quot;confirm&quot;, promptState.method);</span>
<a href="#l14.171"></a><span id="l14.171">   // Was the right message displayed?</span>
<a href="#l14.172"></a><span id="l14.172">   assert_equals(confirmSingle, promptState.text);</span>
<a href="#l14.173"></a><span id="l14.173" class="difflineat">@@ -196,30 +200,29 @@ function test_deleting_contact_causes_co</span>
<a href="#l14.174"></a><span id="l14.174">                 totalEntries - toDelete.length);</span>
<a href="#l14.175"></a><span id="l14.175"> </span>
<a href="#l14.176"></a><span id="l14.176">   gMockPromptService.unregister();</span>
<a href="#l14.177"></a><span id="l14.177"> }</span>
<a href="#l14.178"></a><span id="l14.178"> </span>
<a href="#l14.179"></a><span id="l14.179"> /* Test that if we try to delete multiple contacts, that we are give</span>
<a href="#l14.180"></a><span id="l14.180">  * a confirm prompt.</span>
<a href="#l14.181"></a><span id="l14.181">  */</span>
<a href="#l14.182"></a><span id="l14.182" class="difflineminus">-function test_deleting_contacts_causes_confirm_prompt()</span>
<a href="#l14.183"></a><span id="l14.183" class="difflineminus">-{</span>
<a href="#l14.184"></a><span id="l14.184" class="difflineplus">+function test_deleting_contacts_causes_confirm_prompt() {</span>
<a href="#l14.185"></a><span id="l14.185">   // Register the Mock Prompt Service</span>
<a href="#l14.186"></a><span id="l14.186">   gMockPromptService.register();</span>
<a href="#l14.187"></a><span id="l14.187"> </span>
<a href="#l14.188"></a><span id="l14.188">   // Create some contacts that we'll try to delete.</span>
<a href="#l14.189"></a><span id="l14.189">   let contact2 = create_contact(&quot;test2@example.com&quot;, &quot;Leonard Shelby&quot;, true);</span>
<a href="#l14.190"></a><span id="l14.190">   let contact3 = create_contact(&quot;test3@example.com&quot;, &quot;John Edward Gammell&quot;, true);</span>
<a href="#l14.191"></a><span id="l14.191">   let contact4 = create_contact(&quot;test4@example.com&quot;, &quot;Natalie&quot;, true);</span>
<a href="#l14.192"></a><span id="l14.192"> </span>
<a href="#l14.193"></a><span id="l14.193">   let toDelete = [contact2, contact3, contact4];</span>
<a href="#l14.194"></a><span id="l14.194"> </span>
<a href="#l14.195"></a><span id="l14.195">   let bundle = Services.strings</span>
<a href="#l14.196"></a><span id="l14.196" class="difflineminus">-                       .createBundle(&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;)</span>
<a href="#l14.197"></a><span id="l14.197" class="difflineplus">+                       .createBundle(&quot;chrome://messenger/locale/addressbook/addressBook.properties&quot;);</span>
<a href="#l14.198"></a><span id="l14.198">   let confirmMultiple = bundle.GetStringFromName(&quot;confirmDelete2orMoreContacts&quot;);</span>
<a href="#l14.199"></a><span id="l14.199">   confirmMultiple = confirmMultiple.replace(/.*;/, &quot;&quot;).replace(&quot;#1&quot;, &quot;3&quot;);</span>
<a href="#l14.200"></a><span id="l14.200"> </span>
<a href="#l14.201"></a><span id="l14.201">   // Add some contacts to the address book</span>
<a href="#l14.202"></a><span id="l14.202">   load_contacts_into_address_book(addrBook1, toDelete);</span>
<a href="#l14.203"></a><span id="l14.203">   select_address_book(addrBook1);</span>
<a href="#l14.204"></a><span id="l14.204"> </span>
<a href="#l14.205"></a><span id="l14.205">   let totalEntries = abController.window.gAbView.rowCount;</span>
<a href="#l14.206"></a><span id="l14.206" class="difflineat">@@ -269,17 +272,16 @@ function test_deleting_contacts_causes_c</span>
<a href="#l14.207"></a><span id="l14.207"> function test_deleting_mailing_lists() {</span>
<a href="#l14.208"></a><span id="l14.208">   // Register our Mock Prompt Service</span>
<a href="#l14.209"></a><span id="l14.209">   gMockPromptService.register();</span>
<a href="#l14.210"></a><span id="l14.210"> </span>
<a href="#l14.211"></a><span id="l14.211">   // Create a new mailing list, and add it to one of our</span>
<a href="#l14.212"></a><span id="l14.212">   // address books</span>
<a href="#l14.213"></a><span id="l14.213">   let newList = create_mailing_list(&quot;Delete Me!&quot;);</span>
<a href="#l14.214"></a><span id="l14.214">   let addedList = addrBook1.addMailList(newList);</span>
<a href="#l14.215"></a><span id="l14.215" class="difflineminus">-  let mlURI = addedList.URI;</span>
<a href="#l14.216"></a><span id="l14.216"> </span>
<a href="#l14.217"></a><span id="l14.217">   // Make sure it got added.</span>
<a href="#l14.218"></a><span id="l14.218">   assert_true(addrBook1.hasDirectory(addedList));</span>
<a href="#l14.219"></a><span id="l14.219"> </span>
<a href="#l14.220"></a><span id="l14.220">   // Let's click &quot;cancel&quot; on the confirm dialog box</span>
<a href="#l14.221"></a><span id="l14.221">   // first.</span>
<a href="#l14.222"></a><span id="l14.222">   gMockPromptService.returnValue = false;</span>
<a href="#l14.223"></a><span id="l14.223"> </span>
<a href="#l14.224"></a><span id="l14.224" class="difflineat">@@ -311,33 +313,30 @@ function test_deleting_mailing_lists() {</span>
<a href="#l14.225"></a><span id="l14.225">   gMockPromptService.unregister();</span>
<a href="#l14.226"></a><span id="l14.226"> }</span>
<a href="#l14.227"></a><span id="l14.227"> </span>
<a href="#l14.228"></a><span id="l14.228"> </span>
<a href="#l14.229"></a><span id="l14.229"> /* Tests that we can send mail to a mailing list by selecting the</span>
<a href="#l14.230"></a><span id="l14.230">  * mailing list in the tree, and clicking &quot;Write&quot;</span>
<a href="#l14.231"></a><span id="l14.231">  */</span>
<a href="#l14.232"></a><span id="l14.232"> function test_writing_to_mailing_list() {</span>
<a href="#l14.233"></a><span id="l14.233" class="difflineminus">-</span>
<a href="#l14.234"></a><span id="l14.234">   // Create a new mailing list, and add it to one of our</span>
<a href="#l14.235"></a><span id="l14.235">   // address books</span>
<a href="#l14.236"></a><span id="l14.236">   let newList = create_mailing_list(&quot;Some Mailing List&quot;);</span>
<a href="#l14.237"></a><span id="l14.237">   let addedList = addrBook1.addMailList(newList);</span>
<a href="#l14.238"></a><span id="l14.238" class="difflineminus">-  let mlURI = addedList.URI;</span>
<a href="#l14.239"></a><span id="l14.239"> </span>
<a href="#l14.240"></a><span id="l14.240">   // Create some contacts that we'll try to contact</span>
<a href="#l14.241"></a><span id="l14.241">   let contacts = [create_contact(&quot;test2@example.com&quot;, &quot;Leonard Shelby&quot;, true),</span>
<a href="#l14.242"></a><span id="l14.242" class="difflineminus">-                  create_contact(&quot;test3@example.com&quot;, &quot;John Edward Gammell&quot;,</span>
<a href="#l14.243"></a><span id="l14.243" class="difflineminus">-                                 true),</span>
<a href="#l14.244"></a><span id="l14.244" class="difflineminus">-                  create_contact(&quot;test4@example.com&quot;, &quot;Natalie&quot;, true),];</span>
<a href="#l14.245"></a><span id="l14.245" class="difflineplus">+                  create_contact(&quot;test3@example.com&quot;, &quot;John Edward Gammell&quot;, true),</span>
<a href="#l14.246"></a><span id="l14.246" class="difflineplus">+                  create_contact(&quot;test4@example.com&quot;, &quot;Natalie&quot;, true)];</span>
<a href="#l14.247"></a><span id="l14.247"> </span>
<a href="#l14.248"></a><span id="l14.248">   load_contacts_into_mailing_list(addedList, contacts);</span>
<a href="#l14.249"></a><span id="l14.249"> </span>
<a href="#l14.250"></a><span id="l14.250">   // Ensure that addrBook1 is expanded</span>
<a href="#l14.251"></a><span id="l14.251" class="difflineminus">-  set_address_book_expanded(addrBook1);</span>
<a href="#l14.252"></a><span id="l14.252" class="difflineplus">+  set_address_books_expanded(addrBook1);</span>
<a href="#l14.253"></a><span id="l14.253"> </span>
<a href="#l14.254"></a><span id="l14.254">   // Now select the mailing list in the tree...</span>
<a href="#l14.255"></a><span id="l14.255">   select_address_book(addedList);</span>
<a href="#l14.256"></a><span id="l14.256"> </span>
<a href="#l14.257"></a><span id="l14.257">   // Focus it...</span>
<a href="#l14.258"></a><span id="l14.258">   abController.window.gDirTree.focus();</span>
<a href="#l14.259"></a><span id="l14.259"> </span>
<a href="#l14.260"></a><span id="l14.260">   // Assuming we've made it this far, now we just plan for the compose</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mail/test/mozmill/addrbook/test-update-mailing-list.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mail/test/mozmill/addrbook/test-update-mailing-list.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -4,27 +4,28 @@</span>
<a href="#l15.4"></a><span id="l15.4"> </span>
<a href="#l15.5"></a><span id="l15.5"> /**</span>
<a href="#l15.6"></a><span id="l15.6">  * Tests that if a contact's address is updated, then the address is also</span>
<a href="#l15.7"></a><span id="l15.7">  * updated in mailing lists that that contact belongs to.</span>
<a href="#l15.8"></a><span id="l15.8">  */</span>
<a href="#l15.9"></a><span id="l15.9"> </span>
<a href="#l15.10"></a><span id="l15.10"> &quot;use strict&quot;;</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-var MODULE_NAME = 'test-update-mailing-list';</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-address-book-helpers.js */</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l15.15"></a><span id="l15.15"> </span>
<a href="#l15.16"></a><span id="l15.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineminus">-var MODULE_REQUIRES = ['address-book-helpers',</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineminus">-                       'folder-display-helpers',];</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+var MODULE_NAME = &quot;test-update-mailing-list&quot;;</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l15.21"></a><span id="l15.21" class="difflineplus">+var MODULE_REQUIRES = [&quot;address-book-helpers&quot;, &quot;folder-display-helpers&quot;];</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l15.24"></a><span id="l15.24"> </span>
<a href="#l15.25"></a><span id="l15.25"> function setupModule(module) {</span>
<a href="#l15.26"></a><span id="l15.26" class="difflineminus">-  collector.getModule('folder-display-helpers').installInto(module);</span>
<a href="#l15.27"></a><span id="l15.27" class="difflineminus">-  collector.getModule('address-book-helpers').installInto(module);</span>
<a href="#l15.28"></a><span id="l15.28" class="difflineplus">+  collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineplus">+  collector.getModule(&quot;address-book-helpers&quot;).installInto(module);</span>
<a href="#l15.30"></a><span id="l15.30"> }</span>
<a href="#l15.31"></a><span id="l15.31"> </span>
<a href="#l15.32"></a><span id="l15.32"> function test_contact_in_mailing_list_updated() {</span>
<a href="#l15.33"></a><span id="l15.33">   const kOldAddress = &quot;before@example.com&quot;;</span>
<a href="#l15.34"></a><span id="l15.34">   const kNewAddress = &quot;after@example.com&quot;;</span>
<a href="#l15.35"></a><span id="l15.35"> </span>
<a href="#l15.36"></a><span id="l15.36">   // Create some address book to work with...</span>
<a href="#l15.37"></a><span id="l15.37">   let ab = create_mork_address_book(&quot;Some Address Book&quot;);</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineat">@@ -38,17 +39,17 @@ function test_contact_in_mailing_list_up</span>
<a href="#l15.39"></a><span id="l15.39">   ml.addressLists.appendElement(contact);</span>
<a href="#l15.40"></a><span id="l15.40">   ml = ab.addMailList(ml);</span>
<a href="#l15.41"></a><span id="l15.41"> </span>
<a href="#l15.42"></a><span id="l15.42">   contact = ml.addressLists.queryElementAt(0, Ci.nsIAbCard);</span>
<a href="#l15.43"></a><span id="l15.43"> </span>
<a href="#l15.44"></a><span id="l15.44">   // Open the address book, select our contact...</span>
<a href="#l15.45"></a><span id="l15.45">   let abw = open_address_book_window(mc);</span>
<a href="#l15.46"></a><span id="l15.46">   select_address_book(ab);</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-  select_contact(contact);</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineplus">+  select_contacts(contact);</span>
<a href="#l15.49"></a><span id="l15.49"> </span>
<a href="#l15.50"></a><span id="l15.50">   // Change the primary email address of the contact...</span>
<a href="#l15.51"></a><span id="l15.51">   edit_selected_contact(abw, function(ecw) {</span>
<a href="#l15.52"></a><span id="l15.52">     ecw.e(&quot;PrimaryEmail&quot;).value = kNewAddress;</span>
<a href="#l15.53"></a><span id="l15.53">     accept_contact_changes(ecw);</span>
<a href="#l15.54"></a><span id="l15.54">   });</span>
<a href="#l15.55"></a><span id="l15.55"> </span>
<a href="#l15.56"></a><span id="l15.56">   // Because the current address book is kind of lame, in order</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment-events.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mail/test/mozmill/attachment/test-attachment-events.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -3,25 +3,33 @@</span>
<a href="#l16.4"></a><span id="l16.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l16.5"></a><span id="l16.5"> </span>
<a href="#l16.6"></a><span id="l16.6"> /**</span>
<a href="#l16.7"></a><span id="l16.7">  * Ensures that attachment events are fired properly</span>
<a href="#l16.8"></a><span id="l16.8">  */</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10"> &quot;use strict&quot;;</span>
<a href="#l16.11"></a><span id="l16.11"> </span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-var MODULE_NAME = 'test-attachment-events';</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-attachment-helpers.js */</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-observer-helpers.js */</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-prompt-helpers.js */</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-                       'compose-helpers',</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-                       'window-helpers',</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-                       'attachment-helpers',</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-                       'observer-helpers',</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-                       'prompt-helpers'];</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineplus">+var MODULE_NAME = &quot;test-attachment-events&quot;;</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineplus">+  &quot;attachment-helpers&quot;,</span>
<a href="#l16.34"></a><span id="l16.34" class="difflineplus">+  &quot;observer-helpers&quot;,</span>
<a href="#l16.35"></a><span id="l16.35" class="difflineplus">+  &quot;prompt-helpers&quot;,</span>
<a href="#l16.36"></a><span id="l16.36" class="difflineplus">+];</span>
<a href="#l16.37"></a><span id="l16.37"> </span>
<a href="#l16.38"></a><span id="l16.38"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l16.39"></a><span id="l16.39"> </span>
<a href="#l16.40"></a><span id="l16.40"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l16.41"></a><span id="l16.41"> var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l16.42"></a><span id="l16.42"> </span>
<a href="#l16.43"></a><span id="l16.43"> var kAttachmentsAdded = &quot;attachments-added&quot;;</span>
<a href="#l16.44"></a><span id="l16.44"> var kAttachmentsRemoved = &quot;attachments-removed&quot;;</span>
<a href="#l16.45"></a><span id="l16.45" class="difflineat">@@ -43,46 +51,46 @@ function setupModule(module) {</span>
<a href="#l16.46"></a><span id="l16.46">  */</span>
<a href="#l16.47"></a><span id="l16.47"> function test_attachments_added_on_single() {</span>
<a href="#l16.48"></a><span id="l16.48">   // Prepare to listen for attachments-added</span>
<a href="#l16.49"></a><span id="l16.49">   let eventCount = 0;</span>
<a href="#l16.50"></a><span id="l16.50">   let lastEvent;</span>
<a href="#l16.51"></a><span id="l16.51">   let listener = function(event) {</span>
<a href="#l16.52"></a><span id="l16.52">     eventCount++;</span>
<a href="#l16.53"></a><span id="l16.53">     lastEvent = event;</span>
<a href="#l16.54"></a><span id="l16.54" class="difflineminus">-  }</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineplus">+  };</span>
<a href="#l16.56"></a><span id="l16.56"> </span>
<a href="#l16.57"></a><span id="l16.57">   // Open up the compose window</span>
<a href="#l16.58"></a><span id="l16.58">   let cw = open_compose_new_mail(mc);</span>
<a href="#l16.59"></a><span id="l16.59">   cw.e(&quot;attachmentBucket&quot;).addEventListener(kAttachmentsAdded, listener);</span>
<a href="#l16.60"></a><span id="l16.60"> </span>
<a href="#l16.61"></a><span id="l16.61">   // Attach a single file</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineminus">-  add_attachment(cw, &quot;http://www.example.com/1&quot;, 0, false);</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+  add_attachments(cw, &quot;http://www.example.com/1&quot;, 0, false);</span>
<a href="#l16.64"></a><span id="l16.64"> </span>
<a href="#l16.65"></a><span id="l16.65">   // Make sure we only saw the event once</span>
<a href="#l16.66"></a><span id="l16.66">   assert_equals(1, eventCount);</span>
<a href="#l16.67"></a><span id="l16.67"> </span>
<a href="#l16.68"></a><span id="l16.68">   // Make sure that we were passed the right subject</span>
<a href="#l16.69"></a><span id="l16.69">   let subjects = lastEvent.detail;</span>
<a href="#l16.70"></a><span id="l16.70">   assert_true(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l16.71"></a><span id="l16.71">   assert_equals(&quot;http://www.example.com/1&quot;,</span>
<a href="#l16.72"></a><span id="l16.72">                 subjects.queryElementAt(0, Ci.nsIMsgAttachment).url);</span>
<a href="#l16.73"></a><span id="l16.73"> </span>
<a href="#l16.74"></a><span id="l16.74">   // Make sure that we can get that event again if we</span>
<a href="#l16.75"></a><span id="l16.75">   // attach more files.</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineminus">-  add_attachment(cw, &quot;http://www.example.com/2&quot;, 0, false);</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+  add_attachments(cw, &quot;http://www.example.com/2&quot;, 0, false);</span>
<a href="#l16.78"></a><span id="l16.78">   assert_equals(2, eventCount);</span>
<a href="#l16.79"></a><span id="l16.79">   subjects = lastEvent.detail;</span>
<a href="#l16.80"></a><span id="l16.80">   assert_true(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l16.81"></a><span id="l16.81">   assert_equals(&quot;http://www.example.com/2&quot;,</span>
<a href="#l16.82"></a><span id="l16.82">                 subjects.queryElementAt(0, Ci.nsIMsgAttachment).url);</span>
<a href="#l16.83"></a><span id="l16.83"> </span>
<a href="#l16.84"></a><span id="l16.84">   // And check that we don't receive the event if we try to attach a file</span>
<a href="#l16.85"></a><span id="l16.85">   // that's already attached.</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineminus">-  add_attachment(cw, &quot;http://www.example.com/2&quot;, null, false);</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+  add_attachments(cw, &quot;http://www.example.com/2&quot;, null, false);</span>
<a href="#l16.88"></a><span id="l16.88">   assert_equals(2, eventCount);</span>
<a href="#l16.89"></a><span id="l16.89"> </span>
<a href="#l16.90"></a><span id="l16.90">   cw.e(&quot;attachmentBucket&quot;).removeEventListener(kAttachmentsAdded, listener);</span>
<a href="#l16.91"></a><span id="l16.91">   close_compose_window(cw);</span>
<a href="#l16.92"></a><span id="l16.92"> }</span>
<a href="#l16.93"></a><span id="l16.93"> </span>
<a href="#l16.94"></a><span id="l16.94"> /**</span>
<a href="#l16.95"></a><span id="l16.95">  * Test that the attachments-added event is fired when we add a series</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineat">@@ -90,17 +98,17 @@ function test_attachments_added_on_singl</span>
<a href="#l16.97"></a><span id="l16.97">  */</span>
<a href="#l16.98"></a><span id="l16.98"> function test_attachments_added_on_multiple() {</span>
<a href="#l16.99"></a><span id="l16.99">   // Prepare to listen for attachments-added</span>
<a href="#l16.100"></a><span id="l16.100">   let eventCount = 0;</span>
<a href="#l16.101"></a><span id="l16.101">   let lastEvent;</span>
<a href="#l16.102"></a><span id="l16.102">   let listener = function(event) {</span>
<a href="#l16.103"></a><span id="l16.103">     eventCount++;</span>
<a href="#l16.104"></a><span id="l16.104">     lastEvent = event;</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-  }</span>
<a href="#l16.106"></a><span id="l16.106" class="difflineplus">+  };</span>
<a href="#l16.107"></a><span id="l16.107"> </span>
<a href="#l16.108"></a><span id="l16.108">   // Prepare the attachments - we store the names in attachmentNames to</span>
<a href="#l16.109"></a><span id="l16.109">   // make sure that we observed the right event subjects later on.</span>
<a href="#l16.110"></a><span id="l16.110">   let attachmentUrls = [&quot;http://www.example.com/1&quot;,</span>
<a href="#l16.111"></a><span id="l16.111">                         &quot;http://www.example.com/2&quot;];</span>
<a href="#l16.112"></a><span id="l16.112"> </span>
<a href="#l16.113"></a><span id="l16.113">   // Open the compose window and add the attachments</span>
<a href="#l16.114"></a><span id="l16.114">   let cw = open_compose_new_mail(mc);</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineat">@@ -161,46 +169,44 @@ function test_attachments_added_on_multi</span>
<a href="#l16.116"></a><span id="l16.116">  */</span>
<a href="#l16.117"></a><span id="l16.117"> function test_attachments_removed_on_single() {</span>
<a href="#l16.118"></a><span id="l16.118">   // Prepare to listen for attachments-removed</span>
<a href="#l16.119"></a><span id="l16.119">   let eventCount = 0;</span>
<a href="#l16.120"></a><span id="l16.120">   let lastEvent;</span>
<a href="#l16.121"></a><span id="l16.121">   let listener = function(event) {</span>
<a href="#l16.122"></a><span id="l16.122">     eventCount++;</span>
<a href="#l16.123"></a><span id="l16.123">     lastEvent = event;</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-  }</span>
<a href="#l16.125"></a><span id="l16.125" class="difflineplus">+  };</span>
<a href="#l16.126"></a><span id="l16.126"> </span>
<a href="#l16.127"></a><span id="l16.127"> </span>
<a href="#l16.128"></a><span id="l16.128">   // Open up the compose window, attach a file...</span>
<a href="#l16.129"></a><span id="l16.129">   let cw = open_compose_new_mail(mc);</span>
<a href="#l16.130"></a><span id="l16.130">   cw.e(&quot;attachmentBucket&quot;).addEventListener(kAttachmentsRemoved, listener);</span>
<a href="#l16.131"></a><span id="l16.131"> </span>
<a href="#l16.132"></a><span id="l16.132" class="difflineminus">-  add_attachment(cw, &quot;http://www.example.com/1&quot;);</span>
<a href="#l16.133"></a><span id="l16.133" class="difflineplus">+  add_attachments(cw, &quot;http://www.example.com/1&quot;);</span>
<a href="#l16.134"></a><span id="l16.134"> </span>
<a href="#l16.135"></a><span id="l16.135">   // Now select that attachment and delete it</span>
<a href="#l16.136"></a><span id="l16.136" class="difflineminus">-  let removedAttachmentItem = select_attachments(cw, 0);</span>
<a href="#l16.137"></a><span id="l16.137" class="difflineplus">+  select_attachments(cw, 0);</span>
<a href="#l16.138"></a><span id="l16.138">   // We need to hold a reference to removedAttachment here because</span>
<a href="#l16.139"></a><span id="l16.139">   // the delete routine nulls it out from the attachmentitem.</span>
<a href="#l16.140"></a><span id="l16.140" class="difflineminus">-  let removedAttachment = removedAttachmentItem[0].attachment;</span>
<a href="#l16.141"></a><span id="l16.141">   cw.window.goDoCommand(&quot;cmd_delete&quot;);</span>
<a href="#l16.142"></a><span id="l16.142">   // Make sure we saw the event</span>
<a href="#l16.143"></a><span id="l16.143">   assert_equals(1, eventCount);</span>
<a href="#l16.144"></a><span id="l16.144">   // And make sure we were passed the right attachment item as the</span>
<a href="#l16.145"></a><span id="l16.145">   // subject.</span>
<a href="#l16.146"></a><span id="l16.146">   let subjects = lastEvent.detail;</span>
<a href="#l16.147"></a><span id="l16.147">   assert_true(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l16.148"></a><span id="l16.148">   assert_equals(1, subjects.length);</span>
<a href="#l16.149"></a><span id="l16.149">   assert_equals(subjects.queryElementAt(0, Ci.nsIMsgAttachment).url,</span>
<a href="#l16.150"></a><span id="l16.150">                 &quot;http://www.example.com/1&quot;);</span>
<a href="#l16.151"></a><span id="l16.151"> </span>
<a href="#l16.152"></a><span id="l16.152">   // Ok, let's attach it again, and remove it again to ensure that</span>
<a href="#l16.153"></a><span id="l16.153">   // we still see the event.</span>
<a href="#l16.154"></a><span id="l16.154" class="difflineminus">-  add_attachment(cw, &quot;http://www.example.com/2&quot;);</span>
<a href="#l16.155"></a><span id="l16.155" class="difflineminus">-  removedAttachmentItem = select_attachments(cw, 0);</span>
<a href="#l16.156"></a><span id="l16.156" class="difflineminus">-  removedAttachment = removedAttachmentItem[0].attachment;</span>
<a href="#l16.157"></a><span id="l16.157" class="difflineplus">+  add_attachments(cw, &quot;http://www.example.com/2&quot;);</span>
<a href="#l16.158"></a><span id="l16.158" class="difflineplus">+  select_attachments(cw, 0);</span>
<a href="#l16.159"></a><span id="l16.159">   cw.window.goDoCommand(&quot;cmd_delete&quot;);</span>
<a href="#l16.160"></a><span id="l16.160"> </span>
<a href="#l16.161"></a><span id="l16.161">   assert_equals(2, eventCount);</span>
<a href="#l16.162"></a><span id="l16.162">   subjects = lastEvent.detail;</span>
<a href="#l16.163"></a><span id="l16.163">   assert_true(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l16.164"></a><span id="l16.164">   assert_equals(1, subjects.length);</span>
<a href="#l16.165"></a><span id="l16.165">   assert_equals(subjects.queryElementAt(0, Ci.nsIMsgAttachment).url,</span>
<a href="#l16.166"></a><span id="l16.166">                 &quot;http://www.example.com/2&quot;);</span>
<a href="#l16.167"></a><span id="l16.167" class="difflineat">@@ -215,17 +221,17 @@ function test_attachments_removed_on_sin</span>
<a href="#l16.168"></a><span id="l16.168">  */</span>
<a href="#l16.169"></a><span id="l16.169"> function test_attachments_removed_on_multiple() {</span>
<a href="#l16.170"></a><span id="l16.170">   // Prepare to listen for attachments-removed</span>
<a href="#l16.171"></a><span id="l16.171">   let eventCount = 0;</span>
<a href="#l16.172"></a><span id="l16.172">   let lastEvent;</span>
<a href="#l16.173"></a><span id="l16.173">   let listener = function(event) {</span>
<a href="#l16.174"></a><span id="l16.174">     eventCount++;</span>
<a href="#l16.175"></a><span id="l16.175">     lastEvent = event;</span>
<a href="#l16.176"></a><span id="l16.176" class="difflineminus">-  }</span>
<a href="#l16.177"></a><span id="l16.177" class="difflineplus">+  };</span>
<a href="#l16.178"></a><span id="l16.178"> </span>
<a href="#l16.179"></a><span id="l16.179">   // Open up the compose window and attach some files...</span>
<a href="#l16.180"></a><span id="l16.180">   let cw = open_compose_new_mail(mc);</span>
<a href="#l16.181"></a><span id="l16.181">   cw.e(&quot;attachmentBucket&quot;).addEventListener(kAttachmentsRemoved, listener);</span>
<a href="#l16.182"></a><span id="l16.182"> </span>
<a href="#l16.183"></a><span id="l16.183">   add_attachments(cw, [&quot;http://www.example.com/1&quot;,</span>
<a href="#l16.184"></a><span id="l16.184">                        &quot;http://www.example.com/2&quot;,</span>
<a href="#l16.185"></a><span id="l16.185">                        &quot;http://www.example.com/3&quot;]);</span>
<a href="#l16.186"></a><span id="l16.186" class="difflineat">@@ -266,21 +272,19 @@ function test_attachments_removed_on_mul</span>
<a href="#l16.187"></a><span id="l16.187"> </span>
<a href="#l16.188"></a><span id="l16.188"> /**</span>
<a href="#l16.189"></a><span id="l16.189">  * Test that we don't see the attachments-removed event if no attachments</span>
<a href="#l16.190"></a><span id="l16.190">  * are selected when hitting &quot;Delete&quot;</span>
<a href="#l16.191"></a><span id="l16.191">  */</span>
<a href="#l16.192"></a><span id="l16.192"> function test_no_attachments_removed_on_none() {</span>
<a href="#l16.193"></a><span id="l16.193">   // Prepare to listen for attachments-removed</span>
<a href="#l16.194"></a><span id="l16.194">   let eventCount = 0;</span>
<a href="#l16.195"></a><span id="l16.195" class="difflineminus">-  let lastEvent;</span>
<a href="#l16.196"></a><span id="l16.196">   let listener = function(event) {</span>
<a href="#l16.197"></a><span id="l16.197">     eventCount++;</span>
<a href="#l16.198"></a><span id="l16.198" class="difflineminus">-    lastEvent = event;</span>
<a href="#l16.199"></a><span id="l16.199" class="difflineminus">-  }</span>
<a href="#l16.200"></a><span id="l16.200" class="difflineplus">+  };</span>
<a href="#l16.201"></a><span id="l16.201"> </span>
<a href="#l16.202"></a><span id="l16.202">   // Open the compose window and add some attachments.</span>
<a href="#l16.203"></a><span id="l16.203">   let cw = open_compose_new_mail(mc);</span>
<a href="#l16.204"></a><span id="l16.204">   cw.e(&quot;attachmentBucket&quot;).addEventListener(kAttachmentsRemoved, listener);</span>
<a href="#l16.205"></a><span id="l16.205"> </span>
<a href="#l16.206"></a><span id="l16.206">   add_attachments(cw, [&quot;http://www.example.com/1&quot;,</span>
<a href="#l16.207"></a><span id="l16.207">                        &quot;http://www.example.com/2&quot;,</span>
<a href="#l16.208"></a><span id="l16.208">                        &quot;http://www.example.com/3&quot;]);</span>
<a href="#l16.209"></a><span id="l16.209" class="difflineat">@@ -307,17 +311,17 @@ function test_attachment_renamed() {</span>
<a href="#l16.210"></a><span id="l16.210">   const kRenameTo3 = &quot;Renamed-3&quot;;</span>
<a href="#l16.211"></a><span id="l16.211"> </span>
<a href="#l16.212"></a><span id="l16.212">   // Prepare to listen for attachment-renamed</span>
<a href="#l16.213"></a><span id="l16.213">   let eventCount = 0;</span>
<a href="#l16.214"></a><span id="l16.214">   let lastEvent;</span>
<a href="#l16.215"></a><span id="l16.215">   let listener = function(event) {</span>
<a href="#l16.216"></a><span id="l16.216">     eventCount++;</span>
<a href="#l16.217"></a><span id="l16.217">     lastEvent = event;</span>
<a href="#l16.218"></a><span id="l16.218" class="difflineminus">-  }</span>
<a href="#l16.219"></a><span id="l16.219" class="difflineplus">+  };</span>
<a href="#l16.220"></a><span id="l16.220"> </span>
<a href="#l16.221"></a><span id="l16.221">   // Renaming a file brings up a Prompt, so we'll mock the Prompt Service</span>
<a href="#l16.222"></a><span id="l16.222">   gMockPromptService.reset();</span>
<a href="#l16.223"></a><span id="l16.223">   gMockPromptService.register();</span>
<a href="#l16.224"></a><span id="l16.224">   // The inoutValue is used to set the attachment name</span>
<a href="#l16.225"></a><span id="l16.225">   gMockPromptService.inoutValue = kRenameTo1;</span>
<a href="#l16.226"></a><span id="l16.226">   gMockPromptService.returnValue = true;</span>
<a href="#l16.227"></a><span id="l16.227"> </span>
<a href="#l16.228"></a><span id="l16.228" class="difflineat">@@ -387,21 +391,19 @@ function test_attachment_renamed() {</span>
<a href="#l16.229"></a><span id="l16.229"> </span>
<a href="#l16.230"></a><span id="l16.230"> /**</span>
<a href="#l16.231"></a><span id="l16.231">  * Test that the attachment-renamed event is not fired if we set the</span>
<a href="#l16.232"></a><span id="l16.232">  * filename to be blank.</span>
<a href="#l16.233"></a><span id="l16.233">  */</span>
<a href="#l16.234"></a><span id="l16.234"> function test_no_attachment_renamed_on_blank() {</span>
<a href="#l16.235"></a><span id="l16.235">   // Prepare to listen for attachment-renamed</span>
<a href="#l16.236"></a><span id="l16.236">   let eventCount = 0;</span>
<a href="#l16.237"></a><span id="l16.237" class="difflineminus">-  let lastEvent;</span>
<a href="#l16.238"></a><span id="l16.238">   let listener = function(event) {</span>
<a href="#l16.239"></a><span id="l16.239">     eventCount++;</span>
<a href="#l16.240"></a><span id="l16.240" class="difflineminus">-    lastEvent = event;</span>
<a href="#l16.241"></a><span id="l16.241" class="difflineminus">-  }</span>
<a href="#l16.242"></a><span id="l16.242" class="difflineplus">+  };</span>
<a href="#l16.243"></a><span id="l16.243"> </span>
<a href="#l16.244"></a><span id="l16.244">   // Register the Mock Prompt Service to return the empty string when</span>
<a href="#l16.245"></a><span id="l16.245">   // prompted.</span>
<a href="#l16.246"></a><span id="l16.246">   gMockPromptService.reset();</span>
<a href="#l16.247"></a><span id="l16.247">   gMockPromptService.register();</span>
<a href="#l16.248"></a><span id="l16.248">   gMockPromptService.inoutValue = &quot;&quot;;</span>
<a href="#l16.249"></a><span id="l16.249">   gMockPromptService.returnValue = true;</span>
<a href="#l16.250"></a><span id="l16.250"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -1,21 +1,21 @@</span>
<a href="#l17.4"></a><span id="l17.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.5"></a><span id="l17.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.6"></a><span id="l17.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8" class="difflineminus">-// make SOLO_TEST=attachment/test-attachment-in-plain-msg.js mozmill-one</span>
<a href="#l17.9"></a><span id="l17.9" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l17.10"></a><span id="l17.10"> </span>
<a href="#l17.11"></a><span id="l17.11" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-dom-helpers.js */</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l17.15"></a><span id="l17.15"> </span>
<a href="#l17.16"></a><span id="l17.16"> var MODULE_NAME = &quot;test-attachment-in-plain-msg&quot;;</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineminus">-</span>
<a href="#l17.18"></a><span id="l17.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l17.19"></a><span id="l17.19" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l17.20"></a><span id="l17.20" class="difflineminus">-                       &quot;dom-helpers&quot;];</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;dom-helpers&quot;];</span>
<a href="#l17.22"></a><span id="l17.22"> </span>
<a href="#l17.23"></a><span id="l17.23"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l17.24"></a><span id="l17.24"> </span>
<a href="#l17.25"></a><span id="l17.25"> function setupModule(module) {</span>
<a href="#l17.26"></a><span id="l17.26">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l17.27"></a><span id="l17.27">     collector.getModule(lib).installInto(module);</span>
<a href="#l17.28"></a><span id="l17.28">   }</span>
<a href="#l17.29"></a><span id="l17.29"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment-menus.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mail/test/mozmill/attachment/test-attachment-menus.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,19 +1,21 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.5"></a><span id="l18.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.6"></a><span id="l18.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.7"></a><span id="l18.7"> </span>
<a href="#l18.8"></a><span id="l18.8"> &quot;use strict&quot;;</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+/* import-globals-from ../shared-modules/test-attachment-helpers.js */</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+</span>
<a href="#l18.14"></a><span id="l18.14"> var MODULE_NAME = &quot;test-attachment-menus&quot;;</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-</span>
<a href="#l18.16"></a><span id="l18.16"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineminus">-                       &quot;attachment-helpers&quot;];</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;attachment-helpers&quot;];</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21"> var folder;</span>
<a href="#l18.22"></a><span id="l18.22"> var messenger;</span>
<a href="#l18.23"></a><span id="l18.23"> var epsilon;</span>
<a href="#l18.24"></a><span id="l18.24"> </span>
<a href="#l18.25"></a><span id="l18.25"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l18.26"></a><span id="l18.26"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l18.27"></a><span id="l18.27"> var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineat">@@ -291,68 +293,62 @@ function assert_enabled(id, enabled) {</span>
<a href="#l18.29"></a><span id="l18.29">  * Check that the menu states in the &quot;save&quot; toolbar button are correct.</span>
<a href="#l18.30"></a><span id="l18.30">  *</span>
<a href="#l18.31"></a><span id="l18.31">  * @param expected a dictionary containing the expected states</span>
<a href="#l18.32"></a><span id="l18.32">  */</span>
<a href="#l18.33"></a><span id="l18.33"> function check_toolbar_menu_states_single(expected) {</span>
<a href="#l18.34"></a><span id="l18.34">   assert_shown(&quot;attachmentSaveAllSingle&quot;, true);</span>
<a href="#l18.35"></a><span id="l18.35">   assert_shown(&quot;attachmentSaveAllMultiple&quot;, false);</span>
<a href="#l18.36"></a><span id="l18.36"> </span>
<a href="#l18.37"></a><span id="l18.37" class="difflineminus">-  if (expected.save == false) {</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+  if (expected.save === false) {</span>
<a href="#l18.39"></a><span id="l18.39">     assert_enabled(&quot;attachmentSaveAllSingle&quot;, false);</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-  }</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineminus">-  else {</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+  } else {</span>
<a href="#l18.43"></a><span id="l18.43">     assert_enabled(&quot;attachmentSaveAllSingle&quot;, true);</span>
<a href="#l18.44"></a><span id="l18.44">     mc.click(mc.aid(&quot;attachmentSaveAllSingle&quot;,</span>
<a href="#l18.45"></a><span id="l18.45">                     {&quot;class&quot;: &quot;toolbarbutton-menubutton-dropmarker&quot;}));</span>
<a href="#l18.46"></a><span id="l18.46">     wait_for_popup_to_open(mc.e(&quot;attachmentSaveAllSingleMenu&quot;));</span>
<a href="#l18.47"></a><span id="l18.47"> </span>
<a href="#l18.48"></a><span id="l18.48">     try {</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineminus">-      assert_enabled(&quot;button-openAttachment&quot;,   expected.open);</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineminus">-      assert_enabled(&quot;button-saveAttachment&quot;,   expected.save);</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+      assert_enabled(&quot;button-openAttachment&quot;, expected.open);</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+      assert_enabled(&quot;button-saveAttachment&quot;, expected.save);</span>
<a href="#l18.53"></a><span id="l18.53">       assert_enabled(&quot;button-detachAttachment&quot;, expected.detach);</span>
<a href="#l18.54"></a><span id="l18.54">       assert_enabled(&quot;button-deleteAttachment&quot;, expected.delete_);</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineminus">-    }</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineminus">-    catch(e) {</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+    } catch (e) {</span>
<a href="#l18.58"></a><span id="l18.58">       throw e;</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineminus">-    }</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineminus">-    finally {</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+    } finally {</span>
<a href="#l18.62"></a><span id="l18.62">       close_popup(mc, mc.eid(&quot;attachmentSaveAllSingleMenu&quot;));</span>
<a href="#l18.63"></a><span id="l18.63">     }</span>
<a href="#l18.64"></a><span id="l18.64">   }</span>
<a href="#l18.65"></a><span id="l18.65"> }</span>
<a href="#l18.66"></a><span id="l18.66"> </span>
<a href="#l18.67"></a><span id="l18.67"> /**</span>
<a href="#l18.68"></a><span id="l18.68">  * Check that the menu states in the &quot;save all&quot; toolbar button are correct.</span>
<a href="#l18.69"></a><span id="l18.69">  *</span>
<a href="#l18.70"></a><span id="l18.70">  * @param expected a dictionary containing the expected states</span>
<a href="#l18.71"></a><span id="l18.71">  */</span>
<a href="#l18.72"></a><span id="l18.72"> function check_toolbar_menu_states_multiple(expected) {</span>
<a href="#l18.73"></a><span id="l18.73">   assert_shown(&quot;attachmentSaveAllSingle&quot;, false);</span>
<a href="#l18.74"></a><span id="l18.74">   assert_shown(&quot;attachmentSaveAllMultiple&quot;, true);</span>
<a href="#l18.75"></a><span id="l18.75"> </span>
<a href="#l18.76"></a><span id="l18.76" class="difflineminus">-  if (expected.save == false) {</span>
<a href="#l18.77"></a><span id="l18.77" class="difflineplus">+  if (expected.save === false) {</span>
<a href="#l18.78"></a><span id="l18.78">     assert_enabled(&quot;attachmentSaveAllMultiple&quot;, false);</span>
<a href="#l18.79"></a><span id="l18.79" class="difflineminus">-  }</span>
<a href="#l18.80"></a><span id="l18.80" class="difflineminus">-  else {</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineplus">+  } else {</span>
<a href="#l18.82"></a><span id="l18.82">     assert_enabled(&quot;attachmentSaveAllMultiple&quot;, true);</span>
<a href="#l18.83"></a><span id="l18.83">     mc.click(mc.aid(&quot;attachmentSaveAllMultiple&quot;,</span>
<a href="#l18.84"></a><span id="l18.84">                     {&quot;class&quot;: &quot;toolbarbutton-menubutton-dropmarker&quot;}));</span>
<a href="#l18.85"></a><span id="l18.85">     wait_for_popup_to_open(mc.e(&quot;attachmentSaveAllMultipleMenu&quot;));</span>
<a href="#l18.86"></a><span id="l18.86"> </span>
<a href="#l18.87"></a><span id="l18.87">     try {</span>
<a href="#l18.88"></a><span id="l18.88" class="difflineminus">-      assert_enabled(&quot;button-openAllAttachments&quot;,   expected.open);</span>
<a href="#l18.89"></a><span id="l18.89" class="difflineminus">-      assert_enabled(&quot;button-saveAllAttachments&quot;,   expected.save);</span>
<a href="#l18.90"></a><span id="l18.90" class="difflineplus">+      assert_enabled(&quot;button-openAllAttachments&quot;, expected.open);</span>
<a href="#l18.91"></a><span id="l18.91" class="difflineplus">+      assert_enabled(&quot;button-saveAllAttachments&quot;, expected.save);</span>
<a href="#l18.92"></a><span id="l18.92">       assert_enabled(&quot;button-detachAllAttachments&quot;, expected.detach);</span>
<a href="#l18.93"></a><span id="l18.93">       assert_enabled(&quot;button-deleteAllAttachments&quot;, expected.delete_);</span>
<a href="#l18.94"></a><span id="l18.94" class="difflineminus">-    }</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineminus">-    catch(e) {</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+    } catch (e) {</span>
<a href="#l18.97"></a><span id="l18.97">       throw e;</span>
<a href="#l18.98"></a><span id="l18.98" class="difflineminus">-    }</span>
<a href="#l18.99"></a><span id="l18.99" class="difflineminus">-    finally {</span>
<a href="#l18.100"></a><span id="l18.100" class="difflineplus">+    } finally {</span>
<a href="#l18.101"></a><span id="l18.101">       close_popup(mc, mc.eid(&quot;attachmentSaveAllMultipleMenu&quot;));</span>
<a href="#l18.102"></a><span id="l18.102">     }</span>
<a href="#l18.103"></a><span id="l18.103">   }</span>
<a href="#l18.104"></a><span id="l18.104"> }</span>
<a href="#l18.105"></a><span id="l18.105"> </span>
<a href="#l18.106"></a><span id="l18.106"> /**</span>
<a href="#l18.107"></a><span id="l18.107">  * Check that the menu states in the single item context menu are correct</span>
<a href="#l18.108"></a><span id="l18.108">  *</span>
<a href="#l18.109"></a><span id="l18.109" class="difflineat">@@ -372,31 +368,29 @@ function check_menu_states_single(index,</span>
<a href="#l18.110"></a><span id="l18.110">                                                     &quot;attachmentcell-nameselection&quot;);</span>
<a href="#l18.111"></a><span id="l18.111"> </span>
<a href="#l18.112"></a><span id="l18.112">   attachmentList.selectItem(node);</span>
<a href="#l18.113"></a><span id="l18.113">   let menu = mc.getMenu(&quot;#attachmentItemContext&quot;);</span>
<a href="#l18.114"></a><span id="l18.114">   menu.open(new elib.Elem(clickable));</span>
<a href="#l18.115"></a><span id="l18.115">   wait_for_popup_to_open(mc.e(&quot;attachmentItemContext&quot;));</span>
<a href="#l18.116"></a><span id="l18.116"> </span>
<a href="#l18.117"></a><span id="l18.117">   try {</span>
<a href="#l18.118"></a><span id="l18.118" class="difflineminus">-    assert_shown(&quot;context-openAttachment&quot;,   true);</span>
<a href="#l18.119"></a><span id="l18.119" class="difflineminus">-    assert_shown(&quot;context-saveAttachment&quot;,   true);</span>
<a href="#l18.120"></a><span id="l18.120" class="difflineminus">-    assert_shown(&quot;context-menu-separator&quot;,   true);</span>
<a href="#l18.121"></a><span id="l18.121" class="difflineplus">+    assert_shown(&quot;context-openAttachment&quot;, true);</span>
<a href="#l18.122"></a><span id="l18.122" class="difflineplus">+    assert_shown(&quot;context-saveAttachment&quot;, true);</span>
<a href="#l18.123"></a><span id="l18.123" class="difflineplus">+    assert_shown(&quot;context-menu-separator&quot;, true);</span>
<a href="#l18.124"></a><span id="l18.124">     assert_shown(&quot;context-detachAttachment&quot;, true);</span>
<a href="#l18.125"></a><span id="l18.125">     assert_shown(&quot;context-deleteAttachment&quot;, true);</span>
<a href="#l18.126"></a><span id="l18.126"> </span>
<a href="#l18.127"></a><span id="l18.127" class="difflineminus">-    assert_enabled(&quot;context-openAttachment&quot;,   expected.open);</span>
<a href="#l18.128"></a><span id="l18.128" class="difflineminus">-    assert_enabled(&quot;context-saveAttachment&quot;,   expected.save);</span>
<a href="#l18.129"></a><span id="l18.129" class="difflineplus">+    assert_enabled(&quot;context-openAttachment&quot;, expected.open);</span>
<a href="#l18.130"></a><span id="l18.130" class="difflineplus">+    assert_enabled(&quot;context-saveAttachment&quot;, expected.save);</span>
<a href="#l18.131"></a><span id="l18.131">     assert_enabled(&quot;context-detachAttachment&quot;, expected.detach);</span>
<a href="#l18.132"></a><span id="l18.132">     assert_enabled(&quot;context-deleteAttachment&quot;, expected.delete_);</span>
<a href="#l18.133"></a><span id="l18.133" class="difflineminus">-  }</span>
<a href="#l18.134"></a><span id="l18.134" class="difflineminus">-  catch(e) {</span>
<a href="#l18.135"></a><span id="l18.135" class="difflineplus">+  } catch (e) {</span>
<a href="#l18.136"></a><span id="l18.136">     throw e;</span>
<a href="#l18.137"></a><span id="l18.137" class="difflineminus">-  }</span>
<a href="#l18.138"></a><span id="l18.138" class="difflineminus">-  finally {</span>
<a href="#l18.139"></a><span id="l18.139" class="difflineplus">+  } finally {</span>
<a href="#l18.140"></a><span id="l18.140">     menu.close();</span>
<a href="#l18.141"></a><span id="l18.141">   }</span>
<a href="#l18.142"></a><span id="l18.142"> }</span>
<a href="#l18.143"></a><span id="l18.143"> </span>
<a href="#l18.144"></a><span id="l18.144"> /**</span>
<a href="#l18.145"></a><span id="l18.145">  * Check that the menu states in the all items context menu are correct</span>
<a href="#l18.146"></a><span id="l18.146">  *</span>
<a href="#l18.147"></a><span id="l18.147">  * @param expected a dictionary containing the expected states</span>
<a href="#l18.148"></a><span id="l18.148" class="difflineat">@@ -404,38 +398,36 @@ function check_menu_states_single(index,</span>
<a href="#l18.149"></a><span id="l18.149"> function check_menu_states_all(expected) {</span>
<a href="#l18.150"></a><span id="l18.150">   // Using a rightClick here is unsafe, because we need to hit the empty area</span>
<a href="#l18.151"></a><span id="l18.151">   // beside the attachment items and that seems to be different per platform.</span>
<a href="#l18.152"></a><span id="l18.152">   // Using DOM methods to open the popup works fine.</span>
<a href="#l18.153"></a><span id="l18.153">   mc.e(&quot;attachmentListContext&quot;).openPopup(mc.e(&quot;attachmentList&quot;));</span>
<a href="#l18.154"></a><span id="l18.154">   wait_for_popup_to_open(mc.e(&quot;attachmentListContext&quot;));</span>
<a href="#l18.155"></a><span id="l18.155"> </span>
<a href="#l18.156"></a><span id="l18.156">   try {</span>
<a href="#l18.157"></a><span id="l18.157" class="difflineminus">-    assert_shown(&quot;context-openAllAttachments&quot;,   true);</span>
<a href="#l18.158"></a><span id="l18.158" class="difflineminus">-    assert_shown(&quot;context-saveAllAttachments&quot;,   true);</span>
<a href="#l18.159"></a><span id="l18.159" class="difflineminus">-    assert_shown(&quot;context-menu-separator-all&quot;,   true);</span>
<a href="#l18.160"></a><span id="l18.160" class="difflineplus">+    assert_shown(&quot;context-openAllAttachments&quot;, true);</span>
<a href="#l18.161"></a><span id="l18.161" class="difflineplus">+    assert_shown(&quot;context-saveAllAttachments&quot;, true);</span>
<a href="#l18.162"></a><span id="l18.162" class="difflineplus">+    assert_shown(&quot;context-menu-separator-all&quot;, true);</span>
<a href="#l18.163"></a><span id="l18.163">     assert_shown(&quot;context-detachAllAttachments&quot;, true);</span>
<a href="#l18.164"></a><span id="l18.164">     assert_shown(&quot;context-deleteAllAttachments&quot;, true);</span>
<a href="#l18.165"></a><span id="l18.165"> </span>
<a href="#l18.166"></a><span id="l18.166" class="difflineminus">-    assert_enabled(&quot;context-openAllAttachments&quot;,   expected.open);</span>
<a href="#l18.167"></a><span id="l18.167" class="difflineminus">-    assert_enabled(&quot;context-saveAllAttachments&quot;,   expected.save);</span>
<a href="#l18.168"></a><span id="l18.168" class="difflineplus">+    assert_enabled(&quot;context-openAllAttachments&quot;, expected.open);</span>
<a href="#l18.169"></a><span id="l18.169" class="difflineplus">+    assert_enabled(&quot;context-saveAllAttachments&quot;, expected.save);</span>
<a href="#l18.170"></a><span id="l18.170">     assert_enabled(&quot;context-detachAllAttachments&quot;, expected.detach);</span>
<a href="#l18.171"></a><span id="l18.171">     assert_enabled(&quot;context-deleteAllAttachments&quot;, expected.delete_);</span>
<a href="#l18.172"></a><span id="l18.172" class="difflineminus">-  }</span>
<a href="#l18.173"></a><span id="l18.173" class="difflineminus">-  catch(e) {</span>
<a href="#l18.174"></a><span id="l18.174" class="difflineplus">+  } catch (e) {</span>
<a href="#l18.175"></a><span id="l18.175">     throw e;</span>
<a href="#l18.176"></a><span id="l18.176" class="difflineminus">-  }</span>
<a href="#l18.177"></a><span id="l18.177" class="difflineminus">-  finally {</span>
<a href="#l18.178"></a><span id="l18.178" class="difflineplus">+  } finally {</span>
<a href="#l18.179"></a><span id="l18.179">     close_popup(mc, mc.eid(&quot;attachmentListContext&quot;));</span>
<a href="#l18.180"></a><span id="l18.180">   }</span>
<a href="#l18.181"></a><span id="l18.181"> }</span>
<a href="#l18.182"></a><span id="l18.182"> </span>
<a href="#l18.183"></a><span id="l18.183"> function help_test_attachment_menus(index) {</span>
<a href="#l18.184"></a><span id="l18.184">   be_in_folder(folder);</span>
<a href="#l18.185"></a><span id="l18.185" class="difflineminus">-  let curMessage = select_click_row(index);</span>
<a href="#l18.186"></a><span id="l18.186" class="difflineplus">+  select_click_row(index);</span>
<a href="#l18.187"></a><span id="l18.187">   let expectedStates = messages[index].menuStates;</span>
<a href="#l18.188"></a><span id="l18.188"> </span>
<a href="#l18.189"></a><span id="l18.189">   mc.window.toggleAttachmentList(true);</span>
<a href="#l18.190"></a><span id="l18.190"> </span>
<a href="#l18.191"></a><span id="l18.191">   for (let attachment of mc.window.currentAttachments) {</span>
<a href="#l18.192"></a><span id="l18.192">     // Ensure all attachments are resolved; other than external they already</span>
<a href="#l18.193"></a><span id="l18.193">     // should be.</span>
<a href="#l18.194"></a><span id="l18.194">     attachment.isEmpty();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment-size.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mail/test/mozmill/attachment/test-attachment-size.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -1,19 +1,21 @@</span>
<a href="#l19.4"></a><span id="l19.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l19.5"></a><span id="l19.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l19.6"></a><span id="l19.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l19.7"></a><span id="l19.7"> </span>
<a href="#l19.8"></a><span id="l19.8"> &quot;use strict&quot;;</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10" class="difflineminus">-var MODULE_NAME = 'test-attachment-size';</span>
<a href="#l19.11"></a><span id="l19.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-attachment-helpers.js */</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l19.14"></a><span id="l19.14"> </span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l19.17"></a><span id="l19.17" class="difflineminus">-                       'attachment-helpers'];</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineplus">+var MODULE_NAME = &quot;test-attachment-size&quot;;</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;attachment-helpers&quot;];</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22"> var folder;</span>
<a href="#l19.23"></a><span id="l19.23"> var messenger;</span>
<a href="#l19.24"></a><span id="l19.24"> var epsilon;</span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l19.27"></a><span id="l19.27"> var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l19.28"></a><span id="l19.28"> </span>
<a href="#l19.29"></a><span id="l19.29" class="difflineat">@@ -21,206 +23,206 @@ var textAttachment =</span>
<a href="#l19.30"></a><span id="l19.30">   &quot;Can't make the frug contest, Helen; stomach's upset. I'll fix you, &quot; +</span>
<a href="#l19.31"></a><span id="l19.31">   &quot;Ubik! Ubik drops you back in the thick of things fast. Taken as &quot; +</span>
<a href="#l19.32"></a><span id="l19.32">   &quot;directed, Ubik speeds relief to head and stomach. Remember: Ubik is &quot; +</span>
<a href="#l19.33"></a><span id="l19.33">   &quot;only seconds away. Avoid prolonged use.&quot;;</span>
<a href="#l19.34"></a><span id="l19.34"> </span>
<a href="#l19.35"></a><span id="l19.35"> var binaryAttachment = textAttachment;</span>
<a href="#l19.36"></a><span id="l19.36"> </span>
<a href="#l19.37"></a><span id="l19.37"> var imageAttachment =</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineminus">-  'iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAABHNCSVQICAgIfAhkiAAAAAlwS' +</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineminus">-  'FlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAA' +</span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-  'A5SURBVCiRY/z//z8DKYCJJNXkaGBgYGD4D8NQ5zUgiTVAxeBqSLaBkVRPM0KtIhrQ3km0jwe' +</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-  'SNQAAlmAY+71EgFoAAAAASUVORK5CYII=';</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineplus">+  &quot;iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAABHNCSVQICAgIfAhkiAAAAAlwS&quot; +</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+  &quot;FlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAA&quot; +</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+  &quot;A5SURBVCiRY/z//z8DKYCJJNXkaGBgYGD4D8NQ5zUgiTVAxeBqSLaBkVRPM0KtIhrQ3km0jwe&quot; +</span>
<a href="#l19.45"></a><span id="l19.45" class="difflineplus">+  &quot;SNQAAlmAY+71EgFoAAAAASUVORK5CYII=&quot;;</span>
<a href="#l19.46"></a><span id="l19.46"> var imageSize = 188;</span>
<a href="#l19.47"></a><span id="l19.47"> </span>
<a href="#l19.48"></a><span id="l19.48"> var vcardAttachment =</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-  'YmVnaW46dmNhcmQNCmZuOkppbSBCb2INCm46Qm9iO0ppbQ0KZW1haWw7aW50ZXJuZXQ6Zm9v' +</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineminus">-  'QGJhci5jb20NCnZlcnNpb246Mi4xDQplbmQ6dmNhcmQNCg0K';</span>
<a href="#l19.51"></a><span id="l19.51" class="difflineplus">+  &quot;YmVnaW46dmNhcmQNCmZuOkppbSBCb2INCm46Qm9iO0ppbQ0KZW1haWw7aW50ZXJuZXQ6Zm9v&quot; +</span>
<a href="#l19.52"></a><span id="l19.52" class="difflineplus">+  &quot;QGJhci5jb20NCnZlcnNpb246Mi4xDQplbmQ6dmNhcmQNCg0K&quot;;</span>
<a href="#l19.53"></a><span id="l19.53"> </span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">-var detachedName = './attachment.txt';</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-var missingName = './nonexistent.txt';</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineminus">-var deletedName = 'deleted.txt';</span>
<a href="#l19.57"></a><span id="l19.57" class="difflineplus">+var detachedName = &quot;./attachment.txt&quot;;</span>
<a href="#l19.58"></a><span id="l19.58" class="difflineplus">+var missingName = &quot;./nonexistent.txt&quot;;</span>
<a href="#l19.59"></a><span id="l19.59" class="difflineplus">+var deletedName = &quot;deleted.txt&quot;;</span>
<a href="#l19.60"></a><span id="l19.60"> </span>
<a href="#l19.61"></a><span id="l19.61"> // create some messages that have various types of attachments</span>
<a href="#l19.62"></a><span id="l19.62"> var messages = [</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineminus">-  { name: 'text_attachment',</span>
<a href="#l19.64"></a><span id="l19.64" class="difflineplus">+  { name: &quot;text_attachment&quot;,</span>
<a href="#l19.65"></a><span id="l19.65">     attachments: [{ body: textAttachment,</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-                    filename: 'ubik.txt',</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineminus">-                    format: '' }],</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineplus">+                    filename: &quot;ubik.txt&quot;,</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+                    format: &quot;&quot; }],</span>
<a href="#l19.70"></a><span id="l19.70">     attachmentSizes: [textAttachment.length],</span>
<a href="#l19.71"></a><span id="l19.71">     attachmentTotalSize: { size: textAttachment.length, exact: true },</span>
<a href="#l19.72"></a><span id="l19.72">   },</span>
<a href="#l19.73"></a><span id="l19.73" class="difflineminus">-  { name: 'binary_attachment',</span>
<a href="#l19.74"></a><span id="l19.74" class="difflineplus">+  { name: &quot;binary_attachment&quot;,</span>
<a href="#l19.75"></a><span id="l19.75">     attachments: [{ body: binaryAttachment,</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineminus">-                    contentType: 'application/x-ubik',</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineminus">-                    filename: 'ubik',</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineminus">-                    format: '' }],</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+                    contentType: &quot;application/x-ubik&quot;,</span>
<a href="#l19.80"></a><span id="l19.80" class="difflineplus">+                    filename: &quot;ubik&quot;,</span>
<a href="#l19.81"></a><span id="l19.81" class="difflineplus">+                    format: &quot;&quot; }],</span>
<a href="#l19.82"></a><span id="l19.82">     attachmentSizes: [binaryAttachment.length],</span>
<a href="#l19.83"></a><span id="l19.83">     attachmentTotalSize: { size: binaryAttachment.length, exact: true },</span>
<a href="#l19.84"></a><span id="l19.84">   },</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineminus">-  { name: 'image_attachment',</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+  { name: &quot;image_attachment&quot;,</span>
<a href="#l19.87"></a><span id="l19.87">     attachments: [{ body: imageAttachment,</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineminus">-                    contentType: 'image/png',</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-                    filename: 'lines.png',</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineminus">-                    encoding: 'base64',</span>
<a href="#l19.91"></a><span id="l19.91" class="difflineminus">-                    format: '' }],</span>
<a href="#l19.92"></a><span id="l19.92" class="difflineplus">+                    contentType: &quot;image/png&quot;,</span>
<a href="#l19.93"></a><span id="l19.93" class="difflineplus">+                    filename: &quot;lines.png&quot;,</span>
<a href="#l19.94"></a><span id="l19.94" class="difflineplus">+                    encoding: &quot;base64&quot;,</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineplus">+                    format: &quot;&quot; }],</span>
<a href="#l19.96"></a><span id="l19.96">     attachmentSizes: [imageSize],</span>
<a href="#l19.97"></a><span id="l19.97">     attachmentTotalSize: { size: imageSize, exact: true },</span>
<a href="#l19.98"></a><span id="l19.98">   },</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-  { name: 'detached_attachment',</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineplus">+  { name: &quot;detached_attachment&quot;,</span>
<a href="#l19.101"></a><span id="l19.101">     bodyPart: null,</span>
<a href="#l19.102"></a><span id="l19.102">     // Sizes filled in on message creation.</span>
<a href="#l19.103"></a><span id="l19.103">     attachmentSizes: [null],</span>
<a href="#l19.104"></a><span id="l19.104">     attachmentTotalSize: { size: 0, exact: true },</span>
<a href="#l19.105"></a><span id="l19.105">   },</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineminus">-  { name: 'detached_attachment_with_missing_file',</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineplus">+  { name: &quot;detached_attachment_with_missing_file&quot;,</span>
<a href="#l19.108"></a><span id="l19.108">     bodyPart: null,</span>
<a href="#l19.109"></a><span id="l19.109">     attachmentSizes: [-1],</span>
<a href="#l19.110"></a><span id="l19.110">     attachmentTotalSize: { size: 0, exact: false },</span>
<a href="#l19.111"></a><span id="l19.111">   },</span>
<a href="#l19.112"></a><span id="l19.112" class="difflineminus">-  { name: 'deleted_attachment',</span>
<a href="#l19.113"></a><span id="l19.113" class="difflineplus">+  { name: &quot;deleted_attachment&quot;,</span>
<a href="#l19.114"></a><span id="l19.114">     bodyPart: null,</span>
<a href="#l19.115"></a><span id="l19.115">     attachmentSizes: [-1],</span>
<a href="#l19.116"></a><span id="l19.116">     attachmentTotalSize: { size: 0, exact: true },</span>
<a href="#l19.117"></a><span id="l19.117">   },</span>
<a href="#l19.118"></a><span id="l19.118" class="difflineminus">-  { name: 'multiple_attachments',</span>
<a href="#l19.119"></a><span id="l19.119" class="difflineplus">+  { name: &quot;multiple_attachments&quot;,</span>
<a href="#l19.120"></a><span id="l19.120">     attachments: [{ body: textAttachment,</span>
<a href="#l19.121"></a><span id="l19.121" class="difflineminus">-                    filename: 'ubik.txt',</span>
<a href="#l19.122"></a><span id="l19.122" class="difflineminus">-                    format: '' },</span>
<a href="#l19.123"></a><span id="l19.123" class="difflineplus">+                    filename: &quot;ubik.txt&quot;,</span>
<a href="#l19.124"></a><span id="l19.124" class="difflineplus">+                    format: &quot;&quot; },</span>
<a href="#l19.125"></a><span id="l19.125">                   { body: binaryAttachment,</span>
<a href="#l19.126"></a><span id="l19.126" class="difflineminus">-                    contentType: 'application/x-ubik',</span>
<a href="#l19.127"></a><span id="l19.127" class="difflineminus">-                    filename: 'ubik',</span>
<a href="#l19.128"></a><span id="l19.128" class="difflineminus">-                    format: '' }],</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineplus">+                    contentType: &quot;application/x-ubik&quot;,</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineplus">+                    filename: &quot;ubik&quot;,</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineplus">+                    format: &quot;&quot; }],</span>
<a href="#l19.132"></a><span id="l19.132">     attachmentSizes: [textAttachment.length, binaryAttachment.length],</span>
<a href="#l19.133"></a><span id="l19.133">     attachmentTotalSize: { size: textAttachment.length +</span>
<a href="#l19.134"></a><span id="l19.134">                                  binaryAttachment.length,</span>
<a href="#l19.135"></a><span id="l19.135">                            exact: true },</span>
<a href="#l19.136"></a><span id="l19.136">   },</span>
<a href="#l19.137"></a><span id="l19.137">   // vCards should be ignored in the attachment list; make sure we do so</span>
<a href="#l19.138"></a><span id="l19.138">   // properly.</span>
<a href="#l19.139"></a><span id="l19.139" class="difflineminus">-  { name: 'multiple_attachments_one_vcard',</span>
<a href="#l19.140"></a><span id="l19.140" class="difflineplus">+  { name: &quot;multiple_attachments_one_vcard&quot;,</span>
<a href="#l19.141"></a><span id="l19.141">     attachments: [{ body: textAttachment,</span>
<a href="#l19.142"></a><span id="l19.142" class="difflineminus">-                    filename: 'ubik.txt',</span>
<a href="#l19.143"></a><span id="l19.143" class="difflineminus">-                    format: '' },</span>
<a href="#l19.144"></a><span id="l19.144" class="difflineplus">+                    filename: &quot;ubik.txt&quot;,</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineplus">+                    format: &quot;&quot; },</span>
<a href="#l19.146"></a><span id="l19.146">                   { body: vcardAttachment,</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineminus">-                    contentType: 'text/x-vcard',</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineminus">-                    filename: 'ubik.vcf',</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineminus">-                    encoding: 'base64',</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineminus">-                    format: '' }],</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineplus">+                    contentType: &quot;text/x-vcard&quot;,</span>
<a href="#l19.152"></a><span id="l19.152" class="difflineplus">+                    filename: &quot;ubik.vcf&quot;,</span>
<a href="#l19.153"></a><span id="l19.153" class="difflineplus">+                    encoding: &quot;base64&quot;,</span>
<a href="#l19.154"></a><span id="l19.154" class="difflineplus">+                    format: &quot;&quot; }],</span>
<a href="#l19.155"></a><span id="l19.155">     attachmentSizes: [textAttachment.length],</span>
<a href="#l19.156"></a><span id="l19.156">     attachmentTotalSize: { size: textAttachment.length,</span>
<a href="#l19.157"></a><span id="l19.157">                            exact: true },</span>
<a href="#l19.158"></a><span id="l19.158">   },</span>
<a href="#l19.159"></a><span id="l19.159" class="difflineminus">-  { name: 'multiple_attachments_one_detached',</span>
<a href="#l19.160"></a><span id="l19.160" class="difflineplus">+  { name: &quot;multiple_attachments_one_detached&quot;,</span>
<a href="#l19.161"></a><span id="l19.161">     bodyPart: null,</span>
<a href="#l19.162"></a><span id="l19.162">     attachments: [{ body: textAttachment,</span>
<a href="#l19.163"></a><span id="l19.163" class="difflineminus">-                    filename: 'ubik.txt',</span>
<a href="#l19.164"></a><span id="l19.164" class="difflineminus">-                    format: '' }],</span>
<a href="#l19.165"></a><span id="l19.165" class="difflineplus">+                    filename: &quot;ubik.txt&quot;,</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineplus">+                    format: &quot;&quot; }],</span>
<a href="#l19.167"></a><span id="l19.167">     attachmentSizes: [null, textAttachment.length],</span>
<a href="#l19.168"></a><span id="l19.168">     attachmentTotalSize: { size: textAttachment.length, exact: true },</span>
<a href="#l19.169"></a><span id="l19.169">   },</span>
<a href="#l19.170"></a><span id="l19.170" class="difflineminus">-  { name: 'multiple_attachments_one_detached_with_missing_file',</span>
<a href="#l19.171"></a><span id="l19.171" class="difflineplus">+  { name: &quot;multiple_attachments_one_detached_with_missing_file&quot;,</span>
<a href="#l19.172"></a><span id="l19.172">     bodyPart: null,</span>
<a href="#l19.173"></a><span id="l19.173">     attachments: [{ body: textAttachment,</span>
<a href="#l19.174"></a><span id="l19.174" class="difflineminus">-                    filename: 'ubik.txt',</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineminus">-                    format: '' }],</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineplus">+                    filename: &quot;ubik.txt&quot;,</span>
<a href="#l19.177"></a><span id="l19.177" class="difflineplus">+                    format: &quot;&quot; }],</span>
<a href="#l19.178"></a><span id="l19.178">     attachmentSizes: [-1, textAttachment.length],</span>
<a href="#l19.179"></a><span id="l19.179">     attachmentTotalSize: { size: textAttachment.length, exact: false },</span>
<a href="#l19.180"></a><span id="l19.180">   },</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineminus">-  { name: 'multiple_attachments_one_deleted',</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineplus">+  { name: &quot;multiple_attachments_one_deleted&quot;,</span>
<a href="#l19.183"></a><span id="l19.183">     bodyPart: null,</span>
<a href="#l19.184"></a><span id="l19.184">     attachments: [{ body: textAttachment,</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineminus">-                    filename: 'ubik.txt',</span>
<a href="#l19.186"></a><span id="l19.186" class="difflineminus">-                    format: '' }],</span>
<a href="#l19.187"></a><span id="l19.187" class="difflineplus">+                    filename: &quot;ubik.txt&quot;,</span>
<a href="#l19.188"></a><span id="l19.188" class="difflineplus">+                    format: &quot;&quot; }],</span>
<a href="#l19.189"></a><span id="l19.189">     attachmentSizes: [-1, textAttachment.length],</span>
<a href="#l19.190"></a><span id="l19.190">     attachmentTotalSize: { size: textAttachment.length, exact: true },</span>
<a href="#l19.191"></a><span id="l19.191">   },</span>
<a href="#l19.192"></a><span id="l19.192">   // this is an attached message that itself has an attachment</span>
<a href="#l19.193"></a><span id="l19.193">   {</span>
<a href="#l19.194"></a><span id="l19.194" class="difflineminus">-    name: 'attached_message_with_attachment',</span>
<a href="#l19.195"></a><span id="l19.195" class="difflineplus">+    name: &quot;attached_message_with_attachment&quot;,</span>
<a href="#l19.196"></a><span id="l19.196">     bodyPart: null,</span>
<a href="#l19.197"></a><span id="l19.197">     attachmentSizes: [-1, textAttachment.length],</span>
<a href="#l19.198"></a><span id="l19.198">     attachmentTotalSize: { size: 0, exact: true },</span>
<a href="#l19.199"></a><span id="l19.199">   },</span>
<a href="#l19.200"></a><span id="l19.200"> ];</span>
<a href="#l19.201"></a><span id="l19.201"> </span>
<a href="#l19.202"></a><span id="l19.202"> function setupModule(module) {</span>
<a href="#l19.203"></a><span id="l19.203">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l19.204"></a><span id="l19.204">     collector.getModule(lib).installInto(module);</span>
<a href="#l19.205"></a><span id="l19.205">   }</span>
<a href="#l19.206"></a><span id="l19.206"> </span>
<a href="#l19.207"></a><span id="l19.207" class="difflineminus">-  messenger = Cc['@mozilla.org/messenger;1'].createInstance(Ci.nsIMessenger);</span>
<a href="#l19.208"></a><span id="l19.208" class="difflineplus">+  messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l19.209"></a><span id="l19.209"> </span>
<a href="#l19.210"></a><span id="l19.210">   /* Today's gory details (thanks to Jonathan Protzenko): libmime somehow</span>
<a href="#l19.211"></a><span id="l19.211">    * counts the trailing newline for an attachment MIME part. Most of the time,</span>
<a href="#l19.212"></a><span id="l19.212">    * assuming attachment has N bytes (no matter what's inside, newlines or</span>
<a href="#l19.213"></a><span id="l19.213">    * not), libmime will return N + 1 bytes. On Linux and Mac, this always</span>
<a href="#l19.214"></a><span id="l19.214">    * holds. However, on Windows, if the attachment is not encoded (that is, is</span>
<a href="#l19.215"></a><span id="l19.215">    * inline text), libmime will return N + 2 bytes.</span>
<a href="#l19.216"></a><span id="l19.216">    */</span>
<a href="#l19.217"></a><span id="l19.217" class="difflineminus">-  epsilon = ('@mozilla.org/windows-registry-key;1' in Cc) ? 4 : 2;</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineplus">+  epsilon = (&quot;@mozilla.org/windows-registry-key;1&quot; in Cc) ? 4 : 2;</span>
<a href="#l19.219"></a><span id="l19.219"> </span>
<a href="#l19.220"></a><span id="l19.220">   // set up our detached/deleted attachments</span>
<a href="#l19.221"></a><span id="l19.221">   var thisFilePath = os.getFileForPath(__file__);</span>
<a href="#l19.222"></a><span id="l19.222"> </span>
<a href="#l19.223"></a><span id="l19.223">   var detachedFile = os.getFileForPath(os.abspath(detachedName, thisFilePath));</span>
<a href="#l19.224"></a><span id="l19.224">   var detached = create_body_part(</span>
<a href="#l19.225"></a><span id="l19.225" class="difflineminus">-    'Here is a file',</span>
<a href="#l19.226"></a><span id="l19.226" class="difflineminus">-    [create_detached_attachment(detachedFile, 'text/plain')]</span>
<a href="#l19.227"></a><span id="l19.227" class="difflineplus">+    &quot;Here is a file&quot;,</span>
<a href="#l19.228"></a><span id="l19.228" class="difflineplus">+    [create_detached_attachment(detachedFile, &quot;text/plain&quot;)]</span>
<a href="#l19.229"></a><span id="l19.229">   );</span>
<a href="#l19.230"></a><span id="l19.230"> </span>
<a href="#l19.231"></a><span id="l19.231">   var missingFile = os.getFileForPath(os.abspath(missingName, thisFilePath));</span>
<a href="#l19.232"></a><span id="l19.232">   var missing = create_body_part(</span>
<a href="#l19.233"></a><span id="l19.233" class="difflineminus">-    'Here is a file (but you deleted the external file, you silly oaf!)',</span>
<a href="#l19.234"></a><span id="l19.234" class="difflineminus">-    [create_detached_attachment(missingFile, 'text/plain')]</span>
<a href="#l19.235"></a><span id="l19.235" class="difflineplus">+    &quot;Here is a file (but you deleted the external file, you silly oaf!)&quot;,</span>
<a href="#l19.236"></a><span id="l19.236" class="difflineplus">+    [create_detached_attachment(missingFile, &quot;text/plain&quot;)]</span>
<a href="#l19.237"></a><span id="l19.237">   );</span>
<a href="#l19.238"></a><span id="l19.238"> </span>
<a href="#l19.239"></a><span id="l19.239">   var deleted = create_body_part(</span>
<a href="#l19.240"></a><span id="l19.240" class="difflineminus">-    'Here is a file that you deleted',</span>
<a href="#l19.241"></a><span id="l19.241" class="difflineminus">-    [create_deleted_attachment(deletedName, 'text/plain')]</span>
<a href="#l19.242"></a><span id="l19.242" class="difflineplus">+    &quot;Here is a file that you deleted&quot;,</span>
<a href="#l19.243"></a><span id="l19.243" class="difflineplus">+    [create_deleted_attachment(deletedName, &quot;text/plain&quot;)]</span>
<a href="#l19.244"></a><span id="l19.244">   );</span>
<a href="#l19.245"></a><span id="l19.245"> </span>
<a href="#l19.246"></a><span id="l19.246">   var attachedMessage = msgGen.makeMessage({</span>
<a href="#l19.247"></a><span id="l19.247">     body: { body: textAttachment },</span>
<a href="#l19.248"></a><span id="l19.248">     attachments: [{ body: textAttachment,</span>
<a href="#l19.249"></a><span id="l19.249" class="difflineminus">-                    filename: 'ubik.txt',</span>
<a href="#l19.250"></a><span id="l19.250" class="difflineminus">-                    format: '' }],</span>
<a href="#l19.251"></a><span id="l19.251" class="difflineplus">+                    filename: &quot;ubik.txt&quot;,</span>
<a href="#l19.252"></a><span id="l19.252" class="difflineplus">+                    format: &quot;&quot; }],</span>
<a href="#l19.253"></a><span id="l19.253">   });</span>
<a href="#l19.254"></a><span id="l19.254"> </span>
<a href="#l19.255"></a><span id="l19.255">   /* Much like the above comment, libmime counts bytes differently on Windows,</span>
<a href="#l19.256"></a><span id="l19.256">    * where it counts newlines (\r\n) as 2 bytes. Mac and Linux treats them as</span>
<a href="#l19.257"></a><span id="l19.257">    * 1 byte.</span>
<a href="#l19.258"></a><span id="l19.258">    */</span>
<a href="#l19.259"></a><span id="l19.259">   var attachedMessageLength;</span>
<a href="#l19.260"></a><span id="l19.260">   if (epsilon == 4) // Windows</span>
<a href="#l19.261"></a><span id="l19.261">     attachedMessageLength = attachedMessage.toMessageString().length;</span>
<a href="#l19.262"></a><span id="l19.262">   else // Mac/Linux</span>
<a href="#l19.263"></a><span id="l19.263">     attachedMessageLength = attachedMessage.toMessageString()</span>
<a href="#l19.264"></a><span id="l19.264">                                            .replace(/\r\n/g, &quot;\n&quot;).length;</span>
<a href="#l19.265"></a><span id="l19.265"> </span>
<a href="#l19.266"></a><span id="l19.266" class="difflineminus">-  folder = create_folder('AttachmentSizeA');</span>
<a href="#l19.267"></a><span id="l19.267" class="difflineplus">+  folder = create_folder(&quot;AttachmentSizeA&quot;);</span>
<a href="#l19.268"></a><span id="l19.268">   for (let i = 0; i &lt; messages.length; i++) {</span>
<a href="#l19.269"></a><span id="l19.269">     // First, add any missing info to the message object.</span>
<a href="#l19.270"></a><span id="l19.270" class="difflineminus">-    switch(messages[i].name) {</span>
<a href="#l19.271"></a><span id="l19.271" class="difflineminus">-      case 'detached_attachment':</span>
<a href="#l19.272"></a><span id="l19.272" class="difflineminus">-      case 'multiple_attachments_one_detached':</span>
<a href="#l19.273"></a><span id="l19.273" class="difflineplus">+    switch (messages[i].name) {</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineplus">+      case &quot;detached_attachment&quot;:</span>
<a href="#l19.275"></a><span id="l19.275" class="difflineplus">+      case &quot;multiple_attachments_one_detached&quot;:</span>
<a href="#l19.276"></a><span id="l19.276">         messages[i].bodyPart = detached;</span>
<a href="#l19.277"></a><span id="l19.277">         messages[i].attachmentSizes[0] = detachedFile.fileSize;</span>
<a href="#l19.278"></a><span id="l19.278">         messages[i].attachmentTotalSize.size += detachedFile.fileSize;</span>
<a href="#l19.279"></a><span id="l19.279">         break;</span>
<a href="#l19.280"></a><span id="l19.280" class="difflineminus">-      case 'detached_attachment_with_missing_file':</span>
<a href="#l19.281"></a><span id="l19.281" class="difflineminus">-      case 'multiple_attachments_one_detached_with_missing_file':</span>
<a href="#l19.282"></a><span id="l19.282" class="difflineplus">+      case &quot;detached_attachment_with_missing_file&quot;:</span>
<a href="#l19.283"></a><span id="l19.283" class="difflineplus">+      case &quot;multiple_attachments_one_detached_with_missing_file&quot;:</span>
<a href="#l19.284"></a><span id="l19.284">         messages[i].bodyPart = missing;</span>
<a href="#l19.285"></a><span id="l19.285">         break;</span>
<a href="#l19.286"></a><span id="l19.286" class="difflineminus">-      case 'deleted_attachment':</span>
<a href="#l19.287"></a><span id="l19.287" class="difflineminus">-      case 'multiple_attachments_one_deleted':</span>
<a href="#l19.288"></a><span id="l19.288" class="difflineplus">+      case &quot;deleted_attachment&quot;:</span>
<a href="#l19.289"></a><span id="l19.289" class="difflineplus">+      case &quot;multiple_attachments_one_deleted&quot;:</span>
<a href="#l19.290"></a><span id="l19.290">         messages[i].bodyPart = deleted;</span>
<a href="#l19.291"></a><span id="l19.291">         break;</span>
<a href="#l19.292"></a><span id="l19.292" class="difflineminus">-      case 'attached_message_with_attachment':</span>
<a href="#l19.293"></a><span id="l19.293" class="difflineplus">+      case &quot;attached_message_with_attachment&quot;:</span>
<a href="#l19.294"></a><span id="l19.294">         messages[i].bodyPart = new SyntheticPartMultiMixed([</span>
<a href="#l19.295"></a><span id="l19.295">           new SyntheticPartLeaf(&quot;I am text!&quot;, { contentType: &quot;text/plain&quot; }),</span>
<a href="#l19.296"></a><span id="l19.296">           attachedMessage,</span>
<a href="#l19.297"></a><span id="l19.297">         ]);</span>
<a href="#l19.298"></a><span id="l19.298">         messages[i].attachmentSizes[0] = attachedMessageLength;</span>
<a href="#l19.299"></a><span id="l19.299">         messages[i].attachmentTotalSize.size += attachedMessageLength;</span>
<a href="#l19.300"></a><span id="l19.300">         break;</span>
<a href="#l19.301"></a><span id="l19.301">     }</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineat">@@ -230,108 +232,108 @@ function setupModule(module) {</span>
<a href="#l19.303"></a><span id="l19.303"> }</span>
<a href="#l19.304"></a><span id="l19.304"> </span>
<a href="#l19.305"></a><span id="l19.305"> /**</span>
<a href="#l19.306"></a><span id="l19.306">  * Make sure that the attachment's size is what we expect</span>
<a href="#l19.307"></a><span id="l19.307">  * @param index the attachment's index, starting at 0</span>
<a href="#l19.308"></a><span id="l19.308">  * @param expectedSize the expected size of the attachment, in bytes</span>
<a href="#l19.309"></a><span id="l19.309">  */</span>
<a href="#l19.310"></a><span id="l19.310"> function check_attachment_size(index, expectedSize) {</span>
<a href="#l19.311"></a><span id="l19.311" class="difflineminus">-  let list = mc.e('attachmentList');</span>
<a href="#l19.312"></a><span id="l19.312" class="difflineplus">+  let list = mc.e(&quot;attachmentList&quot;);</span>
<a href="#l19.313"></a><span id="l19.313">   let node = list.querySelectorAll(&quot;richlistitem.attachmentItem&quot;)[index];</span>
<a href="#l19.314"></a><span id="l19.314"> </span>
<a href="#l19.315"></a><span id="l19.315">   // First, let's check that the attachment size is correct</span>
<a href="#l19.316"></a><span id="l19.316">   let size = node.attachment.size;</span>
<a href="#l19.317"></a><span id="l19.317">   if (Math.abs(size - expectedSize) &gt; epsilon)</span>
<a href="#l19.318"></a><span id="l19.318" class="difflineminus">-    throw new Error('Reported attachment size ('+size+') not within epsilon ' +</span>
<a href="#l19.319"></a><span id="l19.319" class="difflineminus">-                    'of actual attachment size ('+expectedSize+')');</span>
<a href="#l19.320"></a><span id="l19.320" class="difflineplus">+    throw new Error(&quot;Reported attachment size (&quot; + size + &quot;) not within epsilon &quot; +</span>
<a href="#l19.321"></a><span id="l19.321" class="difflineplus">+                    &quot;of actual attachment size (&quot; + expectedSize + &quot;)&quot;);</span>
<a href="#l19.322"></a><span id="l19.322"> </span>
<a href="#l19.323"></a><span id="l19.323">   // Next, make sure that the formatted size in the label is correct</span>
<a href="#l19.324"></a><span id="l19.324" class="difflineminus">-  let formattedSize = node.getAttribute('size');</span>
<a href="#l19.325"></a><span id="l19.325" class="difflineplus">+  let formattedSize = node.getAttribute(&quot;size&quot;);</span>
<a href="#l19.326"></a><span id="l19.326">   let expectedFormattedSize = messenger.formatFileSize(size);</span>
<a href="#l19.327"></a><span id="l19.327">   if (formattedSize != expectedFormattedSize)</span>
<a href="#l19.328"></a><span id="l19.328" class="difflineminus">-    throw new Error('Formatted attachment size ('+formattedSize+') does not ' +</span>
<a href="#l19.329"></a><span id="l19.329" class="difflineminus">-                    'match expected value ('+expectedFormattedSize+')');</span>
<a href="#l19.330"></a><span id="l19.330" class="difflineplus">+    throw new Error(&quot;Formatted attachment size (&quot; + formattedSize + &quot;) does not &quot; +</span>
<a href="#l19.331"></a><span id="l19.331" class="difflineplus">+                    &quot;match expected value (&quot; + expectedFormattedSize + &quot;)&quot;);</span>
<a href="#l19.332"></a><span id="l19.332"> }</span>
<a href="#l19.333"></a><span id="l19.333"> </span>
<a href="#l19.334"></a><span id="l19.334"> /**</span>
<a href="#l19.335"></a><span id="l19.335">  * Make sure that the attachment's size is not displayed</span>
<a href="#l19.336"></a><span id="l19.336">  * @param index the attachment's index, starting at 0</span>
<a href="#l19.337"></a><span id="l19.337">  */</span>
<a href="#l19.338"></a><span id="l19.338"> function check_no_attachment_size(index) {</span>
<a href="#l19.339"></a><span id="l19.339" class="difflineminus">-  let list = mc.e('attachmentList');</span>
<a href="#l19.340"></a><span id="l19.340" class="difflineplus">+  let list = mc.e(&quot;attachmentList&quot;);</span>
<a href="#l19.341"></a><span id="l19.341">   let node = list.querySelectorAll(&quot;richlistitem.attachmentItem&quot;)[index];</span>
<a href="#l19.342"></a><span id="l19.342"> </span>
<a href="#l19.343"></a><span id="l19.343">   if (node.attachment.size != -1)</span>
<a href="#l19.344"></a><span id="l19.344" class="difflineminus">-    throw new Error('attachmentSize attribute of deleted attachment should ' +</span>
<a href="#l19.345"></a><span id="l19.345" class="difflineminus">-                    'be -1!');</span>
<a href="#l19.346"></a><span id="l19.346" class="difflineplus">+    throw new Error(&quot;attachmentSize attribute of deleted attachment should &quot; +</span>
<a href="#l19.347"></a><span id="l19.347" class="difflineplus">+                    &quot;be -1!&quot;);</span>
<a href="#l19.348"></a><span id="l19.348"> </span>
<a href="#l19.349"></a><span id="l19.349">   // If there's no size, the size attribute is the zero-width space.</span>
<a href="#l19.350"></a><span id="l19.350" class="difflineminus">-  let nodeSize = node.getAttribute('size');</span>
<a href="#l19.351"></a><span id="l19.351" class="difflineminus">-  mc.window.console.log(&quot;check_no_attachment_size: node.size-&gt;&quot;+nodeSize+&quot;&lt;-&quot;);</span>
<a href="#l19.352"></a><span id="l19.352" class="difflineminus">-  if (nodeSize != '\u200b' &amp;&amp; nodeSize != '')</span>
<a href="#l19.353"></a><span id="l19.353" class="difflineminus">-    throw new Error('Attachment size should not be displayed!');</span>
<a href="#l19.354"></a><span id="l19.354" class="difflineplus">+  let nodeSize = node.getAttribute(&quot;size&quot;);</span>
<a href="#l19.355"></a><span id="l19.355" class="difflineplus">+  mc.window.console.log(&quot;check_no_attachment_size: node.size-&gt;&quot; + nodeSize + &quot;&lt;-&quot;);</span>
<a href="#l19.356"></a><span id="l19.356" class="difflineplus">+  if (nodeSize != &quot;\u200b&quot; &amp;&amp; nodeSize != &quot;&quot;)</span>
<a href="#l19.357"></a><span id="l19.357" class="difflineplus">+    throw new Error(&quot;Attachment size should not be displayed!&quot;);</span>
<a href="#l19.358"></a><span id="l19.358"> }</span>
<a href="#l19.359"></a><span id="l19.359"> </span>
<a href="#l19.360"></a><span id="l19.360"> /**</span>
<a href="#l19.361"></a><span id="l19.361">  * Make sure that the total size of all attachments is what we expect.</span>
<a href="#l19.362"></a><span id="l19.362">  * @param count the expected number of attachments</span>
<a href="#l19.363"></a><span id="l19.363">  * @param expectedSize the expected size in bytes of all the attachments</span>
<a href="#l19.364"></a><span id="l19.364">  * @param exact true if the size of all attachments is known, false otherwise</span>
<a href="#l19.365"></a><span id="l19.365">  */</span>
<a href="#l19.366"></a><span id="l19.366"> function check_total_attachment_size(count, expectedSize, exact) {</span>
<a href="#l19.367"></a><span id="l19.367" class="difflineminus">-  let list = mc.e('attachmentList');</span>
<a href="#l19.368"></a><span id="l19.368" class="difflineplus">+  let list = mc.e(&quot;attachmentList&quot;);</span>
<a href="#l19.369"></a><span id="l19.369">   let nodes = list.querySelectorAll(&quot;richlistitem.attachmentItem&quot;);</span>
<a href="#l19.370"></a><span id="l19.370" class="difflineminus">-  let sizeNode = mc.e('attachmentSize');</span>
<a href="#l19.371"></a><span id="l19.371" class="difflineplus">+  let sizeNode = mc.e(&quot;attachmentSize&quot;);</span>
<a href="#l19.372"></a><span id="l19.372"> </span>
<a href="#l19.373"></a><span id="l19.373">   if (nodes.length != count)</span>
<a href="#l19.374"></a><span id="l19.374" class="difflineminus">-    throw new Error('Saw '+nodes.length+' attachments, but expected '+count);</span>
<a href="#l19.375"></a><span id="l19.375" class="difflineplus">+    throw new Error(&quot;Saw &quot; + nodes.length + &quot; attachments, but expected &quot; + count);</span>
<a href="#l19.376"></a><span id="l19.376"> </span>
<a href="#l19.377"></a><span id="l19.377">   let lastPartID;</span>
<a href="#l19.378"></a><span id="l19.378">   let size = 0;</span>
<a href="#l19.379"></a><span id="l19.379">   for (let i = 0; i &lt; nodes.length; i++) {</span>
<a href="#l19.380"></a><span id="l19.380">     let attachment = nodes[i].attachment;</span>
<a href="#l19.381"></a><span id="l19.381">     if (!lastPartID || attachment.partID.indexOf(lastPartID) != 0) {</span>
<a href="#l19.382"></a><span id="l19.382">       lastPartID = attachment.partID;</span>
<a href="#l19.383"></a><span id="l19.383">       let currSize = attachment.size;</span>
<a href="#l19.384"></a><span id="l19.384">       if (currSize &gt; 0 &amp;&amp; !isNaN(currSize))</span>
<a href="#l19.385"></a><span id="l19.385">         size += Number(currSize);</span>
<a href="#l19.386"></a><span id="l19.386">     }</span>
<a href="#l19.387"></a><span id="l19.387">   }</span>
<a href="#l19.388"></a><span id="l19.388"> </span>
<a href="#l19.389"></a><span id="l19.389" class="difflineminus">-  if (Math.abs(size - expectedSize) &gt; epsilon*count)</span>
<a href="#l19.390"></a><span id="l19.390" class="difflineminus">-    throw new Error('Reported attachment size ('+size+') not within epsilon ' +</span>
<a href="#l19.391"></a><span id="l19.391" class="difflineminus">-                    'of actual attachment size ('+expectedSize+')');</span>
<a href="#l19.392"></a><span id="l19.392" class="difflineplus">+  if (Math.abs(size - expectedSize) &gt; epsilon * count)</span>
<a href="#l19.393"></a><span id="l19.393" class="difflineplus">+    throw new Error(&quot;Reported attachment size (&quot; + size + &quot;) not within epsilon &quot; +</span>
<a href="#l19.394"></a><span id="l19.394" class="difflineplus">+                    &quot;of actual attachment size (&quot; + expectedSize + &quot;)&quot;);</span>
<a href="#l19.395"></a><span id="l19.395"> </span>
<a href="#l19.396"></a><span id="l19.396">   // Next, make sure that the formatted size in the label is correct</span>
<a href="#l19.397"></a><span id="l19.397" class="difflineminus">-  let formattedSize = sizeNode.getAttribute('value');</span>
<a href="#l19.398"></a><span id="l19.398" class="difflineplus">+  let formattedSize = sizeNode.getAttribute(&quot;value&quot;);</span>
<a href="#l19.399"></a><span id="l19.399">   let expectedFormattedSize = messenger.formatFileSize(size);</span>
<a href="#l19.400"></a><span id="l19.400" class="difflineminus">-  let messengerBundle = mc.window.document.getElementById('bundle_messenger');</span>
<a href="#l19.401"></a><span id="l19.401" class="difflineplus">+  let messengerBundle = mc.window.document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l19.402"></a><span id="l19.402"> </span>
<a href="#l19.403"></a><span id="l19.403">   if (!exact) {</span>
<a href="#l19.404"></a><span id="l19.404">     if (size == 0)</span>
<a href="#l19.405"></a><span id="l19.405">       expectedFormattedSize = messengerBundle.getString(</span>
<a href="#l19.406"></a><span id="l19.406" class="difflineminus">-        'attachmentSizeUnknown');</span>
<a href="#l19.407"></a><span id="l19.407" class="difflineplus">+        &quot;attachmentSizeUnknown&quot;);</span>
<a href="#l19.408"></a><span id="l19.408">     else</span>
<a href="#l19.409"></a><span id="l19.409">       expectedFormattedSize = messengerBundle.getFormattedString(</span>
<a href="#l19.410"></a><span id="l19.410" class="difflineminus">-        'attachmentSizeAtLeast', [expectedFormattedSize]);</span>
<a href="#l19.411"></a><span id="l19.411" class="difflineplus">+        &quot;attachmentSizeAtLeast&quot;, [expectedFormattedSize]);</span>
<a href="#l19.412"></a><span id="l19.412">   }</span>
<a href="#l19.413"></a><span id="l19.413">   if (formattedSize != expectedFormattedSize)</span>
<a href="#l19.414"></a><span id="l19.414" class="difflineminus">-    throw new Error('Formatted attachment size ('+formattedSize+') does not ' +</span>
<a href="#l19.415"></a><span id="l19.415" class="difflineminus">-                    'match expected value ('+expectedFormattedSize+')');</span>
<a href="#l19.416"></a><span id="l19.416" class="difflineplus">+    throw new Error(&quot;Formatted attachment size (&quot; + formattedSize + &quot;) does not &quot; +</span>
<a href="#l19.417"></a><span id="l19.417" class="difflineplus">+                    &quot;match expected value (&quot; + expectedFormattedSize + &quot;)&quot;);</span>
<a href="#l19.418"></a><span id="l19.418"> }</span>
<a href="#l19.419"></a><span id="l19.419"> </span>
<a href="#l19.420"></a><span id="l19.420"> /**</span>
<a href="#l19.421"></a><span id="l19.421">  * Make sure that the individual and total attachment sizes for this message</span>
<a href="#l19.422"></a><span id="l19.422">  * are as expected</span>
<a href="#l19.423"></a><span id="l19.423">  * @param index the index of the message to check in the thread pane</span>
<a href="#l19.424"></a><span id="l19.424">  */</span>
<a href="#l19.425"></a><span id="l19.425"> function help_test_attachment_size(index) {</span>
<a href="#l19.426"></a><span id="l19.426">   be_in_folder(folder);</span>
<a href="#l19.427"></a><span id="l19.427" class="difflineminus">-  let curMessage = select_click_row(index);</span>
<a href="#l19.428"></a><span id="l19.428" class="difflineplus">+  select_click_row(index);</span>
<a href="#l19.429"></a><span id="l19.429">   let expectedSizes = messages[index].attachmentSizes;</span>
<a href="#l19.430"></a><span id="l19.430"> </span>
<a href="#l19.431"></a><span id="l19.431">   mc.window.toggleAttachmentList(true);</span>
<a href="#l19.432"></a><span id="l19.432"> </span>
<a href="#l19.433"></a><span id="l19.433">   // Test funcs are generated in the global scope, and there isn't a way to</span>
<a href="#l19.434"></a><span id="l19.434">   // do this async (like within an async add_task in xpcshell) so await can</span>
<a href="#l19.435"></a><span id="l19.435">   // force serial execution of each test. Wait here for the fetch() to complete.</span>
<a href="#l19.436"></a><span id="l19.436">   controller.sleep(2000);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/test/mozmill/attachment/test-attachment.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -3,21 +3,23 @@</span>
<a href="#l20.4"></a><span id="l20.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6"> /**</span>
<a href="#l20.7"></a><span id="l20.7">  * Checks various attachments display correctly</span>
<a href="#l20.8"></a><span id="l20.8">  */</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10"> &quot;use strict&quot;;</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-var MODULE_NAME = 'test-attachment';</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l20.16"></a><span id="l20.16"> </span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'compose-helpers',</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-                       'window-helpers'];</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineplus">+var MODULE_NAME = &quot;test-attachment&quot;;</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l20.23"></a><span id="l20.23"> </span>
<a href="#l20.24"></a><span id="l20.24"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l20.25"></a><span id="l20.25"> var EventUtils = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/EventUtils.jsm&quot;);</span>
<a href="#l20.26"></a><span id="l20.26"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28"> var folder;</span>
<a href="#l20.29"></a><span id="l20.29"> var messages;</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31" class="difflineat">@@ -27,111 +29,111 @@ var textAttachment =</span>
<a href="#l20.32"></a><span id="l20.32">   &quot;of human values and compassion and simple warmth will return, and when &quot; +</span>
<a href="#l20.33"></a><span id="l20.33">   &quot;that happens someone like myself who has gone through an ordeal and who &quot; +</span>
<a href="#l20.34"></a><span id="l20.34">   &quot;genuinely needs hot coffee to pick him up and keep him functioning when &quot; +</span>
<a href="#l20.35"></a><span id="l20.35">   &quot;he has to function will get the hot coffee whether he happens to have a &quot; +</span>
<a href="#l20.36"></a><span id="l20.36">   &quot;poscred readily available or not.&quot;;</span>
<a href="#l20.37"></a><span id="l20.37"> </span>
<a href="#l20.38"></a><span id="l20.38"> var binaryAttachment = textAttachment;</span>
<a href="#l20.39"></a><span id="l20.39"> </span>
<a href="#l20.40"></a><span id="l20.40" class="difflineminus">-var setupModule = function (module) {</span>
<a href="#l20.41"></a><span id="l20.41" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l20.42"></a><span id="l20.42" class="difflineplus">+function setupModule(module) {</span>
<a href="#l20.43"></a><span id="l20.43" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l20.44"></a><span id="l20.44">   fdh.installInto(module);</span>
<a href="#l20.45"></a><span id="l20.45" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l20.47"></a><span id="l20.47">   wh.installInto(module);</span>
<a href="#l20.48"></a><span id="l20.48" class="difflineminus">-  let composeHelper = collector.getModule('compose-helpers');</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineplus">+  let composeHelper = collector.getModule(&quot;compose-helpers&quot;);</span>
<a href="#l20.50"></a><span id="l20.50">   composeHelper.installInto(module);</span>
<a href="#l20.51"></a><span id="l20.51"> </span>
<a href="#l20.52"></a><span id="l20.52">   folder = create_folder(&quot;AttachmentA&quot;);</span>
<a href="#l20.53"></a><span id="l20.53"> </span>
<a href="#l20.54"></a><span id="l20.54">   var attachedMessage = msgGen.makeMessage({</span>
<a href="#l20.55"></a><span id="l20.55">     body: { body: &quot;I'm an attached email!&quot; },</span>
<a href="#l20.56"></a><span id="l20.56">     attachments: [{ body: textAttachment,</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineminus">-                    filename: 'inner attachment.txt',</span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-                    format: '' }],</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+                    filename: &quot;inner attachment.txt&quot;,</span>
<a href="#l20.60"></a><span id="l20.60" class="difflineplus">+                    format: &quot;&quot; }],</span>
<a href="#l20.61"></a><span id="l20.61">   });</span>
<a href="#l20.62"></a><span id="l20.62"> </span>
<a href="#l20.63"></a><span id="l20.63">   // create some messages that have various types of attachments</span>
<a href="#l20.64"></a><span id="l20.64">   messages = [</span>
<a href="#l20.65"></a><span id="l20.65">     // no attachment</span>
<a href="#l20.66"></a><span id="l20.66">     {},</span>
<a href="#l20.67"></a><span id="l20.67">     // text attachment</span>
<a href="#l20.68"></a><span id="l20.68">     { attachments: [{ body: textAttachment,</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineminus">-                      filename: 'ubik.txt',</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineminus">-                      format: '' }],</span>
<a href="#l20.71"></a><span id="l20.71" class="difflineplus">+                      filename: &quot;ubik.txt&quot;,</span>
<a href="#l20.72"></a><span id="l20.72" class="difflineplus">+                      format: &quot;&quot; }],</span>
<a href="#l20.73"></a><span id="l20.73">     },</span>
<a href="#l20.74"></a><span id="l20.74">     // binary attachment; filename has 9 &quot;1&quot;s, which should be just within the</span>
<a href="#l20.75"></a><span id="l20.75">     // limit for showing the original name</span>
<a href="#l20.76"></a><span id="l20.76">     { attachments: [{ body: binaryAttachment,</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineminus">-                      contentType: 'application/octet-stream',</span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-                      filename: 'ubik-111111111.xxyyzz',</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-                      format: '' }],</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+                      contentType: &quot;application/octet-stream&quot;,</span>
<a href="#l20.81"></a><span id="l20.81" class="difflineplus">+                      filename: &quot;ubik-111111111.xxyyzz&quot;,</span>
<a href="#l20.82"></a><span id="l20.82" class="difflineplus">+                      format: &quot;&quot; }],</span>
<a href="#l20.83"></a><span id="l20.83">     },</span>
<a href="#l20.84"></a><span id="l20.84">     // multiple attachments</span>
<a href="#l20.85"></a><span id="l20.85">     { attachments: [{ body: textAttachment,</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-                      filename: 'ubik.txt',</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineminus">-                      format: '' },</span>
<a href="#l20.88"></a><span id="l20.88" class="difflineplus">+                      filename: &quot;ubik.txt&quot;,</span>
<a href="#l20.89"></a><span id="l20.89" class="difflineplus">+                      format: &quot;&quot; },</span>
<a href="#l20.90"></a><span id="l20.90">                     { body: binaryAttachment,</span>
<a href="#l20.91"></a><span id="l20.91" class="difflineminus">-                      contentType: 'application/octet-stream',</span>
<a href="#l20.92"></a><span id="l20.92" class="difflineminus">-                      filename: 'ubik.xxyyzz',</span>
<a href="#l20.93"></a><span id="l20.93" class="difflineminus">-                      format: '' }],</span>
<a href="#l20.94"></a><span id="l20.94" class="difflineplus">+                      contentType: &quot;application/octet-stream&quot;,</span>
<a href="#l20.95"></a><span id="l20.95" class="difflineplus">+                      filename: &quot;ubik.xxyyzz&quot;,</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineplus">+                      format: &quot;&quot; }],</span>
<a href="#l20.97"></a><span id="l20.97">     },</span>
<a href="#l20.98"></a><span id="l20.98">     // attachment with a long name; the attachment bar should crop this</span>
<a href="#l20.99"></a><span id="l20.99">     { attachments: [{ body: textAttachment,</span>
<a href="#l20.100"></a><span id="l20.100" class="difflineminus">-                      filename: 'this-is-a-file-with-an-extremely-long-name-' +</span>
<a href="#l20.101"></a><span id="l20.101" class="difflineminus">-                                'that-seems-to-go-on-forever-seriously-you-' +</span>
<a href="#l20.102"></a><span id="l20.102" class="difflineminus">-                                'would-not-believe-how-long-this-name-is-it-' +</span>
<a href="#l20.103"></a><span id="l20.103" class="difflineminus">-                                'surely-exceeds-the-maximum-filename-length-' +</span>
<a href="#l20.104"></a><span id="l20.104" class="difflineminus">-                                'for-most-filesystems.txt',</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-                      format: '' }],</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineplus">+                      filename: &quot;this-is-a-file-with-an-extremely-long-name-&quot; +</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineplus">+                                &quot;that-seems-to-go-on-forever-seriously-you-&quot; +</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+                                &quot;would-not-believe-how-long-this-name-is-it-&quot; +</span>
<a href="#l20.109"></a><span id="l20.109" class="difflineplus">+                                &quot;surely-exceeds-the-maximum-filename-length-&quot; +</span>
<a href="#l20.110"></a><span id="l20.110" class="difflineplus">+                                &quot;for-most-filesystems.txt&quot;,</span>
<a href="#l20.111"></a><span id="l20.111" class="difflineplus">+                      format: &quot;&quot; }],</span>
<a href="#l20.112"></a><span id="l20.112">     },</span>
<a href="#l20.113"></a><span id="l20.113">     // a message with a text attachment and an email attachment, which in turn</span>
<a href="#l20.114"></a><span id="l20.114">     // has its own text attachment</span>
<a href="#l20.115"></a><span id="l20.115">     {</span>
<a href="#l20.116"></a><span id="l20.116">       bodyPart: new SyntheticPartMultiMixed([</span>
<a href="#l20.117"></a><span id="l20.117">         new SyntheticPartLeaf(&quot;I'm a message!&quot;),</span>
<a href="#l20.118"></a><span id="l20.118">         new SyntheticPartLeaf(textAttachment,</span>
<a href="#l20.119"></a><span id="l20.119" class="difflineminus">-                              { filename: 'outer attachment.txt',</span>
<a href="#l20.120"></a><span id="l20.120" class="difflineminus">-                                contentType: 'text/plain',</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineminus">-                                format: '' }),</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+                              { filename: &quot;outer attachment.txt&quot;,</span>
<a href="#l20.123"></a><span id="l20.123" class="difflineplus">+                                contentType: &quot;text/plain&quot;,</span>
<a href="#l20.124"></a><span id="l20.124" class="difflineplus">+                                format: &quot;&quot; }),</span>
<a href="#l20.125"></a><span id="l20.125">         attachedMessage,</span>
<a href="#l20.126"></a><span id="l20.126">       ]),</span>
<a href="#l20.127"></a><span id="l20.127">     },</span>
<a href="#l20.128"></a><span id="l20.128">     // evilly-named attachment; spaces should be collapsed and trimmed on the</span>
<a href="#l20.129"></a><span id="l20.129">     // ends</span>
<a href="#l20.130"></a><span id="l20.130">     { attachments: [{ body: textAttachment,</span>
<a href="#l20.131"></a><span id="l20.131" class="difflineminus">-                      contentType: 'application/octet-stream',</span>
<a href="#l20.132"></a><span id="l20.132" class="difflineminus">-                      filename: ' ubik  .txt                            .evil ',</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineminus">-                      sanitizedFilename: 'ubik .txt .evil',</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineminus">-                      format: '' }],</span>
<a href="#l20.135"></a><span id="l20.135" class="difflineplus">+                      contentType: &quot;application/octet-stream&quot;,</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineplus">+                      filename: &quot; ubik  .txt                            .evil &quot;,</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineplus">+                      sanitizedFilename: &quot;ubik .txt .evil&quot;,</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineplus">+                      format: &quot;&quot; }],</span>
<a href="#l20.139"></a><span id="l20.139">     },</span>
<a href="#l20.140"></a><span id="l20.140">     // another evilly-named attachment; filename has 10 &quot;_&quot;s, which should be</span>
<a href="#l20.141"></a><span id="l20.141">     // just enough to trigger the sanitizer</span>
<a href="#l20.142"></a><span id="l20.142">     { attachments: [{ body: textAttachment,</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineminus">-                      contentType: 'application/octet-stream',</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineminus">-                      filename: 'ubik.txt__________.evil',</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineminus">-                      sanitizedFilename: 'ubik.txt__.evil',</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineminus">-                      format: '' }],</span>
<a href="#l20.147"></a><span id="l20.147" class="difflineplus">+                      contentType: &quot;application/octet-stream&quot;,</span>
<a href="#l20.148"></a><span id="l20.148" class="difflineplus">+                      filename: &quot;ubik.txt__________.evil&quot;,</span>
<a href="#l20.149"></a><span id="l20.149" class="difflineplus">+                      sanitizedFilename: &quot;ubik.txt__.evil&quot;,</span>
<a href="#l20.150"></a><span id="l20.150" class="difflineplus">+                      format: &quot;&quot; }],</span>
<a href="#l20.151"></a><span id="l20.151">     },</span>
<a href="#l20.152"></a><span id="l20.152">   ];</span>
<a href="#l20.153"></a><span id="l20.153"> </span>
<a href="#l20.154"></a><span id="l20.154">   // Add another evilly-named attachment for Windows tests, to ensure that</span>
<a href="#l20.155"></a><span id="l20.155">   // trailing periods are stripped.</span>
<a href="#l20.156"></a><span id="l20.156" class="difflineminus">-  if ('@mozilla.org/windows-registry-key;1' in Cc) {</span>
<a href="#l20.157"></a><span id="l20.157" class="difflineplus">+  if (&quot;@mozilla.org/windows-registry-key;1&quot; in Cc) {</span>
<a href="#l20.158"></a><span id="l20.158">     messages.push({ attachments: [{ body: textAttachment,</span>
<a href="#l20.159"></a><span id="l20.159" class="difflineminus">-                                    contentType: 'application/octet-stream',</span>
<a href="#l20.160"></a><span id="l20.160" class="difflineminus">-                                    filename: 'ubik.evil. . . . . . . . . ....',</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineminus">-                                    sanitizedFilename: 'ubik.evil',</span>
<a href="#l20.162"></a><span id="l20.162" class="difflineminus">-                                    format: '' }],</span>
<a href="#l20.163"></a><span id="l20.163" class="difflineplus">+                                    contentType: &quot;application/octet-stream&quot;,</span>
<a href="#l20.164"></a><span id="l20.164" class="difflineplus">+                                    filename: &quot;ubik.evil. . . . . . . . . ....&quot;,</span>
<a href="#l20.165"></a><span id="l20.165" class="difflineplus">+                                    sanitizedFilename: &quot;ubik.evil&quot;,</span>
<a href="#l20.166"></a><span id="l20.166" class="difflineplus">+                                    format: &quot;&quot; }],</span>
<a href="#l20.167"></a><span id="l20.167">                   });</span>
<a href="#l20.168"></a><span id="l20.168">   }</span>
<a href="#l20.169"></a><span id="l20.169"> </span>
<a href="#l20.170"></a><span id="l20.170">   for (let i = 0; i &lt; messages.length; i++)</span>
<a href="#l20.171"></a><span id="l20.171">     add_message_to_folder(folder, create_message(messages[i]));</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineminus">-};</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineplus">+}</span>
<a href="#l20.174"></a><span id="l20.174"> </span>
<a href="#l20.175"></a><span id="l20.175"> /**</span>
<a href="#l20.176"></a><span id="l20.176">  * Set the pref to ensure that the attachments pane starts out (un)expanded</span>
<a href="#l20.177"></a><span id="l20.177">  *</span>
<a href="#l20.178"></a><span id="l20.178">  * @param expand true if the attachment pane should start out expanded,</span>
<a href="#l20.179"></a><span id="l20.179">  *        false otherwise</span>
<a href="#l20.180"></a><span id="l20.180">  */</span>
<a href="#l20.181"></a><span id="l20.181"> function ensure_starts_expanded(expand) {</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineat">@@ -151,17 +153,17 @@ function test_attachment_view_collapsed(</span>
<a href="#l20.183"></a><span id="l20.183"> function test_attachment_view_expanded() {</span>
<a href="#l20.184"></a><span id="l20.184">   be_in_folder(folder);</span>
<a href="#l20.185"></a><span id="l20.185"> </span>
<a href="#l20.186"></a><span id="l20.186">   for (let i = 1; i &lt; messages.length; i++) {</span>
<a href="#l20.187"></a><span id="l20.187">     select_click_row(i);</span>
<a href="#l20.188"></a><span id="l20.188">     assert_selected_and_displayed(i);</span>
<a href="#l20.189"></a><span id="l20.189"> </span>
<a href="#l20.190"></a><span id="l20.190">     if (mc.e(&quot;attachmentView&quot;).collapsed)</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-      throw new Error(&quot;Attachment pane collapsed (on message #&quot;+i+</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineplus">+      throw new Error(&quot;Attachment pane collapsed (on message #&quot; + i +</span>
<a href="#l20.193"></a><span id="l20.193">                       &quot; when it shouldn't be!&quot;);</span>
<a href="#l20.194"></a><span id="l20.194">   }</span>
<a href="#l20.195"></a><span id="l20.195"> }</span>
<a href="#l20.196"></a><span id="l20.196"> </span>
<a href="#l20.197"></a><span id="l20.197"> function test_attachment_name_sanitization() {</span>
<a href="#l20.198"></a><span id="l20.198">   be_in_folder(folder);</span>
<a href="#l20.199"></a><span id="l20.199"> </span>
<a href="#l20.200"></a><span id="l20.200">   let attachmentList = mc.e(&quot;attachmentList&quot;);</span>
<a href="#l20.201"></a><span id="l20.201" class="difflineat">@@ -273,17 +275,17 @@ function test_attachment_right_click_sin</span>
<a href="#l20.202"></a><span id="l20.202">   subtest_attachment_right_click(&quot;attachmentToggle&quot;,</span>
<a href="#l20.203"></a><span id="l20.203">                                  &quot;attachment-toolbar-context-menu&quot;);</span>
<a href="#l20.204"></a><span id="l20.204">   subtest_attachment_right_click(&quot;attachmentSaveAllSingle&quot;,</span>
<a href="#l20.205"></a><span id="l20.205">                                  &quot;attachment-toolbar-context-menu&quot;);</span>
<a href="#l20.206"></a><span id="l20.206">   subtest_attachment_right_click(&quot;attachmentBar&quot;,</span>
<a href="#l20.207"></a><span id="l20.207">                                  &quot;attachment-toolbar-context-menu&quot;);</span>
<a href="#l20.208"></a><span id="l20.208"> }</span>
<a href="#l20.209"></a><span id="l20.209"> // Re-enable this test once Bug 617311 is fixed.</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineminus">-test_attachment_right_click_single.EXCLUDED_PLATFORMS = ['linux'];</span>
<a href="#l20.211"></a><span id="l20.211" class="difflineplus">+test_attachment_right_click_single.EXCLUDED_PLATFORMS = [&quot;linux&quot;];</span>
<a href="#l20.212"></a><span id="l20.212"> </span>
<a href="#l20.213"></a><span id="l20.213"> function test_attachment_right_click_multiple() {</span>
<a href="#l20.214"></a><span id="l20.214">   be_in_folder(folder);</span>
<a href="#l20.215"></a><span id="l20.215"> </span>
<a href="#l20.216"></a><span id="l20.216">   select_click_row(3);</span>
<a href="#l20.217"></a><span id="l20.217">   assert_selected_and_displayed(3);</span>
<a href="#l20.218"></a><span id="l20.218"> </span>
<a href="#l20.219"></a><span id="l20.219">   subtest_attachment_right_click(&quot;attachmentIcon&quot;, &quot;attachmentListContext&quot;);</span>
<a href="#l20.220"></a><span id="l20.220" class="difflineat">@@ -293,36 +295,36 @@ function test_attachment_right_click_mul</span>
<a href="#l20.221"></a><span id="l20.221">   subtest_attachment_right_click(&quot;attachmentToggle&quot;,</span>
<a href="#l20.222"></a><span id="l20.222">                                  &quot;attachment-toolbar-context-menu&quot;);</span>
<a href="#l20.223"></a><span id="l20.223">   subtest_attachment_right_click(&quot;attachmentSaveAllMultiple&quot;,</span>
<a href="#l20.224"></a><span id="l20.224">                                  &quot;attachment-toolbar-context-menu&quot;);</span>
<a href="#l20.225"></a><span id="l20.225">   subtest_attachment_right_click(&quot;attachmentBar&quot;,</span>
<a href="#l20.226"></a><span id="l20.226">                                  &quot;attachment-toolbar-context-menu&quot;);</span>
<a href="#l20.227"></a><span id="l20.227"> }</span>
<a href="#l20.228"></a><span id="l20.228"> // Re-enable this test once Bug 617311 is fixed.</span>
<a href="#l20.229"></a><span id="l20.229" class="difflineminus">-test_attachment_right_click_multiple.EXCLUDED_PLATFORMS = ['linux'];</span>
<a href="#l20.230"></a><span id="l20.230" class="difflineplus">+test_attachment_right_click_multiple.EXCLUDED_PLATFORMS = [&quot;linux&quot;];</span>
<a href="#l20.231"></a><span id="l20.231"> </span>
<a href="#l20.232"></a><span id="l20.232"> /**</span>
<a href="#l20.233"></a><span id="l20.233">  * Test that clicking on various elements in the attachment bar toggles the</span>
<a href="#l20.234"></a><span id="l20.234">  * attachment list.</span>
<a href="#l20.235"></a><span id="l20.235">  *</span>
<a href="#l20.236"></a><span id="l20.236">  * @param elementId the id of the element to click</span>
<a href="#l20.237"></a><span id="l20.237">  */</span>
<a href="#l20.238"></a><span id="l20.238"> function subtest_attachment_list_toggle(elementId) {</span>
<a href="#l20.239"></a><span id="l20.239">   let attachmentList = mc.e(&quot;attachmentList&quot;);</span>
<a href="#l20.240"></a><span id="l20.240">   let element = mc.eid(elementId);</span>
<a href="#l20.241"></a><span id="l20.241"> </span>
<a href="#l20.242"></a><span id="l20.242">   mc.click(element);</span>
<a href="#l20.243"></a><span id="l20.243">   assert_true(!attachmentList.collapsed, &quot;Attachment list should be expanded &quot; +</span>
<a href="#l20.244"></a><span id="l20.244" class="difflineminus">-              &quot;after clicking &quot;+elementId+&quot;!&quot;);</span>
<a href="#l20.245"></a><span id="l20.245" class="difflineplus">+              &quot;after clicking &quot; + elementId + &quot;!&quot;);</span>
<a href="#l20.246"></a><span id="l20.246">   assert_attachment_list_focused();</span>
<a href="#l20.247"></a><span id="l20.247"> </span>
<a href="#l20.248"></a><span id="l20.248">   mc.click(element);</span>
<a href="#l20.249"></a><span id="l20.249">   assert_true(attachmentList.collapsed, &quot;Attachment list should be collapsed &quot; +</span>
<a href="#l20.250"></a><span id="l20.250" class="difflineminus">-              &quot;after clicking &quot;+elementId+&quot; again!&quot;);</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineplus">+              &quot;after clicking &quot; + elementId + &quot; again!&quot;);</span>
<a href="#l20.252"></a><span id="l20.252">   assert_message_pane_focused();</span>
<a href="#l20.253"></a><span id="l20.253"> }</span>
<a href="#l20.254"></a><span id="l20.254"> </span>
<a href="#l20.255"></a><span id="l20.255"> function test_attachment_list_expansion() {</span>
<a href="#l20.256"></a><span id="l20.256">   be_in_folder(folder);</span>
<a href="#l20.257"></a><span id="l20.257"> </span>
<a href="#l20.258"></a><span id="l20.258">   select_click_row(1);</span>
<a href="#l20.259"></a><span id="l20.259">   assert_selected_and_displayed(1);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -3,23 +3,29 @@</span>
<a href="#l21.4"></a><span id="l21.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.5"></a><span id="l21.5"> </span>
<a href="#l21.6"></a><span id="l21.6"> /**</span>
<a href="#l21.7"></a><span id="l21.7">  * Tests Filelink attachment item behaviour.</span>
<a href="#l21.8"></a><span id="l21.8">  */</span>
<a href="#l21.9"></a><span id="l21.9"> </span>
<a href="#l21.10"></a><span id="l21.10"> &quot;use strict&quot;;</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-cloudfile-helpers.js */</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-attachment-helpers.js */</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineplus">+</span>
<a href="#l21.17"></a><span id="l21.17"> var MODULE_NAME = &quot;test-cloudfile-attachment-item&quot;;</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-</span>
<a href="#l21.19"></a><span id="l21.19"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l21.21"></a><span id="l21.21" class="difflineminus">-                       &quot;compose-helpers&quot;,</span>
<a href="#l21.22"></a><span id="l21.22" class="difflineminus">-                       &quot;cloudfile-helpers&quot;,</span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-                       &quot;attachment-helpers&quot;];</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l21.25"></a><span id="l21.25" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l21.26"></a><span id="l21.26" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l21.27"></a><span id="l21.27" class="difflineplus">+  &quot;cloudfile-helpers&quot;,</span>
<a href="#l21.28"></a><span id="l21.28" class="difflineplus">+  &quot;attachment-helpers&quot;,</span>
<a href="#l21.29"></a><span id="l21.29" class="difflineplus">+];</span>
<a href="#l21.30"></a><span id="l21.30"> </span>
<a href="#l21.31"></a><span id="l21.31"> var kAttachmentItemContextID = &quot;msgComposeAttachmentItemContext&quot;;</span>
<a href="#l21.32"></a><span id="l21.32"> </span>
<a href="#l21.33"></a><span id="l21.33"> var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l21.34"></a><span id="l21.34"> </span>
<a href="#l21.35"></a><span id="l21.35"> function setupModule(module) {</span>
<a href="#l21.36"></a><span id="l21.36">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l21.37"></a><span id="l21.37">     collector.getModule(lib).installInto(module);</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineat">@@ -61,25 +67,22 @@ function test_upload_cancel_repeat() {</span>
<a href="#l21.39"></a><span id="l21.39">   provider.uploadFile = function(aFile) {</span>
<a href="#l21.40"></a><span id="l21.40">     return new Promise((resolve, reject) =&gt; {</span>
<a href="#l21.41"></a><span id="l21.41">       promise = { resolve, reject };</span>
<a href="#l21.42"></a><span id="l21.42">       started = true;</span>
<a href="#l21.43"></a><span id="l21.43">     });</span>
<a href="#l21.44"></a><span id="l21.44">   };</span>
<a href="#l21.45"></a><span id="l21.45"> </span>
<a href="#l21.46"></a><span id="l21.46">   const kAttempts = 3;</span>
<a href="#l21.47"></a><span id="l21.47" class="difflineminus">-  let cmd = cw.e(&quot;cmd_cancelUpload&quot;);</span>
<a href="#l21.48"></a><span id="l21.48" class="difflineminus">-  let menu = cw.getMenu(&quot;#&quot; + kAttachmentItemContextID);</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-</span>
<a href="#l21.50"></a><span id="l21.50">   for (let i = 0; i &lt; kAttempts; i++) {</span>
<a href="#l21.51"></a><span id="l21.51">     promise = null;</span>
<a href="#l21.52"></a><span id="l21.52">     started = false;</span>
<a href="#l21.53"></a><span id="l21.53"> </span>
<a href="#l21.54"></a><span id="l21.54">     // Select the attachment, and choose to convert it to a Filelink</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineminus">-    let attachmentitem = select_attachments(cw, 0)[0];</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineplus">+    select_attachments(cw, 0)[0];</span>
<a href="#l21.57"></a><span id="l21.57">     cw.window.convertSelectedToCloudAttachment(provider);</span>
<a href="#l21.58"></a><span id="l21.58">     cw.waitFor(() =&gt; started);</span>
<a href="#l21.59"></a><span id="l21.59"> </span>
<a href="#l21.60"></a><span id="l21.60">     assert_can_cancel_upload(cw, provider, promise, file);</span>
<a href="#l21.61"></a><span id="l21.61">   }</span>
<a href="#l21.62"></a><span id="l21.62"> </span>
<a href="#l21.63"></a><span id="l21.63">   close_compose_window(cw);</span>
<a href="#l21.64"></a><span id="l21.64"> }</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineat">@@ -140,21 +143,20 @@ function assert_can_cancel_upload(aContr</span>
<a href="#l21.66"></a><span id="l21.66">     }</span>
<a href="#l21.67"></a><span id="l21.67">   };</span>
<a href="#l21.68"></a><span id="l21.68"> </span>
<a href="#l21.69"></a><span id="l21.69">   // Retrieve the attachment bucket index for the target file...</span>
<a href="#l21.70"></a><span id="l21.70">   let index = get_attachmentitem_index_for_file(aController,</span>
<a href="#l21.71"></a><span id="l21.71">                                                 aTargetFile);</span>
<a href="#l21.72"></a><span id="l21.72"> </span>
<a href="#l21.73"></a><span id="l21.73">   // Select that attachmentitem in the bucket</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineminus">-  let attachmentitem = select_attachments(aController, index)[0];</span>
<a href="#l21.75"></a><span id="l21.75" class="difflineplus">+  select_attachments(aController, index)[0];</span>
<a href="#l21.76"></a><span id="l21.76"> </span>
<a href="#l21.77"></a><span id="l21.77">   // Bring up the context menu, and click cancel.</span>
<a href="#l21.78"></a><span id="l21.78">   let cmd = aController.e(&quot;cmd_cancelUpload&quot;);</span>
<a href="#l21.79"></a><span id="l21.79" class="difflineminus">-  let menu = aController.getMenu(&quot;#&quot; + kAttachmentItemContextID);</span>
<a href="#l21.80"></a><span id="l21.80">   aController.window.updateAttachmentItems();</span>
<a href="#l21.81"></a><span id="l21.81"> </span>
<a href="#l21.82"></a><span id="l21.82">   assert_false(cmd.hidden);</span>
<a href="#l21.83"></a><span id="l21.83">   assert_false(cmd.disabled);</span>
<a href="#l21.84"></a><span id="l21.84">   let cancelItem = aController.eid(&quot;composeAttachmentContext_cancelUploadItem&quot;);</span>
<a href="#l21.85"></a><span id="l21.85">   aController.click(cancelItem);</span>
<a href="#l21.86"></a><span id="l21.86"> </span>
<a href="#l21.87"></a><span id="l21.87">   // Close the popup, and wait for the cancellation to be complete.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -3,25 +3,33 @@</span>
<a href="#l22.4"></a><span id="l22.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.5"></a><span id="l22.5"> </span>
<a href="#l22.6"></a><span id="l22.6"> /**</span>
<a href="#l22.7"></a><span id="l22.7">  * Tests Filelink URL insertion behaviours in compose windows.</span>
<a href="#l22.8"></a><span id="l22.8">  */</span>
<a href="#l22.9"></a><span id="l22.9"> </span>
<a href="#l22.10"></a><span id="l22.10"> &quot;use strict&quot;;</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-cloudfile-helpers.js */</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-attachment-helpers.js */</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-dom-helpers.js */</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+</span>
<a href="#l22.19"></a><span id="l22.19"> var MODULE_NAME = &quot;test-cloudfile-attachment-urls&quot;;</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-</span>
<a href="#l22.21"></a><span id="l22.21"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-                       &quot;compose-helpers&quot;,</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-                       &quot;cloudfile-helpers&quot;,</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-                       &quot;attachment-helpers&quot;,</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-                       &quot;dom-helpers&quot;,</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-                       &quot;window-helpers&quot;];</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineplus">+  &quot;cloudfile-helpers&quot;,</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineplus">+  &quot;attachment-helpers&quot;,</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineplus">+  &quot;dom-helpers&quot;,</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+];</span>
<a href="#l22.36"></a><span id="l22.36"> </span>
<a href="#l22.37"></a><span id="l22.37"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l22.38"></a><span id="l22.38"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l22.39"></a><span id="l22.39"> </span>
<a href="#l22.40"></a><span id="l22.40"> var kUploadedFile = &quot;attachment-uploaded&quot;;</span>
<a href="#l22.41"></a><span id="l22.41"> var kHtmlPrefKey = &quot;mail.identity.default.compose_html&quot;;</span>
<a href="#l22.42"></a><span id="l22.42"> var kReplyOnTopKey = &quot;mail.identity.default.reply_on_top&quot;;</span>
<a href="#l22.43"></a><span id="l22.43"> var kReplyOnTop = 1;</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineat">@@ -239,17 +247,17 @@ function test_inserts_linebreak_on_empty</span>
<a href="#l22.45"></a><span id="l22.45">  */</span>
<a href="#l22.46"></a><span id="l22.46"> function subtest_inserts_linebreak_on_empty_compose() {</span>
<a href="#l22.47"></a><span id="l22.47">   gMockFilePicker.returnFiles = collectFiles(kFiles, __file__);</span>
<a href="#l22.48"></a><span id="l22.48">   let provider = new MockCloudfileAccount();</span>
<a href="#l22.49"></a><span id="l22.49">   provider.init(&quot;someKey&quot;);</span>
<a href="#l22.50"></a><span id="l22.50">   let cw = open_compose_new_mail();</span>
<a href="#l22.51"></a><span id="l22.51">   add_cloud_attachments(cw, provider);</span>
<a href="#l22.52"></a><span id="l22.52"> </span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-  let [root, list, urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineplus">+  let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.55"></a><span id="l22.55"> </span>
<a href="#l22.56"></a><span id="l22.56">   let br = root.previousSibling;</span>
<a href="#l22.57"></a><span id="l22.57">   assert_equals(br.localName, &quot;br&quot;,</span>
<a href="#l22.58"></a><span id="l22.58">                 &quot;The attachment URL containment node should be preceded by &quot; +</span>
<a href="#l22.59"></a><span id="l22.59">                 &quot;a linebreak&quot;);</span>
<a href="#l22.60"></a><span id="l22.60"> </span>
<a href="#l22.61"></a><span id="l22.61">   let mailBody = get_compose_body(cw);</span>
<a href="#l22.62"></a><span id="l22.62"> </span>
<a href="#l22.63"></a><span id="l22.63" class="difflineat">@@ -270,17 +278,17 @@ function test_inserts_linebreak_on_empty</span>
<a href="#l22.64"></a><span id="l22.64">   gMockFilePicker.returnFiles = collectFiles(kFiles, __file__);</span>
<a href="#l22.65"></a><span id="l22.65">   let provider = new MockCloudfileAccount();</span>
<a href="#l22.66"></a><span id="l22.66">   provider.init(&quot;someKey&quot;);</span>
<a href="#l22.67"></a><span id="l22.67">   let cw = open_compose_new_mail();</span>
<a href="#l22.68"></a><span id="l22.68">   add_cloud_attachments(cw, provider);</span>
<a href="#l22.69"></a><span id="l22.69">   // wait_for_attachment_urls ensures that the attachment URL containment</span>
<a href="#l22.70"></a><span id="l22.70">   // node is an immediate child of the body of the message, so if this</span>
<a href="#l22.71"></a><span id="l22.71">   // succeeds, then we were not in the signature node.</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-  let [root, list, urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineplus">+  let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.74"></a><span id="l22.74"> </span>
<a href="#l22.75"></a><span id="l22.75">   let br = assert_previous_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l22.76"></a><span id="l22.76"> </span>
<a href="#l22.77"></a><span id="l22.77">   let mailBody = get_compose_body(cw);</span>
<a href="#l22.78"></a><span id="l22.78">   assert_equals(mailBody.firstChild, br,</span>
<a href="#l22.79"></a><span id="l22.79">                 &quot;The linebreak should be the first child of the compose body&quot;);</span>
<a href="#l22.80"></a><span id="l22.80"> </span>
<a href="#l22.81"></a><span id="l22.81">   // Now ensure that the node after the attachments is a br, and following</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineat">@@ -295,17 +303,17 @@ function test_inserts_linebreak_on_empty</span>
<a href="#l22.83"></a><span id="l22.83"> </span>
<a href="#l22.84"></a><span id="l22.84">   close_window(cw);</span>
<a href="#l22.85"></a><span id="l22.85"> </span>
<a href="#l22.86"></a><span id="l22.86">   Services.prefs.setBoolPref(kHtmlPrefKey, false);</span>
<a href="#l22.87"></a><span id="l22.87"> </span>
<a href="#l22.88"></a><span id="l22.88">   // Now let's try with plaintext mail.</span>
<a href="#l22.89"></a><span id="l22.89">   cw = open_compose_new_mail();</span>
<a href="#l22.90"></a><span id="l22.90">   add_cloud_attachments(cw, provider);</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineminus">-  [root, list, urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineplus">+  [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.93"></a><span id="l22.93"> </span>
<a href="#l22.94"></a><span id="l22.94">   br = assert_previous_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l22.95"></a><span id="l22.95"> </span>
<a href="#l22.96"></a><span id="l22.96">   mailBody = get_compose_body(cw);</span>
<a href="#l22.97"></a><span id="l22.97">   assert_equals(mailBody.firstChild, br,</span>
<a href="#l22.98"></a><span id="l22.98">                 &quot;The linebreak should be the first child of the compose body&quot;);</span>
<a href="#l22.99"></a><span id="l22.99"> </span>
<a href="#l22.100"></a><span id="l22.100">   // Now ensure that the node after the attachments is a br, and following</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineat">@@ -331,17 +339,17 @@ function test_removing_filelinks_removes</span>
<a href="#l22.102"></a><span id="l22.102"> }</span>
<a href="#l22.103"></a><span id="l22.103"> </span>
<a href="#l22.104"></a><span id="l22.104"> /**</span>
<a href="#l22.105"></a><span id="l22.105">  * Test for test_removing_filelinks_removes_root_node - can be executed</span>
<a href="#l22.106"></a><span id="l22.106">  * on both plaintext and HTML compose windows.</span>
<a href="#l22.107"></a><span id="l22.107">  */</span>
<a href="#l22.108"></a><span id="l22.108"> function subtest_removing_filelinks_removes_root_node() {</span>
<a href="#l22.109"></a><span id="l22.109">   let cw = prepare_some_attachments_and_reply([], kFiles);</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineminus">-  let [root, list, urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineplus">+  let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.112"></a><span id="l22.112"> </span>
<a href="#l22.113"></a><span id="l22.113">   // Now select the attachments in the attachment bucket, and remove them.</span>
<a href="#l22.114"></a><span id="l22.114">   select_attachments(cw, 0, 1);</span>
<a href="#l22.115"></a><span id="l22.115">   cw.window.goDoCommand(&quot;cmd_delete&quot;);</span>
<a href="#l22.116"></a><span id="l22.116"> </span>
<a href="#l22.117"></a><span id="l22.117">   // Wait for the root to be removed.</span>
<a href="#l22.118"></a><span id="l22.118">   let mailBody = get_compose_body(cw);</span>
<a href="#l22.119"></a><span id="l22.119">   cw.waitFor(function() {</span>
<a href="#l22.120"></a><span id="l22.120" class="difflineat">@@ -370,17 +378,17 @@ function subtest_adding_filelinks_to_wri</span>
<a href="#l22.121"></a><span id="l22.121">   gMockFilePicker.returnFiles = collectFiles(kFiles, __file__);</span>
<a href="#l22.122"></a><span id="l22.122">   let provider = new MockCloudfileAccount();</span>
<a href="#l22.123"></a><span id="l22.123">   provider.init(&quot;someKey&quot;);</span>
<a href="#l22.124"></a><span id="l22.124">   let cw = open_compose_new_mail();</span>
<a href="#l22.125"></a><span id="l22.125"> </span>
<a href="#l22.126"></a><span id="l22.126">   type_in_composer(cw, kLines);</span>
<a href="#l22.127"></a><span id="l22.127">   add_cloud_attachments(cw, provider);</span>
<a href="#l22.128"></a><span id="l22.128"> </span>
<a href="#l22.129"></a><span id="l22.129" class="difflineminus">-  let [root, list, urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineplus">+  let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.131"></a><span id="l22.131"> </span>
<a href="#l22.132"></a><span id="l22.132">   let br = root.previousSibling;</span>
<a href="#l22.133"></a><span id="l22.133">   assert_equals(br.localName, &quot;br&quot;,</span>
<a href="#l22.134"></a><span id="l22.134">                 &quot;The attachment URL containment node should be preceded by &quot; +</span>
<a href="#l22.135"></a><span id="l22.135">                 &quot;a linebreak&quot;);</span>
<a href="#l22.136"></a><span id="l22.136">   br = br.previousSibling;</span>
<a href="#l22.137"></a><span id="l22.137">   assert_equals(br.localName, &quot;br&quot;,</span>
<a href="#l22.138"></a><span id="l22.138">                 &quot;The attachment URL containment node should be preceded by &quot; +</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineat">@@ -426,17 +434,17 @@ function test_adding_filelinks_to_nonemp</span>
<a href="#l22.140"></a><span id="l22.140"> </span>
<a href="#l22.141"></a><span id="l22.141"> /**</span>
<a href="#l22.142"></a><span id="l22.142">  * Subtest for test_adding_filelinks_to_reply_above for the plaintext composer.</span>
<a href="#l22.143"></a><span id="l22.143">  * Does some special casing for the weird br insertions that happens in</span>
<a href="#l22.144"></a><span id="l22.144">  * various cases.</span>
<a href="#l22.145"></a><span id="l22.145">  */</span>
<a href="#l22.146"></a><span id="l22.146"> function subtest_adding_filelinks_to_reply_above_plaintext(aText, aWithSig) {</span>
<a href="#l22.147"></a><span id="l22.147">   let cw = prepare_some_attachments_and_reply(aText, kFiles);</span>
<a href="#l22.148"></a><span id="l22.148" class="difflineminus">-  let [root, list, urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.149"></a><span id="l22.149" class="difflineplus">+  let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.150"></a><span id="l22.150"> </span>
<a href="#l22.151"></a><span id="l22.151">   let br;</span>
<a href="#l22.152"></a><span id="l22.152">   if (aText.length)</span>
<a href="#l22.153"></a><span id="l22.153">     br = assert_next_nodes(&quot;br&quot;, root, 2);</span>
<a href="#l22.154"></a><span id="l22.154">   else</span>
<a href="#l22.155"></a><span id="l22.155">     br = assert_next_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l22.156"></a><span id="l22.156"> </span>
<a href="#l22.157"></a><span id="l22.157">   let div = br.nextSibling;</span>
<a href="#l22.158"></a><span id="l22.158" class="difflineat">@@ -467,17 +475,17 @@ function subtest_adding_filelinks_to_rep</span>
<a href="#l22.159"></a><span id="l22.159">   close_window(cw);</span>
<a href="#l22.160"></a><span id="l22.160"> }</span>
<a href="#l22.161"></a><span id="l22.161"> </span>
<a href="#l22.162"></a><span id="l22.162"> /**</span>
<a href="#l22.163"></a><span id="l22.163">  * Subtest for test_adding_filelinks_to_reply_above for the HTML composer.</span>
<a href="#l22.164"></a><span id="l22.164">  */</span>
<a href="#l22.165"></a><span id="l22.165"> function subtest_adding_filelinks_to_reply_above(aText) {</span>
<a href="#l22.166"></a><span id="l22.166">   let cw = prepare_some_attachments_and_reply(aText, kFiles);</span>
<a href="#l22.167"></a><span id="l22.167" class="difflineminus">-  let [root, list, urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.168"></a><span id="l22.168" class="difflineplus">+  let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.169"></a><span id="l22.169"> </span>
<a href="#l22.170"></a><span id="l22.170">   // If there's any text written, then there's only a single break between the</span>
<a href="#l22.171"></a><span id="l22.171">   // end of the text and the reply. Otherwise, there are two breaks.</span>
<a href="#l22.172"></a><span id="l22.172">   let br = aText.length &gt; 1 ? assert_next_nodes(&quot;br&quot;, root, 2)</span>
<a href="#l22.173"></a><span id="l22.173">                             : assert_next_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l22.174"></a><span id="l22.174"> </span>
<a href="#l22.175"></a><span id="l22.175">   // ... which is followed by a div with a class of &quot;moz-cite-prefix&quot;.</span>
<a href="#l22.176"></a><span id="l22.176">   let div = br.nextSibling;</span>
<a href="#l22.177"></a><span id="l22.177" class="difflineat">@@ -526,17 +534,17 @@ function test_adding_filelinks_to_nonemp</span>
<a href="#l22.178"></a><span id="l22.178">   Services.prefs.setIntPref(kReplyOnTopKey, oldReplyOnTop);</span>
<a href="#l22.179"></a><span id="l22.179"> }</span>
<a href="#l22.180"></a><span id="l22.180"> </span>
<a href="#l22.181"></a><span id="l22.181"> /**</span>
<a href="#l22.182"></a><span id="l22.182">  * Subtest for test_adding_filelinks_to_reply_below for the HTML composer.</span>
<a href="#l22.183"></a><span id="l22.183">  */</span>
<a href="#l22.184"></a><span id="l22.184"> function subtest_adding_filelinks_to_reply_below(aText, aWithSig) {</span>
<a href="#l22.185"></a><span id="l22.185">   let cw = prepare_some_attachments_and_reply(aText, kFiles);</span>
<a href="#l22.186"></a><span id="l22.186" class="difflineminus">-  let [root, list, urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.187"></a><span id="l22.187" class="difflineplus">+  let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.188"></a><span id="l22.188">   // So, we should have the root, followed by a br</span>
<a href="#l22.189"></a><span id="l22.189">   let br = root.nextSibling;</span>
<a href="#l22.190"></a><span id="l22.190">   assert_equals(br.localName, &quot;br&quot;,</span>
<a href="#l22.191"></a><span id="l22.191">                 &quot;The attachment URL containment node should be followed by &quot; +</span>
<a href="#l22.192"></a><span id="l22.192">                 &quot; a br&quot;);</span>
<a href="#l22.193"></a><span id="l22.193"> </span>
<a href="#l22.194"></a><span id="l22.194">   let blockquote;</span>
<a href="#l22.195"></a><span id="l22.195">   if (aText.length) {</span>
<a href="#l22.196"></a><span id="l22.196" class="difflineat">@@ -564,17 +572,17 @@ function subtest_adding_filelinks_to_rep</span>
<a href="#l22.197"></a><span id="l22.197">   close_window(cw);</span>
<a href="#l22.198"></a><span id="l22.198"> }</span>
<a href="#l22.199"></a><span id="l22.199"> </span>
<a href="#l22.200"></a><span id="l22.200"> /**</span>
<a href="#l22.201"></a><span id="l22.201">  * Subtest for test_adding_filelinks_to_reply_below for the plaintext composer.</span>
<a href="#l22.202"></a><span id="l22.202">  */</span>
<a href="#l22.203"></a><span id="l22.203"> function subtest_adding_filelinks_to_plaintext_reply_below(aText, aWithSig) {</span>
<a href="#l22.204"></a><span id="l22.204">   let cw = prepare_some_attachments_and_reply(aText, kFiles);</span>
<a href="#l22.205"></a><span id="l22.205" class="difflineminus">-  let [root, list, urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.206"></a><span id="l22.206" class="difflineplus">+  let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.207"></a><span id="l22.207"> </span>
<a href="#l22.208"></a><span id="l22.208">   let br, span;</span>
<a href="#l22.209"></a><span id="l22.209"> </span>
<a href="#l22.210"></a><span id="l22.210">   assert_next_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l22.211"></a><span id="l22.211"> </span>
<a href="#l22.212"></a><span id="l22.212">   if (aText.length) {</span>
<a href="#l22.213"></a><span id="l22.213">     br = assert_previous_nodes(&quot;br&quot;, root, 2);</span>
<a href="#l22.214"></a><span id="l22.214">     // If text was entered, make sure it matches what we expect...</span>
<a href="#l22.215"></a><span id="l22.215" class="difflineat">@@ -632,28 +640,28 @@ function test_adding_filelinks_to_forwar</span>
<a href="#l22.216"></a><span id="l22.216"> </span>
<a href="#l22.217"></a><span id="l22.217"> /**</span>
<a href="#l22.218"></a><span id="l22.218">  * Subtest for both test_adding_filelinks_to_empty_forward and</span>
<a href="#l22.219"></a><span id="l22.219">  * test_adding_filelinks_to_forward - ensures that the inserted Filelinks</span>
<a href="#l22.220"></a><span id="l22.220">  * are positioned correctly.</span>
<a href="#l22.221"></a><span id="l22.221">  */</span>
<a href="#l22.222"></a><span id="l22.222"> function subtest_adding_filelinks_to_forward(aText, aWithSig) {</span>
<a href="#l22.223"></a><span id="l22.223">   let cw = prepare_some_attachments_and_forward(aText, kFiles);</span>
<a href="#l22.224"></a><span id="l22.224" class="difflineminus">-  let [root, list, urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.225"></a><span id="l22.225" class="difflineplus">+  let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.226"></a><span id="l22.226"> </span>
<a href="#l22.227"></a><span id="l22.227">   let br = assert_next_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l22.228"></a><span id="l22.228">   let forwardDiv = br.nextSibling;</span>
<a href="#l22.229"></a><span id="l22.229">   assert_equals(forwardDiv.localName, &quot;div&quot;);</span>
<a href="#l22.230"></a><span id="l22.230">   assert_true(forwardDiv.classList.contains(&quot;moz-forward-container&quot;));</span>
<a href="#l22.231"></a><span id="l22.231"> </span>
<a href="#l22.232"></a><span id="l22.232">   if (aText.length) {</span>
<a href="#l22.233"></a><span id="l22.233">     // If there was text typed in, it should be separated from the root by two</span>
<a href="#l22.234"></a><span id="l22.234">     // br's</span>
<a href="#l22.235"></a><span id="l22.235">     let br = assert_previous_nodes(&quot;br&quot;, root, 2);</span>
<a href="#l22.236"></a><span id="l22.236" class="difflineminus">-    let textNode = assert_previous_text(br.previousSibling, aText);</span>
<a href="#l22.237"></a><span id="l22.237" class="difflineplus">+    assert_previous_text(br.previousSibling, aText);</span>
<a href="#l22.238"></a><span id="l22.238">   } else {</span>
<a href="#l22.239"></a><span id="l22.239">     // Otherwise, there's only 1 br, and that br should be the first element</span>
<a href="#l22.240"></a><span id="l22.240">     // of the message body.</span>
<a href="#l22.241"></a><span id="l22.241">     let br = assert_previous_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l22.242"></a><span id="l22.242">     let mailBody = get_compose_body(cw);</span>
<a href="#l22.243"></a><span id="l22.243">     assert_equals(br, mailBody.firstChild);</span>
<a href="#l22.244"></a><span id="l22.244">   }</span>
<a href="#l22.245"></a><span id="l22.245"> </span>
<a href="#l22.246"></a><span id="l22.246" class="difflineat">@@ -680,24 +688,24 @@ function subtest_converting_filelink_upd</span>
<a href="#l22.247"></a><span id="l22.247">   let providerA = new MockCloudfileAccount();</span>
<a href="#l22.248"></a><span id="l22.248">   let providerB = new MockCloudfileAccount();</span>
<a href="#l22.249"></a><span id="l22.249">   providerA.init(&quot;providerA&quot;);</span>
<a href="#l22.250"></a><span id="l22.250">   providerB.init(&quot;providerB&quot;);</span>
<a href="#l22.251"></a><span id="l22.251"> </span>
<a href="#l22.252"></a><span id="l22.252">   let cw = open_compose_new_mail();</span>
<a href="#l22.253"></a><span id="l22.253">   add_cloud_attachments(cw, providerA);</span>
<a href="#l22.254"></a><span id="l22.254"> </span>
<a href="#l22.255"></a><span id="l22.255" class="difflineminus">-  let [root, list, urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.256"></a><span id="l22.256" class="difflineplus">+  let [, , urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.257"></a><span id="l22.257"> </span>
<a href="#l22.258"></a><span id="l22.258">   // Convert each Filelink to providerB, ensuring that the URLs are replaced.</span>
<a href="#l22.259"></a><span id="l22.259">   for (let i = 0; i &lt; kFiles.length; ++i) {</span>
<a href="#l22.260"></a><span id="l22.260">     let url = urls[i];</span>
<a href="#l22.261"></a><span id="l22.261">     select_attachments(cw, i);</span>
<a href="#l22.262"></a><span id="l22.262">     cw.window.convertSelectedToCloudAttachment(providerB);</span>
<a href="#l22.263"></a><span id="l22.263" class="difflineminus">-    [root, list, urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.264"></a><span id="l22.264" class="difflineplus">+    [, , urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.265"></a><span id="l22.265"> </span>
<a href="#l22.266"></a><span id="l22.266">     let newUrl = urls[i];</span>
<a href="#l22.267"></a><span id="l22.267"> </span>
<a href="#l22.268"></a><span id="l22.268">     assert_not_equals(url, newUrl,</span>
<a href="#l22.269"></a><span id="l22.269">                       &quot;The original URL should have been replaced&quot;);</span>
<a href="#l22.270"></a><span id="l22.270">   }</span>
<a href="#l22.271"></a><span id="l22.271"> </span>
<a href="#l22.272"></a><span id="l22.272">   close_window(cw);</span>
<a href="#l22.273"></a><span id="l22.273" class="difflineat">@@ -721,17 +729,17 @@ function test_converting_filelink_to_nor</span>
<a href="#l22.274"></a><span id="l22.274"> function subtest_converting_filelink_to_normal_removes_url() {</span>
<a href="#l22.275"></a><span id="l22.275">   gMockFilePicker.returnFiles = collectFiles(kFiles, __file__);</span>
<a href="#l22.276"></a><span id="l22.276">   let provider = new MockCloudfileAccount();</span>
<a href="#l22.277"></a><span id="l22.277">   provider.init(&quot;someKey&quot;);</span>
<a href="#l22.278"></a><span id="l22.278"> </span>
<a href="#l22.279"></a><span id="l22.279">   let cw = open_compose_new_mail();</span>
<a href="#l22.280"></a><span id="l22.280">   add_cloud_attachments(cw, provider);</span>
<a href="#l22.281"></a><span id="l22.281"> </span>
<a href="#l22.282"></a><span id="l22.282" class="difflineminus">-  let [root, list, urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.283"></a><span id="l22.283" class="difflineplus">+  let [root, list] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.284"></a><span id="l22.284"> </span>
<a href="#l22.285"></a><span id="l22.285">   for (let i = 0; i &lt; kFiles.length; ++i) {</span>
<a href="#l22.286"></a><span id="l22.286">     select_attachments(cw, i);</span>
<a href="#l22.287"></a><span id="l22.287">     cw.window.convertSelectedToRegularAttachment();</span>
<a href="#l22.288"></a><span id="l22.288"> </span>
<a href="#l22.289"></a><span id="l22.289">     let urls = list.querySelectorAll(&quot;.cloudAttachmentItem&quot;);</span>
<a href="#l22.290"></a><span id="l22.290">     assert_equals(urls.length, kFiles.length - (i + 1));</span>
<a href="#l22.291"></a><span id="l22.291">   }</span>
<a href="#l22.292"></a><span id="l22.292" class="difflineat">@@ -762,24 +770,24 @@ function test_filelinks_work_after_manua</span>
<a href="#l22.293"></a><span id="l22.293"> function subtest_filelinks_work_after_manual_removal() {</span>
<a href="#l22.294"></a><span id="l22.294">   // Insert some Filelinks...</span>
<a href="#l22.295"></a><span id="l22.295">   gMockFilePicker.returnFiles = collectFiles(kFiles, __file__);</span>
<a href="#l22.296"></a><span id="l22.296">   let provider = new MockCloudfileAccount();</span>
<a href="#l22.297"></a><span id="l22.297">   provider.init(&quot;someKey&quot;);</span>
<a href="#l22.298"></a><span id="l22.298">   let cw = open_compose_new_mail();</span>
<a href="#l22.299"></a><span id="l22.299">   add_cloud_attachments(cw, provider);</span>
<a href="#l22.300"></a><span id="l22.300"> </span>
<a href="#l22.301"></a><span id="l22.301" class="difflineminus">-  let [root, list, urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.302"></a><span id="l22.302" class="difflineplus">+  let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.303"></a><span id="l22.303"> </span>
<a href="#l22.304"></a><span id="l22.304">   // Now remove the root node from the document body</span>
<a href="#l22.305"></a><span id="l22.305">   root.remove();</span>
<a href="#l22.306"></a><span id="l22.306"> </span>
<a href="#l22.307"></a><span id="l22.307">   gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile3&quot;], __file__);</span>
<a href="#l22.308"></a><span id="l22.308">   add_cloud_attachments(cw, provider);</span>
<a href="#l22.309"></a><span id="l22.309" class="difflineminus">-  [root, list, urls] = wait_for_attachment_urls(cw, 1);</span>
<a href="#l22.310"></a><span id="l22.310" class="difflineplus">+  [root] = wait_for_attachment_urls(cw, 1);</span>
<a href="#l22.311"></a><span id="l22.311"> </span>
<a href="#l22.312"></a><span id="l22.312">   close_window(cw);</span>
<a href="#l22.313"></a><span id="l22.313"> }</span>
<a href="#l22.314"></a><span id="l22.314"> </span>
<a href="#l22.315"></a><span id="l22.315"> /**</span>
<a href="#l22.316"></a><span id="l22.316">  * Test that if the users selection caret is on a newline when the URL</span>
<a href="#l22.317"></a><span id="l22.317">  * insertion occurs, that the caret does not move when the insertion is</span>
<a href="#l22.318"></a><span id="l22.318">  * complete. Tests both HTML and plaintext composers.</span>
<a href="#l22.319"></a><span id="l22.319" class="difflineat">@@ -805,19 +813,19 @@ function subtest_insertion_restores_care</span>
<a href="#l22.320"></a><span id="l22.320">   let editor = cw.window.GetCurrentEditor();</span>
<a href="#l22.321"></a><span id="l22.321">   editor.beginningOfDocument();</span>
<a href="#l22.322"></a><span id="l22.322"> </span>
<a href="#l22.323"></a><span id="l22.323">   // Do any necessary typing, ending with two linebreaks.</span>
<a href="#l22.324"></a><span id="l22.324">   type_in_composer(cw, [&quot;Line 1&quot;, &quot;Line 2&quot;, &quot;&quot;, &quot;&quot;]);</span>
<a href="#l22.325"></a><span id="l22.325"> </span>
<a href="#l22.326"></a><span id="l22.326">   // Attach some Filelinks.</span>
<a href="#l22.327"></a><span id="l22.327">   add_cloud_attachments(cw, provider);</span>
<a href="#l22.328"></a><span id="l22.328" class="difflineminus">-  let [root, list, urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.329"></a><span id="l22.329" class="difflineplus">+  let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l22.330"></a><span id="l22.330"> </span>
<a href="#l22.331"></a><span id="l22.331">   // Type some text.</span>
<a href="#l22.332"></a><span id="l22.332">   const kTypedIn = &quot;Test&quot;;</span>
<a href="#l22.333"></a><span id="l22.333">   type_in_composer(cw, [kTypedIn]);</span>
<a href="#l22.334"></a><span id="l22.334"> </span>
<a href="#l22.335"></a><span id="l22.335">   // That text should be inserted just above the root attachment URL node.</span>
<a href="#l22.336"></a><span id="l22.336" class="difflineminus">-  let textNode = assert_previous_text(root.previousSibling, [kTypedIn]);</span>
<a href="#l22.337"></a><span id="l22.337" class="difflineplus">+  assert_previous_text(root.previousSibling, [kTypedIn]);</span>
<a href="#l22.338"></a><span id="l22.338"> </span>
<a href="#l22.339"></a><span id="l22.339">   close_window(cw);</span>
<a href="#l22.340"></a><span id="l22.340"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-manager.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-manager.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -4,24 +4,31 @@</span>
<a href="#l23.4"></a><span id="l23.4"> </span>
<a href="#l23.5"></a><span id="l23.5"> /**</span>
<a href="#l23.6"></a><span id="l23.6">  * Tests the richlistbox in the manager for attachment storage</span>
<a href="#l23.7"></a><span id="l23.7">  * services</span>
<a href="#l23.8"></a><span id="l23.8">  */</span>
<a href="#l23.9"></a><span id="l23.9"> </span>
<a href="#l23.10"></a><span id="l23.10"> &quot;use strict&quot;;</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-cloudfile-helpers.js */</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-pref-window-helpers.js */</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineplus">+</span>
<a href="#l23.18"></a><span id="l23.18"> var MODULE_NAME = &quot;test-cloudfile-manager&quot;;</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-</span>
<a href="#l23.20"></a><span id="l23.20"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l23.21"></a><span id="l23.21" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l23.22"></a><span id="l23.22" class="difflineminus">-                       &quot;pref-window-helpers&quot;,</span>
<a href="#l23.23"></a><span id="l23.23" class="difflineminus">-                       &quot;content-tab-helpers&quot;,</span>
<a href="#l23.24"></a><span id="l23.24" class="difflineminus">-                       &quot;cloudfile-helpers&quot;,</span>
<a href="#l23.25"></a><span id="l23.25" class="difflineminus">-                       &quot;window-helpers&quot;];</span>
<a href="#l23.26"></a><span id="l23.26" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l23.27"></a><span id="l23.27" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineplus">+  &quot;pref-window-helpers&quot;,</span>
<a href="#l23.29"></a><span id="l23.29" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l23.30"></a><span id="l23.30" class="difflineplus">+  &quot;cloudfile-helpers&quot;,</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l23.32"></a><span id="l23.32" class="difflineplus">+];</span>
<a href="#l23.33"></a><span id="l23.33"> </span>
<a href="#l23.34"></a><span id="l23.34"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l23.35"></a><span id="l23.35"> </span>
<a href="#l23.36"></a><span id="l23.36"> var kTestAccountType = &quot;mock&quot;;</span>
<a href="#l23.37"></a><span id="l23.37"> var kRootURL = collector.addHttpResource(&quot;../cloudfile/html&quot;, &quot;&quot;);</span>
<a href="#l23.38"></a><span id="l23.38"> var kSettingsWithLink = kRootURL + &quot;settings-with-link.xhtml&quot;;</span>
<a href="#l23.39"></a><span id="l23.39"> </span>
<a href="#l23.40"></a><span id="l23.40"> function setupModule(module) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -3,25 +3,33 @@</span>
<a href="#l24.4"></a><span id="l24.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6"> /**</span>
<a href="#l24.7"></a><span id="l24.7">  * Tests that the cloudfile notifications work as they should.</span>
<a href="#l24.8"></a><span id="l24.8">  */</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> &quot;use strict&quot;;</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-cloudfile-helpers.js */</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-attachment-helpers.js */</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-prompt-helpers.js */</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-notificationbox-helpers.js */</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+</span>
<a href="#l24.19"></a><span id="l24.19"> var MODULE_NAME = &quot;test-cloudfile-notifications&quot;;</span>
<a href="#l24.20"></a><span id="l24.20" class="difflineminus">-</span>
<a href="#l24.21"></a><span id="l24.21"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l24.22"></a><span id="l24.22" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l24.23"></a><span id="l24.23" class="difflineminus">-                       &quot;compose-helpers&quot;,</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-                       &quot;cloudfile-helpers&quot;,</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineminus">-                       &quot;attachment-helpers&quot;,</span>
<a href="#l24.26"></a><span id="l24.26" class="difflineminus">-                       &quot;prompt-helpers&quot;,</span>
<a href="#l24.27"></a><span id="l24.27" class="difflineminus">-                       &quot;notificationbox-helpers&quot;];</span>
<a href="#l24.28"></a><span id="l24.28" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l24.29"></a><span id="l24.29" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l24.30"></a><span id="l24.30" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l24.31"></a><span id="l24.31" class="difflineplus">+  &quot;cloudfile-helpers&quot;,</span>
<a href="#l24.32"></a><span id="l24.32" class="difflineplus">+  &quot;attachment-helpers&quot;,</span>
<a href="#l24.33"></a><span id="l24.33" class="difflineplus">+  &quot;prompt-helpers&quot;,</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineplus">+  &quot;notificationbox-helpers&quot;,</span>
<a href="#l24.35"></a><span id="l24.35" class="difflineplus">+];</span>
<a href="#l24.36"></a><span id="l24.36"> </span>
<a href="#l24.37"></a><span id="l24.37"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l24.38"></a><span id="l24.38"> var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l24.39"></a><span id="l24.39"> </span>
<a href="#l24.40"></a><span id="l24.40"> var maxSize, oldInsertNotificationPref;</span>
<a href="#l24.41"></a><span id="l24.41"> </span>
<a href="#l24.42"></a><span id="l24.42"> var kOfferThreshold = &quot;mail.compose.big_attachments.threshold_kb&quot;;</span>
<a href="#l24.43"></a><span id="l24.43"> var kInsertNotificationPref = &quot;mail.compose.big_attachments.insert_notification&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-address-widgets.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-address-widgets.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -3,23 +3,25 @@</span>
<a href="#l25.4"></a><span id="l25.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.5"></a><span id="l25.5"> </span>
<a href="#l25.6"></a><span id="l25.6"> /**</span>
<a href="#l25.7"></a><span id="l25.7">  * Tests proper enabling of addressing widgets.</span>
<a href="#l25.8"></a><span id="l25.8">  */</span>
<a href="#l25.9"></a><span id="l25.9"> </span>
<a href="#l25.10"></a><span id="l25.10"> &quot;use strict&quot;;</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l25.16"></a><span id="l25.16"> </span>
<a href="#l25.17"></a><span id="l25.17"> var MODULE_NAME = &quot;test-address-widgets&quot;;</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l25.20"></a><span id="l25.20"> </span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;,</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-                         &quot;window-helpers&quot;];</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l25.25"></a><span id="l25.25"> </span>
<a href="#l25.26"></a><span id="l25.26"> var cwc = null; // compose window controller</span>
<a href="#l25.27"></a><span id="l25.27"> var accountPOP3 = null;</span>
<a href="#l25.28"></a><span id="l25.28"> var accountNNTP = null;</span>
<a href="#l25.29"></a><span id="l25.29"> var originalAccountCount;</span>
<a href="#l25.30"></a><span id="l25.30"> </span>
<a href="#l25.31"></a><span id="l25.31"> function setupModule(module) {</span>
<a href="#l25.32"></a><span id="l25.32">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineat">@@ -28,17 +30,17 @@ function setupModule(module) {</span>
<a href="#l25.34"></a><span id="l25.34"> </span>
<a href="#l25.35"></a><span id="l25.35">   // Ensure we're in the tinderbox account as that has the right identities set</span>
<a href="#l25.36"></a><span id="l25.36">   // up for this test.</span>
<a href="#l25.37"></a><span id="l25.37">   let server = MailServices.accounts.FindServer(&quot;tinderbox&quot;, FAKE_SERVER_HOSTNAME, &quot;pop3&quot;);</span>
<a href="#l25.38"></a><span id="l25.38">   accountPOP3 = MailServices.accounts.FindAccountForServer(server);</span>
<a href="#l25.39"></a><span id="l25.39"> </span>
<a href="#l25.40"></a><span id="l25.40">   // There may be pre-existing accounts from other tests.</span>
<a href="#l25.41"></a><span id="l25.41">   originalAccountCount = MailServices.accounts.allServers.length;</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-};</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineplus">+}</span>
<a href="#l25.44"></a><span id="l25.44"> </span>
<a href="#l25.45"></a><span id="l25.45"> function teardownModule(module) {</span>
<a href="#l25.46"></a><span id="l25.46"> }</span>
<a href="#l25.47"></a><span id="l25.47"> </span>
<a href="#l25.48"></a><span id="l25.48"> /**</span>
<a href="#l25.49"></a><span id="l25.49">  * Check if the address type items are in the wished state.</span>
<a href="#l25.50"></a><span id="l25.50">  *</span>
<a href="#l25.51"></a><span id="l25.51">  * @param aItemsEnabled  List of item values that should be enabled (uncollapsed).</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-attachment-reminder.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-attachment-reminder.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -1,28 +1,33 @@</span>
<a href="#l26.4"></a><span id="l26.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l26.5"></a><span id="l26.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l26.6"></a><span id="l26.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l26.7"></a><span id="l26.7"> </span>
<a href="#l26.8"></a><span id="l26.8"> /**</span>
<a href="#l26.9"></a><span id="l26.9">  * Tests that the attachment reminder works properly.</span>
<a href="#l26.10"></a><span id="l26.10">  */</span>
<a href="#l26.11"></a><span id="l26.11"> </span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-// make SOLO_TEST=composition/test-attachment-reminder.js mozmill-one</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l26.14"></a><span id="l26.14"> </span>
<a href="#l26.15"></a><span id="l26.15" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l26.16"></a><span id="l26.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-keyboard-helpers.js */</span>
<a href="#l26.19"></a><span id="l26.19" class="difflineplus">+/* import-globals-from ../shared-modules/test-notificationbox-helpers.js */</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l26.21"></a><span id="l26.21"> </span>
<a href="#l26.22"></a><span id="l26.22"> var MODULE_NAME = &quot;test-attachment-reminder&quot;;</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineminus">-</span>
<a href="#l26.24"></a><span id="l26.24"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l26.25"></a><span id="l26.25" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l26.26"></a><span id="l26.26" class="difflineminus">-                         &quot;compose-helpers&quot;,</span>
<a href="#l26.27"></a><span id="l26.27" class="difflineminus">-                         &quot;window-helpers&quot;,</span>
<a href="#l26.28"></a><span id="l26.28" class="difflineminus">-                         &quot;notificationbox-helpers&quot;,</span>
<a href="#l26.29"></a><span id="l26.29" class="difflineminus">-                         &quot;keyboard-helpers&quot;];</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l26.31"></a><span id="l26.31" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l26.32"></a><span id="l26.32" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+  &quot;notificationbox-helpers&quot;,</span>
<a href="#l26.35"></a><span id="l26.35" class="difflineplus">+  &quot;keyboard-helpers&quot;,</span>
<a href="#l26.36"></a><span id="l26.36" class="difflineplus">+];</span>
<a href="#l26.37"></a><span id="l26.37"> </span>
<a href="#l26.38"></a><span id="l26.38"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l26.39"></a><span id="l26.39"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l26.40"></a><span id="l26.40"> </span>
<a href="#l26.41"></a><span id="l26.41"> var kBoxId = &quot;compose-notification-bottom&quot;;</span>
<a href="#l26.42"></a><span id="l26.42"> var kNotificationId = &quot;attachmentReminder&quot;;</span>
<a href="#l26.43"></a><span id="l26.43"> var kReminderPref = &quot;mail.compose.attachment_reminder&quot;;</span>
<a href="#l26.44"></a><span id="l26.44"> var gDrafts;</span>
<a href="#l26.45"></a><span id="l26.45" class="difflineat">@@ -412,18 +417,17 @@ function test_manual_automatic_attachmen</span>
<a href="#l26.46"></a><span id="l26.46"> </span>
<a href="#l26.47"></a><span id="l26.47"> /**</span>
<a href="#l26.48"></a><span id="l26.48">  * Assert if there is any notification in the compose window.</span>
<a href="#l26.49"></a><span id="l26.49">  *</span>
<a href="#l26.50"></a><span id="l26.50">  * @param aCwc         Compose Window Controller</span>
<a href="#l26.51"></a><span id="l26.51">  * @param aValue       True if notification should exist.</span>
<a href="#l26.52"></a><span id="l26.52">  *                     False otherwise.</span>
<a href="#l26.53"></a><span id="l26.53">  */</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-function assert_any_notification(aCwc, aValue)</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-{</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+function assert_any_notification(aCwc, aValue) {</span>
<a href="#l26.57"></a><span id="l26.57">   let notification = aCwc.e(kBoxId).currentNotification;</span>
<a href="#l26.58"></a><span id="l26.58">   if ((notification == null) == aValue)</span>
<a href="#l26.59"></a><span id="l26.59">     throw new Error(&quot;Notification in wrong state&quot;);</span>
<a href="#l26.60"></a><span id="l26.60"> }</span>
<a href="#l26.61"></a><span id="l26.61"> </span>
<a href="#l26.62"></a><span id="l26.62"> /**</span>
<a href="#l26.63"></a><span id="l26.63">  * Bug 989653</span>
<a href="#l26.64"></a><span id="l26.64">  * Send filelink attachment should not trigger the attachment reminder.</span>
<a href="#l26.65"></a><span id="l26.65" class="difflineat">@@ -437,17 +441,17 @@ function test_attachment_vs_filelink_rem</span>
<a href="#l26.66"></a><span id="l26.66">   // There should be no notification yet.</span>
<a href="#l26.67"></a><span id="l26.67">   assert_any_notification(cwc, false);</span>
<a href="#l26.68"></a><span id="l26.68"> </span>
<a href="#l26.69"></a><span id="l26.69">   // Bring up the FileLink notification.</span>
<a href="#l26.70"></a><span id="l26.70">   let kOfferThreshold = &quot;mail.compose.big_attachments.threshold_kb&quot;;</span>
<a href="#l26.71"></a><span id="l26.71">   let maxSize = Services.prefs.getIntPref(kOfferThreshold, 0) * 1024;</span>
<a href="#l26.72"></a><span id="l26.72">   let file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l26.73"></a><span id="l26.73">   file.append(&quot;panacea.dat&quot;);</span>
<a href="#l26.74"></a><span id="l26.74" class="difflineminus">-  add_attachment(cwc, Services.io.newFileURI(file).spec, maxSize);</span>
<a href="#l26.75"></a><span id="l26.75" class="difflineplus">+  add_attachments(cwc, Services.io.newFileURI(file).spec, maxSize);</span>
<a href="#l26.76"></a><span id="l26.76"> </span>
<a href="#l26.77"></a><span id="l26.77">   // The filelink attachment proposal should be up but not the attachment</span>
<a href="#l26.78"></a><span id="l26.78">   // reminder and it should also not interfere with the sending of the message.</span>
<a href="#l26.79"></a><span id="l26.79">   wait_for_notification_to_show(cwc, kBoxId, &quot;bigAttachment&quot;);</span>
<a href="#l26.80"></a><span id="l26.80">   assert_automatic_reminder_state(cwc, false);</span>
<a href="#l26.81"></a><span id="l26.81"> </span>
<a href="#l26.82"></a><span id="l26.82">   click_send_and_handle_send_error(cwc);</span>
<a href="#l26.83"></a><span id="l26.83">   close_window(cwc);</span>
<a href="#l26.84"></a><span id="l26.84" class="difflineat">@@ -689,37 +693,37 @@ function click_send_and_handle_send_erro</span>
<a href="#l26.85"></a><span id="l26.85">     aController.click(aController.eid(&quot;button-send&quot;));</span>
<a href="#l26.86"></a><span id="l26.86">   wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l26.87"></a><span id="l26.87"> }</span>
<a href="#l26.88"></a><span id="l26.88"> </span>
<a href="#l26.89"></a><span id="l26.89"> /**</span>
<a href="#l26.90"></a><span id="l26.90">  * Click the &quot;Oh, I Did!&quot; button in the attachment reminder dialog.</span>
<a href="#l26.91"></a><span id="l26.91">  */</span>
<a href="#l26.92"></a><span id="l26.92"> function click_oh_i_did(controller) {</span>
<a href="#l26.93"></a><span id="l26.93" class="difflineminus">-  controller.window.document.documentElement.getButton('extra1').doCommand();</span>
<a href="#l26.94"></a><span id="l26.94" class="difflineplus">+  controller.window.document.documentElement.getButton(&quot;extra1&quot;).doCommand();</span>
<a href="#l26.95"></a><span id="l26.95"> }</span>
<a href="#l26.96"></a><span id="l26.96"> </span>
<a href="#l26.97"></a><span id="l26.97"> /**</span>
<a href="#l26.98"></a><span id="l26.98">  * Click the &quot;No, Send Now&quot; button in the attachment reminder dialog.</span>
<a href="#l26.99"></a><span id="l26.99">  */</span>
<a href="#l26.100"></a><span id="l26.100"> function click_no_send_now(controller) {</span>
<a href="#l26.101"></a><span id="l26.101" class="difflineminus">-  controller.window.document.documentElement.getButton('accept').doCommand();</span>
<a href="#l26.102"></a><span id="l26.102" class="difflineplus">+  controller.window.document.documentElement.getButton(&quot;accept&quot;).doCommand();</span>
<a href="#l26.103"></a><span id="l26.103"> }</span>
<a href="#l26.104"></a><span id="l26.104"> </span>
<a href="#l26.105"></a><span id="l26.105"> /**</span>
<a href="#l26.106"></a><span id="l26.106">  * Click Ok in the Send Message Error dialog.</span>
<a href="#l26.107"></a><span id="l26.107">  */</span>
<a href="#l26.108"></a><span id="l26.108"> function click_ok_on_send_error(controller) {</span>
<a href="#l26.109"></a><span id="l26.109">   if (controller.window.document.title != &quot;Send Message Error&quot;)</span>
<a href="#l26.110"></a><span id="l26.110">     throw new Error(&quot;Not a send error dialog; title=&quot; +</span>
<a href="#l26.111"></a><span id="l26.111">                     controller.window.document.title);</span>
<a href="#l26.112"></a><span id="l26.112" class="difflineminus">-  controller.window.document.documentElement.getButton('accept').doCommand();</span>
<a href="#l26.113"></a><span id="l26.113" class="difflineplus">+  controller.window.document.documentElement.getButton(&quot;accept&quot;).doCommand();</span>
<a href="#l26.114"></a><span id="l26.114"> }</span>
<a href="#l26.115"></a><span id="l26.115"> </span>
<a href="#l26.116"></a><span id="l26.116"> /**</span>
<a href="#l26.117"></a><span id="l26.117">  * Click Save in the Save message dialog.</span>
<a href="#l26.118"></a><span id="l26.118">  */</span>
<a href="#l26.119"></a><span id="l26.119"> function click_save_message(controller) {</span>
<a href="#l26.120"></a><span id="l26.120">   if (controller.window.document.title != &quot;Save Message&quot;)</span>
<a href="#l26.121"></a><span id="l26.121">     throw new Error(&quot;Not a Save message dialog; title=&quot; +</span>
<a href="#l26.122"></a><span id="l26.122">                     controller.window.document.title);</span>
<a href="#l26.123"></a><span id="l26.123" class="difflineminus">-  controller.window.document.documentElement.getButton('accept').doCommand();</span>
<a href="#l26.124"></a><span id="l26.124" class="difflineplus">+  controller.window.document.documentElement.getButton(&quot;accept&quot;).doCommand();</span>
<a href="#l26.125"></a><span id="l26.125"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-attachment.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-attachment.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -3,23 +3,25 @@</span>
<a href="#l27.4"></a><span id="l27.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l27.5"></a><span id="l27.5"> </span>
<a href="#l27.6"></a><span id="l27.6"> /**</span>
<a href="#l27.7"></a><span id="l27.7">  * Tests attachment handling functionality of the message compose window.</span>
<a href="#l27.8"></a><span id="l27.8">  */</span>
<a href="#l27.9"></a><span id="l27.9"> </span>
<a href="#l27.10"></a><span id="l27.10"> &quot;use strict&quot;;</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-var MODULE_NAME = 'test-attachment';</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l27.16"></a><span id="l27.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l27.18"></a><span id="l27.18"> </span>
<a href="#l27.19"></a><span id="l27.19" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'compose-helpers',</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineminus">-                       'window-helpers'];</span>
<a href="#l27.22"></a><span id="l27.22" class="difflineplus">+var MODULE_NAME = &quot;test-attachment&quot;;</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l27.24"></a><span id="l27.24" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l27.25"></a><span id="l27.25" class="difflineplus">+</span>
<a href="#l27.26"></a><span id="l27.26" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l27.27"></a><span id="l27.27"> </span>
<a href="#l27.28"></a><span id="l27.28"> var messenger;</span>
<a href="#l27.29"></a><span id="l27.29"> var folder;</span>
<a href="#l27.30"></a><span id="l27.30"> var epsilon;</span>
<a href="#l27.31"></a><span id="l27.31"> var isWindows;</span>
<a href="#l27.32"></a><span id="l27.32"> var filePrefix;</span>
<a href="#l27.33"></a><span id="l27.33"> </span>
<a href="#l27.34"></a><span id="l27.34"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineat">@@ -27,202 +29,202 @@ var {AppConstants} = ChromeUtils.import(</span>
<a href="#l27.36"></a><span id="l27.36"> </span>
<a href="#l27.37"></a><span id="l27.37"> var rawAttachment =</span>
<a href="#l27.38"></a><span id="l27.38">   &quot;Can't make the frug contest, Helen; stomach's upset. I'll fix you, &quot; +</span>
<a href="#l27.39"></a><span id="l27.39">   &quot;Ubik! Ubik drops you back in the thick of things fast. Taken as &quot; +</span>
<a href="#l27.40"></a><span id="l27.40">   &quot;directed, Ubik speeds relief to head and stomach. Remember: Ubik is &quot; +</span>
<a href="#l27.41"></a><span id="l27.41">   &quot;only seconds away. Avoid prolonged use.&quot;;</span>
<a href="#l27.42"></a><span id="l27.42"> </span>
<a href="#l27.43"></a><span id="l27.43"> var b64Attachment =</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineminus">-  'iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAABHNCSVQICAgIfAhkiAAAAAlwS' +</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineminus">-  'FlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAA' +</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-  'A5SURBVCiRY/z//z8DKYCJJNXkaGBgYGD4D8NQ5zUgiTVAxeBqSLaBkVRPM0KtIhrQ3km0jwe' +</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineminus">-  'SNQAAlmAY+71EgFoAAAAASUVORK5CYII=';</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineplus">+  &quot;iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAABHNCSVQICAgIfAhkiAAAAAlwS&quot; +</span>
<a href="#l27.49"></a><span id="l27.49" class="difflineplus">+  &quot;FlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAA&quot; +</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineplus">+  &quot;A5SURBVCiRY/z//z8DKYCJJNXkaGBgYGD4D8NQ5zUgiTVAxeBqSLaBkVRPM0KtIhrQ3km0jwe&quot; +</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineplus">+  &quot;SNQAAlmAY+71EgFoAAAAASUVORK5CYII=&quot;;</span>
<a href="#l27.52"></a><span id="l27.52"> var b64Size = 188;</span>
<a href="#l27.53"></a><span id="l27.53"> </span>
<a href="#l27.54"></a><span id="l27.54"> function setupModule(module) {</span>
<a href="#l27.55"></a><span id="l27.55">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l27.56"></a><span id="l27.56">     collector.getModule(lib).installInto(module);</span>
<a href="#l27.57"></a><span id="l27.57">   }</span>
<a href="#l27.58"></a><span id="l27.58"> </span>
<a href="#l27.59"></a><span id="l27.59" class="difflineminus">-  folder = create_folder('ComposeAttachmentA');</span>
<a href="#l27.60"></a><span id="l27.60" class="difflineplus">+  folder = create_folder(&quot;ComposeAttachmentA&quot;);</span>
<a href="#l27.61"></a><span id="l27.61"> </span>
<a href="#l27.62"></a><span id="l27.62" class="difflineminus">-  messenger = Cc['@mozilla.org/messenger;1']</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineplus">+  messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l27.64"></a><span id="l27.64">                 .createInstance(Ci.nsIMessenger);</span>
<a href="#l27.65"></a><span id="l27.65"> </span>
<a href="#l27.66"></a><span id="l27.66" class="difflineminus">-  isWindows = '@mozilla.org/windows-registry-key;1' in Cc;</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineplus">+  isWindows = &quot;@mozilla.org/windows-registry-key;1&quot; in Cc;</span>
<a href="#l27.68"></a><span id="l27.68"> </span>
<a href="#l27.69"></a><span id="l27.69">   /* Today's gory details (thanks to Jonathan Protzenko): libmime somehow</span>
<a href="#l27.70"></a><span id="l27.70">    * counts the trailing newline for an attachment MIME part. Most of the time,</span>
<a href="#l27.71"></a><span id="l27.71">    * assuming attachment has N bytes (no matter what's inside, newlines or</span>
<a href="#l27.72"></a><span id="l27.72">    * not), libmime will return N + 1 bytes. On Linux and Mac, this always</span>
<a href="#l27.73"></a><span id="l27.73">    * holds. However, on Windows, if the attachment is not encoded (that is, is</span>
<a href="#l27.74"></a><span id="l27.74">    * inline text), libmime will return N + 2 bytes. Since we're dealing with</span>
<a href="#l27.75"></a><span id="l27.75">    * forwarded message data here, the bonus byte(s) appear twice.</span>
<a href="#l27.76"></a><span id="l27.76">    */</span>
<a href="#l27.77"></a><span id="l27.77">   epsilon = isWindows ? 4 : 2;</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineminus">-  filePrefix = isWindows ? 'file:///C:/' : 'file:///';</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineplus">+  filePrefix = isWindows ? &quot;file:///C:/&quot; : &quot;file:///&quot;;</span>
<a href="#l27.80"></a><span id="l27.80"> </span>
<a href="#l27.81"></a><span id="l27.81">   // create some messages that have various types of attachments</span>
<a href="#l27.82"></a><span id="l27.82">   let messages = [</span>
<a href="#l27.83"></a><span id="l27.83">     // no attachment</span>
<a href="#l27.84"></a><span id="l27.84">     {},</span>
<a href="#l27.85"></a><span id="l27.85">     // raw attachment</span>
<a href="#l27.86"></a><span id="l27.86">     { attachments: [{ body: rawAttachment,</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineminus">-                      filename: 'ubik.txt',</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineminus">-                      format: '' }]},</span>
<a href="#l27.89"></a><span id="l27.89" class="difflineplus">+                      filename: &quot;ubik.txt&quot;,</span>
<a href="#l27.90"></a><span id="l27.90" class="difflineplus">+                      format: &quot;&quot; }]},</span>
<a href="#l27.91"></a><span id="l27.91">     // b64-encoded image attachment</span>
<a href="#l27.92"></a><span id="l27.92">     { attachments: [{ body: b64Attachment,</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineminus">-                      contentType: 'image/png',</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineminus">-                      filename: 'lines.png',</span>
<a href="#l27.95"></a><span id="l27.95" class="difflineminus">-                      encoding: 'base64',</span>
<a href="#l27.96"></a><span id="l27.96" class="difflineminus">-                      format: '' }]},</span>
<a href="#l27.97"></a><span id="l27.97" class="difflineplus">+                      contentType: &quot;image/png&quot;,</span>
<a href="#l27.98"></a><span id="l27.98" class="difflineplus">+                      filename: &quot;lines.png&quot;,</span>
<a href="#l27.99"></a><span id="l27.99" class="difflineplus">+                      encoding: &quot;base64&quot;,</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineplus">+                      format: &quot;&quot; }]},</span>
<a href="#l27.101"></a><span id="l27.101">     ];</span>
<a href="#l27.102"></a><span id="l27.102"> </span>
<a href="#l27.103"></a><span id="l27.103" class="difflineminus">-  for (let i=0; i&lt;messages.length; i++) {</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineplus">+  for (let i = 0; i &lt; messages.length; i++) {</span>
<a href="#l27.105"></a><span id="l27.105">     add_message_to_folder(folder, create_message(messages[i]));</span>
<a href="#l27.106"></a><span id="l27.106">   }</span>
<a href="#l27.107"></a><span id="l27.107"> }</span>
<a href="#l27.108"></a><span id="l27.108"> </span>
<a href="#l27.109"></a><span id="l27.109"> /**</span>
<a href="#l27.110"></a><span id="l27.110">  * Make sure that the attachment's size is what we expect</span>
<a href="#l27.111"></a><span id="l27.111">  * @param controller the controller for the compose window</span>
<a href="#l27.112"></a><span id="l27.112">  * @param index the attachment to examine, as an index into the listbox</span>
<a href="#l27.113"></a><span id="l27.113">  * @param expectedSize the expected size of the attachment, in bytes</span>
<a href="#l27.114"></a><span id="l27.114">  */</span>
<a href="#l27.115"></a><span id="l27.115"> function check_attachment_size(controller, index, expectedSize) {</span>
<a href="#l27.116"></a><span id="l27.116" class="difflineminus">-  let bucket = controller.e('attachmentBucket');</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineplus">+  let bucket = controller.e(&quot;attachmentBucket&quot;);</span>
<a href="#l27.118"></a><span id="l27.118">   let node = bucket.querySelectorAll(&quot;richlistitem.attachmentItem&quot;)[index];</span>
<a href="#l27.119"></a><span id="l27.119"> </span>
<a href="#l27.120"></a><span id="l27.120">   // First, let's check that the attachment size is correct</span>
<a href="#l27.121"></a><span id="l27.121">   let size = node.attachment.size;</span>
<a href="#l27.122"></a><span id="l27.122">   if (Math.abs(size - expectedSize) &gt; epsilon)</span>
<a href="#l27.123"></a><span id="l27.123" class="difflineminus">-    throw new Error('Reported attachment size ('+size+') not within epsilon ' +</span>
<a href="#l27.124"></a><span id="l27.124" class="difflineminus">-                    'of actual attachment size ('+expectedSize+')');</span>
<a href="#l27.125"></a><span id="l27.125" class="difflineplus">+    throw new Error(&quot;Reported attachment size (&quot; + size + &quot;) not within epsilon &quot; +</span>
<a href="#l27.126"></a><span id="l27.126" class="difflineplus">+                    &quot;of actual attachment size (&quot; + expectedSize + &quot;)&quot;);</span>
<a href="#l27.127"></a><span id="l27.127"> </span>
<a href="#l27.128"></a><span id="l27.128">   // Next, make sure that the formatted size in the label is correct</span>
<a href="#l27.129"></a><span id="l27.129" class="difflineminus">-  let formattedSize = node.getAttribute('size');</span>
<a href="#l27.130"></a><span id="l27.130" class="difflineplus">+  let formattedSize = node.getAttribute(&quot;size&quot;);</span>
<a href="#l27.131"></a><span id="l27.131">   let expectedFormattedSize = messenger.formatFileSize(size);</span>
<a href="#l27.132"></a><span id="l27.132">   if (formattedSize != expectedFormattedSize)</span>
<a href="#l27.133"></a><span id="l27.133" class="difflineminus">-    throw new Error('Formatted attachment size ('+formattedSize+') does not ' +</span>
<a href="#l27.134"></a><span id="l27.134" class="difflineminus">-                    'match expected value ('+expectedFormattedSize+')');</span>
<a href="#l27.135"></a><span id="l27.135" class="difflineplus">+    throw new Error(&quot;Formatted attachment size (&quot; + formattedSize + &quot;) does not &quot; +</span>
<a href="#l27.136"></a><span id="l27.136" class="difflineplus">+                    &quot;match expected value (&quot; + expectedFormattedSize + &quot;)&quot;);</span>
<a href="#l27.137"></a><span id="l27.137"> }</span>
<a href="#l27.138"></a><span id="l27.138"> </span>
<a href="#l27.139"></a><span id="l27.139"> /**</span>
<a href="#l27.140"></a><span id="l27.140">  * Make sure that the attachment's size is not displayed</span>
<a href="#l27.141"></a><span id="l27.141">  * @param controller the controller for the compose window</span>
<a href="#l27.142"></a><span id="l27.142">  * @param index the attachment to examine, as an index into the listbox</span>
<a href="#l27.143"></a><span id="l27.143">  */</span>
<a href="#l27.144"></a><span id="l27.144"> function check_no_attachment_size(controller, index) {</span>
<a href="#l27.145"></a><span id="l27.145" class="difflineminus">-  let bucket = controller.e('attachmentBucket');</span>
<a href="#l27.146"></a><span id="l27.146" class="difflineplus">+  let bucket = controller.e(&quot;attachmentBucket&quot;);</span>
<a href="#l27.147"></a><span id="l27.147">   let node = bucket.querySelectorAll(&quot;richlistitem.attachmentItem&quot;)[index];</span>
<a href="#l27.148"></a><span id="l27.148"> </span>
<a href="#l27.149"></a><span id="l27.149">   if (node.attachment.size != -1)</span>
<a href="#l27.150"></a><span id="l27.150" class="difflineminus">-    throw new Error('attachment.size attribute should be -1!');</span>
<a href="#l27.151"></a><span id="l27.151" class="difflineplus">+    throw new Error(&quot;attachment.size attribute should be -1!&quot;);</span>
<a href="#l27.152"></a><span id="l27.152"> </span>
<a href="#l27.153"></a><span id="l27.153">   // If there's no size, the size attribute is the zero-width space.</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineminus">-  if (node.getAttribute('size') != '\u200b')</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineminus">-    throw new Error('Attachment size should not be displayed!');</span>
<a href="#l27.156"></a><span id="l27.156" class="difflineplus">+  if (node.getAttribute(&quot;size&quot;) != &quot;\u200b&quot;)</span>
<a href="#l27.157"></a><span id="l27.157" class="difflineplus">+    throw new Error(&quot;Attachment size should not be displayed!&quot;);</span>
<a href="#l27.158"></a><span id="l27.158"> }</span>
<a href="#l27.159"></a><span id="l27.159"> </span>
<a href="#l27.160"></a><span id="l27.160"> /**</span>
<a href="#l27.161"></a><span id="l27.161">  * Make sure that the total size of all attachments is what we expect.</span>
<a href="#l27.162"></a><span id="l27.162">  * @param controller the controller for the compose window</span>
<a href="#l27.163"></a><span id="l27.163">  * @param count the expected number of attachments</span>
<a href="#l27.164"></a><span id="l27.164">  */</span>
<a href="#l27.165"></a><span id="l27.165"> function check_total_attachment_size(controller, count) {</span>
<a href="#l27.166"></a><span id="l27.166">   let bucket = controller.e(&quot;attachmentBucket&quot;);</span>
<a href="#l27.167"></a><span id="l27.167">   let nodes = bucket.querySelectorAll(&quot;richlistitem.attachmentItem&quot;);</span>
<a href="#l27.168"></a><span id="l27.168">   let sizeNode = controller.e(&quot;attachmentBucketSize&quot;);</span>
<a href="#l27.169"></a><span id="l27.169"> </span>
<a href="#l27.170"></a><span id="l27.170">   if (nodes.length != count)</span>
<a href="#l27.171"></a><span id="l27.171" class="difflineminus">-    throw new Error(&quot;Saw &quot;+nodes.length+&quot; attachments, but expected &quot;+count);</span>
<a href="#l27.172"></a><span id="l27.172" class="difflineplus">+    throw new Error(&quot;Saw &quot; + nodes.length + &quot; attachments, but expected &quot; + count);</span>
<a href="#l27.173"></a><span id="l27.173"> </span>
<a href="#l27.174"></a><span id="l27.174">   let size = 0;</span>
<a href="#l27.175"></a><span id="l27.175">   for (let i = 0; i &lt; nodes.length; i++) {</span>
<a href="#l27.176"></a><span id="l27.176">     let currSize = nodes[i].attachment.size;</span>
<a href="#l27.177"></a><span id="l27.177">     if (currSize != -1)</span>
<a href="#l27.178"></a><span id="l27.178">       size += currSize;</span>
<a href="#l27.179"></a><span id="l27.179">   }</span>
<a href="#l27.180"></a><span id="l27.180"> </span>
<a href="#l27.181"></a><span id="l27.181">   // Next, make sure that the formatted size in the label is correct</span>
<a href="#l27.182"></a><span id="l27.182">   let formattedSize = sizeNode.getAttribute(&quot;value&quot;);</span>
<a href="#l27.183"></a><span id="l27.183">   let expectedFormattedSize = messenger.formatFileSize(size);</span>
<a href="#l27.184"></a><span id="l27.184">   if (formattedSize != expectedFormattedSize)</span>
<a href="#l27.185"></a><span id="l27.185" class="difflineminus">-    throw new Error(&quot;Formatted attachment size (&quot;+formattedSize+&quot;) does not &quot; +</span>
<a href="#l27.186"></a><span id="l27.186" class="difflineminus">-                    &quot;match expected value (&quot;+expectedFormattedSize+&quot;)&quot;);</span>
<a href="#l27.187"></a><span id="l27.187" class="difflineplus">+    throw new Error(&quot;Formatted attachment size (&quot; + formattedSize + &quot;) does not &quot; +</span>
<a href="#l27.188"></a><span id="l27.188" class="difflineplus">+                    &quot;match expected value (&quot; + expectedFormattedSize + &quot;)&quot;);</span>
<a href="#l27.189"></a><span id="l27.189"> }</span>
<a href="#l27.190"></a><span id="l27.190"> </span>
<a href="#l27.191"></a><span id="l27.191"> function test_file_attachment() {</span>
<a href="#l27.192"></a><span id="l27.192">   let cwc = open_compose_new_mail();</span>
<a href="#l27.193"></a><span id="l27.193"> </span>
<a href="#l27.194"></a><span id="l27.194">   let url = filePrefix + &quot;some/file/here.txt&quot;;</span>
<a href="#l27.195"></a><span id="l27.195">   let size = 1234;</span>
<a href="#l27.196"></a><span id="l27.196"> </span>
<a href="#l27.197"></a><span id="l27.197" class="difflineminus">-  add_attachment(cwc, url, size);</span>
<a href="#l27.198"></a><span id="l27.198" class="difflineplus">+  add_attachments(cwc, url, size);</span>
<a href="#l27.199"></a><span id="l27.199">   check_attachment_size(cwc, 0, size);</span>
<a href="#l27.200"></a><span id="l27.200">   check_total_attachment_size(cwc, 1);</span>
<a href="#l27.201"></a><span id="l27.201"> </span>
<a href="#l27.202"></a><span id="l27.202">   close_compose_window(cwc);</span>
<a href="#l27.203"></a><span id="l27.203"> }</span>
<a href="#l27.204"></a><span id="l27.204"> </span>
<a href="#l27.205"></a><span id="l27.205"> function test_webpage_attachment() {</span>
<a href="#l27.206"></a><span id="l27.206">   let cwc = open_compose_new_mail();</span>
<a href="#l27.207"></a><span id="l27.207"> </span>
<a href="#l27.208"></a><span id="l27.208" class="difflineminus">-  add_attachment(cwc, &quot;http://www.mozilla.org/&quot;);</span>
<a href="#l27.209"></a><span id="l27.209" class="difflineplus">+  add_attachments(cwc, &quot;http://www.mozilla.org/&quot;);</span>
<a href="#l27.210"></a><span id="l27.210">   check_no_attachment_size(cwc, 0);</span>
<a href="#l27.211"></a><span id="l27.211">   check_total_attachment_size(cwc, 1);</span>
<a href="#l27.212"></a><span id="l27.212"> </span>
<a href="#l27.213"></a><span id="l27.213">   close_compose_window(cwc);</span>
<a href="#l27.214"></a><span id="l27.214"> }</span>
<a href="#l27.215"></a><span id="l27.215"> </span>
<a href="#l27.216"></a><span id="l27.216"> function test_multiple_attachments() {</span>
<a href="#l27.217"></a><span id="l27.217">   let cwc = open_compose_new_mail();</span>
<a href="#l27.218"></a><span id="l27.218"> </span>
<a href="#l27.219"></a><span id="l27.219">   let files = [{name: &quot;foo.txt&quot;, size: 1234},</span>
<a href="#l27.220"></a><span id="l27.220">                {name: &quot;bar.txt&quot;, size: 5678},</span>
<a href="#l27.221"></a><span id="l27.221">                {name: &quot;baz.txt&quot;, size: 9012}];</span>
<a href="#l27.222"></a><span id="l27.222">   for (let i = 0; i &lt; files.length; i++) {</span>
<a href="#l27.223"></a><span id="l27.223" class="difflineminus">-    add_attachment(cwc, filePrefix+files[i].name, files[i].size);</span>
<a href="#l27.224"></a><span id="l27.224" class="difflineplus">+    add_attachments(cwc, filePrefix + files[i].name, files[i].size);</span>
<a href="#l27.225"></a><span id="l27.225">     check_attachment_size(cwc, i, files[i].size);</span>
<a href="#l27.226"></a><span id="l27.226">   }</span>
<a href="#l27.227"></a><span id="l27.227"> </span>
<a href="#l27.228"></a><span id="l27.228">   check_total_attachment_size(cwc, files.length);</span>
<a href="#l27.229"></a><span id="l27.229">   close_compose_window(cwc);</span>
<a href="#l27.230"></a><span id="l27.230"> }</span>
<a href="#l27.231"></a><span id="l27.231"> </span>
<a href="#l27.232"></a><span id="l27.232"> function test_delete_attachments() {</span>
<a href="#l27.233"></a><span id="l27.233">   let cwc = open_compose_new_mail();</span>
<a href="#l27.234"></a><span id="l27.234"> </span>
<a href="#l27.235"></a><span id="l27.235">   let files = [{name: &quot;foo.txt&quot;, size: 1234},</span>
<a href="#l27.236"></a><span id="l27.236">                {name: &quot;bar.txt&quot;, size: 5678},</span>
<a href="#l27.237"></a><span id="l27.237">                {name: &quot;baz.txt&quot;, size: 9012}];</span>
<a href="#l27.238"></a><span id="l27.238">   for (let i = 0; i &lt; files.length; i++) {</span>
<a href="#l27.239"></a><span id="l27.239" class="difflineminus">-    add_attachment(cwc, filePrefix+files[i].name, files[i].size);</span>
<a href="#l27.240"></a><span id="l27.240" class="difflineplus">+    add_attachments(cwc, filePrefix + files[i].name, files[i].size);</span>
<a href="#l27.241"></a><span id="l27.241">     check_attachment_size(cwc, i, files[i].size);</span>
<a href="#l27.242"></a><span id="l27.242">   }</span>
<a href="#l27.243"></a><span id="l27.243"> </span>
<a href="#l27.244"></a><span id="l27.244">   delete_attachment(cwc, 0);</span>
<a href="#l27.245"></a><span id="l27.245" class="difflineminus">-  check_total_attachment_size(cwc, files.length-1);</span>
<a href="#l27.246"></a><span id="l27.246" class="difflineplus">+  check_total_attachment_size(cwc, files.length - 1);</span>
<a href="#l27.247"></a><span id="l27.247"> </span>
<a href="#l27.248"></a><span id="l27.248">   close_compose_window(cwc);</span>
<a href="#l27.249"></a><span id="l27.249"> }</span>
<a href="#l27.250"></a><span id="l27.250"> </span>
<a href="#l27.251"></a><span id="l27.251"> function subtest_rename_attachment(cwc) {</span>
<a href="#l27.252"></a><span id="l27.252">   cwc.e(&quot;loginTextbox&quot;).value = &quot;renamed.txt&quot;;</span>
<a href="#l27.253"></a><span id="l27.253" class="difflineminus">-  cwc.window.document.documentElement.getButton('accept').doCommand();</span>
<a href="#l27.254"></a><span id="l27.254" class="difflineplus">+  cwc.window.document.documentElement.getButton(&quot;accept&quot;).doCommand();</span>
<a href="#l27.255"></a><span id="l27.255"> }</span>
<a href="#l27.256"></a><span id="l27.256"> </span>
<a href="#l27.257"></a><span id="l27.257"> function test_rename_attachment() {</span>
<a href="#l27.258"></a><span id="l27.258">   let cwc = open_compose_new_mail();</span>
<a href="#l27.259"></a><span id="l27.259"> </span>
<a href="#l27.260"></a><span id="l27.260">   let url = filePrefix + &quot;some/file/here.txt&quot;;</span>
<a href="#l27.261"></a><span id="l27.261">   let size = 1234;</span>
<a href="#l27.262"></a><span id="l27.262"> </span>
<a href="#l27.263"></a><span id="l27.263" class="difflineminus">-  add_attachment(cwc, url, size);</span>
<a href="#l27.264"></a><span id="l27.264" class="difflineplus">+  add_attachments(cwc, url, size);</span>
<a href="#l27.265"></a><span id="l27.265"> </span>
<a href="#l27.266"></a><span id="l27.266">   // Now, rename the attachment.</span>
<a href="#l27.267"></a><span id="l27.267">   let bucket = cwc.e(&quot;attachmentBucket&quot;);</span>
<a href="#l27.268"></a><span id="l27.268">   let node = bucket.querySelector(&quot;richlistitem.attachmentItem&quot;);</span>
<a href="#l27.269"></a><span id="l27.269">   cwc.click(new elib.Elem(node));</span>
<a href="#l27.270"></a><span id="l27.270">   plan_for_modal_dialog(&quot;commonDialog&quot;, subtest_rename_attachment);</span>
<a href="#l27.271"></a><span id="l27.271">   cwc.window.RenameSelectedAttachment();</span>
<a href="#l27.272"></a><span id="l27.272">   wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l27.273"></a><span id="l27.273" class="difflineat">@@ -245,42 +247,42 @@ function test_open_attachment() {</span>
<a href="#l27.274"></a><span id="l27.274">   // set up our external file for attaching</span>
<a href="#l27.275"></a><span id="l27.275">   let thisFilePath = os.getFileForPath(__file__);</span>
<a href="#l27.276"></a><span id="l27.276">   let file = os.getFileForPath(os.abspath(&quot;./attachment.txt&quot;, thisFilePath));</span>
<a href="#l27.277"></a><span id="l27.277">   let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l27.278"></a><span id="l27.278">                             .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l27.279"></a><span id="l27.279">   let url = fileHandler.getURLSpecFromFile(file);</span>
<a href="#l27.280"></a><span id="l27.280">   let size = file.fileSize;</span>
<a href="#l27.281"></a><span id="l27.281"> </span>
<a href="#l27.282"></a><span id="l27.282" class="difflineminus">-  add_attachment(cwc, url, size);</span>
<a href="#l27.283"></a><span id="l27.283" class="difflineplus">+  add_attachments(cwc, url, size);</span>
<a href="#l27.284"></a><span id="l27.284"> </span>
<a href="#l27.285"></a><span id="l27.285">   // Now, open the attachment.</span>
<a href="#l27.286"></a><span id="l27.286">   let bucket = cwc.e(&quot;attachmentBucket&quot;);</span>
<a href="#l27.287"></a><span id="l27.287">   let node = bucket.querySelector(&quot;richlistitem.attachmentItem&quot;);</span>
<a href="#l27.288"></a><span id="l27.288">   plan_for_modal_dialog(&quot;unknownContentType&quot;, subtest_open_attachment);</span>
<a href="#l27.289"></a><span id="l27.289">   cwc.doubleClick(new elib.Elem(node));</span>
<a href="#l27.290"></a><span id="l27.290">   wait_for_modal_dialog(&quot;unknownContentType&quot;);</span>
<a href="#l27.291"></a><span id="l27.291"> </span>
<a href="#l27.292"></a><span id="l27.292">   close_compose_window(cwc);</span>
<a href="#l27.293"></a><span id="l27.293"> }</span>
<a href="#l27.294"></a><span id="l27.294"> </span>
<a href="#l27.295"></a><span id="l27.295"> function test_forward_raw_attachment() {</span>
<a href="#l27.296"></a><span id="l27.296">   be_in_folder(folder);</span>
<a href="#l27.297"></a><span id="l27.297" class="difflineminus">-  let curMessage = select_click_row(1);</span>
<a href="#l27.298"></a><span id="l27.298" class="difflineplus">+  select_click_row(1);</span>
<a href="#l27.299"></a><span id="l27.299"> </span>
<a href="#l27.300"></a><span id="l27.300">   let cwc = open_compose_with_forward();</span>
<a href="#l27.301"></a><span id="l27.301">   check_attachment_size(cwc, 0, rawAttachment.length);</span>
<a href="#l27.302"></a><span id="l27.302">   check_total_attachment_size(cwc, 1);</span>
<a href="#l27.303"></a><span id="l27.303"> </span>
<a href="#l27.304"></a><span id="l27.304">   close_compose_window(cwc);</span>
<a href="#l27.305"></a><span id="l27.305"> }</span>
<a href="#l27.306"></a><span id="l27.306"> </span>
<a href="#l27.307"></a><span id="l27.307"> function test_forward_b64_attachment() {</span>
<a href="#l27.308"></a><span id="l27.308">   be_in_folder(folder);</span>
<a href="#l27.309"></a><span id="l27.309" class="difflineminus">-  let curMessage = select_click_row(2);</span>
<a href="#l27.310"></a><span id="l27.310" class="difflineplus">+  select_click_row(2);</span>
<a href="#l27.311"></a><span id="l27.311"> </span>
<a href="#l27.312"></a><span id="l27.312">   let cwc = open_compose_with_forward();</span>
<a href="#l27.313"></a><span id="l27.313">   check_attachment_size(cwc, 0, b64Size);</span>
<a href="#l27.314"></a><span id="l27.314">   check_total_attachment_size(cwc, 1);</span>
<a href="#l27.315"></a><span id="l27.315"> </span>
<a href="#l27.316"></a><span id="l27.316">   close_compose_window(cwc);</span>
<a href="#l27.317"></a><span id="l27.317"> }</span>
<a href="#l27.318"></a><span id="l27.318"> </span>
<a href="#l27.319"></a><span id="l27.319" class="difflineat">@@ -329,17 +331,16 @@ function check_attachment_names(aControl</span>
<a href="#l27.320"></a><span id="l27.320">  *                    { focusEl: the element to be focused for keypresses</span>
<a href="#l27.321"></a><span id="l27.321">  *                      key:     keycode of key to press</span>
<a href="#l27.322"></a><span id="l27.322">  *                      key_modifiers: { accelKey: bool, ctrlKey: bool</span>
<a href="#l27.323"></a><span id="l27.323">  *                                       shiftKey: bool, altKey: bool, etc. },</span>
<a href="#l27.324"></a><span id="l27.324">  *                    }</span>
<a href="#l27.325"></a><span id="l27.325">  */</span>
<a href="#l27.326"></a><span id="l27.326"> function subtest_reordering_panel_keyboard(aCwc, aActions) {</span>
<a href="#l27.327"></a><span id="l27.327">   let panel = aCwc.e(&quot;reorderAttachmentsPanel&quot;);</span>
<a href="#l27.328"></a><span id="l27.328" class="difflineminus">-  let bucket = aCwc.e(&quot;attachmentBucket&quot;);</span>
<a href="#l27.329"></a><span id="l27.329"> </span>
<a href="#l27.330"></a><span id="l27.330">   for (let action of aActions) {</span>
<a href="#l27.331"></a><span id="l27.331">     aCwc.keypress(new elib.Elem(action.focusEl),</span>
<a href="#l27.332"></a><span id="l27.332">                   action.key, action.key_modifiers);</span>
<a href="#l27.333"></a><span id="l27.333">     wait_for_popup_to_open(panel);</span>
<a href="#l27.334"></a><span id="l27.334">     aCwc.sleep(0);</span>
<a href="#l27.335"></a><span id="l27.335"> </span>
<a href="#l27.336"></a><span id="l27.336">     // Press ESC which should close the panel.</span>
<a href="#l27.337"></a><span id="l27.337" class="difflineat">@@ -370,17 +371,17 @@ function subtest_reordering_panel_keyboa</span>
<a href="#l27.338"></a><span id="l27.338"> function subtest_reordering(aCwc, aInitialAttachmentNames,</span>
<a href="#l27.339"></a><span id="l27.339">                             aReorder_actions, aOpenPanel = true) {</span>
<a href="#l27.340"></a><span id="l27.340">   let bucket = aCwc.e(&quot;attachmentBucket&quot;);</span>
<a href="#l27.341"></a><span id="l27.341">   let panel;</span>
<a href="#l27.342"></a><span id="l27.342"> </span>
<a href="#l27.343"></a><span id="l27.343">   // Create a set of attachments for the test.</span>
<a href="#l27.344"></a><span id="l27.344">   const size = 1234;</span>
<a href="#l27.345"></a><span id="l27.345">   for (let name of aInitialAttachmentNames) {</span>
<a href="#l27.346"></a><span id="l27.346" class="difflineminus">-    add_attachment(aCwc, filePrefix + name, size);</span>
<a href="#l27.347"></a><span id="l27.347" class="difflineplus">+    add_attachments(aCwc, filePrefix + name, size);</span>
<a href="#l27.348"></a><span id="l27.348">   }</span>
<a href="#l27.349"></a><span id="l27.349">   aCwc.sleep(0);</span>
<a href="#l27.350"></a><span id="l27.350">   assert_equals(aCwc.window.attachmentsCount(), aInitialAttachmentNames.length);</span>
<a href="#l27.351"></a><span id="l27.351">   check_attachment_names(aCwc, aInitialAttachmentNames);</span>
<a href="#l27.352"></a><span id="l27.352"> </span>
<a href="#l27.353"></a><span id="l27.353">   if (aOpenPanel) {</span>
<a href="#l27.354"></a><span id="l27.354">     // Bring up the reordering panel.</span>
<a href="#l27.355"></a><span id="l27.355">     aCwc.window.showReorderAttachmentsPanel();</span>
<a href="#l27.356"></a><span id="l27.356" class="difflineat">@@ -421,28 +422,28 @@ function subtest_reordering(aCwc, aIniti</span>
<a href="#l27.357"></a><span id="l27.357">  * Check basic and advanced attachment reordering operations.</span>
<a href="#l27.358"></a><span id="l27.358">  * This is the main function of this test.</span>
<a href="#l27.359"></a><span id="l27.359">  */</span>
<a href="#l27.360"></a><span id="l27.360"> function test_attachment_reordering() {</span>
<a href="#l27.361"></a><span id="l27.361">   let cwc = open_compose_new_mail();</span>
<a href="#l27.362"></a><span id="l27.362">   let editorEl = cwc.window.GetCurrentEditorElement();</span>
<a href="#l27.363"></a><span id="l27.363">   let bucket = cwc.e(&quot;attachmentBucket&quot;);</span>
<a href="#l27.364"></a><span id="l27.364">   let panel = cwc.e(&quot;reorderAttachmentsPanel&quot;);</span>
<a href="#l27.365"></a><span id="l27.365" class="difflineminus">-  const openReorderPanelModifiers =</span>
<a href="#l27.366"></a><span id="l27.366" class="difflineminus">-    (AppConstants.platform == &quot;macosx&quot;) ? { controlKey: true }</span>
<a href="#l27.367"></a><span id="l27.367" class="difflineminus">-                                        : { altKey: true };</span>
<a href="#l27.368"></a><span id="l27.368" class="difflineplus">+  // const openReorderPanelModifiers =</span>
<a href="#l27.369"></a><span id="l27.369" class="difflineplus">+  //   (AppConstants.platform == &quot;macosx&quot;) ? { controlKey: true }</span>
<a href="#l27.370"></a><span id="l27.370" class="difflineplus">+  //                                       : { altKey: true };</span>
<a href="#l27.371"></a><span id="l27.371"> </span>
<a href="#l27.372"></a><span id="l27.372">   // First, some checks if the 'Reorder Attachments' panel</span>
<a href="#l27.373"></a><span id="l27.373">   // opens and closes correctly.</span>
<a href="#l27.374"></a><span id="l27.374"> </span>
<a href="#l27.375"></a><span id="l27.375">   // Create two attachments as otherwise the reordering panel won't open.</span>
<a href="#l27.376"></a><span id="l27.376">   const size = 1234;</span>
<a href="#l27.377"></a><span id="l27.377">   const initialAttachmentNames_0 = [&quot;A1&quot;, &quot;A2&quot;];</span>
<a href="#l27.378"></a><span id="l27.378">   for (let name of initialAttachmentNames_0) {</span>
<a href="#l27.379"></a><span id="l27.379" class="difflineminus">-    add_attachment(cwc, filePrefix + name, size);</span>
<a href="#l27.380"></a><span id="l27.380" class="difflineplus">+    add_attachments(cwc, filePrefix + name, size);</span>
<a href="#l27.381"></a><span id="l27.381">     cwc.sleep(0);</span>
<a href="#l27.382"></a><span id="l27.382">   }</span>
<a href="#l27.383"></a><span id="l27.383">   assert_equals(cwc.window.attachmentsCount(), initialAttachmentNames_0.length);</span>
<a href="#l27.384"></a><span id="l27.384">   check_attachment_names(cwc, initialAttachmentNames_0);</span>
<a href="#l27.385"></a><span id="l27.385"> </span>
<a href="#l27.386"></a><span id="l27.386">   // Show 'Reorder Attachments' panel via mouse clicks.</span>
<a href="#l27.387"></a><span id="l27.387">   cwc.rightClick(new elib.Elem(bucket.getItemAtIndex(1)));</span>
<a href="#l27.388"></a><span id="l27.388">   cwc.click_menus_in_sequence(cwc.e(&quot;msgComposeAttachmentItemContext&quot;),</span>
<a href="#l27.389"></a><span id="l27.389" class="difflineat">@@ -451,24 +452,24 @@ function test_attachment_reordering() {</span>
<a href="#l27.390"></a><span id="l27.390"> </span>
<a href="#l27.391"></a><span id="l27.391">   // Click on the editor which should close the panel.</span>
<a href="#l27.392"></a><span id="l27.392">   cwc.click(new elib.Elem(editorEl));</span>
<a href="#l27.393"></a><span id="l27.393">   cwc.waitFor(() =&gt; panel.state == &quot;closed&quot;,</span>
<a href="#l27.394"></a><span id="l27.394">     &quot;Reordering panel didn't close when editor was clicked.&quot;);</span>
<a href="#l27.395"></a><span id="l27.395"> </span>
<a href="#l27.396"></a><span id="l27.396">   // Show 'Reorder Attachments' panel via keyboard.</span>
<a href="#l27.397"></a><span id="l27.397">   // key_reorderAttachments, Bug 1427037</span>
<a href="#l27.398"></a><span id="l27.398" class="difflineminus">-  const openPanelActions = [</span>
<a href="#l27.399"></a><span id="l27.399" class="difflineminus">-    { focusEl: editorEl,</span>
<a href="#l27.400"></a><span id="l27.400" class="difflineminus">-      key: &quot;x&quot;,</span>
<a href="#l27.401"></a><span id="l27.401" class="difflineminus">-      key_modifiers: openReorderPanelModifiers },</span>
<a href="#l27.402"></a><span id="l27.402" class="difflineminus">-    { focusEl: bucket,</span>
<a href="#l27.403"></a><span id="l27.403" class="difflineminus">-      key: &quot;x&quot;,</span>
<a href="#l27.404"></a><span id="l27.404" class="difflineminus">-      key_modifiers: openReorderPanelModifiers }</span>
<a href="#l27.405"></a><span id="l27.405" class="difflineminus">-  ];</span>
<a href="#l27.406"></a><span id="l27.406" class="difflineplus">+  // const openPanelActions = [</span>
<a href="#l27.407"></a><span id="l27.407" class="difflineplus">+  //   { focusEl: editorEl,</span>
<a href="#l27.408"></a><span id="l27.408" class="difflineplus">+  //     key: &quot;x&quot;,</span>
<a href="#l27.409"></a><span id="l27.409" class="difflineplus">+  //     key_modifiers: openReorderPanelModifiers },</span>
<a href="#l27.410"></a><span id="l27.410" class="difflineplus">+  //   { focusEl: bucket,</span>
<a href="#l27.411"></a><span id="l27.411" class="difflineplus">+  //     key: &quot;x&quot;,</span>
<a href="#l27.412"></a><span id="l27.412" class="difflineplus">+  //     key_modifiers: openReorderPanelModifiers },</span>
<a href="#l27.413"></a><span id="l27.413" class="difflineplus">+  // ];</span>
<a href="#l27.414"></a><span id="l27.414"> </span>
<a href="#l27.415"></a><span id="l27.415">   // XXX this doesn't work on any platform yet, ESC doesn't close the panel.</span>
<a href="#l27.416"></a><span id="l27.416">   // Execute test of opening 'Reorder Attachments' panel via keyboard.</span>
<a href="#l27.417"></a><span id="l27.417">   // subtest_reordering_panel_keyboard(cwc, openPanelActions);</span>
<a href="#l27.418"></a><span id="l27.418"> </span>
<a href="#l27.419"></a><span id="l27.419">   // Clean up for a new set of attachments.</span>
<a href="#l27.420"></a><span id="l27.420">   cwc.window.RemoveAllAttachments();</span>
<a href="#l27.421"></a><span id="l27.421"> </span>
<a href="#l27.422"></a><span id="l27.422" class="difflineat">@@ -492,17 +493,17 @@ function test_attachment_reordering() {</span>
<a href="#l27.423"></a><span id="l27.423">       button: &quot;btn_moveAttachmentBottom&quot;,</span>
<a href="#l27.424"></a><span id="l27.424">       result: [&quot;a&quot;, &quot;b&quot;, &quot;B&quot;, &quot;bb&quot;, &quot;C&quot;, &quot;x&quot;] },</span>
<a href="#l27.425"></a><span id="l27.425">     { select: [1, 3],</span>
<a href="#l27.426"></a><span id="l27.426">       button: &quot;btn_moveAttachmentBundleUp&quot;,</span>
<a href="#l27.427"></a><span id="l27.427">       result: [&quot;a&quot;, &quot;b&quot;, &quot;bb&quot;, &quot;B&quot;, &quot;C&quot;, &quot;x&quot;] },</span>
<a href="#l27.428"></a><span id="l27.428">     // Bug 1417856</span>
<a href="#l27.429"></a><span id="l27.429">     { select: [2],</span>
<a href="#l27.430"></a><span id="l27.430">       button: &quot;btn_sortAttachmentsToggle&quot;,</span>
<a href="#l27.431"></a><span id="l27.431" class="difflineminus">-      result: [&quot;a&quot;, &quot;b&quot;, &quot;B&quot;, &quot;bb&quot;, &quot;C&quot;, &quot;x&quot;] }</span>
<a href="#l27.432"></a><span id="l27.432" class="difflineplus">+      result: [&quot;a&quot;, &quot;b&quot;, &quot;B&quot;, &quot;bb&quot;, &quot;C&quot;, &quot;x&quot;] },</span>
<a href="#l27.433"></a><span id="l27.433">   ];</span>
<a href="#l27.434"></a><span id="l27.434"> </span>
<a href="#l27.435"></a><span id="l27.435">   // Check 2: basic and advanced, mouse-only.</span>
<a href="#l27.436"></a><span id="l27.436">   const initialAttachmentNames_2 = [&quot;a&quot;, &quot;x&quot;, &quot;C&quot;, &quot;y1&quot;, &quot;y2&quot;, &quot;B&quot;, &quot;b&quot;, &quot;z&quot;, &quot;bb&quot;];</span>
<a href="#l27.437"></a><span id="l27.437">   const reorderActions_2 = [</span>
<a href="#l27.438"></a><span id="l27.438">     // For starters: moving a single attachment around in the list.</span>
<a href="#l27.439"></a><span id="l27.439">     { select: [1],</span>
<a href="#l27.440"></a><span id="l27.440">       button: &quot;btn_moveAttachmentUp&quot;,</span>
<a href="#l27.441"></a><span id="l27.441" class="difflineat">@@ -590,17 +591,17 @@ function test_attachment_reordering() {</span>
<a href="#l27.442"></a><span id="l27.442">       result: [&quot;z&quot;, &quot;y2&quot;, &quot;y1&quot;, &quot;x&quot;, &quot;C&quot;, &quot;bb&quot;, &quot;B&quot;, &quot;b&quot;, &quot;a&quot;] },</span>
<a href="#l27.443"></a><span id="l27.443"> </span>
<a href="#l27.444"></a><span id="l27.444">     // Collapsing multiple, disjunct selection with inner block to top/bottom.</span>
<a href="#l27.445"></a><span id="l27.445">     { select: [3, 5, 6, 8],</span>
<a href="#l27.446"></a><span id="l27.446">       button: &quot;btn_moveAttachmentTop&quot;,</span>
<a href="#l27.447"></a><span id="l27.447">       result: [&quot;x&quot;, &quot;bb&quot;, &quot;B&quot;, &quot;a&quot;, &quot;z&quot;, &quot;y2&quot;, &quot;y1&quot;, &quot;C&quot;, &quot;b&quot;] },</span>
<a href="#l27.448"></a><span id="l27.448">     { select: [0, 2, 3, 7],</span>
<a href="#l27.449"></a><span id="l27.449">       button: &quot;btn_moveAttachmentBottom&quot;,</span>
<a href="#l27.450"></a><span id="l27.450" class="difflineminus">-      result: [&quot;bb&quot;, &quot;z&quot;, &quot;y2&quot;, &quot;y1&quot;, &quot;b&quot;, &quot;x&quot;, &quot;B&quot;, &quot;a&quot;, &quot;C&quot;] }</span>
<a href="#l27.451"></a><span id="l27.451" class="difflineplus">+      result: [&quot;bb&quot;, &quot;z&quot;, &quot;y2&quot;, &quot;y1&quot;, &quot;b&quot;, &quot;x&quot;, &quot;B&quot;, &quot;a&quot;, &quot;C&quot;] },</span>
<a href="#l27.452"></a><span id="l27.452">   ];</span>
<a href="#l27.453"></a><span id="l27.453"> </span>
<a href="#l27.454"></a><span id="l27.454">   // Check 3: basic and advanced, keyboard-only.</span>
<a href="#l27.455"></a><span id="l27.455">   const initialAttachmentNames_3 = [&quot;a&quot;, &quot;x&quot;, &quot;C&quot;, &quot;y1&quot;, &quot;y2&quot;, &quot;B&quot;, &quot;b&quot;, &quot;z&quot;, &quot;bb&quot;];</span>
<a href="#l27.456"></a><span id="l27.456">   const modAlt = { altKey: true };</span>
<a href="#l27.457"></a><span id="l27.457">   const modifiers2 = (AppConstants.platform == &quot;macosx&quot;) ? { accelKey: true,</span>
<a href="#l27.458"></a><span id="l27.458">                                                              altKey: true }</span>
<a href="#l27.459"></a><span id="l27.459">                                                          : { altKey: true };</span>
<a href="#l27.460"></a><span id="l27.460" class="difflineat">@@ -728,28 +729,28 @@ function test_attachment_reordering() {</span>
<a href="#l27.461"></a><span id="l27.461">       // key_moveAttachmentBottom2 (secondary shortcut on MAC, same as Win primary)</span>
<a href="#l27.462"></a><span id="l27.462">       key:    &quot;VK_END&quot;,</span>
<a href="#l27.463"></a><span id="l27.463">       key_modifiers: modAlt,</span>
<a href="#l27.464"></a><span id="l27.464">       result: [&quot;B&quot;, &quot;x&quot;, &quot;y1&quot;, &quot;y2&quot;, &quot;z&quot;, &quot;a&quot;, &quot;b&quot;, &quot;C&quot;, &quot;bb&quot;] },</span>
<a href="#l27.465"></a><span id="l27.465">     { select: [5, 6, 7, 8],</span>
<a href="#l27.466"></a><span id="l27.466">       // key_moveAttachmentTop2 (secondary shortcut on MAC, same as Win primary)</span>
<a href="#l27.467"></a><span id="l27.467">       key:    &quot;VK_HOME&quot;,</span>
<a href="#l27.468"></a><span id="l27.468">       key_modifiers: modAlt,</span>
<a href="#l27.469"></a><span id="l27.469" class="difflineminus">-      result: [&quot;a&quot;, &quot;b&quot;, &quot;C&quot;, &quot;bb&quot;, &quot;B&quot;, &quot;x&quot;, &quot;y1&quot;, &quot;y2&quot;, &quot;z&quot;] }</span>
<a href="#l27.470"></a><span id="l27.470" class="difflineplus">+      result: [&quot;a&quot;, &quot;b&quot;, &quot;C&quot;, &quot;bb&quot;, &quot;B&quot;, &quot;x&quot;, &quot;y1&quot;, &quot;y2&quot;, &quot;z&quot;] },</span>
<a href="#l27.471"></a><span id="l27.471">   ];</span>
<a href="#l27.472"></a><span id="l27.472"> </span>
<a href="#l27.473"></a><span id="l27.473">   // Check 4: Alt+Y keyboard shortcut for sorting (Bug 1425891).</span>
<a href="#l27.474"></a><span id="l27.474">   const initialAttachmentNames_4 = [&quot;a&quot;, &quot;x&quot;, &quot;C&quot;, &quot;y1&quot;, &quot;y2&quot;, &quot;B&quot;, &quot;b&quot;, &quot;z&quot;, &quot;bb&quot;];</span>
<a href="#l27.475"></a><span id="l27.475"> </span>
<a href="#l27.476"></a><span id="l27.476">   const reorderActions_4 = [</span>
<a href="#l27.477"></a><span id="l27.477">     { select: [1],</span>
<a href="#l27.478"></a><span id="l27.478">       // key_sortAttachmentsToggle</span>
<a href="#l27.479"></a><span id="l27.479">       key:    &quot;y&quot;,</span>
<a href="#l27.480"></a><span id="l27.480">       key_modifiers: modAlt,</span>
<a href="#l27.481"></a><span id="l27.481" class="difflineminus">-      result: [&quot;a&quot;, &quot;b&quot;, &quot;B&quot;, &quot;bb&quot;, &quot;C&quot;, &quot;x&quot;, &quot;y1&quot;, &quot;y2&quot;, &quot;z&quot;] }</span>
<a href="#l27.482"></a><span id="l27.482" class="difflineplus">+      result: [&quot;a&quot;, &quot;b&quot;, &quot;B&quot;, &quot;bb&quot;, &quot;C&quot;, &quot;x&quot;, &quot;y1&quot;, &quot;y2&quot;, &quot;z&quot;] },</span>
<a href="#l27.483"></a><span id="l27.483">   ];</span>
<a href="#l27.484"></a><span id="l27.484"> </span>
<a href="#l27.485"></a><span id="l27.485">   // Execute the tests of reordering actions as defined above.</span>
<a href="#l27.486"></a><span id="l27.486">   subtest_reordering(cwc, initialAttachmentNames_1, reorderActions_1);</span>
<a href="#l27.487"></a><span id="l27.487">   subtest_reordering(cwc, initialAttachmentNames_2, reorderActions_2);</span>
<a href="#l27.488"></a><span id="l27.488">   // Check 3 (keyboard-only) with panel open.</span>
<a href="#l27.489"></a><span id="l27.489">   subtest_reordering(cwc, initialAttachmentNames_3, reorderActions_3);</span>
<a href="#l27.490"></a><span id="l27.490">   // Check 3 (keyboard-only) without panel.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-base64-display.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-base64-display.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1,22 +1,22 @@</span>
<a href="#l28.4"></a><span id="l28.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.5"></a><span id="l28.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.6"></a><span id="l28.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.7"></a><span id="l28.7"> </span>
<a href="#l28.8"></a><span id="l28.8"> /**</span>
<a href="#l28.9"></a><span id="l28.9">  * Tests that messages with &quot;broken&quot; base64 are correctly displayed.</span>
<a href="#l28.10"></a><span id="l28.10">  */</span>
<a href="#l28.11"></a><span id="l28.11"> </span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-// mozmake SOLO_TEST=composition/test-base64-display.js mozmill-one</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineminus">-</span>
<a href="#l28.14"></a><span id="l28.14"> &quot;use strict&quot;;</span>
<a href="#l28.15"></a><span id="l28.15"> </span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l28.17"></a><span id="l28.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+</span>
<a href="#l28.19"></a><span id="l28.19"> var MODULE_NAME = &quot;test-base64-display.js&quot;;</span>
<a href="#l28.20"></a><span id="l28.20" class="difflineminus">-</span>
<a href="#l28.21"></a><span id="l28.21"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l28.22"></a><span id="l28.22"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l28.23"></a><span id="l28.23"> </span>
<a href="#l28.24"></a><span id="l28.24"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l28.25"></a><span id="l28.25"> </span>
<a href="#l28.26"></a><span id="l28.26"> function setupModule(module) {</span>
<a href="#l28.27"></a><span id="l28.27">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l28.28"></a><span id="l28.28">     collector.getModule(lib).installInto(module);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-blocked-content.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-blocked-content.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -1,28 +1,30 @@</span>
<a href="#l29.4"></a><span id="l29.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.5"></a><span id="l29.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.6"></a><span id="l29.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.7"></a><span id="l29.7"> </span>
<a href="#l29.8"></a><span id="l29.8"> /**</span>
<a href="#l29.9"></a><span id="l29.9">  * Tests that we do the right thing wrt. blocked resources during composition.</span>
<a href="#l29.10"></a><span id="l29.10">  */</span>
<a href="#l29.11"></a><span id="l29.11"> </span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-// make mozmill-one SOLO_TEST=composition/test-blocked-content.js</span>
<a href="#l29.13"></a><span id="l29.13" class="difflineminus">-</span>
<a href="#l29.14"></a><span id="l29.14"> &quot;use strict&quot;;</span>
<a href="#l29.15"></a><span id="l29.15"> </span>
<a href="#l29.16"></a><span id="l29.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-notificationbox-helpers.js */</span>
<a href="#l29.19"></a><span id="l29.19" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l29.20"></a><span id="l29.20" class="difflineplus">+</span>
<a href="#l29.21"></a><span id="l29.21"> var MODULE_NAME = &quot;test-blocked-content&quot;;</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-</span>
<a href="#l29.23"></a><span id="l29.23"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l29.24"></a><span id="l29.24"> var MODULE_REQUIRES = [</span>
<a href="#l29.25"></a><span id="l29.25">   &quot;folder-display-helpers&quot;,</span>
<a href="#l29.26"></a><span id="l29.26" class="difflineminus">-   &quot;window-helpers&quot;,</span>
<a href="#l29.27"></a><span id="l29.27" class="difflineminus">-   &quot;compose-helpers&quot;,</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineminus">-   &quot;notificationbox-helpers&quot;</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l29.31"></a><span id="l29.31" class="difflineplus">+  &quot;notificationbox-helpers&quot;,</span>
<a href="#l29.32"></a><span id="l29.32"> ];</span>
<a href="#l29.33"></a><span id="l29.33"> </span>
<a href="#l29.34"></a><span id="l29.34"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l29.35"></a><span id="l29.35"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l29.36"></a><span id="l29.36"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l29.37"></a><span id="l29.37"> var {OS} = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l29.38"></a><span id="l29.38"> </span>
<a href="#l29.39"></a><span id="l29.39"> var gOutboxFolder;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-charset-edit.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-charset-edit.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -2,25 +2,31 @@</span>
<a href="#l30.4"></a><span id="l30.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.5"></a><span id="l30.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l30.6"></a><span id="l30.6"> </span>
<a href="#l30.7"></a><span id="l30.7"> /**</span>
<a href="#l30.8"></a><span id="l30.8">  * Tests that we do the right thing wrt. message encoding when editing or</span>
<a href="#l30.9"></a><span id="l30.9">  * replying to messages.</span>
<a href="#l30.10"></a><span id="l30.10">  */</span>
<a href="#l30.11"></a><span id="l30.11"> </span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-// make SOLO_TEST=composition/test-charset-edit.js mozmill-one</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l30.14"></a><span id="l30.14"> </span>
<a href="#l30.15"></a><span id="l30.15" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-notificationbox-helpers.js */</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l30.20"></a><span id="l30.20"> </span>
<a href="#l30.21"></a><span id="l30.21"> var MODULE_NAME = &quot;test-charset-edit&quot;;</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineminus">-</span>
<a href="#l30.23"></a><span id="l30.23"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;,</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineminus">-                       &quot;window-helpers&quot;, &quot;notificationbox-helpers&quot;];</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+  &quot;notificationbox-helpers&quot;,</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+];</span>
<a href="#l30.32"></a><span id="l30.32"> </span>
<a href="#l30.33"></a><span id="l30.33"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l30.34"></a><span id="l30.34"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l30.35"></a><span id="l30.35"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l30.36"></a><span id="l30.36"> var {MimeParser} = ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l30.37"></a><span id="l30.37"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l30.38"></a><span id="l30.38"> var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l30.39"></a><span id="l30.39"> </span>
<a href="#l30.40"></a><span id="l30.40" class="difflineat">@@ -44,31 +50,31 @@ function setupModule(module) {</span>
<a href="#l30.41"></a><span id="l30.41"> </span>
<a href="#l30.42"></a><span id="l30.42"> /**</span>
<a href="#l30.43"></a><span id="l30.43">  * Helper to get the full message content.</span>
<a href="#l30.44"></a><span id="l30.44">  *</span>
<a href="#l30.45"></a><span id="l30.45">  * @param aMsgHdr: nsIMsgDBHdr object whose text body will be read</span>
<a href="#l30.46"></a><span id="l30.46">  * @param aGetText: if true, return header objects. if false, return body data.</span>
<a href="#l30.47"></a><span id="l30.47">  * @return Map(partnum -&gt; message headers)</span>
<a href="#l30.48"></a><span id="l30.48">  */</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineminus">-function getMsgHeaders(aMsgHdr, aGetText=false) {</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+function getMsgHeaders(aMsgHdr, aGetText = false) {</span>
<a href="#l30.51"></a><span id="l30.51">   let msgFolder = aMsgHdr.folder;</span>
<a href="#l30.52"></a><span id="l30.52">   let msgUri = msgFolder.getUriForMsg(aMsgHdr);</span>
<a href="#l30.53"></a><span id="l30.53"> </span>
<a href="#l30.54"></a><span id="l30.54">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l30.55"></a><span id="l30.55">                     .createInstance(Ci.nsIMessenger);</span>
<a href="#l30.56"></a><span id="l30.56">   let handler = {</span>
<a href="#l30.57"></a><span id="l30.57">     _done: false,</span>
<a href="#l30.58"></a><span id="l30.58">     _data: new Map(),</span>
<a href="#l30.59"></a><span id="l30.59">     _text: new Map(),</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineminus">-    endMessage: function () { this._done = true; },</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineminus">-    deliverPartData: function (num, text) {</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineplus">+    endMessage() { this._done = true; },</span>
<a href="#l30.63"></a><span id="l30.63" class="difflineplus">+    deliverPartData(num, text) {</span>
<a href="#l30.64"></a><span id="l30.64">       this._text.set(num, this._text.get(num) + text);</span>
<a href="#l30.65"></a><span id="l30.65">     },</span>
<a href="#l30.66"></a><span id="l30.66" class="difflineminus">-    startPart: function (num, headers) {</span>
<a href="#l30.67"></a><span id="l30.67" class="difflineplus">+    startPart(num, headers) {</span>
<a href="#l30.68"></a><span id="l30.68">       this._data.set(num, headers);</span>
<a href="#l30.69"></a><span id="l30.69">       this._text.set(num, &quot;&quot;);</span>
<a href="#l30.70"></a><span id="l30.70">     },</span>
<a href="#l30.71"></a><span id="l30.71">   };</span>
<a href="#l30.72"></a><span id="l30.72">   let streamListener = MimeParser.makeStreamListenerParser(handler,</span>
<a href="#l30.73"></a><span id="l30.73">     {strformat: &quot;unicode&quot;});</span>
<a href="#l30.74"></a><span id="l30.74">   messenger.messageServiceFromURI(msgUri).streamMessage(msgUri,</span>
<a href="#l30.75"></a><span id="l30.75">                                                         streamListener,</span>
<a href="#l30.76"></a><span id="l30.76" class="difflineat">@@ -85,17 +91,17 @@ function getMsgHeaders(aMsgHdr, aGetText</span>
<a href="#l30.77"></a><span id="l30.77">  * Test that if we reply to a message in an invalid charset, we don't try to compose</span>
<a href="#l30.78"></a><span id="l30.78">  * in that charset. Instead, we should be using the default charset (set to</span>
<a href="#l30.79"></a><span id="l30.79">  * not be UTF-8 in this test).</span>
<a href="#l30.80"></a><span id="l30.80">  */</span>
<a href="#l30.81"></a><span id="l30.81"> function test_wrong_reply_charset() {</span>
<a href="#l30.82"></a><span id="l30.82">   let folder = gDrafts;</span>
<a href="#l30.83"></a><span id="l30.83">   let msg0 = create_message({</span>
<a href="#l30.84"></a><span id="l30.84">     bodyPart: new SyntheticPartLeaf(&quot;Some text&quot;,</span>
<a href="#l30.85"></a><span id="l30.85" class="difflineminus">-      {charset: &quot;invalid-charset&quot;})</span>
<a href="#l30.86"></a><span id="l30.86" class="difflineplus">+      {charset: &quot;invalid-charset&quot;}),</span>
<a href="#l30.87"></a><span id="l30.87">   });</span>
<a href="#l30.88"></a><span id="l30.88">   add_message_to_folder(folder, msg0);</span>
<a href="#l30.89"></a><span id="l30.89">   be_in_folder(folder);</span>
<a href="#l30.90"></a><span id="l30.90">   let msg = select_click_row(0);</span>
<a href="#l30.91"></a><span id="l30.91">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l30.92"></a><span id="l30.92">   assert_equals(getMsgHeaders(msg).get(&quot;&quot;).charset, &quot;invalid-charset&quot;);</span>
<a href="#l30.93"></a><span id="l30.93"> </span>
<a href="#l30.94"></a><span id="l30.94">   let rwc = open_compose_with_reply();</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineat">@@ -126,17 +132,17 @@ function test_wrong_reply_charset() {</span>
<a href="#l30.96"></a><span id="l30.96"> /**</span>
<a href="#l30.97"></a><span id="l30.97">  * Test that replying to bad charsets don't screw up the existing text.</span>
<a href="#l30.98"></a><span id="l30.98">  */</span>
<a href="#l30.99"></a><span id="l30.99"> function test_no_mojibake() {</span>
<a href="#l30.100"></a><span id="l30.100">   let folder = gDrafts;</span>
<a href="#l30.101"></a><span id="l30.101">   let nonASCII = &quot;&quot;;</span>
<a href="#l30.102"></a><span id="l30.102">   let UTF7 = &quot;+MLEwxDChMOswszCiMMgw6w-&quot;;</span>
<a href="#l30.103"></a><span id="l30.103">   let msg0 = create_message({</span>
<a href="#l30.104"></a><span id="l30.104" class="difflineminus">-    bodyPart: new SyntheticPartLeaf(UTF7, {charset: &quot;utf-7&quot;})</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineplus">+    bodyPart: new SyntheticPartLeaf(UTF7, {charset: &quot;utf-7&quot;}),</span>
<a href="#l30.106"></a><span id="l30.106">   });</span>
<a href="#l30.107"></a><span id="l30.107">   add_message_to_folder(folder, msg0);</span>
<a href="#l30.108"></a><span id="l30.108">   be_in_folder(folder);</span>
<a href="#l30.109"></a><span id="l30.109">   let msg = select_click_row(0);</span>
<a href="#l30.110"></a><span id="l30.110">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l30.111"></a><span id="l30.111">   assert_equals(getMsgHeaders(msg).get(&quot;&quot;).charset, &quot;utf-7&quot;);</span>
<a href="#l30.112"></a><span id="l30.112">   assert_equals(getMsgHeaders(msg, true).get(&quot;&quot;).trim(), nonASCII);</span>
<a href="#l30.113"></a><span id="l30.113"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-charset-upgrade.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-charset-upgrade.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -2,22 +2,23 @@</span>
<a href="#l31.4"></a><span id="l31.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.5"></a><span id="l31.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l31.6"></a><span id="l31.6"> </span>
<a href="#l31.7"></a><span id="l31.7"> /**</span>
<a href="#l31.8"></a><span id="l31.8">  * Tests that we do the right thing wrt. message encoding, especially when</span>
<a href="#l31.9"></a><span id="l31.9">  * all characters doesn't fit the selected charset.</span>
<a href="#l31.10"></a><span id="l31.10">  */</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-// make SOLO_TEST=composition/test-charset-upgrade.js mozmill-one</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineminus">-</span>
<a href="#l31.14"></a><span id="l31.14"> &quot;use strict&quot;;</span>
<a href="#l31.15"></a><span id="l31.15"> </span>
<a href="#l31.16"></a><span id="l31.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l31.18"></a><span id="l31.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l31.19"></a><span id="l31.19" class="difflineplus">+</span>
<a href="#l31.20"></a><span id="l31.20"> var MODULE_NAME = &quot;test-charset-upgrade&quot;;</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineminus">-</span>
<a href="#l31.22"></a><span id="l31.22"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l31.23"></a><span id="l31.23"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l31.24"></a><span id="l31.24"> </span>
<a href="#l31.25"></a><span id="l31.25"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l31.26"></a><span id="l31.26"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l31.27"></a><span id="l31.27"> </span>
<a href="#l31.28"></a><span id="l31.28"> var gDrafts;</span>
<a href="#l31.29"></a><span id="l31.29"> var gOutbox;</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineat">@@ -158,17 +159,17 @@ function test_encoding_upgrade_plaintext</span>
<a href="#l31.31"></a><span id="l31.31"> </span>
<a href="#l31.32"></a><span id="l31.32">   be_in_folder(gDrafts);</span>
<a href="#l31.33"></a><span id="l31.33">   let draftMsg2 = select_click_row(0);</span>
<a href="#l31.34"></a><span id="l31.34">   // Charset should have be upgraded to UTF-8.</span>
<a href="#l31.35"></a><span id="l31.35">   assert_equals(draftMsg2.Charset, &quot;UTF-8&quot;);</span>
<a href="#l31.36"></a><span id="l31.36"> </span>
<a href="#l31.37"></a><span id="l31.37">   let draftMsg2Content = get_msg_source(draftMsg2, &quot;UTF-8&quot;);</span>
<a href="#l31.38"></a><span id="l31.38">   if (draftMsg2Content.includes(&quot;&lt;html&gt;&quot;))</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineminus">-    throw new Error(&quot;Plaintext draft contained &lt;html&gt;; &quot;+</span>
<a href="#l31.40"></a><span id="l31.40" class="difflineplus">+    throw new Error(&quot;Plaintext draft contained &lt;html&gt;; &quot; +</span>
<a href="#l31.41"></a><span id="l31.41">                     &quot;draftMsg2Content=&quot; + draftMsg2Content);</span>
<a href="#l31.42"></a><span id="l31.42"> </span>
<a href="#l31.43"></a><span id="l31.43">   if (!draftMsg2Content.includes(CHINESE))</span>
<a href="#l31.44"></a><span id="l31.44">     throw new Error(&quot;Chinese text not in msg; CHINESE=&quot; + CHINESE +</span>
<a href="#l31.45"></a><span id="l31.45">                     &quot;, draftMsg2Content=&quot; + draftMsg2Content);</span>
<a href="#l31.46"></a><span id="l31.46"> </span>
<a href="#l31.47"></a><span id="l31.47">   plan_for_window_close(compWin);</span>
<a href="#l31.48"></a><span id="l31.48">   compWin.window.goDoCommand(&quot;cmd_sendLater&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-cp932-display.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-cp932-display.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -1,22 +1,22 @@</span>
<a href="#l32.4"></a><span id="l32.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l32.5"></a><span id="l32.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l32.6"></a><span id="l32.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l32.7"></a><span id="l32.7"> </span>
<a href="#l32.8"></a><span id="l32.8"> /**</span>
<a href="#l32.9"></a><span id="l32.9">  * Tests that messages in cp932, Thunderbirds alias for Shift_JIS, are correctly displayed.</span>
<a href="#l32.10"></a><span id="l32.10">  */</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-// mozmake SOLO_TEST=composition/test-cp932-display.js mozmill-one</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-</span>
<a href="#l32.14"></a><span id="l32.14"> &quot;use strict&quot;;</span>
<a href="#l32.15"></a><span id="l32.15"> </span>
<a href="#l32.16"></a><span id="l32.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineplus">+</span>
<a href="#l32.19"></a><span id="l32.19"> var MODULE_NAME = &quot;test-cp932-display.js&quot;;</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineminus">-</span>
<a href="#l32.21"></a><span id="l32.21"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l32.22"></a><span id="l32.22"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l32.23"></a><span id="l32.23"> </span>
<a href="#l32.24"></a><span id="l32.24"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l32.25"></a><span id="l32.25"> </span>
<a href="#l32.26"></a><span id="l32.26"> function setupModule(module) {</span>
<a href="#l32.27"></a><span id="l32.27">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l32.28"></a><span id="l32.28">     collector.getModule(lib).installInto(module);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-draft-identity.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-draft-identity.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -2,25 +2,31 @@</span>
<a href="#l33.4"></a><span id="l33.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l33.5"></a><span id="l33.5">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l33.6"></a><span id="l33.6"> </span>
<a href="#l33.7"></a><span id="l33.7"> /**</span>
<a href="#l33.8"></a><span id="l33.8">  * Tests that compose new message chooses the correct initial identity when</span>
<a href="#l33.9"></a><span id="l33.9">  * called from the context of an open composer.</span>
<a href="#l33.10"></a><span id="l33.10">  */</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-// make SOLO_TEST=composition/test-draft-identity.js mozmill-one</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l33.14"></a><span id="l33.14"> </span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-notificationbox-helpers.js */</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l33.20"></a><span id="l33.20"> </span>
<a href="#l33.21"></a><span id="l33.21"> var MODULE_NAME = &quot;test-draft-identity&quot;;</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineminus">-</span>
<a href="#l33.23"></a><span id="l33.23"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineminus">-                       &quot;compose-helpers&quot;, &quot;notificationbox-helpers&quot;];</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+  &quot;notificationbox-helpers&quot;,</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineplus">+];</span>
<a href="#l33.32"></a><span id="l33.32"> </span>
<a href="#l33.33"></a><span id="l33.33"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l33.34"></a><span id="l33.34"> </span>
<a href="#l33.35"></a><span id="l33.35"> var gDrafts;</span>
<a href="#l33.36"></a><span id="l33.36"> var gAccount;</span>
<a href="#l33.37"></a><span id="l33.37"> </span>
<a href="#l33.38"></a><span id="l33.38"> // The first identity should become the default in the account.</span>
<a href="#l33.39"></a><span id="l33.39"> var gIdentities = [ { email: &quot;x@example.invalid&quot; },</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineat">@@ -63,24 +69,24 @@ function setupModule(module) {</span>
<a href="#l33.41"></a><span id="l33.41"> /**</span>
<a href="#l33.42"></a><span id="l33.42">  * Create a new templated draft message in the drafts folder.</span>
<a href="#l33.43"></a><span id="l33.43">  *</span>
<a href="#l33.44"></a><span id="l33.44">  * @return {integer}  The index (position) of the created message in the drafts folder.</span>
<a href="#l33.45"></a><span id="l33.45">  */</span>
<a href="#l33.46"></a><span id="l33.46"> function create_draft(aFrom, aIdKey) {</span>
<a href="#l33.47"></a><span id="l33.47">   let msgCount = gDrafts.getTotalMessages(false);</span>
<a href="#l33.48"></a><span id="l33.48">   let source =</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineminus">-    &quot;From - Wed Mar 01 01:02:03 2017\n&quot;+</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+    &quot;From - Wed Mar 01 01:02:03 2017\n&quot; +</span>
<a href="#l33.51"></a><span id="l33.51">     &quot;X-Mozilla-Status: 0000\n&quot; +</span>
<a href="#l33.52"></a><span id="l33.52">     &quot;X-Mozilla-Status2: 00000000\n&quot; +</span>
<a href="#l33.53"></a><span id="l33.53">     &quot;X-Mozilla-Keys:                                                                                 \n&quot; +</span>
<a href="#l33.54"></a><span id="l33.54">     &quot;FCC: mailbox://nobody@Local%20Folders/Sent\n&quot; +</span>
<a href="#l33.55"></a><span id="l33.55">     (aIdKey ?</span>
<a href="#l33.56"></a><span id="l33.56">     `X-Identity-Key: ${aIdKey}\n` +</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineminus">-    `X-Account-Key: ${gAccount.key}\n`:&quot;&quot;) +</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineplus">+    `X-Account-Key: ${gAccount.key}\n` : &quot;&quot;) +</span>
<a href="#l33.59"></a><span id="l33.59">     `From: ${aFrom}\n` +</span>
<a href="#l33.60"></a><span id="l33.60">     &quot;To: nobody@example.invalid\n&quot; +</span>
<a href="#l33.61"></a><span id="l33.61">     &quot;Subject: test!\n&quot; +</span>
<a href="#l33.62"></a><span id="l33.62">     `Message-ID: &lt;${msgCount}@example.invalid&gt;\n` +</span>
<a href="#l33.63"></a><span id="l33.63">     &quot;Date: Wed, 1 Mar 2017 01:02:03 +0100\n&quot; +</span>
<a href="#l33.64"></a><span id="l33.64">     &quot;X-Mozilla-Draft-Info: internal/draft; vcard=0; receipt=0; DSN=0; uuencode=0;\n&quot; +</span>
<a href="#l33.65"></a><span id="l33.65">     &quot; attachmentreminder=0; deliveryformat=4\n&quot; +</span>
<a href="#l33.66"></a><span id="l33.66">     &quot;MIME-Version: 1.0\n&quot; +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-drafts.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-drafts.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -2,25 +2,31 @@</span>
<a href="#l34.4"></a><span id="l34.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l34.5"></a><span id="l34.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l34.6"></a><span id="l34.6"> </span>
<a href="#l34.7"></a><span id="l34.7"> /**</span>
<a href="#l34.8"></a><span id="l34.8">  * Tests draft related functionality:</span>
<a href="#l34.9"></a><span id="l34.9">  * - that we don't allow opening multiple copies of a draft.</span>
<a href="#l34.10"></a><span id="l34.10">  */</span>
<a href="#l34.11"></a><span id="l34.11"> </span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-// make SOLO_TEST=composition/test-drafts.js mozmill-one</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l34.14"></a><span id="l34.14"> </span>
<a href="#l34.15"></a><span id="l34.15" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-notificationbox-helpers.js */</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l34.20"></a><span id="l34.20"> </span>
<a href="#l34.21"></a><span id="l34.21"> var MODULE_NAME = &quot;test-drafts&quot;;</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineminus">-</span>
<a href="#l34.23"></a><span id="l34.23"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;,</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineminus">-                       &quot;window-helpers&quot;, &quot;notificationbox-helpers&quot;];</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineplus">+  &quot;notificationbox-helpers&quot;,</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+];</span>
<a href="#l34.32"></a><span id="l34.32"> </span>
<a href="#l34.33"></a><span id="l34.33"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l34.34"></a><span id="l34.34"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l34.35"></a><span id="l34.35"> </span>
<a href="#l34.36"></a><span id="l34.36"> var kBoxId = &quot;mail-notification-top&quot;;</span>
<a href="#l34.37"></a><span id="l34.37"> var draftsFolder;</span>
<a href="#l34.38"></a><span id="l34.38"> </span>
<a href="#l34.39"></a><span id="l34.39"> function setupModule(module) {</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineat">@@ -33,17 +39,17 @@ function setupModule(module) {</span>
<a href="#l34.41"></a><span id="l34.41"> </span>
<a href="#l34.42"></a><span id="l34.42"> /**</span>
<a href="#l34.43"></a><span id="l34.43">  * Bug 349547.</span>
<a href="#l34.44"></a><span id="l34.44">  * Tests that we only open one compose window for one instance of a draft.</span>
<a href="#l34.45"></a><span id="l34.45">  */</span>
<a href="#l34.46"></a><span id="l34.46"> function test_open_draft_again() {</span>
<a href="#l34.47"></a><span id="l34.47">   make_new_sets_in_folder(draftsFolder, [{count: 1}]);</span>
<a href="#l34.48"></a><span id="l34.48">   be_in_folder(draftsFolder);</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineminus">-  let draftMsg = select_click_row(0);</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+  select_click_row(0);</span>
<a href="#l34.51"></a><span id="l34.51"> </span>
<a href="#l34.52"></a><span id="l34.52">   // Wait for the notification with the Edit button.</span>
<a href="#l34.53"></a><span id="l34.53">   wait_for_notification_to_show(mc, kBoxId, &quot;draftMsgContent&quot;);</span>
<a href="#l34.54"></a><span id="l34.54"> </span>
<a href="#l34.55"></a><span id="l34.55">   plan_for_new_window(&quot;msgcompose&quot;);</span>
<a href="#l34.56"></a><span id="l34.56">   mc.click(mc.eid(kBoxId, {tagName: &quot;button&quot;, label: &quot;Edit&quot;}));</span>
<a href="#l34.57"></a><span id="l34.57">   let cwc = wait_for_compose_window();</span>
<a href="#l34.58"></a><span id="l34.58"> </span>
<a href="#l34.59"></a><span id="l34.59" class="difflineat">@@ -175,17 +181,17 @@ function test_save_delivery_format_with_</span>
<a href="#l34.60"></a><span id="l34.60">  * Tests that 'Edit as New' leaves the original message in drafts folder.</span>
<a href="#l34.61"></a><span id="l34.61">  */</span>
<a href="#l34.62"></a><span id="l34.62"> function test_edit_as_new_in_draft() {</span>
<a href="#l34.63"></a><span id="l34.63">   make_new_sets_in_folder(draftsFolder, [{count: 1}]);</span>
<a href="#l34.64"></a><span id="l34.64">   be_in_folder(draftsFolder);</span>
<a href="#l34.65"></a><span id="l34.65"> </span>
<a href="#l34.66"></a><span id="l34.66">   assert_equals(draftsFolder.getTotalMessages(false), 1);</span>
<a href="#l34.67"></a><span id="l34.67"> </span>
<a href="#l34.68"></a><span id="l34.68" class="difflineminus">-  let draftMsg = select_click_row(0);</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineplus">+  select_click_row(0);</span>
<a href="#l34.70"></a><span id="l34.70"> </span>
<a href="#l34.71"></a><span id="l34.71">   // Wait for the notification with the Edit button.</span>
<a href="#l34.72"></a><span id="l34.72">   wait_for_notification_to_show(mc, kBoxId, &quot;draftMsgContent&quot;);</span>
<a href="#l34.73"></a><span id="l34.73"> </span>
<a href="#l34.74"></a><span id="l34.74">   plan_for_new_window(&quot;msgcompose&quot;);</span>
<a href="#l34.75"></a><span id="l34.75">   mc.keypress(null, &quot;e&quot;, {shiftKey: false, accelKey: true});</span>
<a href="#l34.76"></a><span id="l34.76">   let cwc = wait_for_compose_window();</span>
<a href="#l34.77"></a><span id="l34.77"> </span>
<a href="#l34.78"></a><span id="l34.78" class="difflineat">@@ -249,17 +255,17 @@ function test_remove_space_stuffing_form</span>
<a href="#l34.79"></a><span id="l34.79">   utils.waitFor(() =&gt; !cwc.window.gSaveOperationInProgress &amp;&amp; !cwc.window.gWindowLock,</span>
<a href="#l34.80"></a><span id="l34.80">                 &quot;Saving of draft did not finish&quot;);</span>
<a href="#l34.81"></a><span id="l34.81">   wait_for_window_focused(cwc.window);</span>
<a href="#l34.82"></a><span id="l34.82"> </span>
<a href="#l34.83"></a><span id="l34.83">   close_compose_window(cwc);</span>
<a href="#l34.84"></a><span id="l34.84"> </span>
<a href="#l34.85"></a><span id="l34.85">   be_in_folder(draftsFolder);</span>
<a href="#l34.86"></a><span id="l34.86"> </span>
<a href="#l34.87"></a><span id="l34.87" class="difflineminus">-  let draftMsg = select_click_row(0);</span>
<a href="#l34.88"></a><span id="l34.88" class="difflineplus">+  select_click_row(0);</span>
<a href="#l34.89"></a><span id="l34.89"> </span>
<a href="#l34.90"></a><span id="l34.90">   // Wait for the notification with the Edit button.</span>
<a href="#l34.91"></a><span id="l34.91">   wait_for_notification_to_show(mc, kBoxId, &quot;draftMsgContent&quot;);</span>
<a href="#l34.92"></a><span id="l34.92"> </span>
<a href="#l34.93"></a><span id="l34.93">   plan_for_new_window(&quot;msgcompose&quot;);</span>
<a href="#l34.94"></a><span id="l34.94">   mc.click(mc.eid(kBoxId, {tagName: &quot;button&quot;, label: &quot;Edit&quot;}));</span>
<a href="#l34.95"></a><span id="l34.95">   cwc = wait_for_compose_window();</span>
<a href="#l34.96"></a><span id="l34.96"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-eml-actions.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-eml-actions.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -1,22 +1,23 @@</span>
<a href="#l35.4"></a><span id="l35.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l35.5"></a><span id="l35.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l35.6"></a><span id="l35.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l35.7"></a><span id="l35.7"> </span>
<a href="#l35.8"></a><span id="l35.8"> /**</span>
<a href="#l35.9"></a><span id="l35.9">  * Tests that actions such as replying to an .eml works properly.</span>
<a href="#l35.10"></a><span id="l35.10">  */</span>
<a href="#l35.11"></a><span id="l35.11"> </span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-// make SOLO_TEST=composition/test-eml-actions.js mozmill-one</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-</span>
<a href="#l35.14"></a><span id="l35.14"> &quot;use strict&quot;;</span>
<a href="#l35.15"></a><span id="l35.15"> </span>
<a href="#l35.16"></a><span id="l35.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineplus">+</span>
<a href="#l35.20"></a><span id="l35.20"> var MODULE_NAME = &quot;test-eml-actions&quot;;</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineminus">-</span>
<a href="#l35.22"></a><span id="l35.22"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l35.23"></a><span id="l35.23"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l35.24"></a><span id="l35.24"> </span>
<a href="#l35.25"></a><span id="l35.25"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l35.26"></a><span id="l35.26"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l35.27"></a><span id="l35.27"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l35.28"></a><span id="l35.28"> </span>
<a href="#l35.29"></a><span id="l35.29"> var gDrafts;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-focus.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-focus.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -3,21 +3,23 @@</span>
<a href="#l36.4"></a><span id="l36.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l36.5"></a><span id="l36.5"> </span>
<a href="#l36.6"></a><span id="l36.6"> /*</span>
<a href="#l36.7"></a><span id="l36.7">  * Test that cycling through the focus of the 3pane's panes works correctly.</span>
<a href="#l36.8"></a><span id="l36.8">  */</span>
<a href="#l36.9"></a><span id="l36.9"> </span>
<a href="#l36.10"></a><span id="l36.10"> &quot;use strict&quot;;</span>
<a href="#l36.11"></a><span id="l36.11"> </span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l36.15"></a><span id="l36.15" class="difflineplus">+</span>
<a href="#l36.16"></a><span id="l36.16"> var MODULE_NAME = &quot;test-focus&quot;;</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineminus">-</span>
<a href="#l36.18"></a><span id="l36.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;,</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineminus">-                       &quot;window-helpers&quot;];</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l36.22"></a><span id="l36.22"> </span>
<a href="#l36.23"></a><span id="l36.23"> function setupModule(module) {</span>
<a href="#l36.24"></a><span id="l36.24">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l36.25"></a><span id="l36.25">     collector.getModule(lib).installInto(module);</span>
<a href="#l36.26"></a><span id="l36.26">   }</span>
<a href="#l36.27"></a><span id="l36.27"> }</span>
<a href="#l36.28"></a><span id="l36.28"> </span>
<a href="#l36.29"></a><span id="l36.29"> /**</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineat">@@ -72,25 +74,25 @@ function check_element_cycling(controlle</span>
<a href="#l36.31"></a><span id="l36.31"> function test_f6_no_attachment() {</span>
<a href="#l36.32"></a><span id="l36.32">   let cwc = open_compose_new_mail();</span>
<a href="#l36.33"></a><span id="l36.33">   check_element_cycling(cwc, false, false);</span>
<a href="#l36.34"></a><span id="l36.34">   close_compose_window(cwc);</span>
<a href="#l36.35"></a><span id="l36.35"> }</span>
<a href="#l36.36"></a><span id="l36.36"> </span>
<a href="#l36.37"></a><span id="l36.37"> function test_f6_attachment() {</span>
<a href="#l36.38"></a><span id="l36.38">   let cwc = open_compose_new_mail();</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineminus">-  add_attachment(cwc, &quot;http://www.mozilla.org/&quot;);</span>
<a href="#l36.40"></a><span id="l36.40" class="difflineplus">+  add_attachments(cwc, &quot;http://www.mozilla.org/&quot;);</span>
<a href="#l36.41"></a><span id="l36.41">   check_element_cycling(cwc, true, false);</span>
<a href="#l36.42"></a><span id="l36.42">   close_compose_window(cwc);</span>
<a href="#l36.43"></a><span id="l36.43"> }</span>
<a href="#l36.44"></a><span id="l36.44"> </span>
<a href="#l36.45"></a><span id="l36.45"> function test_ctrl_tab_no_attachment() {</span>
<a href="#l36.46"></a><span id="l36.46">   let cwc = open_compose_new_mail();</span>
<a href="#l36.47"></a><span id="l36.47">   check_element_cycling(cwc, false, true);</span>
<a href="#l36.48"></a><span id="l36.48">   close_compose_window(cwc);</span>
<a href="#l36.49"></a><span id="l36.49"> }</span>
<a href="#l36.50"></a><span id="l36.50"> </span>
<a href="#l36.51"></a><span id="l36.51"> function test_ctrl_tab_attachment() {</span>
<a href="#l36.52"></a><span id="l36.52">   let cwc = open_compose_new_mail();</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineminus">-  add_attachment(cwc, &quot;http://www.mozilla.org/&quot;);</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineplus">+  add_attachments(cwc, &quot;http://www.mozilla.org/&quot;);</span>
<a href="#l36.55"></a><span id="l36.55">   check_element_cycling(cwc, true, true);</span>
<a href="#l36.56"></a><span id="l36.56">   close_compose_window(cwc);</span>
<a href="#l36.57"></a><span id="l36.57"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-forward-headers.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-forward-headers.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -4,29 +4,37 @@</span>
<a href="#l37.4"></a><span id="l37.4"> </span>
<a href="#l37.5"></a><span id="l37.5"> /**</span>
<a href="#l37.6"></a><span id="l37.6">  * Tests that headers like References and X-Forwarded-Message-Id are</span>
<a href="#l37.7"></a><span id="l37.7">  * set properly when forwarding messages.</span>
<a href="#l37.8"></a><span id="l37.8">  */</span>
<a href="#l37.9"></a><span id="l37.9"> </span>
<a href="#l37.10"></a><span id="l37.10"> &quot;use strict&quot;;</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-message-helpers.js */</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l37.16"></a><span id="l37.16" class="difflineplus">+</span>
<a href="#l37.17"></a><span id="l37.17"> var MODULE_NAME = &quot;test-forward-headers&quot;;</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineminus">-</span>
<a href="#l37.19"></a><span id="l37.19"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l37.20"></a><span id="l37.20" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l37.21"></a><span id="l37.21" class="difflineminus">-                         &quot;message-helpers&quot;];</span>
<a href="#l37.22"></a><span id="l37.22" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineplus">+  &quot;message-helpers&quot;,</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+];</span>
<a href="#l37.28"></a><span id="l37.28"> </span>
<a href="#l37.29"></a><span id="l37.29"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l37.30"></a><span id="l37.30"> </span>
<a href="#l37.31"></a><span id="l37.31"> var cwc = null; // compose window controller</span>
<a href="#l37.32"></a><span id="l37.32"> var folder;</span>
<a href="#l37.33"></a><span id="l37.33"> var gDrafts;</span>
<a href="#l37.34"></a><span id="l37.34"> </span>
<a href="#l37.35"></a><span id="l37.35" class="difflineminus">-var setupModule = function (module) {</span>
<a href="#l37.36"></a><span id="l37.36" class="difflineplus">+function setupModule(module) {</span>
<a href="#l37.37"></a><span id="l37.37">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l37.38"></a><span id="l37.38">   fdh.installInto(module);</span>
<a href="#l37.39"></a><span id="l37.39">   let composeHelper = collector.getModule(&quot;compose-helpers&quot;);</span>
<a href="#l37.40"></a><span id="l37.40">   composeHelper.installInto(module);</span>
<a href="#l37.41"></a><span id="l37.41">   let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l37.42"></a><span id="l37.42">   wh.installInto(module);</span>
<a href="#l37.43"></a><span id="l37.43">   let mh = collector.getModule(&quot;message-helpers&quot;);</span>
<a href="#l37.44"></a><span id="l37.44">   mh.installInto(module);</span>
<a href="#l37.45"></a><span id="l37.45" class="difflineat">@@ -36,50 +44,50 @@ var setupModule = function (module) {</span>
<a href="#l37.46"></a><span id="l37.46">   add_sets_to_folders([folder], [thread1]);</span>
<a href="#l37.47"></a><span id="l37.47"> </span>
<a href="#l37.48"></a><span id="l37.48">   gDrafts = get_special_folder(Ci.nsMsgFolderFlags.Drafts, true);</span>
<a href="#l37.49"></a><span id="l37.49"> </span>
<a href="#l37.50"></a><span id="l37.50">   // Don't create paragraphs in the test.</span>
<a href="#l37.51"></a><span id="l37.51">   // The test checks for the first DOM node and expects a text and not</span>
<a href="#l37.52"></a><span id="l37.52">   // a paragraph.</span>
<a href="#l37.53"></a><span id="l37.53">   Services.prefs.setBoolPref(&quot;mail.compose.default_to_paragraph&quot;, false);</span>
<a href="#l37.54"></a><span id="l37.54" class="difflineminus">-};</span>
<a href="#l37.55"></a><span id="l37.55" class="difflineplus">+}</span>
<a href="#l37.56"></a><span id="l37.56"> </span>
<a href="#l37.57"></a><span id="l37.57"> function teardownModule(module) {</span>
<a href="#l37.58"></a><span id="l37.58">   Services.prefs.clearUserPref(&quot;mail.compose.default_to_paragraph&quot;);</span>
<a href="#l37.59"></a><span id="l37.59"> }</span>
<a href="#l37.60"></a><span id="l37.60"> </span>
<a href="#l37.61"></a><span id="l37.61"> function forward_selected_messages_and_go_to_drafts_folder(f) {</span>
<a href="#l37.62"></a><span id="l37.62">   const kText = &quot;Hey check out this megalol link&quot;;</span>
<a href="#l37.63"></a><span id="l37.63">   // opening a new compose window</span>
<a href="#l37.64"></a><span id="l37.64">   cwc = f(mc);</span>
<a href="#l37.65"></a><span id="l37.65">   cwc.type(cwc.eid(&quot;content-frame&quot;), kText);</span>
<a href="#l37.66"></a><span id="l37.66"> </span>
<a href="#l37.67"></a><span id="l37.67">   let mailBody = get_compose_body(cwc);</span>
<a href="#l37.68"></a><span id="l37.68">   assert_previous_text(mailBody.firstChild, [kText]);</span>
<a href="#l37.69"></a><span id="l37.69"> </span>
<a href="#l37.70"></a><span id="l37.70">   plan_for_window_close(cwc);</span>
<a href="#l37.71"></a><span id="l37.71">   // mwc is modal window controller</span>
<a href="#l37.72"></a><span id="l37.72" class="difflineminus">-  plan_for_modal_dialog(&quot;commonDialog&quot;, function click_save (mwc) {</span>
<a href="#l37.73"></a><span id="l37.73" class="difflineminus">-      //accept saving</span>
<a href="#l37.74"></a><span id="l37.74" class="difflineminus">-      mwc.window.document.documentElement.getButton('accept').doCommand();</span>
<a href="#l37.75"></a><span id="l37.75" class="difflineminus">-    });</span>
<a href="#l37.76"></a><span id="l37.76" class="difflineplus">+  plan_for_modal_dialog(&quot;commonDialog&quot;, function click_save(mwc) {</span>
<a href="#l37.77"></a><span id="l37.77" class="difflineplus">+    // accept saving</span>
<a href="#l37.78"></a><span id="l37.78" class="difflineplus">+    mwc.window.document.documentElement.getButton(&quot;accept&quot;).doCommand();</span>
<a href="#l37.79"></a><span id="l37.79" class="difflineplus">+  });</span>
<a href="#l37.80"></a><span id="l37.80"> </span>
<a href="#l37.81"></a><span id="l37.81">   // quit -&gt; do you want to save ?</span>
<a href="#l37.82"></a><span id="l37.82" class="difflineminus">-  cwc.window.goDoCommand('cmd_close');</span>
<a href="#l37.83"></a><span id="l37.83" class="difflineplus">+  cwc.window.goDoCommand(&quot;cmd_close&quot;);</span>
<a href="#l37.84"></a><span id="l37.84">   // wait for the modal dialog to return</span>
<a href="#l37.85"></a><span id="l37.85">   wait_for_modal_dialog();</span>
<a href="#l37.86"></a><span id="l37.86">   // Actually quit the window.</span>
<a href="#l37.87"></a><span id="l37.87">   wait_for_window_close();</span>
<a href="#l37.88"></a><span id="l37.88"> </span>
<a href="#l37.89"></a><span id="l37.89">   // Visit the existing Drafts folder.</span>
<a href="#l37.90"></a><span id="l37.90">   be_in_folder(gDrafts);</span>
<a href="#l37.91"></a><span id="l37.91"> }</span>
<a href="#l37.92"></a><span id="l37.92"> </span>
<a href="#l37.93"></a><span id="l37.93" class="difflineminus">-function test_forward_inline () {</span>
<a href="#l37.94"></a><span id="l37.94" class="difflineplus">+function test_forward_inline() {</span>
<a href="#l37.95"></a><span id="l37.95">   be_in_folder(folder);</span>
<a href="#l37.96"></a><span id="l37.96">   // original message header</span>
<a href="#l37.97"></a><span id="l37.97">   let oMsgHdr = select_click_row(0);</span>
<a href="#l37.98"></a><span id="l37.98"> </span>
<a href="#l37.99"></a><span id="l37.99">   forward_selected_messages_and_go_to_drafts_folder(open_compose_with_forward);</span>
<a href="#l37.100"></a><span id="l37.100"> </span>
<a href="#l37.101"></a><span id="l37.101">   // forwarded message header</span>
<a href="#l37.102"></a><span id="l37.102">   let fMsgHdr = select_click_row(0);</span>
<a href="#l37.103"></a><span id="l37.103" class="difflineat">@@ -87,24 +95,24 @@ function test_forward_inline () {</span>
<a href="#l37.104"></a><span id="l37.104">   assert_true(fMsgHdr.numReferences &gt; 0, &quot;No References Header in forwarded msg.&quot;);</span>
<a href="#l37.105"></a><span id="l37.105">   assert_equals(fMsgHdr.getStringReference(0), oMsgHdr.messageId,</span>
<a href="#l37.106"></a><span id="l37.106">     &quot;The forwarded message should have References: = Message-Id: of the original msg&quot;);</span>
<a href="#l37.107"></a><span id="l37.107"> </span>
<a href="#l37.108"></a><span id="l37.108">   // test for x-forwarded-message id and exercise the js mime representation as</span>
<a href="#l37.109"></a><span id="l37.109">   // well</span>
<a href="#l37.110"></a><span id="l37.110">   to_mime_message(fMsgHdr, null, function(aMsgHdr, aMimeMsg) {</span>
<a href="#l37.111"></a><span id="l37.111">     assert_equals(aMimeMsg.headers[&quot;x-forwarded-message-id&quot;],</span>
<a href="#l37.112"></a><span id="l37.112" class="difflineminus">-      &quot;&lt;&quot;+oMsgHdr.messageId+&quot;&gt;&quot;);</span>
<a href="#l37.113"></a><span id="l37.113" class="difflineminus">-    assert_equals(aMimeMsg.headers[&quot;references&quot;],</span>
<a href="#l37.114"></a><span id="l37.114" class="difflineminus">-      &quot;&lt;&quot;+oMsgHdr.messageId+&quot;&gt;&quot;);</span>
<a href="#l37.115"></a><span id="l37.115" class="difflineplus">+      &quot;&lt;&quot; + oMsgHdr.messageId + &quot;&gt;&quot;);</span>
<a href="#l37.116"></a><span id="l37.116" class="difflineplus">+    assert_equals(aMimeMsg.headers.references,</span>
<a href="#l37.117"></a><span id="l37.117" class="difflineplus">+      &quot;&lt;&quot; + oMsgHdr.messageId + &quot;&gt;&quot;);</span>
<a href="#l37.118"></a><span id="l37.118">   });</span>
<a href="#l37.119"></a><span id="l37.119">   press_delete(mc);</span>
<a href="#l37.120"></a><span id="l37.120"> }</span>
<a href="#l37.121"></a><span id="l37.121"> </span>
<a href="#l37.122"></a><span id="l37.122" class="difflineminus">-function test_forward_as_attachments () {</span>
<a href="#l37.123"></a><span id="l37.123" class="difflineplus">+function test_forward_as_attachments() {</span>
<a href="#l37.124"></a><span id="l37.124">   be_in_folder(folder);</span>
<a href="#l37.125"></a><span id="l37.125">   // original message header</span>
<a href="#l37.126"></a><span id="l37.126">   let oMsgHdr0 = select_click_row(0);</span>
<a href="#l37.127"></a><span id="l37.127">   let oMsgHdr1 = select_click_row(1);</span>
<a href="#l37.128"></a><span id="l37.128">   select_shift_click_row(0);</span>
<a href="#l37.129"></a><span id="l37.129"> </span>
<a href="#l37.130"></a><span id="l37.130">   forward_selected_messages_and_go_to_drafts_folder(open_compose_with_forward_as_attachments);</span>
<a href="#l37.131"></a><span id="l37.131"> </span>
<a href="#l37.132"></a><span id="l37.132" class="difflineat">@@ -117,15 +125,15 @@ function test_forward_as_attachments () </span>
<a href="#l37.133"></a><span id="l37.133">     &quot;The forwarded message should have References: = Message-Id: of the original msg#1&quot;);</span>
<a href="#l37.134"></a><span id="l37.134">   assert_equals(fMsgHdr.getStringReference(0), oMsgHdr0.messageId,</span>
<a href="#l37.135"></a><span id="l37.135">     &quot;The forwarded message should have References: = Message-Id: of the original msg#0&quot;);</span>
<a href="#l37.136"></a><span id="l37.136"> </span>
<a href="#l37.137"></a><span id="l37.137">   // test for x-forwarded-message id and exercise the js mime representation as</span>
<a href="#l37.138"></a><span id="l37.138">   // well</span>
<a href="#l37.139"></a><span id="l37.139">   to_mime_message(fMsgHdr, null, function(aMsgHdr, aMimeMsg) {</span>
<a href="#l37.140"></a><span id="l37.140">     assert_equals(aMimeMsg.headers[&quot;x-forwarded-message-id&quot;],</span>
<a href="#l37.141"></a><span id="l37.141" class="difflineminus">-      &quot;&lt;&quot;+oMsgHdr0.messageId+&quot;&gt; &lt;&quot;+oMsgHdr1.messageId+&quot;&gt;&quot;);</span>
<a href="#l37.142"></a><span id="l37.142" class="difflineminus">-    assert_equals(aMimeMsg.headers[&quot;references&quot;],</span>
<a href="#l37.143"></a><span id="l37.143" class="difflineminus">-      &quot;&lt;&quot;+oMsgHdr0.messageId+&quot;&gt; &lt;&quot;+oMsgHdr1.messageId+&quot;&gt;&quot;);</span>
<a href="#l37.144"></a><span id="l37.144" class="difflineplus">+      &quot;&lt;&quot; + oMsgHdr0.messageId + &quot;&gt; &lt;&quot; + oMsgHdr1.messageId + &quot;&gt;&quot;);</span>
<a href="#l37.145"></a><span id="l37.145" class="difflineplus">+    assert_equals(aMimeMsg.headers.references,</span>
<a href="#l37.146"></a><span id="l37.146" class="difflineplus">+      &quot;&lt;&quot; + oMsgHdr0.messageId + &quot;&gt; &lt;&quot; + oMsgHdr1.messageId + &quot;&gt;&quot;);</span>
<a href="#l37.147"></a><span id="l37.147">   });</span>
<a href="#l37.148"></a><span id="l37.148"> </span>
<a href="#l37.149"></a><span id="l37.149">   press_delete(mc);</span>
<a href="#l37.150"></a><span id="l37.150"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-forward-rfc822-attach.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-forward-rfc822-attach.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -2,22 +2,23 @@</span>
<a href="#l38.4"></a><span id="l38.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l38.5"></a><span id="l38.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l38.6"></a><span id="l38.6"> </span>
<a href="#l38.7"></a><span id="l38.7"> /**</span>
<a href="#l38.8"></a><span id="l38.8">  * Tests that attached messages (message/rfc822) are correctly sent.</span>
<a href="#l38.9"></a><span id="l38.9">  * It's easiest to test the forward case.</span>
<a href="#l38.10"></a><span id="l38.10">  */</span>
<a href="#l38.11"></a><span id="l38.11"> </span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-// mozmake SOLO_TEST=composition/test-forward-rfc822-attach.js mozmill-one</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-</span>
<a href="#l38.14"></a><span id="l38.14"> &quot;use strict&quot;;</span>
<a href="#l38.15"></a><span id="l38.15"> </span>
<a href="#l38.16"></a><span id="l38.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l38.17"></a><span id="l38.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l38.18"></a><span id="l38.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l38.19"></a><span id="l38.19" class="difflineplus">+</span>
<a href="#l38.20"></a><span id="l38.20"> var MODULE_NAME = &quot;test-forward-rfc822-attach&quot;;</span>
<a href="#l38.21"></a><span id="l38.21" class="difflineminus">-</span>
<a href="#l38.22"></a><span id="l38.22"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l38.23"></a><span id="l38.23"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l38.24"></a><span id="l38.24"> </span>
<a href="#l38.25"></a><span id="l38.25"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l38.26"></a><span id="l38.26"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l38.27"></a><span id="l38.27"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l38.28"></a><span id="l38.28"> </span>
<a href="#l38.29"></a><span id="l38.29"> var gDrafts;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-forward-utf8.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-forward-utf8.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -1,22 +1,23 @@</span>
<a href="#l39.4"></a><span id="l39.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l39.5"></a><span id="l39.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l39.6"></a><span id="l39.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l39.7"></a><span id="l39.7"> </span>
<a href="#l39.8"></a><span id="l39.8"> /**</span>
<a href="#l39.9"></a><span id="l39.9">  * Tests that UTF-8 messages are correctly forwarded.</span>
<a href="#l39.10"></a><span id="l39.10">  */</span>
<a href="#l39.11"></a><span id="l39.11"> </span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-// mozmake SOLO_TEST=composition/test-forward-utf8.js mozmill-one</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-</span>
<a href="#l39.14"></a><span id="l39.14"> &quot;use strict&quot;;</span>
<a href="#l39.15"></a><span id="l39.15"> </span>
<a href="#l39.16"></a><span id="l39.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l39.17"></a><span id="l39.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l39.18"></a><span id="l39.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l39.19"></a><span id="l39.19" class="difflineplus">+</span>
<a href="#l39.20"></a><span id="l39.20"> var MODULE_NAME = &quot;test-forward-utf8&quot;;</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineminus">-</span>
<a href="#l39.22"></a><span id="l39.22"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l39.23"></a><span id="l39.23"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l39.24"></a><span id="l39.24"> </span>
<a href="#l39.25"></a><span id="l39.25"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l39.26"></a><span id="l39.26"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l39.27"></a><span id="l39.27"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l39.28"></a><span id="l39.28"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l39.29"></a><span id="l39.29"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-forwarded-content.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-forwarded-content.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -3,21 +3,23 @@</span>
<a href="#l40.4"></a><span id="l40.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l40.5"></a><span id="l40.5"> </span>
<a href="#l40.6"></a><span id="l40.6"> /**</span>
<a href="#l40.7"></a><span id="l40.7">  * Tests that forwarded content is ok.</span>
<a href="#l40.8"></a><span id="l40.8">  */</span>
<a href="#l40.9"></a><span id="l40.9"> </span>
<a href="#l40.10"></a><span id="l40.10"> &quot;use strict&quot;;</span>
<a href="#l40.11"></a><span id="l40.11"> </span>
<a href="#l40.12"></a><span id="l40.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l40.13"></a><span id="l40.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l40.14"></a><span id="l40.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l40.15"></a><span id="l40.15" class="difflineplus">+</span>
<a href="#l40.16"></a><span id="l40.16"> var MODULE_NAME = &quot;test-forwarded-content&quot;;</span>
<a href="#l40.17"></a><span id="l40.17" class="difflineminus">-</span>
<a href="#l40.18"></a><span id="l40.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l40.19"></a><span id="l40.19" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l40.20"></a><span id="l40.20" class="difflineminus">-                         &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l40.21"></a><span id="l40.21" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l40.22"></a><span id="l40.22"> </span>
<a href="#l40.23"></a><span id="l40.23"> var folder = null;</span>
<a href="#l40.24"></a><span id="l40.24"> </span>
<a href="#l40.25"></a><span id="l40.25"> function setupModule(module) {</span>
<a href="#l40.26"></a><span id="l40.26">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l40.27"></a><span id="l40.27">     collector.getModule(lib).installInto(module);</span>
<a href="#l40.28"></a><span id="l40.28">   }</span>
<a href="#l40.29"></a><span id="l40.29"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-forwarded-eml-actions.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-forwarded-eml-actions.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -2,25 +2,25 @@</span>
<a href="#l41.4"></a><span id="l41.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l41.5"></a><span id="l41.5">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l41.6"></a><span id="l41.6"> </span>
<a href="#l41.7"></a><span id="l41.7"> /**</span>
<a href="#l41.8"></a><span id="l41.8">  * Tests that actions such as replying and forwarding works correctly from</span>
<a href="#l41.9"></a><span id="l41.9">  * an .eml message that's attached to another mail.</span>
<a href="#l41.10"></a><span id="l41.10">  */</span>
<a href="#l41.11"></a><span id="l41.11"> </span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-// make SOLO_TEST=composition/test-forwarded-eml-actions.js mozmill-one</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l41.14"></a><span id="l41.14"> </span>
<a href="#l41.15"></a><span id="l41.15" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l41.19"></a><span id="l41.19"> </span>
<a href="#l41.20"></a><span id="l41.20"> var MODULE_NAME = &quot;test-forwarded-eml-actions&quot;;</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineminus">-</span>
<a href="#l41.22"></a><span id="l41.22"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l41.23"></a><span id="l41.23" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineminus">-                         &quot;compose-helpers&quot;];</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l41.26"></a><span id="l41.26"> </span>
<a href="#l41.27"></a><span id="l41.27"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l41.28"></a><span id="l41.28"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l41.29"></a><span id="l41.29"> </span>
<a href="#l41.30"></a><span id="l41.30"> var folder;</span>
<a href="#l41.31"></a><span id="l41.31"> </span>
<a href="#l41.32"></a><span id="l41.32"> var msgsubject = &quot;mail client suggestions&quot;;</span>
<a href="#l41.33"></a><span id="l41.33"> var msgbodyA = &quot;know of a good email client?&quot;;</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineat">@@ -76,17 +76,17 @@ var setupModule = function(module) {</span>
<a href="#l41.35"></a><span id="l41.35">     &quot;Content-Transfer-Encoding: 7bit\n&quot; +</span>
<a href="#l41.36"></a><span id="l41.36">     &quot;\n&quot; +</span>
<a href="#l41.37"></a><span id="l41.37">     msgbodyA + &quot;\n&quot; +</span>
<a href="#l41.38"></a><span id="l41.38">     &quot;\n&quot; +</span>
<a href="#l41.39"></a><span id="l41.39">     &quot;--------------080806020206040800000503--\n&quot;;</span>
<a href="#l41.40"></a><span id="l41.40"> </span>
<a href="#l41.41"></a><span id="l41.41">   folder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l41.42"></a><span id="l41.42">   folder.addMessage(source);</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineminus">-}</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineplus">+};</span>
<a href="#l41.45"></a><span id="l41.45"> </span>
<a href="#l41.46"></a><span id="l41.46"> /**</span>
<a href="#l41.47"></a><span id="l41.47">  * Helper to open an attached .eml file, invoke the hotkey and check some</span>
<a href="#l41.48"></a><span id="l41.48">  * properties of the composition content we get.</span>
<a href="#l41.49"></a><span id="l41.49">  */</span>
<a href="#l41.50"></a><span id="l41.50"> function setupWindowAndTest(hotkeyToHit, hotkeyModifiers) {</span>
<a href="#l41.51"></a><span id="l41.51">   be_in_folder(folder);</span>
<a href="#l41.52"></a><span id="l41.52"> </span>
<a href="#l41.53"></a><span id="l41.53" class="difflineat">@@ -108,17 +108,17 @@ function setupWindowAndTest(hotkeyToHit,</span>
<a href="#l41.54"></a><span id="l41.54"> </span>
<a href="#l41.55"></a><span id="l41.55">   if (!bodyText.includes(msgbodyA))</span>
<a href="#l41.56"></a><span id="l41.56">     throw new Error(&quot;body text didn't contain the body text; msgbodyA=&quot; +</span>
<a href="#l41.57"></a><span id="l41.57">                     msgbodyB + &quot;, bodyText=&quot; + bodyText);</span>
<a href="#l41.58"></a><span id="l41.58"> </span>
<a href="#l41.59"></a><span id="l41.59">   let subjectText = compWin.e(&quot;msgSubject&quot;).value;</span>
<a href="#l41.60"></a><span id="l41.60">   if (!subjectText.includes(msgsubject))</span>
<a href="#l41.61"></a><span id="l41.61">     throw new Error(&quot;subject text didn't contain the original subject; &quot; +</span>
<a href="#l41.62"></a><span id="l41.62" class="difflineminus">-                    &quot;msgsubject=&quot; +  msgsubject + &quot;, subjectText=&quot; + subjectText);</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineplus">+                    &quot;msgsubject=&quot; + msgsubject + &quot;, subjectText=&quot; + subjectText);</span>
<a href="#l41.64"></a><span id="l41.64"> </span>
<a href="#l41.65"></a><span id="l41.65">   close_compose_window(compWin, false);</span>
<a href="#l41.66"></a><span id="l41.66">   close_window(msgWin);</span>
<a href="#l41.67"></a><span id="l41.67"> }</span>
<a href="#l41.68"></a><span id="l41.68"> </span>
<a href="#l41.69"></a><span id="l41.69"> /**</span>
<a href="#l41.70"></a><span id="l41.70">  * Test that replying to an attached .eml contains the expected texts.</span>
<a href="#l41.71"></a><span id="l41.71">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-image-display.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-image-display.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -1,25 +1,25 @@</span>
<a href="#l42.4"></a><span id="l42.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l42.5"></a><span id="l42.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l42.6"></a><span id="l42.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l42.7"></a><span id="l42.7"> </span>
<a href="#l42.8"></a><span id="l42.8"> /**</span>
<a href="#l42.9"></a><span id="l42.9">  * Tests that we load and display embedded images in messages.</span>
<a href="#l42.10"></a><span id="l42.10">  */</span>
<a href="#l42.11"></a><span id="l42.11"> </span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-// make SOLO_TEST=composition/test-image-display.js mozmill-one</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l42.14"></a><span id="l42.14"> </span>
<a href="#l42.15"></a><span id="l42.15" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l42.17"></a><span id="l42.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l42.18"></a><span id="l42.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l42.19"></a><span id="l42.19"> </span>
<a href="#l42.20"></a><span id="l42.20"> var MODULE_NAME = &quot;test-image-display&quot;;</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineminus">-</span>
<a href="#l42.22"></a><span id="l42.22"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineminus">-var MODULE_REQUIRES = [ &quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineminus">-                        &quot;compose-helpers&quot; ];</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l42.26"></a><span id="l42.26"> </span>
<a href="#l42.27"></a><span id="l42.27"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l42.28"></a><span id="l42.28"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l42.29"></a><span id="l42.29"> var {IOUtils} = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l42.30"></a><span id="l42.30"> </span>
<a href="#l42.31"></a><span id="l42.31"> var gImageFolder;</span>
<a href="#l42.32"></a><span id="l42.32"> </span>
<a href="#l42.33"></a><span id="l42.33"> function setupModule(module) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-image-insertion-dialog.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-image-insertion-dialog.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -3,34 +3,42 @@</span>
<a href="#l43.4"></a><span id="l43.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l43.5"></a><span id="l43.5"> </span>
<a href="#l43.6"></a><span id="l43.6"> /**</span>
<a href="#l43.7"></a><span id="l43.7">  * Tests the image insertion dialog functionality.</span>
<a href="#l43.8"></a><span id="l43.8">  */</span>
<a href="#l43.9"></a><span id="l43.9"> </span>
<a href="#l43.10"></a><span id="l43.10"> &quot;use strict&quot;;</span>
<a href="#l43.11"></a><span id="l43.11"> </span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-keyboard-helpers.js */</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l43.17"></a><span id="l43.17"> </span>
<a href="#l43.18"></a><span id="l43.18"> var MODULE_NAME = &quot;test-image-insertion-dialog&quot;;</span>
<a href="#l43.19"></a><span id="l43.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l43.22"></a><span id="l43.22" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l43.24"></a><span id="l43.24" class="difflineplus">+  &quot;keyboard-helpers&quot;,</span>
<a href="#l43.25"></a><span id="l43.25" class="difflineplus">+];</span>
<a href="#l43.26"></a><span id="l43.26"> </span>
<a href="#l43.27"></a><span id="l43.27" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l43.28"></a><span id="l43.28" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'compose-helpers',</span>
<a href="#l43.29"></a><span id="l43.29" class="difflineminus">-                       'window-helpers', 'keyboard-helpers'];</span>
<a href="#l43.30"></a><span id="l43.30" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l43.31"></a><span id="l43.31"> </span>
<a href="#l43.32"></a><span id="l43.32"> var fdh, ch, wh, kh;</span>
<a href="#l43.33"></a><span id="l43.33"> </span>
<a href="#l43.34"></a><span id="l43.34"> function setupModule(module) {</span>
<a href="#l43.35"></a><span id="l43.35" class="difflineminus">-  fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l43.36"></a><span id="l43.36" class="difflineplus">+  fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l43.37"></a><span id="l43.37">   fdh.installInto(module);</span>
<a href="#l43.38"></a><span id="l43.38">   ch = collector.getModule(&quot;compose-helpers&quot;);</span>
<a href="#l43.39"></a><span id="l43.39">   ch.installInto(module);</span>
<a href="#l43.40"></a><span id="l43.40" class="difflineminus">-  wh = collector.getModule('window-helpers');</span>
<a href="#l43.41"></a><span id="l43.41" class="difflineplus">+  wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l43.42"></a><span id="l43.42">   wh.installInto(module);</span>
<a href="#l43.43"></a><span id="l43.43" class="difflineminus">-  kh = collector.getModule('keyboard-helpers');</span>
<a href="#l43.44"></a><span id="l43.44" class="difflineplus">+  kh = collector.getModule(&quot;keyboard-helpers&quot;);</span>
<a href="#l43.45"></a><span id="l43.45">   kh.installInto(module);</span>
<a href="#l43.46"></a><span id="l43.46"> }</span>
<a href="#l43.47"></a><span id="l43.47"> </span>
<a href="#l43.48"></a><span id="l43.48"> function test_image_insertion_dialog_persist() {</span>
<a href="#l43.49"></a><span id="l43.49">   let cwc = open_compose_new_mail();</span>
<a href="#l43.50"></a><span id="l43.50"> </span>
<a href="#l43.51"></a><span id="l43.51">   // First focus on the editor element</span>
<a href="#l43.52"></a><span id="l43.52">   cwc.e(&quot;content-frame&quot;).focus();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-multipart-related.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-multipart-related.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -1,22 +1,23 @@</span>
<a href="#l44.4"></a><span id="l44.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l44.5"></a><span id="l44.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l44.6"></a><span id="l44.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l44.7"></a><span id="l44.7"> </span>
<a href="#l44.8"></a><span id="l44.8"> /**</span>
<a href="#l44.9"></a><span id="l44.9">  * Tests that multipart/related messages are handled properly.</span>
<a href="#l44.10"></a><span id="l44.10">  */</span>
<a href="#l44.11"></a><span id="l44.11"> </span>
<a href="#l44.12"></a><span id="l44.12" class="difflineminus">-// make SOLO_TEST=composition/test-multipart-related.js mozmill-one</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineminus">-</span>
<a href="#l44.14"></a><span id="l44.14"> &quot;use strict&quot;;</span>
<a href="#l44.15"></a><span id="l44.15"> </span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineplus">+</span>
<a href="#l44.20"></a><span id="l44.20"> var MODULE_NAME = &quot;test-multipart-related&quot;;</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineminus">-</span>
<a href="#l44.22"></a><span id="l44.22"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l44.23"></a><span id="l44.23"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l44.24"></a><span id="l44.24"> </span>
<a href="#l44.25"></a><span id="l44.25"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l44.26"></a><span id="l44.26"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l44.27"></a><span id="l44.27"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l44.28"></a><span id="l44.28"> var {MimeParser} = ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l44.29"></a><span id="l44.29"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l44.30"></a><span id="l44.30" class="difflineat">@@ -42,21 +43,21 @@ function getMsgHeaders(aMsgHdr) {</span>
<a href="#l44.31"></a><span id="l44.31">   let msgUri = msgFolder.getUriForMsg(aMsgHdr);</span>
<a href="#l44.32"></a><span id="l44.32"> </span>
<a href="#l44.33"></a><span id="l44.33">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l44.34"></a><span id="l44.34">                     .createInstance(Ci.nsIMessenger);</span>
<a href="#l44.35"></a><span id="l44.35">   let handler = {</span>
<a href="#l44.36"></a><span id="l44.36">     _done: false,</span>
<a href="#l44.37"></a><span id="l44.37">     _data: new Map(),</span>
<a href="#l44.38"></a><span id="l44.38">     _text: new Map(),</span>
<a href="#l44.39"></a><span id="l44.39" class="difflineminus">-    endMessage: function () { this._done = true; },</span>
<a href="#l44.40"></a><span id="l44.40" class="difflineminus">-    deliverPartData: function (num, text) {</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineplus">+    endMessage() { this._done = true; },</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineplus">+    deliverPartData(num, text) {</span>
<a href="#l44.43"></a><span id="l44.43">       this._text.set(num, this._text.get(num) + text);</span>
<a href="#l44.44"></a><span id="l44.44">     },</span>
<a href="#l44.45"></a><span id="l44.45" class="difflineminus">-    startPart: function (num, headers) {</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineplus">+    startPart(num, headers) {</span>
<a href="#l44.47"></a><span id="l44.47">       this._data.set(num, headers);</span>
<a href="#l44.48"></a><span id="l44.48">       this._text.set(num, &quot;&quot;);</span>
<a href="#l44.49"></a><span id="l44.49">     },</span>
<a href="#l44.50"></a><span id="l44.50">   };</span>
<a href="#l44.51"></a><span id="l44.51">   let streamListener = MimeParser.makeStreamListenerParser(handler,</span>
<a href="#l44.52"></a><span id="l44.52">     {strformat: &quot;unicode&quot;});</span>
<a href="#l44.53"></a><span id="l44.53">   messenger.messageServiceFromURI(msgUri).streamMessage(msgUri,</span>
<a href="#l44.54"></a><span id="l44.54">                                                         streamListener,</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineat">@@ -79,17 +80,17 @@ function test_basic_multipart_related() </span>
<a href="#l44.56"></a><span id="l44.56"> </span>
<a href="#l44.57"></a><span id="l44.57">   const fname = &quot;./tb-logo.png&quot;;</span>
<a href="#l44.58"></a><span id="l44.58">   let file = os.getFileForPath(os.abspath(fname, os.getFileForPath(__file__)));</span>
<a href="#l44.59"></a><span id="l44.59">   let fileHandler = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l44.60"></a><span id="l44.60">     .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l44.61"></a><span id="l44.61">   let fileURL = fileHandler.getURLSpecFromFile(file);</span>
<a href="#l44.62"></a><span id="l44.62"> </span>
<a href="#l44.63"></a><span id="l44.63">   // Add a simple image to our dialog</span>
<a href="#l44.64"></a><span id="l44.64" class="difflineminus">-  plan_for_modal_dialog(&quot;imageDlg&quot;, function (dialog) {</span>
<a href="#l44.65"></a><span id="l44.65" class="difflineplus">+  plan_for_modal_dialog(&quot;imageDlg&quot;, function(dialog) {</span>
<a href="#l44.66"></a><span id="l44.66">     // Insert the url of the image.</span>
<a href="#l44.67"></a><span id="l44.67">     dialog.type(null, fileURL);</span>
<a href="#l44.68"></a><span id="l44.68">     dialog.type(dialog.eid(&quot;altTextInput&quot;), &quot;Alt text&quot;);</span>
<a href="#l44.69"></a><span id="l44.69">     dialog.sleep(0);</span>
<a href="#l44.70"></a><span id="l44.70"> </span>
<a href="#l44.71"></a><span id="l44.71">     // Accept the dialog</span>
<a href="#l44.72"></a><span id="l44.72">     dialog.window.document.getElementById(&quot;imageDlg&quot;).acceptDialog();</span>
<a href="#l44.73"></a><span id="l44.73">   });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-newmsg-compose-identity.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-newmsg-compose-identity.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -4,21 +4,23 @@</span>
<a href="#l45.4"></a><span id="l45.4"> </span>
<a href="#l45.5"></a><span id="l45.5"> /**</span>
<a href="#l45.6"></a><span id="l45.6">  * Tests that compose new message chooses the correct initial identity when</span>
<a href="#l45.7"></a><span id="l45.7">  * called from the context of an open composer.</span>
<a href="#l45.8"></a><span id="l45.8">  */</span>
<a href="#l45.9"></a><span id="l45.9"> </span>
<a href="#l45.10"></a><span id="l45.10"> &quot;use strict&quot;;</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l45.14"></a><span id="l45.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineplus">+</span>
<a href="#l45.16"></a><span id="l45.16"> var MODULE_NAME = &quot;test-newmsg-compose-identity&quot;;</span>
<a href="#l45.17"></a><span id="l45.17" class="difflineminus">-</span>
<a href="#l45.18"></a><span id="l45.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l45.19"></a><span id="l45.19" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l45.20"></a><span id="l45.20" class="difflineminus">-                       &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l45.21"></a><span id="l45.21" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l45.22"></a><span id="l45.22"> </span>
<a href="#l45.23"></a><span id="l45.23"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l45.24"></a><span id="l45.24"> </span>
<a href="#l45.25"></a><span id="l45.25"> var gInbox;</span>
<a href="#l45.26"></a><span id="l45.26"> var gDrafts;</span>
<a href="#l45.27"></a><span id="l45.27"> var account;</span>
<a href="#l45.28"></a><span id="l45.28"> </span>
<a href="#l45.29"></a><span id="l45.29"> var identityKey1;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-reply-addresses.js</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-reply-addresses.js</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -3,25 +3,25 @@</span>
<a href="#l46.4"></a><span id="l46.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l46.5"></a><span id="l46.5"> </span>
<a href="#l46.6"></a><span id="l46.6"> /**</span>
<a href="#l46.7"></a><span id="l46.7">  * Tests that we get correct adressees for different type of replies:</span>
<a href="#l46.8"></a><span id="l46.8">  * reply to sender, reply to all, reply to list, mail-followup-tp,</span>
<a href="#l46.9"></a><span id="l46.9">  * mail-reply-to, and reply to self.</span>
<a href="#l46.10"></a><span id="l46.10">  */</span>
<a href="#l46.11"></a><span id="l46.11"> </span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-// make SOLO_TEST=composition/test-reply-addresses.js mozmill-one</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l46.14"></a><span id="l46.14"> </span>
<a href="#l46.15"></a><span id="l46.15" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l46.16"></a><span id="l46.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l46.17"></a><span id="l46.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l46.18"></a><span id="l46.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l46.19"></a><span id="l46.19"> </span>
<a href="#l46.20"></a><span id="l46.20"> var MODULE_NAME = &quot;test-reply-addresses&quot;;</span>
<a href="#l46.21"></a><span id="l46.21" class="difflineminus">-</span>
<a href="#l46.22"></a><span id="l46.22"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l46.23"></a><span id="l46.23" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l46.24"></a><span id="l46.24" class="difflineminus">-                         &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l46.25"></a><span id="l46.25" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l46.26"></a><span id="l46.26"> </span>
<a href="#l46.27"></a><span id="l46.27"> var folder;</span>
<a href="#l46.28"></a><span id="l46.28"> var i = 0;</span>
<a href="#l46.29"></a><span id="l46.29"> </span>
<a href="#l46.30"></a><span id="l46.30"> var myEmail = &quot;me@example.com&quot;;</span>
<a href="#l46.31"></a><span id="l46.31"> var myEmail2 = &quot;otherme@example.com&quot;;</span>
<a href="#l46.32"></a><span id="l46.32"> </span>
<a href="#l46.33"></a><span id="l46.33"> var identity;</span>
<a href="#l46.34"></a><span id="l46.34" class="difflineat">@@ -177,17 +177,17 @@ function ensureNoAutoBcc(aIdentity) {</span>
<a href="#l46.35"></a><span id="l46.35"> function testReplyToMungedReplyToList() {</span>
<a href="#l46.36"></a><span id="l46.36">   let msg0 = create_message({</span>
<a href="#l46.37"></a><span id="l46.37">     from: &quot;Tester &lt;test@example.com&gt;&quot;,</span>
<a href="#l46.38"></a><span id="l46.38">     to: &quot;munged.list@example.com, someone.else@example.com&quot;,</span>
<a href="#l46.39"></a><span id="l46.39">     subject: &quot;testReplyToMungedReplyToList&quot;,</span>
<a href="#l46.40"></a><span id="l46.40">     clobberHeaders: {</span>
<a href="#l46.41"></a><span id="l46.41">       &quot;Reply-To&quot;: &quot;Munged List &lt;munged.list@example.com&gt;&quot;,</span>
<a href="#l46.42"></a><span id="l46.42">       &quot;List-Post&quot;: &quot;&lt;mailto:munged.list@example.com&gt;&quot;,</span>
<a href="#l46.43"></a><span id="l46.43" class="difflineminus">-    }</span>
<a href="#l46.44"></a><span id="l46.44" class="difflineplus">+    },</span>
<a href="#l46.45"></a><span id="l46.45">   });</span>
<a href="#l46.46"></a><span id="l46.46">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.47"></a><span id="l46.47"> </span>
<a href="#l46.48"></a><span id="l46.48">   be_in_folder(folder);</span>
<a href="#l46.49"></a><span id="l46.49">   let msg = select_click_row(i++);</span>
<a href="#l46.50"></a><span id="l46.50">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.51"></a><span id="l46.51"> </span>
<a href="#l46.52"></a><span id="l46.52">   ensureNoAutoCc(identity);</span>
<a href="#l46.53"></a><span id="l46.53" class="difflineat">@@ -198,39 +198,39 @@ function testReplyToMungedReplyToList() </span>
<a href="#l46.54"></a><span id="l46.54">   );</span>
<a href="#l46.55"></a><span id="l46.55"> </span>
<a href="#l46.56"></a><span id="l46.56">   checkReply(</span>
<a href="#l46.57"></a><span id="l46.57">     open_compose_with_reply_to_all,</span>
<a href="#l46.58"></a><span id="l46.58">     {</span>
<a href="#l46.59"></a><span id="l46.59">       &quot;addr_to&quot;: [</span>
<a href="#l46.60"></a><span id="l46.60">         &quot;Munged List &lt;munged.list@example.com&gt;&quot;,</span>
<a href="#l46.61"></a><span id="l46.61">         &quot;someone.else@example.com&quot;,</span>
<a href="#l46.62"></a><span id="l46.62" class="difflineminus">-        &quot;Tester &lt;test@example.com&gt;&quot;</span>
<a href="#l46.63"></a><span id="l46.63" class="difflineminus">-       ]</span>
<a href="#l46.64"></a><span id="l46.64" class="difflineplus">+        &quot;Tester &lt;test@example.com&gt;&quot;,</span>
<a href="#l46.65"></a><span id="l46.65" class="difflineplus">+       ],</span>
<a href="#l46.66"></a><span id="l46.66">     }</span>
<a href="#l46.67"></a><span id="l46.67">   );</span>
<a href="#l46.68"></a><span id="l46.68"> </span>
<a href="#l46.69"></a><span id="l46.69">   checkReply(</span>
<a href="#l46.70"></a><span id="l46.70">     open_compose_with_reply_to_list,</span>
<a href="#l46.71"></a><span id="l46.71">     {</span>
<a href="#l46.72"></a><span id="l46.72" class="difflineminus">-      &quot;addr_to&quot;: [&quot;munged.list@example.com&quot;]</span>
<a href="#l46.73"></a><span id="l46.73" class="difflineplus">+      &quot;addr_to&quot;: [&quot;munged.list@example.com&quot;],</span>
<a href="#l46.74"></a><span id="l46.74">     }</span>
<a href="#l46.75"></a><span id="l46.75">   );</span>
<a href="#l46.76"></a><span id="l46.76"> }</span>
<a href="#l46.77"></a><span id="l46.77"> </span>
<a href="#l46.78"></a><span id="l46.78"> /**</span>
<a href="#l46.79"></a><span id="l46.79">  * Tests that addresses get set properly when doing a normal reply.</span>
<a href="#l46.80"></a><span id="l46.80">  */</span>
<a href="#l46.81"></a><span id="l46.81"> function testToCcReply() {</span>
<a href="#l46.82"></a><span id="l46.82">   let msg0 = create_message({</span>
<a href="#l46.83"></a><span id="l46.83">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l46.84"></a><span id="l46.84">     to: &quot;Mr Burns &lt;mrburns@example.com&gt;, workers@example.com, &quot; +</span>
<a href="#l46.85"></a><span id="l46.85">         myEmail,</span>
<a href="#l46.86"></a><span id="l46.86">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l46.87"></a><span id="l46.87" class="difflineminus">-    subject: &quot;testToCcReply - normal mail with to and cc (me in To)&quot;</span>
<a href="#l46.88"></a><span id="l46.88" class="difflineplus">+    subject: &quot;testToCcReply - normal mail with to and cc (me in To)&quot;,</span>
<a href="#l46.89"></a><span id="l46.89">   });</span>
<a href="#l46.90"></a><span id="l46.90">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.91"></a><span id="l46.91"> </span>
<a href="#l46.92"></a><span id="l46.92">   be_in_folder(folder);</span>
<a href="#l46.93"></a><span id="l46.93">   let msg = select_click_row(i++);</span>
<a href="#l46.94"></a><span id="l46.94">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.95"></a><span id="l46.95"> </span>
<a href="#l46.96"></a><span id="l46.96">   ensureNoAutoCc(identity);</span>
<a href="#l46.97"></a><span id="l46.97" class="difflineat">@@ -242,85 +242,89 @@ function testToCcReply() {</span>
<a href="#l46.98"></a><span id="l46.98"> </span>
<a href="#l46.99"></a><span id="l46.99">   useAutoCc(identity, myEmail + &quot;, smithers@example.com&quot;);</span>
<a href="#l46.100"></a><span id="l46.100">   checkReply(</span>
<a href="#l46.101"></a><span id="l46.101">     open_compose_with_reply,</span>
<a href="#l46.102"></a><span id="l46.102">     // To: From</span>
<a href="#l46.103"></a><span id="l46.103">     // Cc: identity Cc list, including self.</span>
<a href="#l46.104"></a><span id="l46.104">     {</span>
<a href="#l46.105"></a><span id="l46.105">       &quot;addr_to&quot;: [&quot;Homer &lt;homer@example.com&gt;&quot;],</span>
<a href="#l46.106"></a><span id="l46.106" class="difflineminus">-      &quot;addr_cc&quot;: [myEmail, &quot;smithers@example.com&quot;]</span>
<a href="#l46.107"></a><span id="l46.107" class="difflineplus">+      &quot;addr_cc&quot;: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l46.108"></a><span id="l46.108">     }</span>
<a href="#l46.109"></a><span id="l46.109">   );</span>
<a href="#l46.110"></a><span id="l46.110">   stopUsingAutoCc(identity);</span>
<a href="#l46.111"></a><span id="l46.111"> }</span>
<a href="#l46.112"></a><span id="l46.112"> </span>
<a href="#l46.113"></a><span id="l46.113"> /**</span>
<a href="#l46.114"></a><span id="l46.114">  * Tests that addresses get set properly when doing a normal reply to all.</span>
<a href="#l46.115"></a><span id="l46.115">  */</span>
<a href="#l46.116"></a><span id="l46.116"> function testToCcReplyAll() {</span>
<a href="#l46.117"></a><span id="l46.117">   let msg0 = create_message({</span>
<a href="#l46.118"></a><span id="l46.118">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l46.119"></a><span id="l46.119">     to: &quot;Mr Burns &lt;mrburns@example.com&gt;, workers@example.com, &quot; +</span>
<a href="#l46.120"></a><span id="l46.120">         myEmail,</span>
<a href="#l46.121"></a><span id="l46.121">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l46.122"></a><span id="l46.122" class="difflineminus">-    subject: &quot;testToCcReplyAll - normal mail with to and cc (me in To)&quot;</span>
<a href="#l46.123"></a><span id="l46.123" class="difflineplus">+    subject: &quot;testToCcReplyAll - normal mail with to and cc (me in To)&quot;,</span>
<a href="#l46.124"></a><span id="l46.124">   });</span>
<a href="#l46.125"></a><span id="l46.125">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.126"></a><span id="l46.126"> </span>
<a href="#l46.127"></a><span id="l46.127">   be_in_folder(folder);</span>
<a href="#l46.128"></a><span id="l46.128">   let msg = select_click_row(i++);</span>
<a href="#l46.129"></a><span id="l46.129">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.130"></a><span id="l46.130"> </span>
<a href="#l46.131"></a><span id="l46.131">   ensureNoAutoCc(identity);</span>
<a href="#l46.132"></a><span id="l46.132">   checkReply(</span>
<a href="#l46.133"></a><span id="l46.133">     open_compose_with_reply_to_all,</span>
<a href="#l46.134"></a><span id="l46.134">     // To: From + Tos without me.</span>
<a href="#l46.135"></a><span id="l46.135">     // Cc: original Ccs</span>
<a href="#l46.136"></a><span id="l46.136">     {</span>
<a href="#l46.137"></a><span id="l46.137">       &quot;addr_to&quot;: [&quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l46.138"></a><span id="l46.138">                   &quot;Mr Burns &lt;mrburns@example.com&gt;&quot;,</span>
<a href="#l46.139"></a><span id="l46.139">                   &quot;workers@example.com&quot;],</span>
<a href="#l46.140"></a><span id="l46.140" class="difflineminus">-      &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;]</span>
<a href="#l46.141"></a><span id="l46.141" class="difflineplus">+      &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l46.142"></a><span id="l46.142">     }</span>
<a href="#l46.143"></a><span id="l46.143">   );</span>
<a href="#l46.144"></a><span id="l46.144"> </span>
<a href="#l46.145"></a><span id="l46.145">   useAutoCc(identity, myEmail + &quot;, smithers@example.com&quot;);</span>
<a href="#l46.146"></a><span id="l46.146">   checkReply(</span>
<a href="#l46.147"></a><span id="l46.147">     open_compose_with_reply_to_all,</span>
<a href="#l46.148"></a><span id="l46.148">     // To: From + Tos without me.</span>
<a href="#l46.149"></a><span id="l46.149">     // Cc: original Ccs + auto-Ccs</span>
<a href="#l46.150"></a><span id="l46.150">     {</span>
<a href="#l46.151"></a><span id="l46.151">       &quot;addr_to&quot;: [&quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l46.152"></a><span id="l46.152">                   &quot;Mr Burns &lt;mrburns@example.com&gt;&quot;,</span>
<a href="#l46.153"></a><span id="l46.153">                   &quot;workers@example.com&quot;],</span>
<a href="#l46.154"></a><span id="l46.154">       &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l46.155"></a><span id="l46.155">                   myEmail,</span>
<a href="#l46.156"></a><span id="l46.156" class="difflineminus">-                  &quot;smithers@example.com&quot;]</span>
<a href="#l46.157"></a><span id="l46.157" class="difflineplus">+                  &quot;smithers@example.com&quot;],</span>
<a href="#l46.158"></a><span id="l46.158">     }</span>
<a href="#l46.159"></a><span id="l46.159">   );</span>
<a href="#l46.160"></a><span id="l46.160">   stopUsingAutoCc(identity);</span>
<a href="#l46.161"></a><span id="l46.161"> }</span>
<a href="#l46.162"></a><span id="l46.162"> </span>
<a href="#l46.163"></a><span id="l46.163"> /**</span>
<a href="#l46.164"></a><span id="l46.164">  * Tests that that addresses get set properly when doing a normal reply to all</span>
<a href="#l46.165"></a><span id="l46.165">  * where when recipients aren't all ascii.</span>
<a href="#l46.166"></a><span id="l46.166">  */</span>
<a href="#l46.167"></a><span id="l46.167"> function testToCcReplyAllInternational() {</span>
<a href="#l46.168"></a><span id="l46.168">   let msg0 = create_message({</span>
<a href="#l46.169"></a><span id="l46.169">     from: &quot;Hideaki / =?iso-2022-jp?B?GyRCNUhGIzFRTEAbKEI=?= &lt;hideaki@example.com&gt;&quot;,</span>
<a href="#l46.170"></a><span id="l46.170">     to: &quot;Mr Burns &lt;mrburns@example.com&gt;, =?UTF-8?B?w4VrZQ==?= &lt;ake@example.com&gt;, &quot; +</span>
<a href="#l46.171"></a><span id="l46.171">         &quot;=?KOI8-R?Q?=E9=D7=C1=CE?= &lt;ivan@example.com&gt;, &quot; + myEmail,</span>
<a href="#l46.172"></a><span id="l46.172">     cc: &quot;=?Big5?B?pP2oca1e?= &lt;xiuying@example.com&gt;&quot;,</span>
<a href="#l46.173"></a><span id="l46.173">     subject: &quot;testToCcReplyAllInternational - non-ascii people mail with to and cc (me in To)&quot;,</span>
<a href="#l46.174"></a><span id="l46.174" class="difflineminus">-    clobberHeaders: { 'Content-Transfer-Encoding': 'quoted-printable' },</span>
<a href="#l46.175"></a><span id="l46.175" class="difflineplus">+    clobberHeaders: { &quot;Content-Transfer-Encoding&quot;: &quot;quoted-printable&quot; },</span>
<a href="#l46.176"></a><span id="l46.176">     // Content-Transfer-Encoding ^^^ should be set from the body encoding below,</span>
<a href="#l46.177"></a><span id="l46.177" class="difflineminus">-    //but that doesn't seem to work. (No Content-Transfer-Encoding header is</span>
<a href="#l46.178"></a><span id="l46.178" class="difflineplus">+    // but that doesn't seem to work. (No Content-Transfer-Encoding header is</span>
<a href="#l46.179"></a><span id="l46.179">     // generated).</span>
<a href="#l46.180"></a><span id="l46.180" class="difflineminus">-    body: {charset: &quot;windows-1251&quot;, encoding: &quot;quoted-printable&quot;, body: &quot;=CF=F0=E8=E2=E5=F2 =E8=E7 =CC=EE=F1=EA=E2=FB&quot;}</span>
<a href="#l46.181"></a><span id="l46.181" class="difflineplus">+    body: {</span>
<a href="#l46.182"></a><span id="l46.182" class="difflineplus">+      charset: &quot;windows-1251&quot;,</span>
<a href="#l46.183"></a><span id="l46.183" class="difflineplus">+      encoding: &quot;quoted-printable&quot;,</span>
<a href="#l46.184"></a><span id="l46.184" class="difflineplus">+      body: &quot;=CF=F0=E8=E2=E5=F2 =E8=E7 =CC=EE=F1=EA=E2=FB&quot;,</span>
<a href="#l46.185"></a><span id="l46.185" class="difflineplus">+    },</span>
<a href="#l46.186"></a><span id="l46.186">   });</span>
<a href="#l46.187"></a><span id="l46.187">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.188"></a><span id="l46.188"> </span>
<a href="#l46.189"></a><span id="l46.189">   be_in_folder(folder);</span>
<a href="#l46.190"></a><span id="l46.190">   let msg = select_click_row(i++);</span>
<a href="#l46.191"></a><span id="l46.191">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.192"></a><span id="l46.192"> </span>
<a href="#l46.193"></a><span id="l46.193">   ensureNoAutoCc(identity);</span>
<a href="#l46.194"></a><span id="l46.194" class="difflineat">@@ -328,49 +332,49 @@ function testToCcReplyAllInternational()</span>
<a href="#l46.195"></a><span id="l46.195">     open_compose_with_reply_to_all,</span>
<a href="#l46.196"></a><span id="l46.196">     // To: From + Tos without me.</span>
<a href="#l46.197"></a><span id="l46.197">     // Cc: original Ccs</span>
<a href="#l46.198"></a><span id="l46.198">     {</span>
<a href="#l46.199"></a><span id="l46.199">       &quot;addr_to&quot;: [&quot;Hideaki /  &lt;hideaki@example.com&gt;&quot;,</span>
<a href="#l46.200"></a><span id="l46.200">                   &quot;Mr Burns &lt;mrburns@example.com&gt;&quot;,</span>
<a href="#l46.201"></a><span id="l46.201">                   &quot;ke &lt;ake@example.com&gt;&quot;,</span>
<a href="#l46.202"></a><span id="l46.202">                   &quot; &lt;ivan@example.com&gt;&quot;],</span>
<a href="#l46.203"></a><span id="l46.203" class="difflineminus">-      &quot;addr_cc&quot;: [&quot; &lt;xiuying@example.com&gt;&quot;]</span>
<a href="#l46.204"></a><span id="l46.204" class="difflineplus">+      &quot;addr_cc&quot;: [&quot; &lt;xiuying@example.com&gt;&quot;],</span>
<a href="#l46.205"></a><span id="l46.205">     }</span>
<a href="#l46.206"></a><span id="l46.206">   );</span>
<a href="#l46.207"></a><span id="l46.207"> </span>
<a href="#l46.208"></a><span id="l46.208">   useAutoCc(identity, &quot;sa &lt;asa@example.com&gt;&quot;);</span>
<a href="#l46.209"></a><span id="l46.209">   checkReply(</span>
<a href="#l46.210"></a><span id="l46.210">     open_compose_with_reply_to_all,</span>
<a href="#l46.211"></a><span id="l46.211">     // To: From + Tos without me.</span>
<a href="#l46.212"></a><span id="l46.212">     // Cc: original Ccs + auto-Ccs</span>
<a href="#l46.213"></a><span id="l46.213">     {</span>
<a href="#l46.214"></a><span id="l46.214">       &quot;addr_to&quot;: [&quot;Hideaki /  &lt;hideaki@example.com&gt;&quot;,</span>
<a href="#l46.215"></a><span id="l46.215">                   &quot;Mr Burns &lt;mrburns@example.com&gt;&quot;,</span>
<a href="#l46.216"></a><span id="l46.216">                   &quot;ke &lt;ake@example.com&gt;&quot;,</span>
<a href="#l46.217"></a><span id="l46.217">                   &quot; &lt;ivan@example.com&gt;&quot;],</span>
<a href="#l46.218"></a><span id="l46.218" class="difflineminus">-      &quot;addr_cc&quot;: [&quot; &lt;xiuying@example.com&gt;&quot;, &quot;sa &lt;asa@example.com&gt;&quot;]</span>
<a href="#l46.219"></a><span id="l46.219" class="difflineplus">+      &quot;addr_cc&quot;: [&quot; &lt;xiuying@example.com&gt;&quot;, &quot;sa &lt;asa@example.com&gt;&quot;],</span>
<a href="#l46.220"></a><span id="l46.220">     }</span>
<a href="#l46.221"></a><span id="l46.221">   );</span>
<a href="#l46.222"></a><span id="l46.222">   stopUsingAutoCc(identity);</span>
<a href="#l46.223"></a><span id="l46.223"> }</span>
<a href="#l46.224"></a><span id="l46.224"> </span>
<a href="#l46.225"></a><span id="l46.225"> /**</span>
<a href="#l46.226"></a><span id="l46.226">  * Tests that that addresses get set properly when doing a reply to a mail with</span>
<a href="#l46.227"></a><span id="l46.227">  * reply-to set.</span>
<a href="#l46.228"></a><span id="l46.228">  */</span>
<a href="#l46.229"></a><span id="l46.229"> function testToCcReplyWhenReplyToSet() {</span>
<a href="#l46.230"></a><span id="l46.230">   let msg0 = create_message({</span>
<a href="#l46.231"></a><span id="l46.231">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l46.232"></a><span id="l46.232">     to: &quot;workers@example.com&quot;,</span>
<a href="#l46.233"></a><span id="l46.233">     cc: &quot;Lisa &lt;lisa@example.com&gt;, &quot; + myEmail,</span>
<a href="#l46.234"></a><span id="l46.234">     subject: &quot;testToCcReplyWhenReplyToSet - to/cc mail with reply-to set (me in Cc)&quot;,</span>
<a href="#l46.235"></a><span id="l46.235">     clobberHeaders: {</span>
<a href="#l46.236"></a><span id="l46.236" class="difflineminus">-      &quot;Reply-To&quot;: &quot;marge@example.com&quot;</span>
<a href="#l46.237"></a><span id="l46.237" class="difflineminus">-    }</span>
<a href="#l46.238"></a><span id="l46.238" class="difflineplus">+      &quot;Reply-To&quot;: &quot;marge@example.com&quot;,</span>
<a href="#l46.239"></a><span id="l46.239" class="difflineplus">+    },</span>
<a href="#l46.240"></a><span id="l46.240">   });</span>
<a href="#l46.241"></a><span id="l46.241">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.242"></a><span id="l46.242"> </span>
<a href="#l46.243"></a><span id="l46.243">   be_in_folder(folder);</span>
<a href="#l46.244"></a><span id="l46.244">   let msg = select_click_row(i++);</span>
<a href="#l46.245"></a><span id="l46.245">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.246"></a><span id="l46.246"> </span>
<a href="#l46.247"></a><span id="l46.247">   ensureNoAutoCc(identity);</span>
<a href="#l46.248"></a><span id="l46.248" class="difflineat">@@ -382,80 +386,80 @@ function testToCcReplyWhenReplyToSet() {</span>
<a href="#l46.249"></a><span id="l46.249"> </span>
<a href="#l46.250"></a><span id="l46.250">   useAutoCc(identity, myEmail + &quot;, smithers@example.com&quot;);</span>
<a href="#l46.251"></a><span id="l46.251">   checkReply(</span>
<a href="#l46.252"></a><span id="l46.252">     open_compose_with_reply,</span>
<a href="#l46.253"></a><span id="l46.253">     // To: reply-to</span>
<a href="#l46.254"></a><span id="l46.254">     // Cc: auto-Ccs</span>
<a href="#l46.255"></a><span id="l46.255">     {</span>
<a href="#l46.256"></a><span id="l46.256">       &quot;addr_to&quot;: [&quot;marge@example.com&quot;],</span>
<a href="#l46.257"></a><span id="l46.257" class="difflineminus">-      &quot;addr_cc&quot;: [myEmail, &quot;smithers@example.com&quot;]</span>
<a href="#l46.258"></a><span id="l46.258" class="difflineplus">+      &quot;addr_cc&quot;: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l46.259"></a><span id="l46.259">     }</span>
<a href="#l46.260"></a><span id="l46.260">   );</span>
<a href="#l46.261"></a><span id="l46.261">   stopUsingAutoCc(identity);</span>
<a href="#l46.262"></a><span id="l46.262"> }</span>
<a href="#l46.263"></a><span id="l46.263"> </span>
<a href="#l46.264"></a><span id="l46.264"> /**</span>
<a href="#l46.265"></a><span id="l46.265">  * Tests that addresses get set properly when doing a reply to all for a mail</span>
<a href="#l46.266"></a><span id="l46.266">  * w/ Reply-To.</span>
<a href="#l46.267"></a><span id="l46.267">  */</span>
<a href="#l46.268"></a><span id="l46.268"> function testToCcReplyAllWhenReplyToSet() {</span>
<a href="#l46.269"></a><span id="l46.269">   let msg0 = create_message({</span>
<a href="#l46.270"></a><span id="l46.270">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l46.271"></a><span id="l46.271">     to: &quot;workers@example.com&quot;,</span>
<a href="#l46.272"></a><span id="l46.272">     cc: &quot;Lisa &lt;lisa@example.com&gt;, &quot; + myEmail,</span>
<a href="#l46.273"></a><span id="l46.273">     subject: &quot;testToCcReplyAllWhenReplyToSet - to/cc mail with reply-to set (me in Cc)&quot;,</span>
<a href="#l46.274"></a><span id="l46.274">     clobberHeaders: {</span>
<a href="#l46.275"></a><span id="l46.275" class="difflineminus">-      &quot;Reply-To&quot;: &quot;marge@example.com&quot;</span>
<a href="#l46.276"></a><span id="l46.276" class="difflineminus">-    }</span>
<a href="#l46.277"></a><span id="l46.277" class="difflineplus">+      &quot;Reply-To&quot;: &quot;marge@example.com&quot;,</span>
<a href="#l46.278"></a><span id="l46.278" class="difflineplus">+    },</span>
<a href="#l46.279"></a><span id="l46.279">   });</span>
<a href="#l46.280"></a><span id="l46.280">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.281"></a><span id="l46.281"> </span>
<a href="#l46.282"></a><span id="l46.282">   be_in_folder(folder);</span>
<a href="#l46.283"></a><span id="l46.283">   let msg = select_click_row(i++);</span>
<a href="#l46.284"></a><span id="l46.284">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.285"></a><span id="l46.285"> </span>
<a href="#l46.286"></a><span id="l46.286">   ensureNoAutoCc(identity);</span>
<a href="#l46.287"></a><span id="l46.287">   checkReply(</span>
<a href="#l46.288"></a><span id="l46.288">     open_compose_with_reply_to_all,</span>
<a href="#l46.289"></a><span id="l46.289">     // To: Reply-To + Tos</span>
<a href="#l46.290"></a><span id="l46.290">     // Cc: original Ccs without me.</span>
<a href="#l46.291"></a><span id="l46.291">     {</span>
<a href="#l46.292"></a><span id="l46.292">       &quot;addr_to&quot;: [&quot;marge@example.com&quot;,</span>
<a href="#l46.293"></a><span id="l46.293">                   &quot;workers@example.com&quot;],</span>
<a href="#l46.294"></a><span id="l46.294" class="difflineminus">-      &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;]</span>
<a href="#l46.295"></a><span id="l46.295" class="difflineplus">+      &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l46.296"></a><span id="l46.296">     }</span>
<a href="#l46.297"></a><span id="l46.297">   );</span>
<a href="#l46.298"></a><span id="l46.298"> </span>
<a href="#l46.299"></a><span id="l46.299">   useAutoCc(identity, myEmail + &quot;, smithers@example.com&quot;);</span>
<a href="#l46.300"></a><span id="l46.300">   checkReply(</span>
<a href="#l46.301"></a><span id="l46.301">     open_compose_with_reply_to_all,</span>
<a href="#l46.302"></a><span id="l46.302">     // To: Reply-To + Tos</span>
<a href="#l46.303"></a><span id="l46.303">     // Cc: original Ccs + auto-Ccs (which includes me!)</span>
<a href="#l46.304"></a><span id="l46.304">     {</span>
<a href="#l46.305"></a><span id="l46.305">       &quot;addr_to&quot;: [&quot;marge@example.com&quot;,</span>
<a href="#l46.306"></a><span id="l46.306">                   &quot;workers@example.com&quot;],</span>
<a href="#l46.307"></a><span id="l46.307" class="difflineminus">-      &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;, myEmail, &quot;smithers@example.com&quot;]</span>
<a href="#l46.308"></a><span id="l46.308" class="difflineplus">+      &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;, myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l46.309"></a><span id="l46.309">     }</span>
<a href="#l46.310"></a><span id="l46.310">   );</span>
<a href="#l46.311"></a><span id="l46.311">   stopUsingAutoCc(identity);</span>
<a href="#l46.312"></a><span id="l46.312"> }</span>
<a href="#l46.313"></a><span id="l46.313"> </span>
<a href="#l46.314"></a><span id="l46.314"> /**</span>
<a href="#l46.315"></a><span id="l46.315">  * Tests that addresses get set properly when doing a reply to list.</span>
<a href="#l46.316"></a><span id="l46.316">  */</span>
<a href="#l46.317"></a><span id="l46.317"> function testReplyToList() {</span>
<a href="#l46.318"></a><span id="l46.318">   let msg0 = create_message({</span>
<a href="#l46.319"></a><span id="l46.319">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l46.320"></a><span id="l46.320">     to: &quot;workers-list@example.com&quot;,</span>
<a href="#l46.321"></a><span id="l46.321">     cc: &quot;Lisa &lt;lisa@example.com&gt;, &quot; + myEmail,</span>
<a href="#l46.322"></a><span id="l46.322">     subject: &quot;testReplyToList - mailing list message (me in Cc)&quot;,</span>
<a href="#l46.323"></a><span id="l46.323">     clobberHeaders: {</span>
<a href="#l46.324"></a><span id="l46.324" class="difflineminus">-      &quot;List-Post&quot;: &quot;&lt;mailto:workers-list@example.com&gt;&quot;</span>
<a href="#l46.325"></a><span id="l46.325" class="difflineminus">-    }</span>
<a href="#l46.326"></a><span id="l46.326" class="difflineplus">+      &quot;List-Post&quot;: &quot;&lt;mailto:workers-list@example.com&gt;&quot;,</span>
<a href="#l46.327"></a><span id="l46.327" class="difflineplus">+    },</span>
<a href="#l46.328"></a><span id="l46.328">   });</span>
<a href="#l46.329"></a><span id="l46.329">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.330"></a><span id="l46.330"> </span>
<a href="#l46.331"></a><span id="l46.331">   be_in_folder(folder);</span>
<a href="#l46.332"></a><span id="l46.332">   let msg = select_click_row(i++);</span>
<a href="#l46.333"></a><span id="l46.333">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.334"></a><span id="l46.334"> </span>
<a href="#l46.335"></a><span id="l46.335">   ensureNoAutoCc(identity);</span>
<a href="#l46.336"></a><span id="l46.336" class="difflineat">@@ -467,35 +471,35 @@ function testReplyToList() {</span>
<a href="#l46.337"></a><span id="l46.337"> </span>
<a href="#l46.338"></a><span id="l46.338">   useAutoCc(identity, myEmail + &quot;, smithers@example.com&quot;);</span>
<a href="#l46.339"></a><span id="l46.339">   checkReply(</span>
<a href="#l46.340"></a><span id="l46.340">     open_compose_with_reply_to_list,</span>
<a href="#l46.341"></a><span id="l46.341">     // To: the list</span>
<a href="#l46.342"></a><span id="l46.342">     // Cc: auto-Ccs</span>
<a href="#l46.343"></a><span id="l46.343">     {</span>
<a href="#l46.344"></a><span id="l46.344">       &quot;addr_to&quot;: [&quot;workers-list@example.com&quot;],</span>
<a href="#l46.345"></a><span id="l46.345" class="difflineminus">-      &quot;addr_cc&quot;: [myEmail, &quot;smithers@example.com&quot;]</span>
<a href="#l46.346"></a><span id="l46.346" class="difflineplus">+      &quot;addr_cc&quot;: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l46.347"></a><span id="l46.347">     }</span>
<a href="#l46.348"></a><span id="l46.348">   );</span>
<a href="#l46.349"></a><span id="l46.349">   stopUsingAutoCc(identity);</span>
<a href="#l46.350"></a><span id="l46.350"> }</span>
<a href="#l46.351"></a><span id="l46.351"> </span>
<a href="#l46.352"></a><span id="l46.352"> /**</span>
<a href="#l46.353"></a><span id="l46.353">  * Tests that addresses get set properly when doing a reply to sender for a</span>
<a href="#l46.354"></a><span id="l46.354">  * list post.</span>
<a href="#l46.355"></a><span id="l46.355">  */</span>
<a href="#l46.356"></a><span id="l46.356"> function testReplySenderForListPost() {</span>
<a href="#l46.357"></a><span id="l46.357">   let msg0 = create_message({</span>
<a href="#l46.358"></a><span id="l46.358">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l46.359"></a><span id="l46.359">     to: &quot;workers-list@example.com&quot;,</span>
<a href="#l46.360"></a><span id="l46.360">     cc: &quot;Lisa &lt;lisa@example.com&gt;, &quot; + myEmail,</span>
<a href="#l46.361"></a><span id="l46.361">     subject: &quot;testReplySenderForListPost - mailing list message (me in Cc)&quot;,</span>
<a href="#l46.362"></a><span id="l46.362">     clobberHeaders: {</span>
<a href="#l46.363"></a><span id="l46.363" class="difflineminus">-      &quot;List-Post&quot;: &quot;&lt;mailto:workers-list@example.com&gt;&quot;</span>
<a href="#l46.364"></a><span id="l46.364" class="difflineminus">-    }</span>
<a href="#l46.365"></a><span id="l46.365" class="difflineplus">+      &quot;List-Post&quot;: &quot;&lt;mailto:workers-list@example.com&gt;&quot;,</span>
<a href="#l46.366"></a><span id="l46.366" class="difflineplus">+    },</span>
<a href="#l46.367"></a><span id="l46.367">   });</span>
<a href="#l46.368"></a><span id="l46.368">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.369"></a><span id="l46.369"> </span>
<a href="#l46.370"></a><span id="l46.370">   be_in_folder(folder);</span>
<a href="#l46.371"></a><span id="l46.371">   let msg = select_click_row(i++);</span>
<a href="#l46.372"></a><span id="l46.372">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.373"></a><span id="l46.373"> </span>
<a href="#l46.374"></a><span id="l46.374">   ensureNoAutoCc(identity);</span>
<a href="#l46.375"></a><span id="l46.375" class="difflineat">@@ -507,60 +511,60 @@ function testReplySenderForListPost() {</span>
<a href="#l46.376"></a><span id="l46.376"> </span>
<a href="#l46.377"></a><span id="l46.377">   useAutoCc(identity, myEmail + &quot;, smithers@example.com&quot;);</span>
<a href="#l46.378"></a><span id="l46.378">   checkReply(</span>
<a href="#l46.379"></a><span id="l46.379">     open_compose_with_reply,</span>
<a href="#l46.380"></a><span id="l46.380">     // To: From</span>
<a href="#l46.381"></a><span id="l46.381">     // Cc: auto-Ccs</span>
<a href="#l46.382"></a><span id="l46.382">     {</span>
<a href="#l46.383"></a><span id="l46.383">       &quot;addr_to&quot;: [&quot;Homer &lt;homer@example.com&gt;&quot;],</span>
<a href="#l46.384"></a><span id="l46.384" class="difflineminus">-      &quot;addr_cc&quot;: [myEmail, &quot;smithers@example.com&quot;]</span>
<a href="#l46.385"></a><span id="l46.385" class="difflineplus">+      &quot;addr_cc&quot;: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l46.386"></a><span id="l46.386">     }</span>
<a href="#l46.387"></a><span id="l46.387">   );</span>
<a href="#l46.388"></a><span id="l46.388">   stopUsingAutoCc(identity);</span>
<a href="#l46.389"></a><span id="l46.389"> }</span>
<a href="#l46.390"></a><span id="l46.390"> </span>
<a href="#l46.391"></a><span id="l46.391"> /**</span>
<a href="#l46.392"></a><span id="l46.392">  * Tests that addresses get set properly when doing a reply all to a list post.</span>
<a href="#l46.393"></a><span id="l46.393">  */</span>
<a href="#l46.394"></a><span id="l46.394"> function testReplyToAllForListPost() {</span>
<a href="#l46.395"></a><span id="l46.395">   let msg0 = create_message({</span>
<a href="#l46.396"></a><span id="l46.396">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l46.397"></a><span id="l46.397">     to: &quot;workers-list@example.com&quot;,</span>
<a href="#l46.398"></a><span id="l46.398">     cc: &quot;Lisa &lt;lisa@example.com&gt;, &quot; + myEmail,</span>
<a href="#l46.399"></a><span id="l46.399">     subject: &quot;testReplyToAllForListPost - mailing list message (me in Cc)&quot;,</span>
<a href="#l46.400"></a><span id="l46.400">     clobberHeaders: {</span>
<a href="#l46.401"></a><span id="l46.401" class="difflineminus">-      &quot;List-Post&quot;: &quot;&lt;mailto:workers-list@example.com&gt;&quot;</span>
<a href="#l46.402"></a><span id="l46.402" class="difflineminus">-    }</span>
<a href="#l46.403"></a><span id="l46.403" class="difflineplus">+      &quot;List-Post&quot;: &quot;&lt;mailto:workers-list@example.com&gt;&quot;,</span>
<a href="#l46.404"></a><span id="l46.404" class="difflineplus">+    },</span>
<a href="#l46.405"></a><span id="l46.405">   });</span>
<a href="#l46.406"></a><span id="l46.406">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.407"></a><span id="l46.407"> </span>
<a href="#l46.408"></a><span id="l46.408">   be_in_folder(folder);</span>
<a href="#l46.409"></a><span id="l46.409">   let msg = select_click_row(i++);</span>
<a href="#l46.410"></a><span id="l46.410">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.411"></a><span id="l46.411"> </span>
<a href="#l46.412"></a><span id="l46.412">   ensureNoAutoCc(identity);</span>
<a href="#l46.413"></a><span id="l46.413">   checkReply(</span>
<a href="#l46.414"></a><span id="l46.414">     open_compose_with_reply_to_all,</span>
<a href="#l46.415"></a><span id="l46.415">     // To: From + original To</span>
<a href="#l46.416"></a><span id="l46.416">     // Cc: original CC without me</span>
<a href="#l46.417"></a><span id="l46.417">     {</span>
<a href="#l46.418"></a><span id="l46.418">       &quot;addr_to&quot;: [&quot;Homer &lt;homer@example.com&gt;&quot;, &quot;workers-list@example.com&quot;],</span>
<a href="#l46.419"></a><span id="l46.419" class="difflineminus">-      &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;]</span>
<a href="#l46.420"></a><span id="l46.420" class="difflineplus">+      &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l46.421"></a><span id="l46.421">     }</span>
<a href="#l46.422"></a><span id="l46.422">   );</span>
<a href="#l46.423"></a><span id="l46.423"> </span>
<a href="#l46.424"></a><span id="l46.424">   useAutoCc(identity, myEmail + &quot;, smithers@example.com&quot;);</span>
<a href="#l46.425"></a><span id="l46.425">   checkReply(</span>
<a href="#l46.426"></a><span id="l46.426">     open_compose_with_reply_to_all,</span>
<a href="#l46.427"></a><span id="l46.427">     // To: From + original To</span>
<a href="#l46.428"></a><span id="l46.428">     // Cc: original CC + auto-Ccs (including me!)</span>
<a href="#l46.429"></a><span id="l46.429">     {</span>
<a href="#l46.430"></a><span id="l46.430">     &quot;addr_to&quot;: [&quot;Homer &lt;homer@example.com&gt;&quot;, &quot;workers-list@example.com&quot;],</span>
<a href="#l46.431"></a><span id="l46.431" class="difflineminus">-    &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;, myEmail, &quot;smithers@example.com&quot;]</span>
<a href="#l46.432"></a><span id="l46.432" class="difflineplus">+    &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;, myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l46.433"></a><span id="l46.433">     }</span>
<a href="#l46.434"></a><span id="l46.434">   );</span>
<a href="#l46.435"></a><span id="l46.435">   stopUsingAutoCc(identity);</span>
<a href="#l46.436"></a><span id="l46.436"> }</span>
<a href="#l46.437"></a><span id="l46.437"> </span>
<a href="#l46.438"></a><span id="l46.438"> /**</span>
<a href="#l46.439"></a><span id="l46.439">  * Tests that addresses get set properly when doing a reply to all for a list</span>
<a href="#l46.440"></a><span id="l46.440">  * post when also reply-to is set.</span>
<a href="#l46.441"></a><span id="l46.441" class="difflineat">@@ -568,44 +572,44 @@ function testReplyToAllForListPost() {</span>
<a href="#l46.442"></a><span id="l46.442"> function testReplyToListWhenReplyToSet() {</span>
<a href="#l46.443"></a><span id="l46.443">   let msg0 = create_message({</span>
<a href="#l46.444"></a><span id="l46.444">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l46.445"></a><span id="l46.445">     to: &quot;workers-list@example.com, &quot; + myEmail,</span>
<a href="#l46.446"></a><span id="l46.446">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l46.447"></a><span id="l46.447">     subject: &quot;testReplyToListWhenReplyToSet - mailing list message w/ cc, reply-to (me in To)&quot;,</span>
<a href="#l46.448"></a><span id="l46.448">     clobberHeaders: {</span>
<a href="#l46.449"></a><span id="l46.449">       &quot;Reply-To&quot;: &quot;marge@example.com&quot;,</span>
<a href="#l46.450"></a><span id="l46.450" class="difflineminus">-      &quot;List-Post&quot;: &quot;&lt;mailto:workers-list@example.com&gt;&quot;</span>
<a href="#l46.451"></a><span id="l46.451" class="difflineminus">-    }</span>
<a href="#l46.452"></a><span id="l46.452" class="difflineplus">+      &quot;List-Post&quot;: &quot;&lt;mailto:workers-list@example.com&gt;&quot;,</span>
<a href="#l46.453"></a><span id="l46.453" class="difflineplus">+    },</span>
<a href="#l46.454"></a><span id="l46.454">   });</span>
<a href="#l46.455"></a><span id="l46.455">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.456"></a><span id="l46.456"> </span>
<a href="#l46.457"></a><span id="l46.457">   be_in_folder(folder);</span>
<a href="#l46.458"></a><span id="l46.458">   let msg = select_click_row(i++);</span>
<a href="#l46.459"></a><span id="l46.459">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.460"></a><span id="l46.460"> </span>
<a href="#l46.461"></a><span id="l46.461">   ensureNoAutoCc(identity);</span>
<a href="#l46.462"></a><span id="l46.462">   checkReply(</span>
<a href="#l46.463"></a><span id="l46.463">     open_compose_with_reply_to_all,</span>
<a href="#l46.464"></a><span id="l46.464">     // To: Reply-To, original Tos</span>
<a href="#l46.465"></a><span id="l46.465">     // Cc: original Cc</span>
<a href="#l46.466"></a><span id="l46.466">     {</span>
<a href="#l46.467"></a><span id="l46.467">       &quot;addr_to&quot;: [&quot;marge@example.com&quot;, &quot;workers-list@example.com&quot;],</span>
<a href="#l46.468"></a><span id="l46.468" class="difflineminus">-      &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;]</span>
<a href="#l46.469"></a><span id="l46.469" class="difflineplus">+      &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l46.470"></a><span id="l46.470">     }</span>
<a href="#l46.471"></a><span id="l46.471">   );</span>
<a href="#l46.472"></a><span id="l46.472"> </span>
<a href="#l46.473"></a><span id="l46.473">   useAutoCc(identity, myEmail + &quot;, smithers@example.com&quot;);</span>
<a href="#l46.474"></a><span id="l46.474">   checkReply(</span>
<a href="#l46.475"></a><span id="l46.475">     open_compose_with_reply_to_all,</span>
<a href="#l46.476"></a><span id="l46.476">     // To: Reply-To, original Tos</span>
<a href="#l46.477"></a><span id="l46.477">     // Cc: original Cc + auto-Ccs</span>
<a href="#l46.478"></a><span id="l46.478">     {</span>
<a href="#l46.479"></a><span id="l46.479">       &quot;addr_to&quot;: [&quot;marge@example.com&quot;, &quot;workers-list@example.com&quot;],</span>
<a href="#l46.480"></a><span id="l46.480" class="difflineminus">-      &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;, myEmail, &quot;smithers@example.com&quot;]</span>
<a href="#l46.481"></a><span id="l46.481" class="difflineplus">+      &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;, myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l46.482"></a><span id="l46.482">     }</span>
<a href="#l46.483"></a><span id="l46.483">   );</span>
<a href="#l46.484"></a><span id="l46.484">   stopUsingAutoCc(identity);</span>
<a href="#l46.485"></a><span id="l46.485"> }</span>
<a href="#l46.486"></a><span id="l46.486"> </span>
<a href="#l46.487"></a><span id="l46.487"> /**</span>
<a href="#l46.488"></a><span id="l46.488">  * Test that addresses get set properly for Mail-Reply-To. Mail-Reply-To should</span>
<a href="#l46.489"></a><span id="l46.489">  * be used for reply to author, if present.</span>
<a href="#l46.490"></a><span id="l46.490" class="difflineat">@@ -614,18 +618,18 @@ function testReplyToListWhenReplyToSet()</span>
<a href="#l46.491"></a><span id="l46.491"> function testMailReplyTo() {</span>
<a href="#l46.492"></a><span id="l46.492">   let msg0 = create_message({</span>
<a href="#l46.493"></a><span id="l46.493">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l46.494"></a><span id="l46.494">     to: &quot;workers-list@example.com&quot;,</span>
<a href="#l46.495"></a><span id="l46.495">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l46.496"></a><span id="l46.496">     subject: &quot;testMailReplyTo - mail with Mail-Reply-To header&quot;,</span>
<a href="#l46.497"></a><span id="l46.497">     clobberHeaders: {</span>
<a href="#l46.498"></a><span id="l46.498">       &quot;Reply-To&quot;: &quot;workers-list@example.com&quot;, // reply-to munging</span>
<a href="#l46.499"></a><span id="l46.499" class="difflineminus">-      &quot;Mail-Reply-To&quot;: &quot;Homer S. &lt;homer@example.com&gt;&quot;</span>
<a href="#l46.500"></a><span id="l46.500" class="difflineminus">-    }</span>
<a href="#l46.501"></a><span id="l46.501" class="difflineplus">+      &quot;Mail-Reply-To&quot;: &quot;Homer S. &lt;homer@example.com&gt;&quot;,</span>
<a href="#l46.502"></a><span id="l46.502" class="difflineplus">+    },</span>
<a href="#l46.503"></a><span id="l46.503">   });</span>
<a href="#l46.504"></a><span id="l46.504">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.505"></a><span id="l46.505"> </span>
<a href="#l46.506"></a><span id="l46.506">   be_in_folder(folder);</span>
<a href="#l46.507"></a><span id="l46.507">   let msg = select_click_row(i++);</span>
<a href="#l46.508"></a><span id="l46.508">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.509"></a><span id="l46.509"> </span>
<a href="#l46.510"></a><span id="l46.510">   ensureNoAutoCc(identity);</span>
<a href="#l46.511"></a><span id="l46.511" class="difflineat">@@ -637,17 +641,17 @@ function testMailReplyTo() {</span>
<a href="#l46.512"></a><span id="l46.512"> </span>
<a href="#l46.513"></a><span id="l46.513">   useAutoCc(identity, myEmail + &quot;, smithers@example.com&quot;);</span>
<a href="#l46.514"></a><span id="l46.514">   checkReply(</span>
<a href="#l46.515"></a><span id="l46.515">     open_compose_with_reply,</span>
<a href="#l46.516"></a><span id="l46.516">     // To: Mail-Reply-To</span>
<a href="#l46.517"></a><span id="l46.517">     // Cc: auto-Ccs</span>
<a href="#l46.518"></a><span id="l46.518">     {</span>
<a href="#l46.519"></a><span id="l46.519">       &quot;addr_to&quot;: [&quot;Homer S. &lt;homer@example.com&gt;&quot;],</span>
<a href="#l46.520"></a><span id="l46.520" class="difflineminus">-      &quot;addr_cc&quot;: [myEmail, &quot;smithers@example.com&quot;]</span>
<a href="#l46.521"></a><span id="l46.521" class="difflineplus">+      &quot;addr_cc&quot;: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l46.522"></a><span id="l46.522">     }</span>
<a href="#l46.523"></a><span id="l46.523">   );</span>
<a href="#l46.524"></a><span id="l46.524">   stopUsingAutoCc(identity);</span>
<a href="#l46.525"></a><span id="l46.525"> }</span>
<a href="#l46.526"></a><span id="l46.526"> </span>
<a href="#l46.527"></a><span id="l46.527"> /**</span>
<a href="#l46.528"></a><span id="l46.528">  * Test that addresses get set properly Mail-Followup-To. Mail-Followup-To</span>
<a href="#l46.529"></a><span id="l46.529">  * should be the default recipient list for reply-all, if present.</span>
<a href="#l46.530"></a><span id="l46.530" class="difflineat">@@ -657,18 +661,18 @@ function testMailFollowupTo() {</span>
<a href="#l46.531"></a><span id="l46.531">   let msg0 = create_message({</span>
<a href="#l46.532"></a><span id="l46.532">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l46.533"></a><span id="l46.533">     to: &quot;workers-list@example.com, &quot; + myEmail,</span>
<a href="#l46.534"></a><span id="l46.534">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l46.535"></a><span id="l46.535">     subject: &quot;testMailFollowupTo - mail with Mail-Followup-To header&quot;,</span>
<a href="#l46.536"></a><span id="l46.536">     clobberHeaders: {</span>
<a href="#l46.537"></a><span id="l46.537">       // Homer is on the list, and don't want extra copies, so he has</span>
<a href="#l46.538"></a><span id="l46.538">       // set the Mail-Followup-To header so followups go to the list.</span>
<a href="#l46.539"></a><span id="l46.539" class="difflineminus">-      &quot;Mail-Followup-To&quot;: &quot;workers-list@example.com&quot;</span>
<a href="#l46.540"></a><span id="l46.540" class="difflineminus">-    }</span>
<a href="#l46.541"></a><span id="l46.541" class="difflineplus">+      &quot;Mail-Followup-To&quot;: &quot;workers-list@example.com&quot;,</span>
<a href="#l46.542"></a><span id="l46.542" class="difflineplus">+    },</span>
<a href="#l46.543"></a><span id="l46.543">   });</span>
<a href="#l46.544"></a><span id="l46.544">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.545"></a><span id="l46.545"> </span>
<a href="#l46.546"></a><span id="l46.546">   be_in_folder(folder);</span>
<a href="#l46.547"></a><span id="l46.547">   let msg = select_click_row(i++);</span>
<a href="#l46.548"></a><span id="l46.548">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.549"></a><span id="l46.549"> </span>
<a href="#l46.550"></a><span id="l46.550">   ensureNoAutoCc(identity);</span>
<a href="#l46.551"></a><span id="l46.551" class="difflineat">@@ -680,63 +684,63 @@ function testMailFollowupTo() {</span>
<a href="#l46.552"></a><span id="l46.552"> </span>
<a href="#l46.553"></a><span id="l46.553">   useAutoCc(identity, myEmail + &quot;, smithers@example.com&quot;);</span>
<a href="#l46.554"></a><span id="l46.554">   checkReply(</span>
<a href="#l46.555"></a><span id="l46.555">     open_compose_with_reply_to_all,</span>
<a href="#l46.556"></a><span id="l46.556">     // To: Mail-Followup-To</span>
<a href="#l46.557"></a><span id="l46.557">     // Cc: auto-Ccs</span>
<a href="#l46.558"></a><span id="l46.558">     {</span>
<a href="#l46.559"></a><span id="l46.559">       &quot;addr_to&quot;: [&quot;workers-list@example.com&quot;],</span>
<a href="#l46.560"></a><span id="l46.560" class="difflineminus">-      &quot;addr_cc&quot;: [myEmail, &quot;smithers@example.com&quot;]</span>
<a href="#l46.561"></a><span id="l46.561" class="difflineplus">+      &quot;addr_cc&quot;: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l46.562"></a><span id="l46.562">     }</span>
<a href="#l46.563"></a><span id="l46.563">   );</span>
<a href="#l46.564"></a><span id="l46.564">   stopUsingAutoCc(identity);</span>
<a href="#l46.565"></a><span id="l46.565"> }</span>
<a href="#l46.566"></a><span id="l46.566"> </span>
<a href="#l46.567"></a><span id="l46.567"> /**</span>
<a href="#l46.568"></a><span id="l46.568">  * Tests that addresses get set properly for reply to self.</span>
<a href="#l46.569"></a><span id="l46.569">  */</span>
<a href="#l46.570"></a><span id="l46.570"> function testReplyToSelfReply() {</span>
<a href="#l46.571"></a><span id="l46.571">   let msg0 = create_message({</span>
<a href="#l46.572"></a><span id="l46.572">     from: myEmail,</span>
<a href="#l46.573"></a><span id="l46.573">     to: &quot;Bart &lt;bart@example.com&gt;, Maggie &lt;maggie@example.com&gt;&quot;,</span>
<a href="#l46.574"></a><span id="l46.574">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l46.575"></a><span id="l46.575">     subject: &quot;testReplyToSelfReply - reply to self&quot;,</span>
<a href="#l46.576"></a><span id="l46.576">     clobberHeaders: {</span>
<a href="#l46.577"></a><span id="l46.577">       &quot;Bcc&quot;: &quot;Moe &lt;moe@example.com&gt;&quot;,</span>
<a href="#l46.578"></a><span id="l46.578" class="difflineminus">-      &quot;Reply-To&quot;: &quot;Flanders &lt;flanders@example.com&gt;&quot;</span>
<a href="#l46.579"></a><span id="l46.579" class="difflineminus">-    }</span>
<a href="#l46.580"></a><span id="l46.580" class="difflineplus">+      &quot;Reply-To&quot;: &quot;Flanders &lt;flanders@example.com&gt;&quot;,</span>
<a href="#l46.581"></a><span id="l46.581" class="difflineplus">+    },</span>
<a href="#l46.582"></a><span id="l46.582">   });</span>
<a href="#l46.583"></a><span id="l46.583">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.584"></a><span id="l46.584"> </span>
<a href="#l46.585"></a><span id="l46.585">   be_in_folder(folder);</span>
<a href="#l46.586"></a><span id="l46.586">   let msg = select_click_row(i++);</span>
<a href="#l46.587"></a><span id="l46.587">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.588"></a><span id="l46.588"> </span>
<a href="#l46.589"></a><span id="l46.589">   ensureNoAutoCc(identity);</span>
<a href="#l46.590"></a><span id="l46.590">   checkReply(</span>
<a href="#l46.591"></a><span id="l46.591">     open_compose_with_reply,</span>
<a href="#l46.592"></a><span id="l46.592">     // To: original To</span>
<a href="#l46.593"></a><span id="l46.593">     // Reply-To: original Reply-To</span>
<a href="#l46.594"></a><span id="l46.594">     {</span>
<a href="#l46.595"></a><span id="l46.595">       &quot;addr_to&quot;: [&quot;Bart &lt;bart@example.com&gt;&quot;, &quot;Maggie &lt;maggie@example.com&gt;&quot;],</span>
<a href="#l46.596"></a><span id="l46.596" class="difflineminus">-      &quot;addr_reply&quot;: [&quot;Flanders &lt;flanders@example.com&gt;&quot;]</span>
<a href="#l46.597"></a><span id="l46.597" class="difflineplus">+      &quot;addr_reply&quot;: [&quot;Flanders &lt;flanders@example.com&gt;&quot;],</span>
<a href="#l46.598"></a><span id="l46.598">     }</span>
<a href="#l46.599"></a><span id="l46.599">   );</span>
<a href="#l46.600"></a><span id="l46.600"> </span>
<a href="#l46.601"></a><span id="l46.601">   useAutoCc(identity, myEmail + &quot;, smithers@example.com&quot;);</span>
<a href="#l46.602"></a><span id="l46.602">   checkReply(</span>
<a href="#l46.603"></a><span id="l46.603">     open_compose_with_reply,</span>
<a href="#l46.604"></a><span id="l46.604">     // To: original To</span>
<a href="#l46.605"></a><span id="l46.605">     // Cc: auto-Ccs</span>
<a href="#l46.606"></a><span id="l46.606">     // Reply-To: original Reply-To</span>
<a href="#l46.607"></a><span id="l46.607">     {</span>
<a href="#l46.608"></a><span id="l46.608">       &quot;addr_to&quot;: [&quot;Bart &lt;bart@example.com&gt;&quot;, &quot;Maggie &lt;maggie@example.com&gt;&quot;],</span>
<a href="#l46.609"></a><span id="l46.609">       &quot;addr_cc&quot;: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l46.610"></a><span id="l46.610" class="difflineminus">-      &quot;addr_reply&quot;: [&quot;Flanders &lt;flanders@example.com&gt;&quot;]</span>
<a href="#l46.611"></a><span id="l46.611" class="difflineplus">+      &quot;addr_reply&quot;: [&quot;Flanders &lt;flanders@example.com&gt;&quot;],</span>
<a href="#l46.612"></a><span id="l46.612">     }</span>
<a href="#l46.613"></a><span id="l46.613">   );</span>
<a href="#l46.614"></a><span id="l46.614">   stopUsingAutoCc(identity);</span>
<a href="#l46.615"></a><span id="l46.615"> }</span>
<a href="#l46.616"></a><span id="l46.616"> </span>
<a href="#l46.617"></a><span id="l46.617"> /**</span>
<a href="#l46.618"></a><span id="l46.618">  * Tests that addresses get set properly for a reply all to self - this should</span>
<a href="#l46.619"></a><span id="l46.619">  * be treated as a followup.</span>
<a href="#l46.620"></a><span id="l46.620" class="difflineat">@@ -744,18 +748,18 @@ function testReplyToSelfReply() {</span>
<a href="#l46.621"></a><span id="l46.621"> function testReplyToSelfReplyAll() {</span>
<a href="#l46.622"></a><span id="l46.622">   let msg0 = create_message({</span>
<a href="#l46.623"></a><span id="l46.623">     from: myEmail,</span>
<a href="#l46.624"></a><span id="l46.624">     to: &quot;Bart &lt;bart@example.com&gt;, Maggie &lt;maggie@example.com&gt;&quot;,</span>
<a href="#l46.625"></a><span id="l46.625">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l46.626"></a><span id="l46.626">     subject: &quot;testReplyToSelfReplyAll - reply to self&quot;,</span>
<a href="#l46.627"></a><span id="l46.627">     clobberHeaders: {</span>
<a href="#l46.628"></a><span id="l46.628">       &quot;Bcc&quot;: &quot;Moe &lt;moe@example.com&gt;&quot;,</span>
<a href="#l46.629"></a><span id="l46.629" class="difflineminus">-      &quot;Reply-To&quot;: &quot;Flanders &lt;flanders@example.com&gt;&quot;</span>
<a href="#l46.630"></a><span id="l46.630" class="difflineminus">-    }</span>
<a href="#l46.631"></a><span id="l46.631" class="difflineplus">+      &quot;Reply-To&quot;: &quot;Flanders &lt;flanders@example.com&gt;&quot;,</span>
<a href="#l46.632"></a><span id="l46.632" class="difflineplus">+    },</span>
<a href="#l46.633"></a><span id="l46.633">   });</span>
<a href="#l46.634"></a><span id="l46.634">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.635"></a><span id="l46.635"> </span>
<a href="#l46.636"></a><span id="l46.636">   be_in_folder(folder);</span>
<a href="#l46.637"></a><span id="l46.637">   let msg = select_click_row(i++);</span>
<a href="#l46.638"></a><span id="l46.638">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.639"></a><span id="l46.639"> </span>
<a href="#l46.640"></a><span id="l46.640">   ensureNoAutoCc(identity);</span>
<a href="#l46.641"></a><span id="l46.641" class="difflineat">@@ -765,34 +769,34 @@ function testReplyToSelfReplyAll() {</span>
<a href="#l46.642"></a><span id="l46.642">     // Cc: original Cc</span>
<a href="#l46.643"></a><span id="l46.643">     // Bcc: original Bcc</span>
<a href="#l46.644"></a><span id="l46.644">     // Reply-To: original Reply-To</span>
<a href="#l46.645"></a><span id="l46.645">     {</span>
<a href="#l46.646"></a><span id="l46.646">       &quot;addr_to&quot;: [&quot;Bart &lt;bart@example.com&gt;&quot;,</span>
<a href="#l46.647"></a><span id="l46.647">                   &quot;Maggie &lt;maggie@example.com&gt;&quot;],</span>
<a href="#l46.648"></a><span id="l46.648">       &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l46.649"></a><span id="l46.649">       &quot;addr_bcc&quot;: [&quot;Moe &lt;moe@example.com&gt;&quot;],</span>
<a href="#l46.650"></a><span id="l46.650" class="difflineminus">-      &quot;addr_reply&quot;: [&quot;Flanders &lt;flanders@example.com&gt;&quot;]</span>
<a href="#l46.651"></a><span id="l46.651" class="difflineplus">+      &quot;addr_reply&quot;: [&quot;Flanders &lt;flanders@example.com&gt;&quot;],</span>
<a href="#l46.652"></a><span id="l46.652">     }</span>
<a href="#l46.653"></a><span id="l46.653">   );</span>
<a href="#l46.654"></a><span id="l46.654"> </span>
<a href="#l46.655"></a><span id="l46.655">   useAutoCc(identity, myEmail + &quot;, smithers@example.com&quot;);</span>
<a href="#l46.656"></a><span id="l46.656">   useAutoBcc(identity, &quot;Lisa &lt;lisa@example.com&gt;&quot;);</span>
<a href="#l46.657"></a><span id="l46.657">   checkReply(</span>
<a href="#l46.658"></a><span id="l46.658">     open_compose_with_reply_to_all,</span>
<a href="#l46.659"></a><span id="l46.659">     // To: original To</span>
<a href="#l46.660"></a><span id="l46.660">     // Cc: original Cc (auto-Ccs would have been included here already)</span>
<a href="#l46.661"></a><span id="l46.661">     // Bcc: original Bcc</span>
<a href="#l46.662"></a><span id="l46.662">     // Reply-To: original Reply-To</span>
<a href="#l46.663"></a><span id="l46.663">     {</span>
<a href="#l46.664"></a><span id="l46.664">       &quot;addr_to&quot;: [&quot;Bart &lt;bart@example.com&gt;&quot;,</span>
<a href="#l46.665"></a><span id="l46.665">                   &quot;Maggie &lt;maggie@example.com&gt;&quot;],</span>
<a href="#l46.666"></a><span id="l46.666">       &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l46.667"></a><span id="l46.667">       &quot;addr_bcc&quot;: [&quot;Moe &lt;moe@example.com&gt;&quot;],</span>
<a href="#l46.668"></a><span id="l46.668" class="difflineminus">-      &quot;addr_reply&quot;: [&quot;Flanders &lt;flanders@example.com&gt;&quot;]</span>
<a href="#l46.669"></a><span id="l46.669" class="difflineplus">+      &quot;addr_reply&quot;: [&quot;Flanders &lt;flanders@example.com&gt;&quot;],</span>
<a href="#l46.670"></a><span id="l46.670">     }</span>
<a href="#l46.671"></a><span id="l46.671">   );</span>
<a href="#l46.672"></a><span id="l46.672">   stopUsingAutoCc(identity);</span>
<a href="#l46.673"></a><span id="l46.673">   stopUsingAutoBcc(identity);</span>
<a href="#l46.674"></a><span id="l46.674"> }</span>
<a href="#l46.675"></a><span id="l46.675"> </span>
<a href="#l46.676"></a><span id="l46.676"> /**</span>
<a href="#l46.677"></a><span id="l46.677">  * Tests that addresses get set properly for a reply all to self - but for a</span>
<a href="#l46.678"></a><span id="l46.678" class="difflineat">@@ -801,18 +805,18 @@ function testReplyToSelfReplyAll() {</span>
<a href="#l46.679"></a><span id="l46.679">  */</span>
<a href="#l46.680"></a><span id="l46.680"> function testReplyToSelfNotOriginalSourceMsgReplyAll() {</span>
<a href="#l46.681"></a><span id="l46.681">   let msg0 = create_message({</span>
<a href="#l46.682"></a><span id="l46.682">     from: myEmail2,</span>
<a href="#l46.683"></a><span id="l46.683">     to: &quot;Bart &lt;bart@example.com&gt;, Maggie &lt;maggie@example.com&gt;&quot;,</span>
<a href="#l46.684"></a><span id="l46.684">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l46.685"></a><span id="l46.685">     subject: &quot;testReplyToSelfNotOriginalSourceMsgReplyAll - reply to self&quot;,</span>
<a href="#l46.686"></a><span id="l46.686">     clobberHeaders: {</span>
<a href="#l46.687"></a><span id="l46.687" class="difflineminus">-      &quot;Reply-To&quot;: &quot;Flanders &lt;flanders@example.com&gt;&quot;</span>
<a href="#l46.688"></a><span id="l46.688" class="difflineminus">-    }</span>
<a href="#l46.689"></a><span id="l46.689" class="difflineplus">+      &quot;Reply-To&quot;: &quot;Flanders &lt;flanders@example.com&gt;&quot;,</span>
<a href="#l46.690"></a><span id="l46.690" class="difflineplus">+    },</span>
<a href="#l46.691"></a><span id="l46.691">   });</span>
<a href="#l46.692"></a><span id="l46.692">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.693"></a><span id="l46.693"> </span>
<a href="#l46.694"></a><span id="l46.694">   be_in_folder(folder);</span>
<a href="#l46.695"></a><span id="l46.695">   let msg = select_click_row(i++);</span>
<a href="#l46.696"></a><span id="l46.696">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.697"></a><span id="l46.697"> </span>
<a href="#l46.698"></a><span id="l46.698">   ensureNoAutoCc(identity2);</span>
<a href="#l46.699"></a><span id="l46.699" class="difflineat">@@ -823,17 +827,17 @@ function testReplyToSelfNotOriginalSourc</span>
<a href="#l46.700"></a><span id="l46.700">     // Cc: original Cc</span>
<a href="#l46.701"></a><span id="l46.701">     // Bcc: auto-bccs</span>
<a href="#l46.702"></a><span id="l46.702">     // Reply-To: original Reply-To</span>
<a href="#l46.703"></a><span id="l46.703">     {</span>
<a href="#l46.704"></a><span id="l46.704">       &quot;addr_to&quot;: [&quot;Bart &lt;bart@example.com&gt;&quot;,</span>
<a href="#l46.705"></a><span id="l46.705">                   &quot;Maggie &lt;maggie@example.com&gt;&quot;],</span>
<a href="#l46.706"></a><span id="l46.706">       &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l46.707"></a><span id="l46.707">       &quot;addr_bcc&quot;: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l46.708"></a><span id="l46.708" class="difflineminus">-      &quot;addr_reply&quot;: [&quot;Flanders &lt;flanders@example.com&gt;&quot;]</span>
<a href="#l46.709"></a><span id="l46.709" class="difflineplus">+      &quot;addr_reply&quot;: [&quot;Flanders &lt;flanders@example.com&gt;&quot;],</span>
<a href="#l46.710"></a><span id="l46.710">     }</span>
<a href="#l46.711"></a><span id="l46.711">   );</span>
<a href="#l46.712"></a><span id="l46.712">   stopUsingAutoBcc(identity2);</span>
<a href="#l46.713"></a><span id="l46.713"> </span>
<a href="#l46.714"></a><span id="l46.714">   useAutoCc(identity2, myEmail + &quot;, smithers@example.com&quot;);</span>
<a href="#l46.715"></a><span id="l46.715">   useAutoBcc(identity2, &quot;moe@example.com,bart@example.com,lisa@example.com&quot;);</span>
<a href="#l46.716"></a><span id="l46.716">   checkReply(</span>
<a href="#l46.717"></a><span id="l46.717">     open_compose_with_reply_to_all,</span>
<a href="#l46.718"></a><span id="l46.718" class="difflineat">@@ -841,17 +845,17 @@ function testReplyToSelfNotOriginalSourc</span>
<a href="#l46.719"></a><span id="l46.719">     // Cc: original Cc (auto-Ccs would have been included here already)</span>
<a href="#l46.720"></a><span id="l46.720">     // Bcc: auto-bcc minus addresses already in To/Cc</span>
<a href="#l46.721"></a><span id="l46.721">     // Reply-To: original Reply-To</span>
<a href="#l46.722"></a><span id="l46.722">     {</span>
<a href="#l46.723"></a><span id="l46.723">       &quot;addr_to&quot;: [&quot;Bart &lt;bart@example.com&gt;&quot;,</span>
<a href="#l46.724"></a><span id="l46.724">                   &quot;Maggie &lt;maggie@example.com&gt;&quot;],</span>
<a href="#l46.725"></a><span id="l46.725">       &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;, myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l46.726"></a><span id="l46.726">       &quot;addr_bcc&quot;: [&quot;moe@example.com&quot;],</span>
<a href="#l46.727"></a><span id="l46.727" class="difflineminus">-      &quot;addr_reply&quot;: [&quot;Flanders &lt;flanders@example.com&gt;&quot;]</span>
<a href="#l46.728"></a><span id="l46.728" class="difflineplus">+      &quot;addr_reply&quot;: [&quot;Flanders &lt;flanders@example.com&gt;&quot;],</span>
<a href="#l46.729"></a><span id="l46.729">     }</span>
<a href="#l46.730"></a><span id="l46.730">   );</span>
<a href="#l46.731"></a><span id="l46.731">   stopUsingAutoCc(identity2);</span>
<a href="#l46.732"></a><span id="l46.732">   stopUsingAutoBcc(identity2);</span>
<a href="#l46.733"></a><span id="l46.733"> </span>
<a href="#l46.734"></a><span id="l46.734">   useAutoBcc(identity2, myEmail2 + &quot;, smithers@example.com&quot;);</span>
<a href="#l46.735"></a><span id="l46.735">   checkReply(</span>
<a href="#l46.736"></a><span id="l46.736">     open_compose_with_reply_to_all,</span>
<a href="#l46.737"></a><span id="l46.737" class="difflineat">@@ -859,70 +863,70 @@ function testReplyToSelfNotOriginalSourc</span>
<a href="#l46.738"></a><span id="l46.738">     // Cc: original Cc (auto-Ccs would have been included here already)</span>
<a href="#l46.739"></a><span id="l46.739">     // Bcc: auto-bccs</span>
<a href="#l46.740"></a><span id="l46.740">     // Reply-To: original Reply-To</span>
<a href="#l46.741"></a><span id="l46.741">     {</span>
<a href="#l46.742"></a><span id="l46.742">       &quot;addr_to&quot;: [&quot;Bart &lt;bart@example.com&gt;&quot;,</span>
<a href="#l46.743"></a><span id="l46.743">                   &quot;Maggie &lt;maggie@example.com&gt;&quot;],</span>
<a href="#l46.744"></a><span id="l46.744">       &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l46.745"></a><span id="l46.745">       &quot;addr_bcc&quot;: [myEmail2, &quot;smithers@example.com&quot;],</span>
<a href="#l46.746"></a><span id="l46.746" class="difflineminus">-      &quot;addr_reply&quot;: [&quot;Flanders &lt;flanders@example.com&gt;&quot;]</span>
<a href="#l46.747"></a><span id="l46.747" class="difflineplus">+      &quot;addr_reply&quot;: [&quot;Flanders &lt;flanders@example.com&gt;&quot;],</span>
<a href="#l46.748"></a><span id="l46.748">     }</span>
<a href="#l46.749"></a><span id="l46.749">   );</span>
<a href="#l46.750"></a><span id="l46.750">   stopUsingAutoBcc(identity2);</span>
<a href="#l46.751"></a><span id="l46.751"> }</span>
<a href="#l46.752"></a><span id="l46.752"> </span>
<a href="#l46.753"></a><span id="l46.753"> /**</span>
<a href="#l46.754"></a><span id="l46.754">  * Tests that a reply to an other identity isn't treated as a reply to self</span>
<a href="#l46.755"></a><span id="l46.755">  * followup.</span>
<a href="#l46.756"></a><span id="l46.756">  */</span>
<a href="#l46.757"></a><span id="l46.757"> function testReplyToOtherIdentity() {</span>
<a href="#l46.758"></a><span id="l46.758">   let msg0 = create_message({</span>
<a href="#l46.759"></a><span id="l46.759">     from: myEmail,</span>
<a href="#l46.760"></a><span id="l46.760">     to: myEmail2 + &quot;, barney@example.com&quot;,</span>
<a href="#l46.761"></a><span id="l46.761">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l46.762"></a><span id="l46.762">     subject: &quot;testReplyToOtherIdentity - reply to other identity&quot;,</span>
<a href="#l46.763"></a><span id="l46.763">     clobberHeaders: {</span>
<a href="#l46.764"></a><span id="l46.764" class="difflineminus">-      &quot;Reply-To&quot;: &quot;secretary@example.com&quot;</span>
<a href="#l46.765"></a><span id="l46.765" class="difflineminus">-    }</span>
<a href="#l46.766"></a><span id="l46.766" class="difflineplus">+      &quot;Reply-To&quot;: &quot;secretary@example.com&quot;,</span>
<a href="#l46.767"></a><span id="l46.767" class="difflineplus">+    },</span>
<a href="#l46.768"></a><span id="l46.768">   });</span>
<a href="#l46.769"></a><span id="l46.769">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.770"></a><span id="l46.770"> </span>
<a href="#l46.771"></a><span id="l46.771">   be_in_folder(folder);</span>
<a href="#l46.772"></a><span id="l46.772">   let msg = select_click_row(i++);</span>
<a href="#l46.773"></a><span id="l46.773">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.774"></a><span id="l46.774"> </span>
<a href="#l46.775"></a><span id="l46.775">   ensureNoAutoCc(identity2);</span>
<a href="#l46.776"></a><span id="l46.776">   ensureNoAutoBcc(identity2);</span>
<a href="#l46.777"></a><span id="l46.777">   checkReply(</span>
<a href="#l46.778"></a><span id="l46.778">     open_compose_with_reply_to_all,</span>
<a href="#l46.779"></a><span id="l46.779">     // To: from + to (except me2)</span>
<a href="#l46.780"></a><span id="l46.780">     // Cc: original Cc</span>
<a href="#l46.781"></a><span id="l46.781">     //</span>
<a href="#l46.782"></a><span id="l46.782">     {</span>
<a href="#l46.783"></a><span id="l46.783">       &quot;addr_to&quot;: [&quot;secretary@example.com&quot;, &quot;barney@example.com&quot;],</span>
<a href="#l46.784"></a><span id="l46.784" class="difflineminus">-      &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;]</span>
<a href="#l46.785"></a><span id="l46.785" class="difflineplus">+      &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l46.786"></a><span id="l46.786">     }</span>
<a href="#l46.787"></a><span id="l46.787">   );</span>
<a href="#l46.788"></a><span id="l46.788"> }</span>
<a href="#l46.789"></a><span id="l46.789"> </span>
<a href="#l46.790"></a><span id="l46.790"> /**</span>
<a href="#l46.791"></a><span id="l46.791">  * Tests that addresses get set properly for a reply all to self w/ bccs -</span>
<a href="#l46.792"></a><span id="l46.792">  * this should be treated as a followup.</span>
<a href="#l46.793"></a><span id="l46.793">  */</span>
<a href="#l46.794"></a><span id="l46.794"> function testReplyToSelfWithBccs() {</span>
<a href="#l46.795"></a><span id="l46.795">   let msg0 = create_message({</span>
<a href="#l46.796"></a><span id="l46.796">     from: myEmail,</span>
<a href="#l46.797"></a><span id="l46.797">     to: myEmail,</span>
<a href="#l46.798"></a><span id="l46.798">     cc: myEmail2 + &quot;, Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l46.799"></a><span id="l46.799">     subject: &quot;testReplyToSelfWithBccs - reply to self&quot;,</span>
<a href="#l46.800"></a><span id="l46.800">     clobberHeaders: {</span>
<a href="#l46.801"></a><span id="l46.801">       &quot;Bcc&quot;: &quot;Moe &lt;moe@example.com&gt;, Barney &lt;barney@example.com&gt;&quot;,</span>
<a href="#l46.802"></a><span id="l46.802" class="difflineminus">-      &quot;Reply-To&quot;: myEmail2</span>
<a href="#l46.803"></a><span id="l46.803" class="difflineminus">-    }</span>
<a href="#l46.804"></a><span id="l46.804" class="difflineplus">+      &quot;Reply-To&quot;: myEmail2,</span>
<a href="#l46.805"></a><span id="l46.805" class="difflineplus">+    },</span>
<a href="#l46.806"></a><span id="l46.806">   });</span>
<a href="#l46.807"></a><span id="l46.807">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.808"></a><span id="l46.808"> </span>
<a href="#l46.809"></a><span id="l46.809">   be_in_folder(folder);</span>
<a href="#l46.810"></a><span id="l46.810">   let msg = select_click_row(i++);</span>
<a href="#l46.811"></a><span id="l46.811">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.812"></a><span id="l46.812"> </span>
<a href="#l46.813"></a><span id="l46.813">   ensureNoAutoCc(identity);</span>
<a href="#l46.814"></a><span id="l46.814" class="difflineat">@@ -931,154 +935,154 @@ function testReplyToSelfWithBccs() {</span>
<a href="#l46.815"></a><span id="l46.815">     // To: original To</span>
<a href="#l46.816"></a><span id="l46.816">     // Cc: original Cc</span>
<a href="#l46.817"></a><span id="l46.817">     // Bcc: original Bcc</span>
<a href="#l46.818"></a><span id="l46.818">     // Reply-To: original Reply-To</span>
<a href="#l46.819"></a><span id="l46.819">     {</span>
<a href="#l46.820"></a><span id="l46.820">       &quot;addr_to&quot;: [myEmail],</span>
<a href="#l46.821"></a><span id="l46.821">       &quot;addr_cc&quot;: [myEmail2, &quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l46.822"></a><span id="l46.822">       &quot;addr_bcc&quot;: [&quot;Moe &lt;moe@example.com&gt;&quot;, &quot;Barney &lt;barney@example.com&gt;&quot;],</span>
<a href="#l46.823"></a><span id="l46.823" class="difflineminus">-      &quot;addr_reply&quot;: [myEmail2]</span>
<a href="#l46.824"></a><span id="l46.824" class="difflineplus">+      &quot;addr_reply&quot;: [myEmail2],</span>
<a href="#l46.825"></a><span id="l46.825">     }</span>
<a href="#l46.826"></a><span id="l46.826">   );</span>
<a href="#l46.827"></a><span id="l46.827"> }</span>
<a href="#l46.828"></a><span id="l46.828"> </span>
<a href="#l46.829"></a><span id="l46.829"> /**</span>
<a href="#l46.830"></a><span id="l46.830">  * Tests that addresses get set properly for a reply all to other identity w/ bccs -</span>
<a href="#l46.831"></a><span id="l46.831">  * this be treated as a followup.</span>
<a href="#l46.832"></a><span id="l46.832">  */</span>
<a href="#l46.833"></a><span id="l46.833"> function testReplyToOtherIdentityWithBccs() {</span>
<a href="#l46.834"></a><span id="l46.834">   let msg0 = create_message({</span>
<a href="#l46.835"></a><span id="l46.835">     from: myEmail,</span>
<a href="#l46.836"></a><span id="l46.836">     to: myEmail2,</span>
<a href="#l46.837"></a><span id="l46.837">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l46.838"></a><span id="l46.838">     subject: &quot;testReplyToOtherIdentityWithBccs - reply to other identity&quot;,</span>
<a href="#l46.839"></a><span id="l46.839">     clobberHeaders: {</span>
<a href="#l46.840"></a><span id="l46.840" class="difflineminus">-      &quot;Bcc&quot;: &quot;Moe &lt;moe@example.com&gt;, Barney &lt;barney@example.com&gt;&quot;</span>
<a href="#l46.841"></a><span id="l46.841" class="difflineminus">-    }</span>
<a href="#l46.842"></a><span id="l46.842" class="difflineplus">+      &quot;Bcc&quot;: &quot;Moe &lt;moe@example.com&gt;, Barney &lt;barney@example.com&gt;&quot;,</span>
<a href="#l46.843"></a><span id="l46.843" class="difflineplus">+    },</span>
<a href="#l46.844"></a><span id="l46.844">   });</span>
<a href="#l46.845"></a><span id="l46.845">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.846"></a><span id="l46.846"> </span>
<a href="#l46.847"></a><span id="l46.847">   be_in_folder(folder);</span>
<a href="#l46.848"></a><span id="l46.848">   let msg = select_click_row(i++);</span>
<a href="#l46.849"></a><span id="l46.849">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.850"></a><span id="l46.850"> </span>
<a href="#l46.851"></a><span id="l46.851">   ensureNoAutoCc(identity);</span>
<a href="#l46.852"></a><span id="l46.852">   checkReply(</span>
<a href="#l46.853"></a><span id="l46.853">     open_compose_with_reply_to_all,</span>
<a href="#l46.854"></a><span id="l46.854">     // To: original To</span>
<a href="#l46.855"></a><span id="l46.855">     // Cc: original Cc</span>
<a href="#l46.856"></a><span id="l46.856">     // Bcc: original Bcc</span>
<a href="#l46.857"></a><span id="l46.857">     {</span>
<a href="#l46.858"></a><span id="l46.858">       &quot;addr_to&quot;: [myEmail2],</span>
<a href="#l46.859"></a><span id="l46.859">       &quot;addr_cc&quot;: [&quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l46.860"></a><span id="l46.860" class="difflineminus">-      &quot;addr_bcc&quot;: [&quot;Moe &lt;moe@example.com&gt;&quot;, &quot;Barney &lt;barney@example.com&gt;&quot;]</span>
<a href="#l46.861"></a><span id="l46.861" class="difflineplus">+      &quot;addr_bcc&quot;: [&quot;Moe &lt;moe@example.com&gt;&quot;, &quot;Barney &lt;barney@example.com&gt;&quot;],</span>
<a href="#l46.862"></a><span id="l46.862">     }</span>
<a href="#l46.863"></a><span id="l46.863">   );</span>
<a href="#l46.864"></a><span id="l46.864"> }</span>
<a href="#l46.865"></a><span id="l46.865"> </span>
<a href="#l46.866"></a><span id="l46.866"> /**</span>
<a href="#l46.867"></a><span id="l46.867">  * Tests that addresses get set properly for a nntp reply-all.</span>
<a href="#l46.868"></a><span id="l46.868">  */</span>
<a href="#l46.869"></a><span id="l46.869"> function testNewsgroupsReplyAll() {</span>
<a href="#l46.870"></a><span id="l46.870">   let msg0 = create_message({</span>
<a href="#l46.871"></a><span id="l46.871">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l46.872"></a><span id="l46.872">     to: &quot;test1-list@example.org&quot;,</span>
<a href="#l46.873"></a><span id="l46.873">     subject: &quot;testNewsgroupsReplyAll - sent to two newsgroups and a list&quot;,</span>
<a href="#l46.874"></a><span id="l46.874">     clobberHeaders: {</span>
<a href="#l46.875"></a><span id="l46.875" class="difflineminus">-      &quot;Newsgroups&quot;: &quot;example.test1, example.test2&quot;</span>
<a href="#l46.876"></a><span id="l46.876" class="difflineminus">-    }</span>
<a href="#l46.877"></a><span id="l46.877" class="difflineplus">+      &quot;Newsgroups&quot;: &quot;example.test1, example.test2&quot;,</span>
<a href="#l46.878"></a><span id="l46.878" class="difflineplus">+    },</span>
<a href="#l46.879"></a><span id="l46.879">   });</span>
<a href="#l46.880"></a><span id="l46.880">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.881"></a><span id="l46.881"> </span>
<a href="#l46.882"></a><span id="l46.882">   be_in_folder(folder);</span>
<a href="#l46.883"></a><span id="l46.883">   let msg = select_click_row(i++);</span>
<a href="#l46.884"></a><span id="l46.884">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.885"></a><span id="l46.885"> </span>
<a href="#l46.886"></a><span id="l46.886">   ensureNoAutoCc(identity);</span>
<a href="#l46.887"></a><span id="l46.887">   checkReply(</span>
<a href="#l46.888"></a><span id="l46.888">      open_compose_with_reply_to_all,</span>
<a href="#l46.889"></a><span id="l46.889">     // To: From, original To</span>
<a href="#l46.890"></a><span id="l46.890">     // Newsgroups: original Ccs</span>
<a href="#l46.891"></a><span id="l46.891">     {</span>
<a href="#l46.892"></a><span id="l46.892">       &quot;addr_to&quot;: [&quot;Homer &lt;homer@example.com&gt;&quot;, &quot;test1-list@example.org&quot;],</span>
<a href="#l46.893"></a><span id="l46.893" class="difflineminus">-      &quot;addr_newsgroups&quot;: [&quot;example.test1&quot;, &quot;example.test2&quot;]</span>
<a href="#l46.894"></a><span id="l46.894" class="difflineplus">+      &quot;addr_newsgroups&quot;: [&quot;example.test1&quot;, &quot;example.test2&quot;],</span>
<a href="#l46.895"></a><span id="l46.895">     }</span>
<a href="#l46.896"></a><span id="l46.896">   );</span>
<a href="#l46.897"></a><span id="l46.897"> </span>
<a href="#l46.898"></a><span id="l46.898">   useAutoCc(identity, myEmail + &quot;, smithers@example.com&quot;);</span>
<a href="#l46.899"></a><span id="l46.899">   checkReply(</span>
<a href="#l46.900"></a><span id="l46.900">      open_compose_with_reply_to_all,</span>
<a href="#l46.901"></a><span id="l46.901">     // To: From, original To</span>
<a href="#l46.902"></a><span id="l46.902">     // Newsgroups: original Ccs</span>
<a href="#l46.903"></a><span id="l46.903">     {</span>
<a href="#l46.904"></a><span id="l46.904">       &quot;addr_to&quot;: [&quot;Homer &lt;homer@example.com&gt;&quot;, &quot;test1-list@example.org&quot;],</span>
<a href="#l46.905"></a><span id="l46.905">       &quot;addr_cc&quot;: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l46.906"></a><span id="l46.906" class="difflineminus">-      &quot;addr_newsgroups&quot;: [&quot;example.test1&quot;, &quot;example.test2&quot;]</span>
<a href="#l46.907"></a><span id="l46.907" class="difflineplus">+      &quot;addr_newsgroups&quot;: [&quot;example.test1&quot;, &quot;example.test2&quot;],</span>
<a href="#l46.908"></a><span id="l46.908">     }</span>
<a href="#l46.909"></a><span id="l46.909">   );</span>
<a href="#l46.910"></a><span id="l46.910">   stopUsingAutoCc(identity);</span>
<a href="#l46.911"></a><span id="l46.911"> }</span>
<a href="#l46.912"></a><span id="l46.912"> </span>
<a href="#l46.913"></a><span id="l46.913"> /**</span>
<a href="#l46.914"></a><span id="l46.914">  * Tests that addresses get set properly for an nntp followup, when Followup-To</span>
<a href="#l46.915"></a><span id="l46.915">  * is set.</span>
<a href="#l46.916"></a><span id="l46.916">  */</span>
<a href="#l46.917"></a><span id="l46.917"> function testNewsgroupsReplyAllFollowupTo() {</span>
<a href="#l46.918"></a><span id="l46.918">   let msg0 = create_message({</span>
<a href="#l46.919"></a><span id="l46.919">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l46.920"></a><span id="l46.920">     to: &quot;test1-list@example.org, &quot; + myEmail,</span>
<a href="#l46.921"></a><span id="l46.921">     subject: &quot;testNewsgroupsReplyAllFollowupTo - Followup-To set&quot;,</span>
<a href="#l46.922"></a><span id="l46.922">     clobberHeaders: {</span>
<a href="#l46.923"></a><span id="l46.923">       &quot;Newsgroups&quot;: &quot;example.test1, example.test2&quot;,</span>
<a href="#l46.924"></a><span id="l46.924" class="difflineminus">-      &quot;Followup-To&quot;: &quot;example.test2&quot;</span>
<a href="#l46.925"></a><span id="l46.925" class="difflineminus">-    }</span>
<a href="#l46.926"></a><span id="l46.926" class="difflineplus">+      &quot;Followup-To&quot;: &quot;example.test2&quot;,</span>
<a href="#l46.927"></a><span id="l46.927" class="difflineplus">+    },</span>
<a href="#l46.928"></a><span id="l46.928">   });</span>
<a href="#l46.929"></a><span id="l46.929">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.930"></a><span id="l46.930"> </span>
<a href="#l46.931"></a><span id="l46.931">   be_in_folder(folder);</span>
<a href="#l46.932"></a><span id="l46.932">   let msg = select_click_row(i++);</span>
<a href="#l46.933"></a><span id="l46.933">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.934"></a><span id="l46.934"> </span>
<a href="#l46.935"></a><span id="l46.935">   ensureNoAutoCc(identity);</span>
<a href="#l46.936"></a><span id="l46.936">   checkReply(</span>
<a href="#l46.937"></a><span id="l46.937">     open_compose_with_reply_to_all,</span>
<a href="#l46.938"></a><span id="l46.938">     // To: From + original To (except me)</span>
<a href="#l46.939"></a><span id="l46.939">     // Newsgroups: &lt;Followup-To&gt;</span>
<a href="#l46.940"></a><span id="l46.940">     {</span>
<a href="#l46.941"></a><span id="l46.941">       &quot;addr_to&quot;: [&quot;Homer &lt;homer@example.com&gt;&quot;, &quot;test1-list@example.org&quot;],</span>
<a href="#l46.942"></a><span id="l46.942" class="difflineminus">-      &quot;addr_newsgroups&quot;: [&quot;example.test2&quot;]</span>
<a href="#l46.943"></a><span id="l46.943" class="difflineplus">+      &quot;addr_newsgroups&quot;: [&quot;example.test2&quot;],</span>
<a href="#l46.944"></a><span id="l46.944">     }</span>
<a href="#l46.945"></a><span id="l46.945">   );</span>
<a href="#l46.946"></a><span id="l46.946"> </span>
<a href="#l46.947"></a><span id="l46.947">   useAutoCc(identity, myEmail + &quot;, smithers@example.com&quot;);</span>
<a href="#l46.948"></a><span id="l46.948">   checkReply(</span>
<a href="#l46.949"></a><span id="l46.949">     open_compose_with_reply_to_all,</span>
<a href="#l46.950"></a><span id="l46.950">     // To: From + original To (except me)</span>
<a href="#l46.951"></a><span id="l46.951">     // Cc: auto-Ccs</span>
<a href="#l46.952"></a><span id="l46.952">     // Newsgroups: &lt;Followup-To&gt;</span>
<a href="#l46.953"></a><span id="l46.953">     {</span>
<a href="#l46.954"></a><span id="l46.954">       &quot;addr_to&quot;: [&quot;Homer &lt;homer@example.com&gt;&quot;, &quot;test1-list@example.org&quot;],</span>
<a href="#l46.955"></a><span id="l46.955">       &quot;addr_cc&quot;: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l46.956"></a><span id="l46.956" class="difflineminus">-      &quot;addr_newsgroups&quot;: [&quot;example.test2&quot;]</span>
<a href="#l46.957"></a><span id="l46.957" class="difflineplus">+      &quot;addr_newsgroups&quot;: [&quot;example.test2&quot;],</span>
<a href="#l46.958"></a><span id="l46.958">     }</span>
<a href="#l46.959"></a><span id="l46.959">   );</span>
<a href="#l46.960"></a><span id="l46.960">   stopUsingAutoCc(identity);</span>
<a href="#l46.961"></a><span id="l46.961"> }</span>
<a href="#l46.962"></a><span id="l46.962"> </span>
<a href="#l46.963"></a><span id="l46.963"> /**</span>
<a href="#l46.964"></a><span id="l46.964">  * Tests that addresses get set properly when doing a reply where To=From</span>
<a href="#l46.965"></a><span id="l46.965">  * and a Reply-To exists.</span>
<a href="#l46.966"></a><span id="l46.966">  */</span>
<a href="#l46.967"></a><span id="l46.967"> function testToFromWithReplyTo() {</span>
<a href="#l46.968"></a><span id="l46.968">   let msg0 = create_message({</span>
<a href="#l46.969"></a><span id="l46.969">     from: myEmail,</span>
<a href="#l46.970"></a><span id="l46.970">     to: myEmail,</span>
<a href="#l46.971"></a><span id="l46.971">     subject: &quot;testToFromWithReplyTo - To=From w/ Reply-To set&quot;,</span>
<a href="#l46.972"></a><span id="l46.972" class="difflineminus">-    clobberHeaders: { &quot;Reply-To&quot;: &quot;Flanders &lt;flanders@example.com&gt;&quot; }</span>
<a href="#l46.973"></a><span id="l46.973" class="difflineplus">+    clobberHeaders: { &quot;Reply-To&quot;: &quot;Flanders &lt;flanders@example.com&gt;&quot; },</span>
<a href="#l46.974"></a><span id="l46.974">   });</span>
<a href="#l46.975"></a><span id="l46.975">   add_message_to_folder(folder, msg0);</span>
<a href="#l46.976"></a><span id="l46.976"> </span>
<a href="#l46.977"></a><span id="l46.977">   be_in_folder(folder);</span>
<a href="#l46.978"></a><span id="l46.978">   let msg = select_click_row(i++);</span>
<a href="#l46.979"></a><span id="l46.979">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l46.980"></a><span id="l46.980"> </span>
<a href="#l46.981"></a><span id="l46.981">   ensureNoAutoCc(identity);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-reply-format-flowed.js</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-reply-format-flowed.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -1,22 +1,23 @@</span>
<a href="#l47.4"></a><span id="l47.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l47.5"></a><span id="l47.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l47.6"></a><span id="l47.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l47.7"></a><span id="l47.7"> </span>
<a href="#l47.8"></a><span id="l47.8"> /**</span>
<a href="#l47.9"></a><span id="l47.9">  * Tests that the reply to a format=flowed message is also flowed.</span>
<a href="#l47.10"></a><span id="l47.10">  */</span>
<a href="#l47.11"></a><span id="l47.11"> </span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-// make SOLO_TEST=composition/test-reply-format-flowed.js mozmill-one</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineminus">-</span>
<a href="#l47.14"></a><span id="l47.14"> &quot;use strict&quot;;</span>
<a href="#l47.15"></a><span id="l47.15"> </span>
<a href="#l47.16"></a><span id="l47.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l47.17"></a><span id="l47.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l47.18"></a><span id="l47.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l47.19"></a><span id="l47.19" class="difflineplus">+</span>
<a href="#l47.20"></a><span id="l47.20"> var MODULE_NAME = &quot;test-reply-format-flowed&quot;;</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineminus">-</span>
<a href="#l47.22"></a><span id="l47.22"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l47.23"></a><span id="l47.23"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l47.24"></a><span id="l47.24"> </span>
<a href="#l47.25"></a><span id="l47.25"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l47.26"></a><span id="l47.26"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l47.27"></a><span id="l47.27"> </span>
<a href="#l47.28"></a><span id="l47.28"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l47.29"></a><span id="l47.29"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-reply-multipart-charset.js</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-reply-multipart-charset.js</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -15,22 +15,23 @@</span>
<a href="#l48.4"></a><span id="l48.4">  *</span>
<a href="#l48.5"></a><span id="l48.5">  * Bug 1323377:</span>
<a href="#l48.6"></a><span id="l48.6">  * Tests that the correct charset is used, even if the message</span>
<a href="#l48.7"></a><span id="l48.7">  * wasn't viewed before answering/forwarding.</span>
<a href="#l48.8"></a><span id="l48.8">  * For good measure some tests are included for charset overriding</span>
<a href="#l48.9"></a><span id="l48.9">  * and enforcing the charset default.</span>
<a href="#l48.10"></a><span id="l48.10">  */</span>
<a href="#l48.11"></a><span id="l48.11"> </span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-// make SOLO_TEST=composition/test-reply-multipart-charset.js mozmill-one</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineminus">-</span>
<a href="#l48.14"></a><span id="l48.14"> &quot;use strict&quot;;</span>
<a href="#l48.15"></a><span id="l48.15"> </span>
<a href="#l48.16"></a><span id="l48.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l48.17"></a><span id="l48.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l48.19"></a><span id="l48.19" class="difflineplus">+</span>
<a href="#l48.20"></a><span id="l48.20"> var MODULE_NAME = &quot;test-reply-multipart-charset&quot;;</span>
<a href="#l48.21"></a><span id="l48.21" class="difflineminus">-</span>
<a href="#l48.22"></a><span id="l48.22"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l48.23"></a><span id="l48.23"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l48.24"></a><span id="l48.24"> </span>
<a href="#l48.25"></a><span id="l48.25"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l48.26"></a><span id="l48.26"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l48.27"></a><span id="l48.27"> </span>
<a href="#l48.28"></a><span id="l48.28"> var folderToStoreMessages;</span>
<a href="#l48.29"></a><span id="l48.29"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-reply-signature.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-reply-signature.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -1,25 +1,31 @@</span>
<a href="#l49.4"></a><span id="l49.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l49.5"></a><span id="l49.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l49.6"></a><span id="l49.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l49.7"></a><span id="l49.7"> </span>
<a href="#l49.8"></a><span id="l49.8"> /**</span>
<a href="#l49.9"></a><span id="l49.9">  * Tests the mail.strip_sig_on_reply pref.</span>
<a href="#l49.10"></a><span id="l49.10">  */</span>
<a href="#l49.11"></a><span id="l49.11"> </span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-// make SOLO_TEST=composition/test-reply-signature.js mozmill-one</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l49.14"></a><span id="l49.14"> </span>
<a href="#l49.15"></a><span id="l49.15" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l49.18"></a><span id="l49.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-message-helpers.js */</span>
<a href="#l49.19"></a><span id="l49.19" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l49.20"></a><span id="l49.20"> </span>
<a href="#l49.21"></a><span id="l49.21"> var MODULE_NAME = &quot;test-reply-signature&quot;;</span>
<a href="#l49.22"></a><span id="l49.22" class="difflineminus">-</span>
<a href="#l49.23"></a><span id="l49.23"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l49.24"></a><span id="l49.24" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l49.25"></a><span id="l49.25" class="difflineminus">-                         &quot;message-helpers&quot;];</span>
<a href="#l49.26"></a><span id="l49.26" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l49.27"></a><span id="l49.27" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l49.28"></a><span id="l49.28" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l49.29"></a><span id="l49.29" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l49.30"></a><span id="l49.30" class="difflineplus">+  &quot;message-helpers&quot;,</span>
<a href="#l49.31"></a><span id="l49.31" class="difflineplus">+];</span>
<a href="#l49.32"></a><span id="l49.32"> </span>
<a href="#l49.33"></a><span id="l49.33"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l49.34"></a><span id="l49.34"> </span>
<a href="#l49.35"></a><span id="l49.35"> var sig = &quot;roses are red&quot;;</span>
<a href="#l49.36"></a><span id="l49.36"> var folder;</span>
<a href="#l49.37"></a><span id="l49.37"> </span>
<a href="#l49.38"></a><span id="l49.38"> function setupModule(module) {</span>
<a href="#l49.39"></a><span id="l49.39">     for (let req of MODULE_REQUIRES) {</span>
<a href="#l49.40"></a><span id="l49.40" class="difflineat">@@ -30,32 +36,32 @@ function setupModule(module) {</span>
<a href="#l49.41"></a><span id="l49.41"> </span>
<a href="#l49.42"></a><span id="l49.42">   let msg = create_message({</span>
<a href="#l49.43"></a><span id="l49.43">     subject: &quot;msg with signature; format=flowed&quot;,</span>
<a href="#l49.44"></a><span id="l49.44">     body: {</span>
<a href="#l49.45"></a><span id="l49.45">       body: &quot;get with the flow! get with the flow! get with the flow! &quot; +</span>
<a href="#l49.46"></a><span id="l49.46">         &quot;get with the \n flow! get with the flow!\n-- \n&quot; + sig + &quot;\n&quot;,</span>
<a href="#l49.47"></a><span id="l49.47">       contentType: &quot;text/plain&quot;,</span>
<a href="#l49.48"></a><span id="l49.48">       charset: &quot;UTF-8&quot;,</span>
<a href="#l49.49"></a><span id="l49.49" class="difflineminus">-      format: &quot;flowed&quot;</span>
<a href="#l49.50"></a><span id="l49.50" class="difflineminus">-    }</span>
<a href="#l49.51"></a><span id="l49.51" class="difflineplus">+      format: &quot;flowed&quot;,</span>
<a href="#l49.52"></a><span id="l49.52" class="difflineplus">+    },</span>
<a href="#l49.53"></a><span id="l49.53">   });</span>
<a href="#l49.54"></a><span id="l49.54">   add_message_to_folder(folder, msg);</span>
<a href="#l49.55"></a><span id="l49.55">   let msg2 = create_message({</span>
<a href="#l49.56"></a><span id="l49.56">     subject: &quot;msg with signature; format not flowed&quot;,</span>
<a href="#l49.57"></a><span id="l49.57">     body: {</span>
<a href="#l49.58"></a><span id="l49.58">       body: &quot;not flowed! not flowed! not flowed! \n&quot; +</span>
<a href="#l49.59"></a><span id="l49.59">         &quot;not flowed!\n-- \n&quot; + sig + &quot;\n&quot;,</span>
<a href="#l49.60"></a><span id="l49.60">       contentType: &quot;text/plain&quot;,</span>
<a href="#l49.61"></a><span id="l49.61">       charset: &quot;UTF-8&quot;,</span>
<a href="#l49.62"></a><span id="l49.62" class="difflineminus">-      format: &quot;&quot;</span>
<a href="#l49.63"></a><span id="l49.63" class="difflineminus">-    }</span>
<a href="#l49.64"></a><span id="l49.64" class="difflineplus">+      format: &quot;&quot;,</span>
<a href="#l49.65"></a><span id="l49.65" class="difflineplus">+    },</span>
<a href="#l49.66"></a><span id="l49.66">   });</span>
<a href="#l49.67"></a><span id="l49.67">   add_message_to_folder(folder, msg2);</span>
<a href="#l49.68"></a><span id="l49.68" class="difflineminus">-};</span>
<a href="#l49.69"></a><span id="l49.69" class="difflineplus">+}</span>
<a href="#l49.70"></a><span id="l49.70"> </span>
<a href="#l49.71"></a><span id="l49.71"> /** Test sig strip true for format flowed. */</span>
<a href="#l49.72"></a><span id="l49.72"> function test_sig_strip_true_ff() {</span>
<a href="#l49.73"></a><span id="l49.73">   Services.prefs.setBoolPref(&quot;mail.strip_sig_on_reply&quot;, true);</span>
<a href="#l49.74"></a><span id="l49.74">   check_sig_strip_works(0, true);</span>
<a href="#l49.75"></a><span id="l49.75">   Services.prefs.clearUserPref(&quot;mail.strip_sig_on_reply&quot;);</span>
<a href="#l49.76"></a><span id="l49.76"> }</span>
<a href="#l49.77"></a><span id="l49.77"> </span>
<a href="#l49.78"></a><span id="l49.78" class="difflineat">@@ -90,16 +96,15 @@ function check_sig_strip_works(aRow, aSh</span>
<a href="#l49.79"></a><span id="l49.79">   let msg = select_click_row(aRow);</span>
<a href="#l49.80"></a><span id="l49.80">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l49.81"></a><span id="l49.81"> </span>
<a href="#l49.82"></a><span id="l49.82">   let rwc = open_compose_with_reply();</span>
<a href="#l49.83"></a><span id="l49.83">   let body = get_compose_body(rwc);</span>
<a href="#l49.84"></a><span id="l49.84"> </span>
<a href="#l49.85"></a><span id="l49.85">   if (aShouldStrip &amp;&amp; body.textContent.includes(sig)) {</span>
<a href="#l49.86"></a><span id="l49.86">     throw new Error(&quot;signature was not stripped; body=&quot; + body.textContent);</span>
<a href="#l49.87"></a><span id="l49.87" class="difflineminus">-  }</span>
<a href="#l49.88"></a><span id="l49.88" class="difflineminus">-  else if (!aShouldStrip &amp;&amp; !body.textContent.includes(sig)) {</span>
<a href="#l49.89"></a><span id="l49.89" class="difflineplus">+  } else if (!aShouldStrip &amp;&amp; !body.textContent.includes(sig)) {</span>
<a href="#l49.90"></a><span id="l49.90">     throw new Error(&quot;signature stripped; body=&quot; + body.textContent);</span>
<a href="#l49.91"></a><span id="l49.91">   }</span>
<a href="#l49.92"></a><span id="l49.92">   close_compose_window(rwc);</span>
<a href="#l49.93"></a><span id="l49.93"> }</span>
<a href="#l49.94"></a><span id="l49.94"> </span>
<a href="#l49.95"></a><span id="l49.95"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-save-changes-on-quit.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-save-changes-on-quit.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -3,27 +3,34 @@</span>
<a href="#l50.4"></a><span id="l50.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l50.5"></a><span id="l50.5"> </span>
<a href="#l50.6"></a><span id="l50.6"> /**</span>
<a href="#l50.7"></a><span id="l50.7">  * Tests that we prompt the user if they'd like to save their message when they</span>
<a href="#l50.8"></a><span id="l50.8">  * try to quit/close with an open compose window with unsaved changes, and</span>
<a href="#l50.9"></a><span id="l50.9">  * that we don't prompt if there are no changes.</span>
<a href="#l50.10"></a><span id="l50.10">  */</span>
<a href="#l50.11"></a><span id="l50.11"> </span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-// make SOLO_TEST=composition/test-save-changes-on-quit.js mozmill-one</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l50.14"></a><span id="l50.14"> </span>
<a href="#l50.15"></a><span id="l50.15" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l50.17"></a><span id="l50.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l50.18"></a><span id="l50.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-prompt-helpers.js */</span>
<a href="#l50.19"></a><span id="l50.19" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l50.20"></a><span id="l50.20"> </span>
<a href="#l50.21"></a><span id="l50.21"> var MODULE_NAME = &quot;test-save-changes-on-quit&quot;;</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l50.23"></a><span id="l50.23" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l50.24"></a><span id="l50.24" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l50.25"></a><span id="l50.25" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l50.26"></a><span id="l50.26" class="difflineplus">+  &quot;prompt-helpers&quot;,</span>
<a href="#l50.27"></a><span id="l50.27" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l50.28"></a><span id="l50.28" class="difflineplus">+];</span>
<a href="#l50.29"></a><span id="l50.29"> </span>
<a href="#l50.30"></a><span id="l50.30" class="difflineminus">-var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l50.31"></a><span id="l50.31" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;,</span>
<a href="#l50.32"></a><span id="l50.32" class="difflineminus">-                         &quot;prompt-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l50.33"></a><span id="l50.33" class="difflineminus">-var SAVE = 0</span>
<a href="#l50.34"></a><span id="l50.34" class="difflineminus">-var CANCEL = 1</span>
<a href="#l50.35"></a><span id="l50.35" class="difflineplus">+var SAVE = 0;</span>
<a href="#l50.36"></a><span id="l50.36" class="difflineplus">+var CANCEL = 1;</span>
<a href="#l50.37"></a><span id="l50.37"> var DONT_SAVE = 2;</span>
<a href="#l50.38"></a><span id="l50.38"> </span>
<a href="#l50.39"></a><span id="l50.39"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l50.40"></a><span id="l50.40"> </span>
<a href="#l50.41"></a><span id="l50.41"> var cwc = null; // compose window controller</span>
<a href="#l50.42"></a><span id="l50.42"> var folder = null;</span>
<a href="#l50.43"></a><span id="l50.43"> </span>
<a href="#l50.44"></a><span id="l50.44"> function setupModule(module) {</span>
<a href="#l50.45"></a><span id="l50.45" class="difflineat">@@ -167,17 +174,17 @@ function test_window_quit_state_reset_on</span>
<a href="#l50.46"></a><span id="l50.46">   // This is a hacky method for making sure that the second window</span>
<a href="#l50.47"></a><span id="l50.47">   // receives a CANCEL click in the popup dialog.</span>
<a href="#l50.48"></a><span id="l50.48">   var numOfPrompts = 0;</span>
<a href="#l50.49"></a><span id="l50.49">   gMockPromptService.onPromptCallback = function() {</span>
<a href="#l50.50"></a><span id="l50.50">     numOfPrompts++;</span>
<a href="#l50.51"></a><span id="l50.51"> </span>
<a href="#l50.52"></a><span id="l50.52">     if (numOfPrompts &gt; 1)</span>
<a href="#l50.53"></a><span id="l50.53">       gMockPromptService.returnValue = CANCEL;</span>
<a href="#l50.54"></a><span id="l50.54" class="difflineminus">-  }</span>
<a href="#l50.55"></a><span id="l50.55" class="difflineplus">+  };</span>
<a href="#l50.56"></a><span id="l50.56"> </span>
<a href="#l50.57"></a><span id="l50.57">   gMockPromptService.returnValue = DONT_SAVE;</span>
<a href="#l50.58"></a><span id="l50.58"> </span>
<a href="#l50.59"></a><span id="l50.59">   // Trigger the quit-application-request notification</span>
<a href="#l50.60"></a><span id="l50.60">   Services.obs.notifyObservers(cancelQuit, &quot;quit-application-requested&quot;);</span>
<a href="#l50.61"></a><span id="l50.61"> </span>
<a href="#l50.62"></a><span id="l50.62">   // We should have cancelled the quit appropriately.</span>
<a href="#l50.63"></a><span id="l50.63">   assert_true(cancelQuit.data);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-send-button.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-send-button.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -3,41 +3,49 @@</span>
<a href="#l51.4"></a><span id="l51.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l51.5"></a><span id="l51.5"> </span>
<a href="#l51.6"></a><span id="l51.6"> /**</span>
<a href="#l51.7"></a><span id="l51.7">  * Tests proper enabling of send buttons depending on addresses input.</span>
<a href="#l51.8"></a><span id="l51.8">  */</span>
<a href="#l51.9"></a><span id="l51.9"> </span>
<a href="#l51.10"></a><span id="l51.10"> &quot;use strict&quot;;</span>
<a href="#l51.11"></a><span id="l51.11"> </span>
<a href="#l51.12"></a><span id="l51.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-address-book-helpers.js */</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l51.14"></a><span id="l51.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineplus">+</span>
<a href="#l51.17"></a><span id="l51.17"> var MODULE_NAME = &quot;test-send-button&quot;;</span>
<a href="#l51.18"></a><span id="l51.18" class="difflineminus">-</span>
<a href="#l51.19"></a><span id="l51.19"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l51.20"></a><span id="l51.20" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;,</span>
<a href="#l51.21"></a><span id="l51.21" class="difflineminus">-                         &quot;window-helpers&quot;, &quot;address-book-helpers&quot;];</span>
<a href="#l51.22"></a><span id="l51.22" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l51.23"></a><span id="l51.23" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l51.24"></a><span id="l51.24" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l51.25"></a><span id="l51.25" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l51.26"></a><span id="l51.26" class="difflineplus">+  &quot;address-book-helpers&quot;,</span>
<a href="#l51.27"></a><span id="l51.27" class="difflineplus">+];</span>
<a href="#l51.28"></a><span id="l51.28"> </span>
<a href="#l51.29"></a><span id="l51.29"> var {AppConstants} = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l51.30"></a><span id="l51.30"> </span>
<a href="#l51.31"></a><span id="l51.31"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l51.32"></a><span id="l51.32"> </span>
<a href="#l51.33"></a><span id="l51.33"> var account = null;</span>
<a href="#l51.34"></a><span id="l51.34"> </span>
<a href="#l51.35"></a><span id="l51.35" class="difflineminus">-var setupModule = function (module) {</span>
<a href="#l51.36"></a><span id="l51.36" class="difflineplus">+function setupModule(module) {</span>
<a href="#l51.37"></a><span id="l51.37">   collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l51.38"></a><span id="l51.38">   collector.getModule(&quot;compose-helpers&quot;).installInto(module);</span>
<a href="#l51.39"></a><span id="l51.39">   collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l51.40"></a><span id="l51.40">   collector.getModule(&quot;address-book-helpers&quot;).installInto(module);</span>
<a href="#l51.41"></a><span id="l51.41"> </span>
<a href="#l51.42"></a><span id="l51.42">   // Ensure we're in the tinderbox account as that has the right identities set</span>
<a href="#l51.43"></a><span id="l51.43">   // up for this test.</span>
<a href="#l51.44"></a><span id="l51.44">   let server = MailServices.accounts.FindServer(&quot;tinderbox&quot;, FAKE_SERVER_HOSTNAME, &quot;pop3&quot;);</span>
<a href="#l51.45"></a><span id="l51.45">   account = MailServices.accounts.FindAccountForServer(server);</span>
<a href="#l51.46"></a><span id="l51.46">   let inbox = get_special_folder(Ci.nsMsgFolderFlags.Inbox, false, server);</span>
<a href="#l51.47"></a><span id="l51.47">   be_in_folder(inbox);</span>
<a href="#l51.48"></a><span id="l51.48" class="difflineminus">-};</span>
<a href="#l51.49"></a><span id="l51.49" class="difflineplus">+}</span>
<a href="#l51.50"></a><span id="l51.50"> </span>
<a href="#l51.51"></a><span id="l51.51"> /**</span>
<a href="#l51.52"></a><span id="l51.52">  * Check if the send commands are in the wished state.</span>
<a href="#l51.53"></a><span id="l51.53">  *</span>
<a href="#l51.54"></a><span id="l51.54">  * @param aCwc      The compose window controller.</span>
<a href="#l51.55"></a><span id="l51.55">  * @param aEnabled  The expected state of the commands.</span>
<a href="#l51.56"></a><span id="l51.56">  */</span>
<a href="#l51.57"></a><span id="l51.57"> function check_send_commands_state(aCwc, aEnabled) {</span>
<a href="#l51.58"></a><span id="l51.58" class="difflineat">@@ -54,17 +62,16 @@ function check_send_commands_state(aCwc,</span>
<a href="#l51.59"></a><span id="l51.59"> }</span>
<a href="#l51.60"></a><span id="l51.60"> </span>
<a href="#l51.61"></a><span id="l51.61"> /**</span>
<a href="#l51.62"></a><span id="l51.62">  * Bug 431217</span>
<a href="#l51.63"></a><span id="l51.63">  * Test that the Send buttons are properly enabled if an addressee is input</span>
<a href="#l51.64"></a><span id="l51.64">  * by the user.</span>
<a href="#l51.65"></a><span id="l51.65">  */</span>
<a href="#l51.66"></a><span id="l51.66"> function test_send_enabled_manual_address() {</span>
<a href="#l51.67"></a><span id="l51.67" class="difflineminus">-  let isMac = AppConstants.platform == &quot;macosx&quot;;</span>
<a href="#l51.68"></a><span id="l51.68">   let cwc = open_compose_new_mail(); // compose controller</span>
<a href="#l51.69"></a><span id="l51.69">   // On an empty window, Send must be disabled.</span>
<a href="#l51.70"></a><span id="l51.70">   check_send_commands_state(cwc, false);</span>
<a href="#l51.71"></a><span id="l51.71"> </span>
<a href="#l51.72"></a><span id="l51.72">   // On valid &quot;To:&quot; addressee input, Send must be enabled.</span>
<a href="#l51.73"></a><span id="l51.73">   toggle_recipient_type(cwc, &quot;addr_to&quot;);</span>
<a href="#l51.74"></a><span id="l51.74">   setup_msg_contents(cwc, &quot; recipient@fake.invalid &quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l51.75"></a><span id="l51.75">   check_send_commands_state(cwc, true);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-send-format.js</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-send-format.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -2,29 +2,28 @@</span>
<a href="#l52.4"></a><span id="l52.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l52.5"></a><span id="l52.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l52.6"></a><span id="l52.6"> </span>
<a href="#l52.7"></a><span id="l52.7"> /**</span>
<a href="#l52.8"></a><span id="l52.8">  * Tests resulting send format of a message dependent on using HTML features</span>
<a href="#l52.9"></a><span id="l52.9">  * in the composition.</span>
<a href="#l52.10"></a><span id="l52.10">  */</span>
<a href="#l52.11"></a><span id="l52.11"> </span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-// make SOLO_TEST=composition/test-send-format.js mozmill-one</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineminus">-</span>
<a href="#l52.14"></a><span id="l52.14"> &quot;use strict&quot;;</span>
<a href="#l52.15"></a><span id="l52.15"> </span>
<a href="#l52.16"></a><span id="l52.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l52.17"></a><span id="l52.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l52.19"></a><span id="l52.19" class="difflineplus">+</span>
<a href="#l52.20"></a><span id="l52.20"> var MODULE_NAME = &quot;test-send-format&quot;;</span>
<a href="#l52.21"></a><span id="l52.21" class="difflineminus">-</span>
<a href="#l52.22"></a><span id="l52.22"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l52.23"></a><span id="l52.23"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l52.24"></a><span id="l52.24"> </span>
<a href="#l52.25"></a><span id="l52.25"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l52.26"></a><span id="l52.26"> </span>
<a href="#l52.27"></a><span id="l52.27" class="difflineminus">-const nsIMsgCompConvertible = Ci.nsIMsgCompConvertible;</span>
<a href="#l52.28"></a><span id="l52.28" class="difflineminus">-</span>
<a href="#l52.29"></a><span id="l52.29"> function setupModule(module) {</span>
<a href="#l52.30"></a><span id="l52.30">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l52.31"></a><span id="l52.31">     collector.getModule(lib).installInto(module);</span>
<a href="#l52.32"></a><span id="l52.32">   }</span>
<a href="#l52.33"></a><span id="l52.33"> }</span>
<a href="#l52.34"></a><span id="l52.34"> </span>
<a href="#l52.35"></a><span id="l52.35"> function checkMsgFile(aFilePath, aConvertibility) {</span>
<a href="#l52.36"></a><span id="l52.36">   let file = os.getFileForPath(os.abspath(aFilePath,</span>
<a href="#l52.37"></a><span id="l52.37" class="difflineat">@@ -39,20 +38,20 @@ function checkMsgFile(aFilePath, aConver</span>
<a href="#l52.38"></a><span id="l52.38">   close_compose_window(cwc);</span>
<a href="#l52.39"></a><span id="l52.39">   close_window(msgc);</span>
<a href="#l52.40"></a><span id="l52.40"> }</span>
<a href="#l52.41"></a><span id="l52.41"> </span>
<a href="#l52.42"></a><span id="l52.42"> /**</span>
<a href="#l52.43"></a><span id="l52.43">  * Tests that we only open one compose window for one instance of a draft.</span>
<a href="#l52.44"></a><span id="l52.44">  */</span>
<a href="#l52.45"></a><span id="l52.45"> function test_msg_convertibility() {</span>
<a href="#l52.46"></a><span id="l52.46" class="difflineminus">-  checkMsgFile(&quot;./format1-plain.eml&quot;, nsIMsgCompConvertible.Plain);</span>
<a href="#l52.47"></a><span id="l52.47" class="difflineplus">+  checkMsgFile(&quot;./format1-plain.eml&quot;, Ci.nsIMsgCompConvertible.Plain);</span>
<a href="#l52.48"></a><span id="l52.48"> </span>
<a href="#l52.49"></a><span id="l52.49">   // Bug 1385636</span>
<a href="#l52.50"></a><span id="l52.50" class="difflineminus">-  checkMsgFile(&quot;./format1-altering.eml&quot;, nsIMsgCompConvertible.Altering);</span>
<a href="#l52.51"></a><span id="l52.51" class="difflineplus">+  checkMsgFile(&quot;./format1-altering.eml&quot;, Ci.nsIMsgCompConvertible.Altering);</span>
<a href="#l52.52"></a><span id="l52.52"> </span>
<a href="#l52.53"></a><span id="l52.53">   // Bug 584313</span>
<a href="#l52.54"></a><span id="l52.54" class="difflineminus">-  checkMsgFile(&quot;./format2-style-attr.eml&quot;, nsIMsgCompConvertible.No);</span>
<a href="#l52.55"></a><span id="l52.55" class="difflineminus">-  checkMsgFile(&quot;./format3-style-tag.eml&quot;, nsIMsgCompConvertible.No);</span>
<a href="#l52.56"></a><span id="l52.56" class="difflineplus">+  checkMsgFile(&quot;./format2-style-attr.eml&quot;, Ci.nsIMsgCompConvertible.No);</span>
<a href="#l52.57"></a><span id="l52.57" class="difflineplus">+  checkMsgFile(&quot;./format3-style-tag.eml&quot;, Ci.nsIMsgCompConvertible.No);</span>
<a href="#l52.58"></a><span id="l52.58"> }</span>
<a href="#l52.59"></a><span id="l52.59"> </span>
<a href="#l52.60"></a><span id="l52.60"> function teardownModule() {</span>
<a href="#l52.61"></a><span id="l52.61"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-signature-init.js</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-signature-init.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -4,31 +4,33 @@</span>
<a href="#l53.4"></a><span id="l53.4"> </span>
<a href="#l53.5"></a><span id="l53.5"> /**</span>
<a href="#l53.6"></a><span id="l53.6">  * Tests that the compose window initializes with the signature correctly</span>
<a href="#l53.7"></a><span id="l53.7">  * under various circumstances.</span>
<a href="#l53.8"></a><span id="l53.8">  */</span>
<a href="#l53.9"></a><span id="l53.9"> </span>
<a href="#l53.10"></a><span id="l53.10"> &quot;use strict&quot;;</span>
<a href="#l53.11"></a><span id="l53.11"> </span>
<a href="#l53.12"></a><span id="l53.12" class="difflineminus">-var MODULE_NAME = 'test-signature-init';</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineminus">-var MODULE_REQUIRES = ['compose-helpers',</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineminus">-                         'folder-display-helpers'];</span>
<a href="#l53.16"></a><span id="l53.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l53.17"></a><span id="l53.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l53.18"></a><span id="l53.18"> </span>
<a href="#l53.19"></a><span id="l53.19" class="difflineminus">-var kHtmlPref = 'mail.identity.default.compose_html';</span>
<a href="#l53.20"></a><span id="l53.20" class="difflineminus">-var kReplyOnTopPref = 'mail.identity.default.reply_on_top';</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineplus">+var MODULE_NAME = &quot;test-signature-init&quot;;</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l53.23"></a><span id="l53.23" class="difflineplus">+var MODULE_REQUIRES = [&quot;compose-helpers&quot;, &quot;folder-display-helpers&quot;];</span>
<a href="#l53.24"></a><span id="l53.24" class="difflineplus">+</span>
<a href="#l53.25"></a><span id="l53.25" class="difflineplus">+var kHtmlPref = &quot;mail.identity.default.compose_html&quot;;</span>
<a href="#l53.26"></a><span id="l53.26" class="difflineplus">+var kReplyOnTopPref = &quot;mail.identity.default.reply_on_top&quot;;</span>
<a href="#l53.27"></a><span id="l53.27"> var kReplyOnTop = 1;</span>
<a href="#l53.28"></a><span id="l53.28" class="difflineminus">-var kSigBottomPref = 'mail.identity.default.sig_bottom';</span>
<a href="#l53.29"></a><span id="l53.29" class="difflineplus">+var kSigBottomPref = &quot;mail.identity.default.sig_bottom&quot;;</span>
<a href="#l53.30"></a><span id="l53.30"> </span>
<a href="#l53.31"></a><span id="l53.31"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l53.32"></a><span id="l53.32"> </span>
<a href="#l53.33"></a><span id="l53.33"> function setupModule(module) {</span>
<a href="#l53.34"></a><span id="l53.34" class="difflineminus">-  collector.getModule('folder-display-helpers').installInto(module);</span>
<a href="#l53.35"></a><span id="l53.35" class="difflineminus">-  collector.getModule('compose-helpers').installInto(module);</span>
<a href="#l53.36"></a><span id="l53.36" class="difflineplus">+  collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l53.37"></a><span id="l53.37" class="difflineplus">+  collector.getModule(&quot;compose-helpers&quot;).installInto(module);</span>
<a href="#l53.38"></a><span id="l53.38"> }</span>
<a href="#l53.39"></a><span id="l53.39"> </span>
<a href="#l53.40"></a><span id="l53.40"> /**</span>
<a href="#l53.41"></a><span id="l53.41">  * Regression test for bug 762413 - tests that when we're set to reply above,</span>
<a href="#l53.42"></a><span id="l53.42">  * with the signature below the reply, we initialize the compose window such</span>
<a href="#l53.43"></a><span id="l53.43">  * that there is a &lt;br&gt; node above the signature. This allows the user to</span>
<a href="#l53.44"></a><span id="l53.44">  * insert text before the signature.</span>
<a href="#l53.45"></a><span id="l53.45">  */</span>
<a href="#l53.46"></a><span id="l53.46" class="difflineat">@@ -40,15 +42,15 @@ function test_on_reply_above_signature_b</span>
<a href="#l53.47"></a><span id="l53.47">   Services.prefs.setBoolPref(kHtmlPref, false);</span>
<a href="#l53.48"></a><span id="l53.48">   Services.prefs.setIntPref(kReplyOnTopPref, kReplyOnTop);</span>
<a href="#l53.49"></a><span id="l53.49">   Services.prefs.setBoolPref(kSigBottomPref, false);</span>
<a href="#l53.50"></a><span id="l53.50"> </span>
<a href="#l53.51"></a><span id="l53.51">   let cw = open_compose_new_mail();</span>
<a href="#l53.52"></a><span id="l53.52">   let mailBody = get_compose_body(cw);</span>
<a href="#l53.53"></a><span id="l53.53"> </span>
<a href="#l53.54"></a><span id="l53.54">   let node = mailBody.firstChild;</span>
<a href="#l53.55"></a><span id="l53.55" class="difflineminus">-  assert_equals(node.localName, 'br',</span>
<a href="#l53.56"></a><span id="l53.56" class="difflineminus">-                'Expected a BR node to start the compose body.');</span>
<a href="#l53.57"></a><span id="l53.57" class="difflineplus">+  assert_equals(node.localName, &quot;br&quot;,</span>
<a href="#l53.58"></a><span id="l53.58" class="difflineplus">+                &quot;Expected a BR node to start the compose body.&quot;);</span>
<a href="#l53.59"></a><span id="l53.59"> </span>
<a href="#l53.60"></a><span id="l53.60">   Services.prefs.setBoolPref(kHtmlPref, origHtml);</span>
<a href="#l53.61"></a><span id="l53.61">   Services.prefs.setIntPref(kReplyOnTopPref, origReplyOnTop);</span>
<a href="#l53.62"></a><span id="l53.62">   Services.prefs.setBoolPref(kSigBottomPref, origSigBottom);</span>
<a href="#l53.63"></a><span id="l53.63"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mail/test/mozmill/composition/test-signature-updating.js</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mail/test/mozmill/composition/test-signature-updating.js</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -1,45 +1,47 @@</span>
<a href="#l54.4"></a><span id="l54.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l54.5"></a><span id="l54.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l54.6"></a><span id="l54.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l54.7"></a><span id="l54.7"> </span>
<a href="#l54.8"></a><span id="l54.8"> /**</span>
<a href="#l54.9"></a><span id="l54.9">  * Tests that the signature updates properly when switching identities.</span>
<a href="#l54.10"></a><span id="l54.10">  */</span>
<a href="#l54.11"></a><span id="l54.11"> </span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-// make SOLO_TEST=composition/test-signature-updating.js mozmill-one</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineminus">-</span>
<a href="#l54.14"></a><span id="l54.14"> // mail.identity.id1.htmlSigFormat = false</span>
<a href="#l54.15"></a><span id="l54.15"> // mail.identity.id1.htmlSigText   = &quot;Tinderbox is soo 90ies&quot;</span>
<a href="#l54.16"></a><span id="l54.16"> </span>
<a href="#l54.17"></a><span id="l54.17"> // mail.identity.id2.htmlSigFormat = true</span>
<a href="#l54.18"></a><span id="l54.18"> // mail.identity.id2.htmlSigText   = &quot;Tinderboxpushlog is the new &lt;b&gt;hotness!&lt;/b&gt;&quot;</span>
<a href="#l54.19"></a><span id="l54.19"> </span>
<a href="#l54.20"></a><span id="l54.20"> &quot;use strict&quot;;</span>
<a href="#l54.21"></a><span id="l54.21"> </span>
<a href="#l54.22"></a><span id="l54.22" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l54.23"></a><span id="l54.23" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l54.24"></a><span id="l54.24" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l54.25"></a><span id="l54.25" class="difflineplus">+</span>
<a href="#l54.26"></a><span id="l54.26"> var MODULE_NAME = &quot;test-signature-updating&quot;;</span>
<a href="#l54.27"></a><span id="l54.27" class="difflineminus">-</span>
<a href="#l54.28"></a><span id="l54.28"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l54.29"></a><span id="l54.29"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l54.30"></a><span id="l54.30" class="difflineplus">+</span>
<a href="#l54.31"></a><span id="l54.31"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l54.32"></a><span id="l54.32"> </span>
<a href="#l54.33"></a><span id="l54.33"> var cwc = null; // compose window controller</span>
<a href="#l54.34"></a><span id="l54.34"> </span>
<a href="#l54.35"></a><span id="l54.35" class="difflineminus">-var setupModule = function (module) {</span>
<a href="#l54.36"></a><span id="l54.36" class="difflineplus">+function setupModule(module) {</span>
<a href="#l54.37"></a><span id="l54.37">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l54.38"></a><span id="l54.38">     collector.getModule(lib).installInto(module);</span>
<a href="#l54.39"></a><span id="l54.39">   }</span>
<a href="#l54.40"></a><span id="l54.40"> </span>
<a href="#l54.41"></a><span id="l54.41">   // Ensure we're in the tinderbox account as that has the right identities set</span>
<a href="#l54.42"></a><span id="l54.42">   // up for this test.</span>
<a href="#l54.43"></a><span id="l54.43">   let server = MailServices.accounts.FindServer(&quot;tinderbox&quot;, FAKE_SERVER_HOSTNAME, &quot;pop3&quot;);</span>
<a href="#l54.44"></a><span id="l54.44">   let inbox = get_special_folder(Ci.nsMsgFolderFlags.Inbox, false, server);</span>
<a href="#l54.45"></a><span id="l54.45">   be_in_folder(inbox);</span>
<a href="#l54.46"></a><span id="l54.46" class="difflineminus">-};</span>
<a href="#l54.47"></a><span id="l54.47" class="difflineplus">+}</span>
<a href="#l54.48"></a><span id="l54.48"> </span>
<a href="#l54.49"></a><span id="l54.49"> function teardownModule(module) {</span>
<a href="#l54.50"></a><span id="l54.50">   Services.prefs.clearUserPref(&quot;mail.compose.default_to_paragraph&quot;);</span>
<a href="#l54.51"></a><span id="l54.51">   Services.prefs.clearUserPref(&quot;mail.identity.id1.compose_html&quot;);</span>
<a href="#l54.52"></a><span id="l54.52">   Services.prefs.clearUserPref(&quot;mail.identity.id1.suppress_signature_separator&quot;);</span>
<a href="#l54.53"></a><span id="l54.53">   Services.prefs.clearUserPref(&quot;mail.identity.id2.suppress_signature_separator&quot;);</span>
<a href="#l54.54"></a><span id="l54.54"> }</span>
<a href="#l54.55"></a><span id="l54.55"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-compose-mailto.js</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-compose-mailto.js</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -1,45 +1,54 @@</span>
<a href="#l55.4"></a><span id="l55.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l55.5"></a><span id="l55.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l55.6"></a><span id="l55.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l55.7"></a><span id="l55.7"> </span>
<a href="#l55.8"></a><span id="l55.8"> &quot;use strict&quot;;</span>
<a href="#l55.9"></a><span id="l55.9"> </span>
<a href="#l55.10"></a><span id="l55.10" class="difflineminus">-var MODULE_NAME = 'test-compose-mailto';</span>
<a href="#l55.11"></a><span id="l55.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-keyboard-helpers.js */</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l55.16"></a><span id="l55.16"> </span>
<a href="#l55.17"></a><span id="l55.17" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l55.18"></a><span id="l55.18" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'compose-helpers',</span>
<a href="#l55.19"></a><span id="l55.19" class="difflineminus">-                       'window-helpers', 'keyboard-helpers',</span>
<a href="#l55.20"></a><span id="l55.20" class="difflineminus">-                       'content-tab-helpers'];</span>
<a href="#l55.21"></a><span id="l55.21" class="difflineplus">+var MODULE_NAME = &quot;test-compose-mailto&quot;;</span>
<a href="#l55.22"></a><span id="l55.22" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l55.23"></a><span id="l55.23" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l55.24"></a><span id="l55.24" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l55.25"></a><span id="l55.25" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l55.26"></a><span id="l55.26" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l55.27"></a><span id="l55.27" class="difflineplus">+  &quot;keyboard-helpers&quot;,</span>
<a href="#l55.28"></a><span id="l55.28" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l55.29"></a><span id="l55.29" class="difflineplus">+];</span>
<a href="#l55.30"></a><span id="l55.30"> </span>
<a href="#l55.31"></a><span id="l55.31"> var folder = null;</span>
<a href="#l55.32"></a><span id="l55.32"> var composeHelper = null;</span>
<a href="#l55.33"></a><span id="l55.33"> var windowHelper = null;</span>
<a href="#l55.34"></a><span id="l55.34"> var gMsgNo = 0;</span>
<a href="#l55.35"></a><span id="l55.35"> var gComposeWin;</span>
<a href="#l55.36"></a><span id="l55.36"> var gNewTab;</span>
<a href="#l55.37"></a><span id="l55.37"> var gPreCount;</span>
<a href="#l55.38"></a><span id="l55.38"> </span>
<a href="#l55.39"></a><span id="l55.39"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l55.40"></a><span id="l55.40"> // so we get the right path for the resources.</span>
<a href="#l55.41"></a><span id="l55.41" class="difflineminus">-var url = collector.addHttpResource('../content-policy/html', 'content');</span>
<a href="#l55.42"></a><span id="l55.42" class="difflineplus">+var url = collector.addHttpResource(&quot;../content-policy/html&quot;, &quot;content&quot;);</span>
<a href="#l55.43"></a><span id="l55.43"> </span>
<a href="#l55.44"></a><span id="l55.44" class="difflineminus">-var setupModule = function (module) {</span>
<a href="#l55.45"></a><span id="l55.45" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l55.46"></a><span id="l55.46" class="difflineplus">+function setupModule(module) {</span>
<a href="#l55.47"></a><span id="l55.47" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l55.48"></a><span id="l55.48">   fdh.installInto(module);</span>
<a href="#l55.49"></a><span id="l55.49" class="difflineminus">-  let kh = collector.getModule('keyboard-helpers');</span>
<a href="#l55.50"></a><span id="l55.50" class="difflineplus">+  let kh = collector.getModule(&quot;keyboard-helpers&quot;);</span>
<a href="#l55.51"></a><span id="l55.51">   kh.installInto(module);</span>
<a href="#l55.52"></a><span id="l55.52" class="difflineminus">-  composeHelper = collector.getModule('compose-helpers');</span>
<a href="#l55.53"></a><span id="l55.53" class="difflineplus">+  composeHelper = collector.getModule(&quot;compose-helpers&quot;);</span>
<a href="#l55.54"></a><span id="l55.54">   composeHelper.installInto(module);</span>
<a href="#l55.55"></a><span id="l55.55" class="difflineminus">-  windowHelper = collector.getModule('window-helpers');</span>
<a href="#l55.56"></a><span id="l55.56" class="difflineplus">+  windowHelper = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l55.57"></a><span id="l55.57">   windowHelper.installInto(module);</span>
<a href="#l55.58"></a><span id="l55.58">   let cth = collector.getModule(&quot;content-tab-helpers&quot;);</span>
<a href="#l55.59"></a><span id="l55.59">   cth.installInto(module);</span>
<a href="#l55.60"></a><span id="l55.60" class="difflineminus">-};</span>
<a href="#l55.61"></a><span id="l55.61" class="difflineplus">+}</span>
<a href="#l55.62"></a><span id="l55.62"> </span>
<a href="#l55.63"></a><span id="l55.63"> function test_openComposeFromMailToLink() {</span>
<a href="#l55.64"></a><span id="l55.64">   // Open a content tab with the mailto link in it.</span>
<a href="#l55.65"></a><span id="l55.65">     // To open a tab we're going to have to cheat and use tabmail so we can load</span>
<a href="#l55.66"></a><span id="l55.66">   // in the data of what we want.</span>
<a href="#l55.67"></a><span id="l55.67">   gPreCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l55.68"></a><span id="l55.68">   gNewTab = open_content_tab_with_url(url + &quot;mailtolink.html&quot;);</span>
<a href="#l55.69"></a><span id="l55.69">   gComposeWin = composeHelper.open_compose_with_element_click(&quot;mailtolink&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-dns-prefetch.js</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-dns-prefetch.js</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -6,54 +6,55 @@</span>
<a href="#l56.4"></a><span id="l56.4">  * The purpose of this test is to ensure that dns prefetch is turned off in</span>
<a href="#l56.5"></a><span id="l56.5">  * the message pane and compose windows. It also checks that dns prefetch is</span>
<a href="#l56.6"></a><span id="l56.6">  * currently turned off in content tabs, although when bug 545407 is fixed, it</span>
<a href="#l56.7"></a><span id="l56.7">  * should be turned back on again.</span>
<a href="#l56.8"></a><span id="l56.8">  */</span>
<a href="#l56.9"></a><span id="l56.9"> </span>
<a href="#l56.10"></a><span id="l56.10"> &quot;use strict&quot;;</span>
<a href="#l56.11"></a><span id="l56.11"> </span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-var MODULE_NAME = &quot;test-dns-prefetch&quot;;</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l56.14"></a><span id="l56.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l56.15"></a><span id="l56.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l56.16"></a><span id="l56.16"> </span>
<a href="#l56.17"></a><span id="l56.17" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l56.18"></a><span id="l56.18" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'compose-helpers',</span>
<a href="#l56.19"></a><span id="l56.19" class="difflineminus">-                       'content-tab-helpers'];</span>
<a href="#l56.20"></a><span id="l56.20" class="difflineplus">+var MODULE_NAME = &quot;test-dns-prefetch&quot;;</span>
<a href="#l56.21"></a><span id="l56.21" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l56.22"></a><span id="l56.22" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;content-tab-helpers&quot;];</span>
<a href="#l56.23"></a><span id="l56.23"> </span>
<a href="#l56.24"></a><span id="l56.24"> var folder = null;</span>
<a href="#l56.25"></a><span id="l56.25"> var composeHelper = null;</span>
<a href="#l56.26"></a><span id="l56.26"> var gMsgNo = 0;</span>
<a href="#l56.27"></a><span id="l56.27"> var gMsgHdr = null;</span>
<a href="#l56.28"></a><span id="l56.28"> </span>
<a href="#l56.29"></a><span id="l56.29"> // These two constants are used to build the message body.</span>
<a href="#l56.30"></a><span id="l56.30"> var msgBody = '&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;\n' +</span>
<a href="#l56.31"></a><span id="l56.31" class="difflineminus">-'&lt;html&gt;\n' +</span>
<a href="#l56.32"></a><span id="l56.32" class="difflineminus">-'&lt;head&gt;\n' +</span>
<a href="#l56.33"></a><span id="l56.33" class="difflineminus">-'\n' +</span>
<a href="#l56.34"></a><span id="l56.34" class="difflineplus">+&quot;&lt;html&gt;\n&quot; +</span>
<a href="#l56.35"></a><span id="l56.35" class="difflineplus">+&quot;&lt;head&gt;\n&quot; +</span>
<a href="#l56.36"></a><span id="l56.36" class="difflineplus">+&quot;\n&quot; +</span>
<a href="#l56.37"></a><span id="l56.37"> '&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=ISO-8859-1&quot;&gt;\n' +</span>
<a href="#l56.38"></a><span id="l56.38" class="difflineminus">-'&lt;/head&gt;\n' +</span>
<a href="#l56.39"></a><span id="l56.39" class="difflineplus">+&quot;&lt;/head&gt;\n&quot; +</span>
<a href="#l56.40"></a><span id="l56.40"> '&lt;body bgcolor=&quot;#ffffff&quot; text=&quot;#000000&quot;&gt;\n' +</span>
<a href="#l56.41"></a><span id="l56.41" class="difflineminus">-'dns prefetch test message\n' +</span>
<a href="#l56.42"></a><span id="l56.42" class="difflineminus">-'&lt;/body&gt;\n&lt;/html&gt;\n';</span>
<a href="#l56.43"></a><span id="l56.43" class="difflineplus">+&quot;dns prefetch test message\n&quot; +</span>
<a href="#l56.44"></a><span id="l56.44" class="difflineplus">+&quot;&lt;/body&gt;\n&lt;/html&gt;\n&quot;;</span>
<a href="#l56.45"></a><span id="l56.45"> </span>
<a href="#l56.46"></a><span id="l56.46" class="difflineminus">-var setupModule = function (module) {</span>
<a href="#l56.47"></a><span id="l56.47" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l56.48"></a><span id="l56.48" class="difflineplus">+function setupModule(module) {</span>
<a href="#l56.49"></a><span id="l56.49" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l56.50"></a><span id="l56.50">   fdh.installInto(module);</span>
<a href="#l56.51"></a><span id="l56.51" class="difflineminus">-  composeHelper = collector.getModule('compose-helpers');</span>
<a href="#l56.52"></a><span id="l56.52" class="difflineplus">+  composeHelper = collector.getModule(&quot;compose-helpers&quot;);</span>
<a href="#l56.53"></a><span id="l56.53">   composeHelper.installInto(module);</span>
<a href="#l56.54"></a><span id="l56.54" class="difflineminus">-  let cth = collector.getModule('content-tab-helpers');</span>
<a href="#l56.55"></a><span id="l56.55" class="difflineplus">+  let cth = collector.getModule(&quot;content-tab-helpers&quot;);</span>
<a href="#l56.56"></a><span id="l56.56">   cth.installInto(module);</span>
<a href="#l56.57"></a><span id="l56.57"> </span>
<a href="#l56.58"></a><span id="l56.58">   folder = create_folder(&quot;dnsPrefetch&quot;);</span>
<a href="#l56.59"></a><span id="l56.59" class="difflineminus">-};</span>
<a href="#l56.60"></a><span id="l56.60" class="difflineplus">+}</span>
<a href="#l56.61"></a><span id="l56.61"> </span>
<a href="#l56.62"></a><span id="l56.62"> function addToFolder(aSubject, aBody, aFolder) {</span>
<a href="#l56.63"></a><span id="l56.63" class="difflineminus">-</span>
<a href="#l56.64"></a><span id="l56.64">   let msgId = Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l56.65"></a><span id="l56.65">                           .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l56.66"></a><span id="l56.66" class="difflineminus">-                          .generateUUID() +&quot;@mozillamessaging.invalid&quot;;</span>
<a href="#l56.67"></a><span id="l56.67" class="difflineplus">+                          .generateUUID() + &quot;@mozillamessaging.invalid&quot;;</span>
<a href="#l56.68"></a><span id="l56.68"> </span>
<a href="#l56.69"></a><span id="l56.69">   let source = &quot;From - Sat Nov  1 12:39:54 2008\n&quot; +</span>
<a href="#l56.70"></a><span id="l56.70">                &quot;X-Mozilla-Status: 0001\n&quot; +</span>
<a href="#l56.71"></a><span id="l56.71">                &quot;X-Mozilla-Status2: 00000000\n&quot; +</span>
<a href="#l56.72"></a><span id="l56.72">                &quot;Message-ID: &lt;&quot; + msgId + &quot;&gt;\n&quot; +</span>
<a href="#l56.73"></a><span id="l56.73">                &quot;Date: Wed, 11 Jun 2008 20:32:02 -0400\n&quot; +</span>
<a href="#l56.74"></a><span id="l56.74">                &quot;From: Tester &lt;tests@mozillamessaging.invalid&gt;\n&quot; +</span>
<a href="#l56.75"></a><span id="l56.75">                &quot;User-Agent: Thunderbird 3.0a2pre (Macintosh/2008052122)\n&quot; +</span>
<a href="#l56.76"></a><span id="l56.76" class="difflineat">@@ -155,18 +156,18 @@ function test_dnsPrefetch_compose() {</span>
<a href="#l56.77"></a><span id="l56.77">   checkComposeWindow(2);</span>
<a href="#l56.78"></a><span id="l56.78"> }</span>
<a href="#l56.79"></a><span id="l56.79"> </span>
<a href="#l56.80"></a><span id="l56.80"> function test_dnsPrefetch_contentTab() {</span>
<a href="#l56.81"></a><span id="l56.81">   // To open a tab we're going to have to cheat and use tabmail so we can load</span>
<a href="#l56.82"></a><span id="l56.82">   // in the data of what we want.</span>
<a href="#l56.83"></a><span id="l56.83">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l56.84"></a><span id="l56.84"> </span>
<a href="#l56.85"></a><span id="l56.85" class="difflineminus">-  let dataurl = 'data:text/html,&lt;html&gt;&lt;head&gt;&lt;title&gt;test dns prefetch&lt;/title&gt;' +</span>
<a href="#l56.86"></a><span id="l56.86" class="difflineminus">-    '&lt;/head&gt;&lt;body&gt;test dns prefetch&lt;/body&gt;&lt;/html&gt;';</span>
<a href="#l56.87"></a><span id="l56.87" class="difflineplus">+  let dataurl = &quot;data:text/html,&lt;html&gt;&lt;head&gt;&lt;title&gt;test dns prefetch&lt;/title&gt;&quot; +</span>
<a href="#l56.88"></a><span id="l56.88" class="difflineplus">+    &quot;&lt;/head&gt;&lt;body&gt;test dns prefetch&lt;/body&gt;&lt;/html&gt;&quot;;</span>
<a href="#l56.89"></a><span id="l56.89"> </span>
<a href="#l56.90"></a><span id="l56.90">   let newTab = open_content_tab_with_url(dataurl);</span>
<a href="#l56.91"></a><span id="l56.91"> </span>
<a href="#l56.92"></a><span id="l56.92">   if (!mc.tabmail.getBrowserForSelectedTab().docShell.allowDNSPrefetch)</span>
<a href="#l56.93"></a><span id="l56.93">     throw new Error(&quot;DNS prefetch unexpectedly disabled in content tabs&quot;);</span>
<a href="#l56.94"></a><span id="l56.94"> </span>
<a href="#l56.95"></a><span id="l56.95">   mc.tabmail.closeTab(newTab);</span>
<a href="#l56.96"></a><span id="l56.96"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -4,57 +4,58 @@</span>
<a href="#l57.4"></a><span id="l57.4"> </span>
<a href="#l57.5"></a><span id="l57.5"> /**</span>
<a href="#l57.6"></a><span id="l57.6">  * The purpose of this test is to ensure that remote content can't gain access</span>
<a href="#l57.7"></a><span id="l57.7">  * to messages by loading their URIs.</span>
<a href="#l57.8"></a><span id="l57.8">  */</span>
<a href="#l57.9"></a><span id="l57.9"> </span>
<a href="#l57.10"></a><span id="l57.10"> &quot;use strict&quot;;</span>
<a href="#l57.11"></a><span id="l57.11"> </span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-var MODULE_NAME = 'test-exposed-in-content-tabs';</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l57.14"></a><span id="l57.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l57.15"></a><span id="l57.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l57.16"></a><span id="l57.16"> </span>
<a href="#l57.17"></a><span id="l57.17" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l57.18"></a><span id="l57.18" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'compose-helpers',</span>
<a href="#l57.19"></a><span id="l57.19" class="difflineminus">-                       'content-tab-helpers'];</span>
<a href="#l57.20"></a><span id="l57.20" class="difflineplus">+var MODULE_NAME = &quot;test-exposed-in-content-tabs&quot;;</span>
<a href="#l57.21"></a><span id="l57.21" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l57.22"></a><span id="l57.22" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;content-tab-helpers&quot;];</span>
<a href="#l57.23"></a><span id="l57.23"> </span>
<a href="#l57.24"></a><span id="l57.24"> var folder = null;</span>
<a href="#l57.25"></a><span id="l57.25"> var composeHelper = null;</span>
<a href="#l57.26"></a><span id="l57.26"> var gMsgNo = 0;</span>
<a href="#l57.27"></a><span id="l57.27"> </span>
<a href="#l57.28"></a><span id="l57.28"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l57.29"></a><span id="l57.29"> // so we get the right path for the resources.</span>
<a href="#l57.30"></a><span id="l57.30" class="difflineminus">-var url = collector.addHttpResource('../content-policy/html', 'content');</span>
<a href="#l57.31"></a><span id="l57.31" class="difflineplus">+var url = collector.addHttpResource(&quot;../content-policy/html&quot;, &quot;content&quot;);</span>
<a href="#l57.32"></a><span id="l57.32"> </span>
<a href="#l57.33"></a><span id="l57.33"> // These two constants are used to build the message body.</span>
<a href="#l57.34"></a><span id="l57.34"> var msgBody = '&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;\n' +</span>
<a href="#l57.35"></a><span id="l57.35" class="difflineminus">-'&lt;html&gt;\n' +</span>
<a href="#l57.36"></a><span id="l57.36" class="difflineminus">-'&lt;head&gt;\n' +</span>
<a href="#l57.37"></a><span id="l57.37" class="difflineminus">-'\n' +</span>
<a href="#l57.38"></a><span id="l57.38" class="difflineplus">+&quot;&lt;html&gt;\n&quot; +</span>
<a href="#l57.39"></a><span id="l57.39" class="difflineplus">+&quot;&lt;head&gt;\n&quot; +</span>
<a href="#l57.40"></a><span id="l57.40" class="difflineplus">+&quot;\n&quot; +</span>
<a href="#l57.41"></a><span id="l57.41"> '&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=ISO-8859-1&quot;&gt;\n' +</span>
<a href="#l57.42"></a><span id="l57.42" class="difflineminus">-'&lt;/head&gt;\n' +</span>
<a href="#l57.43"></a><span id="l57.43" class="difflineplus">+&quot;&lt;/head&gt;\n&quot; +</span>
<a href="#l57.44"></a><span id="l57.44"> '&lt;body bgcolor=&quot;#ffffff&quot; text=&quot;#000000&quot;&gt;\n' +</span>
<a href="#l57.45"></a><span id="l57.45"> '&lt;img id=&quot;testelement&quot; src=&quot;' + url + 'pass.png&quot;/&gt;\n' +</span>
<a href="#l57.46"></a><span id="l57.46" class="difflineminus">-'&lt;/body&gt;\n&lt;/html&gt;\n';</span>
<a href="#l57.47"></a><span id="l57.47" class="difflineplus">+&quot;&lt;/body&gt;\n&lt;/html&gt;\n&quot;;</span>
<a href="#l57.48"></a><span id="l57.48"> </span>
<a href="#l57.49"></a><span id="l57.49" class="difflineminus">-var setupModule = function (module) {</span>
<a href="#l57.50"></a><span id="l57.50" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l57.51"></a><span id="l57.51" class="difflineplus">+function setupModule(module) {</span>
<a href="#l57.52"></a><span id="l57.52" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l57.53"></a><span id="l57.53">   fdh.installInto(module);</span>
<a href="#l57.54"></a><span id="l57.54" class="difflineminus">-  composeHelper = collector.getModule('compose-helpers');</span>
<a href="#l57.55"></a><span id="l57.55" class="difflineplus">+  composeHelper = collector.getModule(&quot;compose-helpers&quot;);</span>
<a href="#l57.56"></a><span id="l57.56">   composeHelper.installInto(module);</span>
<a href="#l57.57"></a><span id="l57.57" class="difflineminus">-  let cth = collector.getModule('content-tab-helpers');</span>
<a href="#l57.58"></a><span id="l57.58" class="difflineplus">+  let cth = collector.getModule(&quot;content-tab-helpers&quot;);</span>
<a href="#l57.59"></a><span id="l57.59">   cth.installInto(module);</span>
<a href="#l57.60"></a><span id="l57.60"> </span>
<a href="#l57.61"></a><span id="l57.61">   folder = create_folder(&quot;exposedInContent&quot;);</span>
<a href="#l57.62"></a><span id="l57.62" class="difflineminus">-};</span>
<a href="#l57.63"></a><span id="l57.63" class="difflineplus">+}</span>
<a href="#l57.64"></a><span id="l57.64"> </span>
<a href="#l57.65"></a><span id="l57.65"> function addToFolder(aSubject, aBody, aFolder) {</span>
<a href="#l57.66"></a><span id="l57.66" class="difflineminus">-</span>
<a href="#l57.67"></a><span id="l57.67">   let msgId = Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l57.68"></a><span id="l57.68">                           .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l57.69"></a><span id="l57.69" class="difflineminus">-                          .generateUUID() +&quot;@mozillamessaging.invalid&quot;;</span>
<a href="#l57.70"></a><span id="l57.70" class="difflineplus">+                          .generateUUID() + &quot;@mozillamessaging.invalid&quot;;</span>
<a href="#l57.71"></a><span id="l57.71"> </span>
<a href="#l57.72"></a><span id="l57.72">   let source = &quot;From - Sat Nov  1 12:39:54 2008\n&quot; +</span>
<a href="#l57.73"></a><span id="l57.73">                &quot;X-Mozilla-Status: 0001\n&quot; +</span>
<a href="#l57.74"></a><span id="l57.74">                &quot;X-Mozilla-Status2: 00000000\n&quot; +</span>
<a href="#l57.75"></a><span id="l57.75">                &quot;Message-ID: &lt;&quot; + msgId + &quot;&gt;\n&quot; +</span>
<a href="#l57.76"></a><span id="l57.76">                &quot;Date: Wed, 11 Jun 2008 20:32:02 -0400\n&quot; +</span>
<a href="#l57.77"></a><span id="l57.77">                &quot;From: Tester &lt;tests@mozillamessaging.invalid&gt;\n&quot; +</span>
<a href="#l57.78"></a><span id="l57.78">                &quot;User-Agent: Thunderbird 3.0a2pre (Macintosh/2008052122)\n&quot; +</span>
<a href="#l57.79"></a><span id="l57.79" class="difflineat">@@ -103,17 +104,17 @@ function addMsgToFolder(folder) {</span>
<a href="#l57.80"></a><span id="l57.80">   return neckoURL.value.spec;</span>
<a href="#l57.81"></a><span id="l57.81"> }</span>
<a href="#l57.82"></a><span id="l57.82"> </span>
<a href="#l57.83"></a><span id="l57.83"> function checkContentTab(msgURL) {</span>
<a href="#l57.84"></a><span id="l57.84">   // To open a tab we're going to have to cheat and use tabmail so we can load</span>
<a href="#l57.85"></a><span id="l57.85">   // in the data of what we want.</span>
<a href="#l57.86"></a><span id="l57.86">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l57.87"></a><span id="l57.87"> </span>
<a href="#l57.88"></a><span id="l57.88" class="difflineminus">-  let dataurl = 'data:text/html,&lt;html&gt;&lt;head&gt;&lt;title&gt;test exposed&lt;/title&gt;' +</span>
<a href="#l57.89"></a><span id="l57.89" class="difflineplus">+  let dataurl = &quot;data:text/html,&lt;html&gt;&lt;head&gt;&lt;title&gt;test exposed&lt;/title&gt;&quot; +</span>
<a href="#l57.90"></a><span id="l57.90">     '&lt;/head&gt;&lt;body&gt;&lt;iframe id=&quot;msgIframe&quot; src=&quot;' + msgURL + '&quot;/&gt;&lt;/body&gt;&lt;/html&gt;';</span>
<a href="#l57.91"></a><span id="l57.91"> </span>
<a href="#l57.92"></a><span id="l57.92">   let newTab = open_content_tab_with_url(dataurl);</span>
<a href="#l57.93"></a><span id="l57.93"> </span>
<a href="#l57.94"></a><span id="l57.94">   if (mc.window.content.document.getElementById(&quot;msgIframe&quot;)</span>
<a href="#l57.95"></a><span id="l57.95">         .contentDocument.URL != &quot;about:blank&quot;)</span>
<a href="#l57.96"></a><span id="l57.96">     throw new Error(&quot;Message display/access has not been blocked from remote content!&quot;);</span>
<a href="#l57.97"></a><span id="l57.97"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-general-content-policy.js</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-general-content-policy.js</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -12,40 +12,48 @@</span>
<a href="#l58.4"></a><span id="l58.4">  *</span>
<a href="#l58.5"></a><span id="l58.5">  * - Messages</span>
<a href="#l58.6"></a><span id="l58.6">  * - Reply email compose window</span>
<a href="#l58.7"></a><span id="l58.7">  * - Forward email compose window</span>
<a href="#l58.8"></a><span id="l58.8">  * - Content tab</span>
<a href="#l58.9"></a><span id="l58.9">  * - Feed message</span>
<a href="#l58.10"></a><span id="l58.10">  */</span>
<a href="#l58.11"></a><span id="l58.11"> </span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-// make SOLO_TEST=content-policy/test-general-content-policy.js mozmill-one</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineminus">-</span>
<a href="#l58.14"></a><span id="l58.14"> &quot;use strict&quot;;</span>
<a href="#l58.15"></a><span id="l58.15"> </span>
<a href="#l58.16"></a><span id="l58.16" class="difflineminus">-var MODULE_NAME = 'test-general-content-policy';</span>
<a href="#l58.17"></a><span id="l58.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l58.18"></a><span id="l58.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l58.19"></a><span id="l58.19" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l58.20"></a><span id="l58.20" class="difflineplus">+/* import-globals-from ../shared-modules/test-keyboard-helpers.js */</span>
<a href="#l58.21"></a><span id="l58.21" class="difflineplus">+/* import-globals-from ../shared-modules/test-notificationbox-helpers.js */</span>
<a href="#l58.22"></a><span id="l58.22" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l58.23"></a><span id="l58.23"> </span>
<a href="#l58.24"></a><span id="l58.24" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l58.25"></a><span id="l58.25" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l58.26"></a><span id="l58.26" class="difflineminus">-                         'compose-helpers', 'content-tab-helpers',</span>
<a href="#l58.27"></a><span id="l58.27" class="difflineminus">-                         'keyboard-helpers',</span>
<a href="#l58.28"></a><span id="l58.28" class="difflineminus">-                         'notificationbox-helpers'];</span>
<a href="#l58.29"></a><span id="l58.29" class="difflineplus">+var MODULE_NAME = &quot;test-general-content-policy&quot;;</span>
<a href="#l58.30"></a><span id="l58.30" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l58.31"></a><span id="l58.31" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l58.32"></a><span id="l58.32" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l58.33"></a><span id="l58.33" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l58.34"></a><span id="l58.34" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l58.35"></a><span id="l58.35" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l58.36"></a><span id="l58.36" class="difflineplus">+  &quot;keyboard-helpers&quot;,</span>
<a href="#l58.37"></a><span id="l58.37" class="difflineplus">+  &quot;notificationbox-helpers&quot;,</span>
<a href="#l58.38"></a><span id="l58.38" class="difflineplus">+];</span>
<a href="#l58.39"></a><span id="l58.39"> </span>
<a href="#l58.40"></a><span id="l58.40"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l58.41"></a><span id="l58.41"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l58.42"></a><span id="l58.42"> </span>
<a href="#l58.43"></a><span id="l58.43"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l58.44"></a><span id="l58.44"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l58.45"></a><span id="l58.45"> </span>
<a href="#l58.46"></a><span id="l58.46"> var folder = null;</span>
<a href="#l58.47"></a><span id="l58.47"> var gMsgNo = 0;</span>
<a href="#l58.48"></a><span id="l58.48"> </span>
<a href="#l58.49"></a><span id="l58.49"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l58.50"></a><span id="l58.50"> // so we get the right path for the resources.</span>
<a href="#l58.51"></a><span id="l58.51" class="difflineminus">-var url = collector.addHttpResource('../content-policy/html', 'content');</span>
<a href="#l58.52"></a><span id="l58.52" class="difflineplus">+var url = collector.addHttpResource(&quot;../content-policy/html&quot;, &quot;content&quot;);</span>
<a href="#l58.53"></a><span id="l58.53"> </span>
<a href="#l58.54"></a><span id="l58.54"> /**</span>
<a href="#l58.55"></a><span id="l58.55">  * The TESTS array is constructed from objects containing the following:</span>
<a href="#l58.56"></a><span id="l58.56">  *</span>
<a href="#l58.57"></a><span id="l58.57">  * type:            The type of the test being run.</span>
<a href="#l58.58"></a><span id="l58.58">  * body:            The html to be inserted into the body of the message under</span>
<a href="#l58.59"></a><span id="l58.59">  *                  test. Note: the element under test for content</span>
<a href="#l58.60"></a><span id="l58.60">  *                  allowed/disallowed should have id 'testelement'.</span>
<a href="#l58.61"></a><span id="l58.61" class="difflineat">@@ -60,63 +68,62 @@ var TESTS = [</span>
<a href="#l58.62"></a><span id="l58.62">   {</span>
<a href="#l58.63"></a><span id="l58.63">     type: &quot;Image&quot;,</span>
<a href="#l58.64"></a><span id="l58.64">     checkDenied: true,</span>
<a href="#l58.65"></a><span id="l58.65">     body: '&lt;img id=&quot;testelement&quot; src=&quot;' + url + 'pass.png&quot;/&gt;\n',</span>
<a href="#l58.66"></a><span id="l58.66">     webPage: &quot;remoteimage.html&quot;,</span>
<a href="#l58.67"></a><span id="l58.67">     checkForAllowed: function img_checkAllowed(element) {</span>
<a href="#l58.68"></a><span id="l58.68">       return element.QueryInterface(Ci.nsIImageLoadingContent)</span>
<a href="#l58.69"></a><span id="l58.69">                     .imageBlockingStatus == Ci.nsIContentPolicy.ACCEPT;</span>
<a href="#l58.70"></a><span id="l58.70" class="difflineminus">-    }</span>
<a href="#l58.71"></a><span id="l58.71" class="difflineplus">+    },</span>
<a href="#l58.72"></a><span id="l58.72">   },</span>
<a href="#l58.73"></a><span id="l58.73">   {</span>
<a href="#l58.74"></a><span id="l58.74">     type: &quot;Video&quot;,</span>
<a href="#l58.75"></a><span id="l58.75">     checkDenied: true,</span>
<a href="#l58.76"></a><span id="l58.76">     body: '&lt;video id=&quot;testelement&quot; src=&quot;' + url + 'video.ogv&quot;/&gt;\n',</span>
<a href="#l58.77"></a><span id="l58.77">     webPage: &quot;remotevideo.html&quot;,</span>
<a href="#l58.78"></a><span id="l58.78">     checkForAllowed: function video_checkAllowed(element) {</span>
<a href="#l58.79"></a><span id="l58.79">       return element.networkState != element.NETWORK_NO_SOURCE;</span>
<a href="#l58.80"></a><span id="l58.80" class="difflineminus">-    }</span>
<a href="#l58.81"></a><span id="l58.81" class="difflineplus">+    },</span>
<a href="#l58.82"></a><span id="l58.82">   },</span>
<a href="#l58.83"></a><span id="l58.83">   {</span>
<a href="#l58.84"></a><span id="l58.84">     type: &quot;Image-Data&quot;,</span>
<a href="#l58.85"></a><span id="l58.85">     checkDenied: false,</span>
<a href="#l58.86"></a><span id="l58.86">     body: '&lt;img id=&quot;testelement&quot; src=&quot;data:image/png,%89PNG%0D%0A%1A%0A%00%00%00%0DIHDR%00%00%002%00%00%00%14%08%02%00%00%00%40%A8%F9%CD%00%00%02%A3IDATH%C7%ED%96%3D%2C%2CQ%14%C7%FF3K%22H4%3Ev%13%1F%DDR%10QP%09BT%22%0A%C2F%23HhD%B2%09%A5NB%88%C4%2B%25%0A%0At%14%14%04%85%CFD%82H%14%3E%12%8A-h%84B%7Cd%AD%FD%BDb%5E%26c%F7%3D%3B%5E%A5pr%8A%B9%E7%FE%EE%B9%FF%DCs%EE%CC%18%80%BE%9F%99%FA%96%F6%23%EB%3Fd%15%A9%C8%90%E1%F4d%25g%2B%BBNu%EBZ%8FYs%AB%5B%8F%3C%86%8C%90B%F1%19%8Fu%1CP%20W%B9%C9JNRR%8Er*U%19T0%AC%B0%7B%C6%B0Z%BEHE%17%BA%18%D7%B8%24DD%91%7B%DD%1F%E8%60G%3B%A6%CC-mU%AA%D2N%3A%A9%C9%A0%82%92%C646%A8A%A7%A6%3D%ED%D5%AA%D6%23O%9B%DA%FC%F2G%14%09)t%A0%83S%9D%3E%EA1%5D%E9.%19%01%40!%85%E2%CF%B3%D3%26%98%10j%A5%D5%19%2C%A7%DC%83G%A8%8C%B2%18%BE%91F%A1%0D6b%E2W%5C%BD%F1%E6%9EI%20%EB%81%07%A1%12J%EC%C8%25%97B%DDt%7B%F1%0A%9Ds%EE%E4%8B)%16z%E5%95%7F%9B%1B%26A%CB%A7*U%92%E9%B8%19%F3%9A%97%14P%A0E-%92%16%B4%E0%E4%F3%95%2FiF3%9F%E4t%C3%248%AD%13N%9CE%8C%12%F5%E3%CF%24%F3%8D%B7m%B6%85%FC%F8%A3Dm~%8B-%AB%BE%0D4%2C%B1%F4%CCs%7CN7%CCg%B2%DEyo%A6Yh%99e%2Br%C8%A1P%0F%3D%D6%AC%0F%9F%D0%11G%CEUk%AC%15P%20%24%94FZ%3B%ED%FB%EC%C7dN%C8%7C%90u%C6%99%E5\'%9C%2C%B0PM%B5P%1F%7D%F6y%04%09%0A%AD%B3n%0D%FB%E9%17%1Ad0f%D70%E1%25%96%02%04%D2I%B7%F6%EE%A2%2BL%D8%3D%F3A%96%ED%26%A6%0F_%13M%2B%AC%D8%9A%22D%7C%F8%AC%0AZ%91%5Dv%85%F2%C8%7B%E7%FD%AF%9D%FB%C4%D34%D3%D6%E5%18a%C4%3D%93%A0%B7%9C%B6%C9%A6S%BA%D3w%D8%F9d%E1%11GB%15T%B8g%BE%F0%F1%99%D3%9C!cO%7Bg%3A%B3%7DHC%F1%F71%C6JT%22%E9U%AF_%60%5C%9E%D6%0B%2F%19d%D4P%13%13%BF%E1%C6%C4%CC%22%CB%AA%EC%2F~%5Dq%15%C3%AC%B0b%BD%EA%AC%A1%1B%C6%AD%ACE%16%85%A6%98%8A%9F%AA%A7%5Eh%95U%3BO)%A5%BD%F4%0E3%3C%CAh\'%9D)%A4d%91u%CD%B5s%AF%CF%19%B7%B2ZhI%22%E9%8E%BB%F8%A9Yf%85%3A%E8%006%D8%18%60%A0%8A*%2F%5E%0F%1E%133%9F%FC%5EzC%84l%DE%0Dc%FC%FC%9D~%C1~%03%97%96%03%F2QP%E0%18%00%00%00%00IEND%AEB%60%82&quot;/&gt;\n',</span>
<a href="#l58.87"></a><span id="l58.87">     webPage: &quot;remoteimagedata.html&quot;,</span>
<a href="#l58.88"></a><span id="l58.88">     checkForAllowed: function img_checkAllowed(element) {</span>
<a href="#l58.89"></a><span id="l58.89">       return element.QueryInterface(Ci.nsIImageLoadingContent)</span>
<a href="#l58.90"></a><span id="l58.90">                     .imageBlockingStatus == Ci.nsIContentPolicy.ACCEPT;</span>
<a href="#l58.91"></a><span id="l58.91" class="difflineminus">-    }</span>
<a href="#l58.92"></a><span id="l58.92" class="difflineminus">-  }</span>
<a href="#l58.93"></a><span id="l58.93" class="difflineplus">+    },</span>
<a href="#l58.94"></a><span id="l58.94" class="difflineplus">+  },</span>
<a href="#l58.95"></a><span id="l58.95"> ];</span>
<a href="#l58.96"></a><span id="l58.96"> </span>
<a href="#l58.97"></a><span id="l58.97"> // These two constants are used to build the message body.</span>
<a href="#l58.98"></a><span id="l58.98"> var msgBodyStart = '&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;\n' +</span>
<a href="#l58.99"></a><span id="l58.99" class="difflineminus">-'&lt;html&gt;\n' +</span>
<a href="#l58.100"></a><span id="l58.100" class="difflineminus">-'&lt;head&gt;\n' +</span>
<a href="#l58.101"></a><span id="l58.101" class="difflineminus">-'\n' +</span>
<a href="#l58.102"></a><span id="l58.102" class="difflineplus">+&quot;&lt;html&gt;\n&quot; +</span>
<a href="#l58.103"></a><span id="l58.103" class="difflineplus">+&quot;&lt;head&gt;\n&quot; +</span>
<a href="#l58.104"></a><span id="l58.104" class="difflineplus">+&quot;\n&quot; +</span>
<a href="#l58.105"></a><span id="l58.105"> '&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=ISO-8859-1&quot;&gt;\n' +</span>
<a href="#l58.106"></a><span id="l58.106" class="difflineminus">-'&lt;/head&gt;\n' +</span>
<a href="#l58.107"></a><span id="l58.107" class="difflineplus">+&quot;&lt;/head&gt;\n&quot; +</span>
<a href="#l58.108"></a><span id="l58.108"> '&lt;body bgcolor=&quot;#ffffff&quot; text=&quot;#000000&quot;&gt;\n';</span>
<a href="#l58.109"></a><span id="l58.109"> </span>
<a href="#l58.110"></a><span id="l58.110" class="difflineminus">-var msgBodyEnd = '&lt;/body&gt;\n&lt;/html&gt;\n';</span>
<a href="#l58.111"></a><span id="l58.111" class="difflineplus">+var msgBodyEnd = &quot;&lt;/body&gt;\n&lt;/html&gt;\n&quot;;</span>
<a href="#l58.112"></a><span id="l58.112"> </span>
<a href="#l58.113"></a><span id="l58.113" class="difflineminus">-var setupModule = function (module) {</span>
<a href="#l58.114"></a><span id="l58.114" class="difflineplus">+function setupModule(module) {</span>
<a href="#l58.115"></a><span id="l58.115">   for (let dep of MODULE_REQUIRES) {</span>
<a href="#l58.116"></a><span id="l58.116">     collector.getModule(dep).installInto(module);</span>
<a href="#l58.117"></a><span id="l58.117">   }</span>
<a href="#l58.118"></a><span id="l58.118"> </span>
<a href="#l58.119"></a><span id="l58.119">   folder = create_folder(&quot;generalContentPolicy&quot;);</span>
<a href="#l58.120"></a><span id="l58.120" class="difflineminus">-};</span>
<a href="#l58.121"></a><span id="l58.121" class="difflineplus">+}</span>
<a href="#l58.122"></a><span id="l58.122"> </span>
<a href="#l58.123"></a><span id="l58.123"> function addToFolder(aSubject, aBody, aFolder) {</span>
<a href="#l58.124"></a><span id="l58.124" class="difflineminus">-</span>
<a href="#l58.125"></a><span id="l58.125">   let msgId = Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l58.126"></a><span id="l58.126">                           .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l58.127"></a><span id="l58.127" class="difflineminus">-                          .generateUUID() +&quot;@mozillamessaging.invalid&quot;;</span>
<a href="#l58.128"></a><span id="l58.128" class="difflineplus">+                          .generateUUID() + &quot;@mozillamessaging.invalid&quot;;</span>
<a href="#l58.129"></a><span id="l58.129"> </span>
<a href="#l58.130"></a><span id="l58.130">   let source = &quot;From - Sat Nov  1 12:39:54 2008\n&quot; +</span>
<a href="#l58.131"></a><span id="l58.131">                &quot;X-Mozilla-Status: 0001\n&quot; +</span>
<a href="#l58.132"></a><span id="l58.132">                &quot;X-Mozilla-Status2: 00000000\n&quot; +</span>
<a href="#l58.133"></a><span id="l58.133">                &quot;Message-ID: &lt;&quot; + msgId + &quot;&gt;\n&quot; +</span>
<a href="#l58.134"></a><span id="l58.134">                &quot;Date: Wed, 11 Jun 2008 20:32:02 -0400\n&quot; +</span>
<a href="#l58.135"></a><span id="l58.135">                &quot;From: Tester &lt;tests@mozillamessaging.invalid&gt;\n&quot; +</span>
<a href="#l58.136"></a><span id="l58.136">                &quot;User-Agent: Thunderbird 3.0a2pre (Macintosh/2008052122)\n&quot; +</span>
<a href="#l58.137"></a><span id="l58.137" class="difflineat">@@ -369,17 +376,16 @@ function checkAllowForHostsWithPerms(tes</span>
<a href="#l58.138"></a><span id="l58.138">   Services.perms.remove(uri, &quot;image&quot;);</span>
<a href="#l58.139"></a><span id="l58.139">   assert_true(Services.perms.testPermission(uri, &quot;image&quot;) ==</span>
<a href="#l58.140"></a><span id="l58.140">               Services.perms.UNKNOWN_ACTION);</span>
<a href="#l58.141"></a><span id="l58.141"> </span>
<a href="#l58.142"></a><span id="l58.142">   ++gMsgNo;</span>
<a href="#l58.143"></a><span id="l58.143"> }</span>
<a href="#l58.144"></a><span id="l58.144"> </span>
<a href="#l58.145"></a><span id="l58.145"> function test_generalContentPolicy() {</span>
<a href="#l58.146"></a><span id="l58.146" class="difflineminus">-  let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l58.147"></a><span id="l58.147">   be_in_folder(folder);</span>
<a href="#l58.148"></a><span id="l58.148"> </span>
<a href="#l58.149"></a><span id="l58.149">   assert_nothing_selected();</span>
<a href="#l58.150"></a><span id="l58.150"> </span>
<a href="#l58.151"></a><span id="l58.151">   for (let i = 0; i &lt; TESTS.length; ++i) {</span>
<a href="#l58.152"></a><span id="l58.152">     // Check for denied in mail</span>
<a href="#l58.153"></a><span id="l58.153">     addMsgToFolderAndCheckContent(folder, TESTS[i]);</span>
<a href="#l58.154"></a><span id="l58.154"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-js-content-policy.js</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-js-content-policy.js</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -4,49 +4,48 @@</span>
<a href="#l59.4"></a><span id="l59.4"> </span>
<a href="#l59.5"></a><span id="l59.5"> /**</span>
<a href="#l59.6"></a><span id="l59.6">  * Tests whether JavaScript in a local/remote message works.</span>
<a href="#l59.7"></a><span id="l59.7">  *</span>
<a href="#l59.8"></a><span id="l59.8">  * @note This assumes an existing local account, and will cause the Trash</span>
<a href="#l59.9"></a><span id="l59.9">  * folder of that account to be emptied multiple times.</span>
<a href="#l59.10"></a><span id="l59.10">  */</span>
<a href="#l59.11"></a><span id="l59.11"> </span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-// make SOLO_TEST=content-policy/test-js-content-policy.js mozmill-one</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineminus">-</span>
<a href="#l59.14"></a><span id="l59.14"> &quot;use strict&quot;;</span>
<a href="#l59.15"></a><span id="l59.15"> </span>
<a href="#l59.16"></a><span id="l59.16" class="difflineminus">-var MODULE_NAME = 'test-js-content-policy';</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l59.19"></a><span id="l59.19"> </span>
<a href="#l59.20"></a><span id="l59.20" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l59.21"></a><span id="l59.21" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l59.22"></a><span id="l59.22" class="difflineplus">+var MODULE_NAME = &quot;test-js-content-policy&quot;;</span>
<a href="#l59.23"></a><span id="l59.23" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l59.24"></a><span id="l59.24" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l59.25"></a><span id="l59.25"> </span>
<a href="#l59.26"></a><span id="l59.26"> var folder = null;</span>
<a href="#l59.27"></a><span id="l59.27"> </span>
<a href="#l59.28"></a><span id="l59.28"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l59.29"></a><span id="l59.29"> // so we get the right path for the resources.</span>
<a href="#l59.30"></a><span id="l59.30" class="difflineminus">-var url = collector.addHttpResource('../content-policy/html', 'content');</span>
<a href="#l59.31"></a><span id="l59.31" class="difflineplus">+var url = collector.addHttpResource(&quot;../content-policy/html&quot;, &quot;content&quot;);</span>
<a href="#l59.32"></a><span id="l59.32"> </span>
<a href="#l59.33"></a><span id="l59.33"> function setupModule(module) {</span>
<a href="#l59.34"></a><span id="l59.34">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l59.35"></a><span id="l59.35">     collector.getModule(lib).installInto(module);</span>
<a href="#l59.36"></a><span id="l59.36">   }</span>
<a href="#l59.37"></a><span id="l59.37"> </span>
<a href="#l59.38"></a><span id="l59.38">   folder = create_folder(&quot;jsContentPolicy&quot;);</span>
<a href="#l59.39"></a><span id="l59.39">   Services.prefs.setBoolPref(&quot;javascript.enabled&quot;, true);</span>
<a href="#l59.40"></a><span id="l59.40" class="difflineminus">-};</span>
<a href="#l59.41"></a><span id="l59.41" class="difflineplus">+}</span>
<a href="#l59.42"></a><span id="l59.42"> </span>
<a href="#l59.43"></a><span id="l59.43"> function teardownModule(module) {</span>
<a href="#l59.44"></a><span id="l59.44">   Services.prefs.clearUserPref(&quot;javascript.enabled&quot;);</span>
<a href="#l59.45"></a><span id="l59.45"> }</span>
<a href="#l59.46"></a><span id="l59.46"> </span>
<a href="#l59.47"></a><span id="l59.47"> function addToFolder(aSubject, aBody, aFolder) {</span>
<a href="#l59.48"></a><span id="l59.48" class="difflineminus">-</span>
<a href="#l59.49"></a><span id="l59.49">   let msgId = Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l59.50"></a><span id="l59.50">                           .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l59.51"></a><span id="l59.51" class="difflineminus">-                          .generateUUID() +&quot;@mozillamessaging.invalid&quot;;</span>
<a href="#l59.52"></a><span id="l59.52" class="difflineplus">+                          .generateUUID() + &quot;@mozillamessaging.invalid&quot;;</span>
<a href="#l59.53"></a><span id="l59.53"> </span>
<a href="#l59.54"></a><span id="l59.54">   let source = &quot;From - Sat Nov  1 12:39:54 2008\n&quot; +</span>
<a href="#l59.55"></a><span id="l59.55">                &quot;X-Mozilla-Status: 0001\n&quot; +</span>
<a href="#l59.56"></a><span id="l59.56">                &quot;X-Mozilla-Status2: 00000000\n&quot; +</span>
<a href="#l59.57"></a><span id="l59.57">                &quot;Message-ID: &lt;&quot; + msgId + &quot;&gt;\n&quot; +</span>
<a href="#l59.58"></a><span id="l59.58">                &quot;Date: Wed, 11 Jun 2008 20:32:02 -0400\n&quot; +</span>
<a href="#l59.59"></a><span id="l59.59">                &quot;From: Tester &lt;tests@mozillamessaging.invalid&gt;\n&quot; +</span>
<a href="#l59.60"></a><span id="l59.60">                &quot;User-Agent: Thunderbird 3.0a2pre (Macintosh/2008052122)\n&quot; +</span>
<a href="#l59.61"></a><span id="l59.61" class="difflineat">@@ -63,51 +62,51 @@ function addToFolder(aSubject, aBody, aF</span>
<a href="#l59.62"></a><span id="l59.62"> </span>
<a href="#l59.63"></a><span id="l59.63">   aFolder.addMessage(source);</span>
<a href="#l59.64"></a><span id="l59.64">   aFolder.gettingNewMessages = false;</span>
<a href="#l59.65"></a><span id="l59.65"> </span>
<a href="#l59.66"></a><span id="l59.66">   return aFolder.msgDatabase.getMsgHdrForMessageID(msgId);</span>
<a href="#l59.67"></a><span id="l59.67"> }</span>
<a href="#l59.68"></a><span id="l59.68"> </span>
<a href="#l59.69"></a><span id="l59.69"> var jsMsgBody = '&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;\n' +</span>
<a href="#l59.70"></a><span id="l59.70" class="difflineminus">-'&lt;html&gt;\n' +</span>
<a href="#l59.71"></a><span id="l59.71" class="difflineminus">-'&lt;head&gt;\n' +</span>
<a href="#l59.72"></a><span id="l59.72" class="difflineminus">-'\n' +</span>
<a href="#l59.73"></a><span id="l59.73" class="difflineplus">+&quot;&lt;html&gt;\n&quot; +</span>
<a href="#l59.74"></a><span id="l59.74" class="difflineplus">+&quot;&lt;head&gt;\n&quot; +</span>
<a href="#l59.75"></a><span id="l59.75" class="difflineplus">+&quot;\n&quot; +</span>
<a href="#l59.76"></a><span id="l59.76"> '&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=ISO-8859-1&quot;&gt;\n' +</span>
<a href="#l59.77"></a><span id="l59.77" class="difflineminus">-'&lt;/head&gt;\n' +</span>
<a href="#l59.78"></a><span id="l59.78" class="difflineplus">+&quot;&lt;/head&gt;\n&quot; +</span>
<a href="#l59.79"></a><span id="l59.79"> '&lt;body bgcolor=&quot;#ffffff&quot; text=&quot;#000000&quot;&gt;\n' +</span>
<a href="#l59.80"></a><span id="l59.80" class="difflineminus">-'this is a test&lt;big&gt;&lt;big&gt;&lt;big&gt; stuff\n' +</span>
<a href="#l59.81"></a><span id="l59.81" class="difflineminus">-'&lt;br&gt;&lt;br&gt;\n' +</span>
<a href="#l59.82"></a><span id="l59.82" class="difflineminus">-'&lt;/big&gt;&lt;/big&gt;&lt;/big&gt;\n' +</span>
<a href="#l59.83"></a><span id="l59.83" class="difflineminus">-'&lt;noscript&gt;\n'+</span>
<a href="#l59.84"></a><span id="l59.84" class="difflineminus">-'hello, this content is noscript!\n' +</span>
<a href="#l59.85"></a><span id="l59.85" class="difflineminus">-'&lt;/noscript&gt;\n' +</span>
<a href="#l59.86"></a><span id="l59.86" class="difflineminus">-'&lt;script&gt;\n'+</span>
<a href="#l59.87"></a><span id="l59.87" class="difflineminus">-'var jsIsTurnedOn = true;\n' +</span>
<a href="#l59.88"></a><span id="l59.88" class="difflineminus">-'&lt;/script&gt;\n' +</span>
<a href="#l59.89"></a><span id="l59.89" class="difflineminus">-'\n' +</span>
<a href="#l59.90"></a><span id="l59.90" class="difflineminus">-'&lt;/body&gt;\n' +</span>
<a href="#l59.91"></a><span id="l59.91" class="difflineminus">-'&lt;/html&gt;\n';</span>
<a href="#l59.92"></a><span id="l59.92" class="difflineplus">+&quot;this is a test&lt;big&gt;&lt;big&gt;&lt;big&gt; stuff\n&quot; +</span>
<a href="#l59.93"></a><span id="l59.93" class="difflineplus">+&quot;&lt;br&gt;&lt;br&gt;\n&quot; +</span>
<a href="#l59.94"></a><span id="l59.94" class="difflineplus">+&quot;&lt;/big&gt;&lt;/big&gt;&lt;/big&gt;\n&quot; +</span>
<a href="#l59.95"></a><span id="l59.95" class="difflineplus">+&quot;&lt;noscript&gt;\n&quot; +</span>
<a href="#l59.96"></a><span id="l59.96" class="difflineplus">+&quot;hello, this content is noscript!\n&quot; +</span>
<a href="#l59.97"></a><span id="l59.97" class="difflineplus">+&quot;&lt;/noscript&gt;\n&quot; +</span>
<a href="#l59.98"></a><span id="l59.98" class="difflineplus">+&quot;&lt;script&gt;\n&quot; +</span>
<a href="#l59.99"></a><span id="l59.99" class="difflineplus">+&quot;var jsIsTurnedOn = true;\n&quot; +</span>
<a href="#l59.100"></a><span id="l59.100" class="difflineplus">+&quot;&lt;/script&gt;\n&quot; +</span>
<a href="#l59.101"></a><span id="l59.101" class="difflineplus">+&quot;\n&quot; +</span>
<a href="#l59.102"></a><span id="l59.102" class="difflineplus">+&quot;&lt;/body&gt;\n&quot; +</span>
<a href="#l59.103"></a><span id="l59.103" class="difflineplus">+&quot;&lt;/html&gt;\n&quot;;</span>
<a href="#l59.104"></a><span id="l59.104"> </span>
<a href="#l59.105"></a><span id="l59.105"> var gMsgNo = 0;</span>
<a href="#l59.106"></a><span id="l59.106"> </span>
<a href="#l59.107"></a><span id="l59.107"> function checkJsInMail() {</span>
<a href="#l59.108"></a><span id="l59.108">   let msgDbHdr = addToFolder(&quot;JS test message &quot; + gMsgNo, jsMsgBody, folder);</span>
<a href="#l59.109"></a><span id="l59.109"> </span>
<a href="#l59.110"></a><span id="l59.110">   // select the newly created message</span>
<a href="#l59.111"></a><span id="l59.111">   let msgHdr = select_click_row(gMsgNo);</span>
<a href="#l59.112"></a><span id="l59.112"> </span>
<a href="#l59.113"></a><span id="l59.113">   if (msgDbHdr != msgHdr)</span>
<a href="#l59.114"></a><span id="l59.114">     throw new Error(&quot;Selected Message Header is not the same as generated header&quot;);</span>
<a href="#l59.115"></a><span id="l59.115"> </span>
<a href="#l59.116"></a><span id="l59.116">   assert_selected_and_displayed(gMsgNo);</span>
<a href="#l59.117"></a><span id="l59.117"> </span>
<a href="#l59.118"></a><span id="l59.118">   let mc = mozmill.getMail3PaneController();</span>
<a href="#l59.119"></a><span id="l59.119">   // This works because messagepane is type=content-primary in these tests.</span>
<a href="#l59.120"></a><span id="l59.120" class="difflineminus">-  if (typeof mc.window.content.wrappedJSObject.jsIsTurnedOn != 'undefined')</span>
<a href="#l59.121"></a><span id="l59.121" class="difflineplus">+  if (typeof mc.window.content.wrappedJSObject.jsIsTurnedOn != &quot;undefined&quot;)</span>
<a href="#l59.122"></a><span id="l59.122">     throw new Error(&quot;JS is turned on in mail - it shouldn't be.&quot;);</span>
<a href="#l59.123"></a><span id="l59.123"> </span>
<a href="#l59.124"></a><span id="l59.124">   let noscript = mc.window.content.wrappedJSObject.document</span>
<a href="#l59.125"></a><span id="l59.125">                    .getElementsByTagName(&quot;noscript&quot;)[0];</span>
<a href="#l59.126"></a><span id="l59.126">   let display = mc.window.getComputedStyle(noscript).getPropertyValue(&quot;display&quot;);</span>
<a href="#l59.127"></a><span id="l59.127">   if (display != &quot;inline&quot;)</span>
<a href="#l59.128"></a><span id="l59.128">     throw new Error(&quot;noscript display should be 'inline'; display=&quot; + display);</span>
<a href="#l59.129"></a><span id="l59.129"> </span>
<a href="#l59.130"></a><span id="l59.130" class="difflineat">@@ -117,17 +116,17 @@ function checkJsInMail() {</span>
<a href="#l59.131"></a><span id="l59.131"> function checkJsInNonMessageContent() {</span>
<a href="#l59.132"></a><span id="l59.132">   // Deselect everything so we can load our content</span>
<a href="#l59.133"></a><span id="l59.133">   select_none();</span>
<a href="#l59.134"></a><span id="l59.134"> </span>
<a href="#l59.135"></a><span id="l59.135">   let mc = mozmill.getMail3PaneController();</span>
<a href="#l59.136"></a><span id="l59.136"> </span>
<a href="#l59.137"></a><span id="l59.137">   // load something non-message-like in the message pane</span>
<a href="#l59.138"></a><span id="l59.138">   mc.window.GetMessagePaneFrame().location.href =</span>
<a href="#l59.139"></a><span id="l59.139" class="difflineminus">-    &quot;data:text/html;charset=utf-8,&lt;script&gt;var jsIsTurnedOn%3Dtrue%3B&lt;%2Fscript&gt;bar&quot;+</span>
<a href="#l59.140"></a><span id="l59.140" class="difflineplus">+    &quot;data:text/html;charset=utf-8,&lt;script&gt;var jsIsTurnedOn%3Dtrue%3B&lt;%2Fscript&gt;bar&quot; +</span>
<a href="#l59.141"></a><span id="l59.141">                                   &quot;&lt;noscript&gt;&lt;p id='noscript-p'&gt;hey this is noscript&lt;/p&gt;&quot;;</span>
<a href="#l59.142"></a><span id="l59.142"> </span>
<a href="#l59.143"></a><span id="l59.143">   wait_for_message_display_completion();</span>
<a href="#l59.144"></a><span id="l59.144"> </span>
<a href="#l59.145"></a><span id="l59.145">   if (!mc.window.content.wrappedJSObject.jsIsTurnedOn)</span>
<a href="#l59.146"></a><span id="l59.146">     throw new Error(&quot;JS is not turned on in content - it should be.&quot;);</span>
<a href="#l59.147"></a><span id="l59.147"> </span>
<a href="#l59.148"></a><span id="l59.148">   let noscript = mc.window.content.wrappedJSObject.document</span>
<a href="#l59.149"></a><span id="l59.149" class="difflineat">@@ -241,27 +240,25 @@ function checkJsInRemoteContent() {</span>
<a href="#l59.150"></a><span id="l59.150">   let noscript = mc.window.content.wrappedJSObject.document</span>
<a href="#l59.151"></a><span id="l59.151">                    .getElementsByTagName(&quot;noscript&quot;)[0];</span>
<a href="#l59.152"></a><span id="l59.152">   let display = mc.window.getComputedStyle(noscript).getPropertyValue(&quot;display&quot;);</span>
<a href="#l59.153"></a><span id="l59.153">   if (display != &quot;none&quot;)</span>
<a href="#l59.154"></a><span id="l59.154">     throw new Error(&quot;noscript display should be 'none'; display=&quot; + display);</span>
<a href="#l59.155"></a><span id="l59.155"> }</span>
<a href="#l59.156"></a><span id="l59.156"> </span>
<a href="#l59.157"></a><span id="l59.157"> function test_jsContentPolicy() {</span>
<a href="#l59.158"></a><span id="l59.158" class="difflineminus">-  let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l59.159"></a><span id="l59.159">   be_in_folder(folder);</span>
<a href="#l59.160"></a><span id="l59.160"> </span>
<a href="#l59.161"></a><span id="l59.161">   assert_nothing_selected();</span>
<a href="#l59.162"></a><span id="l59.162"> </span>
<a href="#l59.163"></a><span id="l59.163">   // run each test twice to ensure that there aren't any weird side effects,</span>
<a href="#l59.164"></a><span id="l59.164">   // given that these loads all happen in the same docshell</span>
<a href="#l59.165"></a><span id="l59.165"> </span>
<a href="#l59.166"></a><span id="l59.166">   checkJsInMail();</span>
<a href="#l59.167"></a><span id="l59.167">   checkJsInNonMessageContent();</span>
<a href="#l59.168"></a><span id="l59.168"> </span>
<a href="#l59.169"></a><span id="l59.169">   checkJsInMail();</span>
<a href="#l59.170"></a><span id="l59.170">   checkJsInNonMessageContent();</span>
<a href="#l59.171"></a><span id="l59.171"> </span>
<a href="#l59.172"></a><span id="l59.172">   checkJsInFeedContent();</span>
<a href="#l59.173"></a><span id="l59.173">   checkJsInRemoteContent();</span>
<a href="#l59.174"></a><span id="l59.174">   checkJsInFeedTab();</span>
<a href="#l59.175"></a><span id="l59.175" class="difflineminus">-</span>
<a href="#l59.176"></a><span id="l59.176"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-plugins-policy.js</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-plugins-policy.js</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -4,60 +4,68 @@</span>
<a href="#l60.4"></a><span id="l60.4"> </span>
<a href="#l60.5"></a><span id="l60.5"> /**</span>
<a href="#l60.6"></a><span id="l60.6">  * Checks if plugins are enabled in messages correctly or not.</span>
<a href="#l60.7"></a><span id="l60.7">  * As of bug 1508942, plugins are no longer enabled in any context.</span>
<a href="#l60.8"></a><span id="l60.8">  */</span>
<a href="#l60.9"></a><span id="l60.9"> </span>
<a href="#l60.10"></a><span id="l60.10"> &quot;use strict&quot;;</span>
<a href="#l60.11"></a><span id="l60.11"> </span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-var MODULE_NAME = 'test-plugins-policy';</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l60.15"></a><span id="l60.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l60.16"></a><span id="l60.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l60.17"></a><span id="l60.17"> </span>
<a href="#l60.18"></a><span id="l60.18" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l60.19"></a><span id="l60.19" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l60.20"></a><span id="l60.20" class="difflineminus">-                       'compose-helpers', 'content-tab-helpers'];</span>
<a href="#l60.21"></a><span id="l60.21" class="difflineplus">+var MODULE_NAME = &quot;test-plugins-policy&quot;;</span>
<a href="#l60.22"></a><span id="l60.22" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l60.23"></a><span id="l60.23" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l60.24"></a><span id="l60.24" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l60.25"></a><span id="l60.25" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l60.26"></a><span id="l60.26" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l60.27"></a><span id="l60.27" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l60.28"></a><span id="l60.28" class="difflineplus">+];</span>
<a href="#l60.29"></a><span id="l60.29"> </span>
<a href="#l60.30"></a><span id="l60.30"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l60.31"></a><span id="l60.31"> </span>
<a href="#l60.32"></a><span id="l60.32"> var folder = null;</span>
<a href="#l60.33"></a><span id="l60.33"> var composeHelper = null;</span>
<a href="#l60.34"></a><span id="l60.34"> var gMsgNo = 0;</span>
<a href="#l60.35"></a><span id="l60.35"> </span>
<a href="#l60.36"></a><span id="l60.36"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l60.37"></a><span id="l60.37"> // so we get the right path for the resources.</span>
<a href="#l60.38"></a><span id="l60.38" class="difflineminus">-var url = collector.addHttpResource('../content-policy/html', 'content');</span>
<a href="#l60.39"></a><span id="l60.39" class="difflineplus">+var url = collector.addHttpResource(&quot;../content-policy/html&quot;, &quot;content&quot;);</span>
<a href="#l60.40"></a><span id="l60.40"> </span>
<a href="#l60.41"></a><span id="l60.41"> // These two constants are used to build the message body.</span>
<a href="#l60.42"></a><span id="l60.42"> var msgBody = '&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;\n' +</span>
<a href="#l60.43"></a><span id="l60.43" class="difflineminus">-'&lt;html&gt;\n' +</span>
<a href="#l60.44"></a><span id="l60.44" class="difflineminus">-'&lt;head&gt;\n' +</span>
<a href="#l60.45"></a><span id="l60.45" class="difflineminus">-'\n' +</span>
<a href="#l60.46"></a><span id="l60.46" class="difflineplus">+&quot;&lt;html&gt;\n&quot; +</span>
<a href="#l60.47"></a><span id="l60.47" class="difflineplus">+&quot;&lt;head&gt;\n&quot; +</span>
<a href="#l60.48"></a><span id="l60.48" class="difflineplus">+&quot;\n&quot; +</span>
<a href="#l60.49"></a><span id="l60.49"> '&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=ISO-8859-1&quot;&gt;\n' +</span>
<a href="#l60.50"></a><span id="l60.50" class="difflineminus">-'&lt;/head&gt;\n' +</span>
<a href="#l60.51"></a><span id="l60.51" class="difflineplus">+&quot;&lt;/head&gt;\n&quot; +</span>
<a href="#l60.52"></a><span id="l60.52"> '&lt;body bgcolor=&quot;#ffffff&quot; text=&quot;#000000&quot;&gt;\n' +</span>
<a href="#l60.53"></a><span id="l60.53"> '&lt;embed id=&quot;testelement&quot; type=&quot;application/x-test&quot; width=&quot;400&quot; height=&quot;400&quot; border=&quot;1&quot;&gt;&lt;/embed&gt;\n' +</span>
<a href="#l60.54"></a><span id="l60.54" class="difflineminus">-'&lt;/body&gt;\n&lt;/html&gt;\n';</span>
<a href="#l60.55"></a><span id="l60.55" class="difflineplus">+&quot;&lt;/body&gt;\n&lt;/html&gt;\n&quot;;</span>
<a href="#l60.56"></a><span id="l60.56"> </span>
<a href="#l60.57"></a><span id="l60.57" class="difflineminus">-var setupModule = function (module) {</span>
<a href="#l60.58"></a><span id="l60.58" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l60.59"></a><span id="l60.59" class="difflineplus">+function setupModule(module) {</span>
<a href="#l60.60"></a><span id="l60.60" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l60.61"></a><span id="l60.61">   fdh.installInto(module);</span>
<a href="#l60.62"></a><span id="l60.62" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l60.63"></a><span id="l60.63" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l60.64"></a><span id="l60.64">   wh.installInto(module);</span>
<a href="#l60.65"></a><span id="l60.65" class="difflineminus">-  composeHelper = collector.getModule('compose-helpers');</span>
<a href="#l60.66"></a><span id="l60.66" class="difflineplus">+  composeHelper = collector.getModule(&quot;compose-helpers&quot;);</span>
<a href="#l60.67"></a><span id="l60.67">   composeHelper.installInto(module);</span>
<a href="#l60.68"></a><span id="l60.68" class="difflineminus">-  let cth = collector.getModule('content-tab-helpers');</span>
<a href="#l60.69"></a><span id="l60.69" class="difflineplus">+  let cth = collector.getModule(&quot;content-tab-helpers&quot;);</span>
<a href="#l60.70"></a><span id="l60.70">   cth.installInto(module);</span>
<a href="#l60.71"></a><span id="l60.71"> </span>
<a href="#l60.72"></a><span id="l60.72">   folder = create_folder(&quot;pluginPolicy&quot;);</span>
<a href="#l60.73"></a><span id="l60.73" class="difflineminus">-};</span>
<a href="#l60.74"></a><span id="l60.74" class="difflineplus">+}</span>
<a href="#l60.75"></a><span id="l60.75"> </span>
<a href="#l60.76"></a><span id="l60.76"> function addToFolder(aSubject, aBody, aFolder) {</span>
<a href="#l60.77"></a><span id="l60.77">   let msgId = Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l60.78"></a><span id="l60.78">                           .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l60.79"></a><span id="l60.79" class="difflineminus">-                          .generateUUID() +&quot;@mozillamessaging.invalid&quot;;</span>
<a href="#l60.80"></a><span id="l60.80" class="difflineplus">+                          .generateUUID() + &quot;@mozillamessaging.invalid&quot;;</span>
<a href="#l60.81"></a><span id="l60.81"> </span>
<a href="#l60.82"></a><span id="l60.82">   let source = &quot;From - Sat Nov  1 12:39:54 2008\n&quot; +</span>
<a href="#l60.83"></a><span id="l60.83"> </span>
<a href="#l60.84"></a><span id="l60.84">   &quot;X-Mozilla-Status: 0001\n&quot; +</span>
<a href="#l60.85"></a><span id="l60.85">                &quot;X-Mozilla-Status2: 00000000\n&quot; +</span>
<a href="#l60.86"></a><span id="l60.86">                &quot;Message-ID: &lt;&quot; + msgId + &quot;&gt;\n&quot; +</span>
<a href="#l60.87"></a><span id="l60.87">                &quot;Date: Wed, 11 Jun 2008 20:32:02 -0400\n&quot; +</span>
<a href="#l60.88"></a><span id="l60.88">                &quot;From: Tester &lt;tests@mozillamessaging.invalid&gt;\n&quot; +</span>
<a href="#l60.89"></a><span id="l60.89" class="difflineat">@@ -80,18 +88,17 @@ function addToFolder(aSubject, aBody, aF</span>
<a href="#l60.90"></a><span id="l60.90"> </span>
<a href="#l60.91"></a><span id="l60.91"> function isPluginLoaded(contentDocument) {</span>
<a href="#l60.92"></a><span id="l60.92">   let element = contentDocument.getElementById(&quot;testelement&quot;).wrappedJSObject;</span>
<a href="#l60.93"></a><span id="l60.93"> </span>
<a href="#l60.94"></a><span id="l60.94">   try {</span>
<a href="#l60.95"></a><span id="l60.95">     // if setColor throws, then the plugin isn't running</span>
<a href="#l60.96"></a><span id="l60.96">     element.setColor(&quot;FFFF0000&quot;);</span>
<a href="#l60.97"></a><span id="l60.97">     return true;</span>
<a href="#l60.98"></a><span id="l60.98" class="difflineminus">-  }</span>
<a href="#l60.99"></a><span id="l60.99" class="difflineminus">-  catch (ex) {</span>
<a href="#l60.100"></a><span id="l60.100" class="difflineplus">+  } catch (ex) {</span>
<a href="#l60.101"></a><span id="l60.101">     // Any errors and we'll just return false below - they may be expected.</span>
<a href="#l60.102"></a><span id="l60.102">   }</span>
<a href="#l60.103"></a><span id="l60.103">   return false;</span>
<a href="#l60.104"></a><span id="l60.104"> }</span>
<a href="#l60.105"></a><span id="l60.105"> </span>
<a href="#l60.106"></a><span id="l60.106"> function addMsgToFolderAndCheckContent(loadAllowed) {</span>
<a href="#l60.107"></a><span id="l60.107">   let msgDbHdr = addToFolder(&quot;Plugin test message &quot; + gMsgNo, msgBody, folder);</span>
<a href="#l60.108"></a><span id="l60.108"> </span>
<a href="#l60.109"></a><span id="l60.109" class="difflineat">@@ -164,22 +171,18 @@ function test_checkPluginsInNonMessageCo</span>
<a href="#l60.110"></a><span id="l60.110"> }</span>
<a href="#l60.111"></a><span id="l60.111"> </span>
<a href="#l60.112"></a><span id="l60.112"> function test_3paneWindowDeniedAgain() {</span>
<a href="#l60.113"></a><span id="l60.113">   select_click_row(0);</span>
<a href="#l60.114"></a><span id="l60.114"> </span>
<a href="#l60.115"></a><span id="l60.115">   assert_selected_and_displayed(0);</span>
<a href="#l60.116"></a><span id="l60.116"> </span>
<a href="#l60.117"></a><span id="l60.117">   // Now check that the content hasn't been loaded</span>
<a href="#l60.118"></a><span id="l60.118" class="difflineminus">-  if (isPluginLoaded(mozmill.getMail3PaneController().window</span>
<a href="#l60.119"></a><span id="l60.119" class="difflineminus">-                            .content.document) != false)</span>
<a href="#l60.120"></a><span id="l60.120" class="difflineminus">-    throw new Error(loadAllowed ?</span>
<a href="#l60.121"></a><span id="l60.121" class="difflineminus">-                    &quot;Plugin has been unexpectedly blocked in message content&quot; :</span>
<a href="#l60.122"></a><span id="l60.122" class="difflineminus">-                    &quot;Plugin has not been blocked in message as expected&quot;);</span>
<a href="#l60.123"></a><span id="l60.123" class="difflineminus">-</span>
<a href="#l60.124"></a><span id="l60.124" class="difflineplus">+  if (isPluginLoaded(mozmill.getMail3PaneController().window.content.document))</span>
<a href="#l60.125"></a><span id="l60.125" class="difflineplus">+    throw new Error(&quot;Plugin has not been blocked in message as expected&quot;);</span>
<a href="#l60.126"></a><span id="l60.126"> }</span>
<a href="#l60.127"></a><span id="l60.127"> </span>
<a href="#l60.128"></a><span id="l60.128"> function test_checkStandaloneMessageWindowDenied() {</span>
<a href="#l60.129"></a><span id="l60.129">   checkStandaloneMessageWindow(false);</span>
<a href="#l60.130"></a><span id="l60.130"> }</span>
<a href="#l60.131"></a><span id="l60.131"> </span>
<a href="#l60.132"></a><span id="l60.132"> function test_checkContentTab() {</span>
<a href="#l60.133"></a><span id="l60.133">   // To open a tab we're going to have to cheat and use tabmail so we can load</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-view-source.js</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mail/test/mozmill/content-policy/test-view-source.js</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -1,22 +1,22 @@</span>
<a href="#l61.4"></a><span id="l61.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l61.5"></a><span id="l61.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l61.6"></a><span id="l61.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l61.7"></a><span id="l61.7"> </span>
<a href="#l61.8"></a><span id="l61.8"> /**</span>
<a href="#l61.9"></a><span id="l61.9">  * Test that view-source content can be reloaded to change encoding.</span>
<a href="#l61.10"></a><span id="l61.10">  */</span>
<a href="#l61.11"></a><span id="l61.11"> </span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-// make SOLO_TEST=content-policy/test-view-source.js mozmill-one</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineminus">-</span>
<a href="#l61.14"></a><span id="l61.14"> &quot;use strict&quot;;</span>
<a href="#l61.15"></a><span id="l61.15"> </span>
<a href="#l61.16"></a><span id="l61.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l61.17"></a><span id="l61.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l61.18"></a><span id="l61.18" class="difflineplus">+</span>
<a href="#l61.19"></a><span id="l61.19"> var MODULE_NAME = &quot;test-view-source&quot;;</span>
<a href="#l61.20"></a><span id="l61.20" class="difflineminus">-</span>
<a href="#l61.21"></a><span id="l61.21"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l61.22"></a><span id="l61.22"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l61.23"></a><span id="l61.23"> </span>
<a href="#l61.24"></a><span id="l61.24"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l61.25"></a><span id="l61.25"> </span>
<a href="#l61.26"></a><span id="l61.26"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l61.27"></a><span id="l61.27"> </span>
<a href="#l61.28"></a><span id="l61.28"> var folder = null;</span>
<a href="#l61.29"></a><span id="l61.29" class="difflineat">@@ -27,17 +27,17 @@ function setupModule(module) {</span>
<a href="#l61.30"></a><span id="l61.30">   }</span>
<a href="#l61.31"></a><span id="l61.31"> </span>
<a href="#l61.32"></a><span id="l61.32">   folder = create_folder(&quot;viewsource&quot;);</span>
<a href="#l61.33"></a><span id="l61.33"> }</span>
<a href="#l61.34"></a><span id="l61.34"> </span>
<a href="#l61.35"></a><span id="l61.35"> function addToFolder(aSubject, aBody, aFolder) {</span>
<a href="#l61.36"></a><span id="l61.36">   let msgId = Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l61.37"></a><span id="l61.37">                           .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l61.38"></a><span id="l61.38" class="difflineminus">-                          .generateUUID() +&quot;@invalid&quot;;</span>
<a href="#l61.39"></a><span id="l61.39" class="difflineplus">+                          .generateUUID() + &quot;@invalid&quot;;</span>
<a href="#l61.40"></a><span id="l61.40"> </span>
<a href="#l61.41"></a><span id="l61.41">   let source = &quot;From - Sat Nov  1 12:39:54 2008\n&quot; +</span>
<a href="#l61.42"></a><span id="l61.42">                &quot;X-Mozilla-Status: 0001\n&quot; +</span>
<a href="#l61.43"></a><span id="l61.43">                &quot;X-Mozilla-Status2: 00000000\n&quot; +</span>
<a href="#l61.44"></a><span id="l61.44">                &quot;Message-ID: &lt;&quot; + msgId + &quot;&gt;\n&quot; +</span>
<a href="#l61.45"></a><span id="l61.45">                &quot;Date: Wed, 11 Jun 2008 20:32:02 -0400\n&quot; +</span>
<a href="#l61.46"></a><span id="l61.46">                &quot;From: Tester &lt;tests@mozillamessaging.invalid&gt;\n&quot; +</span>
<a href="#l61.47"></a><span id="l61.47">                &quot;MIME-Version: 1.0\n&quot; +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/html/test-lwthemes.html</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/html/test-lwthemes.html</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -4,26 +4,26 @@</span>
<a href="#l62.4"></a><span id="l62.4"> &lt;script&gt;</span>
<a href="#l62.5"></a><span id="l62.5"> var themes = [</span>
<a href="#l62.6"></a><span id="l62.6">   {</span>
<a href="#l62.7"></a><span id="l62.7">     id: &quot;test-01&quot;,</span>
<a href="#l62.8"></a><span id="l62.8">     name: &quot;Test 01&quot;,</span>
<a href="#l62.9"></a><span id="l62.9">     headerURL: &quot;test.png&quot;,</span>
<a href="#l62.10"></a><span id="l62.10">     footerURL: &quot;test.png&quot;,</span>
<a href="#l62.11"></a><span id="l62.11">     textcolor: &quot;#fff&quot;,</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-    accentcolor: &quot;#6b6b6b&quot;</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+    accentcolor: &quot;#6b6b6b&quot;,</span>
<a href="#l62.14"></a><span id="l62.14">   },</span>
<a href="#l62.15"></a><span id="l62.15">   {</span>
<a href="#l62.16"></a><span id="l62.16">     id: &quot;test-02&quot;,</span>
<a href="#l62.17"></a><span id="l62.17">     name: &quot;Test 02&quot;,</span>
<a href="#l62.18"></a><span id="l62.18">     headerURL: &quot;test.png&quot;,</span>
<a href="#l62.19"></a><span id="l62.19">     footerURL: &quot;test.png&quot;,</span>
<a href="#l62.20"></a><span id="l62.20">     textcolor: &quot;#bcf&quot;,</span>
<a href="#l62.21"></a><span id="l62.21" class="difflineminus">-    accentcolor: &quot;#8888FF&quot;</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineminus">-  }</span>
<a href="#l62.23"></a><span id="l62.23" class="difflineplus">+    accentcolor: &quot;#8888FF&quot;,</span>
<a href="#l62.24"></a><span id="l62.24" class="difflineplus">+  },</span>
<a href="#l62.25"></a><span id="l62.25"> ];</span>
<a href="#l62.26"></a><span id="l62.26"> </span>
<a href="#l62.27"></a><span id="l62.27"> const INSTALL = &quot;InstallBrowserTheme&quot;;</span>
<a href="#l62.28"></a><span id="l62.28"> const PREVIEW = &quot;PreviewBrowserTheme&quot;;</span>
<a href="#l62.29"></a><span id="l62.29"> const RESET_PREVIEW = &quot;ResetBrowserThemePreview&quot;;</span>
<a href="#l62.30"></a><span id="l62.30"> </span>
<a href="#l62.31"></a><span id="l62.31"> function setTheme(node, theme, action) {</span>
<a href="#l62.32"></a><span id="l62.32">   node.setAttribute(&quot;data-browsertheme&quot;, JSON.stringify(themes[theme]));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-about-support.js</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-about-support.js</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -1,21 +1,30 @@</span>
<a href="#l63.4"></a><span id="l63.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l63.5"></a><span id="l63.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l63.6"></a><span id="l63.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l63.7"></a><span id="l63.7"> </span>
<a href="#l63.8"></a><span id="l63.8"> &quot;use strict&quot;;</span>
<a href="#l63.9"></a><span id="l63.9"> </span>
<a href="#l63.10"></a><span id="l63.10" class="difflineminus">-var MODULE_NAME = 'test-about-support';</span>
<a href="#l63.11"></a><span id="l63.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l63.14"></a><span id="l63.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l63.15"></a><span id="l63.15"> </span>
<a href="#l63.16"></a><span id="l63.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l63.17"></a><span id="l63.17" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'content-tab-helpers',</span>
<a href="#l63.18"></a><span id="l63.18" class="difflineminus">-                       'compose-helpers', 'window-helpers'];</span>
<a href="#l63.19"></a><span id="l63.19" class="difflineplus">+var MODULE_NAME = &quot;test-about-support&quot;;</span>
<a href="#l63.20"></a><span id="l63.20" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l63.21"></a><span id="l63.21" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l63.22"></a><span id="l63.22" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l63.23"></a><span id="l63.23" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l63.24"></a><span id="l63.24" class="difflineplus">+  &quot;compose-helpers&quot;,</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l63.26"></a><span id="l63.26" class="difflineplus">+];</span>
<a href="#l63.27"></a><span id="l63.27"> </span>
<a href="#l63.28"></a><span id="l63.28"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l63.29"></a><span id="l63.29" class="difflineplus">+// eslint-disable-next-line mozilla/reject-importGlobalProperties</span>
<a href="#l63.30"></a><span id="l63.30"> Cu.importGlobalProperties([&quot;DOMParser&quot;]);</span>
<a href="#l63.31"></a><span id="l63.31"> </span>
<a href="#l63.32"></a><span id="l63.32"> var warningText = new Map();</span>
<a href="#l63.33"></a><span id="l63.33"> </span>
<a href="#l63.34"></a><span id="l63.34"> function setupModule(module) {</span>
<a href="#l63.35"></a><span id="l63.35">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l63.36"></a><span id="l63.36">     collector.getModule(lib).installInto(module);</span>
<a href="#l63.37"></a><span id="l63.37">   }</span>
<a href="#l63.38"></a><span id="l63.38" class="difflineat">@@ -106,17 +115,17 @@ function open_send_via_email(aTab) {</span>
<a href="#l63.39"></a><span id="l63.39"> function find_private_element(aTab) {</span>
<a href="#l63.40"></a><span id="l63.40">   // We use the identity name as an example of a private-only element.</span>
<a href="#l63.41"></a><span id="l63.41">   // It is currently the second td element with class=&quot;data-private&quot; in the table.</span>
<a href="#l63.42"></a><span id="l63.42">   // The content string must be something unique that is not found anywhere else.</span>
<a href="#l63.43"></a><span id="l63.43">   let elem = aTab.browser.contentDocument</span>
<a href="#l63.44"></a><span id="l63.44">                  .querySelector(&quot;#accounts-table td.data-private~td.data-private&quot;);</span>
<a href="#l63.45"></a><span id="l63.45">   assert_true(elem != null);</span>
<a href="#l63.46"></a><span id="l63.46">   assert_true(elem.textContent.length &gt; 0);</span>
<a href="#l63.47"></a><span id="l63.47" class="difflineminus">-  assert_equals(get_content_tab_element_display(aTab,elem), &quot;none&quot;);</span>
<a href="#l63.48"></a><span id="l63.48" class="difflineplus">+  assert_equals(get_content_tab_element_display(aTab, elem), &quot;none&quot;);</span>
<a href="#l63.49"></a><span id="l63.49">   return elem;</span>
<a href="#l63.50"></a><span id="l63.50"> }</span>
<a href="#l63.51"></a><span id="l63.51"> </span>
<a href="#l63.52"></a><span id="l63.52"> /*</span>
<a href="#l63.53"></a><span id="l63.53">  * Tests</span>
<a href="#l63.54"></a><span id="l63.54">  */</span>
<a href="#l63.55"></a><span id="l63.55"> </span>
<a href="#l63.56"></a><span id="l63.56"> /**</span>
<a href="#l63.57"></a><span id="l63.57" class="difflineat">@@ -253,18 +262,17 @@ function test_private_data() {</span>
<a href="#l63.58"></a><span id="l63.58">  * If it is plain text string, just check in text is anywhere in it.</span>
<a href="#l63.59"></a><span id="l63.59">  *</span>
<a href="#l63.60"></a><span id="l63.60">  * @param aDocument  A node tree or a string of plain text data.</span>
<a href="#l63.61"></a><span id="l63.61">  * @param aText      The text to find in the document.</span>
<a href="#l63.62"></a><span id="l63.62">  */</span>
<a href="#l63.63"></a><span id="l63.63"> function check_text_in_body(aDocument, aText) {</span>
<a href="#l63.64"></a><span id="l63.64">   if (typeof(aDocument) == &quot;object&quot;)</span>
<a href="#l63.65"></a><span id="l63.65">     return (get_element_by_text(aDocument, aText) != null);</span>
<a href="#l63.66"></a><span id="l63.66" class="difflineminus">-  else</span>
<a href="#l63.67"></a><span id="l63.67" class="difflineminus">-    return aDocument.includes(aText);</span>
<a href="#l63.68"></a><span id="l63.68" class="difflineplus">+  return aDocument.includes(aText);</span>
<a href="#l63.69"></a><span id="l63.69"> }</span>
<a href="#l63.70"></a><span id="l63.70"> </span>
<a href="#l63.71"></a><span id="l63.71"> /**</span>
<a href="#l63.72"></a><span id="l63.72">  * Test (well, sort of) the copy to clipboard function with public data.</span>
<a href="#l63.73"></a><span id="l63.73">  */</span>
<a href="#l63.74"></a><span id="l63.74"> function test_copy_to_clipboard_public() {</span>
<a href="#l63.75"></a><span id="l63.75">   let tab = open_about_support();</span>
<a href="#l63.76"></a><span id="l63.76">   let privateElem = find_private_element(tab);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-addons-mgr.js</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-addons-mgr.js</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -1,47 +1,47 @@</span>
<a href="#l64.4"></a><span id="l64.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l64.5"></a><span id="l64.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l64.6"></a><span id="l64.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l64.7"></a><span id="l64.7"> </span>
<a href="#l64.8"></a><span id="l64.8" class="difflineminus">-// make SOLO_TEST=content-tabs/test-addons-mgr.js mozmill-one</span>
<a href="#l64.9"></a><span id="l64.9" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l64.10"></a><span id="l64.10"> </span>
<a href="#l64.11"></a><span id="l64.11" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l64.15"></a><span id="l64.15"> </span>
<a href="#l64.16"></a><span id="l64.16"> var MODULE_NAME = &quot;test-addons-mgr&quot;;</span>
<a href="#l64.17"></a><span id="l64.17" class="difflineminus">-</span>
<a href="#l64.18"></a><span id="l64.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l64.19"></a><span id="l64.19" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;content-tab-helpers&quot;,</span>
<a href="#l64.20"></a><span id="l64.20" class="difflineminus">-                       &quot;window-helpers&quot;];</span>
<a href="#l64.21"></a><span id="l64.21" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;content-tab-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l64.22"></a><span id="l64.22"> </span>
<a href="#l64.23"></a><span id="l64.23"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l64.24"></a><span id="l64.24"> </span>
<a href="#l64.25"></a><span id="l64.25"> function setupModule(module) {</span>
<a href="#l64.26"></a><span id="l64.26">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l64.27"></a><span id="l64.27">     collector.getModule(lib).installInto(module);</span>
<a href="#l64.28"></a><span id="l64.28">   }</span>
<a href="#l64.29"></a><span id="l64.29"> }</span>
<a href="#l64.30"></a><span id="l64.30"> </span>
<a href="#l64.31"></a><span id="l64.31"> function test_open_addons_with_url() {</span>
<a href="#l64.32"></a><span id="l64.32" class="difflineminus">-  mc.window.openAddonsMgr('addons://list/theme');</span>
<a href="#l64.33"></a><span id="l64.33" class="difflineplus">+  mc.window.openAddonsMgr(&quot;addons://list/theme&quot;);</span>
<a href="#l64.34"></a><span id="l64.34">   mc.sleep(0);</span>
<a href="#l64.35"></a><span id="l64.35"> </span>
<a href="#l64.36"></a><span id="l64.36">   let tab = mc.tabmail.currentTabInfo;</span>
<a href="#l64.37"></a><span id="l64.37" class="difflineminus">-  wait_for_content_tab_load(tab, 'about:addons', 10000);</span>
<a href="#l64.38"></a><span id="l64.38" class="difflineminus">-  assert_true(content_tab_e(tab, 'category-theme').selected,</span>
<a href="#l64.39"></a><span id="l64.39" class="difflineplus">+  wait_for_content_tab_load(tab, &quot;about:addons&quot;, 10000);</span>
<a href="#l64.40"></a><span id="l64.40" class="difflineplus">+  assert_true(content_tab_e(tab, &quot;category-theme&quot;).selected,</span>
<a href="#l64.41"></a><span id="l64.41">               &quot;Themes category should be selected!&quot;);</span>
<a href="#l64.42"></a><span id="l64.42"> </span>
<a href="#l64.43"></a><span id="l64.43">   mc.tabmail.switchToTab(0); // switch to 3pane</span>
<a href="#l64.44"></a><span id="l64.44"> </span>
<a href="#l64.45"></a><span id="l64.45" class="difflineminus">-  mc.window.openAddonsMgr('addons://list/plugin');</span>
<a href="#l64.46"></a><span id="l64.46" class="difflineplus">+  mc.window.openAddonsMgr(&quot;addons://list/plugin&quot;);</span>
<a href="#l64.47"></a><span id="l64.47">   mc.sleep(0);</span>
<a href="#l64.48"></a><span id="l64.48"> </span>
<a href="#l64.49"></a><span id="l64.49">   tab = mc.tabmail.currentTabInfo;</span>
<a href="#l64.50"></a><span id="l64.50" class="difflineminus">-  wait_for_content_tab_load(tab, 'about:addons', 10000);</span>
<a href="#l64.51"></a><span id="l64.51" class="difflineminus">-  assert_true(content_tab_e(tab, 'category-plugin').selected,</span>
<a href="#l64.52"></a><span id="l64.52" class="difflineplus">+  wait_for_content_tab_load(tab, &quot;about:addons&quot;, 10000);</span>
<a href="#l64.53"></a><span id="l64.53" class="difflineplus">+  assert_true(content_tab_e(tab, &quot;category-plugin&quot;).selected,</span>
<a href="#l64.54"></a><span id="l64.54">               &quot;Plugins category should be selected!&quot;);</span>
<a href="#l64.55"></a><span id="l64.55"> </span>
<a href="#l64.56"></a><span id="l64.56">   mc.tabmail.closeTab(tab);</span>
<a href="#l64.57"></a><span id="l64.57"> }</span>
<a href="#l64.58"></a><span id="l64.58"> </span>
<a href="#l64.59"></a><span id="l64.59"> /**</span>
<a href="#l64.60"></a><span id="l64.60">  * Bug 1462923</span>
<a href="#l64.61"></a><span id="l64.61">  * Check if the &quot;Tools-&gt;Add-on Options&quot; menu item works and shows our add-on.</span>
<a href="#l64.62"></a><span id="l64.62" class="difflineat">@@ -49,23 +49,23 @@ function test_open_addons_with_url() {</span>
<a href="#l64.63"></a><span id="l64.63">  * however simplistic the preferences XUL document may be.</span>
<a href="#l64.64"></a><span id="l64.64">  */</span>
<a href="#l64.65"></a><span id="l64.65"> function test_addon_prefs() {</span>
<a href="#l64.66"></a><span id="l64.66">   // Open Add-on Options.</span>
<a href="#l64.67"></a><span id="l64.67">   mc.click(mc.eid(&quot;button-appmenu&quot;));</span>
<a href="#l64.68"></a><span id="l64.68">   let popups = mc.click_menus_in_sequence(mc.e(&quot;appmenu-popup&quot;), [ { id: &quot;appmenu_addons&quot; } ], true);</span>
<a href="#l64.69"></a><span id="l64.69"> </span>
<a href="#l64.70"></a><span id="l64.70">   let foundAddon = false;</span>
<a href="#l64.71"></a><span id="l64.71" class="difflineminus">-  plan_for_modal_dialog(&quot;mozmill-prefs&quot;, function (controller) {</span>
<a href="#l64.72"></a><span id="l64.72" class="difflineplus">+  plan_for_modal_dialog(&quot;mozmill-prefs&quot;, function(controller) {</span>
<a href="#l64.73"></a><span id="l64.73">      // Add |mc.sleep(1000);| here to see the popup dialog.</span>
<a href="#l64.74"></a><span id="l64.74">     controller.window.close();</span>
<a href="#l64.75"></a><span id="l64.75">   });</span>
<a href="#l64.76"></a><span id="l64.76"> </span>
<a href="#l64.77"></a><span id="l64.77">   // MozMill add-on should be somewhere in the list. When found, click it.</span>
<a href="#l64.78"></a><span id="l64.78" class="difflineminus">-  for (let item of popups[popups.length-1].children) {</span>
<a href="#l64.79"></a><span id="l64.79" class="difflineplus">+  for (let item of popups[popups.length - 1].children) {</span>
<a href="#l64.80"></a><span id="l64.80">     if (item.tagName == &quot;menuitem&quot; &amp;&amp; item.getAttribute(&quot;collapsed&quot;) != &quot;true&quot; &amp;&amp;</span>
<a href="#l64.81"></a><span id="l64.81">         item.label == &quot;MozMill&quot;) {</span>
<a href="#l64.82"></a><span id="l64.82">       foundAddon = true;</span>
<a href="#l64.83"></a><span id="l64.83">       mc.click(new elib.Elem(item));</span>
<a href="#l64.84"></a><span id="l64.84">       break;</span>
<a href="#l64.85"></a><span id="l64.85">     }</span>
<a href="#l64.86"></a><span id="l64.86">   }</span>
<a href="#l64.87"></a><span id="l64.87">   assert_true(foundAddon);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-content-tab.js</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-content-tab.js</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -1,30 +1,38 @@</span>
<a href="#l65.4"></a><span id="l65.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l65.5"></a><span id="l65.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l65.6"></a><span id="l65.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l65.7"></a><span id="l65.7"> </span>
<a href="#l65.8"></a><span id="l65.8"> &quot;use strict&quot;;</span>
<a href="#l65.9"></a><span id="l65.9"> </span>
<a href="#l65.10"></a><span id="l65.10" class="difflineminus">-var MODULE_NAME = 'test-content-tab';</span>
<a href="#l65.11"></a><span id="l65.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-dom-helpers.js */</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l65.14"></a><span id="l65.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l65.15"></a><span id="l65.15"> </span>
<a href="#l65.16"></a><span id="l65.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l65.17"></a><span id="l65.17" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'content-tab-helpers',</span>
<a href="#l65.18"></a><span id="l65.18" class="difflineminus">-                       'dom-helpers', 'window-helpers'];</span>
<a href="#l65.19"></a><span id="l65.19" class="difflineplus">+var MODULE_NAME = &quot;test-content-tab&quot;;</span>
<a href="#l65.20"></a><span id="l65.20" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l65.21"></a><span id="l65.21" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l65.23"></a><span id="l65.23" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l65.24"></a><span id="l65.24" class="difflineplus">+  &quot;dom-helpers&quot;,</span>
<a href="#l65.25"></a><span id="l65.25" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l65.26"></a><span id="l65.26" class="difflineplus">+];</span>
<a href="#l65.27"></a><span id="l65.27"> </span>
<a href="#l65.28"></a><span id="l65.28"> var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l65.29"></a><span id="l65.29"> var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.jsm&quot;);</span>
<a href="#l65.30"></a><span id="l65.30"> var elementslib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l65.31"></a><span id="l65.31"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l65.32"></a><span id="l65.32"> </span>
<a href="#l65.33"></a><span id="l65.33"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l65.34"></a><span id="l65.34"> // so we get the right path for the resources.</span>
<a href="#l65.35"></a><span id="l65.35"> // Note: this one adds to '' as we need to make sure that favicon.ico is in the</span>
<a href="#l65.36"></a><span id="l65.36"> // root directory.</span>
<a href="#l65.37"></a><span id="l65.37" class="difflineminus">-var url = collector.addHttpResource('../content-tabs/html', '');</span>
<a href="#l65.38"></a><span id="l65.38" class="difflineplus">+var url = collector.addHttpResource(&quot;../content-tabs/html&quot;, &quot;&quot;);</span>
<a href="#l65.39"></a><span id="l65.39"> var whatsUrl = url + &quot;whatsnew.html&quot;;</span>
<a href="#l65.40"></a><span id="l65.40"> </span>
<a href="#l65.41"></a><span id="l65.41"> function setupModule(module) {</span>
<a href="#l65.42"></a><span id="l65.42">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l65.43"></a><span id="l65.43">     collector.getModule(lib).installInto(module);</span>
<a href="#l65.44"></a><span id="l65.44">   }</span>
<a href="#l65.45"></a><span id="l65.45"> }</span>
<a href="#l65.46"></a><span id="l65.46"> </span>
<a href="#l65.47"></a><span id="l65.47" class="difflineat">@@ -143,25 +151,25 @@ function test_content_tab_default_favico</span>
<a href="#l65.48"></a><span id="l65.48">   assert_tab_has_title(tab, &quot;What's New Content Test 1&quot;);</span>
<a href="#l65.49"></a><span id="l65.49">   // Check the location of the favicon, this should be the site favicon in this</span>
<a href="#l65.50"></a><span id="l65.50">   // test.</span>
<a href="#l65.51"></a><span id="l65.51">   assert_content_tab_has_favicon(tab, url + &quot;favicon.ico&quot;);</span>
<a href="#l65.52"></a><span id="l65.52"> }</span>
<a href="#l65.53"></a><span id="l65.53"> </span>
<a href="#l65.54"></a><span id="l65.54"> function test_content_tab_onbeforeunload() {</span>
<a href="#l65.55"></a><span id="l65.55">   let count = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l65.56"></a><span id="l65.56" class="difflineminus">-  let tab = mc.tabmail.tabInfo[count-1];</span>
<a href="#l65.57"></a><span id="l65.57" class="difflineminus">-  tab.browser.contentWindow.addEventListener(&quot;beforeunload&quot;, function (event) {</span>
<a href="#l65.58"></a><span id="l65.58" class="difflineplus">+  let tab = mc.tabmail.tabInfo[count - 1];</span>
<a href="#l65.59"></a><span id="l65.59" class="difflineplus">+  tab.browser.contentWindow.addEventListener(&quot;beforeunload&quot;, function(event) {</span>
<a href="#l65.60"></a><span id="l65.60">     event.returnValue = &quot;Green llama in your car&quot;;</span>
<a href="#l65.61"></a><span id="l65.61">   });</span>
<a href="#l65.62"></a><span id="l65.62"> </span>
<a href="#l65.63"></a><span id="l65.63">   const interactionPref = &quot;dom.require_user_interaction_for_beforeunload&quot;;</span>
<a href="#l65.64"></a><span id="l65.64">   Services.prefs.setBoolPref(interactionPref, false);</span>
<a href="#l65.65"></a><span id="l65.65"> </span>
<a href="#l65.66"></a><span id="l65.66" class="difflineminus">-  plan_for_modal_dialog(&quot;commonDialog&quot;, function (controller) {</span>
<a href="#l65.67"></a><span id="l65.67" class="difflineplus">+  plan_for_modal_dialog(&quot;commonDialog&quot;, function(controller) {</span>
<a href="#l65.68"></a><span id="l65.68">     controller.window.document.documentElement.getButton(&quot;accept&quot;).doCommand();</span>
<a href="#l65.69"></a><span id="l65.69">   });</span>
<a href="#l65.70"></a><span id="l65.70">   mc.tabmail.closeTab(tab);</span>
<a href="#l65.71"></a><span id="l65.71">   wait_for_modal_dialog();</span>
<a href="#l65.72"></a><span id="l65.72"> </span>
<a href="#l65.73"></a><span id="l65.73">   Services.prefs.clearUserPref(interactionPref);</span>
<a href="#l65.74"></a><span id="l65.74"> }</span>
<a href="#l65.75"></a><span id="l65.75"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-install-xpi.js</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mail/test/mozmill/content-tabs/test-install-xpi.js</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -1,44 +1,46 @@</span>
<a href="#l66.4"></a><span id="l66.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l66.5"></a><span id="l66.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l66.6"></a><span id="l66.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l66.7"></a><span id="l66.7"> </span>
<a href="#l66.8"></a><span id="l66.8"> &quot;use strict&quot;;</span>
<a href="#l66.9"></a><span id="l66.9"> </span>
<a href="#l66.10"></a><span id="l66.10" class="difflineminus">-var MODULE_NAME = 'test-install-xpi';</span>
<a href="#l66.11"></a><span id="l66.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l66.14"></a><span id="l66.14"> </span>
<a href="#l66.15"></a><span id="l66.15" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l66.16"></a><span id="l66.16" class="difflineminus">-var MODULE_REQUIRES = ['window-helpers', 'folder-display-helpers',</span>
<a href="#l66.17"></a><span id="l66.17" class="difflineminus">-                       'content-tab-helpers'];</span>
<a href="#l66.18"></a><span id="l66.18" class="difflineplus">+var MODULE_NAME = &quot;test-install-xpi&quot;;</span>
<a href="#l66.19"></a><span id="l66.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l66.20"></a><span id="l66.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;window-helpers&quot;, &quot;folder-display-helpers&quot;, &quot;content-tab-helpers&quot;];</span>
<a href="#l66.21"></a><span id="l66.21"> </span>
<a href="#l66.22"></a><span id="l66.22"> var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l66.23"></a><span id="l66.23"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l66.24"></a><span id="l66.24"> var mozmill = ChromeUtils.import(&quot;chrome://mozmill/content/modules/mozmill.jsm&quot;);</span>
<a href="#l66.25"></a><span id="l66.25"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l66.26"></a><span id="l66.26"> </span>
<a href="#l66.27"></a><span id="l66.27"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l66.28"></a><span id="l66.28"> // so we get the right path for the resources.</span>
<a href="#l66.29"></a><span id="l66.29" class="difflineminus">-var url = collector.addHttpResource('../content-tabs/html', 'content-tabs');</span>
<a href="#l66.30"></a><span id="l66.30" class="difflineplus">+var url = collector.addHttpResource(&quot;../content-tabs/html&quot;, &quot;content-tabs&quot;);</span>
<a href="#l66.31"></a><span id="l66.31"> </span>
<a href="#l66.32"></a><span id="l66.32"> var gDocument;</span>
<a href="#l66.33"></a><span id="l66.33"> var gNewTab;</span>
<a href="#l66.34"></a><span id="l66.34"> </span>
<a href="#l66.35"></a><span id="l66.35" class="difflineminus">-var setupModule = function (module) {</span>
<a href="#l66.36"></a><span id="l66.36" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l66.37"></a><span id="l66.37" class="difflineplus">+function setupModule(module) {</span>
<a href="#l66.38"></a><span id="l66.38" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l66.39"></a><span id="l66.39">   wh.installInto(module);</span>
<a href="#l66.40"></a><span id="l66.40" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l66.41"></a><span id="l66.41" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l66.42"></a><span id="l66.42">   fdh.installInto(module);</span>
<a href="#l66.43"></a><span id="l66.43" class="difflineminus">-  let cth = collector.getModule('content-tab-helpers');</span>
<a href="#l66.44"></a><span id="l66.44" class="difflineplus">+  let cth = collector.getModule(&quot;content-tab-helpers&quot;);</span>
<a href="#l66.45"></a><span id="l66.45">   cth.installInto(module);</span>
<a href="#l66.46"></a><span id="l66.46"> </span>
<a href="#l66.47"></a><span id="l66.47">   gDocument = mc.window.document;</span>
<a href="#l66.48"></a><span id="l66.48">   gNewTab = open_content_tab_with_url(url + &quot;installxpi.html&quot;,</span>
<a href="#l66.49"></a><span id="l66.49">       &quot;specialTabs.siteClickHandler(event, new RegExp('^&quot; + url + &quot;'));&quot;);</span>
<a href="#l66.50"></a><span id="l66.50" class="difflineminus">-};</span>
<a href="#l66.51"></a><span id="l66.51" class="difflineplus">+}</span>
<a href="#l66.52"></a><span id="l66.52"> </span>
<a href="#l66.53"></a><span id="l66.53"> var teardownModule = function(module) {</span>
<a href="#l66.54"></a><span id="l66.54">   mc.tabmail.closeTab(gNewTab);</span>
<a href="#l66.55"></a><span id="l66.55"> };</span>
<a href="#l66.56"></a><span id="l66.56"> </span>
<a href="#l66.57"></a><span id="l66.57"> function waitForNotification(id, buttonToClickSelector, callback) {</span>
<a href="#l66.58"></a><span id="l66.58">   let path = `</span>
<a href="#l66.59"></a><span id="l66.59">     /id(&quot;messengerWindow&quot;)/id(&quot;mainPopupSet&quot;)/id(&quot;notification-popup&quot;)/id(&quot;${id}-notification&quot;)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mail/test/mozmill/cookies/test-cookies.js</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mail/test/mozmill/cookies/test-cookies.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -5,29 +5,32 @@</span>
<a href="#l67.4"></a><span id="l67.4"> /**</span>
<a href="#l67.5"></a><span id="l67.5">  * Test file to check that cookies are correctly enabled in Thunderbird.</span>
<a href="#l67.6"></a><span id="l67.6">  *</span>
<a href="#l67.7"></a><span id="l67.7">  * XXX: Still need to check remote content in messages.</span>
<a href="#l67.8"></a><span id="l67.8">  */</span>
<a href="#l67.9"></a><span id="l67.9"> </span>
<a href="#l67.10"></a><span id="l67.10"> &quot;use strict&quot;;</span>
<a href="#l67.11"></a><span id="l67.11"> </span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-var MODULE_NAME = 'test-cookies';</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l67.14"></a><span id="l67.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l67.15"></a><span id="l67.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l67.16"></a><span id="l67.16"> </span>
<a href="#l67.17"></a><span id="l67.17" class="difflineplus">+var MODULE_NAME = &quot;test-cookies&quot;;</span>
<a href="#l67.18"></a><span id="l67.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l67.19"></a><span id="l67.19" class="difflineminus">-var MODULE_REQUIRES = ['window-helpers', 'content-tab-helpers', 'folder-display-helpers'];</span>
<a href="#l67.20"></a><span id="l67.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;window-helpers&quot;, &quot;content-tab-helpers&quot;, &quot;folder-display-helpers&quot;];</span>
<a href="#l67.21"></a><span id="l67.21"> </span>
<a href="#l67.22"></a><span id="l67.22"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l67.23"></a><span id="l67.23"> // so we get the right path for the resources.</span>
<a href="#l67.24"></a><span id="l67.24" class="difflineminus">-var url = collector.addHttpResource('../cookies/html', 'cookies');</span>
<a href="#l67.25"></a><span id="l67.25" class="difflineplus">+var url = collector.addHttpResource(&quot;../cookies/html&quot;, &quot;cookies&quot;);</span>
<a href="#l67.26"></a><span id="l67.26"> </span>
<a href="#l67.27"></a><span id="l67.27"> function setupModule(module) {</span>
<a href="#l67.28"></a><span id="l67.28">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l67.29"></a><span id="l67.29">   fdh.installInto(module);</span>
<a href="#l67.30"></a><span id="l67.30" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l67.31"></a><span id="l67.31" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l67.32"></a><span id="l67.32">   wh.installInto(module);</span>
<a href="#l67.33"></a><span id="l67.33">   let cth = collector.getModule(&quot;content-tab-helpers&quot;);</span>
<a href="#l67.34"></a><span id="l67.34">   cth.installInto(module);</span>
<a href="#l67.35"></a><span id="l67.35"> }</span>
<a href="#l67.36"></a><span id="l67.36"> </span>
<a href="#l67.37"></a><span id="l67.37"> /**</span>
<a href="#l67.38"></a><span id="l67.38">  * Test deleting junk messages with no messages marked as junk.</span>
<a href="#l67.39"></a><span id="l67.39">  */</span>
<a href="#l67.40"></a><span id="l67.40" class="difflineat">@@ -44,10 +47,10 @@ function test_load_cookie_result_page() </span>
<a href="#l67.41"></a><span id="l67.41">   let cookie = mc.window.content.wrappedJSObject.theCookie;</span>
<a href="#l67.42"></a><span id="l67.42"> </span>
<a href="#l67.43"></a><span id="l67.43">   dump(&quot;Cookie is: &quot; + cookie + &quot;\n&quot;);</span>
<a href="#l67.44"></a><span id="l67.44"> </span>
<a href="#l67.45"></a><span id="l67.45">   if (!cookie)</span>
<a href="#l67.46"></a><span id="l67.46">     throw new Error(&quot;Document has no cookie :-(&quot;);</span>
<a href="#l67.47"></a><span id="l67.47"> </span>
<a href="#l67.48"></a><span id="l67.48">   if (cookie != &quot;name=CookieTest&quot;)</span>
<a href="#l67.49"></a><span id="l67.49" class="difflineminus">-    throw new Error(&quot;Cookie set incorrectly, expected: name=CookieTest, got: &quot; +cookie + &quot;\n&quot;);</span>
<a href="#l67.50"></a><span id="l67.50" class="difflineplus">+    throw new Error(&quot;Cookie set incorrectly, expected: name=CookieTest, got: &quot; + cookie + &quot;\n&quot;);</span>
<a href="#l67.51"></a><span id="l67.51"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mail/test/mozmill/downloads/test-about-downloads.js</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mail/test/mozmill/downloads/test-about-downloads.js</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -1,29 +1,35 @@</span>
<a href="#l68.4"></a><span id="l68.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l68.5"></a><span id="l68.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l68.6"></a><span id="l68.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l68.7"></a><span id="l68.7"> </span>
<a href="#l68.8"></a><span id="l68.8"> /**</span>
<a href="#l68.9"></a><span id="l68.9">  * Test about:downloads.</span>
<a href="#l68.10"></a><span id="l68.10">  */</span>
<a href="#l68.11"></a><span id="l68.11"> </span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-// make SOLO_TEST=downloads/test-about-downloads.js mozmill-one</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l68.14"></a><span id="l68.14"> </span>
<a href="#l68.15"></a><span id="l68.15" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l68.16"></a><span id="l68.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-attachment-helpers.js */</span>
<a href="#l68.17"></a><span id="l68.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l68.18"></a><span id="l68.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-dom-helpers.js */</span>
<a href="#l68.19"></a><span id="l68.19" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l68.20"></a><span id="l68.20" class="difflineplus">+/* import-globals-from ../shared-modules/test-prompt-helpers.js */</span>
<a href="#l68.21"></a><span id="l68.21" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l68.22"></a><span id="l68.22"> </span>
<a href="#l68.23"></a><span id="l68.23"> var MODULE_NAME = &quot;test-about-downloads&quot;;</span>
<a href="#l68.24"></a><span id="l68.24" class="difflineminus">-</span>
<a href="#l68.25"></a><span id="l68.25"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l68.26"></a><span id="l68.26" class="difflineminus">-var MODULE_REQUIRES = [ 'attachment-helpers',</span>
<a href="#l68.27"></a><span id="l68.27" class="difflineminus">-                        'content-tab-helpers',</span>
<a href="#l68.28"></a><span id="l68.28" class="difflineminus">-                        'dom-helpers',</span>
<a href="#l68.29"></a><span id="l68.29" class="difflineminus">-                        'folder-display-helpers',</span>
<a href="#l68.30"></a><span id="l68.30" class="difflineminus">-                        'prompt-helpers',</span>
<a href="#l68.31"></a><span id="l68.31" class="difflineminus">-                        'window-helpers' ];</span>
<a href="#l68.32"></a><span id="l68.32" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l68.33"></a><span id="l68.33" class="difflineplus">+  &quot;attachment-helpers&quot;,</span>
<a href="#l68.34"></a><span id="l68.34" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l68.35"></a><span id="l68.35" class="difflineplus">+  &quot;dom-helpers&quot;,</span>
<a href="#l68.36"></a><span id="l68.36" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l68.37"></a><span id="l68.37" class="difflineplus">+  &quot;prompt-helpers&quot;,</span>
<a href="#l68.38"></a><span id="l68.38" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l68.39"></a><span id="l68.39" class="difflineplus">+];</span>
<a href="#l68.40"></a><span id="l68.40"> </span>
<a href="#l68.41"></a><span id="l68.41"> var elementslib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l68.42"></a><span id="l68.42"> var downloads = ChromeUtils.import(&quot;resource://gre/modules/Downloads.jsm&quot;);</span>
<a href="#l68.43"></a><span id="l68.43"> </span>
<a href="#l68.44"></a><span id="l68.44"> var downloadsTab;</span>
<a href="#l68.45"></a><span id="l68.45"> </span>
<a href="#l68.46"></a><span id="l68.46"> var attachmentFileNames = [</span>
<a href="#l68.47"></a><span id="l68.47">   &quot;Attachment#1.txt&quot;,</span>
<a href="#l68.48"></a><span id="l68.48" class="difflineat">@@ -57,43 +63,43 @@ var downloadsView = {</span>
<a href="#l68.49"></a><span id="l68.49">     let succeededPromises = [];</span>
<a href="#l68.50"></a><span id="l68.50">     for (let download of this.items.keys()) {</span>
<a href="#l68.51"></a><span id="l68.51">       let succeededPromise = download.whenSucceeded();</span>
<a href="#l68.52"></a><span id="l68.52">       succeededPromises.push(succeededPromise);</span>
<a href="#l68.53"></a><span id="l68.53">     }</span>
<a href="#l68.54"></a><span id="l68.54">     let finished = false;</span>
<a href="#l68.55"></a><span id="l68.55">     Promise.all(succeededPromises).then(() =&gt; finished = true, Cu.reportError);</span>
<a href="#l68.56"></a><span id="l68.56">     mc.waitFor(() =&gt; finished, &quot;Timeout waiting for downloads to complete.&quot;);</span>
<a href="#l68.57"></a><span id="l68.57" class="difflineminus">-  }</span>
<a href="#l68.58"></a><span id="l68.58" class="difflineplus">+  },</span>
<a href="#l68.59"></a><span id="l68.59"> };</span>
<a href="#l68.60"></a><span id="l68.60"> </span>
<a href="#l68.61"></a><span id="l68.61"> function prepare_messages() {</span>
<a href="#l68.62"></a><span id="l68.62">   let folder = create_folder(&quot;about:downloads&quot;);</span>
<a href="#l68.63"></a><span id="l68.63" class="difflineminus">-  let msgSet = make_new_sets_in_folder(folder, [</span>
<a href="#l68.64"></a><span id="l68.64" class="difflineplus">+  make_new_sets_in_folder(folder, [</span>
<a href="#l68.65"></a><span id="l68.65">     {</span>
<a href="#l68.66"></a><span id="l68.66">       count: 1,</span>
<a href="#l68.67"></a><span id="l68.67">       attachments: [{</span>
<a href="#l68.68"></a><span id="l68.68">         filename: attachmentFileNames[0],</span>
<a href="#l68.69"></a><span id="l68.69" class="difflineminus">-        body: &quot;Body&quot;</span>
<a href="#l68.70"></a><span id="l68.70" class="difflineminus">-      }]</span>
<a href="#l68.71"></a><span id="l68.71" class="difflineplus">+        body: &quot;Body&quot;,</span>
<a href="#l68.72"></a><span id="l68.72" class="difflineplus">+      }],</span>
<a href="#l68.73"></a><span id="l68.73">     },</span>
<a href="#l68.74"></a><span id="l68.74">     {</span>
<a href="#l68.75"></a><span id="l68.75">       count: 1,</span>
<a href="#l68.76"></a><span id="l68.76">       attachments: [{</span>
<a href="#l68.77"></a><span id="l68.77">         filename: attachmentFileNames[1],</span>
<a href="#l68.78"></a><span id="l68.78" class="difflineminus">-        body: &quot;Body&quot;</span>
<a href="#l68.79"></a><span id="l68.79" class="difflineminus">-      }]</span>
<a href="#l68.80"></a><span id="l68.80" class="difflineplus">+        body: &quot;Body&quot;,</span>
<a href="#l68.81"></a><span id="l68.81" class="difflineplus">+      }],</span>
<a href="#l68.82"></a><span id="l68.82">     },</span>
<a href="#l68.83"></a><span id="l68.83">     {</span>
<a href="#l68.84"></a><span id="l68.84">       count: 1,</span>
<a href="#l68.85"></a><span id="l68.85">       attachments: [{</span>
<a href="#l68.86"></a><span id="l68.86">         filename: attachmentFileNames[2],</span>
<a href="#l68.87"></a><span id="l68.87" class="difflineminus">-        body: &quot;Body&quot;</span>
<a href="#l68.88"></a><span id="l68.88" class="difflineminus">-      }]</span>
<a href="#l68.89"></a><span id="l68.89" class="difflineminus">-    }</span>
<a href="#l68.90"></a><span id="l68.90" class="difflineplus">+        body: &quot;Body&quot;,</span>
<a href="#l68.91"></a><span id="l68.91" class="difflineplus">+      }],</span>
<a href="#l68.92"></a><span id="l68.92" class="difflineplus">+    },</span>
<a href="#l68.93"></a><span id="l68.93">   ]);</span>
<a href="#l68.94"></a><span id="l68.94">   be_in_folder(folder);</span>
<a href="#l68.95"></a><span id="l68.95"> }</span>
<a href="#l68.96"></a><span id="l68.96"> </span>
<a href="#l68.97"></a><span id="l68.97"> function prepare_downloads_view() {</span>
<a href="#l68.98"></a><span id="l68.98">   let success = false;</span>
<a href="#l68.99"></a><span id="l68.99">   downloads.Downloads.getList(downloads.Downloads.ALL)</span>
<a href="#l68.100"></a><span id="l68.100">                      .then(list =&gt; list.addView(downloadsView))</span>
<a href="#l68.101"></a><span id="l68.101" class="difflineat">@@ -200,17 +206,17 @@ function test_remove_file() {</span>
<a href="#l68.102"></a><span id="l68.102"> </span>
<a href="#l68.103"></a><span id="l68.103">   // select first element</span>
<a href="#l68.104"></a><span id="l68.104">   mc.click(new elementslib.Elem(firstElement));</span>
<a href="#l68.105"></a><span id="l68.105">   mc.rightClick(new elementslib.Elem(firstElement));</span>
<a href="#l68.106"></a><span id="l68.106"> </span>
<a href="#l68.107"></a><span id="l68.107">   let contextMenu = content_tab_e(downloadsTab, &quot;msgDownloadsContextMenu&quot;);</span>
<a href="#l68.108"></a><span id="l68.108">   wait_for_popup_to_open(contextMenu);</span>
<a href="#l68.109"></a><span id="l68.109">   mc.click_menus_in_sequence(contextMenu, [</span>
<a href="#l68.110"></a><span id="l68.110" class="difflineminus">-                               { command: &quot;msgDownloadsCmd_remove&quot; }</span>
<a href="#l68.111"></a><span id="l68.111" class="difflineplus">+                               { command: &quot;msgDownloadsCmd_remove&quot; },</span>
<a href="#l68.112"></a><span id="l68.112">                              ]);</span>
<a href="#l68.113"></a><span id="l68.113">   mc.waitFor(() =&gt; downloadsView.count == 2,</span>
<a href="#l68.114"></a><span id="l68.114">              &quot;Timeout waiting for removing a saved attachment file.&quot;);</span>
<a href="#l68.115"></a><span id="l68.115"> </span>
<a href="#l68.116"></a><span id="l68.116">   let child = list.firstChild;</span>
<a href="#l68.117"></a><span id="l68.117">   while (child) {</span>
<a href="#l68.118"></a><span id="l68.118">     assert_not_equals(removingFileName, child.querySelector(&quot;.fileName&quot;).getAttribute(&quot;value&quot;));</span>
<a href="#l68.119"></a><span id="l68.119">     child = child.nextSibling;</span>
<a href="#l68.120"></a><span id="l68.120" class="difflineat">@@ -234,17 +240,17 @@ function test_remove_multiple_files() {</span>
<a href="#l68.121"></a><span id="l68.121">   // select two elements</span>
<a href="#l68.122"></a><span id="l68.122">   mc.click(new elementslib.Elem(firstElement));</span>
<a href="#l68.123"></a><span id="l68.123">   list.selectItemRange(firstElement, secondElement);</span>
<a href="#l68.124"></a><span id="l68.124">   mc.rightClick(new elementslib.Elem(firstElement));</span>
<a href="#l68.125"></a><span id="l68.125"> </span>
<a href="#l68.126"></a><span id="l68.126">   let contextMenu = content_tab_e(downloadsTab, &quot;msgDownloadsContextMenu&quot;);</span>
<a href="#l68.127"></a><span id="l68.127">   wait_for_popup_to_open(contextMenu);</span>
<a href="#l68.128"></a><span id="l68.128">   mc.click_menus_in_sequence(contextMenu, [</span>
<a href="#l68.129"></a><span id="l68.129" class="difflineminus">-                               { command: &quot;msgDownloadsCmd_remove&quot; }</span>
<a href="#l68.130"></a><span id="l68.130" class="difflineplus">+                               { command: &quot;msgDownloadsCmd_remove&quot; },</span>
<a href="#l68.131"></a><span id="l68.131">                              ]);</span>
<a href="#l68.132"></a><span id="l68.132">   mc.waitFor(() =&gt; downloadsView.count == 1,</span>
<a href="#l68.133"></a><span id="l68.133">              &quot;Timeout waiting for removing two saved attachment files.&quot;);</span>
<a href="#l68.134"></a><span id="l68.134"> </span>
<a href="#l68.135"></a><span id="l68.135">   let child = list.firstChild;</span>
<a href="#l68.136"></a><span id="l68.136">   while (child) {</span>
<a href="#l68.137"></a><span id="l68.137">     for (let name of removingFileNames) {</span>
<a href="#l68.138"></a><span id="l68.138">       assert_not_equals(name, child.querySelector(&quot;.fileName&quot;).getAttribute(&quot;value&quot;));</span>
<a href="#l68.139"></a><span id="l68.139" class="difflineat">@@ -261,17 +267,17 @@ function test_clear_all_files() {</span>
<a href="#l68.140"></a><span id="l68.140">   downloadsView.waitForFinish();</span>
<a href="#l68.141"></a><span id="l68.141"> </span>
<a href="#l68.142"></a><span id="l68.142">   mc.click(content_tab_eid(downloadsTab, &quot;msgDownloadsRichListBox&quot;));</span>
<a href="#l68.143"></a><span id="l68.143">   mc.rightClick(content_tab_eid(downloadsTab, &quot;msgDownloadsRichListBox&quot;));</span>
<a href="#l68.144"></a><span id="l68.144"> </span>
<a href="#l68.145"></a><span id="l68.145">   let contextMenu = content_tab_e(downloadsTab, &quot;msgDownloadsContextMenu&quot;);</span>
<a href="#l68.146"></a><span id="l68.146">   wait_for_popup_to_open(contextMenu);</span>
<a href="#l68.147"></a><span id="l68.147">   mc.click_menus_in_sequence(contextMenu, [</span>
<a href="#l68.148"></a><span id="l68.148" class="difflineminus">-                               { command: &quot;msgDownloadsCmd_clearDownloads&quot; }</span>
<a href="#l68.149"></a><span id="l68.149" class="difflineplus">+                               { command: &quot;msgDownloadsCmd_clearDownloads&quot; },</span>
<a href="#l68.150"></a><span id="l68.150">                              ]);</span>
<a href="#l68.151"></a><span id="l68.151">   mc.waitFor(() =&gt; downloadsView.count == 0,</span>
<a href="#l68.152"></a><span id="l68.152">              &quot;Timeout waiting for clearing all saved attachment files.&quot;);</span>
<a href="#l68.153"></a><span id="l68.153"> </span>
<a href="#l68.154"></a><span id="l68.154">   let empty = content_tab_e(downloadsTab, &quot;msgDownloadsListEmptyDescription&quot;);</span>
<a href="#l68.155"></a><span id="l68.155">   assert_false(empty.hidden, &quot;msgDownloadsListEmptyDescription is not visible&quot;);</span>
<a href="#l68.156"></a><span id="l68.156"> }</span>
<a href="#l68.157"></a><span id="l68.157"> </span>
<a href="#l68.158"></a><span id="l68.158" class="difflineat">@@ -281,16 +287,16 @@ function teardownTest() {</span>
<a href="#l68.159"></a><span id="l68.159">                        for (let download of downloadsView.items.keys()) {</span>
<a href="#l68.160"></a><span id="l68.160">                          list.remove(download);</span>
<a href="#l68.161"></a><span id="l68.161">                        }</span>
<a href="#l68.162"></a><span id="l68.162">                      })</span>
<a href="#l68.163"></a><span id="l68.163">                      .then(null, Cu.reportError);</span>
<a href="#l68.164"></a><span id="l68.164">   mc.waitFor(() =&gt; downloadsView.count == 0,</span>
<a href="#l68.165"></a><span id="l68.165">              &quot;Timeout waiting for clearing all saved attachment files.&quot;);</span>
<a href="#l68.166"></a><span id="l68.166">   let empty = content_tab_e(downloadsTab, &quot;msgDownloadsListEmptyDescription&quot;);</span>
<a href="#l68.167"></a><span id="l68.167" class="difflineminus">-  mc.waitFor(() =&gt; empty.hidden == false,</span>
<a href="#l68.168"></a><span id="l68.168" class="difflineplus">+  mc.waitFor(() =&gt; empty.hidden === false,</span>
<a href="#l68.169"></a><span id="l68.169">              &quot;Timeout waiting for msgDownloadsListEmptyDescription is visible.&quot;);</span>
<a href="#l68.170"></a><span id="l68.170"> }</span>
<a href="#l68.171"></a><span id="l68.171"> </span>
<a href="#l68.172"></a><span id="l68.172"> function teardownModule(module) {</span>
<a href="#l68.173"></a><span id="l68.173">   close_tab(downloadsTab);</span>
<a href="#l68.174"></a><span id="l68.174">   gMockFilePickReg.unregister();</span>
<a href="#l68.175"></a><span id="l68.175"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-archive-messages.js</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-archive-messages.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -1,30 +1,32 @@</span>
<a href="#l69.4"></a><span id="l69.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l69.5"></a><span id="l69.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l69.6"></a><span id="l69.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l69.7"></a><span id="l69.7"> </span>
<a href="#l69.8"></a><span id="l69.8"> &quot;use strict&quot;;</span>
<a href="#l69.9"></a><span id="l69.9"> </span>
<a href="#l69.10"></a><span id="l69.10" class="difflineminus">-var MODULE_NAME = 'test-archive-messages';</span>
<a href="#l69.11"></a><span id="l69.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l69.13"></a><span id="l69.13"> </span>
<a href="#l69.14"></a><span id="l69.14" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l69.15"></a><span id="l69.15" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l69.16"></a><span id="l69.16" class="difflineplus">+var MODULE_NAME = &quot;test-archive-messages&quot;;</span>
<a href="#l69.17"></a><span id="l69.17" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l69.18"></a><span id="l69.18" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l69.19"></a><span id="l69.19"> </span>
<a href="#l69.20"></a><span id="l69.20"> var folder;</span>
<a href="#l69.21"></a><span id="l69.21"> </span>
<a href="#l69.22"></a><span id="l69.22"> /**</span>
<a href="#l69.23"></a><span id="l69.23">  * The number of messages in the thread we use to test.</span>
<a href="#l69.24"></a><span id="l69.24">  */</span>
<a href="#l69.25"></a><span id="l69.25"> var NUM_MESSAGES_IN_THREAD = 6;</span>
<a href="#l69.26"></a><span id="l69.26"> </span>
<a href="#l69.27"></a><span id="l69.27"> function setupModule(module) {</span>
<a href="#l69.28"></a><span id="l69.28" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l69.29"></a><span id="l69.29" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l69.30"></a><span id="l69.30">   fdh.installInto(module);</span>
<a href="#l69.31"></a><span id="l69.31" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l69.32"></a><span id="l69.32" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l69.33"></a><span id="l69.33">   wh.installInto(module);</span>
<a href="#l69.34"></a><span id="l69.34"> </span>
<a href="#l69.35"></a><span id="l69.35">   folder = create_folder(&quot;ThreadedMessages&quot;);</span>
<a href="#l69.36"></a><span id="l69.36">   let thread = create_thread(NUM_MESSAGES_IN_THREAD);</span>
<a href="#l69.37"></a><span id="l69.37">   add_sets_to_folders([folder], [thread]);</span>
<a href="#l69.38"></a><span id="l69.38">   thread = create_thread(NUM_MESSAGES_IN_THREAD);</span>
<a href="#l69.39"></a><span id="l69.39">   add_sets_to_folders([folder], [thread]);</span>
<a href="#l69.40"></a><span id="l69.40"> }</span>
<a href="#l69.41"></a><span id="l69.41" class="difflineat">@@ -88,17 +90,17 @@ function test_batch_archiver() {</span>
<a href="#l69.42"></a><span id="l69.42">   let child1 = select_click_row(1);</span>
<a href="#l69.43"></a><span id="l69.43">   select_click_row(0);</span>
<a href="#l69.44"></a><span id="l69.44">   archive_messages([root2]);</span>
<a href="#l69.45"></a><span id="l69.45">   assert_selected_and_displayed(child1);</span>
<a href="#l69.46"></a><span id="l69.46"> </span>
<a href="#l69.47"></a><span id="l69.47">   /* Test archiving a partial selection */</span>
<a href="#l69.48"></a><span id="l69.48">   let child2 = select_click_row(1);</span>
<a href="#l69.49"></a><span id="l69.49">   let child3 = select_click_row(2);</span>
<a href="#l69.50"></a><span id="l69.50" class="difflineminus">-  let child4 = select_click_row(3);</span>
<a href="#l69.51"></a><span id="l69.51" class="difflineplus">+  select_click_row(3);</span>
<a href="#l69.52"></a><span id="l69.52"> </span>
<a href="#l69.53"></a><span id="l69.53">   select_shift_click_row(2);</span>
<a href="#l69.54"></a><span id="l69.54">   select_shift_click_row(1);</span>
<a href="#l69.55"></a><span id="l69.55">   select_shift_click_row(0);</span>
<a href="#l69.56"></a><span id="l69.56"> </span>
<a href="#l69.57"></a><span id="l69.57">   archive_messages([child1, child3]);</span>
<a href="#l69.58"></a><span id="l69.58">   assert_message_not_in_view([child1, child3]);</span>
<a href="#l69.59"></a><span id="l69.59">   assert_selected_and_displayed(child2);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-close-window-on-delete.js</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-close-window-on-delete.js</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -3,48 +3,50 @@</span>
<a href="#l70.4"></a><span id="l70.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l70.5"></a><span id="l70.5"> </span>
<a href="#l70.6"></a><span id="l70.6"> /*</span>
<a href="#l70.7"></a><span id="l70.7">  * Test that the close message window on delete option works.</span>
<a href="#l70.8"></a><span id="l70.8">  */</span>
<a href="#l70.9"></a><span id="l70.9"> </span>
<a href="#l70.10"></a><span id="l70.10"> &quot;use strict&quot;;</span>
<a href="#l70.11"></a><span id="l70.11"> </span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-var MODULE_NAME = 'test-close-window-on-delete';</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l70.14"></a><span id="l70.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l70.15"></a><span id="l70.15"> </span>
<a href="#l70.16"></a><span id="l70.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l70.17"></a><span id="l70.17" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l70.18"></a><span id="l70.18" class="difflineplus">+var MODULE_NAME = &quot;test-close-window-on-delete&quot;;</span>
<a href="#l70.19"></a><span id="l70.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l70.20"></a><span id="l70.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l70.21"></a><span id="l70.21"> </span>
<a href="#l70.22"></a><span id="l70.22"> var folder;</span>
<a href="#l70.23"></a><span id="l70.23"> </span>
<a href="#l70.24"></a><span id="l70.24"> function setupModule(module) {</span>
<a href="#l70.25"></a><span id="l70.25" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l70.26"></a><span id="l70.26" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l70.27"></a><span id="l70.27">   fdh.installInto(module);</span>
<a href="#l70.28"></a><span id="l70.28" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l70.29"></a><span id="l70.29" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l70.30"></a><span id="l70.30">   wh.installInto(module);</span>
<a href="#l70.31"></a><span id="l70.31"> </span>
<a href="#l70.32"></a><span id="l70.32">   folder = create_folder(&quot;CloseWindowOnDeleteA&quot;);</span>
<a href="#l70.33"></a><span id="l70.33"> </span>
<a href="#l70.34"></a><span id="l70.34">   make_new_sets_in_folder(folder, [{count: 10}]);</span>
<a href="#l70.35"></a><span id="l70.35"> }</span>
<a href="#l70.36"></a><span id="l70.36"> </span>
<a href="#l70.37"></a><span id="l70.37"> /**</span>
<a href="#l70.38"></a><span id="l70.38">  * Delete a message and check that the message window is closed</span>
<a href="#l70.39"></a><span id="l70.39">  * where appropriate.</span>
<a href="#l70.40"></a><span id="l70.40">  */</span>
<a href="#l70.41"></a><span id="l70.41"> function disabled_test_close_message_window_on_delete_from_message_window() {</span>
<a href="#l70.42"></a><span id="l70.42">   set_close_message_on_delete(true);</span>
<a href="#l70.43"></a><span id="l70.43">   be_in_folder(folder);</span>
<a href="#l70.44"></a><span id="l70.44"> </span>
<a href="#l70.45"></a><span id="l70.45">   // select the first message</span>
<a href="#l70.46"></a><span id="l70.46" class="difflineminus">-  let firstMessage = select_click_row(0);</span>
<a href="#l70.47"></a><span id="l70.47" class="difflineplus">+  select_click_row(0);</span>
<a href="#l70.48"></a><span id="l70.48">   // display it</span>
<a href="#l70.49"></a><span id="l70.49">   let msgc = open_selected_message_in_new_window();</span>
<a href="#l70.50"></a><span id="l70.50"> </span>
<a href="#l70.51"></a><span id="l70.51" class="difflineminus">-  let secondMessage = select_click_row(1);</span>
<a href="#l70.52"></a><span id="l70.52" class="difflineplus">+  select_click_row(1);</span>
<a href="#l70.53"></a><span id="l70.53">   let msgc2 = open_selected_message_in_new_window();</span>
<a href="#l70.54"></a><span id="l70.54"> </span>
<a href="#l70.55"></a><span id="l70.55">   let preCount = folder.getTotalMessages(false);</span>
<a href="#l70.56"></a><span id="l70.56">   msgc.window.focus();</span>
<a href="#l70.57"></a><span id="l70.57">   plan_for_window_close(msgc);</span>
<a href="#l70.58"></a><span id="l70.58">   press_delete(msgc);</span>
<a href="#l70.59"></a><span id="l70.59">   if (folder.getTotalMessages(false) != preCount - 1)</span>
<a href="#l70.60"></a><span id="l70.60">     throw new Error(&quot;didn't delete a message before closing window&quot;);</span>
<a href="#l70.61"></a><span id="l70.61" class="difflineat">@@ -62,22 +64,22 @@ function disabled_test_close_message_win</span>
<a href="#l70.62"></a><span id="l70.62">  * Delete a message when multiple windows are open to the message, and the</span>
<a href="#l70.63"></a><span id="l70.63">  * message is deleted from one of them.</span>
<a href="#l70.64"></a><span id="l70.64">  */</span>
<a href="#l70.65"></a><span id="l70.65"> function disabled_test_close_multiple_message_windows_on_delete_from_message_window() {</span>
<a href="#l70.66"></a><span id="l70.66">   set_close_message_on_delete(true);</span>
<a href="#l70.67"></a><span id="l70.67">   be_in_folder(folder);</span>
<a href="#l70.68"></a><span id="l70.68"> </span>
<a href="#l70.69"></a><span id="l70.69">   // select the first message</span>
<a href="#l70.70"></a><span id="l70.70" class="difflineminus">-  let firstMessage = select_click_row(0);</span>
<a href="#l70.71"></a><span id="l70.71" class="difflineplus">+  select_click_row(0);</span>
<a href="#l70.72"></a><span id="l70.72">   // display it</span>
<a href="#l70.73"></a><span id="l70.73">   let msgc = open_selected_message_in_new_window();</span>
<a href="#l70.74"></a><span id="l70.74">   let msgcA = open_selected_message_in_new_window();</span>
<a href="#l70.75"></a><span id="l70.75"> </span>
<a href="#l70.76"></a><span id="l70.76" class="difflineminus">-  let secondMessage = select_click_row(1);</span>
<a href="#l70.77"></a><span id="l70.77" class="difflineplus">+  select_click_row(1);</span>
<a href="#l70.78"></a><span id="l70.78">   let msgc2 = open_selected_message_in_new_window();</span>
<a href="#l70.79"></a><span id="l70.79"> </span>
<a href="#l70.80"></a><span id="l70.80">   let preCount = folder.getTotalMessages(false);</span>
<a href="#l70.81"></a><span id="l70.81">   msgc.window.focus();</span>
<a href="#l70.82"></a><span id="l70.82">   plan_for_window_close(msgc);</span>
<a href="#l70.83"></a><span id="l70.83">   plan_for_window_close(msgcA);</span>
<a href="#l70.84"></a><span id="l70.84">   press_delete(msgc);</span>
<a href="#l70.85"></a><span id="l70.85"> </span>
<a href="#l70.86"></a><span id="l70.86" class="difflineat">@@ -98,22 +100,22 @@ function disabled_test_close_multiple_me</span>
<a href="#l70.87"></a><span id="l70.87">  * Delete a message when multiple windows are open to the message, and the</span>
<a href="#l70.88"></a><span id="l70.88">  * message is deleted from the 3-pane window.</span>
<a href="#l70.89"></a><span id="l70.89">  */</span>
<a href="#l70.90"></a><span id="l70.90"> function disabled_test_close_multiple_message_windows_on_delete_from_3pane_window() {</span>
<a href="#l70.91"></a><span id="l70.91">   set_close_message_on_delete(true);</span>
<a href="#l70.92"></a><span id="l70.92">   be_in_folder(folder);</span>
<a href="#l70.93"></a><span id="l70.93"> </span>
<a href="#l70.94"></a><span id="l70.94">   // select the first message</span>
<a href="#l70.95"></a><span id="l70.95" class="difflineminus">-  let firstMessage = select_click_row(0);</span>
<a href="#l70.96"></a><span id="l70.96" class="difflineplus">+  select_click_row(0);</span>
<a href="#l70.97"></a><span id="l70.97">   // display it</span>
<a href="#l70.98"></a><span id="l70.98">   let msgc = open_selected_message_in_new_window();</span>
<a href="#l70.99"></a><span id="l70.99">   let msgcA = open_selected_message_in_new_window();</span>
<a href="#l70.100"></a><span id="l70.100"> </span>
<a href="#l70.101"></a><span id="l70.101" class="difflineminus">-  let secondMessage = select_click_row(1);</span>
<a href="#l70.102"></a><span id="l70.102" class="difflineplus">+  select_click_row(1);</span>
<a href="#l70.103"></a><span id="l70.103">   let msgc2 = open_selected_message_in_new_window();</span>
<a href="#l70.104"></a><span id="l70.104"> </span>
<a href="#l70.105"></a><span id="l70.105">   let preCount = folder.getTotalMessages(false);</span>
<a href="#l70.106"></a><span id="l70.106">   mc.window.focus();</span>
<a href="#l70.107"></a><span id="l70.107">   plan_for_window_close(msgc);</span>
<a href="#l70.108"></a><span id="l70.108">   plan_for_window_close(msgcA);</span>
<a href="#l70.109"></a><span id="l70.109">   select_click_row(0);</span>
<a href="#l70.110"></a><span id="l70.110">   press_delete(mc);</span>
<a href="#l70.111"></a><span id="l70.111" class="difflineat">@@ -135,21 +137,21 @@ function disabled_test_close_multiple_me</span>
<a href="#l70.112"></a><span id="l70.112">  * Delete a message and check that the message tab is closed</span>
<a href="#l70.113"></a><span id="l70.113">  * where appropriate.</span>
<a href="#l70.114"></a><span id="l70.114">  */</span>
<a href="#l70.115"></a><span id="l70.115"> function test_close_message_tab_on_delete_from_message_tab() {</span>
<a href="#l70.116"></a><span id="l70.116">   set_close_message_on_delete(true);</span>
<a href="#l70.117"></a><span id="l70.117">   be_in_folder(folder);</span>
<a href="#l70.118"></a><span id="l70.118"> </span>
<a href="#l70.119"></a><span id="l70.119">   // select the first message</span>
<a href="#l70.120"></a><span id="l70.120" class="difflineminus">-  let firstMessage = select_click_row(0);</span>
<a href="#l70.121"></a><span id="l70.121" class="difflineplus">+  select_click_row(0);</span>
<a href="#l70.122"></a><span id="l70.122">   // display it</span>
<a href="#l70.123"></a><span id="l70.123">   let msgc = open_selected_message_in_new_tab(true);</span>
<a href="#l70.124"></a><span id="l70.124"> </span>
<a href="#l70.125"></a><span id="l70.125" class="difflineminus">-  let secondMessage = select_click_row(1);</span>
<a href="#l70.126"></a><span id="l70.126" class="difflineplus">+  select_click_row(1);</span>
<a href="#l70.127"></a><span id="l70.127">   let msgc2 = open_selected_message_in_new_tab(true);</span>
<a href="#l70.128"></a><span id="l70.128"> </span>
<a href="#l70.129"></a><span id="l70.129">   let preCount = folder.getTotalMessages(false);</span>
<a href="#l70.130"></a><span id="l70.130">   switch_tab(msgc);</span>
<a href="#l70.131"></a><span id="l70.131">   press_delete();</span>
<a href="#l70.132"></a><span id="l70.132"> </span>
<a href="#l70.133"></a><span id="l70.133">   if (folder.getTotalMessages(false) != preCount - 1)</span>
<a href="#l70.134"></a><span id="l70.134">     throw new Error(&quot;didn't delete a message before closing tab&quot;);</span>
<a href="#l70.135"></a><span id="l70.135" class="difflineat">@@ -168,22 +170,22 @@ function test_close_message_tab_on_delet</span>
<a href="#l70.136"></a><span id="l70.136">  * Delete a message when multiple windows are open to the message, and the</span>
<a href="#l70.137"></a><span id="l70.137">  * message is deleted from one of them.</span>
<a href="#l70.138"></a><span id="l70.138">  */</span>
<a href="#l70.139"></a><span id="l70.139"> function disabled_test_close_multiple_message_tabs_on_delete_from_message_tab() {</span>
<a href="#l70.140"></a><span id="l70.140">   set_close_message_on_delete(true);</span>
<a href="#l70.141"></a><span id="l70.141">   be_in_folder(folder);</span>
<a href="#l70.142"></a><span id="l70.142"> </span>
<a href="#l70.143"></a><span id="l70.143">   // select the first message</span>
<a href="#l70.144"></a><span id="l70.144" class="difflineminus">-  let firstMessage = select_click_row(0);</span>
<a href="#l70.145"></a><span id="l70.145" class="difflineplus">+  select_click_row(0);</span>
<a href="#l70.146"></a><span id="l70.146">   // display it</span>
<a href="#l70.147"></a><span id="l70.147">   let msgc = open_selected_message_in_new_tab(true);</span>
<a href="#l70.148"></a><span id="l70.148" class="difflineminus">-  let msgcA = open_selected_message_in_new_tab(true);</span>
<a href="#l70.149"></a><span id="l70.149" class="difflineplus">+  open_selected_message_in_new_tab(true);</span>
<a href="#l70.150"></a><span id="l70.150"> </span>
<a href="#l70.151"></a><span id="l70.151" class="difflineminus">-  let secondMessage = select_click_row(1);</span>
<a href="#l70.152"></a><span id="l70.152" class="difflineplus">+  select_click_row(1);</span>
<a href="#l70.153"></a><span id="l70.153">   let msgc2 = open_selected_message_in_new_tab(true);</span>
<a href="#l70.154"></a><span id="l70.154"> </span>
<a href="#l70.155"></a><span id="l70.155">   let preCount = folder.getTotalMessages(false);</span>
<a href="#l70.156"></a><span id="l70.156">   switch_tab(msgc);</span>
<a href="#l70.157"></a><span id="l70.157">   press_delete();</span>
<a href="#l70.158"></a><span id="l70.158"> </span>
<a href="#l70.159"></a><span id="l70.159">   if (folder.getTotalMessages(false) != preCount - 1)</span>
<a href="#l70.160"></a><span id="l70.160">     throw new Error(&quot;didn't delete a message before closing tab&quot;);</span>
<a href="#l70.161"></a><span id="l70.161" class="difflineat">@@ -202,22 +204,22 @@ function disabled_test_close_multiple_me</span>
<a href="#l70.162"></a><span id="l70.162">  * Delete a message when multiple tabs are open to the message, and the</span>
<a href="#l70.163"></a><span id="l70.163">  * message is deleted from the 3-pane window.</span>
<a href="#l70.164"></a><span id="l70.164">  */</span>
<a href="#l70.165"></a><span id="l70.165"> function disabled_test_close_multiple_message_tabs_on_delete_from_3pane_window() {</span>
<a href="#l70.166"></a><span id="l70.166">   set_close_message_on_delete(true);</span>
<a href="#l70.167"></a><span id="l70.167">   be_in_folder(folder);</span>
<a href="#l70.168"></a><span id="l70.168"> </span>
<a href="#l70.169"></a><span id="l70.169">   // select the first message</span>
<a href="#l70.170"></a><span id="l70.170" class="difflineminus">-  let firstMessage = select_click_row(0);</span>
<a href="#l70.171"></a><span id="l70.171" class="difflineplus">+  select_click_row(0);</span>
<a href="#l70.172"></a><span id="l70.172">   // display it</span>
<a href="#l70.173"></a><span id="l70.173" class="difflineminus">-  let msgc = open_selected_message_in_new_tab(true);</span>
<a href="#l70.174"></a><span id="l70.174" class="difflineminus">-  let msgcA = open_selected_message_in_new_tab(true);</span>
<a href="#l70.175"></a><span id="l70.175" class="difflineplus">+  open_selected_message_in_new_tab(true);</span>
<a href="#l70.176"></a><span id="l70.176" class="difflineplus">+  open_selected_message_in_new_tab(true);</span>
<a href="#l70.177"></a><span id="l70.177"> </span>
<a href="#l70.178"></a><span id="l70.178" class="difflineminus">-  let secondMessage = select_click_row(1);</span>
<a href="#l70.179"></a><span id="l70.179" class="difflineplus">+  select_click_row(1);</span>
<a href="#l70.180"></a><span id="l70.180">   let msgc2 = open_selected_message_in_new_tab(true);</span>
<a href="#l70.181"></a><span id="l70.181"> </span>
<a href="#l70.182"></a><span id="l70.182">   let preCount = folder.getTotalMessages(false);</span>
<a href="#l70.183"></a><span id="l70.183">   mc.window.focus();</span>
<a href="#l70.184"></a><span id="l70.184">   select_click_row(0);</span>
<a href="#l70.185"></a><span id="l70.185">   press_delete(mc);</span>
<a href="#l70.186"></a><span id="l70.186"> </span>
<a href="#l70.187"></a><span id="l70.187">   if (folder.getTotalMessages(false) != preCount - 1)</span>
<a href="#l70.188"></a><span id="l70.188" class="difflineat">@@ -237,22 +239,22 @@ function disabled_test_close_multiple_me</span>
<a href="#l70.189"></a><span id="l70.189">  * Delete a message when multiple windows and tabs are open to the message, and</span>
<a href="#l70.190"></a><span id="l70.190">  * the message is deleted from the 3-pane window.</span>
<a href="#l70.191"></a><span id="l70.191">  */</span>
<a href="#l70.192"></a><span id="l70.192"> function disabled_test_close_multiple_windows_tabs_on_delete_from_3pane_window() {</span>
<a href="#l70.193"></a><span id="l70.193">   set_close_message_on_delete(true);</span>
<a href="#l70.194"></a><span id="l70.194">   be_in_folder(folder);</span>
<a href="#l70.195"></a><span id="l70.195"> </span>
<a href="#l70.196"></a><span id="l70.196">   // select the first message</span>
<a href="#l70.197"></a><span id="l70.197" class="difflineminus">-  let firstMessage = select_click_row(0);</span>
<a href="#l70.198"></a><span id="l70.198" class="difflineplus">+  select_click_row(0);</span>
<a href="#l70.199"></a><span id="l70.199">   // display it</span>
<a href="#l70.200"></a><span id="l70.200" class="difflineminus">-  let msgc = open_selected_message_in_new_tab(true);</span>
<a href="#l70.201"></a><span id="l70.201" class="difflineplus">+  open_selected_message_in_new_tab(true);</span>
<a href="#l70.202"></a><span id="l70.202">   let msgcA = open_selected_message_in_new_window();</span>
<a href="#l70.203"></a><span id="l70.203"> </span>
<a href="#l70.204"></a><span id="l70.204" class="difflineminus">-  let secondMessage = select_click_row(1);</span>
<a href="#l70.205"></a><span id="l70.205" class="difflineplus">+  select_click_row(1);</span>
<a href="#l70.206"></a><span id="l70.206">   let msgc2 = open_selected_message_in_new_tab(true);</span>
<a href="#l70.207"></a><span id="l70.207">   let msgc2A = open_selected_message_in_new_window();</span>
<a href="#l70.208"></a><span id="l70.208"> </span>
<a href="#l70.209"></a><span id="l70.209">   let preCount = folder.getTotalMessages(false);</span>
<a href="#l70.210"></a><span id="l70.210">   mc.window.focus();</span>
<a href="#l70.211"></a><span id="l70.211">   plan_for_window_close(msgcA);</span>
<a href="#l70.212"></a><span id="l70.212">   select_click_row(0);</span>
<a href="#l70.213"></a><span id="l70.213">   press_delete(mc);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-columns.js</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-columns.js</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -1,31 +1,31 @@</span>
<a href="#l71.4"></a><span id="l71.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l71.5"></a><span id="l71.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l71.6"></a><span id="l71.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l71.7"></a><span id="l71.7"> </span>
<a href="#l71.8"></a><span id="l71.8" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l71.9"></a><span id="l71.9" class="difflineminus">-</span>
<a href="#l71.10"></a><span id="l71.10" class="difflineminus">-var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l71.11"></a><span id="l71.11" class="difflineminus">-</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-// needed to zero inter-folder processing delay</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineminus">-var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l71.14"></a><span id="l71.14" class="difflineminus">-</span>
<a href="#l71.15"></a><span id="l71.15"> /*</span>
<a href="#l71.16"></a><span id="l71.16">  * Test column default logic and persistence logic.  Persistence comes in both</span>
<a href="#l71.17"></a><span id="l71.17">  *  tab-switching (because of the multiplexed implementation) and</span>
<a href="#l71.18"></a><span id="l71.18">  *  folder-switching forms.</span>
<a href="#l71.19"></a><span id="l71.19">  */</span>
<a href="#l71.20"></a><span id="l71.20"> </span>
<a href="#l71.21"></a><span id="l71.21" class="difflineminus">-// make mozmill-one SOLO_TEST=folder-display/test-columns.js</span>
<a href="#l71.22"></a><span id="l71.22" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l71.23"></a><span id="l71.23" class="difflineplus">+</span>
<a href="#l71.24"></a><span id="l71.24" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l71.25"></a><span id="l71.25" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l71.26"></a><span id="l71.26"> </span>
<a href="#l71.27"></a><span id="l71.27" class="difflineminus">-var MODULE_NAME = 'test-columns';</span>
<a href="#l71.28"></a><span id="l71.28" class="difflineplus">+var MODULE_NAME = &quot;test-columns&quot;;</span>
<a href="#l71.29"></a><span id="l71.29" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l71.30"></a><span id="l71.30" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l71.31"></a><span id="l71.31"> </span>
<a href="#l71.32"></a><span id="l71.32" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l71.33"></a><span id="l71.33" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l71.34"></a><span id="l71.34" class="difflineplus">+var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l71.35"></a><span id="l71.35" class="difflineplus">+</span>
<a href="#l71.36"></a><span id="l71.36" class="difflineplus">+// needed to zero inter-folder processing delay</span>
<a href="#l71.37"></a><span id="l71.37" class="difflineplus">+var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l71.38"></a><span id="l71.38"> </span>
<a href="#l71.39"></a><span id="l71.39"> var folderInbox, folderSent, folderVirtual, folderA, folderB;</span>
<a href="#l71.40"></a><span id="l71.40"> // INBOX_DEFAULTS sans 'dateCol' but gains 'tagsCol'</span>
<a href="#l71.41"></a><span id="l71.41"> var columnsB;</span>
<a href="#l71.42"></a><span id="l71.42"> // GLODA_DEFAULTS sans 'locationCol' but gains 'accountCol'</span>
<a href="#l71.43"></a><span id="l71.43"> var glodaColumns;</span>
<a href="#l71.44"></a><span id="l71.44"> </span>
<a href="#l71.45"></a><span id="l71.45"> // these are for the reset/apply to other/apply to other+child tests.</span>
<a href="#l71.46"></a><span id="l71.46" class="difflineat">@@ -35,61 +35,61 @@ var gColumnStateUpdated = false;</span>
<a href="#l71.47"></a><span id="l71.47"> </span>
<a href="#l71.48"></a><span id="l71.48"> var useCorrespondent;</span>
<a href="#l71.49"></a><span id="l71.49"> var INBOX_DEFAULTS;</span>
<a href="#l71.50"></a><span id="l71.50"> var SENT_DEFAULTS;</span>
<a href="#l71.51"></a><span id="l71.51"> var VIRTUAL_DEFAULTS;</span>
<a href="#l71.52"></a><span id="l71.52"> var GLODA_DEFAULTS;</span>
<a href="#l71.53"></a><span id="l71.53"> </span>
<a href="#l71.54"></a><span id="l71.54"> function setupModule(module) {</span>
<a href="#l71.55"></a><span id="l71.55" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l71.56"></a><span id="l71.56" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l71.57"></a><span id="l71.57">   fdh.installInto(module);</span>
<a href="#l71.58"></a><span id="l71.58" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l71.59"></a><span id="l71.59" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l71.60"></a><span id="l71.60">   wh.installInto(module);</span>
<a href="#l71.61"></a><span id="l71.61"> </span>
<a href="#l71.62"></a><span id="l71.62">   useCorrespondent =</span>
<a href="#l71.63"></a><span id="l71.63">     Services.prefs.getBoolPref(&quot;mail.threadpane.use_correspondents&quot;);</span>
<a href="#l71.64"></a><span id="l71.64">   INBOX_DEFAULTS = [</span>
<a href="#l71.65"></a><span id="l71.65">     &quot;threadCol&quot;,</span>
<a href="#l71.66"></a><span id="l71.66">     &quot;flaggedCol&quot;,</span>
<a href="#l71.67"></a><span id="l71.67">     &quot;attachmentCol&quot;,</span>
<a href="#l71.68"></a><span id="l71.68">     &quot;subjectCol&quot;,</span>
<a href="#l71.69"></a><span id="l71.69">     &quot;unreadButtonColHeader&quot;,</span>
<a href="#l71.70"></a><span id="l71.70">     useCorrespondent ? &quot;correspondentCol&quot; : &quot;senderCol&quot;,</span>
<a href="#l71.71"></a><span id="l71.71">     &quot;junkStatusCol&quot;,</span>
<a href="#l71.72"></a><span id="l71.72" class="difflineminus">-    &quot;dateCol&quot;</span>
<a href="#l71.73"></a><span id="l71.73" class="difflineplus">+    &quot;dateCol&quot;,</span>
<a href="#l71.74"></a><span id="l71.74">   ];</span>
<a href="#l71.75"></a><span id="l71.75">   SENT_DEFAULTS = [</span>
<a href="#l71.76"></a><span id="l71.76">     &quot;threadCol&quot;,</span>
<a href="#l71.77"></a><span id="l71.77">     &quot;flaggedCol&quot;,</span>
<a href="#l71.78"></a><span id="l71.78">     &quot;attachmentCol&quot;,</span>
<a href="#l71.79"></a><span id="l71.79">     &quot;subjectCol&quot;,</span>
<a href="#l71.80"></a><span id="l71.80">     &quot;unreadButtonColHeader&quot;,</span>
<a href="#l71.81"></a><span id="l71.81">     useCorrespondent ? &quot;correspondentCol&quot; : &quot;recipientCol&quot;,</span>
<a href="#l71.82"></a><span id="l71.82">     &quot;junkStatusCol&quot;,</span>
<a href="#l71.83"></a><span id="l71.83" class="difflineminus">-    &quot;dateCol&quot;</span>
<a href="#l71.84"></a><span id="l71.84" class="difflineplus">+    &quot;dateCol&quot;,</span>
<a href="#l71.85"></a><span id="l71.85">   ];</span>
<a href="#l71.86"></a><span id="l71.86">   VIRTUAL_DEFAULTS = [</span>
<a href="#l71.87"></a><span id="l71.87">     &quot;threadCol&quot;,</span>
<a href="#l71.88"></a><span id="l71.88">     &quot;flaggedCol&quot;,</span>
<a href="#l71.89"></a><span id="l71.89">     &quot;attachmentCol&quot;,</span>
<a href="#l71.90"></a><span id="l71.90">     &quot;subjectCol&quot;,</span>
<a href="#l71.91"></a><span id="l71.91">     &quot;unreadButtonColHeader&quot;,</span>
<a href="#l71.92"></a><span id="l71.92">     useCorrespondent ? &quot;correspondentCol&quot; : &quot;senderCol&quot;,</span>
<a href="#l71.93"></a><span id="l71.93">     &quot;junkStatusCol&quot;,</span>
<a href="#l71.94"></a><span id="l71.94">     &quot;dateCol&quot;,</span>
<a href="#l71.95"></a><span id="l71.95" class="difflineminus">-    &quot;locationCol&quot;</span>
<a href="#l71.96"></a><span id="l71.96" class="difflineplus">+    &quot;locationCol&quot;,</span>
<a href="#l71.97"></a><span id="l71.97">   ];</span>
<a href="#l71.98"></a><span id="l71.98">   GLODA_DEFAULTS = [</span>
<a href="#l71.99"></a><span id="l71.99">     &quot;threadCol&quot;,</span>
<a href="#l71.100"></a><span id="l71.100">     &quot;flaggedCol&quot;,</span>
<a href="#l71.101"></a><span id="l71.101">     &quot;subjectCol&quot;,</span>
<a href="#l71.102"></a><span id="l71.102">     useCorrespondent ? &quot;correspondentCol&quot; : &quot;senderCol&quot;,</span>
<a href="#l71.103"></a><span id="l71.103">     &quot;dateCol&quot;,</span>
<a href="#l71.104"></a><span id="l71.104" class="difflineminus">-    &quot;locationCol&quot;</span>
<a href="#l71.105"></a><span id="l71.105" class="difflineplus">+    &quot;locationCol&quot;,</span>
<a href="#l71.106"></a><span id="l71.106">   ];</span>
<a href="#l71.107"></a><span id="l71.107"> </span>
<a href="#l71.108"></a><span id="l71.108">   // create the source</span>
<a href="#l71.109"></a><span id="l71.109">   folderSource = create_folder(&quot;ColumnsApplySource&quot;);</span>
<a href="#l71.110"></a><span id="l71.110"> }</span>
<a href="#l71.111"></a><span id="l71.111"> </span>
<a href="#l71.112"></a><span id="l71.112"> /**</span>
<a href="#l71.113"></a><span id="l71.113">  * Get the currently visible threadTree columns.</span>
<a href="#l71.114"></a><span id="l71.114" class="difflineat">@@ -389,17 +389,17 @@ function test_reset_to_inbox() {</span>
<a href="#l71.115"></a><span id="l71.115">   show_column(&quot;sizeCol&quot;);</span>
<a href="#l71.116"></a><span id="l71.116">   assert_visible_columns(conExtra);</span>
<a href="#l71.117"></a><span id="l71.117"> </span>
<a href="#l71.118"></a><span id="l71.118">   // reset!</span>
<a href="#l71.119"></a><span id="l71.119">   invoke_column_picker_option([{anonid: &quot;menuitem&quot;}]);</span>
<a href="#l71.120"></a><span id="l71.120"> }</span>
<a href="#l71.121"></a><span id="l71.121"> </span>
<a href="#l71.122"></a><span id="l71.122"> function subtest_say_yes(cwc) {</span>
<a href="#l71.123"></a><span id="l71.123" class="difflineminus">-  cwc.window.document.documentElement.getButton('accept').doCommand();</span>
<a href="#l71.124"></a><span id="l71.124" class="difflineplus">+  cwc.window.document.documentElement.getButton(&quot;accept&quot;).doCommand();</span>
<a href="#l71.125"></a><span id="l71.125"> }</span>
<a href="#l71.126"></a><span id="l71.126"> </span>
<a href="#l71.127"></a><span id="l71.127"> function _apply_to_folder_common(aChildrenToo, folder) {</span>
<a href="#l71.128"></a><span id="l71.128">   if (aChildrenToo)</span>
<a href="#l71.129"></a><span id="l71.129">     plan_for_observable_event(&quot;msg-folder-columns-propagated&quot;);</span>
<a href="#l71.130"></a><span id="l71.130">   plan_for_modal_dialog(&quot;commonDialog&quot;, subtest_say_yes);</span>
<a href="#l71.131"></a><span id="l71.131">   invoke_column_picker_option([{class: &quot;applyTo-menu&quot;},</span>
<a href="#l71.132"></a><span id="l71.132">                                {class: aChildrenToo ?</span>
<a href="#l71.133"></a><span id="l71.133" class="difflineat">@@ -491,17 +491,17 @@ function test_apply_to_folder_no_childre</span>
<a href="#l71.134"></a><span id="l71.134">   folderChild2 = folderParent.getChildNamed(&quot;Child2&quot;);</span>
<a href="#l71.135"></a><span id="l71.135"> </span>
<a href="#l71.136"></a><span id="l71.136">   be_in_folder(folderSource);</span>
<a href="#l71.137"></a><span id="l71.137"> </span>
<a href="#l71.138"></a><span id="l71.138">   invoke_column_picker_option([{anonid: &quot;menuitem&quot;}]); // reset order!</span>
<a href="#l71.139"></a><span id="l71.139">   // Hide the columns that were added in other tests, since reset now</span>
<a href="#l71.140"></a><span id="l71.140">   // only resets the order.</span>
<a href="#l71.141"></a><span id="l71.141">   hide_column(&quot;tagsCol&quot;);</span>
<a href="#l71.142"></a><span id="l71.142" class="difflineminus">-  hide_column(&quot;sizeCol&quot;)</span>
<a href="#l71.143"></a><span id="l71.143" class="difflineplus">+  hide_column(&quot;sizeCol&quot;);</span>
<a href="#l71.144"></a><span id="l71.144"> </span>
<a href="#l71.145"></a><span id="l71.145">   // permute!</span>
<a href="#l71.146"></a><span id="l71.146">   let conExtra = [...INBOX_DEFAULTS];</span>
<a href="#l71.147"></a><span id="l71.147">   if (useCorrespondent) {</span>
<a href="#l71.148"></a><span id="l71.148">     conExtra[5] = &quot;senderCol&quot;;</span>
<a href="#l71.149"></a><span id="l71.149">     hide_column(&quot;correspondentCol&quot;);</span>
<a href="#l71.150"></a><span id="l71.150">     show_column(&quot;senderCol&quot;);</span>
<a href="#l71.151"></a><span id="l71.151">   } else {</span>
<a href="#l71.152"></a><span id="l71.152" class="difflineat">@@ -576,17 +576,17 @@ function FakeCollection() {</span>
<a href="#l71.153"></a><span id="l71.153"> function plan_for_columns_state_update() {</span>
<a href="#l71.154"></a><span id="l71.154">   gColumnStateUpdated = false;</span>
<a href="#l71.155"></a><span id="l71.155"> }</span>
<a href="#l71.156"></a><span id="l71.156"> </span>
<a href="#l71.157"></a><span id="l71.157"> function wait_for_columns_state_updated() {</span>
<a href="#l71.158"></a><span id="l71.158">   const STATE_PREF = &quot;mailnews.database.global.views.global&quot;;</span>
<a href="#l71.159"></a><span id="l71.159">   let columns_state_updated = function() {</span>
<a href="#l71.160"></a><span id="l71.160">     gColumnStateUpdated = true;</span>
<a href="#l71.161"></a><span id="l71.161" class="difflineminus">-  }</span>
<a href="#l71.162"></a><span id="l71.162" class="difflineplus">+  };</span>
<a href="#l71.163"></a><span id="l71.163">   Services.prefs.addObserver(STATE_PREF, columns_state_updated);</span>
<a href="#l71.164"></a><span id="l71.164">   mc.waitFor(() =&gt; gColumnStateUpdated, &quot;Timeout waiting for columns state updated.&quot;);</span>
<a href="#l71.165"></a><span id="l71.165">   Services.prefs.removeObserver(STATE_PREF, columns_state_updated);</span>
<a href="#l71.166"></a><span id="l71.166"> }</span>
<a href="#l71.167"></a><span id="l71.167"> </span>
<a href="#l71.168"></a><span id="l71.168"> function test_column_defaults_gloda_collection() {</span>
<a href="#l71.169"></a><span id="l71.169">   let fakeCollection = new FakeCollection();</span>
<a href="#l71.170"></a><span id="l71.170">   mc.tabmail.openTab(&quot;glodaList&quot;, { collection: fakeCollection });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -3,36 +3,38 @@</span>
<a href="#l72.4"></a><span id="l72.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l72.5"></a><span id="l72.5"> </span>
<a href="#l72.6"></a><span id="l72.6"> /*</span>
<a href="#l72.7"></a><span id="l72.7">  * Test that deleting messages works from a virtual folder.</span>
<a href="#l72.8"></a><span id="l72.8">  */</span>
<a href="#l72.9"></a><span id="l72.9"> </span>
<a href="#l72.10"></a><span id="l72.10"> &quot;use strict&quot;;</span>
<a href="#l72.11"></a><span id="l72.11"> </span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-var MODULE_NAME = 'test-deletion-from-virtual-folders';</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l72.14"></a><span id="l72.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l72.15"></a><span id="l72.15"> </span>
<a href="#l72.16"></a><span id="l72.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l72.17"></a><span id="l72.17" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l72.18"></a><span id="l72.18" class="difflineplus">+var MODULE_NAME = &quot;test-deletion-from-virtual-folders&quot;;</span>
<a href="#l72.19"></a><span id="l72.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l72.20"></a><span id="l72.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l72.21"></a><span id="l72.21"> </span>
<a href="#l72.22"></a><span id="l72.22"> var baseFolder, folder, lastMessageFolder;</span>
<a href="#l72.23"></a><span id="l72.23"> </span>
<a href="#l72.24"></a><span id="l72.24"> var tabFolder, tabMessage, tabMessageBackground, curMessage, nextMessage;</span>
<a href="#l72.25"></a><span id="l72.25"> </span>
<a href="#l72.26"></a><span id="l72.26"> var setNormal;</span>
<a href="#l72.27"></a><span id="l72.27"> </span>
<a href="#l72.28"></a><span id="l72.28"> /**</span>
<a href="#l72.29"></a><span id="l72.29">  * The message window controller.</span>
<a href="#l72.30"></a><span id="l72.30">  */</span>
<a href="#l72.31"></a><span id="l72.31"> var msgc;</span>
<a href="#l72.32"></a><span id="l72.32"> </span>
<a href="#l72.33"></a><span id="l72.33"> function setupModule(module) {</span>
<a href="#l72.34"></a><span id="l72.34" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l72.35"></a><span id="l72.35" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l72.36"></a><span id="l72.36">   fdh.installInto(module);</span>
<a href="#l72.37"></a><span id="l72.37" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l72.38"></a><span id="l72.38" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l72.39"></a><span id="l72.39">   wh.installInto(module);</span>
<a href="#l72.40"></a><span id="l72.40"> </span>
<a href="#l72.41"></a><span id="l72.41">   baseFolder = create_folder(&quot;DeletionFromVirtualFoldersA&quot;);</span>
<a href="#l72.42"></a><span id="l72.42">   // For setTagged, we want exactly as many messages as we plan to delete, so</span>
<a href="#l72.43"></a><span id="l72.43">   // that we can test that the message window and tabs close when they run out</span>
<a href="#l72.44"></a><span id="l72.44">   // of things to display.</span>
<a href="#l72.45"></a><span id="l72.45">   let [, setTagged] = make_new_sets_in_folder(baseFolder, [{count: 4},</span>
<a href="#l72.46"></a><span id="l72.46">                                                            {count: 4}]);</span>
<a href="#l72.47"></a><span id="l72.47" class="difflineat">@@ -41,23 +43,23 @@ function setupModule(module) {</span>
<a href="#l72.48"></a><span id="l72.48">   [setNormal] = make_new_sets_in_folder(inboxFolder, [{count: 4}]);</span>
<a href="#l72.49"></a><span id="l72.49"> </span>
<a href="#l72.50"></a><span id="l72.50">   // Add the view picker to the toolbar</span>
<a href="#l72.51"></a><span id="l72.51">   let toolbar = mc.e(&quot;mail-bar3&quot;);</span>
<a href="#l72.52"></a><span id="l72.52">   toolbar.insertItem(&quot;mailviews-container&quot;, null);</span>
<a href="#l72.53"></a><span id="l72.53">   mc.assertNode(mc.eid(&quot;mailviews-container&quot;));</span>
<a href="#l72.54"></a><span id="l72.54"> }</span>
<a href="#l72.55"></a><span id="l72.55"> </span>
<a href="#l72.56"></a><span id="l72.56" class="difflineminus">-/// Check whether this message is displayed in the folder tab</span>
<a href="#l72.57"></a><span id="l72.57" class="difflineplus">+// Check whether this message is displayed in the folder tab</span>
<a href="#l72.58"></a><span id="l72.58"> var VERIFY_FOLDER_TAB = 0x1;</span>
<a href="#l72.59"></a><span id="l72.59" class="difflineminus">-/// Check whether this message is displayed in the foreground message tab</span>
<a href="#l72.60"></a><span id="l72.60" class="difflineplus">+// Check whether this message is displayed in the foreground message tab</span>
<a href="#l72.61"></a><span id="l72.61"> var VERIFY_MESSAGE_TAB = 0x2;</span>
<a href="#l72.62"></a><span id="l72.62" class="difflineminus">-/// Check whether this message is displayed in the background message tab</span>
<a href="#l72.63"></a><span id="l72.63" class="difflineplus">+// Check whether this message is displayed in the background message tab</span>
<a href="#l72.64"></a><span id="l72.64"> var VERIFY_BACKGROUND_MESSAGE_TAB = 0x4;</span>
<a href="#l72.65"></a><span id="l72.65" class="difflineminus">-/// Check whether this message is displayed in the message window</span>
<a href="#l72.66"></a><span id="l72.66" class="difflineplus">+// Check whether this message is displayed in the message window</span>
<a href="#l72.67"></a><span id="l72.67"> var VERIFY_MESSAGE_WINDOW = 0x8;</span>
<a href="#l72.68"></a><span id="l72.68"> var VERIFY_ALL = 0xF;</span>
<a href="#l72.69"></a><span id="l72.69"> </span>
<a href="#l72.70"></a><span id="l72.70"> /**</span>
<a href="#l72.71"></a><span id="l72.71">  * Verify that the message is displayed in the given tabs. The index is</span>
<a href="#l72.72"></a><span id="l72.72">  * optional.</span>
<a href="#l72.73"></a><span id="l72.73">  */</span>
<a href="#l72.74"></a><span id="l72.74"> function _verify_message_is_displayed_in(aFlags, aMessage, aIndex) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -7,29 +7,31 @@</span>
<a href="#l73.4"></a><span id="l73.4">  *  that tab/window as well as all other tabs/windows.  We also test that the</span>
<a href="#l73.5"></a><span id="l73.5">  *  message tab title updates appropriately through all of this. We do all of</span>
<a href="#l73.6"></a><span id="l73.6">  *  this both for tabs that have ever been opened in the foreground, and tabs</span>
<a href="#l73.7"></a><span id="l73.7">  *  that haven't (and thus might have fake selections).</span>
<a href="#l73.8"></a><span id="l73.8">  */</span>
<a href="#l73.9"></a><span id="l73.9"> </span>
<a href="#l73.10"></a><span id="l73.10"> &quot;use strict&quot;;</span>
<a href="#l73.11"></a><span id="l73.11"> </span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-var MODULE_NAME = 'test-deletion-with-multiple-displays';</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l73.14"></a><span id="l73.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l73.15"></a><span id="l73.15"> </span>
<a href="#l73.16"></a><span id="l73.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l73.17"></a><span id="l73.17" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l73.18"></a><span id="l73.18" class="difflineplus">+var MODULE_NAME = &quot;test-deletion-with-multiple-displays&quot;;</span>
<a href="#l73.19"></a><span id="l73.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l73.20"></a><span id="l73.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l73.21"></a><span id="l73.21"> </span>
<a href="#l73.22"></a><span id="l73.22"> var folder, lastMessageFolder, oneBeforeFolder, oneAfterFolder,</span>
<a href="#l73.23"></a><span id="l73.23">     multipleDeletionFolder1, multipleDeletionFolder2, multipleDeletionFolder3,</span>
<a href="#l73.24"></a><span id="l73.24">     multipleDeletionFolder4;</span>
<a href="#l73.25"></a><span id="l73.25"> </span>
<a href="#l73.26"></a><span id="l73.26"> function setupModule(module) {</span>
<a href="#l73.27"></a><span id="l73.27" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l73.28"></a><span id="l73.28" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l73.29"></a><span id="l73.29">   fdh.installInto(module);</span>
<a href="#l73.30"></a><span id="l73.30" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l73.31"></a><span id="l73.31" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l73.32"></a><span id="l73.32">   wh.installInto(module);</span>
<a href="#l73.33"></a><span id="l73.33"> </span>
<a href="#l73.34"></a><span id="l73.34">   folder = create_folder(&quot;DeletionA&quot;);</span>
<a href="#l73.35"></a><span id="l73.35">   lastMessageFolder = create_folder(&quot;DeletionB&quot;);</span>
<a href="#l73.36"></a><span id="l73.36">   oneBeforeFolder = create_folder(&quot;DeletionC&quot;);</span>
<a href="#l73.37"></a><span id="l73.37">   oneAfterFolder = create_folder(&quot;DeletionD&quot;);</span>
<a href="#l73.38"></a><span id="l73.38">   multipleDeletionFolder1 = create_folder(&quot;DeletionE&quot;);</span>
<a href="#l73.39"></a><span id="l73.39">   multipleDeletionFolder2 = create_folder(&quot;DeletionF&quot;);</span>
<a href="#l73.40"></a><span id="l73.40" class="difflineat">@@ -86,23 +88,23 @@ function _open_message_in_all_four_displ</span>
<a href="#l73.41"></a><span id="l73.41"> </span>
<a href="#l73.42"></a><span id="l73.42">   // - Open the window with the message</span>
<a href="#l73.43"></a><span id="l73.43">   // need to go back to the folder tab.  (well, should.)</span>
<a href="#l73.44"></a><span id="l73.44">   switch_tab(tabFolder);</span>
<a href="#l73.45"></a><span id="l73.45">   msgc = open_selected_message_in_new_window();</span>
<a href="#l73.46"></a><span id="l73.46">   assert_selected_and_displayed(msgc, curMessage);</span>
<a href="#l73.47"></a><span id="l73.47"> }</span>
<a href="#l73.48"></a><span id="l73.48"> </span>
<a href="#l73.49"></a><span id="l73.49" class="difflineminus">-/// Check whether this message is displayed in the folder tab</span>
<a href="#l73.50"></a><span id="l73.50" class="difflineplus">+// Check whether this message is displayed in the folder tab</span>
<a href="#l73.51"></a><span id="l73.51"> var VERIFY_FOLDER_TAB = 0x1;</span>
<a href="#l73.52"></a><span id="l73.52" class="difflineminus">-/// Check whether this message is displayed in the foreground message tab</span>
<a href="#l73.53"></a><span id="l73.53" class="difflineplus">+// Check whether this message is displayed in the foreground message tab</span>
<a href="#l73.54"></a><span id="l73.54"> var VERIFY_MESSAGE_TAB = 0x2;</span>
<a href="#l73.55"></a><span id="l73.55" class="difflineminus">-/// Check whether this message is displayed in the background message tab</span>
<a href="#l73.56"></a><span id="l73.56" class="difflineplus">+// Check whether this message is displayed in the background message tab</span>
<a href="#l73.57"></a><span id="l73.57"> var VERIFY_BACKGROUND_MESSAGE_TAB = 0x4;</span>
<a href="#l73.58"></a><span id="l73.58" class="difflineminus">-/// Check whether this message is displayed in the message window</span>
<a href="#l73.59"></a><span id="l73.59" class="difflineplus">+// Check whether this message is displayed in the message window</span>
<a href="#l73.60"></a><span id="l73.60"> var VERIFY_MESSAGE_WINDOW = 0x8;</span>
<a href="#l73.61"></a><span id="l73.61"> var VERIFY_ALL = 0xF;</span>
<a href="#l73.62"></a><span id="l73.62"> </span>
<a href="#l73.63"></a><span id="l73.63"> /**</span>
<a href="#l73.64"></a><span id="l73.64">  * Verify that the message is displayed in the given tabs. The index is</span>
<a href="#l73.65"></a><span id="l73.65">  * optional.</span>
<a href="#l73.66"></a><span id="l73.66">  */</span>
<a href="#l73.67"></a><span id="l73.67"> function _verify_message_is_displayed_in(aFlags, aMessage, aIndex) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-display-name.js</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-display-name.js</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -4,18 +4,20 @@</span>
<a href="#l74.4"></a><span id="l74.4"> </span>
<a href="#l74.5"></a><span id="l74.5"> /*</span>
<a href="#l74.6"></a><span id="l74.6">  * Test that the display names in email addresses are correctly shown in the</span>
<a href="#l74.7"></a><span id="l74.7">  * thread pane.</span>
<a href="#l74.8"></a><span id="l74.8">  */</span>
<a href="#l74.9"></a><span id="l74.9"> </span>
<a href="#l74.10"></a><span id="l74.10"> &quot;use strict&quot;;</span>
<a href="#l74.11"></a><span id="l74.11"> </span>
<a href="#l74.12"></a><span id="l74.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-address-book-helpers.js */</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l74.14"></a><span id="l74.14" class="difflineplus">+</span>
<a href="#l74.15"></a><span id="l74.15"> var MODULE_NAME = &quot;test-display-name&quot;;</span>
<a href="#l74.16"></a><span id="l74.16" class="difflineminus">-</span>
<a href="#l74.17"></a><span id="l74.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l74.18"></a><span id="l74.18"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;address-book-helpers&quot;];</span>
<a href="#l74.19"></a><span id="l74.19"> </span>
<a href="#l74.20"></a><span id="l74.20"> var folder;</span>
<a href="#l74.21"></a><span id="l74.21"> </span>
<a href="#l74.22"></a><span id="l74.22"> var messages = [</span>
<a href="#l74.23"></a><span id="l74.23">   // Basic From header tests</span>
<a href="#l74.24"></a><span id="l74.24">   { name: &quot;from_display_name_unquoted&quot;,</span>
<a href="#l74.25"></a><span id="l74.25" class="difflineat">@@ -175,17 +177,17 @@ function check_display_name(index, colum</span>
<a href="#l74.26"></a><span id="l74.26">       columnIndex = 6;</span>
<a href="#l74.27"></a><span id="l74.27">       break;</span>
<a href="#l74.28"></a><span id="l74.28">     default:</span>
<a href="#l74.29"></a><span id="l74.29">       throw new Error(&quot;unknown column name: &quot; + columnName);</span>
<a href="#l74.30"></a><span id="l74.30">   }</span>
<a href="#l74.31"></a><span id="l74.31"> </span>
<a href="#l74.32"></a><span id="l74.32">   // Select the nth message</span>
<a href="#l74.33"></a><span id="l74.33">   be_in_folder(folder);</span>
<a href="#l74.34"></a><span id="l74.34" class="difflineminus">-  let curMessage = select_click_row(index);</span>
<a href="#l74.35"></a><span id="l74.35" class="difflineplus">+  select_click_row(index);</span>
<a href="#l74.36"></a><span id="l74.36"> </span>
<a href="#l74.37"></a><span id="l74.37">   let tree = mc.folderDisplay.tree;</span>
<a href="#l74.38"></a><span id="l74.38">   let cellText = tree.view.getCellText(index, tree.columns[columnIndex]);</span>
<a href="#l74.39"></a><span id="l74.39"> </span>
<a href="#l74.40"></a><span id="l74.40">   assert_equals(cellText, expectedName, columnName);</span>
<a href="#l74.41"></a><span id="l74.41"> }</span>
<a href="#l74.42"></a><span id="l74.42"> </span>
<a href="#l74.43"></a><span id="l74.43"> // Generate a test for each message in |messages|.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-displaying-messages-in-folder-tabs.js</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -6,21 +6,23 @@</span>
<a href="#l75.4"></a><span id="l75.4">  * Test displaying messages in folder tabs. This is supposed to test a variety</span>
<a href="#l75.5"></a><span id="l75.5">  * of situations, including:</span>
<a href="#l75.6"></a><span id="l75.6">  * - dropping view filters to select the message</span>
<a href="#l75.7"></a><span id="l75.7">  * - displaying the message in an existing folder tab</span>
<a href="#l75.8"></a><span id="l75.8">  */</span>
<a href="#l75.9"></a><span id="l75.9"> </span>
<a href="#l75.10"></a><span id="l75.10"> &quot;use strict&quot;;</span>
<a href="#l75.11"></a><span id="l75.11"> </span>
<a href="#l75.12"></a><span id="l75.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-search-window-helpers.js */</span>
<a href="#l75.14"></a><span id="l75.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l75.15"></a><span id="l75.15" class="difflineplus">+</span>
<a href="#l75.16"></a><span id="l75.16"> var MODULE_NAME = &quot;test-displaying-messages-in-folder-tabs&quot;;</span>
<a href="#l75.17"></a><span id="l75.17" class="difflineminus">-</span>
<a href="#l75.18"></a><span id="l75.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l75.19"></a><span id="l75.19" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l75.20"></a><span id="l75.20" class="difflineminus">-                       &quot;search-window-helpers&quot;];</span>
<a href="#l75.21"></a><span id="l75.21" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;search-window-helpers&quot;];</span>
<a href="#l75.22"></a><span id="l75.22"> </span>
<a href="#l75.23"></a><span id="l75.23"> var folderA;</span>
<a href="#l75.24"></a><span id="l75.24"> var folderB;</span>
<a href="#l75.25"></a><span id="l75.25"> var folderC;</span>
<a href="#l75.26"></a><span id="l75.26"> </span>
<a href="#l75.27"></a><span id="l75.27"> var folderTab;</span>
<a href="#l75.28"></a><span id="l75.28"> </span>
<a href="#l75.29"></a><span id="l75.29"> var msgHdrsInFolderA = [], msgHdrsInFolderB = [];</span>
<a href="#l75.30"></a><span id="l75.30" class="difflineat">@@ -387,9 +389,9 @@ function test_display_message_scrolls_to</span>
<a href="#l75.31"></a><span id="l75.31">   _verify_display_in_existing_tab(preCount, folderC, msgHdr);</span>
<a href="#l75.32"></a><span id="l75.32"> }</span>
<a href="#l75.33"></a><span id="l75.33"> </span>
<a href="#l75.34"></a><span id="l75.34"> /**</span>
<a href="#l75.35"></a><span id="l75.35">  * Clean up and remove the view picker.</span>
<a href="#l75.36"></a><span id="l75.36">  */</span>
<a href="#l75.37"></a><span id="l75.37"> function test_cleanup() {</span>
<a href="#l75.38"></a><span id="l75.38">   remove_from_toolbar(mc.e(&quot;mail-bar3&quot;), &quot;mailviews-container&quot;);</span>
<a href="#l75.39"></a><span id="l75.39" class="difflineminus">-};</span>
<a href="#l75.40"></a><span id="l75.40" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-folder-pane-visibility.js</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-folder-pane-visibility.js</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -4,27 +4,29 @@</span>
<a href="#l76.4"></a><span id="l76.4"> </span>
<a href="#l76.5"></a><span id="l76.5"> /*</span>
<a href="#l76.6"></a><span id="l76.6">  * Test that the folder pane collapses properly, stays collapsed amongst tab</span>
<a href="#l76.7"></a><span id="l76.7">  * changes, and that persistence works (to a first approximation).</span>
<a href="#l76.8"></a><span id="l76.8">  */</span>
<a href="#l76.9"></a><span id="l76.9"> </span>
<a href="#l76.10"></a><span id="l76.10"> &quot;use strict&quot;;</span>
<a href="#l76.11"></a><span id="l76.11"> </span>
<a href="#l76.12"></a><span id="l76.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l76.14"></a><span id="l76.14" class="difflineplus">+</span>
<a href="#l76.15"></a><span id="l76.15"> var MODULE_NAME = &quot;test-folder-pane-visibility&quot;;</span>
<a href="#l76.16"></a><span id="l76.16" class="difflineminus">-</span>
<a href="#l76.17"></a><span id="l76.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l76.18"></a><span id="l76.18"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l76.19"></a><span id="l76.19"> </span>
<a href="#l76.20"></a><span id="l76.20"> var folder;</span>
<a href="#l76.21"></a><span id="l76.21"> </span>
<a href="#l76.22"></a><span id="l76.22"> function setupModule(module) {</span>
<a href="#l76.23"></a><span id="l76.23" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l76.24"></a><span id="l76.24" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l76.25"></a><span id="l76.25">   fdh.installInto(module);</span>
<a href="#l76.26"></a><span id="l76.26" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l76.27"></a><span id="l76.27" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l76.28"></a><span id="l76.28">   wh.installInto(module);</span>
<a href="#l76.29"></a><span id="l76.29"> </span>
<a href="#l76.30"></a><span id="l76.30">   folder = create_folder(&quot;FolderPaneVisibility&quot;);</span>
<a href="#l76.31"></a><span id="l76.31">   make_new_sets_in_folder(folder, [{count: 3}]);</span>
<a href="#l76.32"></a><span id="l76.32"> }</span>
<a href="#l76.33"></a><span id="l76.33"> </span>
<a href="#l76.34"></a><span id="l76.34"> /**</span>
<a href="#l76.35"></a><span id="l76.35">  * When displaying a folder, assert that the folder pane is visible and all the</span>
<a href="#l76.36"></a><span id="l76.36" class="difflineat">@@ -70,20 +72,19 @@ function assert_folder_pane_hidden(aFold</span>
<a href="#l76.37"></a><span id="l76.37">   // force the view menu to update.</span>
<a href="#l76.38"></a><span id="l76.38">   mc.window.view_init();</span>
<a href="#l76.39"></a><span id="l76.39">   let paneMenuItem = mc.e(&quot;menu_showFolderPane&quot;);</span>
<a href="#l76.40"></a><span id="l76.40">   // - the folder pane splitter should or should not be collapsed, depending on</span>
<a href="#l76.41"></a><span id="l76.41">   //   aFolderPaneIllegal</span>
<a href="#l76.42"></a><span id="l76.42">   if (aFolderPaneIllegal) {</span>
<a href="#l76.43"></a><span id="l76.43">     if (mc.e(&quot;folderpane_splitter&quot;).collapsed === false)</span>
<a href="#l76.44"></a><span id="l76.44">       throw new Error(&quot;folderpane_splitter should be collapsed!&quot;);</span>
<a href="#l76.45"></a><span id="l76.45" class="difflineminus">-    //if (paneMenuItem.getAttribute(&quot;disabled&quot;) != &quot;true&quot;)</span>
<a href="#l76.46"></a><span id="l76.46" class="difflineplus">+    // if (paneMenuItem.getAttribute(&quot;disabled&quot;) != &quot;true&quot;)</span>
<a href="#l76.47"></a><span id="l76.47">     //  throw new Error(&quot;The Folder Pane menu item should be disabled.&quot;);</span>
<a href="#l76.48"></a><span id="l76.48" class="difflineminus">-  }</span>
<a href="#l76.49"></a><span id="l76.49" class="difflineminus">-  else {</span>
<a href="#l76.50"></a><span id="l76.50" class="difflineplus">+  } else {</span>
<a href="#l76.51"></a><span id="l76.51">     if (mc.e(&quot;folderpane_splitter&quot;).collapsed === true)</span>
<a href="#l76.52"></a><span id="l76.52">       throw new Error(&quot;folderpane_splitter should not be collapsed!&quot;);</span>
<a href="#l76.53"></a><span id="l76.53">     if (paneMenuItem.getAttribute(&quot;checked&quot;) == &quot;true&quot;)</span>
<a href="#l76.54"></a><span id="l76.54">       throw new Error(&quot;The Folder Pane menu item should not be checked.&quot;);</span>
<a href="#l76.55"></a><span id="l76.55">   }</span>
<a href="#l76.56"></a><span id="l76.56"> }</span>
<a href="#l76.57"></a><span id="l76.57"> </span>
<a href="#l76.58"></a><span id="l76.58"> function toggle_folder_pane() {</span>
<a href="#l76.59"></a><span id="l76.59" class="difflineat">@@ -193,18 +194,17 @@ function test_folder_pane_persistence_ge</span>
<a href="#l76.60"></a><span id="l76.60"> </span>
<a href="#l76.61"></a><span id="l76.61">   // helper to open tabs with the folder pane in the desired states (1 for</span>
<a href="#l76.62"></a><span id="l76.62">   //  visible, 0 for hidden)</span>
<a href="#l76.63"></a><span id="l76.63">   function openTabs(aConfig) {</span>
<a href="#l76.64"></a><span id="l76.64">     let curState;</span>
<a href="#l76.65"></a><span id="l76.65">     for (let [iTab, folderPaneVisible] of aConfig.entries()) {</span>
<a href="#l76.66"></a><span id="l76.66">       if (iTab == 0) {</span>
<a href="#l76.67"></a><span id="l76.67">         curState = folderPaneVisible;</span>
<a href="#l76.68"></a><span id="l76.68" class="difflineminus">-      }</span>
<a href="#l76.69"></a><span id="l76.69" class="difflineminus">-      else {</span>
<a href="#l76.70"></a><span id="l76.70" class="difflineplus">+      } else {</span>
<a href="#l76.71"></a><span id="l76.71">         open_folder_in_new_tab(folder);</span>
<a href="#l76.72"></a><span id="l76.72">         if (curState != folderPaneVisible) {</span>
<a href="#l76.73"></a><span id="l76.73">           toggle_folder_pane();</span>
<a href="#l76.74"></a><span id="l76.74">           curState = folderPaneVisible;</span>
<a href="#l76.75"></a><span id="l76.75">         }</span>
<a href="#l76.76"></a><span id="l76.76">       }</span>
<a href="#l76.77"></a><span id="l76.77">     }</span>
<a href="#l76.78"></a><span id="l76.78">   }</span>
<a href="#l76.79"></a><span id="l76.79" class="difflineat">@@ -225,17 +225,17 @@ function test_folder_pane_persistence_ge</span>
<a href="#l76.80"></a><span id="l76.80">         assert_folder_pane_hidden();</span>
<a href="#l76.81"></a><span id="l76.81">     }</span>
<a href="#l76.82"></a><span id="l76.82">   }</span>
<a href="#l76.83"></a><span id="l76.83"> </span>
<a href="#l76.84"></a><span id="l76.84">   let configs = [</span>
<a href="#l76.85"></a><span id="l76.85">     // 1st time: [+ - - + +]</span>
<a href="#l76.86"></a><span id="l76.86">     [1, 0, 0, 1, 1],</span>
<a href="#l76.87"></a><span id="l76.87">     // 2nd time: [- + + - -]</span>
<a href="#l76.88"></a><span id="l76.88" class="difflineminus">-    [0, 1, 1, 0, 0]</span>
<a href="#l76.89"></a><span id="l76.89" class="difflineplus">+    [0, 1, 1, 0, 0],</span>
<a href="#l76.90"></a><span id="l76.90">   ];</span>
<a href="#l76.91"></a><span id="l76.91"> </span>
<a href="#l76.92"></a><span id="l76.92">   for (let config of configs) {</span>
<a href="#l76.93"></a><span id="l76.93">     openTabs(config);</span>
<a href="#l76.94"></a><span id="l76.94">     verifyTabs(config); // make sure openTabs did its job right</span>
<a href="#l76.95"></a><span id="l76.95">     let state = mc.tabmail.persistTabs();</span>
<a href="#l76.96"></a><span id="l76.96">     closeTabs();</span>
<a href="#l76.97"></a><span id="l76.97">     // toggle the state for the current tab so we can be sure that it knows how</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-folder-toolbar.js</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-folder-toolbar.js</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -4,53 +4,52 @@</span>
<a href="#l77.4"></a><span id="l77.4"> </span>
<a href="#l77.5"></a><span id="l77.5"> /*</span>
<a href="#l77.6"></a><span id="l77.6">  * Test that opening new folder and message tabs has the expected result and</span>
<a href="#l77.7"></a><span id="l77.7">  *  that closing them doesn't break anything.</span>
<a href="#l77.8"></a><span id="l77.8">  */</span>
<a href="#l77.9"></a><span id="l77.9"> </span>
<a href="#l77.10"></a><span id="l77.10"> &quot;use strict&quot;;</span>
<a href="#l77.11"></a><span id="l77.11"> </span>
<a href="#l77.12"></a><span id="l77.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l77.14"></a><span id="l77.14" class="difflineplus">+</span>
<a href="#l77.15"></a><span id="l77.15"> var MODULE_NAME = &quot;test-folder-toolbar&quot;;</span>
<a href="#l77.16"></a><span id="l77.16" class="difflineminus">-</span>
<a href="#l77.17"></a><span id="l77.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l77.18"></a><span id="l77.18"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l77.19"></a><span id="l77.19"> </span>
<a href="#l77.20"></a><span id="l77.20"> var folderA, folderB;</span>
<a href="#l77.21"></a><span id="l77.21"> </span>
<a href="#l77.22"></a><span id="l77.22" class="difflineminus">-function setupModule(module)</span>
<a href="#l77.23"></a><span id="l77.23" class="difflineminus">-{</span>
<a href="#l77.24"></a><span id="l77.24" class="difflineplus">+function setupModule(module) {</span>
<a href="#l77.25"></a><span id="l77.25">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l77.26"></a><span id="l77.26">   fdh.installInto(module);</span>
<a href="#l77.27"></a><span id="l77.27">   let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l77.28"></a><span id="l77.28">   wh.installInto(module);</span>
<a href="#l77.29"></a><span id="l77.29"> </span>
<a href="#l77.30"></a><span id="l77.30">   folderA = create_folder(&quot;FolderToolbarA&quot;);</span>
<a href="#l77.31"></a><span id="l77.31">   // we need one message to select and open</span>
<a href="#l77.32"></a><span id="l77.32">   folderB = create_folder(&quot;FolderToolbarB&quot;);</span>
<a href="#l77.33"></a><span id="l77.33">   make_new_sets_in_folder(folderB, [{count: 1}]);</span>
<a href="#l77.34"></a><span id="l77.34"> }</span>
<a href="#l77.35"></a><span id="l77.35"> </span>
<a href="#l77.36"></a><span id="l77.36" class="difflineminus">-function test_add_folder_toolbar()</span>
<a href="#l77.37"></a><span id="l77.37" class="difflineminus">-{</span>
<a href="#l77.38"></a><span id="l77.38" class="difflineplus">+function test_add_folder_toolbar() {</span>
<a href="#l77.39"></a><span id="l77.39">   // It should not be present by default</span>
<a href="#l77.40"></a><span id="l77.40">   let folderLoc = mc.eid(&quot;locationFolders&quot;);</span>
<a href="#l77.41"></a><span id="l77.41">   mc.assertNodeNotExist(folderLoc);</span>
<a href="#l77.42"></a><span id="l77.42"> </span>
<a href="#l77.43"></a><span id="l77.43">   // But it should show up when we call</span>
<a href="#l77.44"></a><span id="l77.44">   add_to_toolbar(mc.e(&quot;mail-bar3&quot;), &quot;folder-location-container&quot;);</span>
<a href="#l77.45"></a><span id="l77.45">   folderLoc = mc.eid(&quot;locationFolders&quot;);</span>
<a href="#l77.46"></a><span id="l77.46">   mc.assertNode(folderLoc);</span>
<a href="#l77.47"></a><span id="l77.47"> </span>
<a href="#l77.48"></a><span id="l77.48">   assert_equals(!!folderLoc.node.label, true,</span>
<a href="#l77.49"></a><span id="l77.49">                 &quot;Uninitialized Folder doesn't have a default label.&quot;);</span>
<a href="#l77.50"></a><span id="l77.50"> }</span>
<a href="#l77.51"></a><span id="l77.51"> </span>
<a href="#l77.52"></a><span id="l77.52" class="difflineminus">-function test_folder_toolbar_shows_correct_item()</span>
<a href="#l77.53"></a><span id="l77.53" class="difflineminus">-{</span>
<a href="#l77.54"></a><span id="l77.54" class="difflineplus">+function test_folder_toolbar_shows_correct_item() {</span>
<a href="#l77.55"></a><span id="l77.55">   add_to_toolbar(mc.e(&quot;mail-bar3&quot;), &quot;folder-location-container&quot;);</span>
<a href="#l77.56"></a><span id="l77.56">   let folderLoc = mc.eid(&quot;locationFolders&quot;);</span>
<a href="#l77.57"></a><span id="l77.57"> </span>
<a href="#l77.58"></a><span id="l77.58">   // Start in folder a.</span>
<a href="#l77.59"></a><span id="l77.59">   let tabFolderA = be_in_folder(folderA);</span>
<a href="#l77.60"></a><span id="l77.60">   assert_folder_selected_and_displayed(folderA);</span>
<a href="#l77.61"></a><span id="l77.61">   assert_nothing_selected();</span>
<a href="#l77.62"></a><span id="l77.62">   assert_equals(folderLoc.node.label, &quot;FolderToolbarA&quot;,</span>
<a href="#l77.63"></a><span id="l77.63" class="difflineat">@@ -75,29 +74,28 @@ function test_folder_toolbar_shows_corre</span>
<a href="#l77.64"></a><span id="l77.64">   switch_tab(tabFolderB);</span>
<a href="#l77.65"></a><span id="l77.65">   assert_folder_selected_and_displayed(folderB);</span>
<a href="#l77.66"></a><span id="l77.66">   assert_nothing_selected();</span>
<a href="#l77.67"></a><span id="l77.67">   assert_equals(folderLoc.node.label, &quot;FolderToolbarB&quot;,</span>
<a href="#l77.68"></a><span id="l77.68">                 &quot;Switching back to FolderB's tab doesn't update toolbar.&quot;);</span>
<a href="#l77.69"></a><span id="l77.69">   close_tab(tabFolderB);</span>
<a href="#l77.70"></a><span id="l77.70"> }</span>
<a href="#l77.71"></a><span id="l77.71"> </span>
<a href="#l77.72"></a><span id="l77.72" class="difflineminus">-function test_folder_toolbar_disappears_on_message_tab()</span>
<a href="#l77.73"></a><span id="l77.73" class="difflineminus">-{</span>
<a href="#l77.74"></a><span id="l77.74" class="difflineplus">+function test_folder_toolbar_disappears_on_message_tab() {</span>
<a href="#l77.75"></a><span id="l77.75">   add_to_toolbar(mc.e(&quot;mail-bar3&quot;), &quot;folder-location-container&quot;);</span>
<a href="#l77.76"></a><span id="l77.76">   be_in_folder(folderB);</span>
<a href="#l77.77"></a><span id="l77.77">   let folderLoc = mc.eid(&quot;locationFolders&quot;);</span>
<a href="#l77.78"></a><span id="l77.78">   mc.assertNode(folderLoc);</span>
<a href="#l77.79"></a><span id="l77.79">   assert_equals(folderLoc.node.label, &quot;FolderToolbarB&quot;,</span>
<a href="#l77.80"></a><span id="l77.80">                 &quot;We should have started in FolderB.&quot;);</span>
<a href="#l77.81"></a><span id="l77.81">   assert_equals(folderLoc.node.collapsed, false,</span>
<a href="#l77.82"></a><span id="l77.82">                 &quot;The toolbar should be shown.&quot;);</span>
<a href="#l77.83"></a><span id="l77.83"> </span>
<a href="#l77.84"></a><span id="l77.84">   // Select one message</span>
<a href="#l77.85"></a><span id="l77.85" class="difflineminus">-  let msgHdr = select_click_row(0);</span>
<a href="#l77.86"></a><span id="l77.86" class="difflineplus">+  select_click_row(0);</span>
<a href="#l77.87"></a><span id="l77.87">   // Open it</span>
<a href="#l77.88"></a><span id="l77.88">   let messageTab = open_selected_message_in_new_tab();</span>
<a href="#l77.89"></a><span id="l77.89"> </span>
<a href="#l77.90"></a><span id="l77.90">   assert_equals(mc.e(&quot;folder-location-container&quot;).collapsed, true,</span>
<a href="#l77.91"></a><span id="l77.91">                 &quot;The toolbar should be hidden.&quot;);</span>
<a href="#l77.92"></a><span id="l77.92"> </span>
<a href="#l77.93"></a><span id="l77.93">   // Clean up, close the tab</span>
<a href="#l77.94"></a><span id="l77.94">   close_tab(messageTab);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -5,31 +5,33 @@</span>
<a href="#l78.4"></a><span id="l78.4"> /*</span>
<a href="#l78.5"></a><span id="l78.5">  * Test that clicking on a folder with an invalid or missing .msf file</span>
<a href="#l78.6"></a><span id="l78.6">  * regenerates the.msf file and loads the view.</span>
<a href="#l78.7"></a><span id="l78.7">  * Also, check that rebuilding the index on a loaded folder reloads the folder.</span>
<a href="#l78.8"></a><span id="l78.8">  */</span>
<a href="#l78.9"></a><span id="l78.9"> </span>
<a href="#l78.10"></a><span id="l78.10"> &quot;use strict&quot;;</span>
<a href="#l78.11"></a><span id="l78.11"> </span>
<a href="#l78.12"></a><span id="l78.12" class="difflineminus">-var MODULE_NAME = 'test-invalid-db-folder-load';</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l78.14"></a><span id="l78.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l78.15"></a><span id="l78.15"> </span>
<a href="#l78.16"></a><span id="l78.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l78.17"></a><span id="l78.17" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l78.18"></a><span id="l78.18" class="difflineplus">+var MODULE_NAME = &quot;test-invalid-db-folder-load&quot;;</span>
<a href="#l78.19"></a><span id="l78.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l78.20"></a><span id="l78.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l78.21"></a><span id="l78.21"> </span>
<a href="#l78.22"></a><span id="l78.22"> var folder;</span>
<a href="#l78.23"></a><span id="l78.23"> var setA;</span>
<a href="#l78.24"></a><span id="l78.24"> var curMessage;</span>
<a href="#l78.25"></a><span id="l78.25"> </span>
<a href="#l78.26"></a><span id="l78.26"> var nsMsgViewSortType = Ci.nsMsgViewSortType;</span>
<a href="#l78.27"></a><span id="l78.27"> </span>
<a href="#l78.28"></a><span id="l78.28"> function setupModule(module) {</span>
<a href="#l78.29"></a><span id="l78.29" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l78.30"></a><span id="l78.30" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l78.31"></a><span id="l78.31">   fdh.installInto(module);</span>
<a href="#l78.32"></a><span id="l78.32" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l78.33"></a><span id="l78.33" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l78.34"></a><span id="l78.34">   wh.installInto(module);</span>
<a href="#l78.35"></a><span id="l78.35"> </span>
<a href="#l78.36"></a><span id="l78.36">   folder = create_folder(&quot;InvalidMSF&quot;);</span>
<a href="#l78.37"></a><span id="l78.37">   [setA] = make_new_sets_in_folder(folder, [{count: 3}]);</span>
<a href="#l78.38"></a><span id="l78.38"> }</span>
<a href="#l78.39"></a><span id="l78.39"> </span>
<a href="#l78.40"></a><span id="l78.40"> /**</span>
<a href="#l78.41"></a><span id="l78.41">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-mail-views.js</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-mail-views.js</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -1,29 +1,31 @@</span>
<a href="#l79.4"></a><span id="l79.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l79.5"></a><span id="l79.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l79.6"></a><span id="l79.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l79.7"></a><span id="l79.7"> </span>
<a href="#l79.8"></a><span id="l79.8"> &quot;use strict&quot;;</span>
<a href="#l79.9"></a><span id="l79.9"> </span>
<a href="#l79.10"></a><span id="l79.10" class="difflineminus">-var MODULE_NAME = 'test-mail-views';</span>
<a href="#l79.11"></a><span id="l79.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l79.12"></a><span id="l79.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l79.13"></a><span id="l79.13"> </span>
<a href="#l79.14"></a><span id="l79.14" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l79.15"></a><span id="l79.15" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l79.16"></a><span id="l79.16" class="difflineplus">+var MODULE_NAME = &quot;test-mail-views&quot;;</span>
<a href="#l79.17"></a><span id="l79.17" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l79.18"></a><span id="l79.18" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l79.19"></a><span id="l79.19"> </span>
<a href="#l79.20"></a><span id="l79.20"> var baseFolder, savedFolder;</span>
<a href="#l79.21"></a><span id="l79.21"> var setUntagged, setTagged;</span>
<a href="#l79.22"></a><span id="l79.22"> </span>
<a href="#l79.23"></a><span id="l79.23"> var {MailViewConstants} = ChromeUtils.import(&quot;resource:///modules/MailViewManager.jsm&quot;);</span>
<a href="#l79.24"></a><span id="l79.24"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l79.25"></a><span id="l79.25"> </span>
<a href="#l79.26"></a><span id="l79.26"> var setupModule = function(module) {</span>
<a href="#l79.27"></a><span id="l79.27" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l79.28"></a><span id="l79.28" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l79.29"></a><span id="l79.29">   fdh.installInto(module);</span>
<a href="#l79.30"></a><span id="l79.30" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l79.31"></a><span id="l79.31" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l79.32"></a><span id="l79.32">   wh.installInto(module);</span>
<a href="#l79.33"></a><span id="l79.33"> </span>
<a href="#l79.34"></a><span id="l79.34">   // Create a folder with some messages that have no tags and some that are</span>
<a href="#l79.35"></a><span id="l79.35">   //  tagged Important ($label1).</span>
<a href="#l79.36"></a><span id="l79.36">   baseFolder = create_folder(&quot;MailViewA&quot;);</span>
<a href="#l79.37"></a><span id="l79.37">   [setUntagged, setTagged] = make_new_sets_in_folder(baseFolder,</span>
<a href="#l79.38"></a><span id="l79.38">                                                      [{}, {}]);</span>
<a href="#l79.39"></a><span id="l79.39">   setTagged.addTag(&quot;$label1&quot;); // Important, by default</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -6,22 +6,23 @@</span>
<a href="#l80.4"></a><span id="l80.4">  * This tests some commands on messages via the UI. But we specifically check,</span>
<a href="#l80.5"></a><span id="l80.5">  * whether the commands have an effect in the message store on disk, i.e. the</span>
<a href="#l80.6"></a><span id="l80.6">  * markings on the messages are stored in the msgStore, not only in the database.</span>
<a href="#l80.7"></a><span id="l80.7">  * For now, it checks for bug 840418.</span>
<a href="#l80.8"></a><span id="l80.8">  */</span>
<a href="#l80.9"></a><span id="l80.9"> </span>
<a href="#l80.10"></a><span id="l80.10"> &quot;use strict&quot;;</span>
<a href="#l80.11"></a><span id="l80.11"> </span>
<a href="#l80.12"></a><span id="l80.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l80.13"></a><span id="l80.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l80.14"></a><span id="l80.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l80.15"></a><span id="l80.15" class="difflineplus">+</span>
<a href="#l80.16"></a><span id="l80.16"> var MODULE_NAME = &quot;test-message-commands-on-msgstore&quot;;</span>
<a href="#l80.17"></a><span id="l80.17" class="difflineminus">-</span>
<a href="#l80.18"></a><span id="l80.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l80.19"></a><span id="l80.19" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l80.20"></a><span id="l80.20" class="difflineminus">-                         &quot;compose-helpers&quot;,</span>
<a href="#l80.21"></a><span id="l80.21" class="difflineminus">-                         &quot;window-helpers&quot;];</span>
<a href="#l80.22"></a><span id="l80.22" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l80.23"></a><span id="l80.23"> </span>
<a href="#l80.24"></a><span id="l80.24"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l80.25"></a><span id="l80.25"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l80.26"></a><span id="l80.26"> var {IOUtils} = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l80.27"></a><span id="l80.27"> </span>
<a href="#l80.28"></a><span id="l80.28"> var statusHeader = &quot;X-Mozilla-Status: &quot;;</span>
<a href="#l80.29"></a><span id="l80.29"> </span>
<a href="#l80.30"></a><span id="l80.30"> var gInbox;</span>
<a href="#l80.31"></a><span id="l80.31" class="difflineat">@@ -44,23 +45,23 @@ function setupModule(module) {</span>
<a href="#l80.32"></a><span id="l80.32">   be_in_folder(gInbox);</span>
<a href="#l80.33"></a><span id="l80.33">   let curMessage = select_click_row(0);</span>
<a href="#l80.34"></a><span id="l80.34">   press_delete(mc);</span>
<a href="#l80.35"></a><span id="l80.35">   assert_not_equals(curMessage, select_click_row(0));</span>
<a href="#l80.36"></a><span id="l80.36"> </span>
<a href="#l80.37"></a><span id="l80.37">   let urlListener = {</span>
<a href="#l80.38"></a><span id="l80.38">     compactDone: false,</span>
<a href="#l80.39"></a><span id="l80.39"> </span>
<a href="#l80.40"></a><span id="l80.40" class="difflineminus">-    OnStartRunningUrl: function (aUrl) {</span>
<a href="#l80.41"></a><span id="l80.41" class="difflineplus">+    OnStartRunningUrl(aUrl) {</span>
<a href="#l80.42"></a><span id="l80.42">     },</span>
<a href="#l80.43"></a><span id="l80.43" class="difflineminus">-    OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l80.44"></a><span id="l80.44" class="difflineplus">+    OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l80.45"></a><span id="l80.45">       assert_equals(aExitCode, 0);</span>
<a href="#l80.46"></a><span id="l80.46">       assert_true(gInbox.msgDatabase.summaryValid);</span>
<a href="#l80.47"></a><span id="l80.47">       this.compactDone = true;</span>
<a href="#l80.48"></a><span id="l80.48" class="difflineminus">-    }</span>
<a href="#l80.49"></a><span id="l80.49" class="difflineplus">+    },</span>
<a href="#l80.50"></a><span id="l80.50">   };</span>
<a href="#l80.51"></a><span id="l80.51"> </span>
<a href="#l80.52"></a><span id="l80.52">   // Compaction adds the X-Mozilla-Status rows into the messages</span>
<a href="#l80.53"></a><span id="l80.53">   // that we will need later on.</span>
<a href="#l80.54"></a><span id="l80.54">   assert_true(gInbox.msgStore.supportsCompaction);</span>
<a href="#l80.55"></a><span id="l80.55">   gInbox.compact(urlListener, null);</span>
<a href="#l80.56"></a><span id="l80.56"> </span>
<a href="#l80.57"></a><span id="l80.57">   mc.waitFor(function() { return urlListener.compactDone; },</span>
<a href="#l80.58"></a><span id="l80.58" class="difflineat">@@ -83,17 +84,17 @@ function check_status(aMsgHdr, aOffset, </span>
<a href="#l80.59"></a><span id="l80.59">     aStatusOffset = aMsgHdr.statusOffset;</span>
<a href="#l80.60"></a><span id="l80.60"> </span>
<a href="#l80.61"></a><span id="l80.61">   let folder = (aMsgHdr == null) ? gInbox : aMsgHdr.folder;</span>
<a href="#l80.62"></a><span id="l80.62"> </span>
<a href="#l80.63"></a><span id="l80.63">   let mboxstring = IOUtils.loadFileToString(folder.filePath);</span>
<a href="#l80.64"></a><span id="l80.64"> </span>
<a href="#l80.65"></a><span id="l80.65">   let expectedStatusString = aStatus.toString(16);</span>
<a href="#l80.66"></a><span id="l80.66">   while (expectedStatusString.length &lt; 4) {</span>
<a href="#l80.67"></a><span id="l80.67" class="difflineminus">-    expectedStatusString = '0' + expectedStatusString;</span>
<a href="#l80.68"></a><span id="l80.68" class="difflineplus">+    expectedStatusString = &quot;0&quot; + expectedStatusString;</span>
<a href="#l80.69"></a><span id="l80.69">   }</span>
<a href="#l80.70"></a><span id="l80.70"> </span>
<a href="#l80.71"></a><span id="l80.71">   assert_equals(mboxstring.substr(aOffset + aStatusOffset, statusHeader.length),</span>
<a href="#l80.72"></a><span id="l80.72">                 statusHeader,</span>
<a href="#l80.73"></a><span id="l80.73">                 &quot;The header '&quot; + statusHeader + &quot;' not found at offset: &quot; + aOffset + &quot;, statusOffset: &quot; + aStatusOffset);</span>
<a href="#l80.74"></a><span id="l80.74">   assert_equals(mboxstring.substr(aOffset + aStatusOffset + statusHeader.length, 4),</span>
<a href="#l80.75"></a><span id="l80.75">                 expectedStatusString);</span>
<a href="#l80.76"></a><span id="l80.76"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-commands.js</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-message-commands.js</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -5,44 +5,46 @@</span>
<a href="#l81.4"></a><span id="l81.4"> /**</span>
<a href="#l81.5"></a><span id="l81.5">  * This tests various commands on messages. This is primarily for commands</span>
<a href="#l81.6"></a><span id="l81.6">  * that can't be tested with xpcshell tests because they're handling in the</span>
<a href="#l81.7"></a><span id="l81.7">  * front end - which is why Archive is the only command currently tested.</span>
<a href="#l81.8"></a><span id="l81.8">  */</span>
<a href="#l81.9"></a><span id="l81.9"> </span>
<a href="#l81.10"></a><span id="l81.10"> &quot;use strict&quot;;</span>
<a href="#l81.11"></a><span id="l81.11"> </span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-var MODULE_NAME = 'test-message-commands';</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l81.14"></a><span id="l81.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l81.15"></a><span id="l81.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l81.16"></a><span id="l81.16"> </span>
<a href="#l81.17"></a><span id="l81.17" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l81.18"></a><span id="l81.18" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'content-tab-helpers',</span>
<a href="#l81.19"></a><span id="l81.19" class="difflineminus">-                       'window-helpers'];</span>
<a href="#l81.20"></a><span id="l81.20" class="difflineplus">+var MODULE_NAME = &quot;test-message-commands&quot;;</span>
<a href="#l81.21"></a><span id="l81.21" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l81.22"></a><span id="l81.22" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;content-tab-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l81.23"></a><span id="l81.23"> </span>
<a href="#l81.24"></a><span id="l81.24"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l81.25"></a><span id="l81.25"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l81.26"></a><span id="l81.26"> </span>
<a href="#l81.27"></a><span id="l81.27"> var unreadFolder, shiftDeleteFolder, threadDeleteFolder;</span>
<a href="#l81.28"></a><span id="l81.28"> var archiveSrcFolder = null;</span>
<a href="#l81.29"></a><span id="l81.29"> var archiveURI;</span>
<a href="#l81.30"></a><span id="l81.30"> </span>
<a href="#l81.31"></a><span id="l81.31"> var acctMgr;</span>
<a href="#l81.32"></a><span id="l81.32"> var tagArray;</span>
<a href="#l81.33"></a><span id="l81.33"> </span>
<a href="#l81.34"></a><span id="l81.34"> var setupModule = function(module) {</span>
<a href="#l81.35"></a><span id="l81.35" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l81.36"></a><span id="l81.36" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l81.37"></a><span id="l81.37">   fdh.installInto(module);</span>
<a href="#l81.38"></a><span id="l81.38" class="difflineminus">-  let cth = collector.getModule('content-tab-helpers');</span>
<a href="#l81.39"></a><span id="l81.39" class="difflineplus">+  let cth = collector.getModule(&quot;content-tab-helpers&quot;);</span>
<a href="#l81.40"></a><span id="l81.40">   cth.installInto(module);</span>
<a href="#l81.41"></a><span id="l81.41" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l81.42"></a><span id="l81.42" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l81.43"></a><span id="l81.43">   wh.installInto(module);</span>
<a href="#l81.44"></a><span id="l81.44"> </span>
<a href="#l81.45"></a><span id="l81.45" class="difflineminus">-  unreadFolder = create_folder('UnreadFolder');</span>
<a href="#l81.46"></a><span id="l81.46" class="difflineminus">-  shiftDeleteFolder = create_folder('ShiftDeleteFolder');</span>
<a href="#l81.47"></a><span id="l81.47" class="difflineminus">-  threadDeleteFolder = create_folder('ThreadDeleteFolder');</span>
<a href="#l81.48"></a><span id="l81.48" class="difflineminus">-  archiveSrcFolder = create_folder('ArchiveSrc');</span>
<a href="#l81.49"></a><span id="l81.49" class="difflineplus">+  unreadFolder = create_folder(&quot;UnreadFolder&quot;);</span>
<a href="#l81.50"></a><span id="l81.50" class="difflineplus">+  shiftDeleteFolder = create_folder(&quot;ShiftDeleteFolder&quot;);</span>
<a href="#l81.51"></a><span id="l81.51" class="difflineplus">+  threadDeleteFolder = create_folder(&quot;ThreadDeleteFolder&quot;);</span>
<a href="#l81.52"></a><span id="l81.52" class="difflineplus">+  archiveSrcFolder = create_folder(&quot;ArchiveSrc&quot;);</span>
<a href="#l81.53"></a><span id="l81.53"> </span>
<a href="#l81.54"></a><span id="l81.54">   make_new_sets_in_folder(unreadFolder, [{count: 2}]);</span>
<a href="#l81.55"></a><span id="l81.55">   make_new_sets_in_folder(shiftDeleteFolder, [{count: 3}]);</span>
<a href="#l81.56"></a><span id="l81.56">   add_sets_to_folders([threadDeleteFolder],</span>
<a href="#l81.57"></a><span id="l81.57">                       [create_thread(3), create_thread(3), create_thread(3)]);</span>
<a href="#l81.58"></a><span id="l81.58"> </span>
<a href="#l81.59"></a><span id="l81.59">   // Create messages from 20 different months, which will mean 2 different</span>
<a href="#l81.60"></a><span id="l81.60">   // years as well.</span>
<a href="#l81.61"></a><span id="l81.61" class="difflineat">@@ -157,17 +159,16 @@ function test_mark_n_read_mixed() {</span>
<a href="#l81.62"></a><span id="l81.62">   curMessages[1].markRead(false);</span>
<a href="#l81.63"></a><span id="l81.63">   mark_read_via_menu(0, true);</span>
<a href="#l81.64"></a><span id="l81.64">   check_read_status(curMessages, true);</span>
<a href="#l81.65"></a><span id="l81.65"> </span>
<a href="#l81.66"></a><span id="l81.66">   curMessages[0].markRead(false);</span>
<a href="#l81.67"></a><span id="l81.67">   curMessages[1].markRead(true);</span>
<a href="#l81.68"></a><span id="l81.68">   mark_read_via_menu(0, true);</span>
<a href="#l81.69"></a><span id="l81.69">   check_read_status(curMessages, true);</span>
<a href="#l81.70"></a><span id="l81.70" class="difflineminus">-</span>
<a href="#l81.71"></a><span id="l81.71"> }</span>
<a href="#l81.72"></a><span id="l81.72"> </span>
<a href="#l81.73"></a><span id="l81.73"> function test_mark_n_unread_mixed() {</span>
<a href="#l81.74"></a><span id="l81.74">   be_in_folder(unreadFolder);</span>
<a href="#l81.75"></a><span id="l81.75">   select_click_row(0);</span>
<a href="#l81.76"></a><span id="l81.76">   let curMessages = select_shift_click_row(1);</span>
<a href="#l81.77"></a><span id="l81.77"> </span>
<a href="#l81.78"></a><span id="l81.78">   curMessages[0].markRead(false);</span>
<a href="#l81.79"></a><span id="l81.79" class="difflineat">@@ -265,83 +266,83 @@ function test_mark_all_read() {</span>
<a href="#l81.80"></a><span id="l81.80">   assert_true(allReadDisabled, &quot;Mark All Read menu item should be disabled!&quot;);</span>
<a href="#l81.81"></a><span id="l81.81"> }</span>
<a href="#l81.82"></a><span id="l81.82"> </span>
<a href="#l81.83"></a><span id="l81.83"> function test_shift_delete_prompt() {</span>
<a href="#l81.84"></a><span id="l81.84">   be_in_folder(shiftDeleteFolder);</span>
<a href="#l81.85"></a><span id="l81.85">   let curMessage = select_click_row(0);</span>
<a href="#l81.86"></a><span id="l81.86"> </span>
<a href="#l81.87"></a><span id="l81.87">   // First, try shift-deleting and then cancelling at the prompt.</span>
<a href="#l81.88"></a><span id="l81.88" class="difflineminus">-  Services.prefs.setBoolPref('mail.warn_on_shift_delete', true);</span>
<a href="#l81.89"></a><span id="l81.89" class="difflineminus">-  plan_for_modal_dialog('commonDialog', function(controller) {</span>
<a href="#l81.90"></a><span id="l81.90" class="difflineminus">-    controller.window.document.documentElement.getButton('cancel').doCommand();</span>
<a href="#l81.91"></a><span id="l81.91" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.warn_on_shift_delete&quot;, true);</span>
<a href="#l81.92"></a><span id="l81.92" class="difflineplus">+  plan_for_modal_dialog(&quot;commonDialog&quot;, function(controller) {</span>
<a href="#l81.93"></a><span id="l81.93" class="difflineplus">+    controller.window.document.documentElement.getButton(&quot;cancel&quot;).doCommand();</span>
<a href="#l81.94"></a><span id="l81.94">   });</span>
<a href="#l81.95"></a><span id="l81.95">   // We don't use press_delete here because we're not actually deleting this</span>
<a href="#l81.96"></a><span id="l81.96">   // time!</span>
<a href="#l81.97"></a><span id="l81.97" class="difflineminus">-  mc.keypress(null, 'VK_DELETE', {shiftKey: true});</span>
<a href="#l81.98"></a><span id="l81.98" class="difflineminus">-  wait_for_modal_dialog('commonDialog');</span>
<a href="#l81.99"></a><span id="l81.99" class="difflineplus">+  mc.keypress(null, &quot;VK_DELETE&quot;, {shiftKey: true});</span>
<a href="#l81.100"></a><span id="l81.100" class="difflineplus">+  wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l81.101"></a><span id="l81.101">   // Make sure we didn't actually delete the message.</span>
<a href="#l81.102"></a><span id="l81.102">   assert_equals(curMessage, select_click_row(0));</span>
<a href="#l81.103"></a><span id="l81.103"> </span>
<a href="#l81.104"></a><span id="l81.104">   // Second, try shift-deleting and then accepting the deletion.</span>
<a href="#l81.105"></a><span id="l81.105" class="difflineminus">-  plan_for_modal_dialog('commonDialog', function(controller) {</span>
<a href="#l81.106"></a><span id="l81.106" class="difflineminus">-    controller.window.document.documentElement.getButton('accept').doCommand();</span>
<a href="#l81.107"></a><span id="l81.107" class="difflineplus">+  plan_for_modal_dialog(&quot;commonDialog&quot;, function(controller) {</span>
<a href="#l81.108"></a><span id="l81.108" class="difflineplus">+    controller.window.document.documentElement.getButton(&quot;accept&quot;).doCommand();</span>
<a href="#l81.109"></a><span id="l81.109">   });</span>
<a href="#l81.110"></a><span id="l81.110">   press_delete(mc, {shiftKey: true});</span>
<a href="#l81.111"></a><span id="l81.111" class="difflineminus">-  wait_for_modal_dialog('commonDialog');</span>
<a href="#l81.112"></a><span id="l81.112" class="difflineplus">+  wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l81.113"></a><span id="l81.113">   // Make sure we really did delete the message.</span>
<a href="#l81.114"></a><span id="l81.114">   assert_not_equals(curMessage, select_click_row(0));</span>
<a href="#l81.115"></a><span id="l81.115"> </span>
<a href="#l81.116"></a><span id="l81.116">   // Finally, try shift-deleting when we turned off the prompt.</span>
<a href="#l81.117"></a><span id="l81.117" class="difflineminus">-  Services.prefs.setBoolPref('mail.warn_on_shift_delete', false);</span>
<a href="#l81.118"></a><span id="l81.118" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.warn_on_shift_delete&quot;, false);</span>
<a href="#l81.119"></a><span id="l81.119">   curMessage = select_click_row(0);</span>
<a href="#l81.120"></a><span id="l81.120">   press_delete(mc, {shiftKey: true});</span>
<a href="#l81.121"></a><span id="l81.121" class="difflineminus">-  wait_for_modal_dialog('commonDialog');</span>
<a href="#l81.122"></a><span id="l81.122" class="difflineplus">+  wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l81.123"></a><span id="l81.123">   // Make sure we really did delete the message.</span>
<a href="#l81.124"></a><span id="l81.124">   assert_not_equals(curMessage, select_click_row(0));</span>
<a href="#l81.125"></a><span id="l81.125"> </span>
<a href="#l81.126"></a><span id="l81.126" class="difflineminus">-  Services.prefs.clearUserPref('mail.warn_on_shift_delete');</span>
<a href="#l81.127"></a><span id="l81.127" class="difflineplus">+  Services.prefs.clearUserPref(&quot;mail.warn_on_shift_delete&quot;);</span>
<a href="#l81.128"></a><span id="l81.128"> }</span>
<a href="#l81.129"></a><span id="l81.129"> </span>
<a href="#l81.130"></a><span id="l81.130"> function test_thread_delete_prompt() {</span>
<a href="#l81.131"></a><span id="l81.131">   be_in_folder(threadDeleteFolder);</span>
<a href="#l81.132"></a><span id="l81.132">   make_display_threaded();</span>
<a href="#l81.133"></a><span id="l81.133">   collapse_all_threads();</span>
<a href="#l81.134"></a><span id="l81.134"> </span>
<a href="#l81.135"></a><span id="l81.135">   let curMessage = select_click_row(0);</span>
<a href="#l81.136"></a><span id="l81.136">   // First, try deleting and then cancelling at the prompt.</span>
<a href="#l81.137"></a><span id="l81.137" class="difflineminus">-  Services.prefs.setBoolPref('mail.warn_on_collapsed_thread_operation', true);</span>
<a href="#l81.138"></a><span id="l81.138" class="difflineminus">-  plan_for_modal_dialog('commonDialog', function(controller) {</span>
<a href="#l81.139"></a><span id="l81.139" class="difflineminus">-    controller.window.document.documentElement.getButton('cancel').doCommand();</span>
<a href="#l81.140"></a><span id="l81.140" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.warn_on_collapsed_thread_operation&quot;, true);</span>
<a href="#l81.141"></a><span id="l81.141" class="difflineplus">+  plan_for_modal_dialog(&quot;commonDialog&quot;, function(controller) {</span>
<a href="#l81.142"></a><span id="l81.142" class="difflineplus">+    controller.window.document.documentElement.getButton(&quot;cancel&quot;).doCommand();</span>
<a href="#l81.143"></a><span id="l81.143">   });</span>
<a href="#l81.144"></a><span id="l81.144">   // We don't use press_delete here because we're not actually deleting this</span>
<a href="#l81.145"></a><span id="l81.145">   // time!</span>
<a href="#l81.146"></a><span id="l81.146" class="difflineminus">-  mc.keypress(null, 'VK_DELETE', {});</span>
<a href="#l81.147"></a><span id="l81.147" class="difflineminus">-  wait_for_modal_dialog('commonDialog');</span>
<a href="#l81.148"></a><span id="l81.148" class="difflineplus">+  mc.keypress(null, &quot;VK_DELETE&quot;, {});</span>
<a href="#l81.149"></a><span id="l81.149" class="difflineplus">+  wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l81.150"></a><span id="l81.150">   // Make sure we didn't actually delete the message.</span>
<a href="#l81.151"></a><span id="l81.151">   assert_equals(curMessage, select_click_row(0));</span>
<a href="#l81.152"></a><span id="l81.152"> </span>
<a href="#l81.153"></a><span id="l81.153">   // Second, try deleting and then accepting the deletion.</span>
<a href="#l81.154"></a><span id="l81.154" class="difflineminus">-  plan_for_modal_dialog('commonDialog', function(controller) {</span>
<a href="#l81.155"></a><span id="l81.155" class="difflineminus">-    controller.window.document.documentElement.getButton('accept').doCommand();</span>
<a href="#l81.156"></a><span id="l81.156" class="difflineplus">+  plan_for_modal_dialog(&quot;commonDialog&quot;, function(controller) {</span>
<a href="#l81.157"></a><span id="l81.157" class="difflineplus">+    controller.window.document.documentElement.getButton(&quot;accept&quot;).doCommand();</span>
<a href="#l81.158"></a><span id="l81.158">   });</span>
<a href="#l81.159"></a><span id="l81.159">   press_delete(mc);</span>
<a href="#l81.160"></a><span id="l81.160" class="difflineminus">-  wait_for_modal_dialog('commonDialog');</span>
<a href="#l81.161"></a><span id="l81.161" class="difflineplus">+  wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l81.162"></a><span id="l81.162">   // Make sure we really did delete the message.</span>
<a href="#l81.163"></a><span id="l81.163">   assert_not_equals(curMessage, select_click_row(0));</span>
<a href="#l81.164"></a><span id="l81.164"> </span>
<a href="#l81.165"></a><span id="l81.165">   // Finally, try shift-deleting when we turned off the prompt.</span>
<a href="#l81.166"></a><span id="l81.166" class="difflineminus">-  Services.prefs.setBoolPref('mail.warn_on_collapsed_thread_operation', false);</span>
<a href="#l81.167"></a><span id="l81.167" class="difflineplus">+  Services.prefs.setBoolPref(&quot;mail.warn_on_collapsed_thread_operation&quot;, false);</span>
<a href="#l81.168"></a><span id="l81.168">   curMessage = select_click_row(0);</span>
<a href="#l81.169"></a><span id="l81.169">   press_delete(mc);</span>
<a href="#l81.170"></a><span id="l81.170" class="difflineminus">-  wait_for_modal_dialog('commonDialog');</span>
<a href="#l81.171"></a><span id="l81.171" class="difflineplus">+  wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l81.172"></a><span id="l81.172">   // Make sure we really did delete the message.</span>
<a href="#l81.173"></a><span id="l81.173">   assert_not_equals(curMessage, select_click_row(0));</span>
<a href="#l81.174"></a><span id="l81.174"> </span>
<a href="#l81.175"></a><span id="l81.175" class="difflineminus">-  Services.prefs.clearUserPref('mail.warn_on_collapsed_thread_operation');</span>
<a href="#l81.176"></a><span id="l81.176" class="difflineplus">+  Services.prefs.clearUserPref(&quot;mail.warn_on_collapsed_thread_operation&quot;);</span>
<a href="#l81.177"></a><span id="l81.177"> }</span>
<a href="#l81.178"></a><span id="l81.178"> </span>
<a href="#l81.179"></a><span id="l81.179"> function test_yearly_archive() {</span>
<a href="#l81.180"></a><span id="l81.180">   yearly_archive(false);</span>
<a href="#l81.181"></a><span id="l81.181"> }</span>
<a href="#l81.182"></a><span id="l81.182"> </span>
<a href="#l81.183"></a><span id="l81.183"> function yearly_archive(keep_structure) {</span>
<a href="#l81.184"></a><span id="l81.184">   be_in_folder(archiveSrcFolder);</span>
<a href="#l81.185"></a><span id="l81.185" class="difflineat">@@ -522,21 +523,21 @@ function test_tag_keys() {</span>
<a href="#l81.186"></a><span id="l81.186">   check_tag_in_message(curMessage, tagArray[0], false);</span>
<a href="#l81.187"></a><span id="l81.187">   check_tag_in_message(curMessage, tagArray[1], false);</span>
<a href="#l81.188"></a><span id="l81.188"> }</span>
<a href="#l81.189"></a><span id="l81.189"> </span>
<a href="#l81.190"></a><span id="l81.190"> function test_tag_keys_disabled_in_content_tab() {</span>
<a href="#l81.191"></a><span id="l81.191">   be_in_folder(unreadFolder);</span>
<a href="#l81.192"></a><span id="l81.192">   let curMessage = select_click_row(0);</span>
<a href="#l81.193"></a><span id="l81.193"> </span>
<a href="#l81.194"></a><span id="l81.194" class="difflineminus">-  mc.window.openAddonsMgr('addons://list/theme');</span>
<a href="#l81.195"></a><span id="l81.195" class="difflineplus">+  mc.window.openAddonsMgr(&quot;addons://list/theme&quot;);</span>
<a href="#l81.196"></a><span id="l81.196">   mc.sleep(0);</span>
<a href="#l81.197"></a><span id="l81.197"> </span>
<a href="#l81.198"></a><span id="l81.198">   let tab = mc.tabmail.currentTabInfo;</span>
<a href="#l81.199"></a><span id="l81.199" class="difflineminus">-  wait_for_content_tab_load(tab, 'about:addons', 15000);</span>
<a href="#l81.200"></a><span id="l81.200" class="difflineplus">+  wait_for_content_tab_load(tab, &quot;about:addons&quot;, 15000);</span>
<a href="#l81.201"></a><span id="l81.201"> </span>
<a href="#l81.202"></a><span id="l81.202">   // Make sure pressing the &quot;1&quot; key in a content tab doesn't tag a message</span>
<a href="#l81.203"></a><span id="l81.203">   check_tag_in_message(curMessage, tagArray[0], false);</span>
<a href="#l81.204"></a><span id="l81.204">   mc.keypress(null, &quot;1&quot;, {});</span>
<a href="#l81.205"></a><span id="l81.205">   check_tag_in_message(curMessage, tagArray[0], false);</span>
<a href="#l81.206"></a><span id="l81.206"> }</span>
<a href="#l81.207"></a><span id="l81.207"> </span>
<a href="#l81.208"></a><span id="l81.208"> function teardownModule() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-pane-visibility.js</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-message-pane-visibility.js</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -4,27 +4,29 @@</span>
<a href="#l82.4"></a><span id="l82.4"> </span>
<a href="#l82.5"></a><span id="l82.5"> /*</span>
<a href="#l82.6"></a><span id="l82.6">  * Test that the message pane collapses properly, stays collapsed amongst tab</span>
<a href="#l82.7"></a><span id="l82.7">  *  changes, and that persistence works (to a first approximation).</span>
<a href="#l82.8"></a><span id="l82.8">  */</span>
<a href="#l82.9"></a><span id="l82.9"> </span>
<a href="#l82.10"></a><span id="l82.10"> &quot;use strict&quot;;</span>
<a href="#l82.11"></a><span id="l82.11"> </span>
<a href="#l82.12"></a><span id="l82.12" class="difflineminus">-var MODULE_NAME = 'test-message-pane-visibility';</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l82.14"></a><span id="l82.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l82.15"></a><span id="l82.15"> </span>
<a href="#l82.16"></a><span id="l82.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l82.17"></a><span id="l82.17" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l82.18"></a><span id="l82.18" class="difflineplus">+var MODULE_NAME = &quot;test-message-pane-visibility&quot;;</span>
<a href="#l82.19"></a><span id="l82.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l82.20"></a><span id="l82.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l82.21"></a><span id="l82.21"> </span>
<a href="#l82.22"></a><span id="l82.22"> var folder;</span>
<a href="#l82.23"></a><span id="l82.23"> </span>
<a href="#l82.24"></a><span id="l82.24"> function setupModule(module) {</span>
<a href="#l82.25"></a><span id="l82.25" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l82.26"></a><span id="l82.26" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l82.27"></a><span id="l82.27">   fdh.installInto(module);</span>
<a href="#l82.28"></a><span id="l82.28" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l82.29"></a><span id="l82.29" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l82.30"></a><span id="l82.30">   wh.installInto(module);</span>
<a href="#l82.31"></a><span id="l82.31"> </span>
<a href="#l82.32"></a><span id="l82.32">   folder = create_folder(&quot;MessagePaneVisibility&quot;);</span>
<a href="#l82.33"></a><span id="l82.33">   make_new_sets_in_folder(folder, [{count: 3}]);</span>
<a href="#l82.34"></a><span id="l82.34"> }</span>
<a href="#l82.35"></a><span id="l82.35"> </span>
<a href="#l82.36"></a><span id="l82.36"> /**</span>
<a href="#l82.37"></a><span id="l82.37">  * By default, the message pane should be visible.  Make sure that this state of</span>
<a href="#l82.38"></a><span id="l82.38" class="difflineat">@@ -62,17 +64,16 @@ function test_toggle_message_pane_on() {</span>
<a href="#l82.39"></a><span id="l82.39">   assert_message_pane_visible();</span>
<a href="#l82.40"></a><span id="l82.40"> }</span>
<a href="#l82.41"></a><span id="l82.41"> </span>
<a href="#l82.42"></a><span id="l82.42"> /**</span>
<a href="#l82.43"></a><span id="l82.43">  * Make sure that the message tab isn't broken by being invoked from a folder tab</span>
<a href="#l82.44"></a><span id="l82.44">  *  with a collapsed message pane.</span>
<a href="#l82.45"></a><span id="l82.45">  */</span>
<a href="#l82.46"></a><span id="l82.46"> function test_collapsed_message_pane_does_not_break_message_tab() {</span>
<a href="#l82.47"></a><span id="l82.47" class="difflineminus">-</span>
<a href="#l82.48"></a><span id="l82.48">   be_in_folder(folder);</span>
<a href="#l82.49"></a><span id="l82.49"> </span>
<a href="#l82.50"></a><span id="l82.50">   // - toggle message pane off</span>
<a href="#l82.51"></a><span id="l82.51">   toggle_message_pane();</span>
<a href="#l82.52"></a><span id="l82.52">   assert_message_pane_hidden();</span>
<a href="#l82.53"></a><span id="l82.53"> </span>
<a href="#l82.54"></a><span id="l82.54">   // - open message tab, make sure the message pane is visible</span>
<a href="#l82.55"></a><span id="l82.55">   select_click_row(0);</span>
<a href="#l82.56"></a><span id="l82.56" class="difflineat">@@ -165,18 +166,17 @@ function test_message_pane_persistence_g</span>
<a href="#l82.57"></a><span id="l82.57"> </span>
<a href="#l82.58"></a><span id="l82.58">   // helper to open tabs with the message pane in the desired states (1 for</span>
<a href="#l82.59"></a><span id="l82.59">   //  visible, 0 for hidden)</span>
<a href="#l82.60"></a><span id="l82.60">   function openTabs(aConfig) {</span>
<a href="#l82.61"></a><span id="l82.61">     let curState;</span>
<a href="#l82.62"></a><span id="l82.62">     for (let [iTab, messagePaneVisible] of aConfig.entries()) {</span>
<a href="#l82.63"></a><span id="l82.63">       if (iTab == 0) {</span>
<a href="#l82.64"></a><span id="l82.64">         curState = messagePaneVisible;</span>
<a href="#l82.65"></a><span id="l82.65" class="difflineminus">-      }</span>
<a href="#l82.66"></a><span id="l82.66" class="difflineminus">-      else {</span>
<a href="#l82.67"></a><span id="l82.67" class="difflineplus">+      } else {</span>
<a href="#l82.68"></a><span id="l82.68">         open_folder_in_new_tab(folder);</span>
<a href="#l82.69"></a><span id="l82.69">         if (curState != messagePaneVisible) {</span>
<a href="#l82.70"></a><span id="l82.70">           toggle_message_pane();</span>
<a href="#l82.71"></a><span id="l82.71">           curState = messagePaneVisible;</span>
<a href="#l82.72"></a><span id="l82.72">         }</span>
<a href="#l82.73"></a><span id="l82.73">       }</span>
<a href="#l82.74"></a><span id="l82.74">     }</span>
<a href="#l82.75"></a><span id="l82.75">   }</span>
<a href="#l82.76"></a><span id="l82.76" class="difflineat">@@ -197,17 +197,17 @@ function test_message_pane_persistence_g</span>
<a href="#l82.77"></a><span id="l82.77">         assert_message_pane_hidden();</span>
<a href="#l82.78"></a><span id="l82.78">     }</span>
<a href="#l82.79"></a><span id="l82.79">   }</span>
<a href="#l82.80"></a><span id="l82.80"> </span>
<a href="#l82.81"></a><span id="l82.81">   let configs = [</span>
<a href="#l82.82"></a><span id="l82.82">     // 1st time: [+ - - + +]</span>
<a href="#l82.83"></a><span id="l82.83">     [1, 0, 0, 1, 1],</span>
<a href="#l82.84"></a><span id="l82.84">     // 2nd time: [- + + - -]</span>
<a href="#l82.85"></a><span id="l82.85" class="difflineminus">-    [0, 1, 1, 0, 0]</span>
<a href="#l82.86"></a><span id="l82.86" class="difflineplus">+    [0, 1, 1, 0, 0],</span>
<a href="#l82.87"></a><span id="l82.87">   ];</span>
<a href="#l82.88"></a><span id="l82.88">   for (let config of configs) {</span>
<a href="#l82.89"></a><span id="l82.89">     openTabs(config);</span>
<a href="#l82.90"></a><span id="l82.90">     verifyTabs(config); // make sure openTabs did its job right</span>
<a href="#l82.91"></a><span id="l82.91"> </span>
<a href="#l82.92"></a><span id="l82.92">     // Switch to the first tab, so that we don't cause a double message load</span>
<a href="#l82.93"></a><span id="l82.93">     // while restoring tabs (one by the first tab, one by the currently selected</span>
<a href="#l82.94"></a><span id="l82.94">     // one). This is fine because we only restore tabs at startup, and we know</span>
<a href="#l82.95"></a><span id="l82.95" class="difflineat">@@ -223,11 +223,10 @@ function test_message_pane_persistence_g</span>
<a href="#l82.96"></a><span id="l82.96">     mc.tabmail.restoreTabs(state);</span>
<a href="#l82.97"></a><span id="l82.97">     verifyTabs(config);</span>
<a href="#l82.98"></a><span id="l82.98">     closeTabs();</span>
<a href="#l82.99"></a><span id="l82.99"> </span>
<a href="#l82.100"></a><span id="l82.100">     // toggle the first tab again.  This sets - properly for the second pass and</span>
<a href="#l82.101"></a><span id="l82.101">     //  restores it to + for when we are done.</span>
<a href="#l82.102"></a><span id="l82.102">     toggle_message_pane();</span>
<a href="#l82.103"></a><span id="l82.103">   }</span>
<a href="#l82.104"></a><span id="l82.104" class="difflineminus">-</span>
<a href="#l82.105"></a><span id="l82.105"> }</span>
<a href="#l82.106"></a><span id="l82.106"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-reloads.js</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-message-reloads.js</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -4,18 +4,19 @@</span>
<a href="#l83.4"></a><span id="l83.4"> </span>
<a href="#l83.5"></a><span id="l83.5"> /*</span>
<a href="#l83.6"></a><span id="l83.6">  * Test that message reloads happen properly when the message pane is hidden,</span>
<a href="#l83.7"></a><span id="l83.7">  * and then made visible again.</span>
<a href="#l83.8"></a><span id="l83.8">  */</span>
<a href="#l83.9"></a><span id="l83.9"> </span>
<a href="#l83.10"></a><span id="l83.10"> &quot;use strict&quot;;</span>
<a href="#l83.11"></a><span id="l83.11"> </span>
<a href="#l83.12"></a><span id="l83.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineplus">+</span>
<a href="#l83.14"></a><span id="l83.14"> var MODULE_NAME = &quot;test-message-reloads&quot;;</span>
<a href="#l83.15"></a><span id="l83.15" class="difflineminus">-</span>
<a href="#l83.16"></a><span id="l83.16"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l83.17"></a><span id="l83.17"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l83.18"></a><span id="l83.18"> </span>
<a href="#l83.19"></a><span id="l83.19"> var folder;</span>
<a href="#l83.20"></a><span id="l83.20"> </span>
<a href="#l83.21"></a><span id="l83.21"> function setupModule(module) {</span>
<a href="#l83.22"></a><span id="l83.22">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l83.23"></a><span id="l83.23">   fdh.installInto(module);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-size.js</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-message-size.js</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -5,33 +5,34 @@</span>
<a href="#l84.4"></a><span id="l84.4"> </span>
<a href="#l84.5"></a><span id="l84.5"> /*</span>
<a href="#l84.6"></a><span id="l84.6">  * Test that the size column of in the message list is formatted properly (e.g.</span>
<a href="#l84.7"></a><span id="l84.7">    0.1 KB, 1.2 KB, 12.3 KB, 123 KB, and likewise for MB and GB).</span>
<a href="#l84.8"></a><span id="l84.8">  */</span>
<a href="#l84.9"></a><span id="l84.9"> </span>
<a href="#l84.10"></a><span id="l84.10"> &quot;use strict&quot;;</span>
<a href="#l84.11"></a><span id="l84.11"> </span>
<a href="#l84.12"></a><span id="l84.12" class="difflineminus">-var MODULE_NAME = 'test-message-size';</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l84.14"></a><span id="l84.14"> </span>
<a href="#l84.15"></a><span id="l84.15" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l84.16"></a><span id="l84.16" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l84.17"></a><span id="l84.17" class="difflineplus">+var MODULE_NAME = &quot;test-message-size&quot;;</span>
<a href="#l84.18"></a><span id="l84.18" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l84.19"></a><span id="l84.19" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l84.20"></a><span id="l84.20"> </span>
<a href="#l84.21"></a><span id="l84.21"> var folder;</span>
<a href="#l84.22"></a><span id="l84.22"> </span>
<a href="#l84.23"></a><span id="l84.23"> function setupModule(module) {</span>
<a href="#l84.24"></a><span id="l84.24" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l84.25"></a><span id="l84.25" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l84.26"></a><span id="l84.26">   fdh.installInto(module);</span>
<a href="#l84.27"></a><span id="l84.27"> </span>
<a href="#l84.28"></a><span id="l84.28">   folder = create_folder(&quot;MessageSizeA&quot;);</span>
<a href="#l84.29"></a><span id="l84.29"> </span>
<a href="#l84.30"></a><span id="l84.30">   // Create messages with sizes in the byte, KB, and MB ranges.</span>
<a href="#l84.31"></a><span id="l84.31">   let bytemsg = create_message({body: {body: &quot; &quot;}});</span>
<a href="#l84.32"></a><span id="l84.32"> </span>
<a href="#l84.33"></a><span id="l84.33" class="difflineminus">-  let kbstring = &quot;x &quot;.repeat(1024/2);</span>
<a href="#l84.34"></a><span id="l84.34" class="difflineplus">+  let kbstring = &quot;x &quot;.repeat(1024 / 2);</span>
<a href="#l84.35"></a><span id="l84.35">   let kbmsg = create_message({body: {body: kbstring}});</span>
<a href="#l84.36"></a><span id="l84.36"> </span>
<a href="#l84.37"></a><span id="l84.37">   let mbstring = kbstring.repeat(1024);</span>
<a href="#l84.38"></a><span id="l84.38">   let mbmsg = create_message({body: {body: mbstring}});</span>
<a href="#l84.39"></a><span id="l84.39"> </span>
<a href="#l84.40"></a><span id="l84.40">   add_message_to_folder(folder, bytemsg);</span>
<a href="#l84.41"></a><span id="l84.41">   add_message_to_folder(folder, kbmsg);</span>
<a href="#l84.42"></a><span id="l84.42">   add_message_to_folder(folder, mbmsg);</span>
<a href="#l84.43"></a><span id="l84.43" class="difflineat">@@ -47,19 +48,19 @@ function _help_test_message_size(index, </span>
<a href="#l84.44"></a><span id="l84.44">   let sizeCol = tree.columns.sizeCol;</span>
<a href="#l84.45"></a><span id="l84.45">   let sizeStr = tree.view.getCellText(index, sizeCol);</span>
<a href="#l84.46"></a><span id="l84.46"> </span>
<a href="#l84.47"></a><span id="l84.47">   // Note: this assumes that the numeric part of the size string is first</span>
<a href="#l84.48"></a><span id="l84.48">   let realSize = curMessage.messageSize;</span>
<a href="#l84.49"></a><span id="l84.49">   let abbrSize = parseFloat(sizeStr);</span>
<a href="#l84.50"></a><span id="l84.50"> </span>
<a href="#l84.51"></a><span id="l84.51">   if (isNaN(abbrSize))</span>
<a href="#l84.52"></a><span id="l84.52" class="difflineminus">-    throw new Error(&quot;formatted size is not numeric: '&quot;+sizeStr+&quot;'&quot;);</span>
<a href="#l84.53"></a><span id="l84.53" class="difflineminus">-  if (Math.abs(realSize/Math.pow(1024, unit) - abbrSize) &gt; 0.5)</span>
<a href="#l84.54"></a><span id="l84.54" class="difflineminus">-    throw new Error(&quot;size mismatch: '&quot;+realSize+&quot;' and '&quot;+sizeStr+&quot;'&quot;);</span>
<a href="#l84.55"></a><span id="l84.55" class="difflineplus">+    throw new Error(&quot;formatted size is not numeric: '&quot; + sizeStr + &quot;'&quot;);</span>
<a href="#l84.56"></a><span id="l84.56" class="difflineplus">+  if (Math.abs(realSize / Math.pow(1024, unit) - abbrSize) &gt; 0.5)</span>
<a href="#l84.57"></a><span id="l84.57" class="difflineplus">+    throw new Error(&quot;size mismatch: '&quot; + realSize + &quot;' and '&quot; + sizeStr + &quot;'&quot;);</span>
<a href="#l84.58"></a><span id="l84.58"> }</span>
<a href="#l84.59"></a><span id="l84.59"> </span>
<a href="#l84.60"></a><span id="l84.60"> function test_byte_message_size() {</span>
<a href="#l84.61"></a><span id="l84.61">   _help_test_message_size(0, 1);</span>
<a href="#l84.62"></a><span id="l84.62"> }</span>
<a href="#l84.63"></a><span id="l84.63"> </span>
<a href="#l84.64"></a><span id="l84.64"> function test_kb_message_size() {</span>
<a href="#l84.65"></a><span id="l84.65">   _help_test_message_size(1, 1);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-window.js</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-message-window.js</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineat">@@ -4,28 +4,30 @@</span>
<a href="#l85.4"></a><span id="l85.4"> </span>
<a href="#l85.5"></a><span id="l85.5"> /*</span>
<a href="#l85.6"></a><span id="l85.6">  * Test that we can open and close a standalone message display window from the</span>
<a href="#l85.7"></a><span id="l85.7">  *  folder pane.</span>
<a href="#l85.8"></a><span id="l85.8">  */</span>
<a href="#l85.9"></a><span id="l85.9"> </span>
<a href="#l85.10"></a><span id="l85.10"> &quot;use strict&quot;;</span>
<a href="#l85.11"></a><span id="l85.11"> </span>
<a href="#l85.12"></a><span id="l85.12" class="difflineminus">-var MODULE_NAME = 'test-message-window';</span>
<a href="#l85.13"></a><span id="l85.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l85.14"></a><span id="l85.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l85.15"></a><span id="l85.15"> </span>
<a href="#l85.16"></a><span id="l85.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l85.17"></a><span id="l85.17" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l85.18"></a><span id="l85.18" class="difflineplus">+var MODULE_NAME = &quot;test-message-window&quot;;</span>
<a href="#l85.19"></a><span id="l85.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l85.20"></a><span id="l85.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l85.21"></a><span id="l85.21"> </span>
<a href="#l85.22"></a><span id="l85.22"> var folderA, folderB;</span>
<a href="#l85.23"></a><span id="l85.23"> var curMessage;</span>
<a href="#l85.24"></a><span id="l85.24"> </span>
<a href="#l85.25"></a><span id="l85.25"> function setupModule(module) {</span>
<a href="#l85.26"></a><span id="l85.26" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l85.27"></a><span id="l85.27" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l85.28"></a><span id="l85.28">   fdh.installInto(module);</span>
<a href="#l85.29"></a><span id="l85.29" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l85.30"></a><span id="l85.30" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l85.31"></a><span id="l85.31">   wh.installInto(module);</span>
<a href="#l85.32"></a><span id="l85.32"> </span>
<a href="#l85.33"></a><span id="l85.33">   folderA = create_folder(&quot;MessageWindowA&quot;);</span>
<a href="#l85.34"></a><span id="l85.34">   folderB = create_folder(&quot;MessageWindowB&quot;);</span>
<a href="#l85.35"></a><span id="l85.35">   // create three messages in the folder to display</span>
<a href="#l85.36"></a><span id="l85.36">   let msg1 = create_thread(1);</span>
<a href="#l85.37"></a><span id="l85.37">   let msg2 = create_thread(1);</span>
<a href="#l85.38"></a><span id="l85.38">   let thread1 = create_thread(2);</span>
<a href="#l85.39"></a><span id="l85.39" class="difflineat">@@ -90,21 +92,20 @@ function test_delete_single_message() {</span>
<a href="#l85.40"></a><span id="l85.40"> /**</span>
<a href="#l85.41"></a><span id="l85.41">  * Delete the current message, and verify that it only deletes</span>
<a href="#l85.42"></a><span id="l85.42">  * a single message, not the messages in the collapsed thread</span>
<a href="#l85.43"></a><span id="l85.43">  */</span>
<a href="#l85.44"></a><span id="l85.44"> function test_del_collapsed_thread() {</span>
<a href="#l85.45"></a><span id="l85.45">   press_delete(msgc);</span>
<a href="#l85.46"></a><span id="l85.46">   if (folderA.getTotalMessages(false) != 4)</span>
<a href="#l85.47"></a><span id="l85.47">     throw new Error(&quot;should have only deleted one message&quot;);</span>
<a href="#l85.48"></a><span id="l85.48" class="difflineminus">-</span>
<a href="#l85.49"></a><span id="l85.49"> }</span>
<a href="#l85.50"></a><span id="l85.50"> </span>
<a href="#l85.51"></a><span id="l85.51"> function subtest_say_yes(cwc) {</span>
<a href="#l85.52"></a><span id="l85.52" class="difflineminus">-  cwc.window.document.documentElement.getButton('accept').doCommand();</span>
<a href="#l85.53"></a><span id="l85.53" class="difflineplus">+  cwc.window.document.documentElement.getButton(&quot;accept&quot;).doCommand();</span>
<a href="#l85.54"></a><span id="l85.54"> }</span>
<a href="#l85.55"></a><span id="l85.55"> </span>
<a href="#l85.56"></a><span id="l85.56"> /**</span>
<a href="#l85.57"></a><span id="l85.57">  * Hit n enough times to mark all messages in folder A read, and then accept the</span>
<a href="#l85.58"></a><span id="l85.58">  * modal dialog saying that we should move to the next folder. Then, assert that</span>
<a href="#l85.59"></a><span id="l85.59">  * the message displayed in the standalone message window is folder B's first</span>
<a href="#l85.60"></a><span id="l85.60">  * message (since all messages in folder B were unread).</span>
<a href="#l85.61"></a><span id="l85.61">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-opening-messages-without-a-backing-view.js</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-opening-messages-without-a-backing-view.js</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineat">@@ -5,43 +5,45 @@</span>
<a href="#l86.4"></a><span id="l86.4"> /*</span>
<a href="#l86.5"></a><span id="l86.5">  * Test that messages without a backing view are opened correctly. Examples of</span>
<a href="#l86.6"></a><span id="l86.6">  * messages without a backing view are those opened from the command line or</span>
<a href="#l86.7"></a><span id="l86.7">  * desktop search integration results.</span>
<a href="#l86.8"></a><span id="l86.8">  */</span>
<a href="#l86.9"></a><span id="l86.9"> </span>
<a href="#l86.10"></a><span id="l86.10"> &quot;use strict&quot;;</span>
<a href="#l86.11"></a><span id="l86.11"> </span>
<a href="#l86.12"></a><span id="l86.12" class="difflineminus">-var MODULE_NAME = 'test-opening-messages-without-a-backing-view';</span>
<a href="#l86.13"></a><span id="l86.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l86.14"></a><span id="l86.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l86.15"></a><span id="l86.15"> </span>
<a href="#l86.16"></a><span id="l86.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l86.17"></a><span id="l86.17" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l86.18"></a><span id="l86.18" class="difflineplus">+var MODULE_NAME = &quot;test-opening-messages-without-a-backing-view&quot;;</span>
<a href="#l86.19"></a><span id="l86.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l86.20"></a><span id="l86.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l86.21"></a><span id="l86.21"> </span>
<a href="#l86.22"></a><span id="l86.22"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l86.23"></a><span id="l86.23"> </span>
<a href="#l86.24"></a><span id="l86.24"> // One folder's enough</span>
<a href="#l86.25"></a><span id="l86.25"> var folder = null;</span>
<a href="#l86.26"></a><span id="l86.26"> </span>
<a href="#l86.27"></a><span id="l86.27"> // A list of the message headers in this folder</span>
<a href="#l86.28"></a><span id="l86.28"> var msgHdrsInFolder = null;</span>
<a href="#l86.29"></a><span id="l86.29"> </span>
<a href="#l86.30"></a><span id="l86.30"> // Number of messages to open for multi-message tests</span>
<a href="#l86.31"></a><span id="l86.31"> var NUM_MESSAGES_TO_OPEN = 5;</span>
<a href="#l86.32"></a><span id="l86.32"> </span>
<a href="#l86.33"></a><span id="l86.33" class="difflineminus">-var setupModule = function (module) {</span>
<a href="#l86.34"></a><span id="l86.34" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l86.35"></a><span id="l86.35" class="difflineplus">+function setupModule(module) {</span>
<a href="#l86.36"></a><span id="l86.36" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l86.37"></a><span id="l86.37">   fdh.installInto(module);</span>
<a href="#l86.38"></a><span id="l86.38" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l86.39"></a><span id="l86.39" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l86.40"></a><span id="l86.40">   wh.installInto(module);</span>
<a href="#l86.41"></a><span id="l86.41"> </span>
<a href="#l86.42"></a><span id="l86.42">   folder = create_folder(&quot;OpeningMessagesNoBackingViewA&quot;);</span>
<a href="#l86.43"></a><span id="l86.43">   make_new_sets_in_folder(folder, [{count: 10}]);</span>
<a href="#l86.44"></a><span id="l86.44">   // We don't obey mail view persistence unless the view picker is there</span>
<a href="#l86.45"></a><span id="l86.45">   add_to_toolbar(mc.e(&quot;mail-bar3&quot;), &quot;mailviews-container&quot;);</span>
<a href="#l86.46"></a><span id="l86.46" class="difflineminus">-};</span>
<a href="#l86.47"></a><span id="l86.47" class="difflineplus">+}</span>
<a href="#l86.48"></a><span id="l86.48"> </span>
<a href="#l86.49"></a><span id="l86.49"> /**</span>
<a href="#l86.50"></a><span id="l86.50">  * Test opening a single message without a backing view in a new tab.</span>
<a href="#l86.51"></a><span id="l86.51">  */</span>
<a href="#l86.52"></a><span id="l86.52"> function test_open_single_message_without_backing_view_in_tab() {</span>
<a href="#l86.53"></a><span id="l86.53">   set_open_message_behavior(&quot;NEW_TAB&quot;);</span>
<a href="#l86.54"></a><span id="l86.54">   let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l86.55"></a><span id="l86.55">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-opening-messages.js</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-opening-messages.js</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineat">@@ -13,36 +13,38 @@</span>
<a href="#l87.4"></a><span id="l87.4">  *   amount of additional work and are hard to test. We're also assuming here</span>
<a href="#l87.5"></a><span id="l87.5">  *   that multiple messages opened in windows are just the same function called</span>
<a href="#l87.6"></a><span id="l87.6">  *   repeatedly.)</span>
<a href="#l87.7"></a><span id="l87.7">  * - reusing an existing window to show another message</span>
<a href="#l87.8"></a><span id="l87.8">  */</span>
<a href="#l87.9"></a><span id="l87.9"> </span>
<a href="#l87.10"></a><span id="l87.10"> &quot;use strict&quot;;</span>
<a href="#l87.11"></a><span id="l87.11"> </span>
<a href="#l87.12"></a><span id="l87.12" class="difflineminus">-var MODULE_NAME = 'test-opening-messages';</span>
<a href="#l87.13"></a><span id="l87.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l87.14"></a><span id="l87.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l87.15"></a><span id="l87.15"> </span>
<a href="#l87.16"></a><span id="l87.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l87.17"></a><span id="l87.17" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l87.18"></a><span id="l87.18" class="difflineplus">+var MODULE_NAME = &quot;test-opening-messages&quot;;</span>
<a href="#l87.19"></a><span id="l87.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l87.20"></a><span id="l87.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l87.21"></a><span id="l87.21"> </span>
<a href="#l87.22"></a><span id="l87.22"> // One folder's enough</span>
<a href="#l87.23"></a><span id="l87.23"> var folder = null;</span>
<a href="#l87.24"></a><span id="l87.24"> </span>
<a href="#l87.25"></a><span id="l87.25"> // Number of messages to open for multi-message tests</span>
<a href="#l87.26"></a><span id="l87.26"> var NUM_MESSAGES_TO_OPEN = 5;</span>
<a href="#l87.27"></a><span id="l87.27"> </span>
<a href="#l87.28"></a><span id="l87.28" class="difflineminus">-var setupModule = function (module) {</span>
<a href="#l87.29"></a><span id="l87.29" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l87.30"></a><span id="l87.30" class="difflineplus">+function setupModule(module) {</span>
<a href="#l87.31"></a><span id="l87.31" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l87.32"></a><span id="l87.32">   fdh.installInto(module);</span>
<a href="#l87.33"></a><span id="l87.33" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l87.34"></a><span id="l87.34" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l87.35"></a><span id="l87.35">   wh.installInto(module);</span>
<a href="#l87.36"></a><span id="l87.36"> </span>
<a href="#l87.37"></a><span id="l87.37">   folder = create_folder(&quot;OpeningMessagesA&quot;);</span>
<a href="#l87.38"></a><span id="l87.38">   make_new_sets_in_folder(folder, [{count: 10}]);</span>
<a href="#l87.39"></a><span id="l87.39" class="difflineminus">-};</span>
<a href="#l87.40"></a><span id="l87.40" class="difflineplus">+}</span>
<a href="#l87.41"></a><span id="l87.41"> </span>
<a href="#l87.42"></a><span id="l87.42"> /**</span>
<a href="#l87.43"></a><span id="l87.43">  * Test opening a single message in a new tab.</span>
<a href="#l87.44"></a><span id="l87.44">  */</span>
<a href="#l87.45"></a><span id="l87.45"> function test_open_single_message_in_tab() {</span>
<a href="#l87.46"></a><span id="l87.46">   set_open_message_behavior(&quot;NEW_TAB&quot;);</span>
<a href="#l87.47"></a><span id="l87.47">   let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l87.48"></a><span id="l87.48">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l87.49"></a><span id="l87.49" class="difflineat">@@ -191,16 +193,16 @@ function check_message_pane_in_window_fu</span>
<a href="#l87.50"></a><span id="l87.50">   let messengerWindowHeight = aWC.e(&quot;messengerWindow&quot;).getBoundingClientRect().height;</span>
<a href="#l87.51"></a><span id="l87.51">   let messengerChildren = aWC.e(&quot;messengerWindow&quot;).children;</span>
<a href="#l87.52"></a><span id="l87.52">   let childrenHeightsSum = 0;</span>
<a href="#l87.53"></a><span id="l87.53">   let childrenHeightsStr = &quot;&quot;;</span>
<a href="#l87.54"></a><span id="l87.54">   for (let child of messengerChildren) {</span>
<a href="#l87.55"></a><span id="l87.55">     try {</span>
<a href="#l87.56"></a><span id="l87.56">       let childRect = child.getBoundingClientRect();</span>
<a href="#l87.57"></a><span id="l87.57">       childrenHeightsSum += childRect.height;</span>
<a href="#l87.58"></a><span id="l87.58" class="difflineminus">-      childrenHeightsStr += '&quot;' + child.id + '&quot;: ' + childRect.height + ', ';</span>
<a href="#l87.59"></a><span id="l87.59" class="difflineplus">+      childrenHeightsStr += '&quot;' + child.id + '&quot;: ' + childRect.height + &quot;, &quot;;</span>
<a href="#l87.60"></a><span id="l87.60">     } catch (ex) {}</span>
<a href="#l87.61"></a><span id="l87.61">   }</span>
<a href="#l87.62"></a><span id="l87.62"> </span>
<a href="#l87.63"></a><span id="l87.63">   assert_equals(Math.round(messengerWindowHeight), Math.round(childrenHeightsSum),</span>
<a href="#l87.64"></a><span id="l87.64">     &quot;messenger window height not equal to the sum of children heights: &quot; +</span>
<a href="#l87.65"></a><span id="l87.65">     childrenHeightsStr);</span>
<a href="#l87.66"></a><span id="l87.66"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-pane-focus.js</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-pane-focus.js</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineat">@@ -3,18 +3,19 @@</span>
<a href="#l88.4"></a><span id="l88.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l88.5"></a><span id="l88.5"> </span>
<a href="#l88.6"></a><span id="l88.6"> /*</span>
<a href="#l88.7"></a><span id="l88.7">  * Test that cycling through the focus of the 3pane's panes works correctly.</span>
<a href="#l88.8"></a><span id="l88.8">  */</span>
<a href="#l88.9"></a><span id="l88.9"> </span>
<a href="#l88.10"></a><span id="l88.10"> &quot;use strict&quot;;</span>
<a href="#l88.11"></a><span id="l88.11"> </span>
<a href="#l88.12"></a><span id="l88.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l88.13"></a><span id="l88.13" class="difflineplus">+</span>
<a href="#l88.14"></a><span id="l88.14"> var MODULE_NAME = &quot;test-pane-focus&quot;;</span>
<a href="#l88.15"></a><span id="l88.15" class="difflineminus">-</span>
<a href="#l88.16"></a><span id="l88.16"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l88.17"></a><span id="l88.17"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l88.18"></a><span id="l88.18"> </span>
<a href="#l88.19"></a><span id="l88.19"> var folder;</span>
<a href="#l88.20"></a><span id="l88.20"> </span>
<a href="#l88.21"></a><span id="l88.21"> function setupModule(module) {</span>
<a href="#l88.22"></a><span id="l88.22">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l88.23"></a><span id="l88.23">   fdh.installInto(module);</span>
<a href="#l88.24"></a><span id="l88.24" class="difflineat">@@ -33,17 +34,17 @@ function setupModule(module) {</span>
<a href="#l88.25"></a><span id="l88.25"> /**</span>
<a href="#l88.26"></a><span id="l88.26">  * Get the currently-focused pane in the 3pane. One of the folder pane, thread</span>
<a href="#l88.27"></a><span id="l88.27">  * pane, or message pane (single- or multi-message).</span>
<a href="#l88.28"></a><span id="l88.28">  *</span>
<a href="#l88.29"></a><span id="l88.29">  * @return the focused pane</span>
<a href="#l88.30"></a><span id="l88.30">  */</span>
<a href="#l88.31"></a><span id="l88.31"> function get_focused_pane() {</span>
<a href="#l88.32"></a><span id="l88.32">   let panes = [</span>
<a href="#l88.33"></a><span id="l88.33" class="difflineminus">-    &quot;threadTree&quot;, &quot;folderTree&quot;, &quot;messagepane&quot;, &quot;multimessage&quot;</span>
<a href="#l88.34"></a><span id="l88.34" class="difflineplus">+    &quot;threadTree&quot;, &quot;folderTree&quot;, &quot;messagepane&quot;, &quot;multimessage&quot;,</span>
<a href="#l88.35"></a><span id="l88.35">   ].map(id =&gt; mc.e(id));</span>
<a href="#l88.36"></a><span id="l88.36"> </span>
<a href="#l88.37"></a><span id="l88.37">   let currentNode = mc.window.top.document.activeElement;</span>
<a href="#l88.38"></a><span id="l88.38"> </span>
<a href="#l88.39"></a><span id="l88.39">   while (currentNode) {</span>
<a href="#l88.40"></a><span id="l88.40">     if (panes.includes(currentNode))</span>
<a href="#l88.41"></a><span id="l88.41">       return currentNode;</span>
<a href="#l88.42"></a><span id="l88.42"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-recent-menu.js</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-recent-menu.js</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineat">@@ -5,25 +5,27 @@</span>
<a href="#l89.4"></a><span id="l89.4"> /**</span>
<a href="#l89.5"></a><span id="l89.5">  * This tests the move/copy to recent folder menus to make sure</span>
<a href="#l89.6"></a><span id="l89.6">  * that they get updated when messages are moved to folders, and</span>
<a href="#l89.7"></a><span id="l89.7">  * don't get updated when we archive.</span>
<a href="#l89.8"></a><span id="l89.8">  */</span>
<a href="#l89.9"></a><span id="l89.9"> </span>
<a href="#l89.10"></a><span id="l89.10"> &quot;use strict&quot;;</span>
<a href="#l89.11"></a><span id="l89.11"> </span>
<a href="#l89.12"></a><span id="l89.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l89.13"></a><span id="l89.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l89.14"></a><span id="l89.14" class="difflineplus">+</span>
<a href="#l89.15"></a><span id="l89.15" class="difflineplus">+var MODULE_NAME = &quot;test-recent-menu&quot;;</span>
<a href="#l89.16"></a><span id="l89.16" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l89.17"></a><span id="l89.17" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l89.18"></a><span id="l89.18" class="difflineplus">+</span>
<a href="#l89.19"></a><span id="l89.19"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l89.20"></a><span id="l89.20"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l89.21"></a><span id="l89.21"> var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l89.22"></a><span id="l89.22"> </span>
<a href="#l89.23"></a><span id="l89.23" class="difflineminus">-var MODULE_NAME = 'test-recent-menu';</span>
<a href="#l89.24"></a><span id="l89.24" class="difflineminus">-</span>
<a href="#l89.25"></a><span id="l89.25" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l89.26"></a><span id="l89.26" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l89.27"></a><span id="l89.27" class="difflineminus">-</span>
<a href="#l89.28"></a><span id="l89.28"> var folder1, folder2;</span>
<a href="#l89.29"></a><span id="l89.29"> var gInitRecentMenuCount;</span>
<a href="#l89.30"></a><span id="l89.30"> </span>
<a href="#l89.31"></a><span id="l89.31"> var setupModule = function(module) {</span>
<a href="#l89.32"></a><span id="l89.32">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l89.33"></a><span id="l89.33">     collector.getModule(lib).installInto(module);</span>
<a href="#l89.34"></a><span id="l89.34">   }</span>
<a href="#l89.35"></a><span id="l89.35"> </span>
<a href="#l89.36"></a><span id="l89.36" class="difflineat">@@ -34,17 +36,17 @@ var setupModule = function(module) {</span>
<a href="#l89.37"></a><span id="l89.37">     folder.setStringProperty(&quot;MRMTime&quot;, &quot;0&quot;);</span>
<a href="#l89.38"></a><span id="l89.38">   }</span>
<a href="#l89.39"></a><span id="l89.39"> </span>
<a href="#l89.40"></a><span id="l89.40">   // Try to make these folders first in alphabetic order</span>
<a href="#l89.41"></a><span id="l89.41">   folder1 = create_folder(&quot;aaafolder1&quot;);</span>
<a href="#l89.42"></a><span id="l89.42">   folder2 = create_folder(&quot;aaafolder2&quot;);</span>
<a href="#l89.43"></a><span id="l89.43"> </span>
<a href="#l89.44"></a><span id="l89.44">   make_new_sets_in_folder(folder1, [{count: 3}]);</span>
<a href="#l89.45"></a><span id="l89.45" class="difflineminus">-}</span>
<a href="#l89.46"></a><span id="l89.46" class="difflineplus">+};</span>
<a href="#l89.47"></a><span id="l89.47"> </span>
<a href="#l89.48"></a><span id="l89.48"> function test_move_message() {</span>
<a href="#l89.49"></a><span id="l89.49">   be_in_folder(folder1);</span>
<a href="#l89.50"></a><span id="l89.50">   let msgHdr = select_click_row(0);</span>
<a href="#l89.51"></a><span id="l89.51">   // This will cause the initial build of the move recent context menu,</span>
<a href="#l89.52"></a><span id="l89.52">   // which should be empty and disabled.</span>
<a href="#l89.53"></a><span id="l89.53">   right_click_on_row(0);</span>
<a href="#l89.54"></a><span id="l89.54">   let popups = mc.click_menus_in_sequence(mc.e(&quot;mailContext&quot;),</span>
<a href="#l89.55"></a><span id="l89.55" class="difflineat">@@ -55,23 +57,23 @@ function test_move_message() {</span>
<a href="#l89.56"></a><span id="l89.56">   gInitRecentMenuCount = recentMenu.itemCount;</span>
<a href="#l89.57"></a><span id="l89.57">   assert_equals(gInitRecentMenuCount, 0);</span>
<a href="#l89.58"></a><span id="l89.58">   mc.close_popup_sequence(popups);</span>
<a href="#l89.59"></a><span id="l89.59">   let array = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l89.60"></a><span id="l89.60">                 .createInstance(Ci.nsIMutableArray);</span>
<a href="#l89.61"></a><span id="l89.61">   array.appendElement(msgHdr);</span>
<a href="#l89.62"></a><span id="l89.62">   let copyListener = {</span>
<a href="#l89.63"></a><span id="l89.63">     copyDone: false,</span>
<a href="#l89.64"></a><span id="l89.64" class="difflineminus">-    OnStartCopy: function() {},</span>
<a href="#l89.65"></a><span id="l89.65" class="difflineminus">-    OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l89.66"></a><span id="l89.66" class="difflineminus">-    SetMessageKey: function(aKey) { },</span>
<a href="#l89.67"></a><span id="l89.67" class="difflineminus">-    SetMessageId: function(aMessageId) {},</span>
<a href="#l89.68"></a><span id="l89.68" class="difflineminus">-    OnStopCopy: function(aStatus) {</span>
<a href="#l89.69"></a><span id="l89.69" class="difflineplus">+    OnStartCopy() {},</span>
<a href="#l89.70"></a><span id="l89.70" class="difflineplus">+    OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l89.71"></a><span id="l89.71" class="difflineplus">+    SetMessageKey(aKey) { },</span>
<a href="#l89.72"></a><span id="l89.72" class="difflineplus">+    SetMessageId(aMessageId) {},</span>
<a href="#l89.73"></a><span id="l89.73" class="difflineplus">+    OnStopCopy(aStatus) {</span>
<a href="#l89.74"></a><span id="l89.74">       this.copyDone = true;</span>
<a href="#l89.75"></a><span id="l89.75" class="difflineminus">-    }</span>
<a href="#l89.76"></a><span id="l89.76" class="difflineplus">+    },</span>
<a href="#l89.77"></a><span id="l89.77">   };</span>
<a href="#l89.78"></a><span id="l89.78">   MailServices.copy.CopyMessages(folder1, array, folder2, true,</span>
<a href="#l89.79"></a><span id="l89.79">                                  copyListener, mc.window.msgWindow, true);</span>
<a href="#l89.80"></a><span id="l89.80">   mc.waitFor(() =&gt; copyListener.copyDone,</span>
<a href="#l89.81"></a><span id="l89.81">              &quot;Timeout waiting for copy to complete&quot;, 10000, 100);</span>
<a href="#l89.82"></a><span id="l89.82">   // We've moved a message to aaafolder2 - it should appear in recent list now.</span>
<a href="#l89.83"></a><span id="l89.83">   // Clicking the menuitem by label is not localizable, but Recent doesn't have an</span>
<a href="#l89.84"></a><span id="l89.84">   // id we can use.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -4,27 +4,29 @@</span>
<a href="#l90.4"></a><span id="l90.4"> </span>
<a href="#l90.5"></a><span id="l90.5"> /*</span>
<a href="#l90.6"></a><span id="l90.6">  * Test the many horrors involving right-clicks, middle clicks, and</span>
<a href="#l90.7"></a><span id="l90.7">  * selections... on folders!</span>
<a href="#l90.8"></a><span id="l90.8">  */</span>
<a href="#l90.9"></a><span id="l90.9"> </span>
<a href="#l90.10"></a><span id="l90.10"> &quot;use strict&quot;;</span>
<a href="#l90.11"></a><span id="l90.11"> </span>
<a href="#l90.12"></a><span id="l90.12" class="difflineminus">-var MODULE_NAME = 'test-right-click-middle-click-folders';</span>
<a href="#l90.13"></a><span id="l90.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l90.14"></a><span id="l90.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l90.15"></a><span id="l90.15"> </span>
<a href="#l90.16"></a><span id="l90.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l90.17"></a><span id="l90.17" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l90.18"></a><span id="l90.18" class="difflineplus">+var MODULE_NAME = &quot;test-right-click-middle-click-folders&quot;;</span>
<a href="#l90.19"></a><span id="l90.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l90.20"></a><span id="l90.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l90.21"></a><span id="l90.21"> </span>
<a href="#l90.22"></a><span id="l90.22"> var folderA, folderB, folderC;</span>
<a href="#l90.23"></a><span id="l90.23"> </span>
<a href="#l90.24"></a><span id="l90.24"> function setupModule(module) {</span>
<a href="#l90.25"></a><span id="l90.25" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l90.26"></a><span id="l90.26" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l90.27"></a><span id="l90.27">   fdh.installInto(module);</span>
<a href="#l90.28"></a><span id="l90.28" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l90.29"></a><span id="l90.29" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l90.30"></a><span id="l90.30">   wh.installInto(module);</span>
<a href="#l90.31"></a><span id="l90.31"> </span>
<a href="#l90.32"></a><span id="l90.32">   folderA = create_folder(&quot;RightClickMiddleClickFoldersA&quot;);</span>
<a href="#l90.33"></a><span id="l90.33">   folderB = create_folder(&quot;RightClickMiddleClickFoldersB&quot;);</span>
<a href="#l90.34"></a><span id="l90.34">   folderC = create_folder(&quot;RightClickMiddleClickFoldersC&quot;);</span>
<a href="#l90.35"></a><span id="l90.35"> </span>
<a href="#l90.36"></a><span id="l90.36">   // We aren't really interested in the messages the folders contain, but just</span>
<a href="#l90.37"></a><span id="l90.37">   // for appearance's sake, add a message to each folder</span>
<a href="#l90.38"></a><span id="l90.38" class="difflineat">@@ -121,17 +123,17 @@ function test_right_click_folder_on_exis</span>
<a href="#l90.39"></a><span id="l90.39"> function _middle_click_folder_with_nothing_selected_helper(aBackground) {</span>
<a href="#l90.40"></a><span id="l90.40">   // This should cause folderA to be displayed</span>
<a href="#l90.41"></a><span id="l90.41">   be_in_folder(folderA);</span>
<a href="#l90.42"></a><span id="l90.42"> </span>
<a href="#l90.43"></a><span id="l90.43">   select_no_folders();</span>
<a href="#l90.44"></a><span id="l90.44">   assert_no_folders_selected();</span>
<a href="#l90.45"></a><span id="l90.45"> </span>
<a href="#l90.46"></a><span id="l90.46">   let originalTab = mc.tabmail.currentTabInfo;</span>
<a href="#l90.47"></a><span id="l90.47" class="difflineminus">-  let [newTab, ] = middle_click_on_folder(folderA);</span>
<a href="#l90.48"></a><span id="l90.48" class="difflineplus">+  let [newTab] = middle_click_on_folder(folderA);</span>
<a href="#l90.49"></a><span id="l90.49">   if (aBackground) {</span>
<a href="#l90.50"></a><span id="l90.50">     // Make sure we haven't switched to the new tab.</span>
<a href="#l90.51"></a><span id="l90.51">     assert_selected_tab(originalTab);</span>
<a href="#l90.52"></a><span id="l90.52">     // Now switch to the new tab and check</span>
<a href="#l90.53"></a><span id="l90.53">     switch_tab(newTab);</span>
<a href="#l90.54"></a><span id="l90.54">   }</span>
<a href="#l90.55"></a><span id="l90.55">   assert_folder_selected_and_displayed(folderA);</span>
<a href="#l90.56"></a><span id="l90.56">   close_tab(newTab);</span>
<a href="#l90.57"></a><span id="l90.57" class="difflineat">@@ -145,17 +147,17 @@ function _middle_click_folder_with_nothi</span>
<a href="#l90.58"></a><span id="l90.58"> /**</span>
<a href="#l90.59"></a><span id="l90.59">  * One-thing selected, middle-click on something else.</span>
<a href="#l90.60"></a><span id="l90.60">  */</span>
<a href="#l90.61"></a><span id="l90.61"> function _middle_click_folder_with_one_thing_selected_helper(aBackground) {</span>
<a href="#l90.62"></a><span id="l90.62">   select_click_folder(folderB);</span>
<a href="#l90.63"></a><span id="l90.63">   assert_folder_selected_and_displayed(folderB);</span>
<a href="#l90.64"></a><span id="l90.64"> </span>
<a href="#l90.65"></a><span id="l90.65">   let originalTab = mc.tabmail.currentTabInfo;</span>
<a href="#l90.66"></a><span id="l90.66" class="difflineminus">-  let [newTab, ] = middle_click_on_folder(folderA);</span>
<a href="#l90.67"></a><span id="l90.67" class="difflineplus">+  let [newTab] = middle_click_on_folder(folderA);</span>
<a href="#l90.68"></a><span id="l90.68">   if (aBackground) {</span>
<a href="#l90.69"></a><span id="l90.69">     // Make sure we haven't switched to the new tab.</span>
<a href="#l90.70"></a><span id="l90.70">     assert_selected_tab(originalTab);</span>
<a href="#l90.71"></a><span id="l90.71">     // Now switch to the new tab and check</span>
<a href="#l90.72"></a><span id="l90.72">     switch_tab(newTab);</span>
<a href="#l90.73"></a><span id="l90.73">   }</span>
<a href="#l90.74"></a><span id="l90.74">   assert_folder_selected_and_displayed(folderA);</span>
<a href="#l90.75"></a><span id="l90.75">   close_tab(newTab);</span>
<a href="#l90.76"></a><span id="l90.76" class="difflineat">@@ -164,17 +166,17 @@ function _middle_click_folder_with_one_t</span>
<a href="#l90.77"></a><span id="l90.77"> }</span>
<a href="#l90.78"></a><span id="l90.78"> </span>
<a href="#l90.79"></a><span id="l90.79"> function _middle_click_folder_with_many_things_selected_helper(aBackground) {</span>
<a href="#l90.80"></a><span id="l90.80">   select_click_folder(folderB);</span>
<a href="#l90.81"></a><span id="l90.81">   select_shift_click_folder(folderC);</span>
<a href="#l90.82"></a><span id="l90.82">   assert_folders_selected_and_displayed(folderB, folderC);</span>
<a href="#l90.83"></a><span id="l90.83"> </span>
<a href="#l90.84"></a><span id="l90.84">   let originalTab = mc.tabmail.currentTabInfo;</span>
<a href="#l90.85"></a><span id="l90.85" class="difflineminus">-  let [newTab, ] = middle_click_on_folder(folderA);</span>
<a href="#l90.86"></a><span id="l90.86" class="difflineplus">+  let [newTab] = middle_click_on_folder(folderA);</span>
<a href="#l90.87"></a><span id="l90.87">   if (aBackground) {</span>
<a href="#l90.88"></a><span id="l90.88">     // Make sure we haven't switched to the new tab.</span>
<a href="#l90.89"></a><span id="l90.89">     assert_selected_tab(originalTab);</span>
<a href="#l90.90"></a><span id="l90.90">     // Now switch to the new tab and check</span>
<a href="#l90.91"></a><span id="l90.91">     switch_tab(newTab);</span>
<a href="#l90.92"></a><span id="l90.92">   }</span>
<a href="#l90.93"></a><span id="l90.93">   assert_folder_selected_and_displayed(folderA);</span>
<a href="#l90.94"></a><span id="l90.94">   close_tab(newTab);</span>
<a href="#l90.95"></a><span id="l90.95" class="difflineat">@@ -187,17 +189,17 @@ function _middle_click_folder_with_many_</span>
<a href="#l90.96"></a><span id="l90.96"> /**</span>
<a href="#l90.97"></a><span id="l90.97">  * One thing selected, middle-click on that.</span>
<a href="#l90.98"></a><span id="l90.98">  */</span>
<a href="#l90.99"></a><span id="l90.99"> function _middle_click_folder_on_existing_single_selection_helper(aBackground) {</span>
<a href="#l90.100"></a><span id="l90.100">   select_click_folder(folderC);</span>
<a href="#l90.101"></a><span id="l90.101">   assert_folder_selected_and_displayed(folderC);</span>
<a href="#l90.102"></a><span id="l90.102"> </span>
<a href="#l90.103"></a><span id="l90.103">   let originalTab = mc.tabmail.currentTabInfo;</span>
<a href="#l90.104"></a><span id="l90.104" class="difflineminus">-  let [newTab, ] = middle_click_on_folder(folderC);</span>
<a href="#l90.105"></a><span id="l90.105" class="difflineplus">+  let [newTab] = middle_click_on_folder(folderC);</span>
<a href="#l90.106"></a><span id="l90.106">   if (aBackground) {</span>
<a href="#l90.107"></a><span id="l90.107">     // Make sure we haven't switched to the new tab.</span>
<a href="#l90.108"></a><span id="l90.108">     assert_selected_tab(originalTab);</span>
<a href="#l90.109"></a><span id="l90.109">     // Now switch to the new tab and check</span>
<a href="#l90.110"></a><span id="l90.110">     switch_tab(newTab);</span>
<a href="#l90.111"></a><span id="l90.111">   }</span>
<a href="#l90.112"></a><span id="l90.112">   assert_folder_selected_and_displayed(folderC);</span>
<a href="#l90.113"></a><span id="l90.113">   close_tab(newTab);</span>
<a href="#l90.114"></a><span id="l90.114" class="difflineat">@@ -209,17 +211,17 @@ function _middle_click_folder_on_existin</span>
<a href="#l90.115"></a><span id="l90.115">  * Many things selected, middle-click somewhere in the selection.</span>
<a href="#l90.116"></a><span id="l90.116">  */</span>
<a href="#l90.117"></a><span id="l90.117"> function _middle_click_on_existing_multi_selection_helper(aBackground) {</span>
<a href="#l90.118"></a><span id="l90.118">   select_click_folder(folderA);</span>
<a href="#l90.119"></a><span id="l90.119">   select_shift_click_folder(folderC);</span>
<a href="#l90.120"></a><span id="l90.120">   assert_folders_selected_and_displayed(folderA, folderB, folderC);</span>
<a href="#l90.121"></a><span id="l90.121"> </span>
<a href="#l90.122"></a><span id="l90.122">   let originalTab = mc.tabmail.currentTabInfo;</span>
<a href="#l90.123"></a><span id="l90.123" class="difflineminus">-  let [newTab, ] = middle_click_on_folder(folderB);</span>
<a href="#l90.124"></a><span id="l90.124" class="difflineplus">+  let [newTab] = middle_click_on_folder(folderB);</span>
<a href="#l90.125"></a><span id="l90.125">   if (aBackground) {</span>
<a href="#l90.126"></a><span id="l90.126">     // Make sure we haven't switched to the new tab.</span>
<a href="#l90.127"></a><span id="l90.127">     assert_selected_tab(originalTab);</span>
<a href="#l90.128"></a><span id="l90.128">     // Now switch to the new tab and check</span>
<a href="#l90.129"></a><span id="l90.129">     switch_tab(newTab);</span>
<a href="#l90.130"></a><span id="l90.130">   }</span>
<a href="#l90.131"></a><span id="l90.131">   assert_folder_selected_and_displayed(folderB);</span>
<a href="#l90.132"></a><span id="l90.132">   close_tab(newTab);</span>
<a href="#l90.133"></a><span id="l90.133" class="difflineat">@@ -250,10 +252,10 @@ function _generate_background_foreground</span>
<a href="#l90.134"></a><span id="l90.134">     };</span>
<a href="#l90.135"></a><span id="l90.135">   }</span>
<a href="#l90.136"></a><span id="l90.136"> }</span>
<a href="#l90.137"></a><span id="l90.137"> </span>
<a href="#l90.138"></a><span id="l90.138"> _generate_background_foreground_tests([</span>
<a href="#l90.139"></a><span id="l90.139">   &quot;middle_click_folder_with_nothing_selected&quot;,</span>
<a href="#l90.140"></a><span id="l90.140">   &quot;middle_click_folder_with_one_thing_selected&quot;,</span>
<a href="#l90.141"></a><span id="l90.141">   &quot;middle_click_folder_with_many_things_selected&quot;,</span>
<a href="#l90.142"></a><span id="l90.142" class="difflineminus">-  &quot;middle_click_folder_on_existing_single_selection&quot;</span>
<a href="#l90.143"></a><span id="l90.143" class="difflineplus">+  &quot;middle_click_folder_on_existing_single_selection&quot;,</span>
<a href="#l90.144"></a><span id="l90.144"> ]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineat">@@ -3,34 +3,36 @@</span>
<a href="#l91.4"></a><span id="l91.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l91.5"></a><span id="l91.5"> </span>
<a href="#l91.6"></a><span id="l91.6"> /*</span>
<a href="#l91.7"></a><span id="l91.7">  * Test the many horrors involving right-clicks, middle clicks, and selections.</span>
<a href="#l91.8"></a><span id="l91.8">  */</span>
<a href="#l91.9"></a><span id="l91.9"> </span>
<a href="#l91.10"></a><span id="l91.10"> &quot;use strict&quot;;</span>
<a href="#l91.11"></a><span id="l91.11"> </span>
<a href="#l91.12"></a><span id="l91.12" class="difflineminus">-var MODULE_NAME = 'test-right-click-middle-click-messages';</span>
<a href="#l91.13"></a><span id="l91.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l91.14"></a><span id="l91.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l91.15"></a><span id="l91.15"> </span>
<a href="#l91.16"></a><span id="l91.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l91.17"></a><span id="l91.17" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l91.18"></a><span id="l91.18" class="difflineplus">+var MODULE_NAME = &quot;test-right-click-middle-click-messages&quot;;</span>
<a href="#l91.19"></a><span id="l91.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l91.20"></a><span id="l91.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l91.21"></a><span id="l91.21"> </span>
<a href="#l91.22"></a><span id="l91.22"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l91.23"></a><span id="l91.23"> </span>
<a href="#l91.24"></a><span id="l91.24"> var folder, threadedFolder;</span>
<a href="#l91.25"></a><span id="l91.25"> </span>
<a href="#l91.26"></a><span id="l91.26"> /**</span>
<a href="#l91.27"></a><span id="l91.27">  * The number of messages in the thread we use to test.</span>
<a href="#l91.28"></a><span id="l91.28">  */</span>
<a href="#l91.29"></a><span id="l91.29"> var NUM_MESSAGES_IN_THREAD = 6;</span>
<a href="#l91.30"></a><span id="l91.30"> </span>
<a href="#l91.31"></a><span id="l91.31"> function setupModule(module) {</span>
<a href="#l91.32"></a><span id="l91.32" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l91.33"></a><span id="l91.33" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l91.34"></a><span id="l91.34">   fdh.installInto(module);</span>
<a href="#l91.35"></a><span id="l91.35" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l91.36"></a><span id="l91.36" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l91.37"></a><span id="l91.37">   wh.installInto(module);</span>
<a href="#l91.38"></a><span id="l91.38"> </span>
<a href="#l91.39"></a><span id="l91.39">   folder = create_folder(&quot;RightClickMiddleClickA&quot;);</span>
<a href="#l91.40"></a><span id="l91.40">   threadedFolder = create_folder(&quot;RightClickMiddleClickB&quot;);</span>
<a href="#l91.41"></a><span id="l91.41">   // we want exactly as many messages as we plan to delete, so that we can test</span>
<a href="#l91.42"></a><span id="l91.42">   //  that the message window and tabs close when they run out of things to</span>
<a href="#l91.43"></a><span id="l91.43">   //  to display.</span>
<a href="#l91.44"></a><span id="l91.44">   make_new_sets_in_folder(folder, [{count: 20}]);</span>
<a href="#l91.45"></a><span id="l91.45" class="difflineat">@@ -170,18 +172,17 @@ function _middle_click_with_nothing_sele</span>
<a href="#l91.46"></a><span id="l91.46">   // come back</span>
<a href="#l91.47"></a><span id="l91.47">   focus_thread_tree();</span>
<a href="#l91.48"></a><span id="l91.48">   let [tabMessage, curMessage] = middle_click_on_row(1);</span>
<a href="#l91.49"></a><span id="l91.49">   if (aBackground) {</span>
<a href="#l91.50"></a><span id="l91.50">     // Make sure we haven't switched to the new tab.</span>
<a href="#l91.51"></a><span id="l91.51">     assert_selected_tab(folderTab);</span>
<a href="#l91.52"></a><span id="l91.52">     // Now switch to the new tab and check</span>
<a href="#l91.53"></a><span id="l91.53">     switch_tab(tabMessage);</span>
<a href="#l91.54"></a><span id="l91.54" class="difflineminus">-  }</span>
<a href="#l91.55"></a><span id="l91.55" class="difflineminus">-  else {</span>
<a href="#l91.56"></a><span id="l91.56" class="difflineplus">+  } else {</span>
<a href="#l91.57"></a><span id="l91.57">     wait_for_message_display_completion();</span>
<a href="#l91.58"></a><span id="l91.58">   }</span>
<a href="#l91.59"></a><span id="l91.59"> </span>
<a href="#l91.60"></a><span id="l91.60">   assert_selected_and_displayed(curMessage);</span>
<a href="#l91.61"></a><span id="l91.61">   assert_message_pane_focused();</span>
<a href="#l91.62"></a><span id="l91.62">   close_tab(tabMessage);</span>
<a href="#l91.63"></a><span id="l91.63"> </span>
<a href="#l91.64"></a><span id="l91.64">   assert_nothing_selected();</span>
<a href="#l91.65"></a><span id="l91.65" class="difflineat">@@ -199,18 +200,17 @@ function _middle_click_with_one_thing_se</span>
<a href="#l91.66"></a><span id="l91.66"> </span>
<a href="#l91.67"></a><span id="l91.67">   let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l91.68"></a><span id="l91.68">   let [tabMessage, curMessage] = middle_click_on_row(1);</span>
<a href="#l91.69"></a><span id="l91.69">   if (aBackground) {</span>
<a href="#l91.70"></a><span id="l91.70">     // Make sure we haven't switched to the new tab.</span>
<a href="#l91.71"></a><span id="l91.71">     assert_selected_tab(folderTab);</span>
<a href="#l91.72"></a><span id="l91.72">     // Now switch to the new tab and check</span>
<a href="#l91.73"></a><span id="l91.73">     switch_tab(tabMessage);</span>
<a href="#l91.74"></a><span id="l91.74" class="difflineminus">-  }</span>
<a href="#l91.75"></a><span id="l91.75" class="difflineminus">-  else {</span>
<a href="#l91.76"></a><span id="l91.76" class="difflineplus">+  } else {</span>
<a href="#l91.77"></a><span id="l91.77">     wait_for_message_display_completion();</span>
<a href="#l91.78"></a><span id="l91.78">   }</span>
<a href="#l91.79"></a><span id="l91.79"> </span>
<a href="#l91.80"></a><span id="l91.80">   assert_selected_and_displayed(curMessage);</span>
<a href="#l91.81"></a><span id="l91.81">   assert_message_pane_focused();</span>
<a href="#l91.82"></a><span id="l91.82">   close_tab(tabMessage);</span>
<a href="#l91.83"></a><span id="l91.83"> </span>
<a href="#l91.84"></a><span id="l91.84">   assert_selected_and_displayed(0);</span>
<a href="#l91.85"></a><span id="l91.85" class="difflineat">@@ -230,18 +230,17 @@ function _middle_click_with_many_things_</span>
<a href="#l91.86"></a><span id="l91.86"> </span>
<a href="#l91.87"></a><span id="l91.87">   let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l91.88"></a><span id="l91.88">   let [tabMessage, curMessage] = middle_click_on_row(1);</span>
<a href="#l91.89"></a><span id="l91.89">   if (aBackground) {</span>
<a href="#l91.90"></a><span id="l91.90">     // Make sure we haven't switched to the new tab.</span>
<a href="#l91.91"></a><span id="l91.91">     assert_selected_tab(folderTab);</span>
<a href="#l91.92"></a><span id="l91.92">     // Now switch to the new tab and check</span>
<a href="#l91.93"></a><span id="l91.93">     switch_tab(tabMessage);</span>
<a href="#l91.94"></a><span id="l91.94" class="difflineminus">-  }</span>
<a href="#l91.95"></a><span id="l91.95" class="difflineminus">-  else {</span>
<a href="#l91.96"></a><span id="l91.96" class="difflineplus">+  } else {</span>
<a href="#l91.97"></a><span id="l91.97">     wait_for_message_display_completion();</span>
<a href="#l91.98"></a><span id="l91.98">   }</span>
<a href="#l91.99"></a><span id="l91.99"> </span>
<a href="#l91.100"></a><span id="l91.100">   assert_selected_and_displayed(curMessage);</span>
<a href="#l91.101"></a><span id="l91.101">   assert_message_pane_focused();</span>
<a href="#l91.102"></a><span id="l91.102">   close_tab(tabMessage);</span>
<a href="#l91.103"></a><span id="l91.103"> </span>
<a href="#l91.104"></a><span id="l91.104">   assert_selected_and_displayed([0, 5]);</span>
<a href="#l91.105"></a><span id="l91.105" class="difflineat">@@ -259,18 +258,17 @@ function _middle_click_on_existing_singl</span>
<a href="#l91.106"></a><span id="l91.106"> </span>
<a href="#l91.107"></a><span id="l91.107">   let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l91.108"></a><span id="l91.108">   let [tabMessage, curMessage] = middle_click_on_row(3);</span>
<a href="#l91.109"></a><span id="l91.109">   if (aBackground) {</span>
<a href="#l91.110"></a><span id="l91.110">     // Make sure we haven't switched to the new tab.</span>
<a href="#l91.111"></a><span id="l91.111">     assert_selected_tab(folderTab);</span>
<a href="#l91.112"></a><span id="l91.112">     // Now switch to the new tab and check</span>
<a href="#l91.113"></a><span id="l91.113">     switch_tab(tabMessage);</span>
<a href="#l91.114"></a><span id="l91.114" class="difflineminus">-  }</span>
<a href="#l91.115"></a><span id="l91.115" class="difflineminus">-  else {</span>
<a href="#l91.116"></a><span id="l91.116" class="difflineplus">+  } else {</span>
<a href="#l91.117"></a><span id="l91.117">     wait_for_message_display_completion();</span>
<a href="#l91.118"></a><span id="l91.118">   }</span>
<a href="#l91.119"></a><span id="l91.119"> </span>
<a href="#l91.120"></a><span id="l91.120">   assert_selected_and_displayed(curMessage);</span>
<a href="#l91.121"></a><span id="l91.121">   assert_message_pane_focused();</span>
<a href="#l91.122"></a><span id="l91.122">   close_tab(tabMessage);</span>
<a href="#l91.123"></a><span id="l91.123"> </span>
<a href="#l91.124"></a><span id="l91.124">   assert_selected_and_displayed(3);</span>
<a href="#l91.125"></a><span id="l91.125" class="difflineat">@@ -289,18 +287,17 @@ function _middle_click_on_existing_multi</span>
<a href="#l91.126"></a><span id="l91.126"> </span>
<a href="#l91.127"></a><span id="l91.127">   let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l91.128"></a><span id="l91.128">   let [tabMessage, curMessage] = middle_click_on_row(5);</span>
<a href="#l91.129"></a><span id="l91.129">   if (aBackground) {</span>
<a href="#l91.130"></a><span id="l91.130">     // Make sure we haven't switched to the new tab.</span>
<a href="#l91.131"></a><span id="l91.131">     assert_selected_tab(folderTab);</span>
<a href="#l91.132"></a><span id="l91.132">     // Now switch to the new tab and check</span>
<a href="#l91.133"></a><span id="l91.133">     switch_tab(tabMessage);</span>
<a href="#l91.134"></a><span id="l91.134" class="difflineminus">-  }</span>
<a href="#l91.135"></a><span id="l91.135" class="difflineminus">-  else {</span>
<a href="#l91.136"></a><span id="l91.136" class="difflineplus">+  } else {</span>
<a href="#l91.137"></a><span id="l91.137">     wait_for_message_display_completion();</span>
<a href="#l91.138"></a><span id="l91.138">   }</span>
<a href="#l91.139"></a><span id="l91.139"> </span>
<a href="#l91.140"></a><span id="l91.140">   assert_selected_and_displayed(curMessage);</span>
<a href="#l91.141"></a><span id="l91.141">   assert_message_pane_focused();</span>
<a href="#l91.142"></a><span id="l91.142">   close_tab(tabMessage);</span>
<a href="#l91.143"></a><span id="l91.143"> </span>
<a href="#l91.144"></a><span id="l91.144">   assert_selected_and_displayed([3, 6]);</span>
<a href="#l91.145"></a><span id="l91.145" class="difflineat">@@ -327,17 +324,17 @@ function _middle_click_on_collapsed_thre</span>
<a href="#l91.146"></a><span id="l91.146"> </span>
<a href="#l91.147"></a><span id="l91.147">   // Since reflowing a tree (eg when switching tabs) ensures that the current</span>
<a href="#l91.148"></a><span id="l91.148">   // index is brought into view, we need to set the current index so that we</span>
<a href="#l91.149"></a><span id="l91.149">   // don't scroll because of it. So click on the first visible row.</span>
<a href="#l91.150"></a><span id="l91.150">   select_click_row(preFirstRow);</span>
<a href="#l91.151"></a><span id="l91.151"> </span>
<a href="#l91.152"></a><span id="l91.152">   // Middle-click on the root of the collapsed thread, which is also the last</span>
<a href="#l91.153"></a><span id="l91.153">   // row</span>
<a href="#l91.154"></a><span id="l91.154" class="difflineminus">-  let [tabMessage, ] = middle_click_on_row(</span>
<a href="#l91.155"></a><span id="l91.155" class="difflineplus">+  let [tabMessage] = middle_click_on_row(</span>
<a href="#l91.156"></a><span id="l91.156">                            mc.folderDisplay.view.dbView.rowCount - 1);</span>
<a href="#l91.157"></a><span id="l91.157"> </span>
<a href="#l91.158"></a><span id="l91.158">   if (!aBackground) {</span>
<a href="#l91.159"></a><span id="l91.159">     wait_for_message_display_completion();</span>
<a href="#l91.160"></a><span id="l91.160">     // Switch back to the folder tab</span>
<a href="#l91.161"></a><span id="l91.161">     switch_tab(folderTab);</span>
<a href="#l91.162"></a><span id="l91.162">   }</span>
<a href="#l91.163"></a><span id="l91.163"> </span>
<a href="#l91.164"></a><span id="l91.164" class="difflineat">@@ -370,17 +367,17 @@ function _middle_click_on_expanded_threa</span>
<a href="#l91.165"></a><span id="l91.165"> </span>
<a href="#l91.166"></a><span id="l91.166">   // Since reflowing a tree (eg when switching tabs) ensures that the current</span>
<a href="#l91.167"></a><span id="l91.167">   // index is brought into view, we need to set the current index so that we</span>
<a href="#l91.168"></a><span id="l91.168">   // don't scroll because of it. So click on the first visible row.</span>
<a href="#l91.169"></a><span id="l91.169">   select_click_row(preFirstRow);</span>
<a href="#l91.170"></a><span id="l91.170"> </span>
<a href="#l91.171"></a><span id="l91.171">   // Middle-click on the root of the expanded thread, which is the row with</span>
<a href="#l91.172"></a><span id="l91.172">   // index (number of rows - number of messages in thread).</span>
<a href="#l91.173"></a><span id="l91.173" class="difflineminus">-  let [tabMessage, ] = middle_click_on_row(</span>
<a href="#l91.174"></a><span id="l91.174" class="difflineplus">+  let [tabMessage] = middle_click_on_row(</span>
<a href="#l91.175"></a><span id="l91.175">       mc.folderDisplay.view.dbView.rowCount - NUM_MESSAGES_IN_THREAD);</span>
<a href="#l91.176"></a><span id="l91.176"> </span>
<a href="#l91.177"></a><span id="l91.177">   if (!aBackground) {</span>
<a href="#l91.178"></a><span id="l91.178">     wait_for_message_display_completion();</span>
<a href="#l91.179"></a><span id="l91.179">     // Switch back to the folder tab</span>
<a href="#l91.180"></a><span id="l91.180">     switch_tab(folderTab);</span>
<a href="#l91.181"></a><span id="l91.181">   }</span>
<a href="#l91.182"></a><span id="l91.182"> </span>
<a href="#l91.183"></a><span id="l91.183" class="difflineat">@@ -416,17 +413,17 @@ function _generate_background_foreground</span>
<a href="#l91.184"></a><span id="l91.184"> </span>
<a href="#l91.185"></a><span id="l91.185"> _generate_background_foreground_tests([</span>
<a href="#l91.186"></a><span id="l91.186">   &quot;middle_click_with_nothing_selected&quot;,</span>
<a href="#l91.187"></a><span id="l91.187">   &quot;middle_click_with_one_thing_selected&quot;,</span>
<a href="#l91.188"></a><span id="l91.188">   &quot;middle_click_with_many_things_selected&quot;,</span>
<a href="#l91.189"></a><span id="l91.189">   &quot;middle_click_on_existing_single_selection&quot;,</span>
<a href="#l91.190"></a><span id="l91.190">   &quot;middle_click_on_existing_multi_selection&quot;,</span>
<a href="#l91.191"></a><span id="l91.191">   &quot;middle_click_on_collapsed_thread_root&quot;,</span>
<a href="#l91.192"></a><span id="l91.192" class="difflineminus">-  &quot;middle_click_on_expanded_thread_root&quot;</span>
<a href="#l91.193"></a><span id="l91.193" class="difflineplus">+  &quot;middle_click_on_expanded_thread_root&quot;,</span>
<a href="#l91.194"></a><span id="l91.194"> ]);</span>
<a href="#l91.195"></a><span id="l91.195"> </span>
<a href="#l91.196"></a><span id="l91.196"> /**</span>
<a href="#l91.197"></a><span id="l91.197">  * Right-click on something and delete it, having no selection previously.</span>
<a href="#l91.198"></a><span id="l91.198">  */</span>
<a href="#l91.199"></a><span id="l91.199"> function test_right_click_deletion_nothing_selected() {</span>
<a href="#l91.200"></a><span id="l91.200">   be_in_folder(folder);</span>
<a href="#l91.201"></a><span id="l91.201"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l92.1"></a><span id="l92.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js</span>
<a href="#l92.2"></a><span id="l92.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js</span>
<a href="#l92.3"></a><span id="l92.3" class="difflineat">@@ -4,65 +4,67 @@</span>
<a href="#l92.4"></a><span id="l92.4"> </span>
<a href="#l92.5"></a><span id="l92.5"> /**</span>
<a href="#l92.6"></a><span id="l92.6">  * Test reload of saved searches over local folders after compaction</span>
<a href="#l92.7"></a><span id="l92.7">  * of local folders.</span>
<a href="#l92.8"></a><span id="l92.8">  */</span>
<a href="#l92.9"></a><span id="l92.9"> </span>
<a href="#l92.10"></a><span id="l92.10"> &quot;use strict&quot;;</span>
<a href="#l92.11"></a><span id="l92.11"> </span>
<a href="#l92.12"></a><span id="l92.12" class="difflineminus">-var MODULE_NAME = &quot;test-savedsearch-reload-after-compact&quot;;</span>
<a href="#l92.13"></a><span id="l92.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l92.14"></a><span id="l92.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l92.15"></a><span id="l92.15"> </span>
<a href="#l92.16"></a><span id="l92.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l92.17"></a><span id="l92.17" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l92.18"></a><span id="l92.18" class="difflineplus">+var MODULE_NAME = &quot;test-savedsearch-reload-after-compact&quot;;</span>
<a href="#l92.19"></a><span id="l92.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l92.20"></a><span id="l92.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l92.21"></a><span id="l92.21"> </span>
<a href="#l92.22"></a><span id="l92.22"> function setupModule(module) {</span>
<a href="#l92.23"></a><span id="l92.23" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l92.24"></a><span id="l92.24" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l92.25"></a><span id="l92.25">   fdh.installInto(module);</span>
<a href="#l92.26"></a><span id="l92.26" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l92.27"></a><span id="l92.27" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l92.28"></a><span id="l92.28">   wh.installInto(module);</span>
<a href="#l92.29"></a><span id="l92.29"> }</span>
<a href="#l92.30"></a><span id="l92.30"> </span>
<a href="#l92.31"></a><span id="l92.31"> /**</span>
<a href="#l92.32"></a><span id="l92.32">  * Add some messages to a folder, delete the first one, and create a saved</span>
<a href="#l92.33"></a><span id="l92.33">  * search over the inbox and the folder. Then, compact folders.</span>
<a href="#l92.34"></a><span id="l92.34">  */</span>
<a href="#l92.35"></a><span id="l92.35"> function test_setup_virtual_folder_and_compact() {</span>
<a href="#l92.36"></a><span id="l92.36">   let otherFolder = create_folder(&quot;otherFolder&quot;);</span>
<a href="#l92.37"></a><span id="l92.37" class="difflineminus">-  let [msgSet] = make_new_sets_in_folder(otherFolder, [{count: 2}]);</span>
<a href="#l92.38"></a><span id="l92.38" class="difflineplus">+  make_new_sets_in_folder(otherFolder, [{count: 2}]);</span>
<a href="#l92.39"></a><span id="l92.39"> </span>
<a href="#l92.40"></a><span id="l92.40">   /**</span>
<a href="#l92.41"></a><span id="l92.41">    * We delete the first message in the local folder, so compaction of the</span>
<a href="#l92.42"></a><span id="l92.42">    * folder will invalidate the key of the second message in the folder. Then,</span>
<a href="#l92.43"></a><span id="l92.43">    * we select the second message and issue the compact. This causes saving the</span>
<a href="#l92.44"></a><span id="l92.44">    * selection on the compaction notification to fail. We test the saved search</span>
<a href="#l92.45"></a><span id="l92.45">    * view still gets rebuilt, such that there is a valid msg hdr at row 0.</span>
<a href="#l92.46"></a><span id="l92.46">    */</span>
<a href="#l92.47"></a><span id="l92.47">   be_in_folder(otherFolder);</span>
<a href="#l92.48"></a><span id="l92.48" class="difflineminus">-  let curMessage = select_click_row(0);</span>
<a href="#l92.49"></a><span id="l92.49" class="difflineplus">+  select_click_row(0);</span>
<a href="#l92.50"></a><span id="l92.50">   press_delete();</span>
<a href="#l92.51"></a><span id="l92.51"> </span>
<a href="#l92.52"></a><span id="l92.52">   let folderVirtual = create_virtual_folder([inboxFolder, otherFolder], {},</span>
<a href="#l92.53"></a><span id="l92.53">                                             true, &quot;SavedSearch&quot;);</span>
<a href="#l92.54"></a><span id="l92.54"> </span>
<a href="#l92.55"></a><span id="l92.55">   be_in_folder(folderVirtual);</span>
<a href="#l92.56"></a><span id="l92.56" class="difflineminus">-  curMessage = select_click_row(0);</span>
<a href="#l92.57"></a><span id="l92.57" class="difflineplus">+  select_click_row(0);</span>
<a href="#l92.58"></a><span id="l92.58">   let urlListener = {</span>
<a href="#l92.59"></a><span id="l92.59">     compactDone: false,</span>
<a href="#l92.60"></a><span id="l92.60"> </span>
<a href="#l92.61"></a><span id="l92.61" class="difflineminus">-    OnStartRunningUrl: function (aUrl) {</span>
<a href="#l92.62"></a><span id="l92.62" class="difflineplus">+    OnStartRunningUrl(aUrl) {</span>
<a href="#l92.63"></a><span id="l92.63">     },</span>
<a href="#l92.64"></a><span id="l92.64" class="difflineminus">-    OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l92.65"></a><span id="l92.65" class="difflineplus">+    OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l92.66"></a><span id="l92.66">       this.compactDone = true;</span>
<a href="#l92.67"></a><span id="l92.67" class="difflineminus">-    }</span>
<a href="#l92.68"></a><span id="l92.68" class="difflineplus">+    },</span>
<a href="#l92.69"></a><span id="l92.69">   };</span>
<a href="#l92.70"></a><span id="l92.70">   if (otherFolder.msgStore.supportsCompaction) {</span>
<a href="#l92.71"></a><span id="l92.71">     otherFolder.compactAll(urlListener, null, false);</span>
<a href="#l92.72"></a><span id="l92.72"> </span>
<a href="#l92.73"></a><span id="l92.73">     mc.waitFor(() =&gt; urlListener.compactDone,</span>
<a href="#l92.74"></a><span id="l92.74">                &quot;Timeout waiting for compact to complete&quot;, 10000, 100);</span>
<a href="#l92.75"></a><span id="l92.75">   }</span>
<a href="#l92.76"></a><span id="l92.76">   // Let the event queue clear.</span>
<a href="#l92.77"></a><span id="l92.77">   mc.sleep(0);</span>
<a href="#l92.78"></a><span id="l92.78">   // Check view is still valid</span>
<a href="#l92.79"></a><span id="l92.79" class="difflineminus">-  let msgHdr = mc.dbView.getMsgHdrAt(0);</span>
<a href="#l92.80"></a><span id="l92.80" class="difflineplus">+  mc.dbView.getMsgHdrAt(0);</span>
<a href="#l92.81"></a><span id="l92.81"> }</span>
<a href="#l92.82"></a><span id="l92.82"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l93.1"></a><span id="l93.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-selection.js</span>
<a href="#l93.2"></a><span id="l93.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-selection.js</span>
<a href="#l93.3"></a><span id="l93.3" class="difflineat">@@ -1,24 +1,25 @@</span>
<a href="#l93.4"></a><span id="l93.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l93.5"></a><span id="l93.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l93.6"></a><span id="l93.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l93.7"></a><span id="l93.7"> </span>
<a href="#l93.8"></a><span id="l93.8"> &quot;use strict&quot;;</span>
<a href="#l93.9"></a><span id="l93.9"> </span>
<a href="#l93.10"></a><span id="l93.10" class="difflineminus">-var MODULE_NAME = 'test-selection';</span>
<a href="#l93.11"></a><span id="l93.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l93.12"></a><span id="l93.12"> </span>
<a href="#l93.13"></a><span id="l93.13" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l93.14"></a><span id="l93.14" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l93.15"></a><span id="l93.15" class="difflineplus">+var MODULE_NAME = &quot;test-selection&quot;;</span>
<a href="#l93.16"></a><span id="l93.16" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l93.17"></a><span id="l93.17" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l93.18"></a><span id="l93.18"> </span>
<a href="#l93.19"></a><span id="l93.19"> // let us have 2 folders</span>
<a href="#l93.20"></a><span id="l93.20"> var folder = null, folder2 = null;</span>
<a href="#l93.21"></a><span id="l93.21"> </span>
<a href="#l93.22"></a><span id="l93.22"> var setupModule = function(module) {</span>
<a href="#l93.23"></a><span id="l93.23" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l93.24"></a><span id="l93.24" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l93.25"></a><span id="l93.25">   fdh.installInto(module);</span>
<a href="#l93.26"></a><span id="l93.26"> </span>
<a href="#l93.27"></a><span id="l93.27">   folder = create_folder(&quot;SelectionA&quot;);</span>
<a href="#l93.28"></a><span id="l93.28">   folder2 = create_folder(&quot;SelectionB&quot;);</span>
<a href="#l93.29"></a><span id="l93.29">   make_new_sets_in_folders([folder, folder2], [{count: 50}]);</span>
<a href="#l93.30"></a><span id="l93.30"> };</span>
<a href="#l93.31"></a><span id="l93.31"> </span>
<a href="#l93.32"></a><span id="l93.32"> // https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c80</span>
<a href="#l93.33"></a><span id="l93.33" class="difflineat">@@ -93,38 +94,38 @@ function test_selection_persists_through</span>
<a href="#l93.34"></a><span id="l93.34"> </span>
<a href="#l93.35"></a><span id="l93.35">   switch_tab(tab2);</span>
<a href="#l93.36"></a><span id="l93.36">   assert_nothing_selected();</span>
<a href="#l93.37"></a><span id="l93.37">   select_click_row(3);</span>
<a href="#l93.38"></a><span id="l93.38"> </span>
<a href="#l93.39"></a><span id="l93.39">   switch_tab(tab1);</span>
<a href="#l93.40"></a><span id="l93.40">   assert_selected_and_displayed(2);</span>
<a href="#l93.41"></a><span id="l93.41">   select_shift_click_row(4); // 2-4 selected</span>
<a href="#l93.42"></a><span id="l93.42" class="difflineminus">-  assert_selected_and_displayed([2,4]); // ensures multi-message summary</span>
<a href="#l93.43"></a><span id="l93.43" class="difflineplus">+  assert_selected_and_displayed([2, 4]); // ensures multi-message summary</span>
<a href="#l93.44"></a><span id="l93.44"> </span>
<a href="#l93.45"></a><span id="l93.45">   switch_tab(tab2);</span>
<a href="#l93.46"></a><span id="l93.46">   assert_selected_and_displayed(3);</span>
<a href="#l93.47"></a><span id="l93.47"> </span>
<a href="#l93.48"></a><span id="l93.48">   close_tab(tab2);</span>
<a href="#l93.49"></a><span id="l93.49" class="difflineminus">-  assert_selected_and_displayed([2,4]);</span>
<a href="#l93.50"></a><span id="l93.50" class="difflineplus">+  assert_selected_and_displayed([2, 4]);</span>
<a href="#l93.51"></a><span id="l93.51"> }</span>
<a href="#l93.52"></a><span id="l93.52"> </span>
<a href="#l93.53"></a><span id="l93.53"> // https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c87</span>
<a href="#l93.54"></a><span id="l93.54"> /**</span>
<a href="#l93.55"></a><span id="l93.55">  * Verify that we scroll to new messages when we enter a folder.</span>
<a href="#l93.56"></a><span id="l93.56">  */</span>
<a href="#l93.57"></a><span id="l93.57"> function test_enter_scroll_to_new() {</span>
<a href="#l93.58"></a><span id="l93.58">   // be in the folder</span>
<a href="#l93.59"></a><span id="l93.59">   be_in_folder(folder);</span>
<a href="#l93.60"></a><span id="l93.60">   // make sure the sort is ascending...</span>
<a href="#l93.61"></a><span id="l93.61">   mc.folderDisplay.view.sortAscending();</span>
<a href="#l93.62"></a><span id="l93.62">   // leave the folder so that the messages get marked as read</span>
<a href="#l93.63"></a><span id="l93.63">   enter_folder(folder.rootFolder);</span>
<a href="#l93.64"></a><span id="l93.64">   // add a new message, and make sure it is new</span>
<a href="#l93.65"></a><span id="l93.65" class="difflineminus">-  let newSet = make_new_sets_in_folder(folder, [{count: 1}]);</span>
<a href="#l93.66"></a><span id="l93.66" class="difflineplus">+  make_new_sets_in_folder(folder, [{count: 1}]);</span>
<a href="#l93.67"></a><span id="l93.67">   // enter the folder</span>
<a href="#l93.68"></a><span id="l93.68">   enter_folder(folder);</span>
<a href="#l93.69"></a><span id="l93.69">   // make sure it (which must be the last row) is visible</span>
<a href="#l93.70"></a><span id="l93.70">   assert_visible(-1);</span>
<a href="#l93.71"></a><span id="l93.71"> }</span>
<a href="#l93.72"></a><span id="l93.72"> </span>
<a href="#l93.73"></a><span id="l93.73"> /**</span>
<a href="#l93.74"></a><span id="l93.74">  * Test that the last selected message persists through folder changes.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l94.1"></a><span id="l94.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-summarization.js</span>
<a href="#l94.2"></a><span id="l94.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-summarization.js</span>
<a href="#l94.3"></a><span id="l94.3" class="difflineat">@@ -14,28 +14,30 @@</span>
<a href="#l94.4"></a><span id="l94.4">  *  tab tests may do the same thing too...)</span>
<a href="#l94.5"></a><span id="l94.5">  *</span>
<a href="#l94.6"></a><span id="l94.6">  * Things we don't test but should:</span>
<a href="#l94.7"></a><span id="l94.7">  * - The difference between thread summary and multi-message summary.</span>
<a href="#l94.8"></a><span id="l94.8">  */</span>
<a href="#l94.9"></a><span id="l94.9"> </span>
<a href="#l94.10"></a><span id="l94.10"> &quot;use strict&quot;;</span>
<a href="#l94.11"></a><span id="l94.11"> </span>
<a href="#l94.12"></a><span id="l94.12" class="difflineminus">-var MODULE_NAME = 'test-summarization';</span>
<a href="#l94.13"></a><span id="l94.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-address-book-helpers.js */</span>
<a href="#l94.14"></a><span id="l94.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l94.15"></a><span id="l94.15"> </span>
<a href="#l94.16"></a><span id="l94.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l94.17"></a><span id="l94.17" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'address-book-helpers'];</span>
<a href="#l94.18"></a><span id="l94.18" class="difflineplus">+var MODULE_NAME = &quot;test-summarization&quot;;</span>
<a href="#l94.19"></a><span id="l94.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l94.20"></a><span id="l94.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;address-book-helpers&quot;];</span>
<a href="#l94.21"></a><span id="l94.21"> </span>
<a href="#l94.22"></a><span id="l94.22"> var folder;</span>
<a href="#l94.23"></a><span id="l94.23"> var thread1, thread2, msg1, msg2;</span>
<a href="#l94.24"></a><span id="l94.24"> </span>
<a href="#l94.25"></a><span id="l94.25"> var setupModule = function(module) {</span>
<a href="#l94.26"></a><span id="l94.26" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l94.27"></a><span id="l94.27" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l94.28"></a><span id="l94.28">   fdh.installInto(module);</span>
<a href="#l94.29"></a><span id="l94.29" class="difflineminus">-  let abh = collector.getModule('address-book-helpers');</span>
<a href="#l94.30"></a><span id="l94.30" class="difflineplus">+  let abh = collector.getModule(&quot;address-book-helpers&quot;);</span>
<a href="#l94.31"></a><span id="l94.31">   abh.installInto(module);</span>
<a href="#l94.32"></a><span id="l94.32"> </span>
<a href="#l94.33"></a><span id="l94.33">   folder = create_folder(&quot;SummarizationA&quot;);</span>
<a href="#l94.34"></a><span id="l94.34">   thread1 = create_thread(10);</span>
<a href="#l94.35"></a><span id="l94.35">   msg1 = create_thread(1);</span>
<a href="#l94.36"></a><span id="l94.36">   thread2 = create_thread(10);</span>
<a href="#l94.37"></a><span id="l94.37">   msg2 = create_thread(1);</span>
<a href="#l94.38"></a><span id="l94.38">   add_sets_to_folders([folder], [thread1, msg1, thread2, msg2]);</span>
<a href="#l94.39"></a><span id="l94.39" class="difflineat">@@ -174,27 +176,27 @@ function test_summarization_thread_detec</span>
<a href="#l94.40"></a><span id="l94.40">   assert_nothing_selected();</span>
<a href="#l94.41"></a><span id="l94.41">   make_display_threaded();</span>
<a href="#l94.42"></a><span id="l94.42">   select_click_row(0);</span>
<a href="#l94.43"></a><span id="l94.43">   select_shift_click_row(9);</span>
<a href="#l94.44"></a><span id="l94.44">   let messages = mc.folderDisplay.selectedMessages;</span>
<a href="#l94.45"></a><span id="l94.45">   toggle_thread_row(0);</span>
<a href="#l94.46"></a><span id="l94.46">   assert_messages_summarized(mc, messages);</span>
<a href="#l94.47"></a><span id="l94.47">   // count the number of messages represented</span>
<a href="#l94.48"></a><span id="l94.48" class="difflineminus">-  assert_summary_contains_N_elts('#message_list &gt; li', 10);</span>
<a href="#l94.49"></a><span id="l94.49" class="difflineplus">+  assert_summary_contains_N_elts(&quot;#message_list &gt; li&quot;, 10);</span>
<a href="#l94.50"></a><span id="l94.50">   select_shift_click_row(1);</span>
<a href="#l94.51"></a><span id="l94.51">   // this should have shifted to the multi-message view</span>
<a href="#l94.52"></a><span id="l94.52" class="difflineminus">-  assert_summary_contains_N_elts('.item_header &gt; .date', 0);</span>
<a href="#l94.53"></a><span id="l94.53" class="difflineminus">-  assert_summary_contains_N_elts('.item_header &gt; .subject', 2);</span>
<a href="#l94.54"></a><span id="l94.54" class="difflineplus">+  assert_summary_contains_N_elts(&quot;.item_header &gt; .date&quot;, 0);</span>
<a href="#l94.55"></a><span id="l94.55" class="difflineplus">+  assert_summary_contains_N_elts(&quot;.item_header &gt; .subject&quot;, 2);</span>
<a href="#l94.56"></a><span id="l94.56">   select_none();</span>
<a href="#l94.57"></a><span id="l94.57">   assert_nothing_selected();</span>
<a href="#l94.58"></a><span id="l94.58">   select_click_row(1); // select a single message</span>
<a href="#l94.59"></a><span id="l94.59">   select_shift_click_row(2); // add a thread</span>
<a href="#l94.60"></a><span id="l94.60" class="difflineminus">-  assert_summary_contains_N_elts('.item_header &gt; .date', 0);</span>
<a href="#l94.61"></a><span id="l94.61" class="difflineminus">-  assert_summary_contains_N_elts('.item_header &gt; .subject', 2);</span>
<a href="#l94.62"></a><span id="l94.62" class="difflineplus">+  assert_summary_contains_N_elts(&quot;.item_header &gt; .date&quot;, 0);</span>
<a href="#l94.63"></a><span id="l94.63" class="difflineplus">+  assert_summary_contains_N_elts(&quot;.item_header &gt; .subject&quot;, 2);</span>
<a href="#l94.64"></a><span id="l94.64"> }</span>
<a href="#l94.65"></a><span id="l94.65"> </span>
<a href="#l94.66"></a><span id="l94.66"> /**</span>
<a href="#l94.67"></a><span id="l94.67">  * If you are looking at a message that becomes part of a thread because of the</span>
<a href="#l94.68"></a><span id="l94.68">  *  arrival of a new message, expand the thread so you do not have the message</span>
<a href="#l94.69"></a><span id="l94.69">  *  turn into a summary beneath your feet.</span>
<a href="#l94.70"></a><span id="l94.70">  *</span>
<a href="#l94.71"></a><span id="l94.71">  * There are really two cases here:</span>
<a href="#l94.72"></a><span id="l94.72" class="difflineat">@@ -211,28 +213,26 @@ function test_new_thread_that_was_not_su</span>
<a href="#l94.73"></a><span id="l94.73"> </span>
<a href="#l94.74"></a><span id="l94.74">   // - do the non-move case</span>
<a href="#l94.75"></a><span id="l94.75">   // XXX actually, this still gets treated as a move. I don't know why...</span>
<a href="#l94.76"></a><span id="l94.76">   // select it</span>
<a href="#l94.77"></a><span id="l94.77">   select_click_row(willNotMoveMsg);</span>
<a href="#l94.78"></a><span id="l94.78">   assert_selected_and_displayed(willNotMoveMsg);</span>
<a href="#l94.79"></a><span id="l94.79"> </span>
<a href="#l94.80"></a><span id="l94.80">   // give it a friend...</span>
<a href="#l94.81"></a><span id="l94.81" class="difflineminus">-  let [extraNonMoveMsg] = make_new_sets_in_folders(</span>
<a href="#l94.82"></a><span id="l94.82" class="difflineminus">-    [folder], [{count: 1, inReplyTo: willNotMoveMsg}]);</span>
<a href="#l94.83"></a><span id="l94.83" class="difflineplus">+  make_new_sets_in_folders([folder], [{count: 1, inReplyTo: willNotMoveMsg}]);</span>
<a href="#l94.84"></a><span id="l94.84">   assert_expanded(willNotMoveMsg);</span>
<a href="#l94.85"></a><span id="l94.85">   assert_selected_and_displayed(willNotMoveMsg);</span>
<a href="#l94.86"></a><span id="l94.86"> </span>
<a href="#l94.87"></a><span id="l94.87">   // - do the move case</span>
<a href="#l94.88"></a><span id="l94.88">   select_click_row(willMoveMsg);</span>
<a href="#l94.89"></a><span id="l94.89">   assert_selected_and_displayed(willMoveMsg);</span>
<a href="#l94.90"></a><span id="l94.90"> </span>
<a href="#l94.91"></a><span id="l94.91">   // give it a friend...</span>
<a href="#l94.92"></a><span id="l94.92" class="difflineminus">-  let [extraMoveMsg] = make_new_sets_in_folders(</span>
<a href="#l94.93"></a><span id="l94.93" class="difflineminus">-    [folder], [{count: 1, inReplyTo: willMoveMsg}]);</span>
<a href="#l94.94"></a><span id="l94.94" class="difflineplus">+  make_new_sets_in_folders([folder], [{count: 1, inReplyTo: willMoveMsg}]);</span>
<a href="#l94.95"></a><span id="l94.95">   assert_expanded(willMoveMsg);</span>
<a href="#l94.96"></a><span id="l94.96">   assert_selected_and_displayed(willMoveMsg);</span>
<a href="#l94.97"></a><span id="l94.97"> }</span>
<a href="#l94.98"></a><span id="l94.98"> </span>
<a href="#l94.99"></a><span id="l94.99"> /**</span>
<a href="#l94.100"></a><span id="l94.100">  * Selecting an existing (and collapsed) thread, then add a message and make</span>
<a href="#l94.101"></a><span id="l94.101">  *  sure the summary updates.</span>
<a href="#l94.102"></a><span id="l94.102">  */</span>
<a href="#l94.103"></a><span id="l94.103" class="difflineat">@@ -262,17 +262,17 @@ function test_summary_when_multiple_iden</span>
<a href="#l94.104"></a><span id="l94.104">   // only one thread</span>
<a href="#l94.105"></a><span id="l94.105">   let folder1 = create_folder(&quot;Search1&quot;);</span>
<a href="#l94.106"></a><span id="l94.106">   be_in_folder(folder1);</span>
<a href="#l94.107"></a><span id="l94.107">   let thread1 = create_thread(1);</span>
<a href="#l94.108"></a><span id="l94.108">   add_sets_to_folders([folder1], [thread1]);</span>
<a href="#l94.109"></a><span id="l94.109"> </span>
<a href="#l94.110"></a><span id="l94.110">   let folder2 = create_folder(&quot;Search2&quot;);</span>
<a href="#l94.111"></a><span id="l94.111">   be_in_folder(folder2);</span>
<a href="#l94.112"></a><span id="l94.112" class="difflineminus">-  make_new_sets_in_folders([folder2], [{count: 1, inReplyTo: thread1}])</span>
<a href="#l94.113"></a><span id="l94.113" class="difflineplus">+  make_new_sets_in_folders([folder2], [{count: 1, inReplyTo: thread1}]);</span>
<a href="#l94.114"></a><span id="l94.114"> </span>
<a href="#l94.115"></a><span id="l94.115">   let folderVirtual = create_virtual_folder([folder1, folder2], {}, true, &quot;SearchBoth&quot;);</span>
<a href="#l94.116"></a><span id="l94.116"> </span>
<a href="#l94.117"></a><span id="l94.117">   // Do the needed tricks</span>
<a href="#l94.118"></a><span id="l94.118">   be_in_folder(folder1);</span>
<a href="#l94.119"></a><span id="l94.119">   select_click_row(0);</span>
<a href="#l94.120"></a><span id="l94.120">   plan_to_wait_for_folder_events(&quot;DeleteOrMoveMsgCompleted&quot;,</span>
<a href="#l94.121"></a><span id="l94.121">                                  &quot;DeleteOrMoveMsgFailed&quot;);</span>
<a href="#l94.122"></a><span id="l94.122" class="difflineat">@@ -289,78 +289,74 @@ function test_summary_when_multiple_iden</span>
<a href="#l94.123"></a><span id="l94.123">   be_in_folder(folderVirtual);</span>
<a href="#l94.124"></a><span id="l94.124">   make_display_threaded();</span>
<a href="#l94.125"></a><span id="l94.125">   collapse_all_threads();</span>
<a href="#l94.126"></a><span id="l94.126"> </span>
<a href="#l94.127"></a><span id="l94.127">   // Assertions</span>
<a href="#l94.128"></a><span id="l94.128">   select_click_row(0);</span>
<a href="#l94.129"></a><span id="l94.129">   assert_messages_summarized(mc, mc.folderDisplay.selectedMessages);</span>
<a href="#l94.130"></a><span id="l94.130">   // Thread summary shows a date, while multimessage summary shows a subject.</span>
<a href="#l94.131"></a><span id="l94.131" class="difflineminus">-  assert_summary_contains_N_elts('.item_header &gt; .subject', 0);</span>
<a href="#l94.132"></a><span id="l94.132" class="difflineminus">-  assert_summary_contains_N_elts('.item_header &gt; .date', 2);</span>
<a href="#l94.133"></a><span id="l94.133" class="difflineplus">+  assert_summary_contains_N_elts(&quot;.item_header &gt; .subject&quot;, 0);</span>
<a href="#l94.134"></a><span id="l94.134" class="difflineplus">+  assert_summary_contains_N_elts(&quot;.item_header &gt; .date&quot;, 2);</span>
<a href="#l94.135"></a><span id="l94.135"> </span>
<a href="#l94.136"></a><span id="l94.136">   // Second half of the test, makes sure MultiMessageSummary groups messages</span>
<a href="#l94.137"></a><span id="l94.137">   // according to their view thread id</span>
<a href="#l94.138"></a><span id="l94.138">   thread1 = create_thread(1);</span>
<a href="#l94.139"></a><span id="l94.139">   add_sets_to_folders([folder1], [thread1]);</span>
<a href="#l94.140"></a><span id="l94.140">   be_in_folder(folderVirtual);</span>
<a href="#l94.141"></a><span id="l94.141">   select_shift_click_row(1);</span>
<a href="#l94.142"></a><span id="l94.142"> </span>
<a href="#l94.143"></a><span id="l94.143" class="difflineminus">-  assert_summary_contains_N_elts('.item_header &gt; .subject', 2);</span>
<a href="#l94.144"></a><span id="l94.144" class="difflineplus">+  assert_summary_contains_N_elts(&quot;.item_header &gt; .subject&quot;, 2);</span>
<a href="#l94.145"></a><span id="l94.145"> }</span>
<a href="#l94.146"></a><span id="l94.146"> </span>
<a href="#l94.147"></a><span id="l94.147" class="difflineminus">-function extract_first_address(thread)</span>
<a href="#l94.148"></a><span id="l94.148" class="difflineminus">-{</span>
<a href="#l94.149"></a><span id="l94.149" class="difflineplus">+function extract_first_address(thread) {</span>
<a href="#l94.150"></a><span id="l94.150">   let addresses = {};</span>
<a href="#l94.151"></a><span id="l94.151">   let fullNames = {};</span>
<a href="#l94.152"></a><span id="l94.152">   let names = {};</span>
<a href="#l94.153"></a><span id="l94.153" class="difflineminus">-  let numAddresses = MailServices.headerParser.parseHeadersWithArray(</span>
<a href="#l94.154"></a><span id="l94.154" class="difflineplus">+  MailServices.headerParser.parseHeadersWithArray(</span>
<a href="#l94.155"></a><span id="l94.155">     thread1.getMsgHdr(0).mime2DecodedAuthor,</span>
<a href="#l94.156"></a><span id="l94.156">     addresses, names, fullNames);</span>
<a href="#l94.157"></a><span id="l94.157"> </span>
<a href="#l94.158"></a><span id="l94.158">   return {email: addresses.value[0], name: names.value[0]};</span>
<a href="#l94.159"></a><span id="l94.159"> }</span>
<a href="#l94.160"></a><span id="l94.160"> </span>
<a href="#l94.161"></a><span id="l94.161"> function check_address_name(name) {</span>
<a href="#l94.162"></a><span id="l94.162" class="difflineminus">-  let htmlframe = mc.e('multimessage');</span>
<a href="#l94.163"></a><span id="l94.163" class="difflineminus">-  let match = htmlframe.contentDocument.querySelector('.author');</span>
<a href="#l94.164"></a><span id="l94.164" class="difflineplus">+  let htmlframe = mc.e(&quot;multimessage&quot;);</span>
<a href="#l94.165"></a><span id="l94.165" class="difflineplus">+  let match = htmlframe.contentDocument.querySelector(&quot;.author&quot;);</span>
<a href="#l94.166"></a><span id="l94.166">   if (match.textContent != name)</span>
<a href="#l94.167"></a><span id="l94.167">     throw new Error(&quot;Expected to find sender named '&quot; + name + &quot;', found '&quot; +</span>
<a href="#l94.168"></a><span id="l94.168">                     match.textContent + &quot;'&quot;);</span>
<a href="#l94.169"></a><span id="l94.169"> }</span>
<a href="#l94.170"></a><span id="l94.170"> </span>
<a href="#l94.171"></a><span id="l94.171" class="difflineminus">-function test_display_name_no_abook()</span>
<a href="#l94.172"></a><span id="l94.172" class="difflineminus">-{</span>
<a href="#l94.173"></a><span id="l94.173" class="difflineplus">+function test_display_name_no_abook() {</span>
<a href="#l94.174"></a><span id="l94.174">   be_in_folder(folder);</span>
<a href="#l94.175"></a><span id="l94.175"> </span>
<a href="#l94.176"></a><span id="l94.176">   let address = extract_first_address(thread1);</span>
<a href="#l94.177"></a><span id="l94.177">   ensure_no_card_exists(address.email);</span>
<a href="#l94.178"></a><span id="l94.178"> </span>
<a href="#l94.179"></a><span id="l94.179">   collapse_all_threads();</span>
<a href="#l94.180"></a><span id="l94.180">   select_click_row(thread1);</span>
<a href="#l94.181"></a><span id="l94.181"> </span>
<a href="#l94.182"></a><span id="l94.182">   // No address book entry, we display name and e-mail address.</span>
<a href="#l94.183"></a><span id="l94.183">   check_address_name(address.name + &quot; &lt;&quot; + address.email + &quot;&gt;&quot;);</span>
<a href="#l94.184"></a><span id="l94.184"> }</span>
<a href="#l94.185"></a><span id="l94.185"> </span>
<a href="#l94.186"></a><span id="l94.186" class="difflineminus">-function test_display_name_abook()</span>
<a href="#l94.187"></a><span id="l94.187" class="difflineminus">-{</span>
<a href="#l94.188"></a><span id="l94.188" class="difflineplus">+function test_display_name_abook() {</span>
<a href="#l94.189"></a><span id="l94.189">   be_in_folder(folder);</span>
<a href="#l94.190"></a><span id="l94.190"> </span>
<a href="#l94.191"></a><span id="l94.191">   let address = extract_first_address(thread1);</span>
<a href="#l94.192"></a><span id="l94.192">   ensure_card_exists(address.email, &quot;My Friend&quot;, true);</span>
<a href="#l94.193"></a><span id="l94.193"> </span>
<a href="#l94.194"></a><span id="l94.194">   collapse_all_threads();</span>
<a href="#l94.195"></a><span id="l94.195">   select_click_row(thread1);</span>
<a href="#l94.196"></a><span id="l94.196"> </span>
<a href="#l94.197"></a><span id="l94.197">   check_address_name(&quot;My Friend&quot;);</span>
<a href="#l94.198"></a><span id="l94.198"> }</span>
<a href="#l94.199"></a><span id="l94.199"> </span>
<a href="#l94.200"></a><span id="l94.200" class="difflineminus">-function test_display_name_abook_no_pdn()</span>
<a href="#l94.201"></a><span id="l94.201" class="difflineminus">-{</span>
<a href="#l94.202"></a><span id="l94.202" class="difflineplus">+function test_display_name_abook_no_pdn() {</span>
<a href="#l94.203"></a><span id="l94.203">   be_in_folder(folder);</span>
<a href="#l94.204"></a><span id="l94.204"> </span>
<a href="#l94.205"></a><span id="l94.205">   let address = extract_first_address(thread1);</span>
<a href="#l94.206"></a><span id="l94.206">   ensure_card_exists(address.email, &quot;My Friend&quot;, false);</span>
<a href="#l94.207"></a><span id="l94.207"> </span>
<a href="#l94.208"></a><span id="l94.208">   collapse_all_threads();</span>
<a href="#l94.209"></a><span id="l94.209">   select_click_row(thread1);</span>
<a href="#l94.210"></a><span id="l94.210"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l95.1"></a><span id="l95.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-tabs-simple.js</span>
<a href="#l95.2"></a><span id="l95.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-tabs-simple.js</span>
<a href="#l95.3"></a><span id="l95.3" class="difflineat">@@ -8,27 +8,29 @@</span>
<a href="#l95.4"></a><span id="l95.4">  * transitions at one point; I (asuth) am changing our test infrastructure to</span>
<a href="#l95.5"></a><span id="l95.5">  * cause more realistic focus changes so those changes now look sillier</span>
<a href="#l95.6"></a><span id="l95.6">  * because in many cases we are explicitly setting focus back after the thread</span>
<a href="#l95.7"></a><span id="l95.7">  * tree gains focus.</span>
<a href="#l95.8"></a><span id="l95.8">  */</span>
<a href="#l95.9"></a><span id="l95.9"> </span>
<a href="#l95.10"></a><span id="l95.10"> &quot;use strict&quot;;</span>
<a href="#l95.11"></a><span id="l95.11"> </span>
<a href="#l95.12"></a><span id="l95.12" class="difflineminus">-var MODULE_NAME = 'test-tabs-simple';</span>
<a href="#l95.13"></a><span id="l95.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l95.14"></a><span id="l95.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l95.15"></a><span id="l95.15"> </span>
<a href="#l95.16"></a><span id="l95.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l95.17"></a><span id="l95.17" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l95.18"></a><span id="l95.18" class="difflineplus">+var MODULE_NAME = &quot;test-tabs-simple&quot;;</span>
<a href="#l95.19"></a><span id="l95.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l95.20"></a><span id="l95.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l95.21"></a><span id="l95.21"> </span>
<a href="#l95.22"></a><span id="l95.22"> var folderA, folderB, setA, setB;</span>
<a href="#l95.23"></a><span id="l95.23"> </span>
<a href="#l95.24"></a><span id="l95.24"> function setupModule(module) {</span>
<a href="#l95.25"></a><span id="l95.25" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l95.26"></a><span id="l95.26" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l95.27"></a><span id="l95.27">   fdh.installInto(module);</span>
<a href="#l95.28"></a><span id="l95.28" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l95.29"></a><span id="l95.29" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l95.30"></a><span id="l95.30">   wh.installInto(module);</span>
<a href="#l95.31"></a><span id="l95.31"> </span>
<a href="#l95.32"></a><span id="l95.32">   folderA = create_folder(&quot;TabsSimpleA&quot;);</span>
<a href="#l95.33"></a><span id="l95.33">   folderB = create_folder(&quot;TabsSimpleB&quot;);</span>
<a href="#l95.34"></a><span id="l95.34"> </span>
<a href="#l95.35"></a><span id="l95.35">   // We will verify we are seeing the right folder by checking that it has the</span>
<a href="#l95.36"></a><span id="l95.36">   //  right messages in it.</span>
<a href="#l95.37"></a><span id="l95.37">   [setA] = make_new_sets_in_folder(folderA, [{}]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l96.1"></a><span id="l96.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-virtual-folder-commands.js</span>
<a href="#l96.2"></a><span id="l96.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-virtual-folder-commands.js</span>
<a href="#l96.3"></a><span id="l96.3" class="difflineat">@@ -3,33 +3,32 @@</span>
<a href="#l96.4"></a><span id="l96.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l96.5"></a><span id="l96.5"> </span>
<a href="#l96.6"></a><span id="l96.6"> /*</span>
<a href="#l96.7"></a><span id="l96.7">  * Test that commands on virtual folders work properly.</span>
<a href="#l96.8"></a><span id="l96.8">  */</span>
<a href="#l96.9"></a><span id="l96.9"> </span>
<a href="#l96.10"></a><span id="l96.10"> &quot;use strict&quot;;</span>
<a href="#l96.11"></a><span id="l96.11"> </span>
<a href="#l96.12"></a><span id="l96.12" class="difflineminus">-var MODULE_NAME = &quot;test-virtual-folder-commands&quot;;</span>
<a href="#l96.13"></a><span id="l96.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l96.14"></a><span id="l96.14"> </span>
<a href="#l96.15"></a><span id="l96.15" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l96.16"></a><span id="l96.16" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l96.17"></a><span id="l96.17" class="difflineplus">+var MODULE_NAME = &quot;test-virtual-folder-commands&quot;;</span>
<a href="#l96.18"></a><span id="l96.18" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l96.19"></a><span id="l96.19" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l96.20"></a><span id="l96.20"> </span>
<a href="#l96.21"></a><span id="l96.21"> var msgsPerThread = 5;</span>
<a href="#l96.22"></a><span id="l96.22"> var singleVirtFolder;</span>
<a href="#l96.23"></a><span id="l96.23"> var multiVirtFolder;</span>
<a href="#l96.24"></a><span id="l96.24"> </span>
<a href="#l96.25"></a><span id="l96.25"> function setupModule(module) {</span>
<a href="#l96.26"></a><span id="l96.26" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l96.27"></a><span id="l96.27" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l96.28"></a><span id="l96.28">   fdh.installInto(module);</span>
<a href="#l96.29"></a><span id="l96.29"> </span>
<a href="#l96.30"></a><span id="l96.30" class="difflineminus">-  let [folderOne, setOne] = make_folder_with_sets(</span>
<a href="#l96.31"></a><span id="l96.31" class="difflineminus">-    [{msgsPerThread: msgsPerThread}]);</span>
<a href="#l96.32"></a><span id="l96.32" class="difflineminus">-  let [folderTwo, setTwo] = make_folder_with_sets(</span>
<a href="#l96.33"></a><span id="l96.33" class="difflineminus">-    [{msgsPerThread: msgsPerThread}]);</span>
<a href="#l96.34"></a><span id="l96.34" class="difflineplus">+  let [folderOne] = make_folder_with_sets([{msgsPerThread}]);</span>
<a href="#l96.35"></a><span id="l96.35" class="difflineplus">+  let [folderTwo] = make_folder_with_sets([{msgsPerThread}]);</span>
<a href="#l96.36"></a><span id="l96.36"> </span>
<a href="#l96.37"></a><span id="l96.37">   singleVirtFolder = make_virtual_folder([folderOne], {});</span>
<a href="#l96.38"></a><span id="l96.38">   multiVirtFolder = make_virtual_folder([folderOne, folderTwo], {});</span>
<a href="#l96.39"></a><span id="l96.39"> }</span>
<a href="#l96.40"></a><span id="l96.40"> </span>
<a href="#l96.41"></a><span id="l96.41"> function test_single_folder_select_thread() {</span>
<a href="#l96.42"></a><span id="l96.42">   be_in_folder(singleVirtFolder);</span>
<a href="#l96.43"></a><span id="l96.43">   make_display_threaded();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l97.1"></a><span id="l97.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-watch-ignore-thread.js</span>
<a href="#l97.2"></a><span id="l97.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-watch-ignore-thread.js</span>
<a href="#l97.3"></a><span id="l97.3" class="difflineat">@@ -1,22 +1,21 @@</span>
<a href="#l97.4"></a><span id="l97.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l97.5"></a><span id="l97.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l97.6"></a><span id="l97.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l97.7"></a><span id="l97.7"> </span>
<a href="#l97.8"></a><span id="l97.8"> /*</span>
<a href="#l97.9"></a><span id="l97.9">  * Test that &quot;watch thread&quot; and &quot;ignore thread&quot; works correctly.</span>
<a href="#l97.10"></a><span id="l97.10">  */</span>
<a href="#l97.11"></a><span id="l97.11"> </span>
<a href="#l97.12"></a><span id="l97.12" class="difflineminus">-// make SOLO_TEST=folder-display/test-watch-ignore-thread.js mozmill-one</span>
<a href="#l97.13"></a><span id="l97.13" class="difflineminus">-</span>
<a href="#l97.14"></a><span id="l97.14"> &quot;use strict&quot;;</span>
<a href="#l97.15"></a><span id="l97.15"> </span>
<a href="#l97.16"></a><span id="l97.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l97.17"></a><span id="l97.17" class="difflineplus">+</span>
<a href="#l97.18"></a><span id="l97.18"> var MODULE_NAME = &quot;test-watch-ignore-thread&quot;;</span>
<a href="#l97.19"></a><span id="l97.19" class="difflineminus">-</span>
<a href="#l97.20"></a><span id="l97.20"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l97.21"></a><span id="l97.21"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l97.22"></a><span id="l97.22"> </span>
<a href="#l97.23"></a><span id="l97.23"> var folder;</span>
<a href="#l97.24"></a><span id="l97.24"> var thread1, thread2, thread3;</span>
<a href="#l97.25"></a><span id="l97.25"> </span>
<a href="#l97.26"></a><span id="l97.26"> function setupModule(module) {</span>
<a href="#l97.27"></a><span id="l97.27">   collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l97.28"></a><span id="l97.28" class="difflineat">@@ -37,17 +36,17 @@ function setupModule(module) {</span>
<a href="#l97.29"></a><span id="l97.29">  * @param aMenuId the id of the menu item to click.</span>
<a href="#l97.30"></a><span id="l97.30">  */</span>
<a href="#l97.31"></a><span id="l97.31"> function clickViewMessagesItem(aMenuId) {</span>
<a href="#l97.32"></a><span id="l97.32">   mc.click(mc.eid(&quot;button-appmenu&quot;));</span>
<a href="#l97.33"></a><span id="l97.33">   mc.click_menus_in_sequence(mc.e(&quot;appmenu-popup&quot;),</span>
<a href="#l97.34"></a><span id="l97.34">     [</span>
<a href="#l97.35"></a><span id="l97.35">       {id: &quot;appmenu_View&quot;},</span>
<a href="#l97.36"></a><span id="l97.36">       {id: &quot;appmenu_viewMessagesMenu&quot;},</span>
<a href="#l97.37"></a><span id="l97.37" class="difflineminus">-      {id: aMenuId}</span>
<a href="#l97.38"></a><span id="l97.38" class="difflineplus">+      {id: aMenuId},</span>
<a href="#l97.39"></a><span id="l97.39">     ]</span>
<a href="#l97.40"></a><span id="l97.40">   );</span>
<a href="#l97.41"></a><span id="l97.41"> }</span>
<a href="#l97.42"></a><span id="l97.42"> </span>
<a href="#l97.43"></a><span id="l97.43"> /**</span>
<a href="#l97.44"></a><span id="l97.44">  * Test that Ignore Thread works as expected.</span>
<a href="#l97.45"></a><span id="l97.45">  */</span>
<a href="#l97.46"></a><span id="l97.46"> function test_ignore_thread() {</span>
<a href="#l97.47"></a><span id="l97.47" class="difflineat">@@ -93,17 +92,16 @@ function test_view_threads_ignored_threa</span>
<a href="#l97.48"></a><span id="l97.48">   assert_selected_and_displayed(t2root);</span>
<a href="#l97.49"></a><span id="l97.49">   assert_not_shown(thread1.msgHdrList);</span>
<a href="#l97.50"></a><span id="l97.50"> }</span>
<a href="#l97.51"></a><span id="l97.51"> </span>
<a href="#l97.52"></a><span id="l97.52"> /**</span>
<a href="#l97.53"></a><span id="l97.53">  * Test that Watch Thread makes the thread watched.</span>
<a href="#l97.54"></a><span id="l97.54">  */</span>
<a href="#l97.55"></a><span id="l97.55"> function test_watch_thread() {</span>
<a href="#l97.56"></a><span id="l97.56" class="difflineminus">-  let t2root = thread2.getMsgHdr(0);</span>
<a href="#l97.57"></a><span id="l97.57">   let t2second = select_click_row(1);</span>
<a href="#l97.58"></a><span id="l97.58">   let t3root = thread3.getMsgHdr(0);</span>
<a href="#l97.59"></a><span id="l97.59">   assert_selected_and_displayed(t2second);</span>
<a href="#l97.60"></a><span id="l97.60"> </span>
<a href="#l97.61"></a><span id="l97.61">   // Watch this thread.</span>
<a href="#l97.62"></a><span id="l97.62">   mc.keypress(null, &quot;W&quot;, {shiftKey: false, accelKey: false});</span>
<a href="#l97.63"></a><span id="l97.63"> </span>
<a href="#l97.64"></a><span id="l97.64">   // Choose &quot;Watched Threads with Unread&quot;.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l98.1"></a><span id="l98.1" class="difflineminus">--- a/mail/test/mozmill/folder-pane/test-display-message-with-folder-modes.js</span>
<a href="#l98.2"></a><span id="l98.2" class="difflineplus">+++ b/mail/test/mozmill/folder-pane/test-display-message-with-folder-modes.js</span>
<a href="#l98.3"></a><span id="l98.3" class="difflineat">@@ -9,18 +9,19 @@</span>
<a href="#l98.4"></a><span id="l98.4">  *   current folder mode</span>
<a href="#l98.5"></a><span id="l98.5">  * - not switching otherwise</span>
<a href="#l98.6"></a><span id="l98.6">  * - making sure that we're able to expand the right folders in the smart folder</span>
<a href="#l98.7"></a><span id="l98.7">  *   mode</span>
<a href="#l98.8"></a><span id="l98.8">  */</span>
<a href="#l98.9"></a><span id="l98.9"> </span>
<a href="#l98.10"></a><span id="l98.10"> &quot;use strict&quot;;</span>
<a href="#l98.11"></a><span id="l98.11"> </span>
<a href="#l98.12"></a><span id="l98.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l98.13"></a><span id="l98.13" class="difflineplus">+</span>
<a href="#l98.14"></a><span id="l98.14"> var MODULE_NAME = &quot;test-display-message-with-folder-modes&quot;;</span>
<a href="#l98.15"></a><span id="l98.15" class="difflineminus">-</span>
<a href="#l98.16"></a><span id="l98.16"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l98.17"></a><span id="l98.17"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l98.18"></a><span id="l98.18"> </span>
<a href="#l98.19"></a><span id="l98.19"> var folder;</span>
<a href="#l98.20"></a><span id="l98.20"> var dummyFolder;</span>
<a href="#l98.21"></a><span id="l98.21"> var inbox2Folder;</span>
<a href="#l98.22"></a><span id="l98.22"> var smartInboxFolder;</span>
<a href="#l98.23"></a><span id="l98.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l99.1"></a><span id="l99.1" class="difflineminus">--- a/mail/test/mozmill/folder-pane/test-folder-names-in-recent-mode.js</span>
<a href="#l99.2"></a><span id="l99.2" class="difflineplus">+++ b/mail/test/mozmill/folder-pane/test-folder-names-in-recent-mode.js</span>
<a href="#l99.3"></a><span id="l99.3" class="difflineat">@@ -3,18 +3,19 @@</span>
<a href="#l99.4"></a><span id="l99.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l99.5"></a><span id="l99.5"> </span>
<a href="#l99.6"></a><span id="l99.6"> /**</span>
<a href="#l99.7"></a><span id="l99.7">  * Test that the folder names have account name appended when in &quot;recent&quot; view.</span>
<a href="#l99.8"></a><span id="l99.8">  */</span>
<a href="#l99.9"></a><span id="l99.9"> </span>
<a href="#l99.10"></a><span id="l99.10"> &quot;use strict&quot;;</span>
<a href="#l99.11"></a><span id="l99.11"> </span>
<a href="#l99.12"></a><span id="l99.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l99.13"></a><span id="l99.13" class="difflineplus">+</span>
<a href="#l99.14"></a><span id="l99.14"> var MODULE_NAME = &quot;test-folder-names-in-recent-mode&quot;;</span>
<a href="#l99.15"></a><span id="l99.15" class="difflineminus">-</span>
<a href="#l99.16"></a><span id="l99.16"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l99.17"></a><span id="l99.17"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l99.18"></a><span id="l99.18"> </span>
<a href="#l99.19"></a><span id="l99.19"> var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l99.20"></a><span id="l99.20"> </span>
<a href="#l99.21"></a><span id="l99.21"> function setupModule(module) {</span>
<a href="#l99.22"></a><span id="l99.22">   collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l99.23"></a><span id="l99.23"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l100.1"></a><span id="l100.1" class="difflineminus">--- a/mail/test/mozmill/folder-pane/test-folder-pane-consumers.js</span>
<a href="#l100.2"></a><span id="l100.2" class="difflineplus">+++ b/mail/test/mozmill/folder-pane/test-folder-pane-consumers.js</span>
<a href="#l100.3"></a><span id="l100.3" class="difflineat">@@ -3,21 +3,23 @@</span>
<a href="#l100.4"></a><span id="l100.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l100.5"></a><span id="l100.5"> </span>
<a href="#l100.6"></a><span id="l100.6"> /*</span>
<a href="#l100.7"></a><span id="l100.7">  * Tests for other dialogs using the tree view implementation in folderPane.js.</span>
<a href="#l100.8"></a><span id="l100.8">  */</span>
<a href="#l100.9"></a><span id="l100.9"> </span>
<a href="#l100.10"></a><span id="l100.10"> &quot;use strict&quot;;</span>
<a href="#l100.11"></a><span id="l100.11"> </span>
<a href="#l100.12"></a><span id="l100.12" class="difflineminus">-var MODULE_NAME = 'test-folder-pane';</span>
<a href="#l100.13"></a><span id="l100.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l100.14"></a><span id="l100.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-nntp-helpers.js */</span>
<a href="#l100.15"></a><span id="l100.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l100.16"></a><span id="l100.16"> </span>
<a href="#l100.17"></a><span id="l100.17" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l100.18"></a><span id="l100.18" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l100.19"></a><span id="l100.19" class="difflineminus">-                       &quot;nntp-helpers&quot;];</span>
<a href="#l100.20"></a><span id="l100.20" class="difflineplus">+var MODULE_NAME = &quot;test-folder-pane&quot;;</span>
<a href="#l100.21"></a><span id="l100.21" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l100.22"></a><span id="l100.22" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;nntp-helpers&quot;];</span>
<a href="#l100.23"></a><span id="l100.23"> </span>
<a href="#l100.24"></a><span id="l100.24"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l100.25"></a><span id="l100.25"> </span>
<a href="#l100.26"></a><span id="l100.26"> var nntpAccount;</span>
<a href="#l100.27"></a><span id="l100.27"> </span>
<a href="#l100.28"></a><span id="l100.28"> function setupModule(module) {</span>
<a href="#l100.29"></a><span id="l100.29">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l100.30"></a><span id="l100.30">     collector.getModule(lib).installInto(module);</span>
<a href="#l100.31"></a><span id="l100.31" class="difflineat">@@ -62,17 +64,16 @@ function test_offline_sync_folder_select</span>
<a href="#l100.32"></a><span id="l100.32">   plan_for_modal_dialog(&quot;mailnews:synchronizeOffline&quot;,</span>
<a href="#l100.33"></a><span id="l100.33">                         subtest_offline_sync);</span>
<a href="#l100.34"></a><span id="l100.34">   mc.click(mc.eid(&quot;button-appmenu&quot;));</span>
<a href="#l100.35"></a><span id="l100.35">   mc.click_menus_in_sequence(mc.e(&quot;appmenu-popup&quot;),</span>
<a href="#l100.36"></a><span id="l100.36">                              [ { id: &quot;appmenu_File&quot; },</span>
<a href="#l100.37"></a><span id="l100.37">                                { id: &quot;appmenu_offline&quot; },</span>
<a href="#l100.38"></a><span id="l100.38">                                { id: &quot;appmenu_synchronizeOffline&quot; } ]);</span>
<a href="#l100.39"></a><span id="l100.39">   wait_for_modal_dialog(&quot;mailnews:synchronizeOffline&quot;);</span>
<a href="#l100.40"></a><span id="l100.40" class="difflineminus">-</span>
<a href="#l100.41"></a><span id="l100.41"> }</span>
<a href="#l100.42"></a><span id="l100.42"> </span>
<a href="#l100.43"></a><span id="l100.43"> function subtest_offline_sync(osc) {</span>
<a href="#l100.44"></a><span id="l100.44">   // Open the folder chooser.</span>
<a href="#l100.45"></a><span id="l100.45">   plan_for_modal_dialog(&quot;mailnews:selectOffline&quot;,</span>
<a href="#l100.46"></a><span id="l100.46">                         subtest_check_offline_folder_list);</span>
<a href="#l100.47"></a><span id="l100.47">   osc.click(osc.eid(&quot;select&quot;));</span>
<a href="#l100.48"></a><span id="l100.48">   wait_for_modal_dialog(&quot;mailnews:selectOffline&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l101.1"></a><span id="l101.1" class="difflineminus">--- a/mail/test/mozmill/folder-pane/test-folder-pane.js</span>
<a href="#l101.2"></a><span id="l101.2" class="difflineplus">+++ b/mail/test/mozmill/folder-pane/test-folder-pane.js</span>
<a href="#l101.3"></a><span id="l101.3" class="difflineat">@@ -5,26 +5,27 @@</span>
<a href="#l101.4"></a><span id="l101.4"> /*</span>
<a href="#l101.5"></a><span id="l101.5">  * Tests for the folder pane, in particular the tree view. This is kept separate</span>
<a href="#l101.6"></a><span id="l101.6">  * from the main folder-display suite so that the folders created by other tests</span>
<a href="#l101.7"></a><span id="l101.7">  * there don't influence the results here.</span>
<a href="#l101.8"></a><span id="l101.8">  */</span>
<a href="#l101.9"></a><span id="l101.9"> </span>
<a href="#l101.10"></a><span id="l101.10"> &quot;use strict&quot;;</span>
<a href="#l101.11"></a><span id="l101.11"> </span>
<a href="#l101.12"></a><span id="l101.12" class="difflineminus">-var MODULE_NAME = 'test-folder-pane';</span>
<a href="#l101.13"></a><span id="l101.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l101.14"></a><span id="l101.14"> </span>
<a href="#l101.15"></a><span id="l101.15" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l101.16"></a><span id="l101.16" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l101.17"></a><span id="l101.17" class="difflineplus">+var MODULE_NAME = &quot;test-folder-pane&quot;;</span>
<a href="#l101.18"></a><span id="l101.18" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l101.19"></a><span id="l101.19" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l101.20"></a><span id="l101.20"> </span>
<a href="#l101.21"></a><span id="l101.21"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l101.22"></a><span id="l101.22"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l101.23"></a><span id="l101.23"> </span>
<a href="#l101.24"></a><span id="l101.24"> function setupModule(module) {</span>
<a href="#l101.25"></a><span id="l101.25" class="difflineminus">-  collector.getModule('folder-display-helpers').installInto(module);</span>
<a href="#l101.26"></a><span id="l101.26" class="difflineplus">+  collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l101.27"></a><span id="l101.27"> }</span>
<a href="#l101.28"></a><span id="l101.28"> </span>
<a href="#l101.29"></a><span id="l101.29"> /**</span>
<a href="#l101.30"></a><span id="l101.30">  * Assert the Folder Pane is in All Folder mode by default.  Check that the</span>
<a href="#l101.31"></a><span id="l101.31">  * correct number of rows for accounts and folders are always shown as new</span>
<a href="#l101.32"></a><span id="l101.32">  * folders are created, expanded, and collapsed.</span>
<a href="#l101.33"></a><span id="l101.33">  */</span>
<a href="#l101.34"></a><span id="l101.34"> function test_all_folders_toggle_folder_open_state() {</span>
<a href="#l101.35"></a><span id="l101.35" class="difflineat">@@ -55,17 +56,17 @@ function test_all_folders_toggle_folder_</span>
<a href="#l101.36"></a><span id="l101.36">   let folder = MailUtils.getOrCreateFolder(pop3Server.rootFolder.URI + &quot;/Archives&quot;);</span>
<a href="#l101.37"></a><span id="l101.37">   folder.setFlag(Ci.nsMsgFolderFlags.Archive);</span>
<a href="#l101.38"></a><span id="l101.38">   folder.createStorageIfMissing(null);</span>
<a href="#l101.39"></a><span id="l101.39">   // After creating Archives, account should have expanded</span>
<a href="#l101.40"></a><span id="l101.40">   // so that we should have 5 rows visible</span>
<a href="#l101.41"></a><span id="l101.41">   assert_folder_tree_view_row_count(accounts + inbox + trash +</span>
<a href="#l101.42"></a><span id="l101.42">                                     archives);</span>
<a href="#l101.43"></a><span id="l101.43">   // close the tinderbox server.</span>
<a href="#l101.44"></a><span id="l101.44" class="difflineminus">-  mc.folderTreeView.toggleOpenState(0)</span>
<a href="#l101.45"></a><span id="l101.45" class="difflineplus">+  mc.folderTreeView.toggleOpenState(0);</span>
<a href="#l101.46"></a><span id="l101.46">   let folderA = create_folder(&quot;FolderPaneA&quot;);</span>
<a href="#l101.47"></a><span id="l101.47">   be_in_folder(folderA);</span>
<a href="#l101.48"></a><span id="l101.48"> </span>
<a href="#l101.49"></a><span id="l101.49">   // After creating our first folder we should have 6 rows visible</span>
<a href="#l101.50"></a><span id="l101.50">   assert_folder_tree_view_row_count(accounts + inbox + trash + outbox +</span>
<a href="#l101.51"></a><span id="l101.51">                                     folderPaneA);</span>
<a href="#l101.52"></a><span id="l101.52"> </span>
<a href="#l101.53"></a><span id="l101.53">   let oneFolderCount = mc.folderTreeView.rowCount;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l102.1"></a><span id="l102.1" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js</span>
<a href="#l102.2"></a><span id="l102.2" class="difflineplus">+++ b/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js</span>
<a href="#l102.3"></a><span id="l102.3" class="difflineat">@@ -5,18 +5,20 @@</span>
<a href="#l102.4"></a><span id="l102.4"> </span>
<a href="#l102.5"></a><span id="l102.5"> /*</span>
<a href="#l102.6"></a><span id="l102.6">  * Tests for custom folder tree modes. The test mode is provided by the test</span>
<a href="#l102.7"></a><span id="l102.7">  * extension in the test-extension subdirectory.</span>
<a href="#l102.8"></a><span id="l102.8">  */</span>
<a href="#l102.9"></a><span id="l102.9"> </span>
<a href="#l102.10"></a><span id="l102.10"> &quot;use strict&quot;;</span>
<a href="#l102.11"></a><span id="l102.11"> </span>
<a href="#l102.12"></a><span id="l102.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l102.13"></a><span id="l102.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l102.14"></a><span id="l102.14" class="difflineplus">+</span>
<a href="#l102.15"></a><span id="l102.15"> var MODULE_NAME = &quot;test-custom-folder-tree-mode&quot;;</span>
<a href="#l102.16"></a><span id="l102.16" class="difflineminus">-</span>
<a href="#l102.17"></a><span id="l102.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l102.18"></a><span id="l102.18"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l102.19"></a><span id="l102.19"> </span>
<a href="#l102.20"></a><span id="l102.20"> var gInbox;</span>
<a href="#l102.21"></a><span id="l102.21"> </span>
<a href="#l102.22"></a><span id="l102.22"> function setupModule(module) {</span>
<a href="#l102.23"></a><span id="l102.23">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l102.24"></a><span id="l102.24">     collector.getModule(lib).installInto(module);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l103.1"></a><span id="l103.1" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/test-custom-smart-folder.js</span>
<a href="#l103.2"></a><span id="l103.2" class="difflineplus">+++ b/mail/test/mozmill/folder-tree-modes/test-custom-smart-folder.js</span>
<a href="#l103.3"></a><span id="l103.3" class="difflineat">@@ -5,24 +5,26 @@</span>
<a href="#l103.4"></a><span id="l103.4"> </span>
<a href="#l103.5"></a><span id="l103.5"> /*</span>
<a href="#l103.6"></a><span id="l103.6">  * Tests for custom folder tree modes. The test mode is provided by the test</span>
<a href="#l103.7"></a><span id="l103.7">  * extension in the test-extension subdirectory.</span>
<a href="#l103.8"></a><span id="l103.8">  */</span>
<a href="#l103.9"></a><span id="l103.9"> </span>
<a href="#l103.10"></a><span id="l103.10"> &quot;use strict&quot;;</span>
<a href="#l103.11"></a><span id="l103.11"> </span>
<a href="#l103.12"></a><span id="l103.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l103.13"></a><span id="l103.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l103.14"></a><span id="l103.14" class="difflineplus">+</span>
<a href="#l103.15"></a><span id="l103.15"> var MODULE_NAME = &quot;test-custom-smart-folder&quot;;</span>
<a href="#l103.16"></a><span id="l103.16" class="difflineminus">-</span>
<a href="#l103.17"></a><span id="l103.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l103.18"></a><span id="l103.18"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l103.19"></a><span id="l103.19"> </span>
<a href="#l103.20"></a><span id="l103.20"> // spaces in the name are intentional</span>
<a href="#l103.21"></a><span id="l103.21" class="difflineminus">-var smartParentNameA=&quot;My Smart Folder A&quot;;</span>
<a href="#l103.22"></a><span id="l103.22" class="difflineminus">-var smartParentNameB=&quot;My Smart Folder B&quot;;</span>
<a href="#l103.23"></a><span id="l103.23" class="difflineplus">+var smartParentNameA = &quot;My Smart Folder A&quot;;</span>
<a href="#l103.24"></a><span id="l103.24" class="difflineplus">+var smartParentNameB = &quot;My Smart Folder B&quot;;</span>
<a href="#l103.25"></a><span id="l103.25"> </span>
<a href="#l103.26"></a><span id="l103.26"> var rootFolder;</span>
<a href="#l103.27"></a><span id="l103.27"> var inboxSubfolder, subfolderA, subfolderB;</span>
<a href="#l103.28"></a><span id="l103.28"> var smartFolderInbox;</span>
<a href="#l103.29"></a><span id="l103.29"> var smartFolderA;</span>
<a href="#l103.30"></a><span id="l103.30"> </span>
<a href="#l103.31"></a><span id="l103.31"> var nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l103.32"></a><span id="l103.32"> </span>
<a href="#l103.33"></a><span id="l103.33" class="difflineat">@@ -75,22 +77,22 @@ function test_switch_to_smart_folder_mod</span>
<a href="#l103.34"></a><span id="l103.34"> function test_cache_property() {</span>
<a href="#l103.35"></a><span id="l103.35">   if (mc.window.getSmartFolderName(subfolderA) != smartParentNameA)</span>
<a href="#l103.36"></a><span id="l103.36">     throw new Error(&quot;smartFolderName A cache property not set&quot;);</span>
<a href="#l103.37"></a><span id="l103.37">   if (mc.window.getSmartFolderName(subfolderB) != smartParentNameB)</span>
<a href="#l103.38"></a><span id="l103.38">     throw new Error(&quot;smartFolderName B cache property not set&quot;);</span>
<a href="#l103.39"></a><span id="l103.39"> }</span>
<a href="#l103.40"></a><span id="l103.40"> </span>
<a href="#l103.41"></a><span id="l103.41"> function _test_smart_folder_type(folder, parentName) {</span>
<a href="#l103.42"></a><span id="l103.42" class="difflineminus">-  let smartMode = mc.folderTreeView.getFolderTreeMode('smart');</span>
<a href="#l103.43"></a><span id="l103.43" class="difflineminus">-  let [flag,name,deep,search] = smartMode._getSmartFolderType(folder) ;</span>
<a href="#l103.44"></a><span id="l103.44" class="difflineplus">+  let smartMode = mc.folderTreeView.getFolderTreeMode(&quot;smart&quot;);</span>
<a href="#l103.45"></a><span id="l103.45" class="difflineplus">+  let [flag, name] = smartMode._getSmartFolderType(folder);</span>
<a href="#l103.46"></a><span id="l103.46">   if (flag != 0)</span>
<a href="#l103.47"></a><span id="l103.47" class="difflineminus">-    throw new Error(&quot;custom smart folder definition [&quot;+parentName+&quot;] has a flag&quot;)</span>
<a href="#l103.48"></a><span id="l103.48" class="difflineplus">+    throw new Error(&quot;custom smart folder definition [&quot; + parentName + &quot;] has a flag&quot;);</span>
<a href="#l103.49"></a><span id="l103.49">   if (name != parentName)</span>
<a href="#l103.50"></a><span id="l103.50" class="difflineminus">-    throw new Error(&quot;custom smart folder [&quot;+folder.name+&quot;] is incorrect [&quot;+name+&quot;] should be [&quot;+parentName+&quot;]&quot;)</span>
<a href="#l103.51"></a><span id="l103.51" class="difflineplus">+    throw new Error(&quot;custom smart folder [&quot; + folder.name + &quot;] is incorrect [&quot; + name + &quot;] should be [&quot; + parentName + &quot;]&quot;);</span>
<a href="#l103.52"></a><span id="l103.52"> }</span>
<a href="#l103.53"></a><span id="l103.53"> </span>
<a href="#l103.54"></a><span id="l103.54"> function test_smart_folder_type() {</span>
<a href="#l103.55"></a><span id="l103.55">   _test_smart_folder_type(subfolderA, smartParentNameA);</span>
<a href="#l103.56"></a><span id="l103.56">   _test_smart_folder_type(subfolderB, smartParentNameB);</span>
<a href="#l103.57"></a><span id="l103.57"> }</span>
<a href="#l103.58"></a><span id="l103.58"> </span>
<a href="#l103.59"></a><span id="l103.59"> /**</span>
<a href="#l103.60"></a><span id="l103.60" class="difflineat">@@ -118,17 +120,17 @@ function FTVItemHasChild(parentFTVItem, </span>
<a href="#l103.61"></a><span id="l103.61">  * test that our real smart folder is in fact a child if the correct</span>
<a href="#l103.62"></a><span id="l103.62">  * smart folder parent</span>
<a href="#l103.63"></a><span id="l103.63">  */</span>
<a href="#l103.64"></a><span id="l103.64"> function test_smart_child_parent_relationship() {</span>
<a href="#l103.65"></a><span id="l103.65">   let folderIndex = assert_folder_visible(smartFolderA);</span>
<a href="#l103.66"></a><span id="l103.66">   let folderFTVItem = mc.folderTreeView.getFTVItemForIndex(folderIndex);</span>
<a href="#l103.67"></a><span id="l103.67">   if (!FTVItemHasChild(folderFTVItem, subfolderA, false))</span>
<a href="#l103.68"></a><span id="l103.68">     throw new Error(&quot;Folder: &quot; + subfolderA.name + &quot; is not a child of our smart parent folder&quot;);</span>
<a href="#l103.69"></a><span id="l103.69" class="difflineminus">-  assert_folder_mode(&quot;smart&quot;)</span>
<a href="#l103.70"></a><span id="l103.70" class="difflineplus">+  assert_folder_mode(&quot;smart&quot;);</span>
<a href="#l103.71"></a><span id="l103.71"> }</span>
<a href="#l103.72"></a><span id="l103.72"> </span>
<a href="#l103.73"></a><span id="l103.73"> </span>
<a href="#l103.74"></a><span id="l103.74"> /**</span>
<a href="#l103.75"></a><span id="l103.75">  * test that our real smart folder is NOT a child of the smart inbox in the</span>
<a href="#l103.76"></a><span id="l103.76">  * tree view.</span>
<a href="#l103.77"></a><span id="l103.77">  */</span>
<a href="#l103.78"></a><span id="l103.78"> function test_real_child_parent_relationship() {</span>
<a href="#l103.79"></a><span id="l103.79" class="difflineat">@@ -136,17 +138,17 @@ function test_real_child_parent_relation</span>
<a href="#l103.80"></a><span id="l103.80">   expand_folder(smartFolderInbox);</span>
<a href="#l103.81"></a><span id="l103.81">   // the real parent should be an Inbox</span>
<a href="#l103.82"></a><span id="l103.82">   let folderIndex = assert_folder_visible(subfolderA.parent);</span>
<a href="#l103.83"></a><span id="l103.83">   let folderFTVItem = mc.folderTreeView.getFTVItemForIndex(folderIndex);</span>
<a href="#l103.84"></a><span id="l103.84">   // in the tree, subfolder is a child of our magic smart folder, and should not</span>
<a href="#l103.85"></a><span id="l103.85">   // be a child of inbox</span>
<a href="#l103.86"></a><span id="l103.86">   if (FTVItemHasChild(folderFTVItem, subfolderA, true))</span>
<a href="#l103.87"></a><span id="l103.87">     throw new Error(&quot;Folder: &quot; + subfolderA.name + &quot; should not be a child of an inbox&quot;);</span>
<a href="#l103.88"></a><span id="l103.88" class="difflineminus">-  assert_folder_mode(&quot;smart&quot;)</span>
<a href="#l103.89"></a><span id="l103.89" class="difflineplus">+  assert_folder_mode(&quot;smart&quot;);</span>
<a href="#l103.90"></a><span id="l103.90"> }</span>
<a href="#l103.91"></a><span id="l103.91"> </span>
<a href="#l103.92"></a><span id="l103.92"> </span>
<a href="#l103.93"></a><span id="l103.93"> /**</span>
<a href="#l103.94"></a><span id="l103.94">  * test collapse/expand states of one of our smart folders</span>
<a href="#l103.95"></a><span id="l103.95">  */</span>
<a href="#l103.96"></a><span id="l103.96"> function test_smart_subfolder() {</span>
<a href="#l103.97"></a><span id="l103.97">   assert_folder_mode(&quot;smart&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l104.1"></a><span id="l104.1" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/test-extension/bootstrap.js</span>
<a href="#l104.2"></a><span id="l104.2" class="difflineplus">+++ b/mail/test/mozmill/folder-tree-modes/test-extension/bootstrap.js</span>
<a href="#l104.3"></a><span id="l104.3" class="difflineat">@@ -2,39 +2,39 @@</span>
<a href="#l104.4"></a><span id="l104.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l104.5"></a><span id="l104.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l104.6"></a><span id="l104.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l104.7"></a><span id="l104.7"> </span>
<a href="#l104.8"></a><span id="l104.8"> &quot;use strict&quot;;</span>
<a href="#l104.9"></a><span id="l104.9"> </span>
<a href="#l104.10"></a><span id="l104.10"> var {ExtensionSupport} = ChromeUtils.import(&quot;resource:///modules/ExtensionSupport.jsm&quot;);</span>
<a href="#l104.11"></a><span id="l104.11"> </span>
<a href="#l104.12"></a><span id="l104.12" class="difflineminus">-//const addonID = &quot;testfoldertreemode@mozilla.org&quot;;</span>
<a href="#l104.13"></a><span id="l104.13" class="difflineplus">+// const addonID = &quot;testfoldertreemode@mozilla.org&quot;;</span>
<a href="#l104.14"></a><span id="l104.14"> </span>
<a href="#l104.15"></a><span id="l104.15"> function install() {}</span>
<a href="#l104.16"></a><span id="l104.16"> </span>
<a href="#l104.17"></a><span id="l104.17"> function uninstall() {}</span>
<a href="#l104.18"></a><span id="l104.18"> </span>
<a href="#l104.19"></a><span id="l104.19"> function startup(data, reason) {</span>
<a href="#l104.20"></a><span id="l104.20">   ExtensionSupport.registerWindowListener(</span>
<a href="#l104.21"></a><span id="l104.21">     data.id,</span>
<a href="#l104.22"></a><span id="l104.22">     {</span>
<a href="#l104.23"></a><span id="l104.23">       chromeURLs: [ &quot;chrome://messenger/content/messenger.xul&quot; ],</span>
<a href="#l104.24"></a><span id="l104.24" class="difflineminus">-      onLoadWindow: setupFolderMode</span>
<a href="#l104.25"></a><span id="l104.25" class="difflineplus">+      onLoadWindow: setupFolderMode,</span>
<a href="#l104.26"></a><span id="l104.26">     });</span>
<a href="#l104.27"></a><span id="l104.27"> }</span>
<a href="#l104.28"></a><span id="l104.28"> </span>
<a href="#l104.29"></a><span id="l104.29"> function shutdown(data, reason) {</span>
<a href="#l104.30"></a><span id="l104.30">   ExtensionSupport.unregisterWindowListener(data.id);</span>
<a href="#l104.31"></a><span id="l104.31"> }</span>
<a href="#l104.32"></a><span id="l104.32"> </span>
<a href="#l104.33"></a><span id="l104.33"> function setupFolderMode(aWindow) {</span>
<a href="#l104.34"></a><span id="l104.34">   let testFolderTreeMode = {</span>
<a href="#l104.35"></a><span id="l104.35">     __proto__: aWindow.IFolderTreeMode,</span>
<a href="#l104.36"></a><span id="l104.36" class="difflineminus">-    generateMap: function(aFTV) {</span>
<a href="#l104.37"></a><span id="l104.37" class="difflineplus">+    generateMap(aFTV) {</span>
<a href="#l104.38"></a><span id="l104.38">       var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l104.39"></a><span id="l104.39">       // Pick the tinderbox@foo.invalid inbox and use it as the only folder</span>
<a href="#l104.40"></a><span id="l104.40">       let server = MailServices.accounts.FindServer(&quot;tinderbox&quot;, &quot;tinderbox123&quot;, &quot;pop3&quot;);</span>
<a href="#l104.41"></a><span id="l104.41">       let item = new aWindow.ftvItem(server.rootFolder.getChildNamed(&quot;Inbox&quot;));</span>
<a href="#l104.42"></a><span id="l104.42">       item.__defineGetter__(&quot;children&quot;, () =&gt; []);</span>
<a href="#l104.43"></a><span id="l104.43">       return [item];</span>
<a href="#l104.44"></a><span id="l104.44">     },</span>
<a href="#l104.45"></a><span id="l104.45">   };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l105.1"></a><span id="l105.1" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/test-mode-switching.js</span>
<a href="#l105.2"></a><span id="l105.2" class="difflineplus">+++ b/mail/test/mozmill/folder-tree-modes/test-mode-switching.js</span>
<a href="#l105.3"></a><span id="l105.3" class="difflineat">@@ -5,18 +5,20 @@</span>
<a href="#l105.4"></a><span id="l105.4"> /*</span>
<a href="#l105.5"></a><span id="l105.5">  * Bug 978592.</span>
<a href="#l105.6"></a><span id="l105.6">  * Test that switching folder modes via menu works and also compact versions</span>
<a href="#l105.7"></a><span id="l105.7">  * can be toggled properly.</span>
<a href="#l105.8"></a><span id="l105.8">  */</span>
<a href="#l105.9"></a><span id="l105.9"> </span>
<a href="#l105.10"></a><span id="l105.10"> &quot;use strict&quot;;</span>
<a href="#l105.11"></a><span id="l105.11"> </span>
<a href="#l105.12"></a><span id="l105.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l105.13"></a><span id="l105.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l105.14"></a><span id="l105.14" class="difflineplus">+</span>
<a href="#l105.15"></a><span id="l105.15"> var MODULE_NAME = &quot;test-mode-switching&quot;;</span>
<a href="#l105.16"></a><span id="l105.16" class="difflineminus">-</span>
<a href="#l105.17"></a><span id="l105.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l105.18"></a><span id="l105.18"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l105.19"></a><span id="l105.19"> </span>
<a href="#l105.20"></a><span id="l105.20"> var rootFolder;</span>
<a href="#l105.21"></a><span id="l105.21"> var inboxFolder;</span>
<a href="#l105.22"></a><span id="l105.22"> var unreadFolder;</span>
<a href="#l105.23"></a><span id="l105.23"> var favoriteFolder;</span>
<a href="#l105.24"></a><span id="l105.24"> var toggle_menu;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l106.1"></a><span id="l106.1" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/test-smart-folders.js</span>
<a href="#l106.2"></a><span id="l106.2" class="difflineplus">+++ b/mail/test/mozmill/folder-tree-modes/test-smart-folders.js</span>
<a href="#l106.3"></a><span id="l106.3" class="difflineat">@@ -5,20 +5,21 @@</span>
<a href="#l106.4"></a><span id="l106.4"> /*</span>
<a href="#l106.5"></a><span id="l106.5">  * Test that the smart folder mode works properly. This includes checking</span>
<a href="#l106.6"></a><span id="l106.6">  * whether |getParentOfFolder| works, and also making sure selectFolder behaves</span>
<a href="#l106.7"></a><span id="l106.7">  * properly, opening the right folders.</span>
<a href="#l106.8"></a><span id="l106.8">  */</span>
<a href="#l106.9"></a><span id="l106.9"> </span>
<a href="#l106.10"></a><span id="l106.10"> &quot;use strict&quot;;</span>
<a href="#l106.11"></a><span id="l106.11"> </span>
<a href="#l106.12"></a><span id="l106.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l106.13"></a><span id="l106.13" class="difflineplus">+</span>
<a href="#l106.14"></a><span id="l106.14"> var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l106.15"></a><span id="l106.15"> </span>
<a href="#l106.16"></a><span id="l106.16"> var MODULE_NAME = &quot;test-smart-folders&quot;;</span>
<a href="#l106.17"></a><span id="l106.17" class="difflineminus">-</span>
<a href="#l106.18"></a><span id="l106.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l106.19"></a><span id="l106.19"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l106.20"></a><span id="l106.20"> </span>
<a href="#l106.21"></a><span id="l106.21"> var rootFolder;</span>
<a href="#l106.22"></a><span id="l106.22"> var inboxSubfolder;</span>
<a href="#l106.23"></a><span id="l106.23"> var trashFolder;</span>
<a href="#l106.24"></a><span id="l106.24"> var trashSubfolder;</span>
<a href="#l106.25"></a><span id="l106.25"> </span>
<a href="#l106.26"></a><span id="l106.26" class="difflineat">@@ -194,44 +195,40 @@ function test_folder_flag_changes() {</span>
<a href="#l106.27"></a><span id="l106.27">     desiredScope += folder.URI + &quot;|&quot;;</span>
<a href="#l106.28"></a><span id="l106.28">   }</span>
<a href="#l106.29"></a><span id="l106.29"> </span>
<a href="#l106.30"></a><span id="l106.30">   if (archiveScope != desiredScope)</span>
<a href="#l106.31"></a><span id="l106.31">     throw new Error(&quot;archive scope wrong after removing folder&quot;);</span>
<a href="#l106.32"></a><span id="l106.32">   assert_folder_and_children_not_in_scope(archiveFolder, archiveScope);</span>
<a href="#l106.33"></a><span id="l106.33"> }</span>
<a href="#l106.34"></a><span id="l106.34"> </span>
<a href="#l106.35"></a><span id="l106.35" class="difflineminus">-function assert_folder_and_children_in_scope(folder, searchScope)</span>
<a href="#l106.36"></a><span id="l106.36" class="difflineminus">-{</span>
<a href="#l106.37"></a><span id="l106.37" class="difflineplus">+function assert_folder_and_children_in_scope(folder, searchScope) {</span>
<a href="#l106.38"></a><span id="l106.38">   let folderURI = &quot;|&quot; + folder.URI + &quot;|&quot;;</span>
<a href="#l106.39"></a><span id="l106.39">   assert_uri_found(folderURI, searchScope);</span>
<a href="#l106.40"></a><span id="l106.40">   let allDescendants = folder.descendants;</span>
<a href="#l106.41"></a><span id="l106.41">   for (let folder of fixIterator(allDescendants, Ci.nsIMsgFolder)) {</span>
<a href="#l106.42"></a><span id="l106.42">     assert_uri_found(folder.URI, searchScope);</span>
<a href="#l106.43"></a><span id="l106.43">   }</span>
<a href="#l106.44"></a><span id="l106.44"> }</span>
<a href="#l106.45"></a><span id="l106.45"> </span>
<a href="#l106.46"></a><span id="l106.46" class="difflineminus">-function assert_folder_and_children_not_in_scope(folder, searchScope)</span>
<a href="#l106.47"></a><span id="l106.47" class="difflineminus">-{</span>
<a href="#l106.48"></a><span id="l106.48" class="difflineplus">+function assert_folder_and_children_not_in_scope(folder, searchScope) {</span>
<a href="#l106.49"></a><span id="l106.49">   let folderURI = &quot;|&quot; + folder.URI + &quot;|&quot;;</span>
<a href="#l106.50"></a><span id="l106.50">   assert_uri_not_found(folderURI, searchScope);</span>
<a href="#l106.51"></a><span id="l106.51">   let allDescendants = folder.descendants;</span>
<a href="#l106.52"></a><span id="l106.52">   for (let folder of fixIterator(allDescendants, Ci.nsIMsgFolder)) {</span>
<a href="#l106.53"></a><span id="l106.53">     assert_uri_not_found(folder.URI, searchScope);</span>
<a href="#l106.54"></a><span id="l106.54">   }</span>
<a href="#l106.55"></a><span id="l106.55"> }</span>
<a href="#l106.56"></a><span id="l106.56"> </span>
<a href="#l106.57"></a><span id="l106.57" class="difflineminus">-function assert_uri_found(folderURI, scopeList)</span>
<a href="#l106.58"></a><span id="l106.58" class="difflineminus">-{</span>
<a href="#l106.59"></a><span id="l106.59" class="difflineplus">+function assert_uri_found(folderURI, scopeList) {</span>
<a href="#l106.60"></a><span id="l106.60">   if (!scopeList.includes(folderURI))</span>
<a href="#l106.61"></a><span id="l106.61">     throw new Error(&quot;scope &quot; + scopeList + &quot;doesn't contain &quot; + folderURI);</span>
<a href="#l106.62"></a><span id="l106.62"> }</span>
<a href="#l106.63"></a><span id="l106.63"> </span>
<a href="#l106.64"></a><span id="l106.64" class="difflineminus">-function assert_uri_not_found(folderURI, scopeList)</span>
<a href="#l106.65"></a><span id="l106.65" class="difflineminus">-{</span>
<a href="#l106.66"></a><span id="l106.66" class="difflineplus">+function assert_uri_not_found(folderURI, scopeList) {</span>
<a href="#l106.67"></a><span id="l106.67">   if (scopeList.includes(folderURI))</span>
<a href="#l106.68"></a><span id="l106.68">     throw new Error(&quot;scope &quot; + scopeList + &quot;contains &quot; + folderURI +</span>
<a href="#l106.69"></a><span id="l106.69">                     &quot; but shouldn't&quot;);</span>
<a href="#l106.70"></a><span id="l106.70"> }</span>
<a href="#l106.71"></a><span id="l106.71"> </span>
<a href="#l106.72"></a><span id="l106.72"> /**</span>
<a href="#l106.73"></a><span id="l106.73">  * Move back to the all folders mode.</span>
<a href="#l106.74"></a><span id="l106.74">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l107.1"></a><span id="l107.1" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/test-unread-folders.js</span>
<a href="#l107.2"></a><span id="l107.2" class="difflineplus">+++ b/mail/test/mozmill/folder-tree-modes/test-unread-folders.js</span>
<a href="#l107.3"></a><span id="l107.3" class="difflineat">@@ -5,18 +5,19 @@</span>
<a href="#l107.4"></a><span id="l107.4"> /*</span>
<a href="#l107.5"></a><span id="l107.5">  * Test that the unread folder mode works properly. This includes making</span>
<a href="#l107.6"></a><span id="l107.6">  * sure that the selected folder is maintained correctly when the view</span>
<a href="#l107.7"></a><span id="l107.7">  * is rebuilt because a folder has become newly unread.</span>
<a href="#l107.8"></a><span id="l107.8">  */</span>
<a href="#l107.9"></a><span id="l107.9"> </span>
<a href="#l107.10"></a><span id="l107.10"> &quot;use strict&quot;;</span>
<a href="#l107.11"></a><span id="l107.11"> </span>
<a href="#l107.12"></a><span id="l107.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l107.13"></a><span id="l107.13" class="difflineplus">+</span>
<a href="#l107.14"></a><span id="l107.14"> var MODULE_NAME = &quot;test-unread-folders&quot;;</span>
<a href="#l107.15"></a><span id="l107.15" class="difflineminus">-</span>
<a href="#l107.16"></a><span id="l107.16"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l107.17"></a><span id="l107.17"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l107.18"></a><span id="l107.18"> </span>
<a href="#l107.19"></a><span id="l107.19"> var rootFolder;</span>
<a href="#l107.20"></a><span id="l107.20"> var inboxSubfolder;</span>
<a href="#l107.21"></a><span id="l107.21"> var trashFolder;</span>
<a href="#l107.22"></a><span id="l107.22"> var trashSubfolder;</span>
<a href="#l107.23"></a><span id="l107.23"> var inboxSet;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l108.1"></a><span id="l108.1" class="difflineminus">--- a/mail/test/mozmill/folder-widget/test-message-filters.js</span>
<a href="#l108.2"></a><span id="l108.2" class="difflineplus">+++ b/mail/test/mozmill/folder-widget/test-message-filters.js</span>
<a href="#l108.3"></a><span id="l108.3" class="difflineat">@@ -3,50 +3,53 @@</span>
<a href="#l108.4"></a><span id="l108.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l108.5"></a><span id="l108.5"> </span>
<a href="#l108.6"></a><span id="l108.6"> /*</span>
<a href="#l108.7"></a><span id="l108.7">  * Test various properties of the message filters.</span>
<a href="#l108.8"></a><span id="l108.8">  */</span>
<a href="#l108.9"></a><span id="l108.9"> </span>
<a href="#l108.10"></a><span id="l108.10"> &quot;use strict&quot;;</span>
<a href="#l108.11"></a><span id="l108.11"> </span>
<a href="#l108.12"></a><span id="l108.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-address-book-helpers.js */</span>
<a href="#l108.13"></a><span id="l108.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l108.14"></a><span id="l108.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-nntp-helpers.js */</span>
<a href="#l108.15"></a><span id="l108.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-prompt-helpers.js */</span>
<a href="#l108.16"></a><span id="l108.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l108.17"></a><span id="l108.17" class="difflineplus">+</span>
<a href="#l108.18"></a><span id="l108.18"> var MODULE_NAME = &quot;test-message-filters&quot;;</span>
<a href="#l108.19"></a><span id="l108.19" class="difflineminus">-</span>
<a href="#l108.20"></a><span id="l108.20"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l108.21"></a><span id="l108.21" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l108.22"></a><span id="l108.22" class="difflineminus">-                       &quot;nntp-helpers&quot;, &quot;address-book-helpers&quot;,</span>
<a href="#l108.23"></a><span id="l108.23" class="difflineminus">-                       &quot;prompt-helpers&quot;];</span>
<a href="#l108.24"></a><span id="l108.24" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l108.25"></a><span id="l108.25" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l108.26"></a><span id="l108.26" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l108.27"></a><span id="l108.27" class="difflineplus">+  &quot;nntp-helpers&quot;,</span>
<a href="#l108.28"></a><span id="l108.28" class="difflineplus">+  &quot;address-book-helpers&quot;,</span>
<a href="#l108.29"></a><span id="l108.29" class="difflineplus">+  &quot;prompt-helpers&quot;,</span>
<a href="#l108.30"></a><span id="l108.30" class="difflineplus">+];</span>
<a href="#l108.31"></a><span id="l108.31"> </span>
<a href="#l108.32"></a><span id="l108.32"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l108.33"></a><span id="l108.33"> var folderA;</span>
<a href="#l108.34"></a><span id="l108.34"> </span>
<a href="#l108.35"></a><span id="l108.35" class="difflineminus">-function setupModule(module)</span>
<a href="#l108.36"></a><span id="l108.36" class="difflineminus">-{</span>
<a href="#l108.37"></a><span id="l108.37" class="difflineplus">+function setupModule(module) {</span>
<a href="#l108.38"></a><span id="l108.38">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l108.39"></a><span id="l108.39">     collector.getModule(lib).installInto(module);</span>
<a href="#l108.40"></a><span id="l108.40">   }</span>
<a href="#l108.41"></a><span id="l108.41"> </span>
<a href="#l108.42"></a><span id="l108.42">   setupNNTPDaemon();</span>
<a href="#l108.43"></a><span id="l108.43"> </span>
<a href="#l108.44"></a><span id="l108.44">   folderA = create_folder(&quot;FolderToolbarA&quot;);</span>
<a href="#l108.45"></a><span id="l108.45">   // we need one message to select and open</span>
<a href="#l108.46"></a><span id="l108.46">   make_new_sets_in_folder(folderA, [{count: 1}]);</span>
<a href="#l108.47"></a><span id="l108.47"> </span>
<a href="#l108.48"></a><span id="l108.48">   setupLocalServer(NNTP_PORT);</span>
<a href="#l108.49"></a><span id="l108.49" class="difflineminus">-</span>
<a href="#l108.50"></a><span id="l108.50" class="difflineminus">-  // Note, the uri is for hostname &quot;invalid&quot; which is the original uri. See</span>
<a href="#l108.51"></a><span id="l108.51" class="difflineminus">-  // setupProtocolTest parameters.</span>
<a href="#l108.52"></a><span id="l108.52" class="difflineminus">-  var prefix = &quot;news://invalid:&quot;+NNTP_PORT+&quot;/&quot;;</span>
<a href="#l108.53"></a><span id="l108.53"> }</span>
<a href="#l108.54"></a><span id="l108.54"> </span>
<a href="#l108.55"></a><span id="l108.55"> /*</span>
<a href="#l108.56"></a><span id="l108.56">  * Test that the message filter list shows newsgroup servers.</span>
<a href="#l108.57"></a><span id="l108.57">  */</span>
<a href="#l108.58"></a><span id="l108.58" class="difflineminus">-function test_message_filter_shows_newsgroup_server()</span>
<a href="#l108.59"></a><span id="l108.59" class="difflineminus">-{</span>
<a href="#l108.60"></a><span id="l108.60" class="difflineplus">+function test_message_filter_shows_newsgroup_server() {</span>
<a href="#l108.61"></a><span id="l108.61">   be_in_folder(folderA);</span>
<a href="#l108.62"></a><span id="l108.62"> </span>
<a href="#l108.63"></a><span id="l108.63">   // Open the &quot;Tools  Message Filters&quot; window,</span>
<a href="#l108.64"></a><span id="l108.64">   // a.k.a. &quot;tasksMenu  filtersCmd&quot;.</span>
<a href="#l108.65"></a><span id="l108.65">   plan_for_new_window(&quot;mailnews:filterlist&quot;);</span>
<a href="#l108.66"></a><span id="l108.66">   mc.menus.Tools.filtersCmd.click();</span>
<a href="#l108.67"></a><span id="l108.67">   let filterc = wait_for_new_window(&quot;mailnews:filterlist&quot;);</span>
<a href="#l108.68"></a><span id="l108.68">   wait_for_window_focused(filterc.window);</span>
<a href="#l108.69"></a><span id="l108.69" class="difflineat">@@ -54,39 +57,38 @@ function test_message_filter_shows_newsg</span>
<a href="#l108.70"></a><span id="l108.70">   let popup = filterc.eid(&quot;serverMenuPopup&quot;);</span>
<a href="#l108.71"></a><span id="l108.71">   filterc.assertNode(popup);</span>
<a href="#l108.72"></a><span id="l108.72">   filterc.click(popup);</span>
<a href="#l108.73"></a><span id="l108.73"> </span>
<a href="#l108.74"></a><span id="l108.74">   let nntp = new elib.Elem(popup.node.children.item(2));</span>
<a href="#l108.75"></a><span id="l108.75">   filterc.assertNode(nntp);</span>
<a href="#l108.76"></a><span id="l108.76">   // We need to get the newsgroups to pop up somehow.</span>
<a href="#l108.77"></a><span id="l108.77">   // These all fail.</span>
<a href="#l108.78"></a><span id="l108.78" class="difflineminus">-  //filterc.click(nntp);</span>
<a href="#l108.79"></a><span id="l108.79" class="difflineminus">-  //filterc.mouseover(nntp);</span>
<a href="#l108.80"></a><span id="l108.80" class="difflineminus">-  //filterc.select(popup, popup.node.parentNode.getIndexOfItem(nntp.node));</span>
<a href="#l108.81"></a><span id="l108.81" class="difflineminus">-  //filterc.select(nntp, popup.node.parentNode.getIndexOfItem(nntp.node));</span>
<a href="#l108.82"></a><span id="l108.82" class="difflineminus">-  //filterc.select(popup, 2);</span>
<a href="#l108.83"></a><span id="l108.83" class="difflineminus">-  //let nntpPopup = new elib.Elem(nntp.node.menupopup);</span>
<a href="#l108.84"></a><span id="l108.84" class="difflineminus">-  //filterc.click(nntpPopup);</span>
<a href="#l108.85"></a><span id="l108.85" class="difflineminus">-  //filterc.mouseover(nntpPopup);</span>
<a href="#l108.86"></a><span id="l108.86" class="difflineminus">-  //filterc.select(nntpPopup, 2);</span>
<a href="#l108.87"></a><span id="l108.87" class="difflineplus">+  // filterc.click(nntp);</span>
<a href="#l108.88"></a><span id="l108.88" class="difflineplus">+  // filterc.mouseover(nntp);</span>
<a href="#l108.89"></a><span id="l108.89" class="difflineplus">+  // filterc.select(popup, popup.node.parentNode.getIndexOfItem(nntp.node));</span>
<a href="#l108.90"></a><span id="l108.90" class="difflineplus">+  // filterc.select(nntp, popup.node.parentNode.getIndexOfItem(nntp.node));</span>
<a href="#l108.91"></a><span id="l108.91" class="difflineplus">+  // filterc.select(popup, 2);</span>
<a href="#l108.92"></a><span id="l108.92" class="difflineplus">+  // let nntpPopup = new elib.Elem(nntp.node.menupopup);</span>
<a href="#l108.93"></a><span id="l108.93" class="difflineplus">+  // filterc.click(nntpPopup);</span>
<a href="#l108.94"></a><span id="l108.94" class="difflineplus">+  // filterc.mouseover(nntpPopup);</span>
<a href="#l108.95"></a><span id="l108.95" class="difflineplus">+  // filterc.select(nntpPopup, 2);</span>
<a href="#l108.96"></a><span id="l108.96"> </span>
<a href="#l108.97"></a><span id="l108.97">   // This one initializes the menuitems, but it's kinda hacky.</span>
<a href="#l108.98"></a><span id="l108.98">   nntp.node.menupopup._ensureInitialized();</span>
<a href="#l108.99"></a><span id="l108.99">   assert_equals(nntp.node.itemCount, 5,</span>
<a href="#l108.100"></a><span id="l108.100">                 &quot;Incorrect number of children for the NNTP server&quot;);</span>
<a href="#l108.101"></a><span id="l108.101">   close_window(filterc);</span>
<a href="#l108.102"></a><span id="l108.102"> }</span>
<a href="#l108.103"></a><span id="l108.103"> </span>
<a href="#l108.104"></a><span id="l108.104"> /*</span>
<a href="#l108.105"></a><span id="l108.105">  * Test that customizing the toolbar doesn't lead to doubled accounts in</span>
<a href="#l108.106"></a><span id="l108.106">  * the Get Mail menu.  (bug 520457)</span>
<a href="#l108.107"></a><span id="l108.107">  */</span>
<a href="#l108.108"></a><span id="l108.108" class="difflineminus">-function test_customize_toolbar_doesnt_double_get_mail_menu()</span>
<a href="#l108.109"></a><span id="l108.109" class="difflineminus">-{</span>
<a href="#l108.110"></a><span id="l108.110" class="difflineplus">+function test_customize_toolbar_doesnt_double_get_mail_menu() {</span>
<a href="#l108.111"></a><span id="l108.111">   be_in_folder(folderA);</span>
<a href="#l108.112"></a><span id="l108.112"> </span>
<a href="#l108.113"></a><span id="l108.113">   /**</span>
<a href="#l108.114"></a><span id="l108.114">    * Get the getAllNewMessages menu and check the number of items.</span>
<a href="#l108.115"></a><span id="l108.115">    */</span>
<a href="#l108.116"></a><span id="l108.116">   function check_getAllNewMsgMenu() {</span>
<a href="#l108.117"></a><span id="l108.117">     wait_for_window_focused(mc.window);</span>
<a href="#l108.118"></a><span id="l108.118">     mc.click(mc.eid(&quot;button-appmenu&quot;), 5, 5);</span>
<a href="#l108.119"></a><span id="l108.119" class="difflineat">@@ -154,18 +156,17 @@ function create_simple_filter() {</span>
<a href="#l108.120"></a><span id="l108.120">   plan_for_modal_dialog(&quot;mailnews:filtereditor&quot;, fill_in_filter_fields);</span>
<a href="#l108.121"></a><span id="l108.121">   filterc.click(filterc.eid(&quot;newButton&quot;));</span>
<a href="#l108.122"></a><span id="l108.122">   wait_for_modal_dialog(&quot;mailnews:filtereditor&quot;);</span>
<a href="#l108.123"></a><span id="l108.123"> }</span>
<a href="#l108.124"></a><span id="l108.124"> </span>
<a href="#l108.125"></a><span id="l108.125"> /*</span>
<a href="#l108.126"></a><span id="l108.126">  * Test that the address books can appear in the message filter dropdown</span>
<a href="#l108.127"></a><span id="l108.127">  */</span>
<a href="#l108.128"></a><span id="l108.128" class="difflineminus">-function test_address_books_appear_in_message_filter_dropdown()</span>
<a href="#l108.129"></a><span id="l108.129" class="difflineminus">-{</span>
<a href="#l108.130"></a><span id="l108.130" class="difflineplus">+function test_address_books_appear_in_message_filter_dropdown() {</span>
<a href="#l108.131"></a><span id="l108.131">   // Create a remote address book - we don't want this to appear in the</span>
<a href="#l108.132"></a><span id="l108.132">   // dropdown.</span>
<a href="#l108.133"></a><span id="l108.133">   let ldapAb = create_ldap_address_book(&quot;Some LDAP Address Book&quot;);</span>
<a href="#l108.134"></a><span id="l108.134"> </span>
<a href="#l108.135"></a><span id="l108.135">   // Sanity check - this LDAP book should be remote.</span>
<a href="#l108.136"></a><span id="l108.136">   assert_true(ldapAb.isRemote);</span>
<a href="#l108.137"></a><span id="l108.137"> </span>
<a href="#l108.138"></a><span id="l108.138">   // Open the &quot;Tools  Message Filters&quot; window,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l109.1"></a><span id="l109.1" class="difflineminus">--- a/mail/test/mozmill/im/test-chat-tab-restore.js</span>
<a href="#l109.2"></a><span id="l109.2" class="difflineplus">+++ b/mail/test/mozmill/im/test-chat-tab-restore.js</span>
<a href="#l109.3"></a><span id="l109.3" class="difflineat">@@ -1,18 +1,19 @@</span>
<a href="#l109.4"></a><span id="l109.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l109.5"></a><span id="l109.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l109.6"></a><span id="l109.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l109.7"></a><span id="l109.7"> </span>
<a href="#l109.8"></a><span id="l109.8"> &quot;use strict&quot;;</span>
<a href="#l109.9"></a><span id="l109.9"> </span>
<a href="#l109.10"></a><span id="l109.10" class="difflineminus">-var MODULE_NAME = 'test-chat-tab-restore';</span>
<a href="#l109.11"></a><span id="l109.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l109.12"></a><span id="l109.12"> </span>
<a href="#l109.13"></a><span id="l109.13" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l109.14"></a><span id="l109.14" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l109.15"></a><span id="l109.15" class="difflineplus">+var MODULE_NAME = &quot;test-chat-tab-restore&quot;;</span>
<a href="#l109.16"></a><span id="l109.16" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l109.17"></a><span id="l109.17" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l109.18"></a><span id="l109.18"> </span>
<a href="#l109.19"></a><span id="l109.19"> /**</span>
<a href="#l109.20"></a><span id="l109.20">  * Create a new chat tab, making that tab the current tab. We block until the</span>
<a href="#l109.21"></a><span id="l109.21">  * message finishes loading. (Inspired by open_selected_message_in_new_tab)</span>
<a href="#l109.22"></a><span id="l109.22">  */</span>
<a href="#l109.23"></a><span id="l109.23"> function open_chat_tab() {</span>
<a href="#l109.24"></a><span id="l109.24">   // Get the current tab count so we can make sure the tab actually opened.</span>
<a href="#l109.25"></a><span id="l109.25">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l109.26"></a><span id="l109.26" class="difflineat">@@ -46,17 +47,17 @@ function wait_for_chat_tab_to_open(aCont</span>
<a href="#l109.27"></a><span id="l109.27"> </span>
<a href="#l109.28"></a><span id="l109.28">   // The above may return immediately, meaning the event queue might not get a</span>
<a href="#l109.29"></a><span id="l109.29">   // chance. Give it a chance now.</span>
<a href="#l109.30"></a><span id="l109.30">   aController.sleep(0);</span>
<a href="#l109.31"></a><span id="l109.31">   mark_action(&quot;imh&quot;, &quot;/wait_for_chat_tab_to_open&quot;, []);</span>
<a href="#l109.32"></a><span id="l109.32"> }</span>
<a href="#l109.33"></a><span id="l109.33"> </span>
<a href="#l109.34"></a><span id="l109.34"> function setupModule(module) {</span>
<a href="#l109.35"></a><span id="l109.35" class="difflineminus">-  collector.getModule('folder-display-helpers').installInto(module);</span>
<a href="#l109.36"></a><span id="l109.36" class="difflineplus">+  collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l109.37"></a><span id="l109.37"> }</span>
<a href="#l109.38"></a><span id="l109.38"> </span>
<a href="#l109.39"></a><span id="l109.39"> /*</span>
<a href="#l109.40"></a><span id="l109.40">  * This tests that the chat tab is restored properly after tabs are</span>
<a href="#l109.41"></a><span id="l109.41">  * serialized. As for folder tabs, we can't test a restart (can we ?), so we</span>
<a href="#l109.42"></a><span id="l109.42">  * just test the persist/restore cycle.</span>
<a href="#l109.43"></a><span id="l109.43">  */</span>
<a href="#l109.44"></a><span id="l109.44"> function test_chat_tab_restore() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l110.1"></a><span id="l110.1" class="difflineminus">--- a/mail/test/mozmill/im/test-toolbar-buttons.js</span>
<a href="#l110.2"></a><span id="l110.2" class="difflineplus">+++ b/mail/test/mozmill/im/test-toolbar-buttons.js</span>
<a href="#l110.3"></a><span id="l110.3" class="difflineat">@@ -1,23 +1,24 @@</span>
<a href="#l110.4"></a><span id="l110.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l110.5"></a><span id="l110.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l110.6"></a><span id="l110.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l110.7"></a><span id="l110.7"> </span>
<a href="#l110.8"></a><span id="l110.8"> &quot;use strict&quot;;</span>
<a href="#l110.9"></a><span id="l110.9"> </span>
<a href="#l110.10"></a><span id="l110.10" class="difflineminus">-var MODULE_NAME = 'test-toolbar-buttons';</span>
<a href="#l110.11"></a><span id="l110.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l110.12"></a><span id="l110.12"> </span>
<a href="#l110.13"></a><span id="l110.13" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l110.14"></a><span id="l110.14" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l110.15"></a><span id="l110.15" class="difflineplus">+var MODULE_NAME = &quot;test-toolbar-buttons&quot;;</span>
<a href="#l110.16"></a><span id="l110.16" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l110.17"></a><span id="l110.17" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l110.18"></a><span id="l110.18"> </span>
<a href="#l110.19"></a><span id="l110.19"> var {Services} = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l110.20"></a><span id="l110.20"> </span>
<a href="#l110.21"></a><span id="l110.21"> function setupModule(module) {</span>
<a href="#l110.22"></a><span id="l110.22" class="difflineminus">-  collector.getModule('folder-display-helpers').installInto(module);</span>
<a href="#l110.23"></a><span id="l110.23" class="difflineplus">+  collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l110.24"></a><span id="l110.24"> }</span>
<a href="#l110.25"></a><span id="l110.25"> </span>
<a href="#l110.26"></a><span id="l110.26"> /* This test checks that the toolbar buttons of the chat toolbar are</span>
<a href="#l110.27"></a><span id="l110.27">  * correctly disabled/enabled, and that the placeholder displayed in</span>
<a href="#l110.28"></a><span id="l110.28">  * the middle of the chat tab is correct.</span>
<a href="#l110.29"></a><span id="l110.29">  */</span>
<a href="#l110.30"></a><span id="l110.30"> function test_toolbar_and_placeholder() {</span>
<a href="#l110.31"></a><span id="l110.31">   assert_not_equals(mc.tabmail.selectedTab.mode.type, &quot;chat&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l111.1"></a><span id="l111.1" class="difflineminus">--- a/mail/test/mozmill/instrumentation/test-instrument-setup.js</span>
<a href="#l111.2"></a><span id="l111.2" class="difflineplus">+++ b/mail/test/mozmill/instrumentation/test-instrument-setup.js</span>
<a href="#l111.3"></a><span id="l111.3" class="difflineat">@@ -1,19 +1,21 @@</span>
<a href="#l111.4"></a><span id="l111.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l111.5"></a><span id="l111.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l111.6"></a><span id="l111.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l111.7"></a><span id="l111.7"> </span>
<a href="#l111.8"></a><span id="l111.8"> &quot;use strict&quot;;</span>
<a href="#l111.9"></a><span id="l111.9"> </span>
<a href="#l111.10"></a><span id="l111.10" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l111.11"></a><span id="l111.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-keyboard-helpers.js */</span>
<a href="#l111.12"></a><span id="l111.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l111.13"></a><span id="l111.13" class="difflineplus">+</span>
<a href="#l111.14"></a><span id="l111.14"> var MODULE_NAME = &quot;test-instrument-setup&quot;;</span>
<a href="#l111.15"></a><span id="l111.15" class="difflineminus">-</span>
<a href="#l111.16"></a><span id="l111.16"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l111.17"></a><span id="l111.17" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l111.18"></a><span id="l111.18" class="difflineminus">-                       &quot;keyboard-helpers&quot; ];</span>
<a href="#l111.19"></a><span id="l111.19" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;keyboard-helpers&quot;];</span>
<a href="#l111.20"></a><span id="l111.20"> </span>
<a href="#l111.21"></a><span id="l111.21"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l111.22"></a><span id="l111.22"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l111.23"></a><span id="l111.23"> </span>
<a href="#l111.24"></a><span id="l111.24"> var user = {</span>
<a href="#l111.25"></a><span id="l111.25">   name: &quot;Roger Sterling&quot;,</span>
<a href="#l111.26"></a><span id="l111.26">   email: &quot;roger.sterling@example.com&quot;,</span>
<a href="#l111.27"></a><span id="l111.27">   incomingHost: &quot;testin.example.com&quot;,</span>
<a href="#l111.28"></a><span id="l111.28" class="difflineat">@@ -43,41 +45,38 @@ function test_mail_account_setup() {</span>
<a href="#l111.29"></a><span id="l111.29">   awc.e(&quot;realname&quot;).focus();</span>
<a href="#l111.30"></a><span id="l111.30">   input_value(awc, user.name);</span>
<a href="#l111.31"></a><span id="l111.31">   awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l111.32"></a><span id="l111.32">   input_value(awc, user.email);</span>
<a href="#l111.33"></a><span id="l111.33"> </span>
<a href="#l111.34"></a><span id="l111.34">   // Load the autoconfig file from http://localhost:433**/autoconfig/example.com</span>
<a href="#l111.35"></a><span id="l111.35">   awc.e(&quot;next_button&quot;).click();</span>
<a href="#l111.36"></a><span id="l111.36"> </span>
<a href="#l111.37"></a><span id="l111.37" class="difflineminus">-  let config = null;</span>
<a href="#l111.38"></a><span id="l111.38" class="difflineminus">-</span>
<a href="#l111.39"></a><span id="l111.39">   // XXX: This should probably use a notification, once we fix bug 561143.</span>
<a href="#l111.40"></a><span id="l111.40">   awc.waitFor(() =&gt; awc.window.gEmailConfigWizard._currentConfig != null,</span>
<a href="#l111.41"></a><span id="l111.41">               &quot;Timeout waiting for current config to become non-null&quot;,</span>
<a href="#l111.42"></a><span id="l111.42">               8000, 600);</span>
<a href="#l111.43"></a><span id="l111.43" class="difflineminus">-  config = awc.window.gEmailConfigWizard._currentConfig;</span>
<a href="#l111.44"></a><span id="l111.44">   plan_for_window_close(awc);</span>
<a href="#l111.45"></a><span id="l111.45">   awc.e(&quot;create_button&quot;).click();</span>
<a href="#l111.46"></a><span id="l111.46"> </span>
<a href="#l111.47"></a><span id="l111.47">   let events = mc.window.MailInstrumentation._currentState.events;</span>
<a href="#l111.48"></a><span id="l111.48">   wait_for_window_close();</span>
<a href="#l111.49"></a><span id="l111.49"> </span>
<a href="#l111.50"></a><span id="l111.50">   // we expect to have accountAdded and smtpServerAdded events.</span>
<a href="#l111.51"></a><span id="l111.51" class="difflineminus">-  if (! (events[&quot;accountAdded&quot;].data))</span>
<a href="#l111.52"></a><span id="l111.52" class="difflineplus">+  if (!(events.accountAdded.data))</span>
<a href="#l111.53"></a><span id="l111.53">     throw new Error(&quot;failed to add an account&quot;);</span>
<a href="#l111.54"></a><span id="l111.54" class="difflineminus">-  else if (! (events[&quot;smtpServerAdded&quot;].data))</span>
<a href="#l111.55"></a><span id="l111.55" class="difflineplus">+  else if (!(events.smtpServerAdded.data))</span>
<a href="#l111.56"></a><span id="l111.56">     throw new Error(&quot;failed to add an smtp server&quot;);</span>
<a href="#l111.57"></a><span id="l111.57"> }</span>
<a href="#l111.58"></a><span id="l111.58"> </span>
<a href="#l111.59"></a><span id="l111.59"> // Remove the accounts we added.</span>
<a href="#l111.60"></a><span id="l111.60"> function tearDownModule(module) {</span>
<a href="#l111.61"></a><span id="l111.61">   let incomingServer = MailServices.accounts.FindServer(&quot;roger.sterling&quot;, user.incomingHost, &quot;pop3&quot;);</span>
<a href="#l111.62"></a><span id="l111.62">   assert_equals(incomingServer.hostName, user.incomingHost);</span>
<a href="#l111.63"></a><span id="l111.63" class="difflineminus">-  let account = MailServices.accounts.FindAccountForServer(incomingServer)</span>
<a href="#l111.64"></a><span id="l111.64" class="difflineplus">+  let account = MailServices.accounts.FindAccountForServer(incomingServer);</span>
<a href="#l111.65"></a><span id="l111.65"> </span>
<a href="#l111.66"></a><span id="l111.66">   let identity = account.defaultIdentity;</span>
<a href="#l111.67"></a><span id="l111.67">   MailServices.accounts.removeIncomingServer(incomingServer, true);</span>
<a href="#l111.68"></a><span id="l111.68">   let outgoingServer = MailServices.smtp.getServerByKey(identity.smtpServerKey);</span>
<a href="#l111.69"></a><span id="l111.69">   assert_equals(outgoingServer.hostname, user.outgoingHost);</span>
<a href="#l111.70"></a><span id="l111.70">   MailServices.smtp.deleteServer(outgoingServer);</span>
<a href="#l111.71"></a><span id="l111.71">   MailServices.accounts.removeAccount(account);</span>
<a href="#l111.72"></a><span id="l111.72"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l112.1"></a><span id="l112.1" class="difflineminus">--- a/mail/test/mozmill/junk-commands/test-junk-commands.js</span>
<a href="#l112.2"></a><span id="l112.2" class="difflineplus">+++ b/mail/test/mozmill/junk-commands/test-junk-commands.js</span>
<a href="#l112.3"></a><span id="l112.3" class="difflineat">@@ -1,28 +1,30 @@</span>
<a href="#l112.4"></a><span id="l112.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l112.5"></a><span id="l112.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l112.6"></a><span id="l112.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l112.7"></a><span id="l112.7"> </span>
<a href="#l112.8"></a><span id="l112.8"> &quot;use strict&quot;;</span>
<a href="#l112.9"></a><span id="l112.9"> </span>
<a href="#l112.10"></a><span id="l112.10" class="difflineminus">-var MODULE_NAME = 'test-junk-commands';</span>
<a href="#l112.11"></a><span id="l112.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l112.12"></a><span id="l112.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-junk-helpers.js */</span>
<a href="#l112.13"></a><span id="l112.13"> </span>
<a href="#l112.14"></a><span id="l112.14" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l112.15"></a><span id="l112.15" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'junk-helpers'];</span>
<a href="#l112.16"></a><span id="l112.16" class="difflineplus">+var MODULE_NAME = &quot;test-junk-commands&quot;;</span>
<a href="#l112.17"></a><span id="l112.17" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l112.18"></a><span id="l112.18" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;junk-helpers&quot;];</span>
<a href="#l112.19"></a><span id="l112.19"> </span>
<a href="#l112.20"></a><span id="l112.20"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l112.21"></a><span id="l112.21"> </span>
<a href="#l112.22"></a><span id="l112.22"> // One folder's enough</span>
<a href="#l112.23"></a><span id="l112.23"> var folder = null;</span>
<a href="#l112.24"></a><span id="l112.24"> </span>
<a href="#l112.25"></a><span id="l112.25"> function setupModule(module) {</span>
<a href="#l112.26"></a><span id="l112.26" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l112.27"></a><span id="l112.27" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l112.28"></a><span id="l112.28">   fdh.installInto(module);</span>
<a href="#l112.29"></a><span id="l112.29" class="difflineminus">-  let jh = collector.getModule('junk-helpers');</span>
<a href="#l112.30"></a><span id="l112.30" class="difflineplus">+  let jh = collector.getModule(&quot;junk-helpers&quot;);</span>
<a href="#l112.31"></a><span id="l112.31">   jh.installInto(module);</span>
<a href="#l112.32"></a><span id="l112.32"> </span>
<a href="#l112.33"></a><span id="l112.33">   folder = create_folder(&quot;JunkCommandsA&quot;);</span>
<a href="#l112.34"></a><span id="l112.34">   make_new_sets_in_folder(folder, [{count: 30}]);</span>
<a href="#l112.35"></a><span id="l112.35"> }</span>
<a href="#l112.36"></a><span id="l112.36"> </span>
<a href="#l112.37"></a><span id="l112.37"> /**</span>
<a href="#l112.38"></a><span id="l112.38">  * The number of messages to mark as junk and expect to be deleted.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l113.1"></a><span id="l113.1" class="difflineminus">--- a/mail/test/mozmill/keyboard/test-spacehit.js</span>
<a href="#l113.2"></a><span id="l113.2" class="difflineplus">+++ b/mail/test/mozmill/keyboard/test-spacehit.js</span>
<a href="#l113.3"></a><span id="l113.3" class="difflineat">@@ -4,28 +4,29 @@</span>
<a href="#l113.4"></a><span id="l113.4"> </span>
<a href="#l113.5"></a><span id="l113.5"> /**</span>
<a href="#l113.6"></a><span id="l113.6">  * Tests that the space bar only advances to the next unread message</span>
<a href="#l113.7"></a><span id="l113.7">  * when mail.advance_on_spacebar is true (default).</span>
<a href="#l113.8"></a><span id="l113.8">  */</span>
<a href="#l113.9"></a><span id="l113.9"> </span>
<a href="#l113.10"></a><span id="l113.10"> &quot;use strict&quot;;</span>
<a href="#l113.11"></a><span id="l113.11"> </span>
<a href="#l113.12"></a><span id="l113.12" class="difflineminus">-var MODULE_NAME = 'test-spacehit';</span>
<a href="#l113.13"></a><span id="l113.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l113.14"></a><span id="l113.14"> </span>
<a href="#l113.15"></a><span id="l113.15" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l113.16"></a><span id="l113.16" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers'];</span>
<a href="#l113.17"></a><span id="l113.17" class="difflineplus">+var MODULE_NAME = &quot;test-spacehit&quot;;</span>
<a href="#l113.18"></a><span id="l113.18" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l113.19"></a><span id="l113.19" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l113.20"></a><span id="l113.20"> </span>
<a href="#l113.21"></a><span id="l113.21"> // Get original preference value</span>
<a href="#l113.22"></a><span id="l113.22"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l113.23"></a><span id="l113.23"> var prefName = &quot;mail.advance_on_spacebar&quot;;</span>
<a href="#l113.24"></a><span id="l113.24"> var prefValue = Services.prefs.getBoolPref(prefName);</span>
<a href="#l113.25"></a><span id="l113.25"> </span>
<a href="#l113.26"></a><span id="l113.26"> function setupModule(module) {</span>
<a href="#l113.27"></a><span id="l113.27" class="difflineminus">-  collector.getModule('folder-display-helpers').installInto(module);</span>
<a href="#l113.28"></a><span id="l113.28" class="difflineplus">+  collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l113.29"></a><span id="l113.29">   // Create four unread messages in a sample folder</span>
<a href="#l113.30"></a><span id="l113.30">   let folder = create_folder(&quot;Sample&quot;);</span>
<a href="#l113.31"></a><span id="l113.31">   make_new_sets_in_folder(folder, [{count: 4}]);</span>
<a href="#l113.32"></a><span id="l113.32">   be_in_folder(folder);</span>
<a href="#l113.33"></a><span id="l113.33"> }</span>
<a href="#l113.34"></a><span id="l113.34"> </span>
<a href="#l113.35"></a><span id="l113.35"> function teardownModule(module) {</span>
<a href="#l113.36"></a><span id="l113.36">   // Restore original preference value</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l114.1"></a><span id="l114.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-message-header.js</span>
<a href="#l114.2"></a><span id="l114.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-message-header.js</span>
<a href="#l114.3"></a><span id="l114.3" class="difflineat">@@ -2,25 +2,31 @@</span>
<a href="#l114.4"></a><span id="l114.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l114.5"></a><span id="l114.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l114.6"></a><span id="l114.6"> </span>
<a href="#l114.7"></a><span id="l114.7"> /**</span>
<a href="#l114.8"></a><span id="l114.8">  * Test functionality in the message header, e.g. tagging, contact editing,</span>
<a href="#l114.9"></a><span id="l114.9">  * the more button ...</span>
<a href="#l114.10"></a><span id="l114.10">  */</span>
<a href="#l114.11"></a><span id="l114.11"> </span>
<a href="#l114.12"></a><span id="l114.12" class="difflineminus">-// make SOLO_TEST=message-header/test-message-header.js mozmill-one</span>
<a href="#l114.13"></a><span id="l114.13" class="difflineminus">-</span>
<a href="#l114.14"></a><span id="l114.14"> &quot;use strict&quot;;</span>
<a href="#l114.15"></a><span id="l114.15"> </span>
<a href="#l114.16"></a><span id="l114.16" class="difflineminus">-var MODULE_NAME = 'test-message-header';</span>
<a href="#l114.17"></a><span id="l114.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-address-book-helpers.js */</span>
<a href="#l114.18"></a><span id="l114.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-dom-helpers.js */</span>
<a href="#l114.19"></a><span id="l114.19" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l114.20"></a><span id="l114.20" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l114.21"></a><span id="l114.21"> </span>
<a href="#l114.22"></a><span id="l114.22" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l114.23"></a><span id="l114.23" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l114.24"></a><span id="l114.24" class="difflineminus">-                       'address-book-helpers', 'dom-helpers'];</span>
<a href="#l114.25"></a><span id="l114.25" class="difflineplus">+var MODULE_NAME = &quot;test-message-header&quot;;</span>
<a href="#l114.26"></a><span id="l114.26" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l114.27"></a><span id="l114.27" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l114.28"></a><span id="l114.28" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l114.29"></a><span id="l114.29" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l114.30"></a><span id="l114.30" class="difflineplus">+  &quot;address-book-helpers&quot;,</span>
<a href="#l114.31"></a><span id="l114.31" class="difflineplus">+  &quot;dom-helpers&quot;,</span>
<a href="#l114.32"></a><span id="l114.32" class="difflineplus">+];</span>
<a href="#l114.33"></a><span id="l114.33"> </span>
<a href="#l114.34"></a><span id="l114.34"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l114.35"></a><span id="l114.35"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l114.36"></a><span id="l114.36"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l114.37"></a><span id="l114.37"> </span>
<a href="#l114.38"></a><span id="l114.38"> var folder, folderMore;</span>
<a href="#l114.39"></a><span id="l114.39"> var gInterestingMessage;</span>
<a href="#l114.40"></a><span id="l114.40"> </span>
<a href="#l114.41"></a><span id="l114.41" class="difflineat">@@ -40,17 +46,17 @@ function setupModule(module) {</span>
<a href="#l114.42"></a><span id="l114.42">   // create a message that has the interesting headers that commonly</span>
<a href="#l114.43"></a><span id="l114.43">   // show up in the message header pane for testing</span>
<a href="#l114.44"></a><span id="l114.44">   gInterestingMessage = create_message({cc: msgGen.makeNamesAndAddresses(20), // YYY</span>
<a href="#l114.45"></a><span id="l114.45">     subject: &quot;This is a really, really, really, really, really, really, really, really, long subject.&quot;,</span>
<a href="#l114.46"></a><span id="l114.46">     clobberHeaders: {</span>
<a href="#l114.47"></a><span id="l114.47">       &quot;Newsgroups&quot;: &quot;alt.test&quot;,</span>
<a href="#l114.48"></a><span id="l114.48">       &quot;Reply-To&quot;: &quot;J. Doe &lt;j.doe@momo.invalid&gt;&quot;,</span>
<a href="#l114.49"></a><span id="l114.49">       &quot;Content-Base&quot;: &quot;http://example.com/&quot;,</span>
<a href="#l114.50"></a><span id="l114.50" class="difflineminus">-      &quot;Bcc&quot;: &quot;Richard Roe &lt;richard.roe@momo.invalid&gt;&quot;</span>
<a href="#l114.51"></a><span id="l114.51" class="difflineplus">+      &quot;Bcc&quot;: &quot;Richard Roe &lt;richard.roe@momo.invalid&gt;&quot;,</span>
<a href="#l114.52"></a><span id="l114.52">     }});</span>
<a href="#l114.53"></a><span id="l114.53"> </span>
<a href="#l114.54"></a><span id="l114.54">   add_message_to_folder(folder, gInterestingMessage);</span>
<a href="#l114.55"></a><span id="l114.55"> </span>
<a href="#l114.56"></a><span id="l114.56">   // create a message that has more to and cc addresses than visible in the</span>
<a href="#l114.57"></a><span id="l114.57">   // tooltip text of the more button</span>
<a href="#l114.58"></a><span id="l114.58">   let msgMore1 = create_message({to: msgGen.makeNamesAndAddresses(40),</span>
<a href="#l114.59"></a><span id="l114.59">                                  cc: msgGen.makeNamesAndAddresses(40)});</span>
<a href="#l114.60"></a><span id="l114.60" class="difflineat">@@ -69,24 +75,24 @@ function setupModule(module) {</span>
<a href="#l114.61"></a><span id="l114.61"> </span>
<a href="#l114.62"></a><span id="l114.62">   // Some of these tests critically depends on the window width, collapse</span>
<a href="#l114.63"></a><span id="l114.63">   // everything that might be in the way</span>
<a href="#l114.64"></a><span id="l114.64">   collapse_panes(mc.e(&quot;folderpane_splitter&quot;), true);</span>
<a href="#l114.65"></a><span id="l114.65">   collapse_panes(mc.e(&quot;tabmail-container&quot;), true);</span>
<a href="#l114.66"></a><span id="l114.66"> </span>
<a href="#l114.67"></a><span id="l114.67">   // Disable animations on the panel, so that we don't have to deal with</span>
<a href="#l114.68"></a><span id="l114.68">   // async openings.</span>
<a href="#l114.69"></a><span id="l114.69" class="difflineminus">-  let contactPanel = mc.eid('editContactPanel').getNode();</span>
<a href="#l114.70"></a><span id="l114.70" class="difflineplus">+  let contactPanel = mc.eid(&quot;editContactPanel&quot;).getNode();</span>
<a href="#l114.71"></a><span id="l114.71">   contactPanel.setAttribute(&quot;animate&quot;, false);</span>
<a href="#l114.72"></a><span id="l114.72"> </span>
<a href="#l114.73"></a><span id="l114.73">   test_a11y_attrs.__force_skip__ = true; // disabled for now, see bug 1489748</span>
<a href="#l114.74"></a><span id="l114.74"> }</span>
<a href="#l114.75"></a><span id="l114.75"> </span>
<a href="#l114.76"></a><span id="l114.76"> function teardownModule(module) {</span>
<a href="#l114.77"></a><span id="l114.77" class="difflineminus">-  let contactPanel = mc.eid('editContactPanel').getNode();</span>
<a href="#l114.78"></a><span id="l114.78" class="difflineplus">+  let contactPanel = mc.eid(&quot;editContactPanel&quot;).getNode();</span>
<a href="#l114.79"></a><span id="l114.79">   contactPanel.removeAttribute(&quot;animate&quot;);</span>
<a href="#l114.80"></a><span id="l114.80"> </span>
<a href="#l114.81"></a><span id="l114.81">   // Now restore the panes we hid in setupModule</span>
<a href="#l114.82"></a><span id="l114.82">   collapse_panes(mc.e(&quot;folderpane_splitter&quot;), false);</span>
<a href="#l114.83"></a><span id="l114.83">   collapse_panes(mc.e(&quot;tabmail-container&quot;), false);</span>
<a href="#l114.84"></a><span id="l114.84"> }</span>
<a href="#l114.85"></a><span id="l114.85"> </span>
<a href="#l114.86"></a><span id="l114.86"> /**</span>
<a href="#l114.87"></a><span id="l114.87" class="difflineat">@@ -159,111 +165,119 @@ function test_add_tag_with_really_long_l</span>
<a href="#l114.88"></a><span id="l114.88"> /**</span>
<a href="#l114.89"></a><span id="l114.89">  * @param headerName used for pretty-printing in exceptions</span>
<a href="#l114.90"></a><span id="l114.90">  * @param headerValueElement  Function returning the DOM element</span>
<a href="#l114.91"></a><span id="l114.91">  *                            with the data.</span>
<a href="#l114.92"></a><span id="l114.92">  * @param expectedName  Function returning the expected value of</span>
<a href="#l114.93"></a><span id="l114.93">  *                      nsIAccessible.name for the DOM element in question</span>
<a href="#l114.94"></a><span id="l114.94">  * @param expectedRole the expected value for nsIAccessible.role</span>
<a href="#l114.95"></a><span id="l114.95">  */</span>
<a href="#l114.96"></a><span id="l114.96" class="difflineminus">-let headersToTest = [</span>
<a href="#l114.97"></a><span id="l114.97" class="difflineminus">-{</span>
<a href="#l114.98"></a><span id="l114.98" class="difflineplus">+let headersToTest = [{</span>
<a href="#l114.99"></a><span id="l114.99">   headerName: &quot;Subject&quot;,</span>
<a href="#l114.100"></a><span id="l114.100" class="difflineminus">-  headerValueElement: function(mc) {</span>
<a href="#l114.101"></a><span id="l114.101" class="difflineminus">-                      return mc.e(&quot;expandedsubjectBox&quot;, {class: &quot;headerValue&quot;}); },</span>
<a href="#l114.102"></a><span id="l114.102" class="difflineminus">-  expectedName: function(mc, headerValueElement) {</span>
<a href="#l114.103"></a><span id="l114.103" class="difflineminus">-                return mc.e(&quot;expandedsubjectLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.104"></a><span id="l114.104" class="difflineminus">-                headerValueElement.textContent; },</span>
<a href="#l114.105"></a><span id="l114.105" class="difflineminus">-  expectedRole: Ci.nsIAccessibleRole.ROLE_ENTRY</span>
<a href="#l114.106"></a><span id="l114.106" class="difflineminus">-},</span>
<a href="#l114.107"></a><span id="l114.107" class="difflineminus">-{</span>
<a href="#l114.108"></a><span id="l114.108" class="difflineplus">+  headerValueElement(mc) {</span>
<a href="#l114.109"></a><span id="l114.109" class="difflineplus">+    return mc.e(&quot;expandedsubjectBox&quot;, {class: &quot;headerValue&quot;});</span>
<a href="#l114.110"></a><span id="l114.110" class="difflineplus">+  },</span>
<a href="#l114.111"></a><span id="l114.111" class="difflineplus">+  expectedName(mc, headerValueElement) {</span>
<a href="#l114.112"></a><span id="l114.112" class="difflineplus">+    return mc.e(&quot;expandedsubjectLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.113"></a><span id="l114.113" class="difflineplus">+    headerValueElement.textContent;</span>
<a href="#l114.114"></a><span id="l114.114" class="difflineplus">+  },</span>
<a href="#l114.115"></a><span id="l114.115" class="difflineplus">+  expectedRole: Ci.nsIAccessibleRole.ROLE_ENTRY,</span>
<a href="#l114.116"></a><span id="l114.116" class="difflineplus">+}, {</span>
<a href="#l114.117"></a><span id="l114.117">   headerName: &quot;Content-Base&quot;,</span>
<a href="#l114.118"></a><span id="l114.118" class="difflineminus">-  headerValueElement: function(mc) {</span>
<a href="#l114.119"></a><span id="l114.119" class="difflineminus">-                      return mc.a(&quot;expandedcontent-baseBox&quot;, {class: &quot;headerValue text-link headerValueUrl&quot;}); },</span>
<a href="#l114.120"></a><span id="l114.120" class="difflineminus">-  expectedName: function(mc, headerValueElement) {</span>
<a href="#l114.121"></a><span id="l114.121" class="difflineminus">-                return mc.e(&quot;expandedcontent-baseLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.122"></a><span id="l114.122" class="difflineminus">-                headerValueElement.textContent; },</span>
<a href="#l114.123"></a><span id="l114.123" class="difflineminus">-  expectedRole: Ci.nsIAccessibleRole.ROLE_ENTRY</span>
<a href="#l114.124"></a><span id="l114.124" class="difflineminus">-},</span>
<a href="#l114.125"></a><span id="l114.125" class="difflineminus">-{</span>
<a href="#l114.126"></a><span id="l114.126" class="difflineplus">+  headerValueElement(mc) {</span>
<a href="#l114.127"></a><span id="l114.127" class="difflineplus">+    return mc.a(&quot;expandedcontent-baseBox&quot;, {class: &quot;headerValue text-link headerValueUrl&quot;});</span>
<a href="#l114.128"></a><span id="l114.128" class="difflineplus">+  },</span>
<a href="#l114.129"></a><span id="l114.129" class="difflineplus">+  expectedName(mc, headerValueElement) {</span>
<a href="#l114.130"></a><span id="l114.130" class="difflineplus">+    return mc.e(&quot;expandedcontent-baseLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.131"></a><span id="l114.131" class="difflineplus">+    headerValueElement.textContent;</span>
<a href="#l114.132"></a><span id="l114.132" class="difflineplus">+  },</span>
<a href="#l114.133"></a><span id="l114.133" class="difflineplus">+  expectedRole: Ci.nsIAccessibleRole.ROLE_ENTRY,</span>
<a href="#l114.134"></a><span id="l114.134" class="difflineplus">+}, {</span>
<a href="#l114.135"></a><span id="l114.135">   headerName: &quot;From&quot;,</span>
<a href="#l114.136"></a><span id="l114.136" class="difflineminus">-  headerValueElement: function(mc) {</span>
<a href="#l114.137"></a><span id="l114.137" class="difflineminus">-                      return mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l114.138"></a><span id="l114.138" class="difflineminus">-                      mc.e(&quot;expandedfromBox&quot;, {tagName: &quot;mail-emailaddress&quot;}),</span>
<a href="#l114.139"></a><span id="l114.139" class="difflineminus">-                      &quot;class&quot;, &quot;emailDisplayButton&quot;); },</span>
<a href="#l114.140"></a><span id="l114.140" class="difflineminus">-  expectedName: function(mc, headerValueElement) {</span>
<a href="#l114.141"></a><span id="l114.141" class="difflineminus">-                return mc.e(&quot;expandedfromLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.142"></a><span id="l114.142" class="difflineminus">-                headerValueElement.parentNode.getAttribute(&quot;fullAddress&quot;); },</span>
<a href="#l114.143"></a><span id="l114.143" class="difflineminus">-  expectedRole: Ci.nsIAccessibleRole.ROLE_ENTRY</span>
<a href="#l114.144"></a><span id="l114.144" class="difflineminus">-},</span>
<a href="#l114.145"></a><span id="l114.145" class="difflineminus">-{</span>
<a href="#l114.146"></a><span id="l114.146" class="difflineplus">+  headerValueElement(mc) {</span>
<a href="#l114.147"></a><span id="l114.147" class="difflineplus">+    return mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l114.148"></a><span id="l114.148" class="difflineplus">+    mc.e(&quot;expandedfromBox&quot;, {tagName: &quot;mail-emailaddress&quot;}),</span>
<a href="#l114.149"></a><span id="l114.149" class="difflineplus">+    &quot;class&quot;, &quot;emailDisplayButton&quot;);</span>
<a href="#l114.150"></a><span id="l114.150" class="difflineplus">+  },</span>
<a href="#l114.151"></a><span id="l114.151" class="difflineplus">+  expectedName(mc, headerValueElement) {</span>
<a href="#l114.152"></a><span id="l114.152" class="difflineplus">+    return mc.e(&quot;expandedfromLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.153"></a><span id="l114.153" class="difflineplus">+    headerValueElement.parentNode.getAttribute(&quot;fullAddress&quot;);</span>
<a href="#l114.154"></a><span id="l114.154" class="difflineplus">+  },</span>
<a href="#l114.155"></a><span id="l114.155" class="difflineplus">+  expectedRole: Ci.nsIAccessibleRole.ROLE_ENTRY,</span>
<a href="#l114.156"></a><span id="l114.156" class="difflineplus">+}, {</span>
<a href="#l114.157"></a><span id="l114.157">   headerName: &quot;To&quot;,</span>
<a href="#l114.158"></a><span id="l114.158" class="difflineminus">-  headerValueElement: function(mc) {</span>
<a href="#l114.159"></a><span id="l114.159" class="difflineminus">-                      return mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l114.160"></a><span id="l114.160" class="difflineminus">-                      mc.e(&quot;expandedtoBox&quot;, {tagName: &quot;mail-emailaddress&quot;}),</span>
<a href="#l114.161"></a><span id="l114.161" class="difflineminus">-                      &quot;class&quot;, &quot;emailDisplayButton&quot;); },</span>
<a href="#l114.162"></a><span id="l114.162" class="difflineminus">-  expectedName: function(mc, headerValueElement) {</span>
<a href="#l114.163"></a><span id="l114.163" class="difflineminus">-                return mc.e(&quot;expandedtoLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.164"></a><span id="l114.164" class="difflineminus">-                headerValueElement.parentNode.getAttribute(&quot;fullAddress&quot;); },</span>
<a href="#l114.165"></a><span id="l114.165" class="difflineminus">-  expectedRole: Ci.nsIAccessibleRole.ROLE_ENTRY</span>
<a href="#l114.166"></a><span id="l114.166" class="difflineminus">-},</span>
<a href="#l114.167"></a><span id="l114.167" class="difflineminus">-{</span>
<a href="#l114.168"></a><span id="l114.168" class="difflineplus">+  headerValueElement(mc) {</span>
<a href="#l114.169"></a><span id="l114.169" class="difflineplus">+    return mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l114.170"></a><span id="l114.170" class="difflineplus">+    mc.e(&quot;expandedtoBox&quot;, {tagName: &quot;mail-emailaddress&quot;}),</span>
<a href="#l114.171"></a><span id="l114.171" class="difflineplus">+    &quot;class&quot;, &quot;emailDisplayButton&quot;);</span>
<a href="#l114.172"></a><span id="l114.172" class="difflineplus">+  },</span>
<a href="#l114.173"></a><span id="l114.173" class="difflineplus">+  expectedName(mc, headerValueElement) {</span>
<a href="#l114.174"></a><span id="l114.174" class="difflineplus">+    return mc.e(&quot;expandedtoLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.175"></a><span id="l114.175" class="difflineplus">+    headerValueElement.parentNode.getAttribute(&quot;fullAddress&quot;);</span>
<a href="#l114.176"></a><span id="l114.176" class="difflineplus">+  },</span>
<a href="#l114.177"></a><span id="l114.177" class="difflineplus">+  expectedRole: Ci.nsIAccessibleRole.ROLE_ENTRY,</span>
<a href="#l114.178"></a><span id="l114.178" class="difflineplus">+}, {</span>
<a href="#l114.179"></a><span id="l114.179">   headerName: &quot;Cc&quot;,</span>
<a href="#l114.180"></a><span id="l114.180" class="difflineminus">-  headerValueElement: function(mc) {</span>
<a href="#l114.181"></a><span id="l114.181" class="difflineminus">-                      return mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l114.182"></a><span id="l114.182" class="difflineminus">-                      mc.e(&quot;expandedccBox&quot;, {tagName: &quot;mail-emailaddress&quot;}),</span>
<a href="#l114.183"></a><span id="l114.183" class="difflineminus">-                      &quot;class&quot;, &quot;emailDisplayButton&quot;); },</span>
<a href="#l114.184"></a><span id="l114.184" class="difflineminus">-  expectedName: function(mc, headerValueElement) {</span>
<a href="#l114.185"></a><span id="l114.185" class="difflineminus">-                return mc.e(&quot;expandedccLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.186"></a><span id="l114.186" class="difflineminus">-                headerValueElement.parentNode.getAttribute(&quot;fullAddress&quot;); },</span>
<a href="#l114.187"></a><span id="l114.187" class="difflineminus">-  expectedRole: Ci.nsIAccessibleRole.ROLE_ENTRY</span>
<a href="#l114.188"></a><span id="l114.188" class="difflineminus">-},</span>
<a href="#l114.189"></a><span id="l114.189" class="difflineminus">-{</span>
<a href="#l114.190"></a><span id="l114.190" class="difflineplus">+  headerValueElement(mc) {</span>
<a href="#l114.191"></a><span id="l114.191" class="difflineplus">+    return mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l114.192"></a><span id="l114.192" class="difflineplus">+    mc.e(&quot;expandedccBox&quot;, {tagName: &quot;mail-emailaddress&quot;}),</span>
<a href="#l114.193"></a><span id="l114.193" class="difflineplus">+    &quot;class&quot;, &quot;emailDisplayButton&quot;);</span>
<a href="#l114.194"></a><span id="l114.194" class="difflineplus">+  },</span>
<a href="#l114.195"></a><span id="l114.195" class="difflineplus">+  expectedName(mc, headerValueElement) {</span>
<a href="#l114.196"></a><span id="l114.196" class="difflineplus">+    return mc.e(&quot;expandedccLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.197"></a><span id="l114.197" class="difflineplus">+    headerValueElement.parentNode.getAttribute(&quot;fullAddress&quot;);</span>
<a href="#l114.198"></a><span id="l114.198" class="difflineplus">+  },</span>
<a href="#l114.199"></a><span id="l114.199" class="difflineplus">+  expectedRole: Ci.nsIAccessibleRole.ROLE_ENTRY,</span>
<a href="#l114.200"></a><span id="l114.200" class="difflineplus">+}, {</span>
<a href="#l114.201"></a><span id="l114.201">   headerName: &quot;Bcc&quot;,</span>
<a href="#l114.202"></a><span id="l114.202" class="difflineminus">-  headerValueElement: function(mc) {</span>
<a href="#l114.203"></a><span id="l114.203" class="difflineminus">-                      return mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l114.204"></a><span id="l114.204" class="difflineminus">-                      mc.e(&quot;expandedbccBox&quot;, {tagName: &quot;mail-emailaddress&quot;}),</span>
<a href="#l114.205"></a><span id="l114.205" class="difflineminus">-                      &quot;class&quot;, &quot;emailDisplayButton&quot;); },</span>
<a href="#l114.206"></a><span id="l114.206" class="difflineminus">-  expectedName: function(mc, headerValueElement) {</span>
<a href="#l114.207"></a><span id="l114.207" class="difflineminus">-                return mc.e(&quot;expandedbccLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.208"></a><span id="l114.208" class="difflineminus">-                headerValueElement.parentNode.getAttribute(&quot;fullAddress&quot;); },</span>
<a href="#l114.209"></a><span id="l114.209" class="difflineminus">-  expectedRole: Ci.nsIAccessibleRole.ROLE_ENTRY</span>
<a href="#l114.210"></a><span id="l114.210" class="difflineminus">-},</span>
<a href="#l114.211"></a><span id="l114.211" class="difflineminus">-{</span>
<a href="#l114.212"></a><span id="l114.212" class="difflineplus">+  headerValueElement(mc) {</span>
<a href="#l114.213"></a><span id="l114.213" class="difflineplus">+    return mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l114.214"></a><span id="l114.214" class="difflineplus">+    mc.e(&quot;expandedbccBox&quot;, {tagName: &quot;mail-emailaddress&quot;}),</span>
<a href="#l114.215"></a><span id="l114.215" class="difflineplus">+    &quot;class&quot;, &quot;emailDisplayButton&quot;);</span>
<a href="#l114.216"></a><span id="l114.216" class="difflineplus">+  },</span>
<a href="#l114.217"></a><span id="l114.217" class="difflineplus">+  expectedName(mc, headerValueElement) {</span>
<a href="#l114.218"></a><span id="l114.218" class="difflineplus">+    return mc.e(&quot;expandedbccLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.219"></a><span id="l114.219" class="difflineplus">+    headerValueElement.parentNode.getAttribute(&quot;fullAddress&quot;);</span>
<a href="#l114.220"></a><span id="l114.220" class="difflineplus">+  },</span>
<a href="#l114.221"></a><span id="l114.221" class="difflineplus">+  expectedRole: Ci.nsIAccessibleRole.ROLE_ENTRY,</span>
<a href="#l114.222"></a><span id="l114.222" class="difflineplus">+}, {</span>
<a href="#l114.223"></a><span id="l114.223">   headerName: &quot;Reply-To&quot;,</span>
<a href="#l114.224"></a><span id="l114.224" class="difflineminus">-  headerValueElement: function(mc) {</span>
<a href="#l114.225"></a><span id="l114.225" class="difflineminus">-                      return mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l114.226"></a><span id="l114.226" class="difflineminus">-                      mc.e(&quot;expandedreply-toBox&quot;, {tagName: &quot;mail-emailaddress&quot;}),</span>
<a href="#l114.227"></a><span id="l114.227" class="difflineminus">-                      &quot;class&quot;, &quot;emailDisplayButton&quot;); },</span>
<a href="#l114.228"></a><span id="l114.228" class="difflineminus">-  expectedName: function(mc, headerValueElement) {</span>
<a href="#l114.229"></a><span id="l114.229" class="difflineminus">-                return mc.e(&quot;expandedreply-toLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.230"></a><span id="l114.230" class="difflineminus">-                headerValueElement.parentNode.getAttribute(&quot;fullAddress&quot;); },</span>
<a href="#l114.231"></a><span id="l114.231" class="difflineminus">-  expectedRole: Ci.nsIAccessibleRole.ROLE_ENTRY</span>
<a href="#l114.232"></a><span id="l114.232" class="difflineminus">-},</span>
<a href="#l114.233"></a><span id="l114.233" class="difflineminus">-{</span>
<a href="#l114.234"></a><span id="l114.234" class="difflineplus">+  headerValueElement(mc) {</span>
<a href="#l114.235"></a><span id="l114.235" class="difflineplus">+    return mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l114.236"></a><span id="l114.236" class="difflineplus">+    mc.e(&quot;expandedreply-toBox&quot;, {tagName: &quot;mail-emailaddress&quot;}),</span>
<a href="#l114.237"></a><span id="l114.237" class="difflineplus">+    &quot;class&quot;, &quot;emailDisplayButton&quot;);</span>
<a href="#l114.238"></a><span id="l114.238" class="difflineplus">+  },</span>
<a href="#l114.239"></a><span id="l114.239" class="difflineplus">+  expectedName(mc, headerValueElement) {</span>
<a href="#l114.240"></a><span id="l114.240" class="difflineplus">+    return mc.e(&quot;expandedreply-toLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.241"></a><span id="l114.241" class="difflineplus">+    headerValueElement.parentNode.getAttribute(&quot;fullAddress&quot;);</span>
<a href="#l114.242"></a><span id="l114.242" class="difflineplus">+  },</span>
<a href="#l114.243"></a><span id="l114.243" class="difflineplus">+  expectedRole: Ci.nsIAccessibleRole.ROLE_ENTRY,</span>
<a href="#l114.244"></a><span id="l114.244" class="difflineplus">+}, {</span>
<a href="#l114.245"></a><span id="l114.245">   headerName: &quot;Newsgroups&quot;,</span>
<a href="#l114.246"></a><span id="l114.246" class="difflineminus">-  headerValueElement: function(mc) {</span>
<a href="#l114.247"></a><span id="l114.247" class="difflineminus">-                      return mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l114.248"></a><span id="l114.248" class="difflineminus">-                      mc.a(&quot;expandednewsgroupsBox&quot;, {tagName: &quot;mail-newsgroup&quot;}),</span>
<a href="#l114.249"></a><span id="l114.249" class="difflineminus">-                      &quot;class&quot;, &quot;newsgrouplabel&quot;); },</span>
<a href="#l114.250"></a><span id="l114.250" class="difflineminus">-  expectedName: function(mc, headerValueElement) {</span>
<a href="#l114.251"></a><span id="l114.251" class="difflineminus">-                return mc.e(&quot;expandednewsgroupsLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.252"></a><span id="l114.252" class="difflineminus">-                headerValueElement.parentNode.parentNode.getAttribute(&quot;newsgroup&quot;); },</span>
<a href="#l114.253"></a><span id="l114.253" class="difflineminus">-  expectedRole: Ci.nsIAccessibleRole.ROLE_ENTRY</span>
<a href="#l114.254"></a><span id="l114.254" class="difflineminus">-},</span>
<a href="#l114.255"></a><span id="l114.255" class="difflineminus">-{</span>
<a href="#l114.256"></a><span id="l114.256" class="difflineplus">+  headerValueElement(mc) {</span>
<a href="#l114.257"></a><span id="l114.257" class="difflineplus">+    return mc.window.document.getAnonymousElementByAttribute(</span>
<a href="#l114.258"></a><span id="l114.258" class="difflineplus">+    mc.a(&quot;expandednewsgroupsBox&quot;, {tagName: &quot;mail-newsgroup&quot;}),</span>
<a href="#l114.259"></a><span id="l114.259" class="difflineplus">+    &quot;class&quot;, &quot;newsgrouplabel&quot;);</span>
<a href="#l114.260"></a><span id="l114.260" class="difflineplus">+  },</span>
<a href="#l114.261"></a><span id="l114.261" class="difflineplus">+  expectedName(mc, headerValueElement) {</span>
<a href="#l114.262"></a><span id="l114.262" class="difflineplus">+    return mc.e(&quot;expandednewsgroupsLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.263"></a><span id="l114.263" class="difflineplus">+    headerValueElement.parentNode.parentNode.getAttribute(&quot;newsgroup&quot;);</span>
<a href="#l114.264"></a><span id="l114.264" class="difflineplus">+  },</span>
<a href="#l114.265"></a><span id="l114.265" class="difflineplus">+  expectedRole: Ci.nsIAccessibleRole.ROLE_ENTRY,</span>
<a href="#l114.266"></a><span id="l114.266" class="difflineplus">+}, {</span>
<a href="#l114.267"></a><span id="l114.267">   headerName: &quot;Tags&quot;,</span>
<a href="#l114.268"></a><span id="l114.268" class="difflineminus">-  headerValueElement: function(mc) {</span>
<a href="#l114.269"></a><span id="l114.269" class="difflineminus">-                      return mc.a(&quot;expandedtagsBox&quot;, {class: &quot;tagvalue blc-FF0000&quot;}); },</span>
<a href="#l114.270"></a><span id="l114.270" class="difflineminus">-  expectedName: function(mc, headerValueElement) {</span>
<a href="#l114.271"></a><span id="l114.271" class="difflineminus">-                return mc.e(&quot;expandedtagsLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.272"></a><span id="l114.272" class="difflineminus">-                headerValueElement.getAttribute(&quot;value&quot;); },</span>
<a href="#l114.273"></a><span id="l114.273" class="difflineminus">-  expectedRole: Ci.nsIAccessibleRole.ROLE_LABEL</span>
<a href="#l114.274"></a><span id="l114.274" class="difflineminus">-}</span>
<a href="#l114.275"></a><span id="l114.275" class="difflineminus">-];</span>
<a href="#l114.276"></a><span id="l114.276" class="difflineplus">+  headerValueElement(mc) {</span>
<a href="#l114.277"></a><span id="l114.277" class="difflineplus">+    return mc.a(&quot;expandedtagsBox&quot;, {class: &quot;tagvalue blc-FF0000&quot;});</span>
<a href="#l114.278"></a><span id="l114.278" class="difflineplus">+  },</span>
<a href="#l114.279"></a><span id="l114.279" class="difflineplus">+  expectedName(mc, headerValueElement) {</span>
<a href="#l114.280"></a><span id="l114.280" class="difflineplus">+    return mc.e(&quot;expandedtagsLabel&quot;).value + &quot;: &quot; +</span>
<a href="#l114.281"></a><span id="l114.281" class="difflineplus">+    headerValueElement.getAttribute(&quot;value&quot;);</span>
<a href="#l114.282"></a><span id="l114.282" class="difflineplus">+  },</span>
<a href="#l114.283"></a><span id="l114.283" class="difflineplus">+  expectedRole: Ci.nsIAccessibleRole.ROLE_LABEL,</span>
<a href="#l114.284"></a><span id="l114.284" class="difflineplus">+}];</span>
<a href="#l114.285"></a><span id="l114.285"> </span>
<a href="#l114.286"></a><span id="l114.286"> // used to get the accessible object for a DOM node</span>
<a href="#l114.287"></a><span id="l114.287"> let gAccService = Cc[&quot;@mozilla.org/accessibilityService;1&quot;].</span>
<a href="#l114.288"></a><span id="l114.288">                   getService(Ci.nsIAccessibilityService);</span>
<a href="#l114.289"></a><span id="l114.289"> </span>
<a href="#l114.290"></a><span id="l114.290"> /**</span>
<a href="#l114.291"></a><span id="l114.291">  * Use the information from aHeaderInfo to verify that screenreaders will</span>
<a href="#l114.292"></a><span id="l114.292">  * do the right thing with the given message header.</span>
<a href="#l114.293"></a><span id="l114.293" class="difflineat">@@ -317,18 +331,17 @@ function test_a11y_attrs() {</span>
<a href="#l114.294"></a><span id="l114.294">                                       .findIndexOfMsgHdr(hdr, false));</span>
<a href="#l114.295"></a><span id="l114.295"> </span>
<a href="#l114.296"></a><span id="l114.296">   // make sure it loads</span>
<a href="#l114.297"></a><span id="l114.297">   assert_selected_and_displayed(mc, curMessage);</span>
<a href="#l114.298"></a><span id="l114.298"> </span>
<a href="#l114.299"></a><span id="l114.299">   headersToTest.forEach(verify_header_a11y);</span>
<a href="#l114.300"></a><span id="l114.300"> }</span>
<a href="#l114.301"></a><span id="l114.301"> </span>
<a href="#l114.302"></a><span id="l114.302" class="difflineminus">-function test_more_button_with_many_recipients()</span>
<a href="#l114.303"></a><span id="l114.303" class="difflineminus">-{</span>
<a href="#l114.304"></a><span id="l114.304" class="difflineplus">+function test_more_button_with_many_recipients() {</span>
<a href="#l114.305"></a><span id="l114.305">   // Start on the interesting message.</span>
<a href="#l114.306"></a><span id="l114.306">   let curMessage = select_click_row(0);</span>
<a href="#l114.307"></a><span id="l114.307"> </span>
<a href="#l114.308"></a><span id="l114.308">   // make sure it loads</span>
<a href="#l114.309"></a><span id="l114.309">   wait_for_message_display_completion(mc);</span>
<a href="#l114.310"></a><span id="l114.310">   assert_selected_and_displayed(mc, curMessage);</span>
<a href="#l114.311"></a><span id="l114.311"> </span>
<a href="#l114.312"></a><span id="l114.312">   // Check the mode of the header.</span>
<a href="#l114.313"></a><span id="l114.313" class="difflineat">@@ -337,17 +350,17 @@ function test_more_button_with_many_reci</span>
<a href="#l114.314"></a><span id="l114.314"> </span>
<a href="#l114.315"></a><span id="l114.315">   // Click the &quot;more&quot; button.</span>
<a href="#l114.316"></a><span id="l114.316">   let moreIndicator = mc.window.document.getElementById(&quot;expandedccBox&quot;).more;</span>
<a href="#l114.317"></a><span id="l114.317">   moreIndicator = new elementslib.Elem(moreIndicator);</span>
<a href="#l114.318"></a><span id="l114.318">   mc.click(moreIndicator);</span>
<a href="#l114.319"></a><span id="l114.319"> </span>
<a href="#l114.320"></a><span id="l114.320">   // Check the new mode of the header.</span>
<a href="#l114.321"></a><span id="l114.321">   if (headerBox.node.getAttribute(&quot;show_header_mode&quot;) != &quot;all&quot;)</span>
<a href="#l114.322"></a><span id="l114.322" class="difflineminus">-    throw new Error(&quot;Header Mode didn't change to 'all'!  &quot; + &quot;old=&quot; +</span>
<a href="#l114.323"></a><span id="l114.323" class="difflineplus">+    throw new Error(&quot;Header Mode didn't change to 'all'!  old=&quot; +</span>
<a href="#l114.324"></a><span id="l114.324">                     previousHeaderMode + &quot;, new=&quot; +</span>
<a href="#l114.325"></a><span id="l114.325">                     headerBox.node.getAttribute(&quot;show_header_mode&quot;));</span>
<a href="#l114.326"></a><span id="l114.326"> </span>
<a href="#l114.327"></a><span id="l114.327">   // Switch to the boring message, to force the more button to collapse.</span>
<a href="#l114.328"></a><span id="l114.328">   curMessage = select_click_row(1);</span>
<a href="#l114.329"></a><span id="l114.329"> </span>
<a href="#l114.330"></a><span id="l114.330">   // make sure it loads</span>
<a href="#l114.331"></a><span id="l114.331">   wait_for_message_display_completion(mc);</span>
<a href="#l114.332"></a><span id="l114.332" class="difflineat">@@ -359,39 +372,38 @@ function test_more_button_with_many_reci</span>
<a href="#l114.333"></a><span id="l114.333">                     &quot; to &quot; + headerBox.node.getAttribute(&quot;show_header_mode&quot;) +</span>
<a href="#l114.334"></a><span id="l114.334">                     &quot; and didn't change back.&quot;);</span>
<a href="#l114.335"></a><span id="l114.335"> }</span>
<a href="#l114.336"></a><span id="l114.336"> </span>
<a href="#l114.337"></a><span id="l114.337"> /**</span>
<a href="#l114.338"></a><span id="l114.338">  * Test that we can open up the inline contact editor when we</span>
<a href="#l114.339"></a><span id="l114.339">  * click on the star.</span>
<a href="#l114.340"></a><span id="l114.340">  */</span>
<a href="#l114.341"></a><span id="l114.341" class="difflineminus">-function test_clicking_star_opens_inline_contact_editor()</span>
<a href="#l114.342"></a><span id="l114.342" class="difflineminus">-{</span>
<a href="#l114.343"></a><span id="l114.343" class="difflineplus">+function test_clicking_star_opens_inline_contact_editor() {</span>
<a href="#l114.344"></a><span id="l114.344">   // Make sure we're in the right folder</span>
<a href="#l114.345"></a><span id="l114.345">   be_in_folder(folder);</span>
<a href="#l114.346"></a><span id="l114.346">   // Add a new message</span>
<a href="#l114.347"></a><span id="l114.347">   let msg = create_message();</span>
<a href="#l114.348"></a><span id="l114.348">   add_message_to_folder(folder, msg);</span>
<a href="#l114.349"></a><span id="l114.349">   // Open the latest message</span>
<a href="#l114.350"></a><span id="l114.350" class="difflineminus">-  let curMessage = select_click_row(-1);</span>
<a href="#l114.351"></a><span id="l114.351" class="difflineplus">+  select_click_row(-1);</span>
<a href="#l114.352"></a><span id="l114.352">   wait_for_message_display_completion(mc);</span>
<a href="#l114.353"></a><span id="l114.353">   // Make sure the star is clicked, and we add the</span>
<a href="#l114.354"></a><span id="l114.354">   // new contact to our address book</span>
<a href="#l114.355"></a><span id="l114.355">   let toDescription = mc.window.document.getElementById(&quot;expandedtoBox&quot;).emailAddresses;</span>
<a href="#l114.356"></a><span id="l114.356"> </span>
<a href="#l114.357"></a><span id="l114.357"> </span>
<a href="#l114.358"></a><span id="l114.358">   // Ensure that the inline contact editing panel is not open</span>
<a href="#l114.359"></a><span id="l114.359" class="difflineminus">-  let contactPanel = mc.eid('editContactPanel').getNode();</span>
<a href="#l114.360"></a><span id="l114.360" class="difflineplus">+  let contactPanel = mc.eid(&quot;editContactPanel&quot;).getNode();</span>
<a href="#l114.361"></a><span id="l114.361">   assert_not_equals(contactPanel.state, &quot;open&quot;);</span>
<a href="#l114.362"></a><span id="l114.362">   subtest_more_widget_star_click(toDescription);</span>
<a href="#l114.363"></a><span id="l114.363"> </span>
<a href="#l114.364"></a><span id="l114.364">   // Ok, if we're here, then the star has been clicked, and</span>
<a href="#l114.365"></a><span id="l114.365">   // the contact has been added to our AB.</span>
<a href="#l114.366"></a><span id="l114.366" class="difflineminus">-  let addrs = toDescription.getElementsByTagName('mail-emailaddress');</span>
<a href="#l114.367"></a><span id="l114.367" class="difflineplus">+  let addrs = toDescription.getElementsByTagName(&quot;mail-emailaddress&quot;);</span>
<a href="#l114.368"></a><span id="l114.368">   let lastAddr = get_last_visible_address(addrs);</span>
<a href="#l114.369"></a><span id="l114.369"> </span>
<a href="#l114.370"></a><span id="l114.370">   // Click on the star, and ensure that the inline contact</span>
<a href="#l114.371"></a><span id="l114.371">   // editing panel opens</span>
<a href="#l114.372"></a><span id="l114.372">   mc.click(getElement(lastAddr, &quot;.emailStar&quot;));</span>
<a href="#l114.373"></a><span id="l114.373">   mc.waitFor(() =&gt; contactPanel.state == &quot;open&quot;,</span>
<a href="#l114.374"></a><span id="l114.374">              () =&gt; (&quot;Timeout waiting for contactPanel to open; state=&quot; +</span>
<a href="#l114.375"></a><span id="l114.375">                     contactPanel.state));</span>
<a href="#l114.376"></a><span id="l114.376" class="difflineat">@@ -414,23 +426,23 @@ function assert_shown(id, visible) {</span>
<a href="#l114.377"></a><span id="l114.377">  * Test that clicking references context menu works properly.</span>
<a href="#l114.378"></a><span id="l114.378">  */</span>
<a href="#l114.379"></a><span id="l114.379"> function test_msg_id_context_menu() {</span>
<a href="#l114.380"></a><span id="l114.380">   Services.prefs.setBoolPref(&quot;mailnews.headers.showReferences&quot;, true);</span>
<a href="#l114.381"></a><span id="l114.381"> </span>
<a href="#l114.382"></a><span id="l114.382">   // Add a new message</span>
<a href="#l114.383"></a><span id="l114.383">   let msg = create_message({</span>
<a href="#l114.384"></a><span id="l114.384">     clobberHeaders: {</span>
<a href="#l114.385"></a><span id="l114.385" class="difflineminus">-      &quot;References&quot;: &quot;&lt;4880C986@example.com&gt; &lt;4880CAB2@example.com&gt; &lt;4880CC76@example.com&gt;&quot;</span>
<a href="#l114.386"></a><span id="l114.386" class="difflineplus">+      &quot;References&quot;: &quot;&lt;4880C986@example.com&gt; &lt;4880CAB2@example.com&gt; &lt;4880CC76@example.com&gt;&quot;,</span>
<a href="#l114.387"></a><span id="l114.387">     }});</span>
<a href="#l114.388"></a><span id="l114.388">   add_message_to_folder(folder, msg);</span>
<a href="#l114.389"></a><span id="l114.389">   be_in_folder(folder);</span>
<a href="#l114.390"></a><span id="l114.390"> </span>
<a href="#l114.391"></a><span id="l114.391">   // Open the latest message.</span>
<a href="#l114.392"></a><span id="l114.392" class="difflineminus">-  let curMessage = select_click_row(-1);</span>
<a href="#l114.393"></a><span id="l114.393" class="difflineplus">+  select_click_row(-1);</span>
<a href="#l114.394"></a><span id="l114.394"> </span>
<a href="#l114.395"></a><span id="l114.395">   // Right click to show the context menu.</span>
<a href="#l114.396"></a><span id="l114.396">   mc.rightClick(mc.eid(&quot;expandedreferencesBox&quot;, {tagName: &quot;mail-messageid&quot;}));</span>
<a href="#l114.397"></a><span id="l114.397">   wait_for_popup_to_open(mc.e(&quot;messageIdContext&quot;));</span>
<a href="#l114.398"></a><span id="l114.398"> </span>
<a href="#l114.399"></a><span id="l114.399">   // Ensure Open Message For ID is shown... and that Open Browser With Message-ID</span>
<a href="#l114.400"></a><span id="l114.400">   // isn't shown.</span>
<a href="#l114.401"></a><span id="l114.401">   assert_shown(&quot;messageIdContext-openMessageForMsgId&quot;, true);</span>
<a href="#l114.402"></a><span id="l114.402" class="difflineat">@@ -443,67 +455,66 @@ function test_msg_id_context_menu() {</span>
<a href="#l114.403"></a><span id="l114.403"> </span>
<a href="#l114.404"></a><span id="l114.404"> /**</span>
<a href="#l114.405"></a><span id="l114.405">  * Test that if a contact belongs to a mailing list within their</span>
<a href="#l114.406"></a><span id="l114.406">  * address book, then the inline contact editor will not allow</span>
<a href="#l114.407"></a><span id="l114.407">  * the user to change what address book the contact belongs to.</span>
<a href="#l114.408"></a><span id="l114.408">  * The editor should also show a message to explain why the</span>
<a href="#l114.409"></a><span id="l114.409">  * contact cannot be moved.</span>
<a href="#l114.410"></a><span id="l114.410">  */</span>
<a href="#l114.411"></a><span id="l114.411" class="difflineminus">-function test_address_book_switch_disabled_on_contact_in_mailing_list()</span>
<a href="#l114.412"></a><span id="l114.412" class="difflineminus">-{</span>
<a href="#l114.413"></a><span id="l114.413" class="difflineplus">+function test_address_book_switch_disabled_on_contact_in_mailing_list() {</span>
<a href="#l114.414"></a><span id="l114.414">   const MAILING_LIST_DIRNAME = &quot;Some Mailing List&quot;;</span>
<a href="#l114.415"></a><span id="l114.415">   const ADDRESS_BOOK_NAME = &quot;Some Address Book&quot;;</span>
<a href="#l114.416"></a><span id="l114.416">   // Add a new message</span>
<a href="#l114.417"></a><span id="l114.417">   let msg = create_message();</span>
<a href="#l114.418"></a><span id="l114.418">   add_message_to_folder(folder, msg);</span>
<a href="#l114.419"></a><span id="l114.419"> </span>
<a href="#l114.420"></a><span id="l114.420">   // Make sure we're in the right folder</span>
<a href="#l114.421"></a><span id="l114.421">   be_in_folder(folder);</span>
<a href="#l114.422"></a><span id="l114.422"> </span>
<a href="#l114.423"></a><span id="l114.423">   // Open the latest message</span>
<a href="#l114.424"></a><span id="l114.424" class="difflineminus">-  let curMessage = select_click_row(-1);</span>
<a href="#l114.425"></a><span id="l114.425" class="difflineplus">+  select_click_row(-1);</span>
<a href="#l114.426"></a><span id="l114.426"> </span>
<a href="#l114.427"></a><span id="l114.427">   // Make sure the star is clicked, and we add the</span>
<a href="#l114.428"></a><span id="l114.428">   // new contact to our address book</span>
<a href="#l114.429"></a><span id="l114.429">   let toDescription = mc.window.document.getElementById(&quot;expandedtoBox&quot;).emailAddresses;</span>
<a href="#l114.430"></a><span id="l114.430"> </span>
<a href="#l114.431"></a><span id="l114.431">   // Ensure that the inline contact editing panel is not open</span>
<a href="#l114.432"></a><span id="l114.432" class="difflineminus">-  let contactPanel = mc.eid('editContactPanel').getNode();</span>
<a href="#l114.433"></a><span id="l114.433" class="difflineplus">+  let contactPanel = mc.eid(&quot;editContactPanel&quot;).getNode();</span>
<a href="#l114.434"></a><span id="l114.434">   assert_not_equals(contactPanel.state, &quot;open&quot;);</span>
<a href="#l114.435"></a><span id="l114.435"> </span>
<a href="#l114.436"></a><span id="l114.436">   subtest_more_widget_star_click(toDescription);</span>
<a href="#l114.437"></a><span id="l114.437"> </span>
<a href="#l114.438"></a><span id="l114.438">   // Ok, if we're here, then the star has been clicked, and</span>
<a href="#l114.439"></a><span id="l114.439">   // the contact has been added to our AB.</span>
<a href="#l114.440"></a><span id="l114.440" class="difflineminus">-  let addrs = toDescription.getElementsByTagName('mail-emailaddress');</span>
<a href="#l114.441"></a><span id="l114.441" class="difflineplus">+  let addrs = toDescription.getElementsByTagName(&quot;mail-emailaddress&quot;);</span>
<a href="#l114.442"></a><span id="l114.442">   let lastAddr = get_last_visible_address(addrs);</span>
<a href="#l114.443"></a><span id="l114.443"> </span>
<a href="#l114.444"></a><span id="l114.444">   // Click on the star, and ensure that the inline contact</span>
<a href="#l114.445"></a><span id="l114.445">   // editing panel opens</span>
<a href="#l114.446"></a><span id="l114.446">   mc.click(getElement(lastAddr, &quot;.emailStar&quot;));</span>
<a href="#l114.447"></a><span id="l114.447">   mc.waitFor(() =&gt; contactPanel.state == &quot;open&quot;,</span>
<a href="#l114.448"></a><span id="l114.448">              () =&gt; (&quot;Timeout waiting for contactPanel to open; state=&quot; +</span>
<a href="#l114.449"></a><span id="l114.449">                     contactPanel.state));</span>
<a href="#l114.450"></a><span id="l114.450"> </span>
<a href="#l114.451"></a><span id="l114.451" class="difflineminus">-  let abDrop = mc.eid('editContactAddressBookList').getNode();</span>
<a href="#l114.452"></a><span id="l114.452" class="difflineminus">-  let warningMsg = mc.eid('contactMoveDisabledText').getNode();</span>
<a href="#l114.453"></a><span id="l114.453" class="difflineplus">+  let abDrop = mc.eid(&quot;editContactAddressBookList&quot;).getNode();</span>
<a href="#l114.454"></a><span id="l114.454" class="difflineplus">+  let warningMsg = mc.eid(&quot;contactMoveDisabledText&quot;).getNode();</span>
<a href="#l114.455"></a><span id="l114.455"> </span>
<a href="#l114.456"></a><span id="l114.456">   // Ensure that the address book dropdown is not disabled</span>
<a href="#l114.457"></a><span id="l114.457">   assert_true(!abDrop.disabled);</span>
<a href="#l114.458"></a><span id="l114.458">   // We should not be displaying any warning</span>
<a href="#l114.459"></a><span id="l114.459">   assert_true(warningMsg.collapsed);</span>
<a href="#l114.460"></a><span id="l114.460"> </span>
<a href="#l114.461"></a><span id="l114.461">   // Now close the popup</span>
<a href="#l114.462"></a><span id="l114.462">   contactPanel.hidePopup();</span>
<a href="#l114.463"></a><span id="l114.463"> </span>
<a href="#l114.464"></a><span id="l114.464">   // For the contact that was added, create a mailing list in the</span>
<a href="#l114.465"></a><span id="l114.465">   // address book it resides in, and then add that contact to the</span>
<a href="#l114.466"></a><span id="l114.466">   // mailing list</span>
<a href="#l114.467"></a><span id="l114.467" class="difflineminus">-  addrs = toDescription.getElementsByTagName('mail-emailaddress');</span>
<a href="#l114.468"></a><span id="l114.468" class="difflineplus">+  addrs = toDescription.getElementsByTagName(&quot;mail-emailaddress&quot;);</span>
<a href="#l114.469"></a><span id="l114.469">   let targetAddr = get_last_visible_address(addrs).getAttribute(&quot;emailAddress&quot;);</span>
<a href="#l114.470"></a><span id="l114.470"> </span>
<a href="#l114.471"></a><span id="l114.471">   let cards = get_cards_in_all_address_books_for_email(targetAddr);</span>
<a href="#l114.472"></a><span id="l114.472"> </span>
<a href="#l114.473"></a><span id="l114.473">   // There should be only one copy of this email address</span>
<a href="#l114.474"></a><span id="l114.474">   // in the address books.</span>
<a href="#l114.475"></a><span id="l114.475">   assert_equals(cards.length, 1);</span>
<a href="#l114.476"></a><span id="l114.476">   let card = cards[0];</span>
<a href="#l114.477"></a><span id="l114.477" class="difflineat">@@ -614,17 +625,17 @@ function test_that_msg_without_date_clea</span>
<a href="#l114.478"></a><span id="l114.478">   wait_for_message_display_completion(mc);</span>
<a href="#l114.479"></a><span id="l114.479">   assert_selected_and_displayed(mc, curMessage);</span>
<a href="#l114.480"></a><span id="l114.480"> </span>
<a href="#l114.481"></a><span id="l114.481">   // Since we didn't give create_message an argument that would create a</span>
<a href="#l114.482"></a><span id="l114.482">   // Newsgroups header, the newsgroups &lt;row&gt; element should be collapsed.</span>
<a href="#l114.483"></a><span id="l114.483">   // However, since the previously displayed message _did_ have such a header,</span>
<a href="#l114.484"></a><span id="l114.484">   // certain bugs in the display of this header could cause the collapse</span>
<a href="#l114.485"></a><span id="l114.485">   // never to have happened.</span>
<a href="#l114.486"></a><span id="l114.486" class="difflineminus">-  if (mc.e(&quot;expandednewsgroupsRow&quot;).collapsed != true) {</span>
<a href="#l114.487"></a><span id="l114.487" class="difflineplus">+  if (!mc.e(&quot;expandednewsgroupsRow&quot;).collapsed) {</span>
<a href="#l114.488"></a><span id="l114.488">     throw new Error(&quot;Expected &lt;row&gt; element for Newsgroups header to be &quot; +</span>
<a href="#l114.489"></a><span id="l114.489">                     &quot;collapsed, but it wasn't\n!&quot;);</span>
<a href="#l114.490"></a><span id="l114.490">   }</span>
<a href="#l114.491"></a><span id="l114.491"> }</span>
<a href="#l114.492"></a><span id="l114.492"> </span>
<a href="#l114.493"></a><span id="l114.493"> /**</span>
<a href="#l114.494"></a><span id="l114.494">  * Test various aspects of the (n more) widgetry.</span>
<a href="#l114.495"></a><span id="l114.495">  */</span>
<a href="#l114.496"></a><span id="l114.496" class="difflineat">@@ -720,34 +731,34 @@ function change_to_all_header_mode() {</span>
<a href="#l114.497"></a><span id="l114.497"> }</span>
<a href="#l114.498"></a><span id="l114.498"> </span>
<a href="#l114.499"></a><span id="l114.499"> /**</span>
<a href="#l114.500"></a><span id="l114.500">  * Get the number of lines in one of the multi-address fields</span>
<a href="#l114.501"></a><span id="l114.501">  * @param node the description element containing the addresses</span>
<a href="#l114.502"></a><span id="l114.502">  * @return the number of lines</span>
<a href="#l114.503"></a><span id="l114.503">  */</span>
<a href="#l114.504"></a><span id="l114.504"> function help_get_num_lines(node) {</span>
<a href="#l114.505"></a><span id="l114.505" class="difflineminus">-  let style = mc.window.getComputedStyle(node, null);</span>
<a href="#l114.506"></a><span id="l114.506" class="difflineplus">+  let style = mc.window.getComputedStyle(node);</span>
<a href="#l114.507"></a><span id="l114.507">   return style.height / style.lineHeight;</span>
<a href="#l114.508"></a><span id="l114.508"> }</span>
<a href="#l114.509"></a><span id="l114.509"> </span>
<a href="#l114.510"></a><span id="l114.510"> /**</span>
<a href="#l114.511"></a><span id="l114.511">  * Test that the &quot;more&quot; widget displays when it should.</span>
<a href="#l114.512"></a><span id="l114.512">  * @param toDescription the description node for the &quot;to&quot; field</span>
<a href="#l114.513"></a><span id="l114.513">  */</span>
<a href="#l114.514"></a><span id="l114.514"> function subtest_more_widget_display(toDescription) {</span>
<a href="#l114.515"></a><span id="l114.515">   // test that the to element doesn't have more than max lines</span>
<a href="#l114.516"></a><span id="l114.516">   let numLines = help_get_num_lines(toDescription);</span>
<a href="#l114.517"></a><span id="l114.517"> </span>
<a href="#l114.518"></a><span id="l114.518">   // get maxline pref</span>
<a href="#l114.519"></a><span id="l114.519">   let maxLines = Services.prefs.getIntPref(</span>
<a href="#l114.520"></a><span id="l114.520">     &quot;mailnews.headers.show_n_lines_before_more&quot;);</span>
<a href="#l114.521"></a><span id="l114.521"> </span>
<a href="#l114.522"></a><span id="l114.522">   // allow for a 15% tolerance for any padding that may be applied</span>
<a href="#l114.523"></a><span id="l114.523" class="difflineminus">-  if (numLines &lt; 0.85*maxLines || numLines &gt; 1.15*maxLines) {</span>
<a href="#l114.524"></a><span id="l114.524" class="difflineplus">+  if (numLines &lt; 0.85 * maxLines || numLines &gt; 1.15 * maxLines) {</span>
<a href="#l114.525"></a><span id="l114.525">     throw new Error(&quot;expected == &quot; + maxLines + &quot;lines; found &quot; + numLines);</span>
<a href="#l114.526"></a><span id="l114.526">   }</span>
<a href="#l114.527"></a><span id="l114.527"> </span>
<a href="#l114.528"></a><span id="l114.528">   // test that we've got a (more) node and that it's expanded</span>
<a href="#l114.529"></a><span id="l114.529">   let moreNode = mc.window.document.getElementById(&quot;expandedtoBox&quot;).more;</span>
<a href="#l114.530"></a><span id="l114.530">   if (!moreNode) {</span>
<a href="#l114.531"></a><span id="l114.531">     throw new Error(&quot;more node not found before activation&quot;);</span>
<a href="#l114.532"></a><span id="l114.532">   }</span>
<a href="#l114.533"></a><span id="l114.533" class="difflineat">@@ -803,54 +814,50 @@ function subtest_change_to_all_header_mo</span>
<a href="#l114.534"></a><span id="l114.534">   }</span>
<a href="#l114.535"></a><span id="l114.535"> }</span>
<a href="#l114.536"></a><span id="l114.536"> </span>
<a href="#l114.537"></a><span id="l114.537"> /**</span>
<a href="#l114.538"></a><span id="l114.538">  * Test that clicking the star updates the UI properly (see bug 563612).</span>
<a href="#l114.539"></a><span id="l114.539">  * @param toDescription the description node for the &quot;to&quot; field</span>
<a href="#l114.540"></a><span id="l114.540">  */</span>
<a href="#l114.541"></a><span id="l114.541"> function subtest_more_widget_star_click(toDescription) {</span>
<a href="#l114.542"></a><span id="l114.542" class="difflineminus">-  let addrs = toDescription.getElementsByTagName('mail-emailaddress');</span>
<a href="#l114.543"></a><span id="l114.543" class="difflineplus">+  let addrs = toDescription.getElementsByTagName(&quot;mail-emailaddress&quot;);</span>
<a href="#l114.544"></a><span id="l114.544">   let lastAddr = get_last_visible_address(addrs);</span>
<a href="#l114.545"></a><span id="l114.545">   ensure_no_card_exists(lastAddr.getAttribute(&quot;emailAddress&quot;));</span>
<a href="#l114.546"></a><span id="l114.546"> </span>
<a href="#l114.547"></a><span id="l114.547">   // scroll to the bottom first so the address is in view</span>
<a href="#l114.548"></a><span id="l114.548" class="difflineminus">-  let view = mc.e('expandedHeaderView');</span>
<a href="#l114.549"></a><span id="l114.549" class="difflineplus">+  let view = mc.e(&quot;expandedHeaderView&quot;);</span>
<a href="#l114.550"></a><span id="l114.550">   view.scrollTop = view.scrollHeight - view.clientHeight;</span>
<a href="#l114.551"></a><span id="l114.551"> </span>
<a href="#l114.552"></a><span id="l114.552">   mc.click(getElement(lastAddr, &quot;.emailStar&quot;));</span>
<a href="#l114.553"></a><span id="l114.553" class="difflineminus">-  if (lastAddr.getAttribute('hascard') == 'false') {</span>
<a href="#l114.554"></a><span id="l114.554" class="difflineplus">+  if (lastAddr.getAttribute(&quot;hascard&quot;) == &quot;false&quot;) {</span>
<a href="#l114.555"></a><span id="l114.555">     throw new Error(&quot;address not updated after clicking star&quot;);</span>
<a href="#l114.556"></a><span id="l114.556">   }</span>
<a href="#l114.557"></a><span id="l114.557"> }</span>
<a href="#l114.558"></a><span id="l114.558"> </span>
<a href="#l114.559"></a><span id="l114.559"> /**</span>
<a href="#l114.560"></a><span id="l114.560">  * Make sure the (more) widget hidden pref actually works with a</span>
<a href="#l114.561"></a><span id="l114.561">  * non-default value.</span>
<a href="#l114.562"></a><span id="l114.562">  */</span>
<a href="#l114.563"></a><span id="l114.563" class="difflineminus">-function test_more_widget_with_maxlines_of_3(){</span>
<a href="#l114.564"></a><span id="l114.564" class="difflineminus">-</span>
<a href="#l114.565"></a><span id="l114.565" class="difflineplus">+function test_more_widget_with_maxlines_of_3() {</span>
<a href="#l114.566"></a><span id="l114.566">   // set maxLines to 3</span>
<a href="#l114.567"></a><span id="l114.567" class="difflineminus">-  let maxLines = Services.prefs.setIntPref(</span>
<a href="#l114.568"></a><span id="l114.568" class="difflineminus">-    &quot;mailnews.headers.show_n_lines_before_more&quot;, 3);</span>
<a href="#l114.569"></a><span id="l114.569" class="difflineplus">+  Services.prefs.setIntPref(&quot;mailnews.headers.show_n_lines_before_more&quot;, 3);</span>
<a href="#l114.570"></a><span id="l114.570"> </span>
<a href="#l114.571"></a><span id="l114.571">   // call test_more_widget again</span>
<a href="#l114.572"></a><span id="l114.572">   // We need to look at the second last article in the display list.</span>
<a href="#l114.573"></a><span id="l114.573">   test_more_widget();</span>
<a href="#l114.574"></a><span id="l114.574"> }</span>
<a href="#l114.575"></a><span id="l114.575"> </span>
<a href="#l114.576"></a><span id="l114.576"> /**</span>
<a href="#l114.577"></a><span id="l114.577">  * Make sure the (more) widget hidden pref also works with an</span>
<a href="#l114.578"></a><span id="l114.578">  * &quot;all&quot; (0) non-default value.</span>
<a href="#l114.579"></a><span id="l114.579">  */</span>
<a href="#l114.580"></a><span id="l114.580" class="difflineminus">-function test_more_widget_with_disabled_more(){</span>
<a href="#l114.581"></a><span id="l114.581" class="difflineminus">-</span>
<a href="#l114.582"></a><span id="l114.582" class="difflineplus">+function test_more_widget_with_disabled_more() {</span>
<a href="#l114.583"></a><span id="l114.583">   // set maxLines to 0</span>
<a href="#l114.584"></a><span id="l114.584" class="difflineminus">-  let maxLines = Services.prefs.setIntPref(</span>
<a href="#l114.585"></a><span id="l114.585" class="difflineminus">-    &quot;mailnews.headers.show_n_lines_before_more&quot;, 0);</span>
<a href="#l114.586"></a><span id="l114.586" class="difflineplus">+  Services.prefs.setIntPref(&quot;mailnews.headers.show_n_lines_before_more&quot;, 0);</span>
<a href="#l114.587"></a><span id="l114.587"> </span>
<a href="#l114.588"></a><span id="l114.588">   // generate message with 35 recips (effectively guarantees overflow for n=3)</span>
<a href="#l114.589"></a><span id="l114.589">   be_in_folder(folder);</span>
<a href="#l114.590"></a><span id="l114.590">   let msg = create_message({toCount: 35});</span>
<a href="#l114.591"></a><span id="l114.591"> </span>
<a href="#l114.592"></a><span id="l114.592">   // add the message to the end of the folder</span>
<a href="#l114.593"></a><span id="l114.593">   add_message_to_folder(folder, msg);</span>
<a href="#l114.594"></a><span id="l114.594"> </span>
<a href="#l114.595"></a><span id="l114.595" class="difflineat">@@ -881,38 +888,35 @@ function test_more_widget_with_disabled_</span>
<a href="#l114.596"></a><span id="l114.596"> /**</span>
<a href="#l114.597"></a><span id="l114.597">  * When the window gets too narrow the toolbar should float above the From</span>
<a href="#l114.598"></a><span id="l114.598">  *  line.  Then they need to return back to the right when we get large</span>
<a href="#l114.599"></a><span id="l114.599">  *  enough again.</span>
<a href="#l114.600"></a><span id="l114.600">  */</span>
<a href="#l114.601"></a><span id="l114.601"> function test_toolbar_collapse_and_expand() {</span>
<a href="#l114.602"></a><span id="l114.602">   be_in_folder(folder);</span>
<a href="#l114.603"></a><span id="l114.603">   // Select and open a message, in this case the last, for no particular reason.</span>
<a href="#l114.604"></a><span id="l114.604" class="difflineminus">-  let curMessage = select_click_row(-1);</span>
<a href="#l114.605"></a><span id="l114.605" class="difflineplus">+  select_click_row(-1);</span>
<a href="#l114.606"></a><span id="l114.606"> </span>
<a href="#l114.607"></a><span id="l114.607">   try {</span>
<a href="#l114.608"></a><span id="l114.608">     let expandedHeadersTopBox = mc.e(&quot;expandedHeadersTopBox&quot;);</span>
<a href="#l114.609"></a><span id="l114.609" class="difflineminus">-    let toolbar = mc.e(&quot;header-view-toolbar&quot;);</span>
<a href="#l114.610"></a><span id="l114.610" class="difflineminus">-    let mode = toolbar.getAttribute(&quot;mode&quot;);</span>
<a href="#l114.611"></a><span id="l114.611"> </span>
<a href="#l114.612"></a><span id="l114.612">     resize_to(mc, 1200, gDefaultWindowHeight);</span>
<a href="#l114.613"></a><span id="l114.613">     let shortHeight = expandedHeadersTopBox.clientHeight;</span>
<a href="#l114.614"></a><span id="l114.614"> </span>
<a href="#l114.615"></a><span id="l114.615">     resize_to(mc, 600, gDefaultWindowHeight);</span>
<a href="#l114.616"></a><span id="l114.616">     let tallHeight = expandedHeadersTopBox.clientHeight;</span>
<a href="#l114.617"></a><span id="l114.617"> </span>
<a href="#l114.618"></a><span id="l114.618">     if (shortHeight &gt;= tallHeight)</span>
<a href="#l114.619"></a><span id="l114.619">       throw new Error(&quot;The header box should have been made smaller!&quot;);</span>
<a href="#l114.620"></a><span id="l114.620"> </span>
<a href="#l114.621"></a><span id="l114.621">     // And make our window big to achieve the same effect as the just icons mode.</span>
<a href="#l114.622"></a><span id="l114.622">     resize_to(mc, 1200, gDefaultWindowHeight);</span>
<a href="#l114.623"></a><span id="l114.623">     mc.waitFor(() =&gt; expandedHeadersTopBox.clientHeight == shortHeight,</span>
<a href="#l114.624"></a><span id="l114.624" class="difflineminus">-               &quot;The header box should have returned to its wide size!&quot;)</span>
<a href="#l114.625"></a><span id="l114.625" class="difflineminus">-  }</span>
<a href="#l114.626"></a><span id="l114.626" class="difflineminus">-  finally {</span>
<a href="#l114.627"></a><span id="l114.627" class="difflineplus">+               &quot;The header box should have returned to its wide size!&quot;);</span>
<a href="#l114.628"></a><span id="l114.628" class="difflineplus">+  } finally {</span>
<a href="#l114.629"></a><span id="l114.629">     // restore window to nominal dimensions</span>
<a href="#l114.630"></a><span id="l114.630">     restore_default_window_size();</span>
<a href="#l114.631"></a><span id="l114.631">   }</span>
<a href="#l114.632"></a><span id="l114.632"> }</span>
<a href="#l114.633"></a><span id="l114.633"> </span>
<a href="#l114.634"></a><span id="l114.634"> /**</span>
<a href="#l114.635"></a><span id="l114.635">  * Test if the tooltip text of the more widget contains the correct addresses</span>
<a href="#l114.636"></a><span id="l114.636">  * not shown in the header and the number of addresses also hidden in the</span>
<a href="#l114.637"></a><span id="l114.637" class="difflineat">@@ -953,17 +957,17 @@ function subtest_more_button_tooltip(aMs</span>
<a href="#l114.638"></a><span id="l114.638"> /**</span>
<a href="#l114.639"></a><span id="l114.639">  * Return the number of addresses visible in headerBox.</span>
<a href="#l114.640"></a><span id="l114.640">  * @param aHeaderBox the id of the header box element for which to look for</span>
<a href="#l114.641"></a><span id="l114.641">  *                   visible addresses</span>
<a href="#l114.642"></a><span id="l114.642">  * @return           the number of visible addresses in the header box</span>
<a href="#l114.643"></a><span id="l114.643">  */</span>
<a href="#l114.644"></a><span id="l114.644"> function get_number_of_addresses_in_header(aHeaderBox) {</span>
<a href="#l114.645"></a><span id="l114.645">   let headerBoxElement = mc.e(aHeaderBox, {class: &quot;headerValue&quot;});</span>
<a href="#l114.646"></a><span id="l114.646" class="difflineminus">-  let addrs = headerBoxElement.getElementsByTagName('mail-emailaddress');</span>
<a href="#l114.647"></a><span id="l114.647" class="difflineplus">+  let addrs = headerBoxElement.getElementsByTagName(&quot;mail-emailaddress&quot;);</span>
<a href="#l114.648"></a><span id="l114.648">   let addrNum = 0;</span>
<a href="#l114.649"></a><span id="l114.649">   for (let i = 0; i &lt; addrs.length; i++) {</span>
<a href="#l114.650"></a><span id="l114.650">     // check that the address is really visible and not just a cached</span>
<a href="#l114.651"></a><span id="l114.651">     // element</span>
<a href="#l114.652"></a><span id="l114.652">     if (element_visible_recursive(addrs[i]))</span>
<a href="#l114.653"></a><span id="l114.653">       addrNum += 1;</span>
<a href="#l114.654"></a><span id="l114.654">   }</span>
<a href="#l114.655"></a><span id="l114.655">   return addrNum;</span>
<a href="#l114.656"></a><span id="l114.656" class="difflineat">@@ -977,17 +981,17 @@ function get_number_of_addresses_in_head</span>
<a href="#l114.657"></a><span id="l114.657">  */</span>
<a href="#l114.658"></a><span id="l114.658"> function get_number_of_more_button(aHeaderBox) {</span>
<a href="#l114.659"></a><span id="l114.659">   let moreNumber = 0;</span>
<a href="#l114.660"></a><span id="l114.660">   let headerBoxElement = mc.e(aHeaderBox);</span>
<a href="#l114.661"></a><span id="l114.661">   let moreIndicator = headerBoxElement.more;</span>
<a href="#l114.662"></a><span id="l114.662">   if (element_visible_recursive(moreIndicator)) {</span>
<a href="#l114.663"></a><span id="l114.663">     let moreText = moreIndicator.getAttribute(&quot;value&quot;);</span>
<a href="#l114.664"></a><span id="l114.664">     let moreSplit = moreText.split(&quot; &quot;);</span>
<a href="#l114.665"></a><span id="l114.665" class="difflineminus">-    moreNumber = parseInt(moreSplit[0])</span>
<a href="#l114.666"></a><span id="l114.666" class="difflineplus">+    moreNumber = parseInt(moreSplit[0]);</span>
<a href="#l114.667"></a><span id="l114.667">   }</span>
<a href="#l114.668"></a><span id="l114.668">   return moreNumber;</span>
<a href="#l114.669"></a><span id="l114.669"> }</span>
<a href="#l114.670"></a><span id="l114.670"> </span>
<a href="#l114.671"></a><span id="l114.671"> /**</span>
<a href="#l114.672"></a><span id="l114.672">  * Check if hidden addresses are part of more tooltip text.</span>
<a href="#l114.673"></a><span id="l114.673">  * @param aRecipients     an array containing the addresses to look for in the</span>
<a href="#l114.674"></a><span id="l114.674">  *                        header or the tooltip text</span>
<a href="#l114.675"></a><span id="l114.675" class="difflineat">@@ -1014,18 +1018,17 @@ function subtest_addresses_in_tooltip_te</span>
<a href="#l114.676"></a><span id="l114.676">   for (let i = aShownAddrsNum; (i &lt; numAddresses) &amp;&amp;</span>
<a href="#l114.677"></a><span id="l114.677">                                (i &lt; maxTooltipAddrsNum + aShownAddrsNum); i++) {</span>
<a href="#l114.678"></a><span id="l114.678">     assert_true(tooltipText.includes(fullNames.value[i]), fullNames.value[i]);</span>
<a href="#l114.679"></a><span id="l114.679">     addrsNumInTooltip += 1;</span>
<a href="#l114.680"></a><span id="l114.680">   }</span>
<a href="#l114.681"></a><span id="l114.681"> </span>
<a href="#l114.682"></a><span id="l114.682">   if (aHiddenAddrsNum &lt; maxTooltipAddrsNum) {</span>
<a href="#l114.683"></a><span id="l114.683">     assert_equals(aHiddenAddrsNum, addrsNumInTooltip);</span>
<a href="#l114.684"></a><span id="l114.684" class="difflineminus">-  }</span>
<a href="#l114.685"></a><span id="l114.685" class="difflineminus">-  else {</span>
<a href="#l114.686"></a><span id="l114.686" class="difflineplus">+  } else {</span>
<a href="#l114.687"></a><span id="l114.687">     assert_equals(maxTooltipAddrsNum, addrsNumInTooltip);</span>
<a href="#l114.688"></a><span id="l114.688">     // check if &quot;, and X more&quot; shows the correct number</span>
<a href="#l114.689"></a><span id="l114.689">     let moreTooltipSplit = tooltipText.split(&quot;, &quot;);</span>
<a href="#l114.690"></a><span id="l114.690">     let words = mc.window.document</span>
<a href="#l114.691"></a><span id="l114.691">                          .getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l114.692"></a><span id="l114.692">                          .getString(&quot;headerMoreAddrsTooltip&quot;);</span>
<a href="#l114.693"></a><span id="l114.693">     let remainingAddresses = numAddresses - aShownAddrsNum - maxTooltipAddrsNum;</span>
<a href="#l114.694"></a><span id="l114.694">     let moreForm = mc.window.PluralForm.get(remainingAddresses, words)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l115.1"></a><span id="l115.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-phishing-bar.js</span>
<a href="#l115.2"></a><span id="l115.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-phishing-bar.js</span>
<a href="#l115.3"></a><span id="l115.3" class="difflineat">@@ -1,63 +1,63 @@</span>
<a href="#l115.4"></a><span id="l115.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l115.5"></a><span id="l115.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l115.6"></a><span id="l115.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l115.7"></a><span id="l115.7"> </span>
<a href="#l115.8"></a><span id="l115.8"> /**</span>
<a href="#l115.9"></a><span id="l115.9">  * Test that phishing notifications behave properly.</span>
<a href="#l115.10"></a><span id="l115.10">  */</span>
<a href="#l115.11"></a><span id="l115.11"> </span>
<a href="#l115.12"></a><span id="l115.12" class="difflineminus">-// make SOLO_TEST=message-header/test-phishing-bar.js mozmill-one</span>
<a href="#l115.13"></a><span id="l115.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l115.14"></a><span id="l115.14"> </span>
<a href="#l115.15"></a><span id="l115.15" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l115.16"></a><span id="l115.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l115.17"></a><span id="l115.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-notificationbox-helpers.js */</span>
<a href="#l115.18"></a><span id="l115.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l115.19"></a><span id="l115.19"> </span>
<a href="#l115.20"></a><span id="l115.20"> var MODULE_NAME = &quot;test-phishing-bar&quot;;</span>
<a href="#l115.21"></a><span id="l115.21" class="difflineminus">-</span>
<a href="#l115.22"></a><span id="l115.22"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l115.23"></a><span id="l115.23" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l115.24"></a><span id="l115.24" class="difflineminus">-                         &quot;window-helpers&quot;, &quot;notificationbox-helpers&quot;];</span>
<a href="#l115.25"></a><span id="l115.25" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;notificationbox-helpers&quot;];</span>
<a href="#l115.26"></a><span id="l115.26"> </span>
<a href="#l115.27"></a><span id="l115.27"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l115.28"></a><span id="l115.28"> </span>
<a href="#l115.29"></a><span id="l115.29"> var folder;</span>
<a href="#l115.30"></a><span id="l115.30"> </span>
<a href="#l115.31"></a><span id="l115.31"> var kBoxId = &quot;mail-notification-top&quot;;</span>
<a href="#l115.32"></a><span id="l115.32"> var kNotificationValue = &quot;maybeScam&quot;;</span>
<a href="#l115.33"></a><span id="l115.33"> </span>
<a href="#l115.34"></a><span id="l115.34"> function setupModule(module) {</span>
<a href="#l115.35"></a><span id="l115.35">   for (let dep of MODULE_REQUIRES) {</span>
<a href="#l115.36"></a><span id="l115.36">     collector.getModule(dep).installInto(module);</span>
<a href="#l115.37"></a><span id="l115.37">   }</span>
<a href="#l115.38"></a><span id="l115.38"> </span>
<a href="#l115.39"></a><span id="l115.39">   folder = create_folder(&quot;PhishingBarA&quot;);</span>
<a href="#l115.40"></a><span id="l115.40">   add_message_to_folder(folder, create_message({body: {</span>
<a href="#l115.41"></a><span id="l115.41">     body: '&lt;form action=&quot;http://localhost/download-me&quot;&gt;&lt;input&gt;&lt;/form&gt;.',</span>
<a href="#l115.42"></a><span id="l115.42" class="difflineminus">-    contentType: &quot;text/html&quot;</span>
<a href="#l115.43"></a><span id="l115.43" class="difflineplus">+    contentType: &quot;text/html&quot;,</span>
<a href="#l115.44"></a><span id="l115.44">   }}));</span>
<a href="#l115.45"></a><span id="l115.45">   add_message_to_folder(folder, create_message());</span>
<a href="#l115.46"></a><span id="l115.46">   add_message_to_folder(folder, create_message({body: {</span>
<a href="#l115.47"></a><span id="l115.47" class="difflineminus">-    body: 'check out http://130.128.4.1. and http://130.128.4.2/.',</span>
<a href="#l115.48"></a><span id="l115.48" class="difflineminus">-    contentType: &quot;text/plain&quot;</span>
<a href="#l115.49"></a><span id="l115.49" class="difflineplus">+    body: &quot;check out http://130.128.4.1. and http://130.128.4.2/.&quot;,</span>
<a href="#l115.50"></a><span id="l115.50" class="difflineplus">+    contentType: &quot;text/plain&quot;,</span>
<a href="#l115.51"></a><span id="l115.51">   }}));</span>
<a href="#l115.52"></a><span id="l115.52">   add_message_to_folder(folder, create_message({body: {</span>
<a href="#l115.53"></a><span id="l115.53">     body: '&lt;a href=&quot;http://subdomain.google.com/&quot;&gt;http://www.google.com&lt;/a&gt;.',</span>
<a href="#l115.54"></a><span id="l115.54" class="difflineminus">-    contentType: &quot;text/html&quot;</span>
<a href="#l115.55"></a><span id="l115.55" class="difflineplus">+    contentType: &quot;text/html&quot;,</span>
<a href="#l115.56"></a><span id="l115.56">   }}));</span>
<a href="#l115.57"></a><span id="l115.57">   add_message_to_folder(folder, create_message({body: {</span>
<a href="#l115.58"></a><span id="l115.58">     body: '&lt;a href=&quot;http://subdomain.google.com/&quot;&gt;http://google.com&lt;/a&gt;.',</span>
<a href="#l115.59"></a><span id="l115.59" class="difflineminus">-    contentType: &quot;text/html&quot;</span>
<a href="#l115.60"></a><span id="l115.60" class="difflineplus">+    contentType: &quot;text/html&quot;,</span>
<a href="#l115.61"></a><span id="l115.61">   }}));</span>
<a href="#l115.62"></a><span id="l115.62">   add_message_to_folder(folder, create_message({body: {</span>
<a href="#l115.63"></a><span id="l115.63">     body: '&lt;a href=&quot;http://evilhost&quot;&gt;http://localhost&lt;/a&gt;.',</span>
<a href="#l115.64"></a><span id="l115.64" class="difflineminus">-    contentType: &quot;text/html&quot;</span>
<a href="#l115.65"></a><span id="l115.65" class="difflineplus">+    contentType: &quot;text/html&quot;,</span>
<a href="#l115.66"></a><span id="l115.66">   }}));</span>
<a href="#l115.67"></a><span id="l115.67">   add_message_to_folder(folder, create_message({body: {</span>
<a href="#l115.68"></a><span id="l115.68">     body: '&lt;form action=&quot;http://localhost/download-me&quot;&gt;&lt;input&gt;&lt;/form&gt;.',</span>
<a href="#l115.69"></a><span id="l115.69" class="difflineminus">-    contentType: &quot;text/html&quot;</span>
<a href="#l115.70"></a><span id="l115.70" class="difflineplus">+    contentType: &quot;text/html&quot;,</span>
<a href="#l115.71"></a><span id="l115.71">   }}));</span>
<a href="#l115.72"></a><span id="l115.72"> }</span>
<a href="#l115.73"></a><span id="l115.73"> </span>
<a href="#l115.74"></a><span id="l115.74"> /**</span>
<a href="#l115.75"></a><span id="l115.75">  * Make sure the notification shows, and goes away once the Ignore menuitem</span>
<a href="#l115.76"></a><span id="l115.76">  * is clicked.</span>
<a href="#l115.77"></a><span id="l115.77">  */</span>
<a href="#l115.78"></a><span id="l115.78"> function assert_ignore_works(aController) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l116.1"></a><span id="l116.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-reply-identity.js</span>
<a href="#l116.2"></a><span id="l116.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-reply-identity.js</span>
<a href="#l116.3"></a><span id="l116.3" class="difflineat">@@ -1,25 +1,25 @@</span>
<a href="#l116.4"></a><span id="l116.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l116.5"></a><span id="l116.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l116.6"></a><span id="l116.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l116.7"></a><span id="l116.7"> </span>
<a href="#l116.8"></a><span id="l116.8"> /**</span>
<a href="#l116.9"></a><span id="l116.9">  * Tests that actions such as replying choses the most suitable identity.</span>
<a href="#l116.10"></a><span id="l116.10">  */</span>
<a href="#l116.11"></a><span id="l116.11"> </span>
<a href="#l116.12"></a><span id="l116.12" class="difflineminus">-// make SOLO_TEST=message-header/test-reply-identity.js mozmill-one</span>
<a href="#l116.13"></a><span id="l116.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l116.14"></a><span id="l116.14"> </span>
<a href="#l116.15"></a><span id="l116.15" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l116.16"></a><span id="l116.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l116.17"></a><span id="l116.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l116.18"></a><span id="l116.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l116.19"></a><span id="l116.19"> </span>
<a href="#l116.20"></a><span id="l116.20"> var MODULE_NAME = &quot;test-reply-identity&quot;;</span>
<a href="#l116.21"></a><span id="l116.21" class="difflineminus">-</span>
<a href="#l116.22"></a><span id="l116.22"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l116.23"></a><span id="l116.23" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l116.24"></a><span id="l116.24" class="difflineminus">-                         &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l116.25"></a><span id="l116.25" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l116.26"></a><span id="l116.26"> </span>
<a href="#l116.27"></a><span id="l116.27"> var testFolder = null;</span>
<a href="#l116.28"></a><span id="l116.28"> </span>
<a href="#l116.29"></a><span id="l116.29"> var identity1Email = &quot;carl@example.com&quot;;</span>
<a href="#l116.30"></a><span id="l116.30"> var identity2Email = &quot;lenny@springfield.invalid&quot;;</span>
<a href="#l116.31"></a><span id="l116.31"> </span>
<a href="#l116.32"></a><span id="l116.32"> function setupModule(module) {</span>
<a href="#l116.33"></a><span id="l116.33">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l116.34"></a><span id="l116.34" class="difflineat">@@ -29,61 +29,61 @@ function setupModule(module) {</span>
<a href="#l116.35"></a><span id="l116.35">   addIdentitiesAndFolder();</span>
<a href="#l116.36"></a><span id="l116.36">   // Msg #0</span>
<a href="#l116.37"></a><span id="l116.37">   add_message_to_folder(testFolder, create_message({</span>
<a href="#l116.38"></a><span id="l116.38">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l116.39"></a><span id="l116.39">     to: &quot;workers@springfield.invalid&quot;,</span>
<a href="#l116.40"></a><span id="l116.40">     subject: &quot;no matching identity, like bcc/list&quot;,</span>
<a href="#l116.41"></a><span id="l116.41">     body: {body: &quot;Alcohol is a way of life, alcohol is my way of life, and I aim to keep it.&quot;},</span>
<a href="#l116.42"></a><span id="l116.42">     clobberHeaders: {</span>
<a href="#l116.43"></a><span id="l116.43" class="difflineminus">-    }</span>
<a href="#l116.44"></a><span id="l116.44" class="difflineplus">+    },</span>
<a href="#l116.45"></a><span id="l116.45">   }));</span>
<a href="#l116.46"></a><span id="l116.46">   // Msg #1</span>
<a href="#l116.47"></a><span id="l116.47">   add_message_to_folder(testFolder, create_message({</span>
<a href="#l116.48"></a><span id="l116.48">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l116.49"></a><span id="l116.49">     to: &quot;powerplant-workers@springfield.invalid&quot;,</span>
<a href="#l116.50"></a><span id="l116.50">     subject: &quot;only delivered-to header matching identity&quot;,</span>
<a href="#l116.51"></a><span id="l116.51">     body: {body: &quot;Just because I don't care doesn't mean I don't understand.&quot;},</span>
<a href="#l116.52"></a><span id="l116.52">     clobberHeaders: {</span>
<a href="#l116.53"></a><span id="l116.53" class="difflineminus">-      &quot;Delivered-To&quot; : &quot;&lt;&quot; + identity2Email + &quot;&gt;&quot;</span>
<a href="#l116.54"></a><span id="l116.54" class="difflineminus">-    }</span>
<a href="#l116.55"></a><span id="l116.55" class="difflineplus">+      &quot;Delivered-To&quot;: &quot;&lt;&quot; + identity2Email + &quot;&gt;&quot;,</span>
<a href="#l116.56"></a><span id="l116.56" class="difflineplus">+    },</span>
<a href="#l116.57"></a><span id="l116.57">   }));</span>
<a href="#l116.58"></a><span id="l116.58">   // Msg #2</span>
<a href="#l116.59"></a><span id="l116.59">   add_message_to_folder(testFolder, create_message({</span>
<a href="#l116.60"></a><span id="l116.60">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l116.61"></a><span id="l116.61">     to: &quot;powerplant-workers@springfield.invalid, Apu &lt;apu@test.invalid&gt;&quot;,</span>
<a href="#l116.62"></a><span id="l116.62">     cc: &quot;other.&quot; + identity2Email,</span>
<a href="#l116.63"></a><span id="l116.63">     subject: &quot;subpart of cc address matching identity&quot;,</span>
<a href="#l116.64"></a><span id="l116.64">     body: {body: &quot;Blame the guy who doesn't speak Engish.&quot;},</span>
<a href="#l116.65"></a><span id="l116.65">     clobberHeaders: {</span>
<a href="#l116.66"></a><span id="l116.66" class="difflineminus">-    }</span>
<a href="#l116.67"></a><span id="l116.67" class="difflineplus">+    },</span>
<a href="#l116.68"></a><span id="l116.68">   }));</span>
<a href="#l116.69"></a><span id="l116.69">   // Msg #3</span>
<a href="#l116.70"></a><span id="l116.70">   add_message_to_folder(testFolder, create_message({</span>
<a href="#l116.71"></a><span id="l116.71">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l116.72"></a><span id="l116.72">     to: &quot;Lenny &lt;&quot; + identity2Email + &quot;&gt;&quot;,</span>
<a href="#l116.73"></a><span id="l116.73">     subject: &quot;normal to:address match, with full name&quot;,</span>
<a href="#l116.74"></a><span id="l116.74" class="difflineminus">-    body: {body: &quot;Remember as far as anyone knows, we're a nice normal family.&quot;}</span>
<a href="#l116.75"></a><span id="l116.75" class="difflineplus">+    body: {body: &quot;Remember as far as anyone knows, we're a nice normal family.&quot;},</span>
<a href="#l116.76"></a><span id="l116.76">   }));</span>
<a href="#l116.77"></a><span id="l116.77">   // Msg #4</span>
<a href="#l116.78"></a><span id="l116.78">   add_message_to_folder(testFolder, create_message({</span>
<a href="#l116.79"></a><span id="l116.79">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l116.80"></a><span id="l116.80">     to: &quot;powerplant-workers@springfield.invalid&quot;,</span>
<a href="#l116.81"></a><span id="l116.81">     subject: &quot;delivered-to header matching only subpart of identity email&quot;,</span>
<a href="#l116.82"></a><span id="l116.82">     body: {body: &quot;Mmmm...Forbidden donut&quot;},</span>
<a href="#l116.83"></a><span id="l116.83">     clobberHeaders: {</span>
<a href="#l116.84"></a><span id="l116.84" class="difflineminus">-      &quot;Delivered-To&quot; : &quot;&lt;other.&quot; + identity2Email + &quot;&gt;&quot;</span>
<a href="#l116.85"></a><span id="l116.85" class="difflineminus">-    }</span>
<a href="#l116.86"></a><span id="l116.86" class="difflineplus">+      &quot;Delivered-To&quot;: &quot;&lt;other.&quot; + identity2Email + &quot;&gt;&quot;,</span>
<a href="#l116.87"></a><span id="l116.87" class="difflineplus">+    },</span>
<a href="#l116.88"></a><span id="l116.88">   }));</span>
<a href="#l116.89"></a><span id="l116.89">   // Msg #5</span>
<a href="#l116.90"></a><span id="l116.90">   add_message_to_folder(testFolder, create_message({</span>
<a href="#l116.91"></a><span id="l116.91" class="difflineminus">-    from: identity2Email + &quot; &lt;&quot; + identity2Email+ &quot;&gt;&quot;,</span>
<a href="#l116.92"></a><span id="l116.92" class="difflineplus">+    from: identity2Email + &quot; &lt;&quot; + identity2Email + &quot;&gt;&quot;,</span>
<a href="#l116.93"></a><span id="l116.93">     to: &quot;Marge &lt;marge@example.com&gt;&quot;,</span>
<a href="#l116.94"></a><span id="l116.94">     subject: &quot;from second self&quot;,</span>
<a href="#l116.95"></a><span id="l116.95" class="difflineminus">-    body: {body: &quot;All my life I've had one dream, to achieve my many goals.&quot;}</span>
<a href="#l116.96"></a><span id="l116.96" class="difflineplus">+    body: {body: &quot;All my life I've had one dream, to achieve my many goals.&quot;},</span>
<a href="#l116.97"></a><span id="l116.97">   }));</span>
<a href="#l116.98"></a><span id="l116.98"> }</span>
<a href="#l116.99"></a><span id="l116.99"> </span>
<a href="#l116.100"></a><span id="l116.100"> function addIdentitiesAndFolder() {</span>
<a href="#l116.101"></a><span id="l116.101">   let server = MailServices.accounts.createIncomingServer(&quot;nobody&quot;,</span>
<a href="#l116.102"></a><span id="l116.102">                                                           &quot;Reply Identity Testing&quot;, &quot;pop3&quot;);</span>
<a href="#l116.103"></a><span id="l116.103">   testFolder = server.rootFolder.QueryInterface(Ci.nsIMsgLocalMailFolder)</span>
<a href="#l116.104"></a><span id="l116.104">                      .createLocalSubfolder(&quot;Replies&quot;);</span>
<a href="#l116.105"></a><span id="l116.105" class="difflineat">@@ -95,21 +95,21 @@ function addIdentitiesAndFolder() {</span>
<a href="#l116.106"></a><span id="l116.106">   identity2.email = identity2Email;</span>
<a href="#l116.107"></a><span id="l116.107"> </span>
<a href="#l116.108"></a><span id="l116.108">   let account = MailServices.accounts.createAccount();</span>
<a href="#l116.109"></a><span id="l116.109">   account.incomingServer = server;</span>
<a href="#l116.110"></a><span id="l116.110">   account.addIdentity(identity);</span>
<a href="#l116.111"></a><span id="l116.111">   account.addIdentity(identity2);</span>
<a href="#l116.112"></a><span id="l116.112"> }</span>
<a href="#l116.113"></a><span id="l116.113"> </span>
<a href="#l116.114"></a><span id="l116.114" class="difflineminus">-var checkReply = function (replyWin, expectedFromEmail) {</span>
<a href="#l116.115"></a><span id="l116.115" class="difflineplus">+function checkReply(replyWin, expectedFromEmail) {</span>
<a href="#l116.116"></a><span id="l116.116">   let identityList = replyWin.e(&quot;msgIdentity&quot;);</span>
<a href="#l116.117"></a><span id="l116.117">   if (!identityList.selectedItem.label.includes(expectedFromEmail))</span>
<a href="#l116.118"></a><span id="l116.118">     throw new Error(&quot;The From address is not correctly selected! Expected: &quot; +</span>
<a href="#l116.119"></a><span id="l116.119" class="difflineminus">-                    expectedFromEmail + &quot;; Actual: &quot;  +</span>
<a href="#l116.120"></a><span id="l116.120" class="difflineplus">+                    expectedFromEmail + &quot;; Actual: &quot; +</span>
<a href="#l116.121"></a><span id="l116.121">                     identityList.selectedItem.label);</span>
<a href="#l116.122"></a><span id="l116.122"> }</span>
<a href="#l116.123"></a><span id="l116.123"> </span>
<a href="#l116.124"></a><span id="l116.124"> function test_reply_no_matching_identity() {</span>
<a href="#l116.125"></a><span id="l116.125">   be_in_folder(testFolder);</span>
<a href="#l116.126"></a><span id="l116.126"> </span>
<a href="#l116.127"></a><span id="l116.127">   let msg = select_click_row(0);</span>
<a href="#l116.128"></a><span id="l116.128">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l116.129"></a><span id="l116.129" class="difflineat">@@ -177,10 +177,10 @@ function test_reply_to_self_second_id() </span>
<a href="#l116.130"></a><span id="l116.130">   be_in_folder(testFolder);</span>
<a href="#l116.131"></a><span id="l116.131"> </span>
<a href="#l116.132"></a><span id="l116.132">   let msg = select_click_row(5);</span>
<a href="#l116.133"></a><span id="l116.133">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l116.134"></a><span id="l116.134"> </span>
<a href="#l116.135"></a><span id="l116.135">   let replyWin = open_compose_with_reply();</span>
<a href="#l116.136"></a><span id="l116.136">   // Should have selected the second id, which was in From.</span>
<a href="#l116.137"></a><span id="l116.137">   checkReply(replyWin, identity2Email);</span>
<a href="#l116.138"></a><span id="l116.138" class="difflineminus">-  close_compose_window(replyWin, false /*no prompt*/);</span>
<a href="#l116.139"></a><span id="l116.139" class="difflineplus">+  close_compose_window(replyWin, false /* no prompt*/);</span>
<a href="#l116.140"></a><span id="l116.140"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l117.1"></a><span id="l117.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js</span>
<a href="#l117.2"></a><span id="l117.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js</span>
<a href="#l117.3"></a><span id="l117.3" class="difflineat">@@ -3,21 +3,23 @@</span>
<a href="#l117.4"></a><span id="l117.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l117.5"></a><span id="l117.5"> </span>
<a href="#l117.6"></a><span id="l117.6"> /*</span>
<a href="#l117.7"></a><span id="l117.7">  *  Test for the most suitable identity in From address for reply-to-list</span>
<a href="#l117.8"></a><span id="l117.8">  */</span>
<a href="#l117.9"></a><span id="l117.9"> </span>
<a href="#l117.10"></a><span id="l117.10"> &quot;use strict&quot;;</span>
<a href="#l117.11"></a><span id="l117.11"> </span>
<a href="#l117.12"></a><span id="l117.12" class="difflineminus">-var MODULE_NAME = &quot;test-reply-to-list-from-address-selection&quot;;</span>
<a href="#l117.13"></a><span id="l117.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l117.14"></a><span id="l117.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l117.15"></a><span id="l117.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l117.16"></a><span id="l117.16"> </span>
<a href="#l117.17"></a><span id="l117.17" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l117.18"></a><span id="l117.18" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l117.19"></a><span id="l117.19" class="difflineminus">-                       'window-helpers', 'compose-helpers'];</span>
<a href="#l117.20"></a><span id="l117.20" class="difflineplus">+var MODULE_NAME = &quot;test-reply-to-list-from-address-selection&quot;;</span>
<a href="#l117.21"></a><span id="l117.21" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l117.22"></a><span id="l117.22" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l117.23"></a><span id="l117.23"> </span>
<a href="#l117.24"></a><span id="l117.24"> var testFolder = null;</span>
<a href="#l117.25"></a><span id="l117.25"> var msgHdr = null;</span>
<a href="#l117.26"></a><span id="l117.26"> var replyToListWindow = null;</span>
<a href="#l117.27"></a><span id="l117.27"> </span>
<a href="#l117.28"></a><span id="l117.28"> var identityString1 = &quot;tinderbox_correct_identity@foo.invalid&quot;;</span>
<a href="#l117.29"></a><span id="l117.29"> </span>
<a href="#l117.30"></a><span id="l117.30"> function setupModule(module) {</span>
<a href="#l117.31"></a><span id="l117.31" class="difflineat">@@ -44,36 +46,36 @@ function addMessageToFolder(aFolder) {</span>
<a href="#l117.32"></a><span id="l117.32">                 &quot;Date: Wed, 11 Jun 2008 20:32:02 -0400\n&quot; +</span>
<a href="#l117.33"></a><span id="l117.33">                 &quot;From: Tester &lt;tests@mozillamessaging.invalid&gt;\n&quot; +</span>
<a href="#l117.34"></a><span id="l117.34">                 &quot;User-Agent: Thunderbird 3.0a2pre (Macintosh/2008052122)\n&quot; +</span>
<a href="#l117.35"></a><span id="l117.35">                 &quot;MIME-Version: 1.0\n&quot; +</span>
<a href="#l117.36"></a><span id="l117.36">                 &quot;List-ID: &lt;list.mozillamessaging.invalid&gt;\n&quot; +</span>
<a href="#l117.37"></a><span id="l117.37">                 &quot;List-Post: &lt;list.mozillamessaging.invalid&gt;, \n&quot; +</span>
<a href="#l117.38"></a><span id="l117.38">                 &quot;    &lt;mailto: list@mozillamessaging.invalid&gt;\n&quot; +</span>
<a href="#l117.39"></a><span id="l117.39">                 &quot;To: recipient@mozillamessaging.invalid\n&quot; +</span>
<a href="#l117.40"></a><span id="l117.40" class="difflineminus">-                &quot;Subject: &quot; + &quot;a subject&quot; + &quot;\n&quot; +</span>
<a href="#l117.41"></a><span id="l117.41" class="difflineplus">+                &quot;Subject: a subject\n&quot; +</span>
<a href="#l117.42"></a><span id="l117.42">                 &quot;Content-Type: text/html; charset=ISO-8859-1\n&quot; +</span>
<a href="#l117.43"></a><span id="l117.43">                 &quot;Content-Transfer-Encoding: 7bit\n&quot; +</span>
<a href="#l117.44"></a><span id="l117.44" class="difflineminus">-                 &quot;\n&quot; + &quot;text body&quot; + &quot;\n&quot;;</span>
<a href="#l117.45"></a><span id="l117.45" class="difflineplus">+                &quot;\ntext body\n&quot;;</span>
<a href="#l117.46"></a><span id="l117.46"> </span>
<a href="#l117.47"></a><span id="l117.47">   aFolder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l117.48"></a><span id="l117.48">   aFolder.gettingNewMessages = true;</span>
<a href="#l117.49"></a><span id="l117.49">   aFolder.addMessage(source);</span>
<a href="#l117.50"></a><span id="l117.50">   aFolder.gettingNewMessages = false;</span>
<a href="#l117.51"></a><span id="l117.51"> </span>
<a href="#l117.52"></a><span id="l117.52">   return aFolder.msgDatabase.getMsgHdrForMessageID(msgId);</span>
<a href="#l117.53"></a><span id="l117.53"> }</span>
<a href="#l117.54"></a><span id="l117.54"> </span>
<a href="#l117.55"></a><span id="l117.55"> function addIdentitiesAndFolder() {</span>
<a href="#l117.56"></a><span id="l117.56">   let identity2 = MailServices.accounts.createIdentity();</span>
<a href="#l117.57"></a><span id="l117.57" class="difflineminus">-  //identity.fullName = &quot;Tinderbox_Identity1&quot;;</span>
<a href="#l117.58"></a><span id="l117.58" class="difflineminus">-  identity2.email=&quot;tinderbox_identity1@foo.invalid&quot;;</span>
<a href="#l117.59"></a><span id="l117.59" class="difflineplus">+  // identity.fullName = &quot;Tinderbox_Identity1&quot;;</span>
<a href="#l117.60"></a><span id="l117.60" class="difflineplus">+  identity2.email = &quot;tinderbox_identity1@foo.invalid&quot;;</span>
<a href="#l117.61"></a><span id="l117.61"> </span>
<a href="#l117.62"></a><span id="l117.62">   let identity = MailServices.accounts.createIdentity();</span>
<a href="#l117.63"></a><span id="l117.63" class="difflineminus">-  //identity.fullName = &quot;Tinderbox_Identity1&quot;;</span>
<a href="#l117.64"></a><span id="l117.64" class="difflineplus">+  // identity.fullName = &quot;Tinderbox_Identity1&quot;;</span>
<a href="#l117.65"></a><span id="l117.65">   identity.email = identityString1;</span>
<a href="#l117.66"></a><span id="l117.66"> </span>
<a href="#l117.67"></a><span id="l117.67">   let server = MailServices.accounts.createIncomingServer(&quot;nobody&quot;,</span>
<a href="#l117.68"></a><span id="l117.68">                                                           &quot;Test Local Folders&quot;, &quot;pop3&quot;);</span>
<a href="#l117.69"></a><span id="l117.69">   let localRoot = server.rootFolder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l117.70"></a><span id="l117.70">   testFolder = localRoot.createLocalSubfolder(&quot;Test Folder&quot;);</span>
<a href="#l117.71"></a><span id="l117.71"> </span>
<a href="#l117.72"></a><span id="l117.72">   let account = MailServices.accounts.createAccount();</span>
<a href="#l117.73"></a><span id="l117.73" class="difflineat">@@ -89,13 +91,13 @@ function test_Reply_To_List_From_Address</span>
<a href="#l117.74"></a><span id="l117.74">   assert_selected_and_displayed(mc, curMessage);</span>
<a href="#l117.75"></a><span id="l117.75"> </span>
<a href="#l117.76"></a><span id="l117.76">   replyToListWindow = open_compose_with_reply_to_list();</span>
<a href="#l117.77"></a><span id="l117.77"> </span>
<a href="#l117.78"></a><span id="l117.78">   var identityList = replyToListWindow.e(&quot;msgIdentity&quot;);</span>
<a href="#l117.79"></a><span id="l117.79"> </span>
<a href="#l117.80"></a><span id="l117.80">   // see if it's the correct identity selected</span>
<a href="#l117.81"></a><span id="l117.81">   if (!identityList.selectedItem.label.includes(identityString1))</span>
<a href="#l117.82"></a><span id="l117.82" class="difflineminus">-    throw new Error(&quot;The From address is not correctly selected! Expected: &quot;+</span>
<a href="#l117.83"></a><span id="l117.83" class="difflineminus">-                    identityString1 + &quot;; Actual: &quot;  +</span>
<a href="#l117.84"></a><span id="l117.84" class="difflineplus">+    throw new Error(&quot;The From address is not correctly selected! Expected: &quot; +</span>
<a href="#l117.85"></a><span id="l117.85" class="difflineplus">+                    identityString1 + &quot;; Actual: &quot; +</span>
<a href="#l117.86"></a><span id="l117.86">                     identityList.selectedItem.label);</span>
<a href="#l117.87"></a><span id="l117.87"> }</span>
<a href="#l117.88"></a><span id="l117.88"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l118.1"></a><span id="l118.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-return-receipt.js</span>
<a href="#l118.2"></a><span id="l118.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-return-receipt.js</span>
<a href="#l118.3"></a><span id="l118.3" class="difflineat">@@ -1,99 +1,98 @@</span>
<a href="#l118.4"></a><span id="l118.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l118.5"></a><span id="l118.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l118.6"></a><span id="l118.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l118.7"></a><span id="l118.7"> </span>
<a href="#l118.8"></a><span id="l118.8"> /*</span>
<a href="#l118.9"></a><span id="l118.9">  * Test return receipt (MDN) stuff.</span>
<a href="#l118.10"></a><span id="l118.10">  */</span>
<a href="#l118.11"></a><span id="l118.11"> </span>
<a href="#l118.12"></a><span id="l118.12" class="difflineminus">-// make SOLO_TEST=message-header/test-return-receipt.js mozmill-one</span>
<a href="#l118.13"></a><span id="l118.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l118.14"></a><span id="l118.14"> </span>
<a href="#l118.15"></a><span id="l118.15" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l118.16"></a><span id="l118.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l118.17"></a><span id="l118.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-notificationbox-helpers.js */</span>
<a href="#l118.18"></a><span id="l118.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l118.19"></a><span id="l118.19"> </span>
<a href="#l118.20"></a><span id="l118.20"> var MODULE_NAME = &quot;test-return-receipt&quot;;</span>
<a href="#l118.21"></a><span id="l118.21" class="difflineminus">-</span>
<a href="#l118.22"></a><span id="l118.22"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l118.23"></a><span id="l118.23" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l118.24"></a><span id="l118.24" class="difflineminus">-                        &quot;notificationbox-helpers&quot;];</span>
<a href="#l118.25"></a><span id="l118.25" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;notificationbox-helpers&quot;];</span>
<a href="#l118.26"></a><span id="l118.26"> </span>
<a href="#l118.27"></a><span id="l118.27"> var folder;</span>
<a href="#l118.28"></a><span id="l118.28"> </span>
<a href="#l118.29"></a><span id="l118.29"> var kBoxId = &quot;mail-notification-top&quot;;</span>
<a href="#l118.30"></a><span id="l118.30"> var kNotificationValue = &quot;mdnRequested&quot;;</span>
<a href="#l118.31"></a><span id="l118.31"> </span>
<a href="#l118.32"></a><span id="l118.32"> function setupModule(module) {</span>
<a href="#l118.33"></a><span id="l118.33">   collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l118.34"></a><span id="l118.34">   collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l118.35"></a><span id="l118.35">   collector.getModule(&quot;notificationbox-helpers&quot;).installInto(module);</span>
<a href="#l118.36"></a><span id="l118.36"> </span>
<a href="#l118.37"></a><span id="l118.37">   folder = create_folder(&quot;ReturnReceiptTest&quot;);</span>
<a href="#l118.38"></a><span id="l118.38"> </span>
<a href="#l118.39"></a><span id="l118.39">   // Create a message that requests a return receipt.</span>
<a href="#l118.40"></a><span id="l118.40">   let msg0 = create_message(</span>
<a href="#l118.41"></a><span id="l118.41">     {from: [&quot;Ake&quot;, &quot;ake@example.com&quot;],</span>
<a href="#l118.42"></a><span id="l118.42" class="difflineminus">-      clobberHeaders: { &quot;Disposition-Notification-To&quot;: &quot;ake@example.com&quot; }</span>
<a href="#l118.43"></a><span id="l118.43" class="difflineplus">+      clobberHeaders: { &quot;Disposition-Notification-To&quot;: &quot;ake@example.com&quot; },</span>
<a href="#l118.44"></a><span id="l118.44">     });</span>
<a href="#l118.45"></a><span id="l118.45">   add_message_to_folder(folder, msg0);</span>
<a href="#l118.46"></a><span id="l118.46"> </span>
<a href="#l118.47"></a><span id="l118.47">   // ... and one that doesn't request a return receipt.</span>
<a href="#l118.48"></a><span id="l118.48">   let msg1 = create_message();</span>
<a href="#l118.49"></a><span id="l118.49">   add_message_to_folder(folder, msg1);</span>
<a href="#l118.50"></a><span id="l118.50"> </span>
<a href="#l118.51"></a><span id="l118.51">   // Create a message that requests a return receipt to a different address.</span>
<a href="#l118.52"></a><span id="l118.52">   let msg2 = create_message(</span>
<a href="#l118.53"></a><span id="l118.53">     {from: [&quot;Mimi&quot;, &quot;me@example.org&quot;],</span>
<a href="#l118.54"></a><span id="l118.54" class="difflineminus">-      clobberHeaders: { &quot;Disposition-Notification-To&quot;: &quot;other@example.com&quot; }</span>
<a href="#l118.55"></a><span id="l118.55" class="difflineplus">+      clobberHeaders: { &quot;Disposition-Notification-To&quot;: &quot;other@example.com&quot; },</span>
<a href="#l118.56"></a><span id="l118.56">     });</span>
<a href="#l118.57"></a><span id="l118.57">   add_message_to_folder(folder, msg2);</span>
<a href="#l118.58"></a><span id="l118.58"> </span>
<a href="#l118.59"></a><span id="l118.59">   // Create a message that requests a return receipt to different addresses.</span>
<a href="#l118.60"></a><span id="l118.60">   let msg3 = create_message(</span>
<a href="#l118.61"></a><span id="l118.61">     {from: [&quot;Bobby&quot;, &quot;bob@example.org&quot;],</span>
<a href="#l118.62"></a><span id="l118.62" class="difflineminus">-      clobberHeaders: { &quot;Disposition-Notification-To&quot;: &quot;ex1@example.com, ex2@example.com&quot; }</span>
<a href="#l118.63"></a><span id="l118.63" class="difflineplus">+      clobberHeaders: { &quot;Disposition-Notification-To&quot;: &quot;ex1@example.com, ex2@example.com&quot; },</span>
<a href="#l118.64"></a><span id="l118.64">     });</span>
<a href="#l118.65"></a><span id="l118.65">   add_message_to_folder(folder, msg3);</span>
<a href="#l118.66"></a><span id="l118.66"> </span>
<a href="#l118.67"></a><span id="l118.67">   // Create a message that requests a return receipt using non-standard header.</span>
<a href="#l118.68"></a><span id="l118.68">   let msg4 = create_message(</span>
<a href="#l118.69"></a><span id="l118.69">     {from: [&quot;Ake&quot;, &quot;ake@example.com&quot;],</span>
<a href="#l118.70"></a><span id="l118.70" class="difflineminus">-     clobberHeaders: { &quot;Return-Receipt-To&quot;: &quot;ake@example.com&quot; }</span>
<a href="#l118.71"></a><span id="l118.71" class="difflineplus">+     clobberHeaders: { &quot;Return-Receipt-To&quot;: &quot;ake@example.com&quot; },</span>
<a href="#l118.72"></a><span id="l118.72">     });</span>
<a href="#l118.73"></a><span id="l118.73">   add_message_to_folder(folder, msg4);</span>
<a href="#l118.74"></a><span id="l118.74"> </span>
<a href="#l118.75"></a><span id="l118.75">   // Create a message that requests a return receipt to a different address</span>
<a href="#l118.76"></a><span id="l118.76">   // using non-standard header.</span>
<a href="#l118.77"></a><span id="l118.77">   let msg5 = create_message(</span>
<a href="#l118.78"></a><span id="l118.78">     {from: [&quot;Mimi&quot;, &quot;me@example.org&quot;],</span>
<a href="#l118.79"></a><span id="l118.79" class="difflineminus">-     clobberHeaders: { &quot;Return-Receipt-To&quot;: &quot;other@example.com&quot; }</span>
<a href="#l118.80"></a><span id="l118.80" class="difflineplus">+     clobberHeaders: { &quot;Return-Receipt-To&quot;: &quot;other@example.com&quot; },</span>
<a href="#l118.81"></a><span id="l118.81">     });</span>
<a href="#l118.82"></a><span id="l118.82">   add_message_to_folder(folder, msg5);</span>
<a href="#l118.83"></a><span id="l118.83"> </span>
<a href="#l118.84"></a><span id="l118.84">   // Create a message that requests a return receipt to different addresses</span>
<a href="#l118.85"></a><span id="l118.85">   // using non-standard header.</span>
<a href="#l118.86"></a><span id="l118.86">   let msg6 = create_message(</span>
<a href="#l118.87"></a><span id="l118.87">    {from: [&quot;Bobby&quot;, &quot;bob@example.org&quot;],</span>
<a href="#l118.88"></a><span id="l118.88" class="difflineminus">-     clobberHeaders: { &quot;Return-Receipt-To&quot;: &quot;ex1@example.com, ex2@example.com&quot; }</span>
<a href="#l118.89"></a><span id="l118.89" class="difflineplus">+     clobberHeaders: { &quot;Return-Receipt-To&quot;: &quot;ex1@example.com, ex2@example.com&quot; },</span>
<a href="#l118.90"></a><span id="l118.90">    });</span>
<a href="#l118.91"></a><span id="l118.91">   add_message_to_folder(folder, msg6);</span>
<a href="#l118.92"></a><span id="l118.92"> }</span>
<a href="#l118.93"></a><span id="l118.93"> </span>
<a href="#l118.94"></a><span id="l118.94"> /** Utility to select a message. */</span>
<a href="#l118.95"></a><span id="l118.95"> function gotoMsg(row) {</span>
<a href="#l118.96"></a><span id="l118.96">   be_in_folder(folder);</span>
<a href="#l118.97"></a><span id="l118.97">   let curMessage = select_click_row(row);</span>
<a href="#l118.98"></a><span id="l118.98">   assert_selected_and_displayed(mc, curMessage);</span>
<a href="#l118.99"></a><span id="l118.99"> }</span>
<a href="#l118.100"></a><span id="l118.100"> </span>
<a href="#l118.101"></a><span id="l118.101"> /**</span>
<a href="#l118.102"></a><span id="l118.102">  * Utility to make sure the MDN bar is shown / not shown.</span>
<a href="#l118.103"></a><span id="l118.103">  */</span>
<a href="#l118.104"></a><span id="l118.104"> function assert_mdn_shown(shouldShow) {</span>
<a href="#l118.105"></a><span id="l118.105" class="difflineminus">-  let msgNotBar = mc.e(&quot;mail-notification-top&quot;);</span>
<a href="#l118.106"></a><span id="l118.106">   assert_notification_displayed(mc, kBoxId, kNotificationValue, shouldShow);</span>
<a href="#l118.107"></a><span id="l118.107"> }</span>
<a href="#l118.108"></a><span id="l118.108"> </span>
<a href="#l118.109"></a><span id="l118.109"> /**</span>
<a href="#l118.110"></a><span id="l118.110">  * Utility function to make sure the notification contains a certain text.</span>
<a href="#l118.111"></a><span id="l118.111">  */</span>
<a href="#l118.112"></a><span id="l118.112"> function assert_mdn_text_contains(text, shouldContain) {</span>
<a href="#l118.113"></a><span id="l118.113">   let nb = mc.window.document.getElementById(kBoxId);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l119.1"></a><span id="l119.1" class="difflineminus">--- a/mail/test/mozmill/message-reader/test-bug594646.js</span>
<a href="#l119.2"></a><span id="l119.2" class="difflineplus">+++ b/mail/test/mozmill/message-reader/test-bug594646.js</span>
<a href="#l119.3"></a><span id="l119.3" class="difflineat">@@ -6,18 +6,20 @@</span>
<a href="#l119.4"></a><span id="l119.4"> </span>
<a href="#l119.5"></a><span id="l119.5"> /**</span>
<a href="#l119.6"></a><span id="l119.6">  * Tests that opening an .eml file the body of the message is correct,</span>
<a href="#l119.7"></a><span id="l119.7">  * that it hasn't been UTF-8 mojibake'd.</span>
<a href="#l119.8"></a><span id="l119.8">  */</span>
<a href="#l119.9"></a><span id="l119.9"> </span>
<a href="#l119.10"></a><span id="l119.10"> &quot;use strict&quot;;</span>
<a href="#l119.11"></a><span id="l119.11"> </span>
<a href="#l119.12"></a><span id="l119.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l119.13"></a><span id="l119.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l119.14"></a><span id="l119.14" class="difflineplus">+</span>
<a href="#l119.15"></a><span id="l119.15"> var MODULE_NAME = &quot;test-bug594646&quot;;</span>
<a href="#l119.16"></a><span id="l119.16" class="difflineminus">-</span>
<a href="#l119.17"></a><span id="l119.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l119.18"></a><span id="l119.18"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l119.19"></a><span id="l119.19"> </span>
<a href="#l119.20"></a><span id="l119.20"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l119.21"></a><span id="l119.21"> </span>
<a href="#l119.22"></a><span id="l119.22"> var gReferenceTextContent;</span>
<a href="#l119.23"></a><span id="l119.23"> </span>
<a href="#l119.24"></a><span id="l119.24"> function setupModule(module) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l120.1"></a><span id="l120.1" class="difflineminus">--- a/mail/test/mozmill/message-window/test-autohide-menubar.js</span>
<a href="#l120.2"></a><span id="l120.2" class="difflineplus">+++ b/mail/test/mozmill/message-window/test-autohide-menubar.js</span>
<a href="#l120.3"></a><span id="l120.3" class="difflineat">@@ -2,21 +2,23 @@</span>
<a href="#l120.4"></a><span id="l120.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l120.5"></a><span id="l120.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l120.6"></a><span id="l120.6"> </span>
<a href="#l120.7"></a><span id="l120.7"> /* Test that the menubar can be set to &quot;autohide&quot;. This should only have an</span>
<a href="#l120.8"></a><span id="l120.8">    effect on Windows. */</span>
<a href="#l120.9"></a><span id="l120.9"> </span>
<a href="#l120.10"></a><span id="l120.10"> &quot;use strict&quot;;</span>
<a href="#l120.11"></a><span id="l120.11"> </span>
<a href="#l120.12"></a><span id="l120.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-address-book-helpers.js */</span>
<a href="#l120.13"></a><span id="l120.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l120.14"></a><span id="l120.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l120.15"></a><span id="l120.15" class="difflineplus">+</span>
<a href="#l120.16"></a><span id="l120.16"> var MODULE_NAME = &quot;test-autohide-menubar&quot;;</span>
<a href="#l120.17"></a><span id="l120.17" class="difflineminus">-</span>
<a href="#l120.18"></a><span id="l120.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l120.19"></a><span id="l120.19" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;address-book-helpers&quot;,</span>
<a href="#l120.20"></a><span id="l120.20" class="difflineminus">-                       &quot;compose-helpers&quot;];</span>
<a href="#l120.21"></a><span id="l120.21" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;address-book-helpers&quot;, &quot;compose-helpers&quot;];</span>
<a href="#l120.22"></a><span id="l120.22"> </span>
<a href="#l120.23"></a><span id="l120.23"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l120.24"></a><span id="l120.24"> </span>
<a href="#l120.25"></a><span id="l120.25"> var menuFolder;</span>
<a href="#l120.26"></a><span id="l120.26"> var menuState;</span>
<a href="#l120.27"></a><span id="l120.27"> </span>
<a href="#l120.28"></a><span id="l120.28"> function setupModule(module) {</span>
<a href="#l120.29"></a><span id="l120.29">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l121.1"></a><span id="l121.1" class="difflineminus">--- a/mail/test/mozmill/message-window/test-commands.js</span>
<a href="#l121.2"></a><span id="l121.2" class="difflineplus">+++ b/mail/test/mozmill/message-window/test-commands.js</span>
<a href="#l121.3"></a><span id="l121.3" class="difflineat">@@ -1,16 +1,18 @@</span>
<a href="#l121.4"></a><span id="l121.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l121.5"></a><span id="l121.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l121.6"></a><span id="l121.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l121.7"></a><span id="l121.7"> </span>
<a href="#l121.8"></a><span id="l121.8"> &quot;use strict&quot;;</span>
<a href="#l121.9"></a><span id="l121.9"> </span>
<a href="#l121.10"></a><span id="l121.10" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l121.11"></a><span id="l121.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l121.12"></a><span id="l121.12" class="difflineplus">+</span>
<a href="#l121.13"></a><span id="l121.13"> var MODULE_NAME = &quot;test-commands&quot;;</span>
<a href="#l121.14"></a><span id="l121.14" class="difflineminus">-</span>
<a href="#l121.15"></a><span id="l121.15"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l121.16"></a><span id="l121.16"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l121.17"></a><span id="l121.17"> </span>
<a href="#l121.18"></a><span id="l121.18"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l121.19"></a><span id="l121.19"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l121.20"></a><span id="l121.20"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l121.21"></a><span id="l121.21"> </span>
<a href="#l121.22"></a><span id="l121.22"> var folder1, folder2;</span>
<a href="#l121.23"></a><span id="l121.23" class="difflineat">@@ -19,17 +21,17 @@ var setupModule = function(module) {</span>
<a href="#l121.24"></a><span id="l121.24">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l121.25"></a><span id="l121.25">   fdh.installInto(module);</span>
<a href="#l121.26"></a><span id="l121.26">   let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l121.27"></a><span id="l121.27">   wh.installInto(module);</span>
<a href="#l121.28"></a><span id="l121.28"> </span>
<a href="#l121.29"></a><span id="l121.29">   folder1 = create_folder(&quot;CopyFromFolder&quot;);</span>
<a href="#l121.30"></a><span id="l121.30">   folder2 = create_folder(&quot;CopyToFolder&quot;);</span>
<a href="#l121.31"></a><span id="l121.31">   make_new_sets_in_folder(folder1, [{count: 1}]);</span>
<a href="#l121.32"></a><span id="l121.32" class="difflineminus">-}</span>
<a href="#l121.33"></a><span id="l121.33" class="difflineplus">+};</span>
<a href="#l121.34"></a><span id="l121.34"> </span>
<a href="#l121.35"></a><span id="l121.35"> function test_copy_eml_message() {</span>
<a href="#l121.36"></a><span id="l121.36">   // First, copy an email to a folder and delete it immediately just so it shows</span>
<a href="#l121.37"></a><span id="l121.37">   // up in the recent folders list. This simplifies navigation of the copy</span>
<a href="#l121.38"></a><span id="l121.38">   // context menu.</span>
<a href="#l121.39"></a><span id="l121.39">   be_in_folder(folder1);</span>
<a href="#l121.40"></a><span id="l121.40">   let message = select_click_row(0);</span>
<a href="#l121.41"></a><span id="l121.41">   let array = Cc[&quot;@mozilla.org/array;1&quot;]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l122.1"></a><span id="l122.1" class="difflineminus">--- a/mail/test/mozmill/message-window/test-eml-subject.js</span>
<a href="#l122.2"></a><span id="l122.2" class="difflineplus">+++ b/mail/test/mozmill/message-window/test-eml-subject.js</span>
<a href="#l122.3"></a><span id="l122.3" class="difflineat">@@ -3,18 +3,20 @@</span>
<a href="#l122.4"></a><span id="l122.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l122.5"></a><span id="l122.5"> </span>
<a href="#l122.6"></a><span id="l122.6"> /**</span>
<a href="#l122.7"></a><span id="l122.7">  * Tests that opening an .eml file with empty subject works.</span>
<a href="#l122.8"></a><span id="l122.8">  */</span>
<a href="#l122.9"></a><span id="l122.9"> </span>
<a href="#l122.10"></a><span id="l122.10"> &quot;use strict&quot;;</span>
<a href="#l122.11"></a><span id="l122.11"> </span>
<a href="#l122.12"></a><span id="l122.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l122.13"></a><span id="l122.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l122.14"></a><span id="l122.14" class="difflineplus">+</span>
<a href="#l122.15"></a><span id="l122.15"> var MODULE_NAME = &quot;test-eml-subject&quot;;</span>
<a href="#l122.16"></a><span id="l122.16" class="difflineminus">-</span>
<a href="#l122.17"></a><span id="l122.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l122.18"></a><span id="l122.18"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l122.19"></a><span id="l122.19"> </span>
<a href="#l122.20"></a><span id="l122.20"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l122.21"></a><span id="l122.21"> var {StringBundle} = ChromeUtils.import(&quot;resource:///modules/StringBundle.js&quot;);</span>
<a href="#l122.22"></a><span id="l122.22"> var {AppConstants} = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l122.23"></a><span id="l122.23"> </span>
<a href="#l122.24"></a><span id="l122.24"> var setupModule = function(module) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l123.1"></a><span id="l123.1" class="difflineminus">--- a/mail/test/mozmill/message-window/test-message-sidebar.js</span>
<a href="#l123.2"></a><span id="l123.2" class="difflineplus">+++ b/mail/test/mozmill/message-window/test-message-sidebar.js</span>
<a href="#l123.3"></a><span id="l123.3" class="difflineat">@@ -1,25 +1,26 @@</span>
<a href="#l123.4"></a><span id="l123.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l123.5"></a><span id="l123.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l123.6"></a><span id="l123.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l123.7"></a><span id="l123.7"> </span>
<a href="#l123.8"></a><span id="l123.8"> &quot;use strict&quot;;</span>
<a href="#l123.9"></a><span id="l123.9"> </span>
<a href="#l123.10"></a><span id="l123.10" class="difflineminus">-var MODULE_NAME = 'test-message-sidebar';</span>
<a href="#l123.11"></a><span id="l123.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l123.12"></a><span id="l123.12"> </span>
<a href="#l123.13"></a><span id="l123.13" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l123.14"></a><span id="l123.14" class="difflineminus">-var MODULE_REQUIRES = ['window-helpers'];</span>
<a href="#l123.15"></a><span id="l123.15" class="difflineplus">+var MODULE_NAME = &quot;test-message-sidebar&quot;;</span>
<a href="#l123.16"></a><span id="l123.16" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l123.17"></a><span id="l123.17" class="difflineplus">+var MODULE_REQUIRES = [&quot;window-helpers&quot;];</span>
<a href="#l123.18"></a><span id="l123.18"> </span>
<a href="#l123.19"></a><span id="l123.19"> var windowHelper;</span>
<a href="#l123.20"></a><span id="l123.20"> var mc;</span>
<a href="#l123.21"></a><span id="l123.21"> </span>
<a href="#l123.22"></a><span id="l123.22" class="difflineminus">-var setupModule = function (module) {</span>
<a href="#l123.23"></a><span id="l123.23" class="difflineminus">-  windowHelper = collector.getModule('window-helpers');</span>
<a href="#l123.24"></a><span id="l123.24" class="difflineplus">+function setupModule(module) {</span>
<a href="#l123.25"></a><span id="l123.25" class="difflineplus">+  windowHelper = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l123.26"></a><span id="l123.26">   mc = windowHelper.wait_for_existing_window(&quot;mail:3pane&quot;);</span>
<a href="#l123.27"></a><span id="l123.27">   windowHelper.installInto(module);</span>
<a href="#l123.28"></a><span id="l123.28">   windowHelper.augment_controller(mc);</span>
<a href="#l123.29"></a><span id="l123.29" class="difflineminus">-};</span>
<a href="#l123.30"></a><span id="l123.30" class="difflineplus">+}</span>
<a href="#l123.31"></a><span id="l123.31"> </span>
<a href="#l123.32"></a><span id="l123.32"> </span>
<a href="#l123.33"></a><span id="l123.33"> function test_messagepane_extension_points_exist() {</span>
<a href="#l123.34"></a><span id="l123.34">   mc.assertNode(mc.eid(&quot;messagepanewrapper&quot;));</span>
<a href="#l123.35"></a><span id="l123.35"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l124.1"></a><span id="l124.1" class="difflineminus">--- a/mail/test/mozmill/message-window/test-vcard-actions.js</span>
<a href="#l124.2"></a><span id="l124.2" class="difflineplus">+++ b/mail/test/mozmill/message-window/test-vcard-actions.js</span>
<a href="#l124.3"></a><span id="l124.3" class="difflineat">@@ -1,25 +1,25 @@</span>
<a href="#l124.4"></a><span id="l124.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l124.5"></a><span id="l124.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l124.6"></a><span id="l124.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l124.7"></a><span id="l124.7"> </span>
<a href="#l124.8"></a><span id="l124.8"> /**</span>
<a href="#l124.9"></a><span id="l124.9">  * Tests for attached vcards.</span>
<a href="#l124.10"></a><span id="l124.10">  */</span>
<a href="#l124.11"></a><span id="l124.11"> </span>
<a href="#l124.12"></a><span id="l124.12" class="difflineminus">-// make SOLO_TEST=message-window/test-vcard-actions.js mozmill-one</span>
<a href="#l124.13"></a><span id="l124.13" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l124.14"></a><span id="l124.14"> </span>
<a href="#l124.15"></a><span id="l124.15" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l124.16"></a><span id="l124.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-address-book-helpers.js */</span>
<a href="#l124.17"></a><span id="l124.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l124.18"></a><span id="l124.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l124.19"></a><span id="l124.19"> </span>
<a href="#l124.20"></a><span id="l124.20"> var MODULE_NAME = &quot;test-vcard-actions&quot;;</span>
<a href="#l124.21"></a><span id="l124.21" class="difflineminus">-</span>
<a href="#l124.22"></a><span id="l124.22"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l124.23"></a><span id="l124.23" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l124.24"></a><span id="l124.24" class="difflineminus">-                       &quot;address-book-helpers&quot;];</span>
<a href="#l124.25"></a><span id="l124.25" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;address-book-helpers&quot;];</span>
<a href="#l124.26"></a><span id="l124.26"> </span>
<a href="#l124.27"></a><span id="l124.27"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l124.28"></a><span id="l124.28"> </span>
<a href="#l124.29"></a><span id="l124.29"> function setupModule(module) {</span>
<a href="#l124.30"></a><span id="l124.30">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l124.31"></a><span id="l124.31">     collector.getModule(lib).installInto(module);</span>
<a href="#l124.32"></a><span id="l124.32">   }</span>
<a href="#l124.33"></a><span id="l124.33"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l125.1"></a><span id="l125.1" class="difflineminus">--- a/mail/test/mozmill/message-window/test-view-plaintext.js</span>
<a href="#l125.2"></a><span id="l125.2" class="difflineplus">+++ b/mail/test/mozmill/message-window/test-view-plaintext.js</span>
<a href="#l125.3"></a><span id="l125.3" class="difflineat">@@ -1,22 +1,22 @@</span>
<a href="#l125.4"></a><span id="l125.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l125.5"></a><span id="l125.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l125.6"></a><span id="l125.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l125.7"></a><span id="l125.7"> </span>
<a href="#l125.8"></a><span id="l125.8"> /**</span>
<a href="#l125.9"></a><span id="l125.9">  * Tests that the plain text part of multipart/alternative messages can be correctly viewed.</span>
<a href="#l125.10"></a><span id="l125.10">  */</span>
<a href="#l125.11"></a><span id="l125.11"> </span>
<a href="#l125.12"></a><span id="l125.12" class="difflineminus">-// mozmake SOLO_TEST=message-window/test-view-plaintext.js mozmill-one</span>
<a href="#l125.13"></a><span id="l125.13" class="difflineminus">-</span>
<a href="#l125.14"></a><span id="l125.14"> &quot;use strict&quot;;</span>
<a href="#l125.15"></a><span id="l125.15"> </span>
<a href="#l125.16"></a><span id="l125.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l125.17"></a><span id="l125.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l125.18"></a><span id="l125.18" class="difflineplus">+</span>
<a href="#l125.19"></a><span id="l125.19"> var MODULE_NAME = &quot;test-view-plaintext&quot;;</span>
<a href="#l125.20"></a><span id="l125.20" class="difflineminus">-</span>
<a href="#l125.21"></a><span id="l125.21"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l125.22"></a><span id="l125.22"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l125.23"></a><span id="l125.23"> </span>
<a href="#l125.24"></a><span id="l125.24"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l125.25"></a><span id="l125.25"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l125.26"></a><span id="l125.26"> </span>
<a href="#l125.27"></a><span id="l125.27"> function setupModule(module) {</span>
<a href="#l125.28"></a><span id="l125.28">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l125.29"></a><span id="l125.29" class="difflineat">@@ -36,19 +36,19 @@ function check_content(aWindow, aExpecte</span>
<a href="#l125.30"></a><span id="l125.30">   let messageContent = messagePane.contentDocument.firstChild.textContent;</span>
<a href="#l125.31"></a><span id="l125.31"> </span>
<a href="#l125.32"></a><span id="l125.32">   if (aExpected != aDontWantToSee) {</span>
<a href="#l125.33"></a><span id="l125.33">     assert_true(messageContent.includes(aExpected), &quot;Didn't find expected content&quot;);</span>
<a href="#l125.34"></a><span id="l125.34">     assert_false(messageContent.includes(aDontWantToSee),</span>
<a href="#l125.35"></a><span id="l125.35">                  &quot;Found content that shouldn't be there&quot;);</span>
<a href="#l125.36"></a><span id="l125.36">   } else {</span>
<a href="#l125.37"></a><span id="l125.37">     let ind = messageContent.indexOf(aExpected);</span>
<a href="#l125.38"></a><span id="l125.38" class="difflineminus">-    assert_true (ind &gt;= 0, &quot;Didn't find expected content&quot;);</span>
<a href="#l125.39"></a><span id="l125.39" class="difflineplus">+    assert_true(ind &gt;= 0, &quot;Didn't find expected content&quot;);</span>
<a href="#l125.40"></a><span id="l125.40">     if (ind &gt;= 0)</span>
<a href="#l125.41"></a><span id="l125.41" class="difflineminus">-      assert_false(messageContent.substr(ind+aExpected.length).includes(aExpected),</span>
<a href="#l125.42"></a><span id="l125.42" class="difflineplus">+      assert_false(messageContent.substr(ind + aExpected.length).includes(aExpected),</span>
<a href="#l125.43"></a><span id="l125.43">                    &quot;Found content a second time&quot;);</span>
<a href="#l125.44"></a><span id="l125.44">   }</span>
<a href="#l125.45"></a><span id="l125.45"> }</span>
<a href="#l125.46"></a><span id="l125.46"> </span>
<a href="#l125.47"></a><span id="l125.47"> /**</span>
<a href="#l125.48"></a><span id="l125.48">  * Load a message from a file and display it as plain text and HTML. Check that the</span>
<a href="#l125.49"></a><span id="l125.49">  * correct MIME part is displayed.</span>
<a href="#l125.50"></a><span id="l125.50">  *</span>
<a href="#l125.51"></a><span id="l125.51" class="difflineat">@@ -79,39 +79,39 @@ function checkSingleMessage(aFilePath, a</span>
<a href="#l125.52"></a><span id="l125.52">  * Tests that messages with various MIME parts are shown correctly when displayed</span>
<a href="#l125.53"></a><span id="l125.53">  * as plain text or HTML.</span>
<a href="#l125.54"></a><span id="l125.54">  */</span>
<a href="#l125.55"></a><span id="l125.55"> function test_view() {</span>
<a href="#l125.56"></a><span id="l125.56">   // First the straight forward tests:</span>
<a href="#l125.57"></a><span id="l125.57">   // 1) multipart/alternative</span>
<a href="#l125.58"></a><span id="l125.58">   // 2) multipart/alternative with embedded multipart/related</span>
<a href="#l125.59"></a><span id="l125.59">   // 3) multipart/alternative with embedded multipart/related embedded in multipart/mixed</span>
<a href="#l125.60"></a><span id="l125.60" class="difflineminus">-  checkSingleMessage(&quot;./test-alt.eml&quot;,                     &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.61"></a><span id="l125.61" class="difflineminus">-  checkSingleMessage(&quot;./test-alt-rel.eml&quot;,                 &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.62"></a><span id="l125.62" class="difflineminus">-  checkSingleMessage(&quot;./test-alt-rel-with-attach.eml&quot;,     &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.63"></a><span id="l125.63" class="difflineplus">+  checkSingleMessage(&quot;./test-alt.eml&quot;, &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.64"></a><span id="l125.64" class="difflineplus">+  checkSingleMessage(&quot;./test-alt-rel.eml&quot;, &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.65"></a><span id="l125.65" class="difflineplus">+  checkSingleMessage(&quot;./test-alt-rel-with-attach.eml&quot;, &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.66"></a><span id="l125.66"> </span>
<a href="#l125.67"></a><span id="l125.67">   // 4) HTML part missing</span>
<a href="#l125.68"></a><span id="l125.68">   // 5) Plain part missing</span>
<a href="#l125.69"></a><span id="l125.69" class="difflineminus">-  checkSingleMessage(&quot;./test-alt-HTML-missing.eml&quot;,        &quot;Plain Text&quot;, &quot;Plain Text&quot;);</span>
<a href="#l125.70"></a><span id="l125.70" class="difflineminus">-  checkSingleMessage(&quot;./test-alt-plain-missing.eml&quot;,       &quot;HTML Body&quot;,  &quot;HTML Body&quot;);</span>
<a href="#l125.71"></a><span id="l125.71" class="difflineplus">+  checkSingleMessage(&quot;./test-alt-HTML-missing.eml&quot;, &quot;Plain Text&quot;, &quot;Plain Text&quot;);</span>
<a href="#l125.72"></a><span id="l125.72" class="difflineplus">+  checkSingleMessage(&quot;./test-alt-plain-missing.eml&quot;, &quot;HTML Body&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.73"></a><span id="l125.73"> </span>
<a href="#l125.74"></a><span id="l125.74">   // 6) plain and HTML parts reversed in order</span>
<a href="#l125.75"></a><span id="l125.75">   checkSingleMessage(&quot;./test-alt-plain-HTML-reversed.eml&quot;, &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.76"></a><span id="l125.76"> </span>
<a href="#l125.77"></a><span id="l125.77">   // 7) 3 alt. parts with 2 plain and 1 HTML part</span>
<a href="#l125.78"></a><span id="l125.78" class="difflineminus">-  checkSingleMessage(&quot;./test-triple-alt.eml&quot;,              &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.79"></a><span id="l125.79" class="difflineplus">+  checkSingleMessage(&quot;./test-triple-alt.eml&quot;, &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.80"></a><span id="l125.80"> </span>
<a href="#l125.81"></a><span id="l125.81">   // 8) 3 alt. parts with 2 plain and 1 multipart/related</span>
<a href="#l125.82"></a><span id="l125.82" class="difflineminus">-  checkSingleMessage(&quot;./test-alt-rel-text.eml&quot;,            &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.83"></a><span id="l125.83" class="difflineplus">+  checkSingleMessage(&quot;./test-alt-rel-text.eml&quot;, &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.84"></a><span id="l125.84"> </span>
<a href="#l125.85"></a><span id="l125.85">   // Now some cases that don't work yet.</span>
<a href="#l125.86"></a><span id="l125.86">   // 9) multipart/related with embedded multipart/alternative</span>
<a href="#l125.87"></a><span id="l125.87" class="difflineminus">-  checkSingleMessage(&quot;./test-rel-alt.eml&quot;,                 &quot;HTML Body&quot;,  &quot;HTML Body&quot;);</span>
<a href="#l125.88"></a><span id="l125.88" class="difflineplus">+  checkSingleMessage(&quot;./test-rel-alt.eml&quot;, &quot;HTML Body&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.89"></a><span id="l125.89"> </span>
<a href="#l125.90"></a><span id="l125.90">   // Bug 1367156: Rogue message which has an image as the last part.</span>
<a href="#l125.91"></a><span id="l125.91" class="difflineminus">-  checkSingleMessage(&quot;./test-alt-rogue.eml&quot;,               &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.92"></a><span id="l125.92" class="difflineminus">-  checkSingleMessage(&quot;./test-alt-rogue2.eml&quot;,              &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.93"></a><span id="l125.93" class="difflineplus">+  checkSingleMessage(&quot;./test-alt-rogue.eml&quot;, &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.94"></a><span id="l125.94" class="difflineplus">+  checkSingleMessage(&quot;./test-alt-rogue2.eml&quot;, &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l125.95"></a><span id="l125.95"> }</span>
<a href="#l125.96"></a><span id="l125.96"> </span>
<a href="#l125.97"></a><span id="l125.97"> function teardownModule() {</span>
<a href="#l125.98"></a><span id="l125.98">   Services.prefs.clearUserPref(&quot;mailnews.display.prefer_plaintext&quot;);</span>
<a href="#l125.99"></a><span id="l125.99">   Services.prefs.clearUserPref(&quot;mailnews.display.html_as&quot;);</span>
<a href="#l125.100"></a><span id="l125.100"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l126.1"></a><span id="l126.1" class="difflineminus">--- a/mail/test/mozmill/multiple-identities/test-display-names.js</span>
<a href="#l126.2"></a><span id="l126.2" class="difflineplus">+++ b/mail/test/mozmill/multiple-identities/test-display-names.js</span>
<a href="#l126.3"></a><span id="l126.3" class="difflineat">@@ -4,18 +4,20 @@</span>
<a href="#l126.4"></a><span id="l126.4"> </span>
<a href="#l126.5"></a><span id="l126.5"> /*</span>
<a href="#l126.6"></a><span id="l126.6">  * Test that we can open and close a standalone message display window from the</span>
<a href="#l126.7"></a><span id="l126.7">  *  folder pane.</span>
<a href="#l126.8"></a><span id="l126.8">  */</span>
<a href="#l126.9"></a><span id="l126.9"> </span>
<a href="#l126.10"></a><span id="l126.10"> &quot;use strict&quot;;</span>
<a href="#l126.11"></a><span id="l126.11"> </span>
<a href="#l126.12"></a><span id="l126.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-address-book-helpers.js */</span>
<a href="#l126.13"></a><span id="l126.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l126.14"></a><span id="l126.14" class="difflineplus">+</span>
<a href="#l126.15"></a><span id="l126.15"> var MODULE_NAME = &quot;test-display-names&quot;;</span>
<a href="#l126.16"></a><span id="l126.16" class="difflineminus">-</span>
<a href="#l126.17"></a><span id="l126.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l126.18"></a><span id="l126.18"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;address-book-helpers&quot;];</span>
<a href="#l126.19"></a><span id="l126.19"> </span>
<a href="#l126.20"></a><span id="l126.20"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l126.21"></a><span id="l126.21"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l126.22"></a><span id="l126.22"> </span>
<a href="#l126.23"></a><span id="l126.23"> var folder;</span>
<a href="#l126.24"></a><span id="l126.24"> var decoyFolder;</span>
<a href="#l126.25"></a><span id="l126.25" class="difflineat">@@ -85,23 +87,23 @@ function ensure_multiple_identities() {</span>
<a href="#l126.26"></a><span id="l126.26">               &quot;Expected multiple identities, but got only one identity&quot;);</span>
<a href="#l126.27"></a><span id="l126.27"> }</span>
<a href="#l126.28"></a><span id="l126.28"> </span>
<a href="#l126.29"></a><span id="l126.29"> function help_test_display_name(message, field, expectedValue) {</span>
<a href="#l126.30"></a><span id="l126.30">   // Switch to a decoy folder first to ensure that we refresh the message we're</span>
<a href="#l126.31"></a><span id="l126.31">   // looking at in order to update information changed in address book entries.</span>
<a href="#l126.32"></a><span id="l126.32">   be_in_folder(decoyFolder);</span>
<a href="#l126.33"></a><span id="l126.33">   be_in_folder(folder);</span>
<a href="#l126.34"></a><span id="l126.34" class="difflineminus">-  let curMessage = select_click_row(message);</span>
<a href="#l126.35"></a><span id="l126.35" class="difflineplus">+  select_click_row(message);</span>
<a href="#l126.36"></a><span id="l126.36"> </span>
<a href="#l126.37"></a><span id="l126.37" class="difflineminus">-  let value = mc.e(&quot;expanded&quot;+field+&quot;Box&quot;, {tagName: &quot;mail-emailaddress&quot;})</span>
<a href="#l126.38"></a><span id="l126.38" class="difflineplus">+  let value = mc.e(&quot;expanded&quot; + field + &quot;Box&quot;, {tagName: &quot;mail-emailaddress&quot;})</span>
<a href="#l126.39"></a><span id="l126.39">                 .querySelector(&quot;.emaillabel&quot;).value;</span>
<a href="#l126.40"></a><span id="l126.40"> </span>
<a href="#l126.41"></a><span id="l126.41">   if (value != expectedValue)</span>
<a href="#l126.42"></a><span id="l126.42" class="difflineminus">-    throw new Error(&quot;got '&quot;+value+&quot;' but expected '&quot;+expectedValue+&quot;'&quot;);</span>
<a href="#l126.43"></a><span id="l126.43" class="difflineplus">+    throw new Error(&quot;got '&quot; + value + &quot;' but expected '&quot; + expectedValue + &quot;'&quot;);</span>
<a href="#l126.44"></a><span id="l126.44"> }</span>
<a href="#l126.45"></a><span id="l126.45"> </span>
<a href="#l126.46"></a><span id="l126.46"> </span>
<a href="#l126.47"></a><span id="l126.47"> </span>
<a href="#l126.48"></a><span id="l126.48"> function test_single_identity() {</span>
<a href="#l126.49"></a><span id="l126.49">   ensure_no_card_exists(myEmail);</span>
<a href="#l126.50"></a><span id="l126.50">   ensure_single_identity();</span>
<a href="#l126.51"></a><span id="l126.51">   help_test_display_name(0, &quot;to&quot;, headertoFieldMe);</span>
<a href="#l126.52"></a><span id="l126.52" class="difflineat">@@ -119,29 +121,29 @@ function test_single_identity_in_abook_n</span>
<a href="#l126.53"></a><span id="l126.53">   help_test_display_name(0, &quot;to&quot;, headertoFieldMe);</span>
<a href="#l126.54"></a><span id="l126.54"> }</span>
<a href="#l126.55"></a><span id="l126.55"> </span>
<a href="#l126.56"></a><span id="l126.56"> </span>
<a href="#l126.57"></a><span id="l126.57"> </span>
<a href="#l126.58"></a><span id="l126.58"> function test_multiple_identities() {</span>
<a href="#l126.59"></a><span id="l126.59">   ensure_no_card_exists(myEmail);</span>
<a href="#l126.60"></a><span id="l126.60">   ensure_multiple_identities();</span>
<a href="#l126.61"></a><span id="l126.61" class="difflineminus">-  help_test_display_name(0, &quot;to&quot;, headertoFieldMe+&quot; &lt;&quot;+myEmail+&quot;&gt;&quot;);</span>
<a href="#l126.62"></a><span id="l126.62" class="difflineplus">+  help_test_display_name(0, &quot;to&quot;, headertoFieldMe + &quot; &lt;&quot; + myEmail + &quot;&gt;&quot;);</span>
<a href="#l126.63"></a><span id="l126.63"> }</span>
<a href="#l126.64"></a><span id="l126.64"> </span>
<a href="#l126.65"></a><span id="l126.65"> function test_multiple_identities_in_abook() {</span>
<a href="#l126.66"></a><span id="l126.66">   ensure_card_exists(myEmail, &quot;President Frankenstein&quot;, true);</span>
<a href="#l126.67"></a><span id="l126.67">   ensure_multiple_identities();</span>
<a href="#l126.68"></a><span id="l126.68">   help_test_display_name(0, &quot;to&quot;, &quot;President Frankenstein&quot;);</span>
<a href="#l126.69"></a><span id="l126.69"> }</span>
<a href="#l126.70"></a><span id="l126.70"> </span>
<a href="#l126.71"></a><span id="l126.71"> function test_multiple_identities_in_abook_no_pdn() {</span>
<a href="#l126.72"></a><span id="l126.72">   ensure_card_exists(myEmail, &quot;President Frankenstein&quot;);</span>
<a href="#l126.73"></a><span id="l126.73">   ensure_multiple_identities();</span>
<a href="#l126.74"></a><span id="l126.74" class="difflineminus">-  help_test_display_name(0, &quot;to&quot;, headertoFieldMe+&quot; &lt;&quot;+myEmail+&quot;&gt;&quot;);</span>
<a href="#l126.75"></a><span id="l126.75" class="difflineplus">+  help_test_display_name(0, &quot;to&quot;, headertoFieldMe + &quot; &lt;&quot; + myEmail + &quot;&gt;&quot;);</span>
<a href="#l126.76"></a><span id="l126.76"> }</span>
<a href="#l126.77"></a><span id="l126.77"> </span>
<a href="#l126.78"></a><span id="l126.78"> </span>
<a href="#l126.79"></a><span id="l126.79"> </span>
<a href="#l126.80"></a><span id="l126.80"> function test_no_header_name() {</span>
<a href="#l126.81"></a><span id="l126.81">   ensure_no_card_exists(friendEmail);</span>
<a href="#l126.82"></a><span id="l126.82">   ensure_single_identity();</span>
<a href="#l126.83"></a><span id="l126.83">   help_test_display_name(1, &quot;from&quot;, friendEmail);</span>
<a href="#l126.84"></a><span id="l126.84" class="difflineat">@@ -161,17 +163,17 @@ function test_no_header_name_in_abook_no</span>
<a href="#l126.85"></a><span id="l126.85">   help_test_display_name(1, &quot;from&quot;, &quot;carl@sagan.invalid&quot;);</span>
<a href="#l126.86"></a><span id="l126.86"> }</span>
<a href="#l126.87"></a><span id="l126.87"> </span>
<a href="#l126.88"></a><span id="l126.88"> </span>
<a href="#l126.89"></a><span id="l126.89"> </span>
<a href="#l126.90"></a><span id="l126.90"> function test_header_name() {</span>
<a href="#l126.91"></a><span id="l126.91">   ensure_no_card_exists(friendEmail);</span>
<a href="#l126.92"></a><span id="l126.92">   ensure_single_identity();</span>
<a href="#l126.93"></a><span id="l126.93" class="difflineminus">-  help_test_display_name(2, &quot;from&quot;, friendName+&quot; &lt;&quot;+friendEmail+&quot;&gt;&quot;);</span>
<a href="#l126.94"></a><span id="l126.94" class="difflineplus">+  help_test_display_name(2, &quot;from&quot;, friendName + &quot; &lt;&quot; + friendEmail + &quot;&gt;&quot;);</span>
<a href="#l126.95"></a><span id="l126.95"> }</span>
<a href="#l126.96"></a><span id="l126.96"> </span>
<a href="#l126.97"></a><span id="l126.97"> function test_header_name_in_abook() {</span>
<a href="#l126.98"></a><span id="l126.98">   ensure_card_exists(friendEmail, &quot;My Buddy&quot;, true);</span>
<a href="#l126.99"></a><span id="l126.99">   ensure_single_identity();</span>
<a href="#l126.100"></a><span id="l126.100">   help_test_display_name(2, &quot;from&quot;, &quot;My Buddy&quot;);</span>
<a href="#l126.101"></a><span id="l126.101"> }</span>
<a href="#l126.102"></a><span id="l126.102"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l127.1"></a><span id="l127.1" class="difflineminus">--- a/mail/test/mozmill/newmailaccount/test-newmailaccount.js</span>
<a href="#l127.2"></a><span id="l127.2" class="difflineplus">+++ b/mail/test/mozmill/newmailaccount/test-newmailaccount.js</span>
<a href="#l127.3"></a><span id="l127.3" class="difflineat">@@ -3,34 +3,42 @@</span>
<a href="#l127.4"></a><span id="l127.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l127.5"></a><span id="l127.5"> </span>
<a href="#l127.6"></a><span id="l127.6"> /**</span>
<a href="#l127.7"></a><span id="l127.7">  * Tests the get an account (account provisioning) workflow.</span>
<a href="#l127.8"></a><span id="l127.8">  */</span>
<a href="#l127.9"></a><span id="l127.9"> </span>
<a href="#l127.10"></a><span id="l127.10"> &quot;use strict&quot;;</span>
<a href="#l127.11"></a><span id="l127.11"> </span>
<a href="#l127.12"></a><span id="l127.12" class="difflineminus">-var MODULE_NAME = 'test-newmailaccount';</span>
<a href="#l127.13"></a><span id="l127.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l127.14"></a><span id="l127.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l127.15"></a><span id="l127.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l127.16"></a><span id="l127.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-newmailaccount-helpers.js */</span>
<a href="#l127.17"></a><span id="l127.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-keyboard-helpers.js */</span>
<a href="#l127.18"></a><span id="l127.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-dom-helpers.js */</span>
<a href="#l127.19"></a><span id="l127.19"> </span>
<a href="#l127.20"></a><span id="l127.20" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l127.21"></a><span id="l127.21" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l127.22"></a><span id="l127.22" class="difflineminus">-                       'content-tab-helpers',</span>
<a href="#l127.23"></a><span id="l127.23" class="difflineminus">-                       'window-helpers',</span>
<a href="#l127.24"></a><span id="l127.24" class="difflineminus">-                       'newmailaccount-helpers',</span>
<a href="#l127.25"></a><span id="l127.25" class="difflineminus">-                       'keyboard-helpers',</span>
<a href="#l127.26"></a><span id="l127.26" class="difflineminus">-                       'dom-helpers'];</span>
<a href="#l127.27"></a><span id="l127.27" class="difflineplus">+var MODULE_NAME = &quot;test-newmailaccount&quot;;</span>
<a href="#l127.28"></a><span id="l127.28" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l127.29"></a><span id="l127.29" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l127.30"></a><span id="l127.30" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l127.31"></a><span id="l127.31" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l127.32"></a><span id="l127.32" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l127.33"></a><span id="l127.33" class="difflineplus">+  &quot;newmailaccount-helpers&quot;,</span>
<a href="#l127.34"></a><span id="l127.34" class="difflineplus">+  &quot;keyboard-helpers&quot;,</span>
<a href="#l127.35"></a><span id="l127.35" class="difflineplus">+  &quot;dom-helpers&quot;,</span>
<a href="#l127.36"></a><span id="l127.36" class="difflineplus">+];</span>
<a href="#l127.37"></a><span id="l127.37"> </span>
<a href="#l127.38"></a><span id="l127.38"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l127.39"></a><span id="l127.39"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l127.40"></a><span id="l127.40"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l127.41"></a><span id="l127.41"> var {HttpServer} = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/httpd.jsm&quot;);</span>
<a href="#l127.42"></a><span id="l127.42"> </span>
<a href="#l127.43"></a><span id="l127.43"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l127.44"></a><span id="l127.44"> // so we get the right path for the resources.</span>
<a href="#l127.45"></a><span id="l127.45" class="difflineminus">-var url = collector.addHttpResource('../newmailaccount/html', '');</span>
<a href="#l127.46"></a><span id="l127.46" class="difflineplus">+var url = collector.addHttpResource(&quot;../newmailaccount/html&quot;, &quot;&quot;);</span>
<a href="#l127.47"></a><span id="l127.47"> var kProvisionerUrl = &quot;chrome://messenger/content/newmailaccount/accountProvisioner.xhtml&quot;;</span>
<a href="#l127.48"></a><span id="l127.48"> var kProvisionerEnabledPref = &quot;mail.provider.enabled&quot;;</span>
<a href="#l127.49"></a><span id="l127.49"> var kSuggestFromNamePref = &quot;mail.provider.suggestFromName&quot;;</span>
<a href="#l127.50"></a><span id="l127.50"> var kProviderListPref = &quot;mail.provider.providerList&quot;;</span>
<a href="#l127.51"></a><span id="l127.51"> var kDefaultServerPort = 4444;</span>
<a href="#l127.52"></a><span id="l127.52"> var kDefaultServerRoot = &quot;http://localhost:&quot; + kDefaultServerPort;</span>
<a href="#l127.53"></a><span id="l127.53"> </span>
<a href="#l127.54"></a><span id="l127.54"> Services.prefs.setCharPref(kProviderListPref, url + &quot;providerList&quot;);</span>
<a href="#l127.55"></a><span id="l127.55" class="difflineat">@@ -38,37 +46,33 @@ Services.prefs.setCharPref(kSuggestFromN</span>
<a href="#l127.56"></a><span id="l127.56"> </span>
<a href="#l127.57"></a><span id="l127.57"> // Here's a name that we'll type in later on.  It's a global const because</span>
<a href="#l127.58"></a><span id="l127.58"> // we'll be using it in several distinct modal dialog event loops.</span>
<a href="#l127.59"></a><span id="l127.59"> var NAME = &quot;Leonard Shelby&quot;;</span>
<a href="#l127.60"></a><span id="l127.60"> </span>
<a href="#l127.61"></a><span id="l127.61"> // Record what the original value of the mail.provider.enabled pref is so</span>
<a href="#l127.62"></a><span id="l127.62"> // that we can put it back once the tests are done.</span>
<a href="#l127.63"></a><span id="l127.63"> var gProvisionerEnabled = Services.prefs.getBoolPref(kProvisionerEnabledPref);</span>
<a href="#l127.64"></a><span id="l127.64" class="difflineminus">-</span>
<a href="#l127.65"></a><span id="l127.65" class="difflineminus">-// Record what the original value of the mail.provider.enabled pref is so</span>
<a href="#l127.66"></a><span id="l127.66" class="difflineminus">-// that we can put it back once the tests are done.</span>
<a href="#l127.67"></a><span id="l127.67" class="difflineminus">-var gProvisionerEnabled = Services.prefs.getBoolPref(kProvisionerEnabledPref);</span>
<a href="#l127.68"></a><span id="l127.68"> var gOldAcceptLangs = Services.locale.requestedLocales;</span>
<a href="#l127.69"></a><span id="l127.69"> var gNumAccounts;</span>
<a href="#l127.70"></a><span id="l127.70"> </span>
<a href="#l127.71"></a><span id="l127.71"> function setupModule(module) {</span>
<a href="#l127.72"></a><span id="l127.72">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l127.73"></a><span id="l127.73">     collector.getModule(lib).installInto(module);</span>
<a href="#l127.74"></a><span id="l127.74">   }</span>
<a href="#l127.75"></a><span id="l127.75"> </span>
<a href="#l127.76"></a><span id="l127.76">   // Make sure we enable the Account Provisioner.</span>
<a href="#l127.77"></a><span id="l127.77">   Services.prefs.setBoolPref(kProvisionerEnabledPref, true);</span>
<a href="#l127.78"></a><span id="l127.78">   // Restrict the user's language to just en-US</span>
<a href="#l127.79"></a><span id="l127.79">   Services.locale.requestedLocales = [&quot;en-US&quot;];</span>
<a href="#l127.80"></a><span id="l127.80"> </span>
<a href="#l127.81"></a><span id="l127.81">   // Add a &quot;bar&quot; search engine that we can switch to be the default.</span>
<a href="#l127.82"></a><span id="l127.82">   Services.search.addEngineWithDetails(&quot;bar&quot;, null, null, null, &quot;post&quot;,</span>
<a href="#l127.83"></a><span id="l127.83">                                        &quot;http://www.example.com/search&quot;);</span>
<a href="#l127.84"></a><span id="l127.84" class="difflineminus">-};</span>
<a href="#l127.85"></a><span id="l127.85" class="difflineplus">+}</span>
<a href="#l127.86"></a><span id="l127.86"> </span>
<a href="#l127.87"></a><span id="l127.87"> function teardownModule(module) {</span>
<a href="#l127.88"></a><span id="l127.88">   // Put the mail.provider.enabled pref back the way it was.</span>
<a href="#l127.89"></a><span id="l127.89">   Services.prefs.setBoolPref(kProvisionerEnabledPref, gProvisionerEnabled);</span>
<a href="#l127.90"></a><span id="l127.90">   // And same with the user languages</span>
<a href="#l127.91"></a><span id="l127.91">   Services.locale.requestedLocales = gOldAcceptLangs;</span>
<a href="#l127.92"></a><span id="l127.92"> }</span>
<a href="#l127.93"></a><span id="l127.93"> </span>
<a href="#l127.94"></a><span id="l127.94" class="difflineat">@@ -101,28 +105,28 @@ function test_get_an_account(aCloseAndRe</span>
<a href="#l127.95"></a><span id="l127.95">   plan_for_modal_dialog(&quot;AccountCreation&quot;, subtest_get_an_account);</span>
<a href="#l127.96"></a><span id="l127.96">   open_provisioner_window();</span>
<a href="#l127.97"></a><span id="l127.97">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l127.98"></a><span id="l127.98"> </span>
<a href="#l127.99"></a><span id="l127.99">   // Once we're here, subtest_get_an_account has completed, and we're waiting</span>
<a href="#l127.100"></a><span id="l127.100">   // for a content tab to load for the account order form.</span>
<a href="#l127.101"></a><span id="l127.101"> </span>
<a href="#l127.102"></a><span id="l127.102">   // Make sure the page is loaded.</span>
<a href="#l127.103"></a><span id="l127.103" class="difflineminus">-  wait_for_content_tab_load(undefined, function (aURL) {</span>
<a href="#l127.104"></a><span id="l127.104" class="difflineplus">+  wait_for_content_tab_load(undefined, function(aURL) {</span>
<a href="#l127.105"></a><span id="l127.105">     return aURL.host == &quot;localhost&quot;;</span>
<a href="#l127.106"></a><span id="l127.106">   });</span>
<a href="#l127.107"></a><span id="l127.107"> </span>
<a href="#l127.108"></a><span id="l127.108">   let tab = mc.tabmail.currentTabInfo;</span>
<a href="#l127.109"></a><span id="l127.109"> </span>
<a href="#l127.110"></a><span id="l127.110">   if (aCloseAndRestore) {</span>
<a href="#l127.111"></a><span id="l127.111">     // Close the account provisioner tab, and then restore it...</span>
<a href="#l127.112"></a><span id="l127.112">     mc.tabmail.closeTab(mc.tabmail.currentTabInfo);</span>
<a href="#l127.113"></a><span id="l127.113">     mc.tabmail.undoCloseTab();</span>
<a href="#l127.114"></a><span id="l127.114">     // Wait for the page to be loaded again...</span>
<a href="#l127.115"></a><span id="l127.115" class="difflineminus">-    wait_for_content_tab_load(undefined, function (aURL) {</span>
<a href="#l127.116"></a><span id="l127.116" class="difflineplus">+    wait_for_content_tab_load(undefined, function(aURL) {</span>
<a href="#l127.117"></a><span id="l127.117">       return aURL.host == &quot;localhost&quot;;</span>
<a href="#l127.118"></a><span id="l127.118">     });</span>
<a href="#l127.119"></a><span id="l127.119">     tab = mc.tabmail.currentTabInfo;</span>
<a href="#l127.120"></a><span id="l127.120">   }</span>
<a href="#l127.121"></a><span id="l127.121"> </span>
<a href="#l127.122"></a><span id="l127.122">   // Record how many accounts we start with.</span>
<a href="#l127.123"></a><span id="l127.123">   gNumAccounts = nAccounts();</span>
<a href="#l127.124"></a><span id="l127.124"> </span>
<a href="#l127.125"></a><span id="l127.125" class="difflineat">@@ -334,17 +338,17 @@ function test_flip_flop_from_provisioner</span>
<a href="#l127.126"></a><span id="l127.126">  * This function is used by test_flip_flop_from_provisioner_menuitem to switch</span>
<a href="#l127.127"></a><span id="l127.127">  * back from the account provisioner to the wizard.</span>
<a href="#l127.128"></a><span id="l127.128">  */</span>
<a href="#l127.129"></a><span id="l127.129"> function subtest_flip_flop_from_provisioner_menuitem(w) {</span>
<a href="#l127.130"></a><span id="l127.130">   // We need to wait for the wizard to be closed, or else</span>
<a href="#l127.131"></a><span id="l127.131">   // it'll try to refocus when we click on the button to</span>
<a href="#l127.132"></a><span id="l127.132">   // open it.</span>
<a href="#l127.133"></a><span id="l127.133">   wait_for_the_wizard_to_be_closed(w);</span>
<a href="#l127.134"></a><span id="l127.134" class="difflineminus">-  plan_for_window_close(w)</span>
<a href="#l127.135"></a><span id="l127.135" class="difflineplus">+  plan_for_window_close(w);</span>
<a href="#l127.136"></a><span id="l127.136">   mc.click(new elib.Elem(w.window.document.querySelector(&quot;.existing&quot;)));</span>
<a href="#l127.137"></a><span id="l127.137">   wait_for_window_close();</span>
<a href="#l127.138"></a><span id="l127.138"> }</span>
<a href="#l127.139"></a><span id="l127.139"> </span>
<a href="#l127.140"></a><span id="l127.140"> /**</span>
<a href="#l127.141"></a><span id="l127.141">  * This function is used by test_flip_flop_from_provisioner_menuitem to close</span>
<a href="#l127.142"></a><span id="l127.142">  * the provisioner.</span>
<a href="#l127.143"></a><span id="l127.143">  */</span>
<a href="#l127.144"></a><span id="l127.144" class="difflineat">@@ -465,67 +469,66 @@ function test_show_tos_privacy_links_for</span>
<a href="#l127.145"></a><span id="l127.145">  * appropriate terms of service and privacy links are shown.</span>
<a href="#l127.146"></a><span id="l127.146">  */</span>
<a href="#l127.147"></a><span id="l127.147"> function subtest_show_tos_privacy_links_for_selected_providers(w) {</span>
<a href="#l127.148"></a><span id="l127.148">   wait_for_provider_list_loaded(w);</span>
<a href="#l127.149"></a><span id="l127.149"> </span>
<a href="#l127.150"></a><span id="l127.150">   // We should be showing the TOS and Privacy links for the selected</span>
<a href="#l127.151"></a><span id="l127.151">   // providers immediately after the providers have been loaded.</span>
<a href="#l127.152"></a><span id="l127.152">   // Those providers should be &quot;foo&quot; and &quot;bar&quot;.</span>
<a href="#l127.153"></a><span id="l127.153" class="difflineminus">-  assert_links_shown(w, ['http://www.example.com/foo-tos',</span>
<a href="#l127.154"></a><span id="l127.154" class="difflineminus">-                         'http://www.example.com/foo-privacy',</span>
<a href="#l127.155"></a><span id="l127.155" class="difflineminus">-                         'http://www.example.com/bar-tos',</span>
<a href="#l127.156"></a><span id="l127.156" class="difflineminus">-                         'http://www.example.com/bar-privacy',]);</span>
<a href="#l127.157"></a><span id="l127.157" class="difflineplus">+  assert_links_shown(w, [&quot;http://www.example.com/foo-tos&quot;,</span>
<a href="#l127.158"></a><span id="l127.158" class="difflineplus">+                         &quot;http://www.example.com/foo-privacy&quot;,</span>
<a href="#l127.159"></a><span id="l127.159" class="difflineplus">+                         &quot;http://www.example.com/bar-tos&quot;,</span>
<a href="#l127.160"></a><span id="l127.160" class="difflineplus">+                         &quot;http://www.example.com/bar-privacy&quot;]);</span>
<a href="#l127.161"></a><span id="l127.161"> </span>
<a href="#l127.162"></a><span id="l127.162" class="difflineminus">-  assert_links_not_shown(w, ['http://www.example.com/French-tos',</span>
<a href="#l127.163"></a><span id="l127.163" class="difflineminus">-                             'http://www.example.com/French-privacy']);</span>
<a href="#l127.164"></a><span id="l127.164" class="difflineplus">+  assert_links_not_shown(w, [&quot;http://www.example.com/French-tos&quot;,</span>
<a href="#l127.165"></a><span id="l127.165" class="difflineplus">+                             &quot;http://www.example.com/French-privacy&quot;]);</span>
<a href="#l127.166"></a><span id="l127.166"> </span>
<a href="#l127.167"></a><span id="l127.167">   // Now click off one of those providers - we shouldn't be displaying</span>
<a href="#l127.168"></a><span id="l127.168">   // and links for that one now.</span>
<a href="#l127.169"></a><span id="l127.169">   let input = w.window.document.querySelector('input[type=&quot;checkbox&quot;][value=&quot;foo&quot;]');</span>
<a href="#l127.170"></a><span id="l127.170">   w.click(new elib.Elem(input));</span>
<a href="#l127.171"></a><span id="l127.171"> </span>
<a href="#l127.172"></a><span id="l127.172" class="difflineminus">-  assert_links_not_shown(w, ['http://www.example.com/foo-tos',</span>
<a href="#l127.173"></a><span id="l127.173" class="difflineminus">-                             'http://www.example.com/foo-privacy',]);</span>
<a href="#l127.174"></a><span id="l127.174" class="difflineplus">+  assert_links_not_shown(w, [&quot;http://www.example.com/foo-tos&quot;,</span>
<a href="#l127.175"></a><span id="l127.175" class="difflineplus">+                             &quot;http://www.example.com/foo-privacy&quot;]);</span>
<a href="#l127.176"></a><span id="l127.176"> </span>
<a href="#l127.177"></a><span id="l127.177">   // Ensure that the &quot;Other languages&quot; div is visible</span>
<a href="#l127.178"></a><span id="l127.178">   wait_for_element_visible(w, &quot;otherLangDesc&quot;);</span>
<a href="#l127.179"></a><span id="l127.179">   // Now show the providers from different locales...</span>
<a href="#l127.180"></a><span id="l127.180">   w.click(w.eid(&quot;otherLangDesc&quot;));</span>
<a href="#l127.181"></a><span id="l127.181">   wait_for_element_invisible(w, &quot;otherLangDesc&quot;);</span>
<a href="#l127.182"></a><span id="l127.182"> </span>
<a href="#l127.183"></a><span id="l127.183">   // And click on one of those providers...</span>
<a href="#l127.184"></a><span id="l127.184">   input = w.window.document.querySelector('input[type=&quot;checkbox&quot;][value=&quot;French&quot;]');</span>
<a href="#l127.185"></a><span id="l127.185">   w.click(new elib.Elem(input));</span>
<a href="#l127.186"></a><span id="l127.186">   // We should be showing the French TOS / Privacy links, along</span>
<a href="#l127.187"></a><span id="l127.187">   // with those from the bar provider.</span>
<a href="#l127.188"></a><span id="l127.188" class="difflineminus">-  assert_links_shown(w, ['http://www.example.com/French-tos',</span>
<a href="#l127.189"></a><span id="l127.189" class="difflineminus">-                         'http://www.example.com/French-privacy',</span>
<a href="#l127.190"></a><span id="l127.190" class="difflineminus">-                         'http://www.example.com/bar-tos',</span>
<a href="#l127.191"></a><span id="l127.191" class="difflineminus">-                         'http://www.example.com/bar-privacy']);</span>
<a href="#l127.192"></a><span id="l127.192" class="difflineplus">+  assert_links_shown(w, [&quot;http://www.example.com/French-tos&quot;,</span>
<a href="#l127.193"></a><span id="l127.193" class="difflineplus">+                         &quot;http://www.example.com/French-privacy&quot;,</span>
<a href="#l127.194"></a><span id="l127.194" class="difflineplus">+                         &quot;http://www.example.com/bar-tos&quot;,</span>
<a href="#l127.195"></a><span id="l127.195" class="difflineplus">+                         &quot;http://www.example.com/bar-privacy&quot;]);</span>
<a href="#l127.196"></a><span id="l127.196"> </span>
<a href="#l127.197"></a><span id="l127.197">   // The foo provider should still have it's links hidden.</span>
<a href="#l127.198"></a><span id="l127.198" class="difflineminus">-  assert_links_not_shown(w, ['http://www.example.com/foo-tos',</span>
<a href="#l127.199"></a><span id="l127.199" class="difflineminus">-                             'http://www.example.com/foo-privacy',]);</span>
<a href="#l127.200"></a><span id="l127.200" class="difflineplus">+  assert_links_not_shown(w, [&quot;http://www.example.com/foo-tos&quot;,</span>
<a href="#l127.201"></a><span id="l127.201" class="difflineplus">+                             &quot;http://www.example.com/foo-privacy&quot;]);</span>
<a href="#l127.202"></a><span id="l127.202"> </span>
<a href="#l127.203"></a><span id="l127.203">   // Click on the German provider.  It's links should now be</span>
<a href="#l127.204"></a><span id="l127.204">   // shown, along with the French and bar providers.</span>
<a href="#l127.205"></a><span id="l127.205">   input = w.window.document.querySelector('input[type=&quot;checkbox&quot;][value=&quot;German&quot;]');</span>
<a href="#l127.206"></a><span id="l127.206">   w.click(new elib.Elem(input));</span>
<a href="#l127.207"></a><span id="l127.207" class="difflineminus">-  assert_links_shown(w, ['http://www.example.com/French-tos',</span>
<a href="#l127.208"></a><span id="l127.208" class="difflineminus">-                         'http://www.example.com/French-privacy',</span>
<a href="#l127.209"></a><span id="l127.209" class="difflineminus">-                         'http://www.example.com/bar-tos',</span>
<a href="#l127.210"></a><span id="l127.210" class="difflineminus">-                         'http://www.example.com/bar-privacy',</span>
<a href="#l127.211"></a><span id="l127.211" class="difflineminus">-                         'http://www.example.com/German-tos',</span>
<a href="#l127.212"></a><span id="l127.212" class="difflineminus">-                         'http://www.example.com/German-privacy']);</span>
<a href="#l127.213"></a><span id="l127.213" class="difflineplus">+  assert_links_shown(w, [&quot;http://www.example.com/French-tos&quot;,</span>
<a href="#l127.214"></a><span id="l127.214" class="difflineplus">+                         &quot;http://www.example.com/French-privacy&quot;,</span>
<a href="#l127.215"></a><span id="l127.215" class="difflineplus">+                         &quot;http://www.example.com/bar-tos&quot;,</span>
<a href="#l127.216"></a><span id="l127.216" class="difflineplus">+                         &quot;http://www.example.com/bar-privacy&quot;,</span>
<a href="#l127.217"></a><span id="l127.217" class="difflineplus">+                         &quot;http://www.example.com/German-tos&quot;,</span>
<a href="#l127.218"></a><span id="l127.218" class="difflineplus">+                         &quot;http://www.example.com/German-privacy&quot;]);</span>
<a href="#l127.219"></a><span id="l127.219"> </span>
<a href="#l127.220"></a><span id="l127.220">   // And the foo links should still be hidden.</span>
<a href="#l127.221"></a><span id="l127.221" class="difflineminus">-  assert_links_not_shown(w, ['http://www.example.com/foo-tos',</span>
<a href="#l127.222"></a><span id="l127.222" class="difflineminus">-                             'http://www.example.com/foo-privacy',]);</span>
<a href="#l127.223"></a><span id="l127.223" class="difflineminus">-</span>
<a href="#l127.224"></a><span id="l127.224" class="difflineplus">+  assert_links_not_shown(w, [&quot;http://www.example.com/foo-tos&quot;,</span>
<a href="#l127.225"></a><span id="l127.225" class="difflineplus">+                             &quot;http://www.example.com/foo-privacy&quot;]);</span>
<a href="#l127.226"></a><span id="l127.226"> }</span>
<a href="#l127.227"></a><span id="l127.227"> </span>
<a href="#l127.228"></a><span id="l127.228"> /**</span>
<a href="#l127.229"></a><span id="l127.229">  * Test that if the search goes bad on the server-side, that we show an</span>
<a href="#l127.230"></a><span id="l127.230">  * error.</span>
<a href="#l127.231"></a><span id="l127.231">  */</span>
<a href="#l127.232"></a><span id="l127.232"> function test_shows_error_on_bad_suggest_from_name() {</span>
<a href="#l127.233"></a><span id="l127.233">   let original = Services.prefs.getCharPref(kSuggestFromNamePref);</span>
<a href="#l127.234"></a><span id="l127.234" class="difflineat">@@ -693,18 +696,18 @@ function test_search_button_disabled_cas</span>
<a href="#l127.235"></a><span id="l127.235"> function subtest_search_button_disabled_cases(w) {</span>
<a href="#l127.236"></a><span id="l127.236">   wait_for_provider_list_loaded(w);</span>
<a href="#l127.237"></a><span id="l127.237">   let searchInput = w.eid(&quot;name&quot;);</span>
<a href="#l127.238"></a><span id="l127.238">   // Case 1:  Search input empty, some providers selected.</span>
<a href="#l127.239"></a><span id="l127.239"> </span>
<a href="#l127.240"></a><span id="l127.240">   // Empty any strings in the search input.  Select all of the input with</span>
<a href="#l127.241"></a><span id="l127.241">   // Ctrl-A, and then hit backspace.</span>
<a href="#l127.242"></a><span id="l127.242">   searchInput.getNode().focus();</span>
<a href="#l127.243"></a><span id="l127.243" class="difflineminus">-  w.keypress(null, 'a', {accelKey: true});</span>
<a href="#l127.244"></a><span id="l127.244" class="difflineminus">-  w.keypress(null, 'VK_BACK_SPACE', {});</span>
<a href="#l127.245"></a><span id="l127.245" class="difflineplus">+  w.keypress(null, &quot;a&quot;, {accelKey: true});</span>
<a href="#l127.246"></a><span id="l127.246" class="difflineplus">+  w.keypress(null, &quot;VK_BACK_SPACE&quot;, {});</span>
<a href="#l127.247"></a><span id="l127.247"> </span>
<a href="#l127.248"></a><span id="l127.248">   // Make sure at least one provider is checked</span>
<a href="#l127.249"></a><span id="l127.249">   let input = w.window.document.querySelector('input[type=&quot;checkbox&quot;]:checked');</span>
<a href="#l127.250"></a><span id="l127.250">   w.click(new elib.Elem(input));</span>
<a href="#l127.251"></a><span id="l127.251">   input = w.window.document.querySelector('input[type=&quot;checkbox&quot;][value=&quot;foo&quot;]');</span>
<a href="#l127.252"></a><span id="l127.252">   w.click(new elib.Elem(input));</span>
<a href="#l127.253"></a><span id="l127.253"> </span>
<a href="#l127.254"></a><span id="l127.254">   // The search submit button should become disabled</span>
<a href="#l127.255"></a><span id="l127.255" class="difflineat">@@ -735,18 +738,18 @@ function subtest_search_button_disabled_</span>
<a href="#l127.256"></a><span id="l127.256">   input = w.window.document.querySelector('input[type=&quot;checkbox&quot;][value=&quot;foo&quot;]');</span>
<a href="#l127.257"></a><span id="l127.257">   w.click(new elib.Elem(input));</span>
<a href="#l127.258"></a><span id="l127.258">   wait_for_element_enabled(w, w.e(&quot;searchSubmit&quot;), true);</span>
<a href="#l127.259"></a><span id="l127.259"> </span>
<a href="#l127.260"></a><span id="l127.260">   // Case 4:  Search input has no text, and no providers are</span>
<a href="#l127.261"></a><span id="l127.261">   // selected.</span>
<a href="#l127.262"></a><span id="l127.262"> </span>
<a href="#l127.263"></a><span id="l127.263">   // Clear out the search input</span>
<a href="#l127.264"></a><span id="l127.264" class="difflineminus">-  w.keypress(null, 'a', {accelKey: true});</span>
<a href="#l127.265"></a><span id="l127.265" class="difflineminus">-  w.keypress(null, 'VK_BACK_SPACE', {});</span>
<a href="#l127.266"></a><span id="l127.266" class="difflineplus">+  w.keypress(null, &quot;a&quot;, {accelKey: true});</span>
<a href="#l127.267"></a><span id="l127.267" class="difflineplus">+  w.keypress(null, &quot;VK_BACK_SPACE&quot;, {});</span>
<a href="#l127.268"></a><span id="l127.268">   input = w.window.document.querySelector('input[type=&quot;checkbox&quot;]:checked');</span>
<a href="#l127.269"></a><span id="l127.269">   w.click(new elib.Elem(input));</span>
<a href="#l127.270"></a><span id="l127.270"> </span>
<a href="#l127.271"></a><span id="l127.271">   wait_for_element_enabled(w, w.e(&quot;searchSubmit&quot;), false);</span>
<a href="#l127.272"></a><span id="l127.272"> }</span>
<a href="#l127.273"></a><span id="l127.273"> </span>
<a href="#l127.274"></a><span id="l127.274"> /**</span>
<a href="#l127.275"></a><span id="l127.275">  * Tests that when we pref off the Account Provisioner, the menuitem for it</span>
<a href="#l127.276"></a><span id="l127.276" class="difflineat">@@ -823,17 +826,17 @@ function test_can_pref_off_account_provi</span>
<a href="#l127.277"></a><span id="l127.277">   // Alright, close up.</span>
<a href="#l127.278"></a><span id="l127.278">   close_window(wizard);</span>
<a href="#l127.279"></a><span id="l127.279"> </span>
<a href="#l127.280"></a><span id="l127.280">   // And finally restore the menu to the way it was.</span>
<a href="#l127.281"></a><span id="l127.281">   newMenuPopup.getNode().allowevents = oldAllowEvents;</span>
<a href="#l127.282"></a><span id="l127.282"> }</span>
<a href="#l127.283"></a><span id="l127.283"> </span>
<a href="#l127.284"></a><span id="l127.284"> // We cannot control menus via Mozmill in OSX, so we'll skip this test.</span>
<a href="#l127.285"></a><span id="l127.285" class="difflineminus">-test_can_pref_off_account_provisioner.EXCLUDED_PLATFORMS = ['darwin'];</span>
<a href="#l127.286"></a><span id="l127.286" class="difflineplus">+test_can_pref_off_account_provisioner.EXCLUDED_PLATFORMS = [&quot;darwin&quot;];</span>
<a href="#l127.287"></a><span id="l127.287"> </span>
<a href="#l127.288"></a><span id="l127.288"> /**</span>
<a href="#l127.289"></a><span id="l127.289">  * Tests that if we load a provider list that does not include providers in</span>
<a href="#l127.290"></a><span id="l127.290">  * other languages, then the &quot;show me providers in other languages&quot; link is</span>
<a href="#l127.291"></a><span id="l127.291">  * hidden.</span>
<a href="#l127.292"></a><span id="l127.292">  */</span>
<a href="#l127.293"></a><span id="l127.293"> function test_other_lang_link_hides() {</span>
<a href="#l127.294"></a><span id="l127.294">   let original = Services.prefs.getCharPref(kProviderListPref);</span>
<a href="#l127.295"></a><span id="l127.295" class="difflineat">@@ -869,17 +872,17 @@ function get_to_order_form(aAddress) {</span>
<a href="#l127.296"></a><span id="l127.296">   });</span>
<a href="#l127.297"></a><span id="l127.297">   open_provisioner_window();</span>
<a href="#l127.298"></a><span id="l127.298">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l127.299"></a><span id="l127.299"> </span>
<a href="#l127.300"></a><span id="l127.300">   // Once we're here, subtest_get_an_account has completed, and we're waiting</span>
<a href="#l127.301"></a><span id="l127.301">   // for a content tab to load for the account order form.</span>
<a href="#l127.302"></a><span id="l127.302"> </span>
<a href="#l127.303"></a><span id="l127.303">   // Make sure the page is loaded.</span>
<a href="#l127.304"></a><span id="l127.304" class="difflineminus">-  wait_for_content_tab_load(undefined, function (aURL) {</span>
<a href="#l127.305"></a><span id="l127.305" class="difflineplus">+  wait_for_content_tab_load(undefined, function(aURL) {</span>
<a href="#l127.306"></a><span id="l127.306">     return aURL.host == &quot;localhost&quot;;</span>
<a href="#l127.307"></a><span id="l127.307">   });</span>
<a href="#l127.308"></a><span id="l127.308"> }</span>
<a href="#l127.309"></a><span id="l127.309"> </span>
<a href="#l127.310"></a><span id="l127.310"> /**</span>
<a href="#l127.311"></a><span id="l127.311">  * Fills in the Account Provisioner dialog to get us to the order form.</span>
<a href="#l127.312"></a><span id="l127.312">  */</span>
<a href="#l127.313"></a><span id="l127.313"> function sub_get_to_order_form(aController, aAddress) {</span>
<a href="#l127.314"></a><span id="l127.314" class="difflineat">@@ -990,17 +993,16 @@ function test_external_link_opening_beha</span>
<a href="#l127.315"></a><span id="l127.315">  * then we error out and go back to the Account Provisioner dialog.</span>
<a href="#l127.316"></a><span id="l127.316">  */</span>
<a href="#l127.317"></a><span id="l127.317"> function test_return_to_provisioner_on_error_XML() {</span>
<a href="#l127.318"></a><span id="l127.318">   const kOriginalTabNum = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l127.319"></a><span id="l127.319"> </span>
<a href="#l127.320"></a><span id="l127.320">   get_to_order_form(&quot;error@error.invalid&quot;);</span>
<a href="#l127.321"></a><span id="l127.321"> </span>
<a href="#l127.322"></a><span id="l127.322">   let tab = mc.tabmail.currentTabInfo;</span>
<a href="#l127.323"></a><span id="l127.323" class="difflineminus">-  let doc = tab.browser.contentWindow.document;</span>
<a href="#l127.324"></a><span id="l127.324"> </span>
<a href="#l127.325"></a><span id="l127.325">   plan_for_modal_dialog(&quot;AccountCreation&quot;, close_dialog_immediately);</span>
<a href="#l127.326"></a><span id="l127.326"> </span>
<a href="#l127.327"></a><span id="l127.327">   // Click the OK button to order the account.</span>
<a href="#l127.328"></a><span id="l127.328">   let btn = tab.browser.contentWindow.document.querySelector(&quot;input[value=Send]&quot;);</span>
<a href="#l127.329"></a><span id="l127.329">   mc.click(new elib.Elem(btn));</span>
<a href="#l127.330"></a><span id="l127.330"> </span>
<a href="#l127.331"></a><span id="l127.331">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l127.332"></a><span id="l127.332" class="difflineat">@@ -1039,32 +1041,32 @@ function subtest_disabled_fields_when_se</span>
<a href="#l127.333"></a><span id="l127.333">     aResponse.processAsync();</span>
<a href="#l127.334"></a><span id="l127.334">     timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l127.335"></a><span id="l127.335">     let result = [{</span>
<a href="#l127.336"></a><span id="l127.336">       product: &quot;personalized_email&quot;,</span>
<a href="#l127.337"></a><span id="l127.337">       addresses: [&quot;green@example.com&quot;, &quot;green_llama@example.com&quot;],</span>
<a href="#l127.338"></a><span id="l127.338">       succeeded: true,</span>
<a href="#l127.339"></a><span id="l127.339">       quote: &quot;b28acb3c0a474d33af22&quot;,</span>
<a href="#l127.340"></a><span id="l127.340">       price: 0,</span>
<a href="#l127.341"></a><span id="l127.341" class="difflineminus">-      provider: &quot;bar&quot;</span>
<a href="#l127.342"></a><span id="l127.342" class="difflineplus">+      provider: &quot;bar&quot;,</span>
<a href="#l127.343"></a><span id="l127.343">     }];</span>
<a href="#l127.344"></a><span id="l127.344">     let timerEvent = {</span>
<a href="#l127.345"></a><span id="l127.345" class="difflineminus">-      notify: function(aTimer) {</span>
<a href="#l127.346"></a><span id="l127.346" class="difflineplus">+      notify(aTimer) {</span>
<a href="#l127.347"></a><span id="l127.347">         aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l127.348"></a><span id="l127.348">         aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l127.349"></a><span id="l127.349">         aResponse.write(JSON.stringify(result));</span>
<a href="#l127.350"></a><span id="l127.350">         aResponse.finish();</span>
<a href="#l127.351"></a><span id="l127.351" class="difflineminus">-      }</span>
<a href="#l127.352"></a><span id="l127.352" class="difflineplus">+      },</span>
<a href="#l127.353"></a><span id="l127.353">     };</span>
<a href="#l127.354"></a><span id="l127.354">     timer.initWithCallback(timerEvent, kSearchMSeconds,</span>
<a href="#l127.355"></a><span id="l127.355">                            Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l127.356"></a><span id="l127.356">   }</span>
<a href="#l127.357"></a><span id="l127.357"> </span>
<a href="#l127.358"></a><span id="l127.358">   // Set up a mock HTTP server to serve up a super slow search...</span>
<a href="#l127.359"></a><span id="l127.359" class="difflineminus">-  let server = new HttpServer();;</span>
<a href="#l127.360"></a><span id="l127.360" class="difflineplus">+  let server = new HttpServer();</span>
<a href="#l127.361"></a><span id="l127.361">   server.registerPathHandler(kSuggestPath, slow_results);</span>
<a href="#l127.362"></a><span id="l127.362">   server.start(kDefaultServerPort);</span>
<a href="#l127.363"></a><span id="l127.363"> </span>
<a href="#l127.364"></a><span id="l127.364">   // Now point our suggestFromName pref at that slow server.</span>
<a href="#l127.365"></a><span id="l127.365">   let originalSuggest = Services.prefs.getCharPref(kSuggestFromNamePref);</span>
<a href="#l127.366"></a><span id="l127.366">   Services.prefs.setCharPref(kSuggestFromNamePref,</span>
<a href="#l127.367"></a><span id="l127.367">                              kDefaultServerRoot + kSuggestPath);</span>
<a href="#l127.368"></a><span id="l127.368"> </span>
<a href="#l127.369"></a><span id="l127.369" class="difflineat">@@ -1177,17 +1179,16 @@ function test_provider_language_wildcard</span>
<a href="#l127.370"></a><span id="l127.370"> </span>
<a href="#l127.371"></a><span id="l127.371"> /**</span>
<a href="#l127.372"></a><span id="l127.372">  * Subtest used by test_provider_language_wildcard, ensures that the</span>
<a href="#l127.373"></a><span id="l127.373">  * &quot;Universal&quot; and &quot;OtherUniversal&quot; providers are displayed, but the French</span>
<a href="#l127.374"></a><span id="l127.374">  * and German ones are not.</span>
<a href="#l127.375"></a><span id="l127.375">  */</span>
<a href="#l127.376"></a><span id="l127.376"> function subtest_provider_language_wildcard(aController) {</span>
<a href="#l127.377"></a><span id="l127.377">   wait_for_provider_list_loaded(aController);</span>
<a href="#l127.378"></a><span id="l127.378" class="difflineminus">-  let doc = aController.window.document;</span>
<a href="#l127.379"></a><span id="l127.379">   // Check that the two universal providers are visible.</span>
<a href="#l127.380"></a><span id="l127.380">   wait_for_element_visible(aController, &quot;universal-check&quot;);</span>
<a href="#l127.381"></a><span id="l127.381">   wait_for_element_visible(aController, &quot;otherUniversal-check&quot;);</span>
<a href="#l127.382"></a><span id="l127.382">   // The French and German providers should not be visible.</span>
<a href="#l127.383"></a><span id="l127.383">   wait_for_element_invisible(aController, &quot;french-check&quot;);</span>
<a href="#l127.384"></a><span id="l127.384">   wait_for_element_invisible(aController, &quot;german-check&quot;);</span>
<a href="#l127.385"></a><span id="l127.385">   close_dialog_immediately(aController);</span>
<a href="#l127.386"></a><span id="l127.386"> }</span>
<a href="#l127.387"></a><span id="l127.387" class="difflineat">@@ -1218,17 +1219,17 @@ function test_search_button_disabled_if_</span>
<a href="#l127.388"></a><span id="l127.388"> /**</span>
<a href="#l127.389"></a><span id="l127.389">  * Test that if we try to open the Account Provisioner dialog when an</span>
<a href="#l127.390"></a><span id="l127.390">  * Account Provisioner tab is opened, that we focus the tab instead of opening</span>
<a href="#l127.391"></a><span id="l127.391">  * the dialog.</span>
<a href="#l127.392"></a><span id="l127.392">  */</span>
<a href="#l127.393"></a><span id="l127.393"> function test_get_new_account_focuses_existing_ap_tab() {</span>
<a href="#l127.394"></a><span id="l127.394">   get_to_order_form(&quot;green@example.com&quot;);</span>
<a href="#l127.395"></a><span id="l127.395">   let apTab = mc.tabmail.getTabInfoForCurrentOrFirstModeInstance(</span>
<a href="#l127.396"></a><span id="l127.396" class="difflineminus">-    mc.tabmail.tabModes[&quot;accountProvisionerTab&quot;]);</span>
<a href="#l127.397"></a><span id="l127.397" class="difflineplus">+    mc.tabmail.tabModes.accountProvisionerTab);</span>
<a href="#l127.398"></a><span id="l127.398"> </span>
<a href="#l127.399"></a><span id="l127.399">   // Switch back to the inbox tab.</span>
<a href="#l127.400"></a><span id="l127.400">   mc.tabmail.switchToTab(0);</span>
<a href="#l127.401"></a><span id="l127.401"> </span>
<a href="#l127.402"></a><span id="l127.402">   // Try to re-open the provisioner dialog</span>
<a href="#l127.403"></a><span id="l127.403">   open_provisioner_window();</span>
<a href="#l127.404"></a><span id="l127.404"> </span>
<a href="#l127.405"></a><span id="l127.405">   // If we got here, that means that we weren't blocked by a dialog</span>
<a href="#l127.406"></a><span id="l127.406" class="difflineat">@@ -1277,23 +1278,23 @@ function subtest_per_address_prices(w) {</span>
<a href="#l127.407"></a><span id="l127.407">   // Do the search.</span>
<a href="#l127.408"></a><span id="l127.408">   mc.click(w.eid(&quot;searchSubmit&quot;));</span>
<a href="#l127.409"></a><span id="l127.409"> </span>
<a href="#l127.410"></a><span id="l127.410">   wait_for_search_results(w);</span>
<a href="#l127.411"></a><span id="l127.411"> </span>
<a href="#l127.412"></a><span id="l127.412">   let prices = [&quot;$20-$0 a year&quot;, &quot;Free&quot;, &quot;$20.00 a year&quot;];</span>
<a href="#l127.413"></a><span id="l127.413"> </span>
<a href="#l127.414"></a><span id="l127.414">   // Check that the multi-provider has the default price.</span>
<a href="#l127.415"></a><span id="l127.415" class="difflineminus">-  let providers = w.window.document.querySelectorAll('.provider');</span>
<a href="#l127.416"></a><span id="l127.416" class="difflineplus">+  let providers = w.window.document.querySelectorAll(&quot;.provider&quot;);</span>
<a href="#l127.417"></a><span id="l127.417">   let price;</span>
<a href="#l127.418"></a><span id="l127.418">   let multi;</span>
<a href="#l127.419"></a><span id="l127.419">   for (let provider of providers) {</span>
<a href="#l127.420"></a><span id="l127.420">     if (provider.innerHTML == &quot;multi&quot;) {</span>
<a href="#l127.421"></a><span id="l127.421">       multi = provider;</span>
<a href="#l127.422"></a><span id="l127.422" class="difflineminus">-      price = provider.parentNode.querySelector('.price');</span>
<a href="#l127.423"></a><span id="l127.423" class="difflineplus">+      price = provider.parentNode.querySelector(&quot;.price&quot;);</span>
<a href="#l127.424"></a><span id="l127.424">       break;</span>
<a href="#l127.425"></a><span id="l127.425">     }</span>
<a href="#l127.426"></a><span id="l127.426">   }</span>
<a href="#l127.427"></a><span id="l127.427">   assert_equals(price.innerHTML, prices[0].slice(0, 6));</span>
<a href="#l127.428"></a><span id="l127.428"> </span>
<a href="#l127.429"></a><span id="l127.429">   // Click on the multi provider. This reveals the buttons with the prices.</span>
<a href="#l127.430"></a><span id="l127.430">   mc.click(new elib.Elem(multi));</span>
<a href="#l127.431"></a><span id="l127.431">   mc.waitFor(() =&gt; w.window.document.querySelectorAll('button.create:not([disabled=&quot;true&quot;])').length &gt; 0);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l128.1"></a><span id="l128.1" class="difflineminus">--- a/mail/test/mozmill/notification/test-notification.js</span>
<a href="#l128.2"></a><span id="l128.2" class="difflineplus">+++ b/mail/test/mozmill/notification/test-notification.js</span>
<a href="#l128.3"></a><span id="l128.3" class="difflineat">@@ -1,18 +1,20 @@</span>
<a href="#l128.4"></a><span id="l128.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l128.5"></a><span id="l128.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l128.6"></a><span id="l128.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l128.7"></a><span id="l128.7"> </span>
<a href="#l128.8"></a><span id="l128.8"> &quot;use strict&quot;;</span>
<a href="#l128.9"></a><span id="l128.9"> </span>
<a href="#l128.10"></a><span id="l128.10" class="difflineminus">-var MODULE_NAME = 'test-notifications';</span>
<a href="#l128.11"></a><span id="l128.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l128.12"></a><span id="l128.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l128.13"></a><span id="l128.13"> </span>
<a href="#l128.14"></a><span id="l128.14" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l128.15"></a><span id="l128.15" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l128.16"></a><span id="l128.16" class="difflineplus">+var MODULE_NAME = &quot;test-notifications&quot;;</span>
<a href="#l128.17"></a><span id="l128.17" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l128.18"></a><span id="l128.18" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l128.19"></a><span id="l128.19"> </span>
<a href="#l128.20"></a><span id="l128.20"> var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l128.21"></a><span id="l128.21"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l128.22"></a><span id="l128.22"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l128.23"></a><span id="l128.23"> </span>
<a href="#l128.24"></a><span id="l128.24"> // Our global folder variables...</span>
<a href="#l128.25"></a><span id="l128.25"> var gFolder = null;</span>
<a href="#l128.26"></a><span id="l128.26"> var gFolder2 = null;</span>
<a href="#l128.27"></a><span id="l128.27" class="difflineat">@@ -26,18 +28,17 @@ var gTotalOpenTime;</span>
<a href="#l128.28"></a><span id="l128.28"> var gMsgMinutes = 9000;</span>
<a href="#l128.29"></a><span id="l128.29"> </span>
<a href="#l128.30"></a><span id="l128.30"> // We'll use this mock alerts service to capture notification events</span>
<a href="#l128.31"></a><span id="l128.31"> var gMockAlertsService = {</span>
<a href="#l128.32"></a><span id="l128.32">   _doFail: false,</span>
<a href="#l128.33"></a><span id="l128.33"> </span>
<a href="#l128.34"></a><span id="l128.34">   QueryInterface: ChromeUtils.generateQI([Ci.nsIAlertsService]),</span>
<a href="#l128.35"></a><span id="l128.35"> </span>
<a href="#l128.36"></a><span id="l128.36" class="difflineminus">-  showAlertNotification: function(imageUrl, title, text, textClickable, cookie,</span>
<a href="#l128.37"></a><span id="l128.37" class="difflineminus">-                                  alertListener, name) {</span>
<a href="#l128.38"></a><span id="l128.38" class="difflineplus">+  showAlertNotification(imageUrl, title, text, textClickable, cookie, alertListener, name) {</span>
<a href="#l128.39"></a><span id="l128.39">     // Setting the _doFail flag allows us to revert to the newmailalert.xul</span>
<a href="#l128.40"></a><span id="l128.40">     // notification</span>
<a href="#l128.41"></a><span id="l128.41">     if (this._doFail) {</span>
<a href="#l128.42"></a><span id="l128.42">       throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l128.43"></a><span id="l128.43">     }</span>
<a href="#l128.44"></a><span id="l128.44">     this._didNotify = true;</span>
<a href="#l128.45"></a><span id="l128.45">     this._imageUrl = imageUrl;</span>
<a href="#l128.46"></a><span id="l128.46">     this._title = title;</span>
<a href="#l128.47"></a><span id="l128.47" class="difflineat">@@ -54,49 +55,49 @@ var gMockAlertsService = {</span>
<a href="#l128.48"></a><span id="l128.48">   _imageUrl: null,</span>
<a href="#l128.49"></a><span id="l128.49">   _title: null,</span>
<a href="#l128.50"></a><span id="l128.50">   _text: null,</span>
<a href="#l128.51"></a><span id="l128.51">   _textClickable: null,</span>
<a href="#l128.52"></a><span id="l128.52">   _cookie: null,</span>
<a href="#l128.53"></a><span id="l128.53">   _alertListener: null,</span>
<a href="#l128.54"></a><span id="l128.54">   _name: null,</span>
<a href="#l128.55"></a><span id="l128.55"> </span>
<a href="#l128.56"></a><span id="l128.56" class="difflineminus">-  _reset: function() {</span>
<a href="#l128.57"></a><span id="l128.57" class="difflineplus">+  _reset() {</span>
<a href="#l128.58"></a><span id="l128.58">     // Tell any listeners that we're through</span>
<a href="#l128.59"></a><span id="l128.59">     if (this._alertListener)</span>
<a href="#l128.60"></a><span id="l128.60">       this._alertListener.observe(null, &quot;alertfinished&quot;, this._cookie);</span>
<a href="#l128.61"></a><span id="l128.61"> </span>
<a href="#l128.62"></a><span id="l128.62">     this._didNotify = false;</span>
<a href="#l128.63"></a><span id="l128.63">     this._imageUrl = null;</span>
<a href="#l128.64"></a><span id="l128.64">     this._title = null;</span>
<a href="#l128.65"></a><span id="l128.65">     this._text = null;</span>
<a href="#l128.66"></a><span id="l128.66">     this._textClickable = null;</span>
<a href="#l128.67"></a><span id="l128.67">     this._cookie = null;</span>
<a href="#l128.68"></a><span id="l128.68">     this._alertListener = null;</span>
<a href="#l128.69"></a><span id="l128.69">     this._name = null;</span>
<a href="#l128.70"></a><span id="l128.70" class="difflineminus">-  }</span>
<a href="#l128.71"></a><span id="l128.71" class="difflineplus">+  },</span>
<a href="#l128.72"></a><span id="l128.72"> };</span>
<a href="#l128.73"></a><span id="l128.73"> </span>
<a href="#l128.74"></a><span id="l128.74"> var gMockAlertsServiceFactory = {</span>
<a href="#l128.75"></a><span id="l128.75" class="difflineminus">-  createInstance: function(aOuter, aIID) {</span>
<a href="#l128.76"></a><span id="l128.76" class="difflineplus">+  createInstance(aOuter, aIID) {</span>
<a href="#l128.77"></a><span id="l128.77">     if (aOuter != null)</span>
<a href="#l128.78"></a><span id="l128.78">       throw Cr.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l128.79"></a><span id="l128.79"> </span>
<a href="#l128.80"></a><span id="l128.80">     if (!aIID.equals(Ci.nsIAlertsService))</span>
<a href="#l128.81"></a><span id="l128.81">       throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l128.82"></a><span id="l128.82"> </span>
<a href="#l128.83"></a><span id="l128.83">     return gMockAlertsService;</span>
<a href="#l128.84"></a><span id="l128.84" class="difflineminus">-  }</span>
<a href="#l128.85"></a><span id="l128.85" class="difflineplus">+  },</span>
<a href="#l128.86"></a><span id="l128.86"> };</span>
<a href="#l128.87"></a><span id="l128.87"> </span>
<a href="#l128.88"></a><span id="l128.88"> function setupModule(module) {</span>
<a href="#l128.89"></a><span id="l128.89" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l128.90"></a><span id="l128.90" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l128.91"></a><span id="l128.91">   fdh.installInto(module);</span>
<a href="#l128.92"></a><span id="l128.92"> </span>
<a href="#l128.93"></a><span id="l128.93" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l128.94"></a><span id="l128.94" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l128.95"></a><span id="l128.95">   wh.installInto(module);</span>
<a href="#l128.96"></a><span id="l128.96"> </span>
<a href="#l128.97"></a><span id="l128.97">   // Register the mock alerts service</span>
<a href="#l128.98"></a><span id="l128.98">   Components.manager.QueryInterface(Ci.nsIComponentRegistrar)</span>
<a href="#l128.99"></a><span id="l128.99">             .registerFactory(Components</span>
<a href="#l128.100"></a><span id="l128.100">                              .ID(&quot;{1bda6c33-b089-43df-a8fd-111907d6385a}&quot;),</span>
<a href="#l128.101"></a><span id="l128.101">                              &quot;Mock Alerts Service&quot;,</span>
<a href="#l128.102"></a><span id="l128.102">                              &quot;@mozilla.org/system-alerts-service;1&quot;,</span>
<a href="#l128.103"></a><span id="l128.103" class="difflineat">@@ -136,17 +137,16 @@ function setupModule(module) {</span>
<a href="#l128.104"></a><span id="l128.104"> </span>
<a href="#l128.105"></a><span id="l128.105"> function teardownModule(module) {</span>
<a href="#l128.106"></a><span id="l128.106">   put_bool_prefs_back();</span>
<a href="#l128.107"></a><span id="l128.107">   if (Services.appinfo.OS != &quot;Darwin&quot;)</span>
<a href="#l128.108"></a><span id="l128.108">     Services.prefs.setIntPref(&quot;alerts.totalOpenTime&quot;, gTotalOpenTime);</span>
<a href="#l128.109"></a><span id="l128.109"> }</span>
<a href="#l128.110"></a><span id="l128.110"> </span>
<a href="#l128.111"></a><span id="l128.111"> function setupTest(test) {</span>
<a href="#l128.112"></a><span id="l128.112" class="difflineminus">-</span>
<a href="#l128.113"></a><span id="l128.113">   gFolder.markAllMessagesRead(null);</span>
<a href="#l128.114"></a><span id="l128.114">   gMockAlertsService._reset();</span>
<a href="#l128.115"></a><span id="l128.115">   gMockAlertsService._doFail = false;</span>
<a href="#l128.116"></a><span id="l128.116">   gFolder.biffState = Ci.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l128.117"></a><span id="l128.117">   gFolder2.biffState = Ci.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l128.118"></a><span id="l128.118"> </span>
<a href="#l128.119"></a><span id="l128.119">   remember_and_set_bool_pref(&quot;mail.biff.alert.show_subject&quot;, true);</span>
<a href="#l128.120"></a><span id="l128.120">   remember_and_set_bool_pref(&quot;mail.biff.alert.show_sender&quot;, true);</span>
<a href="#l128.121"></a><span id="l128.121" class="difflineat">@@ -171,18 +171,17 @@ function remember_and_set_bool_pref(aPre</span>
<a href="#l128.122"></a><span id="l128.122"> }</span>
<a href="#l128.123"></a><span id="l128.123"> </span>
<a href="#l128.124"></a><span id="l128.124"> /* This function wraps up make_new_sets_in_folder, and takes the</span>
<a href="#l128.125"></a><span id="l128.125">  * same arguments.  The point of this function is to ensure that</span>
<a href="#l128.126"></a><span id="l128.126">  * each sent message is slightly newer than the last.  In this</span>
<a href="#l128.127"></a><span id="l128.127">  * case, each new message set will be sent one minute further</span>
<a href="#l128.128"></a><span id="l128.128">  * into the future than the last message set.</span>
<a href="#l128.129"></a><span id="l128.129">  */</span>
<a href="#l128.130"></a><span id="l128.130" class="difflineminus">-function make_gradually_newer_sets_in_folder(aFolder, aArgs)</span>
<a href="#l128.131"></a><span id="l128.131" class="difflineminus">-{</span>
<a href="#l128.132"></a><span id="l128.132" class="difflineplus">+function make_gradually_newer_sets_in_folder(aFolder, aArgs) {</span>
<a href="#l128.133"></a><span id="l128.133">   gMsgMinutes -= 1;</span>
<a href="#l128.134"></a><span id="l128.134">   if (!aArgs.age) {</span>
<a href="#l128.135"></a><span id="l128.135">     for (let arg of aArgs)</span>
<a href="#l128.136"></a><span id="l128.136">       arg.age = {minutes: gMsgMinutes};</span>
<a href="#l128.137"></a><span id="l128.137">   }</span>
<a href="#l128.138"></a><span id="l128.138">   make_new_sets_in_folder(aFolder, aArgs);</span>
<a href="#l128.139"></a><span id="l128.139"> }</span>
<a href="#l128.140"></a><span id="l128.140"> </span>
<a href="#l128.141"></a><span id="l128.141" class="difflineat">@@ -197,55 +196,55 @@ function test_revert_to_newmailalert() {</span>
<a href="#l128.142"></a><span id="l128.142"> </span>
<a href="#l128.143"></a><span id="l128.143">   // We expect the newmailalert.xul window...</span>
<a href="#l128.144"></a><span id="l128.144">   plan_for_new_window(&quot;alert:alert&quot;);</span>
<a href="#l128.145"></a><span id="l128.145">   make_gradually_newer_sets_in_folder(gFolder, [{count: 2}]);</span>
<a href="#l128.146"></a><span id="l128.146">   let controller = wait_for_new_window(&quot;alert:alert&quot;);</span>
<a href="#l128.147"></a><span id="l128.147">   plan_for_window_close(controller);</span>
<a href="#l128.148"></a><span id="l128.148">   wait_for_window_close();</span>
<a href="#l128.149"></a><span id="l128.149"> }</span>
<a href="#l128.150"></a><span id="l128.150" class="difflineminus">-test_revert_to_newmailalert.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.151"></a><span id="l128.151" class="difflineplus">+test_revert_to_newmailalert.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l128.152"></a><span id="l128.152"> </span>
<a href="#l128.153"></a><span id="l128.153"> /**</span>
<a href="#l128.154"></a><span id="l128.154">  * Test that receiving new mail causes a notification to appear</span>
<a href="#l128.155"></a><span id="l128.155">  */</span>
<a href="#l128.156"></a><span id="l128.156"> function test_new_mail_received_causes_notification() {</span>
<a href="#l128.157"></a><span id="l128.157">   make_gradually_newer_sets_in_folder(gFolder, [{count: 1}]);</span>
<a href="#l128.158"></a><span id="l128.158">   assert_true(gMockAlertsService._didNotify,</span>
<a href="#l128.159"></a><span id="l128.159">               &quot;Did not show alert notification.&quot;);</span>
<a href="#l128.160"></a><span id="l128.160"> }</span>
<a href="#l128.161"></a><span id="l128.161" class="difflineminus">-test_new_mail_received_causes_notification.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.162"></a><span id="l128.162" class="difflineplus">+test_new_mail_received_causes_notification.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l128.163"></a><span id="l128.163"> </span>
<a href="#l128.164"></a><span id="l128.164"> /**</span>
<a href="#l128.165"></a><span id="l128.165">  * Test that if notification shows, we don't show newmailalert.xul</span>
<a href="#l128.166"></a><span id="l128.166">  */</span>
<a href="#l128.167"></a><span id="l128.167"> function test_dont_show_newmailalert() {</span>
<a href="#l128.168"></a><span id="l128.168">   make_gradually_newer_sets_in_folder(gFolder, [{count: 1}]);</span>
<a href="#l128.169"></a><span id="l128.169"> </span>
<a href="#l128.170"></a><span id="l128.170">   // Wait for newmailalert.xul to show</span>
<a href="#l128.171"></a><span id="l128.171">   plan_for_new_window(&quot;alert:alert&quot;);</span>
<a href="#l128.172"></a><span id="l128.172">   try {</span>
<a href="#l128.173"></a><span id="l128.173" class="difflineminus">-    let controller = wait_for_new_window(&quot;alert:alert&quot;);</span>
<a href="#l128.174"></a><span id="l128.174" class="difflineplus">+    wait_for_new_window(&quot;alert:alert&quot;);</span>
<a href="#l128.175"></a><span id="l128.175">     throw Error(&quot;Opened newmailalert.xul when we shouldn't have.&quot;);</span>
<a href="#l128.176"></a><span id="l128.176" class="difflineminus">-  } catch(e) {</span>
<a href="#l128.177"></a><span id="l128.177" class="difflineplus">+  } catch (e) {</span>
<a href="#l128.178"></a><span id="l128.178">     // Correct behaviour - the window didn't show.</span>
<a href="#l128.179"></a><span id="l128.179">   }</span>
<a href="#l128.180"></a><span id="l128.180"> }</span>
<a href="#l128.181"></a><span id="l128.181" class="difflineminus">-test_new_mail_received_causes_notification.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.182"></a><span id="l128.182" class="difflineplus">+test_new_mail_received_causes_notification.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l128.183"></a><span id="l128.183"> </span>
<a href="#l128.184"></a><span id="l128.184"> /**</span>
<a href="#l128.185"></a><span id="l128.185">  * Test that we notify, showing the oldest new, unread message received</span>
<a href="#l128.186"></a><span id="l128.186">  * since the last notification.</span>
<a href="#l128.187"></a><span id="l128.187">  */</span>
<a href="#l128.188"></a><span id="l128.188"> function test_show_oldest_new_unread_since_last_notification() {</span>
<a href="#l128.189"></a><span id="l128.189">   let notifyFirst = &quot;This should notify first&quot;;</span>
<a href="#l128.190"></a><span id="l128.190">   assert_false(gMockAlertsService._didNotify, &quot;Should not have notified yet.&quot;);</span>
<a href="#l128.191"></a><span id="l128.191">   make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l128.192"></a><span id="l128.192">                                       [{count: 1,</span>
<a href="#l128.193"></a><span id="l128.193" class="difflineminus">-                                        body: {body: notifyFirst}}])</span>
<a href="#l128.194"></a><span id="l128.194" class="difflineplus">+                                        body: {body: notifyFirst}}]);</span>
<a href="#l128.195"></a><span id="l128.195">   assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l128.196"></a><span id="l128.196">   assert_true(gMockAlertsService._text.includes(notifyFirst, 1),</span>
<a href="#l128.197"></a><span id="l128.197">               &quot;Should have notified for the first message&quot;);</span>
<a href="#l128.198"></a><span id="l128.198"> </span>
<a href="#l128.199"></a><span id="l128.199">   be_in_folder(gFolder);</span>
<a href="#l128.200"></a><span id="l128.200">   gFolder.biffState = Ci.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l128.201"></a><span id="l128.201">   gMockAlertsService._reset();</span>
<a href="#l128.202"></a><span id="l128.202"> </span>
<a href="#l128.203"></a><span id="l128.203" class="difflineat">@@ -253,38 +252,38 @@ function test_show_oldest_new_unread_sin</span>
<a href="#l128.204"></a><span id="l128.204">   assert_false(gMockAlertsService._didNotify, &quot;Should not have notified yet.&quot;);</span>
<a href="#l128.205"></a><span id="l128.205">   make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l128.206"></a><span id="l128.206">                                       [{count: 1,</span>
<a href="#l128.207"></a><span id="l128.207">                                         body: {body: notifySecond}}]);</span>
<a href="#l128.208"></a><span id="l128.208">   assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l128.209"></a><span id="l128.209">   assert_true(gMockAlertsService._text.includes(notifySecond, 1),</span>
<a href="#l128.210"></a><span id="l128.210">               &quot;Should have notified for the second message&quot;);</span>
<a href="#l128.211"></a><span id="l128.211"> }</span>
<a href="#l128.212"></a><span id="l128.212" class="difflineminus">-test_show_oldest_new_unread_since_last_notification.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.213"></a><span id="l128.213" class="difflineplus">+test_show_oldest_new_unread_since_last_notification.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l128.214"></a><span id="l128.214"> </span>
<a href="#l128.215"></a><span id="l128.215"> /**</span>
<a href="#l128.216"></a><span id="l128.216">  * Test that notifications work across different accounts.</span>
<a href="#l128.217"></a><span id="l128.217">  */</span>
<a href="#l128.218"></a><span id="l128.218"> function test_notification_works_across_accounts() {</span>
<a href="#l128.219"></a><span id="l128.219">   // Cause a notification in the first folder</span>
<a href="#l128.220"></a><span id="l128.220">   make_gradually_newer_sets_in_folder(gFolder, [{count: 1}]);</span>
<a href="#l128.221"></a><span id="l128.221">   assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l128.222"></a><span id="l128.222"> </span>
<a href="#l128.223"></a><span id="l128.223">   gMockAlertsService._reset();</span>
<a href="#l128.224"></a><span id="l128.224">   // We'll set the time for these messages to be slightly further</span>
<a href="#l128.225"></a><span id="l128.225">   // into the past.  That way, test_notification_independent_across_accounts</span>
<a href="#l128.226"></a><span id="l128.226">   // has an opportunity to send slightly newer messages that are older than</span>
<a href="#l128.227"></a><span id="l128.227">   // the messages sent to gFolder.</span>
<a href="#l128.228"></a><span id="l128.228">   make_gradually_newer_sets_in_folder(gFolder2,</span>
<a href="#l128.229"></a><span id="l128.229">                                       [{count: 2,</span>
<a href="#l128.230"></a><span id="l128.230" class="difflineminus">-                                        age: {minutes: gMsgMinutes + 20}</span>
<a href="#l128.231"></a><span id="l128.231" class="difflineplus">+                                        age: {minutes: gMsgMinutes + 20},</span>
<a href="#l128.232"></a><span id="l128.232">                                        }]);</span>
<a href="#l128.233"></a><span id="l128.233">   assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l128.234"></a><span id="l128.234"> }</span>
<a href="#l128.235"></a><span id="l128.235" class="difflineminus">-test_notification_works_across_accounts.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.236"></a><span id="l128.236" class="difflineplus">+test_notification_works_across_accounts.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l128.237"></a><span id="l128.237"> </span>
<a href="#l128.238"></a><span id="l128.238"> /* Test that notification timestamps are independent from account</span>
<a href="#l128.239"></a><span id="l128.239">  * to account.  This is for the scenario where we have two accounts, and</span>
<a href="#l128.240"></a><span id="l128.240">  * one has notified while the other is still updating.  When the second</span>
<a href="#l128.241"></a><span id="l128.241">  * account completes, if it has new mail, it should notify, even if second</span>
<a href="#l128.242"></a><span id="l128.242">  * account's newest mail is older than the first account's newest mail.</span>
<a href="#l128.243"></a><span id="l128.243">  */</span>
<a href="#l128.244"></a><span id="l128.244"> function test_notifications_independent_across_accounts() {</span>
<a href="#l128.245"></a><span id="l128.245" class="difflineat">@@ -292,243 +291,240 @@ function test_notifications_independent_</span>
<a href="#l128.246"></a><span id="l128.246">   assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l128.247"></a><span id="l128.247"> </span>
<a href="#l128.248"></a><span id="l128.248">   gMockAlertsService._reset();</span>
<a href="#l128.249"></a><span id="l128.249">   // Next, let's make some mail arrive in the second folder, but</span>
<a href="#l128.250"></a><span id="l128.250">   // let's have that mail be slightly older than the mail that</span>
<a href="#l128.251"></a><span id="l128.251">   // landed in the first folder.  We should still notify.</span>
<a href="#l128.252"></a><span id="l128.252">   make_gradually_newer_sets_in_folder(gFolder2,</span>
<a href="#l128.253"></a><span id="l128.253">                                       [{count: 2,</span>
<a href="#l128.254"></a><span id="l128.254" class="difflineminus">-                                        age: {minutes: gMsgMinutes + 10}</span>
<a href="#l128.255"></a><span id="l128.255" class="difflineplus">+                                        age: {minutes: gMsgMinutes + 10},</span>
<a href="#l128.256"></a><span id="l128.256">                                        }]);</span>
<a href="#l128.257"></a><span id="l128.257">   assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l128.258"></a><span id="l128.258"> }</span>
<a href="#l128.259"></a><span id="l128.259" class="difflineminus">-test_notifications_independent_across_accounts.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.260"></a><span id="l128.260" class="difflineplus">+test_notifications_independent_across_accounts.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l128.261"></a><span id="l128.261"> </span>
<a href="#l128.262"></a><span id="l128.262"> /**</span>
<a href="#l128.263"></a><span id="l128.263">  * Test that we can show the message subject in the notification.</span>
<a href="#l128.264"></a><span id="l128.264">  */</span>
<a href="#l128.265"></a><span id="l128.265"> function test_show_subject() {</span>
<a href="#l128.266"></a><span id="l128.266">   let subject = &quot;This should be displayed&quot;;</span>
<a href="#l128.267"></a><span id="l128.267">   make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l128.268"></a><span id="l128.268">                                       [{count: 1,</span>
<a href="#l128.269"></a><span id="l128.269" class="difflineminus">-                                        subject: subject</span>
<a href="#l128.270"></a><span id="l128.270" class="difflineplus">+                                        subject,</span>
<a href="#l128.271"></a><span id="l128.271">                                        }]);</span>
<a href="#l128.272"></a><span id="l128.272">   assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l128.273"></a><span id="l128.273">   assert_true(gMockAlertsService._text.includes(subject),</span>
<a href="#l128.274"></a><span id="l128.274">               &quot;Should have displayed the subject&quot;);</span>
<a href="#l128.275"></a><span id="l128.275"> }</span>
<a href="#l128.276"></a><span id="l128.276" class="difflineminus">-test_show_subject.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.277"></a><span id="l128.277" class="difflineplus">+test_show_subject.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l128.278"></a><span id="l128.278"> </span>
<a href="#l128.279"></a><span id="l128.279"> /**</span>
<a href="#l128.280"></a><span id="l128.280">  * Test that we can hide the message subject in the notification.</span>
<a href="#l128.281"></a><span id="l128.281">  */</span>
<a href="#l128.282"></a><span id="l128.282"> function test_hide_subject() {</span>
<a href="#l128.283"></a><span id="l128.283">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_subject&quot;, false);</span>
<a href="#l128.284"></a><span id="l128.284">   let subject = &quot;This should not be displayed&quot;;</span>
<a href="#l128.285"></a><span id="l128.285">   make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l128.286"></a><span id="l128.286">                                       [{count: 1,</span>
<a href="#l128.287"></a><span id="l128.287" class="difflineminus">-                                        subject: subject</span>
<a href="#l128.288"></a><span id="l128.288" class="difflineplus">+                                        subject,</span>
<a href="#l128.289"></a><span id="l128.289">                                        }]);</span>
<a href="#l128.290"></a><span id="l128.290">   assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l128.291"></a><span id="l128.291">   assert_true(!gMockAlertsService._text.includes(subject),</span>
<a href="#l128.292"></a><span id="l128.292">                 &quot;Should not have displayed the subject&quot;);</span>
<a href="#l128.293"></a><span id="l128.293"> }</span>
<a href="#l128.294"></a><span id="l128.294" class="difflineminus">-test_hide_subject.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.295"></a><span id="l128.295" class="difflineplus">+test_hide_subject.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l128.296"></a><span id="l128.296"> </span>
<a href="#l128.297"></a><span id="l128.297"> /**</span>
<a href="#l128.298"></a><span id="l128.298">  * Test that we can show just the message sender in the notification.</span>
<a href="#l128.299"></a><span id="l128.299">  */</span>
<a href="#l128.300"></a><span id="l128.300"> function test_show_only_subject() {</span>
<a href="#l128.301"></a><span id="l128.301">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, false);</span>
<a href="#l128.302"></a><span id="l128.302">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_sender&quot;, false);</span>
<a href="#l128.303"></a><span id="l128.303">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_subject&quot;, true);</span>
<a href="#l128.304"></a><span id="l128.304"> </span>
<a href="#l128.305"></a><span id="l128.305">   let sender = [&quot;John Cleese&quot;, &quot;john@cleese.invalid&quot;];</span>
<a href="#l128.306"></a><span id="l128.306">   let subject = &quot;This should not be displayed&quot;;</span>
<a href="#l128.307"></a><span id="l128.307">   let messageBody = &quot;My message preview&quot;;</span>
<a href="#l128.308"></a><span id="l128.308"> </span>
<a href="#l128.309"></a><span id="l128.309">   make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l128.310"></a><span id="l128.310">                                       [{count: 1,</span>
<a href="#l128.311"></a><span id="l128.311">                                         from: sender,</span>
<a href="#l128.312"></a><span id="l128.312" class="difflineminus">-                                        subject: subject,</span>
<a href="#l128.313"></a><span id="l128.313" class="difflineplus">+                                        subject,</span>
<a href="#l128.314"></a><span id="l128.314">                                         body: {body: messageBody}}]);</span>
<a href="#l128.315"></a><span id="l128.315">   assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l128.316"></a><span id="l128.316">   assert_true(gMockAlertsService._text.includes(subject),</span>
<a href="#l128.317"></a><span id="l128.317">               &quot;Should have displayed the subject&quot;);</span>
<a href="#l128.318"></a><span id="l128.318">   assert_true(!gMockAlertsService._text.includes(messageBody),</span>
<a href="#l128.319"></a><span id="l128.319">                 &quot;Should not have displayed the preview&quot;);</span>
<a href="#l128.320"></a><span id="l128.320">   assert_true(!gMockAlertsService._text.includes(sender[0]),</span>
<a href="#l128.321"></a><span id="l128.321">                 &quot;Should not have displayed the sender&quot;);</span>
<a href="#l128.322"></a><span id="l128.322" class="difflineminus">-</span>
<a href="#l128.323"></a><span id="l128.323"> }</span>
<a href="#l128.324"></a><span id="l128.324" class="difflineminus">-test_show_only_subject.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.325"></a><span id="l128.325" class="difflineplus">+test_show_only_subject.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l128.326"></a><span id="l128.326"> </span>
<a href="#l128.327"></a><span id="l128.327"> </span>
<a href="#l128.328"></a><span id="l128.328"> /**</span>
<a href="#l128.329"></a><span id="l128.329">  * Test that we can show the message sender in the notification.</span>
<a href="#l128.330"></a><span id="l128.330">  */</span>
<a href="#l128.331"></a><span id="l128.331"> function test_show_sender() {</span>
<a href="#l128.332"></a><span id="l128.332">   let sender = [&quot;John Cleese&quot;, &quot;john@cleese.invalid&quot;];</span>
<a href="#l128.333"></a><span id="l128.333">   make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l128.334"></a><span id="l128.334">                                       [{count: 1,</span>
<a href="#l128.335"></a><span id="l128.335">                                         from: sender}]);</span>
<a href="#l128.336"></a><span id="l128.336">   assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l128.337"></a><span id="l128.337">   assert_true(gMockAlertsService._text.includes(sender[0]),</span>
<a href="#l128.338"></a><span id="l128.338">               &quot;Should have displayed the sender&quot;);</span>
<a href="#l128.339"></a><span id="l128.339"> }</span>
<a href="#l128.340"></a><span id="l128.340" class="difflineminus">-test_show_sender.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.341"></a><span id="l128.341" class="difflineplus">+test_show_sender.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l128.342"></a><span id="l128.342"> </span>
<a href="#l128.343"></a><span id="l128.343"> /**</span>
<a href="#l128.344"></a><span id="l128.344">  * Test that we can hide the message sender in the notification.</span>
<a href="#l128.345"></a><span id="l128.345">  */</span>
<a href="#l128.346"></a><span id="l128.346"> function test_hide_sender() {</span>
<a href="#l128.347"></a><span id="l128.347">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_sender&quot;, false);</span>
<a href="#l128.348"></a><span id="l128.348">   let sender = [&quot;John Cleese&quot;, &quot;john@cleese.invalid&quot;];</span>
<a href="#l128.349"></a><span id="l128.349">   make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l128.350"></a><span id="l128.350">                                       [{count: 1,</span>
<a href="#l128.351"></a><span id="l128.351">                                         from: sender}]);</span>
<a href="#l128.352"></a><span id="l128.352">   assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l128.353"></a><span id="l128.353">   assert_true(!gMockAlertsService._text.includes(sender[0]),</span>
<a href="#l128.354"></a><span id="l128.354">                 &quot;Should not have displayed the sender&quot;);</span>
<a href="#l128.355"></a><span id="l128.355"> }</span>
<a href="#l128.356"></a><span id="l128.356" class="difflineminus">-test_hide_sender.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.357"></a><span id="l128.357" class="difflineplus">+test_hide_sender.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l128.358"></a><span id="l128.358"> </span>
<a href="#l128.359"></a><span id="l128.359"> /**</span>
<a href="#l128.360"></a><span id="l128.360">  * Test that we can show just the message sender in the notification.</span>
<a href="#l128.361"></a><span id="l128.361">  */</span>
<a href="#l128.362"></a><span id="l128.362"> function test_show_only_sender() {</span>
<a href="#l128.363"></a><span id="l128.363">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, false);</span>
<a href="#l128.364"></a><span id="l128.364">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_sender&quot;, true);</span>
<a href="#l128.365"></a><span id="l128.365">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_subject&quot;, false);</span>
<a href="#l128.366"></a><span id="l128.366"> </span>
<a href="#l128.367"></a><span id="l128.367">   let sender = [&quot;John Cleese&quot;, &quot;john@cleese.invalid&quot;];</span>
<a href="#l128.368"></a><span id="l128.368">   let subject = &quot;This should not be displayed&quot;;</span>
<a href="#l128.369"></a><span id="l128.369">   let messageBody = &quot;My message preview&quot;;</span>
<a href="#l128.370"></a><span id="l128.370"> </span>
<a href="#l128.371"></a><span id="l128.371">   make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l128.372"></a><span id="l128.372">                                       [{count: 1,</span>
<a href="#l128.373"></a><span id="l128.373">                                         from: sender,</span>
<a href="#l128.374"></a><span id="l128.374" class="difflineminus">-                                        subject: subject,</span>
<a href="#l128.375"></a><span id="l128.375" class="difflineplus">+                                        subject,</span>
<a href="#l128.376"></a><span id="l128.376">                                         body: {body: messageBody}}]);</span>
<a href="#l128.377"></a><span id="l128.377">   assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l128.378"></a><span id="l128.378">   assert_true(gMockAlertsService._text.includes(sender[0]),</span>
<a href="#l128.379"></a><span id="l128.379">               &quot;Should have displayed the sender&quot;);</span>
<a href="#l128.380"></a><span id="l128.380">   assert_true(!gMockAlertsService._text.includes(messageBody),</span>
<a href="#l128.381"></a><span id="l128.381">                 &quot;Should not have displayed the preview&quot;);</span>
<a href="#l128.382"></a><span id="l128.382">   assert_true(!gMockAlertsService._text.includes(subject),</span>
<a href="#l128.383"></a><span id="l128.383">                 &quot;Should not have displayed the subject&quot;);</span>
<a href="#l128.384"></a><span id="l128.384" class="difflineminus">-</span>
<a href="#l128.385"></a><span id="l128.385"> }</span>
<a href="#l128.386"></a><span id="l128.386" class="difflineminus">-test_show_only_sender.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.387"></a><span id="l128.387" class="difflineplus">+test_show_only_sender.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l128.388"></a><span id="l128.388"> </span>
<a href="#l128.389"></a><span id="l128.389"> /**</span>
<a href="#l128.390"></a><span id="l128.390">  * Test that we can show the message preview in the notification.</span>
<a href="#l128.391"></a><span id="l128.391">  */</span>
<a href="#l128.392"></a><span id="l128.392"> function test_show_preview() {</span>
<a href="#l128.393"></a><span id="l128.393">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, true);</span>
<a href="#l128.394"></a><span id="l128.394">   let messageBody = &quot;My message preview&quot;;</span>
<a href="#l128.395"></a><span id="l128.395">   make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l128.396"></a><span id="l128.396">                                       [{count: 1,</span>
<a href="#l128.397"></a><span id="l128.397">                                         body: {body: messageBody}}]);</span>
<a href="#l128.398"></a><span id="l128.398">   assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l128.399"></a><span id="l128.399">   assert_true(gMockAlertsService._text.includes(messageBody),</span>
<a href="#l128.400"></a><span id="l128.400">               &quot;Should have displayed the preview&quot;);</span>
<a href="#l128.401"></a><span id="l128.401"> }</span>
<a href="#l128.402"></a><span id="l128.402" class="difflineminus">-test_show_preview.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.403"></a><span id="l128.403" class="difflineplus">+test_show_preview.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l128.404"></a><span id="l128.404"> </span>
<a href="#l128.405"></a><span id="l128.405"> /**</span>
<a href="#l128.406"></a><span id="l128.406">  * Test that we can hide the message preview in the notification.</span>
<a href="#l128.407"></a><span id="l128.407">  */</span>
<a href="#l128.408"></a><span id="l128.408"> function test_hide_preview() {</span>
<a href="#l128.409"></a><span id="l128.409">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, false);</span>
<a href="#l128.410"></a><span id="l128.410">   let messageBody = &quot;My message preview&quot;;</span>
<a href="#l128.411"></a><span id="l128.411">   make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l128.412"></a><span id="l128.412">                                       [{count: 1,</span>
<a href="#l128.413"></a><span id="l128.413">                                         body: {body: messageBody}}]);</span>
<a href="#l128.414"></a><span id="l128.414">   assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l128.415"></a><span id="l128.415">   assert_true(!gMockAlertsService._text.includes(messageBody),</span>
<a href="#l128.416"></a><span id="l128.416">                 &quot;Should not have displayed the preview&quot;);</span>
<a href="#l128.417"></a><span id="l128.417"> }</span>
<a href="#l128.418"></a><span id="l128.418" class="difflineminus">-test_hide_preview.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.419"></a><span id="l128.419" class="difflineplus">+test_hide_preview.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l128.420"></a><span id="l128.420"> </span>
<a href="#l128.421"></a><span id="l128.421"> /**</span>
<a href="#l128.422"></a><span id="l128.422">  * Test that we can show justthe message preview in the notification.</span>
<a href="#l128.423"></a><span id="l128.423">  */</span>
<a href="#l128.424"></a><span id="l128.424"> function test_show_only_preview() {</span>
<a href="#l128.425"></a><span id="l128.425">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, true);</span>
<a href="#l128.426"></a><span id="l128.426">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_sender&quot;, false);</span>
<a href="#l128.427"></a><span id="l128.427">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_subject&quot;, false);</span>
<a href="#l128.428"></a><span id="l128.428"> </span>
<a href="#l128.429"></a><span id="l128.429">   let sender = [&quot;John Cleese&quot;, &quot;john@cleese.invalid&quot;];</span>
<a href="#l128.430"></a><span id="l128.430">   let subject = &quot;This should not be displayed&quot;;</span>
<a href="#l128.431"></a><span id="l128.431">   let messageBody = &quot;My message preview&quot;;</span>
<a href="#l128.432"></a><span id="l128.432">   make_gradually_newer_sets_in_folder(gFolder,</span>
<a href="#l128.433"></a><span id="l128.433">                                       [{count: 1,</span>
<a href="#l128.434"></a><span id="l128.434">                                         from: sender,</span>
<a href="#l128.435"></a><span id="l128.435" class="difflineminus">-                                        subject: subject,</span>
<a href="#l128.436"></a><span id="l128.436" class="difflineplus">+                                        subject,</span>
<a href="#l128.437"></a><span id="l128.437">                                         body: {body: messageBody}}]);</span>
<a href="#l128.438"></a><span id="l128.438">   assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l128.439"></a><span id="l128.439">   assert_true(gMockAlertsService._text.includes(messageBody),</span>
<a href="#l128.440"></a><span id="l128.440">               &quot;Should have displayed the preview: &quot; + gMockAlertsService._text);</span>
<a href="#l128.441"></a><span id="l128.441">   assert_true(!gMockAlertsService._text.includes(sender[0]),</span>
<a href="#l128.442"></a><span id="l128.442">                 &quot;Should not have displayed the sender&quot;);</span>
<a href="#l128.443"></a><span id="l128.443">   assert_true(!gMockAlertsService._text.includes(subject),</span>
<a href="#l128.444"></a><span id="l128.444">                 &quot;Should not have displayed the subject&quot;);</span>
<a href="#l128.445"></a><span id="l128.445"> }</span>
<a href="#l128.446"></a><span id="l128.446" class="difflineminus">-test_show_only_preview.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.447"></a><span id="l128.447" class="difflineplus">+test_show_only_preview.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l128.448"></a><span id="l128.448"> </span>
<a href="#l128.449"></a><span id="l128.449"> /**</span>
<a href="#l128.450"></a><span id="l128.450">  * Test that we can receive notifications even when the biff state of</span>
<a href="#l128.451"></a><span id="l128.451">  * the folder has not been changed.</span>
<a href="#l128.452"></a><span id="l128.452">  */</span>
<a href="#l128.453"></a><span id="l128.453"> function test_still_notify_with_unchanged_biff() {</span>
<a href="#l128.454"></a><span id="l128.454" class="difflineminus">-</span>
<a href="#l128.455"></a><span id="l128.455">   // For now, we'll make sure that if we receive 10 pieces</span>
<a href="#l128.456"></a><span id="l128.456">   // of email, one after the other, we'll be notified for all</span>
<a href="#l128.457"></a><span id="l128.457">   // (assuming of course that the notifications have a chance</span>
<a href="#l128.458"></a><span id="l128.458">   // to close in between arrivals - we don't want a queue of</span>
<a href="#l128.459"></a><span id="l128.459">   // notifications to go through).</span>
<a href="#l128.460"></a><span id="l128.460">   const HOW_MUCH_MAIL = 10;</span>
<a href="#l128.461"></a><span id="l128.461"> </span>
<a href="#l128.462"></a><span id="l128.462">   assert_false(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l128.463"></a><span id="l128.463"> </span>
<a href="#l128.464"></a><span id="l128.464">   for (let i = 0; i &lt; HOW_MUCH_MAIL; i++) {</span>
<a href="#l128.465"></a><span id="l128.465">     make_gradually_newer_sets_in_folder(gFolder, [{count: 1}]);</span>
<a href="#l128.466"></a><span id="l128.466">     assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l128.467"></a><span id="l128.467">     gMockAlertsService._reset();</span>
<a href="#l128.468"></a><span id="l128.468">   }</span>
<a href="#l128.469"></a><span id="l128.469"> }</span>
<a href="#l128.470"></a><span id="l128.470" class="difflineminus">-test_still_notify_with_unchanged_biff.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.471"></a><span id="l128.471" class="difflineplus">+test_still_notify_with_unchanged_biff.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l128.472"></a><span id="l128.472"> </span>
<a href="#l128.473"></a><span id="l128.473"> /**</span>
<a href="#l128.474"></a><span id="l128.474">  * Test that we don't receive notifications for Draft, Queue, SentMail,</span>
<a href="#l128.475"></a><span id="l128.475">  * Templates or Junk folders.</span>
<a href="#l128.476"></a><span id="l128.476">  */</span>
<a href="#l128.477"></a><span id="l128.477"> function test_no_notification_for_uninteresting_folders() {</span>
<a href="#l128.478"></a><span id="l128.478">   var someFolder = create_folder(&quot;Uninteresting Folder&quot;);</span>
<a href="#l128.479"></a><span id="l128.479">   var uninterestingFlags = [Ci.nsMsgFolderFlags.Drafts,</span>
<a href="#l128.480"></a><span id="l128.480">                             Ci.nsMsgFolderFlags.Queue,</span>
<a href="#l128.481"></a><span id="l128.481">                             Ci.nsMsgFolderFlags.SentMail,</span>
<a href="#l128.482"></a><span id="l128.482">                             Ci.nsMsgFolderFlags.Templates,</span>
<a href="#l128.483"></a><span id="l128.483">                             Ci.nsMsgFolderFlags.Junk,</span>
<a href="#l128.484"></a><span id="l128.484">                             Ci.nsMsgFolderFlags.Archive];</span>
<a href="#l128.485"></a><span id="l128.485"> </span>
<a href="#l128.486"></a><span id="l128.486" class="difflineminus">-  for (var i = 0; i &lt; uninterestingFlags.length; i++) {</span>
<a href="#l128.487"></a><span id="l128.487" class="difflineplus">+  for (let i = 0; i &lt; uninterestingFlags.length; i++) {</span>
<a href="#l128.488"></a><span id="l128.488">     someFolder.flags = uninterestingFlags[i];</span>
<a href="#l128.489"></a><span id="l128.489">     make_gradually_newer_sets_in_folder(someFolder, [{count: 1}]);</span>
<a href="#l128.490"></a><span id="l128.490">     assert_false(gMockAlertsService._didNotify,</span>
<a href="#l128.491"></a><span id="l128.491">                 &quot;Showed alert notification.&quot;);</span>
<a href="#l128.492"></a><span id="l128.492">   }</span>
<a href="#l128.493"></a><span id="l128.493"> </span>
<a href="#l128.494"></a><span id="l128.494">   // However, we want to ensure that Inboxes *always* notify, even</span>
<a href="#l128.495"></a><span id="l128.495">   // if they possess the flags we consider uninteresting.</span>
<a href="#l128.496"></a><span id="l128.496">   someFolder.flags = Ci.nsMsgFolderFlags.Inbox;</span>
<a href="#l128.497"></a><span id="l128.497"> </span>
<a href="#l128.498"></a><span id="l128.498" class="difflineminus">-  for (var i = 0; i &lt; uninterestingFlags.length; i++) {</span>
<a href="#l128.499"></a><span id="l128.499" class="difflineplus">+  for (let i = 0; i &lt; uninterestingFlags.length; i++) {</span>
<a href="#l128.500"></a><span id="l128.500">     someFolder.flags |= uninterestingFlags[i];</span>
<a href="#l128.501"></a><span id="l128.501">     make_gradually_newer_sets_in_folder(someFolder, [{count: 1}]);</span>
<a href="#l128.502"></a><span id="l128.502">     assert_true(gMockAlertsService._didNotify,</span>
<a href="#l128.503"></a><span id="l128.503">                 &quot;Did not show alert notification.&quot;);</span>
<a href="#l128.504"></a><span id="l128.504">     someFolder.flags = someFolder.flags &amp; ~uninterestingFlags[i];</span>
<a href="#l128.505"></a><span id="l128.505">   }</span>
<a href="#l128.506"></a><span id="l128.506"> }</span>
<a href="#l128.507"></a><span id="l128.507" class="difflineminus">-test_no_notification_for_uninteresting_folders.EXCLUDED_PLATFORMS = ['winnt', 'darwin'];</span>
<a href="#l128.508"></a><span id="l128.508" class="difflineplus">+test_no_notification_for_uninteresting_folders.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l129.1"></a><span id="l129.1" class="difflineminus">--- a/mail/test/mozmill/override-main-menu-collapse/test-override-mainmenu-collapse.js</span>
<a href="#l129.2"></a><span id="l129.2" class="difflineplus">+++ b/mail/test/mozmill/override-main-menu-collapse/test-override-mainmenu-collapse.js</span>
<a href="#l129.3"></a><span id="l129.3" class="difflineat">@@ -5,38 +5,40 @@</span>
<a href="#l129.4"></a><span id="l129.4"> /**</span>
<a href="#l129.5"></a><span id="l129.5">  * Tests that the main menu will NOT be collapsed by default if Thunderbird</span>
<a href="#l129.6"></a><span id="l129.6">  * starts with no accounts created, and mail.main_menu.collapse_by_default set</span>
<a href="#l129.7"></a><span id="l129.7">  * to false.</span>
<a href="#l129.8"></a><span id="l129.8">  */</span>
<a href="#l129.9"></a><span id="l129.9"> </span>
<a href="#l129.10"></a><span id="l129.10"> &quot;use strict&quot;;</span>
<a href="#l129.11"></a><span id="l129.11"> </span>
<a href="#l129.12"></a><span id="l129.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l129.13"></a><span id="l129.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l129.14"></a><span id="l129.14" class="difflineplus">+</span>
<a href="#l129.15"></a><span id="l129.15"> var MODULE_NAME = &quot;test-override-mainmenu-collapse&quot;;</span>
<a href="#l129.16"></a><span id="l129.16"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l129.17"></a><span id="l129.17" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l129.18"></a><span id="l129.18" class="difflineminus">-                       &quot;window-helpers&quot;];</span>
<a href="#l129.19"></a><span id="l129.19" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l129.20"></a><span id="l129.20"> </span>
<a href="#l129.21"></a><span id="l129.21"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l129.22"></a><span id="l129.22"> </span>
<a href="#l129.23"></a><span id="l129.23"> function setupModule(module) {</span>
<a href="#l129.24"></a><span id="l129.24">   collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l129.25"></a><span id="l129.25">   collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l129.26"></a><span id="l129.26"> }</span>
<a href="#l129.27"></a><span id="l129.27"> </span>
<a href="#l129.28"></a><span id="l129.28"> function test_main_menu_not_collapsed() {</span>
<a href="#l129.29"></a><span id="l129.29">   // Due to random oranges on slower machines, we need to ensure that startup</span>
<a href="#l129.30"></a><span id="l129.30">   // is complete before running this test.</span>
<a href="#l129.31"></a><span id="l129.31">   let done = false;</span>
<a href="#l129.32"></a><span id="l129.32">   let observer = {</span>
<a href="#l129.33"></a><span id="l129.33" class="difflineminus">-    observe: function(aSubject, aTopic, aData) {</span>
<a href="#l129.34"></a><span id="l129.34" class="difflineplus">+    observe(aSubject, aTopic, aData) {</span>
<a href="#l129.35"></a><span id="l129.35">       if (aTopic == &quot;mail-startup-done&quot;) {</span>
<a href="#l129.36"></a><span id="l129.36">         done = true;</span>
<a href="#l129.37"></a><span id="l129.37">       }</span>
<a href="#l129.38"></a><span id="l129.38" class="difflineminus">-    }</span>
<a href="#l129.39"></a><span id="l129.39" class="difflineplus">+    },</span>
<a href="#l129.40"></a><span id="l129.40">   };</span>
<a href="#l129.41"></a><span id="l129.41">   Services.obs.addObserver(observer, &quot;mail-startup-done&quot;);</span>
<a href="#l129.42"></a><span id="l129.42"> </span>
<a href="#l129.43"></a><span id="l129.43">   // Since no accounts were set up, and the account provisoner was disabled</span>
<a href="#l129.44"></a><span id="l129.44">   // in prefs.js, the wizard will show up. Find it, and close it. This will</span>
<a href="#l129.45"></a><span id="l129.45">   // cause mail-startup-done to eventually be fired.</span>
<a href="#l129.46"></a><span id="l129.46">   let wizard = wait_for_existing_window(&quot;mail:autoconfig&quot;);</span>
<a href="#l129.47"></a><span id="l129.47">   close_window(wizard);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l130.1"></a><span id="l130.1" class="difflineminus">--- a/mail/test/mozmill/pref-window/test-attachments-pane.js</span>
<a href="#l130.2"></a><span id="l130.2" class="difflineplus">+++ b/mail/test/mozmill/pref-window/test-attachments-pane.js</span>
<a href="#l130.3"></a><span id="l130.3" class="difflineat">@@ -3,28 +3,29 @@</span>
<a href="#l130.4"></a><span id="l130.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l130.5"></a><span id="l130.5"> </span>
<a href="#l130.6"></a><span id="l130.6"> /**</span>
<a href="#l130.7"></a><span id="l130.7">  * Tests the manager for attachment storage services</span>
<a href="#l130.8"></a><span id="l130.8">  */</span>
<a href="#l130.9"></a><span id="l130.9"> </span>
<a href="#l130.10"></a><span id="l130.10"> &quot;use strict&quot;;</span>
<a href="#l130.11"></a><span id="l130.11"> </span>
<a href="#l130.12"></a><span id="l130.12" class="difflineminus">-var MODULE_NAME = 'test-attachments-pane';</span>
<a href="#l130.13"></a><span id="l130.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l130.14"></a><span id="l130.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l130.15"></a><span id="l130.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-pref-window-helpers.js */</span>
<a href="#l130.16"></a><span id="l130.16"> </span>
<a href="#l130.17"></a><span id="l130.17" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l130.18"></a><span id="l130.18" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l130.19"></a><span id="l130.19" class="difflineminus">-                       'pref-window-helpers',</span>
<a href="#l130.20"></a><span id="l130.20" class="difflineminus">-                       &quot;content-tab-helpers&quot;];</span>
<a href="#l130.21"></a><span id="l130.21" class="difflineplus">+var MODULE_NAME = &quot;test-attachments-pane&quot;;</span>
<a href="#l130.22"></a><span id="l130.22" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l130.23"></a><span id="l130.23" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;pref-window-helpers&quot;, &quot;content-tab-helpers&quot;];</span>
<a href="#l130.24"></a><span id="l130.24"> </span>
<a href="#l130.25"></a><span id="l130.25"> function setupModule(module) {</span>
<a href="#l130.26"></a><span id="l130.26">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l130.27"></a><span id="l130.27">     collector.getModule(lib).installInto(module);</span>
<a href="#l130.28"></a><span id="l130.28">   }</span>
<a href="#l130.29"></a><span id="l130.29" class="difflineminus">-};</span>
<a href="#l130.30"></a><span id="l130.30" class="difflineplus">+}</span>
<a href="#l130.31"></a><span id="l130.31"> </span>
<a href="#l130.32"></a><span id="l130.32"> /**</span>
<a href="#l130.33"></a><span id="l130.33">  * Test that if we come back to the Attachment pane, then</span>
<a href="#l130.34"></a><span id="l130.34">  * we'll automatically be viewing the same tab we were viewing</span>
<a href="#l130.35"></a><span id="l130.35">  * last time.</span>
<a href="#l130.36"></a><span id="l130.36">  */</span>
<a href="#l130.37"></a><span id="l130.37"> function test_persist_tabs() {</span>
<a href="#l130.38"></a><span id="l130.38">   let prefTab = open_pref_tab(&quot;paneApplications&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l131.1"></a><span id="l131.1" class="difflineminus">--- a/mail/test/mozmill/pref-window/test-font-chooser.js</span>
<a href="#l131.2"></a><span id="l131.2" class="difflineplus">+++ b/mail/test/mozmill/pref-window/test-font-chooser.js</span>
<a href="#l131.3"></a><span id="l131.3" class="difflineat">@@ -7,21 +7,29 @@</span>
<a href="#l131.4"></a><span id="l131.4">  * Test various things about the font chooser window, including</span>
<a href="#l131.5"></a><span id="l131.5">  * - whether if the font defined in font.name.&lt;style&gt;.&lt;language&gt; is not present</span>
<a href="#l131.6"></a><span id="l131.6">  * on the computer, we fall back to displaying what's in</span>
<a href="#l131.7"></a><span id="l131.7">  * font.name-list.&lt;style&gt;.&lt;language&gt;.</span>
<a href="#l131.8"></a><span id="l131.8">  */</span>
<a href="#l131.9"></a><span id="l131.9"> </span>
<a href="#l131.10"></a><span id="l131.10"> &quot;use strict&quot;;</span>
<a href="#l131.11"></a><span id="l131.11"> </span>
<a href="#l131.12"></a><span id="l131.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l131.13"></a><span id="l131.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l131.14"></a><span id="l131.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-pref-window-helpers.js */</span>
<a href="#l131.15"></a><span id="l131.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l131.16"></a><span id="l131.16" class="difflineplus">+</span>
<a href="#l131.17"></a><span id="l131.17"> var MODULE_NAME = &quot;test-font-chooser&quot;;</span>
<a href="#l131.18"></a><span id="l131.18" class="difflineminus">-</span>
<a href="#l131.19"></a><span id="l131.19"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l131.20"></a><span id="l131.20" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l131.21"></a><span id="l131.21" class="difflineminus">-                       &quot;pref-window-helpers&quot;, &quot;content-tab-helpers&quot;];</span>
<a href="#l131.22"></a><span id="l131.22" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l131.23"></a><span id="l131.23" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l131.24"></a><span id="l131.24" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l131.25"></a><span id="l131.25" class="difflineplus">+  &quot;pref-window-helpers&quot;,</span>
<a href="#l131.26"></a><span id="l131.26" class="difflineplus">+  &quot;content-tab-helpers&quot;,</span>
<a href="#l131.27"></a><span id="l131.27" class="difflineplus">+];</span>
<a href="#l131.28"></a><span id="l131.28"> </span>
<a href="#l131.29"></a><span id="l131.29"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l131.30"></a><span id="l131.30"> var {AppConstants} = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l131.31"></a><span id="l131.31"> var {Preferences} = ChromeUtils.import(&quot;resource://gre/modules/Preferences.jsm&quot;);</span>
<a href="#l131.32"></a><span id="l131.32"> </span>
<a href="#l131.33"></a><span id="l131.33"> var gFontEnumerator;</span>
<a href="#l131.34"></a><span id="l131.34"> var gTodayPane;</span>
<a href="#l131.35"></a><span id="l131.35"> </span>
<a href="#l131.36"></a><span id="l131.36" class="difflineat">@@ -108,32 +116,31 @@ function _verify_fonts_displayed(aDefaul</span>
<a href="#l131.37"></a><span id="l131.37">     fontc.waitFor(() =&gt; fontc.e(fontElemId).label != &quot;&quot;,</span>
<a href="#l131.38"></a><span id="l131.38">                   &quot;Timeout waiting for font picker '&quot; + fontElemId + &quot;' to populate.&quot;);</span>
<a href="#l131.39"></a><span id="l131.39">   }</span>
<a href="#l131.40"></a><span id="l131.40"> </span>
<a href="#l131.41"></a><span id="l131.41">   if (!aDefaults) {</span>
<a href="#l131.42"></a><span id="l131.42">     assert_fonts_equal(&quot;serif&quot;, aSerif, fontc.e(&quot;serif&quot;).value);</span>
<a href="#l131.43"></a><span id="l131.43">     assert_fonts_equal(&quot;sans-serif&quot;, aSansSerif, fontc.e(&quot;sans-serif&quot;).value);</span>
<a href="#l131.44"></a><span id="l131.44">     assert_fonts_equal(&quot;monospace&quot;, aMonospace, fontc.e(&quot;monospace&quot;).value);</span>
<a href="#l131.45"></a><span id="l131.45" class="difflineminus">-  } else {</span>
<a href="#l131.46"></a><span id="l131.46" class="difflineplus">+  } else if (AppConstants.platform == &quot;linux&quot;) {</span>
<a href="#l131.47"></a><span id="l131.47">     // When default fonts are displayed in the menulist, there is no value set,</span>
<a href="#l131.48"></a><span id="l131.48">     // only the label, in the form &quot;Default (font name)&quot;.</span>
<a href="#l131.49"></a><span id="l131.49" class="difflineminus">-    if (AppConstants.platform == &quot;linux&quot;) {</span>
<a href="#l131.50"></a><span id="l131.50" class="difflineminus">-      // On Linux the prefs we set contained only the generic font names,</span>
<a href="#l131.51"></a><span id="l131.51" class="difflineminus">-      // like 'serif', but here a specific font name will be shown, but it is</span>
<a href="#l131.52"></a><span id="l131.52" class="difflineminus">-      // system-dependent what it will be. So we just check for the 'Default'</span>
<a href="#l131.53"></a><span id="l131.53" class="difflineminus">-      // prefix.</span>
<a href="#l131.54"></a><span id="l131.54" class="difflineminus">-      assert_fonts_equal(&quot;serif&quot;, `Default (`, fontc.e(&quot;serif&quot;).label, true);</span>
<a href="#l131.55"></a><span id="l131.55" class="difflineminus">-      assert_fonts_equal(&quot;sans-serif&quot;, `Default (`, fontc.e(&quot;sans-serif&quot;).label, true);</span>
<a href="#l131.56"></a><span id="l131.56" class="difflineminus">-      assert_fonts_equal(&quot;monospace&quot;, `Default (`, fontc.e(&quot;monospace&quot;).label, true);</span>
<a href="#l131.57"></a><span id="l131.57" class="difflineminus">-    } else {</span>
<a href="#l131.58"></a><span id="l131.58" class="difflineminus">-      assert_fonts_equal(&quot;serif&quot;, `Default (${aSerif})`, fontc.e(&quot;serif&quot;).label);</span>
<a href="#l131.59"></a><span id="l131.59" class="difflineminus">-      assert_fonts_equal(&quot;sans-serif&quot;, `Default (${aSansSerif})`, fontc.e(&quot;sans-serif&quot;).label);</span>
<a href="#l131.60"></a><span id="l131.60" class="difflineminus">-      assert_fonts_equal(&quot;monospace&quot;, `Default (${aMonospace})`, fontc.e(&quot;monospace&quot;).label);</span>
<a href="#l131.61"></a><span id="l131.61" class="difflineminus">-    }</span>
<a href="#l131.62"></a><span id="l131.62" class="difflineplus">+</span>
<a href="#l131.63"></a><span id="l131.63" class="difflineplus">+    // On Linux the prefs we set contained only the generic font names,</span>
<a href="#l131.64"></a><span id="l131.64" class="difflineplus">+    // like 'serif', but here a specific font name will be shown, but it is</span>
<a href="#l131.65"></a><span id="l131.65" class="difflineplus">+    // system-dependent what it will be. So we just check for the 'Default'</span>
<a href="#l131.66"></a><span id="l131.66" class="difflineplus">+    // prefix.</span>
<a href="#l131.67"></a><span id="l131.67" class="difflineplus">+    assert_fonts_equal(&quot;serif&quot;, `Default (`, fontc.e(&quot;serif&quot;).label, true);</span>
<a href="#l131.68"></a><span id="l131.68" class="difflineplus">+    assert_fonts_equal(&quot;sans-serif&quot;, `Default (`, fontc.e(&quot;sans-serif&quot;).label, true);</span>
<a href="#l131.69"></a><span id="l131.69" class="difflineplus">+    assert_fonts_equal(&quot;monospace&quot;, `Default (`, fontc.e(&quot;monospace&quot;).label, true);</span>
<a href="#l131.70"></a><span id="l131.70" class="difflineplus">+  } else {</span>
<a href="#l131.71"></a><span id="l131.71" class="difflineplus">+    assert_fonts_equal(&quot;serif&quot;, `Default (${aSerif})`, fontc.e(&quot;serif&quot;).label);</span>
<a href="#l131.72"></a><span id="l131.72" class="difflineplus">+    assert_fonts_equal(&quot;sans-serif&quot;, `Default (${aSansSerif})`, fontc.e(&quot;sans-serif&quot;).label);</span>
<a href="#l131.73"></a><span id="l131.73" class="difflineplus">+    assert_fonts_equal(&quot;monospace&quot;, `Default (${aMonospace})`, fontc.e(&quot;monospace&quot;).label);</span>
<a href="#l131.74"></a><span id="l131.74">   }</span>
<a href="#l131.75"></a><span id="l131.75"> </span>
<a href="#l131.76"></a><span id="l131.76">   close_pref_tab(prefTab);</span>
<a href="#l131.77"></a><span id="l131.77"> }</span>
<a href="#l131.78"></a><span id="l131.78"> </span>
<a href="#l131.79"></a><span id="l131.79"> /**</span>
<a href="#l131.80"></a><span id="l131.80">  * Test that for a particular language, whatever's in</span>
<a href="#l131.81"></a><span id="l131.81">  * font.name.&lt;type&gt;.&lt;language&gt; is displayed in the font chooser (if it is</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l132.1"></a><span id="l132.1" class="difflineminus">--- a/mail/test/mozmill/quick-filter-bar/test-display-issues.js</span>
<a href="#l132.2"></a><span id="l132.2" class="difflineplus">+++ b/mail/test/mozmill/quick-filter-bar/test-display-issues.js</span>
<a href="#l132.3"></a><span id="l132.3" class="difflineat">@@ -6,22 +6,29 @@</span>
<a href="#l132.4"></a><span id="l132.4">  * Test things of a visual nature.</span>
<a href="#l132.5"></a><span id="l132.5">  *</span>
<a href="#l132.6"></a><span id="l132.6">  * Note: this test requires a screen resolution of 1280 x 1024 which is standard on</span>
<a href="#l132.7"></a><span id="l132.7">  * the unit test machines (see also testing/machine-configuration.json).</span>
<a href="#l132.8"></a><span id="l132.8">  */</span>
<a href="#l132.9"></a><span id="l132.9"> </span>
<a href="#l132.10"></a><span id="l132.10"> &quot;use strict&quot;;</span>
<a href="#l132.11"></a><span id="l132.11"> </span>
<a href="#l132.12"></a><span id="l132.12" class="difflineminus">-var MODULE_NAME = &quot;test-display-issues&quot;;</span>
<a href="#l132.13"></a><span id="l132.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-dom-helpers.js */</span>
<a href="#l132.14"></a><span id="l132.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l132.15"></a><span id="l132.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-quick-filter-bar-helpers.js */</span>
<a href="#l132.16"></a><span id="l132.16" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l132.17"></a><span id="l132.17"> </span>
<a href="#l132.18"></a><span id="l132.18" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l132.19"></a><span id="l132.19" class="difflineminus">-</span>
<a href="#l132.20"></a><span id="l132.20" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l132.21"></a><span id="l132.21" class="difflineminus">-                       &quot;quick-filter-bar-helper&quot;, &quot;dom-helpers&quot;];</span>
<a href="#l132.22"></a><span id="l132.22" class="difflineplus">+var MODULE_NAME = &quot;test-display-issues&quot;;</span>
<a href="#l132.23"></a><span id="l132.23" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l132.24"></a><span id="l132.24" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l132.25"></a><span id="l132.25" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l132.26"></a><span id="l132.26" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l132.27"></a><span id="l132.27" class="difflineplus">+  &quot;quick-filter-bar-helpers&quot;,</span>
<a href="#l132.28"></a><span id="l132.28" class="difflineplus">+  &quot;dom-helpers&quot;,</span>
<a href="#l132.29"></a><span id="l132.29" class="difflineplus">+];</span>
<a href="#l132.30"></a><span id="l132.30"> </span>
<a href="#l132.31"></a><span id="l132.31"> var folder;</span>
<a href="#l132.32"></a><span id="l132.32"> var setUnstarred, setStarred;</span>
<a href="#l132.33"></a><span id="l132.33"> var gOriginalPaneWidth;</span>
<a href="#l132.34"></a><span id="l132.34"> </span>
<a href="#l132.35"></a><span id="l132.35"> var gEnlargedWindowWidth = 1260;</span>
<a href="#l132.36"></a><span id="l132.36"> var gShrunkenWindowWidth = 600;</span>
<a href="#l132.37"></a><span id="l132.37"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l133.1"></a><span id="l133.1" class="difflineminus">--- a/mail/test/mozmill/quick-filter-bar/test-filter-logic.js</span>
<a href="#l133.2"></a><span id="l133.2" class="difflineplus">+++ b/mail/test/mozmill/quick-filter-bar/test-filter-logic.js</span>
<a href="#l133.3"></a><span id="l133.3" class="difflineat">@@ -2,86 +2,85 @@</span>
<a href="#l133.4"></a><span id="l133.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l133.5"></a><span id="l133.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l133.6"></a><span id="l133.6"> </span>
<a href="#l133.7"></a><span id="l133.7"> /**</span>
<a href="#l133.8"></a><span id="l133.8">  * Verify that we are constructing the filters that we expect and that they</span>
<a href="#l133.9"></a><span id="l133.9">  * are hooked up to the right buttons.</span>
<a href="#l133.10"></a><span id="l133.10">  */</span>
<a href="#l133.11"></a><span id="l133.11"> </span>
<a href="#l133.12"></a><span id="l133.12" class="difflineminus">-// make SOLO_TEST=quick-filter-bar/test-filter-logic.js mozmill-one</span>
<a href="#l133.13"></a><span id="l133.13" class="difflineminus">-</span>
<a href="#l133.14"></a><span id="l133.14"> &quot;use strict&quot;;</span>
<a href="#l133.15"></a><span id="l133.15"> </span>
<a href="#l133.16"></a><span id="l133.16" class="difflineminus">-var MODULE_NAME = 'test-filter-logic';</span>
<a href="#l133.17"></a><span id="l133.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l133.18"></a><span id="l133.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-quick-filter-bar-helpers.js */</span>
<a href="#l133.19"></a><span id="l133.19" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l133.20"></a><span id="l133.20"> </span>
<a href="#l133.21"></a><span id="l133.21" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l133.22"></a><span id="l133.22" class="difflineminus">-</span>
<a href="#l133.23"></a><span id="l133.23" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l133.24"></a><span id="l133.24" class="difflineminus">-                       'quick-filter-bar-helper'];</span>
<a href="#l133.25"></a><span id="l133.25" class="difflineplus">+var MODULE_NAME = &quot;test-filter-logic&quot;;</span>
<a href="#l133.26"></a><span id="l133.26" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l133.27"></a><span id="l133.27" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;quick-filter-bar-helpers&quot;];</span>
<a href="#l133.28"></a><span id="l133.28"> </span>
<a href="#l133.29"></a><span id="l133.29"> function setupModule(module) {</span>
<a href="#l133.30"></a><span id="l133.30">   collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l133.31"></a><span id="l133.31">   collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l133.32"></a><span id="l133.32" class="difflineminus">-  collector.getModule(&quot;quick-filter-bar-helper&quot;).installInto(module);</span>
<a href="#l133.33"></a><span id="l133.33" class="difflineplus">+  collector.getModule(&quot;quick-filter-bar-helpers&quot;).installInto(module);</span>
<a href="#l133.34"></a><span id="l133.34"> }</span>
<a href="#l133.35"></a><span id="l133.35"> </span>
<a href="#l133.36"></a><span id="l133.36"> function test_filter_unread() {</span>
<a href="#l133.37"></a><span id="l133.37">   let folder = create_folder(&quot;QuickFilterBarFilterUnread&quot;);</span>
<a href="#l133.38"></a><span id="l133.38">   let [unread, read] = make_new_sets_in_folder(folder,</span>
<a href="#l133.39"></a><span id="l133.39">     [{count: 1}, {count: 1}]);</span>
<a href="#l133.40"></a><span id="l133.40">   read.setRead(true);</span>
<a href="#l133.41"></a><span id="l133.41"> </span>
<a href="#l133.42"></a><span id="l133.42">   be_in_folder(folder);</span>
<a href="#l133.43"></a><span id="l133.43">   toggle_boolean_constraints(&quot;unread&quot;);</span>
<a href="#l133.44"></a><span id="l133.44">   assert_messages_in_view(unread);</span>
<a href="#l133.45"></a><span id="l133.45"> }</span>
<a href="#l133.46"></a><span id="l133.46"> </span>
<a href="#l133.47"></a><span id="l133.47"> function test_filter_starred() {</span>
<a href="#l133.48"></a><span id="l133.48">   let folder = create_folder(&quot;QuickFilterBarFilterStarred&quot;);</span>
<a href="#l133.49"></a><span id="l133.49" class="difflineminus">-  let [unstarred, starred] = make_new_sets_in_folder(folder,</span>
<a href="#l133.50"></a><span id="l133.50" class="difflineplus">+  let [, starred] = make_new_sets_in_folder(folder,</span>
<a href="#l133.51"></a><span id="l133.51">     [{count: 1}, {count: 1}]);</span>
<a href="#l133.52"></a><span id="l133.52">   starred.setStarred(true);</span>
<a href="#l133.53"></a><span id="l133.53"> </span>
<a href="#l133.54"></a><span id="l133.54">   be_in_folder(folder);</span>
<a href="#l133.55"></a><span id="l133.55">   toggle_boolean_constraints(&quot;starred&quot;);</span>
<a href="#l133.56"></a><span id="l133.56">   assert_messages_in_view(starred);</span>
<a href="#l133.57"></a><span id="l133.57"> }</span>
<a href="#l133.58"></a><span id="l133.58"> </span>
<a href="#l133.59"></a><span id="l133.59"> function test_filter_simple_intersection_unread_and_starred() {</span>
<a href="#l133.60"></a><span id="l133.60">   let folder = create_folder(&quot;QuickFilterBarFilterUnreadAndStarred&quot;);</span>
<a href="#l133.61"></a><span id="l133.61" class="difflineminus">-  let [unreadUnstarred, readUnstarred, unreadStarred, readStarred] =</span>
<a href="#l133.62"></a><span id="l133.62" class="difflineplus">+  let [, readUnstarred, unreadStarred, readStarred] =</span>
<a href="#l133.63"></a><span id="l133.63">     make_new_sets_in_folder(folder,</span>
<a href="#l133.64"></a><span id="l133.64">       [{count: 1}, {count: 1}, {count: 1}, {count: 1}]);</span>
<a href="#l133.65"></a><span id="l133.65">   readUnstarred.setRead(true);</span>
<a href="#l133.66"></a><span id="l133.66">   unreadStarred.setStarred(true);</span>
<a href="#l133.67"></a><span id="l133.67">   readStarred.setRead(true);</span>
<a href="#l133.68"></a><span id="l133.68">   readStarred.setStarred(true);</span>
<a href="#l133.69"></a><span id="l133.69"> </span>
<a href="#l133.70"></a><span id="l133.70">   be_in_folder(folder);</span>
<a href="#l133.71"></a><span id="l133.71">   toggle_boolean_constraints(&quot;unread&quot;, &quot;starred&quot;);</span>
<a href="#l133.72"></a><span id="l133.72"> </span>
<a href="#l133.73"></a><span id="l133.73">   assert_messages_in_view(unreadStarred);</span>
<a href="#l133.74"></a><span id="l133.74"> }</span>
<a href="#l133.75"></a><span id="l133.75"> </span>
<a href="#l133.76"></a><span id="l133.76"> function test_filter_attachments() {</span>
<a href="#l133.77"></a><span id="l133.77">   let attachSetDef = {</span>
<a href="#l133.78"></a><span id="l133.78">     count: 1,</span>
<a href="#l133.79"></a><span id="l133.79" class="difflineminus">-    attachments: [{filename: 'foo.png',</span>
<a href="#l133.80"></a><span id="l133.80" class="difflineminus">-                   contentType: 'image/png',</span>
<a href="#l133.81"></a><span id="l133.81" class="difflineminus">-                   encoding: 'base64', charset: null,</span>
<a href="#l133.82"></a><span id="l133.82" class="difflineminus">-                   body: 'YWJj\n', format: null}],</span>
<a href="#l133.83"></a><span id="l133.83" class="difflineplus">+    attachments: [{filename: &quot;foo.png&quot;,</span>
<a href="#l133.84"></a><span id="l133.84" class="difflineplus">+                   contentType: &quot;image/png&quot;,</span>
<a href="#l133.85"></a><span id="l133.85" class="difflineplus">+                   encoding: &quot;base64&quot;, charset: null,</span>
<a href="#l133.86"></a><span id="l133.86" class="difflineplus">+                   body: &quot;YWJj\n&quot;, format: null}],</span>
<a href="#l133.87"></a><span id="l133.87">   };</span>
<a href="#l133.88"></a><span id="l133.88">   let noAttachSetDef = {</span>
<a href="#l133.89"></a><span id="l133.89">     count: 1,</span>
<a href="#l133.90"></a><span id="l133.90">   };</span>
<a href="#l133.91"></a><span id="l133.91"> </span>
<a href="#l133.92"></a><span id="l133.92"> </span>
<a href="#l133.93"></a><span id="l133.93">   let folder = create_folder(&quot;QuickFilterBarFilterAttachments&quot;);</span>
<a href="#l133.94"></a><span id="l133.94" class="difflineminus">-  let [setNoAttach, setAttach] = make_new_sets_in_folder(folder,</span>
<a href="#l133.95"></a><span id="l133.95" class="difflineplus">+  let [, setAttach] = make_new_sets_in_folder(folder,</span>
<a href="#l133.96"></a><span id="l133.96">     [noAttachSetDef, attachSetDef]);</span>
<a href="#l133.97"></a><span id="l133.97"> </span>
<a href="#l133.98"></a><span id="l133.98">   be_in_folder(folder);</span>
<a href="#l133.99"></a><span id="l133.99">   toggle_boolean_constraints(&quot;attachments&quot;);</span>
<a href="#l133.100"></a><span id="l133.100"> </span>
<a href="#l133.101"></a><span id="l133.101">   assert_messages_in_view(setAttach);</span>
<a href="#l133.102"></a><span id="l133.102"> }</span>
<a href="#l133.103"></a><span id="l133.103"> </span>
<a href="#l133.104"></a><span id="l133.104" class="difflineat">@@ -105,22 +104,21 @@ function add_email_to_address_book(aEmai</span>
<a href="#l133.105"></a><span id="l133.105">   }</span>
<a href="#l133.106"></a><span id="l133.106"> </span>
<a href="#l133.107"></a><span id="l133.107">   throw new Error(&quot;Unable to find any suitable address book.&quot;);</span>
<a href="#l133.108"></a><span id="l133.108"> }</span>
<a href="#l133.109"></a><span id="l133.109"> </span>
<a href="#l133.110"></a><span id="l133.110"> function test_filter_in_address_book() {</span>
<a href="#l133.111"></a><span id="l133.111">   let bookSetDef = {</span>
<a href="#l133.112"></a><span id="l133.112">     from: [&quot;Qbert Q Qbington&quot;, &quot;q@q.invalid&quot;],</span>
<a href="#l133.113"></a><span id="l133.113" class="difflineminus">-    count: 1</span>
<a href="#l133.114"></a><span id="l133.114" class="difflineplus">+    count: 1,</span>
<a href="#l133.115"></a><span id="l133.115">   };</span>
<a href="#l133.116"></a><span id="l133.116">   add_email_to_address_book(bookSetDef.from[1]);</span>
<a href="#l133.117"></a><span id="l133.117">   let folder = create_folder(&quot;MesssageFilterBarInAddressBook&quot;);</span>
<a href="#l133.118"></a><span id="l133.118" class="difflineminus">-  let [setBook, setNoBook] = make_new_sets_in_folder(folder,</span>
<a href="#l133.119"></a><span id="l133.119" class="difflineminus">-                               [bookSetDef, {count: 1}]);</span>
<a href="#l133.120"></a><span id="l133.120" class="difflineplus">+  let [setBook] = make_new_sets_in_folder(folder, [bookSetDef, {count: 1}]);</span>
<a href="#l133.121"></a><span id="l133.121">   be_in_folder(folder);</span>
<a href="#l133.122"></a><span id="l133.122">   toggle_boolean_constraints(&quot;addrbook&quot;);</span>
<a href="#l133.123"></a><span id="l133.123">   assert_messages_in_view(setBook);</span>
<a href="#l133.124"></a><span id="l133.124"> }</span>
<a href="#l133.125"></a><span id="l133.125"> </span>
<a href="#l133.126"></a><span id="l133.126"> function test_filter_tags() {</span>
<a href="#l133.127"></a><span id="l133.127">   let folder = create_folder(&quot;QuickFilterBarTags&quot;);</span>
<a href="#l133.128"></a><span id="l133.128">   const tagA = &quot;$label1&quot;, tagB = &quot;$label2&quot;, tagC = &quot;$label3&quot;;</span>
<a href="#l133.129"></a><span id="l133.129" class="difflineat">@@ -167,19 +165,19 @@ function test_filter_tags() {</span>
<a href="#l133.130"></a><span id="l133.130">   toggle_boolean_constraints(&quot;tags&quot;); // no constraints</span>
<a href="#l133.131"></a><span id="l133.131">   toggle_boolean_constraints(&quot;tags&quot;); // should be any tag (not tagC!)</span>
<a href="#l133.132"></a><span id="l133.132">   assert_messages_in_view([setTagA, setTagB, setTagAB, setTagC]);</span>
<a href="#l133.133"></a><span id="l133.133"> }</span>
<a href="#l133.134"></a><span id="l133.134"> </span>
<a href="#l133.135"></a><span id="l133.135"> function test_filter_text_single_word_and_predicates() {</span>
<a href="#l133.136"></a><span id="l133.136">   let folder = create_folder(&quot;QuickFilterBarTextSingleWord&quot;);</span>
<a href="#l133.137"></a><span id="l133.137">   let whoFoo = [&quot;zabba&quot;, &quot;foo@madeup.invalid&quot;];</span>
<a href="#l133.138"></a><span id="l133.138" class="difflineminus">-  let [setInert, setSenderFoo, setRecipientsFoo, setSubjectFoo, setBodyFoo] =</span>
<a href="#l133.139"></a><span id="l133.139" class="difflineplus">+  let [, setSenderFoo, setRecipientsFoo, setSubjectFoo, setBodyFoo] =</span>
<a href="#l133.140"></a><span id="l133.140">     make_new_sets_in_folder(folder, [</span>
<a href="#l133.141"></a><span id="l133.141" class="difflineminus">-      {count: 1}, {count:1, from: whoFoo}, {count: 1, to: [whoFoo]},</span>
<a href="#l133.142"></a><span id="l133.142" class="difflineplus">+      {count: 1}, {count: 1, from: whoFoo}, {count: 1, to: [whoFoo]},</span>
<a href="#l133.143"></a><span id="l133.143">       {count: 1, subject: &quot;foo&quot;}, {count: 1, body: {body: &quot;foo&quot;}}]);</span>
<a href="#l133.144"></a><span id="l133.144">   be_in_folder(folder);</span>
<a href="#l133.145"></a><span id="l133.145"> </span>
<a href="#l133.146"></a><span id="l133.146">   // by default, sender/recipients/subject are selected</span>
<a href="#l133.147"></a><span id="l133.147">   assert_text_constraints_checked(&quot;sender&quot;, &quot;recipients&quot;, &quot;subject&quot;);</span>
<a href="#l133.148"></a><span id="l133.148"> </span>
<a href="#l133.149"></a><span id="l133.149">   // con defaults, por favor</span>
<a href="#l133.150"></a><span id="l133.150">   set_filter_text(&quot;foo&quot;);</span>
<a href="#l133.151"></a><span id="l133.151" class="difflineat">@@ -223,19 +221,19 @@ function test_filter_text_single_word_an</span>
<a href="#l133.152"></a><span id="l133.152">  *  constitutes sufficient positive coverage, although we also want to make</span>
<a href="#l133.153"></a><span id="l133.153">  *  sure that just a single term match is insufficient.</span>
<a href="#l133.154"></a><span id="l133.154">  */</span>
<a href="#l133.155"></a><span id="l133.155"> function test_filter_text_multi_word() {</span>
<a href="#l133.156"></a><span id="l133.156">   let folder = create_folder(&quot;QuickFilterBarTextMultiWord&quot;);</span>
<a href="#l133.157"></a><span id="l133.157"> </span>
<a href="#l133.158"></a><span id="l133.158">   let whoFoo = [&quot;foo&quot;, &quot;zabba@madeup.invalid&quot;];</span>
<a href="#l133.159"></a><span id="l133.159">   let whoBar = [&quot;zabba&quot;, &quot;bar@madeup.invalid&quot;];</span>
<a href="#l133.160"></a><span id="l133.160" class="difflineminus">-  let [setInert, setPeepMatch, setSubjReverse, setSubjectJustFoo] =</span>
<a href="#l133.161"></a><span id="l133.161" class="difflineplus">+  let [, setPeepMatch, setSubjReverse] =</span>
<a href="#l133.162"></a><span id="l133.162">     make_new_sets_in_folder(folder, [</span>
<a href="#l133.163"></a><span id="l133.163" class="difflineminus">-      {count: 1}, {count:1, from: whoFoo, to: [whoBar]},</span>
<a href="#l133.164"></a><span id="l133.164" class="difflineplus">+      {count: 1}, {count: 1, from: whoFoo, to: [whoBar]},</span>
<a href="#l133.165"></a><span id="l133.165">       {count: 1, subject: &quot;bar foo&quot;}, {count: 1, from: whoFoo}]);</span>
<a href="#l133.166"></a><span id="l133.166">   be_in_folder(folder);</span>
<a href="#l133.167"></a><span id="l133.167"> </span>
<a href="#l133.168"></a><span id="l133.168">   // (precondition)</span>
<a href="#l133.169"></a><span id="l133.169">   assert_text_constraints_checked(&quot;sender&quot;, &quot;recipients&quot;, &quot;subject&quot;);</span>
<a href="#l133.170"></a><span id="l133.170"> </span>
<a href="#l133.171"></a><span id="l133.171">   set_filter_text(&quot;foo bar&quot;);</span>
<a href="#l133.172"></a><span id="l133.172">   assert_messages_in_view([setPeepMatch, setSubjReverse]);</span>
<a href="#l133.173"></a><span id="l133.173" class="difflineat">@@ -246,19 +244,17 @@ function test_filter_text_multi_word() {</span>
<a href="#l133.174"></a><span id="l133.174">  * | (Pipe character) - Bug 586131</span>
<a href="#l133.175"></a><span id="l133.175">  */</span>
<a href="#l133.176"></a><span id="l133.176"> function test_filter_or_operator() {</span>
<a href="#l133.177"></a><span id="l133.177">   let folder = create_folder(&quot;QuickFilterBarOrOperator&quot;);</span>
<a href="#l133.178"></a><span id="l133.178"> </span>
<a href="#l133.179"></a><span id="l133.179">   let whoFoo = [&quot;foo&quot;, &quot;zabba@madeup.invalid&quot;];</span>
<a href="#l133.180"></a><span id="l133.180">   let whoBar = [&quot;zabba&quot;, &quot;bar@madeup.invalid&quot;];</span>
<a href="#l133.181"></a><span id="l133.181">   let whoTest = [&quot;test&quot;, &quot;test@madeup.invalid&quot;];</span>
<a href="#l133.182"></a><span id="l133.182" class="difflineminus">-  let [setInert, setSenderFoo, setToBar,</span>
<a href="#l133.183"></a><span id="l133.183" class="difflineminus">-       setSubject1, setSubject2, setSubject3,</span>
<a href="#l133.184"></a><span id="l133.184" class="difflineminus">-       setMail1, setMail2] =</span>
<a href="#l133.185"></a><span id="l133.185" class="difflineplus">+  let [setInert, setSenderFoo, setToBar, , , setSubject3, setMail1] =</span>
<a href="#l133.186"></a><span id="l133.186">     make_new_sets_in_folder(folder, [</span>
<a href="#l133.187"></a><span id="l133.187">       {count: 1},</span>
<a href="#l133.188"></a><span id="l133.188">       {count: 1, from: whoFoo},</span>
<a href="#l133.189"></a><span id="l133.189">       {count: 1, to: [whoBar]},</span>
<a href="#l133.190"></a><span id="l133.190">       {count: 1, subject: &quot;foo bar&quot;},</span>
<a href="#l133.191"></a><span id="l133.191">       {count: 1, subject: &quot;bar test&quot;},</span>
<a href="#l133.192"></a><span id="l133.192">       {count: 1, subject: &quot;test&quot;},</span>
<a href="#l133.193"></a><span id="l133.193">       {count: 1, to: [whoTest], subject: &quot;logic&quot;},</span>
<a href="#l133.194"></a><span id="l133.194" class="difflineat">@@ -293,17 +289,17 @@ function test_filter_or_operator() {</span>
<a href="#l133.195"></a><span id="l133.195"> function test_filter_text_constraints_propagate() {</span>
<a href="#l133.196"></a><span id="l133.196">   let whoFoo = [&quot;foo&quot;, &quot;zabba@madeup.invalid&quot;];</span>
<a href="#l133.197"></a><span id="l133.197">   let whoBar = [&quot;zabba&quot;, &quot;bar@madeup.invalid&quot;];</span>
<a href="#l133.198"></a><span id="l133.198"> </span>
<a href="#l133.199"></a><span id="l133.199">   let folderOne = create_folder(&quot;QuickFilterBarTextPropagate1&quot;);</span>
<a href="#l133.200"></a><span id="l133.200">   let [setSubjFoo, setWhoFoo] = make_new_sets_in_folder(folderOne,</span>
<a href="#l133.201"></a><span id="l133.201">     [{count: 1, subject: &quot;foo&quot;}, {count: 1, from: whoFoo}]);</span>
<a href="#l133.202"></a><span id="l133.202">   let folderTwo = create_folder(&quot;QuickFilterBarTextPropagate2&quot;);</span>
<a href="#l133.203"></a><span id="l133.203" class="difflineminus">-  let [setSubjBar, setWhoBar] = make_new_sets_in_folder(folderTwo,</span>
<a href="#l133.204"></a><span id="l133.204" class="difflineplus">+  let [, setWhoBar] = make_new_sets_in_folder(folderTwo,</span>
<a href="#l133.205"></a><span id="l133.205">     [{count: 1, subject: &quot;bar&quot;}, {count: 1, from: whoBar}]);</span>
<a href="#l133.206"></a><span id="l133.206"> </span>
<a href="#l133.207"></a><span id="l133.207">   be_in_folder(folderOne);</span>
<a href="#l133.208"></a><span id="l133.208">   set_filter_text(&quot;foo&quot;);</span>
<a href="#l133.209"></a><span id="l133.209">   // (precondition)</span>
<a href="#l133.210"></a><span id="l133.210">   assert_text_constraints_checked(&quot;sender&quot;, &quot;recipients&quot;, &quot;subject&quot;);</span>
<a href="#l133.211"></a><span id="l133.211">   assert_messages_in_view([setSubjFoo, setWhoFoo]);</span>
<a href="#l133.212"></a><span id="l133.212"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l134.1"></a><span id="l134.1" class="difflineminus">--- a/mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js</span>
<a href="#l134.2"></a><span id="l134.2" class="difflineplus">+++ b/mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js</span>
<a href="#l134.3"></a><span id="l134.3" class="difflineat">@@ -6,31 +6,32 @@</span>
<a href="#l134.4"></a><span id="l134.4">  * Tests keyboard stuff that doesn't fall under some other test's heading.</span>
<a href="#l134.5"></a><span id="l134.5">  * Namely, control-shift-k toggling the bar into existence happens in</span>
<a href="#l134.6"></a><span id="l134.6">  * test-toggle-bar.js, but we test that repeatedly hitting control-shift-k</span>
<a href="#l134.7"></a><span id="l134.7">  * selects the text entered in the quick filter bar.</span>
<a href="#l134.8"></a><span id="l134.8">  */</span>
<a href="#l134.9"></a><span id="l134.9"> </span>
<a href="#l134.10"></a><span id="l134.10"> &quot;use strict&quot;;</span>
<a href="#l134.11"></a><span id="l134.11"> </span>
<a href="#l134.12"></a><span id="l134.12" class="difflineminus">-var MODULE_NAME = 'test-keyboard-interface';</span>
<a href="#l134.13"></a><span id="l134.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l134.14"></a><span id="l134.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-quick-filter-bar-helpers.js */</span>
<a href="#l134.15"></a><span id="l134.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l134.16"></a><span id="l134.16"> </span>
<a href="#l134.17"></a><span id="l134.17" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l134.18"></a><span id="l134.18" class="difflineminus">-</span>
<a href="#l134.19"></a><span id="l134.19" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l134.20"></a><span id="l134.20" class="difflineminus">-                       'quick-filter-bar-helper'];</span>
<a href="#l134.21"></a><span id="l134.21" class="difflineplus">+var MODULE_NAME = &quot;test-keyboard-interface&quot;;</span>
<a href="#l134.22"></a><span id="l134.22" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l134.23"></a><span id="l134.23" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;quick-filter-bar-helpers&quot;];</span>
<a href="#l134.24"></a><span id="l134.24"> </span>
<a href="#l134.25"></a><span id="l134.25"> var folder;</span>
<a href="#l134.26"></a><span id="l134.26"> </span>
<a href="#l134.27"></a><span id="l134.27"> function setupModule(module) {</span>
<a href="#l134.28"></a><span id="l134.28" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l134.29"></a><span id="l134.29" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l134.30"></a><span id="l134.30">   fdh.installInto(module);</span>
<a href="#l134.31"></a><span id="l134.31" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l134.32"></a><span id="l134.32" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l134.33"></a><span id="l134.33">   wh.installInto(module);</span>
<a href="#l134.34"></a><span id="l134.34" class="difflineminus">-  let qfb = collector.getModule('quick-filter-bar-helper');</span>
<a href="#l134.35"></a><span id="l134.35" class="difflineplus">+  let qfb = collector.getModule(&quot;quick-filter-bar-helpers&quot;);</span>
<a href="#l134.36"></a><span id="l134.36">   qfb.installInto(module);</span>
<a href="#l134.37"></a><span id="l134.37"> </span>
<a href="#l134.38"></a><span id="l134.38">   folder = create_folder(&quot;QuickFilterBarKeyboardInterface&quot;);</span>
<a href="#l134.39"></a><span id="l134.39">   // we need a message so we can select it so we can find in message</span>
<a href="#l134.40"></a><span id="l134.40">   make_new_sets_in_folder(folder, [{count: 1}]);</span>
<a href="#l134.41"></a><span id="l134.41">   be_in_folder(folder);</span>
<a href="#l134.42"></a><span id="l134.42"> }</span>
<a href="#l134.43"></a><span id="l134.43"> </span>
<a href="#l134.44"></a><span id="l134.44" class="difflineat">@@ -111,18 +112,17 @@ function test_escape_does_not_reach_us_f</span>
<a href="#l134.45"></a><span id="l134.45">   try {</span>
<a href="#l134.46"></a><span id="l134.46">     // uncollapse and focus the gloda search widget</span>
<a href="#l134.47"></a><span id="l134.47">     glodaSearchWidget.collapsed = false;</span>
<a href="#l134.48"></a><span id="l134.48">     glodaSearchWidget.focus();</span>
<a href="#l134.49"></a><span id="l134.49"> </span>
<a href="#l134.50"></a><span id="l134.50">     mc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l134.51"></a><span id="l134.51"> </span>
<a href="#l134.52"></a><span id="l134.52">     assert_quick_filter_bar_visible(true);</span>
<a href="#l134.53"></a><span id="l134.53" class="difflineminus">-  }</span>
<a href="#l134.54"></a><span id="l134.54" class="difflineminus">-  finally {</span>
<a href="#l134.55"></a><span id="l134.55" class="difflineplus">+  } finally {</span>
<a href="#l134.56"></a><span id="l134.56">     glodaSearchWidget.collapsed = true;</span>
<a href="#l134.57"></a><span id="l134.57">   }</span>
<a href="#l134.58"></a><span id="l134.58"> }</span>
<a href="#l134.59"></a><span id="l134.59"> </span>
<a href="#l134.60"></a><span id="l134.60"> /**</span>
<a href="#l134.61"></a><span id="l134.61">  * Control-shift-k expands the quick filter bar when it's collapsed. When</span>
<a href="#l134.62"></a><span id="l134.62">  * already expanded, it focuses the text box and selects its text.</span>
<a href="#l134.63"></a><span id="l134.63">  */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l135.1"></a><span id="l135.1" class="difflineminus">--- a/mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js</span>
<a href="#l135.2"></a><span id="l135.2" class="difflineplus">+++ b/mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js</span>
<a href="#l135.3"></a><span id="l135.3" class="difflineat">@@ -4,29 +4,30 @@</span>
<a href="#l135.4"></a><span id="l135.4"> </span>
<a href="#l135.5"></a><span id="l135.5"> /*</span>
<a href="#l135.6"></a><span id="l135.6">  * Sticky logic only needs to test the general sticky logic plus any filters</span>
<a href="#l135.7"></a><span id="l135.7">  *  with custom propagateState implementations (currently: tags, text filter.)</span>
<a href="#l135.8"></a><span id="l135.8">  */</span>
<a href="#l135.9"></a><span id="l135.9"> </span>
<a href="#l135.10"></a><span id="l135.10"> &quot;use strict&quot;;</span>
<a href="#l135.11"></a><span id="l135.11"> </span>
<a href="#l135.12"></a><span id="l135.12" class="difflineminus">-var MODULE_NAME = &quot;test-sticky-filter-logic&quot;;</span>
<a href="#l135.13"></a><span id="l135.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l135.14"></a><span id="l135.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-quick-filter-bar-helpers.js */</span>
<a href="#l135.15"></a><span id="l135.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l135.16"></a><span id="l135.16"> </span>
<a href="#l135.17"></a><span id="l135.17" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l135.18"></a><span id="l135.18" class="difflineminus">-</span>
<a href="#l135.19"></a><span id="l135.19" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l135.20"></a><span id="l135.20" class="difflineminus">-                       'quick-filter-bar-helper'];</span>
<a href="#l135.21"></a><span id="l135.21" class="difflineplus">+var MODULE_NAME = &quot;test-sticky-filter-logic&quot;;</span>
<a href="#l135.22"></a><span id="l135.22" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l135.23"></a><span id="l135.23" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;quick-filter-bar-helpers&quot;];</span>
<a href="#l135.24"></a><span id="l135.24"> </span>
<a href="#l135.25"></a><span id="l135.25"> function setupModule(module) {</span>
<a href="#l135.26"></a><span id="l135.26" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l135.27"></a><span id="l135.27" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l135.28"></a><span id="l135.28">   fdh.installInto(module);</span>
<a href="#l135.29"></a><span id="l135.29" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l135.30"></a><span id="l135.30" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l135.31"></a><span id="l135.31">   wh.installInto(module);</span>
<a href="#l135.32"></a><span id="l135.32" class="difflineminus">-  let qfb = collector.getModule('quick-filter-bar-helper');</span>
<a href="#l135.33"></a><span id="l135.33" class="difflineplus">+  let qfb = collector.getModule(&quot;quick-filter-bar-helpers&quot;);</span>
<a href="#l135.34"></a><span id="l135.34">   qfb.installInto(module);</span>
<a href="#l135.35"></a><span id="l135.35"> }</span>
<a href="#l135.36"></a><span id="l135.36"> </span>
<a href="#l135.37"></a><span id="l135.37"> /**</span>
<a href="#l135.38"></a><span id="l135.38">  * Persist the current settings through folder change and inherit into a new tab.</span>
<a href="#l135.39"></a><span id="l135.39">  */</span>
<a href="#l135.40"></a><span id="l135.40"> function test_sticky_basics() {</span>
<a href="#l135.41"></a><span id="l135.41">   let folderOne = create_folder(&quot;QuickFilterBarStickyBasics1&quot;);</span>
<a href="#l135.42"></a><span id="l135.42" class="difflineat">@@ -35,17 +36,17 @@ function test_sticky_basics() {</span>
<a href="#l135.43"></a><span id="l135.43">   readOne.setRead(true);</span>
<a href="#l135.44"></a><span id="l135.44"> </span>
<a href="#l135.45"></a><span id="l135.45">   let folderTwo = create_folder(&quot;QuickFilterBarStickyBasics2&quot;);</span>
<a href="#l135.46"></a><span id="l135.46">   let [unreadTwo, readTwo] = make_new_sets_in_folder(folderTwo,</span>
<a href="#l135.47"></a><span id="l135.47">     [{count: 1}, {count: 1}]);</span>
<a href="#l135.48"></a><span id="l135.48">   readTwo.setRead(true);</span>
<a href="#l135.49"></a><span id="l135.49"> </span>
<a href="#l135.50"></a><span id="l135.50">   // -- setup</span>
<a href="#l135.51"></a><span id="l135.51" class="difflineminus">-  let tabA = be_in_folder(folderOne);</span>
<a href="#l135.52"></a><span id="l135.52" class="difflineplus">+  be_in_folder(folderOne);</span>
<a href="#l135.53"></a><span id="l135.53">   toggle_boolean_constraints(&quot;sticky&quot;, &quot;unread&quot;);</span>
<a href="#l135.54"></a><span id="l135.54">   assert_messages_in_view(unreadOne);</span>
<a href="#l135.55"></a><span id="l135.55"> </span>
<a href="#l135.56"></a><span id="l135.56">   // -- change folders</span>
<a href="#l135.57"></a><span id="l135.57">   be_in_folder(folderTwo);</span>
<a href="#l135.58"></a><span id="l135.58">   assert_constraints_expressed({sticky: true, unread: true});</span>
<a href="#l135.59"></a><span id="l135.59">   assert_messages_in_view(unreadTwo);</span>
<a href="#l135.60"></a><span id="l135.60"> </span>
<a href="#l135.61"></a><span id="l135.61" class="difflineat">@@ -68,19 +69,19 @@ function test_sticky_basics() {</span>
<a href="#l135.62"></a><span id="l135.62">  *</span>
<a href="#l135.63"></a><span id="l135.63">  * We only need to do folder changes from here on out since the logic is</span>
<a href="#l135.64"></a><span id="l135.64">  *  identical (and tested to be identical in |test_sticky_basics|).</span>
<a href="#l135.65"></a><span id="l135.65">  */</span>
<a href="#l135.66"></a><span id="l135.66"> function test_sticky_tags() {</span>
<a href="#l135.67"></a><span id="l135.67">   let folderOne = create_folder(&quot;QuickFilterBarStickyTags1&quot;);</span>
<a href="#l135.68"></a><span id="l135.68">   let folderTwo = create_folder(&quot;QuickFilterBarStickyTags2&quot;);</span>
<a href="#l135.69"></a><span id="l135.69">   const tagA = &quot;$label1&quot;, tagB = &quot;$label2&quot;, tagC = &quot;$label3&quot;;</span>
<a href="#l135.70"></a><span id="l135.70" class="difflineminus">-  let [setNoTag1, setTagA1, setTagB1] = make_new_sets_in_folder(</span>
<a href="#l135.71"></a><span id="l135.71" class="difflineplus">+  let [, setTagA1, setTagB1] = make_new_sets_in_folder(</span>
<a href="#l135.72"></a><span id="l135.72">     folderOne, [{count: 1}, {count: 1}, {count: 1}]);</span>
<a href="#l135.73"></a><span id="l135.73" class="difflineminus">-  let [setNoTag2, setTagA2, setTagC2] = make_new_sets_in_folder(</span>
<a href="#l135.74"></a><span id="l135.74" class="difflineplus">+  let [, setTagA2, setTagC2] = make_new_sets_in_folder(</span>
<a href="#l135.75"></a><span id="l135.75">     folderTwo, [{count: 1}, {count: 1}, {count: 1}]);</span>
<a href="#l135.76"></a><span id="l135.76">   setTagA1.addTag(tagA);</span>
<a href="#l135.77"></a><span id="l135.77">   setTagB1.addTag(tagB);</span>
<a href="#l135.78"></a><span id="l135.78">   setTagA2.addTag(tagA);</span>
<a href="#l135.79"></a><span id="l135.79">   setTagC2.addTag(tagC);</span>
<a href="#l135.80"></a><span id="l135.80"> </span>
<a href="#l135.81"></a><span id="l135.81">   be_in_folder(folderOne);</span>
<a href="#l135.82"></a><span id="l135.82">   toggle_boolean_constraints(&quot;sticky&quot;, &quot;tags&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l136.1"></a><span id="l136.1" class="difflineminus">--- a/mail/test/mozmill/quick-filter-bar/test-toggle-bar.js</span>
<a href="#l136.2"></a><span id="l136.2" class="difflineplus">+++ b/mail/test/mozmill/quick-filter-bar/test-toggle-bar.js</span>
<a href="#l136.3"></a><span id="l136.3" class="difflineat">@@ -4,32 +4,33 @@</span>
<a href="#l136.4"></a><span id="l136.4"> </span>
<a href="#l136.5"></a><span id="l136.5"> /*</span>
<a href="#l136.6"></a><span id="l136.6">  * Test that the message filter bar toggles into and out of existence and</span>
<a href="#l136.7"></a><span id="l136.7">  * states are updated as appropriate.</span>
<a href="#l136.8"></a><span id="l136.8">  */</span>
<a href="#l136.9"></a><span id="l136.9"> </span>
<a href="#l136.10"></a><span id="l136.10"> &quot;use strict&quot;;</span>
<a href="#l136.11"></a><span id="l136.11"> </span>
<a href="#l136.12"></a><span id="l136.12" class="difflineminus">-var MODULE_NAME = 'test-toggle-bar';</span>
<a href="#l136.13"></a><span id="l136.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l136.14"></a><span id="l136.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-quick-filter-bar-helpers.js */</span>
<a href="#l136.15"></a><span id="l136.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l136.16"></a><span id="l136.16"> </span>
<a href="#l136.17"></a><span id="l136.17" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l136.18"></a><span id="l136.18" class="difflineminus">-</span>
<a href="#l136.19"></a><span id="l136.19" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers',</span>
<a href="#l136.20"></a><span id="l136.20" class="difflineminus">-                       'quick-filter-bar-helper'];</span>
<a href="#l136.21"></a><span id="l136.21" class="difflineplus">+var MODULE_NAME = &quot;test-toggle-bar&quot;;</span>
<a href="#l136.22"></a><span id="l136.22" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l136.23"></a><span id="l136.23" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;quick-filter-bar-helpers&quot;];</span>
<a href="#l136.24"></a><span id="l136.24"> </span>
<a href="#l136.25"></a><span id="l136.25"> var folder;</span>
<a href="#l136.26"></a><span id="l136.26"> var setUnstarred, setStarred;</span>
<a href="#l136.27"></a><span id="l136.27"> </span>
<a href="#l136.28"></a><span id="l136.28"> function setupModule(module) {</span>
<a href="#l136.29"></a><span id="l136.29" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l136.30"></a><span id="l136.30" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l136.31"></a><span id="l136.31">   fdh.installInto(module);</span>
<a href="#l136.32"></a><span id="l136.32" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l136.33"></a><span id="l136.33" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l136.34"></a><span id="l136.34">   wh.installInto(module);</span>
<a href="#l136.35"></a><span id="l136.35" class="difflineminus">-  let qfb = collector.getModule('quick-filter-bar-helper');</span>
<a href="#l136.36"></a><span id="l136.36" class="difflineplus">+  let qfb = collector.getModule(&quot;quick-filter-bar-helpers&quot;);</span>
<a href="#l136.37"></a><span id="l136.37">   qfb.installInto(module);</span>
<a href="#l136.38"></a><span id="l136.38"> </span>
<a href="#l136.39"></a><span id="l136.39">   folder = create_folder(&quot;QuickFilterBarToggleBar&quot;);</span>
<a href="#l136.40"></a><span id="l136.40">   [setUnstarred, setStarred] = make_new_sets_in_folder(folder, [</span>
<a href="#l136.41"></a><span id="l136.41">                                  {count: 1}, {count: 1}]);</span>
<a href="#l136.42"></a><span id="l136.42">   setStarred.setStarred(true);</span>
<a href="#l136.43"></a><span id="l136.43"> }</span>
<a href="#l136.44"></a><span id="l136.44"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l137.1"></a><span id="l137.1" class="difflineminus">--- a/mail/test/mozmill/search-window/test-multiple-search-windows.js</span>
<a href="#l137.2"></a><span id="l137.2" class="difflineplus">+++ b/mail/test/mozmill/search-window/test-multiple-search-windows.js</span>
<a href="#l137.3"></a><span id="l137.3" class="difflineat">@@ -4,26 +4,28 @@</span>
<a href="#l137.4"></a><span id="l137.4"> </span>
<a href="#l137.5"></a><span id="l137.5"> /*</span>
<a href="#l137.6"></a><span id="l137.6">  * Test that we open multiple search windows when shortcuts are invoked multiple</span>
<a href="#l137.7"></a><span id="l137.7">  * times.</span>
<a href="#l137.8"></a><span id="l137.8">  */</span>
<a href="#l137.9"></a><span id="l137.9"> </span>
<a href="#l137.10"></a><span id="l137.10"> &quot;use strict&quot;;</span>
<a href="#l137.11"></a><span id="l137.11"> </span>
<a href="#l137.12"></a><span id="l137.12" class="difflineminus">-var MODULE_NAME = 'test-multiple-search-windows';</span>
<a href="#l137.13"></a><span id="l137.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l137.14"></a><span id="l137.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-search-window-helpers.js */</span>
<a href="#l137.15"></a><span id="l137.15"> </span>
<a href="#l137.16"></a><span id="l137.16" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l137.17"></a><span id="l137.17" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'search-window-helpers'];</span>
<a href="#l137.18"></a><span id="l137.18" class="difflineplus">+var MODULE_NAME = &quot;test-multiple-search-windows&quot;;</span>
<a href="#l137.19"></a><span id="l137.19" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l137.20"></a><span id="l137.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;search-window-helpers&quot;];</span>
<a href="#l137.21"></a><span id="l137.21"> </span>
<a href="#l137.22"></a><span id="l137.22"> var folderA, folderB;</span>
<a href="#l137.23"></a><span id="l137.23"> function setupModule(module) {</span>
<a href="#l137.24"></a><span id="l137.24" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l137.25"></a><span id="l137.25" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l137.26"></a><span id="l137.26">   fdh.installInto(module);</span>
<a href="#l137.27"></a><span id="l137.27" class="difflineminus">-  let swh = collector.getModule('search-window-helpers');</span>
<a href="#l137.28"></a><span id="l137.28" class="difflineplus">+  let swh = collector.getModule(&quot;search-window-helpers&quot;);</span>
<a href="#l137.29"></a><span id="l137.29">   swh.installInto(module);</span>
<a href="#l137.30"></a><span id="l137.30"> </span>
<a href="#l137.31"></a><span id="l137.31">   folderA = create_folder(&quot;MultipleSearchWindowsA&quot;);</span>
<a href="#l137.32"></a><span id="l137.32">   folderB = create_folder(&quot;MultipleSearchWindowsB&quot;);</span>
<a href="#l137.33"></a><span id="l137.33"> }</span>
<a href="#l137.34"></a><span id="l137.34"> </span>
<a href="#l137.35"></a><span id="l137.35"> /**</span>
<a href="#l137.36"></a><span id="l137.36">  * Test bringing up multiple search windows for multiple folders.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l138.1"></a><span id="l138.1" class="difflineminus">--- a/mail/test/mozmill/search-window/test-right-click-to-open-search-window.js</span>
<a href="#l138.2"></a><span id="l138.2" class="difflineplus">+++ b/mail/test/mozmill/search-window/test-right-click-to-open-search-window.js</span>
<a href="#l138.3"></a><span id="l138.3" class="difflineat">@@ -1,24 +1,26 @@</span>
<a href="#l138.4"></a><span id="l138.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l138.5"></a><span id="l138.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l138.6"></a><span id="l138.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l138.7"></a><span id="l138.7"> </span>
<a href="#l138.8"></a><span id="l138.8"> &quot;use strict&quot;;</span>
<a href="#l138.9"></a><span id="l138.9"> </span>
<a href="#l138.10"></a><span id="l138.10" class="difflineminus">-var MODULE_NAME = 'test-right-click-to-open-search-window';</span>
<a href="#l138.11"></a><span id="l138.11" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l138.12"></a><span id="l138.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-search-window-helpers.js */</span>
<a href="#l138.13"></a><span id="l138.13"> </span>
<a href="#l138.14"></a><span id="l138.14" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l138.15"></a><span id="l138.15" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'search-window-helpers'];</span>
<a href="#l138.16"></a><span id="l138.16" class="difflineplus">+var MODULE_NAME = &quot;test-right-click-to-open-search-window&quot;;</span>
<a href="#l138.17"></a><span id="l138.17" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l138.18"></a><span id="l138.18" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;search-window-helpers&quot;];</span>
<a href="#l138.19"></a><span id="l138.19"> </span>
<a href="#l138.20"></a><span id="l138.20"> var folderA, folderB;</span>
<a href="#l138.21"></a><span id="l138.21"> function setupModule(module) {</span>
<a href="#l138.22"></a><span id="l138.22" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l138.23"></a><span id="l138.23" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l138.24"></a><span id="l138.24">   fdh.installInto(module);</span>
<a href="#l138.25"></a><span id="l138.25" class="difflineminus">-  let swh = collector.getModule('search-window-helpers');</span>
<a href="#l138.26"></a><span id="l138.26" class="difflineplus">+  let swh = collector.getModule(&quot;search-window-helpers&quot;);</span>
<a href="#l138.27"></a><span id="l138.27">   swh.installInto(module);</span>
<a href="#l138.28"></a><span id="l138.28"> </span>
<a href="#l138.29"></a><span id="l138.29">   folderA = create_folder(&quot;RightClickToOpenSearchWindowA&quot;);</span>
<a href="#l138.30"></a><span id="l138.30">   folderB = create_folder(&quot;RightClickToOpenSearchWindowB&quot;);</span>
<a href="#l138.31"></a><span id="l138.31"> }</span>
<a href="#l138.32"></a><span id="l138.32"> </span>
<a href="#l138.33"></a><span id="l138.33"> /**</span>
<a href="#l138.34"></a><span id="l138.34">  * Test opening a search window while nothing is selected.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l139.1"></a><span id="l139.1" class="difflineminus">--- a/mail/test/mozmill/search-window/test-search-window.js</span>
<a href="#l139.2"></a><span id="l139.2" class="difflineplus">+++ b/mail/test/mozmill/search-window/test-search-window.js</span>
<a href="#l139.3"></a><span id="l139.3" class="difflineat">@@ -4,29 +4,32 @@</span>
<a href="#l139.4"></a><span id="l139.4"> </span>
<a href="#l139.5"></a><span id="l139.5"> /*</span>
<a href="#l139.6"></a><span id="l139.6">  * Tests:</span>
<a href="#l139.7"></a><span id="l139.7">  * - https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c96 first para</span>
<a href="#l139.8"></a><span id="l139.8">  */</span>
<a href="#l139.9"></a><span id="l139.9"> </span>
<a href="#l139.10"></a><span id="l139.10"> &quot;use strict&quot;;</span>
<a href="#l139.11"></a><span id="l139.11"> </span>
<a href="#l139.12"></a><span id="l139.12" class="difflineminus">-var MODULE_NAME = 'test-search-window';</span>
<a href="#l139.13"></a><span id="l139.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l139.14"></a><span id="l139.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-search-window-helpers.js */</span>
<a href="#l139.15"></a><span id="l139.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l139.16"></a><span id="l139.16"> </span>
<a href="#l139.17"></a><span id="l139.17" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l139.18"></a><span id="l139.18" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'search-window-helpers',</span>
<a href="#l139.19"></a><span id="l139.19" class="difflineminus">-                       'window-helpers'];</span>
<a href="#l139.20"></a><span id="l139.20" class="difflineplus">+var MODULE_NAME = &quot;test-search-window&quot;;</span>
<a href="#l139.21"></a><span id="l139.21" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l139.22"></a><span id="l139.22" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;search-window-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l139.23"></a><span id="l139.23" class="difflineplus">+</span>
<a href="#l139.24"></a><span id="l139.24"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l139.25"></a><span id="l139.25"> </span>
<a href="#l139.26"></a><span id="l139.26"> function setupModule(module) {</span>
<a href="#l139.27"></a><span id="l139.27" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l139.28"></a><span id="l139.28" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l139.29"></a><span id="l139.29">   fdh.installInto(module);</span>
<a href="#l139.30"></a><span id="l139.30" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l139.31"></a><span id="l139.31" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l139.32"></a><span id="l139.32">   wh.installInto(module);</span>
<a href="#l139.33"></a><span id="l139.33" class="difflineminus">-  let sh = collector.getModule('search-window-helpers');</span>
<a href="#l139.34"></a><span id="l139.34" class="difflineplus">+  let sh = collector.getModule(&quot;search-window-helpers&quot;);</span>
<a href="#l139.35"></a><span id="l139.35">   sh.installInto(module);</span>
<a href="#l139.36"></a><span id="l139.36"> }</span>
<a href="#l139.37"></a><span id="l139.37"> </span>
<a href="#l139.38"></a><span id="l139.38"> var folder, setFoo, setBar, setFooBar;</span>
<a href="#l139.39"></a><span id="l139.39"> </span>
<a href="#l139.40"></a><span id="l139.40"> // Number of messages to open for multi-message tests</span>
<a href="#l139.41"></a><span id="l139.41"> var NUM_MESSAGES_TO_OPEN = 5;</span>
<a href="#l139.42"></a><span id="l139.42"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l140.1"></a><span id="l140.1" class="difflineminus">--- a/mail/test/mozmill/session-store/test-session-store.js</span>
<a href="#l140.2"></a><span id="l140.2" class="difflineplus">+++ b/mail/test/mozmill/session-store/test-session-store.js</span>
<a href="#l140.3"></a><span id="l140.3" class="difflineat">@@ -4,18 +4,20 @@</span>
<a href="#l140.4"></a><span id="l140.4"> </span>
<a href="#l140.5"></a><span id="l140.5"> /*</span>
<a href="#l140.6"></a><span id="l140.6">  * Session Storage Tests. Session Restoration Tests are currently implemented in</span>
<a href="#l140.7"></a><span id="l140.7">  * folder-display/test-message-pane-visibility.js.</span>
<a href="#l140.8"></a><span id="l140.8">  */</span>
<a href="#l140.9"></a><span id="l140.9"> </span>
<a href="#l140.10"></a><span id="l140.10"> &quot;use strict&quot;;</span>
<a href="#l140.11"></a><span id="l140.11"> </span>
<a href="#l140.12"></a><span id="l140.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l140.13"></a><span id="l140.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l140.14"></a><span id="l140.14" class="difflineplus">+</span>
<a href="#l140.15"></a><span id="l140.15"> var MODULE_NAME = &quot;test-session-store&quot;;</span>
<a href="#l140.16"></a><span id="l140.16" class="difflineminus">-</span>
<a href="#l140.17"></a><span id="l140.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l140.18"></a><span id="l140.18"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l140.19"></a><span id="l140.19"> </span>
<a href="#l140.20"></a><span id="l140.20"> var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l140.21"></a><span id="l140.21"> </span>
<a href="#l140.22"></a><span id="l140.22"> var {IOUtils} = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l140.23"></a><span id="l140.23"> var {FileUtils} = ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l140.24"></a><span id="l140.24"> var {SessionStoreManager} = ChromeUtils.import(&quot;resource:///modules/SessionStoreManager.jsm&quot;);</span>
<a href="#l140.25"></a><span id="l140.25" class="difflineat">@@ -34,18 +36,17 @@ var asyncFileWriteDelayMS = 3000;</span>
<a href="#l140.26"></a><span id="l140.26"> /**</span>
<a href="#l140.27"></a><span id="l140.27">  * Reads the contents of the session file into a JSON object.</span>
<a href="#l140.28"></a><span id="l140.28">  */</span>
<a href="#l140.29"></a><span id="l140.29"> function readFile() {</span>
<a href="#l140.30"></a><span id="l140.30">   try {</span>
<a href="#l140.31"></a><span id="l140.31">     let data = IOUtils.loadFileToString(SessionStoreManager.sessionFile);</span>
<a href="#l140.32"></a><span id="l140.32">     if (data)</span>
<a href="#l140.33"></a><span id="l140.33">       return JSON.parse(data);</span>
<a href="#l140.34"></a><span id="l140.34" class="difflineminus">-  }</span>
<a href="#l140.35"></a><span id="l140.35" class="difflineminus">-  catch (ex) {</span>
<a href="#l140.36"></a><span id="l140.36" class="difflineplus">+  } catch (ex) {</span>
<a href="#l140.37"></a><span id="l140.37">     // fall through and return null if the session file cannot be read</span>
<a href="#l140.38"></a><span id="l140.38">     // or is bad</span>
<a href="#l140.39"></a><span id="l140.39">   }</span>
<a href="#l140.40"></a><span id="l140.40"> </span>
<a href="#l140.41"></a><span id="l140.41">   return null;</span>
<a href="#l140.42"></a><span id="l140.42"> }</span>
<a href="#l140.43"></a><span id="l140.43"> </span>
<a href="#l140.44"></a><span id="l140.44"> function waitForFileRefresh() {</span>
<a href="#l140.45"></a><span id="l140.45" class="difflineat">@@ -464,24 +465,24 @@ function test_clean_shutdown_session_per</span>
<a href="#l140.46"></a><span id="l140.46"> /*</span>
<a href="#l140.47"></a><span id="l140.47">  * A set of private helper functions for drag'n'drop</span>
<a href="#l140.48"></a><span id="l140.48">  * These functions are inspired by tabmail/test-tabmail-dragndrop.js</span>
<a href="#l140.49"></a><span id="l140.49">  */</span>
<a href="#l140.50"></a><span id="l140.50"> </span>
<a href="#l140.51"></a><span id="l140.51"> function _move_splitter(aSplitter, aDiffX, aDiffY) {</span>
<a href="#l140.52"></a><span id="l140.52">   // catch the splitter in the middle</span>
<a href="#l140.53"></a><span id="l140.53">   let rect = aSplitter.getBoundingClientRect();</span>
<a href="#l140.54"></a><span id="l140.54" class="difflineminus">-  let middleX = Math.round(rect.width/2);</span>
<a href="#l140.55"></a><span id="l140.55" class="difflineminus">-  let middleY = Math.round(rect.height/2);</span>
<a href="#l140.56"></a><span id="l140.56" class="difflineminus">-  EventUtils.synthesizeMouse(aSplitter, middleX, middleY, {type:&quot;mousedown&quot;},</span>
<a href="#l140.57"></a><span id="l140.57" class="difflineplus">+  let middleX = Math.round(rect.width / 2);</span>
<a href="#l140.58"></a><span id="l140.58" class="difflineplus">+  let middleY = Math.round(rect.height / 2);</span>
<a href="#l140.59"></a><span id="l140.59" class="difflineplus">+  EventUtils.synthesizeMouse(aSplitter, middleX, middleY, {type: &quot;mousedown&quot;},</span>
<a href="#l140.60"></a><span id="l140.60">                              mc.window);</span>
<a href="#l140.61"></a><span id="l140.61">   EventUtils.synthesizeMouse(aSplitter, aDiffX + middleX, aDiffY + middleY,</span>
<a href="#l140.62"></a><span id="l140.62" class="difflineminus">-                             {type:&quot;mousemove&quot;}, mc.window);</span>
<a href="#l140.63"></a><span id="l140.63" class="difflineplus">+                             {type: &quot;mousemove&quot;}, mc.window);</span>
<a href="#l140.64"></a><span id="l140.64">   // release the splitter</span>
<a href="#l140.65"></a><span id="l140.65" class="difflineminus">-  EventUtils.synthesizeMouse(aSplitter, 0, 0, {type:&quot;mouseup&quot;}, mc.window);</span>
<a href="#l140.66"></a><span id="l140.66" class="difflineplus">+  EventUtils.synthesizeMouse(aSplitter, 0, 0, {type: &quot;mouseup&quot;}, mc.window);</span>
<a href="#l140.67"></a><span id="l140.67"> }</span>
<a href="#l140.68"></a><span id="l140.68"> </span>
<a href="#l140.69"></a><span id="l140.69"> /**</span>
<a href="#l140.70"></a><span id="l140.70">  * Helper function that checks the fuzzy equivalence of two numeric</span>
<a href="#l140.71"></a><span id="l140.71">  * values against some given tolerance.</span>
<a href="#l140.72"></a><span id="l140.72">  *</span>
<a href="#l140.73"></a><span id="l140.73">  * @param aLeft one value to check equivalence with</span>
<a href="#l140.74"></a><span id="l140.74">  * @param aRight the other value to check equivalence with</span>
<a href="#l140.75"></a><span id="l140.75" class="difflineat">@@ -494,10 +495,10 @@ function assert_equals_fuzzy(aLeft, aRig</span>
<a href="#l140.76"></a><span id="l140.76"> </span>
<a href="#l140.77"></a><span id="l140.77"> // XXX todo</span>
<a href="#l140.78"></a><span id="l140.78"> // - crash test: not sure if this test should be here. restoring a crashed</span>
<a href="#l140.79"></a><span id="l140.79"> //               session depends on periodically saved session data (there is</span>
<a href="#l140.80"></a><span id="l140.80"> //               already a test for this). session restoration tests do not</span>
<a href="#l140.81"></a><span id="l140.81"> //               belong here. see test-message-pane-visibility.</span>
<a href="#l140.82"></a><span id="l140.82"> //               when testing restoration in test-message-pane-visibility, also</span>
<a href="#l140.83"></a><span id="l140.83"> //               include test of bad session file.</span>
<a href="#l140.84"></a><span id="l140.84" class="difflineminus">-//...............maybe we should move all session restoration related tests</span>
<a href="#l140.85"></a><span id="l140.85" class="difflineminus">-//...............here.</span>
<a href="#l140.86"></a><span id="l140.86" class="difflineplus">+// ..............maybe we should move all session restoration related tests</span>
<a href="#l140.87"></a><span id="l140.87" class="difflineplus">+// ..............here.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l141.1"></a><span id="l141.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-account-manager-helpers.js</span>
<a href="#l141.2"></a><span id="l141.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-account-manager-helpers.js</span>
<a href="#l141.3"></a><span id="l141.3" class="difflineat">@@ -1,29 +1,27 @@</span>
<a href="#l141.4"></a><span id="l141.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l141.5"></a><span id="l141.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l141.6"></a><span id="l141.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l141.7"></a><span id="l141.7"> </span>
<a href="#l141.8"></a><span id="l141.8"> &quot;use strict&quot;;</span>
<a href="#l141.9"></a><span id="l141.9"> </span>
<a href="#l141.10"></a><span id="l141.10"> var MODULE_NAME = &quot;account-manager-helpers&quot;;</span>
<a href="#l141.11"></a><span id="l141.11" class="difflineminus">-</span>
<a href="#l141.12"></a><span id="l141.12"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l141.13"></a><span id="l141.13" class="difflineminus">-// we need this for the main controller</span>
<a href="#l141.14"></a><span id="l141.14"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l141.15"></a><span id="l141.15"> </span>
<a href="#l141.16"></a><span id="l141.16"> var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l141.17"></a><span id="l141.17"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l141.18"></a><span id="l141.18"> </span>
<a href="#l141.19"></a><span id="l141.19"> var wh, fdh, mc;</span>
<a href="#l141.20"></a><span id="l141.20"> </span>
<a href="#l141.21"></a><span id="l141.21"> function setupModule() {</span>
<a href="#l141.22"></a><span id="l141.22" class="difflineminus">-  fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l141.23"></a><span id="l141.23" class="difflineplus">+  fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l141.24"></a><span id="l141.24">   mc = fdh.mc;</span>
<a href="#l141.25"></a><span id="l141.25" class="difflineminus">-  wh = collector.getModule('window-helpers');</span>
<a href="#l141.26"></a><span id="l141.26" class="difflineplus">+  wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l141.27"></a><span id="l141.27"> }</span>
<a href="#l141.28"></a><span id="l141.28"> </span>
<a href="#l141.29"></a><span id="l141.29"> function installInto(module) {</span>
<a href="#l141.30"></a><span id="l141.30">   setupModule();</span>
<a href="#l141.31"></a><span id="l141.31"> </span>
<a href="#l141.32"></a><span id="l141.32">   // Now copy helper functions</span>
<a href="#l141.33"></a><span id="l141.33">   module.open_advanced_settings = open_advanced_settings;</span>
<a href="#l141.34"></a><span id="l141.34">   module.open_advanced_settings_from_account_wizard =</span>
<a href="#l141.35"></a><span id="l141.35" class="difflineat">@@ -129,20 +127,19 @@ function get_account_tree_row(aAccountKe</span>
<a href="#l141.36"></a><span id="l141.36">         }</span>
<a href="#l141.37"></a><span id="l141.37"> </span>
<a href="#l141.38"></a><span id="l141.38">         // The pane was not found.</span>
<a href="#l141.39"></a><span id="l141.39">         dump(&quot;The treerow for pane &quot; + aPaneId + &quot; of account &quot; + aAccountKey + &quot; was not found!\n&quot;);</span>
<a href="#l141.40"></a><span id="l141.40">         return -1;</span>
<a href="#l141.41"></a><span id="l141.41">       }</span>
<a href="#l141.42"></a><span id="l141.42">       // If this is not the wanted account, skip all of its settings panes.</span>
<a href="#l141.43"></a><span id="l141.43">       rowIndex += accountHead.querySelectorAll(&quot;[PageTag]&quot;).length;</span>
<a href="#l141.44"></a><span id="l141.44" class="difflineminus">-    } else {</span>
<a href="#l141.45"></a><span id="l141.45" class="difflineplus">+    } else if (aAccountKey == null) {</span>
<a href="#l141.46"></a><span id="l141.46">       // A row without _account should be the SMTP server.</span>
<a href="#l141.47"></a><span id="l141.47" class="difflineminus">-      if (aAccountKey == null)</span>
<a href="#l141.48"></a><span id="l141.48" class="difflineminus">-        return rowIndex;</span>
<a href="#l141.49"></a><span id="l141.49" class="difflineplus">+      return rowIndex;</span>
<a href="#l141.50"></a><span id="l141.50">     }</span>
<a href="#l141.51"></a><span id="l141.51">     rowIndex++;</span>
<a href="#l141.52"></a><span id="l141.52">   }</span>
<a href="#l141.53"></a><span id="l141.53"> </span>
<a href="#l141.54"></a><span id="l141.54">   // The account was not found.</span>
<a href="#l141.55"></a><span id="l141.55">   dump(&quot;The treerow for account &quot; + aAccountKey + &quot; was not found!\n&quot;);</span>
<a href="#l141.56"></a><span id="l141.56">   return -1;</span>
<a href="#l141.57"></a><span id="l141.57"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l142.1"></a><span id="l142.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-address-book-helpers.js</span>
<a href="#l142.2"></a><span id="l142.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-address-book-helpers.js</span>
<a href="#l142.3"></a><span id="l142.3" class="difflineat">@@ -1,16 +1,15 @@</span>
<a href="#l142.4"></a><span id="l142.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l142.5"></a><span id="l142.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l142.6"></a><span id="l142.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l142.7"></a><span id="l142.7"> </span>
<a href="#l142.8"></a><span id="l142.8"> &quot;use strict&quot;;</span>
<a href="#l142.9"></a><span id="l142.9"> </span>
<a href="#l142.10"></a><span id="l142.10"> var MODULE_NAME = &quot;address-book-helpers&quot;;</span>
<a href="#l142.11"></a><span id="l142.11" class="difflineminus">-</span>
<a href="#l142.12"></a><span id="l142.12"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l142.13"></a><span id="l142.13"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l142.14"></a><span id="l142.14"> </span>
<a href="#l142.15"></a><span id="l142.15"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l142.16"></a><span id="l142.16"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l142.17"></a><span id="l142.17"> </span>
<a href="#l142.18"></a><span id="l142.18"> var ABMDB_PREFIX = &quot;moz-abmdbdirectory://&quot;;</span>
<a href="#l142.19"></a><span id="l142.19"> var ABLDAP_PREFIX = &quot;moz-abldapdirectory://&quot;;</span>
<a href="#l142.20"></a><span id="l142.20" class="difflineat">@@ -19,19 +18,19 @@ var collectedAddresses;</span>
<a href="#l142.21"></a><span id="l142.21"> </span>
<a href="#l142.22"></a><span id="l142.22"> var abController;</span>
<a href="#l142.23"></a><span id="l142.23"> </span>
<a href="#l142.24"></a><span id="l142.24"> var folderDisplayHelper;</span>
<a href="#l142.25"></a><span id="l142.25"> var mc;</span>
<a href="#l142.26"></a><span id="l142.26"> var windowHelper;</span>
<a href="#l142.27"></a><span id="l142.27"> </span>
<a href="#l142.28"></a><span id="l142.28"> function setupModule() {</span>
<a href="#l142.29"></a><span id="l142.29" class="difflineminus">-  folderDisplayHelper = collector.getModule('folder-display-helpers');</span>
<a href="#l142.30"></a><span id="l142.30" class="difflineplus">+  folderDisplayHelper = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l142.31"></a><span id="l142.31">   mc = folderDisplayHelper.mc;</span>
<a href="#l142.32"></a><span id="l142.32" class="difflineminus">-  windowHelper = collector.getModule('window-helpers');</span>
<a href="#l142.33"></a><span id="l142.33" class="difflineplus">+  windowHelper = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l142.34"></a><span id="l142.34">   // Ensure all the directories are initialised.</span>
<a href="#l142.35"></a><span id="l142.35">   MailServices.ab.directories;</span>
<a href="#l142.36"></a><span id="l142.36">   collectedAddresses = MailServices.ab</span>
<a href="#l142.37"></a><span id="l142.37">                        .getDirectory(&quot;moz-abmdbdirectory://history.mab&quot;);</span>
<a href="#l142.38"></a><span id="l142.38"> }</span>
<a href="#l142.39"></a><span id="l142.39"> </span>
<a href="#l142.40"></a><span id="l142.40"> function installInto(module) {</span>
<a href="#l142.41"></a><span id="l142.41">   setupModule();</span>
<a href="#l142.42"></a><span id="l142.42" class="difflineat">@@ -49,78 +48,66 @@ function installInto(module) {</span>
<a href="#l142.43"></a><span id="l142.43">       get_mailing_list_from_address_book;</span>
<a href="#l142.44"></a><span id="l142.44">   module.load_contacts_into_address_book = load_contacts_into_address_book;</span>
<a href="#l142.45"></a><span id="l142.45">   module.load_contacts_into_mailing_list = load_contacts_into_mailing_list;</span>
<a href="#l142.46"></a><span id="l142.46">   module.get_cards_in_all_address_books_for_email =</span>
<a href="#l142.47"></a><span id="l142.47">       get_cards_in_all_address_books_for_email;</span>
<a href="#l142.48"></a><span id="l142.48">   module.get_address_book_tree_view_index = get_address_book_tree_view_index;</span>
<a href="#l142.49"></a><span id="l142.49">   module.set_address_books_collapsed = set_address_books_collapsed;</span>
<a href="#l142.50"></a><span id="l142.50">   module.set_address_books_expanded = set_address_books_expanded;</span>
<a href="#l142.51"></a><span id="l142.51" class="difflineminus">-  // set_address_book_collapsed and set_address_book_expanded use</span>
<a href="#l142.52"></a><span id="l142.52" class="difflineminus">-  // the same code as set_address_books_expanded/collapsed, so I just</span>
<a href="#l142.53"></a><span id="l142.53" class="difflineminus">-  // alias them here.</span>
<a href="#l142.54"></a><span id="l142.54" class="difflineminus">-  module.set_address_book_collapsed = set_address_books_collapsed;</span>
<a href="#l142.55"></a><span id="l142.55" class="difflineminus">-  module.set_address_book_expanded = set_address_books_expanded;</span>
<a href="#l142.56"></a><span id="l142.56">   module.is_address_book_collapsed = is_address_book_collapsed;</span>
<a href="#l142.57"></a><span id="l142.57">   module.is_address_book_collapsible = is_address_book_collapsible;</span>
<a href="#l142.58"></a><span id="l142.58">   module.get_name_of_address_book_element_at = get_name_of_address_book_element_at;</span>
<a href="#l142.59"></a><span id="l142.59">   module.select_address_book = select_address_book;</span>
<a href="#l142.60"></a><span id="l142.60">   module.get_contact_ab_view_index = get_contact_ab_view_index;</span>
<a href="#l142.61"></a><span id="l142.61" class="difflineminus">-  // select_contact is aliased for select_contacts, since they</span>
<a href="#l142.62"></a><span id="l142.62" class="difflineminus">-  // share the same code.</span>
<a href="#l142.63"></a><span id="l142.63" class="difflineminus">-  module.select_contact = select_contacts;</span>
<a href="#l142.64"></a><span id="l142.64">   module.select_contacts = select_contacts;</span>
<a href="#l142.65"></a><span id="l142.65">   module.edit_selected_contact = edit_selected_contact;</span>
<a href="#l142.66"></a><span id="l142.66">   module.accept_contact_changes = accept_contact_changes;</span>
<a href="#l142.67"></a><span id="l142.67">   module.delete_address_book = delete_address_book;</span>
<a href="#l142.68"></a><span id="l142.68"> }</span>
<a href="#l142.69"></a><span id="l142.69"> </span>
<a href="#l142.70"></a><span id="l142.70"> /**</span>
<a href="#l142.71"></a><span id="l142.71">  * Make sure that there is a card for this email address</span>
<a href="#l142.72"></a><span id="l142.72">  * @param emailAddress the address that should have a card</span>
<a href="#l142.73"></a><span id="l142.73">  * @param displayName the display name the card should have</span>
<a href="#l142.74"></a><span id="l142.74">  * @param preferDisplayName |true| if the card display name should override the</span>
<a href="#l142.75"></a><span id="l142.75">  *                          header display name</span>
<a href="#l142.76"></a><span id="l142.76">  */</span>
<a href="#l142.77"></a><span id="l142.77" class="difflineminus">-function ensure_card_exists(emailAddress, displayName, preferDisplayName)</span>
<a href="#l142.78"></a><span id="l142.78" class="difflineminus">-{</span>
<a href="#l142.79"></a><span id="l142.79" class="difflineplus">+function ensure_card_exists(emailAddress, displayName, preferDisplayName) {</span>
<a href="#l142.80"></a><span id="l142.80">   ensure_no_card_exists(emailAddress);</span>
<a href="#l142.81"></a><span id="l142.81">   let card = create_contact(emailAddress, displayName, preferDisplayName);</span>
<a href="#l142.82"></a><span id="l142.82">   collectedAddresses.addCard(card);</span>
<a href="#l142.83"></a><span id="l142.83"> }</span>
<a href="#l142.84"></a><span id="l142.84"> </span>
<a href="#l142.85"></a><span id="l142.85"> /**</span>
<a href="#l142.86"></a><span id="l142.86">  * Make sure that there is no card for this email address</span>
<a href="#l142.87"></a><span id="l142.87">  * @param emailAddress the address that should have no cards</span>
<a href="#l142.88"></a><span id="l142.88">  */</span>
<a href="#l142.89"></a><span id="l142.89" class="difflineminus">-function ensure_no_card_exists(emailAddress)</span>
<a href="#l142.90"></a><span id="l142.90" class="difflineminus">-{</span>
<a href="#l142.91"></a><span id="l142.91" class="difflineplus">+function ensure_no_card_exists(emailAddress) {</span>
<a href="#l142.92"></a><span id="l142.92">   var books = MailServices.ab.directories;</span>
<a href="#l142.93"></a><span id="l142.93"> </span>
<a href="#l142.94"></a><span id="l142.94">   while (books.hasMoreElements()) {</span>
<a href="#l142.95"></a><span id="l142.95">     var ab = books.getNext().QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l142.96"></a><span id="l142.96">     try {</span>
<a href="#l142.97"></a><span id="l142.97">       var card = ab.cardForEmailAddress(emailAddress);</span>
<a href="#l142.98"></a><span id="l142.98">       if (card) {</span>
<a href="#l142.99"></a><span id="l142.99">         let cardArray = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l142.100"></a><span id="l142.100">                           .createInstance(Ci.nsIMutableArray);</span>
<a href="#l142.101"></a><span id="l142.101">         cardArray.appendElement(card);</span>
<a href="#l142.102"></a><span id="l142.102">         ab.deleteCards(cardArray);</span>
<a href="#l142.103"></a><span id="l142.103">       }</span>
<a href="#l142.104"></a><span id="l142.104" class="difflineminus">-    }</span>
<a href="#l142.105"></a><span id="l142.105" class="difflineminus">-    catch (ex) { }</span>
<a href="#l142.106"></a><span id="l142.106" class="difflineplus">+    } catch (ex) {}</span>
<a href="#l142.107"></a><span id="l142.107">   }</span>
<a href="#l142.108"></a><span id="l142.108"> }</span>
<a href="#l142.109"></a><span id="l142.109"> </span>
<a href="#l142.110"></a><span id="l142.110"> /**</span>
<a href="#l142.111"></a><span id="l142.111">  * Return all address book cards for a particular email address</span>
<a href="#l142.112"></a><span id="l142.112">  * @param aEmailAddress the address to search for</span>
<a href="#l142.113"></a><span id="l142.113">  */</span>
<a href="#l142.114"></a><span id="l142.114" class="difflineminus">-function get_cards_in_all_address_books_for_email(aEmailAddress)</span>
<a href="#l142.115"></a><span id="l142.115" class="difflineminus">-{</span>
<a href="#l142.116"></a><span id="l142.116" class="difflineplus">+function get_cards_in_all_address_books_for_email(aEmailAddress) {</span>
<a href="#l142.117"></a><span id="l142.117">   var books = MailServices.ab.directories;</span>
<a href="#l142.118"></a><span id="l142.118">   var result = [];</span>
<a href="#l142.119"></a><span id="l142.119"> </span>
<a href="#l142.120"></a><span id="l142.120">   while (books.hasMoreElements()) {</span>
<a href="#l142.121"></a><span id="l142.121">     var ab = books.getNext().QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l142.122"></a><span id="l142.122">     var card = ab.cardForEmailAddress(aEmailAddress);</span>
<a href="#l142.123"></a><span id="l142.123">     if (card) {</span>
<a href="#l142.124"></a><span id="l142.124">       result.push(card);</span>
<a href="#l142.125"></a><span id="l142.125" class="difflineat">@@ -129,18 +116,17 @@ function get_cards_in_all_address_books_</span>
<a href="#l142.126"></a><span id="l142.126"> </span>
<a href="#l142.127"></a><span id="l142.127">   return result;</span>
<a href="#l142.128"></a><span id="l142.128"> }</span>
<a href="#l142.129"></a><span id="l142.129"> </span>
<a href="#l142.130"></a><span id="l142.130"> /**</span>
<a href="#l142.131"></a><span id="l142.131">  * Opens the address book interface</span>
<a href="#l142.132"></a><span id="l142.132">  * @returns a controller for the address book</span>
<a href="#l142.133"></a><span id="l142.133">  */</span>
<a href="#l142.134"></a><span id="l142.134" class="difflineminus">-function open_address_book_window(aController)</span>
<a href="#l142.135"></a><span id="l142.135" class="difflineminus">-{</span>
<a href="#l142.136"></a><span id="l142.136" class="difflineplus">+function open_address_book_window(aController) {</span>
<a href="#l142.137"></a><span id="l142.137">   if (aController === undefined)</span>
<a href="#l142.138"></a><span id="l142.138">     aController = mc;</span>
<a href="#l142.139"></a><span id="l142.139"> </span>
<a href="#l142.140"></a><span id="l142.140">   windowHelper.plan_for_new_window(&quot;mail:addressbook&quot;);</span>
<a href="#l142.141"></a><span id="l142.141">   aController.keypress(null, &quot;b&quot;, {shiftKey: true, accelKey: true});</span>
<a href="#l142.142"></a><span id="l142.142"> </span>
<a href="#l142.143"></a><span id="l142.143">   // XXX this should probably be changed to making callers pass in which address</span>
<a href="#l142.144"></a><span id="l142.144">   // book they want to work with, just like test-compose-helpers.</span>
<a href="#l142.145"></a><span id="l142.145" class="difflineat">@@ -149,90 +135,83 @@ function open_address_book_window(aContr</span>
<a href="#l142.146"></a><span id="l142.146">   return abController;</span>
<a href="#l142.147"></a><span id="l142.147"> }</span>
<a href="#l142.148"></a><span id="l142.148"> </span>
<a href="#l142.149"></a><span id="l142.149"> /**</span>
<a href="#l142.150"></a><span id="l142.150">  * Closes the address book interface</span>
<a href="#l142.151"></a><span id="l142.151">  * @param abc the controller for the address book window to close</span>
<a href="#l142.152"></a><span id="l142.152">  * @return the result from wait_for_window_close</span>
<a href="#l142.153"></a><span id="l142.153">  */</span>
<a href="#l142.154"></a><span id="l142.154" class="difflineminus">-function close_address_book_window(abc)</span>
<a href="#l142.155"></a><span id="l142.155" class="difflineminus">-{</span>
<a href="#l142.156"></a><span id="l142.156" class="difflineplus">+function close_address_book_window(abc) {</span>
<a href="#l142.157"></a><span id="l142.157">   windowHelper.plan_for_window_close(abc);</span>
<a href="#l142.158"></a><span id="l142.158">   abc.window.close();</span>
<a href="#l142.159"></a><span id="l142.159">   return windowHelper.wait_for_window_close(abc);</span>
<a href="#l142.160"></a><span id="l142.160"> }</span>
<a href="#l142.161"></a><span id="l142.161"> </span>
<a href="#l142.162"></a><span id="l142.162"> /**</span>
<a href="#l142.163"></a><span id="l142.163">  * Creates and returns a Mork-backed address book.</span>
<a href="#l142.164"></a><span id="l142.164">  * @param aName the name for the address book</span>
<a href="#l142.165"></a><span id="l142.165">  * @returns the nsIAbDirectory address book</span>
<a href="#l142.166"></a><span id="l142.166">  */</span>
<a href="#l142.167"></a><span id="l142.167" class="difflineminus">-function create_mork_address_book(aName)</span>
<a href="#l142.168"></a><span id="l142.168" class="difflineminus">-{</span>
<a href="#l142.169"></a><span id="l142.169" class="difflineplus">+function create_mork_address_book(aName) {</span>
<a href="#l142.170"></a><span id="l142.170">   let abPrefString = MailServices.ab.newAddressBook(aName, &quot;&quot;, 2);</span>
<a href="#l142.171"></a><span id="l142.171">   let abURI = Services.prefs.getCharPref(abPrefString + &quot;.filename&quot;);</span>
<a href="#l142.172"></a><span id="l142.172">   return MailServices.ab.getDirectory(ABMDB_PREFIX + abURI);</span>
<a href="#l142.173"></a><span id="l142.173"> }</span>
<a href="#l142.174"></a><span id="l142.174"> </span>
<a href="#l142.175"></a><span id="l142.175"> /**</span>
<a href="#l142.176"></a><span id="l142.176">  * Creates and returns an LDAP-backed address book.</span>
<a href="#l142.177"></a><span id="l142.177">  * This function will automatically fill in a dummy</span>
<a href="#l142.178"></a><span id="l142.178">  * LDAP URI if no URI is supplied.</span>
<a href="#l142.179"></a><span id="l142.179">  * @param aName the name for the address book</span>
<a href="#l142.180"></a><span id="l142.180">  * @param aURI an optional URI for the address book</span>
<a href="#l142.181"></a><span id="l142.181">  * @returns the nsIAbDirectory address book</span>
<a href="#l142.182"></a><span id="l142.182">  */</span>
<a href="#l142.183"></a><span id="l142.183" class="difflineminus">-function create_ldap_address_book(aName, aURI)</span>
<a href="#l142.184"></a><span id="l142.184" class="difflineminus">-{</span>
<a href="#l142.185"></a><span id="l142.185" class="difflineplus">+function create_ldap_address_book(aName, aURI) {</span>
<a href="#l142.186"></a><span id="l142.186">   if (!aURI)</span>
<a href="#l142.187"></a><span id="l142.187">     aURI = &quot;ldap://dummyldap/??sub?(objectclass=*)&quot;;</span>
<a href="#l142.188"></a><span id="l142.188">   let abPrefString = MailServices.ab.newAddressBook(aName, aURI, 0);</span>
<a href="#l142.189"></a><span id="l142.189">   return MailServices.ab.getDirectory(ABLDAP_PREFIX + abPrefString);</span>
<a href="#l142.190"></a><span id="l142.190"> }</span>
<a href="#l142.191"></a><span id="l142.191"> </span>
<a href="#l142.192"></a><span id="l142.192"> /**</span>
<a href="#l142.193"></a><span id="l142.193">  * Creates and returns an address book contact</span>
<a href="#l142.194"></a><span id="l142.194">  * @param aEmailAddress the e-mail address for this contact</span>
<a href="#l142.195"></a><span id="l142.195">  * @param aDisplayName the display name for the contact</span>
<a href="#l142.196"></a><span id="l142.196">  * @param aPreferDisplayName set to true if the card display name should</span>
<a href="#l142.197"></a><span id="l142.197">  *                           override the header display name</span>
<a href="#l142.198"></a><span id="l142.198">  */</span>
<a href="#l142.199"></a><span id="l142.199" class="difflineminus">-function create_contact(aEmailAddress, aDisplayName, aPreferDisplayName)</span>
<a href="#l142.200"></a><span id="l142.200" class="difflineminus">-{</span>
<a href="#l142.201"></a><span id="l142.201" class="difflineplus">+function create_contact(aEmailAddress, aDisplayName, aPreferDisplayName) {</span>
<a href="#l142.202"></a><span id="l142.202">   let card = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;]</span>
<a href="#l142.203"></a><span id="l142.203">                .createInstance(Ci.nsIAbCard);</span>
<a href="#l142.204"></a><span id="l142.204">   card.primaryEmail = aEmailAddress;</span>
<a href="#l142.205"></a><span id="l142.205">   card.displayName = aDisplayName;</span>
<a href="#l142.206"></a><span id="l142.206" class="difflineminus">-  card.setProperty(&quot;PreferDisplayName&quot;, aPreferDisplayName ? true : false);</span>
<a href="#l142.207"></a><span id="l142.207" class="difflineplus">+  card.setProperty(&quot;PreferDisplayName&quot;, !!aPreferDisplayName);</span>
<a href="#l142.208"></a><span id="l142.208">   return card;</span>
<a href="#l142.209"></a><span id="l142.209"> }</span>
<a href="#l142.210"></a><span id="l142.210"> </span>
<a href="#l142.211"></a><span id="l142.211"> /* Creates and returns a mailing list</span>
<a href="#l142.212"></a><span id="l142.212">  * @param aMailingListName the display name for the new mailing list</span>
<a href="#l142.213"></a><span id="l142.213">  */</span>
<a href="#l142.214"></a><span id="l142.214" class="difflineminus">-function create_mailing_list(aMailingListName)</span>
<a href="#l142.215"></a><span id="l142.215" class="difflineminus">-{</span>
<a href="#l142.216"></a><span id="l142.216" class="difflineplus">+function create_mailing_list(aMailingListName) {</span>
<a href="#l142.217"></a><span id="l142.217">   var mailList = Cc[&quot;@mozilla.org/addressbook/directoryproperty;1&quot;]</span>
<a href="#l142.218"></a><span id="l142.218">                    .createInstance(Ci.nsIAbDirectory);</span>
<a href="#l142.219"></a><span id="l142.219">   mailList.isMailList = true;</span>
<a href="#l142.220"></a><span id="l142.220">   mailList.dirName = aMailingListName;</span>
<a href="#l142.221"></a><span id="l142.221">   return mailList;</span>
<a href="#l142.222"></a><span id="l142.222"> }</span>
<a href="#l142.223"></a><span id="l142.223"> </span>
<a href="#l142.224"></a><span id="l142.224"> /* Finds and returns a mailing list with a given dirName within a</span>
<a href="#l142.225"></a><span id="l142.225">  * given address book.</span>
<a href="#l142.226"></a><span id="l142.226">  * @param aAddressBook the address book to search</span>
<a href="#l142.227"></a><span id="l142.227">  * @param aDirName the dirName of the mailing list</span>
<a href="#l142.228"></a><span id="l142.228">  */</span>
<a href="#l142.229"></a><span id="l142.229" class="difflineminus">-function get_mailing_list_from_address_book(aAddressBook, aDirName)</span>
<a href="#l142.230"></a><span id="l142.230" class="difflineminus">-{</span>
<a href="#l142.231"></a><span id="l142.231" class="difflineplus">+function get_mailing_list_from_address_book(aAddressBook, aDirName) {</span>
<a href="#l142.232"></a><span id="l142.232">   let mailingLists = aAddressBook.childNodes;</span>
<a href="#l142.233"></a><span id="l142.233" class="difflineminus">-  while (mailingLists.hasMoreElements())</span>
<a href="#l142.234"></a><span id="l142.234" class="difflineminus">-  {</span>
<a href="#l142.235"></a><span id="l142.235" class="difflineplus">+  while (mailingLists.hasMoreElements()) {</span>
<a href="#l142.236"></a><span id="l142.236">     let item = mailingLists.getNext();</span>
<a href="#l142.237"></a><span id="l142.237">     let list = item.QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l142.238"></a><span id="l142.238">     if (list &amp;&amp; list.dirName == aDirName)</span>
<a href="#l142.239"></a><span id="l142.239">       return list;</span>
<a href="#l142.240"></a><span id="l142.240">   }</span>
<a href="#l142.241"></a><span id="l142.241">   throw Error(&quot;Could not find a mailing list with dirName &quot; + aDirName);</span>
<a href="#l142.242"></a><span id="l142.242"> }</span>
<a href="#l142.243"></a><span id="l142.243"> </span>
<a href="#l142.244"></a><span id="l142.244" class="difflineat">@@ -241,18 +220,17 @@ function get_mailing_list_from_address_b</span>
<a href="#l142.245"></a><span id="l142.245">  * @param aAddressBook an address book to add the contacts to</span>
<a href="#l142.246"></a><span id="l142.246">  * @param aContacts a collection of nsIAbCards, or contacts,</span>
<a href="#l142.247"></a><span id="l142.247">  *                  where each contact has members &quot;email&quot;</span>
<a href="#l142.248"></a><span id="l142.248">  *                  and &quot;displayName&quot;</span>
<a href="#l142.249"></a><span id="l142.249">  *</span>
<a href="#l142.250"></a><span id="l142.250">  *                  Example:</span>
<a href="#l142.251"></a><span id="l142.251">  *                  [{email: 'test@example.com', displayName: 'Sammy Jenkis'}]</span>
<a href="#l142.252"></a><span id="l142.252">  */</span>
<a href="#l142.253"></a><span id="l142.253" class="difflineminus">-function load_contacts_into_address_book(aAddressBook, aContacts)</span>
<a href="#l142.254"></a><span id="l142.254" class="difflineminus">-{</span>
<a href="#l142.255"></a><span id="l142.255" class="difflineplus">+function load_contacts_into_address_book(aAddressBook, aContacts) {</span>
<a href="#l142.256"></a><span id="l142.256">   for (let contact of aContacts) {</span>
<a href="#l142.257"></a><span id="l142.257">     if (!(contact instanceof Ci.nsIAbCard))</span>
<a href="#l142.258"></a><span id="l142.258">       contact = create_contact(contact.email,</span>
<a href="#l142.259"></a><span id="l142.259">                                contact.displayName, true);</span>
<a href="#l142.260"></a><span id="l142.260"> </span>
<a href="#l142.261"></a><span id="l142.261">     aAddressBook.addCard(contact);</span>
<a href="#l142.262"></a><span id="l142.262">   }</span>
<a href="#l142.263"></a><span id="l142.263"> }</span>
<a href="#l142.264"></a><span id="l142.264" class="difflineat">@@ -262,30 +240,28 @@ function load_contacts_into_address_book</span>
<a href="#l142.265"></a><span id="l142.265">  * @param aMailingList a mailing list to add the contacts to</span>
<a href="#l142.266"></a><span id="l142.266">  * @param aContacts a collection of contacts, where each contact is either</span>
<a href="#l142.267"></a><span id="l142.267">  *                  an nsIAbCard, or an object with members &quot;email&quot; and</span>
<a href="#l142.268"></a><span id="l142.268">  *                  &quot;displayName&quot;</span>
<a href="#l142.269"></a><span id="l142.269">  *</span>
<a href="#l142.270"></a><span id="l142.270">  *                  Example:</span>
<a href="#l142.271"></a><span id="l142.271">  *                  [{email: 'test@example.com', displayName: 'Sammy Jenkis'}]</span>
<a href="#l142.272"></a><span id="l142.272">  */</span>
<a href="#l142.273"></a><span id="l142.273" class="difflineminus">-function load_contacts_into_mailing_list(aMailingList, aContacts)</span>
<a href="#l142.274"></a><span id="l142.274" class="difflineminus">-{</span>
<a href="#l142.275"></a><span id="l142.275" class="difflineplus">+function load_contacts_into_mailing_list(aMailingList, aContacts) {</span>
<a href="#l142.276"></a><span id="l142.276">   // Surprise! A mailing list is just a super special type of address</span>
<a href="#l142.277"></a><span id="l142.277">   // book.</span>
<a href="#l142.278"></a><span id="l142.278">   load_contacts_into_address_book(aMailingList, aContacts);</span>
<a href="#l142.279"></a><span id="l142.279"> }</span>
<a href="#l142.280"></a><span id="l142.280"> </span>
<a href="#l142.281"></a><span id="l142.281"> /* Given some address book, return the row index for that address book</span>
<a href="#l142.282"></a><span id="l142.282">  * in the tree view.  Throws an error if it cannot find the address book.</span>
<a href="#l142.283"></a><span id="l142.283">  * @param aAddrBook an address book to search for</span>
<a href="#l142.284"></a><span id="l142.284">  * @return the row index for that address book</span>
<a href="#l142.285"></a><span id="l142.285">  */</span>
<a href="#l142.286"></a><span id="l142.286" class="difflineminus">-function get_address_book_tree_view_index(aAddrBook)</span>
<a href="#l142.287"></a><span id="l142.287" class="difflineminus">-{</span>
<a href="#l142.288"></a><span id="l142.288" class="difflineplus">+function get_address_book_tree_view_index(aAddrBook) {</span>
<a href="#l142.289"></a><span id="l142.289">   let addrbooks = abController.window.gDirectoryTreeView._rowMap;</span>
<a href="#l142.290"></a><span id="l142.290">   for (let i = 0; i &lt; addrbooks.length; i++) {</span>
<a href="#l142.291"></a><span id="l142.291">     if (addrbooks[i]._directory == aAddrBook) {</span>
<a href="#l142.292"></a><span id="l142.292">       return i;</span>
<a href="#l142.293"></a><span id="l142.293">     }</span>
<a href="#l142.294"></a><span id="l142.294">   }</span>
<a href="#l142.295"></a><span id="l142.295">   throw Error(&quot;Could not find the index for the address book named &quot;</span>
<a href="#l142.296"></a><span id="l142.296">               + aAddrBook.dirName);</span>
<a href="#l142.297"></a><span id="l142.297" class="difflineat">@@ -293,64 +269,59 @@ function get_address_book_tree_view_inde</span>
<a href="#l142.298"></a><span id="l142.298"> </span>
<a href="#l142.299"></a><span id="l142.299"> /* Given some contact, return the row index for that contact in the</span>
<a href="#l142.300"></a><span id="l142.300">  * address book view.  Assumes that the address book that the contact</span>
<a href="#l142.301"></a><span id="l142.301">  * belongs to is currently selected.  Throws an error if it cannot</span>
<a href="#l142.302"></a><span id="l142.302">  * find the contact.</span>
<a href="#l142.303"></a><span id="l142.303">  * @param aContact a contact to search for</span>
<a href="#l142.304"></a><span id="l142.304">  * @return the row index for that contact</span>
<a href="#l142.305"></a><span id="l142.305">  */</span>
<a href="#l142.306"></a><span id="l142.306" class="difflineminus">-function get_contact_ab_view_index(aContact)</span>
<a href="#l142.307"></a><span id="l142.307" class="difflineminus">-{</span>
<a href="#l142.308"></a><span id="l142.308" class="difflineplus">+function get_contact_ab_view_index(aContact) {</span>
<a href="#l142.309"></a><span id="l142.309">   let contacts = abController.window.gAbView;</span>
<a href="#l142.310"></a><span id="l142.310">   for (let i = 0; i &lt; contacts.rowCount; i++) {</span>
<a href="#l142.311"></a><span id="l142.311">     let contact = contacts.getCardFromRow(i);</span>
<a href="#l142.312"></a><span id="l142.312">     if (contact.localId == aContact.localId &amp;&amp;</span>
<a href="#l142.313"></a><span id="l142.313">         !contact.isMailList)</span>
<a href="#l142.314"></a><span id="l142.314">       return i;</span>
<a href="#l142.315"></a><span id="l142.315">   }</span>
<a href="#l142.316"></a><span id="l142.316">   throw Error(&quot;Could not find the index for the contact named &quot;</span>
<a href="#l142.317"></a><span id="l142.317">               + aContact.displayName);</span>
<a href="#l142.318"></a><span id="l142.318"> }</span>
<a href="#l142.319"></a><span id="l142.319"> </span>
<a href="#l142.320"></a><span id="l142.320"> /* Determines whether or not an address book is collapsed in</span>
<a href="#l142.321"></a><span id="l142.321">  * the tree view.</span>
<a href="#l142.322"></a><span id="l142.322">  * @param aAddrBook the address book to check</span>
<a href="#l142.323"></a><span id="l142.323">  * @return true if the address book is collapsed, otherwise false</span>
<a href="#l142.324"></a><span id="l142.324">  */</span>
<a href="#l142.325"></a><span id="l142.325" class="difflineminus">-function is_address_book_collapsed(aAddrbook)</span>
<a href="#l142.326"></a><span id="l142.326" class="difflineminus">-{</span>
<a href="#l142.327"></a><span id="l142.327" class="difflineplus">+function is_address_book_collapsed(aAddrbook) {</span>
<a href="#l142.328"></a><span id="l142.328">   let aIndex = get_address_book_tree_view_index(aAddrbook);</span>
<a href="#l142.329"></a><span id="l142.329">   return !abController.window.gDirectoryTreeView.isContainerOpen(aIndex);</span>
<a href="#l142.330"></a><span id="l142.330"> }</span>
<a href="#l142.331"></a><span id="l142.331"> </span>
<a href="#l142.332"></a><span id="l142.332"> /* Determines whether or not an address book is collapsible in</span>
<a href="#l142.333"></a><span id="l142.333">  * the tree view.</span>
<a href="#l142.334"></a><span id="l142.334">  * @param aAddrBook the address book to check</span>
<a href="#l142.335"></a><span id="l142.335">  * @return true if the address book is collapsible, otherwise false</span>
<a href="#l142.336"></a><span id="l142.336">  */</span>
<a href="#l142.337"></a><span id="l142.337" class="difflineminus">-function is_address_book_collapsible(aAddrbook)</span>
<a href="#l142.338"></a><span id="l142.338" class="difflineminus">-{</span>
<a href="#l142.339"></a><span id="l142.339" class="difflineplus">+function is_address_book_collapsible(aAddrbook) {</span>
<a href="#l142.340"></a><span id="l142.340">   let aIndex = get_address_book_tree_view_index(aAddrbook);</span>
<a href="#l142.341"></a><span id="l142.341">   return !abController.window.gDirectoryTreeView.isContainerEmpty(aIndex);</span>
<a href="#l142.342"></a><span id="l142.342"> }</span>
<a href="#l142.343"></a><span id="l142.343"> </span>
<a href="#l142.344"></a><span id="l142.344"> /* Sets one or more address books to the expanded state in the</span>
<a href="#l142.345"></a><span id="l142.345">  * tree view.  If any of the address books cannot be expanded,</span>
<a href="#l142.346"></a><span id="l142.346">  * an error is thrown.</span>
<a href="#l142.347"></a><span id="l142.347">  * @param aAddrBooks either a lone address book, or an array of</span>
<a href="#l142.348"></a><span id="l142.348">  *        address books</span>
<a href="#l142.349"></a><span id="l142.349">  */</span>
<a href="#l142.350"></a><span id="l142.350" class="difflineminus">-function set_address_books_expanded(aAddrBooks)</span>
<a href="#l142.351"></a><span id="l142.351" class="difflineminus">-{</span>
<a href="#l142.352"></a><span id="l142.352" class="difflineplus">+function set_address_books_expanded(aAddrBooks) {</span>
<a href="#l142.353"></a><span id="l142.353">   if (!Array.isArray(aAddrBooks))</span>
<a href="#l142.354"></a><span id="l142.354">     aAddrBooks = [aAddrBooks];</span>
<a href="#l142.355"></a><span id="l142.355"> </span>
<a href="#l142.356"></a><span id="l142.356" class="difflineminus">-  for (let i = 0; i &lt; aAddrBooks.length; i++)</span>
<a href="#l142.357"></a><span id="l142.357" class="difflineminus">-  {</span>
<a href="#l142.358"></a><span id="l142.358" class="difflineplus">+  for (let i = 0; i &lt; aAddrBooks.length; i++) {</span>
<a href="#l142.359"></a><span id="l142.359">     let addrBook = aAddrBooks[i];</span>
<a href="#l142.360"></a><span id="l142.360">     if (!is_address_book_collapsible(addrBook))</span>
<a href="#l142.361"></a><span id="l142.361">       throw Error(&quot;Address book called &quot; + addrBook.dirName</span>
<a href="#l142.362"></a><span id="l142.362">                   + &quot; cannot be expanded.&quot;);</span>
<a href="#l142.363"></a><span id="l142.363">     if (is_address_book_collapsed(addrBook)) {</span>
<a href="#l142.364"></a><span id="l142.364">       let aIndex = get_address_book_tree_view_index(addrBook);</span>
<a href="#l142.365"></a><span id="l142.365">       abController.window.gDirectoryTreeView.toggleOpenState(aIndex);</span>
<a href="#l142.366"></a><span id="l142.366">     }</span>
<a href="#l142.367"></a><span id="l142.367" class="difflineat">@@ -358,65 +329,60 @@ function set_address_books_expanded(aAdd</span>
<a href="#l142.368"></a><span id="l142.368"> }</span>
<a href="#l142.369"></a><span id="l142.369"> </span>
<a href="#l142.370"></a><span id="l142.370"> /* Sets one or more address books to the collapsed state in the</span>
<a href="#l142.371"></a><span id="l142.371">  * tree view.  If any of the address books cannot be collapsed,</span>
<a href="#l142.372"></a><span id="l142.372">  * an error is thrown.</span>
<a href="#l142.373"></a><span id="l142.373">  * @param aAddrBooks either a lone address book, or an array of</span>
<a href="#l142.374"></a><span id="l142.374">  *        address books</span>
<a href="#l142.375"></a><span id="l142.375">  */</span>
<a href="#l142.376"></a><span id="l142.376" class="difflineminus">-function set_address_books_collapsed(aAddrBooks)</span>
<a href="#l142.377"></a><span id="l142.377" class="difflineminus">-{</span>
<a href="#l142.378"></a><span id="l142.378" class="difflineplus">+function set_address_books_collapsed(aAddrBooks) {</span>
<a href="#l142.379"></a><span id="l142.379">   if (!Array.isArray(aAddrBooks))</span>
<a href="#l142.380"></a><span id="l142.380">     aAddrBooks = [aAddrBooks];</span>
<a href="#l142.381"></a><span id="l142.381"> </span>
<a href="#l142.382"></a><span id="l142.382" class="difflineminus">-  for (let i = 0; i &lt; aAddrBooks.length; i++)</span>
<a href="#l142.383"></a><span id="l142.383" class="difflineminus">-  {</span>
<a href="#l142.384"></a><span id="l142.384" class="difflineminus">-    let addrBook = aAddrBooks[i]</span>
<a href="#l142.385"></a><span id="l142.385" class="difflineplus">+  for (let i = 0; i &lt; aAddrBooks.length; i++) {</span>
<a href="#l142.386"></a><span id="l142.386" class="difflineplus">+    let addrBook = aAddrBooks[i];</span>
<a href="#l142.387"></a><span id="l142.387">     if (!is_address_book_collapsible(addrBook))</span>
<a href="#l142.388"></a><span id="l142.388">       throw Error(&quot;Address book called &quot; + addrBook.dirName</span>
<a href="#l142.389"></a><span id="l142.389">                   + &quot; cannot be collapsed.&quot;);</span>
<a href="#l142.390"></a><span id="l142.390">     if (!is_address_book_collapsed(addrBook)) {</span>
<a href="#l142.391"></a><span id="l142.391">       let aIndex = get_address_book_tree_view_index(addrBook);</span>
<a href="#l142.392"></a><span id="l142.392">       abController.window.gDirectoryTreeView.toggleOpenState(aIndex);</span>
<a href="#l142.393"></a><span id="l142.393">     }</span>
<a href="#l142.394"></a><span id="l142.394">   }</span>
<a href="#l142.395"></a><span id="l142.395"> }</span>
<a href="#l142.396"></a><span id="l142.396"> </span>
<a href="#l142.397"></a><span id="l142.397"> /* Returns the displayed name of an address book in the tree view</span>
<a href="#l142.398"></a><span id="l142.398">  * at a particular row index.</span>
<a href="#l142.399"></a><span id="l142.399">  * @param aIndex the row index of the target address book</span>
<a href="#l142.400"></a><span id="l142.400">  * @return the displayed name of the address book</span>
<a href="#l142.401"></a><span id="l142.401">  */</span>
<a href="#l142.402"></a><span id="l142.402" class="difflineminus">-function get_name_of_address_book_element_at(aIndex)</span>
<a href="#l142.403"></a><span id="l142.403" class="difflineminus">-{</span>
<a href="#l142.404"></a><span id="l142.404" class="difflineplus">+function get_name_of_address_book_element_at(aIndex) {</span>
<a href="#l142.405"></a><span id="l142.405">   return abController.window.gDirectoryTreeView.getCellText(aIndex, 0);</span>
<a href="#l142.406"></a><span id="l142.406"> }</span>
<a href="#l142.407"></a><span id="l142.407"> </span>
<a href="#l142.408"></a><span id="l142.408"> /* Selects a given address book in the tree view.  Assumes that</span>
<a href="#l142.409"></a><span id="l142.409">  * the parent of aAddrBook in the treeView is not collapsed.</span>
<a href="#l142.410"></a><span id="l142.410">  * Since mailing lists are technically address books, this will</span>
<a href="#l142.411"></a><span id="l142.411">  * work for mailing lists too.</span>
<a href="#l142.412"></a><span id="l142.412">  * @param aAddrBook an address book to select</span>
<a href="#l142.413"></a><span id="l142.413">  */</span>
<a href="#l142.414"></a><span id="l142.414" class="difflineminus">-function select_address_book(aAddrBook)</span>
<a href="#l142.415"></a><span id="l142.415" class="difflineminus">-{</span>
<a href="#l142.416"></a><span id="l142.416" class="difflineplus">+function select_address_book(aAddrBook) {</span>
<a href="#l142.417"></a><span id="l142.417">   let aIndex = get_address_book_tree_view_index(aAddrBook);</span>
<a href="#l142.418"></a><span id="l142.418">   abController.window.gDirectoryTreeView.selection.select(aIndex);</span>
<a href="#l142.419"></a><span id="l142.419">   // Focus the resulting list of cards.</span>
<a href="#l142.420"></a><span id="l142.420">   abController.window.gAbResultsTree.focus();</span>
<a href="#l142.421"></a><span id="l142.421"> }</span>
<a href="#l142.422"></a><span id="l142.422"> </span>
<a href="#l142.423"></a><span id="l142.423"> /* Selects one or more contacts in an address book, assuming that</span>
<a href="#l142.424"></a><span id="l142.424">  * the address book is already selected.  Pass a single nsIAbCard</span>
<a href="#l142.425"></a><span id="l142.425">  * to select one contact, or an array of nsIAbCards to select</span>
<a href="#l142.426"></a><span id="l142.426">  * multiple.</span>
<a href="#l142.427"></a><span id="l142.427">  */</span>
<a href="#l142.428"></a><span id="l142.428" class="difflineminus">-function select_contacts(aContacts)</span>
<a href="#l142.429"></a><span id="l142.429" class="difflineminus">-{</span>
<a href="#l142.430"></a><span id="l142.430" class="difflineplus">+function select_contacts(aContacts) {</span>
<a href="#l142.431"></a><span id="l142.431">   if (!Array.isArray(aContacts))</span>
<a href="#l142.432"></a><span id="l142.432">     aContacts = [aContacts];</span>
<a href="#l142.433"></a><span id="l142.433"> </span>
<a href="#l142.434"></a><span id="l142.434">   abController.window.gAbView.selection.clearSelection();</span>
<a href="#l142.435"></a><span id="l142.435">   for (let i = 0; i &lt; aContacts.length; i++) {</span>
<a href="#l142.436"></a><span id="l142.436">     let aIndex = get_contact_ab_view_index(aContacts[i]);</span>
<a href="#l142.437"></a><span id="l142.437">     abController.window.gAbView.selection.toggleSelect(aIndex);</span>
<a href="#l142.438"></a><span id="l142.438">   }</span>
<a href="#l142.439"></a><span id="l142.439" class="difflineat">@@ -427,34 +393,31 @@ function select_contacts(aContacts)</span>
<a href="#l142.440"></a><span id="l142.440">  * are responsible for closing the dialog.</span>
<a href="#l142.441"></a><span id="l142.441">  *</span>
<a href="#l142.442"></a><span id="l142.442">  * @param aController the address book window controller to use.</span>
<a href="#l142.443"></a><span id="l142.443">  * @param aFunction the function to execute when the editing dialog</span>
<a href="#l142.444"></a><span id="l142.444">  *                  is opened (since it's a modal dialog).  The function</span>
<a href="#l142.445"></a><span id="l142.445">  *                  should take a single parameter, which will be the</span>
<a href="#l142.446"></a><span id="l142.446">  *                  augmented controller for the editing dialog.</span>
<a href="#l142.447"></a><span id="l142.447">  */</span>
<a href="#l142.448"></a><span id="l142.448" class="difflineminus">-function edit_selected_contact(aController, aFunction)</span>
<a href="#l142.449"></a><span id="l142.449" class="difflineminus">-{</span>
<a href="#l142.450"></a><span id="l142.450" class="difflineplus">+function edit_selected_contact(aController, aFunction) {</span>
<a href="#l142.451"></a><span id="l142.451">   windowHelper.plan_for_modal_dialog(&quot;abcardWindow&quot;, aFunction);</span>
<a href="#l142.452"></a><span id="l142.452">   aController.click(aController.eid(&quot;button-editcard&quot;));</span>
<a href="#l142.453"></a><span id="l142.453">   windowHelper.wait_for_modal_dialog(&quot;abcardWindow&quot;);</span>
<a href="#l142.454"></a><span id="l142.454"> }</span>
<a href="#l142.455"></a><span id="l142.455"> </span>
<a href="#l142.456"></a><span id="l142.456"> /**</span>
<a href="#l142.457"></a><span id="l142.457">  * Accepts the changes entered into the contact editing dialog, and closes</span>
<a href="#l142.458"></a><span id="l142.458">  * the dialog.</span>
<a href="#l142.459"></a><span id="l142.459">  *</span>
<a href="#l142.460"></a><span id="l142.460">  * @param aController the contact editing dialog controller to use.</span>
<a href="#l142.461"></a><span id="l142.461">  */</span>
<a href="#l142.462"></a><span id="l142.462" class="difflineminus">-function accept_contact_changes(aController)</span>
<a href="#l142.463"></a><span id="l142.463" class="difflineminus">-{</span>
<a href="#l142.464"></a><span id="l142.464" class="difflineplus">+function accept_contact_changes(aController) {</span>
<a href="#l142.465"></a><span id="l142.465">   if (!aController.window.document.documentElement.acceptDialog())</span>
<a href="#l142.466"></a><span id="l142.466">     throw new Error(&quot;Could not close the contact editing dialog!&quot;);</span>
<a href="#l142.467"></a><span id="l142.467"> }</span>
<a href="#l142.468"></a><span id="l142.468"> </span>
<a href="#l142.469"></a><span id="l142.469"> /**</span>
<a href="#l142.470"></a><span id="l142.470">  * Deletes an address book.</span>
<a href="#l142.471"></a><span id="l142.471">  */</span>
<a href="#l142.472"></a><span id="l142.472" class="difflineminus">-function delete_address_book(aAddrBook)</span>
<a href="#l142.473"></a><span id="l142.473" class="difflineminus">-{</span>
<a href="#l142.474"></a><span id="l142.474" class="difflineplus">+function delete_address_book(aAddrBook) {</span>
<a href="#l142.475"></a><span id="l142.475">   MailServices.ab.deleteAddressBook(aAddrBook.URI);</span>
<a href="#l142.476"></a><span id="l142.476"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l143.1"></a><span id="l143.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-attachment-helpers.js</span>
<a href="#l143.2"></a><span id="l143.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-attachment-helpers.js</span>
<a href="#l143.3"></a><span id="l143.3" class="difflineat">@@ -1,26 +1,25 @@</span>
<a href="#l143.4"></a><span id="l143.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l143.5"></a><span id="l143.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l143.6"></a><span id="l143.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l143.7"></a><span id="l143.7"> </span>
<a href="#l143.8"></a><span id="l143.8"> &quot;use strict&quot;;</span>
<a href="#l143.9"></a><span id="l143.9"> </span>
<a href="#l143.10"></a><span id="l143.10"> var MODULE_NAME = &quot;attachment-helpers&quot;;</span>
<a href="#l143.11"></a><span id="l143.11" class="difflineminus">-</span>
<a href="#l143.12"></a><span id="l143.12"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l143.13"></a><span id="l143.13"> var MODULE_REQUIRES = [&quot;mock-object-helpers&quot;];</span>
<a href="#l143.14"></a><span id="l143.14"> </span>
<a href="#l143.15"></a><span id="l143.15"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l143.16"></a><span id="l143.16"> var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l143.17"></a><span id="l143.17"> </span>
<a href="#l143.18"></a><span id="l143.18"> var gMockFilePickReg;</span>
<a href="#l143.19"></a><span id="l143.19"> </span>
<a href="#l143.20"></a><span id="l143.20"> function setupModule(module) {</span>
<a href="#l143.21"></a><span id="l143.21" class="difflineminus">-  let moh = collector.getModule('mock-object-helpers');</span>
<a href="#l143.22"></a><span id="l143.22" class="difflineplus">+  let moh = collector.getModule(&quot;mock-object-helpers&quot;);</span>
<a href="#l143.23"></a><span id="l143.23"> </span>
<a href="#l143.24"></a><span id="l143.24">   gMockFilePickReg = new moh.MockObjectReplacer(&quot;@mozilla.org/filepicker;1&quot;,</span>
<a href="#l143.25"></a><span id="l143.25">                                                   MockFilePickerConstructor);</span>
<a href="#l143.26"></a><span id="l143.26"> }</span>
<a href="#l143.27"></a><span id="l143.27"> </span>
<a href="#l143.28"></a><span id="l143.28"> function installInto(module) {</span>
<a href="#l143.29"></a><span id="l143.29">   setupModule(module);</span>
<a href="#l143.30"></a><span id="l143.30"> </span>
<a href="#l143.31"></a><span id="l143.31" class="difflineat">@@ -31,17 +30,17 @@ function installInto(module) {</span>
<a href="#l143.32"></a><span id="l143.32">   module.create_enclosure_attachment = create_enclosure_attachment;</span>
<a href="#l143.33"></a><span id="l143.33">   module.gMockFilePickReg = gMockFilePickReg;</span>
<a href="#l143.34"></a><span id="l143.34">   module.gMockFilePicker = gMockFilePicker;</span>
<a href="#l143.35"></a><span id="l143.35">   module.select_attachments = select_attachments;</span>
<a href="#l143.36"></a><span id="l143.36"> }</span>
<a href="#l143.37"></a><span id="l143.37"> </span>
<a href="#l143.38"></a><span id="l143.38"> function MockFilePickerConstructor() {</span>
<a href="#l143.39"></a><span id="l143.39">   return gMockFilePicker;</span>
<a href="#l143.40"></a><span id="l143.40" class="difflineminus">-};</span>
<a href="#l143.41"></a><span id="l143.41" class="difflineplus">+}</span>
<a href="#l143.42"></a><span id="l143.42"> </span>
<a href="#l143.43"></a><span id="l143.43"> var gMockFilePicker = {</span>
<a href="#l143.44"></a><span id="l143.44">   QueryInterface: ChromeUtils.generateQI([Ci.nsIFilePicker]),</span>
<a href="#l143.45"></a><span id="l143.45">   defaultExtension: &quot;&quot;,</span>
<a href="#l143.46"></a><span id="l143.46">   filterIndex: null,</span>
<a href="#l143.47"></a><span id="l143.47">   displayDirectory: null,</span>
<a href="#l143.48"></a><span id="l143.48">   returnFiles: [],</span>
<a href="#l143.49"></a><span id="l143.49">   addToRecentDocs: false,</span>
<a href="#l143.50"></a><span id="l143.50" class="difflineat">@@ -60,74 +59,73 @@ var gMockFilePicker = {</span>
<a href="#l143.51"></a><span id="l143.51">     return null;</span>
<a href="#l143.52"></a><span id="l143.52">   },</span>
<a href="#l143.53"></a><span id="l143.53"> </span>
<a href="#l143.54"></a><span id="l143.54">   get files() {</span>
<a href="#l143.55"></a><span id="l143.55">     let self = this;</span>
<a href="#l143.56"></a><span id="l143.56">     return {</span>
<a href="#l143.57"></a><span id="l143.57">       index: 0,</span>
<a href="#l143.58"></a><span id="l143.58">       QueryInterface: ChromeUtils.generateQI([Ci.nsISimpleEnumerator]),</span>
<a href="#l143.59"></a><span id="l143.59" class="difflineminus">-      hasMoreElements: function() {</span>
<a href="#l143.60"></a><span id="l143.60" class="difflineplus">+      hasMoreElements() {</span>
<a href="#l143.61"></a><span id="l143.61">         return this.index &lt; self.returnFiles.length;</span>
<a href="#l143.62"></a><span id="l143.62">       },</span>
<a href="#l143.63"></a><span id="l143.63" class="difflineminus">-      getNext: function() {</span>
<a href="#l143.64"></a><span id="l143.64" class="difflineplus">+      getNext() {</span>
<a href="#l143.65"></a><span id="l143.65">         return self.returnFiles[this.index++];</span>
<a href="#l143.66"></a><span id="l143.66">       },</span>
<a href="#l143.67"></a><span id="l143.67">       [Symbol.iterator]() {</span>
<a href="#l143.68"></a><span id="l143.68">         return self.returnFiles.values();</span>
<a href="#l143.69"></a><span id="l143.69" class="difflineminus">-      }</span>
<a href="#l143.70"></a><span id="l143.70" class="difflineminus">-    }</span>
<a href="#l143.71"></a><span id="l143.71" class="difflineplus">+      },</span>
<a href="#l143.72"></a><span id="l143.72" class="difflineplus">+    };</span>
<a href="#l143.73"></a><span id="l143.73">   },</span>
<a href="#l143.74"></a><span id="l143.74"> </span>
<a href="#l143.75"></a><span id="l143.75">   init: function gMFP_init(aParent, aTitle, aMode) {</span>
<a href="#l143.76"></a><span id="l143.76">   },</span>
<a href="#l143.77"></a><span id="l143.77"> </span>
<a href="#l143.78"></a><span id="l143.78">   appendFilters: function gMFP_appendFilters(aFilterMask) {</span>
<a href="#l143.79"></a><span id="l143.79">   },</span>
<a href="#l143.80"></a><span id="l143.80"> </span>
<a href="#l143.81"></a><span id="l143.81">   appendFilter: function gMFP_appendFilter(aTitle, aFilter) {</span>
<a href="#l143.82"></a><span id="l143.82">   },</span>
<a href="#l143.83"></a><span id="l143.83"> </span>
<a href="#l143.84"></a><span id="l143.84" class="difflineminus">-  open: function(aFilePickerShownCallback) {</span>
<a href="#l143.85"></a><span id="l143.85" class="difflineplus">+  open(aFilePickerShownCallback) {</span>
<a href="#l143.86"></a><span id="l143.86">     aFilePickerShownCallback.done(Ci.nsIFilePicker.returnOK);</span>
<a href="#l143.87"></a><span id="l143.87">   },</span>
<a href="#l143.88"></a><span id="l143.88"> </span>
<a href="#l143.89"></a><span id="l143.89">   set defaultString(aVal) {</span>
<a href="#l143.90"></a><span id="l143.90">   },</span>
<a href="#l143.91"></a><span id="l143.91" class="difflineminus">-}</span>
<a href="#l143.92"></a><span id="l143.92" class="difflineplus">+};</span>
<a href="#l143.93"></a><span id="l143.93"> </span>
<a href="#l143.94"></a><span id="l143.94"> /**</span>
<a href="#l143.95"></a><span id="l143.95">  * Create a body part with attachments for the message generator</span>
<a href="#l143.96"></a><span id="l143.96">  *</span>
<a href="#l143.97"></a><span id="l143.97">  * @param body the text of the main body of the message</span>
<a href="#l143.98"></a><span id="l143.98">  * @param attachments an array of attachment objects (as strings)</span>
<a href="#l143.99"></a><span id="l143.99">  * @param boundary an optional string defining the boundary of the parts</span>
<a href="#l143.100"></a><span id="l143.100">  * @return an object suitable for passing as the |bodyPart| for create_message</span>
<a href="#l143.101"></a><span id="l143.101">  */</span>
<a href="#l143.102"></a><span id="l143.102" class="difflineminus">-function create_body_part(body, attachments, boundary)</span>
<a href="#l143.103"></a><span id="l143.103" class="difflineminus">-{</span>
<a href="#l143.104"></a><span id="l143.104" class="difflineplus">+function create_body_part(body, attachments, boundary) {</span>
<a href="#l143.105"></a><span id="l143.105">   if (!boundary)</span>
<a href="#l143.106"></a><span id="l143.106">     boundary = &quot;------------CHOPCHOP&quot;;</span>
<a href="#l143.107"></a><span id="l143.107"> </span>
<a href="#l143.108"></a><span id="l143.108">   return {</span>
<a href="#l143.109"></a><span id="l143.109">     contentTypeHeaderValue:</span>
<a href="#l143.110"></a><span id="l143.110">       &quot;multipart/mixed;\r\n boundary=\&quot;&quot; + boundary + &quot;\&quot;&quot;,</span>
<a href="#l143.111"></a><span id="l143.111" class="difflineminus">-    toMessageString: function() {</span>
<a href="#l143.112"></a><span id="l143.112" class="difflineplus">+    toMessageString() {</span>
<a href="#l143.113"></a><span id="l143.113">       let str = &quot;This is a multi-part message in MIME format.\r\n&quot; +</span>
<a href="#l143.114"></a><span id="l143.114">                 &quot;--&quot; + boundary + &quot;\r\n&quot; +</span>
<a href="#l143.115"></a><span id="l143.115">                 &quot;Content-Type: text/plain; charset=ISO-8859-1; &quot; +</span>
<a href="#l143.116"></a><span id="l143.116">                   &quot;format=flowed\r\n&quot; +</span>
<a href="#l143.117"></a><span id="l143.117">                 &quot;Content-Transfer-Encoding: 7bit\r\n\r\n&quot; + body + &quot;\r\n\r\n&quot;;</span>
<a href="#l143.118"></a><span id="l143.118"> </span>
<a href="#l143.119"></a><span id="l143.119">       for (let i = 0; i &lt; attachments.length; i++)</span>
<a href="#l143.120"></a><span id="l143.120">         str += &quot;--&quot; + boundary + &quot;\r\n&quot; + attachments[i] + &quot;\r\n&quot;;</span>
<a href="#l143.121"></a><span id="l143.121"> </span>
<a href="#l143.122"></a><span id="l143.122">       str += &quot;--&quot; + boundary + &quot;--&quot;;</span>
<a href="#l143.123"></a><span id="l143.123">       return str;</span>
<a href="#l143.124"></a><span id="l143.124" class="difflineminus">-    }</span>
<a href="#l143.125"></a><span id="l143.125" class="difflineplus">+    },</span>
<a href="#l143.126"></a><span id="l143.126">   };</span>
<a href="#l143.127"></a><span id="l143.127"> }</span>
<a href="#l143.128"></a><span id="l143.128"> </span>
<a href="#l143.129"></a><span id="l143.129"> function help_create_detached_deleted_attachment(filename, type) {</span>
<a href="#l143.130"></a><span id="l143.130">   return &quot;You deleted an attachment from this message. The original MIME &quot; +</span>
<a href="#l143.131"></a><span id="l143.131">            &quot;headers for the attachment were:\r\n&quot; +</span>
<a href="#l143.132"></a><span id="l143.132">          &quot;Content-Type: &quot; + type + &quot;;\r\n&quot; +</span>
<a href="#l143.133"></a><span id="l143.133">          &quot; name=\&quot;&quot; + filename + &quot;\&quot;\r\n&quot; +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l144.1"></a><span id="l144.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js</span>
<a href="#l144.2"></a><span id="l144.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js</span>
<a href="#l144.3"></a><span id="l144.3" class="difflineat">@@ -1,16 +1,15 @@</span>
<a href="#l144.4"></a><span id="l144.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l144.5"></a><span id="l144.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l144.6"></a><span id="l144.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l144.7"></a><span id="l144.7"> </span>
<a href="#l144.8"></a><span id="l144.8"> &quot;use strict&quot;;</span>
<a href="#l144.9"></a><span id="l144.9"> </span>
<a href="#l144.10"></a><span id="l144.10"> var MODULE_NAME = &quot;cloudfile-backend-helpers&quot;;</span>
<a href="#l144.11"></a><span id="l144.11" class="difflineminus">-</span>
<a href="#l144.12"></a><span id="l144.12"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l144.13"></a><span id="l144.13"> var MODULE_REQUIRES = [&quot;window-helpers&quot;];</span>
<a href="#l144.14"></a><span id="l144.14"> </span>
<a href="#l144.15"></a><span id="l144.15"> var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l144.16"></a><span id="l144.16"> </span>
<a href="#l144.17"></a><span id="l144.17"> var kUserAuthRequested = &quot;cloudfile:auth&quot;;</span>
<a href="#l144.18"></a><span id="l144.18"> var kUserDataRequested = &quot;cloudfile:user&quot;;</span>
<a href="#l144.19"></a><span id="l144.19"> var kUploadFile = &quot;cloudfile:uploadFile&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l145.1"></a><span id="l145.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</span>
<a href="#l145.2"></a><span id="l145.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</span>
<a href="#l145.3"></a><span id="l145.3" class="difflineat">@@ -1,16 +1,15 @@</span>
<a href="#l145.4"></a><span id="l145.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l145.5"></a><span id="l145.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l145.6"></a><span id="l145.6">   * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l145.7"></a><span id="l145.7"> </span>
<a href="#l145.8"></a><span id="l145.8"> &quot;use strict&quot;;</span>
<a href="#l145.9"></a><span id="l145.9"> </span>
<a href="#l145.10"></a><span id="l145.10"> var MODULE_NAME = &quot;cloudfile-helpers&quot;;</span>
<a href="#l145.11"></a><span id="l145.11" class="difflineminus">-</span>
<a href="#l145.12"></a><span id="l145.12"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l145.13"></a><span id="l145.13"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l145.14"></a><span id="l145.14"> </span>
<a href="#l145.15"></a><span id="l145.15"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l145.16"></a><span id="l145.16"> var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.jsm&quot;);</span>
<a href="#l145.17"></a><span id="l145.17"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l145.18"></a><span id="l145.18"> </span>
<a href="#l145.19"></a><span id="l145.19"> var kMockContractIDPrefix = &quot;@mozilla.org/mail/mockCloudFile;1?id=&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l146.1"></a><span id="l146.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-compose-helpers.js</span>
<a href="#l146.2"></a><span id="l146.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-compose-helpers.js</span>
<a href="#l146.3"></a><span id="l146.3" class="difflineat">@@ -1,36 +1,32 @@</span>
<a href="#l146.4"></a><span id="l146.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l146.5"></a><span id="l146.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l146.6"></a><span id="l146.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l146.7"></a><span id="l146.7"> </span>
<a href="#l146.8"></a><span id="l146.8"> &quot;use strict&quot;;</span>
<a href="#l146.9"></a><span id="l146.9"> </span>
<a href="#l146.10"></a><span id="l146.10"> var MODULE_NAME = &quot;compose-helpers&quot;;</span>
<a href="#l146.11"></a><span id="l146.11" class="difflineminus">-</span>
<a href="#l146.12"></a><span id="l146.12"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l146.13"></a><span id="l146.13" class="difflineminus">-// we need this for the main controller</span>
<a href="#l146.14"></a><span id="l146.14" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l146.15"></a><span id="l146.15" class="difflineminus">-                         &quot;window-helpers&quot;,</span>
<a href="#l146.16"></a><span id="l146.16" class="difflineminus">-                         &quot;dom-helpers&quot;];</span>
<a href="#l146.17"></a><span id="l146.17" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;dom-helpers&quot;];</span>
<a href="#l146.18"></a><span id="l146.18"> </span>
<a href="#l146.19"></a><span id="l146.19"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l146.20"></a><span id="l146.20"> var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l146.21"></a><span id="l146.21"> </span>
<a href="#l146.22"></a><span id="l146.22"> var kTextNodeType = 3;</span>
<a href="#l146.23"></a><span id="l146.23"> </span>
<a href="#l146.24"></a><span id="l146.24"> var folderDisplayHelper;</span>
<a href="#l146.25"></a><span id="l146.25"> var mc;</span>
<a href="#l146.26"></a><span id="l146.26"> var windowHelper, domHelper;</span>
<a href="#l146.27"></a><span id="l146.27"> </span>
<a href="#l146.28"></a><span id="l146.28"> function setupModule() {</span>
<a href="#l146.29"></a><span id="l146.29" class="difflineminus">-  folderDisplayHelper = collector.getModule('folder-display-helpers');</span>
<a href="#l146.30"></a><span id="l146.30" class="difflineplus">+  folderDisplayHelper = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l146.31"></a><span id="l146.31">   mc = folderDisplayHelper.mc;</span>
<a href="#l146.32"></a><span id="l146.32" class="difflineminus">-  windowHelper = collector.getModule('window-helpers');</span>
<a href="#l146.33"></a><span id="l146.33" class="difflineminus">-  domHelper = collector.getModule('dom-helpers');</span>
<a href="#l146.34"></a><span id="l146.34" class="difflineplus">+  windowHelper = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l146.35"></a><span id="l146.35" class="difflineplus">+  domHelper = collector.getModule(&quot;dom-helpers&quot;);</span>
<a href="#l146.36"></a><span id="l146.36"> }</span>
<a href="#l146.37"></a><span id="l146.37"> </span>
<a href="#l146.38"></a><span id="l146.38"> function installInto(module) {</span>
<a href="#l146.39"></a><span id="l146.39">   setupModule();</span>
<a href="#l146.40"></a><span id="l146.40"> </span>
<a href="#l146.41"></a><span id="l146.41">   // Now copy helper functions</span>
<a href="#l146.42"></a><span id="l146.42">   module.open_compose_new_mail = open_compose_new_mail;</span>
<a href="#l146.43"></a><span id="l146.43">   module.open_compose_with_reply = open_compose_with_reply;</span>
<a href="#l146.44"></a><span id="l146.44" class="difflineat">@@ -43,17 +39,16 @@ function installInto(module) {</span>
<a href="#l146.45"></a><span id="l146.45">   module.open_compose_from_draft = open_compose_from_draft;</span>
<a href="#l146.46"></a><span id="l146.46">   module.close_compose_window = close_compose_window;</span>
<a href="#l146.47"></a><span id="l146.47">   module.wait_for_compose_window = wait_for_compose_window;</span>
<a href="#l146.48"></a><span id="l146.48">   module.setup_msg_contents = setup_msg_contents;</span>
<a href="#l146.49"></a><span id="l146.49">   module.clear_recipient = clear_recipient;</span>
<a href="#l146.50"></a><span id="l146.50">   module.toggle_recipient_type = toggle_recipient_type;</span>
<a href="#l146.51"></a><span id="l146.51">   module.create_msg_attachment = create_msg_attachment;</span>
<a href="#l146.52"></a><span id="l146.52">   module.add_attachments = add_attachments;</span>
<a href="#l146.53"></a><span id="l146.53" class="difflineminus">-  module.add_attachment = add_attachments;</span>
<a href="#l146.54"></a><span id="l146.54">   module.add_cloud_attachments = add_cloud_attachments;</span>
<a href="#l146.55"></a><span id="l146.55">   module.delete_attachment = delete_attachment;</span>
<a href="#l146.56"></a><span id="l146.56">   module.get_compose_body = get_compose_body;</span>
<a href="#l146.57"></a><span id="l146.57">   module.type_in_composer = type_in_composer;</span>
<a href="#l146.58"></a><span id="l146.58">   module.assert_previous_text = assert_previous_text;</span>
<a href="#l146.59"></a><span id="l146.59">   module.get_msg_source = get_msg_source;</span>
<a href="#l146.60"></a><span id="l146.60"> }</span>
<a href="#l146.61"></a><span id="l146.61"> </span>
<a href="#l146.62"></a><span id="l146.62" class="difflineat">@@ -233,18 +228,17 @@ function close_compose_window(aControlle</span>
<a href="#l146.63"></a><span id="l146.63">   windowHelper.plan_for_window_close(aController);</span>
<a href="#l146.64"></a><span id="l146.64">   if (aShouldPrompt) {</span>
<a href="#l146.65"></a><span id="l146.65">     windowHelper.plan_for_modal_dialog(&quot;commonDialog&quot;, function clickDontSave(controller) {</span>
<a href="#l146.66"></a><span id="l146.66">        controller.window.document.documentElement.getButton(&quot;extra1&quot;).doCommand();</span>
<a href="#l146.67"></a><span id="l146.67">     });</span>
<a href="#l146.68"></a><span id="l146.68">     // Try to close, we should get a prompt to save.</span>
<a href="#l146.69"></a><span id="l146.69">     aController.window.goDoCommand(&quot;cmd_close&quot;);</span>
<a href="#l146.70"></a><span id="l146.70">     windowHelper.wait_for_modal_dialog();</span>
<a href="#l146.71"></a><span id="l146.71" class="difflineminus">-  }</span>
<a href="#l146.72"></a><span id="l146.72" class="difflineminus">-  else {</span>
<a href="#l146.73"></a><span id="l146.73" class="difflineplus">+  } else {</span>
<a href="#l146.74"></a><span id="l146.74">     aController.window.goDoCommand(&quot;cmd_close&quot;);</span>
<a href="#l146.75"></a><span id="l146.75">   }</span>
<a href="#l146.76"></a><span id="l146.76">   windowHelper.wait_for_window_close();</span>
<a href="#l146.77"></a><span id="l146.77"> }</span>
<a href="#l146.78"></a><span id="l146.78"> </span>
<a href="#l146.79"></a><span id="l146.79"> /**</span>
<a href="#l146.80"></a><span id="l146.80">  * Waits for a new compose window to open. This assumes you have already called</span>
<a href="#l146.81"></a><span id="l146.81">  * &quot;windowHelper.plan_for_new_window(&quot;msgcompose&quot;);&quot; and the command to open</span>
<a href="#l146.82"></a><span id="l146.82" class="difflineat">@@ -264,17 +258,17 @@ function wait_for_compose_window(aContro</span>
<a href="#l146.83"></a><span id="l146.83">   if (editor.docShell.busyFlags != Ci.nsIDocShell.BUSY_FLAGS_NONE) {</span>
<a href="#l146.84"></a><span id="l146.84">     let editorObserver = {</span>
<a href="#l146.85"></a><span id="l146.85">       editorLoaded: false,</span>
<a href="#l146.86"></a><span id="l146.86"> </span>
<a href="#l146.87"></a><span id="l146.87">       observe: function eO_observe(aSubject, aTopic, aData) {</span>
<a href="#l146.88"></a><span id="l146.88">         if (aTopic == &quot;obs_documentCreated&quot;) {</span>
<a href="#l146.89"></a><span id="l146.89">           this.editorLoaded = true;</span>
<a href="#l146.90"></a><span id="l146.90">         }</span>
<a href="#l146.91"></a><span id="l146.91" class="difflineminus">-      }</span>
<a href="#l146.92"></a><span id="l146.92" class="difflineplus">+      },</span>
<a href="#l146.93"></a><span id="l146.93">     };</span>
<a href="#l146.94"></a><span id="l146.94"> </span>
<a href="#l146.95"></a><span id="l146.95">     editor.commandManager.addCommandObserver(editorObserver,</span>
<a href="#l146.96"></a><span id="l146.96">                                              &quot;obs_documentCreated&quot;);</span>
<a href="#l146.97"></a><span id="l146.97"> </span>
<a href="#l146.98"></a><span id="l146.98">     utils.waitFor(() =&gt; editorObserver.editorLoaded,</span>
<a href="#l146.99"></a><span id="l146.99">                   &quot;Timeout waiting for compose window editor to load&quot;,</span>
<a href="#l146.100"></a><span id="l146.100">                   10000, 100);</span>
<a href="#l146.101"></a><span id="l146.101" class="difflineat">@@ -314,17 +308,17 @@ function setup_msg_contents(aCwc, aAddr,</span>
<a href="#l146.102"></a><span id="l146.102">  * Remove the recipient by typing backspaces.</span>
<a href="#l146.103"></a><span id="l146.103">  *</span>
<a href="#l146.104"></a><span id="l146.104">  * @param aController    Compose window controller.</span>
<a href="#l146.105"></a><span id="l146.105">  * @param aRecipientRow  The compose widget row containing recipient to remove.</span>
<a href="#l146.106"></a><span id="l146.106">  */</span>
<a href="#l146.107"></a><span id="l146.107"> function clear_recipient(aController, aRecipientRow = 1) {</span>
<a href="#l146.108"></a><span id="l146.108">   let recipientElem = aController.window.awGetInputElement(aRecipientRow);</span>
<a href="#l146.109"></a><span id="l146.109">   while (recipientElem.value != &quot;&quot;) {</span>
<a href="#l146.110"></a><span id="l146.110" class="difflineminus">-    aController.keypress(new elib.Elem(recipientElem), 'VK_BACK_SPACE', {});</span>
<a href="#l146.111"></a><span id="l146.111" class="difflineplus">+    aController.keypress(new elib.Elem(recipientElem), &quot;VK_BACK_SPACE&quot;, {});</span>
<a href="#l146.112"></a><span id="l146.112">   }</span>
<a href="#l146.113"></a><span id="l146.113"> }</span>
<a href="#l146.114"></a><span id="l146.114"> </span>
<a href="#l146.115"></a><span id="l146.115"> /**</span>
<a href="#l146.116"></a><span id="l146.116">  * Change recipient type in compose widget.</span>
<a href="#l146.117"></a><span id="l146.117">  *</span>
<a href="#l146.118"></a><span id="l146.118">  * @param aController    Compose window controller.</span>
<a href="#l146.119"></a><span id="l146.119">  * @param aType          The recipient type, e.g. &quot;addr_to&quot;.</span>
<a href="#l146.120"></a><span id="l146.120" class="difflineat">@@ -341,17 +335,17 @@ function toggle_recipient_type(aControll</span>
<a href="#l146.121"></a><span id="l146.121">  * @param aUrl the URL for this attachment (either a file URL or a web URL)</span>
<a href="#l146.122"></a><span id="l146.122">  * @param aSize (optional) the file size of this attachment, in bytes</span>
<a href="#l146.123"></a><span id="l146.123">  */</span>
<a href="#l146.124"></a><span id="l146.124"> function create_msg_attachment(aUrl, aSize) {</span>
<a href="#l146.125"></a><span id="l146.125">   let attachment = Cc[&quot;@mozilla.org/messengercompose/attachment;1&quot;]</span>
<a href="#l146.126"></a><span id="l146.126">                      .createInstance(Ci.nsIMsgAttachment);</span>
<a href="#l146.127"></a><span id="l146.127"> </span>
<a href="#l146.128"></a><span id="l146.128">   attachment.url = aUrl;</span>
<a href="#l146.129"></a><span id="l146.129" class="difflineminus">-  if(aSize)</span>
<a href="#l146.130"></a><span id="l146.130" class="difflineplus">+  if (aSize)</span>
<a href="#l146.131"></a><span id="l146.131">     attachment.size = aSize;</span>
<a href="#l146.132"></a><span id="l146.132"> </span>
<a href="#l146.133"></a><span id="l146.133">   return attachment;</span>
<a href="#l146.134"></a><span id="l146.134"> }</span>
<a href="#l146.135"></a><span id="l146.135"> </span>
<a href="#l146.136"></a><span id="l146.136"> /**</span>
<a href="#l146.137"></a><span id="l146.137">  * Add an attachment to the compose window.</span>
<a href="#l146.138"></a><span id="l146.138">  *</span>
<a href="#l146.139"></a><span id="l146.139" class="difflineat">@@ -426,17 +420,17 @@ function add_cloud_attachments(aControll</span>
<a href="#l146.140"></a><span id="l146.140"> }</span>
<a href="#l146.141"></a><span id="l146.141"> </span>
<a href="#l146.142"></a><span id="l146.142"> /**</span>
<a href="#l146.143"></a><span id="l146.143">  * Delete an attachment from the compose window</span>
<a href="#l146.144"></a><span id="l146.144">  * @param aComposeWindow the composition window in question</span>
<a href="#l146.145"></a><span id="l146.145">  * @param aIndex the index of the attachment in the attachment pane</span>
<a href="#l146.146"></a><span id="l146.146">  */</span>
<a href="#l146.147"></a><span id="l146.147"> function delete_attachment(aComposeWindow, aIndex) {</span>
<a href="#l146.148"></a><span id="l146.148" class="difflineminus">-  let bucket = aComposeWindow.e('attachmentBucket');</span>
<a href="#l146.149"></a><span id="l146.149" class="difflineplus">+  let bucket = aComposeWindow.e(&quot;attachmentBucket&quot;);</span>
<a href="#l146.150"></a><span id="l146.150">   let node = bucket.querySelectorAll(&quot;richlistitem.attachmentItem&quot;)[aIndex];</span>
<a href="#l146.151"></a><span id="l146.151"> </span>
<a href="#l146.152"></a><span id="l146.152">   aComposeWindow.click(new elib.Elem(node));</span>
<a href="#l146.153"></a><span id="l146.153">   aComposeWindow.window.RemoveSelectedAttachment();</span>
<a href="#l146.154"></a><span id="l146.154"> }</span>
<a href="#l146.155"></a><span id="l146.155"> </span>
<a href="#l146.156"></a><span id="l146.156"> /**</span>
<a href="#l146.157"></a><span id="l146.157">  * Helper function returns the message body element of a composer window.</span>
<a href="#l146.158"></a><span id="l146.158" class="difflineat">@@ -481,18 +475,17 @@ function type_in_composer(aController, a</span>
<a href="#l146.159"></a><span id="l146.159">  */</span>
<a href="#l146.160"></a><span id="l146.160"> function assert_previous_text(aStart, aText) {</span>
<a href="#l146.161"></a><span id="l146.161">   let textNode = aStart;</span>
<a href="#l146.162"></a><span id="l146.162">   for (let i = aText.length - 1; i &gt;= 0; --i) {</span>
<a href="#l146.163"></a><span id="l146.163">     if (textNode.nodeType != kTextNodeType)</span>
<a href="#l146.164"></a><span id="l146.164">       throw new Error(&quot;Expected a text node! Node type was: &quot; + textNode.nodeType);</span>
<a href="#l146.165"></a><span id="l146.165"> </span>
<a href="#l146.166"></a><span id="l146.166">     if (textNode.nodeValue != aText[i])</span>
<a href="#l146.167"></a><span id="l146.167" class="difflineminus">-      throw new Error(&quot;Unexpected inequality - &quot; + textNode.nodeValue + &quot; != &quot; +</span>
<a href="#l146.168"></a><span id="l146.168" class="difflineminus">-                      + aText[i]);</span>
<a href="#l146.169"></a><span id="l146.169" class="difflineplus">+      throw new Error(&quot;Unexpected inequality - &quot; + textNode.nodeValue + &quot; != &quot; + aText[i]);</span>
<a href="#l146.170"></a><span id="l146.170"> </span>
<a href="#l146.171"></a><span id="l146.171">     // We expect a BR preceding each text node automatically, except</span>
<a href="#l146.172"></a><span id="l146.172">     // for the last one that we reach.</span>
<a href="#l146.173"></a><span id="l146.173">     if (i &gt; 0) {</span>
<a href="#l146.174"></a><span id="l146.174">       let br = textNode.previousSibling;</span>
<a href="#l146.175"></a><span id="l146.175"> </span>
<a href="#l146.176"></a><span id="l146.176">       if (br.localName != &quot;br&quot;)</span>
<a href="#l146.177"></a><span id="l146.177">         throw new Error(&quot;Expected a BR node - got a &quot; + br.localName +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l147.1"></a><span id="l147.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-content-tab-helpers.js</span>
<a href="#l147.2"></a><span id="l147.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-content-tab-helpers.js</span>
<a href="#l147.3"></a><span id="l147.3" class="difflineat">@@ -1,21 +1,17 @@</span>
<a href="#l147.4"></a><span id="l147.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l147.5"></a><span id="l147.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l147.6"></a><span id="l147.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l147.7"></a><span id="l147.7"> </span>
<a href="#l147.8"></a><span id="l147.8"> &quot;use strict&quot;;</span>
<a href="#l147.9"></a><span id="l147.9"> </span>
<a href="#l147.10"></a><span id="l147.10"> var MODULE_NAME = &quot;content-tab-helpers&quot;;</span>
<a href="#l147.11"></a><span id="l147.11" class="difflineminus">-</span>
<a href="#l147.12"></a><span id="l147.12"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l147.13"></a><span id="l147.13" class="difflineminus">-// we need this for the main controller</span>
<a href="#l147.14"></a><span id="l147.14" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l147.15"></a><span id="l147.15" class="difflineminus">-                         &quot;window-helpers&quot;,</span>
<a href="#l147.16"></a><span id="l147.16" class="difflineminus">-                         &quot;mock-object-helpers&quot;];</span>
<a href="#l147.17"></a><span id="l147.17" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;mock-object-helpers&quot;];</span>
<a href="#l147.18"></a><span id="l147.18"> </span>
<a href="#l147.19"></a><span id="l147.19"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l147.20"></a><span id="l147.20"> var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l147.21"></a><span id="l147.21"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l147.22"></a><span id="l147.22"> </span>
<a href="#l147.23"></a><span id="l147.23"> var NORMAL_TIMEOUT = 6000;</span>
<a href="#l147.24"></a><span id="l147.24"> var FAST_TIMEOUT = 1000;</span>
<a href="#l147.25"></a><span id="l147.25"> var FAST_INTERVAL = 100;</span>
<a href="#l147.26"></a><span id="l147.26" class="difflineat">@@ -27,22 +23,22 @@ var wh;</span>
<a href="#l147.27"></a><span id="l147.27"> </span>
<a href="#l147.28"></a><span id="l147.28"> var _originalBlocklistURL = null;</span>
<a href="#l147.29"></a><span id="l147.29"> </span>
<a href="#l147.30"></a><span id="l147.30"> // logHelper (and therefore folderDisplayHelper) exports</span>
<a href="#l147.31"></a><span id="l147.31"> var mark_failure;</span>
<a href="#l147.32"></a><span id="l147.32"> var gMockExtProtSvcReg;</span>
<a href="#l147.33"></a><span id="l147.33"> </span>
<a href="#l147.34"></a><span id="l147.34"> function setupModule() {</span>
<a href="#l147.35"></a><span id="l147.35" class="difflineminus">-  folderDisplayHelper = collector.getModule('folder-display-helpers');</span>
<a href="#l147.36"></a><span id="l147.36" class="difflineplus">+  folderDisplayHelper = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l147.37"></a><span id="l147.37">   mc = folderDisplayHelper.mc;</span>
<a href="#l147.38"></a><span id="l147.38">   mark_failure = folderDisplayHelper.mark_failure;</span>
<a href="#l147.39"></a><span id="l147.39"> </span>
<a href="#l147.40"></a><span id="l147.40" class="difflineminus">-  wh = collector.getModule('window-helpers');</span>
<a href="#l147.41"></a><span id="l147.41" class="difflineminus">-  let moh = collector.getModule('mock-object-helpers');</span>
<a href="#l147.42"></a><span id="l147.42" class="difflineplus">+  wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l147.43"></a><span id="l147.43" class="difflineplus">+  let moh = collector.getModule(&quot;mock-object-helpers&quot;);</span>
<a href="#l147.44"></a><span id="l147.44">   gMockExtProtSvcReg = new moh.MockObjectReplacer(EXT_PROTOCOL_SVC_CID,</span>
<a href="#l147.45"></a><span id="l147.45">                                                   MockExtProtConstructor);</span>
<a href="#l147.46"></a><span id="l147.46"> }</span>
<a href="#l147.47"></a><span id="l147.47"> </span>
<a href="#l147.48"></a><span id="l147.48"> function installInto(module) {</span>
<a href="#l147.49"></a><span id="l147.49">   setupModule();</span>
<a href="#l147.50"></a><span id="l147.50"> </span>
<a href="#l147.51"></a><span id="l147.51">   // Now copy helper functions</span>
<a href="#l147.52"></a><span id="l147.52" class="difflineat">@@ -60,96 +56,95 @@ function installInto(module) {</span>
<a href="#l147.53"></a><span id="l147.53">   module.wait_for_content_tab_element_display_value = wait_for_content_tab_element_display_value;</span>
<a href="#l147.54"></a><span id="l147.54">   module.wait_for_content_tab_element_display = wait_for_content_tab_element_display;</span>
<a href="#l147.55"></a><span id="l147.55">   module.get_element_by_text = get_element_by_text;</span>
<a href="#l147.56"></a><span id="l147.56">   module.assert_content_tab_text_present = assert_content_tab_text_present;</span>
<a href="#l147.57"></a><span id="l147.57">   module.assert_content_tab_text_absent = assert_content_tab_text_absent;</span>
<a href="#l147.58"></a><span id="l147.58">   module.NotificationWatcher = NotificationWatcher;</span>
<a href="#l147.59"></a><span id="l147.59">   module.get_notification_bar_for_tab = get_notification_bar_for_tab;</span>
<a href="#l147.60"></a><span id="l147.60">   module.get_test_plugin = get_test_plugin;</span>
<a href="#l147.61"></a><span id="l147.61" class="difflineminus">-  module.plugins_run_in_separate_processes = plugins_run_in_separate_processes;</span>
<a href="#l147.62"></a><span id="l147.62">   module.updateBlocklist = updateBlocklist;</span>
<a href="#l147.63"></a><span id="l147.63">   module.setAndUpdateBlocklist = setAndUpdateBlocklist;</span>
<a href="#l147.64"></a><span id="l147.64">   module.resetBlocklist = resetBlocklist;</span>
<a href="#l147.65"></a><span id="l147.65">   module.gMockExtProtSvcReg = gMockExtProtSvcReg;</span>
<a href="#l147.66"></a><span id="l147.66">   module.gMockExtProtSvc = gMockExtProtSvc;</span>
<a href="#l147.67"></a><span id="l147.67"> }</span>
<a href="#l147.68"></a><span id="l147.68"> </span>
<a href="#l147.69"></a><span id="l147.69"> /**</span>
<a href="#l147.70"></a><span id="l147.70">  * gMockExtProtocolSvc allows us to capture (most if not all) attempts to</span>
<a href="#l147.71"></a><span id="l147.71">  * open links in the default browser.</span>
<a href="#l147.72"></a><span id="l147.72">  */</span>
<a href="#l147.73"></a><span id="l147.73"> var gMockExtProtSvc = {</span>
<a href="#l147.74"></a><span id="l147.74">   _loadedURLs: [],</span>
<a href="#l147.75"></a><span id="l147.75">   QueryInterface: ChromeUtils.generateQI([Ci.nsIExternalProtocolService]),</span>
<a href="#l147.76"></a><span id="l147.76"> </span>
<a href="#l147.77"></a><span id="l147.77" class="difflineminus">-  externalProtocolHandlerExists: function(aProtocolScheme) {</span>
<a href="#l147.78"></a><span id="l147.78" class="difflineplus">+  externalProtocolHandlerExists(aProtocolScheme) {</span>
<a href="#l147.79"></a><span id="l147.79">   },</span>
<a href="#l147.80"></a><span id="l147.80"> </span>
<a href="#l147.81"></a><span id="l147.81" class="difflineminus">-  getApplicationDescription: function(aScheme) {</span>
<a href="#l147.82"></a><span id="l147.82" class="difflineplus">+  getApplicationDescription(aScheme) {</span>
<a href="#l147.83"></a><span id="l147.83">   },</span>
<a href="#l147.84"></a><span id="l147.84"> </span>
<a href="#l147.85"></a><span id="l147.85" class="difflineminus">-  getProtocolHandlerInfo: function(aProtocolScheme) {</span>
<a href="#l147.86"></a><span id="l147.86" class="difflineplus">+  getProtocolHandlerInfo(aProtocolScheme) {</span>
<a href="#l147.87"></a><span id="l147.87">   },</span>
<a href="#l147.88"></a><span id="l147.88"> </span>
<a href="#l147.89"></a><span id="l147.89" class="difflineminus">-  getProtocolHandlerInfoFromOS: function(aProtocolScheme, aFound) {</span>
<a href="#l147.90"></a><span id="l147.90" class="difflineplus">+  getProtocolHandlerInfoFromOS(aProtocolScheme, aFound) {</span>
<a href="#l147.91"></a><span id="l147.91">   },</span>
<a href="#l147.92"></a><span id="l147.92"> </span>
<a href="#l147.93"></a><span id="l147.93" class="difflineminus">-  isExposedProtocol: function(aProtocolScheme) {</span>
<a href="#l147.94"></a><span id="l147.94" class="difflineplus">+  isExposedProtocol(aProtocolScheme) {</span>
<a href="#l147.95"></a><span id="l147.95">   },</span>
<a href="#l147.96"></a><span id="l147.96"> </span>
<a href="#l147.97"></a><span id="l147.97" class="difflineminus">-  loadURI: function(aURI, aWindowContext) {</span>
<a href="#l147.98"></a><span id="l147.98" class="difflineplus">+  loadURI(aURI, aWindowContext) {</span>
<a href="#l147.99"></a><span id="l147.99">     this._loadedURLs.push(aURI.spec);</span>
<a href="#l147.100"></a><span id="l147.100">   },</span>
<a href="#l147.101"></a><span id="l147.101"> </span>
<a href="#l147.102"></a><span id="l147.102" class="difflineminus">-  setProtocolHandlerDefaults: function(aHandlerInfo, aOSHandlerExists) {</span>
<a href="#l147.103"></a><span id="l147.103" class="difflineplus">+  setProtocolHandlerDefaults(aHandlerInfo, aOSHandlerExists) {</span>
<a href="#l147.104"></a><span id="l147.104">   },</span>
<a href="#l147.105"></a><span id="l147.105"> </span>
<a href="#l147.106"></a><span id="l147.106" class="difflineminus">-  urlLoaded: function(aURL) {</span>
<a href="#l147.107"></a><span id="l147.107" class="difflineplus">+  urlLoaded(aURL) {</span>
<a href="#l147.108"></a><span id="l147.108">     return this._loadedURLs.includes(aURL);</span>
<a href="#l147.109"></a><span id="l147.109">   },</span>
<a href="#l147.110"></a><span id="l147.110" class="difflineminus">-}</span>
<a href="#l147.111"></a><span id="l147.111" class="difflineplus">+};</span>
<a href="#l147.112"></a><span id="l147.112"> </span>
<a href="#l147.113"></a><span id="l147.113"> function MockExtProtConstructor() {</span>
<a href="#l147.114"></a><span id="l147.114">   return gMockExtProtSvc;</span>
<a href="#l147.115"></a><span id="l147.115"> }</span>
<a href="#l147.116"></a><span id="l147.116"> </span>
<a href="#l147.117"></a><span id="l147.117"> </span>
<a href="#l147.118"></a><span id="l147.118"> /* Allows for planning / capture of notification events within</span>
<a href="#l147.119"></a><span id="l147.119">  * content tabs, for example: plugin crash notifications, theme</span>
<a href="#l147.120"></a><span id="l147.120">  * install notifications.</span>
<a href="#l147.121"></a><span id="l147.121">  */</span>
<a href="#l147.122"></a><span id="l147.122"> var ALERT_TIMEOUT = 10000;</span>
<a href="#l147.123"></a><span id="l147.123"> </span>
<a href="#l147.124"></a><span id="l147.124"> var NotificationWatcher = {</span>
<a href="#l147.125"></a><span id="l147.125" class="difflineminus">-  planForNotification: function(aController) {</span>
<a href="#l147.126"></a><span id="l147.126" class="difflineplus">+  planForNotification(aController) {</span>
<a href="#l147.127"></a><span id="l147.127">     this.alerted = false;</span>
<a href="#l147.128"></a><span id="l147.128">     aController.window.document.addEventListener(&quot;AlertActive&quot;,</span>
<a href="#l147.129"></a><span id="l147.129">                                                  this.alertActive);</span>
<a href="#l147.130"></a><span id="l147.130">   },</span>
<a href="#l147.131"></a><span id="l147.131" class="difflineminus">-  waitForNotification: function(aController) {</span>
<a href="#l147.132"></a><span id="l147.132" class="difflineplus">+  waitForNotification(aController) {</span>
<a href="#l147.133"></a><span id="l147.133">     if (!this.alerted) {</span>
<a href="#l147.134"></a><span id="l147.134">       aController.waitFor(() =&gt; this.alerted, &quot;Timeout waiting for alert&quot;,</span>
<a href="#l147.135"></a><span id="l147.135">                           ALERT_TIMEOUT, 100);</span>
<a href="#l147.136"></a><span id="l147.136">     }</span>
<a href="#l147.137"></a><span id="l147.137">     // Double check the notification box has finished animating.</span>
<a href="#l147.138"></a><span id="l147.138">     let notificationBox =</span>
<a href="#l147.139"></a><span id="l147.139">       mc.tabmail.selectedTab.panel.querySelector(&quot;notificationbox&quot;);</span>
<a href="#l147.140"></a><span id="l147.140">     if (notificationBox &amp;&amp; notificationBox._animating)</span>
<a href="#l147.141"></a><span id="l147.141">       aController.waitFor(() =&gt; !notificationBox._animating,</span>
<a href="#l147.142"></a><span id="l147.142">                           &quot;Timeout waiting for notification box animation to finish&quot;,</span>
<a href="#l147.143"></a><span id="l147.143">                           ALERT_TIMEOUT, 100);</span>
<a href="#l147.144"></a><span id="l147.144"> </span>
<a href="#l147.145"></a><span id="l147.145">     aController.window.document.removeEventListener(&quot;AlertActive&quot;,</span>
<a href="#l147.146"></a><span id="l147.146">                                                     this.alertActive);</span>
<a href="#l147.147"></a><span id="l147.147">   },</span>
<a href="#l147.148"></a><span id="l147.148">   alerted: false,</span>
<a href="#l147.149"></a><span id="l147.149" class="difflineminus">-  alertActive: function() {</span>
<a href="#l147.150"></a><span id="l147.150" class="difflineplus">+  alertActive() {</span>
<a href="#l147.151"></a><span id="l147.151">     NotificationWatcher.alerted = true;</span>
<a href="#l147.152"></a><span id="l147.152" class="difflineminus">-  }</span>
<a href="#l147.153"></a><span id="l147.153" class="difflineplus">+  },</span>
<a href="#l147.154"></a><span id="l147.154"> };</span>
<a href="#l147.155"></a><span id="l147.155"> </span>
<a href="#l147.156"></a><span id="l147.156"> /**</span>
<a href="#l147.157"></a><span id="l147.157">  * Opens a content tab with the given URL.</span>
<a href="#l147.158"></a><span id="l147.158">  *</span>
<a href="#l147.159"></a><span id="l147.159">  * @param aURL The URL to load (string).</span>
<a href="#l147.160"></a><span id="l147.160">  * @param [aBackground] Whether the tab is opened in the background. Defaults to</span>
<a href="#l147.161"></a><span id="l147.161">  *                      false.</span>
<a href="#l147.162"></a><span id="l147.162" class="difflineat">@@ -161,19 +156,21 @@ function open_content_tab_with_url(aURL,</span>
<a href="#l147.163"></a><span id="l147.163">   if (aClickHandler === undefined)</span>
<a href="#l147.164"></a><span id="l147.164">     aClickHandler = null;</span>
<a href="#l147.165"></a><span id="l147.165">   if (aBackground === undefined)</span>
<a href="#l147.166"></a><span id="l147.166">     aBackground = false;</span>
<a href="#l147.167"></a><span id="l147.167">   if (aController === undefined)</span>
<a href="#l147.168"></a><span id="l147.168">     aController = mc;</span>
<a href="#l147.169"></a><span id="l147.169"> </span>
<a href="#l147.170"></a><span id="l147.170">   let preCount = mc.tabmail.tabContainer.childNodes.length;</span>
<a href="#l147.171"></a><span id="l147.171" class="difflineminus">-  let newTab = mc.tabmail.openTab(&quot;contentTab&quot;, {contentPage: aURL,</span>
<a href="#l147.172"></a><span id="l147.172" class="difflineminus">-                                                 background: aBackground,</span>
<a href="#l147.173"></a><span id="l147.173" class="difflineminus">-                                                 clickHandler: aClickHandler});</span>
<a href="#l147.174"></a><span id="l147.174" class="difflineplus">+  mc.tabmail.openTab(&quot;contentTab&quot;, {</span>
<a href="#l147.175"></a><span id="l147.175" class="difflineplus">+    contentPage: aURL,</span>
<a href="#l147.176"></a><span id="l147.176" class="difflineplus">+    background: aBackground,</span>
<a href="#l147.177"></a><span id="l147.177" class="difflineplus">+    clickHandler: aClickHandler,</span>
<a href="#l147.178"></a><span id="l147.178" class="difflineplus">+  });</span>
<a href="#l147.179"></a><span id="l147.179">   utils.waitFor(() =&gt; (</span>
<a href="#l147.180"></a><span id="l147.180">                   aController.tabmail.tabContainer.childNodes.length == preCount + 1),</span>
<a href="#l147.181"></a><span id="l147.181">                 &quot;Timeout waiting for the content tab to open with URL: &quot; + aURL,</span>
<a href="#l147.182"></a><span id="l147.182">                 FAST_TIMEOUT, FAST_INTERVAL);</span>
<a href="#l147.183"></a><span id="l147.183"> </span>
<a href="#l147.184"></a><span id="l147.184">   // We append new tabs at the end, so check the last one.</span>
<a href="#l147.185"></a><span id="l147.185">   let expectedNewTab = aController.tabmail.tabInfo[preCount];</span>
<a href="#l147.186"></a><span id="l147.186">   folderDisplayHelper.assert_selected_tab(expectedNewTab);</span>
<a href="#l147.187"></a><span id="l147.187" class="difflineat">@@ -431,45 +428,16 @@ function get_test_plugin() {</span>
<a href="#l147.188"></a><span id="l147.188">   // Find the test plugin</span>
<a href="#l147.189"></a><span id="l147.189">   for (var i = 0; i &lt; tags.length; i++) {</span>
<a href="#l147.190"></a><span id="l147.190">     if (tags[i].name == &quot;Test Plug-in&quot;)</span>
<a href="#l147.191"></a><span id="l147.191">       return tags[i];</span>
<a href="#l147.192"></a><span id="l147.192">   }</span>
<a href="#l147.193"></a><span id="l147.193">   return null;</span>
<a href="#l147.194"></a><span id="l147.194"> }</span>
<a href="#l147.195"></a><span id="l147.195"> </span>
<a href="#l147.196"></a><span id="l147.196" class="difflineminus">-/* Returns true if we're currently set up to run plugins in separate</span>
<a href="#l147.197"></a><span id="l147.197" class="difflineminus">- * processes, false otherwise.</span>
<a href="#l147.198"></a><span id="l147.198" class="difflineminus">- */</span>
<a href="#l147.199"></a><span id="l147.199" class="difflineminus">-function plugins_run_in_separate_processes(aController) {</span>
<a href="#l147.200"></a><span id="l147.200" class="difflineminus">-  let supportsOOPP = false;</span>
<a href="#l147.201"></a><span id="l147.201" class="difflineminus">-</span>
<a href="#l147.202"></a><span id="l147.202" class="difflineminus">-  if (aController.mozmillModule.isMac) {</span>
<a href="#l147.203"></a><span id="l147.203" class="difflineminus">-    if (Services.appinfo.XPCOMABI.includes(&quot;x86-&quot;)) {</span>
<a href="#l147.204"></a><span id="l147.204" class="difflineminus">-      try {</span>
<a href="#l147.205"></a><span id="l147.205" class="difflineminus">-        supportsOOPP = Services.prefs.getBoolPref(&quot;dom.ipc.plugins.enabled.i386.test.plugin&quot;);</span>
<a href="#l147.206"></a><span id="l147.206" class="difflineminus">-      } catch(e) {</span>
<a href="#l147.207"></a><span id="l147.207" class="difflineminus">-        supportsOOPP = Services.prefs.getBoolPref(&quot;dom.ipc.plugins.enabled.i386&quot;);</span>
<a href="#l147.208"></a><span id="l147.208" class="difflineminus">-      }</span>
<a href="#l147.209"></a><span id="l147.209" class="difflineminus">-    }</span>
<a href="#l147.210"></a><span id="l147.210" class="difflineminus">-    else if (Services.appinfo.XPCOMABI.includes(&quot;x86_64-&quot;)) {</span>
<a href="#l147.211"></a><span id="l147.211" class="difflineminus">-      try {</span>
<a href="#l147.212"></a><span id="l147.212" class="difflineminus">-        supportsOOPP = Services.prefs.getBoolPref(&quot;dom.ipc.plugins.enabled.x86_64.test.plugin&quot;);</span>
<a href="#l147.213"></a><span id="l147.213" class="difflineminus">-      } catch(e) {</span>
<a href="#l147.214"></a><span id="l147.214" class="difflineminus">-        supportsOOPP = Services.prefs.getBoolPref(&quot;dom.ipc.plugins.enabled.x86_64&quot;);</span>
<a href="#l147.215"></a><span id="l147.215" class="difflineminus">-      }</span>
<a href="#l147.216"></a><span id="l147.216" class="difflineminus">-    }</span>
<a href="#l147.217"></a><span id="l147.217" class="difflineminus">-  }</span>
<a href="#l147.218"></a><span id="l147.218" class="difflineminus">-  else {</span>
<a href="#l147.219"></a><span id="l147.219" class="difflineminus">-    supportsOOPP = Services.prefs.getBoolPref(&quot;dom.ipc.plugins.enabled&quot;);</span>
<a href="#l147.220"></a><span id="l147.220" class="difflineminus">-  }</span>
<a href="#l147.221"></a><span id="l147.221" class="difflineminus">-</span>
<a href="#l147.222"></a><span id="l147.222" class="difflineminus">-  return supportsOOPP;</span>
<a href="#l147.223"></a><span id="l147.223" class="difflineminus">-}</span>
<a href="#l147.224"></a><span id="l147.224" class="difflineminus">-</span>
<a href="#l147.225"></a><span id="l147.225"> function updateBlocklist(aController, aCallback) {</span>
<a href="#l147.226"></a><span id="l147.226">   let observer = function() {</span>
<a href="#l147.227"></a><span id="l147.227">     Services.obs.removeObserver(observer, &quot;blocklist-updated&quot;);</span>
<a href="#l147.228"></a><span id="l147.228">     aController.window.setTimeout(aCallback, 0);</span>
<a href="#l147.229"></a><span id="l147.229">   };</span>
<a href="#l147.230"></a><span id="l147.230">   Services.obs.addObserver(observer, &quot;blocklist-updated&quot;);</span>
<a href="#l147.231"></a><span id="l147.231">   Services.blocklist.QueryInterface(Ci.nsITimerCallback).notify(null);</span>
<a href="#l147.232"></a><span id="l147.232"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l148.1"></a><span id="l148.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-customization-helpers.js</span>
<a href="#l148.2"></a><span id="l148.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-customization-helpers.js</span>
<a href="#l148.3"></a><span id="l148.3" class="difflineat">@@ -1,29 +1,28 @@</span>
<a href="#l148.4"></a><span id="l148.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l148.5"></a><span id="l148.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l148.6"></a><span id="l148.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l148.7"></a><span id="l148.7"> </span>
<a href="#l148.8"></a><span id="l148.8"> &quot;use strict&quot;;</span>
<a href="#l148.9"></a><span id="l148.9"> </span>
<a href="#l148.10"></a><span id="l148.10"> var MODULE_NAME = &quot;customization-helpers&quot;;</span>
<a href="#l148.11"></a><span id="l148.11" class="difflineminus">-</span>
<a href="#l148.12"></a><span id="l148.12"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l148.13"></a><span id="l148.13"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l148.14"></a><span id="l148.14"> </span>
<a href="#l148.15"></a><span id="l148.15"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l148.16"></a><span id="l148.16"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l148.17"></a><span id="l148.17"> </span>
<a href="#l148.18"></a><span id="l148.18"> var USE_SHEET_PREF = &quot;toolbar.customization.usesheet&quot;;</span>
<a href="#l148.19"></a><span id="l148.19"> </span>
<a href="#l148.20"></a><span id="l148.20"> var wh, fdh;</span>
<a href="#l148.21"></a><span id="l148.21"> </span>
<a href="#l148.22"></a><span id="l148.22"> function setupModule() {</span>
<a href="#l148.23"></a><span id="l148.23" class="difflineminus">-  fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l148.24"></a><span id="l148.24" class="difflineminus">-  wh = collector.getModule('window-helpers');</span>
<a href="#l148.25"></a><span id="l148.25" class="difflineplus">+  fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l148.26"></a><span id="l148.26" class="difflineplus">+  wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l148.27"></a><span id="l148.27"> }</span>
<a href="#l148.28"></a><span id="l148.28"> </span>
<a href="#l148.29"></a><span id="l148.29"> function installInto(module) {</span>
<a href="#l148.30"></a><span id="l148.30">   setupModule();</span>
<a href="#l148.31"></a><span id="l148.31"> </span>
<a href="#l148.32"></a><span id="l148.32">   // Now copy helper functions</span>
<a href="#l148.33"></a><span id="l148.33">   module.CustomizeDialogHelper = CustomizeDialogHelper;</span>
<a href="#l148.34"></a><span id="l148.34"> }</span>
<a href="#l148.35"></a><span id="l148.35" class="difflineat">@@ -56,18 +55,17 @@ CustomizeDialogHelper.prototype = {</span>
<a href="#l148.36"></a><span id="l148.36">   open: function CustomizeDialogHelper_open(aController) {</span>
<a href="#l148.37"></a><span id="l148.37">     let ctc;</span>
<a href="#l148.38"></a><span id="l148.38">     aController.click(aController.eid(this._openElementId));</span>
<a href="#l148.39"></a><span id="l148.39">     // Depending on preferences the customization dialog is</span>
<a href="#l148.40"></a><span id="l148.40">     // either a normal window or embedded into a sheet.</span>
<a href="#l148.41"></a><span id="l148.41">     if (!this._openInWindow) {</span>
<a href="#l148.42"></a><span id="l148.42">       ctc = wh.wait_for_frame_load(aController.e(&quot;customizeToolbarSheetIFrame&quot;),</span>
<a href="#l148.43"></a><span id="l148.43">         &quot;chrome://messenger/content/customizeToolbar.xul&quot;);</span>
<a href="#l148.44"></a><span id="l148.44" class="difflineminus">-    }</span>
<a href="#l148.45"></a><span id="l148.45" class="difflineminus">-    else {</span>
<a href="#l148.46"></a><span id="l148.46" class="difflineplus">+    } else {</span>
<a href="#l148.47"></a><span id="l148.47">       ctc = wh.wait_for_existing_window(this._windowType);</span>
<a href="#l148.48"></a><span id="l148.48">     }</span>
<a href="#l148.49"></a><span id="l148.49">     return ctc;</span>
<a href="#l148.50"></a><span id="l148.50">   },</span>
<a href="#l148.51"></a><span id="l148.51"> </span>
<a href="#l148.52"></a><span id="l148.52">   /**</span>
<a href="#l148.53"></a><span id="l148.53">    * Close the customization dialog.</span>
<a href="#l148.54"></a><span id="l148.54">    * @param {} aCtc</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l149.1"></a><span id="l149.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-dom-helpers.js</span>
<a href="#l149.2"></a><span id="l149.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-dom-helpers.js</span>
<a href="#l149.3"></a><span id="l149.3" class="difflineat">@@ -1,34 +1,32 @@</span>
<a href="#l149.4"></a><span id="l149.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l149.5"></a><span id="l149.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l149.6"></a><span id="l149.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l149.7"></a><span id="l149.7"> </span>
<a href="#l149.8"></a><span id="l149.8"> &quot;use strict&quot;;</span>
<a href="#l149.9"></a><span id="l149.9"> </span>
<a href="#l149.10"></a><span id="l149.10"> var MODULE_NAME = &quot;dom-helpers&quot;;</span>
<a href="#l149.11"></a><span id="l149.11" class="difflineminus">-</span>
<a href="#l149.12"></a><span id="l149.12"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l149.13"></a><span id="l149.13" class="difflineminus">-// we need this for the main controller</span>
<a href="#l149.14"></a><span id="l149.14"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l149.15"></a><span id="l149.15"> </span>
<a href="#l149.16"></a><span id="l149.16"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l149.17"></a><span id="l149.17"> </span>
<a href="#l149.18"></a><span id="l149.18"> var NORMAL_TIMEOUT = 6000;</span>
<a href="#l149.19"></a><span id="l149.19"> var FAST_TIMEOUT = 1000;</span>
<a href="#l149.20"></a><span id="l149.20"> var FAST_INTERVAL = 100;</span>
<a href="#l149.21"></a><span id="l149.21"> </span>
<a href="#l149.22"></a><span id="l149.22"> var folderDisplayHelper;</span>
<a href="#l149.23"></a><span id="l149.23"> var mc;</span>
<a href="#l149.24"></a><span id="l149.24"> </span>
<a href="#l149.25"></a><span id="l149.25"> // logHelper (and therefore folderDisplayHelper) exports</span>
<a href="#l149.26"></a><span id="l149.26"> var mark_failure;</span>
<a href="#l149.27"></a><span id="l149.27"> </span>
<a href="#l149.28"></a><span id="l149.28"> function setupModule() {</span>
<a href="#l149.29"></a><span id="l149.29" class="difflineminus">-  folderDisplayHelper = collector.getModule('folder-display-helpers');</span>
<a href="#l149.30"></a><span id="l149.30" class="difflineplus">+  folderDisplayHelper = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l149.31"></a><span id="l149.31">   mc = folderDisplayHelper.mc;</span>
<a href="#l149.32"></a><span id="l149.32">   mark_failure = folderDisplayHelper.mark_failure;</span>
<a href="#l149.33"></a><span id="l149.33"> }</span>
<a href="#l149.34"></a><span id="l149.34"> </span>
<a href="#l149.35"></a><span id="l149.35"> function installInto(module) {</span>
<a href="#l149.36"></a><span id="l149.36">   setupModule();</span>
<a href="#l149.37"></a><span id="l149.37"> </span>
<a href="#l149.38"></a><span id="l149.38">   // Now copy helper functions</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l150.1"></a><span id="l150.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l150.2"></a><span id="l150.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l150.3"></a><span id="l150.3" class="difflineat">@@ -1,18 +1,16 @@</span>
<a href="#l150.4"></a><span id="l150.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l150.5"></a><span id="l150.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l150.6"></a><span id="l150.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l150.7"></a><span id="l150.7"> </span>
<a href="#l150.8"></a><span id="l150.8"> &quot;use strict&quot;;</span>
<a href="#l150.9"></a><span id="l150.9"> </span>
<a href="#l150.10"></a><span id="l150.10"> var MODULE_NAME = &quot;folder-display-helpers&quot;;</span>
<a href="#l150.11"></a><span id="l150.11" class="difflineminus">-</span>
<a href="#l150.12"></a><span id="l150.12"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l150.13"></a><span id="l150.13" class="difflineminus">-// we need window-helpers for augment_controller</span>
<a href="#l150.14"></a><span id="l150.14"> var MODULE_REQUIRES = [&quot;window-helpers&quot;];</span>
<a href="#l150.15"></a><span id="l150.15"> </span>
<a href="#l150.16"></a><span id="l150.16"> var EventUtils = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/EventUtils.jsm&quot;);</span>
<a href="#l150.17"></a><span id="l150.17"> var controller = ChromeUtils.import(&quot;chrome://mozmill/content/modules/controller.jsm&quot;);</span>
<a href="#l150.18"></a><span id="l150.18"> var frame = ChromeUtils.import(&quot;chrome://mozmill/content/modules/frame.jsm&quot;);</span>
<a href="#l150.19"></a><span id="l150.19"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l150.20"></a><span id="l150.20"> var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l150.21"></a><span id="l150.21"> </span>
<a href="#l150.22"></a><span id="l150.22" class="difflineat">@@ -30,17 +28,17 @@ var FILE_LOAD_PATHS = [</span>
<a href="#l150.23"></a><span id="l150.23">   &quot;../../&quot;,</span>
<a href="#l150.24"></a><span id="l150.24">   &quot;../../../../mailnews/test/&quot;,</span>
<a href="#l150.25"></a><span id="l150.25">   &quot;../../../../mail/base/test/unit/&quot;,</span>
<a href="#l150.26"></a><span id="l150.26"> ];</span>
<a href="#l150.27"></a><span id="l150.27"> </span>
<a href="#l150.28"></a><span id="l150.28"> /**</span>
<a href="#l150.29"></a><span id="l150.29">  * Server hostname as set in runtest.py</span>
<a href="#l150.30"></a><span id="l150.30">  */</span>
<a href="#l150.31"></a><span id="l150.31" class="difflineminus">-var FAKE_SERVER_HOSTNAME = 'tinderbox123';</span>
<a href="#l150.32"></a><span id="l150.32" class="difflineplus">+var FAKE_SERVER_HOSTNAME = &quot;tinderbox123&quot;;</span>
<a href="#l150.33"></a><span id="l150.33"> </span>
<a href="#l150.34"></a><span id="l150.34"> /**</span>
<a href="#l150.35"></a><span id="l150.35">  * List of keys not to export via installInto; values do not matter, we just</span>
<a href="#l150.36"></a><span id="l150.36">  *  use true.</span>
<a href="#l150.37"></a><span id="l150.37">  */</span>
<a href="#l150.38"></a><span id="l150.38"> var DO_NOT_EXPORT = {</span>
<a href="#l150.39"></a><span id="l150.39">   // magic globals</span>
<a href="#l150.40"></a><span id="l150.40">   MODULE_NAME: true, DO_NOT_EXPORT: true, installInto: true,</span>
<a href="#l150.41"></a><span id="l150.41" class="difflineat">@@ -94,35 +92,35 @@ var gDefaultWindowHeight = 768;</span>
<a href="#l150.42"></a><span id="l150.42"> </span>
<a href="#l150.43"></a><span id="l150.43"> var initialized = false;</span>
<a href="#l150.44"></a><span id="l150.44"> function setupModule() {</span>
<a href="#l150.45"></a><span id="l150.45">   if (initialized)</span>
<a href="#l150.46"></a><span id="l150.46">     return;</span>
<a href="#l150.47"></a><span id="l150.47">   initialized = true;</span>
<a href="#l150.48"></a><span id="l150.48"> </span>
<a href="#l150.49"></a><span id="l150.49">   testHelperModule = {</span>
<a href="#l150.50"></a><span id="l150.50" class="difflineminus">-    Cc: Cc,</span>
<a href="#l150.51"></a><span id="l150.51" class="difflineminus">-    Ci: Ci,</span>
<a href="#l150.52"></a><span id="l150.52" class="difflineminus">-    Cu: Cu,</span>
<a href="#l150.53"></a><span id="l150.53" class="difflineplus">+    Cc,</span>
<a href="#l150.54"></a><span id="l150.54" class="difflineplus">+    Ci,</span>
<a href="#l150.55"></a><span id="l150.55" class="difflineplus">+    Cu,</span>
<a href="#l150.56"></a><span id="l150.56">     // fake some xpcshell stuff</span>
<a href="#l150.57"></a><span id="l150.57">     _TEST_FILE: [&quot;mozmill&quot;],</span>
<a href="#l150.58"></a><span id="l150.58">     _do_not_wrap_xpcshell: true,</span>
<a href="#l150.59"></a><span id="l150.59" class="difflineminus">-    do_throw: function(aMsg) {</span>
<a href="#l150.60"></a><span id="l150.60" class="difflineplus">+    do_throw(aMsg) {</span>
<a href="#l150.61"></a><span id="l150.61">       throw new Error(aMsg);</span>
<a href="#l150.62"></a><span id="l150.62">     },</span>
<a href="#l150.63"></a><span id="l150.63" class="difflineminus">-    do_check_eq: function() {},</span>
<a href="#l150.64"></a><span id="l150.64" class="difflineminus">-    do_check_neq: function() {},</span>
<a href="#l150.65"></a><span id="l150.65" class="difflineplus">+    do_check_eq() {},</span>
<a href="#l150.66"></a><span id="l150.66" class="difflineplus">+    do_check_neq() {},</span>
<a href="#l150.67"></a><span id="l150.67">     gDEPTH: &quot;../../&quot;,</span>
<a href="#l150.68"></a><span id="l150.68">   };</span>
<a href="#l150.69"></a><span id="l150.69"> </span>
<a href="#l150.70"></a><span id="l150.70">   // -- logging</span>
<a href="#l150.71"></a><span id="l150.71"> </span>
<a href="#l150.72"></a><span id="l150.72">   // The xpcshell test resources assume they are loaded into a single global</span>
<a href="#l150.73"></a><span id="l150.73">   //  namespace, so we need to help them out to maintain their delusion.</span>
<a href="#l150.74"></a><span id="l150.74" class="difflineminus">-  load_via_src_path('resources/logHelper.js', testHelperModule);</span>
<a href="#l150.75"></a><span id="l150.75" class="difflineplus">+  load_via_src_path(&quot;resources/logHelper.js&quot;, testHelperModule);</span>
<a href="#l150.76"></a><span id="l150.76">   mark_action = testHelperModule.mark_action;</span>
<a href="#l150.77"></a><span id="l150.77">   mark_failure = testHelperModule.mark_failure;</span>
<a href="#l150.78"></a><span id="l150.78"> </span>
<a href="#l150.79"></a><span id="l150.79">   // Remove the dump appender that got appended; it just adds noise.</span>
<a href="#l150.80"></a><span id="l150.80">   testHelperModule._mailnewsTestLogger.removeAppender(</span>
<a href="#l150.81"></a><span id="l150.81">     testHelperModule._mailnewsTestLogger.ownAppenders[</span>
<a href="#l150.82"></a><span id="l150.82">       testHelperModule._mailnewsTestLogger.ownAppenders.length - 1]);</span>
<a href="#l150.83"></a><span id="l150.83"> </span>
<a href="#l150.84"></a><span id="l150.84" class="difflineat">@@ -145,18 +143,17 @@ function setupModule() {</span>
<a href="#l150.85"></a><span id="l150.85">       if (obj.name == &quot;setupModule&quot; ||</span>
<a href="#l150.86"></a><span id="l150.86">           obj.name == &quot;teardownModule&quot;)</span>
<a href="#l150.87"></a><span id="l150.87">         return;</span>
<a href="#l150.88"></a><span id="l150.88">       if (obj.filename != curTestFile) {</span>
<a href="#l150.89"></a><span id="l150.89">         testHelperModule.mark_test_end();</span>
<a href="#l150.90"></a><span id="l150.90">         bucketAppender.newBucket();</span>
<a href="#l150.91"></a><span id="l150.91">         testHelperModule.mark_test_start(obj.filename);</span>
<a href="#l150.92"></a><span id="l150.92">         curTestFile = obj.filename;</span>
<a href="#l150.93"></a><span id="l150.93" class="difflineminus">-      }</span>
<a href="#l150.94"></a><span id="l150.94" class="difflineminus">-      else {</span>
<a href="#l150.95"></a><span id="l150.95" class="difflineplus">+      } else {</span>
<a href="#l150.96"></a><span id="l150.96">         testHelperModule.mark_test_end(1);</span>
<a href="#l150.97"></a><span id="l150.97">         bucketAppender.newBucket();</span>
<a href="#l150.98"></a><span id="l150.98">       }</span>
<a href="#l150.99"></a><span id="l150.99">       testHelperModule.mark_sub_test_start(obj.name);</span>
<a href="#l150.100"></a><span id="l150.100">     });</span>
<a href="#l150.101"></a><span id="l150.101">   // Listen for the fail event so that we can annotate the failure object</span>
<a href="#l150.102"></a><span id="l150.102">   //  with additional metadata.  This works out because we are directly handed</span>
<a href="#l150.103"></a><span id="l150.103">   //  a reference to the object that will be provided to the jsbridge and we</span>
<a href="#l150.104"></a><span id="l150.104" class="difflineat">@@ -187,33 +184,32 @@ function setupModule() {</span>
<a href="#l150.105"></a><span id="l150.105"> </span>
<a href="#l150.106"></a><span id="l150.106">       try {</span>
<a href="#l150.107"></a><span id="l150.107">         obj.failureContext = {</span>
<a href="#l150.108"></a><span id="l150.108">           preEvents: bucketAppender.getPreviousBucketEvents(10000),</span>
<a href="#l150.109"></a><span id="l150.109">           events: bucketAppender.getBucketEvents(),</span>
<a href="#l150.110"></a><span id="l150.110">           windows: windowHelper.captureWindowStatesForErrorReporting(</span>
<a href="#l150.111"></a><span id="l150.111">                      testHelperModule._normalize_for_json),</span>
<a href="#l150.112"></a><span id="l150.112">         };</span>
<a href="#l150.113"></a><span id="l150.113" class="difflineminus">-      }</span>
<a href="#l150.114"></a><span id="l150.114" class="difflineminus">-      catch(ex) {</span>
<a href="#l150.115"></a><span id="l150.115" class="difflineplus">+      } catch (ex) {</span>
<a href="#l150.116"></a><span id="l150.116">         dump(&quot;!!!!!!!!EX: &quot; + ex);</span>
<a href="#l150.117"></a><span id="l150.117">         mark_action(&quot;fdh&quot;, &quot;fail fail marking!&quot;, [ex]);</span>
<a href="#l150.118"></a><span id="l150.118">       }</span>
<a href="#l150.119"></a><span id="l150.119">     });</span>
<a href="#l150.120"></a><span id="l150.120"> </span>
<a href="#l150.121"></a><span id="l150.121">   // -- the rest of the asyncTestUtils framework (but not actually async)</span>
<a href="#l150.122"></a><span id="l150.122"> </span>
<a href="#l150.123"></a><span id="l150.123" class="difflineminus">-  load_via_src_path('resources/asyncTestUtils.js', testHelperModule);</span>
<a href="#l150.124"></a><span id="l150.124" class="difflineminus">-  load_via_src_path('resources/messageGenerator.js', testHelperModule);</span>
<a href="#l150.125"></a><span id="l150.125" class="difflineminus">-  load_via_src_path('resources/messageModifier.js', testHelperModule);</span>
<a href="#l150.126"></a><span id="l150.126" class="difflineminus">-  load_via_src_path('resources/messageInjection.js', testHelperModule);</span>
<a href="#l150.127"></a><span id="l150.127" class="difflineminus">-  load_via_src_path('resources/viewWrapperTestUtils.js', testHelperModule);</span>
<a href="#l150.128"></a><span id="l150.128" class="difflineplus">+  load_via_src_path(&quot;resources/asyncTestUtils.js&quot;, testHelperModule);</span>
<a href="#l150.129"></a><span id="l150.129" class="difflineplus">+  load_via_src_path(&quot;resources/messageGenerator.js&quot;, testHelperModule);</span>
<a href="#l150.130"></a><span id="l150.130" class="difflineplus">+  load_via_src_path(&quot;resources/messageModifier.js&quot;, testHelperModule);</span>
<a href="#l150.131"></a><span id="l150.131" class="difflineplus">+  load_via_src_path(&quot;resources/messageInjection.js&quot;, testHelperModule);</span>
<a href="#l150.132"></a><span id="l150.132" class="difflineplus">+  load_via_src_path(&quot;resources/viewWrapperTestUtils.js&quot;, testHelperModule);</span>
<a href="#l150.133"></a><span id="l150.133"> </span>
<a href="#l150.134"></a><span id="l150.134">   // provide super helpful folder event info (when logHelper cares)</span>
<a href="#l150.135"></a><span id="l150.135" class="difflineminus">-  load_via_src_path('resources/folderEventLogHelper.js', testHelperModule);</span>
<a href="#l150.136"></a><span id="l150.136" class="difflineplus">+  load_via_src_path(&quot;resources/folderEventLogHelper.js&quot;, testHelperModule);</span>
<a href="#l150.137"></a><span id="l150.137">   testHelperModule.registerFolderEventLogHelper();</span>
<a href="#l150.138"></a><span id="l150.138"> </span>
<a href="#l150.139"></a><span id="l150.139">   // messageInjection wants a gMessageGenerator (and so do we)</span>
<a href="#l150.140"></a><span id="l150.140">   msgGen = new testHelperModule.MessageGenerator();</span>
<a href="#l150.141"></a><span id="l150.141">   testHelperModule.gMessageGenerator = msgGen;</span>
<a href="#l150.142"></a><span id="l150.142">   testHelperModule.gMessageScenarioFactory =</span>
<a href="#l150.143"></a><span id="l150.143">     new testHelperModule.MessageScenarioFactory(msgGen);</span>
<a href="#l150.144"></a><span id="l150.144"> </span>
<a href="#l150.145"></a><span id="l150.145" class="difflineat">@@ -225,17 +221,17 @@ function setupModule() {</span>
<a href="#l150.146"></a><span id="l150.146">   SyntheticPartLeaf = testHelperModule.SyntheticPartLeaf;</span>
<a href="#l150.147"></a><span id="l150.147">   SyntheticPartMultiMixed = testHelperModule.SyntheticPartMultiMixed;</span>
<a href="#l150.148"></a><span id="l150.148">   SyntheticPartMultiRelated = testHelperModule.SyntheticPartMultiRelated;</span>
<a href="#l150.149"></a><span id="l150.149"> </span>
<a href="#l150.150"></a><span id="l150.150">   delete_message_set = testHelperModule.async_delete_messages;</span>
<a href="#l150.151"></a><span id="l150.151"> </span>
<a href="#l150.152"></a><span id="l150.152">   // use window-helper's augment_controller method to get our extra good stuff</span>
<a href="#l150.153"></a><span id="l150.153">   //  we need.</span>
<a href="#l150.154"></a><span id="l150.154" class="difflineminus">-  windowHelper = collector.getModule('window-helpers');</span>
<a href="#l150.155"></a><span id="l150.155" class="difflineplus">+  windowHelper = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l150.156"></a><span id="l150.156">   mc = windowHelper.wait_for_existing_window(&quot;mail:3pane&quot;);</span>
<a href="#l150.157"></a><span id="l150.157">   windowHelper.augment_controller(mc);</span>
<a href="#l150.158"></a><span id="l150.158"> </span>
<a href="#l150.159"></a><span id="l150.159">   // Tell window-helper about the true mark_action function in order to try</span>
<a href="#l150.160"></a><span id="l150.160">   // and further complicate this horrid seven-dimensional rats' nest.</span>
<a href="#l150.161"></a><span id="l150.161">   windowHelper.hereIsMarkAction(mark_action, mark_failure,</span>
<a href="#l150.162"></a><span id="l150.162">                                 testHelperModule._normalize_for_json);</span>
<a href="#l150.163"></a><span id="l150.163"> </span>
<a href="#l150.164"></a><span id="l150.164" class="difflineat">@@ -243,18 +239,17 @@ function setupModule() {</span>
<a href="#l150.165"></a><span id="l150.165">               [(mc.window.msgWindow != null) ? &quot;3pane looks initialized&quot;</span>
<a href="#l150.166"></a><span id="l150.166">                : &quot;3pane does not appear to have fully loaded yet!&quot;]);</span>
<a href="#l150.167"></a><span id="l150.167"> </span>
<a href="#l150.168"></a><span id="l150.168">   setupAccountStuff();</span>
<a href="#l150.169"></a><span id="l150.169">   // This will throw if we've not got the main window set up yet e.g. the</span>
<a href="#l150.170"></a><span id="l150.170">   // account wizard is open on an initial startup type test.</span>
<a href="#l150.171"></a><span id="l150.171">   try {</span>
<a href="#l150.172"></a><span id="l150.172">     mc.folderTreeView.toggleOpenState(1);</span>
<a href="#l150.173"></a><span id="l150.173" class="difflineminus">-  }</span>
<a href="#l150.174"></a><span id="l150.174" class="difflineminus">-  catch (ex) {</span>
<a href="#l150.175"></a><span id="l150.175" class="difflineplus">+  } catch (ex) {</span>
<a href="#l150.176"></a><span id="l150.176">   }</span>
<a href="#l150.177"></a><span id="l150.177"> }</span>
<a href="#l150.178"></a><span id="l150.178"> </span>
<a href="#l150.179"></a><span id="l150.179"> /**</span>
<a href="#l150.180"></a><span id="l150.180">  * Install this module into the provided module.</span>
<a href="#l150.181"></a><span id="l150.181">  */</span>
<a href="#l150.182"></a><span id="l150.182"> function installInto(module) {</span>
<a href="#l150.183"></a><span id="l150.183">   setupModule();</span>
<a href="#l150.184"></a><span id="l150.184" class="difflineat">@@ -265,30 +260,29 @@ function installInto(module) {</span>
<a href="#l150.185"></a><span id="l150.185">   // resizeTo operates on outerWidth/outerHeight, their limit is actually</span>
<a href="#l150.186"></a><span id="l150.186">   // screen size + window border size.)</span>
<a href="#l150.187"></a><span id="l150.187">   if (mc.window.outerWidth != gDefaultWindowWidth ||</span>
<a href="#l150.188"></a><span id="l150.188">       mc.window.outerHeight != gDefaultWindowHeight) {</span>
<a href="#l150.189"></a><span id="l150.189">     restore_default_window_size();</span>
<a href="#l150.190"></a><span id="l150.190">   }</span>
<a href="#l150.191"></a><span id="l150.191"> </span>
<a href="#l150.192"></a><span id="l150.192">   // now copy everything into the module they provided to us...</span>
<a href="#l150.193"></a><span id="l150.193" class="difflineminus">-  let us = collector.getModule('folder-display-helpers');</span>
<a href="#l150.194"></a><span id="l150.194" class="difflineplus">+  let us = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l150.195"></a><span id="l150.195">   let self = this;</span>
<a href="#l150.196"></a><span id="l150.196">   for (let key in us) {</span>
<a href="#l150.197"></a><span id="l150.197">     let value = us[key];</span>
<a href="#l150.198"></a><span id="l150.198">     if (key in EXPORT_VIA_GETTER_SETTER) {</span>
<a href="#l150.199"></a><span id="l150.199">       // The value of |key| changes between iterations, so it's important to</span>
<a href="#l150.200"></a><span id="l150.200">       // capture the right key in a local variable.</span>
<a href="#l150.201"></a><span id="l150.201">       let thisKey = key;</span>
<a href="#l150.202"></a><span id="l150.202">       module.__defineGetter__(thisKey, () =&gt; self[thisKey]);</span>
<a href="#l150.203"></a><span id="l150.203" class="difflineminus">-      module.__defineSetter__(thisKey, function (aNewValue) {</span>
<a href="#l150.204"></a><span id="l150.204" class="difflineplus">+      module.__defineSetter__(thisKey, function(aNewValue) {</span>
<a href="#l150.205"></a><span id="l150.205">                                self[thisKey] = aNewValue;</span>
<a href="#l150.206"></a><span id="l150.206">                              });</span>
<a href="#l150.207"></a><span id="l150.207" class="difflineminus">-    }</span>
<a href="#l150.208"></a><span id="l150.208" class="difflineminus">-    else if (!(key in DO_NOT_EXPORT) &amp;&amp;</span>
<a href="#l150.209"></a><span id="l150.209" class="difflineplus">+    } else if (!(key in DO_NOT_EXPORT) &amp;&amp;</span>
<a href="#l150.210"></a><span id="l150.210">              key[0] != &quot;_&quot;) {</span>
<a href="#l150.211"></a><span id="l150.211">       module[key] = value;</span>
<a href="#l150.212"></a><span id="l150.212">     }</span>
<a href="#l150.213"></a><span id="l150.213">   }</span>
<a href="#l150.214"></a><span id="l150.214"> </span>
<a href="#l150.215"></a><span id="l150.215">   // Export the teardown helper</span>
<a href="#l150.216"></a><span id="l150.216">   let customTeardown = null;</span>
<a href="#l150.217"></a><span id="l150.217">   // Mozmill uses __teardownModule__ to store what it thinks is the</span>
<a href="#l150.218"></a><span id="l150.218" class="difflineat">@@ -325,22 +319,20 @@ function teardownImporter(customTeardown</span>
<a href="#l150.219"></a><span id="l150.219">     // - If there are no 3-pane windows open, open one.</span>
<a href="#l150.220"></a><span id="l150.220">     let mail3PaneWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l150.221"></a><span id="l150.221">     if (!mail3PaneWindow) {</span>
<a href="#l150.222"></a><span id="l150.222">       windowHelper.plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l150.223"></a><span id="l150.223">       Services.ww.openWindow(null,</span>
<a href="#l150.224"></a><span id="l150.224">           &quot;chrome://messenger/content/&quot;, &quot;&quot;,</span>
<a href="#l150.225"></a><span id="l150.225">           &quot;all,chrome,dialog=no,status,toolbar&quot;, null);</span>
<a href="#l150.226"></a><span id="l150.226">       mc = windowHelper.wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l150.227"></a><span id="l150.227" class="difflineminus">-    }</span>
<a href="#l150.228"></a><span id="l150.228" class="difflineminus">-    else {</span>
<a href="#l150.229"></a><span id="l150.229" class="difflineplus">+    } else if (!mc || mc.window.closed) {</span>
<a href="#l150.230"></a><span id="l150.230">       // - We might have a window open, but not be assigned to mc -- so if</span>
<a href="#l150.231"></a><span id="l150.231">       //   mc.window.closed is true, look for a window to assign to mc.</span>
<a href="#l150.232"></a><span id="l150.232" class="difflineminus">-      if (!mc || mc.window.closed)</span>
<a href="#l150.233"></a><span id="l150.233" class="difflineminus">-        mc = windowHelper.wait_for_existing_window(&quot;mail:3pane&quot;);</span>
<a href="#l150.234"></a><span id="l150.234" class="difflineplus">+      mc = windowHelper.wait_for_existing_window(&quot;mail:3pane&quot;);</span>
<a href="#l150.235"></a><span id="l150.235">     }</span>
<a href="#l150.236"></a><span id="l150.236"> </span>
<a href="#l150.237"></a><span id="l150.237">     // Run through all open windows, closing any that aren't assigned to mc.</span>
<a href="#l150.238"></a><span id="l150.238">     let enumerator = Services.wm.getEnumerator(null);</span>
<a href="#l150.239"></a><span id="l150.239">     while (enumerator.hasMoreElements()) {</span>
<a href="#l150.240"></a><span id="l150.240">       let win = enumerator.getNext();</span>
<a href="#l150.241"></a><span id="l150.241">       if (win != mc.window) {</span>
<a href="#l150.242"></a><span id="l150.242">         mark_action(&quot;fdh&quot;, &quot;teardown&quot;,</span>
<a href="#l150.243"></a><span id="l150.243" class="difflineat">@@ -959,17 +951,17 @@ function click_tree_row(aTree, aRowIndex</span>
<a href="#l150.244"></a><span id="l150.244">   aTree.ensureRowIsVisible(aRowIndex);</span>
<a href="#l150.245"></a><span id="l150.245"> </span>
<a href="#l150.246"></a><span id="l150.246">   // get cell coordinates</span>
<a href="#l150.247"></a><span id="l150.247">   let column = aTree.columns[0];</span>
<a href="#l150.248"></a><span id="l150.248">   let coords = aTree.getCoordsForCellItem(aRowIndex, column, &quot;text&quot;);</span>
<a href="#l150.249"></a><span id="l150.249"> </span>
<a href="#l150.250"></a><span id="l150.250">   aController.sleep(0);</span>
<a href="#l150.251"></a><span id="l150.251">   EventUtils.synthesizeMouse(aTree.body, coords.x + 4, coords.y + 4,</span>
<a href="#l150.252"></a><span id="l150.252" class="difflineminus">-                             {}, aTree.ownerDocument.defaultView);</span>
<a href="#l150.253"></a><span id="l150.253" class="difflineplus">+                             {}, aTree.ownerGlobal);</span>
<a href="#l150.254"></a><span id="l150.254">   aController.sleep(0);</span>
<a href="#l150.255"></a><span id="l150.255"> }</span>
<a href="#l150.256"></a><span id="l150.256"> </span>
<a href="#l150.257"></a><span id="l150.257"> /**</span>
<a href="#l150.258"></a><span id="l150.258">  * Pretend we are clicking on a row with our mouse.</span>
<a href="#l150.259"></a><span id="l150.259">  *</span>
<a href="#l150.260"></a><span id="l150.260">  * @param aViewIndex If &gt;= 0, the view index provided, if &lt; 0, a reference to</span>
<a href="#l150.261"></a><span id="l150.261">  *     a view index counting from the last row in the tree.  -1 indicates the</span>
<a href="#l150.262"></a><span id="l150.262" class="difflineat">@@ -1216,17 +1208,16 @@ function assert_folder_mode(aMode, aCont</span>
<a href="#l150.263"></a><span id="l150.263">  */</span>
<a href="#l150.264"></a><span id="l150.264"> function assert_folder_child_in_view(aChild, aParent) {</span>
<a href="#l150.265"></a><span id="l150.265">   let actualParent = mc.folderTreeView.getParentOfFolder(aChild);</span>
<a href="#l150.266"></a><span id="l150.266">   if (actualParent != aParent)</span>
<a href="#l150.267"></a><span id="l150.267">     throw new Error(&quot;Folder &quot; + aChild.URI + &quot; should be the child of &quot; +</span>
<a href="#l150.268"></a><span id="l150.268">                     (aParent &amp;&amp; aParent.URI) +</span>
<a href="#l150.269"></a><span id="l150.269">                     &quot;, but is actually the child of &quot; +</span>
<a href="#l150.270"></a><span id="l150.270">                     (actualParent &amp;&amp; actualParent.URI));</span>
<a href="#l150.271"></a><span id="l150.271" class="difflineminus">-</span>
<a href="#l150.272"></a><span id="l150.272"> }</span>
<a href="#l150.273"></a><span id="l150.273"> </span>
<a href="#l150.274"></a><span id="l150.274"> /**</span>
<a href="#l150.275"></a><span id="l150.275">  * Assert that the given folder is in the current folder mode and is visible.</span>
<a href="#l150.276"></a><span id="l150.276">  *</span>
<a href="#l150.277"></a><span id="l150.277">  * @param aFolder The folder to assert as visible</span>
<a href="#l150.278"></a><span id="l150.278">  * @param [aController] The controller in whose context to do this, defaults to</span>
<a href="#l150.279"></a><span id="l150.279">  *     |mc| if omitted.</span>
<a href="#l150.280"></a><span id="l150.280" class="difflineat">@@ -1632,17 +1623,16 @@ function plan_for_message_display(aContr</span>
<a href="#l150.281"></a><span id="l150.281">  *     return immediately.</span>
<a href="#l150.282"></a><span id="l150.282">  */</span>
<a href="#l150.283"></a><span id="l150.283"> function wait_for_message_display_completion(aController, aLoadDemanded) {</span>
<a href="#l150.284"></a><span id="l150.284">   if (aController == null)</span>
<a href="#l150.285"></a><span id="l150.285">     aController = mc;</span>
<a href="#l150.286"></a><span id="l150.286">   mark_action(&quot;fdhb&quot;, &quot;wait_for_message_display_completion&quot;,</span>
<a href="#l150.287"></a><span id="l150.287">               [&quot;load demanded?&quot;, Boolean(aLoadDemanded)]);</span>
<a href="#l150.288"></a><span id="l150.288">   let contentPane = aController.contentPane;</span>
<a href="#l150.289"></a><span id="l150.289" class="difflineminus">-  let oldHref = null;</span>
<a href="#l150.290"></a><span id="l150.290"> </span>
<a href="#l150.291"></a><span id="l150.291">   // count checks so we can know whether we waited; &gt;1 implies waited</span>
<a href="#l150.292"></a><span id="l150.292">   let checkCount = 0;</span>
<a href="#l150.293"></a><span id="l150.293"> </span>
<a href="#l150.294"></a><span id="l150.294">   // There are a couple possible states the universe can be in:</span>
<a href="#l150.295"></a><span id="l150.295">   // 1) No message load happened or is going to happen.</span>
<a href="#l150.296"></a><span id="l150.296">   // 2) The only message load that is going to happened has happened.</span>
<a href="#l150.297"></a><span id="l150.297">   // 3) A message load is happening right now.</span>
<a href="#l150.298"></a><span id="l150.298" class="difflineat">@@ -1715,17 +1705,17 @@ function wait_for_blank_content_pane(aCo</span>
<a href="#l150.299"></a><span id="l150.299">   //  chance.  give it a chance now.</span>
<a href="#l150.300"></a><span id="l150.300">   aController.sleep(0);</span>
<a href="#l150.301"></a><span id="l150.301">   mark_action(&quot;fdh&quot;, &quot;/wait_for_blank_content_pane&quot;, []);</span>
<a href="#l150.302"></a><span id="l150.302"> }</span>
<a href="#l150.303"></a><span id="l150.303"> </span>
<a href="#l150.304"></a><span id="l150.304"> </span>
<a href="#l150.305"></a><span id="l150.305"> var FolderListener = {</span>
<a href="#l150.306"></a><span id="l150.306">   _inited: false,</span>
<a href="#l150.307"></a><span id="l150.307" class="difflineminus">-  ensureInited: function() {</span>
<a href="#l150.308"></a><span id="l150.308" class="difflineplus">+  ensureInited() {</span>
<a href="#l150.309"></a><span id="l150.309">     if (this._inited)</span>
<a href="#l150.310"></a><span id="l150.310">       return;</span>
<a href="#l150.311"></a><span id="l150.311"> </span>
<a href="#l150.312"></a><span id="l150.312">     MailServices.mailSession.AddFolderListener(this,</span>
<a href="#l150.313"></a><span id="l150.313">                                                Ci.nsIFolderListener.event);</span>
<a href="#l150.314"></a><span id="l150.314"> </span>
<a href="#l150.315"></a><span id="l150.315">     this._inited = true;</span>
<a href="#l150.316"></a><span id="l150.316">   },</span>
<a href="#l150.317"></a><span id="l150.317" class="difflineat">@@ -1830,20 +1820,18 @@ function assert_message_pane_visible(aTh</span>
<a href="#l150.318"></a><span id="l150.318">   if (mc.e(&quot;messagepaneboxwrapper&quot;).getAttribute(&quot;collapsed&quot;))</span>
<a href="#l150.319"></a><span id="l150.319">     throw new Error(&quot;messagepaneboxwrapper should not be collapsed!&quot;);</span>
<a href="#l150.320"></a><span id="l150.320"> </span>
<a href="#l150.321"></a><span id="l150.321">   // if the thread pane is illegal, then the splitter should not be visible</span>
<a href="#l150.322"></a><span id="l150.322">   if (aThreadPaneIllegal) {</span>
<a href="#l150.323"></a><span id="l150.323">     if (mc.e(&quot;threadpane-splitter&quot;).getAttribute(&quot;collapsed&quot;) != &quot;true&quot;)</span>
<a href="#l150.324"></a><span id="l150.324">       throw new Error(&quot;threadpane-splitter should be collapsed because the &quot; +</span>
<a href="#l150.325"></a><span id="l150.325">                       &quot;thread pane is illegal&quot;);</span>
<a href="#l150.326"></a><span id="l150.326" class="difflineminus">-  }</span>
<a href="#l150.327"></a><span id="l150.327" class="difflineminus">-  else {</span>
<a href="#l150.328"></a><span id="l150.328" class="difflineminus">-    if (mc.e(&quot;threadpane-splitter&quot;).getAttribute(&quot;collapsed&quot;) == &quot;true&quot;)</span>
<a href="#l150.329"></a><span id="l150.329" class="difflineminus">-      throw new Error(&quot;threadpane-splitter should not be collapsed&quot;);</span>
<a href="#l150.330"></a><span id="l150.330" class="difflineplus">+  } else if (mc.e(&quot;threadpane-splitter&quot;).getAttribute(&quot;collapsed&quot;) == &quot;true&quot;) {</span>
<a href="#l150.331"></a><span id="l150.331" class="difflineplus">+    throw new Error(&quot;threadpane-splitter should not be collapsed&quot;);</span>
<a href="#l150.332"></a><span id="l150.332">   }</span>
<a href="#l150.333"></a><span id="l150.333"> </span>
<a href="#l150.334"></a><span id="l150.334">   // - the menu item should be checked</span>
<a href="#l150.335"></a><span id="l150.335">   // force the view menu to update.</span>
<a href="#l150.336"></a><span id="l150.336">   mc.window.view_init();</span>
<a href="#l150.337"></a><span id="l150.337">   let paneMenuItem = mc.e(&quot;menu_showMessage&quot;);</span>
<a href="#l150.338"></a><span id="l150.338">   if (paneMenuItem.getAttribute(&quot;checked&quot;) != &quot;true&quot;)</span>
<a href="#l150.339"></a><span id="l150.339">     throw new Error(&quot;The Message Pane menu item should be checked.&quot;);</span>
<a href="#l150.340"></a><span id="l150.340" class="difflineat">@@ -1870,18 +1858,17 @@ function assert_message_pane_hidden(aMes</span>
<a href="#l150.341"></a><span id="l150.341">   mc.window.view_init();</span>
<a href="#l150.342"></a><span id="l150.342">   let paneMenuItem = mc.e(&quot;menu_showMessage&quot;);</span>
<a href="#l150.343"></a><span id="l150.343">   if (aMessagePaneIllegal) {</span>
<a href="#l150.344"></a><span id="l150.344">     if (mc.e(&quot;threadpane-splitter&quot;).getAttribute(&quot;collapsed&quot;) != &quot;true&quot;)</span>
<a href="#l150.345"></a><span id="l150.345">       throw new Error(&quot;threadpane-splitter should be collapsed because the &quot; +</span>
<a href="#l150.346"></a><span id="l150.346">                       &quot;message pane is illegal.&quot;);</span>
<a href="#l150.347"></a><span id="l150.347">     if (paneMenuItem.getAttribute(&quot;disabled&quot;) != &quot;true&quot;)</span>
<a href="#l150.348"></a><span id="l150.348">       throw new Error(&quot;The Message Pane menu item should be disabled.&quot;);</span>
<a href="#l150.349"></a><span id="l150.349" class="difflineminus">-  }</span>
<a href="#l150.350"></a><span id="l150.350" class="difflineminus">-  else {</span>
<a href="#l150.351"></a><span id="l150.351" class="difflineplus">+  } else {</span>
<a href="#l150.352"></a><span id="l150.352">     if (mc.e(&quot;threadpane-splitter&quot;).getAttribute(&quot;collapsed&quot;))</span>
<a href="#l150.353"></a><span id="l150.353">       throw new Error(&quot;threadpane-splitter should not be collapsed; the &quot; +</span>
<a href="#l150.354"></a><span id="l150.354">                       &quot;message pane is legal.&quot;);</span>
<a href="#l150.355"></a><span id="l150.355">     if (paneMenuItem.getAttribute(&quot;checked&quot;) == &quot;true&quot;)</span>
<a href="#l150.356"></a><span id="l150.356">       throw new Error(&quot;The Message Pane menu item should not be checked.&quot;);</span>
<a href="#l150.357"></a><span id="l150.357">   }</span>
<a href="#l150.358"></a><span id="l150.358"> }</span>
<a href="#l150.359"></a><span id="l150.359"> </span>
<a href="#l150.360"></a><span id="l150.360" class="difflineat">@@ -1907,70 +1894,61 @@ function toggle_message_pane() {</span>
<a href="#l150.361"></a><span id="l150.361"> function _process_row_message_arguments(...aArgs) {</span>
<a href="#l150.362"></a><span id="l150.362">   let troller = mc;</span>
<a href="#l150.363"></a><span id="l150.363">   // - normalize into desired selected view indices</span>
<a href="#l150.364"></a><span id="l150.364">   let desiredIndices = [];</span>
<a href="#l150.365"></a><span id="l150.365">   for (let arg of aArgs) {</span>
<a href="#l150.366"></a><span id="l150.366">     // An integer identifying a view index</span>
<a href="#l150.367"></a><span id="l150.367">     if (typeof(arg) == &quot;number&quot;) {</span>
<a href="#l150.368"></a><span id="l150.368">       desiredIndices.push(_normalize_view_index(arg));</span>
<a href="#l150.369"></a><span id="l150.369" class="difflineminus">-    }</span>
<a href="#l150.370"></a><span id="l150.370" class="difflineminus">-    // A message header</span>
<a href="#l150.371"></a><span id="l150.371" class="difflineminus">-    else if (arg instanceof Ci.nsIMsgDBHdr) {</span>
<a href="#l150.372"></a><span id="l150.372" class="difflineplus">+    } else if (arg instanceof Ci.nsIMsgDBHdr) { // A message header</span>
<a href="#l150.373"></a><span id="l150.373">       // do not expand; the thing should already be selected, eg expanded!</span>
<a href="#l150.374"></a><span id="l150.374">       let viewIndex = troller.dbView.findIndexOfMsgHdr(arg, false);</span>
<a href="#l150.375"></a><span id="l150.375">       if (viewIndex == nsMsgViewIndex_None)</span>
<a href="#l150.376"></a><span id="l150.376">         throw_and_dump_view_state(</span>
<a href="#l150.377"></a><span id="l150.377">           &quot;Message not present in view that should be there. &quot; +</span>
<a href="#l150.378"></a><span id="l150.378">             &quot;(&quot; + arg.messageKey + &quot;: &quot; + arg.mime2DecodedSubject + &quot;)&quot;);</span>
<a href="#l150.379"></a><span id="l150.379">       desiredIndices.push(viewIndex);</span>
<a href="#l150.380"></a><span id="l150.380" class="difflineminus">-    }</span>
<a href="#l150.381"></a><span id="l150.381" class="difflineminus">-    // A list containing two integers, indicating a range of view indices.</span>
<a href="#l150.382"></a><span id="l150.382" class="difflineminus">-    else if (arg.length == 2 &amp;&amp; typeof(arg[0]) == &quot;number&quot;) {</span>
<a href="#l150.383"></a><span id="l150.383" class="difflineplus">+    } else if (arg.length == 2 &amp;&amp; typeof(arg[0]) == &quot;number&quot;) {</span>
<a href="#l150.384"></a><span id="l150.384" class="difflineplus">+      // A list containing two integers, indicating a range of view indices.</span>
<a href="#l150.385"></a><span id="l150.385">       let lowIndex = _normalize_view_index(arg[0]);</span>
<a href="#l150.386"></a><span id="l150.386">       let highIndex = _normalize_view_index(arg[1]);</span>
<a href="#l150.387"></a><span id="l150.387">       for (let viewIndex = lowIndex; viewIndex &lt;= highIndex; viewIndex++)</span>
<a href="#l150.388"></a><span id="l150.388">         desiredIndices.push(viewIndex);</span>
<a href="#l150.389"></a><span id="l150.389" class="difflineminus">-    }</span>
<a href="#l150.390"></a><span id="l150.390" class="difflineminus">-    // a List of message headers</span>
<a href="#l150.391"></a><span id="l150.391" class="difflineminus">-    else if (arg.length !== undefined) {</span>
<a href="#l150.392"></a><span id="l150.392" class="difflineplus">+    } else if (arg.length !== undefined) {</span>
<a href="#l150.393"></a><span id="l150.393" class="difflineplus">+      // a List of message headers</span>
<a href="#l150.394"></a><span id="l150.394">       for (let iMsg = 0; iMsg &lt; arg.length; iMsg++) {</span>
<a href="#l150.395"></a><span id="l150.395">         let msgHdr = arg[iMsg].QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l150.396"></a><span id="l150.396">         if (!msgHdr)</span>
<a href="#l150.397"></a><span id="l150.397">           throw new Error(arg[iMsg] + &quot; is not a message header!&quot;);</span>
<a href="#l150.398"></a><span id="l150.398">         // false means do not expand, it should already be selected</span>
<a href="#l150.399"></a><span id="l150.399">         let viewIndex = troller.dbView.findIndexOfMsgHdr(msgHdr, false);</span>
<a href="#l150.400"></a><span id="l150.400">         if (viewIndex == nsMsgViewIndex_None)</span>
<a href="#l150.401"></a><span id="l150.401">           throw_and_dump_view_state(</span>
<a href="#l150.402"></a><span id="l150.402">             &quot;Message not present in view that should be there. &quot; +</span>
<a href="#l150.403"></a><span id="l150.403">              &quot;(&quot; + msgHdr.messageKey + &quot;: &quot; + msgHdr.mime2DecodedSubject + &quot;)&quot;);</span>
<a href="#l150.404"></a><span id="l150.404">         desiredIndices.push(viewIndex);</span>
<a href="#l150.405"></a><span id="l150.405">       }</span>
<a href="#l150.406"></a><span id="l150.406" class="difflineminus">-    }</span>
<a href="#l150.407"></a><span id="l150.407" class="difflineminus">-    // SyntheticMessageSet</span>
<a href="#l150.408"></a><span id="l150.408" class="difflineminus">-    else if (arg.synMessages) {</span>
<a href="#l150.409"></a><span id="l150.409" class="difflineplus">+    } else if (arg.synMessages) { // SyntheticMessageSet</span>
<a href="#l150.410"></a><span id="l150.410">       for (let msgHdr of arg.msgHdrs()) {</span>
<a href="#l150.411"></a><span id="l150.411">         let viewIndex = troller.dbView.findIndexOfMsgHdr(msgHdr, false);</span>
<a href="#l150.412"></a><span id="l150.412">         if (viewIndex == nsMsgViewIndex_None)</span>
<a href="#l150.413"></a><span id="l150.413">           throw_and_dump_view_state(</span>
<a href="#l150.414"></a><span id="l150.414">             &quot;Message not present in view that should be there. &quot; +</span>
<a href="#l150.415"></a><span id="l150.415">              &quot;(&quot; + msgHdr.messageKey + &quot;: &quot; + msgHdr.mime2DecodedSubject + &quot;)&quot;);</span>
<a href="#l150.416"></a><span id="l150.416">         desiredIndices.push(viewIndex);</span>
<a href="#l150.417"></a><span id="l150.417">       }</span>
<a href="#l150.418"></a><span id="l150.418" class="difflineminus">-    }</span>
<a href="#l150.419"></a><span id="l150.419" class="difflineminus">-    // it's a MozmillController</span>
<a href="#l150.420"></a><span id="l150.420" class="difflineminus">-    else if (arg.window) {</span>
<a href="#l150.421"></a><span id="l150.421" class="difflineplus">+    } else if (arg.window) { // it's a MozmillController</span>
<a href="#l150.422"></a><span id="l150.422">       troller = arg;</span>
<a href="#l150.423"></a><span id="l150.423" class="difflineminus">-    }</span>
<a href="#l150.424"></a><span id="l150.424" class="difflineminus">-    else {</span>
<a href="#l150.425"></a><span id="l150.425" class="difflineplus">+    } else {</span>
<a href="#l150.426"></a><span id="l150.426">       throw new Error(&quot;Illegal argument: &quot; + arg);</span>
<a href="#l150.427"></a><span id="l150.427">     }</span>
<a href="#l150.428"></a><span id="l150.428">   }</span>
<a href="#l150.429"></a><span id="l150.429">   // sort by integer value</span>
<a href="#l150.430"></a><span id="l150.430" class="difflineminus">-  desiredIndices.sort(function (a, b) { return a - b;} );</span>
<a href="#l150.431"></a><span id="l150.431" class="difflineplus">+  desiredIndices.sort(function(a, b) { return a - b; });</span>
<a href="#l150.432"></a><span id="l150.432"> </span>
<a href="#l150.433"></a><span id="l150.433">   return [troller, desiredIndices];</span>
<a href="#l150.434"></a><span id="l150.434"> }</span>
<a href="#l150.435"></a><span id="l150.435"> </span>
<a href="#l150.436"></a><span id="l150.436"> /**</span>
<a href="#l150.437"></a><span id="l150.437">  * Asserts that the given set of messages are selected.  Unless you are dealing</span>
<a href="#l150.438"></a><span id="l150.438">  *  with transient selections resulting from right-clicks, you want to be using</span>
<a href="#l150.439"></a><span id="l150.439">  *  assert_selected_and_displayed because it makes sure that the display is</span>
<a href="#l150.440"></a><span id="l150.440" class="difflineat">@@ -2034,19 +2012,17 @@ function _internal_assert_displayed(trus</span>
<a href="#l150.441"></a><span id="l150.441">     if (troller.messageDisplay.displayedMessage != null)</span>
<a href="#l150.442"></a><span id="l150.442">       throw new Error(&quot;Message display should not think it is displaying a &quot; +</span>
<a href="#l150.443"></a><span id="l150.443">                       &quot;message.&quot;);</span>
<a href="#l150.444"></a><span id="l150.444">     // make sure the content pane is pointed at about:blank</span>
<a href="#l150.445"></a><span id="l150.445">     if (troller.window.content.location.href != &quot;about:blank&quot;) {</span>
<a href="#l150.446"></a><span id="l150.446">       throw new Error(&quot;the content pane should be blank, but is showing: '&quot; +</span>
<a href="#l150.447"></a><span id="l150.447">                       troller.window.content.location.href + &quot;'&quot;);</span>
<a href="#l150.448"></a><span id="l150.448">     }</span>
<a href="#l150.449"></a><span id="l150.449" class="difflineminus">-  }</span>
<a href="#l150.450"></a><span id="l150.450" class="difflineminus">-  // 1 means the message should be displayed</span>
<a href="#l150.451"></a><span id="l150.451" class="difflineminus">-  else if (desiredIndices.length == 1) {</span>
<a href="#l150.452"></a><span id="l150.452" class="difflineplus">+  } else if (desiredIndices.length == 1) { // 1 means the message should be displayed</span>
<a href="#l150.453"></a><span id="l150.453">     // make sure message display thinks we are in single message display mode</span>
<a href="#l150.454"></a><span id="l150.454">     if (!troller.messageDisplay.singleMessageDisplay)</span>
<a href="#l150.455"></a><span id="l150.455">       throw new Error(&quot;Message display is not in single message display mode.&quot;);</span>
<a href="#l150.456"></a><span id="l150.456">     // now make sure that we actually are in single message display mode</span>
<a href="#l150.457"></a><span id="l150.457">     let singleMessagePane = troller.e(&quot;singlemessage&quot;);</span>
<a href="#l150.458"></a><span id="l150.458">     let multiMessagePane = troller.e(&quot;multimessage&quot;);</span>
<a href="#l150.459"></a><span id="l150.459">     if (singleMessagePane &amp;&amp; singleMessagePane.hidden)</span>
<a href="#l150.460"></a><span id="l150.460">       throw new Error(&quot;Single message pane is hidden but it should not be.&quot;);</span>
<a href="#l150.461"></a><span id="l150.461" class="difflineat">@@ -2073,24 +2049,22 @@ function _internal_assert_displayed(trus</span>
<a href="#l150.462"></a><span id="l150.462">       troller.folderDisplay.messenger.messageServiceFromURI(msgUri);</span>
<a href="#l150.463"></a><span id="l150.463">     let msgUrlObj = {};</span>
<a href="#l150.464"></a><span id="l150.464">     msgService.GetUrlForUri(msgUri, msgUrlObj, troller.folderDisplay.msgWindow);</span>
<a href="#l150.465"></a><span id="l150.465">     let msgUrl = msgUrlObj.value;</span>
<a href="#l150.466"></a><span id="l150.466">     if (troller.window.content.location.href != msgUrl.spec)</span>
<a href="#l150.467"></a><span id="l150.467">       throw new Error(&quot;The content pane is not displaying the right message! &quot; +</span>
<a href="#l150.468"></a><span id="l150.468">                       &quot;Should be: &quot; + msgUrl.spec + &quot; but it's: &quot; +</span>
<a href="#l150.469"></a><span id="l150.469">                       troller.window.content.location.href);</span>
<a href="#l150.470"></a><span id="l150.470" class="difflineminus">-  }</span>
<a href="#l150.471"></a><span id="l150.471" class="difflineminus">-  // multiple means some form of multi-message summary</span>
<a href="#l150.472"></a><span id="l150.472" class="difflineminus">-  else {</span>
<a href="#l150.473"></a><span id="l150.473" class="difflineplus">+  } else { // multiple means some form of multi-message summary</span>
<a href="#l150.474"></a><span id="l150.474">     // XXX deal with the summarization threshold bail case.</span>
<a href="#l150.475"></a><span id="l150.475"> </span>
<a href="#l150.476"></a><span id="l150.476">     // make sure the message display thinks we are in multi-message mode</span>
<a href="#l150.477"></a><span id="l150.477">     if (troller.messageDisplay.singleMessageDisplay)</span>
<a href="#l150.478"></a><span id="l150.478" class="difflineminus">-      throw new Error(&quot;Message display should not be in single message display&quot;+</span>
<a href="#l150.479"></a><span id="l150.479" class="difflineplus">+      throw new Error(&quot;Message display should not be in single message display&quot; +</span>
<a href="#l150.480"></a><span id="l150.480">                       &quot;mode!  Desired indices: &quot; + desiredIndices);</span>
<a href="#l150.481"></a><span id="l150.481"> </span>
<a href="#l150.482"></a><span id="l150.482">     // verify that the message pane browser is displaying about:blank</span>
<a href="#l150.483"></a><span id="l150.483">     if (mc.window.content.location.href != &quot;about:blank&quot;)</span>
<a href="#l150.484"></a><span id="l150.484">       throw new Error(&quot;the content pane should be blank, but is showing: '&quot; +</span>
<a href="#l150.485"></a><span id="l150.485">                       mc.window.content.location.href + &quot;'&quot;);</span>
<a href="#l150.486"></a><span id="l150.486"> </span>
<a href="#l150.487"></a><span id="l150.487">     // now make sure that we actually are in nultiple message display mode</span>
<a href="#l150.488"></a><span id="l150.488" class="difflineat">@@ -2235,17 +2209,17 @@ function assert_visible(aViewIndexOrMess</span>
<a href="#l150.489"></a><span id="l150.489"> </span>
<a href="#l150.490"></a><span id="l150.490"> /**</span>
<a href="#l150.491"></a><span id="l150.491">  * Assert that the given message is now shown in the current view.</span>
<a href="#l150.492"></a><span id="l150.492">  */</span>
<a href="#l150.493"></a><span id="l150.493"> function assert_not_shown(aMessages) {</span>
<a href="#l150.494"></a><span id="l150.494">   aMessages.forEach(function(msg) {</span>
<a href="#l150.495"></a><span id="l150.495">     let viewIndex = mc.dbView.findIndexOfMsgHdr(msg, false);</span>
<a href="#l150.496"></a><span id="l150.496">     if (viewIndex !== nsMsgViewIndex_None)</span>
<a href="#l150.497"></a><span id="l150.497" class="difflineminus">-      throw new Error(&quot;Message shows; &quot;+ msg.messageKey + &quot;: &quot; +</span>
<a href="#l150.498"></a><span id="l150.498" class="difflineplus">+      throw new Error(&quot;Message shows; &quot; + msg.messageKey + &quot;: &quot; +</span>
<a href="#l150.499"></a><span id="l150.499">                       msg.mime2DecodedSubject);</span>
<a href="#l150.500"></a><span id="l150.500">   });</span>
<a href="#l150.501"></a><span id="l150.501"> }</span>
<a href="#l150.502"></a><span id="l150.502"> </span>
<a href="#l150.503"></a><span id="l150.503"> /**</span>
<a href="#l150.504"></a><span id="l150.504">  * @param aShouldBeElided Should the messages at the view indices be elided?</span>
<a href="#l150.505"></a><span id="l150.505">  * @param aArgs Arguments of the form processed by</span>
<a href="#l150.506"></a><span id="l150.506">  *     |_process_row_message_arguments|.</span>
<a href="#l150.507"></a><span id="l150.507" class="difflineat">@@ -2464,42 +2438,35 @@ function _process_row_folder_arguments(.</span>
<a href="#l150.508"></a><span id="l150.508">   for (let arg of aArgs) {</span>
<a href="#l150.509"></a><span id="l150.509">     // An integer identifying a view index</span>
<a href="#l150.510"></a><span id="l150.510">     if (typeof(arg) == &quot;number&quot;) {</span>
<a href="#l150.511"></a><span id="l150.511">       let folder = troller.folderTreeView.getFolderForIndex(</span>
<a href="#l150.512"></a><span id="l150.512">                        _normalize_folder_view_index(arg));</span>
<a href="#l150.513"></a><span id="l150.513">       if (!folder)</span>
<a href="#l150.514"></a><span id="l150.514">         throw new Error(&quot;Folder index not present in folder view: &quot; + arg);</span>
<a href="#l150.515"></a><span id="l150.515">       desiredFolders.push(folder);</span>
<a href="#l150.516"></a><span id="l150.516" class="difflineminus">-    }</span>
<a href="#l150.517"></a><span id="l150.517" class="difflineminus">-    // A folder</span>
<a href="#l150.518"></a><span id="l150.518" class="difflineminus">-    else if (arg instanceof Ci.nsIMsgFolder) {</span>
<a href="#l150.519"></a><span id="l150.519" class="difflineplus">+    } else if (arg instanceof Ci.nsIMsgFolder) { // A folder</span>
<a href="#l150.520"></a><span id="l150.520">       desiredFolders.push(arg);</span>
<a href="#l150.521"></a><span id="l150.521" class="difflineminus">-    }</span>
<a href="#l150.522"></a><span id="l150.522" class="difflineminus">-    // A list containing two integers, indicating a range of view indices.</span>
<a href="#l150.523"></a><span id="l150.523" class="difflineminus">-    else if (arg.length == 2 &amp;&amp; typeof(arg[0]) == &quot;number&quot;) {</span>
<a href="#l150.524"></a><span id="l150.524" class="difflineplus">+    } else if (arg.length == 2 &amp;&amp; typeof(arg[0]) == &quot;number&quot;) {</span>
<a href="#l150.525"></a><span id="l150.525" class="difflineplus">+      // A list containing two integers, indicating a range of view indices.</span>
<a href="#l150.526"></a><span id="l150.526">       let lowIndex = _normalize_folder_view_index(arg[0]);</span>
<a href="#l150.527"></a><span id="l150.527">       let highIndex = _normalize_folder_view_index(arg[1]);</span>
<a href="#l150.528"></a><span id="l150.528">       for (let viewIndex = lowIndex; viewIndex &lt;= highIndex; viewIndex++)</span>
<a href="#l150.529"></a><span id="l150.529">         desiredFolders.push(troller.folderTreeView.getFolderForIndex(viewIndex));</span>
<a href="#l150.530"></a><span id="l150.530" class="difflineminus">-    }</span>
<a href="#l150.531"></a><span id="l150.531" class="difflineminus">-    // a List of folders</span>
<a href="#l150.532"></a><span id="l150.532" class="difflineminus">-    else if (arg.length !== undefined) {</span>
<a href="#l150.533"></a><span id="l150.533" class="difflineplus">+    } else if (arg.length !== undefined) {</span>
<a href="#l150.534"></a><span id="l150.534" class="difflineplus">+      // a List of folders</span>
<a href="#l150.535"></a><span id="l150.535">       for (let iFolder = 0; iFolder &lt; arg.length; iFolder++) {</span>
<a href="#l150.536"></a><span id="l150.536">         let folder = arg[iFolder].QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l150.537"></a><span id="l150.537">         if (!folder)</span>
<a href="#l150.538"></a><span id="l150.538">           throw new Error(arg[iFolder] + &quot; is not a folder!&quot;);</span>
<a href="#l150.539"></a><span id="l150.539">         desiredFolders.push(folder);</span>
<a href="#l150.540"></a><span id="l150.540">       }</span>
<a href="#l150.541"></a><span id="l150.541" class="difflineminus">-    }</span>
<a href="#l150.542"></a><span id="l150.542" class="difflineminus">-    // it's a MozmillController</span>
<a href="#l150.543"></a><span id="l150.543" class="difflineminus">-    else if (arg.window) {</span>
<a href="#l150.544"></a><span id="l150.544" class="difflineplus">+    } else if (arg.window) { // it's a MozmillController</span>
<a href="#l150.545"></a><span id="l150.545">       troller = arg;</span>
<a href="#l150.546"></a><span id="l150.546" class="difflineminus">-    }</span>
<a href="#l150.547"></a><span id="l150.547" class="difflineminus">-    else {</span>
<a href="#l150.548"></a><span id="l150.548" class="difflineplus">+    } else {</span>
<a href="#l150.549"></a><span id="l150.549">       throw new Error(&quot;Illegal argument: &quot; + arg);</span>
<a href="#l150.550"></a><span id="l150.550">     }</span>
<a href="#l150.551"></a><span id="l150.551">   }</span>
<a href="#l150.552"></a><span id="l150.552">   // we can't really sort, so you'll have to grin and bear it</span>
<a href="#l150.553"></a><span id="l150.553">   return [troller, desiredFolders];</span>
<a href="#l150.554"></a><span id="l150.554"> }</span>
<a href="#l150.555"></a><span id="l150.555"> </span>
<a href="#l150.556"></a><span id="l150.556"> /**</span>
<a href="#l150.557"></a><span id="l150.557" class="difflineat">@@ -2601,17 +2568,17 @@ function assert_folder_tree_view_row_cou</span>
<a href="#l150.558"></a><span id="l150.558">                     &quot;, but is actually &quot; + mc.folderTreeView.rowCount);</span>
<a href="#l150.559"></a><span id="l150.559"> }</span>
<a href="#l150.560"></a><span id="l150.560"> </span>
<a href="#l150.561"></a><span id="l150.561"> /**</span>
<a href="#l150.562"></a><span id="l150.562">  * Assert that the displayed text of the folder at index n equals to str.</span>
<a href="#l150.563"></a><span id="l150.563">  */</span>
<a href="#l150.564"></a><span id="l150.564"> function assert_folder_at_index_as(n, str) {</span>
<a href="#l150.565"></a><span id="l150.565">   let folderN = mc.window.gFolderTreeView.getFTVItemForIndex(n);</span>
<a href="#l150.566"></a><span id="l150.566" class="difflineminus">-  assert_equals(folderN.text, str)</span>
<a href="#l150.567"></a><span id="l150.567" class="difflineplus">+  assert_equals(folderN.text, str);</span>
<a href="#l150.568"></a><span id="l150.568"> }</span>
<a href="#l150.569"></a><span id="l150.569"> </span>
<a href="#l150.570"></a><span id="l150.570"> /**</span>
<a href="#l150.571"></a><span id="l150.571">  * Since indexOf does strict equality checking, we need this.</span>
<a href="#l150.572"></a><span id="l150.572">  */</span>
<a href="#l150.573"></a><span id="l150.573"> function _non_strict_index_of(aArray, aSearchElement) {</span>
<a href="#l150.574"></a><span id="l150.574">   for (let [i, item] of aArray.entries()) {</span>
<a href="#l150.575"></a><span id="l150.575">     if (item == aSearchElement)</span>
<a href="#l150.576"></a><span id="l150.576" class="difflineat">@@ -2799,17 +2766,17 @@ function reset_close_message_on_delete()</span>
<a href="#l150.577"></a><span id="l150.577">  * assert that the multimessage/thread summary view contains</span>
<a href="#l150.578"></a><span id="l150.578">  * the specified number of elements of the specified selector.</span>
<a href="#l150.579"></a><span id="l150.579">  *</span>
<a href="#l150.580"></a><span id="l150.580">  * @param aSelector: the CSS selector to use to select</span>
<a href="#l150.581"></a><span id="l150.581">  * @param aNumElts: the number of expected elements that have that class</span>
<a href="#l150.582"></a><span id="l150.582">  */</span>
<a href="#l150.583"></a><span id="l150.583"> </span>
<a href="#l150.584"></a><span id="l150.584"> function assert_summary_contains_N_elts(aSelector, aNumElts) {</span>
<a href="#l150.585"></a><span id="l150.585" class="difflineminus">-  let htmlframe = mc.e('multimessage');</span>
<a href="#l150.586"></a><span id="l150.586" class="difflineplus">+  let htmlframe = mc.e(&quot;multimessage&quot;);</span>
<a href="#l150.587"></a><span id="l150.587">   let matches = htmlframe.contentDocument.querySelectorAll(aSelector);</span>
<a href="#l150.588"></a><span id="l150.588">   if (matches.length != aNumElts) {</span>
<a href="#l150.589"></a><span id="l150.589">     throw new Error(</span>
<a href="#l150.590"></a><span id="l150.590">       &quot;Expected to find &quot; + aNumElts + &quot; elements with selector '&quot; +</span>
<a href="#l150.591"></a><span id="l150.591">       aSelector + &quot;', found: &quot; + matches.length</span>
<a href="#l150.592"></a><span id="l150.592">     );</span>
<a href="#l150.593"></a><span id="l150.593">   }</span>
<a href="#l150.594"></a><span id="l150.594"> }</span>
<a href="#l150.595"></a><span id="l150.595" class="difflineat">@@ -2915,39 +2882,36 @@ function load_via_src_path(aPath, aModul</span>
<a href="#l150.596"></a><span id="l150.596">                  .createInstance(Ci.nsIFile);</span>
<a href="#l150.597"></a><span id="l150.597">     file.initWithPath(fullPath);</span>
<a href="#l150.598"></a><span id="l150.598"> </span>
<a href="#l150.599"></a><span id="l150.599">     if (file.exists()) {</span>
<a href="#l150.600"></a><span id="l150.600">       try {</span>
<a href="#l150.601"></a><span id="l150.601">         let uri = Services.io.newFileURI(file).spec;</span>
<a href="#l150.602"></a><span id="l150.602">         Services.scriptloader.loadSubScript(uri, aModule);</span>
<a href="#l150.603"></a><span id="l150.603">         return;</span>
<a href="#l150.604"></a><span id="l150.604" class="difflineminus">-      }</span>
<a href="#l150.605"></a><span id="l150.605" class="difflineminus">-      catch (ex) {</span>
<a href="#l150.606"></a><span id="l150.606" class="difflineplus">+      } catch (ex) {</span>
<a href="#l150.607"></a><span id="l150.607">         throw new Error(&quot;Unable to load file: &quot; + fullPath + &quot; exception: &quot; + ex);</span>
<a href="#l150.608"></a><span id="l150.608">       }</span>
<a href="#l150.609"></a><span id="l150.609">     }</span>
<a href="#l150.610"></a><span id="l150.610">   }</span>
<a href="#l150.611"></a><span id="l150.611"> </span>
<a href="#l150.612"></a><span id="l150.612">   // If we've got this far, then we weren't successful, fail out.</span>
<a href="#l150.613"></a><span id="l150.613">   throw new Error(&quot;Could not find &quot; + aPath + &quot; in available paths&quot;);</span>
<a href="#l150.614"></a><span id="l150.614"> }</span>
<a href="#l150.615"></a><span id="l150.615"> </span>
<a href="#l150.616"></a><span id="l150.616" class="difflineminus">-function assert_equals(a, b, comment)</span>
<a href="#l150.617"></a><span id="l150.617" class="difflineminus">-{</span>
<a href="#l150.618"></a><span id="l150.618" class="difflineplus">+function assert_equals(a, b, comment) {</span>
<a href="#l150.619"></a><span id="l150.619">   if (!comment)</span>
<a href="#l150.620"></a><span id="l150.620">     comment = &quot;a != b&quot;;</span>
<a href="#l150.621"></a><span id="l150.621" class="difflineminus">-  assert_true(a == b, comment + &quot;: '&quot;+ a + &quot;' != '&quot; + b + &quot;'.&quot;);</span>
<a href="#l150.622"></a><span id="l150.622" class="difflineplus">+  assert_true(a == b, comment + &quot;: '&quot; + a + &quot;' != '&quot; + b + &quot;'.&quot;);</span>
<a href="#l150.623"></a><span id="l150.623"> }</span>
<a href="#l150.624"></a><span id="l150.624"> </span>
<a href="#l150.625"></a><span id="l150.625" class="difflineminus">-function assert_not_equals(a, b, comment)</span>
<a href="#l150.626"></a><span id="l150.626" class="difflineminus">-{</span>
<a href="#l150.627"></a><span id="l150.627" class="difflineplus">+function assert_not_equals(a, b, comment) {</span>
<a href="#l150.628"></a><span id="l150.628">   if (!comment)</span>
<a href="#l150.629"></a><span id="l150.629">     comment = &quot;a == b&quot;;</span>
<a href="#l150.630"></a><span id="l150.630" class="difflineminus">-  assert_true(a != b, comment + &quot;: '&quot;+ a + &quot;' == '&quot; + b + &quot;'.&quot;);</span>
<a href="#l150.631"></a><span id="l150.631" class="difflineplus">+  assert_true(a != b, comment + &quot;: '&quot; + a + &quot;' == '&quot; + b + &quot;'.&quot;);</span>
<a href="#l150.632"></a><span id="l150.632"> }</span>
<a href="#l150.633"></a><span id="l150.633"> </span>
<a href="#l150.634"></a><span id="l150.634"> // something less sucky than do_check_true</span>
<a href="#l150.635"></a><span id="l150.635"> function assert_true(aBeTrue, aWhy = &quot;Expected value of expression is not 'true'&quot;) {</span>
<a href="#l150.636"></a><span id="l150.636">   if (!aBeTrue)</span>
<a href="#l150.637"></a><span id="l150.637">     throw new Error(aWhy);</span>
<a href="#l150.638"></a><span id="l150.638"> }</span>
<a href="#l150.639"></a><span id="l150.639"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l151.1"></a><span id="l151.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-junk-helpers.js</span>
<a href="#l151.2"></a><span id="l151.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-junk-helpers.js</span>
<a href="#l151.3"></a><span id="l151.3" class="difflineat">@@ -1,31 +1,29 @@</span>
<a href="#l151.4"></a><span id="l151.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l151.5"></a><span id="l151.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l151.6"></a><span id="l151.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l151.7"></a><span id="l151.7"> </span>
<a href="#l151.8"></a><span id="l151.8"> &quot;use strict&quot;;</span>
<a href="#l151.9"></a><span id="l151.9"> </span>
<a href="#l151.10"></a><span id="l151.10"> var MODULE_NAME = &quot;junk-helpers&quot;;</span>
<a href="#l151.11"></a><span id="l151.11" class="difflineminus">-</span>
<a href="#l151.12"></a><span id="l151.12"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l151.13"></a><span id="l151.13" class="difflineminus">-// we need this for the main controller</span>
<a href="#l151.14"></a><span id="l151.14"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l151.15"></a><span id="l151.15"> </span>
<a href="#l151.16"></a><span id="l151.16"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l151.17"></a><span id="l151.17"> var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l151.18"></a><span id="l151.18"> </span>
<a href="#l151.19"></a><span id="l151.19"> var folderDisplayHelper;</span>
<a href="#l151.20"></a><span id="l151.20"> var mc;</span>
<a href="#l151.21"></a><span id="l151.21"> </span>
<a href="#l151.22"></a><span id="l151.22"> // logHelper (and therefore folderDisplayHelper) exports</span>
<a href="#l151.23"></a><span id="l151.23"> var mark_failure;</span>
<a href="#l151.24"></a><span id="l151.24"> </span>
<a href="#l151.25"></a><span id="l151.25"> function setupModule() {</span>
<a href="#l151.26"></a><span id="l151.26" class="difflineminus">-  folderDisplayHelper = collector.getModule('folder-display-helpers');</span>
<a href="#l151.27"></a><span id="l151.27" class="difflineplus">+  folderDisplayHelper = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l151.28"></a><span id="l151.28">   mc = folderDisplayHelper.mc;</span>
<a href="#l151.29"></a><span id="l151.29">   mark_failure = folderDisplayHelper.mark_failure;</span>
<a href="#l151.30"></a><span id="l151.30"> }</span>
<a href="#l151.31"></a><span id="l151.31"> </span>
<a href="#l151.32"></a><span id="l151.32"> function installInto(module) {</span>
<a href="#l151.33"></a><span id="l151.33">   setupModule();</span>
<a href="#l151.34"></a><span id="l151.34"> </span>
<a href="#l151.35"></a><span id="l151.35">   // Now copy helper functions</span>
<a href="#l151.36"></a><span id="l151.36" class="difflineat">@@ -135,13 +133,12 @@ function delete_mail_marked_as_junk(aNum</span>
<a href="#l151.37"></a><span id="l151.37">                   &quot;Timeout waiting for numMessagesDeleted to turn &quot; +</span>
<a href="#l151.38"></a><span id="l151.38">                   &quot;non-null. This either means that deleteJunkInFolder &quot; +</span>
<a href="#l151.39"></a><span id="l151.39">                   &quot;didn't get called or that it didn't return a value.&quot;);</span>
<a href="#l151.40"></a><span id="l151.40"> </span>
<a href="#l151.41"></a><span id="l151.41">     // Check the number of deleted messages.</span>
<a href="#l151.42"></a><span id="l151.42">     if (aNumDeletesExpected != numMessagesDeleted)</span>
<a href="#l151.43"></a><span id="l151.43">       mark_failure([&quot;Expected&quot;, aNumDeletesExpected, &quot;deletes, but&quot;,</span>
<a href="#l151.44"></a><span id="l151.44">                     numMessagesDeleted, &quot;happened&quot;]);</span>
<a href="#l151.45"></a><span id="l151.45" class="difflineminus">-  }</span>
<a href="#l151.46"></a><span id="l151.46" class="difflineminus">-  finally {</span>
<a href="#l151.47"></a><span id="l151.47" class="difflineplus">+  } finally {</span>
<a href="#l151.48"></a><span id="l151.48">     aController.window.deleteJunkInFolder = realDeleteJunkInFolder;</span>
<a href="#l151.49"></a><span id="l151.49">   }</span>
<a href="#l151.50"></a><span id="l151.50"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l152.1"></a><span id="l152.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-keyboard-helpers.js</span>
<a href="#l152.2"></a><span id="l152.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-keyboard-helpers.js</span>
<a href="#l152.3"></a><span id="l152.3" class="difflineat">@@ -1,19 +1,16 @@</span>
<a href="#l152.4"></a><span id="l152.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l152.5"></a><span id="l152.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l152.6"></a><span id="l152.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l152.7"></a><span id="l152.7"> </span>
<a href="#l152.8"></a><span id="l152.8"> &quot;use strict&quot;;</span>
<a href="#l152.9"></a><span id="l152.9"> </span>
<a href="#l152.10"></a><span id="l152.10"> var MODULE_NAME = &quot;keyboard-helpers&quot;;</span>
<a href="#l152.11"></a><span id="l152.11"> </span>
<a href="#l152.12"></a><span id="l152.12" class="difflineminus">-var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l152.13"></a><span id="l152.13" class="difflineminus">-var MODULE_REQUIRES = [];</span>
<a href="#l152.14"></a><span id="l152.14" class="difflineminus">-</span>
<a href="#l152.15"></a><span id="l152.15"> function installInto(module) {</span>
<a href="#l152.16"></a><span id="l152.16">   // Now copy helper functions</span>
<a href="#l152.17"></a><span id="l152.17">   module.input_value = input_value;</span>
<a href="#l152.18"></a><span id="l152.18">   module.delete_existing = delete_existing;</span>
<a href="#l152.19"></a><span id="l152.19">   module.delete_all_existing = delete_all_existing;</span>
<a href="#l152.20"></a><span id="l152.20"> }</span>
<a href="#l152.21"></a><span id="l152.21"> </span>
<a href="#l152.22"></a><span id="l152.22"> /**</span>
<a href="#l152.23"></a><span id="l152.23" class="difflineat">@@ -32,21 +29,21 @@ function input_value(aController, aStr, </span>
<a href="#l152.24"></a><span id="l152.24">  * Emulates deleting strings via the keyboard</span>
<a href="#l152.25"></a><span id="l152.25">  *</span>
<a href="#l152.26"></a><span id="l152.26">  * @param aController The window controller to input keypresses into</span>
<a href="#l152.27"></a><span id="l152.27">  * @param aElement    The element in which to delete characters</span>
<a href="#l152.28"></a><span id="l152.28">  * @param aNumber     The number of times to press the delete key.</span>
<a href="#l152.29"></a><span id="l152.29">  */</span>
<a href="#l152.30"></a><span id="l152.30"> function delete_existing(aController, aElement, aNumber) {</span>
<a href="#l152.31"></a><span id="l152.31">   for (let i = 0; i &lt; aNumber; ++i)</span>
<a href="#l152.32"></a><span id="l152.32" class="difflineminus">-    aController.keypress(aElement, 'VK_BACK_SPACE', {});</span>
<a href="#l152.33"></a><span id="l152.33" class="difflineplus">+    aController.keypress(aElement, &quot;VK_BACK_SPACE&quot;, {});</span>
<a href="#l152.34"></a><span id="l152.34"> }</span>
<a href="#l152.35"></a><span id="l152.35"> </span>
<a href="#l152.36"></a><span id="l152.36"> /**</span>
<a href="#l152.37"></a><span id="l152.37">  * Emulates deleting the entire string by pressing Ctrl-A and DEL</span>
<a href="#l152.38"></a><span id="l152.38">  *</span>
<a href="#l152.39"></a><span id="l152.39">  * @param aController The window controller to input keypresses into</span>
<a href="#l152.40"></a><span id="l152.40">  * @param aElement    The element in which to delete characters</span>
<a href="#l152.41"></a><span id="l152.41">  */</span>
<a href="#l152.42"></a><span id="l152.42"> function delete_all_existing(aController, aElement) {</span>
<a href="#l152.43"></a><span id="l152.43" class="difflineminus">-  aController.keypress(aElement, 'a', {accelKey: true});</span>
<a href="#l152.44"></a><span id="l152.44" class="difflineminus">-  aController.keypress(aElement, 'VK_DELETE', {});</span>
<a href="#l152.45"></a><span id="l152.45" class="difflineplus">+  aController.keypress(aElement, &quot;a&quot;, {accelKey: true});</span>
<a href="#l152.46"></a><span id="l152.46" class="difflineplus">+  aController.keypress(aElement, &quot;VK_DELETE&quot;, {});</span>
<a href="#l152.47"></a><span id="l152.47"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l153.1"></a><span id="l153.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-message-helpers.js</span>
<a href="#l153.2"></a><span id="l153.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-message-helpers.js</span>
<a href="#l153.3"></a><span id="l153.3" class="difflineat">@@ -20,26 +20,24 @@ function installInto(module) {</span>
<a href="#l153.4"></a><span id="l153.4"> }</span>
<a href="#l153.5"></a><span id="l153.5"> </span>
<a href="#l153.6"></a><span id="l153.6"> /**</span>
<a href="#l153.7"></a><span id="l153.7">  * Given a message header, converts it to a MimeMessage. If aCallback throws,</span>
<a href="#l153.8"></a><span id="l153.8">  * the test will be marked failed. See the documentation for MsgHdrToMimeMessage</span>
<a href="#l153.9"></a><span id="l153.9">  * for more details.</span>
<a href="#l153.10"></a><span id="l153.10">  */</span>
<a href="#l153.11"></a><span id="l153.11"> function to_mime_message(aMsgHdr, aCallbackThis, aCallback, aAllowDownload, aOptions) {</span>
<a href="#l153.12"></a><span id="l153.12" class="difflineminus">-  let runner = new frame.Runner(collector);</span>
<a href="#l153.13"></a><span id="l153.13" class="difflineplus">+  new frame.Runner(collector);</span>
<a href="#l153.14"></a><span id="l153.14">   let called = false;</span>
<a href="#l153.15"></a><span id="l153.15">   let currentTest = frame.events.currentTest;</span>
<a href="#l153.16"></a><span id="l153.16">   MsgHdrToMimeMessage(aMsgHdr, aCallbackThis,</span>
<a href="#l153.17"></a><span id="l153.17" class="difflineminus">-    function (aRecdMsgHdr, aMimeMsg) {</span>
<a href="#l153.18"></a><span id="l153.18" class="difflineplus">+    function(aRecdMsgHdr, aMimeMsg) {</span>
<a href="#l153.19"></a><span id="l153.19">       try {</span>
<a href="#l153.20"></a><span id="l153.20">         aCallback(aRecdMsgHdr, aMimeMsg);</span>
<a href="#l153.21"></a><span id="l153.21" class="difflineminus">-      }</span>
<a href="#l153.22"></a><span id="l153.22" class="difflineminus">-      catch (ex) {</span>
<a href="#l153.23"></a><span id="l153.23" class="difflineplus">+      } catch (ex) {</span>
<a href="#l153.24"></a><span id="l153.24">         Cu.reportError(ex);</span>
<a href="#l153.25"></a><span id="l153.25">         frame.events.fail({exception: ex, test: currentTest});</span>
<a href="#l153.26"></a><span id="l153.26" class="difflineminus">-      }</span>
<a href="#l153.27"></a><span id="l153.27" class="difflineminus">-      finally {</span>
<a href="#l153.28"></a><span id="l153.28" class="difflineplus">+      } finally {</span>
<a href="#l153.29"></a><span id="l153.29">         called = true;</span>
<a href="#l153.30"></a><span id="l153.30">       }</span>
<a href="#l153.31"></a><span id="l153.31">     }, aAllowDownload, aOptions);</span>
<a href="#l153.32"></a><span id="l153.32">   utils.waitFor(() =&gt; called, &quot;Timeout waiting for message to be parsed&quot;);</span>
<a href="#l153.33"></a><span id="l153.33"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l154.1"></a><span id="l154.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-mock-object-helpers.js</span>
<a href="#l154.2"></a><span id="l154.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-mock-object-helpers.js</span>
<a href="#l154.3"></a><span id="l154.3" class="difflineat">@@ -27,34 +27,34 @@ function MockObjectRegisterer(aContractI</span>
<a href="#l154.4"></a><span id="l154.4"> MockObjectRegisterer.prototype = {</span>
<a href="#l154.5"></a><span id="l154.5">   register: function MOR_register() {</span>
<a href="#l154.6"></a><span id="l154.6">     let providedConstructor = this._component;</span>
<a href="#l154.7"></a><span id="l154.7">     this._mockFactory = {</span>
<a href="#l154.8"></a><span id="l154.8">       createInstance: function MF_createInstance(aOuter, aIid) {</span>
<a href="#l154.9"></a><span id="l154.9">         if (aOuter != null)</span>
<a href="#l154.10"></a><span id="l154.10">           throw Cr.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l154.11"></a><span id="l154.11">         return new providedConstructor().QueryInterface(aIid);</span>
<a href="#l154.12"></a><span id="l154.12" class="difflineminus">-      }</span>
<a href="#l154.13"></a><span id="l154.13" class="difflineplus">+      },</span>
<a href="#l154.14"></a><span id="l154.14">     };</span>
<a href="#l154.15"></a><span id="l154.15"> </span>
<a href="#l154.16"></a><span id="l154.16">    let componentRegistrar = Cm.QueryInterface(Ci.nsIComponentRegistrar);</span>
<a href="#l154.17"></a><span id="l154.17"> </span>
<a href="#l154.18"></a><span id="l154.18">    componentRegistrar.registerFactory(this._cid,</span>
<a href="#l154.19"></a><span id="l154.19">         &quot;&quot;,</span>
<a href="#l154.20"></a><span id="l154.20">         this._contractID,</span>
<a href="#l154.21"></a><span id="l154.21">         this._mockFactory);</span>
<a href="#l154.22"></a><span id="l154.22">   },</span>
<a href="#l154.23"></a><span id="l154.23"> </span>
<a href="#l154.24"></a><span id="l154.24">   unregister: function MOR_unregister() {</span>
<a href="#l154.25"></a><span id="l154.25">     let componentRegistrar = Cm.QueryInterface(Ci.nsIComponentRegistrar);</span>
<a href="#l154.26"></a><span id="l154.26"> </span>
<a href="#l154.27"></a><span id="l154.27">     componentRegistrar.unregisterFactory(this._cid,</span>
<a href="#l154.28"></a><span id="l154.28">         this._mockFactory);</span>
<a href="#l154.29"></a><span id="l154.29">   },</span>
<a href="#l154.30"></a><span id="l154.30" class="difflineminus">-}</span>
<a href="#l154.31"></a><span id="l154.31" class="difflineplus">+};</span>
<a href="#l154.32"></a><span id="l154.32"> </span>
<a href="#l154.33"></a><span id="l154.33"> /**</span>
<a href="#l154.34"></a><span id="l154.34">  * Allows registering a mock XPCOM component, that temporarily replaces the</span>
<a href="#l154.35"></a><span id="l154.35">  *  original one when an object implementing a given ContractID is requested</span>
<a href="#l154.36"></a><span id="l154.36">  *  using createInstance.</span>
<a href="#l154.37"></a><span id="l154.37">  *</span>
<a href="#l154.38"></a><span id="l154.38">  * @param aContractID</span>
<a href="#l154.39"></a><span id="l154.39">  *        The ContractID of the component to replace, for example</span>
<a href="#l154.40"></a><span id="l154.40" class="difflineat">@@ -88,22 +88,22 @@ MockObjectReplacer.prototype = {</span>
<a href="#l154.41"></a><span id="l154.41"> </span>
<a href="#l154.42"></a><span id="l154.42">     // Define a factory that creates a new object using the given constructor.</span>
<a href="#l154.43"></a><span id="l154.43">     var providedConstructor = this._replacementCtor;</span>
<a href="#l154.44"></a><span id="l154.44">     this._mockFactory = {</span>
<a href="#l154.45"></a><span id="l154.45">       createInstance(aOuter, aIid) {</span>
<a href="#l154.46"></a><span id="l154.46">         if (aOuter != null)</span>
<a href="#l154.47"></a><span id="l154.47">           throw Cr.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l154.48"></a><span id="l154.48">         return new providedConstructor().QueryInterface(aIid);</span>
<a href="#l154.49"></a><span id="l154.49" class="difflineminus">-      }</span>
<a href="#l154.50"></a><span id="l154.50" class="difflineplus">+      },</span>
<a href="#l154.51"></a><span id="l154.51">     };</span>
<a href="#l154.52"></a><span id="l154.52"> </span>
<a href="#l154.53"></a><span id="l154.53">     var retVal = swapFactoryRegistration(this._cid, this._originalCID, this._contractID, this._mockFactory);</span>
<a href="#l154.54"></a><span id="l154.54" class="difflineminus">-    if ('error' in retVal) {</span>
<a href="#l154.55"></a><span id="l154.55" class="difflineminus">-      throw new Exception(&quot;ERROR: &quot; + retVal.error);</span>
<a href="#l154.56"></a><span id="l154.56" class="difflineplus">+    if (&quot;error&quot; in retVal) {</span>
<a href="#l154.57"></a><span id="l154.57" class="difflineplus">+      throw new Error(&quot;ERROR: &quot; + retVal.error);</span>
<a href="#l154.58"></a><span id="l154.58">     } else {</span>
<a href="#l154.59"></a><span id="l154.59">       this._cid = retVal.cid;</span>
<a href="#l154.60"></a><span id="l154.60">       this._originalCID = retVal.originalCID;</span>
<a href="#l154.61"></a><span id="l154.61">     }</span>
<a href="#l154.62"></a><span id="l154.62">   },</span>
<a href="#l154.63"></a><span id="l154.63"> </span>
<a href="#l154.64"></a><span id="l154.64">   /**</span>
<a href="#l154.65"></a><span id="l154.65">    * Restores the original factory.</span>
<a href="#l154.66"></a><span id="l154.66" class="difflineat">@@ -126,42 +126,42 @@ MockObjectReplacer.prototype = {</span>
<a href="#l154.67"></a><span id="l154.67">   /**</span>
<a href="#l154.68"></a><span id="l154.68">    * The CID under which the mock contractID was registered.</span>
<a href="#l154.69"></a><span id="l154.69">    */</span>
<a href="#l154.70"></a><span id="l154.70">   _cid: null,</span>
<a href="#l154.71"></a><span id="l154.71"> </span>
<a href="#l154.72"></a><span id="l154.72">   /**</span>
<a href="#l154.73"></a><span id="l154.73">    * The nsIFactory that was automatically generated by this object.</span>
<a href="#l154.74"></a><span id="l154.74">    */</span>
<a href="#l154.75"></a><span id="l154.75" class="difflineminus">-  _mockFactory: null</span>
<a href="#l154.76"></a><span id="l154.76" class="difflineminus">-}</span>
<a href="#l154.77"></a><span id="l154.77" class="difflineplus">+  _mockFactory: null,</span>
<a href="#l154.78"></a><span id="l154.78" class="difflineplus">+};</span>
<a href="#l154.79"></a><span id="l154.79"> </span>
<a href="#l154.80"></a><span id="l154.80"> /**</span>
<a href="#l154.81"></a><span id="l154.81">  * Swiped from mozilla/testing/mochitest/tests/SimpleTest/specialpowersAPI.js</span>
<a href="#l154.82"></a><span id="l154.82">  */</span>
<a href="#l154.83"></a><span id="l154.83"> function swapFactoryRegistration(CID, originalCID, contractID, newFactory) {</span>
<a href="#l154.84"></a><span id="l154.84">   let componentRegistrar = Cm.QueryInterface(Ci.nsIComponentRegistrar);</span>
<a href="#l154.85"></a><span id="l154.85"> </span>
<a href="#l154.86"></a><span id="l154.86">   if (originalCID == null) {</span>
<a href="#l154.87"></a><span id="l154.87">     if (contractID != null) {</span>
<a href="#l154.88"></a><span id="l154.88">       originalCID = componentRegistrar.contractIDToCID(contractID);</span>
<a href="#l154.89"></a><span id="l154.89">       void Cm.getClassObject(Cc[contractID], Ci.nsIFactory);</span>
<a href="#l154.90"></a><span id="l154.90">     } else {</span>
<a href="#l154.91"></a><span id="l154.91" class="difflineminus">-      return {'error': &quot;trying to register a new contract ID: Missing contractID&quot;};</span>
<a href="#l154.92"></a><span id="l154.92" class="difflineplus">+      return {&quot;error&quot;: &quot;trying to register a new contract ID: Missing contractID&quot;};</span>
<a href="#l154.93"></a><span id="l154.93">     }</span>
<a href="#l154.94"></a><span id="l154.94">     CID = UUIDGen.generateUUID();</span>
<a href="#l154.95"></a><span id="l154.95"> </span>
<a href="#l154.96"></a><span id="l154.96">     componentRegistrar.registerFactory(CID,</span>
<a href="#l154.97"></a><span id="l154.97">       &quot;&quot;,</span>
<a href="#l154.98"></a><span id="l154.98">       contractID,</span>
<a href="#l154.99"></a><span id="l154.99">       newFactory);</span>
<a href="#l154.100"></a><span id="l154.100">   } else {</span>
<a href="#l154.101"></a><span id="l154.101">     componentRegistrar.unregisterFactory(CID, newFactory);</span>
<a href="#l154.102"></a><span id="l154.102">     // Restore the original factory.</span>
<a href="#l154.103"></a><span id="l154.103">     componentRegistrar.registerFactory(originalCID,</span>
<a href="#l154.104"></a><span id="l154.104">       &quot;&quot;,</span>
<a href="#l154.105"></a><span id="l154.105">       contractID,</span>
<a href="#l154.106"></a><span id="l154.106">       null);</span>
<a href="#l154.107"></a><span id="l154.107">   }</span>
<a href="#l154.108"></a><span id="l154.108"> </span>
<a href="#l154.109"></a><span id="l154.109" class="difflineminus">-  return {cid: CID, originalCID: originalCID};</span>
<a href="#l154.110"></a><span id="l154.110" class="difflineplus">+  return {cid: CID, originalCID};</span>
<a href="#l154.111"></a><span id="l154.111"> }</span>
<a href="#l154.112"></a><span id="l154.112"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l155.1"></a><span id="l155.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-mouse-event-helpers.js</span>
<a href="#l155.2"></a><span id="l155.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-mouse-event-helpers.js</span>
<a href="#l155.3"></a><span id="l155.3" class="difflineat">@@ -1,25 +1,24 @@</span>
<a href="#l155.4"></a><span id="l155.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l155.5"></a><span id="l155.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l155.6"></a><span id="l155.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l155.7"></a><span id="l155.7"> </span>
<a href="#l155.8"></a><span id="l155.8"> &quot;use strict&quot;;</span>
<a href="#l155.9"></a><span id="l155.9"> </span>
<a href="#l155.10"></a><span id="l155.10"> var MODULE_NAME = &quot;mouse-event-helpers&quot;;</span>
<a href="#l155.11"></a><span id="l155.11" class="difflineminus">-</span>
<a href="#l155.12"></a><span id="l155.12"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l155.13"></a><span id="l155.13"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l155.14"></a><span id="l155.14"> </span>
<a href="#l155.15"></a><span id="l155.15"> var EventUtils = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/EventUtils.jsm&quot;);</span>
<a href="#l155.16"></a><span id="l155.16"> </span>
<a href="#l155.17"></a><span id="l155.17"> var fdh;</span>
<a href="#l155.18"></a><span id="l155.18"> </span>
<a href="#l155.19"></a><span id="l155.19"> function setupModule() {</span>
<a href="#l155.20"></a><span id="l155.20" class="difflineminus">-  fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l155.21"></a><span id="l155.21" class="difflineplus">+  fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l155.22"></a><span id="l155.22"> }</span>
<a href="#l155.23"></a><span id="l155.23"> </span>
<a href="#l155.24"></a><span id="l155.24"> function installInto(module) {</span>
<a href="#l155.25"></a><span id="l155.25">   setupModule();</span>
<a href="#l155.26"></a><span id="l155.26"> </span>
<a href="#l155.27"></a><span id="l155.27">   // Now copy helper functions</span>
<a href="#l155.28"></a><span id="l155.28">   module.drag_n_drop_element = drag_n_drop_element;</span>
<a href="#l155.29"></a><span id="l155.29">   module.synthesize_drag_start = synthesize_drag_start;</span>
<a href="#l155.30"></a><span id="l155.30" class="difflineat">@@ -43,134 +42,127 @@ function installInto(module) {</span>
<a href="#l155.31"></a><span id="l155.31">  *   in percent of the aDropObject width</span>
<a href="#l155.32"></a><span id="l155.32">  * @param {} aRelDropY</span>
<a href="#l155.33"></a><span id="l155.33">  *   the relative y-position the element is dropped over the aDropObject</span>
<a href="#l155.34"></a><span id="l155.34">  *   in percent of the aDropObject height</span>
<a href="#l155.35"></a><span id="l155.35">  * @param {XULElement} aListener</span>
<a href="#l155.36"></a><span id="l155.36">  *   the element who's drop target should be captured and returned.</span>
<a href="#l155.37"></a><span id="l155.37">  */</span>
<a href="#l155.38"></a><span id="l155.38"> function drag_n_drop_element(aDragObject, aDragWindow, aDropObject,</span>
<a href="#l155.39"></a><span id="l155.39" class="difflineminus">-                             aDropWindow, aRelDropX, aRelDropY, aListener)</span>
<a href="#l155.40"></a><span id="l155.40" class="difflineminus">-{</span>
<a href="#l155.41"></a><span id="l155.41" class="difflineplus">+                             aDropWindow, aRelDropX, aRelDropY, aListener) {</span>
<a href="#l155.42"></a><span id="l155.42">   let dt = synthesize_drag_start(aDragWindow, aDragObject, aListener);</span>
<a href="#l155.43"></a><span id="l155.43">   fdh.assert_true(dt, &quot;Drag target was undefined&quot;);</span>
<a href="#l155.44"></a><span id="l155.44"> </span>
<a href="#l155.45"></a><span id="l155.45">   synthesize_drag_over(aDropWindow, aDropObject, dt);</span>
<a href="#l155.46"></a><span id="l155.46"> </span>
<a href="#l155.47"></a><span id="l155.47">   let dropRect = aDropObject.getBoundingClientRect();</span>
<a href="#l155.48"></a><span id="l155.48">   synthesize_drop(aDropWindow, aDropObject, dt,</span>
<a href="#l155.49"></a><span id="l155.49" class="difflineminus">-      { screenX : aDropObject.screenX + (dropRect.width * aRelDropX),</span>
<a href="#l155.50"></a><span id="l155.50" class="difflineminus">-        screenY : aDropObject.screenY + (dropRect.height * aRelDropY)</span>
<a href="#l155.51"></a><span id="l155.51" class="difflineplus">+      { screenX: aDropObject.screenX + (dropRect.width * aRelDropX),</span>
<a href="#l155.52"></a><span id="l155.52" class="difflineplus">+        screenY: aDropObject.screenY + (dropRect.height * aRelDropY),</span>
<a href="#l155.53"></a><span id="l155.53">       });</span>
<a href="#l155.54"></a><span id="l155.54"> }</span>
<a href="#l155.55"></a><span id="l155.55"> </span>
<a href="#l155.56"></a><span id="l155.56"> /**</span>
<a href="#l155.57"></a><span id="l155.57">  * Starts a drag new session.</span>
<a href="#l155.58"></a><span id="l155.58">  * @param {} aWindow</span>
<a href="#l155.59"></a><span id="l155.59">  * @param {XULElement} aDispatcher</span>
<a href="#l155.60"></a><span id="l155.60">  *   the element from which the drag session should be started.</span>
<a href="#l155.61"></a><span id="l155.61">  * @param {XULElement} aListener</span>
<a href="#l155.62"></a><span id="l155.62">  *   the element who's drop target should be captured and returned.</span>
<a href="#l155.63"></a><span id="l155.63">  * @return {nsIDataTransfer}</span>
<a href="#l155.64"></a><span id="l155.64">  *   returns the DataTransfer Object of captured by aListener.</span>
<a href="#l155.65"></a><span id="l155.65">  */</span>
<a href="#l155.66"></a><span id="l155.66" class="difflineminus">-function synthesize_drag_start(aWindow, aDispatcher, aListener)</span>
<a href="#l155.67"></a><span id="l155.67" class="difflineminus">-{</span>
<a href="#l155.68"></a><span id="l155.68" class="difflineplus">+function synthesize_drag_start(aWindow, aDispatcher, aListener) {</span>
<a href="#l155.69"></a><span id="l155.69">   let dt;</span>
<a href="#l155.70"></a><span id="l155.70"> </span>
<a href="#l155.71"></a><span id="l155.71">   let trapDrag = function(event) {</span>
<a href="#l155.72"></a><span id="l155.72" class="difflineminus">-</span>
<a href="#l155.73"></a><span id="l155.73">     if (!event.dataTransfer)</span>
<a href="#l155.74"></a><span id="l155.74">       throw new Error(&quot;no DataTransfer&quot;);</span>
<a href="#l155.75"></a><span id="l155.75"> </span>
<a href="#l155.76"></a><span id="l155.76">     dt = event.dataTransfer;</span>
<a href="#l155.77"></a><span id="l155.77"> </span>
<a href="#l155.78"></a><span id="l155.78">     event.preventDefault();</span>
<a href="#l155.79"></a><span id="l155.79">   };</span>
<a href="#l155.80"></a><span id="l155.80"> </span>
<a href="#l155.81"></a><span id="l155.81">   aListener.addEventListener(&quot;dragstart&quot;, trapDrag, true);</span>
<a href="#l155.82"></a><span id="l155.82"> </span>
<a href="#l155.83"></a><span id="l155.83" class="difflineminus">-  EventUtils.synthesizeMouse(aDispatcher, 5, 5, {type:&quot;mousedown&quot;}, aWindow);</span>
<a href="#l155.84"></a><span id="l155.84" class="difflineminus">-  EventUtils.synthesizeMouse(aDispatcher, 5, 10, {type:&quot;mousemove&quot;}, aWindow);</span>
<a href="#l155.85"></a><span id="l155.85" class="difflineminus">-  EventUtils.synthesizeMouse(aDispatcher, 5, 15, {type:&quot;mousemove&quot;}, aWindow);</span>
<a href="#l155.86"></a><span id="l155.86" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 5, {type: &quot;mousedown&quot;}, aWindow);</span>
<a href="#l155.87"></a><span id="l155.87" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 10, {type: &quot;mousemove&quot;}, aWindow);</span>
<a href="#l155.88"></a><span id="l155.88" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 15, {type: &quot;mousemove&quot;}, aWindow);</span>
<a href="#l155.89"></a><span id="l155.89"> </span>
<a href="#l155.90"></a><span id="l155.90">   aListener.removeEventListener(&quot;dragstart&quot;, trapDrag, true);</span>
<a href="#l155.91"></a><span id="l155.91"> </span>
<a href="#l155.92"></a><span id="l155.92">   return dt;</span>
<a href="#l155.93"></a><span id="l155.93"> }</span>
<a href="#l155.94"></a><span id="l155.94"> </span>
<a href="#l155.95"></a><span id="l155.95"> /**</span>
<a href="#l155.96"></a><span id="l155.96">  * Synthesizes a drag over event.</span>
<a href="#l155.97"></a><span id="l155.97">  * @param {} aWindow</span>
<a href="#l155.98"></a><span id="l155.98">  * @param {XULElement} aDispatcher</span>
<a href="#l155.99"></a><span id="l155.99">  *   the element from which the drag session should be started.</span>
<a href="#l155.100"></a><span id="l155.100">  * @param {nsIDataTransfer} aDt</span>
<a href="#l155.101"></a><span id="l155.101">  *   the DataTransfer Object of captured by listener.</span>
<a href="#l155.102"></a><span id="l155.102">  * @param {} aArgs</span>
<a href="#l155.103"></a><span id="l155.103">  *   arguments passed to the mouse event.</span>
<a href="#l155.104"></a><span id="l155.104">  */</span>
<a href="#l155.105"></a><span id="l155.105" class="difflineminus">-function synthesize_drag_over(aWindow, aDispatcher, aDt, aArgs)</span>
<a href="#l155.106"></a><span id="l155.106" class="difflineminus">-{</span>
<a href="#l155.107"></a><span id="l155.107" class="difflineplus">+function synthesize_drag_over(aWindow, aDispatcher, aDt, aArgs) {</span>
<a href="#l155.108"></a><span id="l155.108">   _synthesizeDragEvent(&quot;dragover&quot;, aWindow, aDispatcher, aDt, aArgs);</span>
<a href="#l155.109"></a><span id="l155.109"> }</span>
<a href="#l155.110"></a><span id="l155.110"> </span>
<a href="#l155.111"></a><span id="l155.111"> /**</span>
<a href="#l155.112"></a><span id="l155.112">  * Synthesizes a drag end event.</span>
<a href="#l155.113"></a><span id="l155.113">  * @param {} aWindow</span>
<a href="#l155.114"></a><span id="l155.114">  * @param {XULElement} aDispatcher</span>
<a href="#l155.115"></a><span id="l155.115">  *   the element from which the drag session should be started.</span>
<a href="#l155.116"></a><span id="l155.116">  * @param {nsIDataTransfer} aDt</span>
<a href="#l155.117"></a><span id="l155.117">  *   the DataTransfer Object of captured by listener.</span>
<a href="#l155.118"></a><span id="l155.118">  * @param {} aArgs</span>
<a href="#l155.119"></a><span id="l155.119">  *   arguments passed to the mouse event.</span>
<a href="#l155.120"></a><span id="l155.120">  */</span>
<a href="#l155.121"></a><span id="l155.121" class="difflineminus">-function synthesize_drag_end(aWindow, aDispatcher, aListener, aDt, aArgs)</span>
<a href="#l155.122"></a><span id="l155.122" class="difflineminus">-{</span>
<a href="#l155.123"></a><span id="l155.123" class="difflineplus">+function synthesize_drag_end(aWindow, aDispatcher, aListener, aDt, aArgs) {</span>
<a href="#l155.124"></a><span id="l155.124">   _synthesizeDragEvent(&quot;dragend&quot;, aWindow, aListener, aDt, aArgs);</span>
<a href="#l155.125"></a><span id="l155.125"> </span>
<a href="#l155.126"></a><span id="l155.126" class="difflineminus">-  //Ensure drag has ended.</span>
<a href="#l155.127"></a><span id="l155.127" class="difflineminus">-  EventUtils.synthesizeMouse(aDispatcher, 5, 5, {type:&quot;mousemove&quot;}, aWindow);</span>
<a href="#l155.128"></a><span id="l155.128" class="difflineminus">-  EventUtils.synthesizeMouse(aDispatcher, 5, 10, {type:&quot;mousemove&quot;}, aWindow);</span>
<a href="#l155.129"></a><span id="l155.129" class="difflineminus">-  EventUtils.synthesizeMouse(aDispatcher, 5, 5, {type:&quot;mouseup&quot;}, aWindow);</span>
<a href="#l155.130"></a><span id="l155.130" class="difflineplus">+  // Ensure drag has ended.</span>
<a href="#l155.131"></a><span id="l155.131" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 5, {type: &quot;mousemove&quot;}, aWindow);</span>
<a href="#l155.132"></a><span id="l155.132" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 10, {type: &quot;mousemove&quot;}, aWindow);</span>
<a href="#l155.133"></a><span id="l155.133" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 5, {type: &quot;mouseup&quot;}, aWindow);</span>
<a href="#l155.134"></a><span id="l155.134"> }</span>
<a href="#l155.135"></a><span id="l155.135"> </span>
<a href="#l155.136"></a><span id="l155.136"> /**</span>
<a href="#l155.137"></a><span id="l155.137">  * Synthesizes a drop event.</span>
<a href="#l155.138"></a><span id="l155.138">  * @param {} aWindow</span>
<a href="#l155.139"></a><span id="l155.139">  * @param {XULElement} aDispatcher</span>
<a href="#l155.140"></a><span id="l155.140">  *   the element from which the drag session should be started.</span>
<a href="#l155.141"></a><span id="l155.141">  * @param {nsIDataTransfer} aDt</span>
<a href="#l155.142"></a><span id="l155.142">  *   the DataTransfer Object of captured by listener.</span>
<a href="#l155.143"></a><span id="l155.143">  * @param {} aArgs</span>
<a href="#l155.144"></a><span id="l155.144">  *   arguments passed to the mouse event.</span>
<a href="#l155.145"></a><span id="l155.145">  */</span>
<a href="#l155.146"></a><span id="l155.146" class="difflineminus">-function synthesize_drop(aWindow, aDispatcher, aDt, aArgs)</span>
<a href="#l155.147"></a><span id="l155.147" class="difflineminus">-{</span>
<a href="#l155.148"></a><span id="l155.148" class="difflineplus">+function synthesize_drop(aWindow, aDispatcher, aDt, aArgs) {</span>
<a href="#l155.149"></a><span id="l155.149">   _synthesizeDragEvent(&quot;drop&quot;, aWindow, aDispatcher, aDt, aArgs);</span>
<a href="#l155.150"></a><span id="l155.150"> </span>
<a href="#l155.151"></a><span id="l155.151">   // Ensure drag has ended.</span>
<a href="#l155.152"></a><span id="l155.152" class="difflineminus">-  EventUtils.synthesizeMouse(aDispatcher, 5, 5, {type:&quot;mousemove&quot;}, aWindow);</span>
<a href="#l155.153"></a><span id="l155.153" class="difflineminus">-  EventUtils.synthesizeMouse(aDispatcher, 5, 10, {type:&quot;mousemove&quot;}, aWindow);</span>
<a href="#l155.154"></a><span id="l155.154" class="difflineminus">-  EventUtils.synthesizeMouse(aDispatcher, 5, 5, {type:&quot;mouseup&quot;}, aWindow);</span>
<a href="#l155.155"></a><span id="l155.155" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 5, {type: &quot;mousemove&quot;}, aWindow);</span>
<a href="#l155.156"></a><span id="l155.156" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 10, {type: &quot;mousemove&quot;}, aWindow);</span>
<a href="#l155.157"></a><span id="l155.157" class="difflineplus">+  EventUtils.synthesizeMouse(aDispatcher, 5, 5, {type: &quot;mouseup&quot;}, aWindow);</span>
<a href="#l155.158"></a><span id="l155.158"> }</span>
<a href="#l155.159"></a><span id="l155.159"> </span>
<a href="#l155.160"></a><span id="l155.160"> /**</span>
<a href="#l155.161"></a><span id="l155.161">  * Private function: Synthesizes a specified drag event.</span>
<a href="#l155.162"></a><span id="l155.162">  * @param {} aType</span>
<a href="#l155.163"></a><span id="l155.163">  *   the type of the drag event to be synthesiyzed.</span>
<a href="#l155.164"></a><span id="l155.164">  * @param {} aWindow</span>
<a href="#l155.165"></a><span id="l155.165">  * @param {XULElement} aDispatcher</span>
<a href="#l155.166"></a><span id="l155.166">  *   the element from which the drag session should be started.</span>
<a href="#l155.167"></a><span id="l155.167">  * @param {nsIDataTransfer} aDt</span>
<a href="#l155.168"></a><span id="l155.168">  *   the DataTransfer Object of captured by listener.</span>
<a href="#l155.169"></a><span id="l155.169">  * @param {} aArgs</span>
<a href="#l155.170"></a><span id="l155.170">  *   arguments passed to the mouse event.</span>
<a href="#l155.171"></a><span id="l155.171">  */</span>
<a href="#l155.172"></a><span id="l155.172" class="difflineminus">-function _synthesizeDragEvent(aType, aWindow, aDispatcher, aDt, aArgs)</span>
<a href="#l155.173"></a><span id="l155.173" class="difflineminus">-{</span>
<a href="#l155.174"></a><span id="l155.174" class="difflineplus">+function _synthesizeDragEvent(aType, aWindow, aDispatcher, aDt, aArgs) {</span>
<a href="#l155.175"></a><span id="l155.175">   let screenX;</span>
<a href="#l155.176"></a><span id="l155.176">   if (aArgs &amp;&amp; (&quot;screenX&quot; in aArgs))</span>
<a href="#l155.177"></a><span id="l155.177">     screenX = aArgs.screenX;</span>
<a href="#l155.178"></a><span id="l155.178">   else</span>
<a href="#l155.179"></a><span id="l155.179">     screenX = aDispatcher.screenX;</span>
<a href="#l155.180"></a><span id="l155.180"> </span>
<a href="#l155.181"></a><span id="l155.181">   let screenY;</span>
<a href="#l155.182"></a><span id="l155.182">   if (aArgs &amp;&amp; (&quot;screenY&quot; in aArgs))</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l156.1"></a><span id="l156.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js</span>
<a href="#l156.2"></a><span id="l156.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js</span>
<a href="#l156.3"></a><span id="l156.3" class="difflineat">@@ -1,31 +1,29 @@</span>
<a href="#l156.4"></a><span id="l156.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l156.5"></a><span id="l156.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l156.6"></a><span id="l156.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l156.7"></a><span id="l156.7"> </span>
<a href="#l156.8"></a><span id="l156.8"> &quot;use strict&quot;;</span>
<a href="#l156.9"></a><span id="l156.9"> </span>
<a href="#l156.10"></a><span id="l156.10"> var MODULE_NAME = &quot;newmailaccount-helpers&quot;;</span>
<a href="#l156.11"></a><span id="l156.11" class="difflineminus">-</span>
<a href="#l156.12"></a><span id="l156.12"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l156.13"></a><span id="l156.13" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;keyboard-helpers&quot;,</span>
<a href="#l156.14"></a><span id="l156.14" class="difflineminus">-                       &quot;dom-helpers&quot;];</span>
<a href="#l156.15"></a><span id="l156.15" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;keyboard-helpers&quot;, &quot;dom-helpers&quot;];</span>
<a href="#l156.16"></a><span id="l156.16"> </span>
<a href="#l156.17"></a><span id="l156.17"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l156.18"></a><span id="l156.18"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l156.19"></a><span id="l156.19"> var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l156.20"></a><span id="l156.20"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l156.21"></a><span id="l156.21"> </span>
<a href="#l156.22"></a><span id="l156.22"> var mc, fdh, kbh, dh;</span>
<a href="#l156.23"></a><span id="l156.23"> </span>
<a href="#l156.24"></a><span id="l156.24"> function setupModule(module) {</span>
<a href="#l156.25"></a><span id="l156.25" class="difflineminus">-  fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l156.26"></a><span id="l156.26" class="difflineplus">+  fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l156.27"></a><span id="l156.27">   fdh.installInto(module);</span>
<a href="#l156.28"></a><span id="l156.28" class="difflineminus">-  kbh = collector.getModule('keyboard-helpers');</span>
<a href="#l156.29"></a><span id="l156.29" class="difflineplus">+  kbh = collector.getModule(&quot;keyboard-helpers&quot;);</span>
<a href="#l156.30"></a><span id="l156.30">   dh = collector.getModule(&quot;dom-helpers&quot;);</span>
<a href="#l156.31"></a><span id="l156.31">   mc = fdh.mc;</span>
<a href="#l156.32"></a><span id="l156.32"> }</span>
<a href="#l156.33"></a><span id="l156.33"> </span>
<a href="#l156.34"></a><span id="l156.34"> function installInto(module) {</span>
<a href="#l156.35"></a><span id="l156.35">   setupModule(module);</span>
<a href="#l156.36"></a><span id="l156.36"> </span>
<a href="#l156.37"></a><span id="l156.37">   module.wait_for_provider_list_loaded = wait_for_provider_list_loaded;</span>
<a href="#l156.38"></a><span id="l156.38" class="difflineat">@@ -72,19 +70,19 @@ function open_provisioner_window() {</span>
<a href="#l156.39"></a><span id="l156.39">  */</span>
<a href="#l156.40"></a><span id="l156.40"> function poll_for_wizard_window(aController) {</span>
<a href="#l156.41"></a><span id="l156.41">   return Services.wm.getMostRecentWindow(&quot;mail:autoconfig&quot;);</span>
<a href="#l156.42"></a><span id="l156.42"> }</span>
<a href="#l156.43"></a><span id="l156.43"> </span>
<a href="#l156.44"></a><span id="l156.44"> /* Waits until the existing email account setup wizard is closed.</span>
<a href="#l156.45"></a><span id="l156.45">  */</span>
<a href="#l156.46"></a><span id="l156.46"> function wait_for_the_wizard_to_be_closed(aController) {</span>
<a href="#l156.47"></a><span id="l156.47" class="difflineminus">-  aController.waitFor(function () {</span>
<a href="#l156.48"></a><span id="l156.48" class="difflineplus">+  aController.waitFor(function() {</span>
<a href="#l156.49"></a><span id="l156.49">     let w = poll_for_wizard_window(aController);</span>
<a href="#l156.50"></a><span id="l156.50" class="difflineminus">-    return w == null</span>
<a href="#l156.51"></a><span id="l156.51" class="difflineplus">+    return w == null;</span>
<a href="#l156.52"></a><span id="l156.52">   });</span>
<a href="#l156.53"></a><span id="l156.53"> }</span>
<a href="#l156.54"></a><span id="l156.54"> </span>
<a href="#l156.55"></a><span id="l156.55"> /* Asserts that a series of links are currently visible. aLinks can either</span>
<a href="#l156.56"></a><span id="l156.56">  * be a single link, or an Array of links.</span>
<a href="#l156.57"></a><span id="l156.57">  */</span>
<a href="#l156.58"></a><span id="l156.58"> function assert_links_shown(aController, aLinks) {</span>
<a href="#l156.59"></a><span id="l156.59">   if (!Array.isArray(aLinks))</span>
<a href="#l156.60"></a><span id="l156.60" class="difflineat">@@ -150,50 +148,50 @@ function remove_email_account(aAddress) </span>
<a href="#l156.61"></a><span id="l156.61">  * Helper function that finds the search input, clears it of any content,</span>
<a href="#l156.62"></a><span id="l156.62">  * and then manually types aName into the field.</span>
<a href="#l156.63"></a><span id="l156.63">  *</span>
<a href="#l156.64"></a><span id="l156.64">  * @param aController the controller for the Account Provisioner dialog.</span>
<a href="#l156.65"></a><span id="l156.65">  * @param aName the name to type in.</span>
<a href="#l156.66"></a><span id="l156.66">  */</span>
<a href="#l156.67"></a><span id="l156.67"> function type_in_search_name(aController, aName) {</span>
<a href="#l156.68"></a><span id="l156.68">   aController.e(&quot;name&quot;).focus();</span>
<a href="#l156.69"></a><span id="l156.69" class="difflineminus">-  aController.keypress(null, 'a', {accelKey: true});</span>
<a href="#l156.70"></a><span id="l156.70" class="difflineminus">-  aController.keypress(null, 'VK_BACK_SPACE', {});</span>
<a href="#l156.71"></a><span id="l156.71" class="difflineplus">+  aController.keypress(null, &quot;a&quot;, {accelKey: true});</span>
<a href="#l156.72"></a><span id="l156.72" class="difflineplus">+  aController.keypress(null, &quot;VK_BACK_SPACE&quot;, {});</span>
<a href="#l156.73"></a><span id="l156.73"> </span>
<a href="#l156.74"></a><span id="l156.74">   kbh.input_value(aController, aName);</span>
<a href="#l156.75"></a><span id="l156.75"> }</span>
<a href="#l156.76"></a><span id="l156.76"> </span>
<a href="#l156.77"></a><span id="l156.77"> /* A listener for the Error Console, which allows us to ensure that certain</span>
<a href="#l156.78"></a><span id="l156.78">  * messages appear in the console.</span>
<a href="#l156.79"></a><span id="l156.79">  */</span>
<a href="#l156.80"></a><span id="l156.80"> var gConsoleListener = {</span>
<a href="#l156.81"></a><span id="l156.81">   QueryInterface: ChromeUtils.generateQI([Ci.nsIConsoleListener]),</span>
<a href="#l156.82"></a><span id="l156.82">   _msg: null,</span>
<a href="#l156.83"></a><span id="l156.83">   _sawMsg: false,</span>
<a href="#l156.84"></a><span id="l156.84"> </span>
<a href="#l156.85"></a><span id="l156.85" class="difflineminus">-  observe: function(aMsg) {</span>
<a href="#l156.86"></a><span id="l156.86" class="difflineplus">+  observe(aMsg) {</span>
<a href="#l156.87"></a><span id="l156.87">     if (!this._msg)</span>
<a href="#l156.88"></a><span id="l156.88">       return;</span>
<a href="#l156.89"></a><span id="l156.89"> </span>
<a href="#l156.90"></a><span id="l156.90">     this._sawMsg |= (aMsg.message.includes(this._msg));</span>
<a href="#l156.91"></a><span id="l156.91">   },</span>
<a href="#l156.92"></a><span id="l156.92"> </span>
<a href="#l156.93"></a><span id="l156.93" class="difflineminus">-  listenFor: function(aMsg) {</span>
<a href="#l156.94"></a><span id="l156.94" class="difflineplus">+  listenFor(aMsg) {</span>
<a href="#l156.95"></a><span id="l156.95">     this._msg = aMsg;</span>
<a href="#l156.96"></a><span id="l156.96">   },</span>
<a href="#l156.97"></a><span id="l156.97"> </span>
<a href="#l156.98"></a><span id="l156.98" class="difflineminus">-  reset: function() {</span>
<a href="#l156.99"></a><span id="l156.99" class="difflineplus">+  reset() {</span>
<a href="#l156.100"></a><span id="l156.100">     this._msg = null;</span>
<a href="#l156.101"></a><span id="l156.101">     this._sawMsg = false;</span>
<a href="#l156.102"></a><span id="l156.102">   },</span>
<a href="#l156.103"></a><span id="l156.103"> </span>
<a href="#l156.104"></a><span id="l156.104">   get sawMsg() {</span>
<a href="#l156.105"></a><span id="l156.105">     return this._sawMsg;</span>
<a href="#l156.106"></a><span id="l156.106">   },</span>
<a href="#l156.107"></a><span id="l156.107"> </span>
<a href="#l156.108"></a><span id="l156.108" class="difflineminus">-  wait: function() {</span>
<a href="#l156.109"></a><span id="l156.109" class="difflineplus">+  wait() {</span>
<a href="#l156.110"></a><span id="l156.110">     let self = this;</span>
<a href="#l156.111"></a><span id="l156.111">     mc.waitFor(function() {</span>
<a href="#l156.112"></a><span id="l156.112">       return self.sawMsg;</span>
<a href="#l156.113"></a><span id="l156.113">     },</span>
<a href="#l156.114"></a><span id="l156.114">     &quot;Timed out waiting for console message: &quot; + this._msg);</span>
<a href="#l156.115"></a><span id="l156.115">   },</span>
<a href="#l156.116"></a><span id="l156.116" class="difflineminus">-}</span>
<a href="#l156.117"></a><span id="l156.117" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l157.1"></a><span id="l157.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-nntp-helpers.js</span>
<a href="#l157.2"></a><span id="l157.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-nntp-helpers.js</span>
<a href="#l157.3"></a><span id="l157.3" class="difflineat">@@ -1,58 +1,57 @@</span>
<a href="#l157.4"></a><span id="l157.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l157.5"></a><span id="l157.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l157.6"></a><span id="l157.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l157.7"></a><span id="l157.7"> </span>
<a href="#l157.8"></a><span id="l157.8"> &quot;use strict&quot;;</span>
<a href="#l157.9"></a><span id="l157.9"> </span>
<a href="#l157.10"></a><span id="l157.10"> var MODULE_NAME = &quot;nntp-helpers&quot;;</span>
<a href="#l157.11"></a><span id="l157.11" class="difflineminus">-</span>
<a href="#l157.12"></a><span id="l157.12"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l157.13"></a><span id="l157.13"> var MODULES_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l157.14"></a><span id="l157.14"> </span>
<a href="#l157.15"></a><span id="l157.15"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l157.16"></a><span id="l157.16"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l157.17"></a><span id="l157.17"> </span>
<a href="#l157.18"></a><span id="l157.18"> var kSimpleNewsArticle =</span>
<a href="#l157.19"></a><span id="l157.19" class="difflineminus">-  &quot;From: John Doe &lt;john.doe@example.com&gt;\n&quot;+</span>
<a href="#l157.20"></a><span id="l157.20" class="difflineminus">-  &quot;Date: Sat, 24 Mar 1990 10:59:24 -0500\n&quot;+</span>
<a href="#l157.21"></a><span id="l157.21" class="difflineminus">-  &quot;Newsgroups: test.subscribe.simple\n&quot;+</span>
<a href="#l157.22"></a><span id="l157.22" class="difflineminus">-  &quot;Subject: H2G2 -- What does it mean?\n&quot;+</span>
<a href="#l157.23"></a><span id="l157.23" class="difflineminus">-  &quot;Message-ID: &lt;TSS1@nntp.invalid&gt;\n&quot;+</span>
<a href="#l157.24"></a><span id="l157.24" class="difflineminus">-  &quot;\n&quot;+</span>
<a href="#l157.25"></a><span id="l157.25" class="difflineplus">+  &quot;From: John Doe &lt;john.doe@example.com&gt;\n&quot; +</span>
<a href="#l157.26"></a><span id="l157.26" class="difflineplus">+  &quot;Date: Sat, 24 Mar 1990 10:59:24 -0500\n&quot; +</span>
<a href="#l157.27"></a><span id="l157.27" class="difflineplus">+  &quot;Newsgroups: test.subscribe.simple\n&quot; +</span>
<a href="#l157.28"></a><span id="l157.28" class="difflineplus">+  &quot;Subject: H2G2 -- What does it mean?\n&quot; +</span>
<a href="#l157.29"></a><span id="l157.29" class="difflineplus">+  &quot;Message-ID: &lt;TSS1@nntp.invalid&gt;\n&quot; +</span>
<a href="#l157.30"></a><span id="l157.30" class="difflineplus">+  &quot;\n&quot; +</span>
<a href="#l157.31"></a><span id="l157.31">   &quot;What does the acronym H2G2 stand for? I've seen it before...\n&quot;;</span>
<a href="#l157.32"></a><span id="l157.32"> </span>
<a href="#l157.33"></a><span id="l157.33"> // The groups to set up on the fake server.</span>
<a href="#l157.34"></a><span id="l157.34"> // It is an array of tuples, where the first element is the group name and the</span>
<a href="#l157.35"></a><span id="l157.35"> // second element is whether or not we should subscribe to it.</span>
<a href="#l157.36"></a><span id="l157.36"> var groups = [</span>
<a href="#l157.37"></a><span id="l157.37">   [&quot;test.empty&quot;, false],</span>
<a href="#l157.38"></a><span id="l157.38">   [&quot;test.subscribe.empty&quot;, true],</span>
<a href="#l157.39"></a><span id="l157.39">   [&quot;test.subscribe.simple&quot;, true],</span>
<a href="#l157.40"></a><span id="l157.40" class="difflineminus">-  [&quot;test.filter&quot;, true]</span>
<a href="#l157.41"></a><span id="l157.41" class="difflineplus">+  [&quot;test.filter&quot;, true],</span>
<a href="#l157.42"></a><span id="l157.42"> ];</span>
<a href="#l157.43"></a><span id="l157.43"> </span>
<a href="#l157.44"></a><span id="l157.44"> var folderDisplayHelper;</span>
<a href="#l157.45"></a><span id="l157.45"> var mc;</span>
<a href="#l157.46"></a><span id="l157.46"> var windowHelper;</span>
<a href="#l157.47"></a><span id="l157.47"> </span>
<a href="#l157.48"></a><span id="l157.48"> var testHelperModule;</span>
<a href="#l157.49"></a><span id="l157.49"> </span>
<a href="#l157.50"></a><span id="l157.50"> function setupModule() {</span>
<a href="#l157.51"></a><span id="l157.51" class="difflineminus">-  folderDisplayHelper = collector.getModule('folder-display-helpers');</span>
<a href="#l157.52"></a><span id="l157.52" class="difflineplus">+  folderDisplayHelper = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l157.53"></a><span id="l157.53">   mc = folderDisplayHelper.mc;</span>
<a href="#l157.54"></a><span id="l157.54" class="difflineminus">-  windowHelper = collector.getModule('window-helpers');</span>
<a href="#l157.55"></a><span id="l157.55" class="difflineplus">+  windowHelper = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l157.56"></a><span id="l157.56">   testHelperModule = {</span>
<a href="#l157.57"></a><span id="l157.57" class="difflineminus">-    Cc: Cc,</span>
<a href="#l157.58"></a><span id="l157.58" class="difflineminus">-    Ci: Ci,</span>
<a href="#l157.59"></a><span id="l157.59" class="difflineminus">-    Cu: Cu,</span>
<a href="#l157.60"></a><span id="l157.60" class="difflineplus">+    Cc,</span>
<a href="#l157.61"></a><span id="l157.61" class="difflineplus">+    Ci,</span>
<a href="#l157.62"></a><span id="l157.62" class="difflineplus">+    Cu,</span>
<a href="#l157.63"></a><span id="l157.63">     // fake some xpcshell stuff</span>
<a href="#l157.64"></a><span id="l157.64">     _TEST_FILE: [&quot;mozmill&quot;],</span>
<a href="#l157.65"></a><span id="l157.65" class="difflineminus">-    do_throw: function(aMsg) {</span>
<a href="#l157.66"></a><span id="l157.66" class="difflineplus">+    do_throw(aMsg) {</span>
<a href="#l157.67"></a><span id="l157.67">       throw new Error(aMsg);</span>
<a href="#l157.68"></a><span id="l157.68">     },</span>
<a href="#l157.69"></a><span id="l157.69">   };</span>
<a href="#l157.70"></a><span id="l157.70">   folderDisplayHelper.load_via_src_path(&quot;fakeserver/nntpd.js&quot;, testHelperModule);</span>
<a href="#l157.71"></a><span id="l157.71">   folderDisplayHelper.load_via_src_path(&quot;fakeserver/maild.js&quot;, testHelperModule);</span>
<a href="#l157.72"></a><span id="l157.72"> }</span>
<a href="#l157.73"></a><span id="l157.73"> </span>
<a href="#l157.74"></a><span id="l157.74"> function installInto(module) {</span>
<a href="#l157.75"></a><span id="l157.75" class="difflineat">@@ -66,17 +65,17 @@ function installInto(module) {</span>
<a href="#l157.76"></a><span id="l157.76">   module.shutdownNNTPServer = shutdownNNTPServer;</span>
<a href="#l157.77"></a><span id="l157.77"> }</span>
<a href="#l157.78"></a><span id="l157.78"> </span>
<a href="#l157.79"></a><span id="l157.79"> </span>
<a href="#l157.80"></a><span id="l157.80"> // Sets up the NNTP daemon object for use in fake server</span>
<a href="#l157.81"></a><span id="l157.81"> function setupNNTPDaemon() {</span>
<a href="#l157.82"></a><span id="l157.82">   var daemon = new testHelperModule.nntpDaemon();</span>
<a href="#l157.83"></a><span id="l157.83"> </span>
<a href="#l157.84"></a><span id="l157.84" class="difflineminus">-  groups.forEach(function (element) {</span>
<a href="#l157.85"></a><span id="l157.85" class="difflineplus">+  groups.forEach(function(element) {</span>
<a href="#l157.86"></a><span id="l157.86">     daemon.addGroup(element[0]);</span>
<a href="#l157.87"></a><span id="l157.87">   });</span>
<a href="#l157.88"></a><span id="l157.88"> </span>
<a href="#l157.89"></a><span id="l157.89">   var article = new testHelperModule.newsArticle(kSimpleNewsArticle);</span>
<a href="#l157.90"></a><span id="l157.90">   daemon.addArticleToGroup(article, &quot;test.subscribe.simple&quot;, 1);</span>
<a href="#l157.91"></a><span id="l157.91"> </span>
<a href="#l157.92"></a><span id="l157.92">   return daemon;</span>
<a href="#l157.93"></a><span id="l157.93"> }</span>
<a href="#l157.94"></a><span id="l157.94" class="difflineat">@@ -100,24 +99,24 @@ function shutdownNNTPServer(server) {</span>
<a href="#l157.95"></a><span id="l157.95"> }</span>
<a href="#l157.96"></a><span id="l157.96"> </span>
<a href="#l157.97"></a><span id="l157.97"> // Enable strict threading</span>
<a href="#l157.98"></a><span id="l157.98"> Services.prefs.setBoolPref(&quot;mail.strict_threading&quot;, true);</span>
<a href="#l157.99"></a><span id="l157.99"> </span>
<a href="#l157.100"></a><span id="l157.100"> </span>
<a href="#l157.101"></a><span id="l157.101"> // Make sure we don't try to use a protected port. I like adding 1024 to the</span>
<a href="#l157.102"></a><span id="l157.102"> // default port when doing so...</span>
<a href="#l157.103"></a><span id="l157.103" class="difflineminus">-var NNTP_PORT = 1024+119;</span>
<a href="#l157.104"></a><span id="l157.104" class="difflineplus">+var NNTP_PORT = 1024 + 119;</span>
<a href="#l157.105"></a><span id="l157.105"> </span>
<a href="#l157.106"></a><span id="l157.106"> var _server = null;</span>
<a href="#l157.107"></a><span id="l157.107"> </span>
<a href="#l157.108"></a><span id="l157.108"> function subscribeServer(incomingServer) {</span>
<a href="#l157.109"></a><span id="l157.109">   // Subscribe to newsgroups</span>
<a href="#l157.110"></a><span id="l157.110">   incomingServer.QueryInterface(Ci.nsINntpIncomingServer);</span>
<a href="#l157.111"></a><span id="l157.111" class="difflineminus">-  groups.forEach(function (element) {</span>
<a href="#l157.112"></a><span id="l157.112" class="difflineplus">+  groups.forEach(function(element) {</span>
<a href="#l157.113"></a><span id="l157.113">       if (element[1])</span>
<a href="#l157.114"></a><span id="l157.114">         incomingServer.subscribeToNewsgroup(element[0]);</span>
<a href="#l157.115"></a><span id="l157.115">     });</span>
<a href="#l157.116"></a><span id="l157.116">   // Only allow one connection</span>
<a href="#l157.117"></a><span id="l157.117">   incomingServer.maximumConnectionsNumber = 1;</span>
<a href="#l157.118"></a><span id="l157.118"> }</span>
<a href="#l157.119"></a><span id="l157.119"> </span>
<a href="#l157.120"></a><span id="l157.120"> // Sets up the client-side portion of fakeserver</span>
<a href="#l157.121"></a><span id="l157.121" class="difflineat">@@ -129,29 +128,16 @@ function setupLocalServer(port) {</span>
<a href="#l157.122"></a><span id="l157.122">   server.port = port;</span>
<a href="#l157.123"></a><span id="l157.123">   server.valid = false;</span>
<a href="#l157.124"></a><span id="l157.124"> </span>
<a href="#l157.125"></a><span id="l157.125">   var account = MailServices.accounts.createAccount();</span>
<a href="#l157.126"></a><span id="l157.126">   account.incomingServer = server;</span>
<a href="#l157.127"></a><span id="l157.127">   server.valid = true;</span>
<a href="#l157.128"></a><span id="l157.128">   // hack to cause an account loaded notification now the server is valid</span>
<a href="#l157.129"></a><span id="l157.129">   // (see also Bug 903804)</span>
<a href="#l157.130"></a><span id="l157.130" class="difflineminus">-  account.incomingServer = account.incomingServer;</span>
<a href="#l157.131"></a><span id="l157.131" class="difflineplus">+  account.incomingServer = account.incomingServer; // eslint-disable-line no-self-assign</span>
<a href="#l157.132"></a><span id="l157.132"> </span>
<a href="#l157.133"></a><span id="l157.133">   subscribeServer(server);</span>
<a href="#l157.134"></a><span id="l157.134"> </span>
<a href="#l157.135"></a><span id="l157.135">   _server = server;</span>
<a href="#l157.136"></a><span id="l157.136"> </span>
<a href="#l157.137"></a><span id="l157.137">   return server;</span>
<a href="#l157.138"></a><span id="l157.138"> }</span>
<a href="#l157.139"></a><span id="l157.139" class="difflineminus">-</span>
<a href="#l157.140"></a><span id="l157.140" class="difflineminus">-var URLCreator = MailServices.nntp.QueryInterface(Ci.nsIProtocolHandler);</span>
<a href="#l157.141"></a><span id="l157.141" class="difflineminus">-</span>
<a href="#l157.142"></a><span id="l157.142" class="difflineminus">-function create_post(baseURL, file) {</span>
<a href="#l157.143"></a><span id="l157.143" class="difflineminus">-  var url = URLCreator.newURI(baseURL);</span>
<a href="#l157.144"></a><span id="l157.144" class="difflineminus">-  url.QueryInterface(Ci.nsINntpUrl);</span>
<a href="#l157.145"></a><span id="l157.145" class="difflineminus">-</span>
<a href="#l157.146"></a><span id="l157.146" class="difflineminus">-  var post = Cc[&quot;@mozilla.org/messenger/nntpnewsgrouppost;1&quot;]</span>
<a href="#l157.147"></a><span id="l157.147" class="difflineminus">-               .createInstance(Ci.nsINNTPNewsgroupPost);</span>
<a href="#l157.148"></a><span id="l157.148" class="difflineminus">-  post.postMessageFile = do_get_file(file);</span>
<a href="#l157.149"></a><span id="l157.149" class="difflineminus">-  url.messageToPost = post;</span>
<a href="#l157.150"></a><span id="l157.150" class="difflineminus">-  return url;</span>
<a href="#l157.151"></a><span id="l157.151" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l158.1"></a><span id="l158.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-notificationbox-helpers.js</span>
<a href="#l158.2"></a><span id="l158.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-notificationbox-helpers.js</span>
<a href="#l158.3"></a><span id="l158.3" class="difflineat">@@ -1,19 +1,16 @@</span>
<a href="#l158.4"></a><span id="l158.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l158.5"></a><span id="l158.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l158.6"></a><span id="l158.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l158.7"></a><span id="l158.7"> </span>
<a href="#l158.8"></a><span id="l158.8"> &quot;use strict&quot;;</span>
<a href="#l158.9"></a><span id="l158.9"> </span>
<a href="#l158.10"></a><span id="l158.10"> var MODULE_NAME = &quot;notificationbox-helpers&quot;;</span>
<a href="#l158.11"></a><span id="l158.11"> </span>
<a href="#l158.12"></a><span id="l158.12" class="difflineminus">-var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l158.13"></a><span id="l158.13" class="difflineminus">-var MODULE_REQUIRES = [];</span>
<a href="#l158.14"></a><span id="l158.14" class="difflineminus">-</span>
<a href="#l158.15"></a><span id="l158.15"> function installInto(module) {</span>
<a href="#l158.16"></a><span id="l158.16">   module.check_notification_displayed = check_notification_displayed;</span>
<a href="#l158.17"></a><span id="l158.17">   module.assert_notification_displayed = assert_notification_displayed;</span>
<a href="#l158.18"></a><span id="l158.18">   module.close_notification = close_notification;</span>
<a href="#l158.19"></a><span id="l158.19">   module.wait_for_notification_to_stop = wait_for_notification_to_stop;</span>
<a href="#l158.20"></a><span id="l158.20">   module.wait_for_notification_to_show = wait_for_notification_to_show;</span>
<a href="#l158.21"></a><span id="l158.21">   module.get_notification_button = get_notification_button;</span>
<a href="#l158.22"></a><span id="l158.22"> }</span>
<a href="#l158.23"></a><span id="l158.23" class="difflineat">@@ -32,17 +29,17 @@ function installInto(module) {</span>
<a href="#l158.24"></a><span id="l158.24">  * @return  True/false depending on the state of the notification.</span>
<a href="#l158.25"></a><span id="l158.25">  */</span>
<a href="#l158.26"></a><span id="l158.26"> function check_notification_displayed(aController, aBoxId, aValue, aNotification) {</span>
<a href="#l158.27"></a><span id="l158.27">   let nb = aController.window.document.getElementById(aBoxId);</span>
<a href="#l158.28"></a><span id="l158.28">   if (!nb)</span>
<a href="#l158.29"></a><span id="l158.29">     throw new Error(&quot;Couldn't find a notification box for id=&quot; + aBoxId);</span>
<a href="#l158.30"></a><span id="l158.30"> </span>
<a href="#l158.31"></a><span id="l158.31">   if (nb.querySelector(&quot;.notificationbox-stack&quot;)) {</span>
<a href="#l158.32"></a><span id="l158.32" class="difflineminus">-    let box = nb.querySelector(&quot;.notificationbox-stack&quot;)._notificationBox</span>
<a href="#l158.33"></a><span id="l158.33" class="difflineplus">+    let box = nb.querySelector(&quot;.notificationbox-stack&quot;)._notificationBox;</span>
<a href="#l158.34"></a><span id="l158.34">     let notification = box.getNotificationWithValue(aValue);</span>
<a href="#l158.35"></a><span id="l158.35">     if (aNotification) {</span>
<a href="#l158.36"></a><span id="l158.36">       aNotification.notification = notification;</span>
<a href="#l158.37"></a><span id="l158.37">     }</span>
<a href="#l158.38"></a><span id="l158.38">     return (notification != null);</span>
<a href="#l158.39"></a><span id="l158.39">   }</span>
<a href="#l158.40"></a><span id="l158.40"> </span>
<a href="#l158.41"></a><span id="l158.41">   return false;</span>
<a href="#l158.42"></a><span id="l158.42" class="difflineat">@@ -79,17 +76,17 @@ function assert_notification_displayed(a</span>
<a href="#l158.43"></a><span id="l158.43">  * @param aBoxId the id of the notification box</span>
<a href="#l158.44"></a><span id="l158.44">  * @param aValue the value of the notification to close</span>
<a href="#l158.45"></a><span id="l158.45">  */</span>
<a href="#l158.46"></a><span id="l158.46"> function close_notification(aController, aBoxId, aValue) {</span>
<a href="#l158.47"></a><span id="l158.47">   let nb = aController.window.document.getElementById(aBoxId);</span>
<a href="#l158.48"></a><span id="l158.48">   if (!nb)</span>
<a href="#l158.49"></a><span id="l158.49">     throw new Error(&quot;Couldn't find a notification box for id=&quot; + aBoxId);</span>
<a href="#l158.50"></a><span id="l158.50"> </span>
<a href="#l158.51"></a><span id="l158.51" class="difflineminus">-  let box = nb.querySelector(&quot;.notificationbox-stack&quot;)._notificationBox</span>
<a href="#l158.52"></a><span id="l158.52" class="difflineplus">+  let box = nb.querySelector(&quot;.notificationbox-stack&quot;)._notificationBox;</span>
<a href="#l158.53"></a><span id="l158.53">   let notification = box.getNotificationWithValue(aValue);</span>
<a href="#l158.54"></a><span id="l158.54">   if (notification)</span>
<a href="#l158.55"></a><span id="l158.55">     notification.close();</span>
<a href="#l158.56"></a><span id="l158.56"> }</span>
<a href="#l158.57"></a><span id="l158.57"> </span>
<a href="#l158.58"></a><span id="l158.58"> /**</span>
<a href="#l158.59"></a><span id="l158.59">  * A helper function that waits for a notification with value aValue</span>
<a href="#l158.60"></a><span id="l158.60">  * to stop displaying in the window.</span>
<a href="#l158.61"></a><span id="l158.61" class="difflineat">@@ -98,17 +95,17 @@ function close_notification(aController,</span>
<a href="#l158.62"></a><span id="l158.62">  * @param aBoxId the id of the notification box</span>
<a href="#l158.63"></a><span id="l158.63">  * @param aValue the value of the notification to wait to stop</span>
<a href="#l158.64"></a><span id="l158.64">  */</span>
<a href="#l158.65"></a><span id="l158.65"> function wait_for_notification_to_stop(aController, aBoxId, aValue) {</span>
<a href="#l158.66"></a><span id="l158.66">   let nb = aController.window.document.getElementById(aBoxId);</span>
<a href="#l158.67"></a><span id="l158.67">   if (!nb)</span>
<a href="#l158.68"></a><span id="l158.68">     throw new Error(&quot;Couldn't find a notification box for id=&quot; + aBoxId);</span>
<a href="#l158.69"></a><span id="l158.69"> </span>
<a href="#l158.70"></a><span id="l158.70" class="difflineminus">-  let box = nb.querySelector(&quot;.notificationbox-stack&quot;)._notificationBox</span>
<a href="#l158.71"></a><span id="l158.71" class="difflineplus">+  let box = nb.querySelector(&quot;.notificationbox-stack&quot;)._notificationBox;</span>
<a href="#l158.72"></a><span id="l158.72">   aController.waitFor(() =&gt; !box.getNotificationWithValue(aValue),</span>
<a href="#l158.73"></a><span id="l158.73">                       &quot;Timed out waiting for notification with value &quot; +</span>
<a href="#l158.74"></a><span id="l158.74">                       aValue + &quot; to stop.&quot;);</span>
<a href="#l158.75"></a><span id="l158.75"> }</span>
<a href="#l158.76"></a><span id="l158.76"> </span>
<a href="#l158.77"></a><span id="l158.77"> /**</span>
<a href="#l158.78"></a><span id="l158.78">  * A helper function that waits for a notification with value aValue</span>
<a href="#l158.79"></a><span id="l158.79">  * to show in the window.</span>
<a href="#l158.80"></a><span id="l158.80" class="difflineat">@@ -120,19 +117,20 @@ function wait_for_notification_to_stop(a</span>
<a href="#l158.81"></a><span id="l158.81">  */</span>
<a href="#l158.82"></a><span id="l158.82"> function wait_for_notification_to_show(aController, aBoxId, aValue) {</span>
<a href="#l158.83"></a><span id="l158.83">   let nb = aController.window.document.getElementById(aBoxId);</span>
<a href="#l158.84"></a><span id="l158.84">   if (!nb)</span>
<a href="#l158.85"></a><span id="l158.85">     throw new Error(&quot;Couldn't find a notification box for id=&quot; + aBoxId);</span>
<a href="#l158.86"></a><span id="l158.86"> </span>
<a href="#l158.87"></a><span id="l158.87">   function nbReady() {</span>
<a href="#l158.88"></a><span id="l158.88">     if (nb.querySelector(&quot;.notificationbox-stack&quot;)) {</span>
<a href="#l158.89"></a><span id="l158.89" class="difflineminus">-      let box = nb.querySelector(&quot;.notificationbox-stack&quot;)._notificationBox</span>
<a href="#l158.90"></a><span id="l158.90" class="difflineplus">+      let box = nb.querySelector(&quot;.notificationbox-stack&quot;)._notificationBox;</span>
<a href="#l158.91"></a><span id="l158.91">       return (box.getNotificationWithValue(aValue) != null) &amp;&amp; !box._animating;</span>
<a href="#l158.92"></a><span id="l158.92">     }</span>
<a href="#l158.93"></a><span id="l158.93" class="difflineplus">+    return false;</span>
<a href="#l158.94"></a><span id="l158.94">   }</span>
<a href="#l158.95"></a><span id="l158.95">   aController.waitFor(nbReady,</span>
<a href="#l158.96"></a><span id="l158.96">                       &quot;Timed out waiting for notification with value &quot; +</span>
<a href="#l158.97"></a><span id="l158.97">                       aValue + &quot; to show.&quot;);</span>
<a href="#l158.98"></a><span id="l158.98"> }</span>
<a href="#l158.99"></a><span id="l158.99"> </span>
<a href="#l158.100"></a><span id="l158.100"> </span>
<a href="#l158.101"></a><span id="l158.101"> /**</span>
<a href="#l158.102"></a><span id="l158.102" class="difflineat">@@ -146,17 +144,17 @@ function wait_for_notification_to_show(a</span>
<a href="#l158.103"></a><span id="l158.103">  *                    An object with key:value pairs,</span>
<a href="#l158.104"></a><span id="l158.104">  *                    similar to click_menus_in_sequence().</span>
<a href="#l158.105"></a><span id="l158.105">  */</span>
<a href="#l158.106"></a><span id="l158.106"> function get_notification_button(aController, aBoxId, aValue, aMatch) {</span>
<a href="#l158.107"></a><span id="l158.107">   let nb = aController.window.document.getElementById(aBoxId);</span>
<a href="#l158.108"></a><span id="l158.108">   if (!nb)</span>
<a href="#l158.109"></a><span id="l158.109">     throw new Error(&quot;Couldn't find a notification box for id=&quot; + aBoxId);</span>
<a href="#l158.110"></a><span id="l158.110"> </span>
<a href="#l158.111"></a><span id="l158.111" class="difflineminus">-  let box = nb.querySelector(&quot;.notificationbox-stack&quot;)._notificationBox</span>
<a href="#l158.112"></a><span id="l158.112" class="difflineplus">+  let box = nb.querySelector(&quot;.notificationbox-stack&quot;)._notificationBox;</span>
<a href="#l158.113"></a><span id="l158.113">   let notification = box.getNotificationWithValue(aValue);</span>
<a href="#l158.114"></a><span id="l158.114">   let buttons = notification.querySelectorAll(&quot;button&quot;);</span>
<a href="#l158.115"></a><span id="l158.115">   for (let button of buttons) {</span>
<a href="#l158.116"></a><span id="l158.116">     let matchedAll = true;</span>
<a href="#l158.117"></a><span id="l158.117">     for (let name in aMatch) {</span>
<a href="#l158.118"></a><span id="l158.118">       let value = aMatch[name];</span>
<a href="#l158.119"></a><span id="l158.119">       let matched = false;</span>
<a href="#l158.120"></a><span id="l158.120">       if (name == &quot;popup&quot;) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l159.1"></a><span id="l159.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-observer-helpers.js</span>
<a href="#l159.2"></a><span id="l159.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-observer-helpers.js</span>
<a href="#l159.3"></a><span id="l159.3" class="difflineat">@@ -130,10 +130,10 @@ ObservationRecorder.prototype = {</span>
<a href="#l159.4"></a><span id="l159.4">    *</span>
<a href="#l159.5"></a><span id="l159.5">    * @param aTopic the topic to count the number of observations of.</span>
<a href="#l159.6"></a><span id="l159.6">    */</span>
<a href="#l159.7"></a><span id="l159.7">   numSightings: function OR_numSightings(aTopic) {</span>
<a href="#l159.8"></a><span id="l159.8">     if (!(aTopic in this.saw))</span>
<a href="#l159.9"></a><span id="l159.9">       return 0;</span>
<a href="#l159.10"></a><span id="l159.10"> </span>
<a href="#l159.11"></a><span id="l159.11">     return this.saw[aTopic];</span>
<a href="#l159.12"></a><span id="l159.12" class="difflineminus">-  }</span>
<a href="#l159.13"></a><span id="l159.13" class="difflineminus">-}</span>
<a href="#l159.14"></a><span id="l159.14" class="difflineplus">+  },</span>
<a href="#l159.15"></a><span id="l159.15" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l160.1"></a><span id="l160.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-pref-window-helpers.js</span>
<a href="#l160.2"></a><span id="l160.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-pref-window-helpers.js</span>
<a href="#l160.3"></a><span id="l160.3" class="difflineat">@@ -5,17 +5,16 @@</span>
<a href="#l160.4"></a><span id="l160.4"> </span>
<a href="#l160.5"></a><span id="l160.5"> /*</span>
<a href="#l160.6"></a><span id="l160.6">  * Helpers to deal with the preferences window.</span>
<a href="#l160.7"></a><span id="l160.7">  */</span>
<a href="#l160.8"></a><span id="l160.8"> </span>
<a href="#l160.9"></a><span id="l160.9"> &quot;use strict&quot;;</span>
<a href="#l160.10"></a><span id="l160.10"> </span>
<a href="#l160.11"></a><span id="l160.11"> var MODULE_NAME = &quot;pref-window-helpers&quot;;</span>
<a href="#l160.12"></a><span id="l160.12" class="difflineminus">-</span>
<a href="#l160.13"></a><span id="l160.13"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l160.14"></a><span id="l160.14"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;content-tab-helpers&quot;];</span>
<a href="#l160.15"></a><span id="l160.15"> </span>
<a href="#l160.16"></a><span id="l160.16"> var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l160.17"></a><span id="l160.17"> </span>
<a href="#l160.18"></a><span id="l160.18"> var fdh;</span>
<a href="#l160.19"></a><span id="l160.19"> var cth;</span>
<a href="#l160.20"></a><span id="l160.20"> </span>
<a href="#l160.21"></a><span id="l160.21" class="difflineat">@@ -35,17 +34,17 @@ function installInto(module) {</span>
<a href="#l160.22"></a><span id="l160.22"> /**</span>
<a href="#l160.23"></a><span id="l160.23">  * Open the preferences tab with the given pane displayed. The pane needs to</span>
<a href="#l160.24"></a><span id="l160.24">  * be one of the prefpane ids in mail/components/preferences/aboutPreferences.xul.</span>
<a href="#l160.25"></a><span id="l160.25">  *</span>
<a href="#l160.26"></a><span id="l160.26">  * @param aPaneID The ID of the pref pane to display (see</span>
<a href="#l160.27"></a><span id="l160.27">  *     mail/components/preferences/aboutPreferences.xul for valid IDs.)</span>
<a href="#l160.28"></a><span id="l160.28">  */</span>
<a href="#l160.29"></a><span id="l160.29"> function open_pref_tab(aPaneID) {</span>
<a href="#l160.30"></a><span id="l160.30" class="difflineminus">-  let tab = cth.open_content_tab_with_click(function() { fdh.mc.window.openOptionsDialog(aPaneID) },</span>
<a href="#l160.31"></a><span id="l160.31" class="difflineplus">+  let tab = cth.open_content_tab_with_click(function() { fdh.mc.window.openOptionsDialog(aPaneID); },</span>
<a href="#l160.32"></a><span id="l160.32">                                             &quot;about:preferences&quot;, fdh.mc, &quot;preferencesTab&quot;);</span>
<a href="#l160.33"></a><span id="l160.33">   utils.waitFor(() =&gt; tab.browser.contentWindow.getCurrentPaneID() == aPaneID,</span>
<a href="#l160.34"></a><span id="l160.34">                 &quot;Timed out waiting for prefpane &quot; + aPaneID + &quot; to load.&quot;);</span>
<a href="#l160.35"></a><span id="l160.35">   return tab;</span>
<a href="#l160.36"></a><span id="l160.36"> }</span>
<a href="#l160.37"></a><span id="l160.37"> </span>
<a href="#l160.38"></a><span id="l160.38"> /**</span>
<a href="#l160.39"></a><span id="l160.39">  * Close the preferences tab.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l161.1"></a><span id="l161.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-prompt-helpers.js</span>
<a href="#l161.2"></a><span id="l161.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-prompt-helpers.js</span>
<a href="#l161.3"></a><span id="l161.3" class="difflineat">@@ -1,31 +1,29 @@</span>
<a href="#l161.4"></a><span id="l161.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l161.5"></a><span id="l161.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l161.6"></a><span id="l161.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l161.7"></a><span id="l161.7"> </span>
<a href="#l161.8"></a><span id="l161.8"> &quot;use strict&quot;;</span>
<a href="#l161.9"></a><span id="l161.9"> </span>
<a href="#l161.10"></a><span id="l161.10"> var MODULE_NAME = &quot;prompt-helpers&quot;;</span>
<a href="#l161.11"></a><span id="l161.11" class="difflineminus">-</span>
<a href="#l161.12"></a><span id="l161.12"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l161.13"></a><span id="l161.13" class="difflineminus">-// we need this for the main controller</span>
<a href="#l161.14"></a><span id="l161.14"> var MODULE_REQUIRES = [&quot;mock-object-helpers&quot;];</span>
<a href="#l161.15"></a><span id="l161.15"> </span>
<a href="#l161.16"></a><span id="l161.16"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l161.17"></a><span id="l161.17"> var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l161.18"></a><span id="l161.18"> </span>
<a href="#l161.19"></a><span id="l161.19"> var kMockPromptServiceName = &quot;Mock Prompt Service&quot;;</span>
<a href="#l161.20"></a><span id="l161.20"> var kPromptServiceContractID = &quot;@mozilla.org/embedcomp/prompt-service;1&quot;;</span>
<a href="#l161.21"></a><span id="l161.21"> var kPromptServiceName = &quot;Prompt Service&quot;;</span>
<a href="#l161.22"></a><span id="l161.22"> </span>
<a href="#l161.23"></a><span id="l161.23"> var gMockAuthPromptReg;</span>
<a href="#l161.24"></a><span id="l161.24"> </span>
<a href="#l161.25"></a><span id="l161.25"> function setupModule() {</span>
<a href="#l161.26"></a><span id="l161.26" class="difflineminus">-  let moh = collector.getModule('mock-object-helpers');</span>
<a href="#l161.27"></a><span id="l161.27" class="difflineplus">+  let moh = collector.getModule(&quot;mock-object-helpers&quot;);</span>
<a href="#l161.28"></a><span id="l161.28">   gMockAuthPromptReg = new moh.MockObjectReplacer(&quot;@mozilla.org/prompter;1&quot;,</span>
<a href="#l161.29"></a><span id="l161.29">                                                   MockAuthPromptFactoryConstructor);</span>
<a href="#l161.30"></a><span id="l161.30"> }</span>
<a href="#l161.31"></a><span id="l161.31"> </span>
<a href="#l161.32"></a><span id="l161.32"> function installInto(module) {</span>
<a href="#l161.33"></a><span id="l161.33">   setupModule();</span>
<a href="#l161.34"></a><span id="l161.34"> </span>
<a href="#l161.35"></a><span id="l161.35">   // Now copy helper functions</span>
<a href="#l161.36"></a><span id="l161.36" class="difflineat">@@ -35,71 +33,65 @@ function installInto(module) {</span>
<a href="#l161.37"></a><span id="l161.37"> }</span>
<a href="#l161.38"></a><span id="l161.38"> </span>
<a href="#l161.39"></a><span id="l161.39"> function MockAuthPromptFactoryConstructor() {</span>
<a href="#l161.40"></a><span id="l161.40">   return gMockAuthPromptFactory;</span>
<a href="#l161.41"></a><span id="l161.41"> }</span>
<a href="#l161.42"></a><span id="l161.42"> </span>
<a href="#l161.43"></a><span id="l161.43"> var gMockAuthPromptFactory = {</span>
<a href="#l161.44"></a><span id="l161.44">   QueryInterface: ChromeUtils.generateQI([Ci.nsIPromptFactory]),</span>
<a href="#l161.45"></a><span id="l161.45" class="difflineminus">-  getPrompt: function(aParent, aIID, aResult) {</span>
<a href="#l161.46"></a><span id="l161.46" class="difflineplus">+  getPrompt(aParent, aIID, aResult) {</span>
<a href="#l161.47"></a><span id="l161.47">     return gMockAuthPrompt.QueryInterface(aIID);</span>
<a href="#l161.48"></a><span id="l161.48" class="difflineminus">-  }</span>
<a href="#l161.49"></a><span id="l161.49" class="difflineminus">-}</span>
<a href="#l161.50"></a><span id="l161.50" class="difflineplus">+  },</span>
<a href="#l161.51"></a><span id="l161.51" class="difflineplus">+};</span>
<a href="#l161.52"></a><span id="l161.52"> </span>
<a href="#l161.53"></a><span id="l161.53"> </span>
<a href="#l161.54"></a><span id="l161.54"> var gMockAuthPrompt = {</span>
<a href="#l161.55"></a><span id="l161.55">   password: &quot;&quot;,</span>
<a href="#l161.56"></a><span id="l161.56"> </span>
<a href="#l161.57"></a><span id="l161.57">   QueryInterface: ChromeUtils.generateQI([Ci.nsIAuthPrompt]),</span>
<a href="#l161.58"></a><span id="l161.58"> </span>
<a href="#l161.59"></a><span id="l161.59" class="difflineminus">-  prompt: function MAP_prompt(aTitle, aText, aRealm, aSave,</span>
<a href="#l161.60"></a><span id="l161.60" class="difflineminus">-                              aDefaultText) {</span>
<a href="#l161.61"></a><span id="l161.61" class="difflineplus">+  prompt(aTitle, aText, aRealm, aSave, aDefaultText) {</span>
<a href="#l161.62"></a><span id="l161.62">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l161.63"></a><span id="l161.63">   },</span>
<a href="#l161.64"></a><span id="l161.64"> </span>
<a href="#l161.65"></a><span id="l161.65" class="difflineminus">-  promptUsernameAndPassword: function</span>
<a href="#l161.66"></a><span id="l161.66" class="difflineminus">-      MAP_promptUsernameAndPassword(aTitle, aText, aRealm, aSave,</span>
<a href="#l161.67"></a><span id="l161.67" class="difflineminus">-                                    aUser, aPwd) {</span>
<a href="#l161.68"></a><span id="l161.68" class="difflineplus">+  promptUsernameAndPassword(aTitle, aText, aRealm, aSave, aUser, aPwd) {</span>
<a href="#l161.69"></a><span id="l161.69">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l161.70"></a><span id="l161.70">   },</span>
<a href="#l161.71"></a><span id="l161.71"> </span>
<a href="#l161.72"></a><span id="l161.72" class="difflineminus">-  promptPassword: function MAP_promptPassword(aTitle, aText,</span>
<a href="#l161.73"></a><span id="l161.73" class="difflineminus">-                                              aRealm, aSave,</span>
<a href="#l161.74"></a><span id="l161.74" class="difflineminus">-                                              aPwd) {</span>
<a href="#l161.75"></a><span id="l161.75" class="difflineplus">+  promptPassword(aTitle, aText, aRealm, aSave, aPwd) {</span>
<a href="#l161.76"></a><span id="l161.76">     aPwd.value = this.password;</span>
<a href="#l161.77"></a><span id="l161.77">     return true;</span>
<a href="#l161.78"></a><span id="l161.78" class="difflineminus">-  }</span>
<a href="#l161.79"></a><span id="l161.79" class="difflineplus">+  },</span>
<a href="#l161.80"></a><span id="l161.80"> };</span>
<a href="#l161.81"></a><span id="l161.81"> </span>
<a href="#l161.82"></a><span id="l161.82"> var gMockPromptService = {</span>
<a href="#l161.83"></a><span id="l161.83">   _registered: false,</span>
<a href="#l161.84"></a><span id="l161.84">   QueryInterface: ChromeUtils.generateQI([Ci.nsIPromptService]),</span>
<a href="#l161.85"></a><span id="l161.85">   _will_return: null,</span>
<a href="#l161.86"></a><span id="l161.86">   _inout_value: null,</span>
<a href="#l161.87"></a><span id="l161.87">   _promptState: null,</span>
<a href="#l161.88"></a><span id="l161.88">   _origFactory: null,</span>
<a href="#l161.89"></a><span id="l161.89">   _promptCb: null,</span>
<a href="#l161.90"></a><span id="l161.90"> </span>
<a href="#l161.91"></a><span id="l161.91" class="difflineminus">-  confirm: function(aParent, aDialogTitle, aText) {</span>
<a href="#l161.92"></a><span id="l161.92" class="difflineplus">+  confirm(aParent, aDialogTitle, aText) {</span>
<a href="#l161.93"></a><span id="l161.93">     this._promptState = {</span>
<a href="#l161.94"></a><span id="l161.94">       method: &quot;confirm&quot;,</span>
<a href="#l161.95"></a><span id="l161.95">       parent: aParent,</span>
<a href="#l161.96"></a><span id="l161.96">       dialogTitle: aDialogTitle,</span>
<a href="#l161.97"></a><span id="l161.97">       text: aText,</span>
<a href="#l161.98"></a><span id="l161.98">     };</span>
<a href="#l161.99"></a><span id="l161.99"> </span>
<a href="#l161.100"></a><span id="l161.100">     this.fireCb();</span>
<a href="#l161.101"></a><span id="l161.101"> </span>
<a href="#l161.102"></a><span id="l161.102">     return this._will_return;</span>
<a href="#l161.103"></a><span id="l161.103">   },</span>
<a href="#l161.104"></a><span id="l161.104"> </span>
<a href="#l161.105"></a><span id="l161.105" class="difflineminus">-  confirmEx: function(aParent, aDialogTitle, aText, aButtonFlags,</span>
<a href="#l161.106"></a><span id="l161.106" class="difflineminus">-                      aButton0Title, aButton1Title, aButton2Title,</span>
<a href="#l161.107"></a><span id="l161.107" class="difflineminus">-                      aCheckMsg, aCheckState) {</span>
<a href="#l161.108"></a><span id="l161.108" class="difflineplus">+  confirmEx(aParent, aDialogTitle, aText, aButtonFlags, aButton0Title, aButton1Title,</span>
<a href="#l161.109"></a><span id="l161.109" class="difflineplus">+            aButton2Title, aCheckMsg, aCheckState) {</span>
<a href="#l161.110"></a><span id="l161.110">     this._promptState = {</span>
<a href="#l161.111"></a><span id="l161.111">       method: &quot;confirmEx&quot;,</span>
<a href="#l161.112"></a><span id="l161.112">       parent: aParent,</span>
<a href="#l161.113"></a><span id="l161.113">       dialogTitle: aDialogTitle,</span>
<a href="#l161.114"></a><span id="l161.114">       text: aText,</span>
<a href="#l161.115"></a><span id="l161.115">       buttonFlags: aButtonFlags,</span>
<a href="#l161.116"></a><span id="l161.116">       button0Title: aButton0Title,</span>
<a href="#l161.117"></a><span id="l161.117">       button1Title: aButton1Title,</span>
<a href="#l161.118"></a><span id="l161.118" class="difflineat">@@ -108,18 +100,17 @@ var gMockPromptService = {</span>
<a href="#l161.119"></a><span id="l161.119">       checkState: aCheckState,</span>
<a href="#l161.120"></a><span id="l161.120">     };</span>
<a href="#l161.121"></a><span id="l161.121"> </span>
<a href="#l161.122"></a><span id="l161.122">     this.fireCb();</span>
<a href="#l161.123"></a><span id="l161.123"> </span>
<a href="#l161.124"></a><span id="l161.124">     return this._will_return;</span>
<a href="#l161.125"></a><span id="l161.125">   },</span>
<a href="#l161.126"></a><span id="l161.126"> </span>
<a href="#l161.127"></a><span id="l161.127" class="difflineminus">-  prompt: function(aParent, aDialogTitle, aText, aValue, aCheckMsg,</span>
<a href="#l161.128"></a><span id="l161.128" class="difflineminus">-                   aCheckState) {</span>
<a href="#l161.129"></a><span id="l161.129" class="difflineplus">+  prompt(aParent, aDialogTitle, aText, aValue, aCheckMsg, aCheckState) {</span>
<a href="#l161.130"></a><span id="l161.130">     this._promptState = {</span>
<a href="#l161.131"></a><span id="l161.131">       method: &quot;prompt&quot;,</span>
<a href="#l161.132"></a><span id="l161.132">       parent: aParent,</span>
<a href="#l161.133"></a><span id="l161.133">       dialogTitle: aDialogTitle,</span>
<a href="#l161.134"></a><span id="l161.134">       text: aText,</span>
<a href="#l161.135"></a><span id="l161.135">       value: aValue,</span>
<a href="#l161.136"></a><span id="l161.136">       checkMsg: aCheckMsg,</span>
<a href="#l161.137"></a><span id="l161.137">       checkState: aCheckState,</span>
<a href="#l161.138"></a><span id="l161.138" class="difflineat">@@ -148,24 +139,24 @@ var gMockPromptService = {</span>
<a href="#l161.139"></a><span id="l161.139">   set inoutValue(aValue) {</span>
<a href="#l161.140"></a><span id="l161.140">     this._inout_value = aValue;</span>
<a href="#l161.141"></a><span id="l161.141">   },</span>
<a href="#l161.142"></a><span id="l161.142"> </span>
<a href="#l161.143"></a><span id="l161.143">   set onPromptCallback(aCb) {</span>
<a href="#l161.144"></a><span id="l161.144">     this._promptCb = aCb;</span>
<a href="#l161.145"></a><span id="l161.145">   },</span>
<a href="#l161.146"></a><span id="l161.146"> </span>
<a href="#l161.147"></a><span id="l161.147" class="difflineminus">-  fireCb: function() {</span>
<a href="#l161.148"></a><span id="l161.148" class="difflineplus">+  fireCb() {</span>
<a href="#l161.149"></a><span id="l161.149">     if (typeof(this._promptCb) == &quot;function&quot;)</span>
<a href="#l161.150"></a><span id="l161.150">       this._promptCb.call();</span>
<a href="#l161.151"></a><span id="l161.151">   },</span>
<a href="#l161.152"></a><span id="l161.152"> </span>
<a href="#l161.153"></a><span id="l161.153">   /* Wipes out the prompt state and any return values.</span>
<a href="#l161.154"></a><span id="l161.154">    */</span>
<a href="#l161.155"></a><span id="l161.155" class="difflineminus">-  reset: function() {</span>
<a href="#l161.156"></a><span id="l161.156" class="difflineplus">+  reset() {</span>
<a href="#l161.157"></a><span id="l161.157">     this._will_return = null;</span>
<a href="#l161.158"></a><span id="l161.158">     this._promptState = null;</span>
<a href="#l161.159"></a><span id="l161.159">     this._promptCb = null;</span>
<a href="#l161.160"></a><span id="l161.160">     this._inout_value = null;</span>
<a href="#l161.161"></a><span id="l161.161">   },</span>
<a href="#l161.162"></a><span id="l161.162"> </span>
<a href="#l161.163"></a><span id="l161.163">   /* Returns the prompt state if one was observed since registering</span>
<a href="#l161.164"></a><span id="l161.164">    * the Mock Prompt Service.</span>
<a href="#l161.165"></a><span id="l161.165" class="difflineat">@@ -211,26 +202,26 @@ var gMockPromptService = {</span>
<a href="#l161.166"></a><span id="l161.166">                                      kPromptServiceContractID,</span>
<a href="#l161.167"></a><span id="l161.167">                                      null);</span>
<a href="#l161.168"></a><span id="l161.168"> </span>
<a href="#l161.169"></a><span id="l161.169">       delete this.originalCID;</span>
<a href="#l161.170"></a><span id="l161.170">       this._resetServicesPrompt();</span>
<a href="#l161.171"></a><span id="l161.171">     }</span>
<a href="#l161.172"></a><span id="l161.172">   },</span>
<a href="#l161.173"></a><span id="l161.173"> </span>
<a href="#l161.174"></a><span id="l161.174" class="difflineminus">-  _resetServicesPrompt: function() {</span>
<a href="#l161.175"></a><span id="l161.175" class="difflineplus">+  _resetServicesPrompt() {</span>
<a href="#l161.176"></a><span id="l161.176">     XPCOMUtils.defineLazyServiceGetter(Services, &quot;prompt&quot;,</span>
<a href="#l161.177"></a><span id="l161.177">                                        kPromptServiceContractID,</span>
<a href="#l161.178"></a><span id="l161.178">                                        &quot;nsIPromptService&quot;);</span>
<a href="#l161.179"></a><span id="l161.179">   },</span>
<a href="#l161.180"></a><span id="l161.180"> };</span>
<a href="#l161.181"></a><span id="l161.181"> </span>
<a href="#l161.182"></a><span id="l161.182"> var gMockPromptServiceFactory = {</span>
<a href="#l161.183"></a><span id="l161.183" class="difflineminus">-  createInstance: function(aOuter, aIID) {</span>
<a href="#l161.184"></a><span id="l161.184" class="difflineplus">+  createInstance(aOuter, aIID) {</span>
<a href="#l161.185"></a><span id="l161.185">     if (aOuter != null)</span>
<a href="#l161.186"></a><span id="l161.186">       throw Cr.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l161.187"></a><span id="l161.187"> </span>
<a href="#l161.188"></a><span id="l161.188">     if (!aIID.equals(Ci.nsIPromptService))</span>
<a href="#l161.189"></a><span id="l161.189">       throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l161.190"></a><span id="l161.190"> </span>
<a href="#l161.191"></a><span id="l161.191">     return gMockPromptService;</span>
<a href="#l161.192"></a><span id="l161.192" class="difflineminus">-  }</span>
<a href="#l161.193"></a><span id="l161.193" class="difflineplus">+  },</span>
<a href="#l161.194"></a><span id="l161.194"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l162.1"></a><span id="l162.1">rename from mail/test/mozmill/shared-modules/test-quick-filter-bar-helper.js</span>
<a href="#l162.2"></a><span id="l162.2">rename to mail/test/mozmill/shared-modules/test-quick-filter-bar-helpers.js</span>
<a href="#l162.3"></a><span id="l162.3" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-quick-filter-bar-helper.js</span>
<a href="#l162.4"></a><span id="l162.4" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-quick-filter-bar-helpers.js</span>
<a href="#l162.5"></a><span id="l162.5" class="difflineat">@@ -1,42 +1,41 @@</span>
<a href="#l162.6"></a><span id="l162.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l162.7"></a><span id="l162.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l162.8"></a><span id="l162.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l162.9"></a><span id="l162.9"> </span>
<a href="#l162.10"></a><span id="l162.10"> &quot;use strict&quot;;</span>
<a href="#l162.11"></a><span id="l162.11"> </span>
<a href="#l162.12"></a><span id="l162.12" class="difflineminus">-var MODULE_NAME = &quot;quick-filter-bar-helper&quot;;</span>
<a href="#l162.13"></a><span id="l162.13" class="difflineminus">-</span>
<a href="#l162.14"></a><span id="l162.14" class="difflineplus">+var MODULE_NAME = &quot;quick-filter-bar-helpers&quot;;</span>
<a href="#l162.15"></a><span id="l162.15"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l162.16"></a><span id="l162.16"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l162.17"></a><span id="l162.17"> </span>
<a href="#l162.18"></a><span id="l162.18"> var fdh, mc;</span>
<a href="#l162.19"></a><span id="l162.19"> </span>
<a href="#l162.20"></a><span id="l162.20"> function setupModule() {</span>
<a href="#l162.21"></a><span id="l162.21" class="difflineminus">-  fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l162.22"></a><span id="l162.22" class="difflineplus">+  fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l162.23"></a><span id="l162.23">   mc = fdh.mc;</span>
<a href="#l162.24"></a><span id="l162.24"> }</span>
<a href="#l162.25"></a><span id="l162.25"> </span>
<a href="#l162.26"></a><span id="l162.26"> var EXPORT = [</span>
<a href="#l162.27"></a><span id="l162.27" class="difflineminus">-  'assert_quick_filter_button_enabled',</span>
<a href="#l162.28"></a><span id="l162.28" class="difflineminus">-  'assert_quick_filter_bar_visible',</span>
<a href="#l162.29"></a><span id="l162.29" class="difflineminus">-  'toggle_quick_filter_bar',</span>
<a href="#l162.30"></a><span id="l162.30" class="difflineminus">-  'assert_constraints_expressed',</span>
<a href="#l162.31"></a><span id="l162.31" class="difflineminus">-  'toggle_boolean_constraints',</span>
<a href="#l162.32"></a><span id="l162.32" class="difflineminus">-  'toggle_tag_constraints',</span>
<a href="#l162.33"></a><span id="l162.33" class="difflineminus">-  'toggle_tag_mode',</span>
<a href="#l162.34"></a><span id="l162.34" class="difflineminus">-  'assert_tag_constraints_visible',</span>
<a href="#l162.35"></a><span id="l162.35" class="difflineminus">-  'assert_tag_constraints_checked',</span>
<a href="#l162.36"></a><span id="l162.36" class="difflineminus">-  'toggle_text_constraints',</span>
<a href="#l162.37"></a><span id="l162.37" class="difflineminus">-  'assert_text_constraints_checked',</span>
<a href="#l162.38"></a><span id="l162.38" class="difflineminus">-  'set_filter_text',</span>
<a href="#l162.39"></a><span id="l162.39" class="difflineminus">-  'assert_filter_text',</span>
<a href="#l162.40"></a><span id="l162.40" class="difflineminus">-  'assert_results_label_count',</span>
<a href="#l162.41"></a><span id="l162.41" class="difflineminus">-  'clear_constraints',</span>
<a href="#l162.42"></a><span id="l162.42" class="difflineplus">+  &quot;assert_quick_filter_button_enabled&quot;,</span>
<a href="#l162.43"></a><span id="l162.43" class="difflineplus">+  &quot;assert_quick_filter_bar_visible&quot;,</span>
<a href="#l162.44"></a><span id="l162.44" class="difflineplus">+  &quot;toggle_quick_filter_bar&quot;,</span>
<a href="#l162.45"></a><span id="l162.45" class="difflineplus">+  &quot;assert_constraints_expressed&quot;,</span>
<a href="#l162.46"></a><span id="l162.46" class="difflineplus">+  &quot;toggle_boolean_constraints&quot;,</span>
<a href="#l162.47"></a><span id="l162.47" class="difflineplus">+  &quot;toggle_tag_constraints&quot;,</span>
<a href="#l162.48"></a><span id="l162.48" class="difflineplus">+  &quot;toggle_tag_mode&quot;,</span>
<a href="#l162.49"></a><span id="l162.49" class="difflineplus">+  &quot;assert_tag_constraints_visible&quot;,</span>
<a href="#l162.50"></a><span id="l162.50" class="difflineplus">+  &quot;assert_tag_constraints_checked&quot;,</span>
<a href="#l162.51"></a><span id="l162.51" class="difflineplus">+  &quot;toggle_text_constraints&quot;,</span>
<a href="#l162.52"></a><span id="l162.52" class="difflineplus">+  &quot;assert_text_constraints_checked&quot;,</span>
<a href="#l162.53"></a><span id="l162.53" class="difflineplus">+  &quot;set_filter_text&quot;,</span>
<a href="#l162.54"></a><span id="l162.54" class="difflineplus">+  &quot;assert_filter_text&quot;,</span>
<a href="#l162.55"></a><span id="l162.55" class="difflineplus">+  &quot;assert_results_label_count&quot;,</span>
<a href="#l162.56"></a><span id="l162.56" class="difflineplus">+  &quot;clear_constraints&quot;,</span>
<a href="#l162.57"></a><span id="l162.57"> ];</span>
<a href="#l162.58"></a><span id="l162.58"> </span>
<a href="#l162.59"></a><span id="l162.59"> var backstage = this;</span>
<a href="#l162.60"></a><span id="l162.60"> </span>
<a href="#l162.61"></a><span id="l162.61"> function installInto(module) {</span>
<a href="#l162.62"></a><span id="l162.62">   setupModule();</span>
<a href="#l162.63"></a><span id="l162.63">   for (let name of EXPORT) {</span>
<a href="#l162.64"></a><span id="l162.64">     module[name] = backstage[name];</span>
<a href="#l162.65"></a><span id="l162.65" class="difflineat">@@ -132,22 +131,20 @@ function toggle_tag_constraints(...aArgs</span>
<a href="#l162.66"></a><span id="l162.66"> /**</span>
<a href="#l162.67"></a><span id="l162.67">  * Set the tag filtering mode. Wait for messages after.</span>
<a href="#l162.68"></a><span id="l162.68">  */</span>
<a href="#l162.69"></a><span id="l162.69"> function toggle_tag_mode() {</span>
<a href="#l162.70"></a><span id="l162.70">   let qbm = mc.e(&quot;qfb-boolean-mode&quot;);</span>
<a href="#l162.71"></a><span id="l162.71">   if (qbm.value === &quot;AND&quot;) {</span>
<a href="#l162.72"></a><span id="l162.72">     qbm.selectedIndex--; // = move to &quot;OR&quot;;</span>
<a href="#l162.73"></a><span id="l162.73">     fdh.assert_equals(qbm.value, &quot;OR&quot;, &quot;qfb-boolean-mode has wrong state&quot;);</span>
<a href="#l162.74"></a><span id="l162.74" class="difflineminus">-  }</span>
<a href="#l162.75"></a><span id="l162.75" class="difflineminus">-  else if (qbm.value === &quot;OR&quot;) {</span>
<a href="#l162.76"></a><span id="l162.76" class="difflineplus">+  } else if (qbm.value === &quot;OR&quot;) {</span>
<a href="#l162.77"></a><span id="l162.77">     qbm.selectedIndex++; // = move to &quot;AND&quot;;</span>
<a href="#l162.78"></a><span id="l162.78">     fdh.assert_equals(qbm.value, &quot;AND&quot;, &quot;qfb-boolean-mode has wrong state&quot;);</span>
<a href="#l162.79"></a><span id="l162.79" class="difflineminus">-  }</span>
<a href="#l162.80"></a><span id="l162.80" class="difflineminus">-  else {</span>
<a href="#l162.81"></a><span id="l162.81" class="difflineplus">+  } else {</span>
<a href="#l162.82"></a><span id="l162.82">     throw new Error(&quot;qfb-boolean-mode value=&quot; + qbm.value);</span>
<a href="#l162.83"></a><span id="l162.83">   }</span>
<a href="#l162.84"></a><span id="l162.84">   fdh.wait_for_all_messages_to_load(mc);</span>
<a href="#l162.85"></a><span id="l162.85"> }</span>
<a href="#l162.86"></a><span id="l162.86"> </span>
<a href="#l162.87"></a><span id="l162.87"> /**</span>
<a href="#l162.88"></a><span id="l162.88">  * Verify that tag buttons exist for exactly the given set of tag keys in the</span>
<a href="#l162.89"></a><span id="l162.89">  *  provided variable argument list.  Ordering is significant.</span>
<a href="#l162.90"></a><span id="l162.90" class="difflineat">@@ -161,19 +158,19 @@ function assert_tag_constraints_visible(</span>
<a href="#l162.91"></a><span id="l162.91">   let tagLength = kids.length - 1; // -1 for the qfb-boolean-mode widget</span>
<a href="#l162.92"></a><span id="l162.92">   // this is bad error reporting in here for now.</span>
<a href="#l162.93"></a><span id="l162.93">   if (tagLength != aArgs.length)</span>
<a href="#l162.94"></a><span id="l162.94">     throw new Error(&quot;Mismatch in expected tag count and actual. &quot; +</span>
<a href="#l162.95"></a><span id="l162.95">                     &quot;Expected &quot; + aArgs.length +</span>
<a href="#l162.96"></a><span id="l162.96">                     &quot; actual &quot; + tagLength);</span>
<a href="#l162.97"></a><span id="l162.97">   for (let iArg = 0; iArg &lt; aArgs.length; iArg++) {</span>
<a href="#l162.98"></a><span id="l162.98">     let nodeId = &quot;qfb-tag-&quot; + aArgs[iArg];</span>
<a href="#l162.99"></a><span id="l162.99" class="difflineminus">-    if (nodeId != kids[iArg+1].id)</span>
<a href="#l162.100"></a><span id="l162.100" class="difflineplus">+    if (nodeId != kids[iArg + 1].id)</span>
<a href="#l162.101"></a><span id="l162.101">       throw new Error(&quot;Mismatch at tag &quot; + iArg + &quot; expected &quot; + nodeId +</span>
<a href="#l162.102"></a><span id="l162.102" class="difflineminus">-                      &quot; but got &quot; + kids[iArg+1].id);</span>
<a href="#l162.103"></a><span id="l162.103" class="difflineplus">+                      &quot; but got &quot; + kids[iArg + 1].id);</span>
<a href="#l162.104"></a><span id="l162.104">   }</span>
<a href="#l162.105"></a><span id="l162.105"> }</span>
<a href="#l162.106"></a><span id="l162.106"> </span>
<a href="#l162.107"></a><span id="l162.107"> /**</span>
<a href="#l162.108"></a><span id="l162.108">  * Verify that only the buttons corresponding to the provided tag keys are</span>
<a href="#l162.109"></a><span id="l162.109">  * checked.</span>
<a href="#l162.110"></a><span id="l162.110">  */</span>
<a href="#l162.111"></a><span id="l162.111"> function assert_tag_constraints_checked(...aArgs) {</span>
<a href="#l162.112"></a><span id="l162.112" class="difflineat">@@ -250,18 +247,17 @@ function assert_filter_text(aText) {</span>
<a href="#l162.113"></a><span id="l162.113">  * Assert that the results label is telling us there are aCount messages</span>
<a href="#l162.114"></a><span id="l162.114">  *  using the appropriate string.</span>
<a href="#l162.115"></a><span id="l162.115">  */</span>
<a href="#l162.116"></a><span id="l162.116"> function assert_results_label_count(aCount) {</span>
<a href="#l162.117"></a><span id="l162.117">   let resultsLabel = mc.e(&quot;qfb-results-label&quot;);</span>
<a href="#l162.118"></a><span id="l162.118">   if (aCount == 0) {</span>
<a href="#l162.119"></a><span id="l162.119">     if (resultsLabel.value != resultsLabel.getAttribute(&quot;noresultsstring&quot;))</span>
<a href="#l162.120"></a><span id="l162.120">       throw new Error(&quot;results label should be displaying the no messages case&quot;);</span>
<a href="#l162.121"></a><span id="l162.121" class="difflineminus">-  }</span>
<a href="#l162.122"></a><span id="l162.122" class="difflineminus">-  else {</span>
<a href="#l162.123"></a><span id="l162.123" class="difflineplus">+  } else {</span>
<a href="#l162.124"></a><span id="l162.124">     let s = resultsLabel.value;</span>
<a href="#l162.125"></a><span id="l162.125">     s = s.substring(0, s.indexOf(&quot; &quot;));</span>
<a href="#l162.126"></a><span id="l162.126">     if (parseInt(s) !== aCount)</span>
<a href="#l162.127"></a><span id="l162.127">      throw new Error(&quot;Result count is displaying &quot; + s + &quot; but should show &quot; +</span>
<a href="#l162.128"></a><span id="l162.128">                      aCount);</span>
<a href="#l162.129"></a><span id="l162.129">   }</span>
<a href="#l162.130"></a><span id="l162.130"> }</span>
<a href="#l162.131"></a><span id="l162.131"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l163.1"></a><span id="l163.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-search-window-helpers.js</span>
<a href="#l163.2"></a><span id="l163.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-search-window-helpers.js</span>
<a href="#l163.3"></a><span id="l163.3" class="difflineat">@@ -1,27 +1,26 @@</span>
<a href="#l163.4"></a><span id="l163.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l163.5"></a><span id="l163.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l163.6"></a><span id="l163.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l163.7"></a><span id="l163.7"> </span>
<a href="#l163.8"></a><span id="l163.8"> &quot;use strict&quot;;</span>
<a href="#l163.9"></a><span id="l163.9"> </span>
<a href="#l163.10"></a><span id="l163.10"> var MODULE_NAME = &quot;search-window-helpers&quot;;</span>
<a href="#l163.11"></a><span id="l163.11" class="difflineminus">-</span>
<a href="#l163.12"></a><span id="l163.12"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l163.13"></a><span id="l163.13"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l163.14"></a><span id="l163.14"> </span>
<a href="#l163.15"></a><span id="l163.15"> var folderDisplayHelper;</span>
<a href="#l163.16"></a><span id="l163.16"> var mc;</span>
<a href="#l163.17"></a><span id="l163.17"> var windowHelper;</span>
<a href="#l163.18"></a><span id="l163.18"> </span>
<a href="#l163.19"></a><span id="l163.19"> function setupModule() {</span>
<a href="#l163.20"></a><span id="l163.20" class="difflineminus">-  folderDisplayHelper = collector.getModule('folder-display-helpers');</span>
<a href="#l163.21"></a><span id="l163.21" class="difflineplus">+  folderDisplayHelper = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l163.22"></a><span id="l163.22">   mc = folderDisplayHelper.mc;</span>
<a href="#l163.23"></a><span id="l163.23" class="difflineminus">-  windowHelper = collector.getModule('window-helpers');</span>
<a href="#l163.24"></a><span id="l163.24" class="difflineplus">+  windowHelper = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l163.25"></a><span id="l163.25"> }</span>
<a href="#l163.26"></a><span id="l163.26"> </span>
<a href="#l163.27"></a><span id="l163.27"> function installInto(module) {</span>
<a href="#l163.28"></a><span id="l163.28">   setupModule();</span>
<a href="#l163.29"></a><span id="l163.29"> </span>
<a href="#l163.30"></a><span id="l163.30">   // Now copy helper functions</span>
<a href="#l163.31"></a><span id="l163.31">   module.open_search_window = open_search_window;</span>
<a href="#l163.32"></a><span id="l163.32">   module.open_search_window_from_context_menu =</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l164.1"></a><span id="l164.1">rename from mail/test/mozmill/shared-modules/test-subscribe-window-helper.js</span>
<a href="#l164.2"></a><span id="l164.2">rename to mail/test/mozmill/shared-modules/test-subscribe-window-helpers.js</span>
<a href="#l164.3"></a><span id="l164.3" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-subscribe-window-helper.js</span>
<a href="#l164.4"></a><span id="l164.4" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-subscribe-window-helpers.js</span>
<a href="#l164.5"></a><span id="l164.5" class="difflineat">@@ -1,29 +1,28 @@</span>
<a href="#l164.6"></a><span id="l164.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l164.7"></a><span id="l164.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l164.8"></a><span id="l164.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l164.9"></a><span id="l164.9"> </span>
<a href="#l164.10"></a><span id="l164.10"> &quot;use strict&quot;;</span>
<a href="#l164.11"></a><span id="l164.11"> </span>
<a href="#l164.12"></a><span id="l164.12"> var MODULE_NAME = &quot;subscribe-window-helpers&quot;;</span>
<a href="#l164.13"></a><span id="l164.13"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l164.14"></a><span id="l164.14" class="difflineminus">-var MODULE_REQUIRES = ['window-helpers', 'folder-display-helpers',</span>
<a href="#l164.15"></a><span id="l164.15" class="difflineminus">-                         'keyboard-helpers'];</span>
<a href="#l164.16"></a><span id="l164.16" class="difflineplus">+var MODULE_REQUIRES = [&quot;window-helpers&quot;, &quot;folder-display-helpers&quot;, &quot;keyboard-helpers&quot;];</span>
<a href="#l164.17"></a><span id="l164.17"> </span>
<a href="#l164.18"></a><span id="l164.18"> var folderDisplayHelper;</span>
<a href="#l164.19"></a><span id="l164.19"> var mc;</span>
<a href="#l164.20"></a><span id="l164.20"> var windowHelper;</span>
<a href="#l164.21"></a><span id="l164.21"> var kh;</span>
<a href="#l164.22"></a><span id="l164.22"> </span>
<a href="#l164.23"></a><span id="l164.23"> function setupModule() {</span>
<a href="#l164.24"></a><span id="l164.24" class="difflineminus">-  folderDisplayHelper = collector.getModule('folder-display-helpers');</span>
<a href="#l164.25"></a><span id="l164.25" class="difflineplus">+  folderDisplayHelper = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l164.26"></a><span id="l164.26">   mc = folderDisplayHelper.mc;</span>
<a href="#l164.27"></a><span id="l164.27" class="difflineminus">-  windowHelper = collector.getModule('window-helpers');</span>
<a href="#l164.28"></a><span id="l164.28" class="difflineminus">-  kh = collector.getModule('keyboard-helpers');</span>
<a href="#l164.29"></a><span id="l164.29" class="difflineplus">+  windowHelper = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l164.30"></a><span id="l164.30" class="difflineplus">+  kh = collector.getModule(&quot;keyboard-helpers&quot;);</span>
<a href="#l164.31"></a><span id="l164.31"> }</span>
<a href="#l164.32"></a><span id="l164.32"> </span>
<a href="#l164.33"></a><span id="l164.33"> function installInto(module) {</span>
<a href="#l164.34"></a><span id="l164.34">   setupModule();</span>
<a href="#l164.35"></a><span id="l164.35"> </span>
<a href="#l164.36"></a><span id="l164.36">   // Now copy helper functions</span>
<a href="#l164.37"></a><span id="l164.37">   module.open_subscribe_window_from_context_menu =</span>
<a href="#l164.38"></a><span id="l164.38">     open_subscribe_window_from_context_menu;</span>
<a href="#l164.39"></a><span id="l164.39" class="difflineat">@@ -39,17 +38,17 @@ function installInto(module) {</span>
<a href="#l164.40"></a><span id="l164.40">  *        for the subscribe dialogue as parameter</span>
<a href="#l164.41"></a><span id="l164.41">  */</span>
<a href="#l164.42"></a><span id="l164.42"> function open_subscribe_window_from_context_menu(aFolder, aFunction) {</span>
<a href="#l164.43"></a><span id="l164.43">   folderDisplayHelper.right_click_on_folder(aFolder);</span>
<a href="#l164.44"></a><span id="l164.44">   let callback = function(controller) {</span>
<a href="#l164.45"></a><span id="l164.45">     // When the &quot;stop button&quot; is disabled, the panel is populated.</span>
<a href="#l164.46"></a><span id="l164.46">     controller.waitFor(() =&gt; controller.e(&quot;stopButton&quot;).disabled);</span>
<a href="#l164.47"></a><span id="l164.47">     aFunction(controller);</span>
<a href="#l164.48"></a><span id="l164.48" class="difflineminus">-  }</span>
<a href="#l164.49"></a><span id="l164.49" class="difflineplus">+  };</span>
<a href="#l164.50"></a><span id="l164.50">   windowHelper.plan_for_modal_dialog(&quot;mailnews:subscribe&quot;, callback);</span>
<a href="#l164.51"></a><span id="l164.51">   mc.click(mc.eid(&quot;folderPaneContext-subscribe&quot;));</span>
<a href="#l164.52"></a><span id="l164.52">   windowHelper.wait_for_modal_dialog(&quot;mailnews:subscribe&quot;);</span>
<a href="#l164.53"></a><span id="l164.53">   folderDisplayHelper.close_popup(mc, mc.eid(&quot;folderPaneContext&quot;));</span>
<a href="#l164.54"></a><span id="l164.54"> }</span>
<a href="#l164.55"></a><span id="l164.55"> </span>
<a href="#l164.56"></a><span id="l164.56"> /**</span>
<a href="#l164.57"></a><span id="l164.57">  * Enter a string in the text box for the search value.</span>
<a href="#l164.58"></a><span id="l164.58" class="difflineat">@@ -80,17 +79,17 @@ function check_searchview(swc) {</span>
<a href="#l164.59"></a><span id="l164.59">  * @param name Name of the newsgroup</span>
<a href="#l164.60"></a><span id="l164.60">  * @returns {Boolean} Result of the check</span>
<a href="#l164.61"></a><span id="l164.61">  */</span>
<a href="#l164.62"></a><span id="l164.62"> function check_newsgroup_displayed(swc, name) {</span>
<a href="#l164.63"></a><span id="l164.63">   let tree = swc.eid(&quot;searchTree&quot;).getNode();</span>
<a href="#l164.64"></a><span id="l164.64">   let treeview = tree.view;</span>
<a href="#l164.65"></a><span id="l164.65">   let nameCol = tree.columns.getColumnFor(swc.eid(&quot;nameColumn2&quot;).getNode());</span>
<a href="#l164.66"></a><span id="l164.66">   for (let i = 0; i &lt; treeview.rowCount; i++) {</span>
<a href="#l164.67"></a><span id="l164.67" class="difflineminus">-    if (treeview.getCellText(i,nameCol)==name)</span>
<a href="#l164.68"></a><span id="l164.68" class="difflineplus">+    if (treeview.getCellText(i, nameCol) == name)</span>
<a href="#l164.69"></a><span id="l164.69">       return true;</span>
<a href="#l164.70"></a><span id="l164.70">   }</span>
<a href="#l164.71"></a><span id="l164.71">   return false;</span>
<a href="#l164.72"></a><span id="l164.72"> }</span>
<a href="#l164.73"></a><span id="l164.73"> </span>
<a href="#l164.74"></a><span id="l164.74"> /**</span>
<a href="#l164.75"></a><span id="l164.75">  * Close a search window by calling window.close() on the controller.</span>
<a href="#l164.76"></a><span id="l164.76">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l165.1"></a><span id="l165.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l165.2"></a><span id="l165.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-window-helpers.js</span>
<a href="#l165.3"></a><span id="l165.3" class="difflineat">@@ -313,18 +313,17 @@ var WindowWatcher = {</span>
<a href="#l165.4"></a><span id="l165.4">       this._timer.cancel();</span>
<a href="#l165.5"></a><span id="l165.5"> </span>
<a href="#l165.6"></a><span id="l165.6">       let self = this;</span>
<a href="#l165.7"></a><span id="l165.7">       function startTest() {</span>
<a href="#l165.8"></a><span id="l165.8">         self.planForWindowClose(troller.window);</span>
<a href="#l165.9"></a><span id="l165.9">         try {</span>
<a href="#l165.10"></a><span id="l165.10">           let runner = new frame.Runner(collector);</span>
<a href="#l165.11"></a><span id="l165.11">           runner.wrapper(self.subTestFunc, troller);</span>
<a href="#l165.12"></a><span id="l165.12" class="difflineminus">-        }</span>
<a href="#l165.13"></a><span id="l165.13" class="difflineminus">-        finally {</span>
<a href="#l165.14"></a><span id="l165.14" class="difflineplus">+        } finally {</span>
<a href="#l165.15"></a><span id="l165.15">           self.subTestFunc = null;</span>
<a href="#l165.16"></a><span id="l165.16">         }</span>
<a href="#l165.17"></a><span id="l165.17"> </span>
<a href="#l165.18"></a><span id="l165.18">         // if the test failed, make sure we force the window closed...</span>
<a href="#l165.19"></a><span id="l165.19">         // except I'm not sure how to easily figure that out...</span>
<a href="#l165.20"></a><span id="l165.20">         // so just close it no matter what.</span>
<a href="#l165.21"></a><span id="l165.21">         troller.window.close();</span>
<a href="#l165.22"></a><span id="l165.22">         self.waitForWindowClose();</span>
<a href="#l165.23"></a><span id="l165.23" class="difflineat">@@ -371,21 +370,22 @@ var WindowWatcher = {</span>
<a href="#l165.24"></a><span id="l165.24">    * Symmetry for planForModalDialog; conceptually provides the waiting.  In</span>
<a href="#l165.25"></a><span id="l165.25">    *  reality, all we do is potentially soak up the event loop a little to</span>
<a href="#l165.26"></a><span id="l165.26">    */</span>
<a href="#l165.27"></a><span id="l165.27">   waitForModalDialog: function WindowWatcher_waitForModalDialog(aWindowType, aTimeout) {</span>
<a href="#l165.28"></a><span id="l165.28">     // did the window already come and go?</span>
<a href="#l165.29"></a><span id="l165.29">     if (this.subTestFunc == null)</span>
<a href="#l165.30"></a><span id="l165.30">       return;</span>
<a href="#l165.31"></a><span id="l165.31">     // spin the event loop until we the window has come and gone.</span>
<a href="#l165.32"></a><span id="l165.32" class="difflineminus">-    utils.waitFor(function () { return (this.waitingForOpen == null &amp;&amp;</span>
<a href="#l165.33"></a><span id="l165.33" class="difflineminus">-                                        this.monitorizeClose()); },</span>
<a href="#l165.34"></a><span id="l165.34" class="difflineminus">-                  &quot;Timeout waiting for modal dialog to open.&quot;,</span>
<a href="#l165.35"></a><span id="l165.35" class="difflineminus">-                  aTimeout || WINDOW_OPEN_TIMEOUT_MS,</span>
<a href="#l165.36"></a><span id="l165.36" class="difflineminus">-                  WINDOW_OPEN_CHECK_INTERVAL_MS, this);</span>
<a href="#l165.37"></a><span id="l165.37" class="difflineplus">+    utils.waitFor(</span>
<a href="#l165.38"></a><span id="l165.38" class="difflineplus">+      () =&gt; { return this.waitingForOpen == null &amp;&amp; this.monitorizeClose(); },</span>
<a href="#l165.39"></a><span id="l165.39" class="difflineplus">+      &quot;Timeout waiting for modal dialog to open.&quot;,</span>
<a href="#l165.40"></a><span id="l165.40" class="difflineplus">+      aTimeout || WINDOW_OPEN_TIMEOUT_MS,</span>
<a href="#l165.41"></a><span id="l165.41" class="difflineplus">+      WINDOW_OPEN_CHECK_INTERVAL_MS</span>
<a href="#l165.42"></a><span id="l165.42" class="difflineplus">+    );</span>
<a href="#l165.43"></a><span id="l165.43">     this.waitingForClose = null;</span>
<a href="#l165.44"></a><span id="l165.44">   },</span>
<a href="#l165.45"></a><span id="l165.45"> </span>
<a href="#l165.46"></a><span id="l165.46">   planForWindowClose: function WindowWatcher_planForWindowClose(aXULWindow) {</span>
<a href="#l165.47"></a><span id="l165.47">     let windowType = getWindowTypeOrId(aXULWindow.document.documentElement);</span>
<a href="#l165.48"></a><span id="l165.48">     this.waitingList.set(windowType, aXULWindow);</span>
<a href="#l165.49"></a><span id="l165.49">     this.waitingForClose = windowType;</span>
<a href="#l165.50"></a><span id="l165.50">   },</span>
<a href="#l165.51"></a><span id="l165.51" class="difflineat">@@ -422,47 +422,47 @@ var WindowWatcher = {</span>
<a href="#l165.52"></a><span id="l165.52">   },</span>
<a href="#l165.53"></a><span id="l165.53"> </span>
<a href="#l165.54"></a><span id="l165.54">   /**</span>
<a href="#l165.55"></a><span id="l165.55">    * Used by waitForWindowOpen to check all of the windows we are monitoring and</span>
<a href="#l165.56"></a><span id="l165.56">    *  then check if we have any results.</span>
<a href="#l165.57"></a><span id="l165.57">    *</span>
<a href="#l165.58"></a><span id="l165.58">    * @return true if we found what we were |waitingForOpen|, false otherwise.</span>
<a href="#l165.59"></a><span id="l165.59">    */</span>
<a href="#l165.60"></a><span id="l165.60" class="difflineminus">-  monitorizeOpen: function () {</span>
<a href="#l165.61"></a><span id="l165.61" class="difflineplus">+  monitorizeOpen() {</span>
<a href="#l165.62"></a><span id="l165.62">     for (let iWin = this.monitoringList.length - 1; iWin &gt;= 0; iWin--) {</span>
<a href="#l165.63"></a><span id="l165.63">       let xulWindow = this.monitoringList[iWin];</span>
<a href="#l165.64"></a><span id="l165.64">       if (this.consider(xulWindow))</span>
<a href="#l165.65"></a><span id="l165.65">         this.monitoringList.splice(iWin, 1);</span>
<a href="#l165.66"></a><span id="l165.66">     }</span>
<a href="#l165.67"></a><span id="l165.67"> </span>
<a href="#l165.68"></a><span id="l165.68">     return this.waitingList.has(this.waitingForOpen) &amp;&amp;</span>
<a href="#l165.69"></a><span id="l165.69">            (this.waitingList.get(this.waitingForOpen) != null);</span>
<a href="#l165.70"></a><span id="l165.70">   },</span>
<a href="#l165.71"></a><span id="l165.71"> </span>
<a href="#l165.72"></a><span id="l165.72">   /**</span>
<a href="#l165.73"></a><span id="l165.73">    * Used by waitForWindowClose to check if the window we are waiting to close</span>
<a href="#l165.74"></a><span id="l165.74">    *  actually closed yet.</span>
<a href="#l165.75"></a><span id="l165.75">    *</span>
<a href="#l165.76"></a><span id="l165.76">    * @return true if it closed.</span>
<a href="#l165.77"></a><span id="l165.77">    */</span>
<a href="#l165.78"></a><span id="l165.78" class="difflineminus">-  monitorizeClose: function () {</span>
<a href="#l165.79"></a><span id="l165.79" class="difflineplus">+  monitorizeClose() {</span>
<a href="#l165.80"></a><span id="l165.80">     return this.waitingList.get(this.waitingForClose) == null;</span>
<a href="#l165.81"></a><span id="l165.81">   },</span>
<a href="#l165.82"></a><span id="l165.82"> </span>
<a href="#l165.83"></a><span id="l165.83">   /**</span>
<a href="#l165.84"></a><span id="l165.84">    * A list of xul windows to monitor because they are loading and it's not yet</span>
<a href="#l165.85"></a><span id="l165.85">    *  possible to tell whether they are something we are looking for.</span>
<a href="#l165.86"></a><span id="l165.86">    */</span>
<a href="#l165.87"></a><span id="l165.87">   monitoringList: [],</span>
<a href="#l165.88"></a><span id="l165.88">   /**</span>
<a href="#l165.89"></a><span id="l165.89">    * Monitor the given window's loading process until we can determine whether</span>
<a href="#l165.90"></a><span id="l165.90">    *  it is what we are looking for.</span>
<a href="#l165.91"></a><span id="l165.91">    */</span>
<a href="#l165.92"></a><span id="l165.92" class="difflineminus">-  monitorWindowLoad: function(aXULWindow) {</span>
<a href="#l165.93"></a><span id="l165.93" class="difflineplus">+  monitorWindowLoad(aXULWindow) {</span>
<a href="#l165.94"></a><span id="l165.94">     this.monitoringList.push(aXULWindow);</span>
<a href="#l165.95"></a><span id="l165.95">   },</span>
<a href="#l165.96"></a><span id="l165.96"> </span>
<a href="#l165.97"></a><span id="l165.97">   /**</span>
<a href="#l165.98"></a><span id="l165.98">    * nsIWindowMediatorListener notification that a XUL window was opened.  We</span>
<a href="#l165.99"></a><span id="l165.99">    *  check out the window, and if we were not able to fully consider it, we</span>
<a href="#l165.100"></a><span id="l165.100">    *  add it to our monitoring list.</span>
<a href="#l165.101"></a><span id="l165.101">    */</span>
<a href="#l165.102"></a><span id="l165.102" class="difflineat">@@ -488,17 +488,17 @@ var WindowWatcher = {</span>
<a href="#l165.103"></a><span id="l165.103">   /**</span>
<a href="#l165.104"></a><span id="l165.104">    * Consider if the given window is something in our |waitingList|.</span>
<a href="#l165.105"></a><span id="l165.105">    *</span>
<a href="#l165.106"></a><span id="l165.106">    * @return true if we were able to fully consider the object, false if we were</span>
<a href="#l165.107"></a><span id="l165.107">    *     not and need to be called again on the window later.  This has no</span>
<a href="#l165.108"></a><span id="l165.108">    *     relation to whether the window was one in our waitingList or not.</span>
<a href="#l165.109"></a><span id="l165.109">    *     Check the waitingList structure for that.</span>
<a href="#l165.110"></a><span id="l165.110">    */</span>
<a href="#l165.111"></a><span id="l165.111" class="difflineminus">-  consider: function (aXULWindow) {</span>
<a href="#l165.112"></a><span id="l165.112" class="difflineplus">+  consider(aXULWindow) {</span>
<a href="#l165.113"></a><span id="l165.113">     let windowType = getWindowTypeForXulWindow(aXULWindow);</span>
<a href="#l165.114"></a><span id="l165.114">     if (windowType == null)</span>
<a href="#l165.115"></a><span id="l165.115">       return false;</span>
<a href="#l165.116"></a><span id="l165.116"> </span>
<a href="#l165.117"></a><span id="l165.117">     // stash the window if we were watching for it</span>
<a href="#l165.118"></a><span id="l165.118">     if (this.waitingList.has(windowType)) {</span>
<a href="#l165.119"></a><span id="l165.119">       this.waitingList.set(windowType, aXULWindow);</span>
<a href="#l165.120"></a><span id="l165.120">     }</span>
<a href="#l165.121"></a><span id="l165.121" class="difflineat">@@ -701,41 +701,40 @@ function wait_for_browser_load(aBrowser,</span>
<a href="#l165.122"></a><span id="l165.122">  * @param aURLOrPredicate The URL that should be loaded (string) or a predicate</span>
<a href="#l165.123"></a><span id="l165.123">  *                        for the URL (function).</span>
<a href="#l165.124"></a><span id="l165.124">  * @returns The frame wrapped in a MozMillController.</span>
<a href="#l165.125"></a><span id="l165.125">  */</span>
<a href="#l165.126"></a><span id="l165.126"> function wait_for_frame_load(aFrame, aURLOrPredicate) {</span>
<a href="#l165.127"></a><span id="l165.127">   let details = {</span>
<a href="#l165.128"></a><span id="l165.128">     // Not sure whether all of these really need to be getters, but this is the</span>
<a href="#l165.129"></a><span id="l165.129">     // safest thing to do.</span>
<a href="#l165.130"></a><span id="l165.130" class="difflineminus">-    get webProgress () {</span>
<a href="#l165.131"></a><span id="l165.131" class="difflineplus">+    get webProgress() {</span>
<a href="#l165.132"></a><span id="l165.132">       return aFrame.contentWindow.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l165.133"></a><span id="l165.133">              .getInterface(Ci.nsIWebNavigation)</span>
<a href="#l165.134"></a><span id="l165.134">              .QueryInterface(Ci.nsIWebProgress);</span>
<a href="#l165.135"></a><span id="l165.135">     },</span>
<a href="#l165.136"></a><span id="l165.136" class="difflineminus">-    get currentURI () { return NetUtil.newURI(aFrame.contentDocument.location); },</span>
<a href="#l165.137"></a><span id="l165.137" class="difflineminus">-    get contentWindow () { return aFrame.contentWindow; },</span>
<a href="#l165.138"></a><span id="l165.138" class="difflineplus">+    get currentURI() { return NetUtil.newURI(aFrame.contentDocument.location); },</span>
<a href="#l165.139"></a><span id="l165.139" class="difflineplus">+    get contentWindow() { return aFrame.contentWindow; },</span>
<a href="#l165.140"></a><span id="l165.140">   };</span>
<a href="#l165.141"></a><span id="l165.141">   return _wait_for_generic_load(details, aURLOrPredicate);</span>
<a href="#l165.142"></a><span id="l165.142"> }</span>
<a href="#l165.143"></a><span id="l165.143"> </span>
<a href="#l165.144"></a><span id="l165.144"> /**</span>
<a href="#l165.145"></a><span id="l165.145">  * Generic function to wait for some sort of document to load. We expect</span>
<a href="#l165.146"></a><span id="l165.146">  * aDetails to have three fields:</span>
<a href="#l165.147"></a><span id="l165.147">  * - webProgress: an nsIWebProgress associated with the contentWindow.</span>
<a href="#l165.148"></a><span id="l165.148">  * - currentURI: the currently loaded page (nsIURI).</span>
<a href="#l165.149"></a><span id="l165.149">  * - contentWindow: the content window.</span>
<a href="#l165.150"></a><span id="l165.150">  */</span>
<a href="#l165.151"></a><span id="l165.151"> function _wait_for_generic_load(aDetails, aURLOrPredicate) {</span>
<a href="#l165.152"></a><span id="l165.152">   let predicate;</span>
<a href="#l165.153"></a><span id="l165.153">   if (typeof aURLOrPredicate == &quot;string&quot;) {</span>
<a href="#l165.154"></a><span id="l165.154">     let expectedURL = NetUtil.newURI(aURLOrPredicate);</span>
<a href="#l165.155"></a><span id="l165.155">     predicate = url =&gt; expectedURL.equals(url);</span>
<a href="#l165.156"></a><span id="l165.156" class="difflineminus">-  }</span>
<a href="#l165.157"></a><span id="l165.157" class="difflineminus">-  else {</span>
<a href="#l165.158"></a><span id="l165.158" class="difflineplus">+  } else {</span>
<a href="#l165.159"></a><span id="l165.159">     predicate = aURLOrPredicate;</span>
<a href="#l165.160"></a><span id="l165.160">   }</span>
<a href="#l165.161"></a><span id="l165.161"> </span>
<a href="#l165.162"></a><span id="l165.162">   function isLoadedChecker() {</span>
<a href="#l165.163"></a><span id="l165.163">     if (aDetails.webProgress.isLoadingDocument !== false)</span>
<a href="#l165.164"></a><span id="l165.164">       return false;</span>
<a href="#l165.165"></a><span id="l165.165"> </span>
<a href="#l165.166"></a><span id="l165.166">     return predicate(aDetails.currentURI);</span>
<a href="#l165.167"></a><span id="l165.167" class="difflineat">@@ -768,20 +767,20 @@ var observationSaw = {};</span>
<a href="#l165.168"></a><span id="l165.168">  * Plan for a notification to be sent via the observer service.</span>
<a href="#l165.169"></a><span id="l165.169">  *</span>
<a href="#l165.170"></a><span id="l165.170">  * @param aTopic The topic that will be sent via the observer service.</span>
<a href="#l165.171"></a><span id="l165.171">  */</span>
<a href="#l165.172"></a><span id="l165.172"> function plan_for_observable_event(aTopic) {</span>
<a href="#l165.173"></a><span id="l165.173">   mark_action(&quot;fdh&quot;, &quot;plan_for_observable_event&quot;, [aTopic]);</span>
<a href="#l165.174"></a><span id="l165.174">   observationSaw[aTopic] = false;</span>
<a href="#l165.175"></a><span id="l165.175">   let waiter = observationWaitFuncs[aTopic] = {</span>
<a href="#l165.176"></a><span id="l165.176" class="difflineminus">-    observe: function() {</span>
<a href="#l165.177"></a><span id="l165.177" class="difflineplus">+    observe() {</span>
<a href="#l165.178"></a><span id="l165.178">       mark_action(&quot;winhelp&quot;, &quot;observed event&quot;, [aTopic]);</span>
<a href="#l165.179"></a><span id="l165.179">       observationSaw[aTopic] = true;</span>
<a href="#l165.180"></a><span id="l165.180" class="difflineminus">-    }</span>
<a href="#l165.181"></a><span id="l165.181" class="difflineplus">+    },</span>
<a href="#l165.182"></a><span id="l165.182">   };</span>
<a href="#l165.183"></a><span id="l165.183">   Services.obs.addObserver(waiter, aTopic);</span>
<a href="#l165.184"></a><span id="l165.184"> }</span>
<a href="#l165.185"></a><span id="l165.185"> </span>
<a href="#l165.186"></a><span id="l165.186"> /**</span>
<a href="#l165.187"></a><span id="l165.187">  * Wait for a notification (previously planned for via</span>
<a href="#l165.188"></a><span id="l165.188">  *  |plan_for_observable_event|) to fire.</span>
<a href="#l165.189"></a><span id="l165.189">  *</span>
<a href="#l165.190"></a><span id="l165.190" class="difflineat">@@ -790,18 +789,17 @@ function plan_for_observable_event(aTopi</span>
<a href="#l165.191"></a><span id="l165.191"> function wait_for_observable_event(aTopic) {</span>
<a href="#l165.192"></a><span id="l165.192">   mark_action(&quot;fdh&quot;, &quot;wait_for_observable_event&quot;, [aTopic]);</span>
<a href="#l165.193"></a><span id="l165.193">   try {</span>
<a href="#l165.194"></a><span id="l165.194">     function areWeThereYet() {</span>
<a href="#l165.195"></a><span id="l165.195">       return observationSaw[aTopic];</span>
<a href="#l165.196"></a><span id="l165.196">     }</span>
<a href="#l165.197"></a><span id="l165.197">     utils.waitFor(areWeThereYet,</span>
<a href="#l165.198"></a><span id="l165.198">                   &quot;Timed out waiting for notification: &quot; + aTopic);</span>
<a href="#l165.199"></a><span id="l165.199" class="difflineminus">-  }</span>
<a href="#l165.200"></a><span id="l165.200" class="difflineminus">-  finally {</span>
<a href="#l165.201"></a><span id="l165.201" class="difflineplus">+  } finally {</span>
<a href="#l165.202"></a><span id="l165.202">     Services.obs.removeObserver(observationWaitFuncs[aTopic], aTopic);</span>
<a href="#l165.203"></a><span id="l165.203">     delete observationWaitFuncs[aTopic];</span>
<a href="#l165.204"></a><span id="l165.204">     delete observationSaw[aTopic];</span>
<a href="#l165.205"></a><span id="l165.205">   }</span>
<a href="#l165.206"></a><span id="l165.206"> }</span>
<a href="#l165.207"></a><span id="l165.207"> </span>
<a href="#l165.208"></a><span id="l165.208"> /**</span>
<a href="#l165.209"></a><span id="l165.209">  * Resize given window to new dimensions.</span>
<a href="#l165.210"></a><span id="l165.210" class="difflineat">@@ -895,41 +893,37 @@ var AugmentEverybodyWith = {</span>
<a href="#l165.211"></a><span id="l165.211">      * @param aId The element id or the actual element.</span>
<a href="#l165.212"></a><span id="l165.212">      *</span>
<a href="#l165.213"></a><span id="l165.213">      * @return the anonymous element determined by the query found in the</span>
<a href="#l165.214"></a><span id="l165.214">      *  anonymous sub-tree of the element with the given id.</span>
<a href="#l165.215"></a><span id="l165.215">      */</span>
<a href="#l165.216"></a><span id="l165.216">     a: function _get_anon_element_by_id_and_query(aId, aQuery) {</span>
<a href="#l165.217"></a><span id="l165.217">       let realElem = (typeof(aId) == &quot;string&quot;) ?</span>
<a href="#l165.218"></a><span id="l165.218">                        this.window.document.getElementById(aId) : aId;</span>
<a href="#l165.219"></a><span id="l165.219" class="difflineminus">-      if (aQuery[&quot;class&quot;]) {</span>
<a href="#l165.220"></a><span id="l165.220" class="difflineplus">+      if (aQuery.class) {</span>
<a href="#l165.221"></a><span id="l165.221">         return this.window.document.getAnonymousElementByAttribute(</span>
<a href="#l165.222"></a><span id="l165.222" class="difflineminus">-          realElem, &quot;class&quot;, aQuery[&quot;class&quot;]);</span>
<a href="#l165.223"></a><span id="l165.223" class="difflineminus">-      }</span>
<a href="#l165.224"></a><span id="l165.224" class="difflineminus">-      else if(aQuery.crazyDeck != null) {</span>
<a href="#l165.225"></a><span id="l165.225" class="difflineplus">+          realElem, &quot;class&quot;, aQuery.class);</span>
<a href="#l165.226"></a><span id="l165.226" class="difflineplus">+      } else if (aQuery.crazyDeck != null) {</span>
<a href="#l165.227"></a><span id="l165.227">         let anonNodes = this.window.document.getAnonymousNodes(realElem);</span>
<a href="#l165.228"></a><span id="l165.228">         let index;</span>
<a href="#l165.229"></a><span id="l165.229">         if (realElem.hasAttribute(&quot;selectedIndex&quot;))</span>
<a href="#l165.230"></a><span id="l165.230">           index = parseInt(realElem.getAttribute(&quot;selectedIndex&quot;));</span>
<a href="#l165.231"></a><span id="l165.231">         else</span>
<a href="#l165.232"></a><span id="l165.232">           index = aQuery.crazyDeck;</span>
<a href="#l165.233"></a><span id="l165.233">         let elem = anonNodes[index];</span>
<a href="#l165.234"></a><span id="l165.234">         return elem;</span>
<a href="#l165.235"></a><span id="l165.235" class="difflineminus">-      }</span>
<a href="#l165.236"></a><span id="l165.236" class="difflineminus">-      else if(aQuery.tagName) {</span>
<a href="#l165.237"></a><span id="l165.237" class="difflineplus">+      } else if (aQuery.tagName) {</span>
<a href="#l165.238"></a><span id="l165.238">         let anonNodes = this.window.document.getAnonymousNodes(realElem);</span>
<a href="#l165.239"></a><span id="l165.239" class="difflineminus">-        let index;</span>
<a href="#l165.240"></a><span id="l165.240">         for (let iNode = 0; iNode &lt; anonNodes.length; iNode++) {</span>
<a href="#l165.241"></a><span id="l165.241">           let node = anonNodes[iNode];</span>
<a href="#l165.242"></a><span id="l165.242">           let named = node.querySelector(aQuery.tagName);</span>
<a href="#l165.243"></a><span id="l165.243">           if (named)</span>
<a href="#l165.244"></a><span id="l165.244">             return named;</span>
<a href="#l165.245"></a><span id="l165.245">         }</span>
<a href="#l165.246"></a><span id="l165.246" class="difflineminus">-      }</span>
<a href="#l165.247"></a><span id="l165.247" class="difflineminus">-      else {</span>
<a href="#l165.248"></a><span id="l165.248" class="difflineplus">+      } else {</span>
<a href="#l165.249"></a><span id="l165.249">         let msg = &quot;Query constraint not implemented, query contained:&quot;;</span>
<a href="#l165.250"></a><span id="l165.250">         for (let [key, val] of Object.entries(aQuery)) {</span>
<a href="#l165.251"></a><span id="l165.251">           msg += &quot; '&quot; + key + &quot;': &quot; + val;</span>
<a href="#l165.252"></a><span id="l165.252">         }</span>
<a href="#l165.253"></a><span id="l165.253">         throw new Error(msg);</span>
<a href="#l165.254"></a><span id="l165.254">       }</span>
<a href="#l165.255"></a><span id="l165.255">       return null;</span>
<a href="#l165.256"></a><span id="l165.256">     },</span>
<a href="#l165.257"></a><span id="l165.257" class="difflineat">@@ -989,17 +983,17 @@ var AugmentEverybodyWith = {</span>
<a href="#l165.258"></a><span id="l165.258">       for (let [iAction, actionObj] of aActions.entries()) {</span>
<a href="#l165.259"></a><span id="l165.259">         /**</span>
<a href="#l165.260"></a><span id="l165.260">          * Check if aNode attributes match all those given in actionObj.</span>
<a href="#l165.261"></a><span id="l165.261">          * Nodes that are obvious containers are skipped, and their children</span>
<a href="#l165.262"></a><span id="l165.262">          * will be used to recursively find a match instead.</span>
<a href="#l165.263"></a><span id="l165.263">          */</span>
<a href="#l165.264"></a><span id="l165.264">         let findMatch = function(aNode) {</span>
<a href="#l165.265"></a><span id="l165.265">           // Ignore some elements and just use their children instead.</span>
<a href="#l165.266"></a><span id="l165.266" class="difflineminus">-          if (aNode.localName == &quot;hbox&quot; || aNode.localName == &quot;vbox&quot; ) {</span>
<a href="#l165.267"></a><span id="l165.267" class="difflineplus">+          if (aNode.localName == &quot;hbox&quot; || aNode.localName == &quot;vbox&quot;) {</span>
<a href="#l165.268"></a><span id="l165.268">             for (let i = 0; i &lt; aNode.children.length; i++) {</span>
<a href="#l165.269"></a><span id="l165.269">               let childMatch = findMatch(aNode.children[i]);</span>
<a href="#l165.270"></a><span id="l165.270">               if (childMatch)</span>
<a href="#l165.271"></a><span id="l165.271">                 return childMatch;</span>
<a href="#l165.272"></a><span id="l165.272">             }</span>
<a href="#l165.273"></a><span id="l165.273">             return null;</span>
<a href="#l165.274"></a><span id="l165.274">           }</span>
<a href="#l165.275"></a><span id="l165.275"> </span>
<a href="#l165.276"></a><span id="l165.276" class="difflineat">@@ -1030,24 +1024,25 @@ var AugmentEverybodyWith = {</span>
<a href="#l165.277"></a><span id="l165.277">         }</span>
<a href="#l165.278"></a><span id="l165.278"> </span>
<a href="#l165.279"></a><span id="l165.279">         if ((matchingNode.localName == &quot;splitmenu&quot;) &amp;&amp;</span>
<a href="#l165.280"></a><span id="l165.280">             ((iAction &lt; aActions.length - 1) || aKeepOpen)) {</span>
<a href="#l165.281"></a><span id="l165.281">           // For splitmenus, click the submenu arrow to open its menupopup,</span>
<a href="#l165.282"></a><span id="l165.282">           // unless this is the last item being searched for. In that case,</span>
<a href="#l165.283"></a><span id="l165.283">           // click the main item.</span>
<a href="#l165.284"></a><span id="l165.284">           this.click(new elib.Elem(matchingNode.menu));</span>
<a href="#l165.285"></a><span id="l165.285" class="difflineminus">-        } else</span>
<a href="#l165.286"></a><span id="l165.286" class="difflineplus">+        } else {</span>
<a href="#l165.287"></a><span id="l165.287">           this.click(new elib.Elem(matchingNode));</span>
<a href="#l165.288"></a><span id="l165.288" class="difflineplus">+        }</span>
<a href="#l165.289"></a><span id="l165.289"> </span>
<a href="#l165.290"></a><span id="l165.290">         let newPopup = null;</span>
<a href="#l165.291"></a><span id="l165.291" class="difflineminus">-        if (&quot;menupopup&quot; in matchingNode)</span>
<a href="#l165.292"></a><span id="l165.292" class="difflineplus">+        if (&quot;menupopup&quot; in matchingNode) {</span>
<a href="#l165.293"></a><span id="l165.293">           newPopup = matchingNode.menupopup;</span>
<a href="#l165.294"></a><span id="l165.294" class="difflineminus">-        else if ((matchingNode.localName == &quot;splitmenu&quot;) &amp;&amp;</span>
<a href="#l165.295"></a><span id="l165.295" class="difflineminus">-                 (&quot;menupopup&quot; in matchingNode.menu)) {</span>
<a href="#l165.296"></a><span id="l165.296" class="difflineplus">+        } else if ((matchingNode.localName == &quot;splitmenu&quot;) &amp;&amp;</span>
<a href="#l165.297"></a><span id="l165.297" class="difflineplus">+                   (&quot;menupopup&quot; in matchingNode.menu)) {</span>
<a href="#l165.298"></a><span id="l165.298">           // We should actually fetch matchingNode.menu.menupopup here,</span>
<a href="#l165.299"></a><span id="l165.299">           // but it doesn't seem to work.</span>
<a href="#l165.300"></a><span id="l165.300">           newPopup = matchingNode.querySelector(&quot;menupopup&quot;);</span>
<a href="#l165.301"></a><span id="l165.301">         }</span>
<a href="#l165.302"></a><span id="l165.302">         if (newPopup) {</span>
<a href="#l165.303"></a><span id="l165.303">           curPopup = newPopup;</span>
<a href="#l165.304"></a><span id="l165.304">           closeStack.push(curPopup);</span>
<a href="#l165.305"></a><span id="l165.305">           utils.waitFor(() =&gt; curPopup.state == &quot;open&quot;,</span>
<a href="#l165.306"></a><span id="l165.306" class="difflineat">@@ -1055,19 +1050,18 @@ var AugmentEverybodyWith = {</span>
<a href="#l165.307"></a><span id="l165.307">                                &quot;; id=&quot; + curPopup.id + &quot;, state=&quot; + curPopup.state),</span>
<a href="#l165.308"></a><span id="l165.308">                         5000, 50);</span>
<a href="#l165.309"></a><span id="l165.309">         }</span>
<a href="#l165.310"></a><span id="l165.310">       }</span>
<a href="#l165.311"></a><span id="l165.311"> </span>
<a href="#l165.312"></a><span id="l165.312">       if (!aKeepOpen) {</span>
<a href="#l165.313"></a><span id="l165.313">         this.close_popup_sequence(closeStack);</span>
<a href="#l165.314"></a><span id="l165.314">         return [];</span>
<a href="#l165.315"></a><span id="l165.315" class="difflineminus">-      } else {</span>
<a href="#l165.316"></a><span id="l165.316" class="difflineminus">-        return closeStack;</span>
<a href="#l165.317"></a><span id="l165.317">       }</span>
<a href="#l165.318"></a><span id="l165.318" class="difflineplus">+      return closeStack;</span>
<a href="#l165.319"></a><span id="l165.319">     },</span>
<a href="#l165.320"></a><span id="l165.320"> </span>
<a href="#l165.321"></a><span id="l165.321">     /**</span>
<a href="#l165.322"></a><span id="l165.322">      * Close given menupopups.</span>
<a href="#l165.323"></a><span id="l165.323">      *</span>
<a href="#l165.324"></a><span id="l165.324">      * @param aCloseStack  An array of menupopup elements that are to be closed.</span>
<a href="#l165.325"></a><span id="l165.325">      *                     The elements are processed from the end of the array</span>
<a href="#l165.326"></a><span id="l165.326">      *                     to the front (a stack).</span>
<a href="#l165.327"></a><span id="l165.327" class="difflineat">@@ -1084,31 +1078,32 @@ var AugmentEverybodyWith = {</span>
<a href="#l165.328"></a><span id="l165.328">     },</span>
<a href="#l165.329"></a><span id="l165.329"> </span>
<a href="#l165.330"></a><span id="l165.330">     /**</span>
<a href="#l165.331"></a><span id="l165.331">      * Get dropmarker arrow element from a toolbarbutton</span>
<a href="#l165.332"></a><span id="l165.332">      *</span>
<a href="#l165.333"></a><span id="l165.333">      * @param aNode  An element containing a dropmarker:</span>
<a href="#l165.334"></a><span id="l165.334">      * a &lt;toobalbuttton type=&quot;menu-button&quot;&gt;. (Only usage left due to de-xbl).</span>
<a href="#l165.335"></a><span id="l165.335">      */</span>
<a href="#l165.336"></a><span id="l165.336" class="difflineminus">-    get_menu_dropmarker: function(aNode) {</span>
<a href="#l165.337"></a><span id="l165.337" class="difflineplus">+    get_menu_dropmarker(aNode) {</span>
<a href="#l165.338"></a><span id="l165.338">       let children = aNode.ownerDocument.getAnonymousNodes(aNode);</span>
<a href="#l165.339"></a><span id="l165.339">       for (let node of children) {</span>
<a href="#l165.340"></a><span id="l165.340">         if (node.tagName == &quot;xul:dropmarker&quot;)</span>
<a href="#l165.341"></a><span id="l165.341">           return node;</span>
<a href="#l165.342"></a><span id="l165.342">       }</span>
<a href="#l165.343"></a><span id="l165.343" class="difflineplus">+      return null;</span>
<a href="#l165.344"></a><span id="l165.344">     },</span>
<a href="#l165.345"></a><span id="l165.345"> </span>
<a href="#l165.346"></a><span id="l165.346">     /**</span>
<a href="#l165.347"></a><span id="l165.347">      * mark_action helper method that produces something that can be concat()ed</span>
<a href="#l165.348"></a><span id="l165.348">      *  onto a list being passed to mark_action in order to describe the focus</span>
<a href="#l165.349"></a><span id="l165.349">      *  state of the window.  For now this will be a variable-length list but</span>
<a href="#l165.350"></a><span id="l165.350">      *  could be changed to a single object in the future.</span>
<a href="#l165.351"></a><span id="l165.351">      */</span>
<a href="#l165.352"></a><span id="l165.352" class="difflineminus">-    describeFocus: function() {</span>
<a href="#l165.353"></a><span id="l165.353" class="difflineplus">+    describeFocus() {</span>
<a href="#l165.354"></a><span id="l165.354">       let arr = [</span>
<a href="#l165.355"></a><span id="l165.355">         &quot;in window:&quot;,</span>
<a href="#l165.356"></a><span id="l165.356">         getWindowTypeForXulWindow(this.window) + &quot; (&quot; +</span>
<a href="#l165.357"></a><span id="l165.357">           getUniqueIdForXulWindow(this.window) + &quot;)&quot;];</span>
<a href="#l165.358"></a><span id="l165.358">       let focusedWinOut = {}, focusedElement, curWindow = this.window;</span>
<a href="#l165.359"></a><span id="l165.359">       // Use the focus manager to walk down through focused sub-frames so</span>
<a href="#l165.360"></a><span id="l165.360">       //  in the event that there is no focused element but there is a focused</span>
<a href="#l165.361"></a><span id="l165.361">       //  sub-frame, we can know that.</span>
<a href="#l165.362"></a><span id="l165.362" class="difflineat">@@ -1125,17 +1120,17 @@ var AugmentEverybodyWith = {</span>
<a href="#l165.363"></a><span id="l165.363">         }</span>
<a href="#l165.364"></a><span id="l165.364">         break;</span>
<a href="#l165.365"></a><span id="l165.365">       }</span>
<a href="#l165.366"></a><span id="l165.366"> </span>
<a href="#l165.367"></a><span id="l165.367">       return arr;</span>
<a href="#l165.368"></a><span id="l165.368">     },</span>
<a href="#l165.369"></a><span id="l165.369">   },</span>
<a href="#l165.370"></a><span id="l165.370">   getters: {</span>
<a href="#l165.371"></a><span id="l165.371" class="difflineminus">-    focusedElement: function() {</span>
<a href="#l165.372"></a><span id="l165.372" class="difflineplus">+    focusedElement() {</span>
<a href="#l165.373"></a><span id="l165.373">       let ignoredFocusedWindow = {};</span>
<a href="#l165.374"></a><span id="l165.374">       return Services.focus.getFocusedElementForWindow(this.window, true,</span>
<a href="#l165.375"></a><span id="l165.375">                                                        ignoredFocusedWindow);</span>
<a href="#l165.376"></a><span id="l165.376">     },</span>
<a href="#l165.377"></a><span id="l165.377">   },</span>
<a href="#l165.378"></a><span id="l165.378"> };</span>
<a href="#l165.379"></a><span id="l165.379"> </span>
<a href="#l165.380"></a><span id="l165.380"> /**</span>
<a href="#l165.381"></a><span id="l165.381" class="difflineat">@@ -1145,17 +1140,17 @@ var AugmentEverybodyWith = {</span>
<a href="#l165.382"></a><span id="l165.382">  */</span>
<a href="#l165.383"></a><span id="l165.383"> var MOUSE_OPS_TO_WRAP = [</span>
<a href="#l165.384"></a><span id="l165.384">   &quot;click&quot;, &quot;doubleClick&quot;, &quot;mouseDown&quot;, &quot;mouseOut&quot;, &quot;mouseOver&quot;, &quot;mouseUp&quot;,</span>
<a href="#l165.385"></a><span id="l165.385">   &quot;middleClick&quot;, &quot;rightClick&quot;,</span>
<a href="#l165.386"></a><span id="l165.386"> ];</span>
<a href="#l165.387"></a><span id="l165.387"> </span>
<a href="#l165.388"></a><span id="l165.388"> for (let mouseOp of MOUSE_OPS_TO_WRAP) {</span>
<a href="#l165.389"></a><span id="l165.389">   let thisMouseOp = mouseOp;</span>
<a href="#l165.390"></a><span id="l165.390" class="difflineminus">-  let wrapperFunc = function (aElem, aLeft, aTop) {</span>
<a href="#l165.391"></a><span id="l165.391" class="difflineplus">+  let wrapperFunc = function(aElem, aLeft, aTop) {</span>
<a href="#l165.392"></a><span id="l165.392">     let el = aElem.getNode();</span>
<a href="#l165.393"></a><span id="l165.393">     let rect = el.getBoundingClientRect();</span>
<a href="#l165.394"></a><span id="l165.394">     if (aLeft === undefined)</span>
<a href="#l165.395"></a><span id="l165.395">       aLeft = rect.width / 2;</span>
<a href="#l165.396"></a><span id="l165.396">     if (aTop === undefined)</span>
<a href="#l165.397"></a><span id="l165.397">       aTop = rect.height / 2;</span>
<a href="#l165.398"></a><span id="l165.398">     // claim to be folder-display-helper since this is an explicit action</span>
<a href="#l165.399"></a><span id="l165.399">     mark_action(&quot;fdh&quot;, thisMouseOp,</span>
<a href="#l165.400"></a><span id="l165.400" class="difflineat">@@ -1205,29 +1200,29 @@ var PerWindowTypeAugmentations = {</span>
<a href="#l165.401"></a><span id="l165.401">       // all of these dudes</span>
<a href="#l165.402"></a><span id="l165.402">       folderDisplay: &quot;gFolderDisplay&quot;,</span>
<a href="#l165.403"></a><span id="l165.403">       messageDisplay: &quot;gMessageDisplay&quot;,</span>
<a href="#l165.404"></a><span id="l165.404">     },</span>
<a href="#l165.405"></a><span id="l165.405">     /**</span>
<a href="#l165.406"></a><span id="l165.406">      * Custom getters whose |this| is the controller.</span>
<a href="#l165.407"></a><span id="l165.407">      */</span>
<a href="#l165.408"></a><span id="l165.408">     getters: {</span>
<a href="#l165.409"></a><span id="l165.409" class="difflineminus">-      dbView: function () {</span>
<a href="#l165.410"></a><span id="l165.410" class="difflineplus">+      dbView() {</span>
<a href="#l165.411"></a><span id="l165.411">         return this.folderDisplay.view.dbView;</span>
<a href="#l165.412"></a><span id="l165.412">       },</span>
<a href="#l165.413"></a><span id="l165.413" class="difflineminus">-      contentPane: function () {</span>
<a href="#l165.414"></a><span id="l165.414" class="difflineplus">+      contentPane() {</span>
<a href="#l165.415"></a><span id="l165.415">         return this.tabmail.getBrowserForSelectedTab();</span>
<a href="#l165.416"></a><span id="l165.416">       },</span>
<a href="#l165.417"></a><span id="l165.417">     },</span>
<a href="#l165.418"></a><span id="l165.418"> </span>
<a href="#l165.419"></a><span id="l165.419">     /**</span>
<a href="#l165.420"></a><span id="l165.420">      * Invoked when we are augmenting a controller.  This is a great time to</span>
<a href="#l165.421"></a><span id="l165.421">      *  poke into the global namespace as required.</span>
<a href="#l165.422"></a><span id="l165.422">      */</span>
<a href="#l165.423"></a><span id="l165.423" class="difflineminus">-    onAugment: function(aController) {</span>
<a href="#l165.424"></a><span id="l165.424" class="difflineplus">+    onAugment(aController) {</span>
<a href="#l165.425"></a><span id="l165.425">       // -- turn off summarization's stabilization logic for now by setting the</span>
<a href="#l165.426"></a><span id="l165.426">       //  timer interval to 0.  We do need to make sure that we drain the event</span>
<a href="#l165.427"></a><span id="l165.427">       //  queue after performing anything that will summarize, but use of</span>
<a href="#l165.428"></a><span id="l165.428">       //  assert_selected_and_displayed in test-folder-display-helpers should</span>
<a href="#l165.429"></a><span id="l165.429">       //  handle that.</span>
<a href="#l165.430"></a><span id="l165.430">       aController.window.MessageDisplayWidget.prototype</span>
<a href="#l165.431"></a><span id="l165.431">                  .SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS = 0;</span>
<a href="#l165.432"></a><span id="l165.432">     },</span>
<a href="#l165.433"></a><span id="l165.433" class="difflineat">@@ -1242,64 +1237,64 @@ var PerWindowTypeAugmentations = {</span>
<a href="#l165.434"></a><span id="l165.434">         method: &quot;OnUnloadMessenger&quot;,</span>
<a href="#l165.435"></a><span id="l165.435">         onGlobal: true,</span>
<a href="#l165.436"></a><span id="l165.436">         reportAs: &quot;OnUnloadMessenger&quot;,</span>
<a href="#l165.437"></a><span id="l165.437">       },</span>
<a href="#l165.438"></a><span id="l165.438">       // goDoCommand command gobbling notification</span>
<a href="#l165.439"></a><span id="l165.439">       {</span>
<a href="#l165.440"></a><span id="l165.440">         method: &quot;goDoCommand&quot;,</span>
<a href="#l165.441"></a><span id="l165.441">         onGlobal: true,</span>
<a href="#l165.442"></a><span id="l165.442" class="difflineminus">-        doBefore: function(command) {</span>
<a href="#l165.443"></a><span id="l165.443" class="difflineplus">+        doBefore(command) {</span>
<a href="#l165.444"></a><span id="l165.444">           let controller = this.top.document</span>
<a href="#l165.445"></a><span id="l165.445">                              .commandDispatcher</span>
<a href="#l165.446"></a><span id="l165.446">                              .getControllerForCommand(command);</span>
<a href="#l165.447"></a><span id="l165.447">           if (controller &amp;&amp; !controller.isCommandEnabled(command))</span>
<a href="#l165.448"></a><span id="l165.448">             mark_action(&quot;winhelp&quot;, &quot;goDoCommand&quot;,</span>
<a href="#l165.449"></a><span id="l165.449">                         [&quot;about to ignore command because it's disabled:&quot;,</span>
<a href="#l165.450"></a><span id="l165.450">                          command]);</span>
<a href="#l165.451"></a><span id="l165.451" class="difflineminus">-        }</span>
<a href="#l165.452"></a><span id="l165.452" class="difflineplus">+        },</span>
<a href="#l165.453"></a><span id="l165.453">       },</span>
<a href="#l165.454"></a><span id="l165.454">       // DefaultController command gobbling notification</span>
<a href="#l165.455"></a><span id="l165.455">       {</span>
<a href="#l165.456"></a><span id="l165.456">         method: &quot;doCommand&quot;,</span>
<a href="#l165.457"></a><span id="l165.457">         onObject: &quot;DefaultController&quot;,</span>
<a href="#l165.458"></a><span id="l165.458" class="difflineminus">-        doBefore: function(command) {</span>
<a href="#l165.459"></a><span id="l165.459" class="difflineplus">+        doBefore(command) {</span>
<a href="#l165.460"></a><span id="l165.460">           if (!this.isCommandEnabled(command))</span>
<a href="#l165.461"></a><span id="l165.461">             mark_action(&quot;winhelp&quot;, &quot;DC_doCommand&quot;,</span>
<a href="#l165.462"></a><span id="l165.462">                         [&quot;about to ignore command because it's disabled:&quot;,</span>
<a href="#l165.463"></a><span id="l165.463">                          command]);</span>
<a href="#l165.464"></a><span id="l165.464" class="difflineminus">-        }</span>
<a href="#l165.465"></a><span id="l165.465" class="difflineplus">+        },</span>
<a href="#l165.466"></a><span id="l165.466">       },</span>
<a href="#l165.467"></a><span id="l165.467">       // FolderDisplayWidget command invocations</span>
<a href="#l165.468"></a><span id="l165.468">       {</span>
<a href="#l165.469"></a><span id="l165.469">         method: &quot;doCommand&quot;,</span>
<a href="#l165.470"></a><span id="l165.470">         onConstructor: &quot;FolderDisplayWidget&quot;,</span>
<a href="#l165.471"></a><span id="l165.471">         reportAs: &quot;FDW_doCommand&quot;,</span>
<a href="#l165.472"></a><span id="l165.472">       },</span>
<a href="#l165.473"></a><span id="l165.473">       {</span>
<a href="#l165.474"></a><span id="l165.474">         method: &quot;doCommandWithFolder&quot;,</span>
<a href="#l165.475"></a><span id="l165.475">         onConstructor: &quot;FolderDisplayWidget&quot;,</span>
<a href="#l165.476"></a><span id="l165.476">         reportAs: &quot;FDW_doCommandWithFolder&quot;,</span>
<a href="#l165.477"></a><span id="l165.477">       },</span>
<a href="#l165.478"></a><span id="l165.478">       // MessageDisplayWidget annotation</span>
<a href="#l165.479"></a><span id="l165.479">       {</span>
<a href="#l165.480"></a><span id="l165.480">         method: &quot;onLoadStarted&quot;,</span>
<a href="#l165.481"></a><span id="l165.481">         onConstructor: &quot;MessageDisplayWidget&quot;,</span>
<a href="#l165.482"></a><span id="l165.482" class="difflineminus">-        doBefore: function() {</span>
<a href="#l165.483"></a><span id="l165.483" class="difflineplus">+        doBefore() {</span>
<a href="#l165.484"></a><span id="l165.484">           mark_action(&quot;winhelp&quot;, &quot;MD_onLoadStarted&quot;,</span>
<a href="#l165.485"></a><span id="l165.485">                       [&quot;singleMessageDisplay?&quot;, this.singleMessageDisplay]);</span>
<a href="#l165.486"></a><span id="l165.486" class="difflineminus">-        }</span>
<a href="#l165.487"></a><span id="l165.487" class="difflineplus">+        },</span>
<a href="#l165.488"></a><span id="l165.488">       },</span>
<a href="#l165.489"></a><span id="l165.489">       {</span>
<a href="#l165.490"></a><span id="l165.490">         method: &quot;onLoadCompleted&quot;,</span>
<a href="#l165.491"></a><span id="l165.491">         onConstructor: &quot;MessageDisplayWidget&quot;,</span>
<a href="#l165.492"></a><span id="l165.492" class="difflineminus">-        doBefore: function() {</span>
<a href="#l165.493"></a><span id="l165.493" class="difflineplus">+        doBefore() {</span>
<a href="#l165.494"></a><span id="l165.494">           mark_action(&quot;winhelp&quot;, &quot;MD_onLoadCompleted&quot;,</span>
<a href="#l165.495"></a><span id="l165.495">                       [&quot;singleMessageDisplay?&quot;, this.singleMessageDisplay]);</span>
<a href="#l165.496"></a><span id="l165.496" class="difflineminus">-        }</span>
<a href="#l165.497"></a><span id="l165.497" class="difflineplus">+        },</span>
<a href="#l165.498"></a><span id="l165.498">       },</span>
<a href="#l165.499"></a><span id="l165.499">       // Message summarization annotations</span>
<a href="#l165.500"></a><span id="l165.500">       {</span>
<a href="#l165.501"></a><span id="l165.501">         method: &quot;summarizeThread&quot;,</span>
<a href="#l165.502"></a><span id="l165.502">         onGlobal: true,</span>
<a href="#l165.503"></a><span id="l165.503">         reportAs: &quot;summarizeThread&quot;,</span>
<a href="#l165.504"></a><span id="l165.504">         showArgs: false,</span>
<a href="#l165.505"></a><span id="l165.505">       },</span>
<a href="#l165.506"></a><span id="l165.506" class="difflineat">@@ -1326,17 +1321,17 @@ var PerWindowTypeAugmentations = {</span>
<a href="#l165.507"></a><span id="l165.507">       contentPane: &quot;messagepane&quot;,</span>
<a href="#l165.508"></a><span id="l165.508">     },</span>
<a href="#l165.509"></a><span id="l165.509">     // the load is deferred, so use a getter.</span>
<a href="#l165.510"></a><span id="l165.510">     globalsToExposeViaGetters: {</span>
<a href="#l165.511"></a><span id="l165.511">       folderDisplay: &quot;gFolderDisplay&quot;,</span>
<a href="#l165.512"></a><span id="l165.512">       messageDisplay: &quot;gMessageDisplay&quot;,</span>
<a href="#l165.513"></a><span id="l165.513">     },</span>
<a href="#l165.514"></a><span id="l165.514">     getters: {</span>
<a href="#l165.515"></a><span id="l165.515" class="difflineminus">-      dbView: function () {</span>
<a href="#l165.516"></a><span id="l165.516" class="difflineplus">+      dbView() {</span>
<a href="#l165.517"></a><span id="l165.517">         return this.folderDisplay.view.dbView;</span>
<a href="#l165.518"></a><span id="l165.518">       },</span>
<a href="#l165.519"></a><span id="l165.519">     },</span>
<a href="#l165.520"></a><span id="l165.520">   },</span>
<a href="#l165.521"></a><span id="l165.521"> </span>
<a href="#l165.522"></a><span id="l165.522">   /**</span>
<a href="#l165.523"></a><span id="l165.523">    * The search window, via control-shift-F.</span>
<a href="#l165.524"></a><span id="l165.524">    */</span>
<a href="#l165.525"></a><span id="l165.525" class="difflineat">@@ -1346,20 +1341,20 @@ var PerWindowTypeAugmentations = {</span>
<a href="#l165.526"></a><span id="l165.526">     },</span>
<a href="#l165.527"></a><span id="l165.527">     globalsToExposeAtStartup: {</span>
<a href="#l165.528"></a><span id="l165.528">       folderDisplay: &quot;gFolderDisplay&quot;,</span>
<a href="#l165.529"></a><span id="l165.529">     },</span>
<a href="#l165.530"></a><span id="l165.530">     globalsToExposeViaGetters: {</span>
<a href="#l165.531"></a><span id="l165.531">       currentFolder: &quot;gCurrentFolder&quot;,</span>
<a href="#l165.532"></a><span id="l165.532">     },</span>
<a href="#l165.533"></a><span id="l165.533">     getters: {</span>
<a href="#l165.534"></a><span id="l165.534" class="difflineminus">-      dbView: function () {</span>
<a href="#l165.535"></a><span id="l165.535" class="difflineplus">+      dbView() {</span>
<a href="#l165.536"></a><span id="l165.536">         return this.folderDisplay.view.dbView;</span>
<a href="#l165.537"></a><span id="l165.537" class="difflineminus">-      }</span>
<a href="#l165.538"></a><span id="l165.538" class="difflineminus">-    }</span>
<a href="#l165.539"></a><span id="l165.539" class="difflineplus">+      },</span>
<a href="#l165.540"></a><span id="l165.540" class="difflineplus">+    },</span>
<a href="#l165.541"></a><span id="l165.541">   },</span>
<a href="#l165.542"></a><span id="l165.542"> };</span>
<a href="#l165.543"></a><span id="l165.543"> </span>
<a href="#l165.544"></a><span id="l165.544"> function _augment_helper(aController, aAugmentDef) {</span>
<a href="#l165.545"></a><span id="l165.545">   if (aAugmentDef.elementsToExpose) {</span>
<a href="#l165.546"></a><span id="l165.546">     for (let key in aAugmentDef.elementsToExpose) {</span>
<a href="#l165.547"></a><span id="l165.547">       let value = aAugmentDef.elementsToExpose[key];</span>
<a href="#l165.548"></a><span id="l165.548">       aController[key] = aController.window.document.getElementById(value);</span>
<a href="#l165.549"></a><span id="l165.549" class="difflineat">@@ -1403,27 +1398,25 @@ function _augment_helper(aController, aA</span>
<a href="#l165.550"></a><span id="l165.550">   if (aAugmentDef.debugTrace) {</span>
<a href="#l165.551"></a><span id="l165.551">     let win = aController.window;</span>
<a href="#l165.552"></a><span id="l165.552">     for (let traceDef of aAugmentDef.debugTrace) {</span>
<a href="#l165.553"></a><span id="l165.553">       let baseObj, useThis;</span>
<a href="#l165.554"></a><span id="l165.554">       // - Get the object that actually has the method to wrap</span>
<a href="#l165.555"></a><span id="l165.555">       if (traceDef.hasOwnProperty(&quot;onGlobal&quot;)) {</span>
<a href="#l165.556"></a><span id="l165.556">         baseObj = win;</span>
<a href="#l165.557"></a><span id="l165.557">         useThis = false;</span>
<a href="#l165.558"></a><span id="l165.558" class="difflineminus">-      }</span>
<a href="#l165.559"></a><span id="l165.559" class="difflineminus">-      else if (traceDef.hasOwnProperty(&quot;onConstructor&quot;)) {</span>
<a href="#l165.560"></a><span id="l165.560" class="difflineplus">+      } else if (traceDef.hasOwnProperty(&quot;onConstructor&quot;)) {</span>
<a href="#l165.561"></a><span id="l165.561">         baseObj = win[traceDef.onConstructor].prototype;</span>
<a href="#l165.562"></a><span id="l165.562">         useThis = true;</span>
<a href="#l165.563"></a><span id="l165.563" class="difflineminus">-      }</span>
<a href="#l165.564"></a><span id="l165.564" class="difflineminus">-      else if (traceDef.hasOwnProperty(&quot;onObject&quot;)) {</span>
<a href="#l165.565"></a><span id="l165.565" class="difflineplus">+      } else if (traceDef.hasOwnProperty(&quot;onObject&quot;)) {</span>
<a href="#l165.566"></a><span id="l165.566">         baseObj = win[traceDef.onObject];</span>
<a href="#l165.567"></a><span id="l165.567">         useThis = false;</span>
<a href="#l165.568"></a><span id="l165.568" class="difflineplus">+      } else { // ignore/bail if unsupported type</span>
<a href="#l165.569"></a><span id="l165.569" class="difflineplus">+        continue;</span>
<a href="#l165.570"></a><span id="l165.570">       }</span>
<a href="#l165.571"></a><span id="l165.571" class="difflineminus">-      else // ignore/bail if unsupported type</span>
<a href="#l165.572"></a><span id="l165.572" class="difflineminus">-        continue;</span>
<a href="#l165.573"></a><span id="l165.573"> </span>
<a href="#l165.574"></a><span id="l165.574">       // - compute/set the wrapped attr, bailing if it's already there</span>
<a href="#l165.575"></a><span id="l165.575">       let wrappedName = &quot;__traceWrapped_&quot; + traceDef.method;</span>
<a href="#l165.576"></a><span id="l165.576">       // bail if we/someone have already wrapped it.</span>
<a href="#l165.577"></a><span id="l165.577">       if (baseObj.hasOwnProperty(wrappedName))</span>
<a href="#l165.578"></a><span id="l165.578">         continue;</span>
<a href="#l165.579"></a><span id="l165.579">       let origFunc = baseObj[traceDef.method];</span>
<a href="#l165.580"></a><span id="l165.580">       let reportAs = traceDef.reportAs; // latch</span>
<a href="#l165.581"></a><span id="l165.581" class="difflineat">@@ -1432,31 +1425,29 @@ function _augment_helper(aController, aA</span>
<a href="#l165.582"></a><span id="l165.582"> </span>
<a href="#l165.583"></a><span id="l165.583">       // - create the trace func based on the definition and apply</span>
<a href="#l165.584"></a><span id="l165.584">       let traceFunc;</span>
<a href="#l165.585"></a><span id="l165.585">       if (traceDef.hasOwnProperty(&quot;doBefore&quot;)) {</span>
<a href="#l165.586"></a><span id="l165.586">         let beforeFunc = traceDef.doBefore;</span>
<a href="#l165.587"></a><span id="l165.587">         traceFunc = function(...aArgs) {</span>
<a href="#l165.588"></a><span id="l165.588">           beforeFunc.apply(useThis ? this : baseObj, aArgs);</span>
<a href="#l165.589"></a><span id="l165.589">           return origFunc.apply(this, aArgs);</span>
<a href="#l165.590"></a><span id="l165.590" class="difflineminus">-        }</span>
<a href="#l165.591"></a><span id="l165.591" class="difflineminus">-      }</span>
<a href="#l165.592"></a><span id="l165.592" class="difflineminus">-      else {</span>
<a href="#l165.593"></a><span id="l165.593" class="difflineplus">+        };</span>
<a href="#l165.594"></a><span id="l165.594" class="difflineplus">+      } else {</span>
<a href="#l165.595"></a><span id="l165.595">         traceFunc = function(...aArgs) {</span>
<a href="#l165.596"></a><span id="l165.596">           mark_action(&quot;winhelp&quot;, reportAs,</span>
<a href="#l165.597"></a><span id="l165.597">                       showArgs ? aArgs : []);</span>
<a href="#l165.598"></a><span id="l165.598">           try {</span>
<a href="#l165.599"></a><span id="l165.599">             return origFunc.apply(this, aArgs);</span>
<a href="#l165.600"></a><span id="l165.600" class="difflineminus">-          }</span>
<a href="#l165.601"></a><span id="l165.601" class="difflineminus">-          catch(ex) {</span>
<a href="#l165.602"></a><span id="l165.602" class="difflineplus">+          } catch (ex) {</span>
<a href="#l165.603"></a><span id="l165.603">             mark_failure([&quot;exception in&quot;, reportAs, &quot;ex:&quot;, ex]);</span>
<a href="#l165.604"></a><span id="l165.604">             // re-throw it; someone might care!</span>
<a href="#l165.605"></a><span id="l165.605">             throw ex;</span>
<a href="#l165.606"></a><span id="l165.606">           }</span>
<a href="#l165.607"></a><span id="l165.607" class="difflineminus">-        }</span>
<a href="#l165.608"></a><span id="l165.608" class="difflineplus">+        };</span>
<a href="#l165.609"></a><span id="l165.609">       }</span>
<a href="#l165.610"></a><span id="l165.610">       baseObj[traceDef.method] = traceFunc;</span>
<a href="#l165.611"></a><span id="l165.611">     }</span>
<a href="#l165.612"></a><span id="l165.612">   }</span>
<a href="#l165.613"></a><span id="l165.613"> </span>
<a href="#l165.614"></a><span id="l165.614">   if (aAugmentDef.onAugment) {</span>
<a href="#l165.615"></a><span id="l165.615">     aAugmentDef.onAugment(aController);</span>
<a href="#l165.616"></a><span id="l165.616">   }</span>
<a href="#l165.617"></a><span id="l165.617" class="difflineat">@@ -1485,22 +1476,21 @@ var UNIQUE_WINDOW_ID_ATTR = &quot;__winHelper</span>
<a href="#l165.618"></a><span id="l165.618">  *   to mark_action.</span>
<a href="#l165.619"></a><span id="l165.619">  */</span>
<a href="#l165.620"></a><span id="l165.620"> function describeEventElementInHierarchy(aNode) {</span>
<a href="#l165.621"></a><span id="l165.621">   let arr = [];</span>
<a href="#l165.622"></a><span id="l165.622">   let win = null;</span>
<a href="#l165.623"></a><span id="l165.623">   // DOM node ?</span>
<a href="#l165.624"></a><span id="l165.624">   if (&quot;ownerDocument&quot; in aNode) {</span>
<a href="#l165.625"></a><span id="l165.625">     arr.push(normalize_for_json(aNode));</span>
<a href="#l165.626"></a><span id="l165.626" class="difflineminus">-    if (aNode.ownerDocument)</span>
<a href="#l165.627"></a><span id="l165.627" class="difflineminus">-      win = aNode.ownerDocument.defaultView;</span>
<a href="#l165.628"></a><span id="l165.628" class="difflineplus">+    if (aNode.ownerGlobal)</span>
<a href="#l165.629"></a><span id="l165.629" class="difflineplus">+      win = aNode.ownerGlobal;</span>
<a href="#l165.630"></a><span id="l165.630">     else</span>
<a href="#l165.631"></a><span id="l165.631">       win = aNode.defaultView;</span>
<a href="#l165.632"></a><span id="l165.632" class="difflineminus">-  }</span>
<a href="#l165.633"></a><span id="l165.633" class="difflineminus">-  else {</span>
<a href="#l165.634"></a><span id="l165.634" class="difflineplus">+  } else {</span>
<a href="#l165.635"></a><span id="l165.635">     // Otherwise this should be a window.</span>
<a href="#l165.636"></a><span id="l165.636">     win = aNode;</span>
<a href="#l165.637"></a><span id="l165.637">   }</span>
<a href="#l165.638"></a><span id="l165.638">   let treeItem = win.QueryInterface(Ci.nsIInterfaceRequestor)</span>
<a href="#l165.639"></a><span id="l165.639">                     .getInterface(Ci.nsIWebNavigation)</span>
<a href="#l165.640"></a><span id="l165.640">                     .QueryInterface(Ci.nsIDocShellTreeItem);</span>
<a href="#l165.641"></a><span id="l165.641">   while (treeItem) {</span>
<a href="#l165.642"></a><span id="l165.642">     win = treeItem.domWindow;</span>
<a href="#l165.643"></a><span id="l165.643" class="difflineat">@@ -1508,18 +1498,17 @@ function describeEventElementInHierarchy</span>
<a href="#l165.644"></a><span id="l165.644">     arr.push(&quot;in&quot;);</span>
<a href="#l165.645"></a><span id="l165.645">     arr.push(normalize_for_json(win));</span>
<a href="#l165.646"></a><span id="l165.646"> </span>
<a href="#l165.647"></a><span id="l165.647">     let parentTreeItem = treeItem.parent;</span>
<a href="#l165.648"></a><span id="l165.648">     // same-type frame element? (easy case)</span>
<a href="#l165.649"></a><span id="l165.649">     if (win.frameElement) {</span>
<a href="#l165.650"></a><span id="l165.650">       arr.push(&quot;frame:&quot;);</span>
<a href="#l165.651"></a><span id="l165.651">       arr.push(normalize_for_json(win.frameElement));</span>
<a href="#l165.652"></a><span id="l165.652" class="difflineminus">-    }</span>
<a href="#l165.653"></a><span id="l165.653" class="difflineminus">-    else if (parentTreeItem) {</span>
<a href="#l165.654"></a><span id="l165.654" class="difflineplus">+    } else if (parentTreeItem) {</span>
<a href="#l165.655"></a><span id="l165.655">       let parentWin = parentTreeItem.domWindow;</span>
<a href="#l165.656"></a><span id="l165.656">       let frame = _findFrameElementForWindowInWindow(win, parentWin);</span>
<a href="#l165.657"></a><span id="l165.657">       arr.push(&quot;frame:&quot;);</span>
<a href="#l165.658"></a><span id="l165.658">       arr.push(normalize_for_json(frame));</span>
<a href="#l165.659"></a><span id="l165.659">     }</span>
<a href="#l165.660"></a><span id="l165.660">     treeItem = parentTreeItem;</span>
<a href="#l165.661"></a><span id="l165.661">   }</span>
<a href="#l165.662"></a><span id="l165.662"> </span>
<a href="#l165.663"></a><span id="l165.663" class="difflineat">@@ -1527,17 +1516,17 @@ function describeEventElementInHierarchy</span>
<a href="#l165.664"></a><span id="l165.664"> }</span>
<a href="#l165.665"></a><span id="l165.665"> </span>
<a href="#l165.666"></a><span id="l165.666"> /**</span>
<a href="#l165.667"></a><span id="l165.667">  * Helper for `describeEventElementInHierarchy` that checks all the</span>
<a href="#l165.668"></a><span id="l165.668">  *  browsers/iframes in `parentWin` for the one that has `win` as its</span>
<a href="#l165.669"></a><span id="l165.669">  *  contentWindow.</span>
<a href="#l165.670"></a><span id="l165.670">  */</span>
<a href="#l165.671"></a><span id="l165.671"> function _findFrameElementForWindowInWindow(win, parentWin) {</span>
<a href="#l165.672"></a><span id="l165.672" class="difflineminus">-  let elems = parentWin.document.getElementsByTagName(&quot;iframe&quot;), i;</span>
<a href="#l165.673"></a><span id="l165.673" class="difflineplus">+  let elems = parentWin.document.getElementsByTagName(&quot;iframe&quot;);</span>
<a href="#l165.674"></a><span id="l165.674">   for (let i = 0; i &lt; elems.length; i++) {</span>
<a href="#l165.675"></a><span id="l165.675">     // (Must not use === because XPConnect uses wrapper identicality when</span>
<a href="#l165.676"></a><span id="l165.676">     //  we do that.)</span>
<a href="#l165.677"></a><span id="l165.677">     if (elems[i].contentWindow == win)</span>
<a href="#l165.678"></a><span id="l165.678">       return elems[i];</span>
<a href="#l165.679"></a><span id="l165.679">   }</span>
<a href="#l165.680"></a><span id="l165.680">   elems = parentWin.document.getElementsByTagName(&quot;browser&quot;);</span>
<a href="#l165.681"></a><span id="l165.681">   for (let i = 0; i &lt; elems.length; i++) {</span>
<a href="#l165.682"></a><span id="l165.682" class="difflineat">@@ -1554,18 +1543,17 @@ function _findFrameElementForWindowInWin</span>
<a href="#l165.683"></a><span id="l165.683">  *  element if there was no windowtype.  (Experience has shown these to be</span>
<a href="#l165.684"></a><span id="l165.684">  *  always present).  Additionally, we annotated a unique counter value onto</span>
<a href="#l165.685"></a><span id="l165.685">  *  the window at augmentation time, and so we tack that on to be able to</span>
<a href="#l165.686"></a><span id="l165.686">  *  tell the difference between otherwise similar windows.</span>
<a href="#l165.687"></a><span id="l165.687">  */</span>
<a href="#l165.688"></a><span id="l165.688"> function getWindowDescribeyFromEvent(event) {</span>
<a href="#l165.689"></a><span id="l165.689">   var target = event.target;</span>
<a href="#l165.690"></a><span id="l165.690">   // assume it's a window if there's no ownerDocument attribute</span>
<a href="#l165.691"></a><span id="l165.691" class="difflineminus">-  var win = (&quot;ownerDocument&quot; in target) ? target.ownerDocument.defaultView</span>
<a href="#l165.692"></a><span id="l165.692" class="difflineminus">-                                        : target;</span>
<a href="#l165.693"></a><span id="l165.693" class="difflineplus">+  var win = (&quot;ownerGlobal&quot; in target) ? target.ownerGlobal : target;</span>
<a href="#l165.694"></a><span id="l165.694">   var owningWin = win.docShell.rootTreeItem.domWindow;</span>
<a href="#l165.695"></a><span id="l165.695">   var docElem = owningWin.document.documentElement;</span>
<a href="#l165.696"></a><span id="l165.696">   return (getWindowTypeOrId(docElem) || &quot;mysterious&quot;) +</span>
<a href="#l165.697"></a><span id="l165.697">          &quot; (&quot; + (UNIQUE_WINDOW_ID_ATTR in owningWin ?</span>
<a href="#l165.698"></a><span id="l165.698">                    owningWin[UNIQUE_WINDOW_ID_ATTR] :</span>
<a href="#l165.699"></a><span id="l165.699">                    &quot;n/a&quot;) + &quot;)&quot;;</span>
<a href="#l165.700"></a><span id="l165.700"> }</span>
<a href="#l165.701"></a><span id="l165.701"> </span>
<a href="#l165.702"></a><span id="l165.702" class="difflineat">@@ -1589,17 +1577,17 @@ function __peek_click_handler(event) {</span>
<a href="#l165.703"></a><span id="l165.703">     s = &quot;middle&quot;;</span>
<a href="#l165.704"></a><span id="l165.704">   else if (event.button === 2)</span>
<a href="#l165.705"></a><span id="l165.705">     s = &quot;right&quot;;</span>
<a href="#l165.706"></a><span id="l165.706">   else</span>
<a href="#l165.707"></a><span id="l165.707">     s = &quot;&quot; + event.button;</span>
<a href="#l165.708"></a><span id="l165.708">   if (event.shiftKey)</span>
<a href="#l165.709"></a><span id="l165.709">     s = &quot;shift-&quot; + s;</span>
<a href="#l165.710"></a><span id="l165.710">   if (event.ctrlKey)</span>
<a href="#l165.711"></a><span id="l165.711" class="difflineminus">-    s = &quot;ctrl-&quot;; + s</span>
<a href="#l165.712"></a><span id="l165.712" class="difflineplus">+    s = &quot;ctrl-&quot; + s;</span>
<a href="#l165.713"></a><span id="l165.713">   if (event.altKey)</span>
<a href="#l165.714"></a><span id="l165.714">     s = &quot;alt-&quot; + s;</span>
<a href="#l165.715"></a><span id="l165.715">   if (event.metaKey)</span>
<a href="#l165.716"></a><span id="l165.716">     s = &quot;meta-&quot; + s;</span>
<a href="#l165.717"></a><span id="l165.717">   mark_action(&quot;winhelp&quot;, event.type,</span>
<a href="#l165.718"></a><span id="l165.718">               [&quot;mouse button&quot;, s,</span>
<a href="#l165.719"></a><span id="l165.719">                &quot;target:&quot;, normalize_for_json(event.target),</span>
<a href="#l165.720"></a><span id="l165.720">                &quot;in&quot;, getWindowDescribeyFromEvent(event),</span>
<a href="#l165.721"></a><span id="l165.721" class="difflineat">@@ -1617,24 +1605,21 @@ function __bubbled_click_handler(event) </span>
<a href="#l165.722"></a><span id="l165.722"> }</span>
<a href="#l165.723"></a><span id="l165.723"> </span>
<a href="#l165.724"></a><span id="l165.724"> function describeKeyEvent(event) {</span>
<a href="#l165.725"></a><span id="l165.725">   let s;</span>
<a href="#l165.726"></a><span id="l165.726">   if (event.key &amp;&amp; event.key != &quot;&quot;) {</span>
<a href="#l165.727"></a><span id="l165.727">     s = event.key;</span>
<a href="#l165.728"></a><span id="l165.728">     if (s.trim() == &quot;&quot;)</span>
<a href="#l165.729"></a><span id="l165.729">       s = &quot;'&quot; + event.key + &quot;'&quot;;</span>
<a href="#l165.730"></a><span id="l165.730" class="difflineminus">-  }</span>
<a href="#l165.731"></a><span id="l165.731" class="difflineminus">-  else if (event.charCode) {</span>
<a href="#l165.732"></a><span id="l165.732" class="difflineplus">+  } else if (event.charCode) {</span>
<a href="#l165.733"></a><span id="l165.733">     s = &quot;'&quot; + String.fromCharCode(event.charCode) + &quot;'&quot;;</span>
<a href="#l165.734"></a><span id="l165.734" class="difflineminus">-  }</span>
<a href="#l165.735"></a><span id="l165.735" class="difflineminus">-  else if (event.keyCode) {</span>
<a href="#l165.736"></a><span id="l165.736" class="difflineplus">+  } else if (event.keyCode) {</span>
<a href="#l165.737"></a><span id="l165.737">     s = event.keyCode;</span>
<a href="#l165.738"></a><span id="l165.738" class="difflineminus">-  }</span>
<a href="#l165.739"></a><span id="l165.739" class="difflineminus">-  else {</span>
<a href="#l165.740"></a><span id="l165.740" class="difflineplus">+  } else {</span>
<a href="#l165.741"></a><span id="l165.741">     s = &quot;no key/keyCode/charCode?&quot;;</span>
<a href="#l165.742"></a><span id="l165.742">   }</span>
<a href="#l165.743"></a><span id="l165.743"> </span>
<a href="#l165.744"></a><span id="l165.744">   if (event.shiftKey)</span>
<a href="#l165.745"></a><span id="l165.745">     s = &quot;shift-&quot; + s;</span>
<a href="#l165.746"></a><span id="l165.746">   if (event.ctrlKey)</span>
<a href="#l165.747"></a><span id="l165.747">     s = &quot;ctrl-&quot; + s;</span>
<a href="#l165.748"></a><span id="l165.748">   if (event.altKey)</span>
<a href="#l165.749"></a><span id="l165.749" class="difflineat">@@ -1768,19 +1753,17 @@ function augment_controller(aController,</span>
<a href="#l165.750"></a><span id="l165.750">       //   |- treecolpicker   &lt;-- item 1 this is the one we want</span>
<a href="#l165.751"></a><span id="l165.751">       let treeColPicker = treecols.querySelector(&quot;treecolpicker&quot;);</span>
<a href="#l165.752"></a><span id="l165.752">       let popup = treeColPicker.querySelector(`menupopup[anonid=&quot;popup&quot;]`);</span>
<a href="#l165.753"></a><span id="l165.753">       popup.addEventListener(&quot;popupshowing&quot;, __popup_showing, true);</span>
<a href="#l165.754"></a><span id="l165.754">       popup.addEventListener(&quot;popupshown&quot;, __popup_shown, true);</span>
<a href="#l165.755"></a><span id="l165.755">       popup.addEventListener(&quot;popuphiding&quot;, __popup_hiding, true);</span>
<a href="#l165.756"></a><span id="l165.756">       popup.addEventListener(&quot;popuphidden&quot;, __popup_hidden, true);</span>
<a href="#l165.757"></a><span id="l165.757">     }</span>
<a href="#l165.758"></a><span id="l165.758" class="difflineminus">-</span>
<a href="#l165.759"></a><span id="l165.759" class="difflineminus">-  }</span>
<a href="#l165.760"></a><span id="l165.760" class="difflineminus">-  catch(ex) {</span>
<a href="#l165.761"></a><span id="l165.761" class="difflineplus">+  } catch (ex) {</span>
<a href="#l165.762"></a><span id="l165.762">     dump(&quot;!!!! failure augmenting controller: &quot; + ex + &quot;\n&quot; + ex.stack);</span>
<a href="#l165.763"></a><span id="l165.763">   }</span>
<a href="#l165.764"></a><span id="l165.764"> </span>
<a href="#l165.765"></a><span id="l165.765"> </span>
<a href="#l165.766"></a><span id="l165.766">   return aController;</span>
<a href="#l165.767"></a><span id="l165.767"> }</span>
<a href="#l165.768"></a><span id="l165.768"> </span>
<a href="#l165.769"></a><span id="l165.769"> /**</span>
<a href="#l165.770"></a><span id="l165.770" class="difflineat">@@ -1865,17 +1848,17 @@ function screenshotToBase64(aWindow) {</span>
<a href="#l165.771"></a><span id="l165.771">  * - The focused element in the window; we leave this up to logHelper to</span>
<a href="#l165.772"></a><span id="l165.772">  *    describe.</span>
<a href="#l165.773"></a><span id="l165.773">  */</span>
<a href="#l165.774"></a><span id="l165.774"> function captureWindowStatesForErrorReporting(normalizeForJsonFunc) {</span>
<a href="#l165.775"></a><span id="l165.775">   let info = {};</span>
<a href="#l165.776"></a><span id="l165.776">   let windows = info.windows = [];</span>
<a href="#l165.777"></a><span id="l165.777"> </span>
<a href="#l165.778"></a><span id="l165.778">   let enumerator = Services.wm.getEnumerator(null);</span>
<a href="#l165.779"></a><span id="l165.779" class="difflineminus">-  let iWin=0;</span>
<a href="#l165.780"></a><span id="l165.780" class="difflineplus">+  let iWin = 0;</span>
<a href="#l165.781"></a><span id="l165.781">   while (enumerator.hasMoreElements()) {</span>
<a href="#l165.782"></a><span id="l165.782">     let win = enumerator.getNext().QueryInterface(Ci.nsIDOMWindow);</span>
<a href="#l165.783"></a><span id="l165.783"> </span>
<a href="#l165.784"></a><span id="l165.784">     let winId = getWindowTypeOrId(win.document.documentElement) ||</span>
<a href="#l165.785"></a><span id="l165.785">                 (&quot;unnamed:&quot; + iWin);</span>
<a href="#l165.786"></a><span id="l165.786"> </span>
<a href="#l165.787"></a><span id="l165.787">     let openPopups =</span>
<a href="#l165.788"></a><span id="l165.788">       Array.from(win.document.documentElement.getElementsByTagName(&quot;menupopup&quot;))</span>
<a href="#l165.789"></a><span id="l165.789" class="difflineat">@@ -1889,16 +1872,16 @@ function captureWindowStatesForErrorRepo</span>
<a href="#l165.790"></a><span id="l165.790">       coords: {x: win.screenX, y: win.screenY},</span>
<a href="#l165.791"></a><span id="l165.791">       dims: {width: win.outerWidth, height: win.outerHeight},</span>
<a href="#l165.792"></a><span id="l165.792">       pageOffsets: {x: win.pageXOffset, y: win.pageYOffset},</span>
<a href="#l165.793"></a><span id="l165.793">       screenshotDataUrl: screenshotToDataURL(win),</span>
<a href="#l165.794"></a><span id="l165.794">       isActive: Services.focus.activeWindow == win,</span>
<a href="#l165.795"></a><span id="l165.795">       focusedElem: normalizeForJsonFunc(</span>
<a href="#l165.796"></a><span id="l165.796">         Services.focus.getFocusedElementForWindow(win, true,</span>
<a href="#l165.797"></a><span id="l165.797">                                                   ignoredFocusedWindow)),</span>
<a href="#l165.798"></a><span id="l165.798" class="difflineminus">-      openPopups: openPopups,</span>
<a href="#l165.799"></a><span id="l165.799" class="difflineplus">+      openPopups,</span>
<a href="#l165.800"></a><span id="l165.800">     };</span>
<a href="#l165.801"></a><span id="l165.801"> </span>
<a href="#l165.802"></a><span id="l165.802">     windows.push(winfo);</span>
<a href="#l165.803"></a><span id="l165.803">   }</span>
<a href="#l165.804"></a><span id="l165.804"> </span>
<a href="#l165.805"></a><span id="l165.805">   return info;</span>
<a href="#l165.806"></a><span id="l165.806"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l166.1"></a><span id="l166.1" class="difflineminus">--- a/mail/test/mozmill/startup-firstrun/test-menubar-collapsed.js</span>
<a href="#l166.2"></a><span id="l166.2" class="difflineplus">+++ b/mail/test/mozmill/startup-firstrun/test-menubar-collapsed.js</span>
<a href="#l166.3"></a><span id="l166.3" class="difflineat">@@ -4,36 +4,38 @@</span>
<a href="#l166.4"></a><span id="l166.4"> </span>
<a href="#l166.5"></a><span id="l166.5"> /**</span>
<a href="#l166.6"></a><span id="l166.6">  * Tests that the main menu will be collapsed by default if Thunderbird starts</span>
<a href="#l166.7"></a><span id="l166.7">  * with no accounts created.</span>
<a href="#l166.8"></a><span id="l166.8">  */</span>
<a href="#l166.9"></a><span id="l166.9"> </span>
<a href="#l166.10"></a><span id="l166.10"> &quot;use strict&quot;;</span>
<a href="#l166.11"></a><span id="l166.11"> </span>
<a href="#l166.12"></a><span id="l166.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l166.13"></a><span id="l166.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l166.14"></a><span id="l166.14" class="difflineplus">+</span>
<a href="#l166.15"></a><span id="l166.15"> var MODULE_NAME = &quot;test-main-menu-collapsed&quot;;</span>
<a href="#l166.16"></a><span id="l166.16"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l166.17"></a><span id="l166.17" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l166.18"></a><span id="l166.18" class="difflineminus">-                       &quot;window-helpers&quot;];</span>
<a href="#l166.19"></a><span id="l166.19" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l166.20"></a><span id="l166.20"> </span>
<a href="#l166.21"></a><span id="l166.21"> function setupModule(module) {</span>
<a href="#l166.22"></a><span id="l166.22">   collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l166.23"></a><span id="l166.23">   collector.getModule(&quot;window-helpers&quot;).installInto(module);</span>
<a href="#l166.24"></a><span id="l166.24"> }</span>
<a href="#l166.25"></a><span id="l166.25"> </span>
<a href="#l166.26"></a><span id="l166.26"> function test_main_menu_collapsed() {</span>
<a href="#l166.27"></a><span id="l166.27">   // Due to random oranges on slower machines, we need to ensure that startup</span>
<a href="#l166.28"></a><span id="l166.28">   // is complete before running this test.</span>
<a href="#l166.29"></a><span id="l166.29">   let done = false;</span>
<a href="#l166.30"></a><span id="l166.30">   let observer = {</span>
<a href="#l166.31"></a><span id="l166.31" class="difflineminus">-    observe: function(aSubject, aTopic, aData) {</span>
<a href="#l166.32"></a><span id="l166.32" class="difflineplus">+    observe(aSubject, aTopic, aData) {</span>
<a href="#l166.33"></a><span id="l166.33">       if (aTopic == &quot;mail-startup-done&quot;) {</span>
<a href="#l166.34"></a><span id="l166.34">         done = true;</span>
<a href="#l166.35"></a><span id="l166.35">       }</span>
<a href="#l166.36"></a><span id="l166.36" class="difflineminus">-    }</span>
<a href="#l166.37"></a><span id="l166.37" class="difflineplus">+    },</span>
<a href="#l166.38"></a><span id="l166.38">   };</span>
<a href="#l166.39"></a><span id="l166.39">   Services.obs.addObserver(observer, &quot;mail-startup-done&quot;);</span>
<a href="#l166.40"></a><span id="l166.40"> </span>
<a href="#l166.41"></a><span id="l166.41">   // Since no accounts were set up, and the account provisioner was disabled</span>
<a href="#l166.42"></a><span id="l166.42">   // in prefs.js, the wizard will show up. Find it, and close it. This will</span>
<a href="#l166.43"></a><span id="l166.43">   // cause mail-startup-done to eventually be fired.</span>
<a href="#l166.44"></a><span id="l166.44">   let wizard = wait_for_existing_window(&quot;mail:autoconfig&quot;);</span>
<a href="#l166.45"></a><span id="l166.45">   close_window(wizard);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l167.1"></a><span id="l167.1" class="difflineminus">--- a/mail/test/mozmill/subscribe/test-subscribe-news-filter.js</span>
<a href="#l167.2"></a><span id="l167.2" class="difflineplus">+++ b/mail/test/mozmill/subscribe/test-subscribe-news-filter.js</span>
<a href="#l167.3"></a><span id="l167.3" class="difflineat">@@ -1,21 +1,23 @@</span>
<a href="#l167.4"></a><span id="l167.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l167.5"></a><span id="l167.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l167.6"></a><span id="l167.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l167.7"></a><span id="l167.7"> </span>
<a href="#l167.8"></a><span id="l167.8"> /* Test that the subscribe window for news servers has working autocomplete. */</span>
<a href="#l167.9"></a><span id="l167.9"> </span>
<a href="#l167.10"></a><span id="l167.10"> &quot;use strict&quot;;</span>
<a href="#l167.11"></a><span id="l167.11"> </span>
<a href="#l167.12"></a><span id="l167.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l167.13"></a><span id="l167.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-nntp-helpers.js */</span>
<a href="#l167.14"></a><span id="l167.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-subscribe-window-helpers.js */</span>
<a href="#l167.15"></a><span id="l167.15" class="difflineplus">+</span>
<a href="#l167.16"></a><span id="l167.16"> var MODULE_NAME = &quot;test-subscribe-news-filter&quot;;</span>
<a href="#l167.17"></a><span id="l167.17" class="difflineminus">-</span>
<a href="#l167.18"></a><span id="l167.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l167.19"></a><span id="l167.19" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;nntp-helpers&quot;,</span>
<a href="#l167.20"></a><span id="l167.20" class="difflineminus">-                         &quot;subscribe-window-helpers&quot;];</span>
<a href="#l167.21"></a><span id="l167.21" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;nntp-helpers&quot;, &quot;subscribe-window-helpers&quot;];</span>
<a href="#l167.22"></a><span id="l167.22"> </span>
<a href="#l167.23"></a><span id="l167.23"> function setupModule(module) {</span>
<a href="#l167.24"></a><span id="l167.24">   collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l167.25"></a><span id="l167.25">   collector.getModule(&quot;nntp-helpers&quot;).installInto(module);</span>
<a href="#l167.26"></a><span id="l167.26">   collector.getModule(&quot;subscribe-window-helpers&quot;).installInto(module);</span>
<a href="#l167.27"></a><span id="l167.27"> }</span>
<a href="#l167.28"></a><span id="l167.28"> </span>
<a href="#l167.29"></a><span id="l167.29"> /**</span>
<a href="#l167.30"></a><span id="l167.30" class="difflineat">@@ -33,15 +35,15 @@ function test_subscribe_newsgroup_filter</span>
<a href="#l167.31"></a><span id="l167.31"> }</span>
<a href="#l167.32"></a><span id="l167.32"> </span>
<a href="#l167.33"></a><span id="l167.33"> /**</span>
<a href="#l167.34"></a><span id="l167.34">  * Helper function (callback), needed because the subscribe window is modal.</span>
<a href="#l167.35"></a><span id="l167.35">  * @param swc Controller for the subscribe window</span>
<a href="#l167.36"></a><span id="l167.36">  */</span>
<a href="#l167.37"></a><span id="l167.37"> function filter_test_helper(swc) {</span>
<a href="#l167.38"></a><span id="l167.38">   enter_text_in_search_box(swc, &quot;subscribe empty&quot;);</span>
<a href="#l167.39"></a><span id="l167.39" class="difflineminus">-  utils.waitFor( () =&gt; check_newsgroup_displayed(swc, &quot;test.subscribe.empty&quot;),</span>
<a href="#l167.40"></a><span id="l167.40" class="difflineplus">+  utils.waitFor(() =&gt; check_newsgroup_displayed(swc, &quot;test.subscribe.empty&quot;),</span>
<a href="#l167.41"></a><span id="l167.41">     &quot;test.subscribe.empty not in the list&quot;);</span>
<a href="#l167.42"></a><span id="l167.42" class="difflineminus">-  utils.waitFor( () =&gt; !check_newsgroup_displayed(swc, &quot;test.empty&quot;),</span>
<a href="#l167.43"></a><span id="l167.43" class="difflineplus">+  utils.waitFor(() =&gt; !check_newsgroup_displayed(swc, &quot;test.empty&quot;),</span>
<a href="#l167.44"></a><span id="l167.44">     &quot;test.empty is in the list, but should not be&quot;);</span>
<a href="#l167.45"></a><span id="l167.45" class="difflineminus">-  utils.waitFor( () =&gt; !check_newsgroup_displayed(swc, &quot;test.subscribe.simple&quot;),</span>
<a href="#l167.46"></a><span id="l167.46" class="difflineplus">+  utils.waitFor(() =&gt; !check_newsgroup_displayed(swc, &quot;test.subscribe.simple&quot;),</span>
<a href="#l167.47"></a><span id="l167.47">     &quot;test.subscribe.simple is in the list, but should not be&quot;);</span>
<a href="#l167.48"></a><span id="l167.48"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l168.1"></a><span id="l168.1" class="difflineminus">--- a/mail/test/mozmill/tabmail/test-tabmail-closing.js</span>
<a href="#l168.2"></a><span id="l168.2" class="difflineplus">+++ b/mail/test/mozmill/tabmail/test-tabmail-closing.js</span>
<a href="#l168.3"></a><span id="l168.3" class="difflineat">@@ -3,21 +3,22 @@</span>
<a href="#l168.4"></a><span id="l168.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l168.5"></a><span id="l168.5"> </span>
<a href="#l168.6"></a><span id="l168.6"> /*</span>
<a href="#l168.7"></a><span id="l168.7">  * Test tabmail behaviour when tabs close.</span>
<a href="#l168.8"></a><span id="l168.8">  */</span>
<a href="#l168.9"></a><span id="l168.9"> </span>
<a href="#l168.10"></a><span id="l168.10"> &quot;use strict&quot;;</span>
<a href="#l168.11"></a><span id="l168.11"> </span>
<a href="#l168.12"></a><span id="l168.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l168.13"></a><span id="l168.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l168.14"></a><span id="l168.14" class="difflineplus">+</span>
<a href="#l168.15"></a><span id="l168.15"> var MODULE_NAME = &quot;test-tabmail-closing&quot;;</span>
<a href="#l168.16"></a><span id="l168.16" class="difflineminus">-</span>
<a href="#l168.17"></a><span id="l168.17"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l168.18"></a><span id="l168.18" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l168.19"></a><span id="l168.19" class="difflineminus">-                       &quot;window-helpers&quot;,];</span>
<a href="#l168.20"></a><span id="l168.20" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;];</span>
<a href="#l168.21"></a><span id="l168.21"> </span>
<a href="#l168.22"></a><span id="l168.22"> var gFolder;</span>
<a href="#l168.23"></a><span id="l168.23"> </span>
<a href="#l168.24"></a><span id="l168.24"> var MSGS_PER_THREAD = 3;</span>
<a href="#l168.25"></a><span id="l168.25"> </span>
<a href="#l168.26"></a><span id="l168.26"> function setupModule(module) {</span>
<a href="#l168.27"></a><span id="l168.27">   collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l168.28"></a><span id="l168.28">   collector.getModule(&quot;window-helpers&quot;).installInto(module);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l169.1"></a><span id="l169.1" class="difflineminus">--- a/mail/test/mozmill/tabmail/test-tabmail-customize.js</span>
<a href="#l169.2"></a><span id="l169.2" class="difflineplus">+++ b/mail/test/mozmill/tabmail/test-tabmail-customize.js</span>
<a href="#l169.3"></a><span id="l169.3" class="difflineat">@@ -3,49 +3,57 @@</span>
<a href="#l169.4"></a><span id="l169.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l169.5"></a><span id="l169.5"> </span>
<a href="#l169.6"></a><span id="l169.6"> /*</span>
<a href="#l169.7"></a><span id="l169.7">  * Tests customization features of the tabs toolbar.</span>
<a href="#l169.8"></a><span id="l169.8">  */</span>
<a href="#l169.9"></a><span id="l169.9"> </span>
<a href="#l169.10"></a><span id="l169.10"> &quot;use strict&quot;;</span>
<a href="#l169.11"></a><span id="l169.11"> </span>
<a href="#l169.12"></a><span id="l169.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-customization-helpers.js */</span>
<a href="#l169.13"></a><span id="l169.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l169.14"></a><span id="l169.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-mouse-event-helpers.js */</span>
<a href="#l169.15"></a><span id="l169.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l169.16"></a><span id="l169.16" class="difflineplus">+</span>
<a href="#l169.17"></a><span id="l169.17"> var MODULE_NAME = &quot;test-tabmail-customize&quot;;</span>
<a href="#l169.18"></a><span id="l169.18" class="difflineminus">-</span>
<a href="#l169.19"></a><span id="l169.19"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l169.20"></a><span id="l169.20" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers', 'mouse-event-helpers',</span>
<a href="#l169.21"></a><span id="l169.21" class="difflineminus">-                       'window-helpers', 'customization-helpers'];</span>
<a href="#l169.22"></a><span id="l169.22" class="difflineplus">+var MODULE_REQUIRES = [</span>
<a href="#l169.23"></a><span id="l169.23" class="difflineplus">+  &quot;folder-display-helpers&quot;,</span>
<a href="#l169.24"></a><span id="l169.24" class="difflineplus">+  &quot;mouse-event-helpers&quot;,</span>
<a href="#l169.25"></a><span id="l169.25" class="difflineplus">+  &quot;window-helpers&quot;,</span>
<a href="#l169.26"></a><span id="l169.26" class="difflineplus">+  &quot;customization-helpers&quot;,</span>
<a href="#l169.27"></a><span id="l169.27" class="difflineplus">+];</span>
<a href="#l169.28"></a><span id="l169.28"> </span>
<a href="#l169.29"></a><span id="l169.29" class="difflineminus">-var gCDHelper ;</span>
<a href="#l169.30"></a><span id="l169.30" class="difflineplus">+var gCDHelper;</span>
<a href="#l169.31"></a><span id="l169.31"> </span>
<a href="#l169.32"></a><span id="l169.32"> function setupModule(module) {</span>
<a href="#l169.33"></a><span id="l169.33" class="difflineminus">-  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l169.34"></a><span id="l169.34" class="difflineplus">+  let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l169.35"></a><span id="l169.35">   fdh.installInto(module);</span>
<a href="#l169.36"></a><span id="l169.36" class="difflineminus">-  let meh = collector.getModule('mouse-event-helpers');</span>
<a href="#l169.37"></a><span id="l169.37" class="difflineplus">+  let meh = collector.getModule(&quot;mouse-event-helpers&quot;);</span>
<a href="#l169.38"></a><span id="l169.38">   meh.installInto(module);</span>
<a href="#l169.39"></a><span id="l169.39" class="difflineminus">-  let wh = collector.getModule('window-helpers');</span>
<a href="#l169.40"></a><span id="l169.40" class="difflineplus">+  let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l169.41"></a><span id="l169.41">   wh.installInto(module);</span>
<a href="#l169.42"></a><span id="l169.42" class="difflineminus">-  let cu = collector.getModule('customization-helpers');</span>
<a href="#l169.43"></a><span id="l169.43" class="difflineplus">+  let cu = collector.getModule(&quot;customization-helpers&quot;);</span>
<a href="#l169.44"></a><span id="l169.44">   cu.installInto(module);</span>
<a href="#l169.45"></a><span id="l169.45" class="difflineminus">-  gCDHelper = new CustomizeDialogHelper('mail-toolbar-menubar2',</span>
<a href="#l169.46"></a><span id="l169.46" class="difflineminus">-    'CustomizeMailToolbar', &quot;mailnews:customizeToolbar&quot;);</span>
<a href="#l169.47"></a><span id="l169.47" class="difflineplus">+  gCDHelper = new CustomizeDialogHelper(&quot;mail-toolbar-menubar2&quot;,</span>
<a href="#l169.48"></a><span id="l169.48" class="difflineplus">+    &quot;CustomizeMailToolbar&quot;, &quot;mailnews:customizeToolbar&quot;);</span>
<a href="#l169.49"></a><span id="l169.49"> }</span>
<a href="#l169.50"></a><span id="l169.50"> </span>
<a href="#l169.51"></a><span id="l169.51"> function teardownModule(module) {</span>
<a href="#l169.52"></a><span id="l169.52">   // Let's reset any and all of our changes to the toolbar</span>
<a href="#l169.53"></a><span id="l169.53">   gCDHelper.restoreDefaultButtons(mc);</span>
<a href="#l169.54"></a><span id="l169.54"> }</span>
<a href="#l169.55"></a><span id="l169.55"> </span>
<a href="#l169.56"></a><span id="l169.56"> /**</span>
<a href="#l169.57"></a><span id="l169.57">  * Test that we can access the customize context menu by right</span>
<a href="#l169.58"></a><span id="l169.58">  * clicking on the tabs toolbar.</span>
<a href="#l169.59"></a><span id="l169.59">  */</span>
<a href="#l169.60"></a><span id="l169.60"> function test_open_context_menu() {</span>
<a href="#l169.61"></a><span id="l169.61">   // First, ensure that the context menu is closed.</span>
<a href="#l169.62"></a><span id="l169.62" class="difflineminus">-  let contextPopup = mc.e('toolbar-context-menu');</span>
<a href="#l169.63"></a><span id="l169.63" class="difflineplus">+  let contextPopup = mc.e(&quot;toolbar-context-menu&quot;);</span>
<a href="#l169.64"></a><span id="l169.64">   assert_not_equals(contextPopup.state, &quot;open&quot;);</span>
<a href="#l169.65"></a><span id="l169.65"> </span>
<a href="#l169.66"></a><span id="l169.66">   // Right click on the tab bar</span>
<a href="#l169.67"></a><span id="l169.67">   mc.rightClick(mc.eid(&quot;tabmail-tabs&quot;));</span>
<a href="#l169.68"></a><span id="l169.68"> </span>
<a href="#l169.69"></a><span id="l169.69">   // Ensure that the popup opened</span>
<a href="#l169.70"></a><span id="l169.70">   wait_for_popup_to_open(contextPopup);</span>
<a href="#l169.71"></a><span id="l169.71"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l170.1"></a><span id="l170.1" class="difflineminus">--- a/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js</span>
<a href="#l170.2"></a><span id="l170.2" class="difflineplus">+++ b/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js</span>
<a href="#l170.3"></a><span id="l170.3" class="difflineat">@@ -6,62 +6,62 @@</span>
<a href="#l170.4"></a><span id="l170.4"> </span>
<a href="#l170.5"></a><span id="l170.5"> var elib = ChromeUtils.import(&quot;chrome://mozmill/content/modules/elementslib.jsm&quot;);</span>
<a href="#l170.6"></a><span id="l170.6"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l170.7"></a><span id="l170.7"> </span>
<a href="#l170.8"></a><span id="l170.8"> /*</span>
<a href="#l170.9"></a><span id="l170.9">  * Test rearanging tabs via drag'n'drop.</span>
<a href="#l170.10"></a><span id="l170.10">  */</span>
<a href="#l170.11"></a><span id="l170.11"> </span>
<a href="#l170.12"></a><span id="l170.12" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l170.13"></a><span id="l170.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-mouse-event-helpers.js */</span>
<a href="#l170.14"></a><span id="l170.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-window-helpers.js */</span>
<a href="#l170.15"></a><span id="l170.15" class="difflineplus">+</span>
<a href="#l170.16"></a><span id="l170.16"> var MODULE_NAME = &quot;test-tabmail-dragndrop&quot;;</span>
<a href="#l170.17"></a><span id="l170.17" class="difflineminus">-</span>
<a href="#l170.18"></a><span id="l170.18"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l170.19"></a><span id="l170.19" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;,</span>
<a href="#l170.20"></a><span id="l170.20" class="difflineminus">-                       'mouse-event-helpers'];</span>
<a href="#l170.21"></a><span id="l170.21" class="difflineminus">-</span>
<a href="#l170.22"></a><span id="l170.22" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;window-helpers&quot;, &quot;mouse-event-helpers&quot;];</span>
<a href="#l170.23"></a><span id="l170.23"> </span>
<a href="#l170.24"></a><span id="l170.24"> var folder;</span>
<a href="#l170.25"></a><span id="l170.25"> var msgHdrsInFolder = [];</span>
<a href="#l170.26"></a><span id="l170.26"> </span>
<a href="#l170.27"></a><span id="l170.27"> // The number of messages in folder.</span>
<a href="#l170.28"></a><span id="l170.28"> var NUM_MESSAGES_IN_FOLDER = 15;</span>
<a href="#l170.29"></a><span id="l170.29"> </span>
<a href="#l170.30"></a><span id="l170.30"> function setupModule(module) {</span>
<a href="#l170.31"></a><span id="l170.31">   let fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l170.32"></a><span id="l170.32">   fdh.installInto(module);</span>
<a href="#l170.33"></a><span id="l170.33">   let wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l170.34"></a><span id="l170.34">   wh.installInto(module);</span>
<a href="#l170.35"></a><span id="l170.35" class="difflineminus">-  let meh = collector.getModule('mouse-event-helpers');</span>
<a href="#l170.36"></a><span id="l170.36" class="difflineplus">+  let meh = collector.getModule(&quot;mouse-event-helpers&quot;);</span>
<a href="#l170.37"></a><span id="l170.37">   meh.installInto(module);</span>
<a href="#l170.38"></a><span id="l170.38"> </span>
<a href="#l170.39"></a><span id="l170.39">   folder = create_folder(&quot;MessageFolder&quot;);</span>
<a href="#l170.40"></a><span id="l170.40">   make_new_sets_in_folder(folder, [{count: NUM_MESSAGES_IN_FOLDER}]);</span>
<a href="#l170.41"></a><span id="l170.41"> }</span>
<a href="#l170.42"></a><span id="l170.42"> </span>
<a href="#l170.43"></a><span id="l170.43"> /**</span>
<a href="#l170.44"></a><span id="l170.44">  * Verifies our test environment is setup correctly and initializes</span>
<a href="#l170.45"></a><span id="l170.45">  * all global variables.</span>
<a href="#l170.46"></a><span id="l170.46">  */</span>
<a href="#l170.47"></a><span id="l170.47"> function test_tab_reorder_setup_globals() {</span>
<a href="#l170.48"></a><span id="l170.48" class="difflineminus">-</span>
<a href="#l170.49"></a><span id="l170.49">   be_in_folder(folder);</span>
<a href="#l170.50"></a><span id="l170.50">   // Scroll to the top</span>
<a href="#l170.51"></a><span id="l170.51">   mc.folderDisplay.ensureRowIsVisible(0);</span>
<a href="#l170.52"></a><span id="l170.52">   let msgHdr = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l170.53"></a><span id="l170.53"> </span>
<a href="#l170.54"></a><span id="l170.54">   display_message_in_folder_tab(msgHdr, false);</span>
<a href="#l170.55"></a><span id="l170.55"> </span>
<a href="#l170.56"></a><span id="l170.56">   // Check that the right message is displayed</span>
<a href="#l170.57"></a><span id="l170.57">   assert_number_of_tabs_open(1);</span>
<a href="#l170.58"></a><span id="l170.58">   assert_folder_selected_and_displayed(folder);</span>
<a href="#l170.59"></a><span id="l170.59">   assert_selected_and_displayed(msgHdr);</span>
<a href="#l170.60"></a><span id="l170.60"> </span>
<a href="#l170.61"></a><span id="l170.61">   assert_row_visible(1);</span>
<a href="#l170.62"></a><span id="l170.62"> </span>
<a href="#l170.63"></a><span id="l170.63" class="difflineminus">-  //Initialize the globals we'll need for all our tests.</span>
<a href="#l170.64"></a><span id="l170.64" class="difflineplus">+  // Initialize the globals we'll need for all our tests.</span>
<a href="#l170.65"></a><span id="l170.65"> </span>
<a href="#l170.66"></a><span id="l170.66">   // Stash messages into arrays for convenience. We do it this way so that the</span>
<a href="#l170.67"></a><span id="l170.67">   // order of messages in the arrays is the same as in the views.</span>
<a href="#l170.68"></a><span id="l170.68">   be_in_folder(folder);</span>
<a href="#l170.69"></a><span id="l170.69">   for (let i = 0; i &lt; NUM_MESSAGES_IN_FOLDER; i++)</span>
<a href="#l170.70"></a><span id="l170.70">     msgHdrsInFolder.push(mc.dbView.getMsgHdrAt(i));</span>
<a href="#l170.71"></a><span id="l170.71"> </span>
<a href="#l170.72"></a><span id="l170.72">   // Mark all messages read</span>
<a href="#l170.73"></a><span id="l170.73" class="difflineat">@@ -69,40 +69,39 @@ function test_tab_reorder_setup_globals(</span>
<a href="#l170.74"></a><span id="l170.74"> }</span>
<a href="#l170.75"></a><span id="l170.75"> </span>
<a href="#l170.76"></a><span id="l170.76"> /**</span>
<a href="#l170.77"></a><span id="l170.77">  * Tests reordering tabs by drag'n'drop within the tabbar</span>
<a href="#l170.78"></a><span id="l170.78">  *</span>
<a href="#l170.79"></a><span id="l170.79">  * It opens additional movable and closable tabs. The picks the first</span>
<a href="#l170.80"></a><span id="l170.80">  * movable tab and drops it onto the third movable tab.</span>
<a href="#l170.81"></a><span id="l170.81">  */</span>
<a href="#l170.82"></a><span id="l170.82" class="difflineminus">-function test_tab_reorder_tabbar(){</span>
<a href="#l170.83"></a><span id="l170.83" class="difflineminus">-</span>
<a href="#l170.84"></a><span id="l170.84" class="difflineplus">+function test_tab_reorder_tabbar() {</span>
<a href="#l170.85"></a><span id="l170.85">   // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l170.86"></a><span id="l170.86">   mc.tabmail.closeOtherTabs(0);</span>
<a href="#l170.87"></a><span id="l170.87">   assert_number_of_tabs_open(1);</span>
<a href="#l170.88"></a><span id="l170.88"> </span>
<a href="#l170.89"></a><span id="l170.89">   be_in_folder(folder);</span>
<a href="#l170.90"></a><span id="l170.90"> </span>
<a href="#l170.91"></a><span id="l170.91">   // Open four tabs</span>
<a href="#l170.92"></a><span id="l170.92" class="difflineminus">-  for (let idx=0; idx &lt; 4 ; idx++) {</span>
<a href="#l170.93"></a><span id="l170.93" class="difflineplus">+  for (let idx = 0; idx &lt; 4; idx++) {</span>
<a href="#l170.94"></a><span id="l170.94">     select_click_row(idx);</span>
<a href="#l170.95"></a><span id="l170.95">     open_selected_message_in_new_tab(true);</span>
<a href="#l170.96"></a><span id="l170.96">   }</span>
<a href="#l170.97"></a><span id="l170.97"> </span>
<a href="#l170.98"></a><span id="l170.98">   // Check if every thing is correctly initialized</span>
<a href="#l170.99"></a><span id="l170.99">   assert_number_of_tabs_open(5);</span>
<a href="#l170.100"></a><span id="l170.100"> </span>
<a href="#l170.101"></a><span id="l170.101" class="difflineminus">-  assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[0] == mc.tabmail.tabInfo[1],</span>
<a href="#l170.102"></a><span id="l170.102" class="difflineplus">+  assert_true(mc.tabmail.tabModes.message.tabs[0] == mc.tabmail.tabInfo[1],</span>
<a href="#l170.103"></a><span id="l170.103">       &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l170.104"></a><span id="l170.104"> </span>
<a href="#l170.105"></a><span id="l170.105" class="difflineminus">-  assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[1] == mc.tabmail.tabInfo[2],</span>
<a href="#l170.106"></a><span id="l170.106" class="difflineplus">+  assert_true(mc.tabmail.tabModes.message.tabs[1] == mc.tabmail.tabInfo[2],</span>
<a href="#l170.107"></a><span id="l170.107">       &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l170.108"></a><span id="l170.108"> </span>
<a href="#l170.109"></a><span id="l170.109" class="difflineminus">-  assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[2] == mc.tabmail.tabInfo[3],</span>
<a href="#l170.110"></a><span id="l170.110" class="difflineplus">+  assert_true(mc.tabmail.tabModes.message.tabs[2] == mc.tabmail.tabInfo[3],</span>
<a href="#l170.111"></a><span id="l170.111">       &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l170.112"></a><span id="l170.112"> </span>
<a href="#l170.113"></a><span id="l170.113">   // Start dragging the first tab</span>
<a href="#l170.114"></a><span id="l170.114">   switch_tab(1);</span>
<a href="#l170.115"></a><span id="l170.115">   assert_selected_and_displayed(msgHdrsInFolder[0]);</span>
<a href="#l170.116"></a><span id="l170.116"> </span>
<a href="#l170.117"></a><span id="l170.117">   let tab1 = mc.tabmail.tabContainer.childNodes[1];</span>
<a href="#l170.118"></a><span id="l170.118">   let tab3 = mc.tabmail.tabContainer.childNodes[3];</span>
<a href="#l170.119"></a><span id="l170.119" class="difflineat">@@ -125,31 +124,30 @@ function test_tab_reorder_tabbar(){</span>
<a href="#l170.120"></a><span id="l170.120">   assert_true(tab3 == mc.tabmail.tabContainer.childNodes[2],</span>
<a href="#l170.121"></a><span id="l170.121">               &quot;Moving tab3 failed&quot;);</span>
<a href="#l170.122"></a><span id="l170.122">   switch_tab(2);</span>
<a href="#l170.123"></a><span id="l170.123">   assert_selected_and_displayed(msgHdrsInFolder[2]);</span>
<a href="#l170.124"></a><span id="l170.124"> </span>
<a href="#l170.125"></a><span id="l170.125">   // we have one &quot;message&quot; tab and three &quot;folder&quot; tabs, thus tabInfo[1-3] and</span>
<a href="#l170.126"></a><span id="l170.126">   // tabMode[&quot;message&quot;].tabs[0-2] have to be same, otherwise something went</span>
<a href="#l170.127"></a><span id="l170.127">   // wrong while moving tabs around</span>
<a href="#l170.128"></a><span id="l170.128" class="difflineminus">-  assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[0] == mc.tabmail.tabInfo[1],</span>
<a href="#l170.129"></a><span id="l170.129" class="difflineplus">+  assert_true(mc.tabmail.tabModes.message.tabs[0] == mc.tabmail.tabInfo[1],</span>
<a href="#l170.130"></a><span id="l170.130">       &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l170.131"></a><span id="l170.131"> </span>
<a href="#l170.132"></a><span id="l170.132" class="difflineminus">-  assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[1] == mc.tabmail.tabInfo[2],</span>
<a href="#l170.133"></a><span id="l170.133" class="difflineplus">+  assert_true(mc.tabmail.tabModes.message.tabs[1] == mc.tabmail.tabInfo[2],</span>
<a href="#l170.134"></a><span id="l170.134">       &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l170.135"></a><span id="l170.135"> </span>
<a href="#l170.136"></a><span id="l170.136" class="difflineminus">-  assert_true(mc.tabmail.tabModes[&quot;message&quot;].tabs[2] == mc.tabmail.tabInfo[3],</span>
<a href="#l170.137"></a><span id="l170.137" class="difflineplus">+  assert_true(mc.tabmail.tabModes.message.tabs[2] == mc.tabmail.tabInfo[3],</span>
<a href="#l170.138"></a><span id="l170.138">       &quot; tabMode.tabs and tabInfo out of sync&quot;);</span>
<a href="#l170.139"></a><span id="l170.139"> }</span>
<a href="#l170.140"></a><span id="l170.140"> </span>
<a href="#l170.141"></a><span id="l170.141"> /**</span>
<a href="#l170.142"></a><span id="l170.142">  * Tests drag'n'drop tab reordering between windows</span>
<a href="#l170.143"></a><span id="l170.143">  */</span>
<a href="#l170.144"></a><span id="l170.144" class="difflineminus">-function test_tab_reorder_window(){</span>
<a href="#l170.145"></a><span id="l170.145" class="difflineminus">-</span>
<a href="#l170.146"></a><span id="l170.146" class="difflineplus">+function test_tab_reorder_window() {</span>
<a href="#l170.147"></a><span id="l170.147">   // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l170.148"></a><span id="l170.148">   mc.tabmail.closeOtherTabs(0);</span>
<a href="#l170.149"></a><span id="l170.149">   assert_number_of_tabs_open(1);</span>
<a href="#l170.150"></a><span id="l170.150"> </span>
<a href="#l170.151"></a><span id="l170.151">   let mc2 = null;</span>
<a href="#l170.152"></a><span id="l170.152"> </span>
<a href="#l170.153"></a><span id="l170.153">   be_in_folder(folder);</span>
<a href="#l170.154"></a><span id="l170.154"> </span>
<a href="#l170.155"></a><span id="l170.155" class="difflineat">@@ -168,48 +166,47 @@ function test_tab_reorder_window(){</span>
<a href="#l170.156"></a><span id="l170.156">   let args = {msgHdr: msgHdrsInFolder[3]};</span>
<a href="#l170.157"></a><span id="l170.157">   args.wrappedJSObject = args;</span>
<a href="#l170.158"></a><span id="l170.158"> </span>
<a href="#l170.159"></a><span id="l170.159">   let aWnd2 = Services.ww.openWindow(null,</span>
<a href="#l170.160"></a><span id="l170.160">         &quot;chrome://messenger/content/&quot;, &quot;&quot;,</span>
<a href="#l170.161"></a><span id="l170.161">         &quot;all,chrome,dialog=no,status,toolbar&quot;, args);</span>
<a href="#l170.162"></a><span id="l170.162"> </span>
<a href="#l170.163"></a><span id="l170.163">   mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l170.164"></a><span id="l170.164" class="difflineminus">-  wait_for_message_display_completion(mc2,true);</span>
<a href="#l170.165"></a><span id="l170.165" class="difflineplus">+  wait_for_message_display_completion(mc2, true);</span>
<a href="#l170.166"></a><span id="l170.166"> </span>
<a href="#l170.167"></a><span id="l170.167">   // Double check if we are listening to the right window.</span>
<a href="#l170.168"></a><span id="l170.168" class="difflineminus">-  assert_true(aWnd2 == mc2.window, &quot;Opening Window failed&quot; );</span>
<a href="#l170.169"></a><span id="l170.169" class="difflineplus">+  assert_true(aWnd2 == mc2.window, &quot;Opening Window failed&quot;);</span>
<a href="#l170.170"></a><span id="l170.170"> </span>
<a href="#l170.171"></a><span id="l170.171">   // Start dragging the first tab ...</span>
<a href="#l170.172"></a><span id="l170.172">   let tabA = mc.tabmail.tabContainer.childNodes[1];</span>
<a href="#l170.173"></a><span id="l170.173">   assert_true(tabA, &quot;No movable Tab&quot;);</span>
<a href="#l170.174"></a><span id="l170.174"> </span>
<a href="#l170.175"></a><span id="l170.175">   // We drop onto the Folder Tab, it is guaranteed to exist.</span>
<a href="#l170.176"></a><span id="l170.176">   let tabB = mc2.tabmail.tabContainer.childNodes[0];</span>
<a href="#l170.177"></a><span id="l170.177">   assert_true(tabB, &quot;No movable Tab&quot;);</span>
<a href="#l170.178"></a><span id="l170.178"> </span>
<a href="#l170.179"></a><span id="l170.179">   drag_n_drop_element(tabA, mc.window, tabB, mc2.window, 0.75, 0.0,</span>
<a href="#l170.180"></a><span id="l170.180">                       mc.tabmail.tabContainer);</span>
<a href="#l170.181"></a><span id="l170.181"> </span>
<a href="#l170.182"></a><span id="l170.182">   wait_for_message_display_completion(mc2);</span>
<a href="#l170.183"></a><span id="l170.183"> </span>
<a href="#l170.184"></a><span id="l170.184" class="difflineminus">-  assert_true( !! (mc.tabmail.tabContainer.childNodes.length == 1),</span>
<a href="#l170.185"></a><span id="l170.185" class="difflineplus">+  assert_true(mc.tabmail.tabContainer.childNodes.length == 1,</span>
<a href="#l170.186"></a><span id="l170.186">     &quot;Moving tab to new window failed, tab still in old window&quot;);</span>
<a href="#l170.187"></a><span id="l170.187"> </span>
<a href="#l170.188"></a><span id="l170.188" class="difflineminus">-  assert_true( !! (mc2.tabmail.tabContainer.childNodes.length == 2),</span>
<a href="#l170.189"></a><span id="l170.189" class="difflineplus">+  assert_true(mc2.tabmail.tabContainer.childNodes.length == 2,</span>
<a href="#l170.190"></a><span id="l170.190">     &quot;Moving tab to new window failed, no new tab in new window&quot;);</span>
<a href="#l170.191"></a><span id="l170.191"> </span>
<a href="#l170.192"></a><span id="l170.192" class="difflineminus">-  assert_selected_and_displayed(mc2,msgHdrsInFolder[1]);</span>
<a href="#l170.193"></a><span id="l170.193" class="difflineplus">+  assert_selected_and_displayed(mc2, msgHdrsInFolder[1]);</span>
<a href="#l170.194"></a><span id="l170.194"> }</span>
<a href="#l170.195"></a><span id="l170.195"> </span>
<a href="#l170.196"></a><span id="l170.196"> /**</span>
<a href="#l170.197"></a><span id="l170.197">  * Tests detaching tabs into windows via drag'n'drop</span>
<a href="#l170.198"></a><span id="l170.198">  */</span>
<a href="#l170.199"></a><span id="l170.199" class="difflineminus">-function test_tab_reorder_detach(){</span>
<a href="#l170.200"></a><span id="l170.200" class="difflineminus">-</span>
<a href="#l170.201"></a><span id="l170.201" class="difflineplus">+function test_tab_reorder_detach() {</span>
<a href="#l170.202"></a><span id="l170.202">   // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l170.203"></a><span id="l170.203">   mc.tabmail.closeOtherTabs(0);</span>
<a href="#l170.204"></a><span id="l170.204">   assert_number_of_tabs_open(1);</span>
<a href="#l170.205"></a><span id="l170.205"> </span>
<a href="#l170.206"></a><span id="l170.206">   let mc2 = null;</span>
<a href="#l170.207"></a><span id="l170.207"> </span>
<a href="#l170.208"></a><span id="l170.208">   be_in_folder(folder);</span>
<a href="#l170.209"></a><span id="l170.209"> </span>
<a href="#l170.210"></a><span id="l170.210" class="difflineat">@@ -231,31 +228,30 @@ function test_tab_reorder_detach(){</span>
<a href="#l170.211"></a><span id="l170.211"> </span>
<a href="#l170.212"></a><span id="l170.212">   let dt = synthesize_drag_start(mc.window, tab1, mc.tabmail.tabContainer);</span>
<a href="#l170.213"></a><span id="l170.213"> </span>
<a href="#l170.214"></a><span id="l170.214">   synthesize_drag_over(mc.window, dropContent, dt);</span>
<a href="#l170.215"></a><span id="l170.215"> </span>
<a href="#l170.216"></a><span id="l170.216">   // notify tab1 drag has ended</span>
<a href="#l170.217"></a><span id="l170.217">   let dropRect = dropContent.getBoundingClientRect();</span>
<a href="#l170.218"></a><span id="l170.218">   synthesize_drag_end(mc.window, dropContent, tab1, dt,</span>
<a href="#l170.219"></a><span id="l170.219" class="difflineminus">-      { screenX : (dropContent.screenX + dropRect.width / 2 ),</span>
<a href="#l170.220"></a><span id="l170.220" class="difflineminus">-        screenY : (dropContent.screenY + dropRect.height / 2 ) });</span>
<a href="#l170.221"></a><span id="l170.221" class="difflineplus">+      { screenX: (dropContent.screenX + dropRect.width / 2),</span>
<a href="#l170.222"></a><span id="l170.222" class="difflineplus">+        screenY: (dropContent.screenY + dropRect.height / 2) });</span>
<a href="#l170.223"></a><span id="l170.223"> </span>
<a href="#l170.224"></a><span id="l170.224">   // ... and wait for the new window</span>
<a href="#l170.225"></a><span id="l170.225">   mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l170.226"></a><span id="l170.226">   wait_for_message_display_completion(mc2, true);</span>
<a href="#l170.227"></a><span id="l170.227"> </span>
<a href="#l170.228"></a><span id="l170.228">   assert_true(mc.tabmail.tabContainer.childNodes.length == 1,</span>
<a href="#l170.229"></a><span id="l170.229">       &quot;Moving tab to new window failed, tab still in old window&quot;);</span>
<a href="#l170.230"></a><span id="l170.230"> </span>
<a href="#l170.231"></a><span id="l170.231">   assert_true(mc2.tabmail.tabContainer.childNodes.length == 2,</span>
<a href="#l170.232"></a><span id="l170.232">       &quot;Moving tab to new window failed, no new tab in new window&quot;);</span>
<a href="#l170.233"></a><span id="l170.233"> </span>
<a href="#l170.234"></a><span id="l170.234">   assert_selected_and_displayed(mc2, msgHdrsInFolder[2]);</span>
<a href="#l170.235"></a><span id="l170.235" class="difflineminus">-</span>
<a href="#l170.236"></a><span id="l170.236"> }</span>
<a href="#l170.237"></a><span id="l170.237"> </span>
<a href="#l170.238"></a><span id="l170.238"> /**</span>
<a href="#l170.239"></a><span id="l170.239">  * Test undo of recently closed tabs.</span>
<a href="#l170.240"></a><span id="l170.240">  */</span>
<a href="#l170.241"></a><span id="l170.241"> function test_tab_undo() {</span>
<a href="#l170.242"></a><span id="l170.242">   // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l170.243"></a><span id="l170.243">   mc.tabmail.closeOtherTabs(0);</span>
<a href="#l170.244"></a><span id="l170.244" class="difflineat">@@ -289,43 +285,40 @@ function test_tab_undo() {</span>
<a href="#l170.245"></a><span id="l170.245"> </span>
<a href="#l170.246"></a><span id="l170.246">   // msgHdrsInFolder[2] won't be restorend it was closed with disabled undo.</span>
<a href="#l170.247"></a><span id="l170.247"> </span>
<a href="#l170.248"></a><span id="l170.248">   mc.tabmail.undoCloseTab();</span>
<a href="#l170.249"></a><span id="l170.249">   assert_number_of_tabs_open(5);</span>
<a href="#l170.250"></a><span id="l170.250">   assert_selected_and_displayed(mc, msgHdrsInFolder[1]);</span>
<a href="#l170.251"></a><span id="l170.251"> }</span>
<a href="#l170.252"></a><span id="l170.252"> </span>
<a href="#l170.253"></a><span id="l170.253" class="difflineminus">-function _synthesizeRecentlyClosedMenu()</span>
<a href="#l170.254"></a><span id="l170.254" class="difflineminus">-{</span>
<a href="#l170.255"></a><span id="l170.255" class="difflineplus">+function _synthesizeRecentlyClosedMenu() {</span>
<a href="#l170.256"></a><span id="l170.256">   mc.rightClick(new elib.Elem(mc.tabmail.tabContainer.childNodes[1]));</span>
<a href="#l170.257"></a><span id="l170.257"> </span>
<a href="#l170.258"></a><span id="l170.258">   let tabContextMenu = mc.window.document.getElementById(&quot;tabContextMenu&quot;);</span>
<a href="#l170.259"></a><span id="l170.259">   wait_for_popup_to_open(tabContextMenu);</span>
<a href="#l170.260"></a><span id="l170.260"> </span>
<a href="#l170.261"></a><span id="l170.261">   let recentlyClosedTabs = tabContextMenu</span>
<a href="#l170.262"></a><span id="l170.262">                            .querySelector('[anonid=&quot;recentlyClosedTabs&quot;]');</span>
<a href="#l170.263"></a><span id="l170.263"> </span>
<a href="#l170.264"></a><span id="l170.264">   EventUtils.synthesizeMouse(recentlyClosedTabs, 5, 5, {}, mc.window);</span>
<a href="#l170.265"></a><span id="l170.265">   wait_for_popup_to_open(recentlyClosedTabs.menupopup);</span>
<a href="#l170.266"></a><span id="l170.266"> </span>
<a href="#l170.267"></a><span id="l170.267">   return recentlyClosedTabs;</span>
<a href="#l170.268"></a><span id="l170.268"> }</span>
<a href="#l170.269"></a><span id="l170.269"> </span>
<a href="#l170.270"></a><span id="l170.270" class="difflineminus">-function _teardownRecentlyClosedMenu()</span>
<a href="#l170.271"></a><span id="l170.271" class="difflineminus">-{</span>
<a href="#l170.272"></a><span id="l170.272" class="difflineplus">+function _teardownRecentlyClosedMenu() {</span>
<a href="#l170.273"></a><span id="l170.273">   let menu = mc.window.document.getElementById(&quot;tabContextMenu&quot;);</span>
<a href="#l170.274"></a><span id="l170.274" class="difflineminus">-  close_popup(mc,new elib.Elem(menu));</span>
<a href="#l170.275"></a><span id="l170.275" class="difflineplus">+  close_popup(mc, new elib.Elem(menu));</span>
<a href="#l170.276"></a><span id="l170.276"> }</span>
<a href="#l170.277"></a><span id="l170.277"> </span>
<a href="#l170.278"></a><span id="l170.278"> /**</span>
<a href="#l170.279"></a><span id="l170.279">  * Tests the recently closed tabs menu.</span>
<a href="#l170.280"></a><span id="l170.280">  */</span>
<a href="#l170.281"></a><span id="l170.281"> function test_tab_recentlyClosed() {</span>
<a href="#l170.282"></a><span id="l170.282" class="difflineminus">-</span>
<a href="#l170.283"></a><span id="l170.283">   // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l170.284"></a><span id="l170.284">   mc.tabmail.closeOtherTabs(0, true);</span>
<a href="#l170.285"></a><span id="l170.285">   assert_number_of_tabs_open(1);</span>
<a href="#l170.286"></a><span id="l170.286"> </span>
<a href="#l170.287"></a><span id="l170.287">   // We start with a clean tab history.</span>
<a href="#l170.288"></a><span id="l170.288">   mc.tabmail.clearRecentlyClosedTabs();</span>
<a href="#l170.289"></a><span id="l170.289">   assert_equals(mc.tabmail.recentlyClosedTabs.length, 0);</span>
<a href="#l170.290"></a><span id="l170.290"> </span>
<a href="#l170.291"></a><span id="l170.291" class="difflineat">@@ -338,105 +331,100 @@ function test_tab_recentlyClosed() {</span>
<a href="#l170.292"></a><span id="l170.292">   }</span>
<a href="#l170.293"></a><span id="l170.293"> </span>
<a href="#l170.294"></a><span id="l170.294">   assert_number_of_tabs_open(16);</span>
<a href="#l170.295"></a><span id="l170.295"> </span>
<a href="#l170.296"></a><span id="l170.296">   switch_tab(2);</span>
<a href="#l170.297"></a><span id="l170.297">   assert_selected_and_displayed(msgHdrsInFolder[1]);</span>
<a href="#l170.298"></a><span id="l170.298"> </span>
<a href="#l170.299"></a><span id="l170.299">   // ... and store the tab titles, to ensure they match with the menu items.</span>
<a href="#l170.300"></a><span id="l170.300" class="difflineminus">-  let tabTitles = []</span>
<a href="#l170.301"></a><span id="l170.301" class="difflineplus">+  let tabTitles = [];</span>
<a href="#l170.302"></a><span id="l170.302">   for (let idx = 0; idx &lt; 16; idx++)</span>
<a href="#l170.303"></a><span id="l170.303">     tabTitles.unshift(mc.tabmail.tabInfo[idx].title);</span>
<a href="#l170.304"></a><span id="l170.304"> </span>
<a href="#l170.305"></a><span id="l170.305">   // Start the test by closing all tabs except the first two tabs...</span>
<a href="#l170.306"></a><span id="l170.306">   for (let idx = 0; idx &lt; 14; idx++)</span>
<a href="#l170.307"></a><span id="l170.307">     mc.tabmail.closeTab(2);</span>
<a href="#l170.308"></a><span id="l170.308"> </span>
<a href="#l170.309"></a><span id="l170.309">   assert_number_of_tabs_open(2);</span>
<a href="#l170.310"></a><span id="l170.310"> </span>
<a href="#l170.311"></a><span id="l170.311">   // ...then open the context menu.</span>
<a href="#l170.312"></a><span id="l170.312">   let menu = _synthesizeRecentlyClosedMenu();</span>
<a href="#l170.313"></a><span id="l170.313"> </span>
<a href="#l170.314"></a><span id="l170.314">   // Check if the context menu was populated correctly...</span>
<a href="#l170.315"></a><span id="l170.315">   assert_true(menu.itemCount == 12, &quot;Failed to populate context menu&quot;);</span>
<a href="#l170.316"></a><span id="l170.316" class="difflineminus">-  for (let idx=0; idx &lt; 10; idx++)</span>
<a href="#l170.317"></a><span id="l170.317" class="difflineplus">+  for (let idx = 0; idx &lt; 10; idx++)</span>
<a href="#l170.318"></a><span id="l170.318">     assert_true(tabTitles[idx] == menu.getItemAtIndex(idx).label,</span>
<a href="#l170.319"></a><span id="l170.319">                 &quot;Tab Title does not match Menu item&quot;);</span>
<a href="#l170.320"></a><span id="l170.320"> </span>
<a href="#l170.321"></a><span id="l170.321">   // Restore the most recently closed tab</span>
<a href="#l170.322"></a><span id="l170.322" class="difflineminus">-  EventUtils.synthesizeMouse(menu.getItemAtIndex(0),5, 5, {},mc.window);</span>
<a href="#l170.323"></a><span id="l170.323" class="difflineplus">+  EventUtils.synthesizeMouse(menu.getItemAtIndex(0), 5, 5, {}, mc.window);</span>
<a href="#l170.324"></a><span id="l170.324">   _teardownRecentlyClosedMenu();</span>
<a href="#l170.325"></a><span id="l170.325"> </span>
<a href="#l170.326"></a><span id="l170.326">   wait_for_message_display_completion(mc);</span>
<a href="#l170.327"></a><span id="l170.327">   assert_number_of_tabs_open(3);</span>
<a href="#l170.328"></a><span id="l170.328">   assert_selected_and_displayed(msgHdrsInFolder[14]);</span>
<a href="#l170.329"></a><span id="l170.329"> </span>
<a href="#l170.330"></a><span id="l170.330">   // The context menu should now contain one item less.</span>
<a href="#l170.331"></a><span id="l170.331">   _synthesizeRecentlyClosedMenu();</span>
<a href="#l170.332"></a><span id="l170.332"> </span>
<a href="#l170.333"></a><span id="l170.333"> </span>
<a href="#l170.334"></a><span id="l170.334">   assert_true(menu.itemCount == 11, &quot;Failed to populate context menu&quot;);</span>
<a href="#l170.335"></a><span id="l170.335" class="difflineminus">-  for (let idx=0; idx &lt; 9; idx++)</span>
<a href="#l170.336"></a><span id="l170.336" class="difflineminus">-    assert_true(tabTitles[idx+1] == menu.getItemAtIndex(idx).label,</span>
<a href="#l170.337"></a><span id="l170.337" class="difflineplus">+  for (let idx = 0; idx &lt; 9; idx++)</span>
<a href="#l170.338"></a><span id="l170.338" class="difflineplus">+    assert_true(tabTitles[idx + 1] == menu.getItemAtIndex(idx).label,</span>
<a href="#l170.339"></a><span id="l170.339">                 &quot;Tab Title does not match Menu item&quot;);</span>
<a href="#l170.340"></a><span id="l170.340"> </span>
<a href="#l170.341"></a><span id="l170.341">   // Now we restore an &quot;random&quot; tab.</span>
<a href="#l170.342"></a><span id="l170.342" class="difflineminus">-  EventUtils.synthesizeMouse(menu.getItemAtIndex(5),5, 5, {},mc.window);</span>
<a href="#l170.343"></a><span id="l170.343" class="difflineplus">+  EventUtils.synthesizeMouse(menu.getItemAtIndex(5), 5, 5, {}, mc.window);</span>
<a href="#l170.344"></a><span id="l170.344">   _teardownRecentlyClosedMenu();</span>
<a href="#l170.345"></a><span id="l170.345"> </span>
<a href="#l170.346"></a><span id="l170.346">   wait_for_message_display_completion(mc);</span>
<a href="#l170.347"></a><span id="l170.347">   assert_number_of_tabs_open(4);</span>
<a href="#l170.348"></a><span id="l170.348">   assert_selected_and_displayed(msgHdrsInFolder[8]);</span>
<a href="#l170.349"></a><span id="l170.349"> </span>
<a href="#l170.350"></a><span id="l170.350">   // finally restore all tabs</span>
<a href="#l170.351"></a><span id="l170.351">   _synthesizeRecentlyClosedMenu();</span>
<a href="#l170.352"></a><span id="l170.352"> </span>
<a href="#l170.353"></a><span id="l170.353">   assert_true(menu.itemCount == 10,</span>
<a href="#l170.354"></a><span id="l170.354">       &quot;Failed to populate context menu&quot;);</span>
<a href="#l170.355"></a><span id="l170.355">   assert_true(tabTitles[1] == menu.getItemAtIndex(0).label,</span>
<a href="#l170.356"></a><span id="l170.356">       &quot;Tab Title does not match Menu item&quot;);</span>
<a href="#l170.357"></a><span id="l170.357">   assert_true(tabTitles[7] == menu.getItemAtIndex(5).label,</span>
<a href="#l170.358"></a><span id="l170.358">       &quot;Tab Title does not match Menu item&quot;);</span>
<a href="#l170.359"></a><span id="l170.359"> </span>
<a href="#l170.360"></a><span id="l170.360" class="difflineminus">-  EventUtils.synthesizeMouse(menu.getItemAtIndex(menu.itemCount-1),5, 5, {},mc.window);</span>
<a href="#l170.361"></a><span id="l170.361" class="difflineplus">+  EventUtils.synthesizeMouse(menu.getItemAtIndex(menu.itemCount - 1), 5, 5, {}, mc.window);</span>
<a href="#l170.362"></a><span id="l170.362">   _teardownRecentlyClosedMenu();</span>
<a href="#l170.363"></a><span id="l170.363"> </span>
<a href="#l170.364"></a><span id="l170.364">   wait_for_message_display_completion(mc);</span>
<a href="#l170.365"></a><span id="l170.365"> </span>
<a href="#l170.366"></a><span id="l170.366">   // out of the 16 tab, we closed all except two. As the history can store</span>
<a href="#l170.367"></a><span id="l170.367">   // only 10 items we have to endup with exactly 10 + 2 tabs.</span>
<a href="#l170.368"></a><span id="l170.368">   assert_number_of_tabs_open(12);</span>
<a href="#l170.369"></a><span id="l170.369"> }</span>
<a href="#l170.370"></a><span id="l170.370"> </span>
<a href="#l170.371"></a><span id="l170.371" class="difflineminus">-function teardownTest(test)</span>
<a href="#l170.372"></a><span id="l170.372" class="difflineminus">-{</span>
<a href="#l170.373"></a><span id="l170.373" class="difflineminus">-</span>
<a href="#l170.374"></a><span id="l170.374" class="difflineminus">-  switch(test)</span>
<a href="#l170.375"></a><span id="l170.375" class="difflineminus">-  {</span>
<a href="#l170.376"></a><span id="l170.376" class="difflineplus">+function teardownTest(test) {</span>
<a href="#l170.377"></a><span id="l170.377" class="difflineplus">+  switch (test) {</span>
<a href="#l170.378"></a><span id="l170.378">     case test_tab_reorder_detach :</span>
<a href="#l170.379"></a><span id="l170.379">     case test_tab_reorder_window :</span>
<a href="#l170.380"></a><span id="l170.380">       // Some test cases open new windows, thus we need to ensure all</span>
<a href="#l170.381"></a><span id="l170.381">       // opened windows get closed.</span>
<a href="#l170.382"></a><span id="l170.382"> </span>
<a href="#l170.383"></a><span id="l170.383">       let en = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l170.384"></a><span id="l170.384"> </span>
<a href="#l170.385"></a><span id="l170.385" class="difflineminus">-       while(en.hasMoreElements()) {</span>
<a href="#l170.386"></a><span id="l170.386" class="difflineminus">-</span>
<a href="#l170.387"></a><span id="l170.387" class="difflineplus">+       while (en.hasMoreElements()) {</span>
<a href="#l170.388"></a><span id="l170.388">          var win = en.getNext();</span>
<a href="#l170.389"></a><span id="l170.389"> </span>
<a href="#l170.390"></a><span id="l170.390" class="difflineminus">-         if(win != mc.window)</span>
<a href="#l170.391"></a><span id="l170.391" class="difflineplus">+         if (win != mc.window)</span>
<a href="#l170.392"></a><span id="l170.392">            close_window(new mozmill.controller.MozMillController(win));</span>
<a href="#l170.393"></a><span id="l170.393">        }</span>
<a href="#l170.394"></a><span id="l170.394"> </span>
<a href="#l170.395"></a><span id="l170.395">        // fall through!</span>
<a href="#l170.396"></a><span id="l170.396"> </span>
<a href="#l170.397"></a><span id="l170.397">     case test_tab_reorder_tabbar :</span>
<a href="#l170.398"></a><span id="l170.398"> </span>
<a href="#l170.399"></a><span id="l170.399">     case test_tab_recentlyClosed :</span>
<a href="#l170.400"></a><span id="l170.400">     case test_tab_undo :</span>
<a href="#l170.401"></a><span id="l170.401"> </span>
<a href="#l170.402"></a><span id="l170.402">       // clean up the tabbbar</span>
<a href="#l170.403"></a><span id="l170.403">       mc.tabmail.closeOtherTabs(0);</span>
<a href="#l170.404"></a><span id="l170.404">       assert_number_of_tabs_open(1);</span>
<a href="#l170.405"></a><span id="l170.405">   }</span>
<a href="#l170.406"></a><span id="l170.406" class="difflineminus">-</span>
<a href="#l170.407"></a><span id="l170.407"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l171.1"></a><span id="l171.1" class="difflineminus">--- a/mail/test/mozmill/utils/html/collections.html</span>
<a href="#l171.2"></a><span id="l171.2" class="difflineplus">+++ b/mail/test/mozmill/utils/html/collections.html</span>
<a href="#l171.3"></a><span id="l171.3" class="difflineat">@@ -1,24 +1,24 @@</span>
<a href="#l171.4"></a><span id="l171.4"> &lt;html&gt;</span>
<a href="#l171.5"></a><span id="l171.5">   &lt;head&gt;</span>
<a href="#l171.6"></a><span id="l171.6">     &lt;title&gt;Collections&lt;/title&gt;</span>
<a href="#l171.7"></a><span id="l171.7">     &lt;script&gt;</span>
<a href="#l171.8"></a><span id="l171.8">       const JS_HAS_SYMBOLS = typeof Symbol === &quot;function&quot;;</span>
<a href="#l171.9"></a><span id="l171.9">       const ITERATOR_SYMBOL = JS_HAS_SYMBOLS ? Symbol.iterator : &quot;@@iterator&quot;;</span>
<a href="#l171.10"></a><span id="l171.10" class="difflineminus">-      var gIterator = (function*() {</span>
<a href="#l171.11"></a><span id="l171.11" class="difflineplus">+      var gIterator = (function* () {</span>
<a href="#l171.12"></a><span id="l171.12">         yield 1; yield 2; yield 3; yield 4; yield 5;</span>
<a href="#l171.13"></a><span id="l171.13">       })();</span>
<a href="#l171.14"></a><span id="l171.14"> </span>
<a href="#l171.15"></a><span id="l171.15">       var gCustomIterator = {</span>
<a href="#l171.16"></a><span id="l171.16">         _array: [6, 7, 8, 9],</span>
<a href="#l171.17"></a><span id="l171.17">         [ITERATOR_SYMBOL]: function* testIterator() {</span>
<a href="#l171.18"></a><span id="l171.18">           for (var i = 0; i &lt; this._array.length; ++i)</span>
<a href="#l171.19"></a><span id="l171.19">             yield this._array[i];</span>
<a href="#l171.20"></a><span id="l171.20" class="difflineminus">-        }</span>
<a href="#l171.21"></a><span id="l171.21" class="difflineplus">+        },</span>
<a href="#l171.22"></a><span id="l171.22">       };</span>
<a href="#l171.23"></a><span id="l171.23">     &lt;/script&gt;</span>
<a href="#l171.24"></a><span id="l171.24">   &lt;/head&gt;</span>
<a href="#l171.25"></a><span id="l171.25">   &lt;body&gt;</span>
<a href="#l171.26"></a><span id="l171.26">     I have two collections defined - gIterator is an iterator, and contains</span>
<a href="#l171.27"></a><span id="l171.27">     [1, 2, 3, 4, 5], and gCustomIterator is an object with an @@iterator</span>
<a href="#l171.28"></a><span id="l171.28">     method that contains [6, 7, 8, 9].</span>
<a href="#l171.29"></a><span id="l171.29">   &lt;/body&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l172.1"></a><span id="l172.1" class="difflineminus">--- a/mail/test/mozmill/utils/test-extensionSupport.js</span>
<a href="#l172.2"></a><span id="l172.2" class="difflineplus">+++ b/mail/test/mozmill/utils/test-extensionSupport.js</span>
<a href="#l172.3"></a><span id="l172.3" class="difflineat">@@ -1,23 +1,23 @@</span>
<a href="#l172.4"></a><span id="l172.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l172.5"></a><span id="l172.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l172.6"></a><span id="l172.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l172.7"></a><span id="l172.7"> </span>
<a href="#l172.8"></a><span id="l172.8"> /**</span>
<a href="#l172.9"></a><span id="l172.9">  * Tests ExtensionSupport.jsm functions.</span>
<a href="#l172.10"></a><span id="l172.10">  */</span>
<a href="#l172.11"></a><span id="l172.11"> </span>
<a href="#l172.12"></a><span id="l172.12" class="difflineminus">-// make SOLO_TEST=utils/test-extensionSupport.js mozmill-one</span>
<a href="#l172.13"></a><span id="l172.13" class="difflineplus">+/* import-globals-from ../shared-modules/test-address-book-helpers.js */</span>
<a href="#l172.14"></a><span id="l172.14" class="difflineplus">+/* import-globals-from ../shared-modules/test-compose-helpers.js */</span>
<a href="#l172.15"></a><span id="l172.15" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l172.16"></a><span id="l172.16"> </span>
<a href="#l172.17"></a><span id="l172.17"> var MODULE_NAME = &quot;test-extensionSupport&quot;;</span>
<a href="#l172.18"></a><span id="l172.18" class="difflineminus">-</span>
<a href="#l172.19"></a><span id="l172.19"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l172.20"></a><span id="l172.20" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;,</span>
<a href="#l172.21"></a><span id="l172.21" class="difflineminus">-                       &quot;address-book-helpers&quot; ];</span>
<a href="#l172.22"></a><span id="l172.22" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;compose-helpers&quot;, &quot;address-book-helpers&quot;];</span>
<a href="#l172.23"></a><span id="l172.23"> </span>
<a href="#l172.24"></a><span id="l172.24"> var {ExtensionSupport} = ChromeUtils.import(&quot;resource:///modules/ExtensionSupport.jsm&quot;);</span>
<a href="#l172.25"></a><span id="l172.25"> </span>
<a href="#l172.26"></a><span id="l172.26"> function setupModule(module) {</span>
<a href="#l172.27"></a><span id="l172.27">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l172.28"></a><span id="l172.28">     collector.getModule(lib).installInto(module);</span>
<a href="#l172.29"></a><span id="l172.29">   }</span>
<a href="#l172.30"></a><span id="l172.30"> }</span>
<a href="#l172.31"></a><span id="l172.31" class="difflineat">@@ -29,18 +29,18 @@ function teardownModule(module) {</span>
<a href="#l172.32"></a><span id="l172.32">  * Bug 1450288</span>
<a href="#l172.33"></a><span id="l172.33">  * Test ExtensionSupport.registerWindowListener and ExtensionSupport.unregisterWindowListener.</span>
<a href="#l172.34"></a><span id="l172.34">  */</span>
<a href="#l172.35"></a><span id="l172.35"> function test_windowListeners() {</span>
<a href="#l172.36"></a><span id="l172.36">   // There may be some pre-existing listeners already set up, e.g. mozmill ones.</span>
<a href="#l172.37"></a><span id="l172.37">   let originalListenerCount = ExtensionSupport.registeredWindowListenerCount;</span>
<a href="#l172.38"></a><span id="l172.38"> </span>
<a href="#l172.39"></a><span id="l172.39">   let addonRunCount = [];</span>
<a href="#l172.40"></a><span id="l172.40" class="difflineminus">-  addonRunCount[&quot;load&quot;] = new Map();</span>
<a href="#l172.41"></a><span id="l172.41" class="difflineminus">-  addonRunCount[&quot;unload&quot;] = new Map();</span>
<a href="#l172.42"></a><span id="l172.42" class="difflineplus">+  addonRunCount.load = new Map();</span>
<a href="#l172.43"></a><span id="l172.43" class="difflineplus">+  addonRunCount.unload = new Map();</span>
<a href="#l172.44"></a><span id="l172.44"> </span>
<a href="#l172.45"></a><span id="l172.45">   function addonListener(aAddon, aEvent) {</span>
<a href="#l172.46"></a><span id="l172.46">     if (!addonRunCount[aEvent].has(aAddon)) {</span>
<a href="#l172.47"></a><span id="l172.47">       addonRunCount[aEvent].set(aAddon, 0);</span>
<a href="#l172.48"></a><span id="l172.48">     }</span>
<a href="#l172.49"></a><span id="l172.49">     addonRunCount[aEvent].set(aAddon, addonRunCount[aEvent].get(aAddon) + 1);</span>
<a href="#l172.50"></a><span id="l172.50">   }</span>
<a href="#l172.51"></a><span id="l172.51"> </span>
<a href="#l172.52"></a><span id="l172.52" class="difflineat">@@ -50,58 +50,62 @@ function test_windowListeners() {</span>
<a href="#l172.53"></a><span id="l172.53"> </span>
<a href="#l172.54"></a><span id="l172.54">     return addonRunCount[aEvent].get(aAddon);</span>
<a href="#l172.55"></a><span id="l172.55">   }</span>
<a href="#l172.56"></a><span id="l172.56"> </span>
<a href="#l172.57"></a><span id="l172.57">   // Extension listening to all windows and all events.</span>
<a href="#l172.58"></a><span id="l172.58">   assert_true(ExtensionSupport.registerWindowListener(</span>
<a href="#l172.59"></a><span id="l172.59">     &quot;test-addon1&quot;,</span>
<a href="#l172.60"></a><span id="l172.60">     {</span>
<a href="#l172.61"></a><span id="l172.61" class="difflineminus">-      onLoadWindow: function() { addonListener(&quot;test-addon1&quot;, &quot;load&quot;); },</span>
<a href="#l172.62"></a><span id="l172.62" class="difflineminus">-      onUnloadWindow: function() { addonListener(&quot;test-addon1&quot;, &quot;unload&quot;); }</span>
<a href="#l172.63"></a><span id="l172.63" class="difflineplus">+      onLoadWindow() { addonListener(&quot;test-addon1&quot;, &quot;load&quot;); },</span>
<a href="#l172.64"></a><span id="l172.64" class="difflineplus">+      onUnloadWindow() { addonListener(&quot;test-addon1&quot;, &quot;unload&quot;); },</span>
<a href="#l172.65"></a><span id="l172.65">     })</span>
<a href="#l172.66"></a><span id="l172.66">   );</span>
<a href="#l172.67"></a><span id="l172.67"> </span>
<a href="#l172.68"></a><span id="l172.68">   assert_equals(addonCount(&quot;test-addon1&quot;, &quot;load&quot;), 1);</span>
<a href="#l172.69"></a><span id="l172.69"> </span>
<a href="#l172.70"></a><span id="l172.70">   // Extension listening to compose window only.</span>
<a href="#l172.71"></a><span id="l172.71">   assert_true(ExtensionSupport.registerWindowListener(</span>
<a href="#l172.72"></a><span id="l172.72">     &quot;test-addon2&quot;,</span>
<a href="#l172.73"></a><span id="l172.73">     {</span>
<a href="#l172.74"></a><span id="l172.74">       chromeURLs: [ &quot;chrome://messenger/content/messengercompose/messengercompose.xul&quot; ],</span>
<a href="#l172.75"></a><span id="l172.75" class="difflineminus">-      onLoadWindow: function() { addonListener(&quot;test-addon2&quot;, &quot;load&quot;); },</span>
<a href="#l172.76"></a><span id="l172.76" class="difflineminus">-      onUnloadWindow: function() { addonListener(&quot;test-addon2&quot;, &quot;unload&quot;); }</span>
<a href="#l172.77"></a><span id="l172.77" class="difflineplus">+      onLoadWindow() { addonListener(&quot;test-addon2&quot;, &quot;load&quot;); },</span>
<a href="#l172.78"></a><span id="l172.78" class="difflineplus">+      onUnloadWindow() { addonListener(&quot;test-addon2&quot;, &quot;unload&quot;); },</span>
<a href="#l172.79"></a><span id="l172.79">     })</span>
<a href="#l172.80"></a><span id="l172.80">   );</span>
<a href="#l172.81"></a><span id="l172.81"> </span>
<a href="#l172.82"></a><span id="l172.82">   let cwc = open_compose_new_mail();</span>
<a href="#l172.83"></a><span id="l172.83"> </span>
<a href="#l172.84"></a><span id="l172.84">   assert_equals(addonCount(&quot;test-addon1&quot;, &quot;load&quot;), 2);</span>
<a href="#l172.85"></a><span id="l172.85">   assert_equals(addonCount(&quot;test-addon2&quot;, &quot;load&quot;), 1);</span>
<a href="#l172.86"></a><span id="l172.86"> </span>
<a href="#l172.87"></a><span id="l172.87">   // Extension listening to compose window once while it is already open.</span>
<a href="#l172.88"></a><span id="l172.88">   assert_true(ExtensionSupport.registerWindowListener(</span>
<a href="#l172.89"></a><span id="l172.89">     &quot;test-addon3&quot;,</span>
<a href="#l172.90"></a><span id="l172.90">     {</span>
<a href="#l172.91"></a><span id="l172.91">       chromeURLs: [ &quot;chrome://messenger/content/messengercompose/messengercompose.xul&quot; ],</span>
<a href="#l172.92"></a><span id="l172.92" class="difflineminus">-      onLoadWindow: function() { addonListener(&quot;test-addon3&quot;, &quot;load&quot;);</span>
<a href="#l172.93"></a><span id="l172.93" class="difflineminus">-                                 ExtensionSupport.unregisterWindowListener(&quot;test-addon3&quot;); }</span>
<a href="#l172.94"></a><span id="l172.94" class="difflineplus">+      onLoadWindow() {</span>
<a href="#l172.95"></a><span id="l172.95" class="difflineplus">+        addonListener(&quot;test-addon3&quot;, &quot;load&quot;);</span>
<a href="#l172.96"></a><span id="l172.96" class="difflineplus">+        ExtensionSupport.unregisterWindowListener(&quot;test-addon3&quot;);</span>
<a href="#l172.97"></a><span id="l172.97" class="difflineplus">+      },</span>
<a href="#l172.98"></a><span id="l172.98">     })</span>
<a href="#l172.99"></a><span id="l172.99">   );</span>
<a href="#l172.100"></a><span id="l172.100"> </span>
<a href="#l172.101"></a><span id="l172.101">   assert_equals(addonCount(&quot;test-addon3&quot;, &quot;load&quot;), 1);</span>
<a href="#l172.102"></a><span id="l172.102"> </span>
<a href="#l172.103"></a><span id="l172.103">   // Extension listening to compose window while it is already open.</span>
<a href="#l172.104"></a><span id="l172.104">   assert_true(ExtensionSupport.registerWindowListener(</span>
<a href="#l172.105"></a><span id="l172.105">     &quot;test-addon4&quot;,</span>
<a href="#l172.106"></a><span id="l172.106">     {</span>
<a href="#l172.107"></a><span id="l172.107">       chromeURLs: [ &quot;chrome://messenger/content/messengercompose/messengercompose.xul&quot; ],</span>
<a href="#l172.108"></a><span id="l172.108" class="difflineminus">-      onLoadWindow: function() { addonListener(&quot;test-addon4&quot;, &quot;load&quot;); },</span>
<a href="#l172.109"></a><span id="l172.109" class="difflineminus">-      onUnloadWindow: function() { addonListener(&quot;test-addon4&quot;, &quot;unload&quot;);</span>
<a href="#l172.110"></a><span id="l172.110" class="difflineminus">-                                   ExtensionSupport.unregisterWindowListener(&quot;test-addon4&quot;); }</span>
<a href="#l172.111"></a><span id="l172.111" class="difflineplus">+      onLoadWindow() { addonListener(&quot;test-addon4&quot;, &quot;load&quot;); },</span>
<a href="#l172.112"></a><span id="l172.112" class="difflineplus">+      onUnloadWindow() {</span>
<a href="#l172.113"></a><span id="l172.113" class="difflineplus">+        addonListener(&quot;test-addon4&quot;, &quot;unload&quot;);</span>
<a href="#l172.114"></a><span id="l172.114" class="difflineplus">+        ExtensionSupport.unregisterWindowListener(&quot;test-addon4&quot;);</span>
<a href="#l172.115"></a><span id="l172.115" class="difflineplus">+      },</span>
<a href="#l172.116"></a><span id="l172.116">     })</span>
<a href="#l172.117"></a><span id="l172.117">   );</span>
<a href="#l172.118"></a><span id="l172.118"> </span>
<a href="#l172.119"></a><span id="l172.119">   assert_equals(addonCount(&quot;test-addon4&quot;, &quot;load&quot;), 1);</span>
<a href="#l172.120"></a><span id="l172.120"> </span>
<a href="#l172.121"></a><span id="l172.121">   close_compose_window(cwc);</span>
<a href="#l172.122"></a><span id="l172.122"> </span>
<a href="#l172.123"></a><span id="l172.123">   assert_equals(addonCount(&quot;test-addon1&quot;, &quot;unload&quot;), 1);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l173.1"></a><span id="l173.1" class="difflineminus">--- a/mail/test/mozmill/utils/test-iteratorUtils.js</span>
<a href="#l173.2"></a><span id="l173.2" class="difflineplus">+++ b/mail/test/mozmill/utils/test-iteratorUtils.js</span>
<a href="#l173.3"></a><span id="l173.3" class="difflineat">@@ -1,33 +1,34 @@</span>
<a href="#l173.4"></a><span id="l173.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l173.5"></a><span id="l173.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l173.6"></a><span id="l173.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l173.7"></a><span id="l173.7"> </span>
<a href="#l173.8"></a><span id="l173.8"> /**</span>
<a href="#l173.9"></a><span id="l173.9">  * Tests iteratorUtils with items pulled from content into chrome.</span>
<a href="#l173.10"></a><span id="l173.10">  */</span>
<a href="#l173.11"></a><span id="l173.11"> </span>
<a href="#l173.12"></a><span id="l173.12" class="difflineminus">-var MODULE_NAME = 'test-iteratorUtils';</span>
<a href="#l173.13"></a><span id="l173.13" class="difflineminus">-</span>
<a href="#l173.14"></a><span id="l173.14" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l173.15"></a><span id="l173.15" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l173.16"></a><span id="l173.16" class="difflineminus">-                         'content-tab-helpers',]</span>
<a href="#l173.17"></a><span id="l173.17" class="difflineplus">+/* import-globals-from ../shared-modules/test-content-tab-helpers.js */</span>
<a href="#l173.18"></a><span id="l173.18" class="difflineplus">+/* import-globals-from ../shared-modules/test-folder-display-helpers.js */</span>
<a href="#l173.19"></a><span id="l173.19"> </span>
<a href="#l173.20"></a><span id="l173.20" class="difflineminus">-var iteratorUtils = ChromeUtils.import('resource:///modules/iteratorUtils.jsm');</span>
<a href="#l173.21"></a><span id="l173.21" class="difflineplus">+var MODULE_NAME = &quot;test-iteratorUtils&quot;;</span>
<a href="#l173.22"></a><span id="l173.22" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l173.23"></a><span id="l173.23" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;content-tab-helpers&quot;];</span>
<a href="#l173.24"></a><span id="l173.24"> </span>
<a href="#l173.25"></a><span id="l173.25" class="difflineminus">-var kWhatsNewPref = 'mailnews.start_page.override_url';</span>
<a href="#l173.26"></a><span id="l173.26" class="difflineplus">+var iteratorUtils = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l173.27"></a><span id="l173.27"> </span>
<a href="#l173.28"></a><span id="l173.28" class="difflineminus">-var gUrl = collector.addHttpResource('../utils/html', '');</span>
<a href="#l173.29"></a><span id="l173.29" class="difflineplus">+var kWhatsNewPref = &quot;mailnews.start_page.override_url&quot;;</span>
<a href="#l173.30"></a><span id="l173.30" class="difflineplus">+</span>
<a href="#l173.31"></a><span id="l173.31" class="difflineplus">+var gUrl = collector.addHttpResource(&quot;../utils/html&quot;, &quot;&quot;);</span>
<a href="#l173.32"></a><span id="l173.32"> var gCollectionsUrl = gUrl + &quot;collections.html&quot;;</span>
<a href="#l173.33"></a><span id="l173.33"> var gOriginalWhatsNew, gTab;</span>
<a href="#l173.34"></a><span id="l173.34"> </span>
<a href="#l173.35"></a><span id="l173.35"> function setupModule(module) {</span>
<a href="#l173.36"></a><span id="l173.36" class="difflineminus">-  collector.getModule('folder-display-helpers').installInto(module);</span>
<a href="#l173.37"></a><span id="l173.37" class="difflineminus">-  collector.getModule('content-tab-helpers').installInto(module);</span>
<a href="#l173.38"></a><span id="l173.38" class="difflineplus">+  collector.getModule(&quot;folder-display-helpers&quot;).installInto(module);</span>
<a href="#l173.39"></a><span id="l173.39" class="difflineplus">+  collector.getModule(&quot;content-tab-helpers&quot;).installInto(module);</span>
<a href="#l173.40"></a><span id="l173.40"> </span>
<a href="#l173.41"></a><span id="l173.41">   gOriginalWhatsNew = Services.prefs.getCharPref(kWhatsNewPref);</span>
<a href="#l173.42"></a><span id="l173.42">   Services.prefs.setCharPref(kWhatsNewPref, gCollectionsUrl);</span>
<a href="#l173.43"></a><span id="l173.43"> }</span>
<a href="#l173.44"></a><span id="l173.44"> </span>
<a href="#l173.45"></a><span id="l173.45"> function teardownModule(module) {</span>
<a href="#l173.46"></a><span id="l173.46">   Services.prefs.setCharPref(kWhatsNewPref, gOriginalWhatsNew);</span>
<a href="#l173.47"></a><span id="l173.47"> }</span>
<a href="#l173.48"></a><span id="l173.48" class="difflineat">@@ -54,17 +55,16 @@ function test_toArray_builtin_content_it</span>
<a href="#l173.49"></a><span id="l173.49">   let iter = gTab.browser.contentWindow.wrappedJSObject.gIterator;</span>
<a href="#l173.50"></a><span id="l173.50">   let iterArray = iteratorUtils.toArray(iter);</span>
<a href="#l173.51"></a><span id="l173.51"> </span>
<a href="#l173.52"></a><span id="l173.52">   assert_equals(kExpected.length, iterArray.length);</span>
<a href="#l173.53"></a><span id="l173.53"> </span>
<a href="#l173.54"></a><span id="l173.54">   kExpected.forEach((val, i) =&gt; {</span>
<a href="#l173.55"></a><span id="l173.55">     assert_equals(val, iterArray[i]);</span>
<a href="#l173.56"></a><span id="l173.56">   });</span>
<a href="#l173.57"></a><span id="l173.57" class="difflineminus">-</span>
<a href="#l173.58"></a><span id="l173.58"> }</span>
<a href="#l173.59"></a><span id="l173.59"> </span>
<a href="#l173.60"></a><span id="l173.60"> /**</span>
<a href="#l173.61"></a><span id="l173.61">  * Tests that we can use iteratorUtils.toArray on a custom iterator created</span>
<a href="#l173.62"></a><span id="l173.62">  * and pulled in from content.</span>
<a href="#l173.63"></a><span id="l173.63">  */</span>
<a href="#l173.64"></a><span id="l173.64"> function test_toArray_custom_content_iterator() {</span>
<a href="#l173.65"></a><span id="l173.65">   // kExpected matches our expectations for the contents of gCustomIterator</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

