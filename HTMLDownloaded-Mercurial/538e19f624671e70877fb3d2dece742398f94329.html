<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 21848:538e19f624671e70877fb3d2dece742398f94329</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 538e19f624671e70877fb3d2dece742398f94329" />
<meta property="og:url" content="/comm-central/rev/538e19f624671e70877fb3d2dece742398f94329" />
<meta property="og:description" content="Bug 1322172 - SeaMonkey mail compose should stop being APP_TYPE_EDITOR. r=IanN" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 538e19f624671e70877fb3d2dece742398f94329 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/538e19f624671e70877fb3d2dece742398f94329">shortlog</a> |
<a href="/comm-central/log/538e19f624671e70877fb3d2dece742398f94329">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/538e19f624671e70877fb3d2dece742398f94329">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/538e19f624671e70877fb3d2dece742398f94329">files</a> |
changeset |
<a href="/comm-central/raw-rev/538e19f624671e70877fb3d2dece742398f94329">raw</a>  | <a href="/comm-central/archive/538e19f624671e70877fb3d2dece742398f94329.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1322172">Bug 1322172</a> - SeaMonkey mail compose should stop being APP_TYPE_EDITOR. r=IanN
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#70;&#114;&#97;&#110;&#107;&#45;&#82;&#97;&#105;&#110;&#101;&#114;&#32;&#71;&#114;&#97;&#104;&#108;&#32;&#60;&#102;&#114;&#103;&#114;&#97;&#104;&#108;&#64;&#103;&#109;&#120;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Sun, 30 Jul 2017 21:31:03 +0200</td></tr>

<tr>
 <td>changeset 21848</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/538e19f624671e70877fb3d2dece742398f94329">538e19f624671e70877fb3d2dece742398f94329</a></td>
</tr>



<tr>
<td>parent 21847</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/5dcb4353fcec7451997c1ccc1364cf27c001b71c">5dcb4353fcec7451997c1ccc1364cf27c001b71c</a>
</td>
</tr>

<tr>
<td>child 21849</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6a2729aebec1a43258690cb8aa199b6a92e2da4a">6a2729aebec1a43258690cb8aa199b6a92e2da4a</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=538e19f624671e70877fb3d2dece742398f94329">13341</a></td></tr>
<tr><td>push user</td><td>frgrahl@gmx.net</td></tr>
<tr><td>push date</td><td class="date age">Sun, 30 Jul 2017 19:32:16 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@19ffaeb8c4a0 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=19ffaeb8c4a027aae028f0dfafc160ed7a3b3c93">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=19ffaeb8c4a027aae028f0dfafc160ed7a3b3c93&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=19ffaeb8c4a027aae028f0dfafc160ed7a3b3c93&newProject=comm-central&newRevision=538e19f624671e70877fb3d2dece742398f94329&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=19ffaeb8c4a027aae028f0dfafc160ed7a3b3c93&newProject=comm-central&newRevision=538e19f624671e70877fb3d2dece742398f94329&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=19ffaeb8c4a027aae028f0dfafc160ed7a3b3c93&newProject=comm-central&newRevision=538e19f624671e70877fb3d2dece742398f94329&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28IanN%29&revcount=50">IanN</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1322172">1322172</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1322172">Bug 1322172</a> - SeaMonkey mail compose should stop being APP_TYPE_EDITOR. r=IanN</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/538e19f624671e70877fb3d2dece742398f94329/mailnews/compose/src/nsMsgCompose.cpp">mailnews/compose/src/nsMsgCompose.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/538e19f624671e70877fb3d2dece742398f94329/mailnews/compose/src/nsMsgCompose.cpp">file</a> |
<a href="/comm-central/annotate/538e19f624671e70877fb3d2dece742398f94329/mailnews/compose/src/nsMsgCompose.cpp">annotate</a> |
<a href="/comm-central/diff/538e19f624671e70877fb3d2dece742398f94329/mailnews/compose/src/nsMsgCompose.cpp">diff</a> |
<a href="/comm-central/comparison/538e19f624671e70877fb3d2dece742398f94329/mailnews/compose/src/nsMsgCompose.cpp">comparison</a> |
<a href="/comm-central/log/538e19f624671e70877fb3d2dece742398f94329/mailnews/compose/src/nsMsgCompose.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/538e19f624671e70877fb3d2dece742398f94329/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/538e19f624671e70877fb3d2dece742398f94329/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/538e19f624671e70877fb3d2dece742398f94329/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/538e19f624671e70877fb3d2dece742398f94329/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/538e19f624671e70877fb3d2dece742398f94329/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/538e19f624671e70877fb3d2dece742398f94329/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/538e19f624671e70877fb3d2dece742398f94329/suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties">suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/538e19f624671e70877fb3d2dece742398f94329/suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties">file</a> |
<a href="/comm-central/annotate/538e19f624671e70877fb3d2dece742398f94329/suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties">annotate</a> |
<a href="/comm-central/diff/538e19f624671e70877fb3d2dece742398f94329/suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties">diff</a> |
<a href="/comm-central/comparison/538e19f624671e70877fb3d2dece742398f94329/suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties">comparison</a> |
<a href="/comm-central/log/538e19f624671e70877fb3d2dece742398f94329/suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/EdColorPropsOverlay.xul">suite/mailnews/compose/EdColorPropsOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/EdColorPropsOverlay.xul">file</a> |
<a href="/comm-central/annotate/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/EdColorPropsOverlay.xul">annotate</a> |
<a href="/comm-central/diff/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/EdColorPropsOverlay.xul">diff</a> |
<a href="/comm-central/comparison/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/EdColorPropsOverlay.xul">comparison</a> |
<a href="/comm-central/log/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/EdColorPropsOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/MsgComposeCommands.js">suite/mailnews/compose/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/messengercompose.xul">suite/mailnews/compose/messengercompose.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/messengercompose.xul">file</a> |
<a href="/comm-central/annotate/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/messengercompose.xul">annotate</a> |
<a href="/comm-central/diff/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/messengercompose.xul">diff</a> |
<a href="/comm-central/comparison/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/messengercompose.xul">comparison</a> |
<a href="/comm-central/log/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/compose/messengercompose.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/jar.mn">suite/mailnews/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/jar.mn">file</a> |
<a href="/comm-central/annotate/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/jar.mn">annotate</a> |
<a href="/comm-central/diff/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/jar.mn">diff</a> |
<a href="/comm-central/comparison/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/jar.mn">comparison</a> |
<a href="/comm-central/log/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/mailWindow.js">suite/mailnews/mailWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/mailWindow.js">file</a> |
<a href="/comm-central/annotate/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/mailWindow.js">annotate</a> |
<a href="/comm-central/diff/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/mailWindow.js">diff</a> |
<a href="/comm-central/comparison/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/mailWindow.js">comparison</a> |
<a href="/comm-central/log/538e19f624671e70877fb3d2dece742398f94329/suite/mailnews/mailWindow.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgCompose.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1027,19 +1027,16 @@ nsMsgCompose::Initialize(nsIMsgComposePa</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">     nsCOMPtr&lt;nsIDocShellTreeItem&gt; treeItem =</span>
<a href="#l1.6"></a><span id="l1.6">       do_QueryInterface(window-&gt;GetDocShell());</span>
<a href="#l1.7"></a><span id="l1.7">     nsCOMPtr&lt;nsIDocShellTreeOwner&gt; treeOwner;</span>
<a href="#l1.8"></a><span id="l1.8">     rv = treeItem-&gt;GetTreeOwner(getter_AddRefs(treeOwner));</span>
<a href="#l1.9"></a><span id="l1.9">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">     m_baseWindow = do_QueryInterface(treeOwner);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-#ifdef MOZ_SUITE</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-    window-&gt;GetDocShell()-&gt;SetAppType(nsIDocShell::APP_TYPE_EDITOR);</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-#endif</span>
<a href="#l1.15"></a><span id="l1.15">   }</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17">   MSG_ComposeFormat format;</span>
<a href="#l1.18"></a><span id="l1.18">   aParams-&gt;GetFormat(&amp;format);</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20">   MSG_ComposeType type;</span>
<a href="#l1.21"></a><span id="l1.21">   aParams-&gt;GetType(&amp;type);</span>
<a href="#l1.22"></a><span id="l1.22"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -1437,26 +1437,16 @@ nsMsgComposeAndSend::GetEmbeddedObjectIn</span>
<a href="#l2.4"></a><span id="l2.4">   // specified or set to &quot;false&quot;.</span>
<a href="#l2.5"></a><span id="l2.5">   if (isData || isNews)</span>
<a href="#l2.6"></a><span id="l2.6">   {</span>
<a href="#l2.7"></a><span id="l2.7">     *acceptObject = mozDoNotSendAttr.IsEmpty() ||</span>
<a href="#l2.8"></a><span id="l2.8">       mozDoNotSendAttr.LowerCaseEqualsLiteral(&quot;false&quot;);</span>
<a href="#l2.9"></a><span id="l2.9">     return NS_OK;</span>
<a href="#l2.10"></a><span id="l2.10">   }</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-#ifdef MOZ_SUITE</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-  bool isFile =</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-    (NS_SUCCEEDED(attachment-&gt;m_url-&gt;SchemeIs(&quot;file&quot;, &amp;isFile)) &amp;&amp; isFile);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-  if (isFile)</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineminus">-  {</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineminus">-    *acceptObject = mozDoNotSendAttr.IsEmpty() ||</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-      mozDoNotSendAttr.LowerCaseEqualsLiteral(&quot;false&quot;);</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-    return NS_OK;</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineminus">-  }</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineminus">-#endif</span>
<a href="#l2.22"></a><span id="l2.22">   return NS_OK;</span>
<a href="#l2.23"></a><span id="l2.23"> }</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25"> </span>
<a href="#l2.26"></a><span id="l2.26"> uint32_t</span>
<a href="#l2.27"></a><span id="l2.27"> nsMsgComposeAndSend::GetMultipartRelatedCount(bool forceToBeCalculated /*=false*/)</span>
<a href="#l2.28"></a><span id="l2.28"> {</span>
<a href="#l2.29"></a><span id="l2.29">   nsresult                  rv = NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/suite/locales/en-US/chrome/mailnews/compose/composeMsgs.properties</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -262,8 +262,25 @@ buttonLabelRetry=Retry</span>
<a href="#l3.4"></a><span id="l3.4"> ## %3$S will be replaced with the local folders account name (typically &quot;Local Folders&quot;).</span>
<a href="#l3.5"></a><span id="l3.5"> promptToSaveTemplateLocally=Your template was not saved to your templates folder (%1$S) probably because of network errors.\n&quot;Retry&quot; attempts to save again.\n&quot;Save&quot; copies the message to %3$S/%1$S-%2$S and you can continue writing.\n&quot;Cancel&quot; allows you to continue writing without saving your template.</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> ## LOCALIZATION NOTE(saveToLocalFoldersFailed): Message appears after normal</span>
<a href="#l3.8"></a><span id="l3.8"> ## save fails (e.g., to Sent) and save to Local Folders also fails. This could</span>
<a href="#l3.9"></a><span id="l3.9"> ## occur if network is down and filesystem problems are present such as disk</span>
<a href="#l3.10"></a><span id="l3.10"> ## full, permission issues or hardware failure.</span>
<a href="#l3.11"></a><span id="l3.11"> saveToLocalFoldersFailed=Unable to save your message to local folders. Possibly out of file storage space.</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+## LOCALIZATION NOTE(blockedAllowResource): %S is the URL to load.</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+blockedAllowResource=Unblock %S</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+## LOCALIZATION NOTE (blockedContentMessage): Semi-colon list of plural forms.</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+## See: http://developer.mozilla.org/en/docs/Localization_and_Plurals</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+## %S will be replaced by brandShortName.</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+## Files must be unblocked individually, therefore the plural form reads:</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+## Unblocking a file (one of several) will include it (that one file) in your sent message.</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+## In other words:</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+## Unblocking one/several file(s) will include it/them in your message.</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+blockedContentMessage=%S has blocked a file from loading into this message. Unblocking the file will include it in your sent message.;%S has blocked some files from loading into this message. Unblocking a file will include it in your sent message.</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+## LOCALIZATION NOTE (blockedContentPrefLabel, blockedContentPrefAccesskey):</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+## Same content as (blockedContentPrefLabel, blockedContentPrefAccesskey)</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+## in mail directory. SeaMonkey does only use Options and not Preferences.</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+blockedContentPrefLabel=Options</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+blockedContentPrefAccesskey=O</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">new file mode 100644</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineminus">--- /dev/null</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineplus">+++ b/suite/mailnews/compose/EdColorPropsOverlay.xul</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineat">@@ -0,0 +1,48 @@</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l4.6"></a><span id="l4.6" class="difflineplus">+&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.7"></a><span id="l4.7" class="difflineplus">+   - License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.8"></a><span id="l4.8" class="difflineplus">+   - file, You can obtain one at http://mozilla.org/MPL/2.0/. --&gt;</span>
<a href="#l4.9"></a><span id="l4.9" class="difflineplus">+</span>
<a href="#l4.10"></a><span id="l4.10" class="difflineplus">+&lt;!DOCTYPE window SYSTEM &quot;chrome://messenger/locale/messengercompose/mailComposeEditorOverlay.dtd&quot; &gt;</span>
<a href="#l4.11"></a><span id="l4.11" class="difflineplus">+</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+&lt;overlay id=&quot;mailEdColorPropsOverlay&quot;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;&gt;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+  &lt;script type=&quot;application/javascript&quot;&gt;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+  &lt;![CDATA[</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineplus">+  function onAccept() {</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+    // If it's a file, convert to a data URL.</span>
<a href="#l4.19"></a><span id="l4.19" class="difflineplus">+    if (gBackgroundImage &amp;&amp; /^file:/i.test(gBackgroundImage)) {</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineplus">+      let nsFile = Services.io.newURI(gBackgroundImage)</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+                              .QueryInterface(Components.interfaces.nsIFileURL)</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+                              .file;</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+      if (nsFile.exists()) {</span>
<a href="#l4.24"></a><span id="l4.24" class="difflineplus">+        let reader = new FileReader();</span>
<a href="#l4.25"></a><span id="l4.25" class="difflineplus">+        reader.addEventListener(&quot;load&quot;, function() {</span>
<a href="#l4.26"></a><span id="l4.26" class="difflineplus">+          gBackgroundImage = reader.result;</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+          gDialog.BackgroundImageInput.value = reader.result;</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+          if (onAccept()) {</span>
<a href="#l4.29"></a><span id="l4.29" class="difflineplus">+            window.close();</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineplus">+          }</span>
<a href="#l4.31"></a><span id="l4.31" class="difflineplus">+        });</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineplus">+        File.createFromNsIFile(nsFile).then(file =&gt; {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+          reader.readAsDataURL(file);</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+        });</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+        return false; // Don't close just yet...</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+      }</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+    }</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+    if (ValidateData()) {</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+      // Copy attributes to element we are changing</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineplus">+      try {</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineplus">+        GetCurrentEditor().cloneAttributes(gBodyElement, globalElement);</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+      } catch (e) {}</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+      SaveWindowLocation();</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+      return true; // do close the window</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+    }</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+    return false;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineplus">+  }</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+  ]]&gt;</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+  &lt;/script&gt;</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+</span>
<a href="#l4.52"></a><span id="l4.52" class="difflineplus">+&lt;/overlay&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/suite/mailnews/compose/MsgComposeCommands.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/suite/mailnews/compose/MsgComposeCommands.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -1,14 +1,18 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l5.5"></a><span id="l5.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l5.6"></a><span id="l5.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l5.7"></a><span id="l5.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l5.8"></a><span id="l5.8"> </span>
<a href="#l5.9"></a><span id="l5.9"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/PluralForm.jsm&quot;);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/InlineSpellChecker.jsm&quot;);</span>
<a href="#l5.14"></a><span id="l5.14"> Components.utils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l5.15"></a><span id="l5.15"> Components.utils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l5.16"></a><span id="l5.16"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l5.17"></a><span id="l5.17"> </span>
<a href="#l5.18"></a><span id="l5.18"> /**</span>
<a href="#l5.19"></a><span id="l5.19">  * interfaces</span>
<a href="#l5.20"></a><span id="l5.20">  */</span>
<a href="#l5.21"></a><span id="l5.21"> var nsIMsgCompDeliverMode = Components.interfaces.nsIMsgCompDeliverMode;</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineat">@@ -45,16 +49,17 @@ var msgWindow = Components.classes[&quot;@moz</span>
<a href="#l5.23"></a><span id="l5.23"> var gMessenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l5.24"></a><span id="l5.24">                            .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26"> /**</span>
<a href="#l5.27"></a><span id="l5.27">  * Global variables, need to be re-initialized every time mostly because we need to release them when the window close</span>
<a href="#l5.28"></a><span id="l5.28">  */</span>
<a href="#l5.29"></a><span id="l5.29"> var gHideMenus;</span>
<a href="#l5.30"></a><span id="l5.30"> var gMsgCompose;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+var gOriginalMsgURI;</span>
<a href="#l5.32"></a><span id="l5.32"> var gAccountManager;</span>
<a href="#l5.33"></a><span id="l5.33"> var gWindowLocked;</span>
<a href="#l5.34"></a><span id="l5.34"> var gContentChanged;</span>
<a href="#l5.35"></a><span id="l5.35"> var gAutoSaving;</span>
<a href="#l5.36"></a><span id="l5.36"> var gCurrentIdentity;</span>
<a href="#l5.37"></a><span id="l5.37"> var defaultSaveOperation;</span>
<a href="#l5.38"></a><span id="l5.38"> var gSendOrSaveOperationInProgress;</span>
<a href="#l5.39"></a><span id="l5.39"> var gCloseWindowAfterSave;</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineat">@@ -87,16 +92,17 @@ var gEditingDraft;</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42"> var kComposeAttachDirPrefName = &quot;mail.compose.attach.dir&quot;;</span>
<a href="#l5.43"></a><span id="l5.43"> </span>
<a href="#l5.44"></a><span id="l5.44"> function InitializeGlobalVariables()</span>
<a href="#l5.45"></a><span id="l5.45"> {</span>
<a href="#l5.46"></a><span id="l5.46">   gAccountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l5.47"></a><span id="l5.47"> </span>
<a href="#l5.48"></a><span id="l5.48">   gMsgCompose = null;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+  gOriginalMsgURI = null;</span>
<a href="#l5.50"></a><span id="l5.50">   gWindowLocked = false;</span>
<a href="#l5.51"></a><span id="l5.51">   gContentChanged = false;</span>
<a href="#l5.52"></a><span id="l5.52">   gCurrentIdentity = null;</span>
<a href="#l5.53"></a><span id="l5.53">   defaultSaveOperation = &quot;draft&quot;;</span>
<a href="#l5.54"></a><span id="l5.54">   gSendOrSaveOperationInProgress = false;</span>
<a href="#l5.55"></a><span id="l5.55">   gAutoSaving = false;</span>
<a href="#l5.56"></a><span id="l5.56">   gCloseWindowAfterSave = false;</span>
<a href="#l5.57"></a><span id="l5.57">   gSavedSendNowKey = null;</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineat">@@ -118,16 +124,17 @@ function InitializeGlobalVariables()</span>
<a href="#l5.59"></a><span id="l5.59"> InitializeGlobalVariables();</span>
<a href="#l5.60"></a><span id="l5.60"> </span>
<a href="#l5.61"></a><span id="l5.61"> function ReleaseGlobalVariables()</span>
<a href="#l5.62"></a><span id="l5.62"> {</span>
<a href="#l5.63"></a><span id="l5.63">   gAccountManager = null;</span>
<a href="#l5.64"></a><span id="l5.64">   gCurrentIdentity = null;</span>
<a href="#l5.65"></a><span id="l5.65">   gCharsetConvertManager = null;</span>
<a href="#l5.66"></a><span id="l5.66">   gMsgCompose = null;</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+  gOriginalMsgURI = null;</span>
<a href="#l5.68"></a><span id="l5.68">   gMailSession = null;</span>
<a href="#l5.69"></a><span id="l5.69"> }</span>
<a href="#l5.70"></a><span id="l5.70"> </span>
<a href="#l5.71"></a><span id="l5.71"> function disableEditableFields()</span>
<a href="#l5.72"></a><span id="l5.72"> {</span>
<a href="#l5.73"></a><span id="l5.73">   gMsgCompose.editor.flags |= nsIPlaintextEditorMail.eEditorReadonlyMask;</span>
<a href="#l5.74"></a><span id="l5.74">   var disableElements = document.getElementsByAttribute(&quot;disableonsend&quot;, &quot;true&quot;);</span>
<a href="#l5.75"></a><span id="l5.75">   for (let i = 0; i &lt; disableElements.length; i++)</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineat">@@ -982,16 +989,147 @@ function handleMailtoArgs(mailtoUrl)</span>
<a href="#l5.77"></a><span id="l5.77">     var uri = Services.io.newURI(mailtoUrl);</span>
<a href="#l5.78"></a><span id="l5.78"> </span>
<a href="#l5.79"></a><span id="l5.79">     if (uri)</span>
<a href="#l5.80"></a><span id="l5.80">       return sMsgComposeService.getParamsForMailto(uri);</span>
<a href="#l5.81"></a><span id="l5.81">   }</span>
<a href="#l5.82"></a><span id="l5.82"> </span>
<a href="#l5.83"></a><span id="l5.83">   return null;</span>
<a href="#l5.84"></a><span id="l5.84"> }</span>
<a href="#l5.85"></a><span id="l5.85" class="difflineplus">+/**</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineplus">+ * Handle ESC keypress from composition window for</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+ * notifications with close button in the</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+ * attachmentNotificationBox.</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+ */</span>
<a href="#l5.90"></a><span id="l5.90" class="difflineplus">+function handleEsc()</span>
<a href="#l5.91"></a><span id="l5.91" class="difflineplus">+{</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineplus">+  let activeElement = document.activeElement;</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineplus">+</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+  // If findbar is visible and the focus is in the message body,</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+  // hide it. (Focus on the findbar is handled by findbar itself).</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineplus">+  let findbar = document.getElementById(&quot;FindToolbar&quot;);</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineplus">+  if (findbar &amp;&amp; !findbar.hidden &amp;&amp; activeElement.id == &quot;content-frame&quot;) {</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineplus">+    findbar.close();</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+    return;</span>
<a href="#l5.100"></a><span id="l5.100" class="difflineplus">+  }</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineplus">+  // If there is a notification in the attachmentNotificationBox</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+  // AND focus is in message body, subject field or on the notification,</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+  // hide it.</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+  let notification = document.getElementById(&quot;attachmentNotificationBox&quot;)</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+                             .currentNotification;</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+  if (notification &amp;&amp; (activeElement.id == &quot;content-frame&quot; ||</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineplus">+      activeElement.parentNode.parentNode.id == &quot;msgSubject&quot; ||</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+      notification.contains(activeElement) ||</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineplus">+      activeElement.classList.contains(&quot;messageCloseButton&quot;))) {</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineplus">+    notification.close();</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+  }</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+}</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+/**</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineplus">+ * On paste or drop, we may want to modify the content before inserting it into</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineplus">+ * the editor, replacing file URLs with data URLs when appropriate.</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineplus">+ */</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+function onPasteOrDrop(e) {</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+  // For paste use e.clipboardData, for drop use e.dataTransfer.</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+  let dataTransfer = (&quot;clipboardData&quot; in e) ? e.clipboardData : e.dataTransfer;</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineplus">+  if (!dataTransfer.types.includes(&quot;text/html&quot;)) {</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineplus">+    return;</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+  }</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineplus">+  if (!gMsgCompose.composeHTML) {</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+    // We're in the plain text editor. Nothing to do here.</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+    return;</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+  }</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineplus">+</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+  let html = dataTransfer.getData(&quot;text/html&quot;);</span>
<a href="#l5.133"></a><span id="l5.133" class="difflineplus">+  let doc = (new DOMParser()).parseFromString(html, &quot;text/html&quot;);</span>
<a href="#l5.134"></a><span id="l5.134" class="difflineplus">+  let tmpD = Services.dirsvc.get(&quot;TmpD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineplus">+  let pendingConversions = 0;</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineplus">+  let needToPreventDefault = true;</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+  for (let img of doc.images) {</span>
<a href="#l5.138"></a><span id="l5.138" class="difflineplus">+    if (!/^file:/i.test(img.src)) {</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineplus">+      // Doesn't start with file:. Nothing to do here.</span>
<a href="#l5.140"></a><span id="l5.140" class="difflineplus">+      continue;</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineplus">+    }</span>
<a href="#l5.142"></a><span id="l5.142" class="difflineplus">+</span>
<a href="#l5.143"></a><span id="l5.143" class="difflineplus">+    // This may throw if the URL is invalid for the OS.</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineplus">+    let nsFile;</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+    try {</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+      nsFile = Services.io.getProtocolHandler(&quot;file&quot;)</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+                 .QueryInterface(Components.interfaces.nsIFileProtocolHandler)</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+                 .getFileFromURLSpec(img.src);</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+    } catch (ex) {</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineplus">+      continue;</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+    }</span>
<a href="#l5.152"></a><span id="l5.152" class="difflineplus">+</span>
<a href="#l5.153"></a><span id="l5.153" class="difflineplus">+    if (!nsFile.exists()) {</span>
<a href="#l5.154"></a><span id="l5.154" class="difflineplus">+      continue;</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineplus">+    }</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineplus">+</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineplus">+    if (!tmpD.contains(nsFile)) {</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+       // Not anywhere under the temp dir.</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+      continue;</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+    }</span>
<a href="#l5.161"></a><span id="l5.161" class="difflineplus">+</span>
<a href="#l5.162"></a><span id="l5.162" class="difflineplus">+    let contentType = Components.classes[&quot;@mozilla.org/mime;1&quot;]</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineplus">+                        .getService(Components.interfaces.nsIMIMEService)</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineplus">+                        .getTypeFromFile(nsFile);</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineplus">+    if (!contentType.startsWith(&quot;image/&quot;)) {</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineplus">+      continue;</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineplus">+    }</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineplus">+</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineplus">+    // If we ever get here, we need to prevent the default paste or drop since</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineplus">+    // the code below will do its own insertion.</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineplus">+    if (needToPreventDefault) {</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+      e.preventDefault();</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+      needToPreventDefault = false;</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+    }</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+    File.createFromNsIFile(nsFile).then(function(file) {</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+      if (file.lastModified &lt; (Date.now() - 60000)) {</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineplus">+        // Not put in temp in the last minute. May be something other than</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+        // a copy-paste. Let's not allow that.</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+        return;</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+      }</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+      let doTheInsert = function() {</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+        // Now run it through sanitation to make sure there wasn't any</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+        // unwanted things in the content.</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+        let ParserUtils = Components.classes[&quot;@mozilla.org/parserutils;1&quot;]</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+                            .getService(Components.interfaces.nsIParserUtils);</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+        let html2 = ParserUtils.sanitize(doc.documentElement.innerHTML,</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+                                         ParserUtils.SanitizerAllowStyle);</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+        getBrowser().contentDocument.execCommand(&quot;insertHTML&quot;, false, html2);</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+      }</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+      // Everything checks out. Convert file to data URL.</span>
<a href="#l5.194"></a><span id="l5.194" class="difflineplus">+      let reader = new FileReader();</span>
<a href="#l5.195"></a><span id="l5.195" class="difflineplus">+      reader.addEventListener(&quot;load&quot;, function() {</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineplus">+        let dataURL = reader.result;</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineplus">+        pendingConversions--;</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineplus">+        img.src = dataURL;</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineplus">+        if (pendingConversions == 0) {</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+          doTheInsert();</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineplus">+        }</span>
<a href="#l5.202"></a><span id="l5.202" class="difflineplus">+      });</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineplus">+</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+      reader.addEventListener(&quot;error&quot;, function() {</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+        pendingConversions--;</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+        if (pendingConversions == 0) {</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineplus">+          doTheInsert();</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+        }</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineplus">+      });</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineplus">+</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineplus">+      pendingConversions++;</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+      reader.readAsDataURL(file);</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineplus">+    });</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineplus">+  }</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineplus">+}</span>
<a href="#l5.216"></a><span id="l5.216"> </span>
<a href="#l5.217"></a><span id="l5.217"> function ComposeStartup(aParams)</span>
<a href="#l5.218"></a><span id="l5.218"> {</span>
<a href="#l5.219"></a><span id="l5.219">   var params = null; // New way to pass parameters to the compose window as a nsIMsgComposeParameters object</span>
<a href="#l5.220"></a><span id="l5.220">   var args = null;   // old way, parameters are passed as a string</span>
<a href="#l5.221"></a><span id="l5.221"> </span>
<a href="#l5.222"></a><span id="l5.222">   if (aParams)</span>
<a href="#l5.223"></a><span id="l5.223">     params = aParams;</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineat">@@ -1013,16 +1151,19 @@ function ComposeStartup(aParams)</span>
<a href="#l5.225"></a><span id="l5.225">   }</span>
<a href="#l5.226"></a><span id="l5.226"> </span>
<a href="#l5.227"></a><span id="l5.227">   // Set the document language to the preference as early as possible.</span>
<a href="#l5.228"></a><span id="l5.228">   document.documentElement</span>
<a href="#l5.229"></a><span id="l5.229">           .setAttribute(&quot;lang&quot;, getPref(&quot;spellchecker.dictionary&quot;));</span>
<a href="#l5.230"></a><span id="l5.230"> </span>
<a href="#l5.231"></a><span id="l5.231">   var identityList = GetMsgIdentityElement();</span>
<a href="#l5.232"></a><span id="l5.232"> </span>
<a href="#l5.233"></a><span id="l5.233" class="difflineplus">+  document.addEventListener(&quot;paste&quot;, onPasteOrDrop, false);</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+  document.addEventListener(&quot;drop&quot;, onPasteOrDrop, false);</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+</span>
<a href="#l5.236"></a><span id="l5.236">   if (identityList)</span>
<a href="#l5.237"></a><span id="l5.237">     FillIdentityList(identityList);</span>
<a href="#l5.238"></a><span id="l5.238"> </span>
<a href="#l5.239"></a><span id="l5.239">   if (!params) {</span>
<a href="#l5.240"></a><span id="l5.240">     // This code will go away soon as now arguments are passed to the window using a object of type nsMsgComposeParams instead of a string</span>
<a href="#l5.241"></a><span id="l5.241"> </span>
<a href="#l5.242"></a><span id="l5.242">     params = Components.classes[&quot;@mozilla.org/messengercompose/composeparams;1&quot;].createInstance(Components.interfaces.nsIMsgComposeParams);</span>
<a href="#l5.243"></a><span id="l5.243">     params.composeFields = Components.classes[&quot;@mozilla.org/messengercompose/composefields;1&quot;].createInstance(Components.interfaces.nsIMsgCompFields);</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineat">@@ -1106,16 +1247,23 @@ function ComposeStartup(aParams)</span>
<a href="#l5.245"></a><span id="l5.245">     identityList.getElementsByAttribute(&quot;identitykey&quot;, params.identity.key)[0];</span>
<a href="#l5.246"></a><span id="l5.246">   if (params.composeFields.from)</span>
<a href="#l5.247"></a><span id="l5.247">     identityList.value = MailServices.headerParser.parseDecodedHeader(params.composeFields.from)[0].toString();</span>
<a href="#l5.248"></a><span id="l5.248">   LoadIdentity(true);</span>
<a href="#l5.249"></a><span id="l5.249">   if (sMsgComposeService)</span>
<a href="#l5.250"></a><span id="l5.250">   {</span>
<a href="#l5.251"></a><span id="l5.251">     // Get the &lt;editor&gt; element to startup an editor</span>
<a href="#l5.252"></a><span id="l5.252">     var editorElement = GetCurrentEditorElement();</span>
<a href="#l5.253"></a><span id="l5.253" class="difflineplus">+</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineplus">+    // Remember the original message URI. When editing a draft which is a reply</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+    // or forwarded message, this gets overwritten by the ancestor's message URI so</span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+    // the disposition flags (&quot;replied&quot; or &quot;forwarded&quot;) can be set on the ancestor.</span>
<a href="#l5.257"></a><span id="l5.257" class="difflineplus">+    // For our purposes we need the URI of the message being processed, not its</span>
<a href="#l5.258"></a><span id="l5.258" class="difflineplus">+    // original ancestor.</span>
<a href="#l5.259"></a><span id="l5.259" class="difflineplus">+    gOriginalMsgURI = params.originalMsgURI;</span>
<a href="#l5.260"></a><span id="l5.260">     gMsgCompose = sMsgComposeService.initCompose(params, window,</span>
<a href="#l5.261"></a><span id="l5.261">                                                  editorElement.docShell);</span>
<a href="#l5.262"></a><span id="l5.262">     if (gMsgCompose)</span>
<a href="#l5.263"></a><span id="l5.263">     {</span>
<a href="#l5.264"></a><span id="l5.264">       if (!editorElement)</span>
<a href="#l5.265"></a><span id="l5.265">       {</span>
<a href="#l5.266"></a><span id="l5.266">         dump(&quot;Failed to get editor element!\n&quot;);</span>
<a href="#l5.267"></a><span id="l5.267">         return;</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineat">@@ -3144,16 +3292,98 @@ function InitEditor(editor)</span>
<a href="#l5.269"></a><span id="l5.269">   gMsgCompose.initEditor(editor, window.content);</span>
<a href="#l5.270"></a><span id="l5.270">   InlineSpellCheckerUI.init(editor);</span>
<a href="#l5.271"></a><span id="l5.271">   EnableInlineSpellCheck(getPref(&quot;mail.spellcheck.inline&quot;));</span>
<a href="#l5.272"></a><span id="l5.272">   document.getElementById(&quot;menu_inlineSpellCheck&quot;).setAttribute(&quot;disabled&quot;, !InlineSpellCheckerUI.canSpellCheck);</span>
<a href="#l5.273"></a><span id="l5.273"> </span>
<a href="#l5.274"></a><span id="l5.274">   // Listen for spellchecker changes, set the document language to the</span>
<a href="#l5.275"></a><span id="l5.275">   // dictionary picked by the user via the right-click menu in the editor.</span>
<a href="#l5.276"></a><span id="l5.276">   document.addEventListener(&quot;spellcheck-changed&quot;, updateDocumentLanguage);</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+  // XXX: the error event fires twice for each load. Why??</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+  editor.document.body.addEventListener(&quot;error&quot;, function(event) {</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+    if (event.target.localName != &quot;img&quot;) {</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+      return;</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+    }</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+    if (event.target.getAttribute(&quot;moz-do-not-send&quot;) == &quot;true&quot;) {</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+      return;</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineplus">+    }</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+    let src = event.target.src;</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+    if (!src) {</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+      return;</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineplus">+    }</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineplus">+</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineplus">+    if (!/^file:/i.test(src)) {</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineplus">+      // Check if this is a protocol that can fetch parts.</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+      let protocol = src.substr(0, src.indexOf(&quot;:&quot;)).toLowerCase();</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineplus">+      if (!(Services.io.getProtocolHandler(protocol) instanceof</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+            Components.interfaces.nsIMsgMessageFetchPartService)) {</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+        // Can't fetch parts, don't try to load.</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+        return;</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineplus">+      }</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+    }</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+</span>
<a href="#l5.304"></a><span id="l5.304" class="difflineplus">+    if (event.target.classList.contains(&quot;loading-internal&quot;)) {</span>
<a href="#l5.305"></a><span id="l5.305" class="difflineplus">+      // We're already loading this, or tried so unsuccesfully.</span>
<a href="#l5.306"></a><span id="l5.306" class="difflineplus">+      return;</span>
<a href="#l5.307"></a><span id="l5.307" class="difflineplus">+    }</span>
<a href="#l5.308"></a><span id="l5.308" class="difflineplus">+</span>
<a href="#l5.309"></a><span id="l5.309" class="difflineplus">+    if (gOriginalMsgURI) {</span>
<a href="#l5.310"></a><span id="l5.310" class="difflineplus">+      let msgSvc = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l5.311"></a><span id="l5.311" class="difflineplus">+                     .createInstance(Components.interfaces.nsIMessenger)</span>
<a href="#l5.312"></a><span id="l5.312" class="difflineplus">+                     .messageServiceFromURI(gOriginalMsgURI);</span>
<a href="#l5.313"></a><span id="l5.313" class="difflineplus">+      let originalMsgNeckoURI = {};</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineplus">+      msgSvc.GetUrlForUri(gOriginalMsgURI, originalMsgNeckoURI, null);</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineplus">+</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineplus">+      if (src.startsWith(originalMsgNeckoURI.value.spec)) {</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineplus">+        // Reply/Forward/Edit Draft/Edit as New can contain references to</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineplus">+        // images in the original message. Load those and make them data: URLs</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineplus">+        // now.</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+        event.target.classList.add(&quot;loading-internal&quot;);</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineplus">+        try {</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+          loadBlockedImage(src);</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineplus">+        } catch (e) {</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineplus">+          // Couldn't load the referenced image.</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineplus">+          Components.utils.reportError(e);</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineplus">+        }</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineplus">+      }</span>
<a href="#l5.328"></a><span id="l5.328" class="difflineplus">+      else {</span>
<a href="#l5.329"></a><span id="l5.329" class="difflineplus">+        // Appears to reference a random message. Notify and keep blocking.</span>
<a href="#l5.330"></a><span id="l5.330" class="difflineplus">+        gComposeNotificationBar.setBlockedContent(src);</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineplus">+      }</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineplus">+    }</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+    else {</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineplus">+      // For file:, and references to parts of random messages, show the</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineplus">+      // blocked content notification.</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineplus">+      gComposeNotificationBar.setBlockedContent(src);</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineplus">+    }</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineplus">+  }, true);</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+  // Convert mailnews URL back to data: URL.</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineplus">+  let background = editor.document.body.background;</span>
<a href="#l5.342"></a><span id="l5.342" class="difflineplus">+  if (background &amp;&amp; gOriginalMsgURI) {</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineplus">+    // Check that background has the same URL as the message itself.</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineplus">+    let msgSvc = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineplus">+                   .createInstance(Components.interfaces.nsIMessenger)</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+                   .messageServiceFromURI(gOriginalMsgURI);</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineplus">+    let originalMsgNeckoURI = {};</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+    msgSvc.GetUrlForUri(gOriginalMsgURI, originalMsgNeckoURI, null);</span>
<a href="#l5.349"></a><span id="l5.349" class="difflineplus">+</span>
<a href="#l5.350"></a><span id="l5.350" class="difflineplus">+    if (background.startsWith(originalMsgNeckoURI.value.spec)) {</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineplus">+      try {</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineplus">+        editor.document.body.background = loadBlockedImage(background, true);</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+      } catch (e) {</span>
<a href="#l5.354"></a><span id="l5.354" class="difflineplus">+        // Couldn't load the referenced image.</span>
<a href="#l5.355"></a><span id="l5.355" class="difflineplus">+        Components.utils.reportError(e);</span>
<a href="#l5.356"></a><span id="l5.356" class="difflineplus">+      }</span>
<a href="#l5.357"></a><span id="l5.357" class="difflineplus">+    }</span>
<a href="#l5.358"></a><span id="l5.358" class="difflineplus">+  }</span>
<a href="#l5.359"></a><span id="l5.359"> }</span>
<a href="#l5.360"></a><span id="l5.360"> </span>
<a href="#l5.361"></a><span id="l5.361"> /**</span>
<a href="#l5.362"></a><span id="l5.362">  * The event listener for the &quot;spellcheck-changed&quot; event updates</span>
<a href="#l5.363"></a><span id="l5.363">  * the document language.</span>
<a href="#l5.364"></a><span id="l5.364">  */</span>
<a href="#l5.365"></a><span id="l5.365"> function updateDocumentLanguage(event)</span>
<a href="#l5.366"></a><span id="l5.366"> {</span>
<a href="#l5.367"></a><span id="l5.367" class="difflineat">@@ -3210,8 +3440,203 @@ function getPref(aPrefName, aIsComplex)</span>
<a href="#l5.368"></a><span id="l5.368">     case Components.interfaces.nsIPrefBranch.PREF_INT:</span>
<a href="#l5.369"></a><span id="l5.369">       return Services.prefs.getIntPref(aPrefName);</span>
<a href="#l5.370"></a><span id="l5.370">     case Components.interfaces.nsIPrefBranch.PREF_STRING:</span>
<a href="#l5.371"></a><span id="l5.371">       return Services.prefs.getCharPref(aPrefName);</span>
<a href="#l5.372"></a><span id="l5.372">     default: // includes nsIPrefBranch.PREF_INVALID</span>
<a href="#l5.373"></a><span id="l5.373">       return null;</span>
<a href="#l5.374"></a><span id="l5.374">   }</span>
<a href="#l5.375"></a><span id="l5.375"> }</span>
<a href="#l5.376"></a><span id="l5.376" class="difflineplus">+</span>
<a href="#l5.377"></a><span id="l5.377" class="difflineplus">+/**</span>
<a href="#l5.378"></a><span id="l5.378" class="difflineplus">+ * Object to handle message related notifications that are showing in a</span>
<a href="#l5.379"></a><span id="l5.379" class="difflineplus">+ * notificationbox below the composed message content.</span>
<a href="#l5.380"></a><span id="l5.380" class="difflineplus">+ */</span>
<a href="#l5.381"></a><span id="l5.381" class="difflineplus">+var gComposeNotificationBar = {</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineplus">+</span>
<a href="#l5.383"></a><span id="l5.383" class="difflineplus">+  get notificationBar() {</span>
<a href="#l5.384"></a><span id="l5.384" class="difflineplus">+    delete this.notificationBar;</span>
<a href="#l5.385"></a><span id="l5.385" class="difflineplus">+    return this.notificationBar = document.getElementById(&quot;attachmentNotificationBox&quot;);</span>
<a href="#l5.386"></a><span id="l5.386" class="difflineplus">+  },</span>
<a href="#l5.387"></a><span id="l5.387" class="difflineplus">+</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineplus">+  setBlockedContent: function(aBlockedURI) {</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+    let brandName = sBrandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineplus">+    let buttonLabel = sComposeMsgsBundle.getString(&quot;blockedContentPrefLabel&quot;);</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineplus">+    let buttonAccesskey = sComposeMsgsBundle.getString(&quot;blockedContentPrefAccesskey&quot;);</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineplus">+</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+    let buttons = [{</span>
<a href="#l5.394"></a><span id="l5.394" class="difflineplus">+      label: buttonLabel,</span>
<a href="#l5.395"></a><span id="l5.395" class="difflineplus">+      accessKey: buttonAccesskey,</span>
<a href="#l5.396"></a><span id="l5.396" class="difflineplus">+      popup: &quot;blockedContentOptions&quot;,</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineplus">+      callback: function(aNotification, aButton) {</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineplus">+        return true; // keep notification open</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+      }</span>
<a href="#l5.400"></a><span id="l5.400" class="difflineplus">+    }];</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineplus">+</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineplus">+    // The popup value is a space separated list of all the blocked urls.</span>
<a href="#l5.403"></a><span id="l5.403" class="difflineplus">+    let popup = document.getElementById(&quot;blockedContentOptions&quot;);</span>
<a href="#l5.404"></a><span id="l5.404" class="difflineplus">+    let urls = popup.value ? popup.value.split(&quot; &quot;) : [];</span>
<a href="#l5.405"></a><span id="l5.405" class="difflineplus">+    if (!urls.includes(aBlockedURI)) {</span>
<a href="#l5.406"></a><span id="l5.406" class="difflineplus">+      urls.push(aBlockedURI);</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineplus">+    }</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineplus">+    popup.value = urls.join(&quot; &quot;);</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineplus">+</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineplus">+    let msg = sComposeMsgsBundle.getFormattedString(&quot;blockedContentMessage&quot;,</span>
<a href="#l5.411"></a><span id="l5.411" class="difflineplus">+                                                    [brandName, brandName]);</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineplus">+    msg = PluralForm.get(urls.length, msg);</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineplus">+</span>
<a href="#l5.414"></a><span id="l5.414" class="difflineplus">+    if (!this.isShowingBlockedContentNotification()) {</span>
<a href="#l5.415"></a><span id="l5.415" class="difflineplus">+      this.notificationBar</span>
<a href="#l5.416"></a><span id="l5.416" class="difflineplus">+          .appendNotification(msg, &quot;blockedContent&quot;, null,</span>
<a href="#l5.417"></a><span id="l5.417" class="difflineplus">+                              this.notificationBar.PRIORITY_WARNING_MEDIUM,</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineplus">+                              buttons);</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineplus">+    }</span>
<a href="#l5.420"></a><span id="l5.420" class="difflineplus">+    else {</span>
<a href="#l5.421"></a><span id="l5.421" class="difflineplus">+      this.notificationBar.getNotificationWithValue(&quot;blockedContent&quot;)</span>
<a href="#l5.422"></a><span id="l5.422" class="difflineplus">+                          .setAttribute(&quot;label&quot;, msg);</span>
<a href="#l5.423"></a><span id="l5.423" class="difflineplus">+    }</span>
<a href="#l5.424"></a><span id="l5.424" class="difflineplus">+  },</span>
<a href="#l5.425"></a><span id="l5.425" class="difflineplus">+</span>
<a href="#l5.426"></a><span id="l5.426" class="difflineplus">+  isShowingBlockedContentNotification: function() {</span>
<a href="#l5.427"></a><span id="l5.427" class="difflineplus">+    return !!this.notificationBar.getNotificationWithValue(&quot;blockedContent&quot;);</span>
<a href="#l5.428"></a><span id="l5.428" class="difflineplus">+  },</span>
<a href="#l5.429"></a><span id="l5.429" class="difflineplus">+</span>
<a href="#l5.430"></a><span id="l5.430" class="difflineplus">+  clearNotifications: function(aValue) {</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineplus">+    this.notificationBar.removeAllNotifications(true);</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineplus">+  }</span>
<a href="#l5.433"></a><span id="l5.433" class="difflineplus">+};</span>
<a href="#l5.434"></a><span id="l5.434" class="difflineplus">+</span>
<a href="#l5.435"></a><span id="l5.435" class="difflineplus">+/**</span>
<a href="#l5.436"></a><span id="l5.436" class="difflineplus">+ * Populate the menuitems of what blocked content to unblock.</span>
<a href="#l5.437"></a><span id="l5.437" class="difflineplus">+ */</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineplus">+function onBlockedContentOptionsShowing(aEvent) {</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineplus">+  let urls = aEvent.target.value ? aEvent.target.value.split(&quot; &quot;) : [];</span>
<a href="#l5.440"></a><span id="l5.440" class="difflineplus">+</span>
<a href="#l5.441"></a><span id="l5.441" class="difflineplus">+  // Out with the old...</span>
<a href="#l5.442"></a><span id="l5.442" class="difflineplus">+  let childNodes = aEvent.target.childNodes;</span>
<a href="#l5.443"></a><span id="l5.443" class="difflineplus">+  for (let i = childNodes.length - 1; i &gt;= 0; i--) {</span>
<a href="#l5.444"></a><span id="l5.444" class="difflineplus">+    childNodes[i].remove();</span>
<a href="#l5.445"></a><span id="l5.445" class="difflineplus">+  }</span>
<a href="#l5.446"></a><span id="l5.446" class="difflineplus">+</span>
<a href="#l5.447"></a><span id="l5.447" class="difflineplus">+  // ... and in with the new.</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineplus">+  for (let url of urls) {</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineplus">+    let menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l5.450"></a><span id="l5.450" class="difflineplus">+    let fString = sComposeMsgsBundle.getFormattedString(&quot;blockedAllowResource&quot;,</span>
<a href="#l5.451"></a><span id="l5.451" class="difflineplus">+                                                        [url]);</span>
<a href="#l5.452"></a><span id="l5.452" class="difflineplus">+    menuitem.setAttribute(&quot;label&quot;, fString);</span>
<a href="#l5.453"></a><span id="l5.453" class="difflineplus">+    menuitem.setAttribute(&quot;crop&quot;, &quot;center&quot;);</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineplus">+    menuitem.setAttribute(&quot;value&quot;, url);</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineplus">+    menuitem.setAttribute(&quot;oncommand&quot;,</span>
<a href="#l5.456"></a><span id="l5.456" class="difflineplus">+                          &quot;onUnblockResource(this.value, this.parentNode);&quot;);</span>
<a href="#l5.457"></a><span id="l5.457" class="difflineplus">+    aEvent.target.appendChild(menuitem);</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineplus">+  }</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineplus">+}</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineplus">+</span>
<a href="#l5.461"></a><span id="l5.461" class="difflineplus">+/**</span>
<a href="#l5.462"></a><span id="l5.462" class="difflineplus">+ * Handle clicking the &quot;Load &lt;url&gt;&quot; in the blocked content notification bar.</span>
<a href="#l5.463"></a><span id="l5.463" class="difflineplus">+ * @param {String} aURL - the URL that was unblocked</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineplus">+ * @param {Node} aNode  - the node holding as value the URLs of the blocked</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineplus">+ *                        resources in the message (space separated).</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineplus">+ */</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineplus">+function onUnblockResource(aURL, aNode) {</span>
<a href="#l5.468"></a><span id="l5.468" class="difflineplus">+  try {</span>
<a href="#l5.469"></a><span id="l5.469" class="difflineplus">+    loadBlockedImage(aURL);</span>
<a href="#l5.470"></a><span id="l5.470" class="difflineplus">+  } catch (e) {</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineplus">+    // Couldn't load the referenced image.</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineplus">+    Components.utils.reportError(e);</span>
<a href="#l5.473"></a><span id="l5.473" class="difflineplus">+  } finally {</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineplus">+    // Remove it from the list on success and failure.</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineplus">+    let urls = aNode.value.split(&quot; &quot;);</span>
<a href="#l5.476"></a><span id="l5.476" class="difflineplus">+    for (let i = 0; i &lt; urls.length; i++) {</span>
<a href="#l5.477"></a><span id="l5.477" class="difflineplus">+      if (urls[i] == aURL) {</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineplus">+        urls.splice(i, 1);</span>
<a href="#l5.479"></a><span id="l5.479" class="difflineplus">+        aNode.value = urls.join(&quot; &quot;);</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineplus">+        if (urls.length == 0) {</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineplus">+          gComposeNotificationBar.clearNotifications();</span>
<a href="#l5.482"></a><span id="l5.482" class="difflineplus">+        }</span>
<a href="#l5.483"></a><span id="l5.483" class="difflineplus">+        break;</span>
<a href="#l5.484"></a><span id="l5.484" class="difflineplus">+      }</span>
<a href="#l5.485"></a><span id="l5.485" class="difflineplus">+    }</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineplus">+  }</span>
<a href="#l5.487"></a><span id="l5.487" class="difflineplus">+}</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineplus">+</span>
<a href="#l5.489"></a><span id="l5.489" class="difflineplus">+/**</span>
<a href="#l5.490"></a><span id="l5.490" class="difflineplus">+ * Convert the blocked content to a data URL and swap the src to that for the</span>
<a href="#l5.491"></a><span id="l5.491" class="difflineplus">+ * elements that were using it.</span>
<a href="#l5.492"></a><span id="l5.492" class="difflineplus">+ *</span>
<a href="#l5.493"></a><span id="l5.493" class="difflineplus">+ * @param {String}  aURL - (necko) URL to unblock</span>
<a href="#l5.494"></a><span id="l5.494" class="difflineplus">+ * @param {Bool}    aReturnDataURL - return data: URL instead of processing image</span>
<a href="#l5.495"></a><span id="l5.495" class="difflineplus">+ * @return {String} the image as data: URL.</span>
<a href="#l5.496"></a><span id="l5.496" class="difflineplus">+ * @throw Error()   if reading the data failed</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineplus">+ */</span>
<a href="#l5.498"></a><span id="l5.498" class="difflineplus">+function loadBlockedImage(aURL, aReturnDataURL = false) {</span>
<a href="#l5.499"></a><span id="l5.499" class="difflineplus">+  let filename;</span>
<a href="#l5.500"></a><span id="l5.500" class="difflineplus">+  if (/^(file|chrome):/i.test(aURL)) {</span>
<a href="#l5.501"></a><span id="l5.501" class="difflineplus">+    filename = aURL.substr(aURL.lastIndexOf(&quot;/&quot;) + 1);</span>
<a href="#l5.502"></a><span id="l5.502" class="difflineplus">+  }</span>
<a href="#l5.503"></a><span id="l5.503" class="difflineplus">+  else {</span>
<a href="#l5.504"></a><span id="l5.504" class="difflineplus">+    let fnMatch = /[?&amp;;]filename=([^?&amp;]+)/.exec(aURL);</span>
<a href="#l5.505"></a><span id="l5.505" class="difflineplus">+    filename = (fnMatch &amp;&amp; fnMatch[1]) || &quot;&quot;;</span>
<a href="#l5.506"></a><span id="l5.506" class="difflineplus">+  }</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineplus">+</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineplus">+  filename = decodeURIComponent(filename);</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineplus">+  let uri = Services.io.newURI(aURL);</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineplus">+  let contentType;</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineplus">+  if (filename) {</span>
<a href="#l5.512"></a><span id="l5.512" class="difflineplus">+    try {</span>
<a href="#l5.513"></a><span id="l5.513" class="difflineplus">+      contentType = Components.classes[&quot;@mozilla.org/mime;1&quot;]</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineplus">+                      .getService(Components.interfaces.nsIMIMEService)</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineplus">+                      .getTypeFromURI(uri);</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineplus">+    } catch (ex) {</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineplus">+      contentType = &quot;image/png&quot;;</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineplus">+    }</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineplus">+</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineplus">+    if (!contentType.startsWith(&quot;image/&quot;)) {</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineplus">+      // Unsafe to unblock this. It would just be garbage either way.</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineplus">+      throw new Error(&quot;Won't unblock; URL=&quot; + aURL +</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineplus">+                      &quot;, contentType=&quot; + contentType);</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineplus">+    }</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineplus">+  }</span>
<a href="#l5.526"></a><span id="l5.526" class="difflineplus">+  else {</span>
<a href="#l5.527"></a><span id="l5.527" class="difflineplus">+    // Assuming image/png is the best we can do.</span>
<a href="#l5.528"></a><span id="l5.528" class="difflineplus">+    contentType = &quot;image/png&quot;;</span>
<a href="#l5.529"></a><span id="l5.529" class="difflineplus">+  }</span>
<a href="#l5.530"></a><span id="l5.530" class="difflineplus">+</span>
<a href="#l5.531"></a><span id="l5.531" class="difflineplus">+  let channel =</span>
<a href="#l5.532"></a><span id="l5.532" class="difflineplus">+    Services.io.newChannelFromURI2(uri,</span>
<a href="#l5.533"></a><span id="l5.533" class="difflineplus">+      null,</span>
<a href="#l5.534"></a><span id="l5.534" class="difflineplus">+      Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l5.535"></a><span id="l5.535" class="difflineplus">+      null,</span>
<a href="#l5.536"></a><span id="l5.536" class="difflineplus">+      Components.interfaces.nsILoadInfo.SEC_ALLOW_CROSS_ORIGIN_DATA_IS_NULL,</span>
<a href="#l5.537"></a><span id="l5.537" class="difflineplus">+      Components.interfaces.nsIContentPolicy.TYPE_OTHER);</span>
<a href="#l5.538"></a><span id="l5.538" class="difflineplus">+</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineplus">+  let inputStream = channel.open();</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineplus">+  let stream = Components.classes[&quot;@mozilla.org/binaryinputstream;1&quot;]</span>
<a href="#l5.541"></a><span id="l5.541" class="difflineplus">+                 .createInstance(Components.interfaces.nsIBinaryInputStream);</span>
<a href="#l5.542"></a><span id="l5.542" class="difflineplus">+  stream.setInputStream(inputStream);</span>
<a href="#l5.543"></a><span id="l5.543" class="difflineplus">+  let streamData = &quot;&quot;;</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineplus">+  try {</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineplus">+    while (stream.available() &gt; 0) {</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineplus">+      streamData += stream.readBytes(stream.available());</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineplus">+    }</span>
<a href="#l5.548"></a><span id="l5.548" class="difflineplus">+  } catch(e) {</span>
<a href="#l5.549"></a><span id="l5.549" class="difflineplus">+    stream.close();</span>
<a href="#l5.550"></a><span id="l5.550" class="difflineplus">+    throw new Error(&quot;Couln't read all data from URL=&quot; + aURL + &quot; (&quot; + e +&quot;)&quot;);</span>
<a href="#l5.551"></a><span id="l5.551" class="difflineplus">+  }</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineplus">+  stream.close();</span>
<a href="#l5.553"></a><span id="l5.553" class="difflineplus">+</span>
<a href="#l5.554"></a><span id="l5.554" class="difflineplus">+  let encoded = btoa(streamData);</span>
<a href="#l5.555"></a><span id="l5.555" class="difflineplus">+  let dataURL = &quot;data:&quot; + contentType +</span>
<a href="#l5.556"></a><span id="l5.556" class="difflineplus">+                (filename ? &quot;;filename=&quot; + encodeURIComponent(filename) : &quot;&quot;) +</span>
<a href="#l5.557"></a><span id="l5.557" class="difflineplus">+                &quot;;base64,&quot; + encoded;</span>
<a href="#l5.558"></a><span id="l5.558" class="difflineplus">+</span>
<a href="#l5.559"></a><span id="l5.559" class="difflineplus">+  if (aReturnDataURL) {</span>
<a href="#l5.560"></a><span id="l5.560" class="difflineplus">+    return dataURL;</span>
<a href="#l5.561"></a><span id="l5.561" class="difflineplus">+  }</span>
<a href="#l5.562"></a><span id="l5.562" class="difflineplus">+</span>
<a href="#l5.563"></a><span id="l5.563" class="difflineplus">+  let editor = GetCurrentEditor();</span>
<a href="#l5.564"></a><span id="l5.564" class="difflineplus">+  for (let img of editor.document.images) {</span>
<a href="#l5.565"></a><span id="l5.565" class="difflineplus">+    if (img.src == aURL) {</span>
<a href="#l5.566"></a><span id="l5.566" class="difflineplus">+      img.src = dataURL; // Swap to data URL.</span>
<a href="#l5.567"></a><span id="l5.567" class="difflineplus">+      img.classList.remove(&quot;loading-internal&quot;);</span>
<a href="#l5.568"></a><span id="l5.568" class="difflineplus">+    }</span>
<a href="#l5.569"></a><span id="l5.569" class="difflineplus">+  }</span>
<a href="#l5.570"></a><span id="l5.570" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/suite/mailnews/compose/messengercompose.xul</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/suite/mailnews/compose/messengercompose.xul</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -142,16 +142,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">   &lt;key id=&quot;showHideSidebar&quot;/&gt;</span>
<a href="#l6.5"></a><span id="l6.5">   &lt;!-- Tab/F6 Keys --&gt;</span>
<a href="#l6.6"></a><span id="l6.6">   &lt;key keycode=&quot;VK_TAB&quot; oncommand=&quot;SwitchElementFocus(event);&quot; modifiers=&quot;control&quot;/&gt;</span>
<a href="#l6.7"></a><span id="l6.7">   &lt;key keycode=&quot;VK_TAB&quot; oncommand=&quot;SwitchElementFocus(event);&quot; modifiers=&quot;control,shift&quot;/&gt;</span>
<a href="#l6.8"></a><span id="l6.8">   &lt;key keycode=&quot;VK_F6&quot; oncommand=&quot;SwitchElementFocus(event);&quot; modifiers=&quot;control&quot;/&gt;</span>
<a href="#l6.9"></a><span id="l6.9">   &lt;key keycode=&quot;VK_F6&quot; oncommand=&quot;SwitchElementFocus(event);&quot; modifiers=&quot;control,shift&quot;/&gt;</span>
<a href="#l6.10"></a><span id="l6.10">   &lt;key keycode=&quot;VK_F6&quot; oncommand=&quot;SwitchElementFocus(event);&quot; modifiers=&quot;shift&quot;/&gt;</span>
<a href="#l6.11"></a><span id="l6.11">   &lt;key keycode=&quot;VK_F6&quot; oncommand=&quot;SwitchElementFocus(event);&quot;/&gt;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+  &lt;key keycode=&quot;VK_ESCAPE&quot; oncommand=&quot;handleEsc();&quot;/&gt;</span>
<a href="#l6.13"></a><span id="l6.13"> &lt;/keyset&gt;</span>
<a href="#l6.14"></a><span id="l6.14"> &lt;keyset id=&quot;editorKeys&quot;/&gt;</span>
<a href="#l6.15"></a><span id="l6.15"> &lt;keyset id=&quot;composeKeys&quot;&gt;</span>
<a href="#l6.16"></a><span id="l6.16">   &lt;key id=&quot;key_renameAttachment&quot;/&gt;</span>
<a href="#l6.17"></a><span id="l6.17"> &lt;/keyset&gt;</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">   &lt;popupset id=&quot;contentAreaContextSet&quot;/&gt;</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineat">@@ -179,16 +180,20 @@</span>
<a href="#l6.22"></a><span id="l6.22">                 accesskey=&quot;&amp;attachFile.accesskey;&quot;</span>
<a href="#l6.23"></a><span id="l6.23">                 command=&quot;cmd_attachFile&quot;/&gt;</span>
<a href="#l6.24"></a><span id="l6.24">       &lt;menuitem label=&quot;&amp;attachPage.label;&quot;</span>
<a href="#l6.25"></a><span id="l6.25">                 accesskey=&quot;&amp;attachPage.accesskey;&quot;</span>
<a href="#l6.26"></a><span id="l6.26">                 command=&quot;cmd_attachPage&quot;/&gt;</span>
<a href="#l6.27"></a><span id="l6.27">     &lt;/menupopup&gt;</span>
<a href="#l6.28"></a><span id="l6.28">   &lt;/popupset&gt;</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30" class="difflineplus">+  &lt;menupopup id=&quot;blockedContentOptions&quot; value=&quot;&quot;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineplus">+             onpopupshowing=&quot;onBlockedContentOptionsShowing(event);&quot;&gt;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+  &lt;/menupopup&gt;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+</span>
<a href="#l6.34"></a><span id="l6.34">   &lt;vbox id=&quot;titlebar&quot;/&gt;</span>
<a href="#l6.35"></a><span id="l6.35"> </span>
<a href="#l6.36"></a><span id="l6.36">   &lt;toolbox id=&quot;compose-toolbox&quot;</span>
<a href="#l6.37"></a><span id="l6.37">            class=&quot;toolbox-top&quot;</span>
<a href="#l6.38"></a><span id="l6.38">            mode=&quot;full&quot;</span>
<a href="#l6.39"></a><span id="l6.39">            defaultmode=&quot;full&quot;&gt;</span>
<a href="#l6.40"></a><span id="l6.40">     &lt;toolbar id=&quot;compose-toolbar-menubar2&quot;</span>
<a href="#l6.41"></a><span id="l6.41">              type=&quot;menubar&quot;</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineat">@@ -643,16 +648,23 @@</span>
<a href="#l6.43"></a><span id="l6.43">             name=&quot;browser.message.body&quot;</span>
<a href="#l6.44"></a><span id="l6.44">             minheight=&quot;100&quot;</span>
<a href="#l6.45"></a><span id="l6.45">             flex=&quot;1&quot;</span>
<a href="#l6.46"></a><span id="l6.46">             ondblclick=&quot;EditorDblClick(event);&quot;</span>
<a href="#l6.47"></a><span id="l6.47">             context=&quot;contentAreaContextMenu&quot;/&gt;</span>
<a href="#l6.48"></a><span id="l6.48">   &lt;/vbox&gt;</span>
<a href="#l6.49"></a><span id="l6.49"> &lt;/hbox&gt;</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51" class="difflineplus">+  &lt;hbox&gt;</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+    &lt;notificationbox id=&quot;attachmentNotificationBox&quot;</span>
<a href="#l6.53"></a><span id="l6.53" class="difflineplus">+                     flex=&quot;1&quot;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineplus">+                     notificationside=&quot;bottom&quot;/&gt;</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+  &lt;/hbox&gt;</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineplus">+</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+</span>
<a href="#l6.58"></a><span id="l6.58">   &lt;statusbar id=&quot;status-bar&quot; class=&quot;chromeclass-status&quot;&gt;</span>
<a href="#l6.59"></a><span id="l6.59">     &lt;statusbarpanel id=&quot;component-bar&quot;/&gt;</span>
<a href="#l6.60"></a><span id="l6.60">     &lt;statusbarpanel id=&quot;statusText&quot; flex=&quot;1&quot;/&gt;</span>
<a href="#l6.61"></a><span id="l6.61">     &lt;statusbarpanel class=&quot;statusbarpanel-progress&quot; id=&quot;statusbar-progresspanel&quot; collapsed=&quot;true&quot;&gt;</span>
<a href="#l6.62"></a><span id="l6.62">       &lt;progressmeter id=&quot;compose-progressmeter&quot; class=&quot;progressmeter-statusbar&quot; mode=&quot;normal&quot; value=&quot;0&quot;/&gt;</span>
<a href="#l6.63"></a><span id="l6.63">     &lt;/statusbarpanel&gt;</span>
<a href="#l6.64"></a><span id="l6.64">     &lt;statusbarpanel checkfunc=&quot;MailCheckBeforeOfflineChange()&quot; id=&quot;offline-status&quot; class=&quot;statusbarpanel-iconic&quot;/&gt;</span>
<a href="#l6.65"></a><span id="l6.65">   &lt;/statusbar&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/suite/mailnews/jar.mn</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/suite/mailnews/jar.mn</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -13,16 +13,17 @@ messenger.jar:</span>
<a href="#l7.4"></a><span id="l7.4"> % content messenger-region %content/messenger-region/</span>
<a href="#l7.5"></a><span id="l7.5"> % overlay chrome://communicator/content/pref/preferences.xul                   chrome://messenger/content/mailPrefsOverlay.xul</span>
<a href="#l7.6"></a><span id="l7.6"> % overlay chrome://communicator/content/pref/pref-appearance.xul               chrome://messenger/content/mailPrefsOverlay.xul</span>
<a href="#l7.7"></a><span id="l7.7"> % overlay chrome://communicator/content/pref/pref-scripts.xul                  chrome://messenger/content/mailPrefsOverlay.xul</span>
<a href="#l7.8"></a><span id="l7.8"> % overlay chrome://communicator/content/pref/pref-cookies.xul                  chrome://messenger/content/mailPrefsOverlay.xul</span>
<a href="#l7.9"></a><span id="l7.9"> % overlay chrome://editor/content/editorTasksOverlay.xul                       chrome://messenger/content/mailTasksOverlay.xul</span>
<a href="#l7.10"></a><span id="l7.10"> % overlay chrome://messenger/content/addressbook/abSelectAddressesDialog.xul   chrome://messenger/content/mailOverlay.xul</span>
<a href="#l7.11"></a><span id="l7.11"> % overlay chrome://editor/content/composerOverlay.xul                          chrome://messenger/content/mailEditorOverlay.xul</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+% overlay chrome://editor/content/EdColorProps.xul                             chrome://messenger/content/messengercompose/EdColorPropsOverlay.xul</span>
<a href="#l7.13"></a><span id="l7.13"> % overlay chrome://editor/content/EdImageOverlay.xul                           chrome://messenger/content/messengercompose/mailComposeEditorOverlay.xul</span>
<a href="#l7.14"></a><span id="l7.14"> % overlay chrome://editor/content/EdLinkProps.xul                              chrome://messenger/content/messengercompose/mailComposeEditorOverlay.xul</span>
<a href="#l7.15"></a><span id="l7.15">     content/messenger/browserRequest.xul</span>
<a href="#l7.16"></a><span id="l7.16">     content/messenger/browserRequest.js</span>
<a href="#l7.17"></a><span id="l7.17">     content/messenger/msgViewPickerOverlay.js</span>
<a href="#l7.18"></a><span id="l7.18">     content/messenger/mailViewSetup.js</span>
<a href="#l7.19"></a><span id="l7.19">     content/messenger/mailViewSetup.xul</span>
<a href="#l7.20"></a><span id="l7.20">     content/messenger/mailViewList.xul</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineat">@@ -90,16 +91,17 @@ messenger.jar:</span>
<a href="#l7.22"></a><span id="l7.22">     content/messenger/ABSearchDialog.js                                        (search/ABSearchDialog.js)</span>
<a href="#l7.23"></a><span id="l7.23">     content/messenger/FilterListDialog.xul                                     (search/FilterListDialog.xul)</span>
<a href="#l7.24"></a><span id="l7.24">     content/messenger/FilterListDialog.js                                      (search/FilterListDialog.js)</span>
<a href="#l7.25"></a><span id="l7.25">     content/messenger/messengercompose/pref-composing_messages.xul             (compose/prefs/pref-composing_messages.xul)</span>
<a href="#l7.26"></a><span id="l7.26">     content/messenger/messengercompose/pref-composing_messages.js              (compose/prefs/pref-composing_messages.js)</span>
<a href="#l7.27"></a><span id="l7.27">     content/messenger/messengercompose/pref-formatting.xul                     (compose/prefs/pref-formatting.xul)</span>
<a href="#l7.28"></a><span id="l7.28">     content/messenger/messengercompose/pref-formatting.js                      (compose/prefs/pref-formatting.js)</span>
<a href="#l7.29"></a><span id="l7.29">     content/messenger/messengercompose/messengercompose.xul                    (compose/messengercompose.xul)</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineplus">+    content/messenger/messengercompose/EdColorPropsOverlay.xul                 (compose/EdColorPropsOverlay.xul)</span>
<a href="#l7.31"></a><span id="l7.31">     content/messenger/messengercompose/mailComposeOverlay.xul                  (compose/mailComposeOverlay.xul)</span>
<a href="#l7.32"></a><span id="l7.32">     content/messenger/messengercompose/msgComposeContextOverlay.xul            (compose/msgComposeContextOverlay.xul)</span>
<a href="#l7.33"></a><span id="l7.33">     content/messenger/messengercompose/MsgComposeCommands.js                   (compose/MsgComposeCommands.js)</span>
<a href="#l7.34"></a><span id="l7.34">     content/messenger/messengercompose/addressingWidgetOverlay.js              (compose/addressingWidgetOverlay.js)</span>
<a href="#l7.35"></a><span id="l7.35">     content/messenger/messengercompose/addressingWidgetOverlay.xul             (compose/addressingWidgetOverlay.xul)</span>
<a href="#l7.36"></a><span id="l7.36">     content/messenger/messengercompose/mailComposeExtrasOverlay.xul            (compose/mailComposeExtrasOverlay.xul)</span>
<a href="#l7.37"></a><span id="l7.37">     content/messenger/addressbook/addressbook.js                               (addrbook/addressbook.js)</span>
<a href="#l7.38"></a><span id="l7.38">     content/messenger/addressbook/addressbook.xul                              (addrbook/addressbook.xul)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/suite/mailnews/mailWindow.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/suite/mailnews/mailWindow.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -56,16 +56,109 @@ function OnMailWindowUnload()</span>
<a href="#l8.4"></a><span id="l8.4">   if (mailSession instanceof Components.interfaces.nsIMsgMailSession)</span>
<a href="#l8.5"></a><span id="l8.5">     mailSession.RemoveFolderListener(folderListener);</span>
<a href="#l8.6"></a><span id="l8.6">   mailSession.RemoveMsgWindow(msgWindow);</span>
<a href="#l8.7"></a><span id="l8.7">   messenger.setWindow(null, null);</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9">   msgWindow.closeWindow();</span>
<a href="#l8.10"></a><span id="l8.10"> }</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+/**</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+ * When copying/dragging, convert imap/mailbox URLs of images into data URLs so</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+ * that the images can be accessed in a paste elsewhere.</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+ */</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+function onCopyOrDragStart(e) {</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+  let sourceDoc = getBrowser().contentDocument;</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+  if (e.target.ownerDocument != sourceDoc) {</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+    // We're only interested if this is in the message content.</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+    return; </span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+  }</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+  let imgMap = new Map(); // Mapping img.src -&gt; dataURL.</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+  // For copy, the data of what is to be copied is not accessible at this point.</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+  // Figure out what images are a) part of the selection and b) visible in</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+  // the current document. If their source isn't http or data already, convert</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+  // them to data URLs.</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+  let selection = sourceDoc.getSelection();</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+  let draggedImg = selection.isCollapsed ? e.target : null;</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+  for (let img of sourceDoc.images) {</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+    if (/^(https?|data):/.test(img.src)) {</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+      continue;</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+    }</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+    if (img.naturalWidth == 0) {</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineplus">+      // Broken/inaccessible image then...</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineplus">+      continue;</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+    }</span>
<a href="#l8.40"></a><span id="l8.40" class="difflineplus">+</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineplus">+    if (!draggedImg &amp;&amp; !selection.containsNode(img, true)) {</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+      continue;</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+    }</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+    let style = window.getComputedStyle(img);</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+    if (style.display == &quot;none&quot; || style.visibility == &quot;hidden&quot;) {</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineplus">+      continue;</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineplus">+    }</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+    // Do not convert if the image is specifically flagged to not snarf.</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineplus">+    if (img.getAttribute(&quot;moz-do-not-send&quot;) == &quot;true&quot;) {</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+      continue;</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+    }</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineplus">+</span>
<a href="#l8.55"></a><span id="l8.55" class="difflineplus">+    // We don't need to wait for the image to load. If it isn't already loaded</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineplus">+    // in the source document, we wouldn't want it anyway.</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineplus">+    let canvas = sourceDoc.createElement(&quot;canvas&quot;);</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineplus">+    canvas.width = img.width;</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineplus">+    canvas.height = img.height;</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+    canvas.getContext(&quot;2d&quot;).drawImage(img, 0, 0, img.width, img.height);</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+    let type = /\.jpe?g$/i.test(img.src) ? &quot;image/jpg&quot; : &quot;image/png&quot;;</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+    imgMap.set(img.src, canvas.toDataURL(type));</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+  }</span>
<a href="#l8.65"></a><span id="l8.65" class="difflineplus">+</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+  if (imgMap.size == 0) {</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+    // Nothing that needs converting!</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineplus">+    return;</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineplus">+  }</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineplus">+  let clonedSelection = draggedImg ? draggedImg.cloneNode(false) :</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+                                     selection.getRangeAt(0).cloneContents();</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+  let div = sourceDoc.createElement(&quot;div&quot;);</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+  div.appendChild(clonedSelection);</span>
<a href="#l8.75"></a><span id="l8.75" class="difflineplus">+</span>
<a href="#l8.76"></a><span id="l8.76" class="difflineplus">+  let images = div.querySelectorAll(&quot;img&quot;);</span>
<a href="#l8.77"></a><span id="l8.77" class="difflineplus">+  for (let img of images) {</span>
<a href="#l8.78"></a><span id="l8.78" class="difflineplus">+    if (!imgMap.has(img.src)) {</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineplus">+      continue;</span>
<a href="#l8.80"></a><span id="l8.80" class="difflineplus">+    }</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+    img.src = imgMap.get(img.src);</span>
<a href="#l8.82"></a><span id="l8.82" class="difflineplus">+  }</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineplus">+</span>
<a href="#l8.84"></a><span id="l8.84" class="difflineplus">+  let html = div.innerHTML;</span>
<a href="#l8.85"></a><span id="l8.85" class="difflineplus">+  let parserUtils = Components.classes[&quot;@mozilla.org/parserutils;1&quot;]</span>
<a href="#l8.86"></a><span id="l8.86" class="difflineplus">+                      .getService(Components.interfaces.nsIParserUtils);</span>
<a href="#l8.87"></a><span id="l8.87" class="difflineplus">+  let plain = </span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+    parserUtils.convertToPlainText(html,</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+      Components.interfaces.nsIDocumentEncoder.OutputForPlainTextClipboardCopy,</span>
<a href="#l8.90"></a><span id="l8.90" class="difflineplus">+      0);</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineplus">+      </span>
<a href="#l8.92"></a><span id="l8.92" class="difflineplus">+  // Copy operation.</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+  if (&quot;clipboardData&quot; in e) { </span>
<a href="#l8.94"></a><span id="l8.94" class="difflineplus">+    e.clipboardData.setData(&quot;text/html&quot;, html);</span>
<a href="#l8.95"></a><span id="l8.95" class="difflineplus">+    e.clipboardData.setData(&quot;text/plain&quot;, plain);</span>
<a href="#l8.96"></a><span id="l8.96" class="difflineplus">+    e.preventDefault();</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineplus">+  }</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+  // Drag operation.</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+  else if (&quot;dataTransfer&quot; in e) { </span>
<a href="#l8.100"></a><span id="l8.100" class="difflineplus">+    e.dataTransfer.setData(&quot;text/html&quot;, html);</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+    e.dataTransfer.setData(&quot;text/plain&quot;, plain);</span>
<a href="#l8.102"></a><span id="l8.102" class="difflineplus">+  }</span>
<a href="#l8.103"></a><span id="l8.103" class="difflineplus">+}</span>
<a href="#l8.104"></a><span id="l8.104" class="difflineplus">+</span>
<a href="#l8.105"></a><span id="l8.105"> function CreateMailWindowGlobals()</span>
<a href="#l8.106"></a><span id="l8.106"> {</span>
<a href="#l8.107"></a><span id="l8.107">   // get the messenger instance</span>
<a href="#l8.108"></a><span id="l8.108">   messenger = Components.classes[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l8.109"></a><span id="l8.109">                         .createInstance(Components.interfaces.nsIMessenger);</span>
<a href="#l8.110"></a><span id="l8.110"> </span>
<a href="#l8.111"></a><span id="l8.111">   //Create windows status feedback</span>
<a href="#l8.112"></a><span id="l8.112">   // set the JS implementation of status feedback before creating the c++ one..</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineat">@@ -127,16 +220,19 @@ function InitMsgWindow()</span>
<a href="#l8.114"></a><span id="l8.114"> </span>
<a href="#l8.115"></a><span id="l8.115">   var messagepane = getMessageBrowser();</span>
<a href="#l8.116"></a><span id="l8.116">   messagepane.docShell.allowAuth = false;</span>
<a href="#l8.117"></a><span id="l8.117">   messagepane.docShell.allowDNSPrefetch = false;</span>
<a href="#l8.118"></a><span id="l8.118">   msgWindow.rootDocShell.allowAuth = true;</span>
<a href="#l8.119"></a><span id="l8.119">   msgWindow.rootDocShell.appType = Components.interfaces.nsIDocShell.APP_TYPE_MAIL;</span>
<a href="#l8.120"></a><span id="l8.120">   // Ensure we don't load xul error pages into the main window</span>
<a href="#l8.121"></a><span id="l8.121">   msgWindow.rootDocShell.useErrorPages = false;</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+  document.addEventListener(&quot;copy&quot;, onCopyOrDragStart, true);</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+  document.addEventListener(&quot;dragstart&quot;, onCopyOrDragStart, true);</span>
<a href="#l8.125"></a><span id="l8.125"> }</span>
<a href="#l8.126"></a><span id="l8.126"> </span>
<a href="#l8.127"></a><span id="l8.127"> function messagePaneOnResize(event)</span>
<a href="#l8.128"></a><span id="l8.128"> {</span>
<a href="#l8.129"></a><span id="l8.129">   // scale any overflowing images</span>
<a href="#l8.130"></a><span id="l8.130">   var messagepane = getMessageBrowser();</span>
<a href="#l8.131"></a><span id="l8.131">   var doc = messagepane.contentDocument;</span>
<a href="#l8.132"></a><span id="l8.132">   var imgs = doc.images;</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

