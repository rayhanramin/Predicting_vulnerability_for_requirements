<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 11820:2968b7dbde32067455f8bf9ddedb1c7b6c21d629</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 2968b7dbde32067455f8bf9ddedb1c7b6c21d629" />
<meta property="og:url" content="/comm-central/rev/2968b7dbde32067455f8bf9ddedb1c7b6c21d629" />
<meta property="og:description" content="Bug 824150 - Code cleanup in /mail/ and /mailnews/: Use new String methods like startsWith, endsWith, contains, remaining Services.jsm switches and querySelector use instead of NodeList calls: account creation" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 2968b7dbde32067455f8bf9ddedb1c7b6c21d629 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/2968b7dbde32067455f8bf9ddedb1c7b6c21d629">shortlog</a> |
<a href="/comm-central/log/2968b7dbde32067455f8bf9ddedb1c7b6c21d629">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/2968b7dbde32067455f8bf9ddedb1c7b6c21d629">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/2968b7dbde32067455f8bf9ddedb1c7b6c21d629">files</a> |
changeset |
<a href="/comm-central/raw-rev/2968b7dbde32067455f8bf9ddedb1c7b6c21d629">raw</a>  | <a href="/comm-central/archive/2968b7dbde32067455f8bf9ddedb1c7b6c21d629.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=824150">Bug 824150</a> - Code cleanup in /mail/ and /mailnews/: Use new String methods like startsWith, endsWith, contains, remaining Services.jsm switches and querySelector use instead of NodeList calls: account creation
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#83;&#101;&#98;&#97;&#115;&#116;&#105;&#97;&#110;&#32;&#72;&#101;&#110;&#103;&#115;&#116;&#32;&#60;&#97;&#114;&#99;&#104;&#97;&#101;&#111;&#112;&#116;&#101;&#114;&#121;&#120;&#64;&#99;&#111;&#111;&#108;&#101;&#45;&#102;&#105;&#108;&#101;&#115;&#46;&#100;&#101;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 15 Jan 2013 21:12:50 +0100</td></tr>

<tr>
 <td>changeset 11820</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/2968b7dbde32067455f8bf9ddedb1c7b6c21d629">2968b7dbde32067455f8bf9ddedb1c7b6c21d629</a></td>
</tr>



<tr>
<td>parent 11819</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/7feccbd27039a940f88203607a3495bbb50ff767">7feccbd27039a940f88203607a3495bbb50ff767</a>
</td>
</tr>

<tr>
<td>child 11821</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/a012dd84980d36de4c257d61ad189b320c5e1a7c">a012dd84980d36de4c257d61ad189b320c5e1a7c</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=2968b7dbde32067455f8bf9ddedb1c7b6c21d629">8803</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Wed, 16 Jan 2013 22:27:04 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@bf3e9bfb110b [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=bf3e9bfb110bd76cee960a1c49c15ac35edee18b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=bf3e9bfb110bd76cee960a1c49c15ac35edee18b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=bf3e9bfb110bd76cee960a1c49c15ac35edee18b&newProject=comm-central&newRevision=78c6a5c0828750976cf50bd4121331fe0ad82328&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=bf3e9bfb110bd76cee960a1c49c15ac35edee18b&newProject=comm-central&newRevision=78c6a5c0828750976cf50bd4121331fe0ad82328&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=bf3e9bfb110bd76cee960a1c49c15ac35edee18b&newProject=comm-central&newRevision=78c6a5c0828750976cf50bd4121331fe0ad82328&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=824150">824150</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=824150">Bug 824150</a> - Code cleanup in /mail/ and /mailnews/: Use new String methods like startsWith, endsWith, contains, remaining Services.jsm switches and querySelector use instead of NodeList calls: account creation</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/components/newmailaccount/content/uriListener.js">mail/components/newmailaccount/content/uriListener.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/components/newmailaccount/content/uriListener.js">file</a> |
<a href="/comm-central/annotate/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/components/newmailaccount/content/uriListener.js">annotate</a> |
<a href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/components/newmailaccount/content/uriListener.js">diff</a> |
<a href="/comm-central/comparison/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/components/newmailaccount/content/uriListener.js">comparison</a> |
<a href="/comm-central/log/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/components/newmailaccount/content/uriListener.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/test/mozmill/newmailaccount/test-newmailaccount.js">mail/test/mozmill/newmailaccount/test-newmailaccount.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/test/mozmill/newmailaccount/test-newmailaccount.js">file</a> |
<a href="/comm-central/annotate/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/test/mozmill/newmailaccount/test-newmailaccount.js">annotate</a> |
<a href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/test/mozmill/newmailaccount/test-newmailaccount.js">diff</a> |
<a href="/comm-central/comparison/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/test/mozmill/newmailaccount/test-newmailaccount.js">comparison</a> |
<a href="/comm-central/log/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/test/mozmill/newmailaccount/test-newmailaccount.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">file</a> |
<a href="/comm-central/annotate/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">annotate</a> |
<a href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">diff</a> |
<a href="/comm-central/comparison/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">comparison</a> |
<a href="/comm-central/log/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/AccountWizard.js">mailnews/base/prefs/content/AccountWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/AccountWizard.js">file</a> |
<a href="/comm-central/annotate/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/AccountWizard.js">annotate</a> |
<a href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/AccountWizard.js">diff</a> |
<a href="/comm-central/comparison/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/AccountWizard.js">comparison</a> |
<a href="/comm-central/log/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/AccountWizard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/createInBackend.js">mailnews/base/prefs/content/accountcreation/createInBackend.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/createInBackend.js">file</a> |
<a href="/comm-central/annotate/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/createInBackend.js">annotate</a> |
<a href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/createInBackend.js">diff</a> |
<a href="/comm-central/comparison/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/createInBackend.js">comparison</a> |
<a href="/comm-central/log/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/createInBackend.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/emailWizard.js">mailnews/base/prefs/content/accountcreation/emailWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/emailWizard.js">file</a> |
<a href="/comm-central/annotate/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/emailWizard.js">annotate</a> |
<a href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/emailWizard.js">diff</a> |
<a href="/comm-central/comparison/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/emailWizard.js">comparison</a> |
<a href="/comm-central/log/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/emailWizard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/fetchConfig.js">mailnews/base/prefs/content/accountcreation/fetchConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/fetchConfig.js">file</a> |
<a href="/comm-central/annotate/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/fetchConfig.js">annotate</a> |
<a href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/fetchConfig.js">diff</a> |
<a href="/comm-central/comparison/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/fetchConfig.js">comparison</a> |
<a href="/comm-central/log/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/fetchConfig.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/fetchhttp.js">mailnews/base/prefs/content/accountcreation/fetchhttp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/fetchhttp.js">file</a> |
<a href="/comm-central/annotate/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/fetchhttp.js">annotate</a> |
<a href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/fetchhttp.js">diff</a> |
<a href="/comm-central/comparison/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/fetchhttp.js">comparison</a> |
<a href="/comm-central/log/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/fetchhttp.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/guessConfig.js">mailnews/base/prefs/content/accountcreation/guessConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/guessConfig.js">file</a> |
<a href="/comm-central/annotate/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/guessConfig.js">annotate</a> |
<a href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/guessConfig.js">diff</a> |
<a href="/comm-central/comparison/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/guessConfig.js">comparison</a> |
<a href="/comm-central/log/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/guessConfig.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js">mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js">file</a> |
<a href="/comm-central/annotate/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js">annotate</a> |
<a href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js">diff</a> |
<a href="/comm-central/comparison/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js">comparison</a> |
<a href="/comm-central/log/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/util.js">mailnews/base/prefs/content/accountcreation/util.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/util.js">file</a> |
<a href="/comm-central/annotate/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/util.js">annotate</a> |
<a href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/util.js">diff</a> |
<a href="/comm-central/comparison/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/util.js">comparison</a> |
<a href="/comm-central/log/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/prefs/content/accountcreation/util.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigFetchDisk.js">mailnews/base/test/unit/test_autoconfigFetchDisk.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigFetchDisk.js">file</a> |
<a href="/comm-central/annotate/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigFetchDisk.js">annotate</a> |
<a href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigFetchDisk.js">diff</a> |
<a href="/comm-central/comparison/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigFetchDisk.js">comparison</a> |
<a href="/comm-central/log/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigFetchDisk.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigUtils.js">mailnews/base/test/unit/test_autoconfigUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigUtils.js">file</a> |
<a href="/comm-central/annotate/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigUtils.js">annotate</a> |
<a href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigUtils.js">diff</a> |
<a href="/comm-central/comparison/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigUtils.js">comparison</a> |
<a href="/comm-central/log/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigXML.js">mailnews/base/test/unit/test_autoconfigXML.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigXML.js">file</a> |
<a href="/comm-central/annotate/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigXML.js">annotate</a> |
<a href="/comm-central/diff/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigXML.js">diff</a> |
<a href="/comm-central/comparison/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigXML.js">comparison</a> |
<a href="/comm-central/log/2968b7dbde32067455f8bf9ddedb1c7b6c21d629/mailnews/base/test/unit/test_autoconfigXML.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/components/newmailaccount/content/uriListener.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/components/newmailaccount/content/uriListener.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -52,17 +52,17 @@ httpRequestObserver.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">     try {</span>
<a href="#l1.5"></a><span id="l1.5">       contentType = aSubject.getResponseHeader(&quot;Content-Type&quot;);</span>
<a href="#l1.6"></a><span id="l1.6">     } catch(e) {</span>
<a href="#l1.7"></a><span id="l1.7">       // If we couldn't get the response header, which can happen,</span>
<a href="#l1.8"></a><span id="l1.8">       // just swallow the exception and return.</span>
<a href="#l1.9"></a><span id="l1.9">       return;</span>
<a href="#l1.10"></a><span id="l1.10">     }</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    if (contentType.toLowerCase().indexOf(&quot;text/xml&quot;) != 0)</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    if (!contentType.toLowerCase().startsWith(&quot;text/xml&quot;))</span>
<a href="#l1.14"></a><span id="l1.14">       return;</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">     let requestWindow = this._getWindowForRequest(aSubject);</span>
<a href="#l1.17"></a><span id="l1.17">     if (!requestWindow || (requestWindow !== this.browser.contentWindow))</span>
<a href="#l1.18"></a><span id="l1.18">       return;</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20">     // Ok, we've got a request that looks like a decent candidate.</span>
<a href="#l1.21"></a><span id="l1.21">     // Let's attach our TracingListener.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/test/mozmill/newmailaccount/test-newmailaccount.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/test/mozmill/newmailaccount/test-newmailaccount.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -453,21 +453,21 @@ function subtest_html_characters_and_amp</span>
<a href="#l2.4"></a><span id="l2.4">   wait_for_search_results(w);</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6">   let displayedName = $(&quot;#FirstAndLastName&quot;).html();</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">   assert_not_equals(CLEVER_STRING, displayedName);</span>
<a href="#l2.9"></a><span id="l2.9">   // &amp; should have been replaced with &amp;amp;, and the</span>
<a href="#l2.10"></a><span id="l2.10">   // greater than / less than characters with &amp;gt; and</span>
<a href="#l2.11"></a><span id="l2.11">   // &amp;lt; respectively.</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  assert_true(displayedName.indexOf(&quot;&amp;amp;&quot;) != -1,</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+  assert_true(displayedName.contains(&quot;&amp;amp;&quot;),</span>
<a href="#l2.14"></a><span id="l2.14">               &quot;Should have eliminated ampersands&quot;);</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-  assert_true(displayedName.indexOf(&quot;&amp;gt;&quot;) != -1,</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+  assert_true(displayedName.contains(&quot;&amp;gt;&quot;),</span>
<a href="#l2.17"></a><span id="l2.17">               &quot;Should have eliminated greater-than signs&quot;);</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineminus">-  assert_true(displayedName.indexOf(&quot;&amp;lt;&quot;) != -1,</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+  assert_true(displayedName.contains(&quot;&amp;lt;&quot;),</span>
<a href="#l2.20"></a><span id="l2.20">               &quot;Should have eliminated less-than signs&quot;);</span>
<a href="#l2.21"></a><span id="l2.21"> }</span>
<a href="#l2.22"></a><span id="l2.22"> </span>
<a href="#l2.23"></a><span id="l2.23"> /**</span>
<a href="#l2.24"></a><span id="l2.24">  * Test that only the terms of service and privacy links for selected</span>
<a href="#l2.25"></a><span id="l2.25">  * providers are shown in the disclaimer.</span>
<a href="#l2.26"></a><span id="l2.26">  */</span>
<a href="#l2.27"></a><span id="l2.27"> function test_show_tos_privacy_links_for_selected_providers() {</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineat">@@ -1190,23 +1190,20 @@ function subtest_provider_language_wildc</span>
<a href="#l2.29"></a><span id="l2.29"> /**</span>
<a href="#l2.30"></a><span id="l2.30">  * Tests that the search button is disabled if we start up the Account</span>
<a href="#l2.31"></a><span id="l2.31">  * Provisioner, and we have no search in the input.</span>
<a href="#l2.32"></a><span id="l2.32">  */</span>
<a href="#l2.33"></a><span id="l2.33"> function test_search_button_disabled_if_no_query_on_init() {</span>
<a href="#l2.34"></a><span id="l2.34">   // We have to do a little bit of gymnastics to access the local storage</span>
<a href="#l2.35"></a><span id="l2.35">   // for the accountProvisioner dialog...</span>
<a href="#l2.36"></a><span id="l2.36">   let url = &quot;chrome://content/messenger/accountProvisionerStorage/accountProvisioner&quot;;</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-  let ssm = Cc[&quot;@mozilla.org/scriptsecuritymanager;1&quot;]</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-    .getService(Ci.nsIScriptSecurityManager);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-  let dsm = Cc[&quot;@mozilla.org/dom/storagemanager;1&quot;]</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-    .getService(Ci.nsIDOMStorageManager);</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineplus">+  let dsm = Services.domStorageManager;</span>
<a href="#l2.42"></a><span id="l2.42"> </span>
<a href="#l2.43"></a><span id="l2.43">   let uri = Services.io.newURI(url, &quot;&quot;, null);</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-  let principal = ssm.getNoAppCodebasePrincipal(uri);</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+  let principal = Services.scriptSecurityManager.getNoAppCodebasePrincipal(uri);</span>
<a href="#l2.46"></a><span id="l2.46">   let storage = dsm.getLocalStorageForPrincipal(principal, url);</span>
<a href="#l2.47"></a><span id="l2.47"> </span>
<a href="#l2.48"></a><span id="l2.48">   // Ok, got it. Now let's blank out the name.</span>
<a href="#l2.49"></a><span id="l2.49">   storage.setItem(&quot;name&quot;, &quot;&quot;);</span>
<a href="#l2.50"></a><span id="l2.50"> </span>
<a href="#l2.51"></a><span id="l2.51">   plan_for_modal_dialog(&quot;AccountCreation&quot;,</span>
<a href="#l2.52"></a><span id="l2.52">                         subtest_search_button_disabled_on_init);</span>
<a href="#l2.53"></a><span id="l2.53">   open_provisioner_window();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-newmailaccount-helpers.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -192,17 +192,17 @@ var gConsoleListener = {</span>
<a href="#l3.4"></a><span id="l3.4">   QueryInterface: XPCOMUtils.generateQI([Ci.nsIConsoleListener]),</span>
<a href="#l3.5"></a><span id="l3.5">   _msg: null,</span>
<a href="#l3.6"></a><span id="l3.6">   _sawMsg: false,</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8">   observe: function(aMsg) {</span>
<a href="#l3.9"></a><span id="l3.9">     if (!this._msg)</span>
<a href="#l3.10"></a><span id="l3.10">       return;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    this._sawMsg |= (aMsg.message.indexOf(this._msg) != -1);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+    this._sawMsg |= (aMsg.message.contains(this._msg));</span>
<a href="#l3.14"></a><span id="l3.14">   },</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16">   listenFor: function(aMsg) {</span>
<a href="#l3.17"></a><span id="l3.17">     this._msg = aMsg;</span>
<a href="#l3.18"></a><span id="l3.18">   },</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20">   reset: function() {</span>
<a href="#l3.21"></a><span id="l3.21">     this._msg = null;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountWizard.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountWizard.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -40,78 +40,75 @@ var okCallback = null;</span>
<a href="#l4.4"></a><span id="l4.4">    (server vs. newsserver)</span>
<a href="#l4.5"></a><span id="l4.5"> */</span>
<a href="#l4.6"></a><span id="l4.6"> </span>
<a href="#l4.7"></a><span id="l4.7"> var contentWindow;</span>
<a href="#l4.8"></a><span id="l4.8"> </span>
<a href="#l4.9"></a><span id="l4.9"> var gPageData;</span>
<a href="#l4.10"></a><span id="l4.10"> var smtpService = Components.classes[&quot;@mozilla.org/messengercompose/smtp;1&quot;].getService(Components.interfaces.nsISmtpService);</span>
<a href="#l4.11"></a><span id="l4.11"> var am = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-var gPrefs = Components.classes[&quot;@mozilla.org/preferences-service;1&quot;].getService(Components.interfaces.nsIPrefBranch);</span>
<a href="#l4.13"></a><span id="l4.13"> var gMailSession = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;].getService(Components.interfaces.nsIMsgMailSession);</span>
<a href="#l4.14"></a><span id="l4.14"> var accounts = am.accounts;</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16"> //accountCount indicates presence or absense of accounts</span>
<a href="#l4.17"></a><span id="l4.17"> var accountCount = accounts.length;</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> var nsIMsgIdentity = Components.interfaces.nsIMsgIdentity;</span>
<a href="#l4.20"></a><span id="l4.20"> var nsIMsgIncomingServer = Components.interfaces.nsIMsgIncomingServer;</span>
<a href="#l4.21"></a><span id="l4.21"> var gPrefsBundle, gMessengerBundle;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-var promptService = Components.classes[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;].getService();</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineminus">-promptService = promptService.QueryInterface(Components.interfaces.nsIPromptService);</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25"> // the current nsIMsgAccount</span>
<a href="#l4.26"></a><span id="l4.26"> var gCurrentAccount;</span>
<a href="#l4.27"></a><span id="l4.27"> </span>
<a href="#l4.28"></a><span id="l4.28"> // default account</span>
<a href="#l4.29"></a><span id="l4.29"> var gDefaultAccount;</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31"> // the current associative array that</span>
<a href="#l4.32"></a><span id="l4.32"> // will eventually be dumped into the account</span>
<a href="#l4.33"></a><span id="l4.33"> var gCurrentAccountData;</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35"> // default picker mode for copies and folders</span>
<a href="#l4.36"></a><span id="l4.36"> const gDefaultSpecialFolderPickerMode = &quot;0&quot;;</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38"> // event handlers</span>
<a href="#l4.39"></a><span id="l4.39"> function onAccountWizardLoad() {</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-    gPrefsBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-    gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+  gPrefsBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l4.44"></a><span id="l4.44"> </span>
<a href="#l4.45"></a><span id="l4.45" class="difflineminus">-    if (&quot;testingIspServices&quot; in this) {</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-      if (&quot;SetCustomizedWizardDimensions&quot; in this &amp;&amp; testingIspServices()) {</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineminus">-        SetCustomizedWizardDimensions();</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineminus">-      }</span>
<a href="#l4.49"></a><span id="l4.49" class="difflineplus">+  if (&quot;testingIspServices&quot; in this) {</span>
<a href="#l4.50"></a><span id="l4.50" class="difflineplus">+    if (&quot;SetCustomizedWizardDimensions&quot; in this &amp;&amp; testingIspServices()) {</span>
<a href="#l4.51"></a><span id="l4.51" class="difflineplus">+      SetCustomizedWizardDimensions();</span>
<a href="#l4.52"></a><span id="l4.52">     }</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+  }</span>
<a href="#l4.54"></a><span id="l4.54"> </span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-    /* We are checking here for the callback argument */</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-    if (window.arguments &amp;&amp; window.arguments[0]) {</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-        if(window.arguments[0].okCallback ) </span>
<a href="#l4.58"></a><span id="l4.58" class="difflineminus">-        {</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-            //dump(&quot;There is okCallback&quot;);</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineminus">-            top.okCallback = window.arguments[0].okCallback;</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineminus">-        }</span>
<a href="#l4.62"></a><span id="l4.62" class="difflineplus">+  /* We are checking here for the callback argument */</span>
<a href="#l4.63"></a><span id="l4.63" class="difflineplus">+  if (window.arguments &amp;&amp; window.arguments[0]) {</span>
<a href="#l4.64"></a><span id="l4.64" class="difflineplus">+    if(window.arguments[0].okCallback ) </span>
<a href="#l4.65"></a><span id="l4.65" class="difflineplus">+    {</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+      //dump(&quot;There is okCallback&quot;);</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineplus">+      top.okCallback = window.arguments[0].okCallback;</span>
<a href="#l4.68"></a><span id="l4.68">     }</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+  }</span>
<a href="#l4.70"></a><span id="l4.70"> </span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-    checkForInvalidAccounts();</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+  checkForInvalidAccounts();</span>
<a href="#l4.73"></a><span id="l4.73"> </span>
<a href="#l4.74"></a><span id="l4.74" class="difflineminus">-    try {</span>
<a href="#l4.75"></a><span id="l4.75" class="difflineminus">-        gDefaultAccount = am.defaultAccount;</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-    }</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineminus">-    catch (ex) {</span>
<a href="#l4.78"></a><span id="l4.78" class="difflineminus">-        // no default account, this is expected the first time you launch mail</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-        // on a new profile</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-        gDefaultAccount = null;</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-    }</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineplus">+  try {</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineplus">+    gDefaultAccount = am.defaultAccount;</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineplus">+  }</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+  catch (ex) {</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+    // no default account, this is expected the first time you launch mail</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+    // on a new profile</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+    gDefaultAccount = null;</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+  }</span>
<a href="#l4.90"></a><span id="l4.90"> </span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-    // Set default value for global inbox checkbox</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-    var checkGlobalInbox = document.getElementById(&quot;deferStorage&quot;);</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-    try {</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-        checkGlobalInbox.checked = gPrefs.getBoolPref(&quot;mail.accountwizard.deferstorage&quot;);</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-    } catch(e) {}</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+  // Set default value for global inbox checkbox</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+  var checkGlobalInbox = document.getElementById(&quot;deferStorage&quot;);</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+  try {</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+    checkGlobalInbox.checked = Services.prefs.getBoolPref(&quot;mail.accountwizard.deferstorage&quot;);</span>
<a href="#l4.100"></a><span id="l4.100" class="difflineplus">+  } catch(e) {}</span>
<a href="#l4.101"></a><span id="l4.101"> }</span>
<a href="#l4.102"></a><span id="l4.102"> </span>
<a href="#l4.103"></a><span id="l4.103"> function onCancel() </span>
<a href="#l4.104"></a><span id="l4.104"> {</span>
<a href="#l4.105"></a><span id="l4.105">   if (&quot;ActivationOnCancel&quot; in this &amp;&amp; ActivationOnCancel())</span>
<a href="#l4.106"></a><span id="l4.106">     return false;</span>
<a href="#l4.107"></a><span id="l4.107">   var firstInvalidAccount = getFirstInvalidAccount();</span>
<a href="#l4.108"></a><span id="l4.108">   var closeWizard = true;</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineat">@@ -135,21 +132,21 @@ function onCancel()</span>
<a href="#l4.110"></a><span id="l4.110">     // call FinishAccount() and not onFinish(), since the &quot;finish&quot;</span>
<a href="#l4.111"></a><span id="l4.111">     // button may be disabled</span>
<a href="#l4.112"></a><span id="l4.112">     FinishAccount();</span>
<a href="#l4.113"></a><span id="l4.113">   }</span>
<a href="#l4.114"></a><span id="l4.114">   else {</span>
<a href="#l4.115"></a><span id="l4.115">     // since this is not an invalid account</span>
<a href="#l4.116"></a><span id="l4.116">     // really cancel if the user hits the &quot;cancel&quot; button</span>
<a href="#l4.117"></a><span id="l4.117">     if (accountCount &lt; 1) {</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-      var confirmMsg = gPrefsBundle.getString(&quot;cancelWizard&quot;);</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineminus">-      var confirmTitle = gPrefsBundle.getString(&quot;accountWizard&quot;);</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineminus">-      var result = promptService.confirmEx(window, confirmTitle, confirmMsg,</span>
<a href="#l4.121"></a><span id="l4.121" class="difflineminus">-        (promptService.BUTTON_TITLE_IS_STRING*promptService.BUTTON_POS_0)+</span>
<a href="#l4.122"></a><span id="l4.122" class="difflineminus">-        (promptService.BUTTON_TITLE_IS_STRING*promptService.BUTTON_POS_1),</span>
<a href="#l4.123"></a><span id="l4.123" class="difflineplus">+      let confirmMsg = gPrefsBundle.getString(&quot;cancelWizard&quot;);</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineplus">+      let confirmTitle = gPrefsBundle.getString(&quot;accountWizard&quot;);</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineplus">+      let result = Services.prompt.confirmEx(window, confirmTitle, confirmMsg,</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+        (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineplus">+        (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_1),</span>
<a href="#l4.128"></a><span id="l4.128">         gPrefsBundle.getString('WizardExit'),</span>
<a href="#l4.129"></a><span id="l4.129">         gPrefsBundle.getString('WizardContinue'), </span>
<a href="#l4.130"></a><span id="l4.130">         null, null, {value:0});</span>
<a href="#l4.131"></a><span id="l4.131"> </span>
<a href="#l4.132"></a><span id="l4.132">       if (result == 1)</span>
<a href="#l4.133"></a><span id="l4.133">         closeWizard = false;</span>
<a href="#l4.134"></a><span id="l4.134">     }</span>
<a href="#l4.135"></a><span id="l4.135"> </span>
<a href="#l4.136"></a><span id="l4.136" class="difflineat">@@ -181,25 +178,25 @@ function FinishAccount()</span>
<a href="#l4.137"></a><span id="l4.137">     verifyLocalFoldersAccount();</span>
<a href="#l4.138"></a><span id="l4.138"> </span>
<a href="#l4.139"></a><span id="l4.139">     PageDataToAccountData(pageData, accountData);</span>
<a href="#l4.140"></a><span id="l4.140"> </span>
<a href="#l4.141"></a><span id="l4.141">     FixupAccountDataForIsp(accountData);</span>
<a href="#l4.142"></a><span id="l4.142">     </span>
<a href="#l4.143"></a><span id="l4.143">     // we might be simply finishing another account</span>
<a href="#l4.144"></a><span id="l4.144">     if (!gCurrentAccount)</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-        gCurrentAccount = createAccount(accountData);</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineplus">+      gCurrentAccount = createAccount(accountData);</span>
<a href="#l4.147"></a><span id="l4.147"> </span>
<a href="#l4.148"></a><span id="l4.148">     // transfer all attributes from the accountdata</span>
<a href="#l4.149"></a><span id="l4.149">     finishAccount(gCurrentAccount, accountData);</span>
<a href="#l4.150"></a><span id="l4.150">     </span>
<a href="#l4.151"></a><span id="l4.151">     setupCopiesAndFoldersServer(gCurrentAccount, getCurrentServerIsDeferred(pageData), accountData);</span>
<a href="#l4.152"></a><span id="l4.152"> </span>
<a href="#l4.153"></a><span id="l4.153">     if (!serverIsNntp(pageData))</span>
<a href="#l4.154"></a><span id="l4.154" class="difflineminus">-        EnableCheckMailAtStartUpIfNeeded(gCurrentAccount);</span>
<a href="#l4.155"></a><span id="l4.155" class="difflineplus">+      EnableCheckMailAtStartUpIfNeeded(gCurrentAccount);</span>
<a href="#l4.156"></a><span id="l4.156"> </span>
<a href="#l4.157"></a><span id="l4.157">     if (!document.getElementById(&quot;downloadMsgs&quot;).hidden) {</span>
<a href="#l4.158"></a><span id="l4.158">       // skip the default biff, we will load messages manually if needed</span>
<a href="#l4.159"></a><span id="l4.159">       window.opener.gLoadStartFolder = false;</span>
<a href="#l4.160"></a><span id="l4.160">       if (document.getElementById(&quot;downloadMsgs&quot;).checked) {</span>
<a href="#l4.161"></a><span id="l4.161">         window.opener.gNewAccountToLoad = gCurrentAccount; // load messages for new POP account</span>
<a href="#l4.162"></a><span id="l4.162">       }</span>
<a href="#l4.163"></a><span id="l4.163">     }</span>
<a href="#l4.164"></a><span id="l4.164" class="difflineat">@@ -209,333 +206,335 @@ function FinishAccount()</span>
<a href="#l4.165"></a><span id="l4.165">       am.saveAccountInfo();</span>
<a href="#l4.166"></a><span id="l4.166">     } </span>
<a href="#l4.167"></a><span id="l4.167">     catch (ex) {</span>
<a href="#l4.168"></a><span id="l4.168">       dump(&quot;Error saving account info: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l4.169"></a><span id="l4.169">     }</span>
<a href="#l4.170"></a><span id="l4.170">     window.close();</span>
<a href="#l4.171"></a><span id="l4.171">     if(top.okCallback)</span>
<a href="#l4.172"></a><span id="l4.172">     {</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-        var state = true;</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineminus">-        //dump(&quot;finish callback&quot;);</span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-        top.okCallback(state);</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineplus">+      var state = true;</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineplus">+      //dump(&quot;finish callback&quot;);</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineplus">+      top.okCallback(state);</span>
<a href="#l4.179"></a><span id="l4.179">     }</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-}</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+  }</span>
<a href="#l4.182"></a><span id="l4.182">   catch(ex) {</span>
<a href="#l4.183"></a><span id="l4.183">     dump(&quot;FinishAccount failed, &quot; + ex +&quot;\n&quot;);</span>
<a href="#l4.184"></a><span id="l4.184">   }</span>
<a href="#l4.185"></a><span id="l4.185"> }</span>
<a href="#l4.186"></a><span id="l4.186"> </span>
<a href="#l4.187"></a><span id="l4.187"> // prepopulate pageData with stuff from accountData</span>
<a href="#l4.188"></a><span id="l4.188"> // use: to prepopulate the wizard with account information</span>
<a href="#l4.189"></a><span id="l4.189"> function AccountDataToPageData(accountData, pageData)</span>
<a href="#l4.190"></a><span id="l4.190"> {</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineminus">-    if (!accountData) {</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineminus">-        dump(&quot;null account data! clearing..\n&quot;);</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-        // handle null accountData as if it were an empty object</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-        // so that we clear-out any old pagedata from a</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineminus">-        // previous accountdata. The trick is that</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineminus">-        // with an empty object, accountData.identity.slot is undefined,</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineminus">-        // so this will clear out the prefill data in setPageData</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineminus">-        </span>
<a href="#l4.199"></a><span id="l4.199" class="difflineminus">-        accountData = new Object;</span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-        accountData.incomingServer = new Object;</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-        accountData.identity = new Object;</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-        accountData.smtp = new Object;</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineminus">-    }</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineplus">+  if (!accountData) {</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineplus">+    dump(&quot;null account data! clearing..\n&quot;);</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineplus">+    // handle null accountData as if it were an empty object</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+    // so that we clear-out any old pagedata from a</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+    // previous accountdata. The trick is that</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+    // with an empty object, accountData.identity.slot is undefined,</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+    // so this will clear out the prefill data in setPageData</span>
<a href="#l4.211"></a><span id="l4.211">     </span>
<a href="#l4.212"></a><span id="l4.212" class="difflineminus">-    var server = accountData.incomingServer;</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+    accountData = new Object;</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+    accountData.incomingServer = new Object;</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+    accountData.identity = new Object;</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+    accountData.smtp = new Object;</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+  }</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+  </span>
<a href="#l4.219"></a><span id="l4.219" class="difflineplus">+  var server = accountData.incomingServer;</span>
<a href="#l4.220"></a><span id="l4.220"> </span>
<a href="#l4.221"></a><span id="l4.221" class="difflineminus">-    if (server.type == undefined) {</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-        // clear out the old server data</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-        //setPageData(pageData, &quot;accounttype&quot;, &quot;mailaccount&quot;, undefined);</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-        //        setPageData(pageData, &quot;accounttype&quot;, &quot;newsaccount&quot;, undefined);</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-        setPageData(pageData, &quot;server&quot;, &quot;servertype&quot;, undefined);</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-        setPageData(pageData, &quot;server&quot;, &quot;hostname&quot;, undefined);</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-        </span>
<a href="#l4.228"></a><span id="l4.228" class="difflineminus">-    } else {</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineminus">-        </span>
<a href="#l4.230"></a><span id="l4.230" class="difflineminus">-        if (server.type == &quot;nntp&quot;) {</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineminus">-            setPageData(pageData, &quot;accounttype&quot;, &quot;newsaccount&quot;, true);</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineminus">-            setPageData(pageData, &quot;accounttype&quot;, &quot;mailaccount&quot;, false);</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-            setPageData(pageData, &quot;newsserver&quot;, &quot;hostname&quot;, server.hostName);</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineminus">-        }</span>
<a href="#l4.235"></a><span id="l4.235" class="difflineminus">-        </span>
<a href="#l4.236"></a><span id="l4.236" class="difflineminus">-        else {</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineminus">-            setPageData(pageData, &quot;accounttype&quot;, &quot;mailaccount&quot;, true);</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineminus">-            setPageData(pageData, &quot;accounttype&quot;, &quot;newsaccount&quot;, false);</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-            setPageData(pageData, &quot;server&quot;, &quot;servertype&quot;, server.type);</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-            setPageData(pageData, &quot;server&quot;, &quot;hostname&quot;, server.hostName);</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-        }</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineminus">-        setPageData(pageData, &quot;accounttype&quot;, &quot;otheraccount&quot;, false);</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineminus">-    }</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineminus">-    </span>
<a href="#l4.245"></a><span id="l4.245" class="difflineminus">-    setPageData(pageData, &quot;login&quot;, &quot;username&quot;, server.username);</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineminus">-    setPageData(pageData, &quot;login&quot;, &quot;password&quot;, server.password);</span>
<a href="#l4.247"></a><span id="l4.247" class="difflineminus">-    setPageData(pageData, &quot;accname&quot;, &quot;prettyName&quot;, server.prettyName);</span>
<a href="#l4.248"></a><span id="l4.248" class="difflineminus">-    setPageData(pageData, &quot;accname&quot;, &quot;userset&quot;, false);</span>
<a href="#l4.249"></a><span id="l4.249" class="difflineminus">-    setPageData(pageData, &quot;ispdata&quot;, &quot;supplied&quot;, false);</span>
<a href="#l4.250"></a><span id="l4.250" class="difflineminus">-    </span>
<a href="#l4.251"></a><span id="l4.251" class="difflineminus">-    var identity;</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-    </span>
<a href="#l4.253"></a><span id="l4.253" class="difflineminus">-    if (accountData.identity) {</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineminus">-        dump(&quot;This is an accountdata\n&quot;);</span>
<a href="#l4.255"></a><span id="l4.255" class="difflineminus">-        identity = accountData.identity;</span>
<a href="#l4.256"></a><span id="l4.256" class="difflineminus">-    }</span>
<a href="#l4.257"></a><span id="l4.257" class="difflineminus">-    else if (accountData.identities) {</span>
<a href="#l4.258"></a><span id="l4.258" class="difflineminus">-        identity = accountData.identities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l4.259"></a><span id="l4.259" class="difflineminus">-        dump(&quot;this is an account, id= &quot; + identity + &quot;\n&quot;);</span>
<a href="#l4.260"></a><span id="l4.260" class="difflineplus">+  if (server.type == undefined) {</span>
<a href="#l4.261"></a><span id="l4.261" class="difflineplus">+    // clear out the old server data</span>
<a href="#l4.262"></a><span id="l4.262" class="difflineplus">+    //setPageData(pageData, &quot;accounttype&quot;, &quot;mailaccount&quot;, undefined);</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineplus">+    //        setPageData(pageData, &quot;accounttype&quot;, &quot;newsaccount&quot;, undefined);</span>
<a href="#l4.264"></a><span id="l4.264" class="difflineplus">+    setPageData(pageData, &quot;server&quot;, &quot;servertype&quot;, undefined);</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+    setPageData(pageData, &quot;server&quot;, &quot;hostname&quot;, undefined);</span>
<a href="#l4.266"></a><span id="l4.266" class="difflineplus">+</span>
<a href="#l4.267"></a><span id="l4.267" class="difflineplus">+  }</span>
<a href="#l4.268"></a><span id="l4.268" class="difflineplus">+  else {</span>
<a href="#l4.269"></a><span id="l4.269" class="difflineplus">+</span>
<a href="#l4.270"></a><span id="l4.270" class="difflineplus">+    if (server.type == &quot;nntp&quot;) {</span>
<a href="#l4.271"></a><span id="l4.271" class="difflineplus">+      setPageData(pageData, &quot;accounttype&quot;, &quot;newsaccount&quot;, true);</span>
<a href="#l4.272"></a><span id="l4.272" class="difflineplus">+      setPageData(pageData, &quot;accounttype&quot;, &quot;mailaccount&quot;, false);</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+      setPageData(pageData, &quot;newsserver&quot;, &quot;hostname&quot;, server.hostName);</span>
<a href="#l4.274"></a><span id="l4.274">     }</span>
<a href="#l4.275"></a><span id="l4.275"> </span>
<a href="#l4.276"></a><span id="l4.276" class="difflineminus">-    setPageData(pageData, &quot;identity&quot;, &quot;email&quot;, identity.email);</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineminus">-    setPageData(pageData, &quot;identity&quot;, &quot;fullName&quot;, identity.fullName);</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineplus">+    else {</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineplus">+      setPageData(pageData, &quot;accounttype&quot;, &quot;mailaccount&quot;, true);</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+      setPageData(pageData, &quot;accounttype&quot;, &quot;newsaccount&quot;, false);</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+      setPageData(pageData, &quot;server&quot;, &quot;servertype&quot;, server.type);</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineplus">+      setPageData(pageData, &quot;server&quot;, &quot;hostname&quot;, server.hostName);</span>
<a href="#l4.283"></a><span id="l4.283" class="difflineplus">+    }</span>
<a href="#l4.284"></a><span id="l4.284" class="difflineplus">+    setPageData(pageData, &quot;accounttype&quot;, &quot;otheraccount&quot;, false);</span>
<a href="#l4.285"></a><span id="l4.285" class="difflineplus">+  }</span>
<a href="#l4.286"></a><span id="l4.286" class="difflineplus">+  </span>
<a href="#l4.287"></a><span id="l4.287" class="difflineplus">+  setPageData(pageData, &quot;login&quot;, &quot;username&quot;, server.username);</span>
<a href="#l4.288"></a><span id="l4.288" class="difflineplus">+  setPageData(pageData, &quot;login&quot;, &quot;password&quot;, server.password);</span>
<a href="#l4.289"></a><span id="l4.289" class="difflineplus">+  setPageData(pageData, &quot;accname&quot;, &quot;prettyName&quot;, server.prettyName);</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineplus">+  setPageData(pageData, &quot;accname&quot;, &quot;userset&quot;, false);</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineplus">+  setPageData(pageData, &quot;ispdata&quot;, &quot;supplied&quot;, false);</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineplus">+  </span>
<a href="#l4.293"></a><span id="l4.293" class="difflineplus">+  var identity;</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+  </span>
<a href="#l4.295"></a><span id="l4.295" class="difflineplus">+  if (accountData.identity) {</span>
<a href="#l4.296"></a><span id="l4.296" class="difflineplus">+      dump(&quot;This is an accountdata\n&quot;);</span>
<a href="#l4.297"></a><span id="l4.297" class="difflineplus">+      identity = accountData.identity;</span>
<a href="#l4.298"></a><span id="l4.298" class="difflineplus">+  }</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineplus">+  else if (accountData.identities) {</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineplus">+      identity = accountData.identities.queryElementAt(0, Components.interfaces.nsIMsgIdentity);</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineplus">+      dump(&quot;this is an account, id= &quot; + identity + &quot;\n&quot;);</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineplus">+  }</span>
<a href="#l4.303"></a><span id="l4.303"> </span>
<a href="#l4.304"></a><span id="l4.304" class="difflineminus">-    var smtp;</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineminus">-    </span>
<a href="#l4.306"></a><span id="l4.306" class="difflineminus">-    if (accountData.smtp) {</span>
<a href="#l4.307"></a><span id="l4.307" class="difflineminus">-        smtp = accountData.smtp;</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineminus">-        setPageData(pageData, &quot;server&quot;, &quot;smtphostname&quot;, smtp.hostname);</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineminus">-        setPageData(pageData, &quot;login&quot;, &quot;smtpusername&quot;, smtp.username);</span>
<a href="#l4.310"></a><span id="l4.310" class="difflineminus">-    }</span>
<a href="#l4.311"></a><span id="l4.311" class="difflineplus">+  setPageData(pageData, &quot;identity&quot;, &quot;email&quot;, identity.email);</span>
<a href="#l4.312"></a><span id="l4.312" class="difflineplus">+  setPageData(pageData, &quot;identity&quot;, &quot;fullName&quot;, identity.fullName);</span>
<a href="#l4.313"></a><span id="l4.313" class="difflineplus">+</span>
<a href="#l4.314"></a><span id="l4.314" class="difflineplus">+  var smtp;</span>
<a href="#l4.315"></a><span id="l4.315" class="difflineplus">+  </span>
<a href="#l4.316"></a><span id="l4.316" class="difflineplus">+  if (accountData.smtp) {</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineplus">+      smtp = accountData.smtp;</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineplus">+      setPageData(pageData, &quot;server&quot;, &quot;smtphostname&quot;, smtp.hostname);</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineplus">+      setPageData(pageData, &quot;login&quot;, &quot;smtpusername&quot;, smtp.username);</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+  }</span>
<a href="#l4.321"></a><span id="l4.321"> }</span>
<a href="#l4.322"></a><span id="l4.322"> </span>
<a href="#l4.323"></a><span id="l4.323"> // take data from each page of pageData and dump it into accountData</span>
<a href="#l4.324"></a><span id="l4.324"> // use: to put results of wizard into a account-oriented object</span>
<a href="#l4.325"></a><span id="l4.325"> function PageDataToAccountData(pageData, accountData)</span>
<a href="#l4.326"></a><span id="l4.326"> {</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineminus">-    if (!accountData.identity)</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineminus">-        accountData.identity = new Object;</span>
<a href="#l4.329"></a><span id="l4.329" class="difflineminus">-    if (!accountData.incomingServer)</span>
<a href="#l4.330"></a><span id="l4.330" class="difflineminus">-        accountData.incomingServer = new Object;</span>
<a href="#l4.331"></a><span id="l4.331" class="difflineminus">-    if (!accountData.smtp)</span>
<a href="#l4.332"></a><span id="l4.332" class="difflineminus">-        accountData.smtp = new Object;</span>
<a href="#l4.333"></a><span id="l4.333" class="difflineminus">-    if (!accountData.pop3)</span>
<a href="#l4.334"></a><span id="l4.334" class="difflineminus">-        accountData.pop3 = new Object;</span>
<a href="#l4.335"></a><span id="l4.335" class="difflineminus">-    if (!accountData.imap)</span>
<a href="#l4.336"></a><span id="l4.336" class="difflineminus">-        accountData.imap = new Object;</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineminus">-    </span>
<a href="#l4.338"></a><span id="l4.338" class="difflineminus">-    var identity = accountData.identity;</span>
<a href="#l4.339"></a><span id="l4.339" class="difflineminus">-    var server = accountData.incomingServer;</span>
<a href="#l4.340"></a><span id="l4.340" class="difflineminus">-    var smtp = accountData.smtp;</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineminus">-    var pop3 = accountData.pop3;</span>
<a href="#l4.342"></a><span id="l4.342" class="difflineminus">-    var imap = accountData.imap;</span>
<a href="#l4.343"></a><span id="l4.343" class="difflineplus">+  if (!accountData.identity)</span>
<a href="#l4.344"></a><span id="l4.344" class="difflineplus">+    accountData.identity = new Object;</span>
<a href="#l4.345"></a><span id="l4.345" class="difflineplus">+  if (!accountData.incomingServer)</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineplus">+    accountData.incomingServer = new Object;</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineplus">+  if (!accountData.smtp)</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+    accountData.smtp = new Object;</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+  if (!accountData.pop3)</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineplus">+    accountData.pop3 = new Object;</span>
<a href="#l4.351"></a><span id="l4.351" class="difflineplus">+  if (!accountData.imap)</span>
<a href="#l4.352"></a><span id="l4.352" class="difflineplus">+    accountData.imap = new Object;</span>
<a href="#l4.353"></a><span id="l4.353" class="difflineplus">+  </span>
<a href="#l4.354"></a><span id="l4.354" class="difflineplus">+  var identity = accountData.identity;</span>
<a href="#l4.355"></a><span id="l4.355" class="difflineplus">+  var server = accountData.incomingServer;</span>
<a href="#l4.356"></a><span id="l4.356" class="difflineplus">+  var smtp = accountData.smtp;</span>
<a href="#l4.357"></a><span id="l4.357" class="difflineplus">+  var pop3 = accountData.pop3;</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineplus">+  var imap = accountData.imap;</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineplus">+</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+  if (pageData.identity.email)</span>
<a href="#l4.361"></a><span id="l4.361" class="difflineplus">+    identity.email = pageData.identity.email.value;</span>
<a href="#l4.362"></a><span id="l4.362" class="difflineplus">+  if (pageData.identity.fullName)</span>
<a href="#l4.363"></a><span id="l4.363" class="difflineplus">+    identity.fullName = pageData.identity.fullName.value;</span>
<a href="#l4.364"></a><span id="l4.364"> </span>
<a href="#l4.365"></a><span id="l4.365" class="difflineminus">-    if (pageData.identity.email)</span>
<a href="#l4.366"></a><span id="l4.366" class="difflineminus">-        identity.email = pageData.identity.email.value;</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-    if (pageData.identity.fullName)</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineminus">-        identity.fullName = pageData.identity.fullName.value;</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineplus">+  server.type = getCurrentServerType(pageData);</span>
<a href="#l4.370"></a><span id="l4.370" class="difflineplus">+  server.hostName = getCurrentHostname(pageData);</span>
<a href="#l4.371"></a><span id="l4.371" class="difflineplus">+  if (getCurrentServerIsDeferred(pageData))</span>
<a href="#l4.372"></a><span id="l4.372" class="difflineplus">+  {</span>
<a href="#l4.373"></a><span id="l4.373" class="difflineplus">+    try</span>
<a href="#l4.374"></a><span id="l4.374" class="difflineplus">+    {</span>
<a href="#l4.375"></a><span id="l4.375" class="difflineplus">+      var accountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l4.376"></a><span id="l4.376" class="difflineplus">+      var localFoldersServer = accountManager.localFoldersServer;</span>
<a href="#l4.377"></a><span id="l4.377" class="difflineplus">+      var localFoldersAccount = accountManager.FindAccountForServer(localFoldersServer);</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineplus">+      pop3.deferredToAccount = localFoldersAccount.key;</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineplus">+      pop3.deferGetNewMail = true;</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineplus">+      server[&quot;ServerType-pop3&quot;] = pop3;</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineplus">+    }</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineplus">+    catch (ex) {dump (&quot;exception setting up deferred account&quot; + ex);}</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineplus">+  }</span>
<a href="#l4.384"></a><span id="l4.384" class="difflineplus">+  if (serverIsNntp(pageData)) {</span>
<a href="#l4.385"></a><span id="l4.385" class="difflineplus">+    // this stuff probably not relevant</span>
<a href="#l4.386"></a><span id="l4.386" class="difflineplus">+    dump(&quot;not setting username/password/etc\n&quot;);</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineplus">+  }</span>
<a href="#l4.388"></a><span id="l4.388" class="difflineplus">+  else {</span>
<a href="#l4.389"></a><span id="l4.389" class="difflineplus">+    if (pageData.login) {</span>
<a href="#l4.390"></a><span id="l4.390" class="difflineplus">+      if (pageData.login.username)</span>
<a href="#l4.391"></a><span id="l4.391" class="difflineplus">+        server.username = pageData.login.username.value;</span>
<a href="#l4.392"></a><span id="l4.392" class="difflineplus">+      if (pageData.login.password)</span>
<a href="#l4.393"></a><span id="l4.393" class="difflineplus">+        server.password = pageData.login.password.value;</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineplus">+      if (pageData.login.smtpusername)</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineplus">+        smtp.username = pageData.login.smtpusername.value;</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineplus">+    }</span>
<a href="#l4.397"></a><span id="l4.397"> </span>
<a href="#l4.398"></a><span id="l4.398" class="difflineminus">-    server.type = getCurrentServerType(pageData);</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineminus">-    server.hostName = getCurrentHostname(pageData);</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineminus">-    if (getCurrentServerIsDeferred(pageData))</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+    dump(&quot;pageData.server = &quot; + pageData.server + &quot;\n&quot;);</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+    if (pageData.server) {</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+      dump(&quot;pageData.server.smtphostname.value = &quot; + pageData.server.smtphostname + &quot;\n&quot;);</span>
<a href="#l4.404"></a><span id="l4.404" class="difflineplus">+      if (pageData.server.smtphostname &amp;&amp;</span>
<a href="#l4.405"></a><span id="l4.405" class="difflineplus">+          pageData.server.smtphostname.value)</span>
<a href="#l4.406"></a><span id="l4.406" class="difflineplus">+        smtp.hostname = pageData.server.smtphostname.value;</span>
<a href="#l4.407"></a><span id="l4.407" class="difflineplus">+    }</span>
<a href="#l4.408"></a><span id="l4.408" class="difflineplus">+    if (pageData.identity &amp;&amp; pageData.identity.smtpServerKey)</span>
<a href="#l4.409"></a><span id="l4.409" class="difflineplus">+      identity.smtpServerKey = pageData.identity.smtpServerKey.value;</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineplus">+</span>
<a href="#l4.411"></a><span id="l4.411" class="difflineplus">+    if (pageData.server.port &amp;&amp;</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineplus">+        pageData.server.port.value)</span>
<a href="#l4.413"></a><span id="l4.413">     {</span>
<a href="#l4.414"></a><span id="l4.414" class="difflineminus">-      try</span>
<a href="#l4.415"></a><span id="l4.415" class="difflineplus">+      if (server.type == 'imap')</span>
<a href="#l4.416"></a><span id="l4.416">       {</span>
<a href="#l4.417"></a><span id="l4.417" class="difflineminus">-        var accountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;].getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l4.418"></a><span id="l4.418" class="difflineminus">-        var localFoldersServer = accountManager.localFoldersServer;</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineminus">-        var localFoldersAccount = accountManager.FindAccountForServer(localFoldersServer);</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineminus">-        pop3.deferredToAccount = localFoldersAccount.key;</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineminus">-        pop3.deferGetNewMail = true;</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+        imap.port = pageData.server.port.value;</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+        server[&quot;ServerType-imap&quot;] = imap;</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+      }</span>
<a href="#l4.425"></a><span id="l4.425" class="difflineplus">+      else if (server.type == 'pop3')</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineplus">+      {</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineplus">+        pop3.port = pageData.server.port.value;</span>
<a href="#l4.428"></a><span id="l4.428">         server[&quot;ServerType-pop3&quot;] = pop3;</span>
<a href="#l4.429"></a><span id="l4.429">       }</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineminus">-      catch (ex) {dump (&quot;exception setting up deferred account&quot; + ex);}</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineminus">-    }</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineminus">-    if (serverIsNntp(pageData)) {</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineminus">-        // this stuff probably not relevant</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineminus">-        dump(&quot;not setting username/password/etc\n&quot;);</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineminus">-    } else {</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineminus">-        if (pageData.login) {</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineminus">-            if (pageData.login.username)</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineminus">-                server.username = pageData.login.username.value;</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineminus">-            if (pageData.login.password)</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineminus">-                server.password = pageData.login.password.value;</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineminus">-            if (pageData.login.smtpusername)</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineminus">-                smtp.username = pageData.login.smtpusername.value;</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineminus">-        }</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineminus">-</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineminus">-        dump(&quot;pageData.server = &quot; + pageData.server + &quot;\n&quot;);</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineminus">-        if (pageData.server) {</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineminus">-            dump(&quot;pageData.server.smtphostname.value = &quot; + pageData.server.smtphostname + &quot;\n&quot;);</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineminus">-            if (pageData.server.smtphostname &amp;&amp;</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineminus">-                pageData.server.smtphostname.value)</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineminus">-                smtp.hostname = pageData.server.smtphostname.value;</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineminus">-        }</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineminus">-        if (pageData.identity &amp;&amp; pageData.identity.smtpServerKey)</span>
<a href="#l4.453"></a><span id="l4.453" class="difflineminus">-            identity.smtpServerKey = pageData.identity.smtpServerKey.value;</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineminus">-</span>
<a href="#l4.455"></a><span id="l4.455" class="difflineminus">-        if (pageData.server.port &amp;&amp;</span>
<a href="#l4.456"></a><span id="l4.456" class="difflineminus">-            pageData.server.port.value)</span>
<a href="#l4.457"></a><span id="l4.457" class="difflineminus">-        {</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineminus">-          if (server.type == 'imap')</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineminus">-          {</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineminus">-            imap.port = pageData.server.port.value;</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineminus">-            server[&quot;ServerType-imap&quot;] = imap;</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineminus">-          }</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineminus">-          else if (server.type == 'pop3')</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineminus">-          {</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineminus">-            pop3.port = pageData.server.port.value;</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineminus">-            server[&quot;ServerType-pop3&quot;] = pop3;</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineminus">-          }</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineminus">-        }</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineminus">-</span>
<a href="#l4.470"></a><span id="l4.470" class="difflineminus">-        if (pageData.server.leaveMessagesOnServer &amp;&amp;</span>
<a href="#l4.471"></a><span id="l4.471" class="difflineminus">-            pageData.server.leaveMessagesOnServer.value)</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineminus">-        {</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineminus">-            pop3.leaveMessagesOnServer = pageData.server.leaveMessagesOnServer.value;</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineminus">-            server[&quot;ServerType-pop3&quot;] = pop3;</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineminus">-        }</span>
<a href="#l4.476"></a><span id="l4.476">     }</span>
<a href="#l4.477"></a><span id="l4.477"> </span>
<a href="#l4.478"></a><span id="l4.478" class="difflineminus">-    if (pageData.accname) {</span>
<a href="#l4.479"></a><span id="l4.479" class="difflineminus">-        if (pageData.accname.prettyName)</span>
<a href="#l4.480"></a><span id="l4.480" class="difflineminus">-            server.prettyName = pageData.accname.prettyName.value;</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineplus">+    if (pageData.server.leaveMessagesOnServer &amp;&amp;</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineplus">+        pageData.server.leaveMessagesOnServer.value)</span>
<a href="#l4.483"></a><span id="l4.483" class="difflineplus">+    {</span>
<a href="#l4.484"></a><span id="l4.484" class="difflineplus">+      pop3.leaveMessagesOnServer = pageData.server.leaveMessagesOnServer.value;</span>
<a href="#l4.485"></a><span id="l4.485" class="difflineplus">+      server[&quot;ServerType-pop3&quot;] = pop3;</span>
<a href="#l4.486"></a><span id="l4.486">     }</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineplus">+  }</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineplus">+</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineplus">+  if (pageData.accname) {</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineplus">+    if (pageData.accname.prettyName)</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineplus">+      server.prettyName = pageData.accname.prettyName.value;</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineplus">+  }</span>
<a href="#l4.493"></a><span id="l4.493"> </span>
<a href="#l4.494"></a><span id="l4.494"> }</span>
<a href="#l4.495"></a><span id="l4.495"> </span>
<a href="#l4.496"></a><span id="l4.496"> // given an accountData structure, create an account</span>
<a href="#l4.497"></a><span id="l4.497"> // (but don't fill in any fields, that's for finishAccount()</span>
<a href="#l4.498"></a><span id="l4.498"> function createAccount(accountData)</span>
<a href="#l4.499"></a><span id="l4.499"> {</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineminus">-    // Retrieve the server (data) from the account data.</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineminus">-    var server = accountData.incomingServer;</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineminus">-    </span>
<a href="#l4.503"></a><span id="l4.503" class="difflineminus">-    // for news, username is always null</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineminus">-    var username = (server.type == &quot;nntp&quot;) ? null : server.username;</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineminus">-    dump(&quot;am.createIncomingServer(&quot; +</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineminus">-         username + &quot;, &quot; + server.hostName + &quot;, &quot; + server.type + &quot;)\n&quot;);</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineminus">-    // Create a (actual) server.</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineminus">-    server = am.createIncomingServer(username, server.hostName, server.type);</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineplus">+  // Retrieve the server (data) from the account data.</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineplus">+  var server = accountData.incomingServer;</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineplus">+  </span>
<a href="#l4.512"></a><span id="l4.512" class="difflineplus">+  // for news, username is always null</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineplus">+  var username = (server.type == &quot;nntp&quot;) ? null : server.username;</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineplus">+  dump(&quot;am.createIncomingServer(&quot; +</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineplus">+       username + &quot;, &quot; + server.hostName + &quot;, &quot; + server.type + &quot;)\n&quot;);</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineplus">+  // Create a (actual) server.</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineplus">+  server = am.createIncomingServer(username, server.hostName, server.type);</span>
<a href="#l4.518"></a><span id="l4.518"> </span>
<a href="#l4.519"></a><span id="l4.519" class="difflineminus">-    dump(&quot;am.createAccount()\n&quot;);</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineminus">-    // Create an account.</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineminus">-    var account = am.createAccount();</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineminus">-    </span>
<a href="#l4.523"></a><span id="l4.523" class="difflineminus">-    // only create an identity for this account if we really have one</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineminus">-    // (use the email address as a check)</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineminus">-    if (accountData.identity &amp;&amp; accountData.identity.email)</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineminus">-    {</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineminus">-        dump(&quot;am.createIdentity()\n&quot;);</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineminus">-        // Create an identity.</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineminus">-        var identity = am.createIdentity();</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineminus">-    </span>
<a href="#l4.531"></a><span id="l4.531" class="difflineminus">-        // New nntp identities should use plain text by default;</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineminus">-        // we want that GNKSA (The Good Net-Keeping Seal of Approval).</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineminus">-        if (server.type == &quot;nntp&quot;)</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineminus">-          identity.composeHtml = false;</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineplus">+  dump(&quot;am.createAccount()\n&quot;);</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineplus">+  // Create an account.</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineplus">+  var account = am.createAccount();</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineplus">+  </span>
<a href="#l4.539"></a><span id="l4.539" class="difflineplus">+  // only create an identity for this account if we really have one</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineplus">+  // (use the email address as a check)</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineplus">+  if (accountData.identity &amp;&amp; accountData.identity.email)</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineplus">+  {</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineplus">+    dump(&quot;am.createIdentity()\n&quot;);</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineplus">+    // Create an identity.</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineplus">+    var identity = am.createIdentity();</span>
<a href="#l4.546"></a><span id="l4.546"> </span>
<a href="#l4.547"></a><span id="l4.547" class="difflineminus">-        account.addIdentity(identity);</span>
<a href="#l4.548"></a><span id="l4.548" class="difflineminus">-    }</span>
<a href="#l4.549"></a><span id="l4.549" class="difflineplus">+    // New nntp identities should use plain text by default;</span>
<a href="#l4.550"></a><span id="l4.550" class="difflineplus">+    // we want that GNKSA (The Good Net-Keeping Seal of Approval).</span>
<a href="#l4.551"></a><span id="l4.551" class="difflineplus">+    if (server.type == &quot;nntp&quot;)</span>
<a href="#l4.552"></a><span id="l4.552" class="difflineplus">+      identity.composeHtml = false;</span>
<a href="#l4.553"></a><span id="l4.553" class="difflineplus">+</span>
<a href="#l4.554"></a><span id="l4.554" class="difflineplus">+    account.addIdentity(identity);</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineplus">+  }</span>
<a href="#l4.556"></a><span id="l4.556"> </span>
<a href="#l4.557"></a><span id="l4.557" class="difflineminus">-    // we mark the server as invalid so that the account manager won't</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineminus">-    // tell RDF about the new server - it's not quite finished getting</span>
<a href="#l4.559"></a><span id="l4.559" class="difflineminus">-    // set up yet, in particular, the deferred storage pref hasn't been set.</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineminus">-    server.valid = false;</span>
<a href="#l4.561"></a><span id="l4.561" class="difflineminus">-    // Set the new account to use the new server.</span>
<a href="#l4.562"></a><span id="l4.562" class="difflineminus">-    account.incomingServer = server;</span>
<a href="#l4.563"></a><span id="l4.563" class="difflineminus">-    server.valid = true;</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineminus">-    return account;</span>
<a href="#l4.565"></a><span id="l4.565" class="difflineplus">+  // we mark the server as invalid so that the account manager won't</span>
<a href="#l4.566"></a><span id="l4.566" class="difflineplus">+  // tell RDF about the new server - it's not quite finished getting</span>
<a href="#l4.567"></a><span id="l4.567" class="difflineplus">+  // set up yet, in particular, the deferred storage pref hasn't been set.</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineplus">+  server.valid = false;</span>
<a href="#l4.569"></a><span id="l4.569" class="difflineplus">+  // Set the new account to use the new server.</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineplus">+  account.incomingServer = server;</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineplus">+  server.valid = true;</span>
<a href="#l4.572"></a><span id="l4.572" class="difflineplus">+  return account;</span>
<a href="#l4.573"></a><span id="l4.573"> }</span>
<a href="#l4.574"></a><span id="l4.574"> </span>
<a href="#l4.575"></a><span id="l4.575"> // given an accountData structure, copy the data into the</span>
<a href="#l4.576"></a><span id="l4.576"> // given account, incoming server, and so forth</span>
<a href="#l4.577"></a><span id="l4.577"> function finishAccount(account, accountData) </span>
<a href="#l4.578"></a><span id="l4.578"> {</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineminus">-    if (accountData.incomingServer) {</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineplus">+  if (accountData.incomingServer) {</span>
<a href="#l4.581"></a><span id="l4.581"> </span>
<a href="#l4.582"></a><span id="l4.582" class="difflineminus">-        var destServer = account.incomingServer;</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineminus">-        var srcServer = accountData.incomingServer;</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineminus">-        copyObjectToInterface(destServer, srcServer, true);</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineplus">+    var destServer = account.incomingServer;</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineplus">+    var srcServer = accountData.incomingServer;</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineplus">+    copyObjectToInterface(destServer, srcServer, true);</span>
<a href="#l4.588"></a><span id="l4.588"> </span>
<a href="#l4.589"></a><span id="l4.589" class="difflineminus">-        // see if there are any protocol-specific attributes</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineminus">-        // if so, we use the type to get the IID, QueryInterface</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineminus">-        // as appropriate, then copy the data over</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineminus">-        dump(&quot;srcServer.ServerType-&quot; + srcServer.type + &quot; = &quot; +</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineminus">-             srcServer[&quot;ServerType-&quot; + srcServer.type] + &quot;\n&quot;);</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineminus">-        if (srcServer[&quot;ServerType-&quot; + srcServer.type]) {</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineminus">-            // handle server-specific stuff</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineminus">-            var IID = getInterfaceForType(srcServer.type);</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineminus">-            if (IID) {</span>
<a href="#l4.598"></a><span id="l4.598" class="difflineminus">-                destProtocolServer = destServer.QueryInterface(IID);</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineminus">-                srcProtocolServer = srcServer[&quot;ServerType-&quot; + srcServer.type];</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineplus">+    // see if there are any protocol-specific attributes</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineplus">+    // if so, we use the type to get the IID, QueryInterface</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineplus">+    // as appropriate, then copy the data over</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineplus">+    dump(&quot;srcServer.ServerType-&quot; + srcServer.type + &quot; = &quot; +</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineplus">+         srcServer[&quot;ServerType-&quot; + srcServer.type] + &quot;\n&quot;);</span>
<a href="#l4.605"></a><span id="l4.605" class="difflineplus">+    if (srcServer[&quot;ServerType-&quot; + srcServer.type]) {</span>
<a href="#l4.606"></a><span id="l4.606" class="difflineplus">+      // handle server-specific stuff</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineplus">+      var IID = getInterfaceForType(srcServer.type);</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineplus">+      if (IID) {</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineplus">+        destProtocolServer = destServer.QueryInterface(IID);</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineplus">+        srcProtocolServer = srcServer[&quot;ServerType-&quot; + srcServer.type];</span>
<a href="#l4.611"></a><span id="l4.611"> </span>
<a href="#l4.612"></a><span id="l4.612" class="difflineminus">-                dump(&quot;Copying over &quot; + srcServer.type + &quot;-specific data\n&quot;);</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineminus">-                copyObjectToInterface(destProtocolServer, srcProtocolServer, false);</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineminus">-            }</span>
<a href="#l4.615"></a><span id="l4.615" class="difflineminus">-        }</span>
<a href="#l4.616"></a><span id="l4.616" class="difflineminus">-          </span>
<a href="#l4.617"></a><span id="l4.617" class="difflineminus">-        account.incomingServer.valid=true;</span>
<a href="#l4.618"></a><span id="l4.618" class="difflineminus">-        // hack to cause an account loaded notification now the server is valid</span>
<a href="#l4.619"></a><span id="l4.619" class="difflineminus">-        account.incomingServer = account.incomingServer;</span>
<a href="#l4.620"></a><span id="l4.620" class="difflineplus">+        dump(&quot;Copying over &quot; + srcServer.type + &quot;-specific data\n&quot;);</span>
<a href="#l4.621"></a><span id="l4.621" class="difflineplus">+        copyObjectToInterface(destProtocolServer, srcProtocolServer, false);</span>
<a href="#l4.622"></a><span id="l4.622" class="difflineplus">+      }</span>
<a href="#l4.623"></a><span id="l4.623">     }</span>
<a href="#l4.624"></a><span id="l4.624" class="difflineplus">+      </span>
<a href="#l4.625"></a><span id="l4.625" class="difflineplus">+    account.incomingServer.valid=true;</span>
<a href="#l4.626"></a><span id="l4.626" class="difflineplus">+    // hack to cause an account loaded notification now the server is valid</span>
<a href="#l4.627"></a><span id="l4.627" class="difflineplus">+    account.incomingServer = account.incomingServer;</span>
<a href="#l4.628"></a><span id="l4.628" class="difflineplus">+  }</span>
<a href="#l4.629"></a><span id="l4.629"> </span>
<a href="#l4.630"></a><span id="l4.630" class="difflineminus">-    // copy identity info</span>
<a href="#l4.631"></a><span id="l4.631" class="difflineminus">-    var destIdentity = account.identities.length ?</span>
<a href="#l4.632"></a><span id="l4.632" class="difflineminus">-                       account.identities.queryElementAt(0, nsIMsgIdentity) :</span>
<a href="#l4.633"></a><span id="l4.633" class="difflineminus">-                       null;</span>
<a href="#l4.634"></a><span id="l4.634" class="difflineplus">+  // copy identity info</span>
<a href="#l4.635"></a><span id="l4.635" class="difflineplus">+  var destIdentity = account.identities.length ?</span>
<a href="#l4.636"></a><span id="l4.636" class="difflineplus">+                     account.identities.queryElementAt(0, nsIMsgIdentity) :</span>
<a href="#l4.637"></a><span id="l4.637" class="difflineplus">+                     null;</span>
<a href="#l4.638"></a><span id="l4.638"> </span>
<a href="#l4.639"></a><span id="l4.639" class="difflineminus">-    if (destIdentity) // does this account have an identity?</span>
<a href="#l4.640"></a><span id="l4.640" class="difflineminus">-    {   </span>
<a href="#l4.641"></a><span id="l4.641" class="difflineminus">-        if (accountData.identity &amp;&amp; accountData.identity.email) {</span>
<a href="#l4.642"></a><span id="l4.642" class="difflineminus">-            // fixup the email address if we have a default domain</span>
<a href="#l4.643"></a><span id="l4.643" class="difflineminus">-            var emailArray = accountData.identity.email.split('@');</span>
<a href="#l4.644"></a><span id="l4.644" class="difflineminus">-            if (emailArray.length &lt; 2 &amp;&amp; accountData.domain) {</span>
<a href="#l4.645"></a><span id="l4.645" class="difflineminus">-                accountData.identity.email += '@' + accountData.domain;</span>
<a href="#l4.646"></a><span id="l4.646" class="difflineminus">-            }</span>
<a href="#l4.647"></a><span id="l4.647" class="difflineplus">+  if (destIdentity) // does this account have an identity?</span>
<a href="#l4.648"></a><span id="l4.648" class="difflineplus">+  {   </span>
<a href="#l4.649"></a><span id="l4.649" class="difflineplus">+      if (accountData.identity &amp;&amp; accountData.identity.email) {</span>
<a href="#l4.650"></a><span id="l4.650" class="difflineplus">+          // fixup the email address if we have a default domain</span>
<a href="#l4.651"></a><span id="l4.651" class="difflineplus">+          var emailArray = accountData.identity.email.split('@');</span>
<a href="#l4.652"></a><span id="l4.652" class="difflineplus">+          if (emailArray.length &lt; 2 &amp;&amp; accountData.domain) {</span>
<a href="#l4.653"></a><span id="l4.653" class="difflineplus">+              accountData.identity.email += '@' + accountData.domain;</span>
<a href="#l4.654"></a><span id="l4.654" class="difflineplus">+          }</span>
<a href="#l4.655"></a><span id="l4.655"> </span>
<a href="#l4.656"></a><span id="l4.656" class="difflineminus">-            copyObjectToInterface(destIdentity, accountData.identity, true);</span>
<a href="#l4.657"></a><span id="l4.657" class="difflineminus">-            destIdentity.valid=true;</span>
<a href="#l4.658"></a><span id="l4.658" class="difflineminus">-        }</span>
<a href="#l4.659"></a><span id="l4.659" class="difflineplus">+          copyObjectToInterface(destIdentity, accountData.identity, true);</span>
<a href="#l4.660"></a><span id="l4.660" class="difflineplus">+          destIdentity.valid=true;</span>
<a href="#l4.661"></a><span id="l4.661" class="difflineplus">+      }</span>
<a href="#l4.662"></a><span id="l4.662"> </span>
<a href="#l4.663"></a><span id="l4.663" class="difflineminus">-        /**</span>
<a href="#l4.664"></a><span id="l4.664" class="difflineminus">-         * If signature file need to be set, get the path to the signature file.</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineminus">-         * Signature files, if exist, are placed under default location. Get</span>
<a href="#l4.666"></a><span id="l4.666" class="difflineminus">-         * default files location for messenger using directory service. Signature </span>
<a href="#l4.667"></a><span id="l4.667" class="difflineminus">-         * file name should be extracted from the account data to build the complete</span>
<a href="#l4.668"></a><span id="l4.668" class="difflineminus">-         * path for signature file. Once the path is built, set the identity's signature pref.</span>
<a href="#l4.669"></a><span id="l4.669" class="difflineminus">-         */</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineminus">-        if (destIdentity.attachSignature)</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineminus">-        {</span>
<a href="#l4.672"></a><span id="l4.672" class="difflineminus">-            var sigFileName = accountData.signatureFileName;</span>
<a href="#l4.673"></a><span id="l4.673" class="difflineminus">-            var sigFile = gMailSession.getDataFilesDir(&quot;messenger&quot;);</span>
<a href="#l4.674"></a><span id="l4.674" class="difflineminus">-            sigFile.append(sigFileName);</span>
<a href="#l4.675"></a><span id="l4.675" class="difflineminus">-            destIdentity.signature = sigFile;</span>
<a href="#l4.676"></a><span id="l4.676" class="difflineminus">-        }</span>
<a href="#l4.677"></a><span id="l4.677" class="difflineplus">+      /**</span>
<a href="#l4.678"></a><span id="l4.678" class="difflineplus">+       * If signature file need to be set, get the path to the signature file.</span>
<a href="#l4.679"></a><span id="l4.679" class="difflineplus">+       * Signature files, if exist, are placed under default location. Get</span>
<a href="#l4.680"></a><span id="l4.680" class="difflineplus">+       * default files location for messenger using directory service. Signature </span>
<a href="#l4.681"></a><span id="l4.681" class="difflineplus">+       * file name should be extracted from the account data to build the complete</span>
<a href="#l4.682"></a><span id="l4.682" class="difflineplus">+       * path for signature file. Once the path is built, set the identity's signature pref.</span>
<a href="#l4.683"></a><span id="l4.683" class="difflineplus">+       */</span>
<a href="#l4.684"></a><span id="l4.684" class="difflineplus">+      if (destIdentity.attachSignature)</span>
<a href="#l4.685"></a><span id="l4.685" class="difflineplus">+      {</span>
<a href="#l4.686"></a><span id="l4.686" class="difflineplus">+          var sigFileName = accountData.signatureFileName;</span>
<a href="#l4.687"></a><span id="l4.687" class="difflineplus">+          var sigFile = gMailSession.getDataFilesDir(&quot;messenger&quot;);</span>
<a href="#l4.688"></a><span id="l4.688" class="difflineplus">+          sigFile.append(sigFileName);</span>
<a href="#l4.689"></a><span id="l4.689" class="difflineplus">+          destIdentity.signature = sigFile;</span>
<a href="#l4.690"></a><span id="l4.690" class="difflineplus">+      }</span>
<a href="#l4.691"></a><span id="l4.691"> </span>
<a href="#l4.692"></a><span id="l4.692" class="difflineminus">-        if (accountData.smtp.hostname &amp;&amp; !destIdentity.smtpServerKey)</span>
<a href="#l4.693"></a><span id="l4.693" class="difflineminus">-        {</span>
<a href="#l4.694"></a><span id="l4.694" class="difflineminus">-            // hostname + no key =&gt; create a new SMTP server.</span>
<a href="#l4.695"></a><span id="l4.695" class="difflineplus">+      if (accountData.smtp.hostname &amp;&amp; !destIdentity.smtpServerKey)</span>
<a href="#l4.696"></a><span id="l4.696" class="difflineplus">+      {</span>
<a href="#l4.697"></a><span id="l4.697" class="difflineplus">+          // hostname + no key =&gt; create a new SMTP server.</span>
<a href="#l4.698"></a><span id="l4.698"> </span>
<a href="#l4.699"></a><span id="l4.699" class="difflineminus">-            var smtpServer = smtpService.createSmtpServer();</span>
<a href="#l4.700"></a><span id="l4.700" class="difflineminus">-            var isDefaultSmtpServer;</span>
<a href="#l4.701"></a><span id="l4.701" class="difflineminus">-            if (!smtpService.defaultServer.hostname) {</span>
<a href="#l4.702"></a><span id="l4.702" class="difflineminus">-              smtpService.defaultServer = smtpServer;</span>
<a href="#l4.703"></a><span id="l4.703" class="difflineminus">-              isDefaultSmtpServer = true;</span>
<a href="#l4.704"></a><span id="l4.704" class="difflineminus">-            }</span>
<a href="#l4.705"></a><span id="l4.705" class="difflineplus">+          var smtpServer = smtpService.createSmtpServer();</span>
<a href="#l4.706"></a><span id="l4.706" class="difflineplus">+          var isDefaultSmtpServer;</span>
<a href="#l4.707"></a><span id="l4.707" class="difflineplus">+          if (!smtpService.defaultServer.hostname) {</span>
<a href="#l4.708"></a><span id="l4.708" class="difflineplus">+            smtpService.defaultServer = smtpServer;</span>
<a href="#l4.709"></a><span id="l4.709" class="difflineplus">+            isDefaultSmtpServer = true;</span>
<a href="#l4.710"></a><span id="l4.710" class="difflineplus">+          }</span>
<a href="#l4.711"></a><span id="l4.711"> </span>
<a href="#l4.712"></a><span id="l4.712" class="difflineminus">-            copyObjectToInterface(smtpServer, accountData.smtp, false);</span>
<a href="#l4.713"></a><span id="l4.713" class="difflineplus">+          copyObjectToInterface(smtpServer, accountData.smtp, false);</span>
<a href="#l4.714"></a><span id="l4.714"> </span>
<a href="#l4.715"></a><span id="l4.715" class="difflineminus">-            // If it's the default server we created, make the identity use</span>
<a href="#l4.716"></a><span id="l4.716" class="difflineminus">-            // &quot;Use Default&quot; by default.</span>
<a href="#l4.717"></a><span id="l4.717" class="difflineminus">-            destIdentity.smtpServerKey =</span>
<a href="#l4.718"></a><span id="l4.718" class="difflineminus">-              (isDefaultSmtpServer) ? &quot;&quot; : smtpServer.key;</span>
<a href="#l4.719"></a><span id="l4.719" class="difflineminus">-         }</span>
<a href="#l4.720"></a><span id="l4.720" class="difflineminus">-     } // if the account has an identity...</span>
<a href="#l4.721"></a><span id="l4.721" class="difflineplus">+          // If it's the default server we created, make the identity use</span>
<a href="#l4.722"></a><span id="l4.722" class="difflineplus">+          // &quot;Use Default&quot; by default.</span>
<a href="#l4.723"></a><span id="l4.723" class="difflineplus">+          destIdentity.smtpServerKey =</span>
<a href="#l4.724"></a><span id="l4.724" class="difflineplus">+            (isDefaultSmtpServer) ? &quot;&quot; : smtpServer.key;</span>
<a href="#l4.725"></a><span id="l4.725" class="difflineplus">+       }</span>
<a href="#l4.726"></a><span id="l4.726" class="difflineplus">+   } // if the account has an identity...</span>
<a href="#l4.727"></a><span id="l4.727"> </span>
<a href="#l4.728"></a><span id="l4.728" class="difflineminus">-     if (this.FinishAccountHook != undefined) {</span>
<a href="#l4.729"></a><span id="l4.729" class="difflineminus">-         FinishAccountHook(accountData.domain);</span>
<a href="#l4.730"></a><span id="l4.730" class="difflineminus">-     }</span>
<a href="#l4.731"></a><span id="l4.731" class="difflineplus">+   if (this.FinishAccountHook != undefined) {</span>
<a href="#l4.732"></a><span id="l4.732" class="difflineplus">+       FinishAccountHook(accountData.domain);</span>
<a href="#l4.733"></a><span id="l4.733" class="difflineplus">+   }</span>
<a href="#l4.734"></a><span id="l4.734"> }</span>
<a href="#l4.735"></a><span id="l4.735"> </span>
<a href="#l4.736"></a><span id="l4.736"> // Helper method used by copyObjectToInterface which attempts to set dest[attribute] as a generic</span>
<a href="#l4.737"></a><span id="l4.737"> // attribute on the xpconnect object, src.</span>
<a href="#l4.738"></a><span id="l4.738"> // This routine skips any attribute that begins with ServerType- </span>
<a href="#l4.739"></a><span id="l4.739"> function setGenericAttribute(dest, src, attribute)</span>
<a href="#l4.740"></a><span id="l4.740"> {</span>
<a href="#l4.741"></a><span id="l4.741" class="difflineminus">-  if (!(/^ServerType-/i.test(attribute)) &amp;&amp; src[attribute])</span>
<a href="#l4.742"></a><span id="l4.742" class="difflineplus">+  if (!(attribute.toLowerCase().startsWith(&quot;servertype-&quot;)) &amp;&amp; src[attribute])</span>
<a href="#l4.743"></a><span id="l4.743">   {</span>
<a href="#l4.744"></a><span id="l4.744">     switch (typeof src[attribute])</span>
<a href="#l4.745"></a><span id="l4.745">     {</span>
<a href="#l4.746"></a><span id="l4.746">       case &quot;string&quot;:</span>
<a href="#l4.747"></a><span id="l4.747">         dest.setUnicharAttribute(attribute, src[attribute]);</span>
<a href="#l4.748"></a><span id="l4.748">         break;</span>
<a href="#l4.749"></a><span id="l4.749">       case &quot;boolean&quot;:</span>
<a href="#l4.750"></a><span id="l4.750">         dest.setBoolAttribute(attribute, src[attribute]);</span>
<a href="#l4.751"></a><span id="l4.751" class="difflineat">@@ -593,17 +592,17 @@ function verifyLocalFoldersAccount()</span>
<a href="#l4.752"></a><span id="l4.752">       // creates a copy of the identity you pass in</span>
<a href="#l4.753"></a><span id="l4.753">       am.createLocalMailAccount();</span>
<a href="#l4.754"></a><span id="l4.754">       try {</span>
<a href="#l4.755"></a><span id="l4.755">         localMailServer = am.localFoldersServer;</span>
<a href="#l4.756"></a><span id="l4.756">       }</span>
<a href="#l4.757"></a><span id="l4.757">       catch (ex) {</span>
<a href="#l4.758"></a><span id="l4.758">         dump(&quot;error!  we should have found the local mail server after we created it.\n&quot;);</span>
<a href="#l4.759"></a><span id="l4.759">         localMailServer = null;</span>
<a href="#l4.760"></a><span id="l4.760" class="difflineminus">-      }	</span>
<a href="#l4.761"></a><span id="l4.761" class="difflineplus">+      }</span>
<a href="#l4.762"></a><span id="l4.762">     }</span>
<a href="#l4.763"></a><span id="l4.763">   }</span>
<a href="#l4.764"></a><span id="l4.764">   catch (ex) {dump(&quot;Error in verifyLocalFoldersAccount&quot; + ex + &quot;\n&quot;);  }</span>
<a href="#l4.765"></a><span id="l4.765"> </span>
<a href="#l4.766"></a><span id="l4.766"> }</span>
<a href="#l4.767"></a><span id="l4.767"> </span>
<a href="#l4.768"></a><span id="l4.768"> function setupCopiesAndFoldersServer(account, accountIsDeferred, accountData)</span>
<a href="#l4.769"></a><span id="l4.769"> {</span>
<a href="#l4.770"></a><span id="l4.770" class="difflineat">@@ -644,26 +643,26 @@ function setupCopiesAndFoldersServer(acc</span>
<a href="#l4.771"></a><span id="l4.771">   }</span>
<a href="#l4.772"></a><span id="l4.772">   return true;</span>
<a href="#l4.773"></a><span id="l4.773"> }</span>
<a href="#l4.774"></a><span id="l4.774"> </span>
<a href="#l4.775"></a><span id="l4.775"> function setDefaultCopiesAndFoldersPrefs(identity, server, accountData)</span>
<a href="#l4.776"></a><span id="l4.776"> {</span>
<a href="#l4.777"></a><span id="l4.777">   var rootFolder = server.rootFolder;</span>
<a href="#l4.778"></a><span id="l4.778"> </span>
<a href="#l4.779"></a><span id="l4.779" class="difflineminus">-	// we need to do this or it is possible that the server's draft,</span>
<a href="#l4.780"></a><span id="l4.780" class="difflineminus">-	// stationery fcc folder will not be in rdf</span>
<a href="#l4.781"></a><span id="l4.781" class="difflineminus">-	//</span>
<a href="#l4.782"></a><span id="l4.782" class="difflineminus">-	// this can happen in a couple cases</span>
<a href="#l4.783"></a><span id="l4.783" class="difflineminus">-	// 1) the first account we create, creates the local mail.  since</span>
<a href="#l4.784"></a><span id="l4.784" class="difflineplus">+  // we need to do this or it is possible that the server's draft,</span>
<a href="#l4.785"></a><span id="l4.785" class="difflineplus">+  // stationery fcc folder will not be in rdf</span>
<a href="#l4.786"></a><span id="l4.786" class="difflineplus">+  //</span>
<a href="#l4.787"></a><span id="l4.787" class="difflineplus">+  // this can happen in a couple cases</span>
<a href="#l4.788"></a><span id="l4.788" class="difflineplus">+  // 1) the first account we create, creates the local mail.  since</span>
<a href="#l4.789"></a><span id="l4.789">   // local mail was just created, it obviously hasn't been opened,</span>
<a href="#l4.790"></a><span id="l4.790">   // or in rdf..</span>
<a href="#l4.791"></a><span id="l4.791" class="difflineminus">-	// 2) the account we created is of a type where</span>
<a href="#l4.792"></a><span id="l4.792" class="difflineplus">+  // 2) the account we created is of a type where</span>
<a href="#l4.793"></a><span id="l4.793">   // defaultCopiesAndFoldersPrefsToServer is true</span>
<a href="#l4.794"></a><span id="l4.794" class="difflineminus">-	// this since we are creating the server, it obviously hasn't been</span>
<a href="#l4.795"></a><span id="l4.795" class="difflineplus">+  // this since we are creating the server, it obviously hasn't been</span>
<a href="#l4.796"></a><span id="l4.796">   // opened, or in rdf.</span>
<a href="#l4.797"></a><span id="l4.797">   //</span>
<a href="#l4.798"></a><span id="l4.798">   // this makes the assumption that the server's draft, stationery fcc folder</span>
<a href="#l4.799"></a><span id="l4.799">   // are at the top level (ie subfolders of the root folder.)  this works</span>
<a href="#l4.800"></a><span id="l4.800">   // because we happen to be doing things that way, and if the user changes</span>
<a href="#l4.801"></a><span id="l4.801">   // that, it will work because to change the folder, it must be in rdf,</span>
<a href="#l4.802"></a><span id="l4.802">   // coming from the folder cache, in the worst case.</span>
<a href="#l4.803"></a><span id="l4.803">   var msgFolder = rootFolder.QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l4.804"></a><span id="l4.804" class="difflineat">@@ -709,67 +708,67 @@ function AccountExists(userName,hostName</span>
<a href="#l4.805"></a><span id="l4.805">   var accountManager = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l4.806"></a><span id="l4.806">                                  .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l4.807"></a><span id="l4.807"> </span>
<a href="#l4.808"></a><span id="l4.808">   return accountManager.findRealServer(userName, hostName, serverType, 0);</span>
<a href="#l4.809"></a><span id="l4.809"> }</span>
<a href="#l4.810"></a><span id="l4.810"> </span>
<a href="#l4.811"></a><span id="l4.811"> function getFirstInvalidAccount()</span>
<a href="#l4.812"></a><span id="l4.812"> {</span>
<a href="#l4.813"></a><span id="l4.813" class="difflineminus">-    var am = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l4.814"></a><span id="l4.814" class="difflineminus">-                       .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l4.815"></a><span id="l4.815" class="difflineplus">+  var am = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l4.816"></a><span id="l4.816" class="difflineplus">+                     .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l4.817"></a><span id="l4.817"> </span>
<a href="#l4.818"></a><span id="l4.818" class="difflineminus">-    var invalidAccounts = getInvalidAccounts(am.accounts);</span>
<a href="#l4.819"></a><span id="l4.819" class="difflineplus">+  var invalidAccounts = getInvalidAccounts(am.accounts);</span>
<a href="#l4.820"></a><span id="l4.820"> </span>
<a href="#l4.821"></a><span id="l4.821" class="difflineminus">-    if (invalidAccounts.length &gt; 0)</span>
<a href="#l4.822"></a><span id="l4.822" class="difflineminus">-        return invalidAccounts[0];</span>
<a href="#l4.823"></a><span id="l4.823" class="difflineminus">-    else</span>
<a href="#l4.824"></a><span id="l4.824" class="difflineminus">-        return null;</span>
<a href="#l4.825"></a><span id="l4.825" class="difflineplus">+  if (invalidAccounts.length &gt; 0)</span>
<a href="#l4.826"></a><span id="l4.826" class="difflineplus">+    return invalidAccounts[0];</span>
<a href="#l4.827"></a><span id="l4.827" class="difflineplus">+  else</span>
<a href="#l4.828"></a><span id="l4.828" class="difflineplus">+    return null;</span>
<a href="#l4.829"></a><span id="l4.829"> }</span>
<a href="#l4.830"></a><span id="l4.830"> </span>
<a href="#l4.831"></a><span id="l4.831"> function checkForInvalidAccounts()</span>
<a href="#l4.832"></a><span id="l4.832"> {</span>
<a href="#l4.833"></a><span id="l4.833" class="difflineminus">-	var firstInvalidAccount = getFirstInvalidAccount();</span>
<a href="#l4.834"></a><span id="l4.834" class="difflineplus">+  var firstInvalidAccount = getFirstInvalidAccount();</span>
<a href="#l4.835"></a><span id="l4.835"> </span>
<a href="#l4.836"></a><span id="l4.836" class="difflineminus">-    if (firstInvalidAccount) {</span>
<a href="#l4.837"></a><span id="l4.837" class="difflineminus">-        var pageData = GetPageData();</span>
<a href="#l4.838"></a><span id="l4.838" class="difflineminus">-        dump(&quot;We have an invalid account, &quot; + firstInvalidAccount + &quot;, let's use that!\n&quot;);</span>
<a href="#l4.839"></a><span id="l4.839" class="difflineminus">-        gCurrentAccount = firstInvalidAccount;</span>
<a href="#l4.840"></a><span id="l4.840" class="difflineplus">+  if (firstInvalidAccount) {</span>
<a href="#l4.841"></a><span id="l4.841" class="difflineplus">+    var pageData = GetPageData();</span>
<a href="#l4.842"></a><span id="l4.842" class="difflineplus">+    dump(&quot;We have an invalid account, &quot; + firstInvalidAccount + &quot;, let's use that!\n&quot;);</span>
<a href="#l4.843"></a><span id="l4.843" class="difflineplus">+    gCurrentAccount = firstInvalidAccount;</span>
<a href="#l4.844"></a><span id="l4.844"> </span>
<a href="#l4.845"></a><span id="l4.845" class="difflineminus">-        // there's a possibility that the invalid account has ISP defaults</span>
<a href="#l4.846"></a><span id="l4.846" class="difflineminus">-        // as well.. so first pre-fill accountData with ISP info, then</span>
<a href="#l4.847"></a><span id="l4.847" class="difflineminus">-        // overwrite it with the account data</span>
<a href="#l4.848"></a><span id="l4.848" class="difflineplus">+    // there's a possibility that the invalid account has ISP defaults</span>
<a href="#l4.849"></a><span id="l4.849" class="difflineplus">+    // as well.. so first pre-fill accountData with ISP info, then</span>
<a href="#l4.850"></a><span id="l4.850" class="difflineplus">+    // overwrite it with the account data</span>
<a href="#l4.851"></a><span id="l4.851"> </span>
<a href="#l4.852"></a><span id="l4.852"> </span>
<a href="#l4.853"></a><span id="l4.853" class="difflineminus">-        var identity =</span>
<a href="#l4.854"></a><span id="l4.854" class="difflineminus">-            firstInvalidAccount.identities.queryElementAt(0, nsIMsgIdentity);</span>
<a href="#l4.855"></a><span id="l4.855" class="difflineplus">+    var identity =</span>
<a href="#l4.856"></a><span id="l4.856" class="difflineplus">+      firstInvalidAccount.identities.queryElementAt(0, nsIMsgIdentity);</span>
<a href="#l4.857"></a><span id="l4.857"> </span>
<a href="#l4.858"></a><span id="l4.858" class="difflineminus">-        var accountData = null;</span>
<a href="#l4.859"></a><span id="l4.859" class="difflineminus">-        // If there is a email address already provided, try to get to other ISP defaults.</span>
<a href="#l4.860"></a><span id="l4.860" class="difflineminus">-        // If not, get pre-configured data, if any.</span>
<a href="#l4.861"></a><span id="l4.861" class="difflineminus">-        if (identity.email) {</span>
<a href="#l4.862"></a><span id="l4.862" class="difflineminus">-          dump(&quot;Invalid account: trying to get ISP data for &quot; + identity.email + &quot;\n&quot;);</span>
<a href="#l4.863"></a><span id="l4.863" class="difflineminus">-          accountData = getIspDefaultsForEmail(identity.email);</span>
<a href="#l4.864"></a><span id="l4.864" class="difflineminus">-          dump(&quot;Invalid account: Got &quot; + accountData + &quot;\n&quot;);</span>
<a href="#l4.865"></a><span id="l4.865" class="difflineplus">+    var accountData = null;</span>
<a href="#l4.866"></a><span id="l4.866" class="difflineplus">+    // If there is a email address already provided, try to get to other ISP defaults.</span>
<a href="#l4.867"></a><span id="l4.867" class="difflineplus">+    // If not, get pre-configured data, if any.</span>
<a href="#l4.868"></a><span id="l4.868" class="difflineplus">+    if (identity.email) {</span>
<a href="#l4.869"></a><span id="l4.869" class="difflineplus">+      dump(&quot;Invalid account: trying to get ISP data for &quot; + identity.email + &quot;\n&quot;);</span>
<a href="#l4.870"></a><span id="l4.870" class="difflineplus">+      accountData = getIspDefaultsForEmail(identity.email);</span>
<a href="#l4.871"></a><span id="l4.871" class="difflineplus">+      dump(&quot;Invalid account: Got &quot; + accountData + &quot;\n&quot;);</span>
<a href="#l4.872"></a><span id="l4.872"> </span>
<a href="#l4.873"></a><span id="l4.873" class="difflineminus">-          // account -&gt; accountData -&gt; pageData</span>
<a href="#l4.874"></a><span id="l4.874" class="difflineminus">-          accountData = AccountToAccountData(firstInvalidAccount, accountData);</span>
<a href="#l4.875"></a><span id="l4.875" class="difflineminus">-        }</span>
<a href="#l4.876"></a><span id="l4.876" class="difflineminus">-        else {</span>
<a href="#l4.877"></a><span id="l4.877" class="difflineminus">-          accountData = getPreConfigDataForAccount(firstInvalidAccount);</span>
<a href="#l4.878"></a><span id="l4.878" class="difflineminus">-        }</span>
<a href="#l4.879"></a><span id="l4.879" class="difflineminus">-        </span>
<a href="#l4.880"></a><span id="l4.880" class="difflineminus">-        AccountDataToPageData(accountData, pageData);</span>
<a href="#l4.881"></a><span id="l4.881" class="difflineplus">+      // account -&gt; accountData -&gt; pageData</span>
<a href="#l4.882"></a><span id="l4.882" class="difflineplus">+      accountData = AccountToAccountData(firstInvalidAccount, accountData);</span>
<a href="#l4.883"></a><span id="l4.883" class="difflineplus">+    }</span>
<a href="#l4.884"></a><span id="l4.884" class="difflineplus">+    else {</span>
<a href="#l4.885"></a><span id="l4.885" class="difflineplus">+      accountData = getPreConfigDataForAccount(firstInvalidAccount);</span>
<a href="#l4.886"></a><span id="l4.886" class="difflineplus">+    }</span>
<a href="#l4.887"></a><span id="l4.887" class="difflineplus">+    </span>
<a href="#l4.888"></a><span id="l4.888" class="difflineplus">+    AccountDataToPageData(accountData, pageData);</span>
<a href="#l4.889"></a><span id="l4.889"> </span>
<a href="#l4.890"></a><span id="l4.890" class="difflineminus">-        gCurrentAccountData = accountData;</span>
<a href="#l4.891"></a><span id="l4.891" class="difflineplus">+    gCurrentAccountData = accountData;</span>
<a href="#l4.892"></a><span id="l4.892"> </span>
<a href="#l4.893"></a><span id="l4.893" class="difflineminus">-        setupWizardPanels();</span>
<a href="#l4.894"></a><span id="l4.894" class="difflineminus">-        // Set the page index to identity page.</span>
<a href="#l4.895"></a><span id="l4.895" class="difflineminus">-        document.documentElement.pageIndex = 1;</span>
<a href="#l4.896"></a><span id="l4.896" class="difflineminus">-    }</span>
<a href="#l4.897"></a><span id="l4.897" class="difflineplus">+    setupWizardPanels();</span>
<a href="#l4.898"></a><span id="l4.898" class="difflineplus">+    // Set the page index to identity page.</span>
<a href="#l4.899"></a><span id="l4.899" class="difflineplus">+    document.documentElement.pageIndex = 1;</span>
<a href="#l4.900"></a><span id="l4.900" class="difflineplus">+  }</span>
<a href="#l4.901"></a><span id="l4.901"> }</span>
<a href="#l4.902"></a><span id="l4.902"> </span>
<a href="#l4.903"></a><span id="l4.903"> // Transfer all invalid account information to AccountData. Also, get those special </span>
<a href="#l4.904"></a><span id="l4.904"> // preferences (not associated with any interfaces but preconfigurable via prefs or rdf files) </span>
<a href="#l4.905"></a><span id="l4.905"> // like whether not the smtp server associated with this account requires </span>
<a href="#l4.906"></a><span id="l4.906"> // a user name (mail.identity.&lt;id_key&gt;.smtpRequiresUsername) and the choice of skipping </span>
<a href="#l4.907"></a><span id="l4.907"> // panels (mail.identity.&lt;id_key&gt;.wizardSkipPanels).</span>
<a href="#l4.908"></a><span id="l4.908"> function getPreConfigDataForAccount(account)</span>
<a href="#l4.909"></a><span id="l4.909" class="difflineat">@@ -781,236 +780,234 @@ function getPreConfigDataForAccount(acco</span>
<a href="#l4.910"></a><span id="l4.910">   accountData.smtp = new Object;</span>
<a href="#l4.911"></a><span id="l4.911"> </span>
<a href="#l4.912"></a><span id="l4.912">   accountData = AccountToAccountData(account, null);</span>
<a href="#l4.913"></a><span id="l4.913"> </span>
<a href="#l4.914"></a><span id="l4.914">   let identity = account.identities.queryElementAt(0, nsIMsgIdentity);</span>
<a href="#l4.915"></a><span id="l4.915"> </span>
<a href="#l4.916"></a><span id="l4.916">   try {</span>
<a href="#l4.917"></a><span id="l4.917">     var skipPanelsPrefStr = &quot;mail.identity.&quot; + identity.key + &quot;.wizardSkipPanels&quot;;</span>
<a href="#l4.918"></a><span id="l4.918" class="difflineminus">-    accountData.wizardSkipPanels = gPrefs.getCharPref(skipPanelsPrefStr);</span>
<a href="#l4.919"></a><span id="l4.919" class="difflineplus">+    accountData.wizardSkipPanels = Services.prefs.getCharPref(skipPanelsPrefStr);</span>
<a href="#l4.920"></a><span id="l4.920"> </span>
<a href="#l4.921"></a><span id="l4.921">     if (identity.smtpServerKey) {</span>
<a href="#l4.922"></a><span id="l4.922">       var smtpServer = smtpService.getServerByKey(identity.smtpServerKey);</span>
<a href="#l4.923"></a><span id="l4.923">       accountData.smtp = smtpServer;</span>
<a href="#l4.924"></a><span id="l4.924"> </span>
<a href="#l4.925"></a><span id="l4.925">       var smtpRequiresUsername = false;</span>
<a href="#l4.926"></a><span id="l4.926">       var smtpRequiresPrefStr = &quot;mail.identity.&quot; + identity.key + &quot;.smtpRequiresUsername&quot;;</span>
<a href="#l4.927"></a><span id="l4.927" class="difflineminus">-      smtpRequiresUsername = gPrefs.getBoolPref(smtpRequiresPrefStr);</span>
<a href="#l4.928"></a><span id="l4.928" class="difflineplus">+      smtpRequiresUsername = Services.prefs.getBoolPref(smtpRequiresPrefStr);</span>
<a href="#l4.929"></a><span id="l4.929">       accountData.smtpRequiresUsername = smtpRequiresUsername;</span>
<a href="#l4.930"></a><span id="l4.930">     }</span>
<a href="#l4.931"></a><span id="l4.931">   }</span>
<a href="#l4.932"></a><span id="l4.932">   catch(ex) {</span>
<a href="#l4.933"></a><span id="l4.933">     // reached here as special identity pre-configuration prefs </span>
<a href="#l4.934"></a><span id="l4.934">     // (wizardSkipPanels, smtpRequiresUsername) are not defined.</span>
<a href="#l4.935"></a><span id="l4.935">   }</span>
<a href="#l4.936"></a><span id="l4.936"> </span>
<a href="#l4.937"></a><span id="l4.937">   return accountData;</span>
<a href="#l4.938"></a><span id="l4.938"> }</span>
<a href="#l4.939"></a><span id="l4.939"> </span>
<a href="#l4.940"></a><span id="l4.940"> function AccountToAccountData(account, defaultAccountData)</span>
<a href="#l4.941"></a><span id="l4.941"> {</span>
<a href="#l4.942"></a><span id="l4.942" class="difflineminus">-    dump(&quot;AccountToAccountData(&quot; + account + &quot;, &quot; +</span>
<a href="#l4.943"></a><span id="l4.943" class="difflineminus">-         defaultAccountData + &quot;)\n&quot;);</span>
<a href="#l4.944"></a><span id="l4.944" class="difflineminus">-    var accountData = defaultAccountData;</span>
<a href="#l4.945"></a><span id="l4.945" class="difflineminus">-    if (!accountData)</span>
<a href="#l4.946"></a><span id="l4.946" class="difflineminus">-        accountData = new Object;</span>
<a href="#l4.947"></a><span id="l4.947" class="difflineplus">+  dump(&quot;AccountToAccountData(&quot; + account + &quot;, &quot; +</span>
<a href="#l4.948"></a><span id="l4.948" class="difflineplus">+       defaultAccountData + &quot;)\n&quot;);</span>
<a href="#l4.949"></a><span id="l4.949" class="difflineplus">+  var accountData = defaultAccountData;</span>
<a href="#l4.950"></a><span id="l4.950" class="difflineplus">+  if (!accountData)</span>
<a href="#l4.951"></a><span id="l4.951" class="difflineplus">+    accountData = new Object;</span>
<a href="#l4.952"></a><span id="l4.952"> </span>
<a href="#l4.953"></a><span id="l4.953" class="difflineminus">-    accountData.incomingServer = account.incomingServer;</span>
<a href="#l4.954"></a><span id="l4.954" class="difflineminus">-    accountData.identity = account.identities.queryElementAt(0, nsIMsgIdentity);</span>
<a href="#l4.955"></a><span id="l4.955" class="difflineminus">-    accountData.smtp = smtpService.defaultServer;</span>
<a href="#l4.956"></a><span id="l4.956" class="difflineplus">+  accountData.incomingServer = account.incomingServer;</span>
<a href="#l4.957"></a><span id="l4.957" class="difflineplus">+  accountData.identity = account.identities.queryElementAt(0, nsIMsgIdentity);</span>
<a href="#l4.958"></a><span id="l4.958" class="difflineplus">+  accountData.smtp = smtpService.defaultServer;</span>
<a href="#l4.959"></a><span id="l4.959"> </span>
<a href="#l4.960"></a><span id="l4.960" class="difflineminus">-    return accountData;</span>
<a href="#l4.961"></a><span id="l4.961" class="difflineplus">+  return accountData;</span>
<a href="#l4.962"></a><span id="l4.962"> }</span>
<a href="#l4.963"></a><span id="l4.963"> </span>
<a href="#l4.964"></a><span id="l4.964"> // sets the page data, automatically creating the arrays as necessary</span>
<a href="#l4.965"></a><span id="l4.965"> function setPageData(pageData, tag, slot, value) {</span>
<a href="#l4.966"></a><span id="l4.966" class="difflineminus">-    if (!pageData[tag]) pageData[tag] = [];</span>
<a href="#l4.967"></a><span id="l4.967" class="difflineplus">+  if (!pageData[tag]) pageData[tag] = [];</span>
<a href="#l4.968"></a><span id="l4.968"> </span>
<a href="#l4.969"></a><span id="l4.969" class="difflineminus">-    if (value == undefined) {</span>
<a href="#l4.970"></a><span id="l4.970" class="difflineminus">-        // clear out this slot</span>
<a href="#l4.971"></a><span id="l4.971" class="difflineminus">-        if (pageData[tag][slot]) delete pageData[tag][slot];</span>
<a href="#l4.972"></a><span id="l4.972" class="difflineminus">-    } else {</span>
<a href="#l4.973"></a><span id="l4.973" class="difflineminus">-        // pre-fill this slot</span>
<a href="#l4.974"></a><span id="l4.974" class="difflineminus">-        if (!pageData[tag][slot]) pageData[tag][slot] = [];</span>
<a href="#l4.975"></a><span id="l4.975" class="difflineminus">-        pageData[tag][slot].id = slot;</span>
<a href="#l4.976"></a><span id="l4.976" class="difflineminus">-        pageData[tag][slot].value = value;</span>
<a href="#l4.977"></a><span id="l4.977" class="difflineminus">-    }</span>
<a href="#l4.978"></a><span id="l4.978" class="difflineplus">+  if (value == undefined) {</span>
<a href="#l4.979"></a><span id="l4.979" class="difflineplus">+    // clear out this slot</span>
<a href="#l4.980"></a><span id="l4.980" class="difflineplus">+    if (pageData[tag][slot]) delete pageData[tag][slot];</span>
<a href="#l4.981"></a><span id="l4.981" class="difflineplus">+  }</span>
<a href="#l4.982"></a><span id="l4.982" class="difflineplus">+  else {</span>
<a href="#l4.983"></a><span id="l4.983" class="difflineplus">+    // pre-fill this slot</span>
<a href="#l4.984"></a><span id="l4.984" class="difflineplus">+    if (!pageData[tag][slot]) pageData[tag][slot] = [];</span>
<a href="#l4.985"></a><span id="l4.985" class="difflineplus">+    pageData[tag][slot].id = slot;</span>
<a href="#l4.986"></a><span id="l4.986" class="difflineplus">+    pageData[tag][slot].value = value;</span>
<a href="#l4.987"></a><span id="l4.987" class="difflineplus">+  }</span>
<a href="#l4.988"></a><span id="l4.988"> }</span>
<a href="#l4.989"></a><span id="l4.989"> </span>
<a href="#l4.990"></a><span id="l4.990"> // value of checkbox on the first page</span>
<a href="#l4.991"></a><span id="l4.991"> function serverIsNntp(pageData) {</span>
<a href="#l4.992"></a><span id="l4.992">   if (pageData.accounttype.newsaccount)</span>
<a href="#l4.993"></a><span id="l4.993">     return pageData.accounttype.newsaccount.value;</span>
<a href="#l4.994"></a><span id="l4.994">   return false;</span>
<a href="#l4.995"></a><span id="l4.995"> }</span>
<a href="#l4.996"></a><span id="l4.996"> </span>
<a href="#l4.997"></a><span id="l4.997"> function getUsernameFromEmail(aEmail, aEnsureDomain)</span>
<a href="#l4.998"></a><span id="l4.998"> {</span>
<a href="#l4.999"></a><span id="l4.999" class="difflineminus">-  var username = aEmail.split(&quot;@&quot;)[0];  </span>
<a href="#l4.1000"></a><span id="l4.1000" class="difflineplus">+  var username = aEmail.substr(0, aEmail.indexOf(&quot;@&quot;));  </span>
<a href="#l4.1001"></a><span id="l4.1001">   if (aEnsureDomain &amp;&amp; gCurrentAccountData &amp;&amp; gCurrentAccountData.domain)</span>
<a href="#l4.1002"></a><span id="l4.1002">     username += '@' + gCurrentAccountData.domain;    </span>
<a href="#l4.1003"></a><span id="l4.1003">   return username;</span>
<a href="#l4.1004"></a><span id="l4.1004"> }</span>
<a href="#l4.1005"></a><span id="l4.1005"> </span>
<a href="#l4.1006"></a><span id="l4.1006"> function getCurrentUserName(pageData)</span>
<a href="#l4.1007"></a><span id="l4.1007"> {</span>
<a href="#l4.1008"></a><span id="l4.1008" class="difflineminus">-	var userName = &quot;&quot;;</span>
<a href="#l4.1009"></a><span id="l4.1009" class="difflineplus">+  var userName = &quot;&quot;;</span>
<a href="#l4.1010"></a><span id="l4.1010"> </span>
<a href="#l4.1011"></a><span id="l4.1011" class="difflineminus">-	if (pageData.login) {</span>
<a href="#l4.1012"></a><span id="l4.1012" class="difflineminus">-    	if (pageData.login.username) {</span>
<a href="#l4.1013"></a><span id="l4.1013" class="difflineminus">-        	userName = pageData.login.username.value;</span>
<a href="#l4.1014"></a><span id="l4.1014" class="difflineminus">-		}</span>
<a href="#l4.1015"></a><span id="l4.1015" class="difflineminus">-	}</span>
<a href="#l4.1016"></a><span id="l4.1016" class="difflineminus">-	if (userName == &quot;&quot;) {</span>
<a href="#l4.1017"></a><span id="l4.1017" class="difflineminus">-		var email = pageData.identity.email.value;</span>
<a href="#l4.1018"></a><span id="l4.1018" class="difflineminus">-		userName = getUsernameFromEmail(email, false); </span>
<a href="#l4.1019"></a><span id="l4.1019" class="difflineminus">-	}</span>
<a href="#l4.1020"></a><span id="l4.1020" class="difflineminus">-	return userName;</span>
<a href="#l4.1021"></a><span id="l4.1021" class="difflineplus">+  if (pageData.login) {</span>
<a href="#l4.1022"></a><span id="l4.1022" class="difflineplus">+    if (pageData.login.username) {</span>
<a href="#l4.1023"></a><span id="l4.1023" class="difflineplus">+      userName = pageData.login.username.value;</span>
<a href="#l4.1024"></a><span id="l4.1024" class="difflineplus">+    }</span>
<a href="#l4.1025"></a><span id="l4.1025" class="difflineplus">+  }</span>
<a href="#l4.1026"></a><span id="l4.1026" class="difflineplus">+  if (userName == &quot;&quot;) {</span>
<a href="#l4.1027"></a><span id="l4.1027" class="difflineplus">+    var email = pageData.identity.email.value;</span>
<a href="#l4.1028"></a><span id="l4.1028" class="difflineplus">+    userName = getUsernameFromEmail(email, false); </span>
<a href="#l4.1029"></a><span id="l4.1029" class="difflineplus">+  }</span>
<a href="#l4.1030"></a><span id="l4.1030" class="difflineplus">+  return userName;</span>
<a href="#l4.1031"></a><span id="l4.1031"> }</span>
<a href="#l4.1032"></a><span id="l4.1032"> </span>
<a href="#l4.1033"></a><span id="l4.1033"> function getCurrentServerType(pageData) {</span>
<a href="#l4.1034"></a><span id="l4.1034" class="difflineminus">-    var servertype = &quot;pop3&quot;;    // hopefully don't resort to default!</span>
<a href="#l4.1035"></a><span id="l4.1035" class="difflineminus">-    if (serverIsNntp(pageData))</span>
<a href="#l4.1036"></a><span id="l4.1036" class="difflineminus">-        servertype = &quot;nntp&quot;;</span>
<a href="#l4.1037"></a><span id="l4.1037" class="difflineminus">-    else if (pageData.server &amp;&amp; pageData.server.servertype)</span>
<a href="#l4.1038"></a><span id="l4.1038" class="difflineminus">-        servertype = pageData.server.servertype.value;</span>
<a href="#l4.1039"></a><span id="l4.1039" class="difflineminus">-    return servertype;</span>
<a href="#l4.1040"></a><span id="l4.1040" class="difflineplus">+  var servertype = &quot;pop3&quot;;    // hopefully don't resort to default!</span>
<a href="#l4.1041"></a><span id="l4.1041" class="difflineplus">+  if (serverIsNntp(pageData))</span>
<a href="#l4.1042"></a><span id="l4.1042" class="difflineplus">+    servertype = &quot;nntp&quot;;</span>
<a href="#l4.1043"></a><span id="l4.1043" class="difflineplus">+  else if (pageData.server &amp;&amp; pageData.server.servertype)</span>
<a href="#l4.1044"></a><span id="l4.1044" class="difflineplus">+    servertype = pageData.server.servertype.value;</span>
<a href="#l4.1045"></a><span id="l4.1045" class="difflineplus">+  return servertype;</span>
<a href="#l4.1046"></a><span id="l4.1046"> }</span>
<a href="#l4.1047"></a><span id="l4.1047"> </span>
<a href="#l4.1048"></a><span id="l4.1048"> function getCurrentServerIsDeferred(pageData) {</span>
<a href="#l4.1049"></a><span id="l4.1049" class="difflineminus">-    var serverDeferred = false; </span>
<a href="#l4.1050"></a><span id="l4.1050" class="difflineminus">-    if (getCurrentServerType(pageData) == &quot;pop3&quot; &amp;&amp; pageData.server &amp;&amp; pageData.server.deferStorage)</span>
<a href="#l4.1051"></a><span id="l4.1051" class="difflineminus">-        serverDeferred = pageData.server.deferStorage.value;</span>
<a href="#l4.1052"></a><span id="l4.1052" class="difflineplus">+  var serverDeferred = false; </span>
<a href="#l4.1053"></a><span id="l4.1053" class="difflineplus">+  if (getCurrentServerType(pageData) == &quot;pop3&quot; &amp;&amp; pageData.server &amp;&amp; pageData.server.deferStorage)</span>
<a href="#l4.1054"></a><span id="l4.1054" class="difflineplus">+    serverDeferred = pageData.server.deferStorage.value;</span>
<a href="#l4.1055"></a><span id="l4.1055"> </span>
<a href="#l4.1056"></a><span id="l4.1056" class="difflineminus">-    return serverDeferred;</span>
<a href="#l4.1057"></a><span id="l4.1057" class="difflineplus">+  return serverDeferred;</span>
<a href="#l4.1058"></a><span id="l4.1058"> }</span>
<a href="#l4.1059"></a><span id="l4.1059"> </span>
<a href="#l4.1060"></a><span id="l4.1060"> function getCurrentHostname(pageData) {</span>
<a href="#l4.1061"></a><span id="l4.1061" class="difflineminus">-    if (serverIsNntp(pageData))</span>
<a href="#l4.1062"></a><span id="l4.1062" class="difflineminus">-        return pageData.newsserver.hostname.value;</span>
<a href="#l4.1063"></a><span id="l4.1063" class="difflineminus">-    else</span>
<a href="#l4.1064"></a><span id="l4.1064" class="difflineminus">-        return pageData.server.hostname.value;</span>
<a href="#l4.1065"></a><span id="l4.1065" class="difflineplus">+  if (serverIsNntp(pageData))</span>
<a href="#l4.1066"></a><span id="l4.1066" class="difflineplus">+    return pageData.newsserver.hostname.value;</span>
<a href="#l4.1067"></a><span id="l4.1067" class="difflineplus">+  else</span>
<a href="#l4.1068"></a><span id="l4.1068" class="difflineplus">+    return pageData.server.hostname.value;</span>
<a href="#l4.1069"></a><span id="l4.1069"> }</span>
<a href="#l4.1070"></a><span id="l4.1070"> </span>
<a href="#l4.1071"></a><span id="l4.1071"> function GetPageData()</span>
<a href="#l4.1072"></a><span id="l4.1072"> {</span>
<a href="#l4.1073"></a><span id="l4.1073" class="difflineminus">-    if (!gPageData)</span>
<a href="#l4.1074"></a><span id="l4.1074" class="difflineminus">-      gPageData = new Object;</span>
<a href="#l4.1075"></a><span id="l4.1075" class="difflineplus">+  if (!gPageData)</span>
<a href="#l4.1076"></a><span id="l4.1076" class="difflineplus">+    gPageData = new Object;</span>
<a href="#l4.1077"></a><span id="l4.1077"> </span>
<a href="#l4.1078"></a><span id="l4.1078" class="difflineminus">-    return gPageData;</span>
<a href="#l4.1079"></a><span id="l4.1079" class="difflineplus">+  return gPageData;</span>
<a href="#l4.1080"></a><span id="l4.1080"> }</span>
<a href="#l4.1081"></a><span id="l4.1081"> </span>
<a href="#l4.1082"></a><span id="l4.1082"> function PrefillAccountForIsp(ispName)</span>
<a href="#l4.1083"></a><span id="l4.1083"> {</span>
<a href="#l4.1084"></a><span id="l4.1084" class="difflineminus">-    dump(&quot;AccountWizard.prefillAccountForIsp(&quot; + ispName + &quot;)\n&quot;);</span>
<a href="#l4.1085"></a><span id="l4.1085" class="difflineplus">+  dump(&quot;AccountWizard.prefillAccountForIsp(&quot; + ispName + &quot;)\n&quot;);</span>
<a href="#l4.1086"></a><span id="l4.1086"> </span>
<a href="#l4.1087"></a><span id="l4.1087" class="difflineminus">-    var ispData = getIspDefaultsForUri(ispName);</span>
<a href="#l4.1088"></a><span id="l4.1088" class="difflineminus">-    </span>
<a href="#l4.1089"></a><span id="l4.1089" class="difflineminus">-    var pageData = GetPageData();</span>
<a href="#l4.1090"></a><span id="l4.1090" class="difflineplus">+  var ispData = getIspDefaultsForUri(ispName);</span>
<a href="#l4.1091"></a><span id="l4.1091" class="difflineplus">+  </span>
<a href="#l4.1092"></a><span id="l4.1092" class="difflineplus">+  var pageData = GetPageData();</span>
<a href="#l4.1093"></a><span id="l4.1093"> </span>
<a href="#l4.1094"></a><span id="l4.1094" class="difflineminus">-    if (!ispData) {</span>
<a href="#l4.1095"></a><span id="l4.1095" class="difflineminus">-      SetCurrentAccountData(null);</span>
<a href="#l4.1096"></a><span id="l4.1096" class="difflineminus">-      return;</span>
<a href="#l4.1097"></a><span id="l4.1097" class="difflineminus">-    }</span>
<a href="#l4.1098"></a><span id="l4.1098" class="difflineplus">+  if (!ispData) {</span>
<a href="#l4.1099"></a><span id="l4.1099" class="difflineplus">+    SetCurrentAccountData(null);</span>
<a href="#l4.1100"></a><span id="l4.1100" class="difflineplus">+    return;</span>
<a href="#l4.1101"></a><span id="l4.1101" class="difflineplus">+  }</span>
<a href="#l4.1102"></a><span id="l4.1102"> </span>
<a href="#l4.1103"></a><span id="l4.1103" class="difflineminus">-    // prefill the rest of the wizard</span>
<a href="#l4.1104"></a><span id="l4.1104" class="difflineminus">-    dump(&quot;PrefillAccountForISP: filling with &quot; + ispData + &quot;\n&quot;);</span>
<a href="#l4.1105"></a><span id="l4.1105" class="difflineminus">-    SetCurrentAccountData(ispData);</span>
<a href="#l4.1106"></a><span id="l4.1106" class="difflineminus">-    AccountDataToPageData(ispData, pageData);</span>
<a href="#l4.1107"></a><span id="l4.1107" class="difflineplus">+  // prefill the rest of the wizard</span>
<a href="#l4.1108"></a><span id="l4.1108" class="difflineplus">+  dump(&quot;PrefillAccountForISP: filling with &quot; + ispData + &quot;\n&quot;);</span>
<a href="#l4.1109"></a><span id="l4.1109" class="difflineplus">+  SetCurrentAccountData(ispData);</span>
<a href="#l4.1110"></a><span id="l4.1110" class="difflineplus">+  AccountDataToPageData(ispData, pageData);</span>
<a href="#l4.1111"></a><span id="l4.1111"> </span>
<a href="#l4.1112"></a><span id="l4.1112" class="difflineminus">-    setPageData(pageData, &quot;ispdata&quot;, &quot;supplied&quot;, true);</span>
<a href="#l4.1113"></a><span id="l4.1113" class="difflineplus">+  setPageData(pageData, &quot;ispdata&quot;, &quot;supplied&quot;, true);</span>
<a href="#l4.1114"></a><span id="l4.1114"> }</span>
<a href="#l4.1115"></a><span id="l4.1115"> </span>
<a href="#l4.1116"></a><span id="l4.1116"> // does any cleanup work for the the account data</span>
<a href="#l4.1117"></a><span id="l4.1117"> // - sets the username from the email address if it's not already set</span>
<a href="#l4.1118"></a><span id="l4.1118"> // - anything else?</span>
<a href="#l4.1119"></a><span id="l4.1119"> function FixupAccountDataForIsp(accountData)</span>
<a href="#l4.1120"></a><span id="l4.1120"> {</span>
<a href="#l4.1121"></a><span id="l4.1121" class="difflineminus">-    // no fixup for news</span>
<a href="#l4.1122"></a><span id="l4.1122" class="difflineminus">-    // setting the username does bad things</span>
<a href="#l4.1123"></a><span id="l4.1123" class="difflineminus">-    // see bugs #42105 and #154213</span>
<a href="#l4.1124"></a><span id="l4.1124" class="difflineminus">-    if (accountData.incomingServer.type == &quot;nntp&quot;)</span>
<a href="#l4.1125"></a><span id="l4.1125" class="difflineminus">-      return;</span>
<a href="#l4.1126"></a><span id="l4.1126" class="difflineplus">+  // no fixup for news</span>
<a href="#l4.1127"></a><span id="l4.1127" class="difflineplus">+  // setting the username does bad things</span>
<a href="#l4.1128"></a><span id="l4.1128" class="difflineplus">+  // see bugs #42105 and #154213</span>
<a href="#l4.1129"></a><span id="l4.1129" class="difflineplus">+  if (accountData.incomingServer.type == &quot;nntp&quot;)</span>
<a href="#l4.1130"></a><span id="l4.1130" class="difflineplus">+    return;</span>
<a href="#l4.1131"></a><span id="l4.1131"> </span>
<a href="#l4.1132"></a><span id="l4.1132" class="difflineminus">-    var email = accountData.identity.email;</span>
<a href="#l4.1133"></a><span id="l4.1133" class="difflineplus">+  var email = accountData.identity.email;</span>
<a href="#l4.1134"></a><span id="l4.1134"> </span>
<a href="#l4.1135"></a><span id="l4.1135" class="difflineminus">-    // The identity might not have an email address, which is what the rest of</span>
<a href="#l4.1136"></a><span id="l4.1136" class="difflineminus">-    // this function is looking for.</span>
<a href="#l4.1137"></a><span id="l4.1137" class="difflineminus">-    if (!email)</span>
<a href="#l4.1138"></a><span id="l4.1138" class="difflineminus">-      return;</span>
<a href="#l4.1139"></a><span id="l4.1139" class="difflineplus">+  // The identity might not have an email address, which is what the rest of</span>
<a href="#l4.1140"></a><span id="l4.1140" class="difflineplus">+  // this function is looking for.</span>
<a href="#l4.1141"></a><span id="l4.1141" class="difflineplus">+  if (!email)</span>
<a href="#l4.1142"></a><span id="l4.1142" class="difflineplus">+    return;</span>
<a href="#l4.1143"></a><span id="l4.1143"> </span>
<a href="#l4.1144"></a><span id="l4.1144" class="difflineminus">-    // fix up the username</span>
<a href="#l4.1145"></a><span id="l4.1145" class="difflineminus">-    if (!accountData.incomingServer.username)</span>
<a href="#l4.1146"></a><span id="l4.1146" class="difflineminus">-        accountData.incomingServer.username = getUsernameFromEmail(email, accountData.incomingServerUserNameRequiresDomain);</span>
<a href="#l4.1147"></a><span id="l4.1147" class="difflineplus">+  // fix up the username</span>
<a href="#l4.1148"></a><span id="l4.1148" class="difflineplus">+  if (!accountData.incomingServer.username)</span>
<a href="#l4.1149"></a><span id="l4.1149" class="difflineplus">+    accountData.incomingServer.username = </span>
<a href="#l4.1150"></a><span id="l4.1150" class="difflineplus">+      getUsernameFromEmail(email, accountData.incomingServerUserNameRequiresDomain);</span>
<a href="#l4.1151"></a><span id="l4.1151"> </span>
<a href="#l4.1152"></a><span id="l4.1152" class="difflineminus">-    if (!accountData.smtp.username &amp;&amp;</span>
<a href="#l4.1153"></a><span id="l4.1153" class="difflineminus">-        accountData.smtpRequiresUsername) {</span>
<a href="#l4.1154"></a><span id="l4.1154" class="difflineminus">-      // fix for bug #107953</span>
<a href="#l4.1155"></a><span id="l4.1155" class="difflineminus">-      // if incoming hostname is same as smtp hostname</span>
<a href="#l4.1156"></a><span id="l4.1156" class="difflineminus">-      // use the server username (instead of the email username)</span>
<a href="#l4.1157"></a><span id="l4.1157" class="difflineminus">-      if (accountData.smtp.hostname == accountData.incomingServer.hostName &amp;&amp;</span>
<a href="#l4.1158"></a><span id="l4.1158" class="difflineminus">-          accountData.smtpUserNameRequiresDomain == accountData.incomingServerUserNameRequiresDomain)</span>
<a href="#l4.1159"></a><span id="l4.1159" class="difflineminus">-        accountData.smtp.username = accountData.incomingServer.username;</span>
<a href="#l4.1160"></a><span id="l4.1160" class="difflineminus">-      else</span>
<a href="#l4.1161"></a><span id="l4.1161" class="difflineminus">-        accountData.smtp.username = getUsernameFromEmail(email, accountData.smtpUserNameRequiresDomain);</span>
<a href="#l4.1162"></a><span id="l4.1162" class="difflineminus">-    }</span>
<a href="#l4.1163"></a><span id="l4.1163" class="difflineplus">+  if (!accountData.smtp.username &amp;&amp;</span>
<a href="#l4.1164"></a><span id="l4.1164" class="difflineplus">+      accountData.smtpRequiresUsername) {</span>
<a href="#l4.1165"></a><span id="l4.1165" class="difflineplus">+    // fix for bug #107953</span>
<a href="#l4.1166"></a><span id="l4.1166" class="difflineplus">+    // if incoming hostname is same as smtp hostname</span>
<a href="#l4.1167"></a><span id="l4.1167" class="difflineplus">+    // use the server username (instead of the email username)</span>
<a href="#l4.1168"></a><span id="l4.1168" class="difflineplus">+    if (accountData.smtp.hostname == accountData.incomingServer.hostName &amp;&amp;</span>
<a href="#l4.1169"></a><span id="l4.1169" class="difflineplus">+        accountData.smtpUserNameRequiresDomain == accountData.incomingServerUserNameRequiresDomain)</span>
<a href="#l4.1170"></a><span id="l4.1170" class="difflineplus">+      accountData.smtp.username = accountData.incomingServer.username;</span>
<a href="#l4.1171"></a><span id="l4.1171" class="difflineplus">+    else</span>
<a href="#l4.1172"></a><span id="l4.1172" class="difflineplus">+      accountData.smtp.username = getUsernameFromEmail(email, accountData.smtpUserNameRequiresDomain);</span>
<a href="#l4.1173"></a><span id="l4.1173" class="difflineplus">+  }</span>
<a href="#l4.1174"></a><span id="l4.1174"> }</span>
<a href="#l4.1175"></a><span id="l4.1175"> </span>
<a href="#l4.1176"></a><span id="l4.1176"> function SetCurrentAccountData(accountData)</span>
<a href="#l4.1177"></a><span id="l4.1177"> {</span>
<a href="#l4.1178"></a><span id="l4.1178" class="difflineminus">-    //    dump(&quot;Setting current account data (&quot; + gCurrentAccountData + &quot;) to &quot; + accountData + &quot;\n&quot;);</span>
<a href="#l4.1179"></a><span id="l4.1179" class="difflineminus">-    gCurrentAccountData = accountData;</span>
<a href="#l4.1180"></a><span id="l4.1180" class="difflineplus">+  //    dump(&quot;Setting current account data (&quot; + gCurrentAccountData + &quot;) to &quot; + accountData + &quot;\n&quot;);</span>
<a href="#l4.1181"></a><span id="l4.1181" class="difflineplus">+  gCurrentAccountData = accountData;</span>
<a href="#l4.1182"></a><span id="l4.1182"> }</span>
<a href="#l4.1183"></a><span id="l4.1183"> </span>
<a href="#l4.1184"></a><span id="l4.1184"> function getInterfaceForType(type) {</span>
<a href="#l4.1185"></a><span id="l4.1185" class="difflineminus">-    try {</span>
<a href="#l4.1186"></a><span id="l4.1186" class="difflineminus">-        var protocolInfoContractIDPrefix = &quot;@mozilla.org/messenger/protocol/info;1?type=&quot;;</span>
<a href="#l4.1187"></a><span id="l4.1187" class="difflineminus">-        </span>
<a href="#l4.1188"></a><span id="l4.1188" class="difflineminus">-        var thisContractID = protocolInfoContractIDPrefix + type;</span>
<a href="#l4.1189"></a><span id="l4.1189" class="difflineminus">-        </span>
<a href="#l4.1190"></a><span id="l4.1190" class="difflineminus">-        var protoInfo = Components.classes[thisContractID].getService(Components.interfaces.nsIMsgProtocolInfo);</span>
<a href="#l4.1191"></a><span id="l4.1191" class="difflineminus">-        </span>
<a href="#l4.1192"></a><span id="l4.1192" class="difflineminus">-        return protoInfo.serverIID;</span>
<a href="#l4.1193"></a><span id="l4.1193" class="difflineminus">-    } catch (ex) {</span>
<a href="#l4.1194"></a><span id="l4.1194" class="difflineminus">-        dump(&quot;could not get IID for &quot; + type + &quot;: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l4.1195"></a><span id="l4.1195" class="difflineminus">-        return undefined;</span>
<a href="#l4.1196"></a><span id="l4.1196" class="difflineminus">-    }</span>
<a href="#l4.1197"></a><span id="l4.1197" class="difflineplus">+  try {</span>
<a href="#l4.1198"></a><span id="l4.1198" class="difflineplus">+    var protocolInfoContractIDPrefix = &quot;@mozilla.org/messenger/protocol/info;1?type=&quot;;</span>
<a href="#l4.1199"></a><span id="l4.1199" class="difflineplus">+    var thisContractID = protocolInfoContractIDPrefix + type;</span>
<a href="#l4.1200"></a><span id="l4.1200" class="difflineplus">+    var protoInfo = Components.classes[thisContractID].getService(Components.interfaces.nsIMsgProtocolInfo);</span>
<a href="#l4.1201"></a><span id="l4.1201" class="difflineplus">+</span>
<a href="#l4.1202"></a><span id="l4.1202" class="difflineplus">+    return protoInfo.serverIID;</span>
<a href="#l4.1203"></a><span id="l4.1203" class="difflineplus">+  } catch (ex) {</span>
<a href="#l4.1204"></a><span id="l4.1204" class="difflineplus">+    dump(&quot;could not get IID for &quot; + type + &quot;: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l4.1205"></a><span id="l4.1205" class="difflineplus">+    return undefined;</span>
<a href="#l4.1206"></a><span id="l4.1206" class="difflineplus">+  }</span>
<a href="#l4.1207"></a><span id="l4.1207"> }</span>
<a href="#l4.1208"></a><span id="l4.1208"> </span>
<a href="#l4.1209"></a><span id="l4.1209"> // flush the XUL cache - just for debugging purposes - not called</span>
<a href="#l4.1210"></a><span id="l4.1210"> function onFlush() {</span>
<a href="#l4.1211"></a><span id="l4.1211" class="difflineminus">-        gPrefs.setBoolPref(&quot;nglayout.debug.disable_xul_cache&quot;, true);</span>
<a href="#l4.1212"></a><span id="l4.1212" class="difflineminus">-        gPrefs.setBoolPref(&quot;nglayout.debug.disable_xul_cache&quot;, false);</span>
<a href="#l4.1213"></a><span id="l4.1213" class="difflineminus">-</span>
<a href="#l4.1214"></a><span id="l4.1214" class="difflineplus">+  Services.prefs.setBoolPref(&quot;nglayout.debug.disable_xul_cache&quot;, true);</span>
<a href="#l4.1215"></a><span id="l4.1215" class="difflineplus">+  Services.prefs.setBoolPref(&quot;nglayout.debug.disable_xul_cache&quot;, false);</span>
<a href="#l4.1216"></a><span id="l4.1216"> }</span>
<a href="#l4.1217"></a><span id="l4.1217"> </span>
<a href="#l4.1218"></a><span id="l4.1218"> /** If there are no default accounts..</span>
<a href="#l4.1219"></a><span id="l4.1219">   * this is will be the new default, so enable</span>
<a href="#l4.1220"></a><span id="l4.1220">   * check for mail at startup</span>
<a href="#l4.1221"></a><span id="l4.1221">   */</span>
<a href="#l4.1222"></a><span id="l4.1222"> function EnableCheckMailAtStartUpIfNeeded(newAccount)</span>
<a href="#l4.1223"></a><span id="l4.1223"> {</span>
<a href="#l4.1224"></a><span id="l4.1224" class="difflineminus">-    // Check if default account exists and if that account is alllowed to be</span>
<a href="#l4.1225"></a><span id="l4.1225" class="difflineminus">-    // a default account. If no such account, make this one as the default account </span>
<a href="#l4.1226"></a><span id="l4.1226" class="difflineminus">-    // and turn on the new mail check at startup for the current account   </span>
<a href="#l4.1227"></a><span id="l4.1227" class="difflineminus">-    if (!(gDefaultAccount &amp;&amp; gDefaultAccount.incomingServer.canBeDefaultServer)) { </span>
<a href="#l4.1228"></a><span id="l4.1228" class="difflineminus">-        am.defaultAccount = newAccount;</span>
<a href="#l4.1229"></a><span id="l4.1229" class="difflineminus">-        newAccount.incomingServer.loginAtStartUp = true;</span>
<a href="#l4.1230"></a><span id="l4.1230" class="difflineminus">-        newAccount.incomingServer.downloadOnBiff = true;</span>
<a href="#l4.1231"></a><span id="l4.1231" class="difflineminus">-    }</span>
<a href="#l4.1232"></a><span id="l4.1232" class="difflineplus">+  // Check if default account exists and if that account is alllowed to be</span>
<a href="#l4.1233"></a><span id="l4.1233" class="difflineplus">+  // a default account. If no such account, make this one as the default account </span>
<a href="#l4.1234"></a><span id="l4.1234" class="difflineplus">+  // and turn on the new mail check at startup for the current account   </span>
<a href="#l4.1235"></a><span id="l4.1235" class="difflineplus">+  if (!(gDefaultAccount &amp;&amp; gDefaultAccount.incomingServer.canBeDefaultServer)) { </span>
<a href="#l4.1236"></a><span id="l4.1236" class="difflineplus">+    am.defaultAccount = newAccount;</span>
<a href="#l4.1237"></a><span id="l4.1237" class="difflineplus">+    newAccount.incomingServer.loginAtStartUp = true;</span>
<a href="#l4.1238"></a><span id="l4.1238" class="difflineplus">+    newAccount.incomingServer.downloadOnBiff = true;</span>
<a href="#l4.1239"></a><span id="l4.1239" class="difflineplus">+  }</span>
<a href="#l4.1240"></a><span id="l4.1240"> }</span>
<a href="#l4.1241"></a><span id="l4.1241"> </span>
<a href="#l4.1242"></a><span id="l4.1242"> function SetSmtpRequiresUsernameAttribute(accountData) </span>
<a href="#l4.1243"></a><span id="l4.1243"> {</span>
<a href="#l4.1244"></a><span id="l4.1244" class="difflineminus">-    // If this is the default server, time to set the smtp user name</span>
<a href="#l4.1245"></a><span id="l4.1245" class="difflineminus">-    // Set the generic attribute for requiring user name for smtp to true.</span>
<a href="#l4.1246"></a><span id="l4.1246" class="difflineminus">-    // ISPs can override the pref via rdf files.</span>
<a href="#l4.1247"></a><span id="l4.1247" class="difflineminus">-    if (!(gDefaultAccount &amp;&amp; gDefaultAccount.incomingServer.canBeDefaultServer)) { </span>
<a href="#l4.1248"></a><span id="l4.1248" class="difflineminus">-        accountData.smtpRequiresUsername = true;</span>
<a href="#l4.1249"></a><span id="l4.1249" class="difflineminus">-    }</span>
<a href="#l4.1250"></a><span id="l4.1250" class="difflineplus">+  // If this is the default server, time to set the smtp user name</span>
<a href="#l4.1251"></a><span id="l4.1251" class="difflineplus">+  // Set the generic attribute for requiring user name for smtp to true.</span>
<a href="#l4.1252"></a><span id="l4.1252" class="difflineplus">+  // ISPs can override the pref via rdf files.</span>
<a href="#l4.1253"></a><span id="l4.1253" class="difflineplus">+  if (!(gDefaultAccount &amp;&amp; gDefaultAccount.incomingServer.canBeDefaultServer)) { </span>
<a href="#l4.1254"></a><span id="l4.1254" class="difflineplus">+    accountData.smtpRequiresUsername = true;</span>
<a href="#l4.1255"></a><span id="l4.1255" class="difflineplus">+  }</span>
<a href="#l4.1256"></a><span id="l4.1256"> }</span>
<a href="#l4.1257"></a><span id="l4.1257"> </span>
<a href="#l4.1258"></a><span id="l4.1258"> function setNextPage(currentPageId, nextPageId) {</span>
<a href="#l4.1259"></a><span id="l4.1259" class="difflineminus">-    var currentPage = document.getElementById(currentPageId);</span>
<a href="#l4.1260"></a><span id="l4.1260" class="difflineminus">-    currentPage.next = nextPageId;</span>
<a href="#l4.1261"></a><span id="l4.1261" class="difflineplus">+  var currentPage = document.getElementById(currentPageId);</span>
<a href="#l4.1262"></a><span id="l4.1262" class="difflineplus">+  currentPage.next = nextPageId;</span>
<a href="#l4.1263"></a><span id="l4.1263"> }</span>
<a href="#l4.1264"></a><span id="l4.1264" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/createInBackend.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/createInBackend.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -6,16 +6,19 @@</span>
<a href="#l5.4"></a><span id="l5.4"> /**</span>
<a href="#l5.5"></a><span id="l5.5">  * Takes an |AccountConfig| JS object and creates that account in the</span>
<a href="#l5.6"></a><span id="l5.6">  * Thunderbird backend (which also writes it to prefs).</span>
<a href="#l5.7"></a><span id="l5.7">  *</span>
<a href="#l5.8"></a><span id="l5.8">  * @param config {AccountConfig} The account to create</span>
<a href="#l5.9"></a><span id="l5.9">  *</span>
<a href="#l5.10"></a><span id="l5.10">  * @return - the account created.</span>
<a href="#l5.11"></a><span id="l5.11">  */</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+</span>
<a href="#l5.15"></a><span id="l5.15"> function createAccountInBackend(config)</span>
<a href="#l5.16"></a><span id="l5.16"> {</span>
<a href="#l5.17"></a><span id="l5.17">   var accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l5.18"></a><span id="l5.18">                        .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l5.19"></a><span id="l5.19">   var smtpManager = Cc[&quot;@mozilla.org/messengercompose/smtp;1&quot;]</span>
<a href="#l5.20"></a><span id="l5.20">                     .getService(Ci.nsISmtpService);</span>
<a href="#l5.21"></a><span id="l5.21"> </span>
<a href="#l5.22"></a><span id="l5.22">   // incoming server</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineat">@@ -36,24 +39,22 @@ function createAccountInBackend(config)</span>
<a href="#l5.24"></a><span id="l5.24">     inServer.socketType = Ci.nsMsgSocketType.SSL;</span>
<a href="#l5.25"></a><span id="l5.25">   else if (config.incoming.socketType == 3) // STARTTLS</span>
<a href="#l5.26"></a><span id="l5.26">     inServer.socketType = Ci.nsMsgSocketType.alwaysSTARTTLS;</span>
<a href="#l5.27"></a><span id="l5.27">   //inServer.prettyName = config.displayName;</span>
<a href="#l5.28"></a><span id="l5.28">   inServer.prettyName = config.identity.emailAddress;</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30">   inServer.doBiff = true;</span>
<a href="#l5.31"></a><span id="l5.31">   inServer.biffMinutes = config.incoming.checkInterval;</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-  let prefs = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineminus">-              .getService(Ci.nsIPrefBranch);</span>
<a href="#l5.34"></a><span id="l5.34">   const loginAtStartupPrefTemplate =</span>
<a href="#l5.35"></a><span id="l5.35">     &quot;mail.server.%serverkey%.login_at_startup&quot;;</span>
<a href="#l5.36"></a><span id="l5.36">   var loginAtStartupPref =</span>
<a href="#l5.37"></a><span id="l5.37">     loginAtStartupPrefTemplate.replace(&quot;%serverkey%&quot;, inServer.key);</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-  prefs.setBoolPref(loginAtStartupPref,</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineminus">-                    config.incoming.loginAtStartup);</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+  Services.prefs.setBoolPref(loginAtStartupPref,</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+                             config.incoming.loginAtStartup);</span>
<a href="#l5.42"></a><span id="l5.42">   if (config.incoming.type == &quot;pop3&quot;)</span>
<a href="#l5.43"></a><span id="l5.43">   {</span>
<a href="#l5.44"></a><span id="l5.44">     const leaveOnServerPrefTemplate =</span>
<a href="#l5.45"></a><span id="l5.45">       &quot;mail.server.%serverkey%.leave_on_server&quot;;</span>
<a href="#l5.46"></a><span id="l5.46">     const daysToLeaveOnServerPrefTemplate =</span>
<a href="#l5.47"></a><span id="l5.47">       &quot;mail.server.%serverkey%.num_days_to_leave_on_server&quot;;</span>
<a href="#l5.48"></a><span id="l5.48">     const deleteFromServerPrefTemplate =</span>
<a href="#l5.49"></a><span id="l5.49">       &quot;mail.server.%serverkey%.delete_mail_left_on_server&quot;;</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineat">@@ -66,26 +67,26 @@ function createAccountInBackend(config)</span>
<a href="#l5.51"></a><span id="l5.51">     var ageFromServerPref =</span>
<a href="#l5.52"></a><span id="l5.52">       deleteByAgeFromServerPrefTemplate.replace(&quot;%serverkey%&quot;, inServer.key);</span>
<a href="#l5.53"></a><span id="l5.53">     var daysToLeaveOnServerPref =</span>
<a href="#l5.54"></a><span id="l5.54">       daysToLeaveOnServerPrefTemplate.replace(&quot;%serverkey%&quot;, inServer.key);</span>
<a href="#l5.55"></a><span id="l5.55">     var deleteFromServerPref =</span>
<a href="#l5.56"></a><span id="l5.56">       deleteFromServerPrefTemplate.replace(&quot;%serverkey%&quot;, inServer.key);</span>
<a href="#l5.57"></a><span id="l5.57">     let downloadOnBiffPref =</span>
<a href="#l5.58"></a><span id="l5.58">       downloadOnBiffPrefTemplate.replace(&quot;%serverkey%&quot;, inServer.key);</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-    prefs.setBoolPref(leaveOnServerPref,</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-                      config.incoming.leaveMessagesOnServer);</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-    prefs.setIntPref(daysToLeaveOnServerPref,</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-                     config.incoming.daysToLeaveMessagesOnServer);</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-    prefs.setBoolPref(deleteFromServerPref,</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-                      config.incoming.deleteOnServerWhenLocalDelete);</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-    prefs.setBoolPref(ageFromServerPref,</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-                      config.incoming.deleteByAgeFromServer);</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-    prefs.setBoolPref(downloadOnBiffPref,</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-                      config.incoming.downloadOnBiff);</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineplus">+    Services.prefs.setBoolPref(leaveOnServerPref,</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+                               config.incoming.leaveMessagesOnServer);</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineplus">+    Services.prefs.setIntPref(daysToLeaveOnServerPref,</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineplus">+                              config.incoming.daysToLeaveMessagesOnServer);</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+    Services.prefs.setBoolPref(deleteFromServerPref,</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+                               config.incoming.deleteOnServerWhenLocalDelete);</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+    Services.prefs.setBoolPref(ageFromServerPref,</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineplus">+                               config.incoming.deleteByAgeFromServer);</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineplus">+    Services.prefs.setBoolPref(downloadOnBiffPref,</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineplus">+                               config.incoming.downloadOnBiff);</span>
<a href="#l5.79"></a><span id="l5.79">   }</span>
<a href="#l5.80"></a><span id="l5.80">   inServer.valid = true;</span>
<a href="#l5.81"></a><span id="l5.81"> </span>
<a href="#l5.82"></a><span id="l5.82">   let username = config.outgoing.auth &gt; 1 ? config.outgoing.username : null;</span>
<a href="#l5.83"></a><span id="l5.83">   let outServer = smtpManager.findServer(username, config.outgoing.hostname);</span>
<a href="#l5.84"></a><span id="l5.84">   assert(config.outgoing.addThisServer ||</span>
<a href="#l5.85"></a><span id="l5.85">          config.outgoing.useGlobalPreferredServer ||</span>
<a href="#l5.86"></a><span id="l5.86">          config.outgoing.existingServerKey,</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineat">@@ -150,19 +151,17 @@ function createAccountInBackend(config)</span>
<a href="#l5.88"></a><span id="l5.88">     accountManager.defaultAccount = account;</span>
<a href="#l5.89"></a><span id="l5.89"> </span>
<a href="#l5.90"></a><span id="l5.90">   verifyLocalFoldersAccount(accountManager);</span>
<a href="#l5.91"></a><span id="l5.91">   setFolders(identity, inServer);</span>
<a href="#l5.92"></a><span id="l5.92"> </span>
<a href="#l5.93"></a><span id="l5.93">   // save</span>
<a href="#l5.94"></a><span id="l5.94">   accountManager.saveAccountInfo();</span>
<a href="#l5.95"></a><span id="l5.95">   try {</span>
<a href="#l5.96"></a><span id="l5.96" class="difflineminus">-    Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l5.97"></a><span id="l5.97" class="difflineminus">-    .getService(Ci.nsIPrefService)</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-    .savePrefFile(null);</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+    Services.prefs.savePrefFile(null);</span>
<a href="#l5.100"></a><span id="l5.100">   } catch (ex) {</span>
<a href="#l5.101"></a><span id="l5.101">     ddump(&quot;Could not write out prefs: &quot; + ex);</span>
<a href="#l5.102"></a><span id="l5.102">   }</span>
<a href="#l5.103"></a><span id="l5.103">   return account;</span>
<a href="#l5.104"></a><span id="l5.104"> }</span>
<a href="#l5.105"></a><span id="l5.105"> </span>
<a href="#l5.106"></a><span id="l5.106"> function setFolders(identity, server)</span>
<a href="#l5.107"></a><span id="l5.107"> {</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineat">@@ -192,24 +191,22 @@ function rememberPassword(server, passwo</span>
<a href="#l5.109"></a><span id="l5.109"> {</span>
<a href="#l5.110"></a><span id="l5.110">   if (server instanceof Components.interfaces.nsIMsgIncomingServer)</span>
<a href="#l5.111"></a><span id="l5.111">     var passwordURI = server.localStoreType + &quot;://&quot; + server.hostName;</span>
<a href="#l5.112"></a><span id="l5.112">   else if (server instanceof Components.interfaces.nsISmtpServer)</span>
<a href="#l5.113"></a><span id="l5.113">     var passwordURI = &quot;smtp://&quot; + server.hostname;</span>
<a href="#l5.114"></a><span id="l5.114">   else</span>
<a href="#l5.115"></a><span id="l5.115">     throw new NotReached(&quot;Server type not supported&quot;);</span>
<a href="#l5.116"></a><span id="l5.116"> </span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-  let lm = Cc[&quot;@mozilla.org/login-manager;1&quot;]</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-           .getService(Ci.nsILoginManager);</span>
<a href="#l5.119"></a><span id="l5.119">   let login = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l5.120"></a><span id="l5.120">               .createInstance(Ci.nsILoginInfo);</span>
<a href="#l5.121"></a><span id="l5.121">   login.init(passwordURI, null, passwordURI, server.username, password, &quot;&quot;, &quot;&quot;);</span>
<a href="#l5.122"></a><span id="l5.122">   try {</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-    lm.addLogin(login);</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-  } catch (e if e.message.indexOf(&quot;This login already exists&quot;) != -1) {</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineplus">+    Services.logins.addLogin(login);</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineplus">+  } catch (e if e.message.contains(&quot;This login already exists&quot;)) {</span>
<a href="#l5.127"></a><span id="l5.127">     // TODO modify</span>
<a href="#l5.128"></a><span id="l5.128">   }</span>
<a href="#l5.129"></a><span id="l5.129"> }</span>
<a href="#l5.130"></a><span id="l5.130"> </span>
<a href="#l5.131"></a><span id="l5.131"> /**</span>
<a href="#l5.132"></a><span id="l5.132">  * Check whether the user's setup already has an incoming server</span>
<a href="#l5.133"></a><span id="l5.133">  * which matches (hostname, port, username) the primary one</span>
<a href="#l5.134"></a><span id="l5.134">  * in the config.</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineat">@@ -228,17 +225,17 @@ function checkIncomingServerAlreadyExist</span>
<a href="#l5.136"></a><span id="l5.136">   var incoming = config.incoming;</span>
<a href="#l5.137"></a><span id="l5.137">   var existing = accountManager.findRealServer(incoming.username,</span>
<a href="#l5.138"></a><span id="l5.138">         incoming.hostname,</span>
<a href="#l5.139"></a><span id="l5.139">         sanitize.enum(incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l5.140"></a><span id="l5.140">         incoming.port);</span>
<a href="#l5.141"></a><span id="l5.141"> </span>
<a href="#l5.142"></a><span id="l5.142">   // if username does not have an '@', also check the e-mail</span>
<a href="#l5.143"></a><span id="l5.143">   // address form of the name.</span>
<a href="#l5.144"></a><span id="l5.144" class="difflineminus">-  if (!existing &amp;&amp; incoming.username.indexOf(&quot;@&quot;) == -1)</span>
<a href="#l5.145"></a><span id="l5.145" class="difflineplus">+  if (!existing &amp;&amp; !incoming.username.contains(&quot;@&quot;))</span>
<a href="#l5.146"></a><span id="l5.146">     existing = accountManager.findRealServer(config.identity.emailAddress,</span>
<a href="#l5.147"></a><span id="l5.147">           incoming.hostname,</span>
<a href="#l5.148"></a><span id="l5.148">           sanitize.enum(incoming.type, [&quot;pop3&quot;, &quot;imap&quot;, &quot;nntp&quot;]),</span>
<a href="#l5.149"></a><span id="l5.149">           incoming.port);</span>
<a href="#l5.150"></a><span id="l5.150">   return existing;</span>
<a href="#l5.151"></a><span id="l5.151"> };</span>
<a href="#l5.152"></a><span id="l5.152"> </span>
<a href="#l5.153"></a><span id="l5.153"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/emailWizard.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/emailWizard.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -1320,30 +1320,28 @@ EmailConfigWizard.prototype =</span>
<a href="#l6.4"></a><span id="l6.4">    * [Advanced Setup...] button click handler</span>
<a href="#l6.5"></a><span id="l6.5">    * Only active in manual edit mode, and goes straight into</span>
<a href="#l6.6"></a><span id="l6.6">    * Account Settings (pref UI) dialog. Requires a backend account,</span>
<a href="#l6.7"></a><span id="l6.7">    * which requires proper hostname, port and protocol.</span>
<a href="#l6.8"></a><span id="l6.8">    */</span>
<a href="#l6.9"></a><span id="l6.9">   onAdvancedSetup : function()</span>
<a href="#l6.10"></a><span id="l6.10">   {</span>
<a href="#l6.11"></a><span id="l6.11">     assert(this._currentConfig instanceof AccountConfig);</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    var configFilledIn = this.getConcreteConfig();</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+    let configFilledIn = this.getConcreteConfig();</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15">     if (checkIncomingServerAlreadyExists(configFilledIn)) {</span>
<a href="#l6.16"></a><span id="l6.16">       alertPrompt(gStringsBundle.getString(&quot;error_creating_account&quot;),</span>
<a href="#l6.17"></a><span id="l6.17">                   gStringsBundle.getString(&quot;incoming_server_exists&quot;));</span>
<a href="#l6.18"></a><span id="l6.18">       return;</span>
<a href="#l6.19"></a><span id="l6.19">     }</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21">     gEmailWizardLogger.info(&quot;creating account in backend&quot;);</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineminus">-    var newAccount = createAccountInBackend(configFilledIn);</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+    let newAccount = createAccountInBackend(configFilledIn);</span>
<a href="#l6.24"></a><span id="l6.24"> </span>
<a href="#l6.25"></a><span id="l6.25" class="difflineminus">-    var windowManager = Cc[&quot;@mozilla.org/appshell/window-mediator;1&quot;]</span>
<a href="#l6.26"></a><span id="l6.26" class="difflineminus">-        .getService(Ci.nsIWindowMediator);</span>
<a href="#l6.27"></a><span id="l6.27" class="difflineminus">-    var existingAccountManager = windowManager</span>
<a href="#l6.28"></a><span id="l6.28" class="difflineplus">+    let existingAccountManager = Services.wm</span>
<a href="#l6.29"></a><span id="l6.29">         .getMostRecentWindow(&quot;mailnews:accountmanager&quot;);</span>
<a href="#l6.30"></a><span id="l6.30">     if (existingAccountManager) {</span>
<a href="#l6.31"></a><span id="l6.31">       existingAccountManager.focus();</span>
<a href="#l6.32"></a><span id="l6.32">     } else {</span>
<a href="#l6.33"></a><span id="l6.33">       window.openDialog(&quot;chrome://messenger/content/AccountManager.xul&quot;,</span>
<a href="#l6.34"></a><span id="l6.34">                         &quot;AccountManager&quot;, &quot;chrome,centerscreen,modal,titlebar&quot;,</span>
<a href="#l6.35"></a><span id="l6.35">                         { server: newAccount.incomingServer,</span>
<a href="#l6.36"></a><span id="l6.36">                           selectPage: &quot;am-server.xul&quot; });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/fetchConfig.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/fetchConfig.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -102,23 +102,21 @@ function fetchConfigFromISP(domain, emai</span>
<a href="#l7.4"></a><span id="l7.4"> /**</span>
<a href="#l7.5"></a><span id="l7.5">  * Tries to get a configuration for this ISP from a central database at</span>
<a href="#l7.6"></a><span id="l7.6">  * Mozilla servers.</span>
<a href="#l7.7"></a><span id="l7.7">  * Params @see fetchConfigFromISP()</span>
<a href="#l7.8"></a><span id="l7.8">  */</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10"> function fetchConfigFromDB(domain, successCallback, errorCallback)</span>
<a href="#l7.11"></a><span id="l7.11"> {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  let pref = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-             .getService(Ci.nsIPrefBranch);</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-  let url = pref.getCharPref(&quot;mailnews.auto_config_url&quot;);</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineplus">+  let url = Services.prefs.getCharPref(&quot;mailnews.auto_config_url&quot;);</span>
<a href="#l7.16"></a><span id="l7.16">   domain = sanitize.hostname(domain);</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18">   // If we don't specify a place to put the domain, put it at the end.</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-  if (url.indexOf(&quot;{{domain}}&quot;) == -1)</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineplus">+  if (!url.contains(&quot;{{domain}}&quot;))</span>
<a href="#l7.21"></a><span id="l7.21">     url = url + domain;</span>
<a href="#l7.22"></a><span id="l7.22">   else</span>
<a href="#l7.23"></a><span id="l7.23">     url = url.replace(&quot;{{domain}}&quot;, domain);</span>
<a href="#l7.24"></a><span id="l7.24">   var accountManager = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l7.25"></a><span id="l7.25">                        .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l7.26"></a><span id="l7.26">   url = url.replace(&quot;{{accounts}}&quot;, accountManager.accounts.length);</span>
<a href="#l7.27"></a><span id="l7.27"> </span>
<a href="#l7.28"></a><span id="l7.28">   if (!url.length)</span>
<a href="#l7.29"></a><span id="l7.29" class="difflineat">@@ -145,33 +143,31 @@ function fetchConfigFromDB(domain, succe</span>
<a href="#l7.30"></a><span id="l7.30">  * - DNS MX tells us the incoming server, not the mailbox (IMAP) server.</span>
<a href="#l7.31"></a><span id="l7.31">  *   They are different. This mechnism is only an approximation</span>
<a href="#l7.32"></a><span id="l7.32">  *   for hosted domains (yourname.com is served by mx.hoster.com and</span>
<a href="#l7.33"></a><span id="l7.33">  *   therefore imap.hoster.com - that &quot;therefore&quot; is exactly the</span>
<a href="#l7.34"></a><span id="l7.34">  *   conclusional jump we make here.) and alternative domains</span>
<a href="#l7.35"></a><span id="l7.35">  *   (e.g. yahoo.de -&gt; yahoo.com).</span>
<a href="#l7.36"></a><span id="l7.36">  * - We make a look up for the base domain. E.g. if MX is</span>
<a href="#l7.37"></a><span id="l7.37">  *   mx1.incoming.servers.hoster.com, we look up hoster.com.</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineminus">- *   Thanks to nsIEffectiveTLDService, we also get bbc.co.uk right.</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+ *   Thanks to Services.eTLD, we also get bbc.co.uk right.</span>
<a href="#l7.40"></a><span id="l7.40">  *</span>
<a href="#l7.41"></a><span id="l7.41">  * Params @see fetchConfigFromISP()</span>
<a href="#l7.42"></a><span id="l7.42">  */</span>
<a href="#l7.43"></a><span id="l7.43"> function fetchConfigForMX(domain, successCallback, errorCallback)</span>
<a href="#l7.44"></a><span id="l7.44"> {</span>
<a href="#l7.45"></a><span id="l7.45">   domain = sanitize.hostname(domain);</span>
<a href="#l7.46"></a><span id="l7.46"> </span>
<a href="#l7.47"></a><span id="l7.47">   var sucAbortable = new SuccessiveAbortable();</span>
<a href="#l7.48"></a><span id="l7.48">   var time = Date.now();</span>
<a href="#l7.49"></a><span id="l7.49">   sucAbortable.current = getMX(domain,</span>
<a href="#l7.50"></a><span id="l7.50">     function(mxHostname) // success</span>
<a href="#l7.51"></a><span id="l7.51">     {</span>
<a href="#l7.52"></a><span id="l7.52">       ddump(&quot;getmx took &quot; + (Date.now() - time) + &quot;ms&quot;);</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineminus">-      var tldServ = Cc[&quot;@mozilla.org/network/effective-tld-service;1&quot;]</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-                      .getService(Ci.nsIEffectiveTLDService);</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-      var sld = tldServ.getBaseDomainFromHost(mxHostname);</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+      let sld = Services.eTLD.getBaseDomainFromHost(mxHostname);</span>
<a href="#l7.57"></a><span id="l7.57">       ddump(&quot;base domain &quot; + sld + &quot; for &quot; + mxHostname);</span>
<a href="#l7.58"></a><span id="l7.58">       if (sld == domain)</span>
<a href="#l7.59"></a><span id="l7.59">       {</span>
<a href="#l7.60"></a><span id="l7.60">         errorCallback(&quot;MX lookup would be no different from domain&quot;);</span>
<a href="#l7.61"></a><span id="l7.61">         return;</span>
<a href="#l7.62"></a><span id="l7.62">       }</span>
<a href="#l7.63"></a><span id="l7.63">       sucAbortable.current = fetchConfigFromDB(sld, successCallback,</span>
<a href="#l7.64"></a><span id="l7.64">                                                errorCallback);</span>
<a href="#l7.65"></a><span id="l7.65" class="difflineat">@@ -201,19 +197,17 @@ function fetchConfigForMX(domain, succes</span>
<a href="#l7.66"></a><span id="l7.66">  *   For |hostname|, see description above.</span>
<a href="#l7.67"></a><span id="l7.67">  * @param errorCallback @see fetchConfigFromISP()</span>
<a href="#l7.68"></a><span id="l7.68">  * @returns @see fetchConfigFromISP()</span>
<a href="#l7.69"></a><span id="l7.69">  */</span>
<a href="#l7.70"></a><span id="l7.70"> function getMX(domain, successCallback, errorCallback)</span>
<a href="#l7.71"></a><span id="l7.71"> {</span>
<a href="#l7.72"></a><span id="l7.72">   domain = sanitize.hostname(domain);</span>
<a href="#l7.73"></a><span id="l7.73"> </span>
<a href="#l7.74"></a><span id="l7.74" class="difflineminus">-  let pref = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineminus">-               .getService(Ci.nsIPrefBranch);</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineminus">-  let url = pref.getCharPref(&quot;mailnews.mx_service_url&quot;);</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+  let url = Services.prefs.getCharPref(&quot;mailnews.mx_service_url&quot;);</span>
<a href="#l7.78"></a><span id="l7.78">   if (!url)</span>
<a href="#l7.79"></a><span id="l7.79">     errorCallback(&quot;no URL for MX service configured&quot;);</span>
<a href="#l7.80"></a><span id="l7.80">   url += domain;</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82">   let fetch = new FetchHTTP(url, null, false,</span>
<a href="#l7.83"></a><span id="l7.83">     function(result)</span>
<a href="#l7.84"></a><span id="l7.84">     {</span>
<a href="#l7.85"></a><span id="l7.85">       // result is plain text, with one line per server.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/fetchhttp.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/fetchhttp.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -90,17 +90,17 @@ FetchHTTP.prototype =</span>
<a href="#l8.4"></a><span id="l8.4">   _request : null, // the XMLHttpRequest object</span>
<a href="#l8.5"></a><span id="l8.5">   result : null,</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7">   start : function()</span>
<a href="#l8.8"></a><span id="l8.8">   {</span>
<a href="#l8.9"></a><span id="l8.9">     var url = this._url;</span>
<a href="#l8.10"></a><span id="l8.10">     for (var name in this._urlArgs)</span>
<a href="#l8.11"></a><span id="l8.11">     {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-      url += (url.indexOf(&quot;?&quot;) == -1 ? &quot;?&quot; : &quot;&amp;&quot;) +</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+      url += (!url.contains(&quot;?&quot;) ? &quot;?&quot; : &quot;&amp;&quot;) +</span>
<a href="#l8.14"></a><span id="l8.14">               name + &quot;=&quot; + encodeURIComponent(this._urlArgs[name]);</span>
<a href="#l8.15"></a><span id="l8.15">     }</span>
<a href="#l8.16"></a><span id="l8.16">     this._request = new XMLHttpRequest();</span>
<a href="#l8.17"></a><span id="l8.17">     let request = this._request;</span>
<a href="#l8.18"></a><span id="l8.18">     request.open(this._post ? &quot;POST&quot; : &quot;GET&quot;, url);</span>
<a href="#l8.19"></a><span id="l8.19">     request.channel.loadGroup = null;</span>
<a href="#l8.20"></a><span id="l8.20">     // needs bug 407190 patch v4 (or higher) - uncomment if that lands.</span>
<a href="#l8.21"></a><span id="l8.21">     // try {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/guessConfig.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/guessConfig.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -613,26 +613,26 @@ HostDetector.prototype =</span>
<a href="#l9.4"></a><span id="l9.4">       throw NotReached(&quot;must pass protocol&quot;);</span>
<a href="#l9.5"></a><span id="l9.5">     // add in decreasing order of preference</span>
<a href="#l9.6"></a><span id="l9.6">     if (new RegExp(prefix + &quot;GSSAPI&quot;).test(line))</span>
<a href="#l9.7"></a><span id="l9.7">       result.push(Ci.nsMsgAuthMethod.GSSAPI);</span>
<a href="#l9.8"></a><span id="l9.8">     if (new RegExp(prefix + &quot;CRAM-MD5&quot;).test(line))</span>
<a href="#l9.9"></a><span id="l9.9">       result.push(Ci.nsMsgAuthMethod.passwordEncrypted);</span>
<a href="#l9.10"></a><span id="l9.10">     if (new RegExp(prefix + &quot;(NTLM|MSN)&quot;).test(line))</span>
<a href="#l9.11"></a><span id="l9.11">       result.push(Ci.nsMsgAuthMethod.NTLM);</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    if ( ! (protocol == IMAP &amp;&amp; /LOGINDISABLED/.test(line)))</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    if (protocol != IMAP || !line.contains(&quot;LOGINDISABLED&quot;))</span>
<a href="#l9.14"></a><span id="l9.14">       result.push(Ci.nsMsgAuthMethod.passwordCleartext);</span>
<a href="#l9.15"></a><span id="l9.15">     return result;</span>
<a href="#l9.16"></a><span id="l9.16">   },</span>
<a href="#l9.17"></a><span id="l9.17"> </span>
<a href="#l9.18"></a><span id="l9.18">   _hasTLS : function(thisTry, wiredata)</span>
<a href="#l9.19"></a><span id="l9.19">   {</span>
<a href="#l9.20"></a><span id="l9.20">     var capa = thisTry.protocol == POP ? &quot;STLS&quot; : &quot;STARTTLS&quot;;</span>
<a href="#l9.21"></a><span id="l9.21">     return thisTry.ssl == TLS &amp;&amp;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-        wiredata.join(&quot;&quot;).toUpperCase().indexOf(capa) != -1;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineplus">+        wiredata.join(&quot;&quot;).toUpperCase().contains(capa);</span>
<a href="#l9.24"></a><span id="l9.24">   },</span>
<a href="#l9.25"></a><span id="l9.25"> }</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27"> /**</span>
<a href="#l9.28"></a><span id="l9.28">  * @param authMethods @see return value of _advertisesAuthMethods()</span>
<a href="#l9.29"></a><span id="l9.29">  *    Note: the returned auth method will be removed from the array.</span>
<a href="#l9.30"></a><span id="l9.30">  * @return one of them, the preferred one</span>
<a href="#l9.31"></a><span id="l9.31">  * Note: this might be Kerberos, which might not actually work,</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineat">@@ -757,19 +757,19 @@ function sortTriesByPreference(tries)</span>
<a href="#l9.33"></a><span id="l9.33"> /**</span>
<a href="#l9.34"></a><span id="l9.34">  * @returns {Array of {HostTry}}</span>
<a href="#l9.35"></a><span id="l9.35">  */</span>
<a href="#l9.36"></a><span id="l9.36"> function getIncomingTryOrder(host, protocol, ssl, port)</span>
<a href="#l9.37"></a><span id="l9.37"> {</span>
<a href="#l9.38"></a><span id="l9.38">   var lowerCaseHost = host.toLowerCase();</span>
<a href="#l9.39"></a><span id="l9.39"> </span>
<a href="#l9.40"></a><span id="l9.40">   if (protocol == UNKNOWN &amp;&amp;</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-      (!lowerCaseHost.indexOf(&quot;pop.&quot;) || !lowerCaseHost.indexOf(&quot;pop3.&quot;)))</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+      (lowerCaseHost.startsWith(&quot;pop.&quot;) || lowerCaseHost.startsWith(&quot;pop3.&quot;)))</span>
<a href="#l9.43"></a><span id="l9.43">     protocol = POP;</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineminus">-  else if (protocol == UNKNOWN &amp;&amp; !lowerCaseHost.indexOf(&quot;imap.&quot;))</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  else if (protocol == UNKNOWN &amp;&amp; lowerCaseHost.startsWith(&quot;imap.&quot;))</span>
<a href="#l9.46"></a><span id="l9.46">     protocol = IMAP;</span>
<a href="#l9.47"></a><span id="l9.47"> </span>
<a href="#l9.48"></a><span id="l9.48">   if (protocol != UNKNOWN) {</span>
<a href="#l9.49"></a><span id="l9.49">     if (ssl == UNKNOWN)</span>
<a href="#l9.50"></a><span id="l9.50">       return [getHostEntry(protocol, TLS, port),</span>
<a href="#l9.51"></a><span id="l9.51">               //getHostEntry(protocol, SSL, port),</span>
<a href="#l9.52"></a><span id="l9.52">               getHostEntry(protocol, NONE, port)];</span>
<a href="#l9.53"></a><span id="l9.53">     return [getHostEntry(protocol, ssl, port)];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/sanitizeDatatypes.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -108,17 +108,17 @@ var sanitize =</span>
<a href="#l10.4"></a><span id="l10.4">     return str.toLowerCase();</span>
<a href="#l10.5"></a><span id="l10.5">   },</span>
<a href="#l10.6"></a><span id="l10.6">   /**</span>
<a href="#l10.7"></a><span id="l10.7">    * A non-chrome URL that's safe to request.</span>
<a href="#l10.8"></a><span id="l10.8">    */</span>
<a href="#l10.9"></a><span id="l10.9">   url : function (unchecked)</span>
<a href="#l10.10"></a><span id="l10.10">   {</span>
<a href="#l10.11"></a><span id="l10.11">     var str =  this.string(unchecked);</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    if (str.substr(0, 4) != &quot;http&quot; &amp;&amp; str.substr(0, 5) != &quot;https&quot;)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    if (!str.startsWith(&quot;http&quot;) &amp;&amp; !str.startsWith(&quot;https&quot;))</span>
<a href="#l10.14"></a><span id="l10.14">       throw new MalformedException(&quot;url_scheme.error&quot;, unchecked);</span>
<a href="#l10.15"></a><span id="l10.15"> </span>
<a href="#l10.16"></a><span id="l10.16">     var uri;</span>
<a href="#l10.17"></a><span id="l10.17">     try {</span>
<a href="#l10.18"></a><span id="l10.18">       uri = ioService().newURI(str, null, null);</span>
<a href="#l10.19"></a><span id="l10.19">       uri = uri.QueryInterface(Ci.nsIURL);</span>
<a href="#l10.20"></a><span id="l10.20">     } catch (e) {</span>
<a href="#l10.21"></a><span id="l10.21">       throw new MalformedException(&quot;url_parsing.error&quot;, unchecked);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/util.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/util.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -10,16 +10,17 @@ try {</span>
<a href="#l11.4"></a><span id="l11.4">   var Cc = Components.classes;</span>
<a href="#l11.5"></a><span id="l11.5">   var Ci = Components.interfaces;</span>
<a href="#l11.6"></a><span id="l11.6"> } catch (e) { ddump(e); } // if already declared, as in xpcshell-tests</span>
<a href="#l11.7"></a><span id="l11.7"> try {</span>
<a href="#l11.8"></a><span id="l11.8">   var Cu = Components.utils;</span>
<a href="#l11.9"></a><span id="l11.9"> } catch (e) { ddump(e); }</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> Cu.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+Cu.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.13"></a><span id="l11.13"> </span>
<a href="#l11.14"></a><span id="l11.14"> /**</span>
<a href="#l11.15"></a><span id="l11.15">  * Create a subtype</span>
<a href="#l11.16"></a><span id="l11.16">  */</span>
<a href="#l11.17"></a><span id="l11.17"> function extend(child, supertype)</span>
<a href="#l11.18"></a><span id="l11.18"> {</span>
<a href="#l11.19"></a><span id="l11.19">   child.prototype.__proto__ = supertype.prototype;</span>
<a href="#l11.20"></a><span id="l11.20"> }</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineat">@@ -54,38 +55,38 @@ function runAsync(func)</span>
<a href="#l11.22"></a><span id="l11.22"> </span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24"> /**</span>
<a href="#l11.25"></a><span id="l11.25">  * @param uriStr {String}</span>
<a href="#l11.26"></a><span id="l11.26">  * @result {nsIURI}</span>
<a href="#l11.27"></a><span id="l11.27">  */</span>
<a href="#l11.28"></a><span id="l11.28"> function makeNSIURI(uriStr)</span>
<a href="#l11.29"></a><span id="l11.29"> {</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-  return ioService().newURI(uriStr, null, null);</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+  return Services.io.newURI(uriStr, null, null);</span>
<a href="#l11.32"></a><span id="l11.32"> }</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34"> </span>
<a href="#l11.35"></a><span id="l11.35"> /**</span>
<a href="#l11.36"></a><span id="l11.36">  * Reads UTF8 data from a URL.</span>
<a href="#l11.37"></a><span id="l11.37">  *</span>
<a href="#l11.38"></a><span id="l11.38">  * @param uri {nsIURI}   what you want to read</span>
<a href="#l11.39"></a><span id="l11.39">  * @return {Array of String}   the contents of the file, one string per line</span>
<a href="#l11.40"></a><span id="l11.40">  */</span>
<a href="#l11.41"></a><span id="l11.41"> function readURLasUTF8(uri)</span>
<a href="#l11.42"></a><span id="l11.42"> {</span>
<a href="#l11.43"></a><span id="l11.43">   assert(uri instanceof Ci.nsIURI, &quot;uri must be an nsIURI&quot;);</span>
<a href="#l11.44"></a><span id="l11.44">   try {</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-    var chan = ioService().newChannelFromURI(uri);</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-    var is = Cc[&quot;@mozilla.org/intl/converter-input-stream;1&quot;]</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+    let chan = Services.io.newChannelFromURI(uri);</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+    let is = Cc[&quot;@mozilla.org/intl/converter-input-stream;1&quot;]</span>
<a href="#l11.49"></a><span id="l11.49">              .createInstance(Ci.nsIConverterInputStream);</span>
<a href="#l11.50"></a><span id="l11.50">     is.init(chan.open(), &quot;UTF-8&quot;, 1024,</span>
<a href="#l11.51"></a><span id="l11.51">             Ci.nsIConverterInputStream.DEFAULT_REPLACEMENT_CHARACTER);</span>
<a href="#l11.52"></a><span id="l11.52"> </span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-    var content = &quot;&quot;;</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-    var strOut = new Object();</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+    let content = &quot;&quot;;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+    let strOut = new Object();</span>
<a href="#l11.57"></a><span id="l11.57">     try {</span>
<a href="#l11.58"></a><span id="l11.58">       while (is.readString(1024, strOut) != 0)</span>
<a href="#l11.59"></a><span id="l11.59">         content += strOut.value;</span>
<a href="#l11.60"></a><span id="l11.60">     // catch in outer try/catch</span>
<a href="#l11.61"></a><span id="l11.61">     } finally {</span>
<a href="#l11.62"></a><span id="l11.62">       is.close();</span>
<a href="#l11.63"></a><span id="l11.63">     }</span>
<a href="#l11.64"></a><span id="l11.64"> </span>
<a href="#l11.65"></a><span id="l11.65" class="difflineat">@@ -111,40 +112,23 @@ function readURLasUTF8(uri)</span>
<a href="#l11.66"></a><span id="l11.66"> function splitLines(content)</span>
<a href="#l11.67"></a><span id="l11.67"> {</span>
<a href="#l11.68"></a><span id="l11.68">   content = content.replace(&quot;\r\n&quot;, &quot;\n&quot;);</span>
<a href="#l11.69"></a><span id="l11.69">   content = content.replace(&quot;\r&quot;, &quot;\n&quot;);</span>
<a href="#l11.70"></a><span id="l11.70">   return content.split(&quot;\n&quot;);</span>
<a href="#l11.71"></a><span id="l11.71"> }</span>
<a href="#l11.72"></a><span id="l11.72"> </span>
<a href="#l11.73"></a><span id="l11.73"> /**</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineminus">- * @return nsIIOService</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">- * @throws all errors to caller</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">- */</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-function ioService()</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineminus">-{</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-  if (_gIOServiceCached)</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-    return _gIOServiceCached;</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineminus">-</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineminus">-  _gIOServiceCached = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineminus">-                      .getService(Ci.nsIIOService);</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineminus">-  return _gIOServiceCached;</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineminus">-}</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-var _gIOServiceCached;</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineminus">-</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineminus">-/**</span>
<a href="#l11.89"></a><span id="l11.89">  * @param bundleURI {String}   chrome URL to properties file</span>
<a href="#l11.90"></a><span id="l11.90">  * @return nsIStringBundle</span>
<a href="#l11.91"></a><span id="l11.91">  */</span>
<a href="#l11.92"></a><span id="l11.92"> function getStringBundle(bundleURI)</span>
<a href="#l11.93"></a><span id="l11.93"> {</span>
<a href="#l11.94"></a><span id="l11.94">   try {</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-    return Cc[&quot;@mozilla.org/intl/stringbundle;1&quot;]</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-           .getService(Ci.nsIStringBundleService)</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineminus">-           .createBundle(bundleURI);</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+    return Services.strings.createBundle(bundleURI);</span>
<a href="#l11.99"></a><span id="l11.99">   } catch (e) {</span>
<a href="#l11.100"></a><span id="l11.100">     throw new Exception(&quot;Failed to get stringbundle URI &lt;&quot; + bundleURI +</span>
<a href="#l11.101"></a><span id="l11.101">                         &quot;&gt;. Error: &quot; + e);</span>
<a href="#l11.102"></a><span id="l11.102">   }</span>
<a href="#l11.103"></a><span id="l11.103"> }</span>
<a href="#l11.104"></a><span id="l11.104"> </span>
<a href="#l11.105"></a><span id="l11.105"> </span>
<a href="#l11.106"></a><span id="l11.106"> function Exception(msg)</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineat">@@ -324,12 +308,10 @@ function debugObject(obj, name, maxDepth</span>
<a href="#l11.108"></a><span id="l11.108">   }</span>
<a href="#l11.109"></a><span id="l11.109">   if (!i)</span>
<a href="#l11.110"></a><span id="l11.110">     result += name + &quot; is empty\n&quot;;</span>
<a href="#l11.111"></a><span id="l11.111">   return result;</span>
<a href="#l11.112"></a><span id="l11.112"> }</span>
<a href="#l11.113"></a><span id="l11.113"> </span>
<a href="#l11.114"></a><span id="l11.114"> function alertPrompt(alertTitle, alertMsg)</span>
<a href="#l11.115"></a><span id="l11.115"> {</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineminus">-  Cc[&quot;@mozilla.org/embedcomp/prompt-service;1&quot;]</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineminus">-      .getService(Ci.nsIPromptService)</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineminus">-      .alert(window, alertTitle, alertMsg);</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+  Services.prompt.alert(window, alertTitle, alertMsg);</span>
<a href="#l11.120"></a><span id="l11.120"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/test/unit/test_autoconfigFetchDisk.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_autoconfigFetchDisk.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -4,40 +4,41 @@</span>
<a href="#l12.4"></a><span id="l12.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.5"></a><span id="l12.5"> </span>
<a href="#l12.6"></a><span id="l12.6"> /**</span>
<a href="#l12.7"></a><span id="l12.7">  * Tests getting a configuration file from the local isp directory and</span>
<a href="#l12.8"></a><span id="l12.8">  * reading that file.</span>
<a href="#l12.9"></a><span id="l12.9">  */</span>
<a href="#l12.10"></a><span id="l12.10"> </span>
<a href="#l12.11"></a><span id="l12.11"> // Globals</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+</span>
<a href="#l12.15"></a><span id="l12.15"> const kXMLFile = &quot;example.com.xml&quot;;</span>
<a href="#l12.16"></a><span id="l12.16"> var fetchConfigAbortable;</span>
<a href="#l12.17"></a><span id="l12.17"> var copyLocation;</span>
<a href="#l12.18"></a><span id="l12.18"> </span>
<a href="#l12.19"></a><span id="l12.19"> var xmlReader =</span>
<a href="#l12.20"></a><span id="l12.20"> {</span>
<a href="#l12.21"></a><span id="l12.21">   setTimeout : function(func, interval) {</span>
<a href="#l12.22"></a><span id="l12.22">     do_timeout(interval, func);</span>
<a href="#l12.23"></a><span id="l12.23">   }</span>
<a href="#l12.24"></a><span id="l12.24"> };</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26"> try {</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineminus">-  let loader = Cc[&quot;@mozilla.org/moz/jssubscript-loader;1&quot;]</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineminus">-                 .getService(Ci.mozIJSSubScriptLoader);</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-  loader.loadSubScript(</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+  Services.scriptloader.loadSubScript(</span>
<a href="#l12.31"></a><span id="l12.31">     &quot;chrome://messenger/content/accountcreation/util.js&quot;, xmlReader);</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineminus">-  loader.loadSubScript(</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+  Services.scriptloader.loadSubScript(</span>
<a href="#l12.34"></a><span id="l12.34">     &quot;chrome://messenger/content/accountcreation/fetchConfig.js&quot;, xmlReader);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineminus">-  loader.loadSubScript(</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+  Services.scriptloader.loadSubScript(</span>
<a href="#l12.37"></a><span id="l12.37">     &quot;chrome://messenger/content/accountcreation/accountConfig.js&quot;, xmlReader);</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineminus">-  loader.loadSubScript(</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+  Services.scriptloader.loadSubScript(</span>
<a href="#l12.40"></a><span id="l12.40">     &quot;chrome://messenger/content/accountcreation/sanitizeDatatypes.js&quot;,</span>
<a href="#l12.41"></a><span id="l12.41">     xmlReader);</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-  loader.loadSubScript(</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+  Services.scriptloader.loadSubScript(</span>
<a href="#l12.44"></a><span id="l12.44">     &quot;chrome://messenger/content/accountcreation/readFromXML.js&quot;, xmlReader);</span>
<a href="#l12.45"></a><span id="l12.45"> } catch (ex) {</span>
<a href="#l12.46"></a><span id="l12.46">   dump(ex);</span>
<a href="#l12.47"></a><span id="l12.47">   // The &quot;accountcreation&quot; files are not available in SeaMonkey (yet).</span>
<a href="#l12.48"></a><span id="l12.48">   xmlReader = null;</span>
<a href="#l12.49"></a><span id="l12.49"> }</span>
<a href="#l12.50"></a><span id="l12.50"> </span>
<a href="#l12.51"></a><span id="l12.51"> function onTestSuccess(config)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/test/unit/test_autoconfigUtils.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_autoconfigUtils.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -13,24 +13,24 @@</span>
<a href="#l13.4"></a><span id="l13.4">  *</span>
<a href="#l13.5"></a><span id="l13.5">  * TODO:</span>
<a href="#l13.6"></a><span id="l13.6">  * - Test the returned CMDS.</span>
<a href="#l13.7"></a><span id="l13.7">  * - Figure out what else to test.</span>
<a href="#l13.8"></a><span id="l13.8">  */</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> // Globals</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineplus">+</span>
<a href="#l13.14"></a><span id="l13.14"> var loaded = false;</span>
<a href="#l13.15"></a><span id="l13.15"> try {</span>
<a href="#l13.16"></a><span id="l13.16" class="difflineminus">-  let loader = Components.classes[&quot;@mozilla.org/moz/jssubscript-loader;1&quot;]</span>
<a href="#l13.17"></a><span id="l13.17" class="difflineminus">-                         .getService(Components.interfaces.mozIJSSubScriptLoader);</span>
<a href="#l13.18"></a><span id="l13.18" class="difflineminus">-  loader.loadSubScript(&quot;chrome://messenger/content/accountcreation/util.js&quot;);</span>
<a href="#l13.19"></a><span id="l13.19" class="difflineminus">-  loader.loadSubScript(&quot;chrome://messenger/content/accountcreation/accountConfig.js&quot;);</span>
<a href="#l13.20"></a><span id="l13.20" class="difflineminus">-  loader.loadSubScript(&quot;chrome://messenger/content/accountcreation/sanitizeDatatypes.js&quot;);</span>
<a href="#l13.21"></a><span id="l13.21" class="difflineminus">-  loader.loadSubScript(&quot;chrome://messenger/content/accountcreation/guessConfig.js&quot;);</span>
<a href="#l13.22"></a><span id="l13.22" class="difflineplus">+  Services.scriptloader.loadSubScript(&quot;chrome://messenger/content/accountcreation/util.js&quot;);</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineplus">+  Services.scriptloader.loadSubScript(&quot;chrome://messenger/content/accountcreation/accountConfig.js&quot;);</span>
<a href="#l13.24"></a><span id="l13.24" class="difflineplus">+  Services.scriptloader.loadSubScript(&quot;chrome://messenger/content/accountcreation/sanitizeDatatypes.js&quot;);</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineplus">+  Services.scriptloader.loadSubScript(&quot;chrome://messenger/content/accountcreation/guessConfig.js&quot;);</span>
<a href="#l13.26"></a><span id="l13.26">   loaded = true;</span>
<a href="#l13.27"></a><span id="l13.27"> } catch (ex) {</span>
<a href="#l13.28"></a><span id="l13.28">   // The &quot;accountcreation&quot; files are not available in SeaMonkey (yet).</span>
<a href="#l13.29"></a><span id="l13.29">   dump(&quot;loading accountcreation JS files failed: &quot; + ex + &quot;\n&quot; + ex.stack + &quot;\n&quot;);</span>
<a href="#l13.30"></a><span id="l13.30"> }</span>
<a href="#l13.31"></a><span id="l13.31"> </span>
<a href="#l13.32"></a><span id="l13.32"> /*</span>
<a href="#l13.33"></a><span id="l13.33">  * UTILITIES</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/test/unit/test_autoconfigXML.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_autoconfigXML.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -10,29 +10,30 @@</span>
<a href="#l14.4"></a><span id="l14.4">  * To allow forwards-compatibility (add new stuff in the future without</span>
<a href="#l14.5"></a><span id="l14.5">  * breaking old clients on the new files), we are now fairly tolerant when</span>
<a href="#l14.6"></a><span id="l14.6">  * reading and allow fallback mechanisms. This test checks whether that works,</span>
<a href="#l14.7"></a><span id="l14.7">  * and of course also whether we can read a normal config and get the proper</span>
<a href="#l14.8"></a><span id="l14.8">  * values.</span>
<a href="#l14.9"></a><span id="l14.9">  */</span>
<a href="#l14.10"></a><span id="l14.10"> </span>
<a href="#l14.11"></a><span id="l14.11"> // Globals</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineplus">+</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+</span>
<a href="#l14.15"></a><span id="l14.15"> var xmlReader = {};</span>
<a href="#l14.16"></a><span id="l14.16"> try {</span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-  let loader = Components.classes[&quot;@mozilla.org/moz/jssubscript-loader;1&quot;]</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-       .getService(Ci.mozIJSSubScriptLoader);</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-  loader.loadSubScript(</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineplus">+  Services.scriptloader.loadSubScript(</span>
<a href="#l14.21"></a><span id="l14.21">       &quot;chrome://messenger/content/accountcreation/util.js&quot;, xmlReader);</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-  loader.loadSubScript(</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineplus">+  Services.scriptloader.loadSubScript(</span>
<a href="#l14.24"></a><span id="l14.24">       &quot;chrome://messenger/content/accountcreation/accountConfig.js&quot;,</span>
<a href="#l14.25"></a><span id="l14.25">       xmlReader);</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineminus">-  loader.loadSubScript(</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+  Services.scriptloader.loadSubScript(</span>
<a href="#l14.28"></a><span id="l14.28">       &quot;chrome://messenger/content/accountcreation/sanitizeDatatypes.js&quot;,</span>
<a href="#l14.29"></a><span id="l14.29">       xmlReader);</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-  loader.loadSubScript(</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineplus">+  Services.scriptloader.loadSubScript(</span>
<a href="#l14.32"></a><span id="l14.32">       &quot;chrome://messenger/content/accountcreation/readFromXML.js&quot;, xmlReader);</span>
<a href="#l14.33"></a><span id="l14.33"> } catch (ex) {</span>
<a href="#l14.34"></a><span id="l14.34">   // The &quot;accountcreation&quot; files are not available in SeaMonkey (yet).</span>
<a href="#l14.35"></a><span id="l14.35">   xmlReader = null;</span>
<a href="#l14.36"></a><span id="l14.36"> }</span>
<a href="#l14.37"></a><span id="l14.37"> </span>
<a href="#l14.38"></a><span id="l14.38"> /*</span>
<a href="#l14.39"></a><span id="l14.39">  * UTILITIES</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

