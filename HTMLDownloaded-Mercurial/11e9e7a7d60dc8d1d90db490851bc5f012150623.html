<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28232:11e9e7a7d60dc8d1d90db490851bc5f012150623</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 11e9e7a7d60dc8d1d90db490851bc5f012150623" />
<meta property="og:url" content="/comm-central/rev/11e9e7a7d60dc8d1d90db490851bc5f012150623" />
<meta property="og:description" content="Bug 1594877 - Remove xpidl [array] use in nsIMessenger. r=jorgk" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 11e9e7a7d60dc8d1d90db490851bc5f012150623 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/11e9e7a7d60dc8d1d90db490851bc5f012150623">shortlog</a> |
<a href="/comm-central/log/11e9e7a7d60dc8d1d90db490851bc5f012150623">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/11e9e7a7d60dc8d1d90db490851bc5f012150623">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/11e9e7a7d60dc8d1d90db490851bc5f012150623">files</a> |
changeset |
<a href="/comm-central/raw-rev/11e9e7a7d60dc8d1d90db490851bc5f012150623">raw</a>  | <a href="/comm-central/archive/11e9e7a7d60dc8d1d90db490851bc5f012150623.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1594877">Bug 1594877</a> - Remove xpidl [array] use in nsIMessenger. r=jorgk
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#67;&#97;&#109;&#112;&#98;&#101;&#108;&#108;&#32;&#60;&#98;&#101;&#110;&#99;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 20 Nov 2019 00:05:08 +0100</td></tr>

<tr>
 <td>changeset 28232</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/11e9e7a7d60dc8d1d90db490851bc5f012150623">11e9e7a7d60dc8d1d90db490851bc5f012150623</a></td>
</tr>



<tr>
<td>parent 28231</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e0b1df31a3f83d0665a2670a2b4b713b13e27eab">e0b1df31a3f83d0665a2670a2b4b713b13e27eab</a>
</td>
</tr>

<tr>
<td>child 28233</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/afee24ca2f118226ecb57602882f9fa5469ba7b1">afee24ca2f118226ecb57602882f9fa5469ba7b1</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=11e9e7a7d60dc8d1d90db490851bc5f012150623">16707</a></td></tr>
<tr><td>push user</td><td>mozilla@jorgk.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 19 Nov 2019 23:13:05 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@11e9e7a7d60d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=11e9e7a7d60dc8d1d90db490851bc5f012150623">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=11e9e7a7d60dc8d1d90db490851bc5f012150623&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=11e9e7a7d60dc8d1d90db490851bc5f012150623&newProject=comm-central&newRevision=b574aafa64dccd053d78e9ef882fb617a07317d7&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=11e9e7a7d60dc8d1d90db490851bc5f012150623&newProject=comm-central&newRevision=b574aafa64dccd053d78e9ef882fb617a07317d7&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=11e9e7a7d60dc8d1d90db490851bc5f012150623&newProject=comm-central&newRevision=b574aafa64dccd053d78e9ef882fb617a07317d7&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28jorgk%29&revcount=50">jorgk</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1594877">1594877</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1594877">Bug 1594877</a> - Remove xpidl [array] use in nsIMessenger. r=jorgk</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/mail/base/content/mailCommands.js">mail/base/content/mailCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11e9e7a7d60dc8d1d90db490851bc5f012150623/mail/base/content/mailCommands.js">file</a> |
<a href="/comm-central/annotate/11e9e7a7d60dc8d1d90db490851bc5f012150623/mail/base/content/mailCommands.js">annotate</a> |
<a href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/mail/base/content/mailCommands.js">diff</a> |
<a href="/comm-central/comparison/11e9e7a7d60dc8d1d90db490851bc5f012150623/mail/base/content/mailCommands.js">comparison</a> |
<a href="/comm-central/log/11e9e7a7d60dc8d1d90db490851bc5f012150623/mail/base/content/mailCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/mail/base/content/msgHdrView.js">mail/base/content/msgHdrView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11e9e7a7d60dc8d1d90db490851bc5f012150623/mail/base/content/msgHdrView.js">file</a> |
<a href="/comm-central/annotate/11e9e7a7d60dc8d1d90db490851bc5f012150623/mail/base/content/msgHdrView.js">annotate</a> |
<a href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/mail/base/content/msgHdrView.js">diff</a> |
<a href="/comm-central/comparison/11e9e7a7d60dc8d1d90db490851bc5f012150623/mail/base/content/msgHdrView.js">comparison</a> |
<a href="/comm-central/log/11e9e7a7d60dc8d1d90db490851bc5f012150623/mail/base/content/msgHdrView.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/public/nsIMessenger.idl">mailnews/base/public/nsIMessenger.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/public/nsIMessenger.idl">file</a> |
<a href="/comm-central/annotate/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/public/nsIMessenger.idl">annotate</a> |
<a href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/public/nsIMessenger.idl">diff</a> |
<a href="/comm-central/comparison/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/public/nsIMessenger.idl">comparison</a> |
<a href="/comm-central/log/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/public/nsIMessenger.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/src/nsMessenger.cpp">mailnews/base/src/nsMessenger.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/src/nsMessenger.cpp">file</a> |
<a href="/comm-central/annotate/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/src/nsMessenger.cpp">annotate</a> |
<a href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/src/nsMessenger.cpp">diff</a> |
<a href="/comm-central/comparison/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/src/nsMessenger.cpp">comparison</a> |
<a href="/comm-central/log/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/src/nsMessenger.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/src/nsMessenger.h">mailnews/base/src/nsMessenger.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/src/nsMessenger.h">file</a> |
<a href="/comm-central/annotate/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/src/nsMessenger.h">annotate</a> |
<a href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/src/nsMessenger.h">diff</a> |
<a href="/comm-central/comparison/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/src/nsMessenger.h">comparison</a> |
<a href="/comm-central/log/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/src/nsMessenger.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/test/unit/test_detachToFile.js">mailnews/base/test/unit/test_detachToFile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/test/unit/test_detachToFile.js">file</a> |
<a href="/comm-central/annotate/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/test/unit/test_detachToFile.js">annotate</a> |
<a href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/test/unit/test_detachToFile.js">diff</a> |
<a href="/comm-central/comparison/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/test/unit/test_detachToFile.js">comparison</a> |
<a href="/comm-central/log/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/test/unit/test_detachToFile.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/test/unit/test_mimemaltdetach.js">mailnews/base/test/unit/test_mimemaltdetach.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/test/unit/test_mimemaltdetach.js">file</a> |
<a href="/comm-central/annotate/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/test/unit/test_mimemaltdetach.js">annotate</a> |
<a href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/test/unit/test_mimemaltdetach.js">diff</a> |
<a href="/comm-central/comparison/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/test/unit/test_mimemaltdetach.js">comparison</a> |
<a href="/comm-central/log/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/base/test/unit/test_mimemaltdetach.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/imap/test/unit/test_imapAttachmentSaves.js">mailnews/imap/test/unit/test_imapAttachmentSaves.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/imap/test/unit/test_imapAttachmentSaves.js">file</a> |
<a href="/comm-central/annotate/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/imap/test/unit/test_imapAttachmentSaves.js">annotate</a> |
<a href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/imap/test/unit/test_imapAttachmentSaves.js">diff</a> |
<a href="/comm-central/comparison/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/imap/test/unit/test_imapAttachmentSaves.js">comparison</a> |
<a href="/comm-central/log/11e9e7a7d60dc8d1d90db490851bc5f012150623/mailnews/imap/test/unit/test_imapAttachmentSaves.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/suite/mailnews/content/mailCommands.js">suite/mailnews/content/mailCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11e9e7a7d60dc8d1d90db490851bc5f012150623/suite/mailnews/content/mailCommands.js">file</a> |
<a href="/comm-central/annotate/11e9e7a7d60dc8d1d90db490851bc5f012150623/suite/mailnews/content/mailCommands.js">annotate</a> |
<a href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/suite/mailnews/content/mailCommands.js">diff</a> |
<a href="/comm-central/comparison/11e9e7a7d60dc8d1d90db490851bc5f012150623/suite/mailnews/content/mailCommands.js">comparison</a> |
<a href="/comm-central/log/11e9e7a7d60dc8d1d90db490851bc5f012150623/suite/mailnews/content/mailCommands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/suite/mailnews/content/msgHdrViewOverlay.js">suite/mailnews/content/msgHdrViewOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/11e9e7a7d60dc8d1d90db490851bc5f012150623/suite/mailnews/content/msgHdrViewOverlay.js">file</a> |
<a href="/comm-central/annotate/11e9e7a7d60dc8d1d90db490851bc5f012150623/suite/mailnews/content/msgHdrViewOverlay.js">annotate</a> |
<a href="/comm-central/diff/11e9e7a7d60dc8d1d90db490851bc5f012150623/suite/mailnews/content/msgHdrViewOverlay.js">diff</a> |
<a href="/comm-central/comparison/11e9e7a7d60dc8d1d90db490851bc5f012150623/suite/mailnews/content/msgHdrViewOverlay.js">comparison</a> |
<a href="/comm-central/log/11e9e7a7d60dc8d1d90db490851bc5f012150623/suite/mailnews/content/msgHdrViewOverlay.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/mailCommands.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/mailCommands.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -376,17 +376,17 @@ function SaveAsFile(uris) {</span>
<a href="#l1.4"></a><span id="l1.4">       let number = 2;</span>
<a href="#l1.5"></a><span id="l1.5">       while (filenames.includes(name)) {</span>
<a href="#l1.6"></a><span id="l1.6">         // should be unlikely</span>
<a href="#l1.7"></a><span id="l1.7">         name = GenerateValidFilename(nameBase + &quot;-&quot; + number, &quot;.eml&quot;);</span>
<a href="#l1.8"></a><span id="l1.8">         number++;</span>
<a href="#l1.9"></a><span id="l1.9">       }</span>
<a href="#l1.10"></a><span id="l1.10">       filenames.push(name);</span>
<a href="#l1.11"></a><span id="l1.11">     }</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    messenger.saveMessages(uris.length, filenames, uris);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    messenger.saveMessages(filenames, uris);</span>
<a href="#l1.14"></a><span id="l1.14">   }</span>
<a href="#l1.15"></a><span id="l1.15"> }</span>
<a href="#l1.16"></a><span id="l1.16"> </span>
<a href="#l1.17"></a><span id="l1.17"> function GenerateFilenameFromMsgHdr(msgHdr) {</span>
<a href="#l1.18"></a><span id="l1.18">   function MakeIS8601ODateString(date) {</span>
<a href="#l1.19"></a><span id="l1.19">     function pad(n) {</span>
<a href="#l1.20"></a><span id="l1.20">       return n &lt; 10 ? &quot;0&quot; + n : n;</span>
<a href="#l1.21"></a><span id="l1.21">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/msgHdrView.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/msgHdrView.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -3214,43 +3214,40 @@ function HandleMultipleAttachments(attac</span>
<a href="#l2.4"></a><span id="l2.4">     attachmentMessageUriArray[actionIndex] = attachment.uri;</span>
<a href="#l2.5"></a><span id="l2.5">     ++actionIndex;</span>
<a href="#l2.6"></a><span id="l2.6">   }</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8">   // The list has been built. Now call our action code...</span>
<a href="#l2.9"></a><span id="l2.9">   switch (action) {</span>
<a href="#l2.10"></a><span id="l2.10">     case &quot;save&quot;:</span>
<a href="#l2.11"></a><span id="l2.11">       messenger.saveAllAttachments(</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-        attachmentContentTypeArray.length,</span>
<a href="#l2.13"></a><span id="l2.13">         attachmentContentTypeArray,</span>
<a href="#l2.14"></a><span id="l2.14">         attachmentUrlArray,</span>
<a href="#l2.15"></a><span id="l2.15">         attachmentDisplayNameArray,</span>
<a href="#l2.16"></a><span id="l2.16">         attachmentMessageUriArray</span>
<a href="#l2.17"></a><span id="l2.17">       );</span>
<a href="#l2.18"></a><span id="l2.18">       return;</span>
<a href="#l2.19"></a><span id="l2.19">     case &quot;detach&quot;:</span>
<a href="#l2.20"></a><span id="l2.20">       // &quot;detach&quot; on a multiple selection of attachments is so far not really</span>
<a href="#l2.21"></a><span id="l2.21">       // supported. As a workaround, resort to normal detach-&quot;all&quot;. See also</span>
<a href="#l2.22"></a><span id="l2.22">       // the comment on 'detaching a multiple selection of attachments' below.</span>
<a href="#l2.23"></a><span id="l2.23">       if (attachments.length == 1) {</span>
<a href="#l2.24"></a><span id="l2.24">         attachments[0].detach(true);</span>
<a href="#l2.25"></a><span id="l2.25">       } else {</span>
<a href="#l2.26"></a><span id="l2.26">         messenger.detachAllAttachments(</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineminus">-          attachmentContentTypeArray.length,</span>
<a href="#l2.28"></a><span id="l2.28">           attachmentContentTypeArray,</span>
<a href="#l2.29"></a><span id="l2.29">           attachmentUrlArray,</span>
<a href="#l2.30"></a><span id="l2.30">           attachmentDisplayNameArray,</span>
<a href="#l2.31"></a><span id="l2.31">           attachmentMessageUriArray,</span>
<a href="#l2.32"></a><span id="l2.32">           true // save</span>
<a href="#l2.33"></a><span id="l2.33">         );</span>
<a href="#l2.34"></a><span id="l2.34">       }</span>
<a href="#l2.35"></a><span id="l2.35">       return;</span>
<a href="#l2.36"></a><span id="l2.36">     case &quot;delete&quot;:</span>
<a href="#l2.37"></a><span id="l2.37">       messenger.detachAllAttachments(</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-        attachmentContentTypeArray.length,</span>
<a href="#l2.39"></a><span id="l2.39">         attachmentContentTypeArray,</span>
<a href="#l2.40"></a><span id="l2.40">         attachmentUrlArray,</span>
<a href="#l2.41"></a><span id="l2.41">         attachmentDisplayNameArray,</span>
<a href="#l2.42"></a><span id="l2.42">         attachmentMessageUriArray,</span>
<a href="#l2.43"></a><span id="l2.43">         false // don't save</span>
<a href="#l2.44"></a><span id="l2.44">       );</span>
<a href="#l2.45"></a><span id="l2.45">       return;</span>
<a href="#l2.46"></a><span id="l2.46">     case &quot;open&quot;:</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/public/nsIMessenger.idl</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/public/nsIMessenger.idl</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -67,25 +67,25 @@ interface nsIMessenger : nsISupports {</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">     /**</span>
<a href="#l3.6"></a><span id="l3.6">      * Save the given messages as files in a folder - the user will be prompted</span>
<a href="#l3.7"></a><span id="l3.7">      * for which folder to use.</span>
<a href="#l3.8"></a><span id="l3.8">      * @param count message count</span>
<a href="#l3.9"></a><span id="l3.9">      * @param filenameArray the filenames to use</span>
<a href="#l3.10"></a><span id="l3.10">      * @param messageUriArray uris of the messages to save</span>
<a href="#l3.11"></a><span id="l3.11">      */</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    void saveMessages(in unsigned long count,</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-                      [array, size_is(count)] in wstring filenameArray,</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-                      [array, size_is(count)] in string messageUriArray);</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+    void saveMessages(in Array&lt;AString&gt; filenameArray,</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+                      in Array&lt;ACString&gt; messageUriArray);</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18">     void openAttachment(in ACString contentTpe, in ACString url, in ACString displayName, in ACString messageUri, in boolean isExternalAttachment);</span>
<a href="#l3.19"></a><span id="l3.19">     void saveAttachment(in ACString contentTpe, in ACString url, in ACString displayName, in ACString messageUri, in boolean isExternalAttachment);</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-    void saveAllAttachments(in unsigned long count, [array, size_is(count)] in string contentTypeArray,</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-                            [array, size_is(count)] in string urlArray, [array, size_is(count)] in string displayNameArray,</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-                            [array, size_is(count)] in string messageUriArray);</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+    void saveAllAttachments(in Array&lt;ACString&gt; contentTypeArray,</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+                            in Array&lt;ACString&gt; urlArray,</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+                            in Array&lt;ACString&gt; displayNameArray,</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+                            in Array&lt;ACString&gt; messageUriArray);</span>
<a href="#l3.27"></a><span id="l3.27"> </span>
<a href="#l3.28"></a><span id="l3.28">     void saveAttachmentToFile(in nsIFile aFile, in ACString aUrl, in ACString aMessageUri,</span>
<a href="#l3.29"></a><span id="l3.29">                               in ACString aContentType, in nsIUrlListener aListener);</span>
<a href="#l3.30"></a><span id="l3.30"> </span>
<a href="#l3.31"></a><span id="l3.31">     /**</span>
<a href="#l3.32"></a><span id="l3.32">      * For a single message and attachments, save these attachments to a file, and</span>
<a href="#l3.33"></a><span id="l3.33">      *  remove from the message. No warning windows will appear, so this is</span>
<a href="#l3.34"></a><span id="l3.34">      *  suitable for use in test and filtering.</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineat">@@ -95,27 +95,29 @@ interface nsIMessenger : nsISupports {</span>
<a href="#l3.36"></a><span id="l3.36">      * @param aContentTypeArray Content types of the attachments</span>
<a href="#l3.37"></a><span id="l3.37">      * @param aUrlArray         Urls for the attachments</span>
<a href="#l3.38"></a><span id="l3.38">      * @param aDisplayNameArray Files names to save attachments to. Unique</span>
<a href="#l3.39"></a><span id="l3.39">      *                           names will be created if needed.</span>
<a href="#l3.40"></a><span id="l3.40">      * @param aMessageUriArray  Uri for the source message</span>
<a href="#l3.41"></a><span id="l3.41">      * @param aListener         Listener to inform of start and stop of detach</span>
<a href="#l3.42"></a><span id="l3.42">      */</span>
<a href="#l3.43"></a><span id="l3.43">     void detachAttachmentsWOPrompts(in nsIFile aDestFolder,</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineminus">-                                    in unsigned long aCount,</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineminus">-                                    [array, size_is(aCount)] in string aContentTypeArray,</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineminus">-                                    [array, size_is(aCount)] in string aUrlArray,</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineminus">-                                    [array, size_is(aCount)] in string aDisplayNameArray,</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-                                    [array, size_is(aCount)] in string aMessageUriArray,</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+                                    in Array&lt;ACString&gt; aContentTypeArray,</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+                                    in Array&lt;ACString&gt; aUrlArray,</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+                                    in Array&lt;ACString&gt; aDisplayNameArray,</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+                                    in Array&lt;ACString&gt; aMessageUriArray,</span>
<a href="#l3.53"></a><span id="l3.53">                                     in nsIUrlListener aListener);</span>
<a href="#l3.54"></a><span id="l3.54"> </span>
<a href="#l3.55"></a><span id="l3.55" class="difflineminus">-    void detachAttachment(in string contentTpe, in string url, in string displayName, in string messageUri, in boolean saveFirst, [optional] in boolean withoutWarning);</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineminus">-    void detachAllAttachments(in unsigned long count, [array, size_is(count)] in string contentTypeArray,</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">-                             [array, size_is(count)] in string urlArray, [array, size_is(count)] in string displayNameArray,</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">-                             [array, size_is(count)] in string messageUriArray, in boolean saveFirst, [optional] in boolean withoutWarning);</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+    void detachAttachment(in ACString contentTpe, in ACString url, in ACString displayName, in ACString messageUri, in boolean saveFirst, [optional] in boolean withoutWarning);</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    void detachAllAttachments(in Array&lt;ACString&gt; contentTypeArray,</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+                              in Array&lt;ACString&gt; urlArray,</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+                              in Array&lt;ACString&gt; displayNameArray,</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+                              in Array&lt;ACString&gt; messageUriArray,</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+                              in boolean saveFirst,</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+                              [optional] in boolean withoutWarning);</span>
<a href="#l3.66"></a><span id="l3.66">     // saveAttachmentToFolder is used by the drag and drop code to drop an attachment to a destination folder</span>
<a href="#l3.67"></a><span id="l3.67">     // We need to return the actual file path (including the filename).</span>
<a href="#l3.68"></a><span id="l3.68">     nsIFile saveAttachmentToFolder(in ACString contentType, in ACString url, in ACString displayName, in ACString messageUri, in nsIFile aDestFolder);</span>
<a href="#l3.69"></a><span id="l3.69"> </span>
<a href="#l3.70"></a><span id="l3.70">     readonly attribute ACString lastDisplayedMessageUri;</span>
<a href="#l3.71"></a><span id="l3.71"> </span>
<a href="#l3.72"></a><span id="l3.72">     nsIMsgMessageService messageServiceFromURI(in ACString aUri);</span>
<a href="#l3.73"></a><span id="l3.73">     nsIMsgDBHdr msgHdrFromURI(in ACString aUri);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsMessenger.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -96,24 +96,24 @@</span>
<a href="#l4.4"></a><span id="l4.4"> // Convert an nsString buffer to plain text...</span>
<a href="#l4.5"></a><span id="l4.5"> //</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsCharsetSource.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsIChannel.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsIPrincipal.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-static void ConvertAndSanitizeFileName(const char *displayName,</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+static void ConvertAndSanitizeFileName(const nsACString &amp;displayName,</span>
<a href="#l4.14"></a><span id="l4.14">                                        nsString &amp;aResult) {</span>
<a href="#l4.15"></a><span id="l4.15">   nsCString unescapedName;</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17">   /* we need to convert the UTF-8 fileName to platform specific character set.</span>
<a href="#l4.18"></a><span id="l4.18">      The display name is in UTF-8 because it has been escaped from JS</span>
<a href="#l4.19"></a><span id="l4.19">   */</span>
<a href="#l4.20"></a><span id="l4.20" class="difflineminus">-  MsgUnescapeString(nsDependentCString(displayName), 0, unescapedName);</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineplus">+  MsgUnescapeString(displayName, 0, unescapedName);</span>
<a href="#l4.22"></a><span id="l4.22">   CopyUTF8toUTF16(unescapedName, aResult);</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24">   // replace platform specific path separator and illegale characters to avoid</span>
<a href="#l4.25"></a><span id="l4.25">   // any confusion</span>
<a href="#l4.26"></a><span id="l4.26">   MsgReplaceChar(aResult, FILE_PATH_SEPARATOR FILE_ILLEGAL_CHARACTERS, '-');</span>
<a href="#l4.27"></a><span id="l4.27"> }</span>
<a href="#l4.28"></a><span id="l4.28"> </span>
<a href="#l4.29"></a><span id="l4.29"> // ***************************************************</span>
<a href="#l4.30"></a><span id="l4.30" class="difflineat">@@ -170,31 +170,31 @@ class nsSaveMsgListener : public nsIUrlL</span>
<a href="#l4.31"></a><span id="l4.31">  private:</span>
<a href="#l4.32"></a><span id="l4.32">   virtual ~nsSaveMsgListener();</span>
<a href="#l4.33"></a><span id="l4.33"> };</span>
<a href="#l4.34"></a><span id="l4.34"> </span>
<a href="#l4.35"></a><span id="l4.35"> class nsSaveAllAttachmentsState {</span>
<a href="#l4.36"></a><span id="l4.36">   using PathChar = mozilla::filesystem::Path::value_type;</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38">  public:</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineminus">-  nsSaveAllAttachmentsState(uint32_t count, const char **contentTypeArray,</span>
<a href="#l4.40"></a><span id="l4.40" class="difflineminus">-                            const char **urlArray,</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-                            const char **displayNameArray,</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineminus">-                            const char **messageUriArray,</span>
<a href="#l4.43"></a><span id="l4.43" class="difflineplus">+  nsSaveAllAttachmentsState(const nsTArray&lt;nsCString&gt; &amp;contentTypeArray,</span>
<a href="#l4.44"></a><span id="l4.44" class="difflineplus">+                            const nsTArray&lt;nsCString&gt; &amp;urlArray,</span>
<a href="#l4.45"></a><span id="l4.45" class="difflineplus">+                            const nsTArray&lt;nsCString&gt; &amp;displayNameArray,</span>
<a href="#l4.46"></a><span id="l4.46" class="difflineplus">+                            const nsTArray&lt;nsCString&gt; &amp;messageUriArray,</span>
<a href="#l4.47"></a><span id="l4.47">                             const PathChar *directoryName,</span>
<a href="#l4.48"></a><span id="l4.48">                             bool detachingAttachments);</span>
<a href="#l4.49"></a><span id="l4.49">   virtual ~nsSaveAllAttachmentsState();</span>
<a href="#l4.50"></a><span id="l4.50"> </span>
<a href="#l4.51"></a><span id="l4.51">   uint32_t m_count;</span>
<a href="#l4.52"></a><span id="l4.52">   uint32_t m_curIndex;</span>
<a href="#l4.53"></a><span id="l4.53">   PathChar *m_directoryName;</span>
<a href="#l4.54"></a><span id="l4.54" class="difflineminus">-  char **m_contentTypeArray;</span>
<a href="#l4.55"></a><span id="l4.55" class="difflineminus">-  char **m_urlArray;</span>
<a href="#l4.56"></a><span id="l4.56" class="difflineminus">-  char **m_displayNameArray;</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineminus">-  char **m_messageUriArray;</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  nsTArray&lt;nsCString&gt; m_contentTypeArray;</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineplus">+  nsTArray&lt;nsCString&gt; m_urlArray;</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+  nsTArray&lt;nsCString&gt; m_displayNameArray;</span>
<a href="#l4.61"></a><span id="l4.61" class="difflineplus">+  nsTArray&lt;nsCString&gt; m_messageUriArray;</span>
<a href="#l4.62"></a><span id="l4.62">   bool m_detachingAttachments;</span>
<a href="#l4.63"></a><span id="l4.63"> </span>
<a href="#l4.64"></a><span id="l4.64">   // if detaching, do without warning? Will create unique files instead of</span>
<a href="#l4.65"></a><span id="l4.65">   // prompting if duplicate files exist.</span>
<a href="#l4.66"></a><span id="l4.66">   bool m_withoutWarning;</span>
<a href="#l4.67"></a><span id="l4.67">   // if detaching first, remember where we saved to.</span>
<a href="#l4.68"></a><span id="l4.68">   nsTArray&lt;nsCString&gt; m_savedFiles;</span>
<a href="#l4.69"></a><span id="l4.69"> };</span>
<a href="#l4.70"></a><span id="l4.70" class="difflineat">@@ -560,53 +560,49 @@ NS_IMETHODIMP nsMessenger::SaveAttachmen</span>
<a href="#l4.71"></a><span id="l4.71">                                                 const nsACString &amp;aMessageUri,</span>
<a href="#l4.72"></a><span id="l4.72">                                                 const nsACString &amp;aContentType,</span>
<a href="#l4.73"></a><span id="l4.73">                                                 nsIUrlListener *aListener) {</span>
<a href="#l4.74"></a><span id="l4.74">   return SaveAttachment(aFile, aURL, aMessageUri, aContentType, nullptr,</span>
<a href="#l4.75"></a><span id="l4.75">                         aListener);</span>
<a href="#l4.76"></a><span id="l4.76"> }</span>
<a href="#l4.77"></a><span id="l4.77"> </span>
<a href="#l4.78"></a><span id="l4.78"> NS_IMETHODIMP</span>
<a href="#l4.79"></a><span id="l4.79" class="difflineminus">-nsMessenger::DetachAttachmentsWOPrompts(nsIFile *aDestFolder, uint32_t aCount,</span>
<a href="#l4.80"></a><span id="l4.80" class="difflineminus">-                                        const char **aContentTypeArray,</span>
<a href="#l4.81"></a><span id="l4.81" class="difflineminus">-                                        const char **aUrlArray,</span>
<a href="#l4.82"></a><span id="l4.82" class="difflineminus">-                                        const char **aDisplayNameArray,</span>
<a href="#l4.83"></a><span id="l4.83" class="difflineminus">-                                        const char **aMessageUriArray,</span>
<a href="#l4.84"></a><span id="l4.84" class="difflineminus">-                                        nsIUrlListener *aListener) {</span>
<a href="#l4.85"></a><span id="l4.85" class="difflineplus">+nsMessenger::DetachAttachmentsWOPrompts(</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+    nsIFile *aDestFolder, const nsTArray&lt;nsCString&gt; &amp;aContentTypeArray,</span>
<a href="#l4.87"></a><span id="l4.87" class="difflineplus">+    const nsTArray&lt;nsCString&gt; &amp;aUrlArray,</span>
<a href="#l4.88"></a><span id="l4.88" class="difflineplus">+    const nsTArray&lt;nsCString&gt; &amp;aDisplayNameArray,</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineplus">+    const nsTArray&lt;nsCString&gt; &amp;aMessageUriArray, nsIUrlListener *aListener) {</span>
<a href="#l4.90"></a><span id="l4.90">   NS_ENSURE_ARG_POINTER(aDestFolder);</span>
<a href="#l4.91"></a><span id="l4.91" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aContentTypeArray);</span>
<a href="#l4.92"></a><span id="l4.92" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aUrlArray);</span>
<a href="#l4.93"></a><span id="l4.93" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aMessageUriArray);</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aDisplayNameArray);</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineminus">-  if (!aCount) return NS_OK;</span>
<a href="#l4.96"></a><span id="l4.96" class="difflineplus">+  MOZ_ASSERT(aContentTypeArray.Length() == aUrlArray.Length() ==</span>
<a href="#l4.97"></a><span id="l4.97" class="difflineplus">+             aDisplayNameArray.Length() == aMessageUriArray.Length());</span>
<a href="#l4.98"></a><span id="l4.98" class="difflineplus">+</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineplus">+  if (!aContentTypeArray.Length()) return NS_OK;</span>
<a href="#l4.100"></a><span id="l4.100">   nsSaveAllAttachmentsState *saveState;</span>
<a href="#l4.101"></a><span id="l4.101">   nsCOMPtr&lt;nsIFile&gt; attachmentDestination;</span>
<a href="#l4.102"></a><span id="l4.102">   nsresult rv = aDestFolder-&gt;Clone(getter_AddRefs(attachmentDestination));</span>
<a href="#l4.103"></a><span id="l4.103">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.104"></a><span id="l4.104"> </span>
<a href="#l4.105"></a><span id="l4.105">   PathString path = attachmentDestination-&gt;NativePath();</span>
<a href="#l4.106"></a><span id="l4.106"> </span>
<a href="#l4.107"></a><span id="l4.107">   nsAutoString unescapedFileName;</span>
<a href="#l4.108"></a><span id="l4.108">   ConvertAndSanitizeFileName(aDisplayNameArray[0], unescapedFileName);</span>
<a href="#l4.109"></a><span id="l4.109">   rv = attachmentDestination-&gt;Append(unescapedFileName);</span>
<a href="#l4.110"></a><span id="l4.110">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.111"></a><span id="l4.111">   rv = attachmentDestination-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE,</span>
<a href="#l4.112"></a><span id="l4.112">                                            ATTACHMENT_PERMISSION);</span>
<a href="#l4.113"></a><span id="l4.113">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.114"></a><span id="l4.114"> </span>
<a href="#l4.115"></a><span id="l4.115" class="difflineminus">-  saveState = new nsSaveAllAttachmentsState(aCount, aContentTypeArray,</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-                                            aUrlArray, aDisplayNameArray,</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineminus">-                                            aMessageUriArray, path.get(), true);</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineplus">+  saveState = new nsSaveAllAttachmentsState(aContentTypeArray, aUrlArray,</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+                                            aDisplayNameArray, aMessageUriArray,</span>
<a href="#l4.120"></a><span id="l4.120" class="difflineplus">+                                            path.get(), true);</span>
<a href="#l4.121"></a><span id="l4.121"> </span>
<a href="#l4.122"></a><span id="l4.122">   // This method is used in filters, where we don't want to warn</span>
<a href="#l4.123"></a><span id="l4.123">   saveState-&gt;m_withoutWarning = true;</span>
<a href="#l4.124"></a><span id="l4.124" class="difflineminus">-  rv = SaveAttachment(attachmentDestination, nsDependentCString(aUrlArray[0]),</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineminus">-                      nsDependentCString(aMessageUriArray[0]),</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineminus">-                      nsDependentCString(aContentTypeArray[0]),</span>
<a href="#l4.127"></a><span id="l4.127" class="difflineminus">-                      (void *)saveState, aListener);</span>
<a href="#l4.128"></a><span id="l4.128" class="difflineplus">+  rv = SaveAttachment(attachmentDestination, aUrlArray[0], aMessageUriArray[0],</span>
<a href="#l4.129"></a><span id="l4.129" class="difflineplus">+                      aContentTypeArray[0], (void *)saveState, aListener);</span>
<a href="#l4.130"></a><span id="l4.130">   return rv;</span>
<a href="#l4.131"></a><span id="l4.131"> }</span>
<a href="#l4.132"></a><span id="l4.132"> </span>
<a href="#l4.133"></a><span id="l4.133"> nsresult nsMessenger::SaveAttachment(nsIFile *aFile, const nsACString &amp;aURL,</span>
<a href="#l4.134"></a><span id="l4.134">                                      const nsACString &amp;aMessageUri,</span>
<a href="#l4.135"></a><span id="l4.135">                                      const nsACString &amp;aContentType,</span>
<a href="#l4.136"></a><span id="l4.136">                                      void *closure, nsIUrlListener *aListener) {</span>
<a href="#l4.137"></a><span id="l4.137">   nsCOMPtr&lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineat">@@ -717,18 +713,17 @@ nsMessenger::SaveAttachmentToFolder(cons</span>
<a href="#l4.139"></a><span id="l4.139">   NS_ENSURE_ARG_POINTER(aDestFolder);</span>
<a href="#l4.140"></a><span id="l4.140">   nsresult rv;</span>
<a href="#l4.141"></a><span id="l4.141"> </span>
<a href="#l4.142"></a><span id="l4.142">   nsCOMPtr&lt;nsIFile&gt; attachmentDestination;</span>
<a href="#l4.143"></a><span id="l4.143">   rv = aDestFolder-&gt;Clone(getter_AddRefs(attachmentDestination));</span>
<a href="#l4.144"></a><span id="l4.144">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.145"></a><span id="l4.145"> </span>
<a href="#l4.146"></a><span id="l4.146">   nsString unescapedFileName;</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineminus">-  ConvertAndSanitizeFileName(PromiseFlatCString(displayName).get(),</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineminus">-                             unescapedFileName);</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+  ConvertAndSanitizeFileName(displayName, unescapedFileName);</span>
<a href="#l4.150"></a><span id="l4.150">   rv = attachmentDestination-&gt;Append(unescapedFileName);</span>
<a href="#l4.151"></a><span id="l4.151">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.152"></a><span id="l4.152"> #ifdef XP_MACOSX</span>
<a href="#l4.153"></a><span id="l4.153">   rv = attachmentDestination-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE,</span>
<a href="#l4.154"></a><span id="l4.154">                                            ATTACHMENT_PERMISSION);</span>
<a href="#l4.155"></a><span id="l4.155">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.156"></a><span id="l4.156"> #endif</span>
<a href="#l4.157"></a><span id="l4.157"> </span>
<a href="#l4.158"></a><span id="l4.158" class="difflineat">@@ -742,26 +737,24 @@ NS_IMETHODIMP</span>
<a href="#l4.159"></a><span id="l4.159"> nsMessenger::SaveAttachment(const nsACString &amp;aContentType,</span>
<a href="#l4.160"></a><span id="l4.160">                             const nsACString &amp;aURL,</span>
<a href="#l4.161"></a><span id="l4.161">                             const nsACString &amp;aDisplayName,</span>
<a href="#l4.162"></a><span id="l4.162">                             const nsACString &amp;aMessageUri,</span>
<a href="#l4.163"></a><span id="l4.163">                             bool aIsExternalAttachment) {</span>
<a href="#l4.164"></a><span id="l4.164">   // open external attachments inside our message pane which in turn should</span>
<a href="#l4.165"></a><span id="l4.165">   // trigger the helper app dialog...</span>
<a href="#l4.166"></a><span id="l4.166">   if (aIsExternalAttachment) return OpenURL(aURL);</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineminus">-  return SaveOneAttachment(PromiseFlatCString(aContentType).get(),</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineminus">-                           PromiseFlatCString(aURL).get(),</span>
<a href="#l4.169"></a><span id="l4.169" class="difflineminus">-                           PromiseFlatCString(aDisplayName).get(),</span>
<a href="#l4.170"></a><span id="l4.170" class="difflineminus">-                           PromiseFlatCString(aMessageUri).get(), false);</span>
<a href="#l4.171"></a><span id="l4.171" class="difflineplus">+  return SaveOneAttachment(aContentType, aURL, aDisplayName, aMessageUri,</span>
<a href="#l4.172"></a><span id="l4.172" class="difflineplus">+                           false);</span>
<a href="#l4.173"></a><span id="l4.173"> }</span>
<a href="#l4.174"></a><span id="l4.174"> </span>
<a href="#l4.175"></a><span id="l4.175" class="difflineminus">-nsresult nsMessenger::SaveOneAttachment(const char *aContentType,</span>
<a href="#l4.176"></a><span id="l4.176" class="difflineminus">-                                        const char *aURL,</span>
<a href="#l4.177"></a><span id="l4.177" class="difflineminus">-                                        const char *aDisplayName,</span>
<a href="#l4.178"></a><span id="l4.178" class="difflineminus">-                                        const char *aMessageUri,</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineplus">+nsresult nsMessenger::SaveOneAttachment(const nsACString &amp;aContentType,</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineplus">+                                        const nsACString &amp;aURL,</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+                                        const nsACString &amp;aDisplayName,</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+                                        const nsACString &amp;aMessageUri,</span>
<a href="#l4.183"></a><span id="l4.183">                                         bool detaching) {</span>
<a href="#l4.184"></a><span id="l4.184">   nsresult rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.185"></a><span id="l4.185">   nsCOMPtr&lt;nsIFilePicker&gt; filePicker =</span>
<a href="#l4.186"></a><span id="l4.186">       do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l4.187"></a><span id="l4.187">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.188"></a><span id="l4.188"> </span>
<a href="#l4.189"></a><span id="l4.189">   int16_t dialogResult;</span>
<a href="#l4.190"></a><span id="l4.190">   nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l4.191"></a><span id="l4.191" class="difflineat">@@ -813,41 +806,44 @@ nsresult nsMessenger::SaveOneAttachment(</span>
<a href="#l4.192"></a><span id="l4.192"> </span>
<a href="#l4.193"></a><span id="l4.193">   rv = filePicker-&gt;GetFile(getter_AddRefs(localFile));</span>
<a href="#l4.194"></a><span id="l4.194">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.195"></a><span id="l4.195"> </span>
<a href="#l4.196"></a><span id="l4.196">   SetLastSaveDirectory(localFile);</span>
<a href="#l4.197"></a><span id="l4.197"> </span>
<a href="#l4.198"></a><span id="l4.198">   PathString dirName = localFile-&gt;NativePath();</span>
<a href="#l4.199"></a><span id="l4.199"> </span>
<a href="#l4.200"></a><span id="l4.200" class="difflineminus">-  nsSaveAllAttachmentsState *saveState =</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineminus">-      new nsSaveAllAttachmentsState(1, &amp;aContentType, &amp;aURL, &amp;aDisplayName,</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineminus">-                                    &amp;aMessageUri, dirName.get(), detaching);</span>
<a href="#l4.203"></a><span id="l4.203" class="difflineminus">-</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-  return SaveAttachment(</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-      localFile, nsDependentCString(aURL), nsDependentCString(aMessageUri),</span>
<a href="#l4.206"></a><span id="l4.206" class="difflineminus">-      nsDependentCString(aContentType), (void *)saveState, nullptr);</span>
<a href="#l4.207"></a><span id="l4.207" class="difflineplus">+  AutoTArray&lt;nsCString, 1&gt; contentTypeArray = {</span>
<a href="#l4.208"></a><span id="l4.208" class="difflineplus">+      PromiseFlatCString(aContentType)};</span>
<a href="#l4.209"></a><span id="l4.209" class="difflineplus">+  AutoTArray&lt;nsCString, 1&gt; urlArray = {PromiseFlatCString(aURL)};</span>
<a href="#l4.210"></a><span id="l4.210" class="difflineplus">+  AutoTArray&lt;nsCString, 1&gt; displayNameArray = {</span>
<a href="#l4.211"></a><span id="l4.211" class="difflineplus">+      PromiseFlatCString(aDisplayName)};</span>
<a href="#l4.212"></a><span id="l4.212" class="difflineplus">+  AutoTArray&lt;nsCString, 1&gt; messageUriArray = {PromiseFlatCString(aMessageUri)};</span>
<a href="#l4.213"></a><span id="l4.213" class="difflineplus">+  nsSaveAllAttachmentsState *saveState = new nsSaveAllAttachmentsState(</span>
<a href="#l4.214"></a><span id="l4.214" class="difflineplus">+      contentTypeArray, urlArray, displayNameArray, messageUriArray,</span>
<a href="#l4.215"></a><span id="l4.215" class="difflineplus">+      dirName.get(), detaching);</span>
<a href="#l4.216"></a><span id="l4.216" class="difflineplus">+</span>
<a href="#l4.217"></a><span id="l4.217" class="difflineplus">+  return SaveAttachment(localFile, aURL, aMessageUri, aContentType,</span>
<a href="#l4.218"></a><span id="l4.218" class="difflineplus">+                        (void *)saveState, nullptr);</span>
<a href="#l4.219"></a><span id="l4.219"> }</span>
<a href="#l4.220"></a><span id="l4.220"> </span>
<a href="#l4.221"></a><span id="l4.221"> NS_IMETHODIMP</span>
<a href="#l4.222"></a><span id="l4.222" class="difflineminus">-nsMessenger::SaveAllAttachments(uint32_t count, const char **contentTypeArray,</span>
<a href="#l4.223"></a><span id="l4.223" class="difflineminus">-                                const char **urlArray,</span>
<a href="#l4.224"></a><span id="l4.224" class="difflineminus">-                                const char **displayNameArray,</span>
<a href="#l4.225"></a><span id="l4.225" class="difflineminus">-                                const char **messageUriArray) {</span>
<a href="#l4.226"></a><span id="l4.226" class="difflineminus">-  if (!count) return NS_ERROR_INVALID_ARG;</span>
<a href="#l4.227"></a><span id="l4.227" class="difflineminus">-  return SaveAllAttachments(count, contentTypeArray, urlArray, displayNameArray,</span>
<a href="#l4.228"></a><span id="l4.228" class="difflineplus">+nsMessenger::SaveAllAttachments(const nsTArray&lt;nsCString&gt; &amp;contentTypeArray,</span>
<a href="#l4.229"></a><span id="l4.229" class="difflineplus">+                                const nsTArray&lt;nsCString&gt; &amp;urlArray,</span>
<a href="#l4.230"></a><span id="l4.230" class="difflineplus">+                                const nsTArray&lt;nsCString&gt; &amp;displayNameArray,</span>
<a href="#l4.231"></a><span id="l4.231" class="difflineplus">+                                const nsTArray&lt;nsCString&gt; &amp;messageUriArray) {</span>
<a href="#l4.232"></a><span id="l4.232" class="difflineplus">+  return SaveAllAttachments(contentTypeArray, urlArray, displayNameArray,</span>
<a href="#l4.233"></a><span id="l4.233">                             messageUriArray, false);</span>
<a href="#l4.234"></a><span id="l4.234"> }</span>
<a href="#l4.235"></a><span id="l4.235"> </span>
<a href="#l4.236"></a><span id="l4.236" class="difflineminus">-nsresult nsMessenger::SaveAllAttachments(uint32_t count,</span>
<a href="#l4.237"></a><span id="l4.237" class="difflineminus">-                                         const char **contentTypeArray,</span>
<a href="#l4.238"></a><span id="l4.238" class="difflineminus">-                                         const char **urlArray,</span>
<a href="#l4.239"></a><span id="l4.239" class="difflineminus">-                                         const char **displayNameArray,</span>
<a href="#l4.240"></a><span id="l4.240" class="difflineminus">-                                         const char **messageUriArray,</span>
<a href="#l4.241"></a><span id="l4.241" class="difflineminus">-                                         bool detaching) {</span>
<a href="#l4.242"></a><span id="l4.242" class="difflineplus">+nsresult nsMessenger::SaveAllAttachments(</span>
<a href="#l4.243"></a><span id="l4.243" class="difflineplus">+    const nsTArray&lt;nsCString&gt; &amp;contentTypeArray,</span>
<a href="#l4.244"></a><span id="l4.244" class="difflineplus">+    const nsTArray&lt;nsCString&gt; &amp;urlArray,</span>
<a href="#l4.245"></a><span id="l4.245" class="difflineplus">+    const nsTArray&lt;nsCString&gt; &amp;displayNameArray,</span>
<a href="#l4.246"></a><span id="l4.246" class="difflineplus">+    const nsTArray&lt;nsCString&gt; &amp;messageUriArray, bool detaching) {</span>
<a href="#l4.247"></a><span id="l4.247">   nsresult rv = NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.248"></a><span id="l4.248">   nsCOMPtr&lt;nsIFilePicker&gt; filePicker =</span>
<a href="#l4.249"></a><span id="l4.249">       do_CreateInstance(&quot;@mozilla.org/filepicker;1&quot;, &amp;rv);</span>
<a href="#l4.250"></a><span id="l4.250">   nsCOMPtr&lt;nsIFile&gt; localFile;</span>
<a href="#l4.251"></a><span id="l4.251">   nsCOMPtr&lt;nsIFile&gt; lastSaveDir;</span>
<a href="#l4.252"></a><span id="l4.252">   int16_t dialogResult;</span>
<a href="#l4.253"></a><span id="l4.253">   nsString saveAttachmentStr;</span>
<a href="#l4.254"></a><span id="l4.254"> </span>
<a href="#l4.255"></a><span id="l4.255" class="difflineat">@@ -870,31 +866,29 @@ nsresult nsMessenger::SaveAllAttachments</span>
<a href="#l4.256"></a><span id="l4.256">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.257"></a><span id="l4.257"> </span>
<a href="#l4.258"></a><span id="l4.258">   rv = SetLastSaveDirectory(localFile);</span>
<a href="#l4.259"></a><span id="l4.259">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.260"></a><span id="l4.260"> </span>
<a href="#l4.261"></a><span id="l4.261">   nsSaveAllAttachmentsState *saveState = nullptr;</span>
<a href="#l4.262"></a><span id="l4.262">   PathString dirName = localFile-&gt;NativePath();</span>
<a href="#l4.263"></a><span id="l4.263"> </span>
<a href="#l4.264"></a><span id="l4.264" class="difflineminus">-  saveState = new nsSaveAllAttachmentsState(count, contentTypeArray, urlArray,</span>
<a href="#l4.265"></a><span id="l4.265" class="difflineplus">+  saveState = new nsSaveAllAttachmentsState(contentTypeArray, urlArray,</span>
<a href="#l4.266"></a><span id="l4.266">                                             displayNameArray, messageUriArray,</span>
<a href="#l4.267"></a><span id="l4.267">                                             dirName.get(), detaching);</span>
<a href="#l4.268"></a><span id="l4.268">   nsString unescapedName;</span>
<a href="#l4.269"></a><span id="l4.269">   ConvertAndSanitizeFileName(displayNameArray[0], unescapedName);</span>
<a href="#l4.270"></a><span id="l4.270">   rv = localFile-&gt;Append(unescapedName);</span>
<a href="#l4.271"></a><span id="l4.271">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.272"></a><span id="l4.272"> </span>
<a href="#l4.273"></a><span id="l4.273">   rv = PromptIfFileExists(localFile);</span>
<a href="#l4.274"></a><span id="l4.274">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.275"></a><span id="l4.275"> </span>
<a href="#l4.276"></a><span id="l4.276" class="difflineminus">-  rv = SaveAttachment(localFile, nsDependentCString(urlArray[0]),</span>
<a href="#l4.277"></a><span id="l4.277" class="difflineminus">-                      nsDependentCString(messageUriArray[0]),</span>
<a href="#l4.278"></a><span id="l4.278" class="difflineminus">-                      nsDependentCString(contentTypeArray[0]),</span>
<a href="#l4.279"></a><span id="l4.279" class="difflineminus">-                      (void *)saveState, nullptr);</span>
<a href="#l4.280"></a><span id="l4.280" class="difflineplus">+  rv = SaveAttachment(localFile, urlArray[0], messageUriArray[0],</span>
<a href="#l4.281"></a><span id="l4.281" class="difflineplus">+                      contentTypeArray[0], (void *)saveState, nullptr);</span>
<a href="#l4.282"></a><span id="l4.282">   return rv;</span>
<a href="#l4.283"></a><span id="l4.283"> }</span>
<a href="#l4.284"></a><span id="l4.284"> </span>
<a href="#l4.285"></a><span id="l4.285"> enum MESSENGER_SAVEAS_FILE_TYPE {</span>
<a href="#l4.286"></a><span id="l4.286">   EML_FILE_TYPE = 0,</span>
<a href="#l4.287"></a><span id="l4.287">   HTML_FILE_TYPE = 1,</span>
<a href="#l4.288"></a><span id="l4.288">   TEXT_FILE_TYPE = 2,</span>
<a href="#l4.289"></a><span id="l4.289">   ANY_FILE_TYPE = 3</span>
<a href="#l4.290"></a><span id="l4.290" class="difflineat">@@ -1239,53 +1233,48 @@ nsresult nsMessenger::GetSaveToDir(nsIFi</span>
<a href="#l4.291"></a><span id="l4.291">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.292"></a><span id="l4.292"> </span>
<a href="#l4.293"></a><span id="l4.293">   *aSaveDir = nullptr;</span>
<a href="#l4.294"></a><span id="l4.294">   dir.forget(aSaveDir);</span>
<a href="#l4.295"></a><span id="l4.295">   return NS_OK;</span>
<a href="#l4.296"></a><span id="l4.296"> }</span>
<a href="#l4.297"></a><span id="l4.297"> </span>
<a href="#l4.298"></a><span id="l4.298"> NS_IMETHODIMP</span>
<a href="#l4.299"></a><span id="l4.299" class="difflineminus">-nsMessenger::SaveMessages(uint32_t aCount, const char16_t **aFilenameArray,</span>
<a href="#l4.300"></a><span id="l4.300" class="difflineminus">-                          const char **aMessageUriArray) {</span>
<a href="#l4.301"></a><span id="l4.301" class="difflineminus">-  NS_ENSURE_ARG_MIN(aCount, 1);</span>
<a href="#l4.302"></a><span id="l4.302" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aFilenameArray);</span>
<a href="#l4.303"></a><span id="l4.303" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aMessageUriArray);</span>
<a href="#l4.304"></a><span id="l4.304" class="difflineplus">+nsMessenger::SaveMessages(const nsTArray&lt;nsString&gt; &amp;aFilenameArray,</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineplus">+                          const nsTArray&lt;nsCString&gt; &amp;aMessageUriArray) {</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+  MOZ_ASSERT(aFilenameArray.Length() == aMessageUriArray.Length());</span>
<a href="#l4.307"></a><span id="l4.307"> </span>
<a href="#l4.308"></a><span id="l4.308">   nsresult rv;</span>
<a href="#l4.309"></a><span id="l4.309"> </span>
<a href="#l4.310"></a><span id="l4.310">   nsCOMPtr&lt;nsIFile&gt; saveDir;</span>
<a href="#l4.311"></a><span id="l4.311">   rv = GetSaveToDir(getter_AddRefs(saveDir));</span>
<a href="#l4.312"></a><span id="l4.312">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.313"></a><span id="l4.313">   if (!saveDir)  // A null saveDir means that the user canceled the save.</span>
<a href="#l4.314"></a><span id="l4.314">     return NS_OK;</span>
<a href="#l4.315"></a><span id="l4.315"> </span>
<a href="#l4.316"></a><span id="l4.316" class="difflineminus">-  for (uint32_t i = 0; i &lt; aCount; i++) {</span>
<a href="#l4.317"></a><span id="l4.317" class="difflineminus">-    if (!aFilenameArray[i])  // just to be sure</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l4.319"></a><span id="l4.319" class="difflineminus">-</span>
<a href="#l4.320"></a><span id="l4.320" class="difflineplus">+  for (uint32_t i = 0; i &lt; aFilenameArray.Length(); i++) {</span>
<a href="#l4.321"></a><span id="l4.321">     nsCOMPtr&lt;nsIFile&gt; saveToFile =</span>
<a href="#l4.322"></a><span id="l4.322">         do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l4.323"></a><span id="l4.323">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.324"></a><span id="l4.324">     rv = saveToFile-&gt;InitWithFile(saveDir);</span>
<a href="#l4.325"></a><span id="l4.325">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.326"></a><span id="l4.326"> </span>
<a href="#l4.327"></a><span id="l4.327" class="difflineminus">-    rv = saveToFile-&gt;Append(nsDependentString(aFilenameArray[i]));</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+    rv = saveToFile-&gt;Append(aFilenameArray[i]);</span>
<a href="#l4.329"></a><span id="l4.329">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.330"></a><span id="l4.330"> </span>
<a href="#l4.331"></a><span id="l4.331">     rv = AdjustFileIfNameTooLong(saveToFile);</span>
<a href="#l4.332"></a><span id="l4.332">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.333"></a><span id="l4.333"> </span>
<a href="#l4.334"></a><span id="l4.334">     rv = PromptIfFileExists(saveToFile);</span>
<a href="#l4.335"></a><span id="l4.335">     if (NS_FAILED(rv)) continue;</span>
<a href="#l4.336"></a><span id="l4.336"> </span>
<a href="#l4.337"></a><span id="l4.337">     nsCOMPtr&lt;nsIMsgMessageService&gt; messageService;</span>
<a href="#l4.338"></a><span id="l4.338">     nsCOMPtr&lt;nsIUrlListener&gt; urlListener;</span>
<a href="#l4.339"></a><span id="l4.339"> </span>
<a href="#l4.340"></a><span id="l4.340" class="difflineminus">-    rv = GetMessageServiceFromURI(nsDependentCString(aMessageUriArray[i]),</span>
<a href="#l4.341"></a><span id="l4.341" class="difflineplus">+    rv = GetMessageServiceFromURI(aMessageUriArray[i],</span>
<a href="#l4.342"></a><span id="l4.342">                                   getter_AddRefs(messageService));</span>
<a href="#l4.343"></a><span id="l4.343">     if (NS_FAILED(rv)) {</span>
<a href="#l4.344"></a><span id="l4.344">       Alert(&quot;saveMessageFailed&quot;);</span>
<a href="#l4.345"></a><span id="l4.345">       return rv;</span>
<a href="#l4.346"></a><span id="l4.346">     }</span>
<a href="#l4.347"></a><span id="l4.347"> </span>
<a href="#l4.348"></a><span id="l4.348">     RefPtr&lt;nsSaveMsgListener&gt; saveListener =</span>
<a href="#l4.349"></a><span id="l4.349">         new nsSaveMsgListener(saveToFile, this, nullptr);</span>
<a href="#l4.350"></a><span id="l4.350" class="difflineat">@@ -1295,17 +1284,17 @@ nsMessenger::SaveMessages(uint32_t aCoun</span>
<a href="#l4.351"></a><span id="l4.351">     if (NS_FAILED(rv)) {</span>
<a href="#l4.352"></a><span id="l4.352">       Alert(&quot;saveMessageFailed&quot;);</span>
<a href="#l4.353"></a><span id="l4.353">       return rv;</span>
<a href="#l4.354"></a><span id="l4.354">     }</span>
<a href="#l4.355"></a><span id="l4.355"> </span>
<a href="#l4.356"></a><span id="l4.356">     // Ok, now save the message.</span>
<a href="#l4.357"></a><span id="l4.357">     nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l4.358"></a><span id="l4.358">     rv = messageService-&gt;SaveMessageToDisk(</span>
<a href="#l4.359"></a><span id="l4.359" class="difflineminus">-        aMessageUriArray[i], saveToFile, false, urlListener,</span>
<a href="#l4.360"></a><span id="l4.360" class="difflineplus">+        aMessageUriArray[i].get(), saveToFile, false, urlListener,</span>
<a href="#l4.361"></a><span id="l4.361">         getter_AddRefs(dummyNull), true, mMsgWindow);</span>
<a href="#l4.362"></a><span id="l4.362">     if (NS_FAILED(rv)) {</span>
<a href="#l4.363"></a><span id="l4.363">       Alert(&quot;saveMessageFailed&quot;);</span>
<a href="#l4.364"></a><span id="l4.364">       return rv;</span>
<a href="#l4.365"></a><span id="l4.365">     }</span>
<a href="#l4.366"></a><span id="l4.366">   }</span>
<a href="#l4.367"></a><span id="l4.367">   return rv;</span>
<a href="#l4.368"></a><span id="l4.368"> }</span>
<a href="#l4.369"></a><span id="l4.369" class="difflineat">@@ -1716,35 +1705,31 @@ nsSaveMsgListener::OnStopRequest(nsIRequ</span>
<a href="#l4.370"></a><span id="l4.370">         rv = m_messenger-&gt;PromptIfFileExists(localFile);</span>
<a href="#l4.371"></a><span id="l4.371">         if (NS_FAILED(rv)) goto done;</span>
<a href="#l4.372"></a><span id="l4.372">       } else {</span>
<a href="#l4.373"></a><span id="l4.373">         rv = localFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE,</span>
<a href="#l4.374"></a><span id="l4.374">                                      ATTACHMENT_PERMISSION);</span>
<a href="#l4.375"></a><span id="l4.375">         if (NS_FAILED(rv)) goto done;</span>
<a href="#l4.376"></a><span id="l4.376">       }</span>
<a href="#l4.377"></a><span id="l4.377">       rv = m_messenger-&gt;SaveAttachment(</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineminus">-          localFile, nsDependentCString(state-&gt;m_urlArray[i]),</span>
<a href="#l4.379"></a><span id="l4.379" class="difflineminus">-          nsDependentCString(state-&gt;m_messageUriArray[i]),</span>
<a href="#l4.380"></a><span id="l4.380" class="difflineminus">-          nsDependentCString(state-&gt;m_contentTypeArray[i]), (void *)state,</span>
<a href="#l4.381"></a><span id="l4.381" class="difflineminus">-          nullptr);</span>
<a href="#l4.382"></a><span id="l4.382" class="difflineplus">+          localFile, state-&gt;m_urlArray[i], state-&gt;m_messageUriArray[i],</span>
<a href="#l4.383"></a><span id="l4.383" class="difflineplus">+          state-&gt;m_contentTypeArray[i], (void *)state, nullptr);</span>
<a href="#l4.384"></a><span id="l4.384">     done:</span>
<a href="#l4.385"></a><span id="l4.385">       if (NS_FAILED(rv)) {</span>
<a href="#l4.386"></a><span id="l4.386">         delete state;</span>
<a href="#l4.387"></a><span id="l4.387">         m_saveAllAttachmentsState = nullptr;</span>
<a href="#l4.388"></a><span id="l4.388">       }</span>
<a href="#l4.389"></a><span id="l4.389">     } else {</span>
<a href="#l4.390"></a><span id="l4.390">       // check if we're saving attachments prior to detaching them.</span>
<a href="#l4.391"></a><span id="l4.391">       if (m_saveAllAttachmentsState-&gt;m_detachingAttachments &amp;&amp; !mCanceled) {</span>
<a href="#l4.392"></a><span id="l4.392">         nsSaveAllAttachmentsState *state = m_saveAllAttachmentsState;</span>
<a href="#l4.393"></a><span id="l4.393">         m_messenger-&gt;DetachAttachments(</span>
<a href="#l4.394"></a><span id="l4.394" class="difflineminus">-            state-&gt;m_count, (const char **)state-&gt;m_contentTypeArray,</span>
<a href="#l4.395"></a><span id="l4.395" class="difflineminus">-            (const char **)state-&gt;m_urlArray,</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineminus">-            (const char **)state-&gt;m_displayNameArray,</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineminus">-            (const char **)state-&gt;m_messageUriArray, &amp;state-&gt;m_savedFiles,</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineminus">-            state-&gt;m_withoutWarning);</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+            state-&gt;m_contentTypeArray, state-&gt;m_urlArray,</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+            state-&gt;m_displayNameArray, state-&gt;m_messageUriArray,</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+            &amp;state-&gt;m_savedFiles, state-&gt;m_withoutWarning);</span>
<a href="#l4.402"></a><span id="l4.402">       }</span>
<a href="#l4.403"></a><span id="l4.403"> </span>
<a href="#l4.404"></a><span id="l4.404">       delete m_saveAllAttachmentsState;</span>
<a href="#l4.405"></a><span id="l4.405">       m_saveAllAttachmentsState = nullptr;</span>
<a href="#l4.406"></a><span id="l4.406">     }</span>
<a href="#l4.407"></a><span id="l4.407">   }</span>
<a href="#l4.408"></a><span id="l4.408"> </span>
<a href="#l4.409"></a><span id="l4.409">   if (mTransfer) {</span>
<a href="#l4.410"></a><span id="l4.410" class="difflineat">@@ -1834,52 +1819,36 @@ void nsMessenger::GetString(const nsStri</span>
<a href="#l4.411"></a><span id="l4.411">   else</span>
<a href="#l4.412"></a><span id="l4.412">     rv = NS_ERROR_FAILURE;</span>
<a href="#l4.413"></a><span id="l4.413"> </span>
<a href="#l4.414"></a><span id="l4.414">   if (NS_FAILED(rv) || aValue.IsEmpty()) aValue = aStringName;</span>
<a href="#l4.415"></a><span id="l4.415">   return;</span>
<a href="#l4.416"></a><span id="l4.416"> }</span>
<a href="#l4.417"></a><span id="l4.417"> </span>
<a href="#l4.418"></a><span id="l4.418"> nsSaveAllAttachmentsState::nsSaveAllAttachmentsState(</span>
<a href="#l4.419"></a><span id="l4.419" class="difflineminus">-    uint32_t count, const char **contentTypeArray, const char **urlArray,</span>
<a href="#l4.420"></a><span id="l4.420" class="difflineminus">-    const char **nameArray, const char **uriArray, const PathChar *dirName,</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineplus">+    const nsTArray&lt;nsCString&gt; &amp;contentTypeArray,</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineplus">+    const nsTArray&lt;nsCString&gt; &amp;urlArray,</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+    const nsTArray&lt;nsCString&gt; &amp;displayNameArray,</span>
<a href="#l4.424"></a><span id="l4.424" class="difflineplus">+    const nsTArray&lt;nsCString&gt; &amp;messageUriArray, const PathChar *dirName,</span>
<a href="#l4.425"></a><span id="l4.425">     bool detachingAttachments)</span>
<a href="#l4.426"></a><span id="l4.426" class="difflineminus">-    : m_withoutWarning(false) {</span>
<a href="#l4.427"></a><span id="l4.427" class="difflineminus">-  uint32_t i;</span>
<a href="#l4.428"></a><span id="l4.428" class="difflineminus">-  NS_ASSERTION(count &amp;&amp; urlArray &amp;&amp; nameArray &amp;&amp; uriArray &amp;&amp; dirName,</span>
<a href="#l4.429"></a><span id="l4.429" class="difflineminus">-               &quot;fatal - invalid parameters\n&quot;);</span>
<a href="#l4.430"></a><span id="l4.430" class="difflineminus">-</span>
<a href="#l4.431"></a><span id="l4.431" class="difflineminus">-  m_count = count;</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineplus">+    : m_contentTypeArray(contentTypeArray),</span>
<a href="#l4.433"></a><span id="l4.433" class="difflineplus">+      m_urlArray(urlArray),</span>
<a href="#l4.434"></a><span id="l4.434" class="difflineplus">+      m_displayNameArray(displayNameArray),</span>
<a href="#l4.435"></a><span id="l4.435" class="difflineplus">+      m_messageUriArray(messageUriArray),</span>
<a href="#l4.436"></a><span id="l4.436" class="difflineplus">+      m_detachingAttachments(detachingAttachments),</span>
<a href="#l4.437"></a><span id="l4.437" class="difflineplus">+      m_withoutWarning(false) {</span>
<a href="#l4.438"></a><span id="l4.438" class="difflineplus">+  MOZ_ASSERT(contentTypeArray.Length() == urlArray.Length() ==</span>
<a href="#l4.439"></a><span id="l4.439" class="difflineplus">+             displayNameArray.Length() == messageUriArray.Length());</span>
<a href="#l4.440"></a><span id="l4.440" class="difflineplus">+</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+  m_count = contentTypeArray.Length();</span>
<a href="#l4.442"></a><span id="l4.442">   m_curIndex = 0;</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineminus">-  m_contentTypeArray = new char *[count];</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineminus">-  m_urlArray = new char *[count];</span>
<a href="#l4.445"></a><span id="l4.445" class="difflineminus">-  m_displayNameArray = new char *[count];</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineminus">-  m_messageUriArray = new char *[count];</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineminus">-  for (i = 0; i &lt; count; i++) {</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineminus">-    m_contentTypeArray[i] = strdup(contentTypeArray[i]);</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineminus">-    m_urlArray[i] = strdup(urlArray[i]);</span>
<a href="#l4.450"></a><span id="l4.450" class="difflineminus">-    m_displayNameArray[i] = strdup(nameArray[i]);</span>
<a href="#l4.451"></a><span id="l4.451" class="difflineminus">-    m_messageUriArray[i] = strdup(uriArray[i]);</span>
<a href="#l4.452"></a><span id="l4.452" class="difflineminus">-  }</span>
<a href="#l4.453"></a><span id="l4.453">   m_directoryName = NS_xstrdup(dirName);</span>
<a href="#l4.454"></a><span id="l4.454" class="difflineminus">-  m_detachingAttachments = detachingAttachments;</span>
<a href="#l4.455"></a><span id="l4.455"> }</span>
<a href="#l4.456"></a><span id="l4.456"> </span>
<a href="#l4.457"></a><span id="l4.457"> nsSaveAllAttachmentsState::~nsSaveAllAttachmentsState() {</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineminus">-  uint32_t i;</span>
<a href="#l4.459"></a><span id="l4.459" class="difflineminus">-  for (i = 0; i &lt; m_count; i++) {</span>
<a href="#l4.460"></a><span id="l4.460" class="difflineminus">-    free(m_contentTypeArray[i]);</span>
<a href="#l4.461"></a><span id="l4.461" class="difflineminus">-    free(m_urlArray[i]);</span>
<a href="#l4.462"></a><span id="l4.462" class="difflineminus">-    free(m_displayNameArray[i]);</span>
<a href="#l4.463"></a><span id="l4.463" class="difflineminus">-    free(m_messageUriArray[i]);</span>
<a href="#l4.464"></a><span id="l4.464" class="difflineminus">-  }</span>
<a href="#l4.465"></a><span id="l4.465" class="difflineminus">-  delete[] m_contentTypeArray;</span>
<a href="#l4.466"></a><span id="l4.466" class="difflineminus">-  delete[] m_urlArray;</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineminus">-  delete[] m_displayNameArray;</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineminus">-  delete[] m_messageUriArray;</span>
<a href="#l4.469"></a><span id="l4.469">   free(m_directoryName);</span>
<a href="#l4.470"></a><span id="l4.470"> }</span>
<a href="#l4.471"></a><span id="l4.471"> </span>
<a href="#l4.472"></a><span id="l4.472"> nsresult nsMessenger::GetLastSaveDirectory(nsIFile **aLastSaveDir) {</span>
<a href="#l4.473"></a><span id="l4.473">   nsresult rv;</span>
<a href="#l4.474"></a><span id="l4.474">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch =</span>
<a href="#l4.475"></a><span id="l4.475">       do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l4.476"></a><span id="l4.476">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.477"></a><span id="l4.477" class="difflineat">@@ -2125,110 +2094,67 @@ static int CompareAttachmentPartId(const</span>
<a href="#l4.478"></a><span id="l4.478">     ++partIdRight;</span>
<a href="#l4.479"></a><span id="l4.479">   } while (true);</span>
<a href="#l4.480"></a><span id="l4.480"> }</span>
<a href="#l4.481"></a><span id="l4.481"> </span>
<a href="#l4.482"></a><span id="l4.482"> // ------------------------------------</span>
<a href="#l4.483"></a><span id="l4.483"> </span>
<a href="#l4.484"></a><span id="l4.484"> // struct on purpose -&gt; show that we don't ever want a vtable</span>
<a href="#l4.485"></a><span id="l4.485"> struct msgAttachment {</span>
<a href="#l4.486"></a><span id="l4.486" class="difflineminus">-  msgAttachment()</span>
<a href="#l4.487"></a><span id="l4.487" class="difflineminus">-      : mContentType(nullptr),</span>
<a href="#l4.488"></a><span id="l4.488" class="difflineminus">-        mUrl(nullptr),</span>
<a href="#l4.489"></a><span id="l4.489" class="difflineminus">-        mDisplayName(nullptr),</span>
<a href="#l4.490"></a><span id="l4.490" class="difflineminus">-        mMessageUri(nullptr) {}</span>
<a href="#l4.491"></a><span id="l4.491" class="difflineminus">-</span>
<a href="#l4.492"></a><span id="l4.492" class="difflineminus">-  ~msgAttachment() { Clear(); }</span>
<a href="#l4.493"></a><span id="l4.493" class="difflineminus">-</span>
<a href="#l4.494"></a><span id="l4.494" class="difflineminus">-  void Clear() {</span>
<a href="#l4.495"></a><span id="l4.495" class="difflineminus">-    free(mContentType);</span>
<a href="#l4.496"></a><span id="l4.496" class="difflineminus">-    free(mUrl);</span>
<a href="#l4.497"></a><span id="l4.497" class="difflineminus">-    free(mDisplayName);</span>
<a href="#l4.498"></a><span id="l4.498" class="difflineminus">-    free(mMessageUri);</span>
<a href="#l4.499"></a><span id="l4.499" class="difflineminus">-  }</span>
<a href="#l4.500"></a><span id="l4.500" class="difflineminus">-</span>
<a href="#l4.501"></a><span id="l4.501" class="difflineminus">-  bool Init(const char *aContentType, const char *aUrl,</span>
<a href="#l4.502"></a><span id="l4.502" class="difflineminus">-            const char *aDisplayName, const char *aMessageUri) {</span>
<a href="#l4.503"></a><span id="l4.503" class="difflineminus">-    Clear();</span>
<a href="#l4.504"></a><span id="l4.504" class="difflineminus">-    mContentType = strdup(aContentType);</span>
<a href="#l4.505"></a><span id="l4.505" class="difflineminus">-    mUrl = strdup(aUrl);</span>
<a href="#l4.506"></a><span id="l4.506" class="difflineminus">-    mDisplayName = strdup(aDisplayName);</span>
<a href="#l4.507"></a><span id="l4.507" class="difflineminus">-    mMessageUri = strdup(aMessageUri);</span>
<a href="#l4.508"></a><span id="l4.508" class="difflineminus">-    return (mContentType &amp;&amp; mUrl &amp;&amp; mDisplayName &amp;&amp; mMessageUri);</span>
<a href="#l4.509"></a><span id="l4.509" class="difflineminus">-  }</span>
<a href="#l4.510"></a><span id="l4.510" class="difflineminus">-</span>
<a href="#l4.511"></a><span id="l4.511" class="difflineminus">-  // take the pointers from aSource</span>
<a href="#l4.512"></a><span id="l4.512" class="difflineminus">-  void Adopt(msgAttachment &amp;aSource) {</span>
<a href="#l4.513"></a><span id="l4.513" class="difflineminus">-    Clear();</span>
<a href="#l4.514"></a><span id="l4.514" class="difflineminus">-</span>
<a href="#l4.515"></a><span id="l4.515" class="difflineminus">-    mContentType = aSource.mContentType;</span>
<a href="#l4.516"></a><span id="l4.516" class="difflineminus">-    mUrl = aSource.mUrl;</span>
<a href="#l4.517"></a><span id="l4.517" class="difflineminus">-    mDisplayName = aSource.mDisplayName;</span>
<a href="#l4.518"></a><span id="l4.518" class="difflineminus">-    mMessageUri = aSource.mMessageUri;</span>
<a href="#l4.519"></a><span id="l4.519" class="difflineminus">-</span>
<a href="#l4.520"></a><span id="l4.520" class="difflineminus">-    aSource.mContentType = nullptr;</span>
<a href="#l4.521"></a><span id="l4.521" class="difflineminus">-    aSource.mUrl = nullptr;</span>
<a href="#l4.522"></a><span id="l4.522" class="difflineminus">-    aSource.mDisplayName = nullptr;</span>
<a href="#l4.523"></a><span id="l4.523" class="difflineminus">-    aSource.mMessageUri = nullptr;</span>
<a href="#l4.524"></a><span id="l4.524" class="difflineminus">-  }</span>
<a href="#l4.525"></a><span id="l4.525" class="difflineminus">-</span>
<a href="#l4.526"></a><span id="l4.526" class="difflineminus">-  char *mContentType;</span>
<a href="#l4.527"></a><span id="l4.527" class="difflineminus">-  char *mUrl;</span>
<a href="#l4.528"></a><span id="l4.528" class="difflineminus">-  char *mDisplayName;</span>
<a href="#l4.529"></a><span id="l4.529" class="difflineminus">-  char *mMessageUri;</span>
<a href="#l4.530"></a><span id="l4.530" class="difflineminus">-</span>
<a href="#l4.531"></a><span id="l4.531" class="difflineminus">- private:</span>
<a href="#l4.532"></a><span id="l4.532" class="difflineminus">-  // disable by not implementing</span>
<a href="#l4.533"></a><span id="l4.533" class="difflineminus">-  msgAttachment(const msgAttachment &amp;rhs);</span>
<a href="#l4.534"></a><span id="l4.534" class="difflineminus">-  msgAttachment &amp;operator=(const msgAttachment &amp;rhs);</span>
<a href="#l4.535"></a><span id="l4.535" class="difflineplus">+  msgAttachment(const nsACString &amp;aContentType, const nsACString &amp;aUrl,</span>
<a href="#l4.536"></a><span id="l4.536" class="difflineplus">+                const nsACString &amp;aDisplayName, const nsACString &amp;aMessageUri)</span>
<a href="#l4.537"></a><span id="l4.537" class="difflineplus">+      : mContentType(aContentType),</span>
<a href="#l4.538"></a><span id="l4.538" class="difflineplus">+        mUrl(aUrl),</span>
<a href="#l4.539"></a><span id="l4.539" class="difflineplus">+        mDisplayName(aDisplayName),</span>
<a href="#l4.540"></a><span id="l4.540" class="difflineplus">+        mMessageUri(aMessageUri) {}</span>
<a href="#l4.541"></a><span id="l4.541" class="difflineplus">+</span>
<a href="#l4.542"></a><span id="l4.542" class="difflineplus">+  nsCString mContentType;</span>
<a href="#l4.543"></a><span id="l4.543" class="difflineplus">+  nsCString mUrl;</span>
<a href="#l4.544"></a><span id="l4.544" class="difflineplus">+  nsCString mDisplayName;</span>
<a href="#l4.545"></a><span id="l4.545" class="difflineplus">+  nsCString mMessageUri;</span>
<a href="#l4.546"></a><span id="l4.546"> };</span>
<a href="#l4.547"></a><span id="l4.547"> </span>
<a href="#l4.548"></a><span id="l4.548"> // ------------------------------------</span>
<a href="#l4.549"></a><span id="l4.549"> </span>
<a href="#l4.550"></a><span id="l4.550"> class nsAttachmentState {</span>
<a href="#l4.551"></a><span id="l4.551">  public:</span>
<a href="#l4.552"></a><span id="l4.552">   nsAttachmentState();</span>
<a href="#l4.553"></a><span id="l4.553" class="difflineminus">-  ~nsAttachmentState();</span>
<a href="#l4.554"></a><span id="l4.554" class="difflineminus">-  nsresult Init(uint32_t aCount, const char **aContentTypeArray,</span>
<a href="#l4.555"></a><span id="l4.555" class="difflineminus">-                const char **aUrlArray, const char **aDisplayNameArray,</span>
<a href="#l4.556"></a><span id="l4.556" class="difflineminus">-                const char **aMessageUriArray);</span>
<a href="#l4.557"></a><span id="l4.557" class="difflineplus">+  nsresult Init(const nsTArray&lt;nsCString&gt; &amp;aContentTypeArray,</span>
<a href="#l4.558"></a><span id="l4.558" class="difflineplus">+                const nsTArray&lt;nsCString&gt; &amp;aUrlArray,</span>
<a href="#l4.559"></a><span id="l4.559" class="difflineplus">+                const nsTArray&lt;nsCString&gt; &amp;aDisplayNameArray,</span>
<a href="#l4.560"></a><span id="l4.560" class="difflineplus">+                const nsTArray&lt;nsCString&gt; &amp;aMessageUriArray);</span>
<a href="#l4.561"></a><span id="l4.561">   nsresult PrepareForAttachmentDelete();</span>
<a href="#l4.562"></a><span id="l4.562"> </span>
<a href="#l4.563"></a><span id="l4.563">  private:</span>
<a href="#l4.564"></a><span id="l4.564" class="difflineminus">-  static int SortAttachmentsByPartId(const void *aLeft, const void *aRight);</span>
<a href="#l4.565"></a><span id="l4.565" class="difflineplus">+  static int CompareAttachmentsByPartId(const void *aLeft, const void *aRight);</span>
<a href="#l4.566"></a><span id="l4.566"> </span>
<a href="#l4.567"></a><span id="l4.567">  public:</span>
<a href="#l4.568"></a><span id="l4.568" class="difflineminus">-  uint32_t mCount;</span>
<a href="#l4.569"></a><span id="l4.569">   uint32_t mCurIndex;</span>
<a href="#l4.570"></a><span id="l4.570" class="difflineminus">-  msgAttachment *mAttachmentArray;</span>
<a href="#l4.571"></a><span id="l4.571" class="difflineplus">+  nsTArray&lt;msgAttachment&gt; mAttachmentArray;</span>
<a href="#l4.572"></a><span id="l4.572"> };</span>
<a href="#l4.573"></a><span id="l4.573"> </span>
<a href="#l4.574"></a><span id="l4.574" class="difflineminus">-nsAttachmentState::nsAttachmentState()</span>
<a href="#l4.575"></a><span id="l4.575" class="difflineminus">-    : mCount(0), mCurIndex(0), mAttachmentArray(nullptr) {}</span>
<a href="#l4.576"></a><span id="l4.576" class="difflineminus">-</span>
<a href="#l4.577"></a><span id="l4.577" class="difflineminus">-nsAttachmentState::~nsAttachmentState() { delete[] mAttachmentArray; }</span>
<a href="#l4.578"></a><span id="l4.578" class="difflineminus">-</span>
<a href="#l4.579"></a><span id="l4.579" class="difflineminus">-nsresult nsAttachmentState::Init(uint32_t aCount,</span>
<a href="#l4.580"></a><span id="l4.580" class="difflineminus">-                                 const char **aContentTypeArray,</span>
<a href="#l4.581"></a><span id="l4.581" class="difflineminus">-                                 const char **aUrlArray,</span>
<a href="#l4.582"></a><span id="l4.582" class="difflineminus">-                                 const char **aDisplayNameArray,</span>
<a href="#l4.583"></a><span id="l4.583" class="difflineminus">-                                 const char **aMessageUriArray) {</span>
<a href="#l4.584"></a><span id="l4.584" class="difflineminus">-  MOZ_ASSERT(aCount &gt; 0, &quot;count is invalid&quot;);</span>
<a href="#l4.585"></a><span id="l4.585" class="difflineminus">-</span>
<a href="#l4.586"></a><span id="l4.586" class="difflineminus">-  mCount = aCount;</span>
<a href="#l4.587"></a><span id="l4.587" class="difflineplus">+nsAttachmentState::nsAttachmentState() : mCurIndex(0) {}</span>
<a href="#l4.588"></a><span id="l4.588" class="difflineplus">+</span>
<a href="#l4.589"></a><span id="l4.589" class="difflineplus">+nsresult nsAttachmentState::Init(const nsTArray&lt;nsCString&gt; &amp;aContentTypeArray,</span>
<a href="#l4.590"></a><span id="l4.590" class="difflineplus">+                                 const nsTArray&lt;nsCString&gt; &amp;aUrlArray,</span>
<a href="#l4.591"></a><span id="l4.591" class="difflineplus">+                                 const nsTArray&lt;nsCString&gt; &amp;aDisplayNameArray,</span>
<a href="#l4.592"></a><span id="l4.592" class="difflineplus">+                                 const nsTArray&lt;nsCString&gt; &amp;aMessageUriArray) {</span>
<a href="#l4.593"></a><span id="l4.593" class="difflineplus">+  MOZ_ASSERT(aContentTypeArray.Length() &gt; 0);</span>
<a href="#l4.594"></a><span id="l4.594" class="difflineplus">+  MOZ_ASSERT(aContentTypeArray.Length() == aUrlArray.Length() ==</span>
<a href="#l4.595"></a><span id="l4.595" class="difflineplus">+             aDisplayNameArray.Length() == aMessageUriArray.Length());</span>
<a href="#l4.596"></a><span id="l4.596" class="difflineplus">+</span>
<a href="#l4.597"></a><span id="l4.597" class="difflineplus">+  uint32_t count = aContentTypeArray.Length();</span>
<a href="#l4.598"></a><span id="l4.598">   mCurIndex = 0;</span>
<a href="#l4.599"></a><span id="l4.599" class="difflineminus">-  delete[] mAttachmentArray;</span>
<a href="#l4.600"></a><span id="l4.600" class="difflineminus">-</span>
<a href="#l4.601"></a><span id="l4.601" class="difflineminus">-  mAttachmentArray = new msgAttachment[aCount];</span>
<a href="#l4.602"></a><span id="l4.602" class="difflineminus">-  if (!mAttachmentArray) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.603"></a><span id="l4.603" class="difflineminus">-</span>
<a href="#l4.604"></a><span id="l4.604" class="difflineminus">-  for (uint32_t u = 0; u &lt; aCount; ++u) {</span>
<a href="#l4.605"></a><span id="l4.605" class="difflineminus">-    if (!mAttachmentArray[u].Init(aContentTypeArray[u], aUrlArray[u],</span>
<a href="#l4.606"></a><span id="l4.606" class="difflineminus">-                                  aDisplayNameArray[u], aMessageUriArray[u]))</span>
<a href="#l4.607"></a><span id="l4.607" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.608"></a><span id="l4.608" class="difflineplus">+  mAttachmentArray.Clear();</span>
<a href="#l4.609"></a><span id="l4.609" class="difflineplus">+  mAttachmentArray.SetCapacity(count);</span>
<a href="#l4.610"></a><span id="l4.610" class="difflineplus">+</span>
<a href="#l4.611"></a><span id="l4.611" class="difflineplus">+  for (uint32_t u = 0; u &lt; count; ++u) {</span>
<a href="#l4.612"></a><span id="l4.612" class="difflineplus">+    mAttachmentArray.AppendElement(</span>
<a href="#l4.613"></a><span id="l4.613" class="difflineplus">+        msgAttachment(aContentTypeArray[u], aUrlArray[u], aDisplayNameArray[u],</span>
<a href="#l4.614"></a><span id="l4.614" class="difflineplus">+                      aMessageUriArray[u]));</span>
<a href="#l4.615"></a><span id="l4.615">   }</span>
<a href="#l4.616"></a><span id="l4.616"> </span>
<a href="#l4.617"></a><span id="l4.617">   return NS_OK;</span>
<a href="#l4.618"></a><span id="l4.618"> }</span>
<a href="#l4.619"></a><span id="l4.619"> </span>
<a href="#l4.620"></a><span id="l4.620"> nsresult nsAttachmentState::PrepareForAttachmentDelete() {</span>
<a href="#l4.621"></a><span id="l4.621">   // this must be called before any processing</span>
<a href="#l4.622"></a><span id="l4.622">   if (mCurIndex != 0) return NS_ERROR_FAILURE;</span>
<a href="#l4.623"></a><span id="l4.623" class="difflineat">@@ -2239,46 +2165,44 @@ nsresult nsAttachmentState::PrepareForAt</span>
<a href="#l4.624"></a><span id="l4.624">   // automatically by the removal of the parent.</span>
<a href="#l4.625"></a><span id="l4.625">   //</span>
<a href="#l4.626"></a><span id="l4.626">   // e.g. the attachment list processing (showing only part ids)</span>
<a href="#l4.627"></a><span id="l4.627">   // before: 1.11, 1.3, 1.2, 1.2.1.3, 1.4.1.2</span>
<a href="#l4.628"></a><span id="l4.628">   // sorted: 1.2, 1.2.1.3, 1.3, 1.4.1.2, 1.11</span>
<a href="#l4.629"></a><span id="l4.629">   // after:  1.2, 1.3, 1.4.1.2, 1.11</span>
<a href="#l4.630"></a><span id="l4.630"> </span>
<a href="#l4.631"></a><span id="l4.631">   // sort</span>
<a href="#l4.632"></a><span id="l4.632" class="difflineminus">-  qsort(mAttachmentArray, mCount, sizeof(msgAttachment),</span>
<a href="#l4.633"></a><span id="l4.633" class="difflineminus">-        SortAttachmentsByPartId);</span>
<a href="#l4.634"></a><span id="l4.634" class="difflineplus">+  qsort(mAttachmentArray.Elements(), mAttachmentArray.Length(),</span>
<a href="#l4.635"></a><span id="l4.635" class="difflineplus">+        sizeof(msgAttachment), CompareAttachmentsByPartId);</span>
<a href="#l4.636"></a><span id="l4.636"> </span>
<a href="#l4.637"></a><span id="l4.637">   // remove duplicates and sub-items</span>
<a href="#l4.638"></a><span id="l4.638">   int nCompare;</span>
<a href="#l4.639"></a><span id="l4.639" class="difflineminus">-  for (uint32_t u = 1; u &lt; mCount;) {</span>
<a href="#l4.640"></a><span id="l4.640" class="difflineminus">-    nCompare = ::CompareAttachmentPartId(mAttachmentArray[u - 1].mUrl,</span>
<a href="#l4.641"></a><span id="l4.641" class="difflineminus">-                                         mAttachmentArray[u].mUrl);</span>
<a href="#l4.642"></a><span id="l4.642" class="difflineplus">+  for (uint32_t u = 1; u &lt; mAttachmentArray.Length();) {</span>
<a href="#l4.643"></a><span id="l4.643" class="difflineplus">+    nCompare = ::CompareAttachmentPartId(mAttachmentArray[u - 1].mUrl.get(),</span>
<a href="#l4.644"></a><span id="l4.644" class="difflineplus">+                                         mAttachmentArray[u].mUrl.get());</span>
<a href="#l4.645"></a><span id="l4.645">     if (nCompare == 0 ||</span>
<a href="#l4.646"></a><span id="l4.646">         nCompare == -2)  // [u-1] is the same as or a parent of [u]</span>
<a href="#l4.647"></a><span id="l4.647">     {</span>
<a href="#l4.648"></a><span id="l4.648">       // shuffle the array down (and thus keeping the sorted order)</span>
<a href="#l4.649"></a><span id="l4.649" class="difflineminus">-      // this will get rid of the current unnecessary element</span>
<a href="#l4.650"></a><span id="l4.650" class="difflineminus">-      for (uint32_t i = u + 1; i &lt; mCount; ++i) {</span>
<a href="#l4.651"></a><span id="l4.651" class="difflineminus">-        mAttachmentArray[i - 1].Adopt(mAttachmentArray[i]);</span>
<a href="#l4.652"></a><span id="l4.652" class="difflineminus">-      }</span>
<a href="#l4.653"></a><span id="l4.653" class="difflineminus">-      --mCount;</span>
<a href="#l4.654"></a><span id="l4.654" class="difflineplus">+      mAttachmentArray.RemoveElementAt(u);</span>
<a href="#l4.655"></a><span id="l4.655">     } else {</span>
<a href="#l4.656"></a><span id="l4.656">       ++u;</span>
<a href="#l4.657"></a><span id="l4.657">     }</span>
<a href="#l4.658"></a><span id="l4.658">   }</span>
<a href="#l4.659"></a><span id="l4.659"> </span>
<a href="#l4.660"></a><span id="l4.660">   return NS_OK;</span>
<a href="#l4.661"></a><span id="l4.661"> }</span>
<a href="#l4.662"></a><span id="l4.662"> </span>
<a href="#l4.663"></a><span id="l4.663" class="difflineminus">-int nsAttachmentState::SortAttachmentsByPartId(const void *aLeft,</span>
<a href="#l4.664"></a><span id="l4.664" class="difflineminus">-                                               const void *aRight) {</span>
<a href="#l4.665"></a><span id="l4.665" class="difflineplus">+// Static compare callback for sorting.</span>
<a href="#l4.666"></a><span id="l4.666" class="difflineplus">+int nsAttachmentState::CompareAttachmentsByPartId(const void *aLeft,</span>
<a href="#l4.667"></a><span id="l4.667" class="difflineplus">+                                                  const void *aRight) {</span>
<a href="#l4.668"></a><span id="l4.668">   msgAttachment &amp;attachLeft = *((msgAttachment *)aLeft);</span>
<a href="#l4.669"></a><span id="l4.669">   msgAttachment &amp;attachRight = *((msgAttachment *)aRight);</span>
<a href="#l4.670"></a><span id="l4.670" class="difflineminus">-  return ::CompareAttachmentPartId(attachLeft.mUrl, attachRight.mUrl);</span>
<a href="#l4.671"></a><span id="l4.671" class="difflineplus">+  return ::CompareAttachmentPartId(attachLeft.mUrl.get(),</span>
<a href="#l4.672"></a><span id="l4.672" class="difflineplus">+                                   attachRight.mUrl.get());</span>
<a href="#l4.673"></a><span id="l4.673"> }</span>
<a href="#l4.674"></a><span id="l4.674"> </span>
<a href="#l4.675"></a><span id="l4.675"> // ------------------------------------</span>
<a href="#l4.676"></a><span id="l4.676"> </span>
<a href="#l4.677"></a><span id="l4.677"> class nsDelAttachListener : public nsIStreamListener,</span>
<a href="#l4.678"></a><span id="l4.678">                             public nsIUrlListener,</span>
<a href="#l4.679"></a><span id="l4.679">                             public nsIMsgCopyServiceListener {</span>
<a href="#l4.680"></a><span id="l4.680">  public:</span>
<a href="#l4.681"></a><span id="l4.681" class="difflineat">@@ -2427,34 +2351,35 @@ nsresult nsDelAttachListener::DeleteOrig</span>
<a href="#l4.682"></a><span id="l4.682">                                         false,                // isMove</span>
<a href="#l4.683"></a><span id="l4.683">                                         listenerCopyService,  // listener</span>
<a href="#l4.684"></a><span id="l4.684">                                         false);               // allowUndo</span>
<a href="#l4.685"></a><span id="l4.685"> }</span>
<a href="#l4.686"></a><span id="l4.686"> </span>
<a href="#l4.687"></a><span id="l4.687"> void nsDelAttachListener::SelectNewMessage() {</span>
<a href="#l4.688"></a><span id="l4.688">   nsCString displayUri;</span>
<a href="#l4.689"></a><span id="l4.689">   // all attachments refer to the same message</span>
<a href="#l4.690"></a><span id="l4.690" class="difflineminus">-  const char *messageUri = mAttach-&gt;mAttachmentArray[0].mMessageUri;</span>
<a href="#l4.691"></a><span id="l4.691" class="difflineplus">+  const nsCString &amp;messageUri(mAttach-&gt;mAttachmentArray[0].mMessageUri);</span>
<a href="#l4.692"></a><span id="l4.692">   mMessenger-&gt;GetLastDisplayedMessageUri(displayUri);</span>
<a href="#l4.693"></a><span id="l4.693">   if (displayUri.Equals(messageUri)) {</span>
<a href="#l4.694"></a><span id="l4.694">     mMessageFolder-&gt;GenerateMessageURI(mNewMessageKey, displayUri);</span>
<a href="#l4.695"></a><span id="l4.695">     if (!displayUri.IsEmpty() &amp;&amp; mMsgWindow) {</span>
<a href="#l4.696"></a><span id="l4.696">       nsCOMPtr&lt;nsIMsgWindowCommands&gt; windowCommands;</span>
<a href="#l4.697"></a><span id="l4.697">       mMsgWindow-&gt;GetWindowCommands(getter_AddRefs(windowCommands));</span>
<a href="#l4.698"></a><span id="l4.698">       if (windowCommands) windowCommands-&gt;SelectMessage(displayUri);</span>
<a href="#l4.699"></a><span id="l4.699">     }</span>
<a href="#l4.700"></a><span id="l4.700">   }</span>
<a href="#l4.701"></a><span id="l4.701">   mNewMessageKey = nsMsgKey_None;</span>
<a href="#l4.702"></a><span id="l4.702"> }</span>
<a href="#l4.703"></a><span id="l4.703"> </span>
<a href="#l4.704"></a><span id="l4.704"> NS_IMETHODIMP</span>
<a href="#l4.705"></a><span id="l4.705"> nsDelAttachListener::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode) {</span>
<a href="#l4.706"></a><span id="l4.706">   nsresult rv = NS_OK;</span>
<a href="#l4.707"></a><span id="l4.707" class="difflineminus">-  const char *messageUri = mAttach-&gt;mAttachmentArray[0].mMessageUri;</span>
<a href="#l4.708"></a><span id="l4.708" class="difflineminus">-  if (mOriginalMessage &amp;&amp; !strncmp(messageUri, &quot;imap-message:&quot;, 13)) {</span>
<a href="#l4.709"></a><span id="l4.709" class="difflineplus">+  const nsCString &amp;messageUri(mAttach-&gt;mAttachmentArray[0].mMessageUri);</span>
<a href="#l4.710"></a><span id="l4.710" class="difflineplus">+  if (mOriginalMessage &amp;&amp;</span>
<a href="#l4.711"></a><span id="l4.711" class="difflineplus">+      Substring(messageUri, 0, 13).EqualsLiteral(&quot;imap-message:&quot;)) {</span>
<a href="#l4.712"></a><span id="l4.712">     if (m_state == eUpdatingFolder) rv = DeleteOriginalMessage();</span>
<a href="#l4.713"></a><span id="l4.713">   }</span>
<a href="#l4.714"></a><span id="l4.714">   // check if we've deleted the original message, and we know the new msg id.</span>
<a href="#l4.715"></a><span id="l4.715">   else if (m_state == eDeletingOldMessage &amp;&amp; mMsgWindow)</span>
<a href="#l4.716"></a><span id="l4.716">     SelectNewMessage();</span>
<a href="#l4.717"></a><span id="l4.717"> </span>
<a href="#l4.718"></a><span id="l4.718">   return rv;</span>
<a href="#l4.719"></a><span id="l4.719"> }</span>
<a href="#l4.720"></a><span id="l4.720" class="difflineat">@@ -2503,18 +2428,19 @@ nsDelAttachListener::OnStopCopy(nsresult</span>
<a href="#l4.721"></a><span id="l4.721">   // do this for non-imap messages - for imap, we'll do the delete in</span>
<a href="#l4.722"></a><span id="l4.722">   // OnStopRunningUrl. For local messages, we won't get an OnStopRunningUrl</span>
<a href="#l4.723"></a><span id="l4.723">   // notification. And for imap, it's too late to delete the message here,</span>
<a href="#l4.724"></a><span id="l4.724">   // because we'll be updating the folder naturally as a result of</span>
<a href="#l4.725"></a><span id="l4.725">   // running an append url. If we delete the header here, that folder</span>
<a href="#l4.726"></a><span id="l4.726">   // update will think we need to download the header...If we do it</span>
<a href="#l4.727"></a><span id="l4.727">   // in OnStopRunningUrl, we'll issue the delete before we do the</span>
<a href="#l4.728"></a><span id="l4.728">   // update....all nasty stuff.</span>
<a href="#l4.729"></a><span id="l4.729" class="difflineminus">-  const char *messageUri = mAttach-&gt;mAttachmentArray[0].mMessageUri;</span>
<a href="#l4.730"></a><span id="l4.730" class="difflineminus">-  if (mOriginalMessage &amp;&amp; strncmp(messageUri, &quot;imap-message:&quot;, 13))</span>
<a href="#l4.731"></a><span id="l4.731" class="difflineplus">+  const nsACString &amp;messageUri = mAttach-&gt;mAttachmentArray[0].mMessageUri;</span>
<a href="#l4.732"></a><span id="l4.732" class="difflineplus">+  if (mOriginalMessage &amp;&amp;</span>
<a href="#l4.733"></a><span id="l4.733" class="difflineplus">+      !Substring(messageUri, 0, 13).EqualsLiteral(&quot;imap-message:&quot;))</span>
<a href="#l4.734"></a><span id="l4.734">     return DeleteOriginalMessage();</span>
<a href="#l4.735"></a><span id="l4.735">   else</span>
<a href="#l4.736"></a><span id="l4.736">     m_state = eUpdatingFolder;</span>
<a href="#l4.737"></a><span id="l4.737">   return NS_OK;</span>
<a href="#l4.738"></a><span id="l4.738"> }</span>
<a href="#l4.739"></a><span id="l4.739"> </span>
<a href="#l4.740"></a><span id="l4.740"> //</span>
<a href="#l4.741"></a><span id="l4.741"> // local methods</span>
<a href="#l4.742"></a><span id="l4.742" class="difflineat">@@ -2549,23 +2475,22 @@ nsresult nsDelAttachListener::StartProce</span>
<a href="#l4.743"></a><span id="l4.743">                              getter_AddRefs(mMessenger));</span>
<a href="#l4.744"></a><span id="l4.744">   mMsgWindow = aMsgWindow;</span>
<a href="#l4.745"></a><span id="l4.745">   mAttach = aAttach;</span>
<a href="#l4.746"></a><span id="l4.746">   mDetaching = detaching;</span>
<a href="#l4.747"></a><span id="l4.747"> </span>
<a href="#l4.748"></a><span id="l4.748">   nsresult rv;</span>
<a href="#l4.749"></a><span id="l4.749"> </span>
<a href="#l4.750"></a><span id="l4.750">   // all attachments refer to the same message</span>
<a href="#l4.751"></a><span id="l4.751" class="difflineminus">-  const char *messageUri = mAttach-&gt;mAttachmentArray[0].mMessageUri;</span>
<a href="#l4.752"></a><span id="l4.752" class="difflineplus">+  const nsCString &amp;messageUri = mAttach-&gt;mAttachmentArray[0].mMessageUri;</span>
<a href="#l4.753"></a><span id="l4.753"> </span>
<a href="#l4.754"></a><span id="l4.754">   // get the message service, original message and folder for this message</span>
<a href="#l4.755"></a><span id="l4.755" class="difflineminus">-  rv = GetMessageServiceFromURI(nsDependentCString(messageUri),</span>
<a href="#l4.756"></a><span id="l4.756" class="difflineminus">-                                getter_AddRefs(mMessageService));</span>
<a href="#l4.757"></a><span id="l4.757" class="difflineplus">+  rv = GetMessageServiceFromURI(messageUri, getter_AddRefs(mMessageService));</span>
<a href="#l4.758"></a><span id="l4.758">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.759"></a><span id="l4.759" class="difflineminus">-  rv = mMessageService-&gt;MessageURIToMsgHdr(messageUri,</span>
<a href="#l4.760"></a><span id="l4.760" class="difflineplus">+  rv = mMessageService-&gt;MessageURIToMsgHdr(messageUri.get(),</span>
<a href="#l4.761"></a><span id="l4.761">                                            getter_AddRefs(mOriginalMessage));</span>
<a href="#l4.762"></a><span id="l4.762">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.763"></a><span id="l4.763">   rv = mOriginalMessage-&gt;GetFolder(getter_AddRefs(mMessageFolder));</span>
<a href="#l4.764"></a><span id="l4.764">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.765"></a><span id="l4.765">   mOriginalMessage-&gt;GetFlags(&amp;mOrigMsgFlags);</span>
<a href="#l4.766"></a><span id="l4.766"> </span>
<a href="#l4.767"></a><span id="l4.767">   // ensure that we can store and delete messages in this folder, if we</span>
<a href="#l4.768"></a><span id="l4.768">   // can't then we can't do attachment deleting</span>
<a href="#l4.769"></a><span id="l4.769" class="difflineat">@@ -2592,22 +2517,22 @@ nsresult nsDelAttachListener::StartProce</span>
<a href="#l4.770"></a><span id="l4.770"> </span>
<a href="#l4.771"></a><span id="l4.771">   // create the additional header for data conversion. This will tell the stream</span>
<a href="#l4.772"></a><span id="l4.772">   // converter which MIME emitter we want to use, and it will tell the MIME</span>
<a href="#l4.773"></a><span id="l4.773">   // emitter which attachments should be deleted.</span>
<a href="#l4.774"></a><span id="l4.774">   const char *partId;</span>
<a href="#l4.775"></a><span id="l4.775">   const char *nextField;</span>
<a href="#l4.776"></a><span id="l4.776">   nsAutoCString sHeader(&quot;attach&amp;del=&quot;);</span>
<a href="#l4.777"></a><span id="l4.777">   nsAutoCString detachToHeader(&quot;&amp;detachTo=&quot;);</span>
<a href="#l4.778"></a><span id="l4.778" class="difflineminus">-  for (uint32_t u = 0; u &lt; mAttach-&gt;mCount; ++u) {</span>
<a href="#l4.779"></a><span id="l4.779" class="difflineplus">+  for (uint32_t u = 0; u &lt; mAttach-&gt;mAttachmentArray.Length(); ++u) {</span>
<a href="#l4.780"></a><span id="l4.780">     if (u &gt; 0) {</span>
<a href="#l4.781"></a><span id="l4.781">       sHeader.Append(',');</span>
<a href="#l4.782"></a><span id="l4.782">       if (detaching) detachToHeader.Append(',');</span>
<a href="#l4.783"></a><span id="l4.783">     }</span>
<a href="#l4.784"></a><span id="l4.784" class="difflineminus">-    partId = GetAttachmentPartId(mAttach-&gt;mAttachmentArray[u].mUrl);</span>
<a href="#l4.785"></a><span id="l4.785" class="difflineplus">+    partId = GetAttachmentPartId(mAttach-&gt;mAttachmentArray[u].mUrl.get());</span>
<a href="#l4.786"></a><span id="l4.786">     nextField = PL_strchr(partId, '&amp;');</span>
<a href="#l4.787"></a><span id="l4.787">     sHeader.Append(partId, nextField ? nextField - partId : -1);</span>
<a href="#l4.788"></a><span id="l4.788">     if (detaching) detachToHeader.Append(mDetachedFileUris[u]);</span>
<a href="#l4.789"></a><span id="l4.789">   }</span>
<a href="#l4.790"></a><span id="l4.790"> </span>
<a href="#l4.791"></a><span id="l4.791">   if (detaching) sHeader.Append(detachToHeader);</span>
<a href="#l4.792"></a><span id="l4.792">   // stream this message to our listener converting it via the attachment mime</span>
<a href="#l4.793"></a><span id="l4.793">   // converter. The listener will just write the converted message straight to</span>
<a href="#l4.794"></a><span id="l4.794" class="difflineat">@@ -2616,86 +2541,89 @@ nsresult nsDelAttachListener::StartProce</span>
<a href="#l4.795"></a><span id="l4.795">   rv = this-&gt;QueryInterface(NS_GET_IID(nsISupports),</span>
<a href="#l4.796"></a><span id="l4.796">                             getter_AddRefs(listenerSupports));</span>
<a href="#l4.797"></a><span id="l4.797">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.798"></a><span id="l4.798">   nsCOMPtr&lt;nsIUrlListener&gt; listenerUrlListener =</span>
<a href="#l4.799"></a><span id="l4.799">       do_QueryInterface(listenerSupports, &amp;rv);</span>
<a href="#l4.800"></a><span id="l4.800">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.801"></a><span id="l4.801"> </span>
<a href="#l4.802"></a><span id="l4.802">   nsCOMPtr&lt;nsIURI&gt; dummyNull;</span>
<a href="#l4.803"></a><span id="l4.803" class="difflineminus">-  rv = mMessageService-&gt;StreamMessage(messageUri, listenerSupports, mMsgWindow,</span>
<a href="#l4.804"></a><span id="l4.804" class="difflineminus">-                                      listenerUrlListener, true, sHeader, false,</span>
<a href="#l4.805"></a><span id="l4.805" class="difflineminus">-                                      getter_AddRefs(dummyNull));</span>
<a href="#l4.806"></a><span id="l4.806" class="difflineplus">+  rv = mMessageService-&gt;StreamMessage(</span>
<a href="#l4.807"></a><span id="l4.807" class="difflineplus">+      messageUri.get(), listenerSupports, mMsgWindow, listenerUrlListener, true,</span>
<a href="#l4.808"></a><span id="l4.808" class="difflineplus">+      sHeader, false, getter_AddRefs(dummyNull));</span>
<a href="#l4.809"></a><span id="l4.809">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.810"></a><span id="l4.810"> </span>
<a href="#l4.811"></a><span id="l4.811">   return NS_OK;</span>
<a href="#l4.812"></a><span id="l4.812"> }</span>
<a href="#l4.813"></a><span id="l4.813"> </span>
<a href="#l4.814"></a><span id="l4.814"> // ------------------------------------</span>
<a href="#l4.815"></a><span id="l4.815"> </span>
<a href="#l4.816"></a><span id="l4.816"> NS_IMETHODIMP</span>
<a href="#l4.817"></a><span id="l4.817" class="difflineminus">-nsMessenger::DetachAttachment(const char *aContentType, const char *aUrl,</span>
<a href="#l4.818"></a><span id="l4.818" class="difflineminus">-                              const char *aDisplayName, const char *aMessageUri,</span>
<a href="#l4.819"></a><span id="l4.819" class="difflineminus">-                              bool aSaveFirst, bool withoutWarning = false) {</span>
<a href="#l4.820"></a><span id="l4.820" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aContentType);</span>
<a href="#l4.821"></a><span id="l4.821" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l4.822"></a><span id="l4.822" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aDisplayName);</span>
<a href="#l4.823"></a><span id="l4.823" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aMessageUri);</span>
<a href="#l4.824"></a><span id="l4.824" class="difflineminus">-</span>
<a href="#l4.825"></a><span id="l4.825" class="difflineplus">+nsMessenger::DetachAttachment(const nsACString &amp;aContentType,</span>
<a href="#l4.826"></a><span id="l4.826" class="difflineplus">+                              const nsACString &amp;aURL,</span>
<a href="#l4.827"></a><span id="l4.827" class="difflineplus">+                              const nsACString &amp;aDisplayName,</span>
<a href="#l4.828"></a><span id="l4.828" class="difflineplus">+                              const nsACString &amp;aMessageUri, bool aSaveFirst,</span>
<a href="#l4.829"></a><span id="l4.829" class="difflineplus">+                              bool withoutWarning = false) {</span>
<a href="#l4.830"></a><span id="l4.830">   if (aSaveFirst)</span>
<a href="#l4.831"></a><span id="l4.831" class="difflineminus">-    return SaveOneAttachment(aContentType, aUrl, aDisplayName, aMessageUri,</span>
<a href="#l4.832"></a><span id="l4.832" class="difflineplus">+    return SaveOneAttachment(aContentType, aURL, aDisplayName, aMessageUri,</span>
<a href="#l4.833"></a><span id="l4.833">                              true);</span>
<a href="#l4.834"></a><span id="l4.834" class="difflineminus">-  return DetachAttachments(1, &amp;aContentType, &amp;aUrl, &amp;aDisplayName, &amp;aMessageUri,</span>
<a href="#l4.835"></a><span id="l4.835" class="difflineminus">-                           nullptr, withoutWarning);</span>
<a href="#l4.836"></a><span id="l4.836" class="difflineplus">+  AutoTArray&lt;nsCString, 1&gt; contentTypeArray = {</span>
<a href="#l4.837"></a><span id="l4.837" class="difflineplus">+      PromiseFlatCString(aContentType)};</span>
<a href="#l4.838"></a><span id="l4.838" class="difflineplus">+  AutoTArray&lt;nsCString, 1&gt; urlArray = {PromiseFlatCString(aURL)};</span>
<a href="#l4.839"></a><span id="l4.839" class="difflineplus">+  AutoTArray&lt;nsCString, 1&gt; displayNameArray = {</span>
<a href="#l4.840"></a><span id="l4.840" class="difflineplus">+      PromiseFlatCString(aDisplayName)};</span>
<a href="#l4.841"></a><span id="l4.841" class="difflineplus">+  AutoTArray&lt;nsCString, 1&gt; messageUriArray = {PromiseFlatCString(aMessageUri)};</span>
<a href="#l4.842"></a><span id="l4.842" class="difflineplus">+  return DetachAttachments(contentTypeArray, urlArray, displayNameArray,</span>
<a href="#l4.843"></a><span id="l4.843" class="difflineplus">+                           messageUriArray, nullptr, withoutWarning);</span>
<a href="#l4.844"></a><span id="l4.844"> }</span>
<a href="#l4.845"></a><span id="l4.845"> </span>
<a href="#l4.846"></a><span id="l4.846"> NS_IMETHODIMP</span>
<a href="#l4.847"></a><span id="l4.847" class="difflineminus">-nsMessenger::DetachAllAttachments(</span>
<a href="#l4.848"></a><span id="l4.848" class="difflineminus">-    uint32_t aCount, const char **aContentTypeArray, const char **aUrlArray,</span>
<a href="#l4.849"></a><span id="l4.849" class="difflineminus">-    const char **aDisplayNameArray, const char **aMessageUriArray,</span>
<a href="#l4.850"></a><span id="l4.850" class="difflineminus">-    bool aSaveFirst, bool withoutWarning = false) {</span>
<a href="#l4.851"></a><span id="l4.851" class="difflineminus">-  NS_ENSURE_ARG_MIN(aCount, 1);</span>
<a href="#l4.852"></a><span id="l4.852" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aContentTypeArray);</span>
<a href="#l4.853"></a><span id="l4.853" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aUrlArray);</span>
<a href="#l4.854"></a><span id="l4.854" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aDisplayNameArray);</span>
<a href="#l4.855"></a><span id="l4.855" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aMessageUriArray);</span>
<a href="#l4.856"></a><span id="l4.856" class="difflineplus">+nsMessenger::DetachAllAttachments(const nsTArray&lt;nsCString&gt; &amp;aContentTypeArray,</span>
<a href="#l4.857"></a><span id="l4.857" class="difflineplus">+                                  const nsTArray&lt;nsCString&gt; &amp;aUrlArray,</span>
<a href="#l4.858"></a><span id="l4.858" class="difflineplus">+                                  const nsTArray&lt;nsCString&gt; &amp;aDisplayNameArray,</span>
<a href="#l4.859"></a><span id="l4.859" class="difflineplus">+                                  const nsTArray&lt;nsCString&gt; &amp;aMessageUriArray,</span>
<a href="#l4.860"></a><span id="l4.860" class="difflineplus">+                                  bool aSaveFirst,</span>
<a href="#l4.861"></a><span id="l4.861" class="difflineplus">+                                  bool withoutWarning = false) {</span>
<a href="#l4.862"></a><span id="l4.862" class="difflineplus">+  NS_ENSURE_ARG_MIN(aContentTypeArray.Length(), 1);</span>
<a href="#l4.863"></a><span id="l4.863" class="difflineplus">+  MOZ_ASSERT(aContentTypeArray.Length() == aUrlArray.Length() ==</span>
<a href="#l4.864"></a><span id="l4.864" class="difflineplus">+             aDisplayNameArray.Length() == aMessageUriArray.Length());</span>
<a href="#l4.865"></a><span id="l4.865"> </span>
<a href="#l4.866"></a><span id="l4.866">   if (aSaveFirst)</span>
<a href="#l4.867"></a><span id="l4.867" class="difflineminus">-    return SaveAllAttachments(aCount, aContentTypeArray, aUrlArray,</span>
<a href="#l4.868"></a><span id="l4.868" class="difflineminus">-                              aDisplayNameArray, aMessageUriArray, true);</span>
<a href="#l4.869"></a><span id="l4.869" class="difflineplus">+    return SaveAllAttachments(aContentTypeArray, aUrlArray, aDisplayNameArray,</span>
<a href="#l4.870"></a><span id="l4.870" class="difflineplus">+                              aMessageUriArray, true);</span>
<a href="#l4.871"></a><span id="l4.871">   else</span>
<a href="#l4.872"></a><span id="l4.872" class="difflineminus">-    return DetachAttachments(aCount, aContentTypeArray, aUrlArray,</span>
<a href="#l4.873"></a><span id="l4.873" class="difflineminus">-                             aDisplayNameArray, aMessageUriArray, nullptr,</span>
<a href="#l4.874"></a><span id="l4.874" class="difflineminus">-                             withoutWarning);</span>
<a href="#l4.875"></a><span id="l4.875" class="difflineplus">+    return DetachAttachments(aContentTypeArray, aUrlArray, aDisplayNameArray,</span>
<a href="#l4.876"></a><span id="l4.876" class="difflineplus">+                             aMessageUriArray, nullptr, withoutWarning);</span>
<a href="#l4.877"></a><span id="l4.877"> }</span>
<a href="#l4.878"></a><span id="l4.878"> </span>
<a href="#l4.879"></a><span id="l4.879"> nsresult nsMessenger::DetachAttachments(</span>
<a href="#l4.880"></a><span id="l4.880" class="difflineminus">-    uint32_t aCount, const char **aContentTypeArray, const char **aUrlArray,</span>
<a href="#l4.881"></a><span id="l4.881" class="difflineminus">-    const char **aDisplayNameArray, const char **aMessageUriArray,</span>
<a href="#l4.882"></a><span id="l4.882" class="difflineplus">+    const nsTArray&lt;nsCString&gt; &amp;aContentTypeArray,</span>
<a href="#l4.883"></a><span id="l4.883" class="difflineplus">+    const nsTArray&lt;nsCString&gt; &amp;aUrlArray,</span>
<a href="#l4.884"></a><span id="l4.884" class="difflineplus">+    const nsTArray&lt;nsCString&gt; &amp;aDisplayNameArray,</span>
<a href="#l4.885"></a><span id="l4.885" class="difflineplus">+    const nsTArray&lt;nsCString&gt; &amp;aMessageUriArray,</span>
<a href="#l4.886"></a><span id="l4.886">     nsTArray&lt;nsCString&gt; *saveFileUris, bool withoutWarning) {</span>
<a href="#l4.887"></a><span id="l4.887">   // if withoutWarning no dialog for user</span>
<a href="#l4.888"></a><span id="l4.888" class="difflineminus">-  if (!withoutWarning &amp;&amp;</span>
<a href="#l4.889"></a><span id="l4.889" class="difflineminus">-      NS_FAILED(PromptIfDeleteAttachments(saveFileUris != nullptr, aCount,</span>
<a href="#l4.890"></a><span id="l4.890" class="difflineminus">-                                          aDisplayNameArray)))</span>
<a href="#l4.891"></a><span id="l4.891" class="difflineplus">+  if (!withoutWarning &amp;&amp; NS_FAILED(PromptIfDeleteAttachments(</span>
<a href="#l4.892"></a><span id="l4.892" class="difflineplus">+                             saveFileUris != nullptr, aDisplayNameArray)))</span>
<a href="#l4.893"></a><span id="l4.893">     return NS_OK;</span>
<a href="#l4.894"></a><span id="l4.894"> </span>
<a href="#l4.895"></a><span id="l4.895">   nsresult rv = NS_OK;</span>
<a href="#l4.896"></a><span id="l4.896"> </span>
<a href="#l4.897"></a><span id="l4.897">   // ensure that our arguments are valid</span>
<a href="#l4.898"></a><span id="l4.898">   //  char * partId;</span>
<a href="#l4.899"></a><span id="l4.899" class="difflineminus">-  for (uint32_t u = 0; u &lt; aCount; ++u) {</span>
<a href="#l4.900"></a><span id="l4.900" class="difflineplus">+  for (uint32_t u = 0; u &lt; aContentTypeArray.Length(); ++u) {</span>
<a href="#l4.901"></a><span id="l4.901">     // ensure all of the message URI are the same, we cannot process</span>
<a href="#l4.902"></a><span id="l4.902">     // attachments from different messages</span>
<a href="#l4.903"></a><span id="l4.903" class="difflineminus">-    if (u &gt; 0 &amp;&amp; 0 != strcmp(aMessageUriArray[0], aMessageUriArray[u])) {</span>
<a href="#l4.904"></a><span id="l4.904" class="difflineplus">+    if (u &gt; 0 &amp;&amp; aMessageUriArray[0] != aMessageUriArray[u]) {</span>
<a href="#l4.905"></a><span id="l4.905">       rv = NS_ERROR_INVALID_ARG;</span>
<a href="#l4.906"></a><span id="l4.906">       break;</span>
<a href="#l4.907"></a><span id="l4.907">     }</span>
<a href="#l4.908"></a><span id="l4.908"> </span>
<a href="#l4.909"></a><span id="l4.909">     // ensure that we don't have deleted messages in this list</span>
<a href="#l4.910"></a><span id="l4.910" class="difflineminus">-    if (0 == strcmp(aContentTypeArray[u], MIMETYPE_DELETED)) {</span>
<a href="#l4.911"></a><span id="l4.911" class="difflineplus">+    if (aContentTypeArray[u].EqualsLiteral(MIMETYPE_DELETED)) {</span>
<a href="#l4.912"></a><span id="l4.912">       rv = NS_ERROR_INVALID_ARG;</span>
<a href="#l4.913"></a><span id="l4.913">       break;</span>
<a href="#l4.914"></a><span id="l4.914">     }</span>
<a href="#l4.915"></a><span id="l4.915"> </span>
<a href="#l4.916"></a><span id="l4.916">     // for the moment we prevent any attachments other than root level</span>
<a href="#l4.917"></a><span id="l4.917">     // attachments being deleted (i.e. you can't delete attachments from a</span>
<a href="#l4.918"></a><span id="l4.918">     // email forwarded as an attachment). We do this by ensuring that the</span>
<a href="#l4.919"></a><span id="l4.919">     // part id only has a single period in it (e.g. &quot;1.2&quot;).</span>
<a href="#l4.920"></a><span id="l4.920" class="difflineat">@@ -2725,48 +2653,47 @@ nsresult nsMessenger::DetachAttachments(</span>
<a href="#l4.921"></a><span id="l4.921">   nsCOMPtr&lt;nsISupports&gt;</span>
<a href="#l4.922"></a><span id="l4.922">       listenerSupports;  // auto-delete of the listener with error</span>
<a href="#l4.923"></a><span id="l4.923">   listener-&gt;QueryInterface(NS_GET_IID(nsISupports),</span>
<a href="#l4.924"></a><span id="l4.924">                            getter_AddRefs(listenerSupports));</span>
<a href="#l4.925"></a><span id="l4.925"> </span>
<a href="#l4.926"></a><span id="l4.926">   if (saveFileUris) listener-&gt;mDetachedFileUris = *saveFileUris;</span>
<a href="#l4.927"></a><span id="l4.927">   // create the attachments for use by the listener</span>
<a href="#l4.928"></a><span id="l4.928">   nsAttachmentState *attach = new nsAttachmentState;</span>
<a href="#l4.929"></a><span id="l4.929" class="difflineminus">-  if (!attach) return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l4.930"></a><span id="l4.930" class="difflineminus">-  rv = attach-&gt;Init(aCount, aContentTypeArray, aUrlArray, aDisplayNameArray,</span>
<a href="#l4.931"></a><span id="l4.931" class="difflineplus">+  rv = attach-&gt;Init(aContentTypeArray, aUrlArray, aDisplayNameArray,</span>
<a href="#l4.932"></a><span id="l4.932">                     aMessageUriArray);</span>
<a href="#l4.933"></a><span id="l4.933">   if (NS_SUCCEEDED(rv)) rv = attach-&gt;PrepareForAttachmentDelete();</span>
<a href="#l4.934"></a><span id="l4.934">   if (NS_FAILED(rv)) {</span>
<a href="#l4.935"></a><span id="l4.935">     delete attach;</span>
<a href="#l4.936"></a><span id="l4.936">     return rv;</span>
<a href="#l4.937"></a><span id="l4.937">   }</span>
<a href="#l4.938"></a><span id="l4.938"> </span>
<a href="#l4.939"></a><span id="l4.939">   // initialize our listener with the attachments and details. The listener</span>
<a href="#l4.940"></a><span id="l4.940">   // takes ownership of 'attach' immediately irrespective of the return value</span>
<a href="#l4.941"></a><span id="l4.941">   // (error or not).</span>
<a href="#l4.942"></a><span id="l4.942">   return listener-&gt;StartProcessing(this, mMsgWindow, attach,</span>
<a href="#l4.943"></a><span id="l4.943">                                    saveFileUris != nullptr);</span>
<a href="#l4.944"></a><span id="l4.944"> }</span>
<a href="#l4.945"></a><span id="l4.945"> </span>
<a href="#l4.946"></a><span id="l4.946"> nsresult nsMessenger::PromptIfDeleteAttachments(</span>
<a href="#l4.947"></a><span id="l4.947" class="difflineminus">-    bool aSaveFirst, uint32_t aCount, const char **aDisplayNameArray) {</span>
<a href="#l4.948"></a><span id="l4.948" class="difflineplus">+    bool aSaveFirst, const nsTArray&lt;nsCString&gt; &amp;aDisplayNameArray) {</span>
<a href="#l4.949"></a><span id="l4.949">   nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l4.950"></a><span id="l4.950"> </span>
<a href="#l4.951"></a><span id="l4.951">   nsCOMPtr&lt;nsIPrompt&gt; dialog(do_GetInterface(mDocShell));</span>
<a href="#l4.952"></a><span id="l4.952">   if (!dialog) return rv;</span>
<a href="#l4.953"></a><span id="l4.953"> </span>
<a href="#l4.954"></a><span id="l4.954">   if (!mStringBundle) {</span>
<a href="#l4.955"></a><span id="l4.955">     rv = InitStringBundle();</span>
<a href="#l4.956"></a><span id="l4.956">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l4.957"></a><span id="l4.957">   }</span>
<a href="#l4.958"></a><span id="l4.958"> </span>
<a href="#l4.959"></a><span id="l4.959">   // create the list of attachments we are removing</span>
<a href="#l4.960"></a><span id="l4.960">   nsString displayString;</span>
<a href="#l4.961"></a><span id="l4.961">   nsString attachmentList;</span>
<a href="#l4.962"></a><span id="l4.962" class="difflineminus">-  for (uint32_t u = 0; u &lt; aCount; ++u) {</span>
<a href="#l4.963"></a><span id="l4.963" class="difflineplus">+  for (uint32_t u = 0; u &lt; aDisplayNameArray.Length(); ++u) {</span>
<a href="#l4.964"></a><span id="l4.964">     ConvertAndSanitizeFileName(aDisplayNameArray[u], displayString);</span>
<a href="#l4.965"></a><span id="l4.965">     attachmentList.Append(displayString);</span>
<a href="#l4.966"></a><span id="l4.966">     attachmentList.Append(char16_t('\n'));</span>
<a href="#l4.967"></a><span id="l4.967">   }</span>
<a href="#l4.968"></a><span id="l4.968">   AutoTArray&lt;nsString, 1&gt; formatStrings = {attachmentList};</span>
<a href="#l4.969"></a><span id="l4.969"> </span>
<a href="#l4.970"></a><span id="l4.970">   // format the message and display</span>
<a href="#l4.971"></a><span id="l4.971">   nsString promptMessage;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/src/nsMessenger.h</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/src/nsMessenger.h</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -35,37 +35,39 @@ class nsMessenger : public nsIMessenger,</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5">   nsresult Alert(const char *stringName);</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7">   nsresult SaveAttachment(nsIFile *file, const nsACString &amp;unescapedUrl,</span>
<a href="#l5.8"></a><span id="l5.8">                           const nsACString &amp;messageUri,</span>
<a href="#l5.9"></a><span id="l5.9">                           const nsACString &amp;contentType, void *closure,</span>
<a href="#l5.10"></a><span id="l5.10">                           nsIUrlListener *aListener);</span>
<a href="#l5.11"></a><span id="l5.11">   nsresult PromptIfFileExists(nsIFile *file);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  nsresult DetachAttachments(uint32_t aCount, const char **aContentTypeArray,</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineminus">-                             const char **aUrlArray,</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-                             const char **aDisplayNameArray,</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-                             const char **aMessageUriArray,</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+  nsresult DetachAttachments(const nsTArray&lt;nsCString&gt; &amp;aContentTypeArray,</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+                             const nsTArray&lt;nsCString&gt; &amp;aUrlArray,</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+                             const nsTArray&lt;nsCString&gt; &amp;aDisplayNameArray,</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+                             const nsTArray&lt;nsCString&gt; &amp;aMessageUriArray,</span>
<a href="#l5.20"></a><span id="l5.20">                              nsTArray&lt;nsCString&gt; *saveFileUris,</span>
<a href="#l5.21"></a><span id="l5.21">                              bool withoutWarning = false);</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineminus">-  nsresult SaveAllAttachments(uint32_t count, const char **contentTypeArray,</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineminus">-                              const char **urlArray,</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineminus">-                              const char **displayNameArray,</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineminus">-                              const char **messageUriArray, bool detaching);</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineminus">-  nsresult SaveOneAttachment(const char *aContentType, const char *aURL,</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineminus">-                             const char *aDisplayName, const char *aMessageUri,</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-                             bool detaching);</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+  nsresult SaveAllAttachments(const nsTArray&lt;nsCString&gt; &amp;contentTypeArray,</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+                              const nsTArray&lt;nsCString&gt; &amp;urlArray,</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+                              const nsTArray&lt;nsCString&gt; &amp;displayNameArray,</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+                              const nsTArray&lt;nsCString&gt; &amp;messageUriArray,</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+                              bool detaching);</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+  nsresult SaveOneAttachment(const nsACString &amp;aContentType,</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+                             const nsACString &amp;aURL,</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+                             const nsACString &amp;aDisplayName,</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+                             const nsACString &amp;aMessageUri, bool detaching);</span>
<a href="#l5.38"></a><span id="l5.38"> </span>
<a href="#l5.39"></a><span id="l5.39">  protected:</span>
<a href="#l5.40"></a><span id="l5.40">   virtual ~nsMessenger();</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42">   void GetString(const nsString &amp;aStringName, nsString &amp;stringValue);</span>
<a href="#l5.43"></a><span id="l5.43">   nsresult InitStringBundle();</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineminus">-  nsresult PromptIfDeleteAttachments(bool saveFirst, uint32_t count,</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineminus">-                                     const char **displayNameArray);</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+  nsresult PromptIfDeleteAttachments(</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+      bool saveFirst, const nsTArray&lt;nsCString&gt; &amp;displayNameArray);</span>
<a href="#l5.48"></a><span id="l5.48"> </span>
<a href="#l5.49"></a><span id="l5.49">  private:</span>
<a href="#l5.50"></a><span id="l5.50">   nsresult GetLastSaveDirectory(nsIFile **aLastSaveAsDir);</span>
<a href="#l5.51"></a><span id="l5.51">   // if aLocalFile is a dir, we use it.  otherwise, we use the parent of</span>
<a href="#l5.52"></a><span id="l5.52">   // aLocalFile.</span>
<a href="#l5.53"></a><span id="l5.53">   nsresult SetLastSaveDirectory(nsIFile *aLocalFile);</span>
<a href="#l5.54"></a><span id="l5.54"> </span>
<a href="#l5.55"></a><span id="l5.55">   nsresult AdjustFileIfNameTooLong(nsIFile *aFile);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/test/unit/test_detachToFile.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_detachToFile.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -56,17 +56,16 @@ function* startDetach() {</span>
<a href="#l6.4"></a><span id="l6.4"> </span>
<a href="#l6.5"></a><span id="l6.5">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(</span>
<a href="#l6.6"></a><span id="l6.6">     Ci.nsIMessenger</span>
<a href="#l6.7"></a><span id="l6.7">   );</span>
<a href="#l6.8"></a><span id="l6.8">   let attachment = gCallbackObject.attachments[0];</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10">   messenger.detachAttachmentsWOPrompts(</span>
<a href="#l6.11"></a><span id="l6.11">     do_get_profile(),</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-    1,</span>
<a href="#l6.13"></a><span id="l6.13">     [attachment.contentType],</span>
<a href="#l6.14"></a><span id="l6.14">     [attachment.url],</span>
<a href="#l6.15"></a><span id="l6.15">     [attachment.name],</span>
<a href="#l6.16"></a><span id="l6.16">     [msgURI],</span>
<a href="#l6.17"></a><span id="l6.17">     asyncUrlListener</span>
<a href="#l6.18"></a><span id="l6.18">   );</span>
<a href="#l6.19"></a><span id="l6.19">   yield false;</span>
<a href="#l6.20"></a><span id="l6.20"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/test/unit/test_mimemaltdetach.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_mimemaltdetach.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -57,17 +57,16 @@ function* startDetach() {</span>
<a href="#l7.4"></a><span id="l7.4"> </span>
<a href="#l7.5"></a><span id="l7.5">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(</span>
<a href="#l7.6"></a><span id="l7.6">     Ci.nsIMessenger</span>
<a href="#l7.7"></a><span id="l7.7">   );</span>
<a href="#l7.8"></a><span id="l7.8">   let attachment = gCallbackObject.attachments[0];</span>
<a href="#l7.9"></a><span id="l7.9"> </span>
<a href="#l7.10"></a><span id="l7.10">   messenger.detachAttachmentsWOPrompts(</span>
<a href="#l7.11"></a><span id="l7.11">     do_get_profile(),</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    1,</span>
<a href="#l7.13"></a><span id="l7.13">     [attachment.contentType],</span>
<a href="#l7.14"></a><span id="l7.14">     [attachment.url],</span>
<a href="#l7.15"></a><span id="l7.15">     [attachment.name],</span>
<a href="#l7.16"></a><span id="l7.16">     [msgURI],</span>
<a href="#l7.17"></a><span id="l7.17">     asyncUrlListener</span>
<a href="#l7.18"></a><span id="l7.18">   );</span>
<a href="#l7.19"></a><span id="l7.19">   yield false;</span>
<a href="#l7.20"></a><span id="l7.20"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapAttachmentSaves.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapAttachmentSaves.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -76,17 +76,16 @@ function* startDetach() {</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(</span>
<a href="#l8.6"></a><span id="l8.6">     Ci.nsIMessenger</span>
<a href="#l8.7"></a><span id="l8.7">   );</span>
<a href="#l8.8"></a><span id="l8.8">   let attachment = gCallbackObject.attachments[0];</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10">   messenger.detachAttachmentsWOPrompts(</span>
<a href="#l8.11"></a><span id="l8.11">     do_get_profile(),</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    1,</span>
<a href="#l8.13"></a><span id="l8.13">     [attachment.contentType],</span>
<a href="#l8.14"></a><span id="l8.14">     [attachment.url],</span>
<a href="#l8.15"></a><span id="l8.15">     [attachment.name],</span>
<a href="#l8.16"></a><span id="l8.16">     [msgURI],</span>
<a href="#l8.17"></a><span id="l8.17">     null</span>
<a href="#l8.18"></a><span id="l8.18">   );</span>
<a href="#l8.19"></a><span id="l8.19">   // deletion of original message should kick async_driver.</span>
<a href="#l8.20"></a><span id="l8.20">   yield false;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/suite/mailnews/content/mailCommands.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/suite/mailnews/content/mailCommands.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -345,17 +345,17 @@ function SaveAsFile(aUris)</span>
<a href="#l9.4"></a><span id="l9.4">                            .messageURIToMsgHdr(aUris[i])</span>
<a href="#l9.5"></a><span id="l9.5">                            .mime2DecodedSubject;</span>
<a href="#l9.6"></a><span id="l9.6">     fileNames[i] = suggestUniqueFileName(subject.substr(0, 120), &quot;.eml&quot;,</span>
<a href="#l9.7"></a><span id="l9.7">                                          fileNames);</span>
<a href="#l9.8"></a><span id="l9.8">   }</span>
<a href="#l9.9"></a><span id="l9.9">   if (num == 1)</span>
<a href="#l9.10"></a><span id="l9.10">     messenger.saveAs(aUris[0], true, null, fileNames[0]);</span>
<a href="#l9.11"></a><span id="l9.11">   else</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-    messenger.saveMessages(num, fileNames, aUris);</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+    messenger.saveMessages(fileNames, aUris);</span>
<a href="#l9.14"></a><span id="l9.14"> }</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16"> function saveAsUrlListener(aUri, aIdentity)</span>
<a href="#l9.17"></a><span id="l9.17"> {</span>
<a href="#l9.18"></a><span id="l9.18">   this.uri = aUri;</span>
<a href="#l9.19"></a><span id="l9.19">   this.identity = aIdentity;</span>
<a href="#l9.20"></a><span id="l9.20"> }</span>
<a href="#l9.21"></a><span id="l9.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/suite/mailnews/content/msgHdrViewOverlay.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/suite/mailnews/content/msgHdrViewOverlay.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -1792,33 +1792,30 @@ function HandleMultipleAttachments(comma</span>
<a href="#l10.4"></a><span id="l10.4">      attachmentDisplayNameArray[index] = encodeURI(attachment.displayName);</span>
<a href="#l10.5"></a><span id="l10.5">      attachmentMessageUriArray[index] = attachment.uri;</span>
<a href="#l10.6"></a><span id="l10.6">    }</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8">    // okay the list has been built... now call our action code...</span>
<a href="#l10.9"></a><span id="l10.9">    switch (commandPrefix)</span>
<a href="#l10.10"></a><span id="l10.10">    {</span>
<a href="#l10.11"></a><span id="l10.11">      case &quot;saveAttachment&quot;:</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-       messenger.saveAllAttachments(attachmentContentTypeArray.length,</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-                                    attachmentContentTypeArray,</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+       messenger.saveAllAttachments(attachmentContentTypeArray,</span>
<a href="#l10.15"></a><span id="l10.15">                                     attachmentUrlArray,</span>
<a href="#l10.16"></a><span id="l10.16">                                     attachmentDisplayNameArray,</span>
<a href="#l10.17"></a><span id="l10.17">                                     attachmentMessageUriArray);</span>
<a href="#l10.18"></a><span id="l10.18">        break;</span>
<a href="#l10.19"></a><span id="l10.19">      case &quot;detachAttachment&quot;:</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-       messenger.detachAllAttachments(attachmentContentTypeArray.length,</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-                                      attachmentContentTypeArray,</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineplus">+       messenger.detachAllAttachments(attachmentContentTypeArray,</span>
<a href="#l10.23"></a><span id="l10.23">                                       attachmentUrlArray,</span>
<a href="#l10.24"></a><span id="l10.24">                                       attachmentDisplayNameArray,</span>
<a href="#l10.25"></a><span id="l10.25">                                       attachmentMessageUriArray,</span>
<a href="#l10.26"></a><span id="l10.26">                                       true /* save */);</span>
<a href="#l10.27"></a><span id="l10.27">        break;</span>
<a href="#l10.28"></a><span id="l10.28">      case &quot;deleteAttachment&quot;:</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-       messenger.detachAllAttachments(attachmentContentTypeArray.length,</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-                                      attachmentContentTypeArray,</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineplus">+       messenger.detachAllAttachments(attachmentContentTypeArray,</span>
<a href="#l10.32"></a><span id="l10.32">                                       attachmentUrlArray,</span>
<a href="#l10.33"></a><span id="l10.33">                                       attachmentDisplayNameArray,</span>
<a href="#l10.34"></a><span id="l10.34">                                       attachmentMessageUriArray,</span>
<a href="#l10.35"></a><span id="l10.35">                                       false /* don't save */);</span>
<a href="#l10.36"></a><span id="l10.36">        break;</span>
<a href="#l10.37"></a><span id="l10.37">      default:</span>
<a href="#l10.38"></a><span id="l10.38">        dump (commandPrefix + &quot;** unknown handle all attachments action **\n&quot;);</span>
<a href="#l10.39"></a><span id="l10.39">    }</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:31Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

