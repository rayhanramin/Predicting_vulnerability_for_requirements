<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 29792:41df9fb58b55af38c3334efce65cc0514c53a944</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 41df9fb58b55af38c3334efce65cc0514c53a944" />
<meta property="og:url" content="/comm-central/rev/41df9fb58b55af38c3334efce65cc0514c53a944" />
<meta property="og:description" content="Bug 1612237 - Remove nsIArray use from nsIMsgFilterService. r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 41df9fb58b55af38c3334efce65cc0514c53a944 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/41df9fb58b55af38c3334efce65cc0514c53a944">shortlog</a> |
<a href="/comm-central/log/41df9fb58b55af38c3334efce65cc0514c53a944">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/41df9fb58b55af38c3334efce65cc0514c53a944">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/41df9fb58b55af38c3334efce65cc0514c53a944">files</a> |
changeset |
<a href="/comm-central/raw-rev/41df9fb58b55af38c3334efce65cc0514c53a944">raw</a>  | <a href="/comm-central/archive/41df9fb58b55af38c3334efce65cc0514c53a944.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1612237">Bug 1612237</a> - Remove nsIArray use from nsIMsgFilterService. r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#66;&#101;&#110;&#32;&#67;&#97;&#109;&#112;&#98;&#101;&#108;&#108;&#32;&#60;&#98;&#101;&#110;&#99;&#64;&#116;&#104;&#117;&#110;&#100;&#101;&#114;&#98;&#105;&#114;&#100;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Fri, 05 Jun 2020 13:56:32 +0300</td></tr>

<tr>
 <td>changeset 29792</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/41df9fb58b55af38c3334efce65cc0514c53a944">41df9fb58b55af38c3334efce65cc0514c53a944</a></td>
</tr>



<tr>
<td>parent 29791</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/8650de6acb255b335cf108d201c646dff77b9d57">8650de6acb255b335cf108d201c646dff77b9d57</a>
</td>
</tr>

<tr>
<td>child 29793</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/6602b6ca210fe75a9e65d19acc80635b287a52fe">6602b6ca210fe75a9e65d19acc80635b287a52fe</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=41df9fb58b55af38c3334efce65cc0514c53a944">17534</a></td></tr>
<tr><td>push user</td><td>mkmelin@iki.fi</td></tr>
<tr><td>push date</td><td class="date age">Fri, 05 Jun 2020 10:58:24 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@68ea43e43f5d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=68ea43e43f5d2fff5eac43dcf7bd255f292506be">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=68ea43e43f5d2fff5eac43dcf7bd255f292506be&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=68ea43e43f5d2fff5eac43dcf7bd255f292506be&newProject=comm-central&newRevision=8650de6acb255b335cf108d201c646dff77b9d57&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=68ea43e43f5d2fff5eac43dcf7bd255f292506be&newProject=comm-central&newRevision=8650de6acb255b335cf108d201c646dff77b9d57&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=68ea43e43f5d2fff5eac43dcf7bd255f292506be&newProject=comm-central&newRevision=8650de6acb255b335cf108d201c646dff77b9d57&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1612237">1612237</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1612237">Bug 1612237</a> - Remove nsIArray use from nsIMsgFilterService. r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/content/FilterListDialog.js">mail/base/content/FilterListDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/content/FilterListDialog.js">file</a> |
<a href="/comm-central/annotate/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/content/FilterListDialog.js">annotate</a> |
<a href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/content/FilterListDialog.js">diff</a> |
<a href="/comm-central/comparison/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/content/FilterListDialog.js">comparison</a> |
<a href="/comm-central/log/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/content/FilterListDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/modules/MessageArchiver.jsm">mail/base/modules/MessageArchiver.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/modules/MessageArchiver.jsm">file</a> |
<a href="/comm-central/annotate/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/modules/MessageArchiver.jsm">annotate</a> |
<a href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/modules/MessageArchiver.jsm">diff</a> |
<a href="/comm-central/comparison/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/modules/MessageArchiver.jsm">comparison</a> |
<a href="/comm-central/log/41df9fb58b55af38c3334efce65cc0514c53a944/mail/base/modules/MessageArchiver.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/public/nsIMsgFilterService.idl">mailnews/base/search/public/nsIMsgFilterService.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/public/nsIMsgFilterService.idl">file</a> |
<a href="/comm-central/annotate/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/public/nsIMsgFilterService.idl">annotate</a> |
<a href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/public/nsIMsgFilterService.idl">diff</a> |
<a href="/comm-central/comparison/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/public/nsIMsgFilterService.idl">comparison</a> |
<a href="/comm-central/log/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/public/nsIMsgFilterService.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/src/PeriodicFilterManager.jsm">mailnews/base/search/src/PeriodicFilterManager.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/src/PeriodicFilterManager.jsm">file</a> |
<a href="/comm-central/annotate/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/src/PeriodicFilterManager.jsm">annotate</a> |
<a href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/src/PeriodicFilterManager.jsm">diff</a> |
<a href="/comm-central/comparison/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/src/PeriodicFilterManager.jsm">comparison</a> |
<a href="/comm-central/log/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/src/PeriodicFilterManager.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/src/nsMsgFilterService.cpp">mailnews/base/search/src/nsMsgFilterService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/src/nsMsgFilterService.cpp">file</a> |
<a href="/comm-central/annotate/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/src/nsMsgFilterService.cpp">annotate</a> |
<a href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/src/nsMsgFilterService.cpp">diff</a> |
<a href="/comm-central/comparison/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/src/nsMsgFilterService.cpp">comparison</a> |
<a href="/comm-central/log/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/search/src/nsMsgFilterService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/test/unit/test_copyThenMoveManual.js">mailnews/base/test/unit/test_copyThenMoveManual.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/test/unit/test_copyThenMoveManual.js">file</a> |
<a href="/comm-central/annotate/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/test/unit/test_copyThenMoveManual.js">annotate</a> |
<a href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/test/unit/test_copyThenMoveManual.js">diff</a> |
<a href="/comm-central/comparison/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/test/unit/test_copyThenMoveManual.js">comparison</a> |
<a href="/comm-central/log/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/test/unit/test_copyThenMoveManual.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/util/nsMsgDBFolder.h">mailnews/base/util/nsMsgDBFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/util/nsMsgDBFolder.h">file</a> |
<a href="/comm-central/annotate/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/util/nsMsgDBFolder.h">annotate</a> |
<a href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/util/nsMsgDBFolder.h">diff</a> |
<a href="/comm-central/comparison/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/util/nsMsgDBFolder.h">comparison</a> |
<a href="/comm-central/log/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/base/util/nsMsgDBFolder.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/41df9fb58b55af38c3334efce65cc0514c53a944/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/suite/mailnews/content/FilterListDialog.js">suite/mailnews/content/FilterListDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/41df9fb58b55af38c3334efce65cc0514c53a944/suite/mailnews/content/FilterListDialog.js">file</a> |
<a href="/comm-central/annotate/41df9fb58b55af38c3334efce65cc0514c53a944/suite/mailnews/content/FilterListDialog.js">annotate</a> |
<a href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/suite/mailnews/content/FilterListDialog.js">diff</a> |
<a href="/comm-central/comparison/41df9fb58b55af38c3334efce65cc0514c53a944/suite/mailnews/content/FilterListDialog.js">comparison</a> |
<a href="/comm-central/log/41df9fb58b55af38c3334efce65cc0514c53a944/suite/mailnews/content/FilterListDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/suite/mailnews/content/mailWindowOverlay.js">suite/mailnews/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/41df9fb58b55af38c3334efce65cc0514c53a944/suite/mailnews/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/41df9fb58b55af38c3334efce65cc0514c53a944/suite/mailnews/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/41df9fb58b55af38c3334efce65cc0514c53a944/suite/mailnews/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/41df9fb58b55af38c3334efce65cc0514c53a944/suite/mailnews/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/41df9fb58b55af38c3334efce65cc0514c53a944/suite/mailnews/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/FilterListDialog.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/FilterListDialog.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -706,31 +706,29 @@ function runSelectedFilters() {</span>
<a href="#l1.4"></a><span id="l1.4"> </span>
<a href="#l1.5"></a><span id="l1.5">   let folder =</span>
<a href="#l1.6"></a><span id="l1.6">     gRunFiltersFolder._folder || gRunFiltersFolder.selectedItem._folder;</span>
<a href="#l1.7"></a><span id="l1.7">   if (!folder) {</span>
<a href="#l1.8"></a><span id="l1.8">     return;</span>
<a href="#l1.9"></a><span id="l1.9">   }</span>
<a href="#l1.10"></a><span id="l1.10"> </span>
<a href="#l1.11"></a><span id="l1.11">   let filterList = MailServices.filters.getTempFilterList(folder);</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  let folders = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-  folders.appendElement(folder);</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15">   // make sure the tmp filter list uses the real filter list log stream</span>
<a href="#l1.16"></a><span id="l1.16">   filterList.logStream = gCurrentFilterList.logStream;</span>
<a href="#l1.17"></a><span id="l1.17">   filterList.loggingEnabled = gCurrentFilterList.loggingEnabled;</span>
<a href="#l1.18"></a><span id="l1.18"> </span>
<a href="#l1.19"></a><span id="l1.19">   let index = 0;</span>
<a href="#l1.20"></a><span id="l1.20">   for (let item of gFilterListbox.selectedItems) {</span>
<a href="#l1.21"></a><span id="l1.21">     filterList.insertFilterAt(index++, item._filter);</span>
<a href="#l1.22"></a><span id="l1.22">   }</span>
<a href="#l1.23"></a><span id="l1.23"> </span>
<a href="#l1.24"></a><span id="l1.24">   MailServices.filters.applyFiltersToFolders(</span>
<a href="#l1.25"></a><span id="l1.25">     filterList,</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-    folders,</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+    [folder],</span>
<a href="#l1.28"></a><span id="l1.28">     gFilterListMsgWindow</span>
<a href="#l1.29"></a><span id="l1.29">   );</span>
<a href="#l1.30"></a><span id="l1.30"> }</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32"> function moveCurrentFilter(motion) {</span>
<a href="#l1.33"></a><span id="l1.33">   let filter = currentFilter();</span>
<a href="#l1.34"></a><span id="l1.34">   if (!filter) {</span>
<a href="#l1.35"></a><span id="l1.35">     return;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -2563,20 +2563,16 @@ function MsgFilters(emailAddress, folder</span>
<a href="#l2.4"></a><span id="l2.4">     // just launch filterList dialog</span>
<a href="#l2.5"></a><span id="l2.5">     args = { refresh: false, folder };</span>
<a href="#l2.6"></a><span id="l2.6">     MsgFilterList(args);</span>
<a href="#l2.7"></a><span id="l2.7">   }</span>
<a href="#l2.8"></a><span id="l2.8"> }</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> function MsgApplyFilters() {</span>
<a href="#l2.11"></a><span id="l2.11">   let preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-  let selectedFolders = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-    Ci.nsIMutableArray</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">-  );</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineminus">-  selectedFolders.appendElement(preselectedFolder);</span>
<a href="#l2.16"></a><span id="l2.16"> </span>
<a href="#l2.17"></a><span id="l2.17">   let curFilterList = preselectedFolder.getFilterList(msgWindow);</span>
<a href="#l2.18"></a><span id="l2.18">   // create a new filter list and copy over the enabled filters to it.</span>
<a href="#l2.19"></a><span id="l2.19">   // We do this instead of having the filter after the fact code ignore</span>
<a href="#l2.20"></a><span id="l2.20">   // disabled filters because the Filter Dialog filter after the fact</span>
<a href="#l2.21"></a><span id="l2.21">   // code would have to clone filters to allow disabled filters to run,</span>
<a href="#l2.22"></a><span id="l2.22">   // and we don't support cloning filters currently.</span>
<a href="#l2.23"></a><span id="l2.23">   let tempFilterList = MailServices.filters.getTempFilterList(</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineat">@@ -2596,32 +2592,32 @@ function MsgApplyFilters() {</span>
<a href="#l2.25"></a><span id="l2.25">       curFilter.filterType &amp; Ci.nsMsgFilterType.Manual</span>
<a href="#l2.26"></a><span id="l2.26">     ) {</span>
<a href="#l2.27"></a><span id="l2.27">       tempFilterList.insertFilterAt(newFilterIndex, curFilter);</span>
<a href="#l2.28"></a><span id="l2.28">       newFilterIndex++;</span>
<a href="#l2.29"></a><span id="l2.29">     }</span>
<a href="#l2.30"></a><span id="l2.30">   }</span>
<a href="#l2.31"></a><span id="l2.31">   MailServices.filters.applyFiltersToFolders(</span>
<a href="#l2.32"></a><span id="l2.32">     tempFilterList,</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-    selectedFolders,</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+    [preselectedFolder],</span>
<a href="#l2.35"></a><span id="l2.35">     msgWindow</span>
<a href="#l2.36"></a><span id="l2.36">   );</span>
<a href="#l2.37"></a><span id="l2.37"> }</span>
<a href="#l2.38"></a><span id="l2.38"> </span>
<a href="#l2.39"></a><span id="l2.39"> function MsgApplyFiltersToSelection() {</span>
<a href="#l2.40"></a><span id="l2.40">   // bail if we're dealing with a dummy header</span>
<a href="#l2.41"></a><span id="l2.41">   if (gMessageDisplay.isDummy) {</span>
<a href="#l2.42"></a><span id="l2.42">     return;</span>
<a href="#l2.43"></a><span id="l2.43">   }</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45">   var selectedMessages = gFolderDisplay.selectedMessages;</span>
<a href="#l2.46"></a><span id="l2.46">   if (selectedMessages.length) {</span>
<a href="#l2.47"></a><span id="l2.47">     MailServices.filters.applyFilters(</span>
<a href="#l2.48"></a><span id="l2.48">       Ci.nsMsgFilterType.Manual,</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-      toXPCOMArray(selectedMessages, Ci.nsIMutableArray),</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineplus">+      selectedMessages,</span>
<a href="#l2.51"></a><span id="l2.51">       gFolderDisplay.displayedFolder,</span>
<a href="#l2.52"></a><span id="l2.52">       msgWindow</span>
<a href="#l2.53"></a><span id="l2.53">     );</span>
<a href="#l2.54"></a><span id="l2.54">   }</span>
<a href="#l2.55"></a><span id="l2.55"> }</span>
<a href="#l2.56"></a><span id="l2.56"> </span>
<a href="#l2.57"></a><span id="l2.57"> function ChangeMailLayout(newLayout) {</span>
<a href="#l2.58"></a><span id="l2.58">   Services.prefs.setIntPref(&quot;mail.pane_config.dynamic&quot;, newLayout);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/modules/MessageArchiver.jsm</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/modules/MessageArchiver.jsm</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -123,28 +123,20 @@ MessageArchiver.prototype = {</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5">     if (typeof this.oncomplete == &quot;function&quot;) {</span>
<a href="#l3.6"></a><span id="l3.6">       this.oncomplete();</span>
<a href="#l3.7"></a><span id="l3.7">     }</span>
<a href="#l3.8"></a><span id="l3.8">   },</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10">   filterBatch() {</span>
<a href="#l3.11"></a><span id="l3.11">     let batch = this._currentBatch;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    let filterArray = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-      Ci.nsIMutableArray</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-    );</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-    for (let message of batch.messages) {</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-      filterArray.appendElement(message);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-    }</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-</span>
<a href="#l3.20"></a><span id="l3.20">     // Apply filters to this batch.</span>
<a href="#l3.21"></a><span id="l3.21">     MailServices.filters.applyFilters(</span>
<a href="#l3.22"></a><span id="l3.22">       Ci.nsMsgFilterType.Archive,</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-      filterArray,</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+      batch.messages,</span>
<a href="#l3.25"></a><span id="l3.25">       batch.srcFolder,</span>
<a href="#l3.26"></a><span id="l3.26">       this.msgWindow,</span>
<a href="#l3.27"></a><span id="l3.27">       this</span>
<a href="#l3.28"></a><span id="l3.28">     );</span>
<a href="#l3.29"></a><span id="l3.29">     // continues with onStopOperation</span>
<a href="#l3.30"></a><span id="l3.30">   },</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32">   onStopOperation(aResult) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/search/public/nsIMsgFilterService.idl</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/search/public/nsIMsgFilterService.idl</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -8,45 +8,44 @@</span>
<a href="#l4.4"></a><span id="l4.4"> </span>
<a href="#l4.5"></a><span id="l4.5"> interface nsIMsgFilterList;</span>
<a href="#l4.6"></a><span id="l4.6"> interface nsIMsgWindow;</span>
<a href="#l4.7"></a><span id="l4.7"> interface nsIMsgFilterCustomAction;</span>
<a href="#l4.8"></a><span id="l4.8"> interface nsISimpleEnumerator;</span>
<a href="#l4.9"></a><span id="l4.9"> interface nsIFile;</span>
<a href="#l4.10"></a><span id="l4.10"> interface nsIMsgFolder;</span>
<a href="#l4.11"></a><span id="l4.11"> interface nsIMsgSearchCustomTerm;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-interface nsIArray;</span>
<a href="#l4.13"></a><span id="l4.13"> interface nsIMsgOperationListener;</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> [scriptable, uuid(78a74023-1692-4567-8d72-9ca58fbbd427)]</span>
<a href="#l4.16"></a><span id="l4.16"> interface nsIMsgFilterService : nsISupports {</span>
<a href="#l4.17"></a><span id="l4.17"> </span>
<a href="#l4.18"></a><span id="l4.18">     nsIMsgFilterList OpenFilterList(in nsIFile filterFile, in nsIMsgFolder rootFolder, in nsIMsgWindow msgWindow);</span>
<a href="#l4.19"></a><span id="l4.19">     void CloseFilterList(in nsIMsgFilterList filterList);</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21">     void SaveFilterList(in nsIMsgFilterList filterList,</span>
<a href="#l4.22"></a><span id="l4.22">                         in nsIFile filterFile);</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24">     void CancelFilterList(in nsIMsgFilterList filterList);</span>
<a href="#l4.25"></a><span id="l4.25">     nsIMsgFilterList getTempFilterList(in nsIMsgFolder aFolder);</span>
<a href="#l4.26"></a><span id="l4.26">     void applyFiltersToFolders(in nsIMsgFilterList aFilterList,</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineminus">-                               in nsIArray aFolders,</span>
<a href="#l4.28"></a><span id="l4.28" class="difflineplus">+                               in Array&lt;nsIMsgFolder&gt; aFolders,</span>
<a href="#l4.29"></a><span id="l4.29">                                in nsIMsgWindow aMsgWindow,</span>
<a href="#l4.30"></a><span id="l4.30">                                [optional] in nsIMsgOperationListener aCallback);</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32">     /*</span>
<a href="#l4.33"></a><span id="l4.33">      * Apply filters to a specific list of messages in a folder.</span>
<a href="#l4.34"></a><span id="l4.34">      * @param  aFilterType  The type of filter to match against</span>
<a href="#l4.35"></a><span id="l4.35">      * @param  aMsgHdrList  The list of message headers (nsIMsgDBHdr objects)</span>
<a href="#l4.36"></a><span id="l4.36">      * @param  aFolder      The folder the messages belong to</span>
<a href="#l4.37"></a><span id="l4.37">      * @param  aMsgWindow   A UI window for attaching progress/dialogs</span>
<a href="#l4.38"></a><span id="l4.38">      * @param  aCallback    A listener that gets notified of any filtering error</span>
<a href="#l4.39"></a><span id="l4.39">      */</span>
<a href="#l4.40"></a><span id="l4.40">     void applyFilters(in nsMsgFilterTypeType aFilterType,</span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-                      in nsIArray aMsgHdrList,</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+                      in Array&lt;nsIMsgDBHdr&gt; aMsgHdrList,</span>
<a href="#l4.43"></a><span id="l4.43">                       in nsIMsgFolder aFolder,</span>
<a href="#l4.44"></a><span id="l4.44">                       in nsIMsgWindow aMsgWindow,</span>
<a href="#l4.45"></a><span id="l4.45">                       [optional] in nsIMsgOperationListener aCallback);</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47">     /**</span>
<a href="#l4.48"></a><span id="l4.48">      * add a custom filter action</span>
<a href="#l4.49"></a><span id="l4.49">      *</span>
<a href="#l4.50"></a><span id="l4.50">      * @param  aAction   the custom action to add</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/search/src/PeriodicFilterManager.jsm</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/search/src/PeriodicFilterManager.jsm</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -11,16 +11,19 @@</span>
<a href="#l5.4"></a><span id="l5.4"> </span>
<a href="#l5.5"></a><span id="l5.5"> const EXPORTED_SYMBOLS = [&quot;PeriodicFilterManager&quot;];</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> const { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/Log4moz.jsm&quot;);</span>
<a href="#l5.8"></a><span id="l5.8"> const { MailServices } = ChromeUtils.import(</span>
<a href="#l5.9"></a><span id="l5.9">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l5.10"></a><span id="l5.10"> );</span>
<a href="#l5.11"></a><span id="l5.11"> const { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+const { fixIterator } = ChromeUtils.import(</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  &quot;resource:///modules/iteratorUtils.jsm&quot;</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+);</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> const log = Log4Moz.getConfiguredLogger(</span>
<a href="#l5.17"></a><span id="l5.17">   &quot;mail.periodicFilterManager&quot;,</span>
<a href="#l5.18"></a><span id="l5.18">   Log4Moz.Level.Warn,</span>
<a href="#l5.19"></a><span id="l5.19">   Log4Moz.Level.Warn,</span>
<a href="#l5.20"></a><span id="l5.20">   Log4Moz.Level.Warn</span>
<a href="#l5.21"></a><span id="l5.21"> );</span>
<a href="#l5.22"></a><span id="l5.22"> </span>
<a href="#l5.23"></a><span id="l5.23" class="difflineat">@@ -137,17 +140,17 @@ var PeriodicFilterManager = {</span>
<a href="#l5.24"></a><span id="l5.24">       }</span>
<a href="#l5.25"></a><span id="l5.25"> </span>
<a href="#l5.26"></a><span id="l5.26">       log.debug(</span>
<a href="#l5.27"></a><span id="l5.27">         &quot;PeriodicFilterManager apply periodic filters to server &quot; +</span>
<a href="#l5.28"></a><span id="l5.28">           server.prettyName</span>
<a href="#l5.29"></a><span id="l5.29">       );</span>
<a href="#l5.30"></a><span id="l5.30">       MailServices.filters.applyFiltersToFolders(</span>
<a href="#l5.31"></a><span id="l5.31">         tempFilterList,</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-        foldersToFilter,</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+        [...fixIterator(foldersToFilter, Ci.nsIMsgFolder)],</span>
<a href="#l5.34"></a><span id="l5.34">         null</span>
<a href="#l5.35"></a><span id="l5.35">       );</span>
<a href="#l5.36"></a><span id="l5.36">     }</span>
<a href="#l5.37"></a><span id="l5.37">     this._running = false;</span>
<a href="#l5.38"></a><span id="l5.38">   },</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40">   /**</span>
<a href="#l5.41"></a><span id="l5.41">    * Gets the periodic filter interval for the given server.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgFilterService.cpp</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -339,17 +339,18 @@ nsresult nsMsgFilterService::ThrowAlertM</span>
<a href="#l6.4"></a><span id="l6.4"> // operations, or imap/local  moves, the action will be asynchronous, so we'll</span>
<a href="#l6.5"></a><span id="l6.5"> // need to be a url listener as well, and kick off the next filter when the</span>
<a href="#l6.6"></a><span id="l6.6"> // action completes.</span>
<a href="#l6.7"></a><span id="l6.7"> class nsMsgFilterAfterTheFact : public nsIUrlListener,</span>
<a href="#l6.8"></a><span id="l6.8">                                 public nsIMsgSearchNotify,</span>
<a href="#l6.9"></a><span id="l6.9">                                 public nsIMsgCopyServiceListener {</span>
<a href="#l6.10"></a><span id="l6.10">  public:</span>
<a href="#l6.11"></a><span id="l6.11">   nsMsgFilterAfterTheFact(nsIMsgWindow *aMsgWindow,</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-                          nsIMsgFilterList *aFilterList, nsIArray *aFolderList,</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+                          nsIMsgFilterList *aFilterList,</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+                          const nsTArray&lt;RefPtr&lt;nsIMsgFolder&gt;&gt; &amp;aFolderList,</span>
<a href="#l6.15"></a><span id="l6.15">                           nsIMsgOperationListener *aCallback);</span>
<a href="#l6.16"></a><span id="l6.16">   NS_DECL_ISUPPORTS</span>
<a href="#l6.17"></a><span id="l6.17">   NS_DECL_NSIURLLISTENER</span>
<a href="#l6.18"></a><span id="l6.18">   NS_DECL_NSIMSGSEARCHNOTIFY</span>
<a href="#l6.19"></a><span id="l6.19">   NS_DECL_NSIMSGCOPYSERVICELISTENER</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21">   nsresult AdvanceToNextFolder();  // kicks off the process</span>
<a href="#l6.22"></a><span id="l6.22">  protected:</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineat">@@ -361,47 +362,46 @@ class nsMsgFilterAfterTheFact : public n</span>
<a href="#l6.24"></a><span id="l6.24">   nsresult ApplyFilter();</span>
<a href="#l6.25"></a><span id="l6.25">   nsresult OnEndExecution();  // do what we have to do to cleanup.</span>
<a href="#l6.26"></a><span id="l6.26">   bool ContinueExecutionPrompt();</span>
<a href="#l6.27"></a><span id="l6.27">   nsresult DisplayConfirmationPrompt(nsIMsgWindow *msgWindow,</span>
<a href="#l6.28"></a><span id="l6.28">                                      const char16_t *confirmString,</span>
<a href="#l6.29"></a><span id="l6.29">                                      bool *confirmed);</span>
<a href="#l6.30"></a><span id="l6.30">   nsCOMPtr&lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l6.31"></a><span id="l6.31">   nsCOMPtr&lt;nsIMsgFilterList&gt; m_filters;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineminus">-  nsCOMPtr&lt;nsIArray&gt; m_folders;</span>
<a href="#l6.33"></a><span id="l6.33" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgFolder&gt;&gt; m_folders;</span>
<a href="#l6.34"></a><span id="l6.34">   nsCOMPtr&lt;nsIMsgFolder&gt; m_curFolder;</span>
<a href="#l6.35"></a><span id="l6.35">   nsCOMPtr&lt;nsIMsgDatabase&gt; m_curFolderDB;</span>
<a href="#l6.36"></a><span id="l6.36">   nsCOMPtr&lt;nsIMsgFilter&gt; m_curFilter;</span>
<a href="#l6.37"></a><span id="l6.37">   uint32_t m_curFilterIndex;</span>
<a href="#l6.38"></a><span id="l6.38">   uint32_t m_curFolderIndex;</span>
<a href="#l6.39"></a><span id="l6.39">   uint32_t m_numFilters;</span>
<a href="#l6.40"></a><span id="l6.40" class="difflineminus">-  uint32_t m_numFolders;</span>
<a href="#l6.41"></a><span id="l6.41">   nsTArray&lt;nsMsgKey&gt; m_searchHits;</span>
<a href="#l6.42"></a><span id="l6.42">   nsCOMPtr&lt;nsIMutableArray&gt; m_searchHitHdrs;</span>
<a href="#l6.43"></a><span id="l6.43">   nsTArray&lt;nsMsgKey&gt; m_stopFiltering;</span>
<a href="#l6.44"></a><span id="l6.44">   nsCOMPtr&lt;nsIMsgSearchSession&gt; m_searchSession;</span>
<a href="#l6.45"></a><span id="l6.45">   nsCOMPtr&lt;nsIMsgOperationListener&gt; m_callback;</span>
<a href="#l6.46"></a><span id="l6.46">   uint32_t m_nextAction;  // next filter action to perform</span>
<a href="#l6.47"></a><span id="l6.47">   nsresult mFinalResult;  // report of overall success or failure</span>
<a href="#l6.48"></a><span id="l6.48">   bool mNeedsRelease;     // Did we need to release ourself?</span>
<a href="#l6.49"></a><span id="l6.49"> };</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51"> NS_IMPL_ISUPPORTS(nsMsgFilterAfterTheFact, nsIUrlListener, nsIMsgSearchNotify,</span>
<a href="#l6.52"></a><span id="l6.52">                   nsIMsgCopyServiceListener)</span>
<a href="#l6.53"></a><span id="l6.53"> </span>
<a href="#l6.54"></a><span id="l6.54"> nsMsgFilterAfterTheFact::nsMsgFilterAfterTheFact(</span>
<a href="#l6.55"></a><span id="l6.55">     nsIMsgWindow *aMsgWindow, nsIMsgFilterList *aFilterList,</span>
<a href="#l6.56"></a><span id="l6.56" class="difflineminus">-    nsIArray *aFolderList, nsIMsgOperationListener *aCallback) {</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgFolder&gt;&gt; &amp;aFolderList,</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineplus">+    nsIMsgOperationListener *aCallback) {</span>
<a href="#l6.59"></a><span id="l6.59">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug, (&quot;(Post) nsMsgFilterAfterTheFact&quot;));</span>
<a href="#l6.60"></a><span id="l6.60">   m_curFilterIndex = m_curFolderIndex = m_nextAction = 0;</span>
<a href="#l6.61"></a><span id="l6.61">   m_msgWindow = aMsgWindow;</span>
<a href="#l6.62"></a><span id="l6.62">   m_filters = aFilterList;</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineminus">-  m_folders = aFolderList;</span>
<a href="#l6.64"></a><span id="l6.64" class="difflineplus">+  m_folders = aFolderList.Clone();</span>
<a href="#l6.65"></a><span id="l6.65">   m_filters-&gt;GetFilterCount(&amp;m_numFilters);</span>
<a href="#l6.66"></a><span id="l6.66" class="difflineminus">-  m_folders-&gt;GetLength(&amp;m_numFolders);</span>
<a href="#l6.67"></a><span id="l6.67"> </span>
<a href="#l6.68"></a><span id="l6.68">   NS_ADDREF_THIS();  // we own ourselves, and will release ourselves when</span>
<a href="#l6.69"></a><span id="l6.69">                      // execution is done.</span>
<a href="#l6.70"></a><span id="l6.70">   mNeedsRelease = true;</span>
<a href="#l6.71"></a><span id="l6.71"> </span>
<a href="#l6.72"></a><span id="l6.72">   m_searchHitHdrs = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l6.73"></a><span id="l6.73">   m_callback = aCallback;</span>
<a href="#l6.74"></a><span id="l6.74">   mFinalResult = NS_OK;</span>
<a href="#l6.75"></a><span id="l6.75" class="difflineat">@@ -500,29 +500,28 @@ nsresult nsMsgFilterAfterTheFact::RunNex</span>
<a href="#l6.76"></a><span id="l6.76"> nsresult nsMsgFilterAfterTheFact::AdvanceToNextFolder() {</span>
<a href="#l6.77"></a><span id="l6.77">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l6.78"></a><span id="l6.78">           (&quot;(Post) nsMsgFilterAfterTheFact::AdvanceToNextFolder&quot;));</span>
<a href="#l6.79"></a><span id="l6.79">   nsresult rv = NS_OK;</span>
<a href="#l6.80"></a><span id="l6.80">   // Advance through folders, making sure m_curFolder is null on errors</span>
<a href="#l6.81"></a><span id="l6.81">   while (true) {</span>
<a href="#l6.82"></a><span id="l6.82">     m_stopFiltering.Clear();</span>
<a href="#l6.83"></a><span id="l6.83">     m_curFolder = nullptr;</span>
<a href="#l6.84"></a><span id="l6.84" class="difflineminus">-    if (m_curFolderIndex &gt;= m_numFolders) {</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineplus">+    if (m_curFolderIndex &gt;= m_folders.Length()) {</span>
<a href="#l6.86"></a><span id="l6.86">       // final end of nsMsgFilterAfterTheFact object</span>
<a href="#l6.87"></a><span id="l6.87">       return OnEndExecution();</span>
<a href="#l6.88"></a><span id="l6.88">     }</span>
<a href="#l6.89"></a><span id="l6.89"> </span>
<a href="#l6.90"></a><span id="l6.90">     MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l6.91"></a><span id="l6.91">             (&quot;(Post) Entering folder %&quot; PRIu32, m_curFolderIndex));</span>
<a href="#l6.92"></a><span id="l6.92"> </span>
<a href="#l6.93"></a><span id="l6.93">     // reset the filter index to apply all filters to this new folder</span>
<a href="#l6.94"></a><span id="l6.94">     m_curFilterIndex = 0;</span>
<a href="#l6.95"></a><span id="l6.95">     m_nextAction = 0;</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-    m_curFolder = do_QueryElementAt(m_folders, m_curFolderIndex++, &amp;rv);</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-    CONTINUE_IF_FAILURE(rv, &quot;Could not get next folder&quot;);</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineplus">+    m_curFolder = m_folders[m_curFolderIndex++];</span>
<a href="#l6.99"></a><span id="l6.99"> </span>
<a href="#l6.100"></a><span id="l6.100">     // Note: I got rv = NS_OK but null m_curFolder after deleting a folder</span>
<a href="#l6.101"></a><span id="l6.101">     // outside of TB, when I select a single message and &quot;run filter on message&quot;</span>
<a href="#l6.102"></a><span id="l6.102">     // and the filter is to move the message to the deleted folder.</span>
<a href="#l6.103"></a><span id="l6.103"> </span>
<a href="#l6.104"></a><span id="l6.104">     // m_curFolder may be null when the folder is deleted externally.</span>
<a href="#l6.105"></a><span id="l6.105">     CONTINUE_IF_FALSE(m_curFolder, &quot;Next folder returned null&quot;);</span>
<a href="#l6.106"></a><span id="l6.106"> </span>
<a href="#l6.107"></a><span id="l6.107" class="difflineat">@@ -1068,36 +1067,33 @@ NS_IMETHODIMP nsMsgFilterService::GetTem</span>
<a href="#l6.108"></a><span id="l6.108">   nsMsgFilterList *filterList = new nsMsgFilterList;</span>
<a href="#l6.109"></a><span id="l6.109">   filterList-&gt;SetFolder(aFolder);</span>
<a href="#l6.110"></a><span id="l6.110">   filterList-&gt;m_temporaryList = true;</span>
<a href="#l6.111"></a><span id="l6.111">   NS_ADDREF(*aFilterList = filterList);</span>
<a href="#l6.112"></a><span id="l6.112">   return NS_OK;</span>
<a href="#l6.113"></a><span id="l6.113"> }</span>
<a href="#l6.114"></a><span id="l6.114"> </span>
<a href="#l6.115"></a><span id="l6.115"> NS_IMETHODIMP</span>
<a href="#l6.116"></a><span id="l6.116" class="difflineminus">-nsMsgFilterService::ApplyFiltersToFolders(nsIMsgFilterList *aFilterList,</span>
<a href="#l6.117"></a><span id="l6.117" class="difflineminus">-                                          nsIArray *aFolders,</span>
<a href="#l6.118"></a><span id="l6.118" class="difflineminus">-                                          nsIMsgWindow *aMsgWindow,</span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-                                          nsIMsgOperationListener *aCallback) {</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+nsMsgFilterService::ApplyFiltersToFolders(</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineplus">+    nsIMsgFilterList *aFilterList,</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgFolder&gt;&gt; &amp;aFolders, nsIMsgWindow *aMsgWindow,</span>
<a href="#l6.123"></a><span id="l6.123" class="difflineplus">+    nsIMsgOperationListener *aCallback) {</span>
<a href="#l6.124"></a><span id="l6.124">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l6.125"></a><span id="l6.125">           (&quot;(Post) nsMsgFilterService::ApplyFiltersToFolders&quot;));</span>
<a href="#l6.126"></a><span id="l6.126">   NS_ENSURE_ARG_POINTER(aFilterList);</span>
<a href="#l6.127"></a><span id="l6.127" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aFolders);</span>
<a href="#l6.128"></a><span id="l6.128"> </span>
<a href="#l6.129"></a><span id="l6.129">   uint32_t filterCount;</span>
<a href="#l6.130"></a><span id="l6.130">   aFilterList-&gt;GetFilterCount(&amp;filterCount);</span>
<a href="#l6.131"></a><span id="l6.131">   nsCString listId;</span>
<a href="#l6.132"></a><span id="l6.132">   aFilterList-&gt;GetListId(listId);</span>
<a href="#l6.133"></a><span id="l6.133" class="difflineminus">-  uint32_t folderCount;</span>
<a href="#l6.134"></a><span id="l6.134" class="difflineminus">-  aFolders-&gt;GetLength(&amp;folderCount);</span>
<a href="#l6.135"></a><span id="l6.135">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l6.136"></a><span id="l6.136">           (&quot;(Post) Manual filter run initiated&quot;));</span>
<a href="#l6.137"></a><span id="l6.137">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l6.138"></a><span id="l6.138">           (&quot;(Post) Running %&quot; PRIu32 &quot; filters from %s on %&quot; PRIu32 &quot; folders&quot;,</span>
<a href="#l6.139"></a><span id="l6.139" class="difflineminus">-           filterCount, listId.get(), folderCount));</span>
<a href="#l6.140"></a><span id="l6.140" class="difflineplus">+           filterCount, listId.get(), (int)aFolders.Length()));</span>
<a href="#l6.141"></a><span id="l6.141"> </span>
<a href="#l6.142"></a><span id="l6.142">   RefPtr&lt;nsMsgFilterAfterTheFact&gt; filterExecutor =</span>
<a href="#l6.143"></a><span id="l6.143">       new nsMsgFilterAfterTheFact(aMsgWindow, aFilterList, aFolders, aCallback);</span>
<a href="#l6.144"></a><span id="l6.144">   if (filterExecutor)</span>
<a href="#l6.145"></a><span id="l6.145">     return filterExecutor-&gt;AdvanceToNextFolder();</span>
<a href="#l6.146"></a><span id="l6.146">   else</span>
<a href="#l6.147"></a><span id="l6.147">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.148"></a><span id="l6.148"> }</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineat">@@ -1213,50 +1209,38 @@ nsMsgFilterService::FilterTypeName(nsMsg</span>
<a href="#l6.150"></a><span id="l6.150"> }</span>
<a href="#l6.151"></a><span id="l6.151"> </span>
<a href="#l6.152"></a><span id="l6.152"> // nsMsgApplyFiltersToMessages overrides nsMsgFilterAfterTheFact in order to</span>
<a href="#l6.153"></a><span id="l6.153"> // apply filters to a list of messages, rather than an entire folder</span>
<a href="#l6.154"></a><span id="l6.154"> class nsMsgApplyFiltersToMessages : public nsMsgFilterAfterTheFact {</span>
<a href="#l6.155"></a><span id="l6.155">  public:</span>
<a href="#l6.156"></a><span id="l6.156">   nsMsgApplyFiltersToMessages(nsIMsgWindow *aMsgWindow,</span>
<a href="#l6.157"></a><span id="l6.157">                               nsIMsgFilterList *aFilterList,</span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-                              nsIArray *aFolderList, nsIArray *aMsgHdrList,</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineplus">+                              const nsTArray&lt;RefPtr&lt;nsIMsgFolder&gt;&gt; &amp;aFolderList,</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+                              const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMsgHdrList,</span>
<a href="#l6.161"></a><span id="l6.161">                               nsMsgFilterTypeType aFilterType,</span>
<a href="#l6.162"></a><span id="l6.162">                               nsIMsgOperationListener *aCallback);</span>
<a href="#l6.163"></a><span id="l6.163"> </span>
<a href="#l6.164"></a><span id="l6.164">  protected:</span>
<a href="#l6.165"></a><span id="l6.165">   virtual nsresult RunNextFilter();</span>
<a href="#l6.166"></a><span id="l6.166"> </span>
<a href="#l6.167"></a><span id="l6.167" class="difflineminus">-  nsCOMArray&lt;nsIMsgDBHdr&gt; m_msgHdrList;</span>
<a href="#l6.168"></a><span id="l6.168" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; m_msgHdrList;</span>
<a href="#l6.169"></a><span id="l6.169">   nsMsgFilterTypeType m_filterType;</span>
<a href="#l6.170"></a><span id="l6.170"> };</span>
<a href="#l6.171"></a><span id="l6.171"> </span>
<a href="#l6.172"></a><span id="l6.172"> nsMsgApplyFiltersToMessages::nsMsgApplyFiltersToMessages(</span>
<a href="#l6.173"></a><span id="l6.173">     nsIMsgWindow *aMsgWindow, nsIMsgFilterList *aFilterList,</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineminus">-    nsIArray *aFolderList, nsIArray *aMsgHdrList,</span>
<a href="#l6.175"></a><span id="l6.175" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgFolder&gt;&gt; &amp;aFolderList,</span>
<a href="#l6.176"></a><span id="l6.176" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMsgHdrList,</span>
<a href="#l6.177"></a><span id="l6.177">     nsMsgFilterTypeType aFilterType, nsIMsgOperationListener *aCallback)</span>
<a href="#l6.178"></a><span id="l6.178">     : nsMsgFilterAfterTheFact(aMsgWindow, aFilterList, aFolderList, aCallback),</span>
<a href="#l6.179"></a><span id="l6.179" class="difflineplus">+      m_msgHdrList(aMsgHdrList.Clone()),</span>
<a href="#l6.180"></a><span id="l6.180">       m_filterType(aFilterType) {</span>
<a href="#l6.181"></a><span id="l6.181">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l6.182"></a><span id="l6.182">           (&quot;(Post) nsMsgApplyFiltersToMessages&quot;));</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; msgEnumerator;</span>
<a href="#l6.184"></a><span id="l6.184" class="difflineminus">-  if (NS_SUCCEEDED(aMsgHdrList-&gt;Enumerate(getter_AddRefs(msgEnumerator)))) {</span>
<a href="#l6.185"></a><span id="l6.185" class="difflineminus">-    uint32_t length;</span>
<a href="#l6.186"></a><span id="l6.186" class="difflineminus">-    if (NS_SUCCEEDED(aMsgHdrList-&gt;GetLength(&amp;length)))</span>
<a href="#l6.187"></a><span id="l6.187" class="difflineminus">-      m_msgHdrList.SetCapacity(length);</span>
<a href="#l6.188"></a><span id="l6.188" class="difflineminus">-</span>
<a href="#l6.189"></a><span id="l6.189" class="difflineminus">-    bool hasMore;</span>
<a href="#l6.190"></a><span id="l6.190" class="difflineminus">-    while (NS_SUCCEEDED(msgEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore) {</span>
<a href="#l6.191"></a><span id="l6.191" class="difflineminus">-      nsCOMPtr&lt;nsISupports&gt; supports;</span>
<a href="#l6.192"></a><span id="l6.192" class="difflineminus">-      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l6.193"></a><span id="l6.193" class="difflineminus">-      if (NS_SUCCEEDED(msgEnumerator-&gt;GetNext(getter_AddRefs(supports))) &amp;&amp;</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-          (msgHdr = do_QueryInterface(supports)))</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-        m_msgHdrList.AppendObject(msgHdr);</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineminus">-    }</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineminus">-  }</span>
<a href="#l6.198"></a><span id="l6.198"> }</span>
<a href="#l6.199"></a><span id="l6.199"> </span>
<a href="#l6.200"></a><span id="l6.200"> nsresult nsMsgApplyFiltersToMessages::RunNextFilter() {</span>
<a href="#l6.201"></a><span id="l6.201">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l6.202"></a><span id="l6.202">           (&quot;(Post) nsMsgApplyFiltersToMessages::RunNextFilter&quot;));</span>
<a href="#l6.203"></a><span id="l6.203">   nsresult rv = NS_OK;</span>
<a href="#l6.204"></a><span id="l6.204">   while (true) {</span>
<a href="#l6.205"></a><span id="l6.205">     m_curFilter = nullptr;  // we are done with the current filter</span>
<a href="#l6.206"></a><span id="l6.206" class="difflineat">@@ -1288,20 +1272,17 @@ nsresult nsMsgApplyFiltersToMessages::Ru</span>
<a href="#l6.207"></a><span id="l6.207">     // clang-format on</span>
<a href="#l6.208"></a><span id="l6.208"> </span>
<a href="#l6.209"></a><span id="l6.209">     nsCOMPtr&lt;nsIMsgSearchScopeTerm&gt; scope(new nsMsgSearchScopeTerm(</span>
<a href="#l6.210"></a><span id="l6.210">         nullptr, nsMsgSearchScope::offlineMail, m_curFolder));</span>
<a href="#l6.211"></a><span id="l6.211">     BREAK_IF_FALSE(scope, &quot;Could not create scope, OOM?&quot;);</span>
<a href="#l6.212"></a><span id="l6.212">     m_curFilter-&gt;SetScope(scope);</span>
<a href="#l6.213"></a><span id="l6.213">     OnNewSearch();</span>
<a href="#l6.214"></a><span id="l6.214"> </span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-    for (int32_t i = 0; i &lt; m_msgHdrList.Count(); i++) {</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = m_msgHdrList[i];</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-      CONTINUE_IF_FALSE(msgHdr, &quot;null msgHdr&quot;);</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineminus">-</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineplus">+    for (auto msgHdr : m_msgHdrList) {</span>
<a href="#l6.220"></a><span id="l6.220">       bool matched;</span>
<a href="#l6.221"></a><span id="l6.221">       rv = m_curFilter-&gt;MatchHdr(msgHdr, m_curFolder, m_curFolderDB,</span>
<a href="#l6.222"></a><span id="l6.222">                                  EmptyCString(), &amp;matched);</span>
<a href="#l6.223"></a><span id="l6.223">       if (NS_SUCCEEDED(rv) &amp;&amp; matched) {</span>
<a href="#l6.224"></a><span id="l6.224">         // In order to work with nsMsgFilterAfterTheFact::ApplyFilter we</span>
<a href="#l6.225"></a><span id="l6.225">         // initialize nsMsgFilterAfterTheFact's information with a search hit</span>
<a href="#l6.226"></a><span id="l6.226">         // now for the message that we're filtering.</span>
<a href="#l6.227"></a><span id="l6.227">         OnSearchHit(msgHdr, m_curFolder);</span>
<a href="#l6.228"></a><span id="l6.228" class="difflineat">@@ -1335,56 +1316,48 @@ nsresult nsMsgApplyFiltersToMessages::Ru</span>
<a href="#l6.229"></a><span id="l6.229"> </span>
<a href="#l6.230"></a><span id="l6.230">   // We expect the failure is already recorded through one of the macro</span>
<a href="#l6.231"></a><span id="l6.231">   // expressions, that will have console logging added to them.</span>
<a href="#l6.232"></a><span id="l6.232">   // So an additional console warning is not needed here.</span>
<a href="#l6.233"></a><span id="l6.233">   return AdvanceToNextFolder();</span>
<a href="#l6.234"></a><span id="l6.234"> }</span>
<a href="#l6.235"></a><span id="l6.235"> </span>
<a href="#l6.236"></a><span id="l6.236"> NS_IMETHODIMP nsMsgFilterService::ApplyFilters(</span>
<a href="#l6.237"></a><span id="l6.237" class="difflineminus">-    nsMsgFilterTypeType aFilterType, nsIArray *aMsgHdrList,</span>
<a href="#l6.238"></a><span id="l6.238" class="difflineminus">-    nsIMsgFolder *aFolder, nsIMsgWindow *aMsgWindow,</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-    nsIMsgOperationListener *aCallback) {</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineplus">+    nsMsgFilterTypeType aFilterType,</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+    const nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; &amp;aMsgHdrList, nsIMsgFolder *aFolder,</span>
<a href="#l6.242"></a><span id="l6.242" class="difflineplus">+    nsIMsgWindow *aMsgWindow, nsIMsgOperationListener *aCallback) {</span>
<a href="#l6.243"></a><span id="l6.243">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Debug,</span>
<a href="#l6.244"></a><span id="l6.244">           (&quot;(Post) nsMsgApplyFiltersToMessages::ApplyFilters&quot;));</span>
<a href="#l6.245"></a><span id="l6.245">   NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l6.246"></a><span id="l6.246"> </span>
<a href="#l6.247"></a><span id="l6.247">   nsCOMPtr&lt;nsIMsgFilterList&gt; filterList;</span>
<a href="#l6.248"></a><span id="l6.248">   nsresult rv = aFolder-&gt;GetFilterList(aMsgWindow, getter_AddRefs(filterList));</span>
<a href="#l6.249"></a><span id="l6.249">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.250"></a><span id="l6.250"> </span>
<a href="#l6.251"></a><span id="l6.251" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; folderList(</span>
<a href="#l6.252"></a><span id="l6.252" class="difflineminus">-      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l6.253"></a><span id="l6.253" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l6.254"></a><span id="l6.254" class="difflineminus">-</span>
<a href="#l6.255"></a><span id="l6.255" class="difflineminus">-  folderList-&gt;AppendElement(aFolder);</span>
<a href="#l6.256"></a><span id="l6.256" class="difflineminus">-</span>
<a href="#l6.257"></a><span id="l6.257">   uint32_t filterCount;</span>
<a href="#l6.258"></a><span id="l6.258">   filterList-&gt;GetFilterCount(&amp;filterCount);</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-  uint32_t msgCount;</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-  aMsgHdrList-&gt;GetLength(&amp;msgCount);</span>
<a href="#l6.261"></a><span id="l6.261">   nsCString listId;</span>
<a href="#l6.262"></a><span id="l6.262">   filterList-&gt;GetListId(listId);</span>
<a href="#l6.263"></a><span id="l6.263">   nsString folderName;</span>
<a href="#l6.264"></a><span id="l6.264">   aFolder-&gt;GetName(folderName);</span>
<a href="#l6.265"></a><span id="l6.265">   nsCString typeName;</span>
<a href="#l6.266"></a><span id="l6.266">   FilterTypeName(aFilterType, typeName);</span>
<a href="#l6.267"></a><span id="l6.267">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l6.268"></a><span id="l6.268">           (&quot;(Post) Filter run initiated, trigger=%s (%i)&quot;, typeName.get(),</span>
<a href="#l6.269"></a><span id="l6.269">            aFilterType));</span>
<a href="#l6.270"></a><span id="l6.270">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l6.271"></a><span id="l6.271">           (&quot;(Post) Running %&quot; PRIu32 &quot; filters from %s on %&quot; PRIu32</span>
<a href="#l6.272"></a><span id="l6.272">            &quot; message(s) in folder '%s'&quot;,</span>
<a href="#l6.273"></a><span id="l6.273" class="difflineminus">-           filterCount, listId.get(), msgCount,</span>
<a href="#l6.274"></a><span id="l6.274" class="difflineplus">+           filterCount, listId.get(), (uint32_t)aMsgHdrList.Length(),</span>
<a href="#l6.275"></a><span id="l6.275">            NS_ConvertUTF16toUTF8(folderName).get()));</span>
<a href="#l6.276"></a><span id="l6.276"> </span>
<a href="#l6.277"></a><span id="l6.277">   // Create our nsMsgApplyFiltersToMessages object which will be called when</span>
<a href="#l6.278"></a><span id="l6.278">   // ApplyFiltersToHdr finds one or more filters that hit.</span>
<a href="#l6.279"></a><span id="l6.279">   RefPtr&lt;nsMsgApplyFiltersToMessages&gt; filterExecutor =</span>
<a href="#l6.280"></a><span id="l6.280" class="difflineminus">-      new nsMsgApplyFiltersToMessages(aMsgWindow, filterList, folderList,</span>
<a href="#l6.281"></a><span id="l6.281" class="difflineplus">+      new nsMsgApplyFiltersToMessages(aMsgWindow, filterList, {aFolder},</span>
<a href="#l6.282"></a><span id="l6.282">                                       aMsgHdrList, aFilterType, aCallback);</span>
<a href="#l6.283"></a><span id="l6.283"> </span>
<a href="#l6.284"></a><span id="l6.284">   if (filterExecutor) return filterExecutor-&gt;AdvanceToNextFolder();</span>
<a href="#l6.285"></a><span id="l6.285"> </span>
<a href="#l6.286"></a><span id="l6.286">   return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l6.287"></a><span id="l6.287"> }</span>
<a href="#l6.288"></a><span id="l6.288"> </span>
<a href="#l6.289"></a><span id="l6.289"> /* void OnStartCopy (); */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/test/unit/test_copyThenMoveManual.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_copyThenMoveManual.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -42,27 +42,23 @@ var gTestArray = [</span>
<a href="#l7.4"></a><span id="l7.4">   },</span>
<a href="#l7.5"></a><span id="l7.5">   // just get a message into the local folder</span>
<a href="#l7.6"></a><span id="l7.6">   async function getLocalMessages1() {</span>
<a href="#l7.7"></a><span id="l7.7">     gPOP3Pump.files = gFiles;</span>
<a href="#l7.8"></a><span id="l7.8">     await gPOP3Pump.run();</span>
<a href="#l7.9"></a><span id="l7.9">   },</span>
<a href="#l7.10"></a><span id="l7.10">   // test applying filters to a message header</span>
<a href="#l7.11"></a><span id="l7.11">   async function applyFilters() {</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-    let messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-      Ci.nsIMutableArray</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-    );</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-    messages.appendElement(localAccountUtils.inboxFolder.firstNewMessage);</span>
<a href="#l7.16"></a><span id="l7.16">     let promiseFolderEvent = PromiseTestUtils.promiseFolderEvent(</span>
<a href="#l7.17"></a><span id="l7.17">       localAccountUtils.inboxFolder,</span>
<a href="#l7.18"></a><span id="l7.18">       &quot;DeleteOrMoveMsgCompleted&quot;</span>
<a href="#l7.19"></a><span id="l7.19">     );</span>
<a href="#l7.20"></a><span id="l7.20">     MailServices.filters.applyFilters(</span>
<a href="#l7.21"></a><span id="l7.21">       Ci.nsMsgFilterType.Manual,</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-      messages,</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+      [localAccountUtils.inboxFolder.firstNewMessage],</span>
<a href="#l7.24"></a><span id="l7.24">       localAccountUtils.inboxFolder,</span>
<a href="#l7.25"></a><span id="l7.25">       null</span>
<a href="#l7.26"></a><span id="l7.26">     );</span>
<a href="#l7.27"></a><span id="l7.27">     await promiseFolderEvent;</span>
<a href="#l7.28"></a><span id="l7.28">   },</span>
<a href="#l7.29"></a><span id="l7.29">   function verifyFolders1() {</span>
<a href="#l7.30"></a><span id="l7.30">     // Copy and Move should each now have 1 message in them.</span>
<a href="#l7.31"></a><span id="l7.31">     Assert.equal(folderCount(gCopyFolder), 1);</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineat">@@ -73,18 +69,17 @@ var gTestArray = [</span>
<a href="#l7.33"></a><span id="l7.33">   },</span>
<a href="#l7.34"></a><span id="l7.34">   // just get a message into the local folder</span>
<a href="#l7.35"></a><span id="l7.35">   async function getLocalMessages2() {</span>
<a href="#l7.36"></a><span id="l7.36">     gPOP3Pump.files = gFiles;</span>
<a href="#l7.37"></a><span id="l7.37">     await gPOP3Pump.run();</span>
<a href="#l7.38"></a><span id="l7.38">   },</span>
<a href="#l7.39"></a><span id="l7.39">   // use the alternate call into the filter service</span>
<a href="#l7.40"></a><span id="l7.40">   async function applyFiltersToFolders() {</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineminus">-    let folders = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineminus">-    folders.appendElement(localAccountUtils.inboxFolder);</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+    let folders = [localAccountUtils.inboxFolder];</span>
<a href="#l7.44"></a><span id="l7.44">     let promiseFolderEvent = PromiseTestUtils.promiseFolderEvent(</span>
<a href="#l7.45"></a><span id="l7.45">       localAccountUtils.inboxFolder,</span>
<a href="#l7.46"></a><span id="l7.46">       &quot;DeleteOrMoveMsgCompleted&quot;</span>
<a href="#l7.47"></a><span id="l7.47">     );</span>
<a href="#l7.48"></a><span id="l7.48">     MailServices.filters.applyFiltersToFolders(gFilterList, folders, null);</span>
<a href="#l7.49"></a><span id="l7.49">     await promiseFolderEvent;</span>
<a href="#l7.50"></a><span id="l7.50">   },</span>
<a href="#l7.51"></a><span id="l7.51">   function verifyFolders2() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -2094,31 +2094,28 @@ nsMsgDBFolder::OnMessageClassified(const</span>
<a href="#l8.4"></a><span id="l8.4">                                    nsMsgJunkStatus aClassification,</span>
<a href="#l8.5"></a><span id="l8.5">                                    uint32_t aJunkPercent) {</span>
<a href="#l8.6"></a><span id="l8.6">   nsresult rv = GetDatabase();</span>
<a href="#l8.7"></a><span id="l8.7">   NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9">   if (!aMsgURI)  // This signifies end of batch.</span>
<a href="#l8.10"></a><span id="l8.10">   {</span>
<a href="#l8.11"></a><span id="l8.11">     // Apply filters if needed.</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    uint32_t length;</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-    if (mPostBayesMessagesToFilter &amp;&amp;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-        NS_SUCCEEDED(mPostBayesMessagesToFilter-&gt;GetLength(&amp;length)) &amp;&amp;</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-        length) {</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+    if (!mPostBayesMessagesToFilter.IsEmpty()) {</span>
<a href="#l8.17"></a><span id="l8.17">       // Apply post-bayes filtering.</span>
<a href="#l8.18"></a><span id="l8.18">       nsCOMPtr&lt;nsIMsgFilterService&gt; filterService(</span>
<a href="#l8.19"></a><span id="l8.19">           do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l8.20"></a><span id="l8.20">       if (NS_SUCCEEDED(rv))</span>
<a href="#l8.21"></a><span id="l8.21">         // We use a null nsIMsgWindow because we don't want some sort of ui</span>
<a href="#l8.22"></a><span id="l8.22">         // appearing in the middle of automatic filtering (plus I really don't</span>
<a href="#l8.23"></a><span id="l8.23">         // want to propagate that value.)</span>
<a href="#l8.24"></a><span id="l8.24">         rv = filterService-&gt;ApplyFilters(nsMsgFilterType::PostPlugin,</span>
<a href="#l8.25"></a><span id="l8.25">                                          mPostBayesMessagesToFilter, this,</span>
<a href="#l8.26"></a><span id="l8.26">                                          nullptr, nullptr);</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-      mPostBayesMessagesToFilter-&gt;Clear();</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+      mPostBayesMessagesToFilter.Clear();</span>
<a href="#l8.29"></a><span id="l8.29">     }</span>
<a href="#l8.30"></a><span id="l8.30"> </span>
<a href="#l8.31"></a><span id="l8.31">     // If we classified any messages, send out a notification.</span>
<a href="#l8.32"></a><span id="l8.32">     nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; hdrs;</span>
<a href="#l8.33"></a><span id="l8.33">     rv = MsgGetHeadersFromKeys2(mDatabase, mClassifiedMsgKeys, hdrs);</span>
<a href="#l8.34"></a><span id="l8.34">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l8.35"></a><span id="l8.35">     if (!hdrs.IsEmpty()) {</span>
<a href="#l8.36"></a><span id="l8.36">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l8.37"></a><span id="l8.37" class="difflineat">@@ -2492,20 +2489,17 @@ nsMsgDBFolder::CallFilterPlugins(nsIMsgW</span>
<a href="#l8.38"></a><span id="l8.38">     if (!(processingFlags &amp; nsMsgProcessingFlags::FiltersDone)) {</span>
<a href="#l8.39"></a><span id="l8.39">       if (filterPostPlugin) {</span>
<a href="#l8.40"></a><span id="l8.40">         // Don't do filters on this message again.</span>
<a href="#l8.41"></a><span id="l8.41">         // (Only set this if we are actually filtering since this is</span>
<a href="#l8.42"></a><span id="l8.42">         // tantamount to a memory leak.)</span>
<a href="#l8.43"></a><span id="l8.43">         MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l8.44"></a><span id="l8.44">                 (&quot;Filters done on this message&quot;));</span>
<a href="#l8.45"></a><span id="l8.45">         OrProcessingFlags(msgKey, nsMsgProcessingFlags::FiltersDone);</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineminus">-        // Lazily create the array.</span>
<a href="#l8.47"></a><span id="l8.47" class="difflineminus">-        if (!mPostBayesMessagesToFilter)</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-          mPostBayesMessagesToFilter = do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineminus">-        mPostBayesMessagesToFilter-&gt;AppendElement(msgHdr);</span>
<a href="#l8.50"></a><span id="l8.50" class="difflineplus">+        mPostBayesMessagesToFilter.AppendElement(msgHdr);</span>
<a href="#l8.51"></a><span id="l8.51">       }</span>
<a href="#l8.52"></a><span id="l8.52">     }</span>
<a href="#l8.53"></a><span id="l8.53">   }</span>
<a href="#l8.54"></a><span id="l8.54"> </span>
<a href="#l8.55"></a><span id="l8.55">   NotifyHdrsNotBeingClassified();</span>
<a href="#l8.56"></a><span id="l8.56">   // If there weren't any new messages, just return.</span>
<a href="#l8.57"></a><span id="l8.57">   if (newMessageKeys.IsEmpty()) return NS_OK;</span>
<a href="#l8.58"></a><span id="l8.58"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -296,17 +296,17 @@ class NS_MSG_BASE nsMsgDBFolder : public</span>
<a href="#l9.4"></a><span id="l9.4"> </span>
<a href="#l9.5"></a><span id="l9.5">   // store of keys that have a processing flag set</span>
<a href="#l9.6"></a><span id="l9.6">   struct {</span>
<a href="#l9.7"></a><span id="l9.7">     uint32_t bit;</span>
<a href="#l9.8"></a><span id="l9.8">     nsMsgKeySetU *keys;</span>
<a href="#l9.9"></a><span id="l9.9">   } mProcessingFlag[nsMsgProcessingFlags::NumberOfFlags];</span>
<a href="#l9.10"></a><span id="l9.10"> </span>
<a href="#l9.11"></a><span id="l9.11">   // list of nsIMsgDBHdrs for messages to process post-bayes</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; mPostBayesMessagesToFilter;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineplus">+  nsTArray&lt;RefPtr&lt;nsIMsgDBHdr&gt;&gt; mPostBayesMessagesToFilter;</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15">   /**</span>
<a href="#l9.16"></a><span id="l9.16">    * The list of message keys that have been classified for msgsClassified</span>
<a href="#l9.17"></a><span id="l9.17">    * batch notification purposes.  We add to this list in OnMessageClassified</span>
<a href="#l9.18"></a><span id="l9.18">    * when we are told about a classified message (a URI is provided), and we</span>
<a href="#l9.19"></a><span id="l9.19">    * notify for the list and clear it when we are told all the messages in</span>
<a href="#l9.20"></a><span id="l9.20">    * the batch were classified (a URI is not provided).</span>
<a href="#l9.21"></a><span id="l9.21">    */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -3560,33 +3560,26 @@ nsresult nsMsgComposeAndSend::FilterSent</span>
<a href="#l10.4"></a><span id="l10.4">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l10.5"></a><span id="l10.5">   nsresult rv = GetExistingFolder(m_folderName, getter_AddRefs(folder));</span>
<a href="#l10.6"></a><span id="l10.6">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8">   nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l10.9"></a><span id="l10.9">   rv = folder-&gt;GetMessageHeader(m_messageKey, getter_AddRefs(msgHdr));</span>
<a href="#l10.10"></a><span id="l10.10">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-  nsCOMPtr&lt;nsIMutableArray&gt; msgArray(</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-      do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-</span>
<a href="#l10.16"></a><span id="l10.16">   nsCOMPtr&lt;nsIMsgFilterService&gt; filterSvc =</span>
<a href="#l10.17"></a><span id="l10.17">       do_GetService(NS_MSGFILTERSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l10.18"></a><span id="l10.18">   if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.19"></a><span id="l10.19"> </span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-  rv = msgArray-&gt;AppendElement(msgHdr);</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-</span>
<a href="#l10.23"></a><span id="l10.23">   nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l10.24"></a><span id="l10.24">   if (mSendProgress) mSendProgress-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l10.25"></a><span id="l10.25"> </span>
<a href="#l10.26"></a><span id="l10.26">   MOZ_LOG(FILTERLOGMODULE, LogLevel::Info,</span>
<a href="#l10.27"></a><span id="l10.27">           (&quot;(Send) Running filters on sent message&quot;));</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-  return filterSvc-&gt;ApplyFilters(nsMsgFilterType::PostOutgoing, msgArray,</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineplus">+  return filterSvc-&gt;ApplyFilters(nsMsgFilterType::PostOutgoing, {&amp;*msgHdr},</span>
<a href="#l10.30"></a><span id="l10.30">                                  folder, msgWindow, this);</span>
<a href="#l10.31"></a><span id="l10.31"> }</span>
<a href="#l10.32"></a><span id="l10.32"> </span>
<a href="#l10.33"></a><span id="l10.33"> NS_IMETHODIMP</span>
<a href="#l10.34"></a><span id="l10.34"> nsMsgComposeAndSend::OnStopOperation(nsresult aStatus) {</span>
<a href="#l10.35"></a><span id="l10.35">   // Set a status message...</span>
<a href="#l10.36"></a><span id="l10.36">   nsString msg;</span>
<a href="#l10.37"></a><span id="l10.37">   if (NS_SUCCEEDED(aStatus)) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/suite/mailnews/content/FilterListDialog.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/suite/mailnews/content/FilterListDialog.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -403,35 +403,32 @@ function runSelectedFilters()</span>
<a href="#l11.4"></a><span id="l11.4">   // if run button has &quot;stop&quot; label, do stop.</span>
<a href="#l11.5"></a><span id="l11.5">   if (gRunFiltersButton.getAttribute(&quot;label&quot;) == gRunFiltersButton.getAttribute(&quot;stoplabel&quot;)) {</span>
<a href="#l11.6"></a><span id="l11.6">     gFilterListMsgWindow.StopUrls();</span>
<a href="#l11.7"></a><span id="l11.7">     return;</span>
<a href="#l11.8"></a><span id="l11.8">   }</span>
<a href="#l11.9"></a><span id="l11.9"> </span>
<a href="#l11.10"></a><span id="l11.10">   var msgFolder = gRunFiltersFolderPicker._folder || gRunFiltersFolderPicker.selectedItem._folder;</span>
<a href="#l11.11"></a><span id="l11.11">   var filterList = MailServices.filters.getTempFilterList(msgFolder);</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-  var folders = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-                  .createInstance(Ci.nsIMutableArray);</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-  folders.appendElement(msgFolder);</span>
<a href="#l11.15"></a><span id="l11.15"> </span>
<a href="#l11.16"></a><span id="l11.16">   // make sure the tmp filter list uses the real filter list log stream</span>
<a href="#l11.17"></a><span id="l11.17">   filterList.logStream = currentFilterList().logStream;</span>
<a href="#l11.18"></a><span id="l11.18">   filterList.loggingEnabled = currentFilterList().loggingEnabled;</span>
<a href="#l11.19"></a><span id="l11.19">   var index = 0, sel = gFilterTree.view.selection;</span>
<a href="#l11.20"></a><span id="l11.20">   for (var i = 0; i &lt; sel.getRangeCount(); i++) {</span>
<a href="#l11.21"></a><span id="l11.21">     var start = {}, end = {};</span>
<a href="#l11.22"></a><span id="l11.22">     sel.getRangeAt(i, start, end);</span>
<a href="#l11.23"></a><span id="l11.23">     for (var j = start.value; j &lt;= end.value; j++) {</span>
<a href="#l11.24"></a><span id="l11.24">       var curFilter = getFilter(j);</span>
<a href="#l11.25"></a><span id="l11.25">       if (curFilter)</span>
<a href="#l11.26"></a><span id="l11.26">         filterList.insertFilterAt(index++, curFilter);</span>
<a href="#l11.27"></a><span id="l11.27">     }</span>
<a href="#l11.28"></a><span id="l11.28">   }</span>
<a href="#l11.29"></a><span id="l11.29"> </span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-  MailServices.filters.applyFiltersToFolders(filterList, folders, gFilterListMsgWindow);</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+  MailServices.filters.applyFiltersToFolders(filterList, [msgFolder], gFilterListMsgWindow);</span>
<a href="#l11.32"></a><span id="l11.32"> }</span>
<a href="#l11.33"></a><span id="l11.33"> </span>
<a href="#l11.34"></a><span id="l11.34"> function moveCurrentFilter(motion)</span>
<a href="#l11.35"></a><span id="l11.35"> {</span>
<a href="#l11.36"></a><span id="l11.36">     var filterList = currentFilterList();</span>
<a href="#l11.37"></a><span id="l11.37">     var filter = currentFilter();</span>
<a href="#l11.38"></a><span id="l11.38">     if (!filterList || !filter)</span>
<a href="#l11.39"></a><span id="l11.39">       return;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/suite/mailnews/content/mailWindowOverlay.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/suite/mailnews/content/mailWindowOverlay.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1155,29 +1155,22 @@ BatchMessageMover.prototype =</span>
<a href="#l12.4"></a><span id="l12.4">     treeView.selection.select(this.messageToSelectAfterWereDone);</span>
<a href="#l12.5"></a><span id="l12.5">     treeView.selectionChanged();</span>
<a href="#l12.6"></a><span id="l12.6">     return;</span>
<a href="#l12.7"></a><span id="l12.7">   },</span>
<a href="#l12.8"></a><span id="l12.8"> </span>
<a href="#l12.9"></a><span id="l12.9">   filterBatch: function()</span>
<a href="#l12.10"></a><span id="l12.10">   {</span>
<a href="#l12.11"></a><span id="l12.11">     let batch = this._currentBatch;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+    // Apply filters to this batch.</span>
<a href="#l12.13"></a><span id="l12.13">     let msgs = batch.slice(6);</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-    let filterArray = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-                        .createInstance(Ci.nsIMutableArray);</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-    for (let message of msgs) {</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-      filterArray.appendElement(message);</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-    }</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-    // Apply filters to this batch.</span>
<a href="#l12.22"></a><span id="l12.22">     let srcFolder = batch[0];</span>
<a href="#l12.23"></a><span id="l12.23">     MailServices.filters.applyFilters(</span>
<a href="#l12.24"></a><span id="l12.24">       Ci.nsMsgFilterType.Archive,</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-      filterArray, srcFolder, msgWindow, this);</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+      msgs, srcFolder, msgWindow, this);</span>
<a href="#l12.27"></a><span id="l12.27">     return; // continues with onStopOperation</span>
<a href="#l12.28"></a><span id="l12.28">   },</span>
<a href="#l12.29"></a><span id="l12.29"> </span>
<a href="#l12.30"></a><span id="l12.30">   onStopOperation: function(aResult)</span>
<a href="#l12.31"></a><span id="l12.31">   {</span>
<a href="#l12.32"></a><span id="l12.32">     if (!Components.isSuccessCode(aResult))</span>
<a href="#l12.33"></a><span id="l12.33">     {</span>
<a href="#l12.34"></a><span id="l12.34">       Cu.reportError(&quot;Archive filter failed: &quot; + aResult);</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineat">@@ -1798,19 +1791,16 @@ function MsgFilters(emailAddress, folder</span>
<a href="#l12.36"></a><span id="l12.36"> }</span>
<a href="#l12.37"></a><span id="l12.37"> </span>
<a href="#l12.38"></a><span id="l12.38"> function MsgApplyFilters()</span>
<a href="#l12.39"></a><span id="l12.39"> {</span>
<a href="#l12.40"></a><span id="l12.40">   var filterService = Cc[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l12.41"></a><span id="l12.41">                         .getService(Ci.nsIMsgFilterService);</span>
<a href="#l12.42"></a><span id="l12.42"> </span>
<a href="#l12.43"></a><span id="l12.43">   var preselectedFolder = GetFirstSelectedMsgFolder();</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineminus">-  var selectedFolders = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineminus">-                          .createInstance(Ci.nsIMutableArray);</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-  selectedFolders.appendElement(preselectedFolder);</span>
<a href="#l12.47"></a><span id="l12.47"> </span>
<a href="#l12.48"></a><span id="l12.48">   var curFilterList = preselectedFolder.getFilterList(msgWindow);</span>
<a href="#l12.49"></a><span id="l12.49">   // create a new filter list and copy over the enabled filters to it.</span>
<a href="#l12.50"></a><span id="l12.50">   // We do this instead of having the filter after the fact code ignore</span>
<a href="#l12.51"></a><span id="l12.51">   // disabled filters because the Filter Dialog filter after the fact</span>
<a href="#l12.52"></a><span id="l12.52">   // code would have to clone filters to allow disabled filters to run,</span>
<a href="#l12.53"></a><span id="l12.53">   // and we don't support cloning filters currently.</span>
<a href="#l12.54"></a><span id="l12.54">   var tempFilterList = filterService.getTempFilterList(preselectedFolder);</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineat">@@ -1825,41 +1815,40 @@ function MsgApplyFilters()</span>
<a href="#l12.56"></a><span id="l12.56">     // only add enabled, UI visibile filters that are in the manual context</span>
<a href="#l12.57"></a><span id="l12.57">     if (curFilter.enabled &amp;&amp; !curFilter.temporary &amp;&amp;</span>
<a href="#l12.58"></a><span id="l12.58">         (curFilter.filterType &amp; Ci.nsMsgFilterType.Manual))</span>
<a href="#l12.59"></a><span id="l12.59">     {</span>
<a href="#l12.60"></a><span id="l12.60">       tempFilterList.insertFilterAt(newFilterIndex, curFilter);</span>
<a href="#l12.61"></a><span id="l12.61">       newFilterIndex++;</span>
<a href="#l12.62"></a><span id="l12.62">     }</span>
<a href="#l12.63"></a><span id="l12.63">   }</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineminus">-  filterService.applyFiltersToFolders(tempFilterList, selectedFolders, msgWindow);</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+  filterService.applyFiltersToFolders(tempFilterList, [preselectedFolder], msgWindow);</span>
<a href="#l12.66"></a><span id="l12.66"> }</span>
<a href="#l12.67"></a><span id="l12.67"> </span>
<a href="#l12.68"></a><span id="l12.68"> function MsgApplyFiltersToSelection()</span>
<a href="#l12.69"></a><span id="l12.69"> {</span>
<a href="#l12.70"></a><span id="l12.70">   var filterService = Cc[&quot;@mozilla.org/messenger/services/filters;1&quot;]</span>
<a href="#l12.71"></a><span id="l12.71">                         .getService(Ci.nsIMsgFilterService);</span>
<a href="#l12.72"></a><span id="l12.72"> </span>
<a href="#l12.73"></a><span id="l12.73">   var folder = gDBView.msgFolder;</span>
<a href="#l12.74"></a><span id="l12.74">   var indices = GetSelectedIndices(gDBView);</span>
<a href="#l12.75"></a><span id="l12.75">   if (indices &amp;&amp; indices.length)</span>
<a href="#l12.76"></a><span id="l12.76">   {</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-    var selectedMsgs = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineminus">-                         .createInstance(Ci.nsIMutableArray);</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+    var selectedMsgs = [];</span>
<a href="#l12.80"></a><span id="l12.80">     for (var i = 0; i &lt; indices.length; i++)</span>
<a href="#l12.81"></a><span id="l12.81">     {</span>
<a href="#l12.82"></a><span id="l12.82">       try</span>
<a href="#l12.83"></a><span id="l12.83">       {</span>
<a href="#l12.84"></a><span id="l12.84">         // Getting the URI will tell us if the item is real or a dummy header</span>
<a href="#l12.85"></a><span id="l12.85">         var uri = gDBView.getURIForViewIndex(indices[i]);</span>
<a href="#l12.86"></a><span id="l12.86">         if (uri)</span>
<a href="#l12.87"></a><span id="l12.87">         {</span>
<a href="#l12.88"></a><span id="l12.88">           var msgHdr = folder.GetMessageHeader(gDBView.getKeyAt(indices[i]));</span>
<a href="#l12.89"></a><span id="l12.89">           if (msgHdr)</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineminus">-            selectedMsgs.appendElement(msgHdr);</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+            selectedMsgs.push(msgHdr);</span>
<a href="#l12.92"></a><span id="l12.92">         }</span>
<a href="#l12.93"></a><span id="l12.93">       } catch (ex) {}</span>
<a href="#l12.94"></a><span id="l12.94">     }</span>
<a href="#l12.95"></a><span id="l12.95"> </span>
<a href="#l12.96"></a><span id="l12.96">     filterService.applyFilters(Ci.nsMsgFilterType.Manual,</span>
<a href="#l12.97"></a><span id="l12.97">                                selectedMsgs,</span>
<a href="#l12.98"></a><span id="l12.98">                                folder,</span>
<a href="#l12.99"></a><span id="l12.99">                                msgWindow);</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

