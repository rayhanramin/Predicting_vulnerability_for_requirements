<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 26353:d34239c5e7a0714bec4bf828481ea0aec0d17840</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ d34239c5e7a0714bec4bf828481ea0aec0d17840" />
<meta property="og:url" content="/comm-central/rev/d34239c5e7a0714bec4bf828481ea0aec0d17840" />
<meta property="og:description" content="Bug 1515877 - Turn on ESLint in mailnews/base; r=aceman" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / d34239c5e7a0714bec4bf828481ea0aec0d17840 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/d34239c5e7a0714bec4bf828481ea0aec0d17840">shortlog</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/d34239c5e7a0714bec4bf828481ea0aec0d17840">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840">files</a> |
changeset |
<a href="/comm-central/raw-rev/d34239c5e7a0714bec4bf828481ea0aec0d17840">raw</a>  | <a href="/comm-central/archive/d34239c5e7a0714bec4bf828481ea0aec0d17840.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/base; r=aceman
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 16 Apr 2019 12:48:24 +1200</td></tr>

<tr>
 <td>changeset 26353</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/d34239c5e7a0714bec4bf828481ea0aec0d17840">d34239c5e7a0714bec4bf828481ea0aec0d17840</a></td>
</tr>



<tr>
<td>parent 26352</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/b86fe81c7f28052942963eb2a87894b8b0917bc7">b86fe81c7f28052942963eb2a87894b8b0917bc7</a>
</td>
</tr>

<tr>
<td>child 26354</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/cbd032bfb56248bd79295ca9a8c33171df38ed08">cbd032bfb56248bd79295ca9a8c33171df38ed08</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=d34239c5e7a0714bec4bf828481ea0aec0d17840">15798</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Tue, 16 Apr 2019 04:15:07 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@ffedede7fa10 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ffedede7fa10b0e3b82b793275de91cd25dd44d3">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=ffedede7fa10b0e3b82b793275de91cd25dd44d3&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ffedede7fa10b0e3b82b793275de91cd25dd44d3&newProject=comm-central&newRevision=d34239c5e7a0714bec4bf828481ea0aec0d17840&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ffedede7fa10b0e3b82b793275de91cd25dd44d3&newProject=comm-central&newRevision=d34239c5e7a0714bec4bf828481ea0aec0d17840&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=ffedede7fa10b0e3b82b793275de91cd25dd44d3&newProject=comm-central&newRevision=d34239c5e7a0714bec4bf828481ea0aec0d17840&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28aceman%29&revcount=50">aceman</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">1515877</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1515877">Bug 1515877</a> - Turn on ESLint in mailnews/base; r=aceman</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/.eslintignore">.eslintignore</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/.eslintignore">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/.eslintignore">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/.eslintignore">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/.eslintignore">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/.eslintignore">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/dateFormat.js">mailnews/base/content/dateFormat.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/dateFormat.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/dateFormat.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/dateFormat.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/dateFormat.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/dateFormat.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/folderProps.js">mailnews/base/content/folderProps.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/folderProps.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/folderProps.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/folderProps.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/folderProps.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/folderProps.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/folderWidgets.xml">mailnews/base/content/folderWidgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/folderWidgets.xml">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/folderWidgets.xml">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/folderWidgets.xml">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/folderWidgets.xml">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/folderWidgets.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/jsTreeView.js">mailnews/base/content/jsTreeView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/jsTreeView.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/jsTreeView.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/jsTreeView.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/jsTreeView.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/jsTreeView.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/junkCommands.js">mailnews/base/content/junkCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/junkCommands.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/junkCommands.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/junkCommands.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/junkCommands.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/junkCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/junkLog.js">mailnews/base/content/junkLog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/junkLog.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/junkLog.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/junkLog.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/junkLog.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/junkLog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/markByDate.js">mailnews/base/content/markByDate.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/markByDate.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/markByDate.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/markByDate.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/markByDate.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/markByDate.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgAccountCentral.js">mailnews/base/content/msgAccountCentral.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgAccountCentral.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgAccountCentral.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgAccountCentral.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgAccountCentral.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgAccountCentral.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgFolderPickerOverlay.js">mailnews/base/content/msgFolderPickerOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgFolderPickerOverlay.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgFolderPickerOverlay.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgFolderPickerOverlay.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgFolderPickerOverlay.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgFolderPickerOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgPrintEngine.js">mailnews/base/content/msgPrintEngine.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgPrintEngine.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgPrintEngine.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgPrintEngine.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgPrintEngine.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgPrintEngine.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgSelectOfflineFolders.js">mailnews/base/content/msgSelectOfflineFolders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgSelectOfflineFolders.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgSelectOfflineFolders.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgSelectOfflineFolders.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgSelectOfflineFolders.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgSelectOfflineFolders.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgSynchronize.js">mailnews/base/content/msgSynchronize.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgSynchronize.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgSynchronize.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgSynchronize.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgSynchronize.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/msgSynchronize.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newFolderDialog.js">mailnews/base/content/newFolderDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newFolderDialog.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newFolderDialog.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newFolderDialog.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newFolderDialog.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newFolderDialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newmailalert.js">mailnews/base/content/newmailalert.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newmailalert.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newmailalert.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newmailalert.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newmailalert.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newmailalert.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newsError.js">mailnews/base/content/newsError.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newsError.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newsError.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newsError.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newsError.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/newsError.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/renameFolderDialog.js">mailnews/base/content/renameFolderDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/renameFolderDialog.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/renameFolderDialog.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/renameFolderDialog.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/renameFolderDialog.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/renameFolderDialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/retention.js">mailnews/base/content/retention.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/retention.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/retention.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/retention.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/retention.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/retention.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/shutdownWindow.js">mailnews/base/content/shutdownWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/shutdownWindow.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/shutdownWindow.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/shutdownWindow.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/shutdownWindow.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/shutdownWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/subscribe.js">mailnews/base/content/subscribe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/subscribe.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/subscribe.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/subscribe.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/subscribe.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/subscribe.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/virtualFolderListEdit.js">mailnews/base/content/virtualFolderListEdit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/virtualFolderListEdit.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/virtualFolderListEdit.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/virtualFolderListEdit.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/virtualFolderListEdit.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/virtualFolderListEdit.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/virtualFolderProperties.js">mailnews/base/content/virtualFolderProperties.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/virtualFolderProperties.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/virtualFolderProperties.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/virtualFolderProperties.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/virtualFolderProperties.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/content/virtualFolderProperties.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountManager.js">mailnews/base/prefs/content/AccountManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountManager.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountManager.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountManager.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountManager.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountManager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountManager.xul">mailnews/base/prefs/content/AccountManager.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountManager.xul">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountManager.xul">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountManager.xul">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountManager.xul">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountManager.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountWizard.js">mailnews/base/prefs/content/AccountWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountWizard.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountWizard.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountWizard.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountWizard.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountWizard.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountWizard.xul">mailnews/base/prefs/content/AccountWizard.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountWizard.xul">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountWizard.xul">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountWizard.xul">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountWizard.xul">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/AccountWizard.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/SmtpServerEdit.js">mailnews/base/prefs/content/SmtpServerEdit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/SmtpServerEdit.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/SmtpServerEdit.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/SmtpServerEdit.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/SmtpServerEdit.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/SmtpServerEdit.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/accountUtils.js">mailnews/base/prefs/content/accountUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/accountUtils.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/accountUtils.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/accountUtils.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/accountUtils.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/accountUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-addressing.js">mailnews/base/prefs/content/am-addressing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-addressing.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-addressing.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-addressing.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-addressing.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-addressing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-copies.js">mailnews/base/prefs/content/am-copies.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-copies.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-copies.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-copies.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-copies.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-copies.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-help.js">mailnews/base/prefs/content/am-help.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-help.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-help.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-help.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-help.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-help.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-identities-list.js">mailnews/base/prefs/content/am-identities-list.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-identities-list.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-identities-list.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-identities-list.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-identities-list.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-identities-list.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-identity-edit.js">mailnews/base/prefs/content/am-identity-edit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-identity-edit.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-identity-edit.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-identity-edit.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-identity-edit.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-identity-edit.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-junk.js">mailnews/base/prefs/content/am-junk.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-junk.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-junk.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-junk.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-junk.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-junk.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-main.js">mailnews/base/prefs/content/am-main.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-main.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-main.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-main.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-main.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-main.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-offline.js">mailnews/base/prefs/content/am-offline.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-offline.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-offline.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-offline.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-offline.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-offline.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-offline.xul">mailnews/base/prefs/content/am-offline.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-offline.xul">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-offline.xul">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-offline.xul">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-offline.xul">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-offline.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-prefs.js">mailnews/base/prefs/content/am-prefs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-prefs.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-prefs.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-prefs.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-prefs.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-prefs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-server-advanced.js">mailnews/base/prefs/content/am-server-advanced.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-server-advanced.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-server-advanced.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-server-advanced.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-server-advanced.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-server-advanced.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-server.js">mailnews/base/prefs/content/am-server.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-server.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-server.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-server.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-server.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-server.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-serverwithnoidentities.js">mailnews/base/prefs/content/am-serverwithnoidentities.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-serverwithnoidentities.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-serverwithnoidentities.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-serverwithnoidentities.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-serverwithnoidentities.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-serverwithnoidentities.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-smtp.js">mailnews/base/prefs/content/am-smtp.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-smtp.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-smtp.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-smtp.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-smtp.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/am-smtp.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/amUtils.js">mailnews/base/prefs/content/amUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/amUtils.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/amUtils.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/amUtils.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/amUtils.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/amUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-accname.js">mailnews/base/prefs/content/aw-accname.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-accname.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-accname.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-accname.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-accname.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-accname.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-accounttype.js">mailnews/base/prefs/content/aw-accounttype.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-accounttype.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-accounttype.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-accounttype.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-accounttype.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-accounttype.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-done.js">mailnews/base/prefs/content/aw-done.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-done.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-done.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-done.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-done.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-done.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-identity.js">mailnews/base/prefs/content/aw-identity.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-identity.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-identity.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-identity.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-identity.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-identity.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-incoming.js">mailnews/base/prefs/content/aw-incoming.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-incoming.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-incoming.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-incoming.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-incoming.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-incoming.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-outgoing.js">mailnews/base/prefs/content/aw-outgoing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-outgoing.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-outgoing.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-outgoing.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-outgoing.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/aw-outgoing.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/converterDialog.js">mailnews/base/prefs/content/converterDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/converterDialog.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/converterDialog.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/converterDialog.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/converterDialog.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/converterDialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/removeAccount.js">mailnews/base/prefs/content/removeAccount.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/removeAccount.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/removeAccount.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/removeAccount.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/removeAccount.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/prefs/content/removeAccount.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/CustomHeaders.js">mailnews/base/search/content/CustomHeaders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/CustomHeaders.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/CustomHeaders.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/CustomHeaders.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/CustomHeaders.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/CustomHeaders.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/FilterEditor.js">mailnews/base/search/content/FilterEditor.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/FilterEditor.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/FilterEditor.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/FilterEditor.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/FilterEditor.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/FilterEditor.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/FilterEditor.xul">mailnews/base/search/content/FilterEditor.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/FilterEditor.xul">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/FilterEditor.xul">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/FilterEditor.xul">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/FilterEditor.xul">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/FilterEditor.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchTerm.js">mailnews/base/search/content/searchTerm.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchTerm.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchTerm.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchTerm.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchTerm.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchTerm.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchWidgets.js">mailnews/base/search/content/searchWidgets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchWidgets.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchWidgets.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchWidgets.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchWidgets.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchWidgets.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchWidgets.xml">mailnews/base/search/content/searchWidgets.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchWidgets.xml">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchWidgets.xml">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchWidgets.xml">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchWidgets.xml">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/searchWidgets.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/viewLog.js">mailnews/base/search/content/viewLog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/viewLog.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/viewLog.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/viewLog.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/viewLog.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/content/viewLog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/src/nsMsgTraitService.js">mailnews/base/search/src/nsMsgTraitService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/src/nsMsgTraitService.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/src/nsMsgTraitService.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/src/nsMsgTraitService.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/src/nsMsgTraitService.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/search/src/nsMsgTraitService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/folderLookupService.js">mailnews/base/src/folderLookupService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/folderLookupService.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/folderLookupService.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/folderLookupService.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/folderLookupService.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/folderLookupService.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/msgAsyncPrompter.js">mailnews/base/src/msgAsyncPrompter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/msgAsyncPrompter.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/msgAsyncPrompter.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/msgAsyncPrompter.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/msgAsyncPrompter.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/msgAsyncPrompter.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/msgOAuth2Module.js">mailnews/base/src/msgOAuth2Module.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/msgOAuth2Module.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/msgOAuth2Module.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/msgOAuth2Module.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/msgOAuth2Module.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/msgOAuth2Module.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/newMailNotificationService.js">mailnews/base/src/newMailNotificationService.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/newMailNotificationService.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/newMailNotificationService.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/newMailNotificationService.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/newMailNotificationService.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/newMailNotificationService.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/nsMailNewsCommandLineHandler.js">mailnews/base/src/nsMailNewsCommandLineHandler.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/nsMailNewsCommandLineHandler.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/nsMailNewsCommandLineHandler.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/nsMailNewsCommandLineHandler.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/nsMailNewsCommandLineHandler.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/nsMailNewsCommandLineHandler.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/virtualFolderWrapper.js">mailnews/base/src/virtualFolderWrapper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/virtualFolderWrapper.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/virtualFolderWrapper.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/virtualFolderWrapper.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/virtualFolderWrapper.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/src/virtualFolderWrapper.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/IOUtils.js">mailnews/base/util/IOUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/IOUtils.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/IOUtils.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/IOUtils.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/IOUtils.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/IOUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/JXON.js">mailnews/base/util/JXON.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/JXON.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/JXON.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/JXON.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/JXON.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/JXON.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/OAuth2.jsm">mailnews/base/util/OAuth2.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/OAuth2.jsm">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/OAuth2.jsm">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/OAuth2.jsm">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/OAuth2.jsm">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/OAuth2.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/OAuth2Providers.jsm">mailnews/base/util/OAuth2Providers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/OAuth2Providers.jsm">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/OAuth2Providers.jsm">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/OAuth2Providers.jsm">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/OAuth2Providers.jsm">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/OAuth2Providers.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/StringBundle.js">mailnews/base/util/StringBundle.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/StringBundle.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/StringBundle.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/StringBundle.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/StringBundle.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/StringBundle.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/converterWorker.js">mailnews/base/util/converterWorker.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/converterWorker.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/converterWorker.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/converterWorker.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/converterWorker.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/converterWorker.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/errUtils.js">mailnews/base/util/errUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/errUtils.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/errUtils.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/errUtils.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/errUtils.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/errUtils.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/folderUtils.jsm">mailnews/base/util/folderUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/folderUtils.jsm">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/folderUtils.jsm">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/folderUtils.jsm">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/folderUtils.jsm">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/folderUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/hostnameUtils.jsm">mailnews/base/util/hostnameUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/hostnameUtils.jsm">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/hostnameUtils.jsm">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/hostnameUtils.jsm">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/hostnameUtils.jsm">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/hostnameUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/iteratorUtils.jsm">mailnews/base/util/iteratorUtils.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/iteratorUtils.jsm">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/iteratorUtils.jsm">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/iteratorUtils.jsm">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/iteratorUtils.jsm">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/iteratorUtils.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/jsTreeSelection.js">mailnews/base/util/jsTreeSelection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/jsTreeSelection.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/jsTreeSelection.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/jsTreeSelection.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/jsTreeSelection.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/jsTreeSelection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/mailnewsMigrator.js">mailnews/base/util/mailnewsMigrator.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/mailnewsMigrator.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/mailnewsMigrator.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/mailnewsMigrator.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/mailnewsMigrator.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/mailnewsMigrator.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/msgDBCacheManager.js">mailnews/base/util/msgDBCacheManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/msgDBCacheManager.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/msgDBCacheManager.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/msgDBCacheManager.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/msgDBCacheManager.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/msgDBCacheManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/templateUtils.js">mailnews/base/util/templateUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/templateUtils.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/templateUtils.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/templateUtils.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/templateUtils.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/templateUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/traceHelper.js">mailnews/base/util/traceHelper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/traceHelper.js">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/traceHelper.js">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/traceHelper.js">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/traceHelper.js">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/base/util/traceHelper.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/jar.mn">mailnews/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/jar.mn">file</a> |
<a href="/comm-central/annotate/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/jar.mn">annotate</a> |
<a href="/comm-central/diff/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/jar.mn">diff</a> |
<a href="/comm-central/comparison/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/jar.mn">comparison</a> |
<a href="/comm-central/log/d34239c5e7a0714bec4bf828481ea0aec0d17840/mailnews/jar.mn">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/.eslintignore</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/.eslintignore</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -57,21 +57,16 @@ editor/ui/dialogs/content/EditorSaveAsCh</span>
<a href="#l1.4"></a><span id="l1.4"> editor/ui/dialogs/content/EdLinkChecker.js</span>
<a href="#l1.5"></a><span id="l1.5"> editor/ui/dialogs/content/EdLinkChecker.xul</span>
<a href="#l1.6"></a><span id="l1.6"> editor/ui/dialogs/content/EdSnapToGrid.js</span>
<a href="#l1.7"></a><span id="l1.7"> editor/ui/dialogs/content/EdSnapToGrid.xul</span>
<a href="#l1.8"></a><span id="l1.8"> editor/ui/texzilla/**</span>
<a href="#l1.9"></a><span id="l1.9"> </span>
<a href="#l1.10"></a><span id="l1.10"> # mailnews exclusions</span>
<a href="#l1.11"></a><span id="l1.11"> mailnews/mailnews.js</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-mailnews/base/content/*</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineminus">-mailnews/base/prefs/*</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineminus">-mailnews/base/search/*</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineminus">-mailnews/base/src/*</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-mailnews/base/util/*</span>
<a href="#l1.17"></a><span id="l1.17"> mailnews/build/*</span>
<a href="#l1.18"></a><span id="l1.18"> mailnews/compose/*</span>
<a href="#l1.19"></a><span id="l1.19"> mailnews/db/*</span>
<a href="#l1.20"></a><span id="l1.20"> mailnews/imap/*</span>
<a href="#l1.21"></a><span id="l1.21"> mailnews/import/*</span>
<a href="#l1.22"></a><span id="l1.22"> mailnews/intl/*</span>
<a href="#l1.23"></a><span id="l1.23"> mailnews/jsaccount/*</span>
<a href="#l1.24"></a><span id="l1.24"> mailnews/mime/*</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/base/content/dateFormat.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/base/content/dateFormat.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -13,146 +13,125 @@ var gSearchDateFormat = 0;</span>
<a href="#l2.4"></a><span id="l2.4"> var gSearchDateSeparator;</span>
<a href="#l2.5"></a><span id="l2.5"> var gSearchDateLeadingZeros;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7"> /**</span>
<a href="#l2.8"></a><span id="l2.8">  * Get the short date format option of the current locale.</span>
<a href="#l2.9"></a><span id="l2.9">  * This supports the common case which the date separator is</span>
<a href="#l2.10"></a><span id="l2.10">  * either '/', '-', '.' and using Christian year.</span>
<a href="#l2.11"></a><span id="l2.11">  */</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-function initLocaleShortDateFormat()</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-{</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+function initLocaleShortDateFormat() {</span>
<a href="#l2.15"></a><span id="l2.15">   try {</span>
<a href="#l2.16"></a><span id="l2.16">     const dateFormatter = new Services.intl.DateTimeFormat(undefined,</span>
<a href="#l2.17"></a><span id="l2.17">       { dateStyle: &quot;short&quot; });</span>
<a href="#l2.18"></a><span id="l2.18">     var aDate = new Date(1999, 11, 1);</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-    var dateString = dateFormatter.format(aDate).replace(/ /g,&quot;&quot;);</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+    var dateString = dateFormatter.format(aDate).replace(/ /g, &quot;&quot;);</span>
<a href="#l2.21"></a><span id="l2.21"> </span>
<a href="#l2.22"></a><span id="l2.22">     // find out the separator</span>
<a href="#l2.23"></a><span id="l2.23">     var possibleSeparators = &quot;/-.&quot;;</span>
<a href="#l2.24"></a><span id="l2.24">     var arrayOfStrings;</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-    for (let i = 0; i &lt; possibleSeparators.length; ++i)</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineminus">-    {</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+    for (let i = 0; i &lt; possibleSeparators.length; ++i) {</span>
<a href="#l2.28"></a><span id="l2.28">       arrayOfStrings = dateString.split(possibleSeparators[i]);</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineminus">-      if (arrayOfStrings.length == 3)</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineminus">-      {</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+      if (arrayOfStrings.length == 3) {</span>
<a href="#l2.32"></a><span id="l2.32">         gSearchDateSeparator = possibleSeparators[i];</span>
<a href="#l2.33"></a><span id="l2.33">         break;</span>
<a href="#l2.34"></a><span id="l2.34">       }</span>
<a href="#l2.35"></a><span id="l2.35">     }</span>
<a href="#l2.36"></a><span id="l2.36"> </span>
<a href="#l2.37"></a><span id="l2.37">     // check the format option</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-    if (arrayOfStrings.length != 3)  // no successful split</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-    {</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+    if (arrayOfStrings.length != 3) { // no successful split</span>
<a href="#l2.41"></a><span id="l2.41">       Cu.reportError(&quot;initLocaleShortDateFormat: could not analyze the date format, defaulting to mm/dd/yyyy&quot;);</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-    }</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-    else</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-    {</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineplus">+    } else {</span>
<a href="#l2.46"></a><span id="l2.46">       // The date will contain a zero if the system settings include leading zeros.</span>
<a href="#l2.47"></a><span id="l2.47">       gSearchDateLeadingZeros = dateString.includes(&quot;0&quot;);</span>
<a href="#l2.48"></a><span id="l2.48"> </span>
<a href="#l2.49"></a><span id="l2.49">       // match 1 as number, since that will match both &quot;1&quot; and &quot;01&quot;</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-      if (arrayOfStrings[0] == 1)</span>
<a href="#l2.51"></a><span id="l2.51" class="difflineminus">-      {</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineplus">+      if (arrayOfStrings[0] == 1) {</span>
<a href="#l2.53"></a><span id="l2.53">         // 01.12.1999 or 01.1999.12</span>
<a href="#l2.54"></a><span id="l2.54">         gSearchDateFormat = arrayOfStrings[1] == &quot;12&quot; ? 5 : 6;</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineminus">-      }</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineminus">-      else if (arrayOfStrings[1] == 1)</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-      {</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineplus">+      } else if (arrayOfStrings[1] == 1) {</span>
<a href="#l2.59"></a><span id="l2.59">         // 12.01.1999 or 1999.01.12</span>
<a href="#l2.60"></a><span id="l2.60">         gSearchDateFormat = arrayOfStrings[0] == &quot;12&quot; ? 3 : 2;</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-      }</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-      else  // implies arrayOfStrings[2] == 1</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-      {</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineplus">+      } else { // implies arrayOfStrings[2] == 1</span>
<a href="#l2.65"></a><span id="l2.65">         // 12.1999.01 or 1999.12.01</span>
<a href="#l2.66"></a><span id="l2.66">         gSearchDateFormat = arrayOfStrings[0] == &quot;12&quot; ? 4 : 1;</span>
<a href="#l2.67"></a><span id="l2.67">       }</span>
<a href="#l2.68"></a><span id="l2.68">     }</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-  }</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-  catch (e)</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-  {</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+  } catch (e) {</span>
<a href="#l2.73"></a><span id="l2.73">     Cu.reportError(&quot;initLocaleShortDateFormat: caught an exception: &quot; + e);</span>
<a href="#l2.74"></a><span id="l2.74">     gSearchDateFormat = 0;</span>
<a href="#l2.75"></a><span id="l2.75">   }</span>
<a href="#l2.76"></a><span id="l2.76"> }</span>
<a href="#l2.77"></a><span id="l2.77"> </span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-function initializeSearchDateFormat()</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-{</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineplus">+function initializeSearchDateFormat() {</span>
<a href="#l2.81"></a><span id="l2.81">   if (gSearchDateFormat &gt; 0)</span>
<a href="#l2.82"></a><span id="l2.82">     return;</span>
<a href="#l2.83"></a><span id="l2.83"> </span>
<a href="#l2.84"></a><span id="l2.84">   // get a search date format option and a separator</span>
<a href="#l2.85"></a><span id="l2.85">   try {</span>
<a href="#l2.86"></a><span id="l2.86">     gSearchDateFormat =</span>
<a href="#l2.87"></a><span id="l2.87">       Services.prefs.getComplexValue(&quot;mailnews.search_date_format&quot;,</span>
<a href="#l2.88"></a><span id="l2.88">                                      Ci.nsIPrefLocalizedString).data;</span>
<a href="#l2.89"></a><span id="l2.89"> </span>
<a href="#l2.90"></a><span id="l2.90">     gSearchDateFormat = parseInt(gSearchDateFormat);</span>
<a href="#l2.91"></a><span id="l2.91"> </span>
<a href="#l2.92"></a><span id="l2.92">     // if the option is 0 then try to use the format of the current locale</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-    if (gSearchDateFormat == 0)</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineplus">+    if (gSearchDateFormat == 0) {</span>
<a href="#l2.95"></a><span id="l2.95">       initLocaleShortDateFormat();</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineminus">-    else</span>
<a href="#l2.97"></a><span id="l2.97" class="difflineminus">-    {</span>
<a href="#l2.98"></a><span id="l2.98" class="difflineplus">+    } else {</span>
<a href="#l2.99"></a><span id="l2.99">       // initialize the search date format based on preferences</span>
<a href="#l2.100"></a><span id="l2.100">       if (gSearchDateFormat &lt; 1 || gSearchDateFormat &gt; 6)</span>
<a href="#l2.101"></a><span id="l2.101">         gSearchDateFormat = 3;</span>
<a href="#l2.102"></a><span id="l2.102"> </span>
<a href="#l2.103"></a><span id="l2.103">       gSearchDateSeparator =</span>
<a href="#l2.104"></a><span id="l2.104">         Services.prefs.getComplexValue(&quot;mailnews.search_date_separator&quot;,</span>
<a href="#l2.105"></a><span id="l2.105">                                        Ci.nsIPrefLocalizedString).data;</span>
<a href="#l2.106"></a><span id="l2.106"> </span>
<a href="#l2.107"></a><span id="l2.107">       gSearchDateLeadingZeros =</span>
<a href="#l2.108"></a><span id="l2.108">         (Services.prefs.getComplexValue(</span>
<a href="#l2.109"></a><span id="l2.109">            &quot;mailnews.search_date_leading_zeros&quot;,</span>
<a href="#l2.110"></a><span id="l2.110">            Ci.nsIPrefLocalizedString).data == &quot;true&quot;);</span>
<a href="#l2.111"></a><span id="l2.111">     }</span>
<a href="#l2.112"></a><span id="l2.112" class="difflineminus">-  }</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-  catch (e)</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-  {</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+  } catch (e) {</span>
<a href="#l2.116"></a><span id="l2.116">     Cu.reportError(&quot;initializeSearchDateFormat: caught an exception: &quot; + e);</span>
<a href="#l2.117"></a><span id="l2.117">     gSearchDateFormat = 0;</span>
<a href="#l2.118"></a><span id="l2.118">   }</span>
<a href="#l2.119"></a><span id="l2.119"> </span>
<a href="#l2.120"></a><span id="l2.120" class="difflineminus">-  if (gSearchDateFormat == 0)</span>
<a href="#l2.121"></a><span id="l2.121" class="difflineminus">-  {</span>
<a href="#l2.122"></a><span id="l2.122" class="difflineplus">+  if (gSearchDateFormat == 0) {</span>
<a href="#l2.123"></a><span id="l2.123">     // Set to mm/dd/yyyy in case we couldn't determine in any way.</span>
<a href="#l2.124"></a><span id="l2.124">     gSearchDateFormat = 3;</span>
<a href="#l2.125"></a><span id="l2.125">     gSearchDateSeparator = &quot;/&quot;;</span>
<a href="#l2.126"></a><span id="l2.126">     gSearchDateLeadingZeros = true;</span>
<a href="#l2.127"></a><span id="l2.127">   }</span>
<a href="#l2.128"></a><span id="l2.128"> }</span>
<a href="#l2.129"></a><span id="l2.129"> </span>
<a href="#l2.130"></a><span id="l2.130" class="difflineminus">-function convertPRTimeToString(tm)</span>
<a href="#l2.131"></a><span id="l2.131" class="difflineminus">-{</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineplus">+function convertPRTimeToString(tm) {</span>
<a href="#l2.133"></a><span id="l2.133">   var time = new Date();</span>
<a href="#l2.134"></a><span id="l2.134">   // PRTime is in microseconds, JavaScript time is in milliseconds</span>
<a href="#l2.135"></a><span id="l2.135">   // so divide by 1000 when converting</span>
<a href="#l2.136"></a><span id="l2.136">   time.setTime(tm / 1000);</span>
<a href="#l2.137"></a><span id="l2.137"> </span>
<a href="#l2.138"></a><span id="l2.138">   return convertDateToString(time);</span>
<a href="#l2.139"></a><span id="l2.139"> }</span>
<a href="#l2.140"></a><span id="l2.140"> </span>
<a href="#l2.141"></a><span id="l2.141" class="difflineminus">-function convertDateToString(time)</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineminus">-{</span>
<a href="#l2.143"></a><span id="l2.143" class="difflineplus">+function convertDateToString(time) {</span>
<a href="#l2.144"></a><span id="l2.144">   initializeSearchDateFormat();</span>
<a href="#l2.145"></a><span id="l2.145"> </span>
<a href="#l2.146"></a><span id="l2.146">   var year = time.getFullYear();</span>
<a href="#l2.147"></a><span id="l2.147">   var month = time.getMonth() + 1;  // since js month is 0-11</span>
<a href="#l2.148"></a><span id="l2.148">   if (gSearchDateLeadingZeros &amp;&amp; month &lt; 10)</span>
<a href="#l2.149"></a><span id="l2.149">     month = &quot;0&quot; + month;</span>
<a href="#l2.150"></a><span id="l2.150">   var date = time.getDate();  // day</span>
<a href="#l2.151"></a><span id="l2.151">   if (gSearchDateLeadingZeros &amp;&amp; date &lt; 10)</span>
<a href="#l2.152"></a><span id="l2.152">     date = &quot;0&quot; + date;</span>
<a href="#l2.153"></a><span id="l2.153"> </span>
<a href="#l2.154"></a><span id="l2.154">   var dateStr;</span>
<a href="#l2.155"></a><span id="l2.155">   var sep = gSearchDateSeparator;</span>
<a href="#l2.156"></a><span id="l2.156"> </span>
<a href="#l2.157"></a><span id="l2.157" class="difflineminus">-  switch (gSearchDateFormat)</span>
<a href="#l2.158"></a><span id="l2.158" class="difflineminus">-  {</span>
<a href="#l2.159"></a><span id="l2.159" class="difflineplus">+  switch (gSearchDateFormat) {</span>
<a href="#l2.160"></a><span id="l2.160">     case 1:</span>
<a href="#l2.161"></a><span id="l2.161">       dateStr = year + sep + month + sep + date;</span>
<a href="#l2.162"></a><span id="l2.162">       break;</span>
<a href="#l2.163"></a><span id="l2.163">     case 2:</span>
<a href="#l2.164"></a><span id="l2.164">       dateStr = year + sep + date + sep + month;</span>
<a href="#l2.165"></a><span id="l2.165">       break;</span>
<a href="#l2.166"></a><span id="l2.166">     case 3:</span>
<a href="#l2.167"></a><span id="l2.167">      dateStr = month + sep + date + sep + year;</span>
<a href="#l2.168"></a><span id="l2.168" class="difflineat">@@ -168,26 +147,24 @@ function convertDateToString(time)</span>
<a href="#l2.169"></a><span id="l2.169">       break;</span>
<a href="#l2.170"></a><span id="l2.170">     default:</span>
<a href="#l2.171"></a><span id="l2.171">       dump(&quot;valid search date format option is 1-6\n&quot;);</span>
<a href="#l2.172"></a><span id="l2.172">   }</span>
<a href="#l2.173"></a><span id="l2.173"> </span>
<a href="#l2.174"></a><span id="l2.174">   return dateStr;</span>
<a href="#l2.175"></a><span id="l2.175"> }</span>
<a href="#l2.176"></a><span id="l2.176"> </span>
<a href="#l2.177"></a><span id="l2.177" class="difflineminus">-function convertStringToPRTime(str)</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-{</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineplus">+function convertStringToPRTime(str) {</span>
<a href="#l2.180"></a><span id="l2.180">   initializeSearchDateFormat();</span>
<a href="#l2.181"></a><span id="l2.181"> </span>
<a href="#l2.182"></a><span id="l2.182">   var arrayOfStrings = str.split(gSearchDateSeparator);</span>
<a href="#l2.183"></a><span id="l2.183">   var year, month, date;</span>
<a href="#l2.184"></a><span id="l2.184"> </span>
<a href="#l2.185"></a><span id="l2.185">   // set year, month, date based on the format option</span>
<a href="#l2.186"></a><span id="l2.186" class="difflineminus">-  switch (gSearchDateFormat)</span>
<a href="#l2.187"></a><span id="l2.187" class="difflineminus">-  {</span>
<a href="#l2.188"></a><span id="l2.188" class="difflineplus">+  switch (gSearchDateFormat) {</span>
<a href="#l2.189"></a><span id="l2.189">     case 1:</span>
<a href="#l2.190"></a><span id="l2.190">       year = arrayOfStrings[0];</span>
<a href="#l2.191"></a><span id="l2.191">       month = arrayOfStrings[1];</span>
<a href="#l2.192"></a><span id="l2.192">       date = arrayOfStrings[2];</span>
<a href="#l2.193"></a><span id="l2.193">       break;</span>
<a href="#l2.194"></a><span id="l2.194">     case 2:</span>
<a href="#l2.195"></a><span id="l2.195">       year = arrayOfStrings[0];</span>
<a href="#l2.196"></a><span id="l2.196">       month = arrayOfStrings[2];</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/content/folderProps.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/content/folderProps.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1,193 +1,174 @@</span>
<a href="#l3.4"></a><span id="l3.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.5"></a><span id="l3.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l3.6"></a><span id="l3.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.7"></a><span id="l3.7"> </span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+/* import-globals-from retention.js */</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+</span>
<a href="#l3.10"></a><span id="l3.10"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l3.11"></a><span id="l3.11"> var {Gloda} = ChromeUtils.import(&quot;resource:///modules/gloda/gloda.js&quot;);</span>
<a href="#l3.12"></a><span id="l3.12"> </span>
<a href="#l3.13"></a><span id="l3.13"> var gMsgFolder;</span>
<a href="#l3.14"></a><span id="l3.14"> var gLockedPref = null;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16"> document.addEventListener(&quot;dialogaccept&quot;, folderPropsOKButton);</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18"> // The folderPropsSink is the class that gets notified of an imap folder's properties</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20"> var gFolderPropsSink = {</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-    setFolderType: function(folderTypeString)</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-    {</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+    setFolderType(folderTypeString) {</span>
<a href="#l3.24"></a><span id="l3.24">       var typeLabel = document.getElementById(&quot;folderType.text&quot;);</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-      if (typeLabel)</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-      {</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-        typeLabel.setAttribute(&quot;value&quot;,folderTypeString);</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+      if (typeLabel) {</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+        typeLabel.setAttribute(&quot;value&quot;, folderTypeString);</span>
<a href="#l3.30"></a><span id="l3.30">       }</span>
<a href="#l3.31"></a><span id="l3.31">       // get the element for the folder type label and set value on it.</span>
<a href="#l3.32"></a><span id="l3.32">     },</span>
<a href="#l3.33"></a><span id="l3.33"> </span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-    setFolderTypeDescription: function(folderDescription)</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-    {</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+    setFolderTypeDescription(folderDescription) {</span>
<a href="#l3.37"></a><span id="l3.37">       var folderTypeLabel = document.getElementById(&quot;folderDescription.text&quot;);</span>
<a href="#l3.38"></a><span id="l3.38">       if (folderTypeLabel)</span>
<a href="#l3.39"></a><span id="l3.39">         folderTypeLabel.setAttribute(&quot;value&quot;, folderDescription);</span>
<a href="#l3.40"></a><span id="l3.40">     },</span>
<a href="#l3.41"></a><span id="l3.41"> </span>
<a href="#l3.42"></a><span id="l3.42" class="difflineminus">-    setFolderPermissions: function(folderPermissions)</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineminus">-    {</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+    setFolderPermissions(folderPermissions) {</span>
<a href="#l3.45"></a><span id="l3.45">       var permissionsLabel = document.getElementById(&quot;folderPermissions.text&quot;);</span>
<a href="#l3.46"></a><span id="l3.46">       var descTextNode =  document.createTextNode(folderPermissions);</span>
<a href="#l3.47"></a><span id="l3.47">       permissionsLabel.appendChild(descTextNode);</span>
<a href="#l3.48"></a><span id="l3.48">     },</span>
<a href="#l3.49"></a><span id="l3.49"> </span>
<a href="#l3.50"></a><span id="l3.50" class="difflineminus">-    serverDoesntSupportACL : function()</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineminus">-    {</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+    serverDoesntSupportACL() {</span>
<a href="#l3.53"></a><span id="l3.53">       var typeLabel = document.getElementById(&quot;folderTypeLabel&quot;);</span>
<a href="#l3.54"></a><span id="l3.54">       if (typeLabel)</span>
<a href="#l3.55"></a><span id="l3.55">         typeLabel.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l3.56"></a><span id="l3.56">       var permissionsLabel = document.getElementById(&quot;permissionsDescLabel&quot;);</span>
<a href="#l3.57"></a><span id="l3.57">       if (permissionsLabel)</span>
<a href="#l3.58"></a><span id="l3.58">         permissionsLabel.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">-</span>
<a href="#l3.60"></a><span id="l3.60">     },</span>
<a href="#l3.61"></a><span id="l3.61"> </span>
<a href="#l3.62"></a><span id="l3.62" class="difflineminus">-    setQuotaStatus : function(folderQuotaStatus)</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineminus">-    {</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+    setQuotaStatus(folderQuotaStatus) {</span>
<a href="#l3.65"></a><span id="l3.65">       var quotaStatusLabel = document.getElementById(&quot;folderQuotaStatus&quot;);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineminus">-      if(quotaStatusLabel)</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+      if (quotaStatusLabel)</span>
<a href="#l3.68"></a><span id="l3.68">         quotaStatusLabel.setAttribute(&quot;value&quot;, folderQuotaStatus);</span>
<a href="#l3.69"></a><span id="l3.69">     },</span>
<a href="#l3.70"></a><span id="l3.70"> </span>
<a href="#l3.71"></a><span id="l3.71" class="difflineminus">-    showQuotaData : function(showData)</span>
<a href="#l3.72"></a><span id="l3.72" class="difflineminus">-    {</span>
<a href="#l3.73"></a><span id="l3.73" class="difflineplus">+    showQuotaData(showData) {</span>
<a href="#l3.74"></a><span id="l3.74">       var quotaStatusLabel = document.getElementById(&quot;folderQuotaStatus&quot;);</span>
<a href="#l3.75"></a><span id="l3.75">       var folderQuotaData = document.getElementById(&quot;folderQuotaData&quot;);</span>
<a href="#l3.76"></a><span id="l3.76"> </span>
<a href="#l3.77"></a><span id="l3.77" class="difflineminus">-      if(quotaStatusLabel &amp;&amp; folderQuotaData)</span>
<a href="#l3.78"></a><span id="l3.78" class="difflineminus">-      {</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+      if (quotaStatusLabel &amp;&amp; folderQuotaData) {</span>
<a href="#l3.80"></a><span id="l3.80">         quotaStatusLabel.hidden = showData;</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-        folderQuotaData.hidden = ! showData;</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+        folderQuotaData.hidden = !showData;</span>
<a href="#l3.83"></a><span id="l3.83">       }</span>
<a href="#l3.84"></a><span id="l3.84">     },</span>
<a href="#l3.85"></a><span id="l3.85"> </span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-    setQuotaData : function(root, usedKB, maxKB)</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineminus">-    {</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+    setQuotaData(root, usedKB, maxKB) {</span>
<a href="#l3.89"></a><span id="l3.89">       var quotaRoot = document.getElementById(&quot;quotaRoot&quot;);</span>
<a href="#l3.90"></a><span id="l3.90">       if (quotaRoot)</span>
<a href="#l3.91"></a><span id="l3.91">         quotaRoot.setAttribute(&quot;value&quot;, '&quot;' + root + '&quot;');</span>
<a href="#l3.92"></a><span id="l3.92"> </span>
<a href="#l3.93"></a><span id="l3.93">       var percentage = (maxKB != 0) ? Math.round(usedKB / maxKB * 100) : 0;</span>
<a href="#l3.94"></a><span id="l3.94"> </span>
<a href="#l3.95"></a><span id="l3.95">       var quotaPercentageBar = document.getElementById(&quot;quotaPercentageBar&quot;);</span>
<a href="#l3.96"></a><span id="l3.96">       if (quotaPercentageBar)</span>
<a href="#l3.97"></a><span id="l3.97">         quotaPercentageBar.setAttribute(&quot;value&quot;, percentage);</span>
<a href="#l3.98"></a><span id="l3.98"> </span>
<a href="#l3.99"></a><span id="l3.99">       var bundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineminus">-      if(bundle)</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineminus">-      {</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+      if (bundle) {</span>
<a href="#l3.103"></a><span id="l3.103">         var usedFreeCaption = bundle.getFormattedString(&quot;quotaUsedFree&quot;, [usedKB, maxKB], 2);</span>
<a href="#l3.104"></a><span id="l3.104">         var quotaCaption = document.getElementById(&quot;quotaUsedFree&quot;);</span>
<a href="#l3.105"></a><span id="l3.105" class="difflineminus">-        if(quotaCaption)</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineplus">+        if (quotaCaption)</span>
<a href="#l3.107"></a><span id="l3.107">           quotaCaption.setAttribute(&quot;value&quot;, usedFreeCaption);</span>
<a href="#l3.108"></a><span id="l3.108"> </span>
<a href="#l3.109"></a><span id="l3.109">         var percentUsedCaption = bundle.getFormattedString(&quot;quotaPercentUsed&quot;, [percentage], 1);</span>
<a href="#l3.110"></a><span id="l3.110">         var percentUsed = document.getElementById(&quot;quotaPercentUsed&quot;);</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-        if(percentUsed)</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineplus">+        if (percentUsed)</span>
<a href="#l3.113"></a><span id="l3.113">           percentUsed.setAttribute(&quot;value&quot;, percentUsedCaption);</span>
<a href="#l3.114"></a><span id="l3.114">       }</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineminus">-    }</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+    },</span>
<a href="#l3.117"></a><span id="l3.117"> </span>
<a href="#l3.118"></a><span id="l3.118"> };</span>
<a href="#l3.119"></a><span id="l3.119"> </span>
<a href="#l3.120"></a><span id="l3.120" class="difflineminus">-function doEnabling()</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineminus">-{</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+function doEnabling() {</span>
<a href="#l3.123"></a><span id="l3.123">   var nameTextbox = document.getElementById(&quot;name&quot;);</span>
<a href="#l3.124"></a><span id="l3.124">   document.documentElement.getButton(&quot;accept&quot;).disabled = !nameTextbox.value;</span>
<a href="#l3.125"></a><span id="l3.125"> }</span>
<a href="#l3.126"></a><span id="l3.126"> </span>
<a href="#l3.127"></a><span id="l3.127" class="difflineminus">-function folderPropsOKButton(event)</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineminus">-{</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineminus">-  if (gMsgFolder)</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineminus">-  {</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineplus">+function folderPropsOKButton(event) {</span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+  if (gMsgFolder) {</span>
<a href="#l3.133"></a><span id="l3.133">     // set charset attributes</span>
<a href="#l3.134"></a><span id="l3.134">     var folderCharsetList = document.getElementById(&quot;folderCharsetList&quot;);</span>
<a href="#l3.135"></a><span id="l3.135"> </span>
<a href="#l3.136"></a><span id="l3.136">     // Log to the Error Console the charset value for the folder</span>
<a href="#l3.137"></a><span id="l3.137">     // if it is unknown to us. Value will be preserved by the menu-item.</span>
<a href="#l3.138"></a><span id="l3.138" class="difflineminus">-    if (folderCharsetList.selectedIndex == -1)</span>
<a href="#l3.139"></a><span id="l3.139" class="difflineminus">-    {</span>
<a href="#l3.140"></a><span id="l3.140" class="difflineplus">+    if (folderCharsetList.selectedIndex == -1) {</span>
<a href="#l3.141"></a><span id="l3.141">       Cu.reportError(&quot;Unknown folder encoding; folder=&quot; +</span>
<a href="#l3.142"></a><span id="l3.142">         gMsgFolder.name + &quot;, charset=&quot; + gMsgFolder.charset);</span>
<a href="#l3.143"></a><span id="l3.143">     }</span>
<a href="#l3.144"></a><span id="l3.144"> </span>
<a href="#l3.145"></a><span id="l3.145">     gMsgFolder.charset = folderCharsetList.getAttribute(&quot;value&quot;);</span>
<a href="#l3.146"></a><span id="l3.146">     gMsgFolder.charsetOverride = document.getElementById(&quot;folderCharsetOverride&quot;)</span>
<a href="#l3.147"></a><span id="l3.147">                                          .checked;</span>
<a href="#l3.148"></a><span id="l3.148"> </span>
<a href="#l3.149"></a><span id="l3.149" class="difflineminus">-    if(document.getElementById(&quot;offline.selectForOfflineFolder&quot;).checked ||</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+    if (document.getElementById(&quot;offline.selectForOfflineFolder&quot;).checked ||</span>
<a href="#l3.151"></a><span id="l3.151">       document.getElementById(&quot;offline.selectForOfflineNewsgroup&quot;).checked)</span>
<a href="#l3.152"></a><span id="l3.152">       gMsgFolder.setFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l3.153"></a><span id="l3.153">     else</span>
<a href="#l3.154"></a><span id="l3.154">       gMsgFolder.clearFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l3.155"></a><span id="l3.155"> </span>
<a href="#l3.156"></a><span id="l3.156" class="difflineminus">-    if(document.getElementById(&quot;folderCheckForNewMessages&quot;).checked)</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+    if (document.getElementById(&quot;folderCheckForNewMessages&quot;).checked)</span>
<a href="#l3.158"></a><span id="l3.158">       gMsgFolder.setFlag(Ci.nsMsgFolderFlags.CheckNew);</span>
<a href="#l3.159"></a><span id="l3.159">     else</span>
<a href="#l3.160"></a><span id="l3.160">       gMsgFolder.clearFlag(Ci.nsMsgFolderFlags.CheckNew);</span>
<a href="#l3.161"></a><span id="l3.161"> </span>
<a href="#l3.162"></a><span id="l3.162">     let glodaCheckbox = document.getElementById(&quot;folderIncludeInGlobalSearch&quot;);</span>
<a href="#l3.163"></a><span id="l3.163">     if (!glodaCheckbox.hidden) {</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineminus">-      if(glodaCheckbox.checked) {</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+      if (glodaCheckbox.checked) {</span>
<a href="#l3.166"></a><span id="l3.166">         // We pass true here so that folders such as trash and junk can still</span>
<a href="#l3.167"></a><span id="l3.167">         // have a priority set.</span>
<a href="#l3.168"></a><span id="l3.168">         Gloda.resetFolderIndexingPriority(gMsgFolder, true);</span>
<a href="#l3.169"></a><span id="l3.169">       } else {</span>
<a href="#l3.170"></a><span id="l3.170">         Gloda.setFolderIndexingPriority(gMsgFolder,</span>
<a href="#l3.171"></a><span id="l3.171">           Gloda.getFolderForFolder(gMsgFolder).kIndexingNeverPriority);</span>
<a href="#l3.172"></a><span id="l3.172">       }</span>
<a href="#l3.173"></a><span id="l3.173">     }</span>
<a href="#l3.174"></a><span id="l3.174"> </span>
<a href="#l3.175"></a><span id="l3.175">     var retentionSettings = saveCommonRetentionSettings(gMsgFolder.retentionSettings);</span>
<a href="#l3.176"></a><span id="l3.176">     retentionSettings.useServerDefaults = document.getElementById(&quot;retention.useDefault&quot;).checked;</span>
<a href="#l3.177"></a><span id="l3.177">     gMsgFolder.retentionSettings = retentionSettings;</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineminus">-</span>
<a href="#l3.179"></a><span id="l3.179">   }</span>
<a href="#l3.180"></a><span id="l3.180"> </span>
<a href="#l3.181"></a><span id="l3.181" class="difflineminus">-  try</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineminus">-  {</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+  try {</span>
<a href="#l3.184"></a><span id="l3.184">     // This throws an exception when an illegal folder name was entered.</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineminus">-    okCallback(document.getElementById(&quot;name&quot;).value, window.arguments[0].name,</span>
<a href="#l3.186"></a><span id="l3.186" class="difflineminus">-               gMsgFolder.URI);</span>
<a href="#l3.187"></a><span id="l3.187" class="difflineminus">-  }</span>
<a href="#l3.188"></a><span id="l3.188" class="difflineminus">-  catch (e)</span>
<a href="#l3.189"></a><span id="l3.189" class="difflineminus">-  {</span>
<a href="#l3.190"></a><span id="l3.190" class="difflineplus">+    top.okCallback(document.getElementById(&quot;name&quot;).value, window.arguments[0].name,</span>
<a href="#l3.191"></a><span id="l3.191" class="difflineplus">+                   gMsgFolder.URI);</span>
<a href="#l3.192"></a><span id="l3.192" class="difflineplus">+  } catch (e) {</span>
<a href="#l3.193"></a><span id="l3.193">     event.preventDefault();</span>
<a href="#l3.194"></a><span id="l3.194">   }</span>
<a href="#l3.195"></a><span id="l3.195"> }</span>
<a href="#l3.196"></a><span id="l3.196"> </span>
<a href="#l3.197"></a><span id="l3.197" class="difflineminus">-function folderPropsOnLoad()</span>
<a href="#l3.198"></a><span id="l3.198" class="difflineminus">-{</span>
<a href="#l3.199"></a><span id="l3.199" class="difflineplus">+function folderPropsOnLoad() {</span>
<a href="#l3.200"></a><span id="l3.200">   // look in arguments[0] for parameters</span>
<a href="#l3.201"></a><span id="l3.201">   if (window.arguments &amp;&amp; window.arguments[0]) {</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-    if ( window.arguments[0].title ) {</span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+    if (window.arguments[0].title) {</span>
<a href="#l3.204"></a><span id="l3.204">       document.title = window.arguments[0].title;</span>
<a href="#l3.205"></a><span id="l3.205">     }</span>
<a href="#l3.206"></a><span id="l3.206" class="difflineminus">-    if ( window.arguments[0].okCallback ) {</span>
<a href="#l3.207"></a><span id="l3.207" class="difflineplus">+    if (window.arguments[0].okCallback) {</span>
<a href="#l3.208"></a><span id="l3.208">       top.okCallback = window.arguments[0].okCallback;</span>
<a href="#l3.209"></a><span id="l3.209">     }</span>
<a href="#l3.210"></a><span id="l3.210">   }</span>
<a href="#l3.211"></a><span id="l3.211"> </span>
<a href="#l3.212"></a><span id="l3.212">   // fill in folder name, based on what they selected in the folder pane</span>
<a href="#l3.213"></a><span id="l3.213">   if (window.arguments[0].folder) {</span>
<a href="#l3.214"></a><span id="l3.214">     gMsgFolder = window.arguments[0].folder;</span>
<a href="#l3.215"></a><span id="l3.215">   } else {</span>
<a href="#l3.216"></a><span id="l3.216">     dump(&quot;passed null for folder, do nothing\n&quot;);</span>
<a href="#l3.217"></a><span id="l3.217">   }</span>
<a href="#l3.218"></a><span id="l3.218"> </span>
<a href="#l3.219"></a><span id="l3.219" class="difflineminus">-  if(window.arguments[0].name)</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineminus">-  {</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+  if (window.arguments[0].name) {</span>
<a href="#l3.222"></a><span id="l3.222">     // Initialize name textbox with the given name and remember this</span>
<a href="#l3.223"></a><span id="l3.223">     // value so we can tell whether the folder needs to be renamed</span>
<a href="#l3.224"></a><span id="l3.224">     // when the dialog is accepted.</span>
<a href="#l3.225"></a><span id="l3.225">     var nameTextbox = document.getElementById(&quot;name&quot;);</span>
<a href="#l3.226"></a><span id="l3.226">     nameTextbox.value = window.arguments[0].name;</span>
<a href="#l3.227"></a><span id="l3.227"> </span>
<a href="#l3.228"></a><span id="l3.228"> //  name.setSelectionRange(0,-1);</span>
<a href="#l3.229"></a><span id="l3.229"> //  name.focusTextField();</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineat">@@ -198,45 +179,42 @@ function folderPropsOnLoad()</span>
<a href="#l3.231"></a><span id="l3.231">   // Do this first, because of gloda we may want to override some of the hidden</span>
<a href="#l3.232"></a><span id="l3.232">   // statuses.</span>
<a href="#l3.233"></a><span id="l3.233">   hideShowControls(serverType);</span>
<a href="#l3.234"></a><span id="l3.234"> </span>
<a href="#l3.235"></a><span id="l3.235">   if (gMsgFolder) {</span>
<a href="#l3.236"></a><span id="l3.236">     // We really need a functioning database, so we'll detect problems</span>
<a href="#l3.237"></a><span id="l3.237">     // and create one if we have to.</span>
<a href="#l3.238"></a><span id="l3.238">     try {</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineminus">-      var db = gMsgFolder.getDatabase(null);</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-    }</span>
<a href="#l3.241"></a><span id="l3.241" class="difflineminus">-    catch (e) {</span>
<a href="#l3.242"></a><span id="l3.242" class="difflineplus">+      gMsgFolder.getDatabase(null);</span>
<a href="#l3.243"></a><span id="l3.243" class="difflineplus">+    } catch (e) {</span>
<a href="#l3.244"></a><span id="l3.244">       gMsgFolder.updateFolder(window.arguments[0].msgWindow);</span>
<a href="#l3.245"></a><span id="l3.245">     }</span>
<a href="#l3.246"></a><span id="l3.246"> </span>
<a href="#l3.247"></a><span id="l3.247">     var locationTextbox = document.getElementById(&quot;location&quot;);</span>
<a href="#l3.248"></a><span id="l3.248"> </span>
<a href="#l3.249"></a><span id="l3.249">     // Decode the displayed mailbox:// URL as it's useful primarily for debugging,</span>
<a href="#l3.250"></a><span id="l3.250">     // whereas imap and news urls are sent around.</span>
<a href="#l3.251"></a><span id="l3.251">     locationTextbox.value = (serverType == &quot;imap&quot; || serverType == &quot;nntp&quot;) ?</span>
<a href="#l3.252"></a><span id="l3.252">         gMsgFolder.folderURL : decodeURI(gMsgFolder.folderURL);</span>
<a href="#l3.253"></a><span id="l3.253"> </span>
<a href="#l3.254"></a><span id="l3.254">     if (gMsgFolder.canRename)</span>
<a href="#l3.255"></a><span id="l3.255">       document.getElementById(&quot;name&quot;).removeAttribute(&quot;readonly&quot;);</span>
<a href="#l3.256"></a><span id="l3.256"> </span>
<a href="#l3.257"></a><span id="l3.257">     if (gMsgFolder.getFlag(Ci.nsMsgFolderFlags.Offline)) {</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineminus">-      if(serverType == &quot;imap&quot; || serverType == &quot;pop3&quot;)</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+      if (serverType == &quot;imap&quot; || serverType == &quot;pop3&quot;)</span>
<a href="#l3.261"></a><span id="l3.261">         document.getElementById(&quot;offline.selectForOfflineFolder&quot;).checked = true;</span>
<a href="#l3.262"></a><span id="l3.262"> </span>
<a href="#l3.263"></a><span id="l3.263" class="difflineminus">-      if(serverType == &quot;nntp&quot;)</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+      if (serverType == &quot;nntp&quot;)</span>
<a href="#l3.265"></a><span id="l3.265">         document.getElementById(&quot;offline.selectForOfflineNewsgroup&quot;).checked = true;</span>
<a href="#l3.266"></a><span id="l3.266" class="difflineminus">-    }</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineminus">-    else {</span>
<a href="#l3.268"></a><span id="l3.268" class="difflineminus">-      if(serverType == &quot;imap&quot; || serverType == &quot;pop3&quot;)</span>
<a href="#l3.269"></a><span id="l3.269" class="difflineplus">+    } else {</span>
<a href="#l3.270"></a><span id="l3.270" class="difflineplus">+      if (serverType == &quot;imap&quot; || serverType == &quot;pop3&quot;)</span>
<a href="#l3.271"></a><span id="l3.271">         document.getElementById(&quot;offline.selectForOfflineFolder&quot;).checked = false;</span>
<a href="#l3.272"></a><span id="l3.272"> </span>
<a href="#l3.273"></a><span id="l3.273" class="difflineminus">-      if(serverType == &quot;nntp&quot;)</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+      if (serverType == &quot;nntp&quot;)</span>
<a href="#l3.275"></a><span id="l3.275">         document.getElementById(&quot;offline.selectForOfflineNewsgroup&quot;).checked = false;</span>
<a href="#l3.276"></a><span id="l3.276">     }</span>
<a href="#l3.277"></a><span id="l3.277"> </span>
<a href="#l3.278"></a><span id="l3.278">     // select the menu item</span>
<a href="#l3.279"></a><span id="l3.279">     var folderCharsetList = document.getElementById(&quot;folderCharsetList&quot;);</span>
<a href="#l3.280"></a><span id="l3.280">     folderCharsetList.value = gMsgFolder.charset;</span>
<a href="#l3.281"></a><span id="l3.281"> </span>
<a href="#l3.282"></a><span id="l3.282">     // set override checkbox</span>
<a href="#l3.283"></a><span id="l3.283" class="difflineat">@@ -256,18 +234,17 @@ function folderPropsOnLoad()</span>
<a href="#l3.284"></a><span id="l3.284">     } else {</span>
<a href="#l3.285"></a><span id="l3.285">       // otherwise, the user can choose whether this file gets indexed</span>
<a href="#l3.286"></a><span id="l3.286">       let glodaFolder = Gloda.getFolderForFolder(gMsgFolder);</span>
<a href="#l3.287"></a><span id="l3.287">       glodaCheckbox.checked =</span>
<a href="#l3.288"></a><span id="l3.288">         glodaFolder.indexingPriority != glodaFolder.kIndexingNeverPriority;</span>
<a href="#l3.289"></a><span id="l3.289">     }</span>
<a href="#l3.290"></a><span id="l3.290">   }</span>
<a href="#l3.291"></a><span id="l3.291"> </span>
<a href="#l3.292"></a><span id="l3.292" class="difflineminus">-  if (serverType == &quot;imap&quot;)</span>
<a href="#l3.293"></a><span id="l3.293" class="difflineminus">-  {</span>
<a href="#l3.294"></a><span id="l3.294" class="difflineplus">+  if (serverType == &quot;imap&quot;) {</span>
<a href="#l3.295"></a><span id="l3.295">     var imapFolder = gMsgFolder.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l3.296"></a><span id="l3.296">     if (imapFolder)</span>
<a href="#l3.297"></a><span id="l3.297">       imapFolder.fillInFolderProps(gFolderPropsSink);</span>
<a href="#l3.298"></a><span id="l3.298">   }</span>
<a href="#l3.299"></a><span id="l3.299"> </span>
<a href="#l3.300"></a><span id="l3.300">   var retentionSettings = gMsgFolder.retentionSettings;</span>
<a href="#l3.301"></a><span id="l3.301">   initCommonRetentionSettings(retentionSettings);</span>
<a href="#l3.302"></a><span id="l3.302">   document.getElementById(&quot;retention.useDefault&quot;).checked = retentionSettings.useServerDefaults;</span>
<a href="#l3.303"></a><span id="l3.303" class="difflineat">@@ -284,32 +261,30 @@ function folderPropsOnLoad()</span>
<a href="#l3.304"></a><span id="l3.304">     document.getElementById(&quot;sizeOnDisk&quot;).value = sizeOnDisk;</span>
<a href="#l3.305"></a><span id="l3.305">   } catch (e) { }</span>
<a href="#l3.306"></a><span id="l3.306"> </span>
<a href="#l3.307"></a><span id="l3.307">   // select the initial tab</span>
<a href="#l3.308"></a><span id="l3.308">   if (window.arguments[0].tabID) {</span>
<a href="#l3.309"></a><span id="l3.309">     try {</span>
<a href="#l3.310"></a><span id="l3.310">       document.getElementById(&quot;folderPropTabBox&quot;).selectedTab =</span>
<a href="#l3.311"></a><span id="l3.311">         document.getElementById(window.arguments[0].tabID);</span>
<a href="#l3.312"></a><span id="l3.312" class="difflineminus">-    }</span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-    catch (ex) {}</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+    } catch (ex) {}</span>
<a href="#l3.315"></a><span id="l3.315">   }</span>
<a href="#l3.316"></a><span id="l3.316">   onCheckKeepMsg();</span>
<a href="#l3.317"></a><span id="l3.317">   onUseDefaultRetentionSettings();</span>
<a href="#l3.318"></a><span id="l3.318"> }</span>
<a href="#l3.319"></a><span id="l3.319"> </span>
<a href="#l3.320"></a><span id="l3.320" class="difflineminus">-function hideShowControls(serverType)</span>
<a href="#l3.321"></a><span id="l3.321" class="difflineminus">-{</span>
<a href="#l3.322"></a><span id="l3.322" class="difflineplus">+function hideShowControls(serverType) {</span>
<a href="#l3.323"></a><span id="l3.323">   let controls = document.querySelectorAll(&quot;[hidefor]&quot;);</span>
<a href="#l3.324"></a><span id="l3.324">   var len = controls.length;</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-  for (var i=0; i&lt;len; i++) {</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineplus">+  for (var i = 0; i &lt; len; i++) {</span>
<a href="#l3.327"></a><span id="l3.327">     var control = controls[i];</span>
<a href="#l3.328"></a><span id="l3.328">     var hideFor = control.getAttribute(&quot;hidefor&quot;);</span>
<a href="#l3.329"></a><span id="l3.329">     if (!hideFor)</span>
<a href="#l3.330"></a><span id="l3.330" class="difflineminus">-      throw &quot;hidefor empty&quot;;</span>
<a href="#l3.331"></a><span id="l3.331" class="difflineplus">+      throw new Error(&quot;hidefor empty&quot;);</span>
<a href="#l3.332"></a><span id="l3.332"> </span>
<a href="#l3.333"></a><span id="l3.333">     // hide unsupported server type</span>
<a href="#l3.334"></a><span id="l3.334">     // adding support for hiding multiple server types using hideFor=&quot;server1,server2&quot;</span>
<a href="#l3.335"></a><span id="l3.335">     var hideForBool = false;</span>
<a href="#l3.336"></a><span id="l3.336">     var hideForTokens = hideFor.split(&quot;,&quot;);</span>
<a href="#l3.337"></a><span id="l3.337">     for (var j = 0; j &lt; hideForTokens.length; j++) {</span>
<a href="#l3.338"></a><span id="l3.338">       if (hideForTokens[j] == serverType) {</span>
<a href="#l3.339"></a><span id="l3.339">         hideForBool = true;</span>
<a href="#l3.340"></a><span id="l3.340" class="difflineat">@@ -318,68 +293,60 @@ function hideShowControls(serverType)</span>
<a href="#l3.341"></a><span id="l3.341">     }</span>
<a href="#l3.342"></a><span id="l3.342">     control.hidden = hideForBool;</span>
<a href="#l3.343"></a><span id="l3.343">   }</span>
<a href="#l3.344"></a><span id="l3.344"> </span>
<a href="#l3.345"></a><span id="l3.345">   // hide the privileges button if the imap folder doesn't have an admin url</span>
<a href="#l3.346"></a><span id="l3.346">   // mabye should leave this hidden by default and only show it in this case instead</span>
<a href="#l3.347"></a><span id="l3.347">   try {</span>
<a href="#l3.348"></a><span id="l3.348">     var imapFolder = gMsgFolder.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l3.349"></a><span id="l3.349" class="difflineminus">-    if (imapFolder)</span>
<a href="#l3.350"></a><span id="l3.350" class="difflineminus">-    {</span>
<a href="#l3.351"></a><span id="l3.351" class="difflineplus">+    if (imapFolder) {</span>
<a href="#l3.352"></a><span id="l3.352">       var privilegesButton = document.getElementById(&quot;imap.FolderPrivileges&quot;);</span>
<a href="#l3.353"></a><span id="l3.353" class="difflineminus">-      if (privilegesButton)</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineminus">-      {</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineplus">+      if (privilegesButton) {</span>
<a href="#l3.356"></a><span id="l3.356">         if (!imapFolder.hasAdminUrl)</span>
<a href="#l3.357"></a><span id="l3.357">           privilegesButton.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l3.358"></a><span id="l3.358">       }</span>
<a href="#l3.359"></a><span id="l3.359">     }</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineminus">-  }</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineminus">-  catch (ex) {}</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+  } catch (ex) {}</span>
<a href="#l3.363"></a><span id="l3.363"> </span>
<a href="#l3.364"></a><span id="l3.364" class="difflineminus">-  if (gMsgFolder)</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineminus">-  {</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineplus">+  if (gMsgFolder) {</span>
<a href="#l3.367"></a><span id="l3.367">     // Hide &quot;check for new mail&quot; checkbox if this is an Inbox.</span>
<a href="#l3.368"></a><span id="l3.368">     if (gMsgFolder.getFlag(Ci.nsMsgFolderFlags.Inbox))</span>
<a href="#l3.369"></a><span id="l3.369">       document.getElementById(&quot;folderCheckForNewMessages&quot;).hidden = true;</span>
<a href="#l3.370"></a><span id="l3.370">     // Retention policy doesn't apply to Drafts/Templates/Outbox.</span>
<a href="#l3.371"></a><span id="l3.371">     if (gMsgFolder.isSpecialFolder(Ci.nsMsgFolderFlags.Drafts |</span>
<a href="#l3.372"></a><span id="l3.372">                                    Ci.nsMsgFolderFlags.Templates |</span>
<a href="#l3.373"></a><span id="l3.373">                                    Ci.nsMsgFolderFlags.Queue, true))</span>
<a href="#l3.374"></a><span id="l3.374">       document.getElementById(&quot;Retention&quot;).hidden = true;</span>
<a href="#l3.375"></a><span id="l3.375">   }</span>
<a href="#l3.376"></a><span id="l3.376"> }</span>
<a href="#l3.377"></a><span id="l3.377"> </span>
<a href="#l3.378"></a><span id="l3.378" class="difflineminus">-function onOfflineFolderDownload()</span>
<a href="#l3.379"></a><span id="l3.379" class="difflineminus">-{</span>
<a href="#l3.380"></a><span id="l3.380" class="difflineplus">+function onOfflineFolderDownload() {</span>
<a href="#l3.381"></a><span id="l3.381">   // we need to create a progress window and pass that in as the second parameter here.</span>
<a href="#l3.382"></a><span id="l3.382">   gMsgFolder.downloadAllForOffline(null, window.arguments[0].msgWindow);</span>
<a href="#l3.383"></a><span id="l3.383"> }</span>
<a href="#l3.384"></a><span id="l3.384"> </span>
<a href="#l3.385"></a><span id="l3.385" class="difflineminus">-function onFolderPrivileges()</span>
<a href="#l3.386"></a><span id="l3.386" class="difflineminus">-{</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineplus">+function onFolderPrivileges() {</span>
<a href="#l3.388"></a><span id="l3.388">   var imapFolder = gMsgFolder.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l3.389"></a><span id="l3.389">   if (imapFolder)</span>
<a href="#l3.390"></a><span id="l3.390">     imapFolder.folderPrivileges(window.arguments[0].msgWindow);</span>
<a href="#l3.391"></a><span id="l3.391">   // let's try closing the modal dialog to see if it fixes the various problems running this url</span>
<a href="#l3.392"></a><span id="l3.392">   window.close();</span>
<a href="#l3.393"></a><span id="l3.393"> }</span>
<a href="#l3.394"></a><span id="l3.394"> </span>
<a href="#l3.395"></a><span id="l3.395"> </span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-function onUseDefaultRetentionSettings()</span>
<a href="#l3.397"></a><span id="l3.397" class="difflineminus">-{</span>
<a href="#l3.398"></a><span id="l3.398" class="difflineplus">+function onUseDefaultRetentionSettings() {</span>
<a href="#l3.399"></a><span id="l3.399">   var useDefault = document.getElementById(&quot;retention.useDefault&quot;).checked;</span>
<a href="#l3.400"></a><span id="l3.400" class="difflineminus">-  document.getElementById('retention.keepMsg').disabled = useDefault;</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineminus">-  document.getElementById('retention.keepNewMsgMinLabel').disabled = useDefault;</span>
<a href="#l3.402"></a><span id="l3.402" class="difflineminus">-  document.getElementById('retention.keepOldMsgMinLabel').disabled = useDefault;</span>
<a href="#l3.403"></a><span id="l3.403" class="difflineplus">+  document.getElementById(&quot;retention.keepMsg&quot;).disabled = useDefault;</span>
<a href="#l3.404"></a><span id="l3.404" class="difflineplus">+  document.getElementById(&quot;retention.keepNewMsgMinLabel&quot;).disabled = useDefault;</span>
<a href="#l3.405"></a><span id="l3.405" class="difflineplus">+  document.getElementById(&quot;retention.keepOldMsgMinLabel&quot;).disabled = useDefault;</span>
<a href="#l3.406"></a><span id="l3.406"> </span>
<a href="#l3.407"></a><span id="l3.407">   var keepMsg = document.getElementById(&quot;retention.keepMsg&quot;).value;</span>
<a href="#l3.408"></a><span id="l3.408">   const nsIMsgRetentionSettings = Ci.nsIMsgRetentionSettings;</span>
<a href="#l3.409"></a><span id="l3.409" class="difflineminus">-  document.getElementById('retention.keepOldMsgMin').disabled =</span>
<a href="#l3.410"></a><span id="l3.410" class="difflineplus">+  document.getElementById(&quot;retention.keepOldMsgMin&quot;).disabled =</span>
<a href="#l3.411"></a><span id="l3.411">     useDefault || (keepMsg != nsIMsgRetentionSettings.nsMsgRetainByAge);</span>
<a href="#l3.412"></a><span id="l3.412" class="difflineminus">-  document.getElementById('retention.keepNewMsgMin').disabled =</span>
<a href="#l3.413"></a><span id="l3.413" class="difflineplus">+  document.getElementById(&quot;retention.keepNewMsgMin&quot;).disabled =</span>
<a href="#l3.414"></a><span id="l3.414">     useDefault || (keepMsg != nsIMsgRetentionSettings.nsMsgRetainByNumHeaders);</span>
<a href="#l3.415"></a><span id="l3.415"> }</span>
<a href="#l3.416"></a><span id="l3.416"> </span>
<a href="#l3.417"></a><span id="l3.417" class="difflineminus">-function RebuildSummaryInformation()</span>
<a href="#l3.418"></a><span id="l3.418" class="difflineminus">-{</span>
<a href="#l3.419"></a><span id="l3.419" class="difflineplus">+function RebuildSummaryInformation() {</span>
<a href="#l3.420"></a><span id="l3.420">   window.arguments[0].rebuildSummaryCallback(gMsgFolder);</span>
<a href="#l3.421"></a><span id="l3.421"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/content/folderWidgets.xml</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/content/folderWidgets.xml</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -102,89 +102,89 @@</span>
<a href="#l4.4"></a><span id="l4.4">          - one of them, append the mode=&quot;foo&quot; attribute to the element.  When</span>
<a href="#l4.5"></a><span id="l4.5">          - building the menu, we will then use this._filters[mode] as a filter</span>
<a href="#l4.6"></a><span id="l4.6">          - function to eliminate folders that should not be shown.</span>
<a href="#l4.7"></a><span id="l4.7">          -</span>
<a href="#l4.8"></a><span id="l4.8">          - Note that extensions should feel free to plug in here!</span>
<a href="#l4.9"></a><span id="l4.9">         --&gt;</span>
<a href="#l4.10"></a><span id="l4.10">       &lt;field name=&quot;_filters&quot;&gt;&lt;![CDATA[({</span>
<a href="#l4.11"></a><span id="l4.11">         // Returns true if messages can be filed in the folder</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-        filing: function filter_filing(aFolder) {</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+        filing(aFolder) {</span>
<a href="#l4.14"></a><span id="l4.14">           if (!aFolder.server.canFileMessagesOnServer)</span>
<a href="#l4.15"></a><span id="l4.15">             return false;</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17">           return (aFolder.canFileMessages || aFolder.hasSubFolders);</span>
<a href="#l4.18"></a><span id="l4.18">         },</span>
<a href="#l4.19"></a><span id="l4.19"> </span>
<a href="#l4.20"></a><span id="l4.20">         // Returns true if we can get mail for this folder. (usually this just</span>
<a href="#l4.21"></a><span id="l4.21">         // means the &quot;root&quot; fake folder)</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineminus">-        getMail: function filter_getMail(aFolder) {</span>
<a href="#l4.23"></a><span id="l4.23" class="difflineplus">+        getMail(aFolder) {</span>
<a href="#l4.24"></a><span id="l4.24">           if (aFolder.isServer &amp;&amp; aFolder.server.type != &quot;none&quot;)</span>
<a href="#l4.25"></a><span id="l4.25">             return true;</span>
<a href="#l4.26"></a><span id="l4.26">           if (aFolder.server.type == &quot;nntp&quot; || aFolder.server.type == &quot;rss&quot;)</span>
<a href="#l4.27"></a><span id="l4.27">             return true;</span>
<a href="#l4.28"></a><span id="l4.28">           return false;</span>
<a href="#l4.29"></a><span id="l4.29">         },</span>
<a href="#l4.30"></a><span id="l4.30"> </span>
<a href="#l4.31"></a><span id="l4.31">         // Returns true if we can add filters to this folder/account</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-        filters: function filter_filter(aFolder) {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+        filters(aFolder) {</span>
<a href="#l4.34"></a><span id="l4.34">           // We can always filter news</span>
<a href="#l4.35"></a><span id="l4.35">           if (aFolder.server.type == &quot;nntp&quot;)</span>
<a href="#l4.36"></a><span id="l4.36">             return true;</span>
<a href="#l4.37"></a><span id="l4.37"> </span>
<a href="#l4.38"></a><span id="l4.38">           return aFolder.server.canHaveFilters;</span>
<a href="#l4.39"></a><span id="l4.39">         },</span>
<a href="#l4.40"></a><span id="l4.40"> </span>
<a href="#l4.41"></a><span id="l4.41" class="difflineminus">-        subscribe: function filter_subscribe(aFolder) {</span>
<a href="#l4.42"></a><span id="l4.42" class="difflineplus">+        subscribe(aFolder) {</span>
<a href="#l4.43"></a><span id="l4.43">           return aFolder.canSubscribe;</span>
<a href="#l4.44"></a><span id="l4.44">         },</span>
<a href="#l4.45"></a><span id="l4.45"> </span>
<a href="#l4.46"></a><span id="l4.46" class="difflineminus">-        newFolder: function filter_newFolder(aFolder) {</span>
<a href="#l4.47"></a><span id="l4.47" class="difflineplus">+        newFolder(aFolder) {</span>
<a href="#l4.48"></a><span id="l4.48">           return aFolder.canCreateSubfolders &amp;&amp;</span>
<a href="#l4.49"></a><span id="l4.49">                  aFolder.server.canCreateFoldersOnServer;</span>
<a href="#l4.50"></a><span id="l4.50">         },</span>
<a href="#l4.51"></a><span id="l4.51"> </span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-        deferred: function filter_defered(aFolder) {</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+        deferred(aFolder) {</span>
<a href="#l4.54"></a><span id="l4.54">           return aFolder.server.canCreateFoldersOnServer &amp;&amp;</span>
<a href="#l4.55"></a><span id="l4.55">                  !aFolder.supportsOffline;</span>
<a href="#l4.56"></a><span id="l4.56">         },</span>
<a href="#l4.57"></a><span id="l4.57"> </span>
<a href="#l4.58"></a><span id="l4.58">         // Folders that are not in a deferred account</span>
<a href="#l4.59"></a><span id="l4.59" class="difflineminus">-        notDeferred: function(aFolder) {</span>
<a href="#l4.60"></a><span id="l4.60" class="difflineplus">+        notDeferred(aFolder) {</span>
<a href="#l4.61"></a><span id="l4.61">           let server = aFolder.server;</span>
<a href="#l4.62"></a><span id="l4.62">           return !(server instanceof Ci.nsIPop3IncomingServer &amp;&amp;</span>
<a href="#l4.63"></a><span id="l4.63">                    server.deferredToAccount);</span>
<a href="#l4.64"></a><span id="l4.64">         },</span>
<a href="#l4.65"></a><span id="l4.65"> </span>
<a href="#l4.66"></a><span id="l4.66">         // Folders that can be searched.</span>
<a href="#l4.67"></a><span id="l4.67" class="difflineminus">-        search: function filter_search(aFolder) {</span>
<a href="#l4.68"></a><span id="l4.68" class="difflineplus">+        search(aFolder) {</span>
<a href="#l4.69"></a><span id="l4.69">           if (!aFolder.server.canSearchMessages ||</span>
<a href="#l4.70"></a><span id="l4.70">               aFolder.getFlag(Ci.nsMsgFolderFlags.Virtual))</span>
<a href="#l4.71"></a><span id="l4.71">             return false;</span>
<a href="#l4.72"></a><span id="l4.72">           return true;</span>
<a href="#l4.73"></a><span id="l4.73">         },</span>
<a href="#l4.74"></a><span id="l4.74"> </span>
<a href="#l4.75"></a><span id="l4.75">         // Folders that can subscribe feeds.</span>
<a href="#l4.76"></a><span id="l4.76" class="difflineminus">-        feeds: function filter_feeds(aFolder) {</span>
<a href="#l4.77"></a><span id="l4.77" class="difflineplus">+        feeds(aFolder) {</span>
<a href="#l4.78"></a><span id="l4.78">           if (aFolder.server.type != &quot;rss&quot; ||</span>
<a href="#l4.79"></a><span id="l4.79">               aFolder.getFlag(Ci.nsMsgFolderFlags.Trash) ||</span>
<a href="#l4.80"></a><span id="l4.80">               aFolder.getFlag(Ci.nsMsgFolderFlags.Virtual))</span>
<a href="#l4.81"></a><span id="l4.81">             return false;</span>
<a href="#l4.82"></a><span id="l4.82">           return true;</span>
<a href="#l4.83"></a><span id="l4.83">         },</span>
<a href="#l4.84"></a><span id="l4.84"> </span>
<a href="#l4.85"></a><span id="l4.85" class="difflineminus">-        junk: function filter_junk(aFolder) {</span>
<a href="#l4.86"></a><span id="l4.86" class="difflineplus">+        junk(aFolder) {</span>
<a href="#l4.87"></a><span id="l4.87">           // Don't show servers (nntp &amp; any others) which do not allow search or filing</span>
<a href="#l4.88"></a><span id="l4.88">           // I don't really understand why canSearchMessages is needed, but it was included in</span>
<a href="#l4.89"></a><span id="l4.89">           // earlier code, so I include it as well.</span>
<a href="#l4.90"></a><span id="l4.90">           if (!aFolder.server.canFileMessagesOnServer || !aFolder.server.canSearchMessages)</span>
<a href="#l4.91"></a><span id="l4.91">             return false;</span>
<a href="#l4.92"></a><span id="l4.92">           // show parents that might have usable subfolders, or usable folders</span>
<a href="#l4.93"></a><span id="l4.93">           return aFolder.hasSubFolders || aFolder.canFileMessages;</span>
<a href="#l4.94"></a><span id="l4.94" class="difflineminus">-        }</span>
<a href="#l4.95"></a><span id="l4.95" class="difflineplus">+        },</span>
<a href="#l4.96"></a><span id="l4.96">       })]]&gt;&lt;/field&gt;</span>
<a href="#l4.97"></a><span id="l4.97"> </span>
<a href="#l4.98"></a><span id="l4.98">       &lt;!--</span>
<a href="#l4.99"></a><span id="l4.99">          - The maximum number of entries in the &quot;Recent&quot; menu</span>
<a href="#l4.100"></a><span id="l4.100">         --&gt;</span>
<a href="#l4.101"></a><span id="l4.101">       &lt;field name=&quot;_MAXRECENT&quot;&gt;15&lt;/field&gt;</span>
<a href="#l4.102"></a><span id="l4.102"> </span>
<a href="#l4.103"></a><span id="l4.103">       &lt;!--</span>
<a href="#l4.104"></a><span id="l4.104" class="difflineat">@@ -195,117 +195,116 @@</span>
<a href="#l4.105"></a><span id="l4.105">       &lt;!--</span>
<a href="#l4.106"></a><span id="l4.106">          - Our listener to let us know when folders change/appear/disappear so</span>
<a href="#l4.107"></a><span id="l4.107">          - we can know to rebuild ourselves.</span>
<a href="#l4.108"></a><span id="l4.108">         --&gt;</span>
<a href="#l4.109"></a><span id="l4.109">       &lt;field name=&quot;_listener&quot;&gt;</span>
<a href="#l4.110"></a><span id="l4.110">           &lt;![CDATA[({</span>
<a href="#l4.111"></a><span id="l4.111">         _menu: this,</span>
<a href="#l4.112"></a><span id="l4.112">         _clearMenu(menu) {</span>
<a href="#l4.113"></a><span id="l4.113" class="difflineminus">-          //xxx I'm not quite sure why this isn't always a function (bug 514445)</span>
<a href="#l4.114"></a><span id="l4.114" class="difflineplus">+          // xxx I'm not quite sure why this isn't always a function (bug 514445)</span>
<a href="#l4.115"></a><span id="l4.115">           if (menu._teardown)</span>
<a href="#l4.116"></a><span id="l4.116">             menu._teardown();</span>
<a href="#l4.117"></a><span id="l4.117">         },</span>
<a href="#l4.118"></a><span id="l4.118" class="difflineminus">-        OnItemAdded: function act_add(aRDFParentItem, aItem) {</span>
<a href="#l4.119"></a><span id="l4.119" class="difflineplus">+        OnItemAdded(aRDFParentItem, aItem) {</span>
<a href="#l4.120"></a><span id="l4.120">           if (!(aItem instanceof Ci.nsIMsgFolder))</span>
<a href="#l4.121"></a><span id="l4.121">             return;</span>
<a href="#l4.122"></a><span id="l4.122">           if (this._filterFunction &amp;&amp; !this._filterFunction(aItem)) {</span>
<a href="#l4.123"></a><span id="l4.123">             return;</span>
<a href="#l4.124"></a><span id="l4.124">           }</span>
<a href="#l4.125"></a><span id="l4.125" class="difflineminus">-          //xxx we can optimize this later</span>
<a href="#l4.126"></a><span id="l4.126" class="difflineplus">+          // xxx we can optimize this later</span>
<a href="#l4.127"></a><span id="l4.127">           this._clearMenu(this._menu);</span>
<a href="#l4.128"></a><span id="l4.128">         },</span>
<a href="#l4.129"></a><span id="l4.129"> </span>
<a href="#l4.130"></a><span id="l4.130" class="difflineminus">-        OnItemRemoved: function act_remove(aRDFParentItem, aItem) {</span>
<a href="#l4.131"></a><span id="l4.131" class="difflineplus">+        OnItemRemoved(aRDFParentItem, aItem) {</span>
<a href="#l4.132"></a><span id="l4.132">           if (!(aItem instanceof Ci.nsIMsgFolder))</span>
<a href="#l4.133"></a><span id="l4.133">             return;</span>
<a href="#l4.134"></a><span id="l4.134">           if (this._filterFunction &amp;&amp; !this._filterFunction(aItem)) {</span>
<a href="#l4.135"></a><span id="l4.135">             return;</span>
<a href="#l4.136"></a><span id="l4.136">           }</span>
<a href="#l4.137"></a><span id="l4.137" class="difflineminus">-          //xxx we can optimize this later</span>
<a href="#l4.138"></a><span id="l4.138" class="difflineplus">+          // xxx we can optimize this later</span>
<a href="#l4.139"></a><span id="l4.139">           this._clearMenu(this._menu);</span>
<a href="#l4.140"></a><span id="l4.140">         },</span>
<a href="#l4.141"></a><span id="l4.141"> </span>
<a href="#l4.142"></a><span id="l4.142" class="difflineminus">-        //xxx I stole this listener list from nsMsgFolderDatasource.cpp, but</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-        //    someone should really document what events are fired when, so that</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineminus">-        //    we make sure we're updating at the right times.</span>
<a href="#l4.145"></a><span id="l4.145" class="difflineminus">-        OnItemPropertyChanged: function(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l4.146"></a><span id="l4.146" class="difflineminus">-        OnItemIntPropertyChanged: function(aItem, aProperty, aOld, aNew) {</span>
<a href="#l4.147"></a><span id="l4.147" class="difflineplus">+        // xxx I stole this listener list from nsMsgFolderDatasource.cpp, but</span>
<a href="#l4.148"></a><span id="l4.148" class="difflineplus">+        //     someone should really document what events are fired when, so that</span>
<a href="#l4.149"></a><span id="l4.149" class="difflineplus">+        //     we make sure we're updating at the right times.</span>
<a href="#l4.150"></a><span id="l4.150" class="difflineplus">+        OnItemPropertyChanged(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l4.151"></a><span id="l4.151" class="difflineplus">+        OnItemIntPropertyChanged(aItem, aProperty, aOld, aNew) {</span>
<a href="#l4.152"></a><span id="l4.152">           if (aItem instanceof Ci.nsIMsgFolder) {</span>
<a href="#l4.153"></a><span id="l4.153">             if (aProperty == &quot;FolderFlag&quot;) {</span>
<a href="#l4.154"></a><span id="l4.154">               if (this._menu.getAttribute(&quot;showFavorites&quot;) != &quot;true&quot; ||</span>
<a href="#l4.155"></a><span id="l4.155">                   !this._menu._initializedSpecials.has(&quot;favorites&quot;))</span>
<a href="#l4.156"></a><span id="l4.156">                 return;</span>
<a href="#l4.157"></a><span id="l4.157"> </span>
<a href="#l4.158"></a><span id="l4.158">               if ((aOld &amp; Ci.nsMsgFolderFlags.Favorite) !=</span>
<a href="#l4.159"></a><span id="l4.159">                  (aNew &amp; Ci.nsMsgFolderFlags.Favorite))</span>
<a href="#l4.160"></a><span id="l4.160">                setTimeout(this._clearMenu, 0, this._menu);</span>
<a href="#l4.161"></a><span id="l4.161">             }</span>
<a href="#l4.162"></a><span id="l4.162">           }</span>
<a href="#l4.163"></a><span id="l4.163">           var child = this._getChildForItem(aItem);</span>
<a href="#l4.164"></a><span id="l4.164">           if (child)</span>
<a href="#l4.165"></a><span id="l4.165">             this._menu._setCssSelectors(child._folder, child);</span>
<a href="#l4.166"></a><span id="l4.166">         },</span>
<a href="#l4.167"></a><span id="l4.167" class="difflineminus">-        OnItemBoolPropertyChanged: function(aItem, aProperty, aOld, aNew) {</span>
<a href="#l4.168"></a><span id="l4.168" class="difflineplus">+        OnItemBoolPropertyChanged(aItem, aProperty, aOld, aNew) {</span>
<a href="#l4.169"></a><span id="l4.169">           var child = this._getChildForItem(aItem);</span>
<a href="#l4.170"></a><span id="l4.170">           if (child)</span>
<a href="#l4.171"></a><span id="l4.171">             this._menu._setCssSelectors(child._folder, child);</span>
<a href="#l4.172"></a><span id="l4.172">         },</span>
<a href="#l4.173"></a><span id="l4.173" class="difflineminus">-        OnItemUnicharPropertyChanged: function(aItem, aProperty, aOld, aNew) {</span>
<a href="#l4.174"></a><span id="l4.174" class="difflineplus">+        OnItemUnicharPropertyChanged(aItem, aProperty, aOld, aNew) {</span>
<a href="#l4.175"></a><span id="l4.175">           var child = this._getChildForItem(aItem);</span>
<a href="#l4.176"></a><span id="l4.176">           if (child)</span>
<a href="#l4.177"></a><span id="l4.177">             this._menu._setCssSelectors(child._folder, child);</span>
<a href="#l4.178"></a><span id="l4.178">         },</span>
<a href="#l4.179"></a><span id="l4.179" class="difflineminus">-        OnItemPropertyFlagChanged: function(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l4.180"></a><span id="l4.180" class="difflineminus">-        OnItemEvent: function(aFolder, aEvent) {</span>
<a href="#l4.181"></a><span id="l4.181" class="difflineplus">+        OnItemPropertyFlagChanged(aItem, aProperty, aOld, aNew) {},</span>
<a href="#l4.182"></a><span id="l4.182" class="difflineplus">+        OnItemEvent(aFolder, aEvent) {</span>
<a href="#l4.183"></a><span id="l4.183">           if (aEvent == &quot;MRMTimeChanged&quot;) {</span>
<a href="#l4.184"></a><span id="l4.184">             if (this._menu.getAttribute(&quot;showRecent&quot;) != &quot;true&quot; ||</span>
<a href="#l4.185"></a><span id="l4.185">                 !this._menu._initializedSpecials.has(&quot;recent&quot;) ||</span>
<a href="#l4.186"></a><span id="l4.186">                 !this._menu.firstChild || !this._menu.firstChild.firstChild)</span>
<a href="#l4.187"></a><span id="l4.187">               return;</span>
<a href="#l4.188"></a><span id="l4.188">             // if this folder is already in the recent menu, return.</span>
<a href="#l4.189"></a><span id="l4.189">             if (this._getChildForItem(aFolder,</span>
<a href="#l4.190"></a><span id="l4.190">                                       this._menu.firstChild.firstChild))</span>
<a href="#l4.191"></a><span id="l4.191">               return;</span>
<a href="#l4.192"></a><span id="l4.192" class="difflineminus">-          }</span>
<a href="#l4.193"></a><span id="l4.193" class="difflineminus">-          // Special casing folder renames here, since they require more work</span>
<a href="#l4.194"></a><span id="l4.194" class="difflineminus">-          // since sort-order may have changed.</span>
<a href="#l4.195"></a><span id="l4.195" class="difflineminus">-          else if (aEvent == &quot;RenameCompleted&quot;) {</span>
<a href="#l4.196"></a><span id="l4.196" class="difflineplus">+          } else if (aEvent == &quot;RenameCompleted&quot;) {</span>
<a href="#l4.197"></a><span id="l4.197" class="difflineplus">+            // Special casing folder renames here, since they require more work</span>
<a href="#l4.198"></a><span id="l4.198" class="difflineplus">+            // since sort-order may have changed.</span>
<a href="#l4.199"></a><span id="l4.199">             if (!this._getChildForItem(aFolder))</span>
<a href="#l4.200"></a><span id="l4.200">               return;</span>
<a href="#l4.201"></a><span id="l4.201" class="difflineplus">+          } else {</span>
<a href="#l4.202"></a><span id="l4.202" class="difflineplus">+            return;</span>
<a href="#l4.203"></a><span id="l4.203">           }</span>
<a href="#l4.204"></a><span id="l4.204" class="difflineminus">-          else</span>
<a href="#l4.205"></a><span id="l4.205" class="difflineminus">-            return;</span>
<a href="#l4.206"></a><span id="l4.206">           // folder renamed, or new recent folder, so rebuild.</span>
<a href="#l4.207"></a><span id="l4.207">           setTimeout(this._clearMenu, 0, this._menu);</span>
<a href="#l4.208"></a><span id="l4.208">         },</span>
<a href="#l4.209"></a><span id="l4.209"> </span>
<a href="#l4.210"></a><span id="l4.210">         /**</span>
<a href="#l4.211"></a><span id="l4.211">          * Helper function to check and see whether we have a menuitem for this</span>
<a href="#l4.212"></a><span id="l4.212">          * particular nsIMsgFolder</span>
<a href="#l4.213"></a><span id="l4.213">          *</span>
<a href="#l4.214"></a><span id="l4.214">          * @param aItem  the nsIMsgFolder to check</span>
<a href="#l4.215"></a><span id="l4.215">          * @param aMenu  (optional) menu to look in, defaults to this._menu.</span>
<a href="#l4.216"></a><span id="l4.216">          * @returns      null if no child for that folder exists, otherwise the</span>
<a href="#l4.217"></a><span id="l4.217">          *               menuitem for that child</span>
<a href="#l4.218"></a><span id="l4.218">          */</span>
<a href="#l4.219"></a><span id="l4.219" class="difflineminus">-        _getChildForItem: function act__itemIsChild(aItem, aMenu) {</span>
<a href="#l4.220"></a><span id="l4.220" class="difflineplus">+        _getChildForItem(aItem, aMenu) {</span>
<a href="#l4.221"></a><span id="l4.221">           aMenu = aMenu || this._menu;</span>
<a href="#l4.222"></a><span id="l4.222">           if (!aMenu || !aMenu.hasChildNodes())</span>
<a href="#l4.223"></a><span id="l4.223">             return null;</span>
<a href="#l4.224"></a><span id="l4.224"> </span>
<a href="#l4.225"></a><span id="l4.225">            if (!(aItem instanceof Ci.nsIMsgFolder))</span>
<a href="#l4.226"></a><span id="l4.226">              return null;</span>
<a href="#l4.227"></a><span id="l4.227">            for (let i = 0; i &lt; aMenu.childNodes.length; i++) {</span>
<a href="#l4.228"></a><span id="l4.228">              let folder = aMenu.childNodes[i]._folder;</span>
<a href="#l4.229"></a><span id="l4.229">              if (folder &amp;&amp; folder.URI == aItem.URI)</span>
<a href="#l4.230"></a><span id="l4.230">                return aMenu.childNodes[i];</span>
<a href="#l4.231"></a><span id="l4.231">            }</span>
<a href="#l4.232"></a><span id="l4.232">            return null;</span>
<a href="#l4.233"></a><span id="l4.233" class="difflineminus">-        }</span>
<a href="#l4.234"></a><span id="l4.234" class="difflineplus">+        },</span>
<a href="#l4.235"></a><span id="l4.235">       })]]&gt;&lt;/field&gt;</span>
<a href="#l4.236"></a><span id="l4.236"> </span>
<a href="#l4.237"></a><span id="l4.237">        &lt;!--</span>
<a href="#l4.238"></a><span id="l4.238">          - True if we have already built our menu-items and are now just</span>
<a href="#l4.239"></a><span id="l4.239">          - listening for changes.</span>
<a href="#l4.240"></a><span id="l4.240">          --&gt;</span>
<a href="#l4.241"></a><span id="l4.241">       &lt;field name=&quot;_initialized&quot;&gt;false&lt;/field&gt;</span>
<a href="#l4.242"></a><span id="l4.242"> </span>
<a href="#l4.243"></a><span id="l4.243" class="difflineat">@@ -382,17 +381,18 @@</span>
<a href="#l4.244"></a><span id="l4.244">             this._listener._filterFunction = filterFunction;</span>
<a href="#l4.245"></a><span id="l4.245">           } else {</span>
<a href="#l4.246"></a><span id="l4.246">             folders = aFolders;</span>
<a href="#l4.247"></a><span id="l4.247">             this._listener._filterFunction = function(folder) { return true; };</span>
<a href="#l4.248"></a><span id="l4.248">           }</span>
<a href="#l4.249"></a><span id="l4.249"> </span>
<a href="#l4.250"></a><span id="l4.250">           if (excludeServers.length &gt; 0) {</span>
<a href="#l4.251"></a><span id="l4.251">             folders = folders.filter(function(aFolder) {</span>
<a href="#l4.252"></a><span id="l4.252" class="difflineminus">-              return !(excludeServers.indexOf(aFolder.server.key) != -1); });</span>
<a href="#l4.253"></a><span id="l4.253" class="difflineplus">+              return !excludeServers.includes(aFolder.server.key);</span>
<a href="#l4.254"></a><span id="l4.254" class="difflineplus">+            });</span>
<a href="#l4.255"></a><span id="l4.255">           }</span>
<a href="#l4.256"></a><span id="l4.256"> </span>
<a href="#l4.257"></a><span id="l4.257">           /* This code block will do the following: Add a menu item that refers</span>
<a href="#l4.258"></a><span id="l4.258">              back to the parent folder when there is a showFileHereLabel</span>
<a href="#l4.259"></a><span id="l4.259">              attribute or no mode attribute. However the code won't add such a</span>
<a href="#l4.260"></a><span id="l4.260">              menu item if one of the following conditions is met:</span>
<a href="#l4.261"></a><span id="l4.261">              (*) There is no parent folder</span>
<a href="#l4.262"></a><span id="l4.262">              (*) Folder is server and showAccountsFileHere is explicitly false</span>
<a href="#l4.263"></a><span id="l4.263" class="difflineat">@@ -424,17 +424,17 @@</span>
<a href="#l4.264"></a><span id="l4.264">               }</span>
<a href="#l4.265"></a><span id="l4.265">               // Eww. have to support some legacy code here...</span>
<a href="#l4.266"></a><span id="l4.266">               menuitem.setAttribute(&quot;id&quot;, this._parentFolder.URI);</span>
<a href="#l4.267"></a><span id="l4.267">               this.appendChild(menuitem);</span>
<a href="#l4.268"></a><span id="l4.268"> </span>
<a href="#l4.269"></a><span id="l4.269">               if (this._parentFolder.noSelect)</span>
<a href="#l4.270"></a><span id="l4.270">                 menuitem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l4.271"></a><span id="l4.271"> </span>
<a href="#l4.272"></a><span id="l4.272" class="difflineminus">-              var sep= document.createElement(&quot;menuseparator&quot;);</span>
<a href="#l4.273"></a><span id="l4.273" class="difflineplus">+              let sep = document.createElement(&quot;menuseparator&quot;);</span>
<a href="#l4.274"></a><span id="l4.274">               sep.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.275"></a><span id="l4.275">               this.appendChild(sep);</span>
<a href="#l4.276"></a><span id="l4.276">             }</span>
<a href="#l4.277"></a><span id="l4.277">           }</span>
<a href="#l4.278"></a><span id="l4.278"> </span>
<a href="#l4.279"></a><span id="l4.279">           let globalInboxFolder = null;</span>
<a href="#l4.280"></a><span id="l4.280">           // See if this is the toplevel menu (usually with accounts).</span>
<a href="#l4.281"></a><span id="l4.281">           if (!this._parentFolder) {</span>
<a href="#l4.282"></a><span id="l4.282" class="difflineat">@@ -468,32 +468,30 @@</span>
<a href="#l4.283"></a><span id="l4.283">             // If we're the root of the folder hierarchy, then we actually don't</span>
<a href="#l4.284"></a><span id="l4.284">             // want to sort the folders, but rather the accounts to which the</span>
<a href="#l4.285"></a><span id="l4.285">             // folders belong.  Since that sorting was already done, we don't need</span>
<a href="#l4.286"></a><span id="l4.286">             // to do anything for that case here.</span>
<a href="#l4.287"></a><span id="l4.287">           } else {</span>
<a href="#l4.288"></a><span id="l4.288">             // Sorts the list of folders. We give first priority to the sortKey</span>
<a href="#l4.289"></a><span id="l4.289">             // property if it is available, otherwise a case-insensitive</span>
<a href="#l4.290"></a><span id="l4.290">             // comparison of names.</span>
<a href="#l4.291"></a><span id="l4.291" class="difflineminus">-            folders = folders.sort(function nameCompare(a, b) {</span>
<a href="#l4.292"></a><span id="l4.292" class="difflineminus">-              return a.compareSortKeys(b);</span>
<a href="#l4.293"></a><span id="l4.293" class="difflineminus">-            });</span>
<a href="#l4.294"></a><span id="l4.294" class="difflineplus">+            folders = folders.sort((a, b) =&gt; a.compareSortKeys(b));</span>
<a href="#l4.295"></a><span id="l4.295">           }</span>
<a href="#l4.296"></a><span id="l4.296"> </span>
<a href="#l4.297"></a><span id="l4.297">           /* In some cases, the user wants to have a list of subfolders for only</span>
<a href="#l4.298"></a><span id="l4.298">            * some account types (or maybe all of them). So we use this to</span>
<a href="#l4.299"></a><span id="l4.299">            * determine what the user wanted.</span>
<a href="#l4.300"></a><span id="l4.300">            */</span>
<a href="#l4.301"></a><span id="l4.301">            var shouldExpand;</span>
<a href="#l4.302"></a><span id="l4.302">            var labels = null;</span>
<a href="#l4.303"></a><span id="l4.303">            if (this.getAttribute(&quot;expandFolders&quot;) == &quot;true&quot; ||</span>
<a href="#l4.304"></a><span id="l4.304">                !this.hasAttribute(&quot;expandFolders&quot;)) {</span>
<a href="#l4.305"></a><span id="l4.305" class="difflineminus">-             shouldExpand = function (e) { return true; };</span>
<a href="#l4.306"></a><span id="l4.306" class="difflineplus">+             shouldExpand = () =&gt; true;</span>
<a href="#l4.307"></a><span id="l4.307">            } else if (this.getAttribute(&quot;expandFolders&quot;) == &quot;false&quot;) {</span>
<a href="#l4.308"></a><span id="l4.308" class="difflineminus">-             shouldExpand = function (e) { return false; };</span>
<a href="#l4.309"></a><span id="l4.309" class="difflineplus">+             shouldExpand = () =&gt; false;</span>
<a href="#l4.310"></a><span id="l4.310">            } else {</span>
<a href="#l4.311"></a><span id="l4.311">              /* We want a subfolder list for only some servers. We also may need</span>
<a href="#l4.312"></a><span id="l4.312">               * to create headers to select the servers. If so, then headlabels</span>
<a href="#l4.313"></a><span id="l4.313">               * is a comma-delimited list of labels corresponding to the server</span>
<a href="#l4.314"></a><span id="l4.314">               * types specified in expandFolders.</span>
<a href="#l4.315"></a><span id="l4.315">               */</span>
<a href="#l4.316"></a><span id="l4.316">              var types = this.getAttribute(&quot;expandFolders&quot;).split(/ *, */);</span>
<a href="#l4.317"></a><span id="l4.317">              // Set the labels. labels[type] = label</span>
<a href="#l4.318"></a><span id="l4.318" class="difflineat">@@ -502,17 +500,17 @@</span>
<a href="#l4.319"></a><span id="l4.319">                labels = {};</span>
<a href="#l4.320"></a><span id="l4.320">                // If the length isn't equal, don't give them any of the labels,</span>
<a href="#l4.321"></a><span id="l4.321">                // since any combination will probably be wrong.</span>
<a href="#l4.322"></a><span id="l4.322">                if (labelNames.length == types.length) {</span>
<a href="#l4.323"></a><span id="l4.323">                  for (var index in types)</span>
<a href="#l4.324"></a><span id="l4.324">                    labels[types[index]] = labelNames[index];</span>
<a href="#l4.325"></a><span id="l4.325">                }</span>
<a href="#l4.326"></a><span id="l4.326">              }</span>
<a href="#l4.327"></a><span id="l4.327" class="difflineminus">-             shouldExpand = function (e) { return types.indexOf(e) != -1; };</span>
<a href="#l4.328"></a><span id="l4.328" class="difflineplus">+             shouldExpand = (e) =&gt; types.includes(e);</span>
<a href="#l4.329"></a><span id="l4.329">            }</span>
<a href="#l4.330"></a><span id="l4.330"> </span>
<a href="#l4.331"></a><span id="l4.331">           // We need to call this, or hasSubFolders will always return false.</span>
<a href="#l4.332"></a><span id="l4.332">           // Remove this workaround when Bug 502900 is fixed.</span>
<a href="#l4.333"></a><span id="l4.333">           this.MailUtils.discoverFolders();</span>
<a href="#l4.334"></a><span id="l4.334">           this._serversOnly = true;</span>
<a href="#l4.335"></a><span id="l4.335"> </span>
<a href="#l4.336"></a><span id="l4.336">           for (let folder of folders) {</span>
<a href="#l4.337"></a><span id="l4.337" class="difflineat">@@ -526,18 +524,18 @@</span>
<a href="#l4.338"></a><span id="l4.338">               node = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l4.339"></a><span id="l4.339">               // Grumble, grumble, legacy code support</span>
<a href="#l4.340"></a><span id="l4.340">               node.setAttribute(&quot;id&quot;, folder.URI);</span>
<a href="#l4.341"></a><span id="l4.341">               node.setAttribute(&quot;class&quot;, &quot;folderMenuItem menuitem-iconic&quot;);</span>
<a href="#l4.342"></a><span id="l4.342">               node.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.343"></a><span id="l4.343">               this.appendChild(node);</span>
<a href="#l4.344"></a><span id="l4.344">             } else {</span>
<a href="#l4.345"></a><span id="l4.345">               this._serversOnly = false;</span>
<a href="#l4.346"></a><span id="l4.346" class="difflineminus">-              //xxx this is slightly problematic in that we haven't confirmed</span>
<a href="#l4.347"></a><span id="l4.347" class="difflineminus">-              //    whether any of the subfolders will pass the filter</span>
<a href="#l4.348"></a><span id="l4.348" class="difflineplus">+              // xxx this is slightly problematic in that we haven't confirmed</span>
<a href="#l4.349"></a><span id="l4.349" class="difflineplus">+              //     whether any of the subfolders will pass the filter</span>
<a href="#l4.350"></a><span id="l4.350">               node = document.createElement(&quot;menu&quot;);</span>
<a href="#l4.351"></a><span id="l4.351">               node.setAttribute(&quot;class&quot;, &quot;folderMenuItem menu-iconic&quot;);</span>
<a href="#l4.352"></a><span id="l4.352">               node.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.353"></a><span id="l4.353">               this.appendChild(node);</span>
<a href="#l4.354"></a><span id="l4.354"> </span>
<a href="#l4.355"></a><span id="l4.355">               // Create the submenu</span>
<a href="#l4.356"></a><span id="l4.356">               // (We must use cloneNode here because on OS X the native menu</span>
<a href="#l4.357"></a><span id="l4.357">               // functionality and very sad limitations of XBL1 cause the bindings</span>
<a href="#l4.358"></a><span id="l4.358" class="difflineat">@@ -565,26 +563,26 @@</span>
<a href="#l4.359"></a><span id="l4.359"> </span>
<a href="#l4.360"></a><span id="l4.360">               // If there are labels, add the labels now</span>
<a href="#l4.361"></a><span id="l4.361">               if (labels) {</span>
<a href="#l4.362"></a><span id="l4.362">                 var serverNode = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l4.363"></a><span id="l4.363">                 serverNode.setAttribute(&quot;label&quot;, labels[folder.server.type]);</span>
<a href="#l4.364"></a><span id="l4.364">                 serverNode._folder = folder;</span>
<a href="#l4.365"></a><span id="l4.365">                 serverNode.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.366"></a><span id="l4.366">                 popup.appendChild(serverNode);</span>
<a href="#l4.367"></a><span id="l4.367" class="difflineminus">-                var sep = document.createElement(&quot;menuseparator&quot;);</span>
<a href="#l4.368"></a><span id="l4.368" class="difflineplus">+                let sep = document.createElement(&quot;menuseparator&quot;);</span>
<a href="#l4.369"></a><span id="l4.369">                 sep.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.370"></a><span id="l4.370">                 popup.appendChild(sep);</span>
<a href="#l4.371"></a><span id="l4.371">               }</span>
<a href="#l4.372"></a><span id="l4.372"> </span>
<a href="#l4.373"></a><span id="l4.373">               popup.setAttribute(&quot;generated&quot;, &quot;true&quot;);</span>
<a href="#l4.374"></a><span id="l4.374">               node.appendChild(popup);</span>
<a href="#l4.375"></a><span id="l4.375">             }</span>
<a href="#l4.376"></a><span id="l4.376"> </span>
<a href="#l4.377"></a><span id="l4.377" class="difflineminus">-            if (disableServers.indexOf(folder.server.key) != -1)</span>
<a href="#l4.378"></a><span id="l4.378" class="difflineplus">+            if (disableServers.includes(folder.server.key))</span>
<a href="#l4.379"></a><span id="l4.379">               node.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l4.380"></a><span id="l4.380"> </span>
<a href="#l4.381"></a><span id="l4.381">             node._folder = folder;</span>
<a href="#l4.382"></a><span id="l4.382">             let label = &quot;&quot;;</span>
<a href="#l4.383"></a><span id="l4.383">             if (mode == &quot;deferred&quot; &amp;&amp; folder.isServer &amp;&amp;</span>
<a href="#l4.384"></a><span id="l4.384">                 folder.server.rootFolder == globalInboxFolder) {</span>
<a href="#l4.385"></a><span id="l4.385">               label = this._stringBundle.get(&quot;globalInbox&quot;, [folder.prettyName]);</span>
<a href="#l4.386"></a><span id="l4.386">             } else {</span>
<a href="#l4.387"></a><span id="l4.387" class="difflineat">@@ -653,18 +651,22 @@</span>
<a href="#l4.388"></a><span id="l4.388">               break;</span>
<a href="#l4.389"></a><span id="l4.389">             case &quot;favorites&quot;:</span>
<a href="#l4.390"></a><span id="l4.390">               specialFolders = specialFolders.filter(folder =&gt; folder.getFlag(Ci.nsMsgFolderFlags.Favorite));</span>
<a href="#l4.391"></a><span id="l4.391">               break;</span>
<a href="#l4.392"></a><span id="l4.392">           }</span>
<a href="#l4.393"></a><span id="l4.393"> </span>
<a href="#l4.394"></a><span id="l4.394">           // Cache the pretty names so that they do not need to be fetched</span>
<a href="#l4.395"></a><span id="l4.395">           // _MAXRECENT^2 times later.</span>
<a href="#l4.396"></a><span id="l4.396" class="difflineminus">-          let specialFoldersMap = specialFolders.map(</span>
<a href="#l4.397"></a><span id="l4.397" class="difflineminus">-            function (f) { return { folder: f, name: f.prettyName } });</span>
<a href="#l4.398"></a><span id="l4.398" class="difflineplus">+          let specialFoldersMap = specialFolders.map(function(f) {</span>
<a href="#l4.399"></a><span id="l4.399" class="difflineplus">+            return {</span>
<a href="#l4.400"></a><span id="l4.400" class="difflineplus">+              folder: f,</span>
<a href="#l4.401"></a><span id="l4.401" class="difflineplus">+              name: f.prettyName,</span>
<a href="#l4.402"></a><span id="l4.402" class="difflineplus">+            };</span>
<a href="#l4.403"></a><span id="l4.403" class="difflineplus">+          });</span>
<a href="#l4.404"></a><span id="l4.404"> </span>
<a href="#l4.405"></a><span id="l4.405">           // Because we're scanning across multiple accounts, we can end up with</span>
<a href="#l4.406"></a><span id="l4.406">           // several folders with the same name. Find those dupes.</span>
<a href="#l4.407"></a><span id="l4.407">           let dupeNames = new Set();</span>
<a href="#l4.408"></a><span id="l4.408">           for (let i = 0; i &lt; specialFoldersMap.length; i++) {</span>
<a href="#l4.409"></a><span id="l4.409">             for (let j = i + 1; j &lt; specialFoldersMap.length; j++) {</span>
<a href="#l4.410"></a><span id="l4.410">               if (specialFoldersMap[i].name == specialFoldersMap[j].name)</span>
<a href="#l4.411"></a><span id="l4.411">                 dupeNames.add(specialFoldersMap[i].name);</span>
<a href="#l4.412"></a><span id="l4.412" class="difflineat">@@ -732,18 +734,17 @@</span>
<a href="#l4.413"></a><span id="l4.413">               aMenuNode.setAttribute(&quot;BiffState&quot;, state);</span>
<a href="#l4.414"></a><span id="l4.414">               break;</span>
<a href="#l4.415"></a><span id="l4.415">             }</span>
<a href="#l4.416"></a><span id="l4.416">           }</span>
<a href="#l4.417"></a><span id="l4.417"> </span>
<a href="#l4.418"></a><span id="l4.418">           aMenuNode.setAttribute(&quot;IsServer&quot;, aFolder.isServer);</span>
<a href="#l4.419"></a><span id="l4.419">           aMenuNode.setAttribute(&quot;IsSecure&quot;, aFolder.server.isSecure);</span>
<a href="#l4.420"></a><span id="l4.420">           aMenuNode.setAttribute(&quot;ServerType&quot;, aFolder.server.type);</span>
<a href="#l4.421"></a><span id="l4.421" class="difflineminus">-          aMenuNode.setAttribute(&quot;IsFeedFolder&quot;,</span>
<a href="#l4.422"></a><span id="l4.422" class="difflineminus">-            (this.FeedUtils.getFeedUrlsInFolder(aFolder) ? true : false));</span>
<a href="#l4.423"></a><span id="l4.423" class="difflineplus">+          aMenuNode.setAttribute(&quot;IsFeedFolder&quot;, !!this.FeedUtils.getFeedUrlsInFolder(aFolder));</span>
<a href="#l4.424"></a><span id="l4.424">         ]]&gt;&lt;/body&gt;</span>
<a href="#l4.425"></a><span id="l4.425">       &lt;/method&gt;</span>
<a href="#l4.426"></a><span id="l4.426"> </span>
<a href="#l4.427"></a><span id="l4.427">       &lt;!--</span>
<a href="#l4.428"></a><span id="l4.428">          - This function returns a formatted display name for a menulist</span>
<a href="#l4.429"></a><span id="l4.429">          - selected folder.  The desired format is set as the 'displayformat'</span>
<a href="#l4.430"></a><span id="l4.430">          - attribute of the folderpicker's &lt;menulist&gt;, one of:</span>
<a href="#l4.431"></a><span id="l4.431">          - 'name' (default) - Folder</span>
<a href="#l4.432"></a><span id="l4.432" class="difflineat">@@ -782,20 +783,22 @@</span>
<a href="#l4.433"></a><span id="l4.433">       &lt;method name=&quot;selectFolder&quot;&gt;</span>
<a href="#l4.434"></a><span id="l4.434">         &lt;parameter name=&quot;aFolder&quot;/&gt;</span>
<a href="#l4.435"></a><span id="l4.435">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l4.436"></a><span id="l4.436">           // Set the label of the menulist element as if aFolder had been selected.</span>
<a href="#l4.437"></a><span id="l4.437">           function setupParent(aFolder, aMenulist, aNoFolders) {</span>
<a href="#l4.438"></a><span id="l4.438">             let menupopup = aMenulist.menupopup;</span>
<a href="#l4.439"></a><span id="l4.439">             if (aFolder) {</span>
<a href="#l4.440"></a><span id="l4.440">               aMenulist.setAttribute(&quot;label&quot;, menupopup.getDisplayName(aFolder));</span>
<a href="#l4.441"></a><span id="l4.441" class="difflineplus">+            } else if (aNoFolders) {</span>
<a href="#l4.442"></a><span id="l4.442" class="difflineplus">+              aMenulist.setAttribute(&quot;label&quot;, menupopup._stringBundle.getString(&quot;noFolders&quot;));</span>
<a href="#l4.443"></a><span id="l4.443" class="difflineplus">+            } else if (menupopup._serversOnly) {</span>
<a href="#l4.444"></a><span id="l4.444" class="difflineplus">+              aMenulist.setAttribute(&quot;label&quot;, menupopup._stringBundle.getString(&quot;chooseAccount&quot;));</span>
<a href="#l4.445"></a><span id="l4.445">             } else {</span>
<a href="#l4.446"></a><span id="l4.446" class="difflineminus">-              aMenulist.setAttribute(&quot;label&quot;, menupopup._stringBundle.getString(</span>
<a href="#l4.447"></a><span id="l4.447" class="difflineminus">-                aNoFolders ? &quot;noFolders&quot; :</span>
<a href="#l4.448"></a><span id="l4.448" class="difflineminus">-                             (menupopup._serversOnly ? &quot;chooseAccount&quot; : &quot;chooseFolder&quot;)));</span>
<a href="#l4.449"></a><span id="l4.449" class="difflineplus">+              aMenulist.setAttribute(&quot;label&quot;, menupopup._stringBundle.getString(&quot;chooseFolder&quot;));</span>
<a href="#l4.450"></a><span id="l4.450">             }</span>
<a href="#l4.451"></a><span id="l4.451">             aMenulist.setAttribute(&quot;value&quot;,</span>
<a href="#l4.452"></a><span id="l4.452">               aFolder ? aFolder.URI : &quot;&quot;);</span>
<a href="#l4.453"></a><span id="l4.453">             aMenulist.setAttribute(&quot;IsServer&quot;,</span>
<a href="#l4.454"></a><span id="l4.454">               aFolder ? aFolder.isServer : false);</span>
<a href="#l4.455"></a><span id="l4.455">             aMenulist.setAttribute(&quot;IsSecure&quot;,</span>
<a href="#l4.456"></a><span id="l4.456">               aFolder ? aFolder.server.isSecure : false);</span>
<a href="#l4.457"></a><span id="l4.457">             aMenulist.setAttribute(&quot;ServerType&quot;,</span>
<a href="#l4.458"></a><span id="l4.458" class="difflineat">@@ -824,29 +827,26 @@</span>
<a href="#l4.459"></a><span id="l4.459">           // If the caller specified a folder to select and it was not</span>
<a href="#l4.460"></a><span id="l4.460">           // found, or if the caller didn't pass a folder (meaning a logical</span>
<a href="#l4.461"></a><span id="l4.461">           // and valid folder wasn't determined), don't blow up but reset</span>
<a href="#l4.462"></a><span id="l4.462">           // attributes and set a nice Choose Folder label so the user may</span>
<a href="#l4.463"></a><span id="l4.463">           // select a valid folder per the filter for this picker. If there are</span>
<a href="#l4.464"></a><span id="l4.464">           // no children, then no folder passed the filter; disable the menulist</span>
<a href="#l4.465"></a><span id="l4.465">           // as there's nothing to choose from.</span>
<a href="#l4.466"></a><span id="l4.466">           let noFolders;</span>
<a href="#l4.467"></a><span id="l4.467" class="difflineminus">-          if (!this.childElementCount)</span>
<a href="#l4.468"></a><span id="l4.468" class="difflineminus">-          {</span>
<a href="#l4.469"></a><span id="l4.469" class="difflineplus">+          if (!this.childElementCount) {</span>
<a href="#l4.470"></a><span id="l4.470">             this.parentNode.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l4.471"></a><span id="l4.471">             noFolders = true;</span>
<a href="#l4.472"></a><span id="l4.472" class="difflineminus">-          }</span>
<a href="#l4.473"></a><span id="l4.473" class="difflineminus">-          else</span>
<a href="#l4.474"></a><span id="l4.474" class="difflineminus">-          {</span>
<a href="#l4.475"></a><span id="l4.475" class="difflineplus">+          } else {</span>
<a href="#l4.476"></a><span id="l4.476">             this.parentNode.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l4.477"></a><span id="l4.477">             noFolders = false;</span>
<a href="#l4.478"></a><span id="l4.478">           }</span>
<a href="#l4.479"></a><span id="l4.479"> </span>
<a href="#l4.480"></a><span id="l4.480">           setupParent(folder, this.parentNode, noFolders);</span>
<a href="#l4.481"></a><span id="l4.481" class="difflineminus">-          return folder ? true : false;</span>
<a href="#l4.482"></a><span id="l4.482" class="difflineplus">+          return !!folder;</span>
<a href="#l4.483"></a><span id="l4.483">         ]]&gt;&lt;/body&gt;</span>
<a href="#l4.484"></a><span id="l4.484">       &lt;/method&gt;</span>
<a href="#l4.485"></a><span id="l4.485"> </span>
<a href="#l4.486"></a><span id="l4.486">       &lt;!--</span>
<a href="#l4.487"></a><span id="l4.487">          - Removes all menu-items for this popup, resets all fields, and</span>
<a href="#l4.488"></a><span id="l4.488">          - removes the listener.  This function is invoked when a change</span>
<a href="#l4.489"></a><span id="l4.489">          - that affects this menu is detected by our listener.</span>
<a href="#l4.490"></a><span id="l4.490">         --&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/base/content/jsTreeView.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/base/content/jsTreeView.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -28,103 +28,103 @@ PROTO_TREE_VIEW.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4">   get rowCount() {</span>
<a href="#l5.5"></a><span id="l5.5">     return this._rowMap.length;</span>
<a href="#l5.6"></a><span id="l5.6">   },</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8">   /**</span>
<a href="#l5.9"></a><span id="l5.9">    * CSS files will cue off of these.  Note that we reach into the rowMap's</span>
<a href="#l5.10"></a><span id="l5.10">    * items so that custom data-displays can define their own properties</span>
<a href="#l5.11"></a><span id="l5.11">    */</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  getCellProperties: function jstv_getCellProperties(aRow, aCol) {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  getCellProperties(aRow, aCol) {</span>
<a href="#l5.14"></a><span id="l5.14">     return this._rowMap[aRow].getProperties(aCol);</span>
<a href="#l5.15"></a><span id="l5.15">   },</span>
<a href="#l5.16"></a><span id="l5.16"> </span>
<a href="#l5.17"></a><span id="l5.17">   /**</span>
<a href="#l5.18"></a><span id="l5.18">    * The actual text to display in the tree</span>
<a href="#l5.19"></a><span id="l5.19">    */</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-  getCellText: function jstv_getCellText(aRow, aCol) {</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+  getCellText(aRow, aCol) {</span>
<a href="#l5.22"></a><span id="l5.22">     return this._rowMap[aRow].getText(aCol.id);</span>
<a href="#l5.23"></a><span id="l5.23">   },</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25">   /**</span>
<a href="#l5.26"></a><span id="l5.26">    * The jstv items take care of assigning this when building children lists</span>
<a href="#l5.27"></a><span id="l5.27">    */</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineminus">-  getLevel: function jstv_getLevel(aIndex) {</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+  getLevel(aIndex) {</span>
<a href="#l5.30"></a><span id="l5.30">     return this._rowMap[aIndex].level;</span>
<a href="#l5.31"></a><span id="l5.31">   },</span>
<a href="#l5.32"></a><span id="l5.32"> </span>
<a href="#l5.33"></a><span id="l5.33">   /**</span>
<a href="#l5.34"></a><span id="l5.34">    * This is easy since the jstv items assigned the _parent property when making</span>
<a href="#l5.35"></a><span id="l5.35">    * the child lists</span>
<a href="#l5.36"></a><span id="l5.36">    */</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineminus">-  getParentIndex: function jstv_getParentIndex(aIndex) {</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+  getParentIndex(aIndex) {</span>
<a href="#l5.39"></a><span id="l5.39">     return this._rowMap.indexOf(this._rowMap[aIndex]._parent);</span>
<a href="#l5.40"></a><span id="l5.40">   },</span>
<a href="#l5.41"></a><span id="l5.41"> </span>
<a href="#l5.42"></a><span id="l5.42">   /**</span>
<a href="#l5.43"></a><span id="l5.43">    * This is duplicative for our normal jstv views, but custom data-displays may</span>
<a href="#l5.44"></a><span id="l5.44">    * want to do something special here</span>
<a href="#l5.45"></a><span id="l5.45">    */</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-  getRowProperties: function jstv_getRowProperties(aRow) {</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+  getRowProperties(aRow) {</span>
<a href="#l5.48"></a><span id="l5.48">     return this._rowMap[aRow].getProperties();</span>
<a href="#l5.49"></a><span id="l5.49">   },</span>
<a href="#l5.50"></a><span id="l5.50"> </span>
<a href="#l5.51"></a><span id="l5.51">   /**</span>
<a href="#l5.52"></a><span id="l5.52">    * If an item in our list has the same level and parent as us, it's a sibling</span>
<a href="#l5.53"></a><span id="l5.53">    */</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineminus">-  hasNextSibling: function jstv_hasNextSibling(aIndex, aNextIndex) {</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+  hasNextSibling(aIndex, aNextIndex) {</span>
<a href="#l5.56"></a><span id="l5.56">     let targetLevel = this._rowMap[aIndex].level;</span>
<a href="#l5.57"></a><span id="l5.57">     for (let i = aNextIndex + 1; i &lt; this._rowMap.length; i++) {</span>
<a href="#l5.58"></a><span id="l5.58">       if (this._rowMap[i].level == targetLevel)</span>
<a href="#l5.59"></a><span id="l5.59">         return true;</span>
<a href="#l5.60"></a><span id="l5.60">       if (this._rowMap[i].level &lt; targetLevel)</span>
<a href="#l5.61"></a><span id="l5.61">         return false;</span>
<a href="#l5.62"></a><span id="l5.62">     }</span>
<a href="#l5.63"></a><span id="l5.63">     return false;</span>
<a href="#l5.64"></a><span id="l5.64">   },</span>
<a href="#l5.65"></a><span id="l5.65"> </span>
<a href="#l5.66"></a><span id="l5.66">   /**</span>
<a href="#l5.67"></a><span id="l5.67">    * If we have a child-list with at least one element, we are a container.</span>
<a href="#l5.68"></a><span id="l5.68">    */</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-  isContainer: function jstv_isContainer(aIndex) {</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineplus">+  isContainer(aIndex) {</span>
<a href="#l5.71"></a><span id="l5.71">     return this._rowMap[aIndex].children.length &gt; 0;</span>
<a href="#l5.72"></a><span id="l5.72">   },</span>
<a href="#l5.73"></a><span id="l5.73"> </span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-  isContainerEmpty: function jstv_isContainerEmpty(aIndex) {</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineplus">+  isContainerEmpty(aIndex) {</span>
<a href="#l5.76"></a><span id="l5.76">     // If the container has no children, the container is empty.</span>
<a href="#l5.77"></a><span id="l5.77">     return !this._rowMap[aIndex].children.length;</span>
<a href="#l5.78"></a><span id="l5.78">   },</span>
<a href="#l5.79"></a><span id="l5.79"> </span>
<a href="#l5.80"></a><span id="l5.80">   /**</span>
<a href="#l5.81"></a><span id="l5.81">    * Just look at the jstv item here</span>
<a href="#l5.82"></a><span id="l5.82">    */</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineminus">-  isContainerOpen: function jstv_isContainerOpen(aIndex) {</span>
<a href="#l5.84"></a><span id="l5.84" class="difflineplus">+  isContainerOpen(aIndex) {</span>
<a href="#l5.85"></a><span id="l5.85">     return this._rowMap[aIndex].open;</span>
<a href="#l5.86"></a><span id="l5.86">   },</span>
<a href="#l5.87"></a><span id="l5.87"> </span>
<a href="#l5.88"></a><span id="l5.88" class="difflineminus">-  isEditable: function jstv_isEditable(aRow, aCol) {</span>
<a href="#l5.89"></a><span id="l5.89" class="difflineplus">+  isEditable(aRow, aCol) {</span>
<a href="#l5.90"></a><span id="l5.90">     // We don't support editing rows in the tree yet.</span>
<a href="#l5.91"></a><span id="l5.91">     return false;</span>
<a href="#l5.92"></a><span id="l5.92">   },</span>
<a href="#l5.93"></a><span id="l5.93"> </span>
<a href="#l5.94"></a><span id="l5.94" class="difflineminus">-  isSeparator: function jstv_isSeparator(aIndex) {</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+  isSeparator(aIndex) {</span>
<a href="#l5.96"></a><span id="l5.96">     // There are no separators in our trees</span>
<a href="#l5.97"></a><span id="l5.97">     return false;</span>
<a href="#l5.98"></a><span id="l5.98">   },</span>
<a href="#l5.99"></a><span id="l5.99"> </span>
<a href="#l5.100"></a><span id="l5.100" class="difflineminus">-  isSorted: function jstv_isSorted() {</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineplus">+  isSorted() {</span>
<a href="#l5.102"></a><span id="l5.102">     // We do our own customized sorting</span>
<a href="#l5.103"></a><span id="l5.103">     return false;</span>
<a href="#l5.104"></a><span id="l5.104">   },</span>
<a href="#l5.105"></a><span id="l5.105"> </span>
<a href="#l5.106"></a><span id="l5.106" class="difflineminus">-  setTree: function jstv_setTree(aTree) {</span>
<a href="#l5.107"></a><span id="l5.107" class="difflineplus">+  setTree(aTree) {</span>
<a href="#l5.108"></a><span id="l5.108">     this._tree = aTree;</span>
<a href="#l5.109"></a><span id="l5.109">   },</span>
<a href="#l5.110"></a><span id="l5.110"> </span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-  recursivelyAddToMap: function jstv_recursivelyAddToMap(aChild, aNewIndex) {</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+  recursivelyAddToMap(aChild, aNewIndex) {</span>
<a href="#l5.113"></a><span id="l5.113">     // When we add sub-children, we're going to need to increase our index</span>
<a href="#l5.114"></a><span id="l5.114">     // for the next add item at our own level.</span>
<a href="#l5.115"></a><span id="l5.115">     let currentCount = this._rowMap.length;</span>
<a href="#l5.116"></a><span id="l5.116">     if (aChild.children.length &amp;&amp; aChild.open) {</span>
<a href="#l5.117"></a><span id="l5.117">       for (let [i, child] of this._rowMap[aNewIndex].children.entries()) {</span>
<a href="#l5.118"></a><span id="l5.118">         let index = aNewIndex + i + 1;</span>
<a href="#l5.119"></a><span id="l5.119">         this._rowMap.splice(index, 0, child);</span>
<a href="#l5.120"></a><span id="l5.120">         aNewIndex += this.recursivelyAddToMap(child, index);</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineat">@@ -132,18 +132,17 @@ PROTO_TREE_VIEW.prototype = {</span>
<a href="#l5.122"></a><span id="l5.122">     }</span>
<a href="#l5.123"></a><span id="l5.123">     return this._rowMap.length - currentCount;</span>
<a href="#l5.124"></a><span id="l5.124">   },</span>
<a href="#l5.125"></a><span id="l5.125"> </span>
<a href="#l5.126"></a><span id="l5.126">   /**</span>
<a href="#l5.127"></a><span id="l5.127">    * Opens or closes a container with children.  The logic here is a bit hairy, so</span>
<a href="#l5.128"></a><span id="l5.128">    * be very careful about changing anything.</span>
<a href="#l5.129"></a><span id="l5.129">    */</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineminus">-  toggleOpenState: function jstv_toggleOpenState(aIndex) {</span>
<a href="#l5.131"></a><span id="l5.131" class="difflineminus">-</span>
<a href="#l5.132"></a><span id="l5.132" class="difflineplus">+  toggleOpenState(aIndex) {</span>
<a href="#l5.133"></a><span id="l5.133">     // Ok, this is a bit tricky.</span>
<a href="#l5.134"></a><span id="l5.134">     this._rowMap[aIndex]._open = !this._rowMap[aIndex].open;</span>
<a href="#l5.135"></a><span id="l5.135"> </span>
<a href="#l5.136"></a><span id="l5.136">     if (!this._rowMap[aIndex].open) {</span>
<a href="#l5.137"></a><span id="l5.137">       // We're closing the current container.  Remove the children</span>
<a href="#l5.138"></a><span id="l5.138"> </span>
<a href="#l5.139"></a><span id="l5.139">       // Note that we can't simply splice out children.length, because some of</span>
<a href="#l5.140"></a><span id="l5.140">       // them might have children too.  Find out how many items we're actually</span>
<a href="#l5.141"></a><span id="l5.141" class="difflineat">@@ -170,60 +169,60 @@ PROTO_TREE_VIEW.prototype = {</span>
<a href="#l5.142"></a><span id="l5.142"> </span>
<a href="#l5.143"></a><span id="l5.143">       // Note that these children may have been open when we were last closed,</span>
<a href="#l5.144"></a><span id="l5.144">       // and if they are, we also have to add those grandchildren to the map</span>
<a href="#l5.145"></a><span id="l5.145">       let oldCount = this._rowMap.length;</span>
<a href="#l5.146"></a><span id="l5.146">       this.recursivelyAddToMap(this._rowMap[aIndex], aIndex);</span>
<a href="#l5.147"></a><span id="l5.147"> </span>
<a href="#l5.148"></a><span id="l5.148">       // Add this container to the persist map</span>
<a href="#l5.149"></a><span id="l5.149">       let id = this._rowMap[aIndex].id;</span>
<a href="#l5.150"></a><span id="l5.150" class="difflineminus">-      if (this._persistOpenMap.indexOf(id) == -1)</span>
<a href="#l5.151"></a><span id="l5.151" class="difflineplus">+      if (!this._persistOpenMap.includes(id))</span>
<a href="#l5.152"></a><span id="l5.152">         this._persistOpenMap.push(id);</span>
<a href="#l5.153"></a><span id="l5.153"> </span>
<a href="#l5.154"></a><span id="l5.154">       // Notify the tree of changes</span>
<a href="#l5.155"></a><span id="l5.155">       if (this._tree)</span>
<a href="#l5.156"></a><span id="l5.156">         this._tree.rowCountChanged(aIndex + 1, this._rowMap.length - oldCount);</span>
<a href="#l5.157"></a><span id="l5.157">     }</span>
<a href="#l5.158"></a><span id="l5.158"> </span>
<a href="#l5.159"></a><span id="l5.159">     // Invalidate the toggled row, so that the open/closed marker changes</span>
<a href="#l5.160"></a><span id="l5.160">     if (this._tree)</span>
<a href="#l5.161"></a><span id="l5.161">       this._tree.invalidateRow(aIndex);</span>
<a href="#l5.162"></a><span id="l5.162">   },</span>
<a href="#l5.163"></a><span id="l5.163"> </span>
<a href="#l5.164"></a><span id="l5.164">   // We don't implement any of these at the moment</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-  canDrop: function jstv_canDrop(aIndex, aOrientation) {},</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-  drop: function jstv_drop(aRow, aOrientation) {},</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-  performAction: function jstv_performAction(aAction) {},</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-  performActionOnCell: function jstv_performActionOnCell(aAction, aRow, aCol) {},</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-  performActionOnRow: function jstv_performActionOnRow(aAction, aRow) {},</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-  selectionChanged: function jstv_selectionChanged() {},</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-  setCellText: function jstv_setCellText(aRow, aCol, aValue) {},</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-  setCellValue: function jstv_setCellValue(aRow, aCol, aValue) {},</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-  getCellValue: function jstv_getCellValue(aRow, aCol) {},</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-  getColumnProperties: function jstv_getColumnProperties(aCol) { return &quot;&quot;; },</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineminus">-  getImageSrc: function jstv_getImageSrc(aRow, aCol) {},</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineminus">-  getProgressMode: function jstv_getProgressMode(aRow, aCol) {},</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineminus">-  cycleCell: function jstv_cycleCell(aRow, aCol) {},</span>
<a href="#l5.178"></a><span id="l5.178" class="difflineminus">-  cycleHeader: function jstv_cycleHeader(aCol) {},</span>
<a href="#l5.179"></a><span id="l5.179" class="difflineplus">+  canDrop(aIndex, aOrientation) {},</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineplus">+  drop(aRow, aOrientation) {},</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineplus">+  performAction(aAction) {},</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+  performActionOnCell(aAction, aRow, aCol) {},</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+  performActionOnRow(aAction, aRow) {},</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+  selectionChanged() {},</span>
<a href="#l5.185"></a><span id="l5.185" class="difflineplus">+  setCellText(aRow, aCol, aValue) {},</span>
<a href="#l5.186"></a><span id="l5.186" class="difflineplus">+  setCellValue(aRow, aCol, aValue) {},</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineplus">+  getCellValue(aRow, aCol) {},</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineplus">+  getColumnProperties(aCol) { return &quot;&quot;; },</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineplus">+  getImageSrc(aRow, aCol) {},</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+  getProgressMode(aRow, aCol) {},</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineplus">+  cycleCell(aRow, aCol) {},</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+  cycleHeader(aCol) {},</span>
<a href="#l5.193"></a><span id="l5.193"> </span>
<a href="#l5.194"></a><span id="l5.194">   _tree: null,</span>
<a href="#l5.195"></a><span id="l5.195"> </span>
<a href="#l5.196"></a><span id="l5.196">   /**</span>
<a href="#l5.197"></a><span id="l5.197">    * An array of jstv items, where each item corresponds to a row in the tree</span>
<a href="#l5.198"></a><span id="l5.198">    */</span>
<a href="#l5.199"></a><span id="l5.199">   _rowMap: null,</span>
<a href="#l5.200"></a><span id="l5.200"> </span>
<a href="#l5.201"></a><span id="l5.201">   /**</span>
<a href="#l5.202"></a><span id="l5.202">    * This is a javascript map of which containers we had open, so that we can</span>
<a href="#l5.203"></a><span id="l5.203">    * persist their state over-time.  It is designed to be used as a JSON object.</span>
<a href="#l5.204"></a><span id="l5.204">    */</span>
<a href="#l5.205"></a><span id="l5.205">   _persistOpenMap: null,</span>
<a href="#l5.206"></a><span id="l5.206"> </span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-  _restoreOpenStates: function jstv__restoreOpenStates() {</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineplus">+  _restoreOpenStates() {</span>
<a href="#l5.209"></a><span id="l5.209">     // Note that as we iterate through here, .length may grow</span>
<a href="#l5.210"></a><span id="l5.210">     for (let i = 0; i &lt; this._rowMap.length; i++) {</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineminus">-      if (this._persistOpenMap.indexOf(this._rowMap[i].id) != -1)</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineplus">+      if (this._persistOpenMap.includes(this._rowMap[i].id))</span>
<a href="#l5.213"></a><span id="l5.213">         this.toggleOpenState(i);</span>
<a href="#l5.214"></a><span id="l5.214">     }</span>
<a href="#l5.215"></a><span id="l5.215">   },</span>
<a href="#l5.216"></a><span id="l5.216"> </span>
<a href="#l5.217"></a><span id="l5.217">   QueryInterface: ChromeUtils.generateQI([&quot;nsITreeView&quot;]),</span>
<a href="#l5.218"></a><span id="l5.218"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/content/junkCommands.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/content/junkCommands.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -11,25 +11,24 @@</span>
<a href="#l6.4"></a><span id="l6.4">   *</span>
<a href="#l6.5"></a><span id="l6.5">   *   window.MsgStatusFeedback</span>
<a href="#l6.6"></a><span id="l6.6">   *</span>
<a href="#l6.7"></a><span id="l6.7">   *   One of:</span>
<a href="#l6.8"></a><span id="l6.8">   *     GetSelectedIndices(view) (in suite)</span>
<a href="#l6.9"></a><span id="l6.9">   *     gFolderDisplay (in mail)</span>
<a href="#l6.10"></a><span id="l6.10">   *</span>
<a href="#l6.11"></a><span id="l6.11">   *   messenger</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  *   gMessengerBundle</span>
<a href="#l6.13"></a><span id="l6.13">   *   gDBView</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineminus">-  *   either gMsgFolderSelected or gFolderDisplay</span>
<a href="#l6.15"></a><span id="l6.15">   *   MsgJunkMailInfo(aCheckFirstUse)</span>
<a href="#l6.16"></a><span id="l6.16" class="difflineminus">-  *   SetNextMessageAfterDelete()</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-  *   pref</span>
<a href="#l6.18"></a><span id="l6.18">   *   msgWindow</span>
<a href="#l6.19"></a><span id="l6.19">   */</span>
<a href="#l6.20"></a><span id="l6.20"> </span>
<a href="#l6.21"></a><span id="l6.21" class="difflineplus">+/* globals ClearMessagePane, gDBView, gFolderDisplay, MarkSelectedMessagesRead, messenger,</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+   MsgJunkMailInfo, msgWindow, nsMsgViewIndex_None */</span>
<a href="#l6.23"></a><span id="l6.23" class="difflineplus">+</span>
<a href="#l6.24"></a><span id="l6.24"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l6.25"></a><span id="l6.25"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l6.26"></a><span id="l6.26"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28"> /*</span>
<a href="#l6.29"></a><span id="l6.29">  * determineActionsForJunkMsgs</span>
<a href="#l6.30"></a><span id="l6.30">  *</span>
<a href="#l6.31"></a><span id="l6.31">  * Determines the actions that should be carried out on the messages</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineat">@@ -38,43 +37,40 @@ var {MailUtils} = ChromeUtils.import(&quot;re</span>
<a href="#l6.33"></a><span id="l6.33">  * @param aFolder</span>
<a href="#l6.34"></a><span id="l6.34">  *        the folder with messages being marked as junk</span>
<a href="#l6.35"></a><span id="l6.35">  *</span>
<a href="#l6.36"></a><span id="l6.36">  * @return an object with two properties: 'markRead' (boolean) indicating</span>
<a href="#l6.37"></a><span id="l6.37">  *         whether the messages should be marked as read, and 'junkTargetFolder'</span>
<a href="#l6.38"></a><span id="l6.38">  *         (nsIMsgFolder) specifying where the messages should be moved, or</span>
<a href="#l6.39"></a><span id="l6.39">  *         null if they should not be moved.</span>
<a href="#l6.40"></a><span id="l6.40">  */</span>
<a href="#l6.41"></a><span id="l6.41" class="difflineminus">-function determineActionsForJunkMsgs(aFolder)</span>
<a href="#l6.42"></a><span id="l6.42" class="difflineminus">-{</span>
<a href="#l6.43"></a><span id="l6.43" class="difflineplus">+function determineActionsForJunkMsgs(aFolder) {</span>
<a href="#l6.44"></a><span id="l6.44">   var actions = { markRead: false, junkTargetFolder: null };</span>
<a href="#l6.45"></a><span id="l6.45">   var spamSettings = aFolder.server.spamSettings;</span>
<a href="#l6.46"></a><span id="l6.46"> </span>
<a href="#l6.47"></a><span id="l6.47">   // note we will do moves/marking as read even if the spam</span>
<a href="#l6.48"></a><span id="l6.48">   // feature is disabled, since the user has asked to use it</span>
<a href="#l6.49"></a><span id="l6.49">   // despite the disabling</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51">   actions.markRead = spamSettings.markAsReadOnSpam;</span>
<a href="#l6.52"></a><span id="l6.52">   actions.junkTargetFolder = null;</span>
<a href="#l6.53"></a><span id="l6.53"> </span>
<a href="#l6.54"></a><span id="l6.54">   // move only when the corresponding setting is activated</span>
<a href="#l6.55"></a><span id="l6.55">   // and the currently viewed folder is not the junk folder.</span>
<a href="#l6.56"></a><span id="l6.56">   if (spamSettings.moveOnSpam &amp;&amp;</span>
<a href="#l6.57"></a><span id="l6.57" class="difflineminus">-      !(aFolder.flags &amp; Ci.nsMsgFolderFlags.Junk))</span>
<a href="#l6.58"></a><span id="l6.58" class="difflineminus">-  {</span>
<a href="#l6.59"></a><span id="l6.59" class="difflineplus">+      !aFolder.getFlag(Ci.nsMsgFolderFlags.Junk)) {</span>
<a href="#l6.60"></a><span id="l6.60">     var spamFolderURI = spamSettings.spamFolderURI;</span>
<a href="#l6.61"></a><span id="l6.61" class="difflineminus">-    if (!spamFolderURI)</span>
<a href="#l6.62"></a><span id="l6.62" class="difflineminus">-    {</span>
<a href="#l6.63"></a><span id="l6.63" class="difflineplus">+    if (!spamFolderURI) {</span>
<a href="#l6.64"></a><span id="l6.64">       // XXX TODO</span>
<a href="#l6.65"></a><span id="l6.65">       // we should use nsIPromptService to inform the user of the problem,</span>
<a href="#l6.66"></a><span id="l6.66">       // e.g. when the junk folder was accidentally deleted.</span>
<a href="#l6.67"></a><span id="l6.67" class="difflineminus">-      dump('determineActionsForJunkMsgs: no spam folder found, not moving.');</span>
<a href="#l6.68"></a><span id="l6.68" class="difflineplus">+      dump(&quot;determineActionsForJunkMsgs: no spam folder found, not moving.&quot;);</span>
<a href="#l6.69"></a><span id="l6.69" class="difflineplus">+    } else {</span>
<a href="#l6.70"></a><span id="l6.70" class="difflineplus">+      actions.junkTargetFolder = MailUtils.getOrCreateFolder(spamFolderURI);</span>
<a href="#l6.71"></a><span id="l6.71">     }</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineminus">-    else</span>
<a href="#l6.73"></a><span id="l6.73" class="difflineminus">-      actions.junkTargetFolder = MailUtils.getOrCreateFolder(spamFolderURI);</span>
<a href="#l6.74"></a><span id="l6.74">   }</span>
<a href="#l6.75"></a><span id="l6.75"> </span>
<a href="#l6.76"></a><span id="l6.76">   return actions;</span>
<a href="#l6.77"></a><span id="l6.77"> }</span>
<a href="#l6.78"></a><span id="l6.78"> </span>
<a href="#l6.79"></a><span id="l6.79"> /**</span>
<a href="#l6.80"></a><span id="l6.80">  * performActionsOnJunkMsgs</span>
<a href="#l6.81"></a><span id="l6.81">  *</span>
<a href="#l6.82"></a><span id="l6.82" class="difflineat">@@ -84,39 +80,34 @@ function determineActionsForJunkMsgs(aFo</span>
<a href="#l6.83"></a><span id="l6.83">  *        the folder with messages being marked as junk</span>
<a href="#l6.84"></a><span id="l6.84">  *</span>
<a href="#l6.85"></a><span id="l6.85">  * @param aJunkMsgHdrs</span>
<a href="#l6.86"></a><span id="l6.86">  *        nsIArray containing headers (nsIMsgDBHdr) of new junk messages</span>
<a href="#l6.87"></a><span id="l6.87">  *</span>
<a href="#l6.88"></a><span id="l6.88">  * @param aGoodMsgHdrs</span>
<a href="#l6.89"></a><span id="l6.89">  *        nsIArray containing headers (nsIMsgDBHdr) of new good messages</span>
<a href="#l6.90"></a><span id="l6.90">  */</span>
<a href="#l6.91"></a><span id="l6.91" class="difflineminus">- function performActionsOnJunkMsgs(aFolder, aJunkMsgHdrs, aGoodMsgHdrs)</span>
<a href="#l6.92"></a><span id="l6.92" class="difflineminus">-{</span>
<a href="#l6.93"></a><span id="l6.93" class="difflineminus">-  if (aFolder instanceof Ci.nsIMsgImapMailFolder) // need to update IMAP custom flags</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-  {</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineminus">-    if (aJunkMsgHdrs.length)</span>
<a href="#l6.96"></a><span id="l6.96" class="difflineminus">-    {</span>
<a href="#l6.97"></a><span id="l6.97" class="difflineminus">-      var junkMsgKeys = new Array();</span>
<a href="#l6.98"></a><span id="l6.98" class="difflineminus">-      for (var i = 0; i &lt; aJunkMsgHdrs.length; i++)</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineplus">+function performActionsOnJunkMsgs(aFolder, aJunkMsgHdrs, aGoodMsgHdrs) {</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+  if (aFolder instanceof Ci.nsIMsgImapMailFolder) { // need to update IMAP custom flags</span>
<a href="#l6.101"></a><span id="l6.101" class="difflineplus">+    if (aJunkMsgHdrs.length) {</span>
<a href="#l6.102"></a><span id="l6.102" class="difflineplus">+      var junkMsgKeys = [];</span>
<a href="#l6.103"></a><span id="l6.103" class="difflineplus">+      for (let i = 0; i &lt; aJunkMsgHdrs.length; i++)</span>
<a href="#l6.104"></a><span id="l6.104">         junkMsgKeys[i] = aJunkMsgHdrs.queryElementAt(i, Ci.nsIMsgDBHdr).messageKey;</span>
<a href="#l6.105"></a><span id="l6.105">       aFolder.storeCustomKeywords(null, &quot;Junk&quot;, &quot;NonJunk&quot;, junkMsgKeys, junkMsgKeys.length);</span>
<a href="#l6.106"></a><span id="l6.106">     }</span>
<a href="#l6.107"></a><span id="l6.107"> </span>
<a href="#l6.108"></a><span id="l6.108" class="difflineminus">-    if (aGoodMsgHdrs.length)</span>
<a href="#l6.109"></a><span id="l6.109" class="difflineminus">-    {</span>
<a href="#l6.110"></a><span id="l6.110" class="difflineminus">-      var goodMsgKeys = new Array();</span>
<a href="#l6.111"></a><span id="l6.111" class="difflineminus">-      for (var i = 0; i &lt; aGoodMsgHdrs.length; i++)</span>
<a href="#l6.112"></a><span id="l6.112" class="difflineplus">+    if (aGoodMsgHdrs.length) {</span>
<a href="#l6.113"></a><span id="l6.113" class="difflineplus">+      let goodMsgKeys = [];</span>
<a href="#l6.114"></a><span id="l6.114" class="difflineplus">+      for (let i = 0; i &lt; aGoodMsgHdrs.length; i++)</span>
<a href="#l6.115"></a><span id="l6.115">         goodMsgKeys[i] = aGoodMsgHdrs.queryElementAt(i, Ci.nsIMsgDBHdr).messageKey;</span>
<a href="#l6.116"></a><span id="l6.116">       aFolder.storeCustomKeywords(null, &quot;NonJunk&quot;, &quot;Junk&quot;, goodMsgKeys, goodMsgKeys.length);</span>
<a href="#l6.117"></a><span id="l6.117">     }</span>
<a href="#l6.118"></a><span id="l6.118">   }</span>
<a href="#l6.119"></a><span id="l6.119"> </span>
<a href="#l6.120"></a><span id="l6.120" class="difflineminus">-  if (aJunkMsgHdrs.length)</span>
<a href="#l6.121"></a><span id="l6.121" class="difflineminus">-  {</span>
<a href="#l6.122"></a><span id="l6.122" class="difflineplus">+  if (aJunkMsgHdrs.length) {</span>
<a href="#l6.123"></a><span id="l6.123">     var actionParams = determineActionsForJunkMsgs(aFolder);</span>
<a href="#l6.124"></a><span id="l6.124">     if (actionParams.markRead)</span>
<a href="#l6.125"></a><span id="l6.125">       aFolder.markMessagesRead(aJunkMsgHdrs, true);</span>
<a href="#l6.126"></a><span id="l6.126"> </span>
<a href="#l6.127"></a><span id="l6.127">     if (actionParams.junkTargetFolder)</span>
<a href="#l6.128"></a><span id="l6.128">       MailServices.copy</span>
<a href="#l6.129"></a><span id="l6.129">                   .CopyMessages(aFolder, aJunkMsgHdrs, actionParams.junkTargetFolder,</span>
<a href="#l6.130"></a><span id="l6.130">                     true /* isMove */, null, msgWindow, true /* allow undo */);</span>
<a href="#l6.131"></a><span id="l6.131" class="difflineat">@@ -130,88 +121,82 @@ function determineActionsForJunkMsgs(aFo</span>
<a href="#l6.132"></a><span id="l6.132">  * and implementing junk processing callback</span>
<a href="#l6.133"></a><span id="l6.133">  *</span>
<a href="#l6.134"></a><span id="l6.134">  * @param aFolder</span>
<a href="#l6.135"></a><span id="l6.135">  *        the folder with messages to be analyzed for junk</span>
<a href="#l6.136"></a><span id="l6.136">  * @param aTotalMessages</span>
<a href="#l6.137"></a><span id="l6.137">  *        Number of messages to process, used for progress report only</span>
<a href="#l6.138"></a><span id="l6.138">  */</span>
<a href="#l6.139"></a><span id="l6.139"> </span>
<a href="#l6.140"></a><span id="l6.140" class="difflineminus">-function MessageClassifier(aFolder, aTotalMessages)</span>
<a href="#l6.141"></a><span id="l6.141" class="difflineminus">-{</span>
<a href="#l6.142"></a><span id="l6.142" class="difflineplus">+function MessageClassifier(aFolder, aTotalMessages) {</span>
<a href="#l6.143"></a><span id="l6.143">   this.mFolder = aFolder;</span>
<a href="#l6.144"></a><span id="l6.144">   this.mJunkMsgHdrs = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l6.145"></a><span id="l6.145">                         .createInstance(Ci.nsIMutableArray);</span>
<a href="#l6.146"></a><span id="l6.146">   this.mGoodMsgHdrs = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l6.147"></a><span id="l6.147">                         .createInstance(Ci.nsIMutableArray);</span>
<a href="#l6.148"></a><span id="l6.148" class="difflineminus">-  this.mMessages = new Object();</span>
<a href="#l6.149"></a><span id="l6.149" class="difflineminus">-  this.mMessageQueue = new Array();</span>
<a href="#l6.150"></a><span id="l6.150" class="difflineplus">+  this.mMessages = {};</span>
<a href="#l6.151"></a><span id="l6.151" class="difflineplus">+  this.mMessageQueue = [];</span>
<a href="#l6.152"></a><span id="l6.152">   this.mTotalMessages = aTotalMessages;</span>
<a href="#l6.153"></a><span id="l6.153">   this.mProcessedMessages = 0;</span>
<a href="#l6.154"></a><span id="l6.154">   this.firstMessage = true;</span>
<a href="#l6.155"></a><span id="l6.155">   this.lastStatusTime = Date.now();</span>
<a href="#l6.156"></a><span id="l6.156"> }</span>
<a href="#l6.157"></a><span id="l6.157"> </span>
<a href="#l6.158"></a><span id="l6.158" class="difflineminus">-MessageClassifier.prototype =</span>
<a href="#l6.159"></a><span id="l6.159" class="difflineminus">-{</span>
<a href="#l6.160"></a><span id="l6.160" class="difflineplus">+MessageClassifier.prototype = {</span>
<a href="#l6.161"></a><span id="l6.161">   /**</span>
<a href="#l6.162"></a><span id="l6.162">    * analyzeMessage</span>
<a href="#l6.163"></a><span id="l6.163">    *</span>
<a href="#l6.164"></a><span id="l6.164">    * Starts the message classification process for a message. If the message</span>
<a href="#l6.165"></a><span id="l6.165">    * sender's address is whitelisted, the message is skipped.</span>
<a href="#l6.166"></a><span id="l6.166">    *</span>
<a href="#l6.167"></a><span id="l6.167">    * @param aMsgHdr</span>
<a href="#l6.168"></a><span id="l6.168">    *        The header (nsIMsgDBHdr) of the message to classify.</span>
<a href="#l6.169"></a><span id="l6.169">    * @param aSpamSettings</span>
<a href="#l6.170"></a><span id="l6.170">    *        nsISpamSettings object with information about whitelists</span>
<a href="#l6.171"></a><span id="l6.171">    */</span>
<a href="#l6.172"></a><span id="l6.172" class="difflineminus">-  analyzeMessage: function(aMsgHdr, aSpamSettings)</span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-  {</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+  analyzeMessage(aMsgHdr, aSpamSettings) {</span>
<a href="#l6.175"></a><span id="l6.175">     var junkscoreorigin = aMsgHdr.getStringProperty(&quot;junkscoreorigin&quot;);</span>
<a href="#l6.176"></a><span id="l6.176">     if (junkscoreorigin == &quot;user&quot;) // don't override user-set junk status</span>
<a href="#l6.177"></a><span id="l6.177">       return;</span>
<a href="#l6.178"></a><span id="l6.178"> </span>
<a href="#l6.179"></a><span id="l6.179">     // check whitelisting</span>
<a href="#l6.180"></a><span id="l6.180" class="difflineminus">-    if (aSpamSettings.checkWhiteList(aMsgHdr))</span>
<a href="#l6.181"></a><span id="l6.181" class="difflineminus">-    {</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineplus">+    if (aSpamSettings.checkWhiteList(aMsgHdr)) {</span>
<a href="#l6.183"></a><span id="l6.183">       // message is ham from whitelist</span>
<a href="#l6.184"></a><span id="l6.184">       var db = aMsgHdr.folder.msgDatabase;</span>
<a href="#l6.185"></a><span id="l6.185">       db.setStringProperty(aMsgHdr.messageKey, &quot;junkscore&quot;,</span>
<a href="#l6.186"></a><span id="l6.186">                            Ci.nsIJunkMailPlugin.IS_HAM_SCORE);</span>
<a href="#l6.187"></a><span id="l6.187">       db.setStringProperty(aMsgHdr.messageKey, &quot;junkscoreorigin&quot;, &quot;whitelist&quot;);</span>
<a href="#l6.188"></a><span id="l6.188">       this.mGoodMsgHdrs.appendElement(aMsgHdr);</span>
<a href="#l6.189"></a><span id="l6.189">       return;</span>
<a href="#l6.190"></a><span id="l6.190">     }</span>
<a href="#l6.191"></a><span id="l6.191"> </span>
<a href="#l6.192"></a><span id="l6.192">     var messageURI = aMsgHdr.folder.generateMessageURI(aMsgHdr.messageKey) + &quot;?fetchCompleteMessage=true&quot;;</span>
<a href="#l6.193"></a><span id="l6.193">     this.mMessages[messageURI] = aMsgHdr;</span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-    if (this.firstMessage)</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-    {</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+    if (this.firstMessage) {</span>
<a href="#l6.197"></a><span id="l6.197">       this.firstMessage = false;</span>
<a href="#l6.198"></a><span id="l6.198">       MailServices.junk.classifyMessage(messageURI, msgWindow, this);</span>
<a href="#l6.199"></a><span id="l6.199" class="difflineplus">+    } else {</span>
<a href="#l6.200"></a><span id="l6.200" class="difflineplus">+      this.mMessageQueue.push(messageURI);</span>
<a href="#l6.201"></a><span id="l6.201">     }</span>
<a href="#l6.202"></a><span id="l6.202" class="difflineminus">-    else</span>
<a href="#l6.203"></a><span id="l6.203" class="difflineminus">-      this.mMessageQueue.push(messageURI);</span>
<a href="#l6.204"></a><span id="l6.204">   },</span>
<a href="#l6.205"></a><span id="l6.205"> </span>
<a href="#l6.206"></a><span id="l6.206">   /*</span>
<a href="#l6.207"></a><span id="l6.207">    * nsIJunkMailClassificationListener implementation</span>
<a href="#l6.208"></a><span id="l6.208">    * onMessageClassified</span>
<a href="#l6.209"></a><span id="l6.209">    *</span>
<a href="#l6.210"></a><span id="l6.210">    * Callback function from nsIJunkMailPlugin with classification results</span>
<a href="#l6.211"></a><span id="l6.211">    *</span>
<a href="#l6.212"></a><span id="l6.212">    * @param aClassifiedMsgURI</span>
<a href="#l6.213"></a><span id="l6.213">    *        URI of classified message</span>
<a href="#l6.214"></a><span id="l6.214">    * @param aClassification</span>
<a href="#l6.215"></a><span id="l6.215">    *        Junk classification (0: UNCLASSIFIED, 1: GOOD, 2: JUNK)</span>
<a href="#l6.216"></a><span id="l6.216">    * @param aJunkPercent</span>
<a href="#l6.217"></a><span id="l6.217">    *        0 - 100 indicator of junk likelihood, with 100 meaning probably junk</span>
<a href="#l6.218"></a><span id="l6.218">    */</span>
<a href="#l6.219"></a><span id="l6.219" class="difflineminus">-  onMessageClassified: function(aClassifiedMsgURI, aClassification, aJunkPercent)</span>
<a href="#l6.220"></a><span id="l6.220" class="difflineminus">-  {</span>
<a href="#l6.221"></a><span id="l6.221" class="difflineplus">+  onMessageClassified(aClassifiedMsgURI, aClassification, aJunkPercent) {</span>
<a href="#l6.222"></a><span id="l6.222">     if (!aClassifiedMsgURI)</span>
<a href="#l6.223"></a><span id="l6.223">       return; // ignore end of batch</span>
<a href="#l6.224"></a><span id="l6.224">     var nsIJunkMailPlugin = Ci.nsIJunkMailPlugin;</span>
<a href="#l6.225"></a><span id="l6.225">     var score = (aClassification == nsIJunkMailPlugin.JUNK) ?</span>
<a href="#l6.226"></a><span id="l6.226">       nsIJunkMailPlugin.IS_SPAM_SCORE : nsIJunkMailPlugin.IS_HAM_SCORE;</span>
<a href="#l6.227"></a><span id="l6.227">     const statusDisplayInterval = 1000; // milliseconds between status updates</span>
<a href="#l6.228"></a><span id="l6.228"> </span>
<a href="#l6.229"></a><span id="l6.229">     // set these props via the db (instead of the message header</span>
<a href="#l6.230"></a><span id="l6.230" class="difflineat">@@ -224,44 +209,40 @@ MessageClassifier.prototype =</span>
<a href="#l6.231"></a><span id="l6.231">     db.setStringProperty(msgHdr.messageKey, &quot;junkpercent&quot;, aJunkPercent);</span>
<a href="#l6.232"></a><span id="l6.232"> </span>
<a href="#l6.233"></a><span id="l6.233">     if (aClassification == nsIJunkMailPlugin.JUNK)</span>
<a href="#l6.234"></a><span id="l6.234">       this.mJunkMsgHdrs.appendElement(msgHdr);</span>
<a href="#l6.235"></a><span id="l6.235">     else if (aClassification == nsIJunkMailPlugin.GOOD)</span>
<a href="#l6.236"></a><span id="l6.236">       this.mGoodMsgHdrs.appendElement(msgHdr);</span>
<a href="#l6.237"></a><span id="l6.237"> </span>
<a href="#l6.238"></a><span id="l6.238">     var nextMsgURI = this.mMessageQueue.shift();</span>
<a href="#l6.239"></a><span id="l6.239" class="difflineminus">-    if (nextMsgURI)</span>
<a href="#l6.240"></a><span id="l6.240" class="difflineminus">-    {</span>
<a href="#l6.241"></a><span id="l6.241" class="difflineplus">+    if (nextMsgURI) {</span>
<a href="#l6.242"></a><span id="l6.242">       ++this.mProcessedMessages;</span>
<a href="#l6.243"></a><span id="l6.243" class="difflineminus">-      if (Date.now() &gt; this.lastStatusTime + statusDisplayInterval)</span>
<a href="#l6.244"></a><span id="l6.244" class="difflineminus">-      {</span>
<a href="#l6.245"></a><span id="l6.245" class="difflineplus">+      if (Date.now() &gt; this.lastStatusTime + statusDisplayInterval) {</span>
<a href="#l6.246"></a><span id="l6.246">         this.lastStatusTime = Date.now();</span>
<a href="#l6.247"></a><span id="l6.247">         var percentDone = 0;</span>
<a href="#l6.248"></a><span id="l6.248">         if (this.mTotalMessages)</span>
<a href="#l6.249"></a><span id="l6.249">           percentDone = Math.round(this.mProcessedMessages * 100 / this.mTotalMessages);</span>
<a href="#l6.250"></a><span id="l6.250">         var percentStr = percentDone + &quot;%&quot;;</span>
<a href="#l6.251"></a><span id="l6.251">         window.MsgStatusFeedback.showStatusString(</span>
<a href="#l6.252"></a><span id="l6.252">             document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l6.253"></a><span id="l6.253">             .getFormattedString(&quot;junkAnalysisPercentComplete&quot;,</span>
<a href="#l6.254"></a><span id="l6.254">             [percentStr]));</span>
<a href="#l6.255"></a><span id="l6.255">       }</span>
<a href="#l6.256"></a><span id="l6.256"> </span>
<a href="#l6.257"></a><span id="l6.257">       MailServices.junk.classifyMessage(nextMsgURI, msgWindow, this);</span>
<a href="#l6.258"></a><span id="l6.258" class="difflineminus">-    }</span>
<a href="#l6.259"></a><span id="l6.259" class="difflineminus">-    else</span>
<a href="#l6.260"></a><span id="l6.260" class="difflineminus">-    {</span>
<a href="#l6.261"></a><span id="l6.261" class="difflineplus">+    } else {</span>
<a href="#l6.262"></a><span id="l6.262">       window.MsgStatusFeedback.showStatusString(</span>
<a href="#l6.263"></a><span id="l6.263">           document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l6.264"></a><span id="l6.264">           .getString(&quot;processingJunkMessages&quot;));</span>
<a href="#l6.265"></a><span id="l6.265">       performActionsOnJunkMsgs(this.mFolder, this.mJunkMsgHdrs, this.mGoodMsgHdrs);</span>
<a href="#l6.266"></a><span id="l6.266">       window.MsgStatusFeedback.showStatusString(&quot;&quot;);</span>
<a href="#l6.267"></a><span id="l6.267">     }</span>
<a href="#l6.268"></a><span id="l6.268" class="difflineminus">-  }</span>
<a href="#l6.269"></a><span id="l6.269" class="difflineminus">-}</span>
<a href="#l6.270"></a><span id="l6.270" class="difflineplus">+  },</span>
<a href="#l6.271"></a><span id="l6.271" class="difflineplus">+};</span>
<a href="#l6.272"></a><span id="l6.272"> </span>
<a href="#l6.273"></a><span id="l6.273"> /*</span>
<a href="#l6.274"></a><span id="l6.274">  * filterFolderForJunk</span>
<a href="#l6.275"></a><span id="l6.275">  *</span>
<a href="#l6.276"></a><span id="l6.276">  * Filter all messages in the current folder for junk</span>
<a href="#l6.277"></a><span id="l6.277">  */</span>
<a href="#l6.278"></a><span id="l6.278"> function filterFolderForJunk() { processFolderForJunk(true); }</span>
<a href="#l6.279"></a><span id="l6.279"> </span>
<a href="#l6.280"></a><span id="l6.280" class="difflineat">@@ -274,87 +255,74 @@ function analyzeMessagesForJunk() { proc</span>
<a href="#l6.281"></a><span id="l6.281"> </span>
<a href="#l6.282"></a><span id="l6.282"> /*</span>
<a href="#l6.283"></a><span id="l6.283">  * processFolderForJunk</span>
<a href="#l6.284"></a><span id="l6.284">  *</span>
<a href="#l6.285"></a><span id="l6.285">  * Filter messages in the current folder for junk</span>
<a href="#l6.286"></a><span id="l6.286">  *</span>
<a href="#l6.287"></a><span id="l6.287">  * @param aAll: true to filter all messages, else filter selection</span>
<a href="#l6.288"></a><span id="l6.288">  */</span>
<a href="#l6.289"></a><span id="l6.289" class="difflineminus">-function processFolderForJunk(aAll)</span>
<a href="#l6.290"></a><span id="l6.290" class="difflineminus">-{</span>
<a href="#l6.291"></a><span id="l6.291" class="difflineplus">+function processFolderForJunk(aAll) {</span>
<a href="#l6.292"></a><span id="l6.292">   MsgJunkMailInfo(true);</span>
<a href="#l6.293"></a><span id="l6.293"> </span>
<a href="#l6.294"></a><span id="l6.294" class="difflineminus">-  if (aAll)</span>
<a href="#l6.295"></a><span id="l6.295" class="difflineminus">-  {</span>
<a href="#l6.296"></a><span id="l6.296" class="difflineplus">+  let indices;</span>
<a href="#l6.297"></a><span id="l6.297" class="difflineplus">+  if (aAll) {</span>
<a href="#l6.298"></a><span id="l6.298">     // need to expand all threads, so we analyze everything</span>
<a href="#l6.299"></a><span id="l6.299">     gDBView.doCommand(Ci.nsMsgViewCommandType.expandAll);</span>
<a href="#l6.300"></a><span id="l6.300">     var treeView = gDBView.QueryInterface(Ci.nsITreeView);</span>
<a href="#l6.301"></a><span id="l6.301">     var count = treeView.rowCount;</span>
<a href="#l6.302"></a><span id="l6.302">     if (!count)</span>
<a href="#l6.303"></a><span id="l6.303">       return;</span>
<a href="#l6.304"></a><span id="l6.304" class="difflineminus">-  }</span>
<a href="#l6.305"></a><span id="l6.305" class="difflineminus">-  else</span>
<a href="#l6.306"></a><span id="l6.306" class="difflineminus">-  {</span>
<a href="#l6.307"></a><span id="l6.307" class="difflineplus">+  } else {</span>
<a href="#l6.308"></a><span id="l6.308">     // suite uses GetSelectedIndices, mail uses gFolderDisplay.selectedMessages</span>
<a href="#l6.309"></a><span id="l6.309" class="difflineminus">-    var indices = typeof GetSelectedIndices != &quot;undefined&quot; ?</span>
<a href="#l6.310"></a><span id="l6.310" class="difflineminus">-                    GetSelectedIndices(gDBView) :</span>
<a href="#l6.311"></a><span id="l6.311" class="difflineminus">-                    gFolderDisplay.selectedIndices;</span>
<a href="#l6.312"></a><span id="l6.312" class="difflineplus">+    indices = typeof window.GetSelectedIndices != &quot;undefined&quot; ?</span>
<a href="#l6.313"></a><span id="l6.313" class="difflineplus">+                window.GetSelectedIndices(gDBView) :</span>
<a href="#l6.314"></a><span id="l6.314" class="difflineplus">+                gFolderDisplay.selectedIndices;</span>
<a href="#l6.315"></a><span id="l6.315">     if (!indices || !indices.length)</span>
<a href="#l6.316"></a><span id="l6.316">       return;</span>
<a href="#l6.317"></a><span id="l6.317">   }</span>
<a href="#l6.318"></a><span id="l6.318">   var totalMessages = aAll ? count : indices.length;</span>
<a href="#l6.319"></a><span id="l6.319"> </span>
<a href="#l6.320"></a><span id="l6.320">   // retrieve server and its spam settings via the header of an arbitrary message</span>
<a href="#l6.321"></a><span id="l6.321" class="difflineminus">-  for (var i = 0; i &lt; totalMessages; i++)</span>
<a href="#l6.322"></a><span id="l6.322" class="difflineminus">-  {</span>
<a href="#l6.323"></a><span id="l6.323" class="difflineminus">-    var index = aAll ? i : indices[i];</span>
<a href="#l6.324"></a><span id="l6.324" class="difflineminus">-    try</span>
<a href="#l6.325"></a><span id="l6.325" class="difflineminus">-    {</span>
<a href="#l6.326"></a><span id="l6.326" class="difflineplus">+  for (let i = 0; i &lt; totalMessages; i++) {</span>
<a href="#l6.327"></a><span id="l6.327" class="difflineplus">+    let index = aAll ? i : indices[i];</span>
<a href="#l6.328"></a><span id="l6.328" class="difflineplus">+    try {</span>
<a href="#l6.329"></a><span id="l6.329">       var tmpMsgURI = gDBView.getURIForViewIndex(index);</span>
<a href="#l6.330"></a><span id="l6.330">       break;</span>
<a href="#l6.331"></a><span id="l6.331" class="difflineminus">-    }</span>
<a href="#l6.332"></a><span id="l6.332" class="difflineminus">-    catch (e)</span>
<a href="#l6.333"></a><span id="l6.333" class="difflineminus">-    {</span>
<a href="#l6.334"></a><span id="l6.334" class="difflineplus">+    } catch (e) {</span>
<a href="#l6.335"></a><span id="l6.335">       // dummy headers will fail, so look for another</span>
<a href="#l6.336"></a><span id="l6.336">       continue;</span>
<a href="#l6.337"></a><span id="l6.337">     }</span>
<a href="#l6.338"></a><span id="l6.338">   }</span>
<a href="#l6.339"></a><span id="l6.339">   if (!tmpMsgURI)</span>
<a href="#l6.340"></a><span id="l6.340">     return;</span>
<a href="#l6.341"></a><span id="l6.341"> </span>
<a href="#l6.342"></a><span id="l6.342">   var tmpMsgHdr = messenger.messageServiceFromURI(tmpMsgURI).messageURIToMsgHdr(tmpMsgURI);</span>
<a href="#l6.343"></a><span id="l6.343">   var spamSettings = tmpMsgHdr.folder.server.spamSettings;</span>
<a href="#l6.344"></a><span id="l6.344"> </span>
<a href="#l6.345"></a><span id="l6.345">   // create a classifier instance to classify messages in the folder.</span>
<a href="#l6.346"></a><span id="l6.346">   var msgClassifier = new MessageClassifier(tmpMsgHdr.folder, totalMessages);</span>
<a href="#l6.347"></a><span id="l6.347"> </span>
<a href="#l6.348"></a><span id="l6.348" class="difflineminus">-  for ( i = 0; i &lt; totalMessages; i++)</span>
<a href="#l6.349"></a><span id="l6.349" class="difflineminus">-  {</span>
<a href="#l6.350"></a><span id="l6.350" class="difflineminus">-    var index = aAll ? i : indices[i];</span>
<a href="#l6.351"></a><span id="l6.351" class="difflineminus">-    try</span>
<a href="#l6.352"></a><span id="l6.352" class="difflineminus">-    {</span>
<a href="#l6.353"></a><span id="l6.353" class="difflineplus">+  for (let i = 0; i &lt; totalMessages; i++) {</span>
<a href="#l6.354"></a><span id="l6.354" class="difflineplus">+    let index = aAll ? i : indices[i];</span>
<a href="#l6.355"></a><span id="l6.355" class="difflineplus">+    try {</span>
<a href="#l6.356"></a><span id="l6.356">       var msgURI = gDBView.getURIForViewIndex(index);</span>
<a href="#l6.357"></a><span id="l6.357">       var msgHdr = messenger.messageServiceFromURI(msgURI).messageURIToMsgHdr(msgURI);</span>
<a href="#l6.358"></a><span id="l6.358">       msgClassifier.analyzeMessage(msgHdr, spamSettings);</span>
<a href="#l6.359"></a><span id="l6.359" class="difflineminus">-    }</span>
<a href="#l6.360"></a><span id="l6.360" class="difflineminus">-    catch (ex)</span>
<a href="#l6.361"></a><span id="l6.361" class="difflineminus">-    {</span>
<a href="#l6.362"></a><span id="l6.362" class="difflineplus">+    } catch (ex) {</span>
<a href="#l6.363"></a><span id="l6.363">       // blow off errors here - dummy headers will fail</span>
<a href="#l6.364"></a><span id="l6.364" class="difflineminus">-      var msgURI = null;</span>
<a href="#l6.365"></a><span id="l6.365">     }</span>
<a href="#l6.366"></a><span id="l6.366">   }</span>
<a href="#l6.367"></a><span id="l6.367">   if (msgClassifier.firstMessage) // the async plugin was not used, maybe all whitelisted?</span>
<a href="#l6.368"></a><span id="l6.368">     performActionsOnJunkMsgs(msgClassifier.mFolder,</span>
<a href="#l6.369"></a><span id="l6.369">                              msgClassifier.mJunkMsgHdrs,</span>
<a href="#l6.370"></a><span id="l6.370">                              msgClassifier.mGoodMsgHdrs);</span>
<a href="#l6.371"></a><span id="l6.371"> }</span>
<a href="#l6.372"></a><span id="l6.372"> </span>
<a href="#l6.373"></a><span id="l6.373" class="difflineminus">-function JunkSelectedMessages(setAsJunk)</span>
<a href="#l6.374"></a><span id="l6.374" class="difflineminus">-{</span>
<a href="#l6.375"></a><span id="l6.375" class="difflineplus">+function JunkSelectedMessages(setAsJunk) {</span>
<a href="#l6.376"></a><span id="l6.376">   MsgJunkMailInfo(true);</span>
<a href="#l6.377"></a><span id="l6.377"> </span>
<a href="#l6.378"></a><span id="l6.378">   // When the user explicitly marks a message as junk, we can mark it as read,</span>
<a href="#l6.379"></a><span id="l6.379">   // too. This is independent of the &quot;markAsReadOnSpam&quot; pref, which applies</span>
<a href="#l6.380"></a><span id="l6.380">   // only to automatically-classified messages.</span>
<a href="#l6.381"></a><span id="l6.381">   // Note that this behaviour should match the one in the back end for marking</span>
<a href="#l6.382"></a><span id="l6.382">   // as junk via clicking the 'junk' column.</span>
<a href="#l6.383"></a><span id="l6.383"> </span>
<a href="#l6.384"></a><span id="l6.384" class="difflineat">@@ -366,31 +334,28 @@ function JunkSelectedMessages(setAsJunk)</span>
<a href="#l6.385"></a><span id="l6.385"> }</span>
<a href="#l6.386"></a><span id="l6.386"> </span>
<a href="#l6.387"></a><span id="l6.387"> /**</span>
<a href="#l6.388"></a><span id="l6.388">  * Delete junk messages in the current folder. This provides the guarantee that</span>
<a href="#l6.389"></a><span id="l6.389">  * the method will be synchronous if no messages are deleted.</span>
<a href="#l6.390"></a><span id="l6.390">  *</span>
<a href="#l6.391"></a><span id="l6.391">  * @returns The number of messages deleted.</span>
<a href="#l6.392"></a><span id="l6.392">  */</span>
<a href="#l6.393"></a><span id="l6.393" class="difflineminus">-function deleteJunkInFolder()</span>
<a href="#l6.394"></a><span id="l6.394" class="difflineminus">-{</span>
<a href="#l6.395"></a><span id="l6.395" class="difflineplus">+function deleteJunkInFolder() {</span>
<a href="#l6.396"></a><span id="l6.396">   MsgJunkMailInfo(true);</span>
<a href="#l6.397"></a><span id="l6.397"> </span>
<a href="#l6.398"></a><span id="l6.398">   // use direct folder commands if possible so we don't mess with the selection</span>
<a href="#l6.399"></a><span id="l6.399">   let selectedFolder = gFolderDisplay.displayedFolder;</span>
<a href="#l6.400"></a><span id="l6.400" class="difflineminus">-  if ( !(selectedFolder.flags &amp; Ci.nsMsgFolderFlags.Virtual) )</span>
<a href="#l6.401"></a><span id="l6.401" class="difflineminus">-  {</span>
<a href="#l6.402"></a><span id="l6.402" class="difflineplus">+  if (!selectedFolder.getFlag(Ci.nsMsgFolderFlags.Virtual)) {</span>
<a href="#l6.403"></a><span id="l6.403">     var junkMsgHdrs = Cc[&quot;@mozilla.org/array;1&quot;]</span>
<a href="#l6.404"></a><span id="l6.404">                         .createInstance(Ci.nsIMutableArray);</span>
<a href="#l6.405"></a><span id="l6.405">     var enumerator = gDBView.msgFolder.messages;</span>
<a href="#l6.406"></a><span id="l6.406" class="difflineminus">-    while (enumerator.hasMoreElements())</span>
<a href="#l6.407"></a><span id="l6.407" class="difflineminus">-    {</span>
<a href="#l6.408"></a><span id="l6.408" class="difflineminus">-      var msgHdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l6.409"></a><span id="l6.409" class="difflineminus">-      var junkScore = msgHdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l6.410"></a><span id="l6.410" class="difflineplus">+    while (enumerator.hasMoreElements()) {</span>
<a href="#l6.411"></a><span id="l6.411" class="difflineplus">+      let msgHdr = enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l6.412"></a><span id="l6.412" class="difflineplus">+      let junkScore = msgHdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l6.413"></a><span id="l6.413">       if (junkScore == Ci.nsIJunkMailPlugin.IS_SPAM_SCORE)</span>
<a href="#l6.414"></a><span id="l6.414">         junkMsgHdrs.appendElement(msgHdr);</span>
<a href="#l6.415"></a><span id="l6.415">     }</span>
<a href="#l6.416"></a><span id="l6.416"> </span>
<a href="#l6.417"></a><span id="l6.417">     if (junkMsgHdrs.length)</span>
<a href="#l6.418"></a><span id="l6.418">       gDBView.msgFolder.deleteMessages(junkMsgHdrs, msgWindow, false, false, null, true);</span>
<a href="#l6.419"></a><span id="l6.419">     return junkMsgHdrs.length;</span>
<a href="#l6.420"></a><span id="l6.420">   }</span>
<a href="#l6.421"></a><span id="l6.421" class="difflineat">@@ -407,31 +372,29 @@ function deleteJunkInFolder()</span>
<a href="#l6.422"></a><span id="l6.422"> </span>
<a href="#l6.423"></a><span id="l6.423">   var treeSelection = treeView.selection;</span>
<a href="#l6.424"></a><span id="l6.424"> </span>
<a href="#l6.425"></a><span id="l6.425">   var clearedSelection = false;</span>
<a href="#l6.426"></a><span id="l6.426"> </span>
<a href="#l6.427"></a><span id="l6.427">   // select the junk messages</span>
<a href="#l6.428"></a><span id="l6.428">   var messageUri;</span>
<a href="#l6.429"></a><span id="l6.429">   let numMessagesDeleted = 0;</span>
<a href="#l6.430"></a><span id="l6.430" class="difflineminus">-  for (var i = 0; i &lt; count; ++i)</span>
<a href="#l6.431"></a><span id="l6.431" class="difflineminus">-  {</span>
<a href="#l6.432"></a><span id="l6.432" class="difflineplus">+  for (let i = 0; i &lt; count; ++i) {</span>
<a href="#l6.433"></a><span id="l6.433">     try {</span>
<a href="#l6.434"></a><span id="l6.434">       messageUri = gDBView.getURIForViewIndex(i);</span>
<a href="#l6.435"></a><span id="l6.435" class="difflineplus">+    } catch (ex) {</span>
<a href="#l6.436"></a><span id="l6.436" class="difflineplus">+      continue; // blow off errors for dummy rows</span>
<a href="#l6.437"></a><span id="l6.437">     }</span>
<a href="#l6.438"></a><span id="l6.438" class="difflineminus">-    catch (ex) {continue;} // blow off errors for dummy rows</span>
<a href="#l6.439"></a><span id="l6.439" class="difflineminus">-    var msgHdr = messenger.messageServiceFromURI(messageUri).messageURIToMsgHdr(messageUri);</span>
<a href="#l6.440"></a><span id="l6.440" class="difflineminus">-    var junkScore = msgHdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l6.441"></a><span id="l6.441" class="difflineplus">+    let msgHdr = messenger.messageServiceFromURI(messageUri).messageURIToMsgHdr(messageUri);</span>
<a href="#l6.442"></a><span id="l6.442" class="difflineplus">+    let junkScore = msgHdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l6.443"></a><span id="l6.443">     var isJunk = (junkScore == Ci.nsIJunkMailPlugin.IS_SPAM_SCORE);</span>
<a href="#l6.444"></a><span id="l6.444">     // if the message is junk, select it.</span>
<a href="#l6.445"></a><span id="l6.445" class="difflineminus">-    if (isJunk)</span>
<a href="#l6.446"></a><span id="l6.446" class="difflineminus">-    {</span>
<a href="#l6.447"></a><span id="l6.447" class="difflineplus">+    if (isJunk) {</span>
<a href="#l6.448"></a><span id="l6.448">       // only do this once</span>
<a href="#l6.449"></a><span id="l6.449" class="difflineminus">-      if (!clearedSelection)</span>
<a href="#l6.450"></a><span id="l6.450" class="difflineminus">-      {</span>
<a href="#l6.451"></a><span id="l6.451" class="difflineplus">+      if (!clearedSelection) {</span>
<a href="#l6.452"></a><span id="l6.452">         // clear the current selection</span>
<a href="#l6.453"></a><span id="l6.453">         // since we will be deleting all selected messages</span>
<a href="#l6.454"></a><span id="l6.454">         treeSelection.clearSelection();</span>
<a href="#l6.455"></a><span id="l6.455">         clearedSelection = true;</span>
<a href="#l6.456"></a><span id="l6.456">         treeSelection.selectEventsSuppressed = true;</span>
<a href="#l6.457"></a><span id="l6.457">       }</span>
<a href="#l6.458"></a><span id="l6.458">       treeSelection.rangedSelect(i, i, true /* augment */);</span>
<a href="#l6.459"></a><span id="l6.459">       numMessagesDeleted++;</span>
<a href="#l6.460"></a><span id="l6.460" class="difflineat">@@ -442,15 +405,16 @@ function deleteJunkInFolder()</span>
<a href="#l6.461"></a><span id="l6.461">   // there was no junk, so bail.</span>
<a href="#l6.462"></a><span id="l6.462">   if (!clearedSelection)</span>
<a href="#l6.463"></a><span id="l6.463">     return 0;</span>
<a href="#l6.464"></a><span id="l6.464"> </span>
<a href="#l6.465"></a><span id="l6.465">   treeSelection.selectEventsSuppressed = false;</span>
<a href="#l6.466"></a><span id="l6.466">   // delete the selected messages</span>
<a href="#l6.467"></a><span id="l6.467">   //</span>
<a href="#l6.468"></a><span id="l6.468">   // We'll leave no selection after the delete</span>
<a href="#l6.469"></a><span id="l6.469" class="difflineminus">-  gNextMessageViewIndexAfterDelete = nsMsgViewIndex_None;</span>
<a href="#l6.470"></a><span id="l6.470" class="difflineplus">+  if (&quot;gNextMessageViewIndexAfterDelete&quot; in window) {</span>
<a href="#l6.471"></a><span id="l6.471" class="difflineplus">+    window.gNextMessageViewIndexAfterDelete = nsMsgViewIndex_None;</span>
<a href="#l6.472"></a><span id="l6.472" class="difflineplus">+  }</span>
<a href="#l6.473"></a><span id="l6.473">   gDBView.doCommand(Ci.nsMsgViewCommandType.deleteMsg);</span>
<a href="#l6.474"></a><span id="l6.474">   treeSelection.clearSelection();</span>
<a href="#l6.475"></a><span id="l6.475">   ClearMessagePane();</span>
<a href="#l6.476"></a><span id="l6.476">   return numMessagesDeleted;</span>
<a href="#l6.477"></a><span id="l6.477"> }</span>
<a href="#l6.478"></a><span id="l6.478" class="difflineminus">-</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/content/junkLog.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/content/junkLog.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -3,31 +3,27 @@</span>
<a href="#l7.4"></a><span id="l7.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l7.5"></a><span id="l7.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> var gLogView;</span>
<a href="#l7.10"></a><span id="l7.10"> var gLogFile;</span>
<a href="#l7.11"></a><span id="l7.11"> </span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-function onLoad()</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-{</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+function onLoad() {</span>
<a href="#l7.15"></a><span id="l7.15">   gLogView = document.getElementById(&quot;logView&quot;);</span>
<a href="#l7.16"></a><span id="l7.16">   gLogView.docShell.allowJavascript = false; // for security, disable JS</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18">   gLogFile = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l7.19"></a><span id="l7.19">   gLogFile.append(&quot;junklog.html&quot;);</span>
<a href="#l7.20"></a><span id="l7.20"> </span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-  if (gLogFile.exists())</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-  {</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineplus">+  if (gLogFile.exists()) {</span>
<a href="#l7.24"></a><span id="l7.24">     // convert the file to a URL so we can load it.</span>
<a href="#l7.25"></a><span id="l7.25">     gLogView.setAttribute(&quot;src&quot;, Services.io.newFileURI(gLogFile).spec);</span>
<a href="#l7.26"></a><span id="l7.26">   }</span>
<a href="#l7.27"></a><span id="l7.27"> }</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29" class="difflineminus">-function clearLog()</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-{</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-  if (gLogFile.exists())</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineminus">-  {</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+function clearLog() {</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+  if (gLogFile.exists()) {</span>
<a href="#l7.35"></a><span id="l7.35">     gLogFile.remove(false);</span>
<a href="#l7.36"></a><span id="l7.36">     gLogView.setAttribute(&quot;src&quot;, &quot;about:blank&quot;); // we don't have a log file to show</span>
<a href="#l7.37"></a><span id="l7.37">   }</span>
<a href="#l7.38"></a><span id="l7.38"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/content/markByDate.js</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/content/markByDate.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -1,133 +1,126 @@</span>
<a href="#l8.4"></a><span id="l8.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l8.5"></a><span id="l8.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.7"></a><span id="l8.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9" class="difflineplus">+/* import-globals-from dateFormat.js */</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineplus">+</span>
<a href="#l8.11"></a><span id="l8.11"> var MILLISECONDS_PER_HOUR   = 60 * 60 * 1000;</span>
<a href="#l8.12"></a><span id="l8.12"> var MICROSECONDS_PER_DAY    = 1000 * MILLISECONDS_PER_HOUR * 24;</span>
<a href="#l8.13"></a><span id="l8.13"> </span>
<a href="#l8.14"></a><span id="l8.14"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16" class="difflineminus">-function onLoad()</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineminus">-{</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+function onLoad() {</span>
<a href="#l8.19"></a><span id="l8.19">   var upperDateBox = document.getElementById(&quot;upperDate&quot;);</span>
<a href="#l8.20"></a><span id="l8.20">   // focus the upper bound control - this is where we expect most users to enter</span>
<a href="#l8.21"></a><span id="l8.21">   // a date</span>
<a href="#l8.22"></a><span id="l8.22">   upperDateBox.focus();</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24">   // and give it an initial date - &quot;yesterday&quot;</span>
<a href="#l8.25"></a><span id="l8.25">   var initialDate = new Date();</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineminus">-  initialDate.setHours( 0 );</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineminus">-  initialDate.setTime( initialDate.getTime() - MILLISECONDS_PER_HOUR );</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+  initialDate.setHours(0);</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+  initialDate.setTime(initialDate.getTime() - MILLISECONDS_PER_HOUR);</span>
<a href="#l8.30"></a><span id="l8.30">     // note that this is sufficient - though it is at the end of the previous day,</span>
<a href="#l8.31"></a><span id="l8.31">     // we convert it to a date string, and then the time part is truncated</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineminus">-  upperDateBox.value = convertDateToString( initialDate );</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+  upperDateBox.value = convertDateToString(initialDate);</span>
<a href="#l8.34"></a><span id="l8.34">   upperDateBox.select();  // allows to start overwriting immediately</span>
<a href="#l8.35"></a><span id="l8.35"> }</span>
<a href="#l8.36"></a><span id="l8.36"> </span>
<a href="#l8.37"></a><span id="l8.37" class="difflineminus">-function onAccept()</span>
<a href="#l8.38"></a><span id="l8.38" class="difflineminus">-{</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineplus">+function onAccept() {</span>
<a href="#l8.40"></a><span id="l8.40">   // get the times as entered by the user</span>
<a href="#l8.41"></a><span id="l8.41" class="difflineminus">-  var lowerDateString = document.getElementById( &quot;lowerDate&quot; ).value;</span>
<a href="#l8.42"></a><span id="l8.42" class="difflineplus">+  var lowerDateString = document.getElementById(&quot;lowerDate&quot;).value;</span>
<a href="#l8.43"></a><span id="l8.43">   // the fallback for the lower bound, if not entered, is the &quot;beginning of</span>
<a href="#l8.44"></a><span id="l8.44">   // time&quot; (1970-01-01), which actually is simply 0 :)</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineminus">-  var prLower = lowerDateString ? convertStringToPRTime( lowerDateString ) : 0;</span>
<a href="#l8.46"></a><span id="l8.46" class="difflineplus">+  var prLower = lowerDateString ? convertStringToPRTime(lowerDateString) : 0;</span>
<a href="#l8.47"></a><span id="l8.47"> </span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-  var upperDateString = document.getElementById( &quot;upperDate&quot; ).value;</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+  var upperDateString = document.getElementById(&quot;upperDate&quot;).value;</span>
<a href="#l8.50"></a><span id="l8.50">   var prUpper;</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-  if ( upperDateString == &quot;&quot; )</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineminus">-  {</span>
<a href="#l8.53"></a><span id="l8.53" class="difflineplus">+  if (upperDateString == &quot;&quot;) {</span>
<a href="#l8.54"></a><span id="l8.54">     // for the upper bound, the fallback is &quot;today&quot;.</span>
<a href="#l8.55"></a><span id="l8.55">     var dateThisMorning = new Date();</span>
<a href="#l8.56"></a><span id="l8.56" class="difflineminus">-    dateThisMorning.setMilliseconds( 0 );</span>
<a href="#l8.57"></a><span id="l8.57" class="difflineminus">-    dateThisMorning.setSeconds( 0 );</span>
<a href="#l8.58"></a><span id="l8.58" class="difflineminus">-    dateThisMorning.setMinutes( 0 );</span>
<a href="#l8.59"></a><span id="l8.59" class="difflineminus">-    dateThisMorning.setHours( 0 );</span>
<a href="#l8.60"></a><span id="l8.60" class="difflineplus">+    dateThisMorning.setMilliseconds(0);</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineplus">+    dateThisMorning.setSeconds(0);</span>
<a href="#l8.62"></a><span id="l8.62" class="difflineplus">+    dateThisMorning.setMinutes(0);</span>
<a href="#l8.63"></a><span id="l8.63" class="difflineplus">+    dateThisMorning.setHours(0);</span>
<a href="#l8.64"></a><span id="l8.64">     // Javascript time is in milliseconds, PRTime is in microseconds</span>
<a href="#l8.65"></a><span id="l8.65">     prUpper = dateThisMorning.getTime() * 1000;</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineplus">+  } else {</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineplus">+    prUpper = convertStringToPRTime(upperDateString);</span>
<a href="#l8.68"></a><span id="l8.68">   }</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-  else</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-    prUpper = convertStringToPRTime( upperDateString );</span>
<a href="#l8.71"></a><span id="l8.71"> </span>
<a href="#l8.72"></a><span id="l8.72">   // for the upper date, we have to do a correction:</span>
<a href="#l8.73"></a><span id="l8.73">   // if the user enters a date, then she means (hopefully) that all messages sent</span>
<a href="#l8.74"></a><span id="l8.74">   // at this day should be marked, too, but the PRTime calculated from this would</span>
<a href="#l8.75"></a><span id="l8.75">   // point to the beginning of the day. So we need to increment it by</span>
<a href="#l8.76"></a><span id="l8.76">   // [number of micro seconds per day]. This will denote the first microsecond of</span>
<a href="#l8.77"></a><span id="l8.77">   // the next day then, which is later used as exclusive boundary</span>
<a href="#l8.78"></a><span id="l8.78">   prUpper += MICROSECONDS_PER_DAY;</span>
<a href="#l8.79"></a><span id="l8.79"> </span>
<a href="#l8.80"></a><span id="l8.80" class="difflineminus">-  markInDatabase( prLower, prUpper );</span>
<a href="#l8.81"></a><span id="l8.81" class="difflineplus">+  markInDatabase(prLower, prUpper);</span>
<a href="#l8.82"></a><span id="l8.82"> }</span>
<a href="#l8.83"></a><span id="l8.83"> </span>
<a href="#l8.84"></a><span id="l8.84"> /** marks all headers in the database, whose time is between the two</span>
<a href="#l8.85"></a><span id="l8.85">   given times, as read.</span>
<a href="#l8.86"></a><span id="l8.86">   @param lower</span>
<a href="#l8.87"></a><span id="l8.87">     PRTime for the lower bound - this boundary is inclusive</span>
<a href="#l8.88"></a><span id="l8.88">   @param upper</span>
<a href="#l8.89"></a><span id="l8.89">     PRTime for the upper bound - this boundary is exclusive</span>
<a href="#l8.90"></a><span id="l8.90"> */</span>
<a href="#l8.91"></a><span id="l8.91" class="difflineminus">-function markInDatabase( lower, upper )</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-{</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+function markInDatabase(lower, upper) {</span>
<a href="#l8.94"></a><span id="l8.94">   var messageFolder;</span>
<a href="#l8.95"></a><span id="l8.95">   var messageDatabase;</span>
<a href="#l8.96"></a><span id="l8.96">   // extract the database</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-  if ( window.arguments &amp;&amp; window.arguments[0] )</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineminus">-  {</span>
<a href="#l8.99"></a><span id="l8.99" class="difflineplus">+  if (window.arguments &amp;&amp; window.arguments[0]) {</span>
<a href="#l8.100"></a><span id="l8.100">     messageFolder = window.arguments[0];</span>
<a href="#l8.101"></a><span id="l8.101">     messageDatabase = messageFolder.msgDatabase;</span>
<a href="#l8.102"></a><span id="l8.102">   }</span>
<a href="#l8.103"></a><span id="l8.103"> </span>
<a href="#l8.104"></a><span id="l8.104" class="difflineminus">-  if ( !messageDatabase )</span>
<a href="#l8.105"></a><span id="l8.105" class="difflineminus">-  {</span>
<a href="#l8.106"></a><span id="l8.106" class="difflineminus">-    dump( &quot;markByDate::markInDatabase: there /is/ no database to operate on!\n&quot; );</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+  if (!messageDatabase) {</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+    dump(&quot;markByDate::markInDatabase: there /is/ no database to operate on!\n&quot;);</span>
<a href="#l8.109"></a><span id="l8.109">     return;</span>
<a href="#l8.110"></a><span id="l8.110">   }</span>
<a href="#l8.111"></a><span id="l8.111"> </span>
<a href="#l8.112"></a><span id="l8.112">   // the headers which are going to be marked</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineminus">-  var headers = Cc[&quot;@mozilla.org/array;1&quot;].createInstance( Ci.nsIMutableArray );</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineminus">-  var searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;].createInstance( Ci.nsIMsgSearchSession );</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineminus">-  var searchTerms = Cc[&quot;@mozilla.org/array;1&quot;].createInstance( Ci.nsIMutableArray );</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineminus">-  searchSession.addScopeTerm( Ci.nsMsgSearchScope.offlineMail, messageFolder );</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+  var headers = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+  var searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;].createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+  var searchTerms = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+  searchSession.addScopeTerm(Ci.nsMsgSearchScope.offlineMail, messageFolder);</span>
<a href="#l8.121"></a><span id="l8.121"> </span>
<a href="#l8.122"></a><span id="l8.122">   const nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l8.123"></a><span id="l8.123">   const nsMsgSearchOp = Ci.nsMsgSearchOp;</span>
<a href="#l8.124"></a><span id="l8.124"> </span>
<a href="#l8.125"></a><span id="l8.125">   var searchTerm = searchSession.createTerm();</span>
<a href="#l8.126"></a><span id="l8.126">   searchTerm.attrib = nsMsgSearchAttrib.Date;</span>
<a href="#l8.127"></a><span id="l8.127">   searchTerm.op = nsMsgSearchOp.IsBefore;</span>
<a href="#l8.128"></a><span id="l8.128">   var value = searchTerm.value;</span>
<a href="#l8.129"></a><span id="l8.129">   value.attrib = nsMsgSearchAttrib.Date;</span>
<a href="#l8.130"></a><span id="l8.130">   value.date = upper;</span>
<a href="#l8.131"></a><span id="l8.131">   searchTerm.value = value;</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineminus">-  searchTerms.appendElement( searchTerm );</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+  searchTerms.appendElement(searchTerm);</span>
<a href="#l8.134"></a><span id="l8.134"> </span>
<a href="#l8.135"></a><span id="l8.135" class="difflineminus">-  if ( lower )</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineminus">-  {</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+  if (lower) {</span>
<a href="#l8.138"></a><span id="l8.138">     searchTerm = searchSession.createTerm();</span>
<a href="#l8.139"></a><span id="l8.139">     searchTerm.booleanAnd = true;</span>
<a href="#l8.140"></a><span id="l8.140">     searchTerm.attrib = nsMsgSearchAttrib.Date;</span>
<a href="#l8.141"></a><span id="l8.141">     searchTerm.op = nsMsgSearchOp.IsAfter;</span>
<a href="#l8.142"></a><span id="l8.142">     value = searchTerm.value;</span>
<a href="#l8.143"></a><span id="l8.143">     value.attrib = nsMsgSearchAttrib.Date;</span>
<a href="#l8.144"></a><span id="l8.144">     value.date = lower;</span>
<a href="#l8.145"></a><span id="l8.145">     searchTerm.value = value;</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineminus">-    searchTerms.appendElement( searchTerm );</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+    searchTerms.appendElement(searchTerm);</span>
<a href="#l8.148"></a><span id="l8.148">   }</span>
<a href="#l8.149"></a><span id="l8.149"> </span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-  var filterEnumerator = messageDatabase.getFilterEnumerator( searchTerms );</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+  var filterEnumerator = messageDatabase.getFilterEnumerator(searchTerms);</span>
<a href="#l8.152"></a><span id="l8.152"> </span>
<a href="#l8.153"></a><span id="l8.153" class="difflineminus">-  if ( filterEnumerator )</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineminus">-  {</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+  if (filterEnumerator) {</span>
<a href="#l8.156"></a><span id="l8.156">     var keepGoing;</span>
<a href="#l8.157"></a><span id="l8.157">     var numMatches = {};</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineminus">-    do</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineminus">-    {</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+    do {</span>
<a href="#l8.161"></a><span id="l8.161">       keepGoing = messageDatabase.nextMatchingHdrs(filterEnumerator, 0, 0, headers, numMatches);</span>
<a href="#l8.162"></a><span id="l8.162">     }</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineminus">-    while ( keepGoing );</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+    while (keepGoing);</span>
<a href="#l8.165"></a><span id="l8.165">   }</span>
<a href="#l8.166"></a><span id="l8.166"> </span>
<a href="#l8.167"></a><span id="l8.167" class="difflineminus">-  if ( headers.length )</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineminus">-    messageFolder.markMessagesRead( headers, true );</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+  if (headers.length)</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+    messageFolder.markMessagesRead(headers, true);</span>
<a href="#l8.171"></a><span id="l8.171"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/content/msgAccountCentral.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/content/msgAccountCentral.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,19 +1,22 @@</span>
<a href="#l9.4"></a><span id="l9.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l9.5"></a><span id="l9.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.6"></a><span id="l9.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.7"></a><span id="l9.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.8"></a><span id="l9.8"> </span>
<a href="#l9.9"></a><span id="l9.9" class="difflineplus">+/* import-globals-from ../../../mail/base/content/mailCore.js */</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineplus">+/* import-globals-from ../prefs/content/AccountManager.js */</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineplus">+/* import-globals-from ../prefs/content/accountUtils.js */</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+</span>
<a href="#l9.13"></a><span id="l9.13"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l9.14"></a><span id="l9.14"> </span>
<a href="#l9.15"></a><span id="l9.15"> var selectedServer = null;</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-function OnInit()</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-{</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+function OnInit() {</span>
<a href="#l9.20"></a><span id="l9.20">     // Set the header for the page.</span>
<a href="#l9.21"></a><span id="l9.21">     // Title contains the brand name of the application and the account</span>
<a href="#l9.22"></a><span id="l9.22">     // type (mail/news) and the name of the account</span>
<a href="#l9.23"></a><span id="l9.23">     try {</span>
<a href="#l9.24"></a><span id="l9.24">         let msgFolder    = null;</span>
<a href="#l9.25"></a><span id="l9.25">         let title;</span>
<a href="#l9.26"></a><span id="l9.26"> </span>
<a href="#l9.27"></a><span id="l9.27">         // Get the brand name</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineat">@@ -47,71 +50,70 @@ function OnInit()</span>
<a href="#l9.29"></a><span id="l9.29">           title = brandName;</span>
<a href="#l9.30"></a><span id="l9.30">           SetItemDisplay(&quot;AccountsHeader&quot;, true);</span>
<a href="#l9.31"></a><span id="l9.31">           SetItemDisplay(&quot;CreateAccount&quot;, true);</span>
<a href="#l9.32"></a><span id="l9.32">           SetItemDisplay(&quot;CreateAccounts&quot;, true);</span>
<a href="#l9.33"></a><span id="l9.33">         }</span>
<a href="#l9.34"></a><span id="l9.34"> </span>
<a href="#l9.35"></a><span id="l9.35">         // Set the title for the document</span>
<a href="#l9.36"></a><span id="l9.36">         document.getElementById(&quot;AccountCentralTitle&quot;).setAttribute(&quot;value&quot;, title);</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-    }</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-    catch(ex) {</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+    } catch (ex) {</span>
<a href="#l9.40"></a><span id="l9.40">         Cu.reportError(&quot;Error getting selected account: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l9.41"></a><span id="l9.41">     }</span>
<a href="#l9.42"></a><span id="l9.42"> }</span>
<a href="#l9.43"></a><span id="l9.43"> </span>
<a href="#l9.44"></a><span id="l9.44"> // Show items in the AccountCentral page depending on the capabilities</span>
<a href="#l9.45"></a><span id="l9.45"> // of the given account</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineminus">-function ArrangeAccountCentralItems(server, msgFolder)</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineminus">-{</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+/* eslint-disable complexity */</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+function ArrangeAccountCentralItems(server, msgFolder) {</span>
<a href="#l9.50"></a><span id="l9.50">     let exceptions = [];</span>
<a href="#l9.51"></a><span id="l9.51">     let protocolInfo = null;</span>
<a href="#l9.52"></a><span id="l9.52">     try {</span>
<a href="#l9.53"></a><span id="l9.53">       protocolInfo = server.protocolInfo;</span>
<a href="#l9.54"></a><span id="l9.54">     } catch (e) {</span>
<a href="#l9.55"></a><span id="l9.55">       exceptions.push(e);</span>
<a href="#l9.56"></a><span id="l9.56">     }</span>
<a href="#l9.57"></a><span id="l9.57"> </span>
<a href="#l9.58"></a><span id="l9.58">     // Is this a RSS account?</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineminus">-    let displayRssHeader = server &amp;&amp; server.type == 'rss';</span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+    let displayRssHeader = server &amp;&amp; server.type == &quot;rss&quot;;</span>
<a href="#l9.61"></a><span id="l9.61"> </span>
<a href="#l9.62"></a><span id="l9.62" class="difflineminus">-    /***** Email header and items : Begin *****/</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+    /* Email header and items : Begin */</span>
<a href="#l9.64"></a><span id="l9.64"> </span>
<a href="#l9.65"></a><span id="l9.65">     // Read Messages</span>
<a href="#l9.66"></a><span id="l9.66">     let canGetMessages = false;</span>
<a href="#l9.67"></a><span id="l9.67">     try {</span>
<a href="#l9.68"></a><span id="l9.68">         canGetMessages = protocolInfo &amp;&amp; protocolInfo.canGetMessages;</span>
<a href="#l9.69"></a><span id="l9.69">         SetItemDisplay(&quot;ReadMessages&quot;, canGetMessages &amp;&amp; !displayRssHeader);</span>
<a href="#l9.70"></a><span id="l9.70">     } catch (e) { exceptions.push(e); }</span>
<a href="#l9.71"></a><span id="l9.71"> </span>
<a href="#l9.72"></a><span id="l9.72">     // Compose Messages link</span>
<a href="#l9.73"></a><span id="l9.73">     let showComposeMsgLink = false;</span>
<a href="#l9.74"></a><span id="l9.74">     try {</span>
<a href="#l9.75"></a><span id="l9.75">         showComposeMsgLink = protocolInfo &amp;&amp; protocolInfo.showComposeMsgLink;</span>
<a href="#l9.76"></a><span id="l9.76">         SetItemDisplay(&quot;ComposeMessage&quot;, showComposeMsgLink);</span>
<a href="#l9.77"></a><span id="l9.77">     } catch (e) { exceptions.push(e); }</span>
<a href="#l9.78"></a><span id="l9.78"> </span>
<a href="#l9.79"></a><span id="l9.79">     // Junk mail settings (false, until ready for prime time)</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineminus">-    let canControlJunkEmail = false</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+    let canControlJunkEmail = false;</span>
<a href="#l9.82"></a><span id="l9.82">     try {</span>
<a href="#l9.83"></a><span id="l9.83">         canControlJunkEmail = false &amp;&amp; protocolInfo &amp;&amp;</span>
<a href="#l9.84"></a><span id="l9.84">                               protocolInfo.canGetIncomingMessages &amp;&amp;</span>
<a href="#l9.85"></a><span id="l9.85">                               protocolInfo.canGetMessages;</span>
<a href="#l9.86"></a><span id="l9.86">         SetItemDisplay(&quot;JunkSettingsMail&quot;, canControlJunkEmail);</span>
<a href="#l9.87"></a><span id="l9.87">     } catch (e) { exceptions.push(e); }</span>
<a href="#l9.88"></a><span id="l9.88"> </span>
<a href="#l9.89"></a><span id="l9.89">     // Display Email header, only if any of the items are displayed</span>
<a href="#l9.90"></a><span id="l9.90">     let displayEmailHeader = !displayRssHeader &amp;&amp;</span>
<a href="#l9.91"></a><span id="l9.91">                              (canGetMessages || showComposeMsgLink ||</span>
<a href="#l9.92"></a><span id="l9.92">                               canControlJunkEmail);</span>
<a href="#l9.93"></a><span id="l9.93">     SetItemDisplay(&quot;EmailHeader&quot;, displayEmailHeader);</span>
<a href="#l9.94"></a><span id="l9.94"> </span>
<a href="#l9.95"></a><span id="l9.95" class="difflineminus">-    /***** Email header and items : End *****/</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineplus">+    /* Email header and items : End */</span>
<a href="#l9.97"></a><span id="l9.97"> </span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-    /***** News header and items : Begin *****/</span>
<a href="#l9.99"></a><span id="l9.99" class="difflineplus">+    /* News header and items : Begin */</span>
<a href="#l9.100"></a><span id="l9.100"> </span>
<a href="#l9.101"></a><span id="l9.101">     // Subscribe to Newsgroups</span>
<a href="#l9.102"></a><span id="l9.102">     let canSubscribe = false;</span>
<a href="#l9.103"></a><span id="l9.103">     try {</span>
<a href="#l9.104"></a><span id="l9.104">         canSubscribe = msgFolder &amp;&amp; msgFolder.canSubscribe &amp;&amp;</span>
<a href="#l9.105"></a><span id="l9.105">                        protocolInfo &amp;&amp; !protocolInfo.canGetMessages;</span>
<a href="#l9.106"></a><span id="l9.106">         SetItemDisplay(&quot;SubscribeNewsgroups&quot;, canSubscribe);</span>
<a href="#l9.107"></a><span id="l9.107">     } catch (e) { exceptions.push(e); }</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineat">@@ -124,54 +126,53 @@ function ArrangeAccountCentralItems(serv</span>
<a href="#l9.109"></a><span id="l9.109">                              !protocolInfo.canGetMessages;</span>
<a href="#l9.110"></a><span id="l9.110">         SetItemDisplay(&quot;JunkSettingsNews&quot;, canControlJunkNews);</span>
<a href="#l9.111"></a><span id="l9.111">     } catch (e) { exceptions.push(e); }</span>
<a href="#l9.112"></a><span id="l9.112"> </span>
<a href="#l9.113"></a><span id="l9.113">     // Display News header, only if any of the items are displayed</span>
<a href="#l9.114"></a><span id="l9.114">     let displayNewsHeader = canSubscribe || canControlJunkNews;</span>
<a href="#l9.115"></a><span id="l9.115">     SetItemDisplay(&quot;NewsHeader&quot;, displayNewsHeader);</span>
<a href="#l9.116"></a><span id="l9.116"> </span>
<a href="#l9.117"></a><span id="l9.117" class="difflineminus">-    /***** News header and items : End *****/</span>
<a href="#l9.118"></a><span id="l9.118" class="difflineplus">+    /* News header and items : End */</span>
<a href="#l9.119"></a><span id="l9.119"> </span>
<a href="#l9.120"></a><span id="l9.120" class="difflineminus">-    /***** RSS header and items : Begin *****/</span>
<a href="#l9.121"></a><span id="l9.121" class="difflineplus">+    /* RSS header and items : Begin */</span>
<a href="#l9.122"></a><span id="l9.122"> </span>
<a href="#l9.123"></a><span id="l9.123">     // Display RSS header, only if this is RSS account</span>
<a href="#l9.124"></a><span id="l9.124">     SetItemDisplay(&quot;rssHeader&quot;, displayRssHeader);</span>
<a href="#l9.125"></a><span id="l9.125"> </span>
<a href="#l9.126"></a><span id="l9.126">     // Subscribe to RSS Feeds</span>
<a href="#l9.127"></a><span id="l9.127">     SetItemDisplay(&quot;SubscribeRSS&quot;, displayRssHeader);</span>
<a href="#l9.128"></a><span id="l9.128"> </span>
<a href="#l9.129"></a><span id="l9.129" class="difflineminus">-    /***** RSS header and items : End *****/</span>
<a href="#l9.130"></a><span id="l9.130" class="difflineplus">+    /* RSS header and items : End */</span>
<a href="#l9.131"></a><span id="l9.131"> </span>
<a href="#l9.132"></a><span id="l9.132">     // If either of above sections exists, show section separators</span>
<a href="#l9.133"></a><span id="l9.133">     SetItemDisplay(&quot;MessagesSection&quot;,</span>
<a href="#l9.134"></a><span id="l9.134">                    displayNewsHeader || displayEmailHeader || displayRssHeader);</span>
<a href="#l9.135"></a><span id="l9.135"> </span>
<a href="#l9.136"></a><span id="l9.136" class="difflineminus">-    /***** Accounts : Begin *****/</span>
<a href="#l9.137"></a><span id="l9.137" class="difflineplus">+    /* Accounts : Begin */</span>
<a href="#l9.138"></a><span id="l9.138"> </span>
<a href="#l9.139"></a><span id="l9.139">     // Account Settings if a server is found</span>
<a href="#l9.140"></a><span id="l9.140">     let canShowAccountSettings = server != null;</span>
<a href="#l9.141"></a><span id="l9.141">     SetItemDisplay(&quot;AccountSettings&quot;, canShowAccountSettings);</span>
<a href="#l9.142"></a><span id="l9.142"> </span>
<a href="#l9.143"></a><span id="l9.143">     // Show New Mail Account Wizard if not prohibited by pref</span>
<a href="#l9.144"></a><span id="l9.144">     let canShowCreateAccount = false;</span>
<a href="#l9.145"></a><span id="l9.145">     try {</span>
<a href="#l9.146"></a><span id="l9.146">         canShowCreateAccount = !Services.prefs</span>
<a href="#l9.147"></a><span id="l9.147">           .prefIsLocked(&quot;mail.disable_new_account_addition&quot;);</span>
<a href="#l9.148"></a><span id="l9.148">         SetItemDisplay(&quot;CreateAccount&quot;, canShowCreateAccount);</span>
<a href="#l9.149"></a><span id="l9.149">         SetItemDisplay(&quot;CreateAccounts&quot;, canShowCreateAccount);</span>
<a href="#l9.150"></a><span id="l9.150">     } catch (e) { exceptions.push(e); }</span>
<a href="#l9.151"></a><span id="l9.151"> </span>
<a href="#l9.152"></a><span id="l9.152">     // Display Accounts header, only if any of the items are displayed</span>
<a href="#l9.153"></a><span id="l9.153" class="difflineminus">-    let displayAccountsHeader = canShowAccountSettings || canShowCreateAccount;</span>
<a href="#l9.154"></a><span id="l9.154">     SetItemDisplay(&quot;AccountsHeader&quot;, canShowCreateAccount);</span>
<a href="#l9.155"></a><span id="l9.155"> </span>
<a href="#l9.156"></a><span id="l9.156" class="difflineminus">-    /***** Accounts : End *****/</span>
<a href="#l9.157"></a><span id="l9.157" class="difflineplus">+    /* Accounts : End */</span>
<a href="#l9.158"></a><span id="l9.158"> </span>
<a href="#l9.159"></a><span id="l9.159" class="difflineminus">-    /***** Advanced Features header and items : Begin *****/</span>
<a href="#l9.160"></a><span id="l9.160" class="difflineplus">+    /* Advanced Features header and items : Begin */</span>
<a href="#l9.161"></a><span id="l9.161"> </span>
<a href="#l9.162"></a><span id="l9.162">     // Search Messages</span>
<a href="#l9.163"></a><span id="l9.163">     let canSearchMessages = false;</span>
<a href="#l9.164"></a><span id="l9.164">     try {</span>
<a href="#l9.165"></a><span id="l9.165">         canSearchMessages = server &amp;&amp; server.canSearchMessages;</span>
<a href="#l9.166"></a><span id="l9.166">         SetItemDisplay(&quot;SearchMessages&quot;, canSearchMessages);</span>
<a href="#l9.167"></a><span id="l9.167">     } catch (e) { exceptions.push(e); }</span>
<a href="#l9.168"></a><span id="l9.168"> </span>
<a href="#l9.169"></a><span id="l9.169" class="difflineat">@@ -194,102 +195,94 @@ function ArrangeAccountCentralItems(serv</span>
<a href="#l9.170"></a><span id="l9.170">     let supportsOffline = false;</span>
<a href="#l9.171"></a><span id="l9.171">     try {</span>
<a href="#l9.172"></a><span id="l9.172">         supportsOffline = server &amp;&amp; server.offlineSupportLevel != 0;</span>
<a href="#l9.173"></a><span id="l9.173">         SetItemDisplay(&quot;OfflineSettings&quot;, supportsOffline);</span>
<a href="#l9.174"></a><span id="l9.174">     } catch (e) { exceptions.push(e); }</span>
<a href="#l9.175"></a><span id="l9.175"> </span>
<a href="#l9.176"></a><span id="l9.176">     // Display Adv Features header, only if any of the items are displayed</span>
<a href="#l9.177"></a><span id="l9.177">     let displayAdvFeatures = canSearchMessages || canHaveFilters ||</span>
<a href="#l9.178"></a><span id="l9.178" class="difflineminus">-                             canSubscribeImapFolders|| supportsOffline;</span>
<a href="#l9.179"></a><span id="l9.179" class="difflineplus">+                             canSubscribeImapFolders || supportsOffline;</span>
<a href="#l9.180"></a><span id="l9.180">     SetItemDisplay(&quot;AdvancedFeaturesHeader&quot;, displayAdvFeatures);</span>
<a href="#l9.181"></a><span id="l9.181"> </span>
<a href="#l9.182"></a><span id="l9.182" class="difflineminus">-    /***** Advanced Featuers header and items : End *****/</span>
<a href="#l9.183"></a><span id="l9.183" class="difflineplus">+    /* Advanced Featuers header and items : End */</span>
<a href="#l9.184"></a><span id="l9.184"> </span>
<a href="#l9.185"></a><span id="l9.185">     // If either of above features exist, show section separators</span>
<a href="#l9.186"></a><span id="l9.186">     SetItemDisplay(&quot;AccountsSection&quot;, displayAdvFeatures);</span>
<a href="#l9.187"></a><span id="l9.187"> </span>
<a href="#l9.188"></a><span id="l9.188">     while (exceptions.length) {</span>
<a href="#l9.189"></a><span id="l9.189">         Cu.reportError(&quot;Error in setting AccountCentral Items: &quot;</span>
<a href="#l9.190"></a><span id="l9.190">             + exceptions.pop() + &quot;\n&quot;);</span>
<a href="#l9.191"></a><span id="l9.191">     }</span>
<a href="#l9.192"></a><span id="l9.192"> }</span>
<a href="#l9.193"></a><span id="l9.193" class="difflineplus">+/* eslint-enable complexity */</span>
<a href="#l9.194"></a><span id="l9.194"> </span>
<a href="#l9.195"></a><span id="l9.195"> // Show the item if the item feature is supported</span>
<a href="#l9.196"></a><span id="l9.196" class="difflineminus">-function SetItemDisplay(elemId, displayThisItem)</span>
<a href="#l9.197"></a><span id="l9.197" class="difflineminus">-{</span>
<a href="#l9.198"></a><span id="l9.198" class="difflineplus">+function SetItemDisplay(elemId, displayThisItem) {</span>
<a href="#l9.199"></a><span id="l9.199">     if (displayThisItem) {</span>
<a href="#l9.200"></a><span id="l9.200">         let elem = document.getElementById(elemId);</span>
<a href="#l9.201"></a><span id="l9.201">         if (elem)</span>
<a href="#l9.202"></a><span id="l9.202">             elem.setAttribute(&quot;collapsed&quot;, false);</span>
<a href="#l9.203"></a><span id="l9.203"> </span>
<a href="#l9.204"></a><span id="l9.204">         let elemSpacer = document.getElementById(elemId + &quot;.spacer&quot;);</span>
<a href="#l9.205"></a><span id="l9.205">         if (elemSpacer)</span>
<a href="#l9.206"></a><span id="l9.206">             elemSpacer.setAttribute(&quot;collapsed&quot;, false);</span>
<a href="#l9.207"></a><span id="l9.207">     }</span>
<a href="#l9.208"></a><span id="l9.208"> }</span>
<a href="#l9.209"></a><span id="l9.209"> </span>
<a href="#l9.210"></a><span id="l9.210"> // From the current folder tree, return the selected server or null</span>
<a href="#l9.211"></a><span id="l9.211" class="difflineminus">-function GetSelectedServer()</span>
<a href="#l9.212"></a><span id="l9.212" class="difflineminus">-{</span>
<a href="#l9.213"></a><span id="l9.213" class="difflineplus">+function GetSelectedServer() {</span>
<a href="#l9.214"></a><span id="l9.214">     let currentFolder = GetSelectedMsgFolder();</span>
<a href="#l9.215"></a><span id="l9.215">     return currentFolder ? currentFolder.server : null;</span>
<a href="#l9.216"></a><span id="l9.216"> }</span>
<a href="#l9.217"></a><span id="l9.217"> </span>
<a href="#l9.218"></a><span id="l9.218"> // From the current folder tree, return the selected folder,</span>
<a href="#l9.219"></a><span id="l9.219"> // the root folder of default account or null</span>
<a href="#l9.220"></a><span id="l9.220" class="difflineminus">-function GetSelectedMsgFolder()</span>
<a href="#l9.221"></a><span id="l9.221" class="difflineminus">-{</span>
<a href="#l9.222"></a><span id="l9.222" class="difflineplus">+function GetSelectedMsgFolder() {</span>
<a href="#l9.223"></a><span id="l9.223">     return window.parent.GetSelectedMsgFolders()[0] ||</span>
<a href="#l9.224"></a><span id="l9.224">            window.parent.GetDefaultAccountRootFolder();</span>
<a href="#l9.225"></a><span id="l9.225"> }</span>
<a href="#l9.226"></a><span id="l9.226"> </span>
<a href="#l9.227"></a><span id="l9.227"> /**</span>
<a href="#l9.228"></a><span id="l9.228">  * Open Inbox for selected server.</span>
<a href="#l9.229"></a><span id="l9.229">  * If needed, open the twisty and select Inbox.</span>
<a href="#l9.230"></a><span id="l9.230">  */</span>
<a href="#l9.231"></a><span id="l9.231" class="difflineminus">-function ReadMessages()</span>
<a href="#l9.232"></a><span id="l9.232" class="difflineminus">-{</span>
<a href="#l9.233"></a><span id="l9.233" class="difflineplus">+function ReadMessages() {</span>
<a href="#l9.234"></a><span id="l9.234">     if (!selectedServer)</span>
<a href="#l9.235"></a><span id="l9.235">         return;</span>
<a href="#l9.236"></a><span id="l9.236">     try {</span>
<a href="#l9.237"></a><span id="l9.237">         window.parent.OpenInboxForServer(selectedServer);</span>
<a href="#l9.238"></a><span id="l9.238" class="difflineminus">-    }</span>
<a href="#l9.239"></a><span id="l9.239" class="difflineminus">-    catch(ex) {</span>
<a href="#l9.240"></a><span id="l9.240" class="difflineplus">+    } catch (ex) {</span>
<a href="#l9.241"></a><span id="l9.241">         Cu.reportError(&quot;Error opening Inbox for server: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l9.242"></a><span id="l9.242">     }</span>
<a href="#l9.243"></a><span id="l9.243"> }</span>
<a href="#l9.244"></a><span id="l9.244"> </span>
<a href="#l9.245"></a><span id="l9.245"> // Trigger composer for a new message</span>
<a href="#l9.246"></a><span id="l9.246" class="difflineminus">-function ComposeAMessage(event)</span>
<a href="#l9.247"></a><span id="l9.247" class="difflineminus">-{</span>
<a href="#l9.248"></a><span id="l9.248" class="difflineplus">+function ComposeAMessage(event) {</span>
<a href="#l9.249"></a><span id="l9.249">     // Pass event to allow holding Shift key for toggling HTML vs. plaintext format</span>
<a href="#l9.250"></a><span id="l9.250">     window.parent.MsgNewMessage(event);</span>
<a href="#l9.251"></a><span id="l9.251"> }</span>
<a href="#l9.252"></a><span id="l9.252"> </span>
<a href="#l9.253"></a><span id="l9.253"> /**</span>
<a href="#l9.254"></a><span id="l9.254">  * Open AccountManager to view settings for a given account</span>
<a href="#l9.255"></a><span id="l9.255">  * @param selectPage  the xul file name for the viewing page,</span>
<a href="#l9.256"></a><span id="l9.256">  *                    null for the account main page, other pages are</span>
<a href="#l9.257"></a><span id="l9.257">  *                    'am-server.xul', 'am-copies.xul', 'am-offline.xul',</span>
<a href="#l9.258"></a><span id="l9.258">  *                    'am-addressing.xul', 'am-smtp.xul'</span>
<a href="#l9.259"></a><span id="l9.259">  */</span>
<a href="#l9.260"></a><span id="l9.260" class="difflineminus">-function ViewSettings(selectPage)</span>
<a href="#l9.261"></a><span id="l9.261" class="difflineminus">-{</span>
<a href="#l9.262"></a><span id="l9.262" class="difflineplus">+function ViewSettings(selectPage) {</span>
<a href="#l9.263"></a><span id="l9.263">     window.parent.MsgAccountManager(selectPage);</span>
<a href="#l9.264"></a><span id="l9.264"> }</span>
<a href="#l9.265"></a><span id="l9.265"> </span>
<a href="#l9.266"></a><span id="l9.266"> // Open AccountWizard to create an account</span>
<a href="#l9.267"></a><span id="l9.267" class="difflineminus">-function CreateNewAccount()</span>
<a href="#l9.268"></a><span id="l9.268" class="difflineminus">-{</span>
<a href="#l9.269"></a><span id="l9.269" class="difflineplus">+function CreateNewAccount() {</span>
<a href="#l9.270"></a><span id="l9.270">     window.parent.msgOpenAccountWizard();</span>
<a href="#l9.271"></a><span id="l9.271"> }</span>
<a href="#l9.272"></a><span id="l9.272"> </span>
<a href="#l9.273"></a><span id="l9.273" class="difflineminus">-function CreateNewAccountTB(type)</span>
<a href="#l9.274"></a><span id="l9.274" class="difflineminus">-{</span>
<a href="#l9.275"></a><span id="l9.275" class="difflineplus">+function CreateNewAccountTB(type) {</span>
<a href="#l9.276"></a><span id="l9.276">   if (type == &quot;mail&quot;) {</span>
<a href="#l9.277"></a><span id="l9.277">     AddMailAccount();</span>
<a href="#l9.278"></a><span id="l9.278">     return;</span>
<a href="#l9.279"></a><span id="l9.279">   }</span>
<a href="#l9.280"></a><span id="l9.280"> </span>
<a href="#l9.281"></a><span id="l9.281">   if (type == &quot;feeds&quot;) {</span>
<a href="#l9.282"></a><span id="l9.282">     AddFeedAccount();</span>
<a href="#l9.283"></a><span id="l9.283">     return;</span>
<a href="#l9.284"></a><span id="l9.284" class="difflineat">@@ -302,36 +295,32 @@ function CreateNewAccountTB(type)</span>
<a href="#l9.285"></a><span id="l9.285">           win.gFolderTreeView.selectFolder(</span>
<a href="#l9.286"></a><span id="l9.286">               this.gCurrentAccount.incomingServer.rootMsgFolder);</span>
<a href="#l9.287"></a><span id="l9.287">         }</span>
<a href="#l9.288"></a><span id="l9.288">       },</span>
<a href="#l9.289"></a><span id="l9.289">       type);</span>
<a href="#l9.290"></a><span id="l9.290"> }</span>
<a href="#l9.291"></a><span id="l9.291"> </span>
<a href="#l9.292"></a><span id="l9.292"> // Bring up search interface for selected account</span>
<a href="#l9.293"></a><span id="l9.293" class="difflineminus">-function SearchMessages()</span>
<a href="#l9.294"></a><span id="l9.294" class="difflineminus">-{</span>
<a href="#l9.295"></a><span id="l9.295" class="difflineplus">+function SearchMessages() {</span>
<a href="#l9.296"></a><span id="l9.296">     window.parent.MsgSearchMessages();</span>
<a href="#l9.297"></a><span id="l9.297"> }</span>
<a href="#l9.298"></a><span id="l9.298"> </span>
<a href="#l9.299"></a><span id="l9.299"> // Open filters window</span>
<a href="#l9.300"></a><span id="l9.300" class="difflineminus">-function CreateMsgFilters()</span>
<a href="#l9.301"></a><span id="l9.301" class="difflineminus">-{</span>
<a href="#l9.302"></a><span id="l9.302" class="difflineplus">+function CreateMsgFilters() {</span>
<a href="#l9.303"></a><span id="l9.303">     window.parent.MsgFilters(null, null);</span>
<a href="#l9.304"></a><span id="l9.304"> }</span>
<a href="#l9.305"></a><span id="l9.305"> </span>
<a href="#l9.306"></a><span id="l9.306"> // Open Subscribe dialog</span>
<a href="#l9.307"></a><span id="l9.307" class="difflineminus">-function Subscribe()</span>
<a href="#l9.308"></a><span id="l9.308" class="difflineminus">-{</span>
<a href="#l9.309"></a><span id="l9.309" class="difflineplus">+function Subscribe() {</span>
<a href="#l9.310"></a><span id="l9.310">     if (!selectedServer)</span>
<a href="#l9.311"></a><span id="l9.311">         return;</span>
<a href="#l9.312"></a><span id="l9.312" class="difflineminus">-    if (selectedServer.type == 'rss')</span>
<a href="#l9.313"></a><span id="l9.313" class="difflineplus">+    if (selectedServer.type == &quot;rss&quot;)</span>
<a href="#l9.314"></a><span id="l9.314">         window.parent.openSubscriptionsDialog(selectedServer.rootFolder);</span>
<a href="#l9.315"></a><span id="l9.315">     else</span>
<a href="#l9.316"></a><span id="l9.316">         window.parent.MsgSubscribe();</span>
<a href="#l9.317"></a><span id="l9.317"> }</span>
<a href="#l9.318"></a><span id="l9.318"> </span>
<a href="#l9.319"></a><span id="l9.319"> // Open junk mail settings dialog</span>
<a href="#l9.320"></a><span id="l9.320" class="difflineminus">-function JunkSettings()</span>
<a href="#l9.321"></a><span id="l9.321" class="difflineminus">-{</span>
<a href="#l9.322"></a><span id="l9.322" class="difflineplus">+function JunkSettings() {</span>
<a href="#l9.323"></a><span id="l9.323">     // TODO: function does not exist yet, will throw an exception if exposed</span>
<a href="#l9.324"></a><span id="l9.324">     window.parent.MsgJunkMail();</span>
<a href="#l9.325"></a><span id="l9.325"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/content/msgFolderPickerOverlay.js</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/content/msgFolderPickerOverlay.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -3,97 +3,92 @@</span>
<a href="#l10.4"></a><span id="l10.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.5"></a><span id="l10.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.6"></a><span id="l10.6"> </span>
<a href="#l10.7"></a><span id="l10.7"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l10.8"></a><span id="l10.8"> </span>
<a href="#l10.9"></a><span id="l10.9"> var gMessengerBundle;</span>
<a href="#l10.10"></a><span id="l10.10"> </span>
<a href="#l10.11"></a><span id="l10.11"> // call this from dialog onload() to set the menu item to the correct value</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-function MsgFolderPickerOnLoad(pickerID)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-{</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+function MsgFolderPickerOnLoad(pickerID) {</span>
<a href="#l10.15"></a><span id="l10.15">   var uri = null;</span>
<a href="#l10.16"></a><span id="l10.16">   try {</span>
<a href="#l10.17"></a><span id="l10.17">     uri = window.arguments[0].preselectedURI;</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-  }</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-  catch (ex) {</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineplus">+  } catch (ex) {</span>
<a href="#l10.21"></a><span id="l10.21">     uri = null;</span>
<a href="#l10.22"></a><span id="l10.22">   }</span>
<a href="#l10.23"></a><span id="l10.23"> </span>
<a href="#l10.24"></a><span id="l10.24">   if (uri) {</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-    //dump(&quot;on loading, set titled button to &quot; + uri + &quot;\n&quot;);</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineplus">+    // dump(&quot;on loading, set titled button to &quot; + uri + &quot;\n&quot;);</span>
<a href="#l10.27"></a><span id="l10.27"> </span>
<a href="#l10.28"></a><span id="l10.28">     // verify that the value we are attempting to</span>
<a href="#l10.29"></a><span id="l10.29">     // pre-flight the menu with is valid for this</span>
<a href="#l10.30"></a><span id="l10.30">     // picker type</span>
<a href="#l10.31"></a><span id="l10.31">     var msgfolder = MailUtils.getExistingFolder(uri);</span>
<a href="#l10.32"></a><span id="l10.32">           if (!msgfolder) return;</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-    </span>
<a href="#l10.34"></a><span id="l10.34" class="difflineplus">+</span>
<a href="#l10.35"></a><span id="l10.35">     var verifyFunction = null;</span>
<a href="#l10.36"></a><span id="l10.36"> </span>
<a href="#l10.37"></a><span id="l10.37">     switch (pickerID) {</span>
<a href="#l10.38"></a><span id="l10.38">       case &quot;msgNewFolderPicker&quot;:</span>
<a href="#l10.39"></a><span id="l10.39">         verifyFunction = msgfolder.canCreateSubfolders;</span>
<a href="#l10.40"></a><span id="l10.40">         break;</span>
<a href="#l10.41"></a><span id="l10.41">       case &quot;msgRenameFolderPicker&quot;:</span>
<a href="#l10.42"></a><span id="l10.42">         verifyFunction = msgfolder.canRename;</span>
<a href="#l10.43"></a><span id="l10.43">         break;</span>
<a href="#l10.44"></a><span id="l10.44">       default:</span>
<a href="#l10.45"></a><span id="l10.45">         verifyFunction = msgfolder.canFileMessages;</span>
<a href="#l10.46"></a><span id="l10.46">         break;</span>
<a href="#l10.47"></a><span id="l10.47">     }</span>
<a href="#l10.48"></a><span id="l10.48"> </span>
<a href="#l10.49"></a><span id="l10.49">     if (verifyFunction) {</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-      SetFolderPicker(uri,pickerID);</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+      SetFolderPicker(uri, pickerID);</span>
<a href="#l10.52"></a><span id="l10.52">     }</span>
<a href="#l10.53"></a><span id="l10.53">   }</span>
<a href="#l10.54"></a><span id="l10.54"> }</span>
<a href="#l10.55"></a><span id="l10.55"> </span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-function PickedMsgFolder(selection,pickerID)</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-{</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-  var selectedUri = selection.getAttribute('id');</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-  SetFolderPicker(selectedUri,pickerID);</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineplus">+function PickedMsgFolder(selection, pickerID) {</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+  var selectedUri = selection.getAttribute(&quot;id&quot;);</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineplus">+  SetFolderPicker(selectedUri, pickerID);</span>
<a href="#l10.63"></a><span id="l10.63"> }</span>
<a href="#l10.64"></a><span id="l10.64"> </span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-function SetFolderPickerElement(uri, picker)</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-{</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineplus">+function SetFolderPickerElement(uri, picker) {</span>
<a href="#l10.68"></a><span id="l10.68">   var msgfolder = MailUtils.getExistingFolder(uri);</span>
<a href="#l10.69"></a><span id="l10.69"> </span>
<a href="#l10.70"></a><span id="l10.70">   if (!msgfolder)</span>
<a href="#l10.71"></a><span id="l10.71">     return;</span>
<a href="#l10.72"></a><span id="l10.72"> </span>
<a href="#l10.73"></a><span id="l10.73">   var selectedValue = null;</span>
<a href="#l10.74"></a><span id="l10.74">   var serverName;</span>
<a href="#l10.75"></a><span id="l10.75"> </span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-  if (msgfolder.isServer)</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineplus">+  if (msgfolder.isServer) {</span>
<a href="#l10.78"></a><span id="l10.78">     selectedValue = msgfolder.name;</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-  else {</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-    if (msgfolder.server)</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineplus">+  } else {</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineplus">+    if (msgfolder.server) {</span>
<a href="#l10.83"></a><span id="l10.83">       serverName = msgfolder.server.prettyName;</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-    else {</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineplus">+    } else {</span>
<a href="#l10.86"></a><span id="l10.86">      dump(&quot;Can't find server for &quot; + uri + &quot;\n&quot;);</span>
<a href="#l10.87"></a><span id="l10.87">      serverName = &quot;???&quot;;</span>
<a href="#l10.88"></a><span id="l10.88">     }</span>
<a href="#l10.89"></a><span id="l10.89"> </span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-  switch (picker.id) {</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-    case &quot;runFiltersFolder&quot;:</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-      selectedValue = msgfolder.name;</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-      break;</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-    case &quot;msgTrashFolderPicker&quot;:</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-      selectedValue = msgfolder.name;</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-      break;</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-    default:</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-      if (!gMessengerBundle)</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-        gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-      selectedValue = gMessengerBundle.getFormattedString(&quot;verboseFolderFormat&quot;,</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-        [msgfolder.name, serverName]);</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-      break;</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineplus">+    switch (picker.id) {</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineplus">+      case &quot;runFiltersFolder&quot;:</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineplus">+        selectedValue = msgfolder.name;</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineplus">+        break;</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineplus">+      case &quot;msgTrashFolderPicker&quot;:</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineplus">+        selectedValue = msgfolder.name;</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineplus">+        break;</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineplus">+      default:</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineplus">+        if (!gMessengerBundle)</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineplus">+          gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineplus">+        selectedValue = gMessengerBundle.getFormattedString(&quot;verboseFolderFormat&quot;,</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineplus">+          [msgfolder.name, serverName]);</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineplus">+        break;</span>
<a href="#l10.116"></a><span id="l10.116">     }</span>
<a href="#l10.117"></a><span id="l10.117">   }</span>
<a href="#l10.118"></a><span id="l10.118"> </span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-  picker.setAttribute(&quot;label&quot;,selectedValue);</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-  picker.setAttribute(&quot;uri&quot;,uri);</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineplus">+  picker.setAttribute(&quot;label&quot;, selectedValue);</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineplus">+  picker.setAttribute(&quot;uri&quot;, uri);</span>
<a href="#l10.123"></a><span id="l10.123"> }</span>
<a href="#l10.124"></a><span id="l10.124"> </span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-function SetFolderPicker(uri,pickerID)</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-{</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineplus">+function SetFolderPicker(uri, pickerID) {</span>
<a href="#l10.128"></a><span id="l10.128">   SetFolderPickerElement(uri, document.getElementById(pickerID));</span>
<a href="#l10.129"></a><span id="l10.129"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/content/msgPrintEngine.js</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/content/msgPrintEngine.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -1,96 +1,92 @@</span>
<a href="#l11.4"></a><span id="l11.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l11.5"></a><span id="l11.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.6"></a><span id="l11.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.7"></a><span id="l11.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l11.8"></a><span id="l11.8"> </span>
<a href="#l11.9"></a><span id="l11.9"> /* This is where functions related to the print engine are kept */</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+/* import-globals-from ../../../../toolkit/components/printing/content/printUtils.js */</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+</span>
<a href="#l11.13"></a><span id="l11.13"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.14"></a><span id="l11.14"> </span>
<a href="#l11.15"></a><span id="l11.15"> /* globals for a particular window */</span>
<a href="#l11.16"></a><span id="l11.16"> var printEngineContractID      = &quot;@mozilla.org/messenger/msgPrintEngine;1&quot;;</span>
<a href="#l11.17"></a><span id="l11.17"> var printEngineWindow;</span>
<a href="#l11.18"></a><span id="l11.18"> var printEngine;</span>
<a href="#l11.19"></a><span id="l11.19"> var printSettings = null;</span>
<a href="#l11.20"></a><span id="l11.20"> var printOpener = null;</span>
<a href="#l11.21"></a><span id="l11.21"> </span>
<a href="#l11.22"></a><span id="l11.22"> /* Functions related to startup */</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-function OnLoadPrintEngine()</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-{</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+function OnLoadPrintEngine() {</span>
<a href="#l11.26"></a><span id="l11.26">   PrintEngineCreateGlobals();</span>
<a href="#l11.27"></a><span id="l11.27">   InitPrintEngineWindow();</span>
<a href="#l11.28"></a><span id="l11.28">   printEngine.startPrintOperation(printSettings);</span>
<a href="#l11.29"></a><span id="l11.29"> }</span>
<a href="#l11.30"></a><span id="l11.30"> </span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-function PrintEngineCreateGlobals()</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-{</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+function PrintEngineCreateGlobals() {</span>
<a href="#l11.34"></a><span id="l11.34">   /* get the print engine instance */</span>
<a href="#l11.35"></a><span id="l11.35">   printEngine = Cc[printEngineContractID].createInstance();</span>
<a href="#l11.36"></a><span id="l11.36">   printEngine = printEngine.QueryInterface(Ci.nsIMsgPrintEngine);</span>
<a href="#l11.37"></a><span id="l11.37">   printSettings = PrintUtils.getPrintSettings();</span>
<a href="#l11.38"></a><span id="l11.38">   if (printSettings) {</span>
<a href="#l11.39"></a><span id="l11.39">     printSettings.isCancelled = false;</span>
<a href="#l11.40"></a><span id="l11.40">   }</span>
<a href="#l11.41"></a><span id="l11.41"> }</span>
<a href="#l11.42"></a><span id="l11.42"> </span>
<a href="#l11.43"></a><span id="l11.43"> var PrintPreviewListener = {</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-  getPrintPreviewBrowser: function () {</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+  getPrintPreviewBrowser() {</span>
<a href="#l11.46"></a><span id="l11.46">     var browser = document.getElementById(&quot;ppBrowser&quot;);</span>
<a href="#l11.47"></a><span id="l11.47">     if (!browser) {</span>
<a href="#l11.48"></a><span id="l11.48">       browser = document.createElement(&quot;browser&quot;);</span>
<a href="#l11.49"></a><span id="l11.49">       browser.setAttribute(&quot;id&quot;, &quot;ppBrowser&quot;);</span>
<a href="#l11.50"></a><span id="l11.50">       browser.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l11.51"></a><span id="l11.51">       browser.setAttribute(&quot;disablehistory&quot;, &quot;true&quot;);</span>
<a href="#l11.52"></a><span id="l11.52">       browser.setAttribute(&quot;disablesecurity&quot;, &quot;true&quot;);</span>
<a href="#l11.53"></a><span id="l11.53">       browser.setAttribute(&quot;type&quot;, &quot;content&quot;);</span>
<a href="#l11.54"></a><span id="l11.54">       document.documentElement.appendChild(browser);</span>
<a href="#l11.55"></a><span id="l11.55">     }</span>
<a href="#l11.56"></a><span id="l11.56">     return browser;</span>
<a href="#l11.57"></a><span id="l11.57">   },</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-  getSourceBrowser: function () {</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+  getSourceBrowser() {</span>
<a href="#l11.60"></a><span id="l11.60">     return document.getElementById(&quot;content&quot;);</span>
<a href="#l11.61"></a><span id="l11.61">   },</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineminus">-  getNavToolbox: function () {</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+  getNavToolbox() {</span>
<a href="#l11.64"></a><span id="l11.64">     return document.getElementById(&quot;content&quot;);</span>
<a href="#l11.65"></a><span id="l11.65">   },</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-  onEnter: function () {</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+  onEnter() {</span>
<a href="#l11.68"></a><span id="l11.68">     setPPTitle(document.getElementById(&quot;content&quot;).contentDocument.title);</span>
<a href="#l11.69"></a><span id="l11.69">     document.getElementById(&quot;content&quot;).collapsed = true;</span>
<a href="#l11.70"></a><span id="l11.70">     printEngine.showWindow(true);</span>
<a href="#l11.71"></a><span id="l11.71">   },</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineminus">-  onExit: function () {</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+  onExit() {</span>
<a href="#l11.74"></a><span id="l11.74">     window.close();</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineminus">-  }</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+  },</span>
<a href="#l11.77"></a><span id="l11.77"> };</span>
<a href="#l11.78"></a><span id="l11.78"> </span>
<a href="#l11.79"></a><span id="l11.79" class="difflineminus">-function setPPTitle(aTitle)</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineminus">-{</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+function setPPTitle(aTitle) {</span>
<a href="#l11.82"></a><span id="l11.82">   let title = aTitle;</span>
<a href="#l11.83"></a><span id="l11.83">   let gBrandBundle = document.getElementById(&quot;bundle_brand&quot;);</span>
<a href="#l11.84"></a><span id="l11.84">   let msgBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l11.85"></a><span id="l11.85">   let brandStr = gBrandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l11.86"></a><span id="l11.86">   if (brandStr) {</span>
<a href="#l11.87"></a><span id="l11.87">     title = msgBundle.getFormattedString(&quot;PreviewTitle&quot;, [title, brandStr]);</span>
<a href="#l11.88"></a><span id="l11.88">   }</span>
<a href="#l11.89"></a><span id="l11.89">   document.title = title;</span>
<a href="#l11.90"></a><span id="l11.90"> }</span>
<a href="#l11.91"></a><span id="l11.91"> </span>
<a href="#l11.92"></a><span id="l11.92"> // Pref listener constants</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineminus">-var gStartupPPObserver =</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineminus">-{</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineminus">-  observe: function(subject, topic, prefName)</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineminus">-  {</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+var gStartupPPObserver = {</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+  observe(subject, topic, prefName) {</span>
<a href="#l11.99"></a><span id="l11.99">     PrintUtils.printPreview(PrintPreviewListener);</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineminus">-  }</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+  },</span>
<a href="#l11.102"></a><span id="l11.102"> };</span>
<a href="#l11.103"></a><span id="l11.103"> </span>
<a href="#l11.104"></a><span id="l11.104" class="difflineminus">-function ReplaceWithSelection()</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineminus">-{</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+function ReplaceWithSelection() {</span>
<a href="#l11.107"></a><span id="l11.107">   if (!printOpener.content)</span>
<a href="#l11.108"></a><span id="l11.108">     return;</span>
<a href="#l11.109"></a><span id="l11.109"> </span>
<a href="#l11.110"></a><span id="l11.110">   var selection = printOpener.content.getSelection();</span>
<a href="#l11.111"></a><span id="l11.111"> </span>
<a href="#l11.112"></a><span id="l11.112">   if (selection != &quot;&quot;) {</span>
<a href="#l11.113"></a><span id="l11.113">     var range = selection.getRangeAt(0);</span>
<a href="#l11.114"></a><span id="l11.114">     var contents = range.cloneContents();</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineat">@@ -100,18 +96,17 @@ function ReplaceWithSelection()</span>
<a href="#l11.116"></a><span id="l11.116">     /* Replace the content of &lt;body&gt; with the users' selection. */</span>
<a href="#l11.117"></a><span id="l11.117">     if (aBody) {</span>
<a href="#l11.118"></a><span id="l11.118">       aBody.innerHTML = &quot;&quot;;</span>
<a href="#l11.119"></a><span id="l11.119">       aBody.appendChild(contents);</span>
<a href="#l11.120"></a><span id="l11.120">     }</span>
<a href="#l11.121"></a><span id="l11.121">   }</span>
<a href="#l11.122"></a><span id="l11.122"> }</span>
<a href="#l11.123"></a><span id="l11.123"> </span>
<a href="#l11.124"></a><span id="l11.124" class="difflineminus">-function InitPrintEngineWindow()</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-{</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+function InitPrintEngineWindow() {</span>
<a href="#l11.127"></a><span id="l11.127">   /* Store the current opener for later access in ReplaceWithSelection() */</span>
<a href="#l11.128"></a><span id="l11.128">   printOpener = opener;</span>
<a href="#l11.129"></a><span id="l11.129"> </span>
<a href="#l11.130"></a><span id="l11.130">   /* Register the event listener to be able to replace the document</span>
<a href="#l11.131"></a><span id="l11.131">    * content with the user selection when loading is finished.</span>
<a href="#l11.132"></a><span id="l11.132">    */</span>
<a href="#l11.133"></a><span id="l11.133">   document.getElementById(&quot;content&quot;).addEventListener(&quot;load&quot;, ReplaceWithSelection, true);</span>
<a href="#l11.134"></a><span id="l11.134"> </span>
<a href="#l11.135"></a><span id="l11.135" class="difflineat">@@ -155,28 +150,24 @@ function InitPrintEngineWindow()</span>
<a href="#l11.136"></a><span id="l11.136">       printEngine.setPrintURICount(numSelected);</span>
<a href="#l11.137"></a><span id="l11.137">       for (var i = 0; i &lt; numSelected; i++) {</span>
<a href="#l11.138"></a><span id="l11.138">         printEngine.addPrintURI(uriArray[i]);</span>
<a href="#l11.139"></a><span id="l11.139">       }</span>
<a href="#l11.140"></a><span id="l11.140">     }</span>
<a href="#l11.141"></a><span id="l11.141">   }</span>
<a href="#l11.142"></a><span id="l11.142"> }</span>
<a href="#l11.143"></a><span id="l11.143"> </span>
<a href="#l11.144"></a><span id="l11.144" class="difflineminus">-function ClearPrintEnginePane()</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineminus">-{</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineminus">-  if (window.frames[&quot;content&quot;].location.href != &quot;about:blank&quot;)</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineminus">-    window.frames[&quot;content&quot;].location.href = &quot;about:blank&quot;;</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+function ClearPrintEnginePane() {</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+  if (window.frames.content.location.href != &quot;about:blank&quot;)</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+    window.frames.content.location.href = &quot;about:blank&quot;;</span>
<a href="#l11.151"></a><span id="l11.151"> }</span>
<a href="#l11.152"></a><span id="l11.152"> </span>
<a href="#l11.153"></a><span id="l11.153" class="difflineminus">-function StopUrls()</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineminus">-{</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+function StopUrls() {</span>
<a href="#l11.156"></a><span id="l11.156">   printEngine.stopUrls();</span>
<a href="#l11.157"></a><span id="l11.157"> }</span>
<a href="#l11.158"></a><span id="l11.158"> </span>
<a href="#l11.159"></a><span id="l11.159" class="difflineminus">-function PrintEnginePrint()</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineminus">-{</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+function PrintEnginePrint() {</span>
<a href="#l11.162"></a><span id="l11.162">   printEngineWindow = window.openDialog(&quot;chrome://messenger/content/msgPrintEngine.xul&quot;, &quot;&quot;, &quot;chrome,dialog=no,all,centerscreen&quot;, false);</span>
<a href="#l11.163"></a><span id="l11.163"> }</span>
<a href="#l11.164"></a><span id="l11.164"> </span>
<a href="#l11.165"></a><span id="l11.165" class="difflineminus">-function PrintEnginePrintPreview()</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineminus">-{</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+function PrintEnginePrintPreview() {</span>
<a href="#l11.168"></a><span id="l11.168">   printEngineWindow = window.openDialog(&quot;chrome://messenger/content/msgPrintEngine.xul&quot;, &quot;&quot;, &quot;chrome,dialog=no,all,centerscreen&quot;, true);</span>
<a href="#l11.169"></a><span id="l11.169"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mailnews/base/content/msgSelectOfflineFolders.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mailnews/base/content/msgSelectOfflineFolders.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -1,56 +1,57 @@</span>
<a href="#l12.4"></a><span id="l12.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.5"></a><span id="l12.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l12.6"></a><span id="l12.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l12.7"></a><span id="l12.7"> </span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+/* import-globals-from ../../../mail/base/content/folderPane.js */</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+</span>
<a href="#l12.10"></a><span id="l12.10"> var gSelectOffline = {</span>
<a href="#l12.11"></a><span id="l12.11">   _treeElement: null,</span>
<a href="#l12.12"></a><span id="l12.12">   _rollbackMap: new Map(),</span>
<a href="#l12.13"></a><span id="l12.13"> </span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-  load: function() {</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+  load() {</span>
<a href="#l12.16"></a><span id="l12.16">     let oldProps = ftvItem.prototype.getProperties;</span>
<a href="#l12.17"></a><span id="l12.17">     ftvItem.prototype.getProperties = function(aColumn) {</span>
<a href="#l12.18"></a><span id="l12.18">       if (!aColumn || aColumn.id != &quot;syncCol&quot;)</span>
<a href="#l12.19"></a><span id="l12.19">         return oldProps.call(this, aColumn);</span>
<a href="#l12.20"></a><span id="l12.20"> </span>
<a href="#l12.21"></a><span id="l12.21">       let properties = &quot;syncCol&quot;;</span>
<a href="#l12.22"></a><span id="l12.22"> </span>
<a href="#l12.23"></a><span id="l12.23">       if (this._folder.isServer)</span>
<a href="#l12.24"></a><span id="l12.24">         return &quot; isServer-true&quot;;</span>
<a href="#l12.25"></a><span id="l12.25"> </span>
<a href="#l12.26"></a><span id="l12.26">       if (this._folder.getFlag(Ci.nsMsgFolderFlags.Offline))</span>
<a href="#l12.27"></a><span id="l12.27">         properties += &quot; synchronize-true&quot;;</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29">       return properties;</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineminus">-    }</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+    };</span>
<a href="#l12.32"></a><span id="l12.32"> </span>
<a href="#l12.33"></a><span id="l12.33">     let modeOffline = {</span>
<a href="#l12.34"></a><span id="l12.34">       __proto__: IFolderTreeMode,</span>
<a href="#l12.35"></a><span id="l12.35"> </span>
<a href="#l12.36"></a><span id="l12.36" class="difflineminus">-      generateMap: function(ftv) {</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineminus">-        let filterOffline = function(aFolder) { return aFolder.supportsOffline; }</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+      generateMap(ftv) {</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+        let filterOffline = function(aFolder) { return aFolder.supportsOffline; };</span>
<a href="#l12.40"></a><span id="l12.40">         let accounts = gFolderTreeView._sortedAccounts()</span>
<a href="#l12.41"></a><span id="l12.41">                          .filter(acct =&gt; filterOffline(acct.incomingServer.rootFolder));</span>
<a href="#l12.42"></a><span id="l12.42">         // Force each root folder to do its local subfolder discovery.</span>
<a href="#l12.43"></a><span id="l12.43">         MailUtils.discoverFolders();</span>
<a href="#l12.44"></a><span id="l12.44">         return accounts.map(acct =&gt; new ftvItem(acct.incomingServer.rootFolder,</span>
<a href="#l12.45"></a><span id="l12.45">                                                 filterOffline));</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineminus">-      }</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+      },</span>
<a href="#l12.48"></a><span id="l12.48">     };</span>
<a href="#l12.49"></a><span id="l12.49"> </span>
<a href="#l12.50"></a><span id="l12.50">     this._treeElement = document.getElementById(&quot;synchronizeTree&quot;);</span>
<a href="#l12.51"></a><span id="l12.51"> </span>
<a href="#l12.52"></a><span id="l12.52">     gFolderTreeView.registerFolderTreeMode(this._treeElement.getAttribute(&quot;mode&quot;),</span>
<a href="#l12.53"></a><span id="l12.53">                                            modeOffline, &quot;Offline Folders&quot;);</span>
<a href="#l12.54"></a><span id="l12.54">     gFolderTreeView.load(this._treeElement);</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineminus">-</span>
<a href="#l12.56"></a><span id="l12.56">   },</span>
<a href="#l12.57"></a><span id="l12.57"> </span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-  onKeyPress: function(aEvent) {</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+  onKeyPress(aEvent) {</span>
<a href="#l12.60"></a><span id="l12.60">     // For now, only do something on space key.</span>
<a href="#l12.61"></a><span id="l12.61">     if (aEvent.charCode != aEvent.DOM_VK_SPACE)</span>
<a href="#l12.62"></a><span id="l12.62">       return;</span>
<a href="#l12.63"></a><span id="l12.63"> </span>
<a href="#l12.64"></a><span id="l12.64">     let selection = this._treeElement.view.selection;</span>
<a href="#l12.65"></a><span id="l12.65">     let start = {};</span>
<a href="#l12.66"></a><span id="l12.66">     let end = {};</span>
<a href="#l12.67"></a><span id="l12.67">     let numRanges = selection.getRangeCount();</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineat">@@ -58,50 +59,50 @@ var gSelectOffline = {</span>
<a href="#l12.69"></a><span id="l12.69">     for (let range = 0; range &lt; numRanges; range++) {</span>
<a href="#l12.70"></a><span id="l12.70">       selection.getRangeAt(range, start, end);</span>
<a href="#l12.71"></a><span id="l12.71">       for (let i = start.value; i &lt;= end.value; i++) {</span>
<a href="#l12.72"></a><span id="l12.72">         this._toggle(i);</span>
<a href="#l12.73"></a><span id="l12.73">       }</span>
<a href="#l12.74"></a><span id="l12.74">     }</span>
<a href="#l12.75"></a><span id="l12.75">   },</span>
<a href="#l12.76"></a><span id="l12.76"> </span>
<a href="#l12.77"></a><span id="l12.77" class="difflineminus">-  onClick: function(aEvent) {</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+  onClick(aEvent) {</span>
<a href="#l12.79"></a><span id="l12.79">     // We only care about button 0 (left click) events.</span>
<a href="#l12.80"></a><span id="l12.80">     if (aEvent.button != 0)</span>
<a href="#l12.81"></a><span id="l12.81">       return;</span>
<a href="#l12.82"></a><span id="l12.82"> </span>
<a href="#l12.83"></a><span id="l12.83">     let treeCellInfo = this._treeElement.getCellAt(aEvent.clientX);</span>
<a href="#l12.84"></a><span id="l12.84"> </span>
<a href="#l12.85"></a><span id="l12.85">     if (treeCellInfo.row == -1 || treeCellInfo.col.id != &quot;syncCol&quot;)</span>
<a href="#l12.86"></a><span id="l12.86">       return;</span>
<a href="#l12.87"></a><span id="l12.87"> </span>
<a href="#l12.88"></a><span id="l12.88">     this._toggle(treeCellInfo.row);</span>
<a href="#l12.89"></a><span id="l12.89">   },</span>
<a href="#l12.90"></a><span id="l12.90"> </span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-  _toggle: function(aRow) {</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+  _toggle(aRow) {</span>
<a href="#l12.93"></a><span id="l12.93">     let folder = gFolderTreeView._rowMap[aRow]._folder;</span>
<a href="#l12.94"></a><span id="l12.94"> </span>
<a href="#l12.95"></a><span id="l12.95">     if (folder.isServer)</span>
<a href="#l12.96"></a><span id="l12.96">       return;</span>
<a href="#l12.97"></a><span id="l12.97"> </span>
<a href="#l12.98"></a><span id="l12.98">     // Save our current state for rollback, if necessary.</span>
<a href="#l12.99"></a><span id="l12.99">     if (!this._rollbackMap.has(folder))</span>
<a href="#l12.100"></a><span id="l12.100">       this._rollbackMap.set(folder, folder.getFlag(Ci.nsMsgFolderFlags.Offline));</span>
<a href="#l12.101"></a><span id="l12.101"> </span>
<a href="#l12.102"></a><span id="l12.102">     folder.toggleFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l12.103"></a><span id="l12.103">     gFolderTreeView._tree.invalidateRow(aRow);</span>
<a href="#l12.104"></a><span id="l12.104">   },</span>
<a href="#l12.105"></a><span id="l12.105"> </span>
<a href="#l12.106"></a><span id="l12.106" class="difflineminus">-  onAccept: function() {</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+  onAccept() {</span>
<a href="#l12.108"></a><span id="l12.108">     gFolderTreeView.unload();</span>
<a href="#l12.109"></a><span id="l12.109">   },</span>
<a href="#l12.110"></a><span id="l12.110"> </span>
<a href="#l12.111"></a><span id="l12.111" class="difflineminus">-  onCancel: function() {</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+  onCancel() {</span>
<a href="#l12.113"></a><span id="l12.113">     gFolderTreeView.unload();</span>
<a href="#l12.114"></a><span id="l12.114">     for (let [folder, value] of this._rollbackMap) {</span>
<a href="#l12.115"></a><span id="l12.115">       if (value != folder.getFlag(Ci.nsMsgFolderFlags.Offline))</span>
<a href="#l12.116"></a><span id="l12.116">         folder.toggleFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l12.117"></a><span id="l12.117">     }</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineminus">-  }</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+  },</span>
<a href="#l12.120"></a><span id="l12.120"> };</span>
<a href="#l12.121"></a><span id="l12.121"> </span>
<a href="#l12.122"></a><span id="l12.122"> document.addEventListener(&quot;dialogaccept&quot;, gSelectOffline.onAccept);</span>
<a href="#l12.123"></a><span id="l12.123"> document.addEventListener(&quot;dialogcancel&quot;, gSelectOffline.onCancel);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/content/msgSynchronize.js</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/content/msgSynchronize.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -9,18 +9,17 @@ var {MailUtils} = ChromeUtils.import(&quot;re</span>
<a href="#l13.4"></a><span id="l13.4"> var gSynchronizeTree = null;</span>
<a href="#l13.5"></a><span id="l13.5"> var gParentMsgWindow;</span>
<a href="#l13.6"></a><span id="l13.6"> var gMsgWindow;</span>
<a href="#l13.7"></a><span id="l13.7"> </span>
<a href="#l13.8"></a><span id="l13.8"> var gInitialFolderStates = {};</span>
<a href="#l13.9"></a><span id="l13.9"> </span>
<a href="#l13.10"></a><span id="l13.10"> document.addEventListener(&quot;dialogaccept&quot;, syncOkButton);</span>
<a href="#l13.11"></a><span id="l13.11"> </span>
<a href="#l13.12"></a><span id="l13.12" class="difflineminus">-function OnLoad()</span>
<a href="#l13.13"></a><span id="l13.13" class="difflineminus">-{</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineplus">+function OnLoad() {</span>
<a href="#l13.15"></a><span id="l13.15">     if (window.arguments &amp;&amp; window.arguments[0]) {</span>
<a href="#l13.16"></a><span id="l13.16">         if (window.arguments[0].msgWindow) {</span>
<a href="#l13.17"></a><span id="l13.17">             gParentMsgWindow = window.arguments[0].msgWindow;</span>
<a href="#l13.18"></a><span id="l13.18">         }</span>
<a href="#l13.19"></a><span id="l13.19">     }</span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21">     document.getElementById(&quot;syncMail&quot;).checked =</span>
<a href="#l13.22"></a><span id="l13.22">       Services.prefs.getBoolPref(&quot;mailnews.offline_sync_mail&quot;);</span>
<a href="#l13.23"></a><span id="l13.23" class="difflineat">@@ -29,106 +28,98 @@ function OnLoad()</span>
<a href="#l13.24"></a><span id="l13.24">     document.getElementById(&quot;sendMessage&quot;).checked =</span>
<a href="#l13.25"></a><span id="l13.25">       Services.prefs.getBoolPref(&quot;mailnews.offline_sync_send_unsent&quot;);</span>
<a href="#l13.26"></a><span id="l13.26">     document.getElementById(&quot;workOffline&quot;).checked =</span>
<a href="#l13.27"></a><span id="l13.27">       Services.prefs.getBoolPref(&quot;mailnews.offline_sync_work_offline&quot;);</span>
<a href="#l13.28"></a><span id="l13.28"> </span>
<a href="#l13.29"></a><span id="l13.29">     return true;</span>
<a href="#l13.30"></a><span id="l13.30"> }</span>
<a href="#l13.31"></a><span id="l13.31"> </span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-function syncOkButton()</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-{</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineplus">+function syncOkButton() {</span>
<a href="#l13.35"></a><span id="l13.35">     var syncMail = document.getElementById(&quot;syncMail&quot;).checked;</span>
<a href="#l13.36"></a><span id="l13.36">     var syncNews = document.getElementById(&quot;syncNews&quot;).checked;</span>
<a href="#l13.37"></a><span id="l13.37">     var sendMessage = document.getElementById(&quot;sendMessage&quot;).checked;</span>
<a href="#l13.38"></a><span id="l13.38">     var workOffline = document.getElementById(&quot;workOffline&quot;).checked;</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40">     Services.prefs.setBoolPref(&quot;mailnews.offline_sync_mail&quot;, syncMail);</span>
<a href="#l13.41"></a><span id="l13.41">     Services.prefs.setBoolPref(&quot;mailnews.offline_sync_news&quot;, syncNews);</span>
<a href="#l13.42"></a><span id="l13.42">     Services.prefs.setBoolPref(&quot;mailnews.offline_sync_send_unsent&quot;, sendMessage);</span>
<a href="#l13.43"></a><span id="l13.43">     Services.prefs.setBoolPref(&quot;mailnews.offline_sync_work_offline&quot;, workOffline);</span>
<a href="#l13.44"></a><span id="l13.44"> </span>
<a href="#l13.45"></a><span id="l13.45">     if (syncMail || syncNews || sendMessage || workOffline) {</span>
<a href="#l13.46"></a><span id="l13.46">         var offlineManager = Cc[&quot;@mozilla.org/messenger/offline-manager;1&quot;]</span>
<a href="#l13.47"></a><span id="l13.47">                                .getService(Ci.nsIMsgOfflineManager);</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-        if(offlineManager)</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineminus">-            offlineManager.synchronizeForOffline(syncNews, syncMail, sendMessage, workOffline, gParentMsgWindow)</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+        if (offlineManager)</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+            offlineManager.synchronizeForOffline(syncNews, syncMail, sendMessage, workOffline, gParentMsgWindow);</span>
<a href="#l13.52"></a><span id="l13.52">     }</span>
<a href="#l13.53"></a><span id="l13.53"> }</span>
<a href="#l13.54"></a><span id="l13.54"> </span>
<a href="#l13.55"></a><span id="l13.55" class="difflineminus">-function OnSelect()</span>
<a href="#l13.56"></a><span id="l13.56" class="difflineminus">-{</span>
<a href="#l13.57"></a><span id="l13.57" class="difflineplus">+function OnSelect() {</span>
<a href="#l13.58"></a><span id="l13.58">    top.window.openDialog(&quot;chrome://messenger/content/msgSelectOfflineFolders.xul&quot;, &quot;&quot;,</span>
<a href="#l13.59"></a><span id="l13.59">                          &quot;centerscreen,chrome,modal,titlebar,resizable=yes&quot;);</span>
<a href="#l13.60"></a><span id="l13.60">    return true;</span>
<a href="#l13.61"></a><span id="l13.61"> }</span>
<a href="#l13.62"></a><span id="l13.62"> </span>
<a href="#l13.63"></a><span id="l13.63"> // All the code below is only used by Seamonkey.</span>
<a href="#l13.64"></a><span id="l13.64"> </span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-function selectOkButton()</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineminus">-{</span>
<a href="#l13.67"></a><span id="l13.67" class="difflineplus">+function selectOkButton() {</span>
<a href="#l13.68"></a><span id="l13.68">     return true;</span>
<a href="#l13.69"></a><span id="l13.69"> }</span>
<a href="#l13.70"></a><span id="l13.70"> </span>
<a href="#l13.71"></a><span id="l13.71" class="difflineminus">-function selectCancelButton()</span>
<a href="#l13.72"></a><span id="l13.72" class="difflineminus">-{</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineplus">+function selectCancelButton() {</span>
<a href="#l13.74"></a><span id="l13.74">     for (var resourceValue in gInitialFolderStates) {</span>
<a href="#l13.75"></a><span id="l13.75">       let folder = MailUtils.getExistingFolder(resourceValue);</span>
<a href="#l13.76"></a><span id="l13.76">       if (gInitialFolderStates[resourceValue])</span>
<a href="#l13.77"></a><span id="l13.77">         folder.setFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l13.78"></a><span id="l13.78">       else</span>
<a href="#l13.79"></a><span id="l13.79">         folder.clearFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l13.80"></a><span id="l13.80">     }</span>
<a href="#l13.81"></a><span id="l13.81">     return true;</span>
<a href="#l13.82"></a><span id="l13.82"> }</span>
<a href="#l13.83"></a><span id="l13.83"> </span>
<a href="#l13.84"></a><span id="l13.84" class="difflineminus">-function selectOnLoad()</span>
<a href="#l13.85"></a><span id="l13.85" class="difflineminus">-{</span>
<a href="#l13.86"></a><span id="l13.86" class="difflineplus">+function selectOnLoad() {</span>
<a href="#l13.87"></a><span id="l13.87">     gMsgWindow = Cc[&quot;@mozilla.org/messenger/msgwindow;1&quot;]</span>
<a href="#l13.88"></a><span id="l13.88">                    .createInstance(Ci.nsIMsgWindow);</span>
<a href="#l13.89"></a><span id="l13.89">     gMsgWindow.domWindow = window;</span>
<a href="#l13.90"></a><span id="l13.90">     gMsgWindow.rootDocShell.appType = Ci.nsIDocShell.APP_TYPE_MAIL;</span>
<a href="#l13.91"></a><span id="l13.91"> </span>
<a href="#l13.92"></a><span id="l13.92" class="difflineminus">-    gSynchronizeTree = document.getElementById('synchronizeTree');</span>
<a href="#l13.93"></a><span id="l13.93" class="difflineplus">+    gSynchronizeTree = document.getElementById(&quot;synchronizeTree&quot;);</span>
<a href="#l13.94"></a><span id="l13.94"> </span>
<a href="#l13.95"></a><span id="l13.95" class="difflineminus">-    SortSynchronizePane('folderNameCol', '?folderTreeNameSort');</span>
<a href="#l13.96"></a><span id="l13.96" class="difflineplus">+    SortSynchronizePane(&quot;folderNameCol&quot;, &quot;?folderTreeNameSort&quot;);</span>
<a href="#l13.97"></a><span id="l13.97"> }</span>
<a href="#l13.98"></a><span id="l13.98"> </span>
<a href="#l13.99"></a><span id="l13.99" class="difflineminus">-function SortSynchronizePane(column, sortKey)</span>
<a href="#l13.100"></a><span id="l13.100" class="difflineminus">-{</span>
<a href="#l13.101"></a><span id="l13.101" class="difflineplus">+function SortSynchronizePane(column, sortKey) {</span>
<a href="#l13.102"></a><span id="l13.102">     var node = FindInWindow(window, column);</span>
<a href="#l13.103"></a><span id="l13.103" class="difflineminus">-    if(!node) {</span>
<a href="#l13.104"></a><span id="l13.104" class="difflineminus">-        dump('Couldnt find sort column\n');</span>
<a href="#l13.105"></a><span id="l13.105" class="difflineplus">+    if (!node) {</span>
<a href="#l13.106"></a><span id="l13.106" class="difflineplus">+        dump(&quot;Couldnt find sort column\n&quot;);</span>
<a href="#l13.107"></a><span id="l13.107">         return;</span>
<a href="#l13.108"></a><span id="l13.108">     }</span>
<a href="#l13.109"></a><span id="l13.109"> </span>
<a href="#l13.110"></a><span id="l13.110">     node.setAttribute(&quot;sort&quot;, sortKey);</span>
<a href="#l13.111"></a><span id="l13.111">     node.setAttribute(&quot;sortDirection&quot;, &quot;natural&quot;);</span>
<a href="#l13.112"></a><span id="l13.112">     var col = gSynchronizeTree.columns[column];</span>
<a href="#l13.113"></a><span id="l13.113">     gSynchronizeTree.view.cycleHeader(col);</span>
<a href="#l13.114"></a><span id="l13.114"> }</span>
<a href="#l13.115"></a><span id="l13.115"> </span>
<a href="#l13.116"></a><span id="l13.116" class="difflineminus">-function FindInWindow(currentWindow, id)</span>
<a href="#l13.117"></a><span id="l13.117" class="difflineminus">-{</span>
<a href="#l13.118"></a><span id="l13.118" class="difflineplus">+function FindInWindow(currentWindow, id) {</span>
<a href="#l13.119"></a><span id="l13.119">     var item = currentWindow.document.getElementById(id);</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineminus">-    if(item)</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineminus">-    return item;</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+    if (item)</span>
<a href="#l13.123"></a><span id="l13.123" class="difflineplus">+      return item;</span>
<a href="#l13.124"></a><span id="l13.124"> </span>
<a href="#l13.125"></a><span id="l13.125" class="difflineminus">-    for(var i = 0; i &lt; currentWindow.frames.length; i++) {</span>
<a href="#l13.126"></a><span id="l13.126" class="difflineplus">+    for (var i = 0; i &lt; currentWindow.frames.length; i++) {</span>
<a href="#l13.127"></a><span id="l13.127">         var frameItem = FindInWindow(currentWindow.frames[i], id);</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineminus">-        if(frameItem)</span>
<a href="#l13.129"></a><span id="l13.129" class="difflineplus">+        if (frameItem)</span>
<a href="#l13.130"></a><span id="l13.130">             return frameItem;</span>
<a href="#l13.131"></a><span id="l13.131">     }</span>
<a href="#l13.132"></a><span id="l13.132"> </span>
<a href="#l13.133"></a><span id="l13.133">     return null;</span>
<a href="#l13.134"></a><span id="l13.134"> }</span>
<a href="#l13.135"></a><span id="l13.135"> </span>
<a href="#l13.136"></a><span id="l13.136"> </span>
<a href="#l13.137"></a><span id="l13.137" class="difflineminus">-function onSynchronizeClick(event)</span>
<a href="#l13.138"></a><span id="l13.138" class="difflineminus">-{</span>
<a href="#l13.139"></a><span id="l13.139" class="difflineplus">+function onSynchronizeClick(event) {</span>
<a href="#l13.140"></a><span id="l13.140">     // we only care about button 0 (left click) events</span>
<a href="#l13.141"></a><span id="l13.141">     if (event.button != 0)</span>
<a href="#l13.142"></a><span id="l13.142">       return;</span>
<a href="#l13.143"></a><span id="l13.143"> </span>
<a href="#l13.144"></a><span id="l13.144">     let treeCellInfo = gSynchronizeTree.getCellAt(event.clientX, event.clientY);</span>
<a href="#l13.145"></a><span id="l13.145">     if (treeCellInfo.row == -1)</span>
<a href="#l13.146"></a><span id="l13.146">       return;</span>
<a href="#l13.147"></a><span id="l13.147"> </span>
<a href="#l13.148"></a><span id="l13.148" class="difflineat">@@ -139,49 +130,43 @@ function onSynchronizeClick(event)</span>
<a href="#l13.149"></a><span id="l13.149">         if (!(gSynchronizeTree.view.isContainerOpen(treeCellInfo.row))) {</span>
<a href="#l13.150"></a><span id="l13.150">             var serverType = folder.server.type;</span>
<a href="#l13.151"></a><span id="l13.151">             // imap is the only server type that does folder discovery</span>
<a href="#l13.152"></a><span id="l13.152">             if (serverType != &quot;imap&quot;) return;</span>
<a href="#l13.153"></a><span id="l13.153"> </span>
<a href="#l13.154"></a><span id="l13.154">             if (folder.isServer) {</span>
<a href="#l13.155"></a><span id="l13.155">                 var server = folder.server;</span>
<a href="#l13.156"></a><span id="l13.156">                 server.performExpand(gMsgWindow);</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineminus">-            }</span>
<a href="#l13.158"></a><span id="l13.158" class="difflineminus">-            else {</span>
<a href="#l13.159"></a><span id="l13.159" class="difflineplus">+            } else {</span>
<a href="#l13.160"></a><span id="l13.160">                 var imapFolder = folderResource.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l13.161"></a><span id="l13.161">                 if (imapFolder) {</span>
<a href="#l13.162"></a><span id="l13.162">                   imapFolder.performExpand(gMsgWindow);</span>
<a href="#l13.163"></a><span id="l13.163">                 }</span>
<a href="#l13.164"></a><span id="l13.164">             }</span>
<a href="#l13.165"></a><span id="l13.165">         }</span>
<a href="#l13.166"></a><span id="l13.166" class="difflineminus">-    }</span>
<a href="#l13.167"></a><span id="l13.167" class="difflineminus">-    else {</span>
<a href="#l13.168"></a><span id="l13.168" class="difflineminus">-      if (treeCellInfo.col.id == &quot;syncCol&quot;) {</span>
<a href="#l13.169"></a><span id="l13.169" class="difflineplus">+    } else if (treeCellInfo.col.id == &quot;syncCol&quot;) {</span>
<a href="#l13.170"></a><span id="l13.170">         UpdateNode(GetFolderResource(gSynchronizeTree, treeCellInfo.row), treeCellInfo.row);</span>
<a href="#l13.171"></a><span id="l13.171" class="difflineminus">-      }</span>
<a href="#l13.172"></a><span id="l13.172">     }</span>
<a href="#l13.173"></a><span id="l13.173"> }</span>
<a href="#l13.174"></a><span id="l13.174"> </span>
<a href="#l13.175"></a><span id="l13.175" class="difflineminus">-function onSynchronizeTreeKeyPress(event)</span>
<a href="#l13.176"></a><span id="l13.176" class="difflineminus">-{</span>
<a href="#l13.177"></a><span id="l13.177" class="difflineplus">+function onSynchronizeTreeKeyPress(event) {</span>
<a href="#l13.178"></a><span id="l13.178">     // for now, only do something on space key</span>
<a href="#l13.179"></a><span id="l13.179">     if (event.charCode != KeyEvent.DOM_VK_SPACE)</span>
<a href="#l13.180"></a><span id="l13.180">       return;</span>
<a href="#l13.181"></a><span id="l13.181"> </span>
<a href="#l13.182"></a><span id="l13.182">     var treeSelection = gSynchronizeTree.view.selection;</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineminus">-    for (var i=0;i&lt;treeSelection.getRangeCount();i++) {</span>
<a href="#l13.184"></a><span id="l13.184" class="difflineplus">+    for (let i = 0; i &lt; treeSelection.getRangeCount(); i++) {</span>
<a href="#l13.185"></a><span id="l13.185">       var start = {}, end = {};</span>
<a href="#l13.186"></a><span id="l13.186" class="difflineminus">-      treeSelection.getRangeAt(i,start,end);</span>
<a href="#l13.187"></a><span id="l13.187" class="difflineminus">-      for (var k=start.value;k&lt;=end.value;k++)</span>
<a href="#l13.188"></a><span id="l13.188" class="difflineplus">+      treeSelection.getRangeAt(i, start, end);</span>
<a href="#l13.189"></a><span id="l13.189" class="difflineplus">+      for (let k = start.value; k &lt;= end.value; k++)</span>
<a href="#l13.190"></a><span id="l13.190">         UpdateNode(GetFolderResource(gSynchronizeTree, k), k);</span>
<a href="#l13.191"></a><span id="l13.191">     }</span>
<a href="#l13.192"></a><span id="l13.192"> }</span>
<a href="#l13.193"></a><span id="l13.193"> </span>
<a href="#l13.194"></a><span id="l13.194" class="difflineminus">-function UpdateNode(resource, row)</span>
<a href="#l13.195"></a><span id="l13.195" class="difflineminus">-{</span>
<a href="#l13.196"></a><span id="l13.196" class="difflineplus">+function UpdateNode(resource, row) {</span>
<a href="#l13.197"></a><span id="l13.197">     var folder = resource.QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l13.198"></a><span id="l13.198"> </span>
<a href="#l13.199"></a><span id="l13.199">     if (folder.isServer)</span>
<a href="#l13.200"></a><span id="l13.200">       return;</span>
<a href="#l13.201"></a><span id="l13.201"> </span>
<a href="#l13.202"></a><span id="l13.202">     if (!(resource.Value in gInitialFolderStates)) {</span>
<a href="#l13.203"></a><span id="l13.203">       gInitialFolderStates[resource.Value] = folder.getFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l13.204"></a><span id="l13.204">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/content/newFolderDialog.js</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/content/newFolderDialog.js</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -5,33 +5,32 @@</span>
<a href="#l14.4"></a><span id="l14.4">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6"> var FOLDERS = 1;</span>
<a href="#l14.7"></a><span id="l14.7"> var MESSAGES = 2;</span>
<a href="#l14.8"></a><span id="l14.8"> var dialog;</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> document.addEventListener(&quot;dialogaccept&quot;, onOK);</span>
<a href="#l14.11"></a><span id="l14.11"> </span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-function onLoad()</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-{</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+function onLoad() {</span>
<a href="#l14.15"></a><span id="l14.15">   var windowArgs = window.arguments[0];</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17">   dialog = {};</span>
<a href="#l14.18"></a><span id="l14.18"> </span>
<a href="#l14.19"></a><span id="l14.19">   dialog.nameField = document.getElementById(&quot;name&quot;);</span>
<a href="#l14.20"></a><span id="l14.20">   dialog.nameField.focus();</span>
<a href="#l14.21"></a><span id="l14.21"> </span>
<a href="#l14.22"></a><span id="l14.22">   // call this when OK is pressed</span>
<a href="#l14.23"></a><span id="l14.23">   dialog.okCallback = windowArgs.okCallback;</span>
<a href="#l14.24"></a><span id="l14.24"> </span>
<a href="#l14.25"></a><span id="l14.25">   // pre select the folderPicker, based on what they selected in the folder pane</span>
<a href="#l14.26"></a><span id="l14.26">   dialog.folder = windowArgs.folder;</span>
<a href="#l14.27"></a><span id="l14.27">   try {</span>
<a href="#l14.28"></a><span id="l14.28">     document.getElementById(&quot;MsgNewFolderPopup&quot;).selectFolder(windowArgs.folder);</span>
<a href="#l14.29"></a><span id="l14.29" class="difflineminus">-  } catch(ex) {</span>
<a href="#l14.30"></a><span id="l14.30" class="difflineplus">+  } catch (ex) {</span>
<a href="#l14.31"></a><span id="l14.31">     // selected a child folder</span>
<a href="#l14.32"></a><span id="l14.32">       document.getElementById(&quot;msgNewFolderPicker&quot;)</span>
<a href="#l14.33"></a><span id="l14.33">           .setAttribute(&quot;label&quot;, windowArgs.folder.prettyName);</span>
<a href="#l14.34"></a><span id="l14.34">   }</span>
<a href="#l14.35"></a><span id="l14.35"> </span>
<a href="#l14.36"></a><span id="l14.36">   // can folders contain both folders and messages?</span>
<a href="#l14.37"></a><span id="l14.37">   if (windowArgs.dualUseFolders) {</span>
<a href="#l14.38"></a><span id="l14.38">     dialog.folderType = FOLDERS | MESSAGES;</span>
<a href="#l14.39"></a><span id="l14.39" class="difflineat">@@ -48,37 +47,32 @@ function onLoad()</span>
<a href="#l14.40"></a><span id="l14.40"> }</span>
<a href="#l14.41"></a><span id="l14.41"> </span>
<a href="#l14.42"></a><span id="l14.42"> function onFolderSelect(event) {</span>
<a href="#l14.43"></a><span id="l14.43">   dialog.folder = event.target._folder;</span>
<a href="#l14.44"></a><span id="l14.44">   document.getElementById(&quot;msgNewFolderPicker&quot;)</span>
<a href="#l14.45"></a><span id="l14.45">           .setAttribute(&quot;label&quot;, dialog.folder.prettyName);</span>
<a href="#l14.46"></a><span id="l14.46"> }</span>
<a href="#l14.47"></a><span id="l14.47"> </span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-function onOK()</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-{</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineplus">+function onOK() {</span>
<a href="#l14.51"></a><span id="l14.51">   var name = dialog.nameField.value;</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-  var uri = dialog.folder;</span>
<a href="#l14.53"></a><span id="l14.53"> </span>
<a href="#l14.54"></a><span id="l14.54">   // do name validity check?</span>
<a href="#l14.55"></a><span id="l14.55"> </span>
<a href="#l14.56"></a><span id="l14.56">   // make sure name ends in  &quot;/&quot; if folder to create can only contain folders</span>
<a href="#l14.57"></a><span id="l14.57">   if ((dialog.folderType == FOLDERS) &amp;&amp; !name.endsWith(&quot;/&quot;))</span>
<a href="#l14.58"></a><span id="l14.58">     dialog.okCallback(name + &quot;/&quot;, dialog.folder);</span>
<a href="#l14.59"></a><span id="l14.59">   else</span>
<a href="#l14.60"></a><span id="l14.60">     dialog.okCallback(name, dialog.folder);</span>
<a href="#l14.61"></a><span id="l14.61"> }</span>
<a href="#l14.62"></a><span id="l14.62"> </span>
<a href="#l14.63"></a><span id="l14.63" class="difflineminus">-function onFoldersOnly()</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineminus">-{</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+function onFoldersOnly() {</span>
<a href="#l14.66"></a><span id="l14.66">   dialog.folderType = FOLDERS;</span>
<a href="#l14.67"></a><span id="l14.67"> }</span>
<a href="#l14.68"></a><span id="l14.68"> </span>
<a href="#l14.69"></a><span id="l14.69" class="difflineminus">-function onMessagesOnly()</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineminus">-{</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+function onMessagesOnly() {</span>
<a href="#l14.72"></a><span id="l14.72">   dialog.folderType = MESSAGES;</span>
<a href="#l14.73"></a><span id="l14.73"> }</span>
<a href="#l14.74"></a><span id="l14.74"> </span>
<a href="#l14.75"></a><span id="l14.75" class="difflineminus">-function doEnabling()</span>
<a href="#l14.76"></a><span id="l14.76" class="difflineminus">-{</span>
<a href="#l14.77"></a><span id="l14.77" class="difflineplus">+function doEnabling() {</span>
<a href="#l14.78"></a><span id="l14.78">   document.documentElement.getButton(&quot;accept&quot;).disabled = !dialog.nameField.value;</span>
<a href="#l14.79"></a><span id="l14.79"> }</span>
<a href="#l14.80"></a><span id="l14.80"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/content/newmailalert.js</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/content/newmailalert.js</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -14,18 +14,17 @@ var NS_ALERT_TOP = 4;</span>
<a href="#l15.4"></a><span id="l15.4"> var gNumNewMsgsToShowInAlert = 4; // the more messages we show in the alert, the larger it will be</span>
<a href="#l15.5"></a><span id="l15.5"> var gOpenTime = 4000; // total time the alert should stay up once we are done animating.</span>
<a href="#l15.6"></a><span id="l15.6"> </span>
<a href="#l15.7"></a><span id="l15.7"> var gAlertListener = null;</span>
<a href="#l15.8"></a><span id="l15.8"> var gPendingPreviewFetchRequests = 0;</span>
<a href="#l15.9"></a><span id="l15.9"> var gUserInitiated = false;</span>
<a href="#l15.10"></a><span id="l15.10"> var gOrigin = 0; // Default value: alert from bottom right.</span>
<a href="#l15.11"></a><span id="l15.11"> </span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-function prefillAlertInfo()</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineminus">-{</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+function prefillAlertInfo() {</span>
<a href="#l15.15"></a><span id="l15.15">   // unwrap all the args....</span>
<a href="#l15.16"></a><span id="l15.16">   // arguments[0] --&gt; nsIArray of folders with new mail</span>
<a href="#l15.17"></a><span id="l15.17">   // arguments[1] --&gt; the observer to call back with notifications about the alert</span>
<a href="#l15.18"></a><span id="l15.18">   // arguments[2] --&gt; user initiated boolean. true if the user initiated opening the alert</span>
<a href="#l15.19"></a><span id="l15.19">   //                 (which means skip the fade effect and don't auto close the alert)</span>
<a href="#l15.20"></a><span id="l15.20">   // arguments[3] --&gt; the alert origin returned by the look and feel</span>
<a href="#l15.21"></a><span id="l15.21">   var foldersWithNewMail = window.arguments[0];</span>
<a href="#l15.22"></a><span id="l15.22">   gAlertListener = window.arguments[1];</span>
<a href="#l15.23"></a><span id="l15.23" class="difflineat">@@ -36,31 +35,30 @@ function prefillAlertInfo()</span>
<a href="#l15.24"></a><span id="l15.24">   // for the account that has new mail. If we can't find a folder, just</span>
<a href="#l15.25"></a><span id="l15.25">   // return to avoid the exception and empty dialog in upper left-hand corner.</span>
<a href="#l15.26"></a><span id="l15.26">   if (!foldersWithNewMail || foldersWithNewMail.length &lt; 1)</span>
<a href="#l15.27"></a><span id="l15.27">     return;</span>
<a href="#l15.28"></a><span id="l15.28">   let rootFolder = foldersWithNewMail.queryElementAt(0, Ci.nsIWeakReference)</span>
<a href="#l15.29"></a><span id="l15.29">                                      .QueryReferent(Ci.nsIMsgFolder);</span>
<a href="#l15.30"></a><span id="l15.30"> </span>
<a href="#l15.31"></a><span id="l15.31">   // Generate an account label string based on the root folder.</span>
<a href="#l15.32"></a><span id="l15.32" class="difflineminus">-  var label = document.getElementById('alertTitle');</span>
<a href="#l15.33"></a><span id="l15.33" class="difflineplus">+  var label = document.getElementById(&quot;alertTitle&quot;);</span>
<a href="#l15.34"></a><span id="l15.34">   var totalNumNewMessages = rootFolder.getNumNewMessages(true);</span>
<a href="#l15.35"></a><span id="l15.35">   let message = document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l15.36"></a><span id="l15.36">                         .getString(&quot;newMailAlert_message&quot;);</span>
<a href="#l15.37"></a><span id="l15.37">   label.value = PluralForm.get(totalNumNewMessages, message)</span>
<a href="#l15.38"></a><span id="l15.38">                           .replace(&quot;#1&quot;, rootFolder.prettyName)</span>
<a href="#l15.39"></a><span id="l15.39">                           .replace(&quot;#2&quot;, totalNumNewMessages);</span>
<a href="#l15.40"></a><span id="l15.40"> </span>
<a href="#l15.41"></a><span id="l15.41">   // This is really the root folder and we have to walk through the list to</span>
<a href="#l15.42"></a><span id="l15.42">   // find the real folder that has new mail in it...:(</span>
<a href="#l15.43"></a><span id="l15.43">   let allFolders = rootFolder.descendants;</span>
<a href="#l15.44"></a><span id="l15.44" class="difflineminus">-  var folderSummaryInfoEl = document.getElementById('folderSummaryInfo');</span>
<a href="#l15.45"></a><span id="l15.45" class="difflineplus">+  var folderSummaryInfoEl = document.getElementById(&quot;folderSummaryInfo&quot;);</span>
<a href="#l15.46"></a><span id="l15.46">   folderSummaryInfoEl.mMaxMsgHdrsInPopup = gNumNewMsgsToShowInAlert;</span>
<a href="#l15.47"></a><span id="l15.47" class="difflineminus">-  for (let folder of fixIterator(allFolders, Ci.nsIMsgFolder))</span>
<a href="#l15.48"></a><span id="l15.48" class="difflineminus">-  {</span>
<a href="#l15.49"></a><span id="l15.49" class="difflineplus">+  for (let folder of fixIterator(allFolders, Ci.nsIMsgFolder)) {</span>
<a href="#l15.50"></a><span id="l15.50">     if (folder.hasNewMessages) {</span>
<a href="#l15.51"></a><span id="l15.51">       let notify =</span>
<a href="#l15.52"></a><span id="l15.52">         // Any folder which is an inbox or ...</span>
<a href="#l15.53"></a><span id="l15.53">         folder.getFlag(Ci.nsMsgFolderFlags.Inbox) ||</span>
<a href="#l15.54"></a><span id="l15.54">         // any non-special or non-virtual folder. In other words, we don't</span>
<a href="#l15.55"></a><span id="l15.55">         // notify for Drafts|Trash|SentMail|Templates|Junk|Archive|Queue or virtual.</span>
<a href="#l15.56"></a><span id="l15.56">         !(folder.flags &amp; (Ci.nsMsgFolderFlags.SpecialUse | Ci.nsMsgFolderFlags.Virtual));</span>
<a href="#l15.57"></a><span id="l15.57"> </span>
<a href="#l15.58"></a><span id="l15.58" class="difflineat">@@ -69,60 +67,54 @@ function prefillAlertInfo()</span>
<a href="#l15.59"></a><span id="l15.59">         folderSummaryInfoEl.parseFolder(folder, new urlListener(folder), asyncFetch);</span>
<a href="#l15.60"></a><span id="l15.60">         if (asyncFetch.value)</span>
<a href="#l15.61"></a><span id="l15.61">           gPendingPreviewFetchRequests++;</span>
<a href="#l15.62"></a><span id="l15.62">       }</span>
<a href="#l15.63"></a><span id="l15.63">     }</span>
<a href="#l15.64"></a><span id="l15.64">   }</span>
<a href="#l15.65"></a><span id="l15.65"> }</span>
<a href="#l15.66"></a><span id="l15.66"> </span>
<a href="#l15.67"></a><span id="l15.67" class="difflineminus">-function urlListener(aFolder)</span>
<a href="#l15.68"></a><span id="l15.68" class="difflineminus">-{</span>
<a href="#l15.69"></a><span id="l15.69" class="difflineplus">+function urlListener(aFolder) {</span>
<a href="#l15.70"></a><span id="l15.70">   this.mFolder = aFolder;</span>
<a href="#l15.71"></a><span id="l15.71"> }</span>
<a href="#l15.72"></a><span id="l15.72"> </span>
<a href="#l15.73"></a><span id="l15.73" class="difflineminus">-urlListener.prototype =</span>
<a href="#l15.74"></a><span id="l15.74" class="difflineminus">-{</span>
<a href="#l15.75"></a><span id="l15.75" class="difflineminus">-  OnStartRunningUrl: function(aUrl)</span>
<a href="#l15.76"></a><span id="l15.76" class="difflineminus">-  {</span>
<a href="#l15.77"></a><span id="l15.77" class="difflineplus">+urlListener.prototype = {</span>
<a href="#l15.78"></a><span id="l15.78" class="difflineplus">+  OnStartRunningUrl(aUrl) {</span>
<a href="#l15.79"></a><span id="l15.79">   },</span>
<a href="#l15.80"></a><span id="l15.80"> </span>
<a href="#l15.81"></a><span id="l15.81" class="difflineminus">-  OnStopRunningUrl: function(aUrl, aExitCode)</span>
<a href="#l15.82"></a><span id="l15.82" class="difflineminus">-  {</span>
<a href="#l15.83"></a><span id="l15.83" class="difflineplus">+  OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l15.84"></a><span id="l15.84">     let folderSummaryInfoEl = document.getElementById(&quot;folderSummaryInfo&quot;);</span>
<a href="#l15.85"></a><span id="l15.85">     folderSummaryInfoEl.parseFolder(this.mFolder, null, {});</span>
<a href="#l15.86"></a><span id="l15.86">     gPendingPreviewFetchRequests--;</span>
<a href="#l15.87"></a><span id="l15.87"> </span>
<a href="#l15.88"></a><span id="l15.88">     // when we are done running all of our urls for fetching the preview text,</span>
<a href="#l15.89"></a><span id="l15.89">     // start the alert.</span>
<a href="#l15.90"></a><span id="l15.90">     if (!gPendingPreviewFetchRequests)</span>
<a href="#l15.91"></a><span id="l15.91">       showAlert();</span>
<a href="#l15.92"></a><span id="l15.92" class="difflineminus">-  }</span>
<a href="#l15.93"></a><span id="l15.93" class="difflineminus">-}</span>
<a href="#l15.94"></a><span id="l15.94" class="difflineplus">+  },</span>
<a href="#l15.95"></a><span id="l15.95" class="difflineplus">+};</span>
<a href="#l15.96"></a><span id="l15.96"> </span>
<a href="#l15.97"></a><span id="l15.97" class="difflineminus">-function onAlertLoad()</span>
<a href="#l15.98"></a><span id="l15.98" class="difflineminus">-{</span>
<a href="#l15.99"></a><span id="l15.99" class="difflineplus">+function onAlertLoad() {</span>
<a href="#l15.100"></a><span id="l15.100">   prefillAlertInfo();</span>
<a href="#l15.101"></a><span id="l15.101"> </span>
<a href="#l15.102"></a><span id="l15.102">   gOpenTime = Services.prefs.getIntPref(&quot;alerts.totalOpenTime&quot;);</span>
<a href="#l15.103"></a><span id="l15.103"> </span>
<a href="#l15.104"></a><span id="l15.104">   // bogus call to make sure the window is moved offscreen until we are ready for it.</span>
<a href="#l15.105"></a><span id="l15.105">   resizeAlert(true);</span>
<a href="#l15.106"></a><span id="l15.106"> </span>
<a href="#l15.107"></a><span id="l15.107">   // if we aren't waiting to fetch preview text, then go ahead and</span>
<a href="#l15.108"></a><span id="l15.108">   // start showing the alert.</span>
<a href="#l15.109"></a><span id="l15.109">   if (!gPendingPreviewFetchRequests)</span>
<a href="#l15.110"></a><span id="l15.110">     setTimeout(showAlert, 0); // let the JS thread unwind, to give layout</span>
<a href="#l15.111"></a><span id="l15.111">                               // a chance to recompute the styles and widths for our alert text.</span>
<a href="#l15.112"></a><span id="l15.112"> }</span>
<a href="#l15.113"></a><span id="l15.113"> </span>
<a href="#l15.114"></a><span id="l15.114"> // If the user initiated the alert, show it right away, otherwise start opening the alert with</span>
<a href="#l15.115"></a><span id="l15.115"> // the fade effect.</span>
<a href="#l15.116"></a><span id="l15.116" class="difflineminus">-function showAlert()</span>
<a href="#l15.117"></a><span id="l15.117" class="difflineminus">-{</span>
<a href="#l15.118"></a><span id="l15.118" class="difflineplus">+function showAlert() {</span>
<a href="#l15.119"></a><span id="l15.119">   if (!document.getElementById(&quot;folderSummaryInfo&quot;).hasMessages) {</span>
<a href="#l15.120"></a><span id="l15.120">     closeAlert(); // no mail, so don't bother showing the alert...</span>
<a href="#l15.121"></a><span id="l15.121">     return;</span>
<a href="#l15.122"></a><span id="l15.122">   }</span>
<a href="#l15.123"></a><span id="l15.123"> </span>
<a href="#l15.124"></a><span id="l15.124">   // resize the alert based on our current content</span>
<a href="#l15.125"></a><span id="l15.125">   resizeAlert(false);</span>
<a href="#l15.126"></a><span id="l15.126"> </span>
<a href="#l15.127"></a><span id="l15.127" class="difflineat">@@ -140,18 +132,17 @@ function showAlert()</span>
<a href="#l15.128"></a><span id="l15.128">       alertContainer.removeEventListener(&quot;animationend&quot;, hideAlert);</span>
<a href="#l15.129"></a><span id="l15.129">       setTimeout(fadeOutAlert, gOpenTime);</span>
<a href="#l15.130"></a><span id="l15.130">     }</span>
<a href="#l15.131"></a><span id="l15.131">   });</span>
<a href="#l15.132"></a><span id="l15.132"> </span>
<a href="#l15.133"></a><span id="l15.133">   alertContainer.setAttribute(&quot;fade-in&quot;, true);</span>
<a href="#l15.134"></a><span id="l15.134"> }</span>
<a href="#l15.135"></a><span id="l15.135"> </span>
<a href="#l15.136"></a><span id="l15.136" class="difflineminus">-function resizeAlert(aMoveOffScreen)</span>
<a href="#l15.137"></a><span id="l15.137" class="difflineminus">-{</span>
<a href="#l15.138"></a><span id="l15.138" class="difflineplus">+function resizeAlert(aMoveOffScreen) {</span>
<a href="#l15.139"></a><span id="l15.139">   var alertTextBox = document.getElementById(&quot;alertTextBox&quot;);</span>
<a href="#l15.140"></a><span id="l15.140">   var alertImageBox = document.getElementById(&quot;alertImageBox&quot;);</span>
<a href="#l15.141"></a><span id="l15.141">   alertImageBox.style.minHeight = alertTextBox.scrollHeight + &quot;px&quot;;</span>
<a href="#l15.142"></a><span id="l15.142"> </span>
<a href="#l15.143"></a><span id="l15.143">   sizeToContent();</span>
<a href="#l15.144"></a><span id="l15.144"> </span>
<a href="#l15.145"></a><span id="l15.145">   // leftover hack to get the window properly hidden when we first open it</span>
<a href="#l15.146"></a><span id="l15.146">   if (aMoveOffScreen)</span>
<a href="#l15.147"></a><span id="l15.147" class="difflineat">@@ -165,26 +156,24 @@ function resizeAlert(aMoveOffScreen)</span>
<a href="#l15.148"></a><span id="l15.148"> </span>
<a href="#l15.149"></a><span id="l15.149">   // Offset the alert by 10 pixels from the edge of the screen</span>
<a href="#l15.150"></a><span id="l15.150">   y += gOrigin &amp; NS_ALERT_TOP ? 10 : -10;</span>
<a href="#l15.151"></a><span id="l15.151">   x += gOrigin &amp; NS_ALERT_LEFT ? 10 : -10;</span>
<a href="#l15.152"></a><span id="l15.152"> </span>
<a href="#l15.153"></a><span id="l15.153">   window.moveTo(x, y);</span>
<a href="#l15.154"></a><span id="l15.154"> }</span>
<a href="#l15.155"></a><span id="l15.155"> </span>
<a href="#l15.156"></a><span id="l15.156" class="difflineminus">-function fadeOutAlert()</span>
<a href="#l15.157"></a><span id="l15.157" class="difflineminus">-{</span>
<a href="#l15.158"></a><span id="l15.158" class="difflineplus">+function fadeOutAlert() {</span>
<a href="#l15.159"></a><span id="l15.159">   var alertContainer = document.getElementById(&quot;alertContainer&quot;);</span>
<a href="#l15.160"></a><span id="l15.160">   alertContainer.addEventListener(&quot;animationend&quot;, function fadeOut(event) {</span>
<a href="#l15.161"></a><span id="l15.161">     if (event.animationName == &quot;fade-out&quot;) {</span>
<a href="#l15.162"></a><span id="l15.162">       alertContainer.removeEventListener(&quot;animationend&quot;, fadeOut);</span>
<a href="#l15.163"></a><span id="l15.163">       closeAlert();</span>
<a href="#l15.164"></a><span id="l15.164">     }</span>
<a href="#l15.165"></a><span id="l15.165">   });</span>
<a href="#l15.166"></a><span id="l15.166">   alertContainer.setAttribute(&quot;fade-out&quot;, true);</span>
<a href="#l15.167"></a><span id="l15.167"> }</span>
<a href="#l15.168"></a><span id="l15.168"> </span>
<a href="#l15.169"></a><span id="l15.169" class="difflineminus">-function closeAlert()</span>
<a href="#l15.170"></a><span id="l15.170" class="difflineminus">-{</span>
<a href="#l15.171"></a><span id="l15.171" class="difflineplus">+function closeAlert() {</span>
<a href="#l15.172"></a><span id="l15.172">   if (gAlertListener)</span>
<a href="#l15.173"></a><span id="l15.173">     gAlertListener.observe(null, &quot;alertfinished&quot;, &quot;&quot;);</span>
<a href="#l15.174"></a><span id="l15.174">   window.close();</span>
<a href="#l15.175"></a><span id="l15.175"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/content/newsError.js</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/content/newsError.js</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -2,17 +2,17 @@</span>
<a href="#l16.4"></a><span id="l16.4">       //   about:newserror?r=response&amp;m=messageid&amp;k=messagekey&amp;f=folderuri</span>
<a href="#l16.5"></a><span id="l16.5">       // &quot;r&quot; is required; &quot;m&quot; and &quot;f&quot; are optional, but &quot;k&quot; always comes with &quot;m&quot;.</span>
<a href="#l16.6"></a><span id="l16.6"> </span>
<a href="#l16.7"></a><span id="l16.7">       var folderUri;</span>
<a href="#l16.8"></a><span id="l16.8"> </span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10">       function initPage() {</span>
<a href="#l16.11"></a><span id="l16.11">         let uri = document.documentURI;</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-        let query = uri.slice(uri.indexOf(&quot;?&quot;)+1);</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineplus">+        let query = uri.slice(uri.indexOf(&quot;?&quot;) + 1);</span>
<a href="#l16.14"></a><span id="l16.14">         let params = {};</span>
<a href="#l16.15"></a><span id="l16.15">         for (let piece of query.split(&quot;&amp;&quot;)) {</span>
<a href="#l16.16"></a><span id="l16.16">           let [key, value] = piece.split(&quot;=&quot;);</span>
<a href="#l16.17"></a><span id="l16.17">           params[key] = decodeURIComponent(value);</span>
<a href="#l16.18"></a><span id="l16.18">         }</span>
<a href="#l16.19"></a><span id="l16.19"> </span>
<a href="#l16.20"></a><span id="l16.20">         document.getElementById(&quot;ngResp&quot;).textContent = params.r;</span>
<a href="#l16.21"></a><span id="l16.21"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/content/renameFolderDialog.js</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/content/renameFolderDialog.js</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -3,18 +3,17 @@</span>
<a href="#l17.4"></a><span id="l17.4">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.5"></a><span id="l17.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l17.6"></a><span id="l17.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.7"></a><span id="l17.7"> </span>
<a href="#l17.8"></a><span id="l17.8"> var dialog;</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10"> document.addEventListener(&quot;dialogaccept&quot;, onOK);</span>
<a href="#l17.11"></a><span id="l17.11"> </span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">-function onLoad()</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">-{</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineplus">+function onLoad() {</span>
<a href="#l17.15"></a><span id="l17.15">   var windowArgs = window.arguments[0];</span>
<a href="#l17.16"></a><span id="l17.16"> </span>
<a href="#l17.17"></a><span id="l17.17">   dialog = {};</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19">   dialog.OKButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21">   dialog.nameField = document.getElementById(&quot;name&quot;);</span>
<a href="#l17.22"></a><span id="l17.22">   dialog.nameField.value = windowArgs.name;</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineat">@@ -25,23 +24,20 @@ function onLoad()</span>
<a href="#l17.24"></a><span id="l17.24">   dialog.okCallback = windowArgs.okCallback;</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26">   // pre select the folderPicker, based on what they selected in the folder pane</span>
<a href="#l17.27"></a><span id="l17.27">   dialog.preselectedFolderURI = windowArgs.preselectedURI;</span>
<a href="#l17.28"></a><span id="l17.28"> </span>
<a href="#l17.29"></a><span id="l17.29">   doEnabling();</span>
<a href="#l17.30"></a><span id="l17.30"> }</span>
<a href="#l17.31"></a><span id="l17.31"> </span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-function onOK()</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-{</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+function onOK() {</span>
<a href="#l17.35"></a><span id="l17.35">   dialog.okCallback(dialog.nameField.value, dialog.preselectedFolderURI);</span>
<a href="#l17.36"></a><span id="l17.36"> }</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-function doEnabling()</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-{</span>
<a href="#l17.40"></a><span id="l17.40" class="difflineplus">+function doEnabling() {</span>
<a href="#l17.41"></a><span id="l17.41">   if (dialog.nameField.value) {</span>
<a href="#l17.42"></a><span id="l17.42">     if (dialog.OKButton.disabled)</span>
<a href="#l17.43"></a><span id="l17.43">       dialog.OKButton.disabled = false;</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-  } else {</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">-    if (!dialog.OKButton.disabled)</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-      dialog.OKButton.disabled = true;</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+  } else if (!dialog.OKButton.disabled) {</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+    dialog.OKButton.disabled = true;</span>
<a href="#l17.49"></a><span id="l17.49">   }</span>
<a href="#l17.50"></a><span id="l17.50"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/content/retention.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/content/retention.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -1,42 +1,40 @@</span>
<a href="#l18.4"></a><span id="l18.4"> /*</span>
<a href="#l18.5"></a><span id="l18.5">  * -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l18.6"></a><span id="l18.6">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.7"></a><span id="l18.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l18.8"></a><span id="l18.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+/* globals gLockedPref */// From either folderProps.js or am-offline.js.</span>
<a href="#l18.11"></a><span id="l18.11"> </span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-function initCommonRetentionSettings(retentionSettings)</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-{</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+function initCommonRetentionSettings(retentionSettings) {</span>
<a href="#l18.15"></a><span id="l18.15">   document.getElementById(&quot;retention.keepMsg&quot;).value = retentionSettings.retainByPreference;</span>
<a href="#l18.16"></a><span id="l18.16">   document.getElementById(&quot;retention.keepOldMsgMin&quot;).value =</span>
<a href="#l18.17"></a><span id="l18.17">     (retentionSettings.daysToKeepHdrs &gt; 0) ? retentionSettings.daysToKeepHdrs : 30;</span>
<a href="#l18.18"></a><span id="l18.18">   document.getElementById(&quot;retention.keepNewMsgMin&quot;).value =</span>
<a href="#l18.19"></a><span id="l18.19">     (retentionSettings.numHeadersToKeep &gt; 0) ? retentionSettings.numHeadersToKeep : 2000;</span>
<a href="#l18.20"></a><span id="l18.20"> </span>
<a href="#l18.21"></a><span id="l18.21">   document.getElementById(&quot;retention.applyToFlagged&quot;).checked =</span>
<a href="#l18.22"></a><span id="l18.22">     !retentionSettings.applyToFlaggedMessages;</span>
<a href="#l18.23"></a><span id="l18.23"> }</span>
<a href="#l18.24"></a><span id="l18.24"> </span>
<a href="#l18.25"></a><span id="l18.25" class="difflineminus">-function saveCommonRetentionSettings(aRetentionSettings)</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineminus">-{</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+function saveCommonRetentionSettings(aRetentionSettings) {</span>
<a href="#l18.28"></a><span id="l18.28">   aRetentionSettings.retainByPreference = document.getElementById(&quot;retention.keepMsg&quot;).value;</span>
<a href="#l18.29"></a><span id="l18.29"> </span>
<a href="#l18.30"></a><span id="l18.30">   aRetentionSettings.daysToKeepHdrs = document.getElementById(&quot;retention.keepOldMsgMin&quot;).value;</span>
<a href="#l18.31"></a><span id="l18.31">   aRetentionSettings.numHeadersToKeep = document.getElementById(&quot;retention.keepNewMsgMin&quot;).value;</span>
<a href="#l18.32"></a><span id="l18.32"> </span>
<a href="#l18.33"></a><span id="l18.33">   aRetentionSettings.applyToFlaggedMessages =</span>
<a href="#l18.34"></a><span id="l18.34">     !document.getElementById(&quot;retention.applyToFlagged&quot;).checked;</span>
<a href="#l18.35"></a><span id="l18.35"> </span>
<a href="#l18.36"></a><span id="l18.36">   return aRetentionSettings;</span>
<a href="#l18.37"></a><span id="l18.37"> }</span>
<a href="#l18.38"></a><span id="l18.38"> </span>
<a href="#l18.39"></a><span id="l18.39" class="difflineminus">-function onCheckKeepMsg()</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineminus">-{</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+function onCheckKeepMsg() {</span>
<a href="#l18.42"></a><span id="l18.42">   if (gLockedPref &amp;&amp; gLockedPref[&quot;retention.keepMsg&quot;]) {</span>
<a href="#l18.43"></a><span id="l18.43">     // if the pref associated with the radiobutton is locked, as indicated</span>
<a href="#l18.44"></a><span id="l18.44">     // by the gLockedPref, skip this function.  All elements in this</span>
<a href="#l18.45"></a><span id="l18.45">     // radiogroup have been locked by the function onLockPreference.</span>
<a href="#l18.46"></a><span id="l18.46">     return;</span>
<a href="#l18.47"></a><span id="l18.47">   }</span>
<a href="#l18.48"></a><span id="l18.48"> </span>
<a href="#l18.49"></a><span id="l18.49">   var keepMsg = document.getElementById(&quot;retention.keepMsg&quot;).value;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/content/shutdownWindow.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/content/shutdownWindow.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -8,92 +8,79 @@ var curTaskIndex = 0;</span>
<a href="#l19.4"></a><span id="l19.4"> var numTasks = 0;</span>
<a href="#l19.5"></a><span id="l19.5"> var stringBundle;</span>
<a href="#l19.6"></a><span id="l19.6"> </span>
<a href="#l19.7"></a><span id="l19.7"> var msgShutdownService = Cc[&quot;@mozilla.org/messenger/msgshutdownservice;1&quot;]</span>
<a href="#l19.8"></a><span id="l19.8">                            .getService(Ci.nsIMsgShutdownService);</span>
<a href="#l19.9"></a><span id="l19.9"> </span>
<a href="#l19.10"></a><span id="l19.10"> document.addEventListener(&quot;dialogcancel&quot;, onCancel);</span>
<a href="#l19.11"></a><span id="l19.11"> </span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-function onLoad()</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-{</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineplus">+function onLoad() {</span>
<a href="#l19.15"></a><span id="l19.15">   numTasks = msgShutdownService.getNumTasks();</span>
<a href="#l19.16"></a><span id="l19.16"> </span>
<a href="#l19.17"></a><span id="l19.17">   stringBundle = document.getElementById(&quot;bundle_shutdown&quot;);</span>
<a href="#l19.18"></a><span id="l19.18">   document.title = stringBundle.getString(&quot;shutdownDialogTitle&quot;);</span>
<a href="#l19.19"></a><span id="l19.19"> </span>
<a href="#l19.20"></a><span id="l19.20">   updateTaskProgressLabel(1);</span>
<a href="#l19.21"></a><span id="l19.21">   updateProgressMeter(0);</span>
<a href="#l19.22"></a><span id="l19.22"> </span>
<a href="#l19.23"></a><span id="l19.23">   msgShutdownService.startShutdownTasks();</span>
<a href="#l19.24"></a><span id="l19.24"> }</span>
<a href="#l19.25"></a><span id="l19.25"> </span>
<a href="#l19.26"></a><span id="l19.26" class="difflineminus">-function updateProgressLabel(inTaskName)</span>
<a href="#l19.27"></a><span id="l19.27" class="difflineminus">-{</span>
<a href="#l19.28"></a><span id="l19.28" class="difflineplus">+function updateProgressLabel(inTaskName) {</span>
<a href="#l19.29"></a><span id="l19.29">   var curTaskLabel = document.getElementById(&quot;shutdownStatus_label&quot;);</span>
<a href="#l19.30"></a><span id="l19.30">   curTaskLabel.value = inTaskName;</span>
<a href="#l19.31"></a><span id="l19.31"> }</span>
<a href="#l19.32"></a><span id="l19.32"> </span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-function updateTaskProgressLabel(inCurTaskNum)</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineminus">-{</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+function updateTaskProgressLabel(inCurTaskNum) {</span>
<a href="#l19.36"></a><span id="l19.36">   var taskProgressLabel = document.getElementById(&quot;shutdownTask_label&quot;);</span>
<a href="#l19.37"></a><span id="l19.37">   taskProgressLabel.value = stringBundle.getFormattedString(&quot;taskProgress&quot;, [inCurTaskNum, numTasks]);</span>
<a href="#l19.38"></a><span id="l19.38"> }</span>
<a href="#l19.39"></a><span id="l19.39"> </span>
<a href="#l19.40"></a><span id="l19.40" class="difflineminus">-function updateProgressMeter(inPercent)</span>
<a href="#l19.41"></a><span id="l19.41" class="difflineminus">-{</span>
<a href="#l19.42"></a><span id="l19.42" class="difflineminus">-  var taskProgressmeter = document.getElementById('shutdown_progressmeter');</span>
<a href="#l19.43"></a><span id="l19.43" class="difflineplus">+function updateProgressMeter(inPercent) {</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+  var taskProgressmeter = document.getElementById(&quot;shutdown_progressmeter&quot;);</span>
<a href="#l19.45"></a><span id="l19.45">   taskProgressmeter.value = inPercent;</span>
<a href="#l19.46"></a><span id="l19.46"> }</span>
<a href="#l19.47"></a><span id="l19.47"> </span>
<a href="#l19.48"></a><span id="l19.48" class="difflineminus">-function onCancel()</span>
<a href="#l19.49"></a><span id="l19.49" class="difflineminus">-{</span>
<a href="#l19.50"></a><span id="l19.50" class="difflineplus">+function onCancel() {</span>
<a href="#l19.51"></a><span id="l19.51">   msgShutdownService.cancelShutdownTasks();</span>
<a href="#l19.52"></a><span id="l19.52"> }</span>
<a href="#l19.53"></a><span id="l19.53"> </span>
<a href="#l19.54"></a><span id="l19.54" class="difflineminus">-function nsMsgShutdownTaskListener()</span>
<a href="#l19.55"></a><span id="l19.55" class="difflineminus">-{</span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+function nsMsgShutdownTaskListener() {</span>
<a href="#l19.57"></a><span id="l19.57">   msgShutdownService.setShutdownListener(this);</span>
<a href="#l19.58"></a><span id="l19.58"> }</span>
<a href="#l19.59"></a><span id="l19.59"> </span>
<a href="#l19.60"></a><span id="l19.60"> nsMsgShutdownTaskListener.prototype =</span>
<a href="#l19.61"></a><span id="l19.61"> {</span>
<a href="#l19.62"></a><span id="l19.62">   QueryInterface: ChromeUtils.generateQI([&quot;nsIWebProgressListener&quot;,</span>
<a href="#l19.63"></a><span id="l19.63">                                           &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l19.64"></a><span id="l19.64"> </span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-  onStateChange: function(aWebProgress, aRequest, aStateFlags, aStatus)</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineminus">-  {</span>
<a href="#l19.67"></a><span id="l19.67" class="difflineminus">-    if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP)</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineminus">-    {</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+  onStateChange(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l19.70"></a><span id="l19.70" class="difflineplus">+    if (aStateFlags &amp; Ci.nsIWebProgressListener.STATE_STOP) {</span>
<a href="#l19.71"></a><span id="l19.71">       window.close();</span>
<a href="#l19.72"></a><span id="l19.72">     }</span>
<a href="#l19.73"></a><span id="l19.73">   },</span>
<a href="#l19.74"></a><span id="l19.74"> </span>
<a href="#l19.75"></a><span id="l19.75" class="difflineminus">-  onProgressChange: function(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress)</span>
<a href="#l19.76"></a><span id="l19.76" class="difflineminus">-  {</span>
<a href="#l19.77"></a><span id="l19.77" class="difflineplus">+  onProgressChange(aWebProgress, aRequest, aCurSelfProgress, aMaxSelfProgress, aCurTotalProgress, aMaxTotalProgress) {</span>
<a href="#l19.78"></a><span id="l19.78">     updateProgressMeter(((aCurTotalProgress / aMaxTotalProgress) * 100));</span>
<a href="#l19.79"></a><span id="l19.79">     updateTaskProgressLabel(aCurTotalProgress + 1);</span>
<a href="#l19.80"></a><span id="l19.80">   },</span>
<a href="#l19.81"></a><span id="l19.81"> </span>
<a href="#l19.82"></a><span id="l19.82" class="difflineminus">-  onLocationChange: function(aWebProgress, aRequest, aLocation, aFlags)</span>
<a href="#l19.83"></a><span id="l19.83" class="difflineminus">-  {</span>
<a href="#l19.84"></a><span id="l19.84" class="difflineplus">+  onLocationChange(aWebProgress, aRequest, aLocation, aFlags) {</span>
<a href="#l19.85"></a><span id="l19.85">     // we can ignore this notification</span>
<a href="#l19.86"></a><span id="l19.86">   },</span>
<a href="#l19.87"></a><span id="l19.87"> </span>
<a href="#l19.88"></a><span id="l19.88" class="difflineminus">-  onStatusChange: function(aWebProgress, aRequest, aStatus, aMessage)</span>
<a href="#l19.89"></a><span id="l19.89" class="difflineminus">-  {</span>
<a href="#l19.90"></a><span id="l19.90" class="difflineplus">+  onStatusChange(aWebProgress, aRequest, aStatus, aMessage) {</span>
<a href="#l19.91"></a><span id="l19.91">     if (aMessage)</span>
<a href="#l19.92"></a><span id="l19.92">       updateProgressLabel(aMessage);</span>
<a href="#l19.93"></a><span id="l19.93">   },</span>
<a href="#l19.94"></a><span id="l19.94"> </span>
<a href="#l19.95"></a><span id="l19.95" class="difflineminus">-  onSecurityChange: function(aWebProgress, aRequest, state)</span>
<a href="#l19.96"></a><span id="l19.96" class="difflineminus">-  {</span>
<a href="#l19.97"></a><span id="l19.97" class="difflineminus">-    // we can ignore this notification</span>
<a href="#l19.98"></a><span id="l19.98" class="difflineminus">-  }</span>
<a href="#l19.99"></a><span id="l19.99" class="difflineminus">-</span>
<a href="#l19.100"></a><span id="l19.100" class="difflineminus">-  onContentBlockingEvent: function(aWebProgress, aRequest, aEvent)</span>
<a href="#l19.101"></a><span id="l19.101" class="difflineminus">-  {</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineplus">+  onSecurityChange(aWebProgress, aRequest, state) {</span>
<a href="#l19.103"></a><span id="l19.103">     // we can ignore this notification</span>
<a href="#l19.104"></a><span id="l19.104">   },</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineminus">-}</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+</span>
<a href="#l19.107"></a><span id="l19.107" class="difflineplus">+  onContentBlockingEvent(aWebProgress, aRequest, aEvent) {</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineplus">+    // we can ignore this notification</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineplus">+  },</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+};</span>
<a href="#l19.111"></a><span id="l19.111"> </span>
<a href="#l19.112"></a><span id="l19.112"> var MsgShutdownTaskListener = new nsMsgShutdownTaskListener();</span>
<a href="#l19.113"></a><span id="l19.113"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/content/subscribe.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/content/subscribe.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,12 +1,14 @@</span>
<a href="#l20.4"></a><span id="l20.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.5"></a><span id="l20.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.6"></a><span id="l20.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8" class="difflineplus">+/* import-globals-from ../../../mail/base/content/mailWindow.js */</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineplus">+</span>
<a href="#l20.10"></a><span id="l20.10"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12"> var gSubscribeTree = null;</span>
<a href="#l20.13"></a><span id="l20.13"> var gSubscribeBody = null;</span>
<a href="#l20.14"></a><span id="l20.14"> var okCallback = null;</span>
<a href="#l20.15"></a><span id="l20.15"> var gChangeTable = {};</span>
<a href="#l20.16"></a><span id="l20.16"> var gServerURI = null;</span>
<a href="#l20.17"></a><span id="l20.17"> var gSubscribableServer = null;</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineat">@@ -16,25 +18,23 @@ var gStatusFeedback;</span>
<a href="#l20.19"></a><span id="l20.19"> var gSubscribeDeck = null;</span>
<a href="#l20.20"></a><span id="l20.20"> var gSearchView = null;</span>
<a href="#l20.21"></a><span id="l20.21"> var gSearchTree = null;</span>
<a href="#l20.22"></a><span id="l20.22"> var gSubscribeBundle;</span>
<a href="#l20.23"></a><span id="l20.23"> </span>
<a href="#l20.24"></a><span id="l20.24"> document.addEventListener(&quot;dialogaccept&quot;, subscribeOK);</span>
<a href="#l20.25"></a><span id="l20.25"> document.addEventListener(&quot;dialogcancel&quot;, subscribeCancel);</span>
<a href="#l20.26"></a><span id="l20.26"> </span>
<a href="#l20.27"></a><span id="l20.27" class="difflineminus">-function Stop()</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineminus">-{</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+function Stop() {</span>
<a href="#l20.30"></a><span id="l20.30">   if (gSubscribableServer) {</span>
<a href="#l20.31"></a><span id="l20.31">     gSubscribableServer.stopPopulating(msgWindow);</span>
<a href="#l20.32"></a><span id="l20.32">   }</span>
<a href="#l20.33"></a><span id="l20.33"> }</span>
<a href="#l20.34"></a><span id="l20.34"> </span>
<a href="#l20.35"></a><span id="l20.35" class="difflineminus">-function SetServerTypeSpecificTextValues()</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineminus">-{</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+function SetServerTypeSpecificTextValues() {</span>
<a href="#l20.38"></a><span id="l20.38">   if (!gServerURI)</span>
<a href="#l20.39"></a><span id="l20.39">     return;</span>
<a href="#l20.40"></a><span id="l20.40"> </span>
<a href="#l20.41"></a><span id="l20.41">   let serverType = MailUtils.getExistingFolder(gServerURI).server.type;</span>
<a href="#l20.42"></a><span id="l20.42"> </span>
<a href="#l20.43"></a><span id="l20.43">   // set the server specific ui elements</span>
<a href="#l20.44"></a><span id="l20.44">   let subscribeLabelString = gSubscribeBundle.getString(&quot;subscribeLabel-&quot; + serverType);</span>
<a href="#l20.45"></a><span id="l20.45">   let currentListTab  = &quot;currentListTab-&quot; + serverType;</span>
<a href="#l20.46"></a><span id="l20.46" class="difflineat">@@ -42,44 +42,41 @@ function SetServerTypeSpecificTextValues</span>
<a href="#l20.47"></a><span id="l20.47">   let currentListTabAccesskey = gSubscribeBundle.getString(currentListTab + &quot;.accesskey&quot;);</span>
<a href="#l20.48"></a><span id="l20.48"> </span>
<a href="#l20.49"></a><span id="l20.49">   document.getElementById(&quot;currentListTab&quot;).setAttribute(&quot;label&quot;, currentListTabLabel);</span>
<a href="#l20.50"></a><span id="l20.50">   document.getElementById(&quot;currentListTab&quot;).setAttribute(&quot;accesskey&quot;, currentListTabAccesskey);</span>
<a href="#l20.51"></a><span id="l20.51">   document.getElementById(&quot;newGroupsTab&quot;).collapsed = (serverType != &quot;nntp&quot;); // show newGroupsTab only for nntp servers</span>
<a href="#l20.52"></a><span id="l20.52">   document.getElementById(&quot;subscribeLabel&quot;).setAttribute(&quot;value&quot;, subscribeLabelString);</span>
<a href="#l20.53"></a><span id="l20.53"> }</span>
<a href="#l20.54"></a><span id="l20.54"> </span>
<a href="#l20.55"></a><span id="l20.55" class="difflineminus">-function onServerClick(aFolder)</span>
<a href="#l20.56"></a><span id="l20.56" class="difflineminus">-{</span>
<a href="#l20.57"></a><span id="l20.57" class="difflineplus">+function onServerClick(aFolder) {</span>
<a href="#l20.58"></a><span id="l20.58">   gServerURI = aFolder.server.serverURI;</span>
<a href="#l20.59"></a><span id="l20.59">   let serverMenu = document.getElementById(&quot;serverMenu&quot;);</span>
<a href="#l20.60"></a><span id="l20.60">   serverMenu.menupopup.selectFolder(aFolder);</span>
<a href="#l20.61"></a><span id="l20.61"> </span>
<a href="#l20.62"></a><span id="l20.62">   SetServerTypeSpecificTextValues();</span>
<a href="#l20.63"></a><span id="l20.63">   ShowCurrentList();</span>
<a href="#l20.64"></a><span id="l20.64"> }</span>
<a href="#l20.65"></a><span id="l20.65"> </span>
<a href="#l20.66"></a><span id="l20.66"> var MySubscribeListener = {</span>
<a href="#l20.67"></a><span id="l20.67" class="difflineminus">-  OnDonePopulating: function() {</span>
<a href="#l20.68"></a><span id="l20.68" class="difflineplus">+  OnDonePopulating() {</span>
<a href="#l20.69"></a><span id="l20.69">     gStatusFeedback._stopMeteors();</span>
<a href="#l20.70"></a><span id="l20.70">     document.getElementById(&quot;stopButton&quot;).disabled = true;</span>
<a href="#l20.71"></a><span id="l20.71">     document.getElementById(&quot;refreshButton&quot;).disabled = false;</span>
<a href="#l20.72"></a><span id="l20.72">     document.getElementById(&quot;currentListTab&quot;).disabled = false;</span>
<a href="#l20.73"></a><span id="l20.73">     document.getElementById(&quot;newGroupsTab&quot;).disabled = false;</span>
<a href="#l20.74"></a><span id="l20.74" class="difflineminus">-  }</span>
<a href="#l20.75"></a><span id="l20.75" class="difflineplus">+  },</span>
<a href="#l20.76"></a><span id="l20.76"> };</span>
<a href="#l20.77"></a><span id="l20.77"> </span>
<a href="#l20.78"></a><span id="l20.78" class="difflineminus">-function SetUpTree(forceToServer, getOnlyNew)</span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-{</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+function SetUpTree(forceToServer, getOnlyNew) {</span>
<a href="#l20.81"></a><span id="l20.81">   if (!gServerURI)</span>
<a href="#l20.82"></a><span id="l20.82">     return;</span>
<a href="#l20.83"></a><span id="l20.83"> </span>
<a href="#l20.84"></a><span id="l20.84">   var server = MailUtils.getExistingFolder(gServerURI).server;</span>
<a href="#l20.85"></a><span id="l20.85" class="difflineminus">-  try</span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-  {</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+  try {</span>
<a href="#l20.88"></a><span id="l20.88">     CleanUpSearchView();</span>
<a href="#l20.89"></a><span id="l20.89">     gSubscribableServer = server.QueryInterface(Ci.nsISubscribableServer);</span>
<a href="#l20.90"></a><span id="l20.90"> </span>
<a href="#l20.91"></a><span id="l20.91">     // enable (or disable) the search related UI</span>
<a href="#l20.92"></a><span id="l20.92">     EnableSearchUI();</span>
<a href="#l20.93"></a><span id="l20.93"> </span>
<a href="#l20.94"></a><span id="l20.94">     // clear out the text field when switching server</span>
<a href="#l20.95"></a><span id="l20.95">     gNameField.value = &quot;&quot;;</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineat">@@ -101,54 +98,47 @@ function SetUpTree(forceToServer, getOnl</span>
<a href="#l20.97"></a><span id="l20.97">     document.getElementById(&quot;refreshButton&quot;).disabled = true;</span>
<a href="#l20.98"></a><span id="l20.98"> </span>
<a href="#l20.99"></a><span id="l20.99">     gStatusFeedback._startMeteors();</span>
<a href="#l20.100"></a><span id="l20.100">     gStatusFeedback.setStatusString(&quot;&quot;);</span>
<a href="#l20.101"></a><span id="l20.101">     gStatusFeedback.showStatusString(gSubscribeBundle.getString(&quot;pleaseWaitString&quot;));</span>
<a href="#l20.102"></a><span id="l20.102">     document.getElementById(&quot;stopButton&quot;).disabled = false;</span>
<a href="#l20.103"></a><span id="l20.103"> </span>
<a href="#l20.104"></a><span id="l20.104">     gSubscribableServer.startPopulating(msgWindow, forceToServer, getOnlyNew);</span>
<a href="#l20.105"></a><span id="l20.105" class="difflineminus">-  }</span>
<a href="#l20.106"></a><span id="l20.106" class="difflineminus">-  catch (e)</span>
<a href="#l20.107"></a><span id="l20.107" class="difflineminus">-  {</span>
<a href="#l20.108"></a><span id="l20.108" class="difflineplus">+  } catch (e) {</span>
<a href="#l20.109"></a><span id="l20.109">     if (e.result == 0x80550014) {  // NS_MSG_ERROR_OFFLINE</span>
<a href="#l20.110"></a><span id="l20.110">       gStatusFeedback.setStatusString(gSubscribeBundle.getString(&quot;offlineState&quot;));</span>
<a href="#l20.111"></a><span id="l20.111">     } else {</span>
<a href="#l20.112"></a><span id="l20.112">       Cu.reportError(&quot;Failed to populate subscribe tree: &quot; + e);</span>
<a href="#l20.113"></a><span id="l20.113">       gStatusFeedback.setStatusString(gSubscribeBundle.getString(&quot;errorPopulating&quot;));</span>
<a href="#l20.114"></a><span id="l20.114">     }</span>
<a href="#l20.115"></a><span id="l20.115">     Stop();</span>
<a href="#l20.116"></a><span id="l20.116">   }</span>
<a href="#l20.117"></a><span id="l20.117"> }</span>
<a href="#l20.118"></a><span id="l20.118"> </span>
<a href="#l20.119"></a><span id="l20.119"> </span>
<a href="#l20.120"></a><span id="l20.120" class="difflineminus">-function SubscribeOnUnload()</span>
<a href="#l20.121"></a><span id="l20.121" class="difflineminus">-{</span>
<a href="#l20.122"></a><span id="l20.122" class="difflineplus">+function SubscribeOnUnload() {</span>
<a href="#l20.123"></a><span id="l20.123">   try {</span>
<a href="#l20.124"></a><span id="l20.124">     CleanUpSearchView();</span>
<a href="#l20.125"></a><span id="l20.125" class="difflineminus">-  }</span>
<a href="#l20.126"></a><span id="l20.126" class="difflineminus">-  catch (ex) {</span>
<a href="#l20.127"></a><span id="l20.127" class="difflineplus">+  } catch (ex) {</span>
<a href="#l20.128"></a><span id="l20.128">     dump(&quot;Failed to remove the subscribe tree: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l20.129"></a><span id="l20.129">   }</span>
<a href="#l20.130"></a><span id="l20.130"> }</span>
<a href="#l20.131"></a><span id="l20.131"> </span>
<a href="#l20.132"></a><span id="l20.132" class="difflineminus">-function EnableSearchUI()</span>
<a href="#l20.133"></a><span id="l20.133" class="difflineminus">-{</span>
<a href="#l20.134"></a><span id="l20.134" class="difflineplus">+function EnableSearchUI() {</span>
<a href="#l20.135"></a><span id="l20.135">   if (gSubscribableServer.supportsSubscribeSearch) {</span>
<a href="#l20.136"></a><span id="l20.136" class="difflineminus">-    gNameField.removeAttribute('disabled');</span>
<a href="#l20.137"></a><span id="l20.137" class="difflineminus">-    gNameFieldLabel.removeAttribute('disabled');</span>
<a href="#l20.138"></a><span id="l20.138" class="difflineminus">-  }</span>
<a href="#l20.139"></a><span id="l20.139" class="difflineminus">-  else {</span>
<a href="#l20.140"></a><span id="l20.140" class="difflineminus">-    gNameField.setAttribute('disabled',true);</span>
<a href="#l20.141"></a><span id="l20.141" class="difflineminus">-    gNameFieldLabel.setAttribute('disabled',true);</span>
<a href="#l20.142"></a><span id="l20.142" class="difflineplus">+    gNameField.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l20.143"></a><span id="l20.143" class="difflineplus">+    gNameFieldLabel.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l20.144"></a><span id="l20.144" class="difflineplus">+  } else {</span>
<a href="#l20.145"></a><span id="l20.145" class="difflineplus">+    gNameField.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l20.146"></a><span id="l20.146" class="difflineplus">+    gNameFieldLabel.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l20.147"></a><span id="l20.147">   }</span>
<a href="#l20.148"></a><span id="l20.148"> }</span>
<a href="#l20.149"></a><span id="l20.149"> </span>
<a href="#l20.150"></a><span id="l20.150" class="difflineminus">-function SubscribeOnLoad()</span>
<a href="#l20.151"></a><span id="l20.151" class="difflineminus">-{</span>
<a href="#l20.152"></a><span id="l20.152" class="difflineplus">+function SubscribeOnLoad() {</span>
<a href="#l20.153"></a><span id="l20.153">   gSubscribeBundle = document.getElementById(&quot;bundle_subscribe&quot;);</span>
<a href="#l20.154"></a><span id="l20.154"> </span>
<a href="#l20.155"></a><span id="l20.155">   gSubscribeTree = document.getElementById(&quot;subscribeTree&quot;);</span>
<a href="#l20.156"></a><span id="l20.156">   gSubscribeBody = document.getElementById(&quot;subscribeTreeBody&quot;);</span>
<a href="#l20.157"></a><span id="l20.157">   gSearchTree = document.getElementById(&quot;searchTree&quot;);</span>
<a href="#l20.158"></a><span id="l20.158">   gSearchTree = document.getElementById(&quot;searchTree&quot;);</span>
<a href="#l20.159"></a><span id="l20.159">   gNameField = document.getElementById(&quot;namefield&quot;);</span>
<a href="#l20.160"></a><span id="l20.160">   gNameFieldLabel = document.getElementById(&quot;namefieldlabel&quot;);</span>
<a href="#l20.161"></a><span id="l20.161" class="difflineat">@@ -177,105 +167,95 @@ function SubscribeOnLoad()</span>
<a href="#l20.162"></a><span id="l20.162">   if (folder &amp;&amp; folder.server instanceof Ci.nsISubscribableServer) {</span>
<a href="#l20.163"></a><span id="l20.163">     serverMenu.menupopup.selectFolder(folder.server.rootMsgFolder);</span>
<a href="#l20.164"></a><span id="l20.164">     try {</span>
<a href="#l20.165"></a><span id="l20.165">       CleanUpSearchView();</span>
<a href="#l20.166"></a><span id="l20.166">       gSubscribableServer = folder.server.QueryInterface(Ci.nsISubscribableServer);</span>
<a href="#l20.167"></a><span id="l20.167">       // Enable (or disable) the search related UI.</span>
<a href="#l20.168"></a><span id="l20.168">       EnableSearchUI();</span>
<a href="#l20.169"></a><span id="l20.169">       gServerURI = folder.server.serverURI;</span>
<a href="#l20.170"></a><span id="l20.170" class="difflineminus">-    }</span>
<a href="#l20.171"></a><span id="l20.171" class="difflineminus">-    catch (ex) {</span>
<a href="#l20.172"></a><span id="l20.172" class="difflineminus">-      //dump(&quot;not a subscribable server\n&quot;);</span>
<a href="#l20.173"></a><span id="l20.173" class="difflineplus">+    } catch (ex) {</span>
<a href="#l20.174"></a><span id="l20.174" class="difflineplus">+      // dump(&quot;not a subscribable server\n&quot;);</span>
<a href="#l20.175"></a><span id="l20.175">       CleanUpSearchView();</span>
<a href="#l20.176"></a><span id="l20.176">       gSubscribableServer = null;</span>
<a href="#l20.177"></a><span id="l20.177">       gServerURI = null;</span>
<a href="#l20.178"></a><span id="l20.178">     }</span>
<a href="#l20.179"></a><span id="l20.179">   }</span>
<a href="#l20.180"></a><span id="l20.180"> </span>
<a href="#l20.181"></a><span id="l20.181">   if (!gServerURI) {</span>
<a href="#l20.182"></a><span id="l20.182" class="difflineminus">-    //dump(&quot;subscribe: no uri\n&quot;);</span>
<a href="#l20.183"></a><span id="l20.183" class="difflineminus">-    //dump(&quot;xxx todo:  use the default news server.  right now, I'm just using the first server\n&quot;);</span>
<a href="#l20.184"></a><span id="l20.184" class="difflineplus">+    // dump(&quot;subscribe: no uri\n&quot;);</span>
<a href="#l20.185"></a><span id="l20.185" class="difflineplus">+    // dump(&quot;xxx todo:  use the default news server.  right now, I'm just using the first server\n&quot;);</span>
<a href="#l20.186"></a><span id="l20.186"> </span>
<a href="#l20.187"></a><span id="l20.187">     serverMenu.selectedIndex = 0;</span>
<a href="#l20.188"></a><span id="l20.188"> </span>
<a href="#l20.189"></a><span id="l20.189">     if (serverMenu.selectedItem) {</span>
<a href="#l20.190"></a><span id="l20.190">       gServerURI = serverMenu.selectedItem.getAttribute(&quot;id&quot;);</span>
<a href="#l20.191"></a><span id="l20.191" class="difflineminus">-    }</span>
<a href="#l20.192"></a><span id="l20.192" class="difflineminus">-    else {</span>
<a href="#l20.193"></a><span id="l20.193" class="difflineminus">-      //dump(&quot;xxx todo none of your servers are subscribable\n&quot;);</span>
<a href="#l20.194"></a><span id="l20.194" class="difflineminus">-      //dump(&quot;xxx todo fix this by disabling subscribe if no subscribable server or, add a CREATE SERVER button, like in 4.x\n&quot;);</span>
<a href="#l20.195"></a><span id="l20.195" class="difflineplus">+    } else {</span>
<a href="#l20.196"></a><span id="l20.196" class="difflineplus">+      // dump(&quot;xxx todo none of your servers are subscribable\n&quot;);</span>
<a href="#l20.197"></a><span id="l20.197" class="difflineplus">+      // dump(&quot;xxx todo fix this by disabling subscribe if no subscribable server or, add a CREATE SERVER button, like in 4.x\n&quot;);</span>
<a href="#l20.198"></a><span id="l20.198">       return;</span>
<a href="#l20.199"></a><span id="l20.199">     }</span>
<a href="#l20.200"></a><span id="l20.200">   }</span>
<a href="#l20.201"></a><span id="l20.201"> </span>
<a href="#l20.202"></a><span id="l20.202">   SetServerTypeSpecificTextValues();</span>
<a href="#l20.203"></a><span id="l20.203"> </span>
<a href="#l20.204"></a><span id="l20.204">   ShowCurrentList();</span>
<a href="#l20.205"></a><span id="l20.205"> </span>
<a href="#l20.206"></a><span id="l20.206">   gNameField.focus();</span>
<a href="#l20.207"></a><span id="l20.207"> }</span>
<a href="#l20.208"></a><span id="l20.208"> </span>
<a href="#l20.209"></a><span id="l20.209" class="difflineminus">-function subscribeOK()</span>
<a href="#l20.210"></a><span id="l20.210" class="difflineminus">-{</span>
<a href="#l20.211"></a><span id="l20.211" class="difflineplus">+function subscribeOK() {</span>
<a href="#l20.212"></a><span id="l20.212">   if (top.okCallback) {</span>
<a href="#l20.213"></a><span id="l20.213">     top.okCallback(top.gChangeTable);</span>
<a href="#l20.214"></a><span id="l20.214">   }</span>
<a href="#l20.215"></a><span id="l20.215">   Stop();</span>
<a href="#l20.216"></a><span id="l20.216">   if (gSubscribableServer) {</span>
<a href="#l20.217"></a><span id="l20.217">     gSubscribableServer.subscribeCleanup();</span>
<a href="#l20.218"></a><span id="l20.218">   }</span>
<a href="#l20.219"></a><span id="l20.219"> }</span>
<a href="#l20.220"></a><span id="l20.220"> </span>
<a href="#l20.221"></a><span id="l20.221" class="difflineminus">-function subscribeCancel()</span>
<a href="#l20.222"></a><span id="l20.222" class="difflineminus">-{</span>
<a href="#l20.223"></a><span id="l20.223" class="difflineplus">+function subscribeCancel() {</span>
<a href="#l20.224"></a><span id="l20.224">   Stop();</span>
<a href="#l20.225"></a><span id="l20.225">   if (gSubscribableServer) {</span>
<a href="#l20.226"></a><span id="l20.226">     gSubscribableServer.subscribeCleanup();</span>
<a href="#l20.227"></a><span id="l20.227">   }</span>
<a href="#l20.228"></a><span id="l20.228"> }</span>
<a href="#l20.229"></a><span id="l20.229"> </span>
<a href="#l20.230"></a><span id="l20.230" class="difflineminus">-function SetState(name, state)</span>
<a href="#l20.231"></a><span id="l20.231" class="difflineminus">-{</span>
<a href="#l20.232"></a><span id="l20.232" class="difflineplus">+function SetState(name, state) {</span>
<a href="#l20.233"></a><span id="l20.233">   var changed = gSubscribableServer.setState(name, state);</span>
<a href="#l20.234"></a><span id="l20.234">   if (changed)</span>
<a href="#l20.235"></a><span id="l20.235">     StateChanged(name, state);</span>
<a href="#l20.236"></a><span id="l20.236"> }</span>
<a href="#l20.237"></a><span id="l20.237"> </span>
<a href="#l20.238"></a><span id="l20.238" class="difflineminus">-function StateChanged(name,state)</span>
<a href="#l20.239"></a><span id="l20.239" class="difflineminus">-{</span>
<a href="#l20.240"></a><span id="l20.240" class="difflineplus">+function StateChanged(name, state) {</span>
<a href="#l20.241"></a><span id="l20.241">   if (gServerURI in gChangeTable) {</span>
<a href="#l20.242"></a><span id="l20.242">     if (name in gChangeTable[gServerURI]) {</span>
<a href="#l20.243"></a><span id="l20.243">       var oldValue = gChangeTable[gServerURI][name];</span>
<a href="#l20.244"></a><span id="l20.244">       if (oldValue != state)</span>
<a href="#l20.245"></a><span id="l20.245">         delete gChangeTable[gServerURI][name];</span>
<a href="#l20.246"></a><span id="l20.246" class="difflineminus">-    }</span>
<a href="#l20.247"></a><span id="l20.247" class="difflineminus">-    else {</span>
<a href="#l20.248"></a><span id="l20.248" class="difflineplus">+    } else {</span>
<a href="#l20.249"></a><span id="l20.249">       gChangeTable[gServerURI][name] = state;</span>
<a href="#l20.250"></a><span id="l20.250">     }</span>
<a href="#l20.251"></a><span id="l20.251" class="difflineminus">-  }</span>
<a href="#l20.252"></a><span id="l20.252" class="difflineminus">-  else {</span>
<a href="#l20.253"></a><span id="l20.253" class="difflineplus">+  } else {</span>
<a href="#l20.254"></a><span id="l20.254">     gChangeTable[gServerURI] = {};</span>
<a href="#l20.255"></a><span id="l20.255">     gChangeTable[gServerURI][name] = state;</span>
<a href="#l20.256"></a><span id="l20.256">   }</span>
<a href="#l20.257"></a><span id="l20.257"> }</span>
<a href="#l20.258"></a><span id="l20.258"> </span>
<a href="#l20.259"></a><span id="l20.259" class="difflineminus">-function InSearchMode()</span>
<a href="#l20.260"></a><span id="l20.260" class="difflineminus">-{</span>
<a href="#l20.261"></a><span id="l20.261" class="difflineplus">+function InSearchMode() {</span>
<a href="#l20.262"></a><span id="l20.262">   // search is the second card in the deck</span>
<a href="#l20.263"></a><span id="l20.263">   return (gSubscribeDeck.getAttribute(&quot;selectedIndex&quot;) == &quot;1&quot;);</span>
<a href="#l20.264"></a><span id="l20.264"> }</span>
<a href="#l20.265"></a><span id="l20.265"> </span>
<a href="#l20.266"></a><span id="l20.266" class="difflineminus">-function SearchOnClick(event)</span>
<a href="#l20.267"></a><span id="l20.267" class="difflineminus">-{</span>
<a href="#l20.268"></a><span id="l20.268" class="difflineplus">+function SearchOnClick(event) {</span>
<a href="#l20.269"></a><span id="l20.269">   // we only care about button 0 (left click) events</span>
<a href="#l20.270"></a><span id="l20.270">   if (event.button != 0 || event.originalTarget.localName != &quot;treechildren&quot;) return;</span>
<a href="#l20.271"></a><span id="l20.271"> </span>
<a href="#l20.272"></a><span id="l20.272">   let treeCellInfo = gSearchTree.getCellAt(event.clientX, event.clientY);</span>
<a href="#l20.273"></a><span id="l20.273" class="difflineminus">-  if (treeCellInfo.row == -1 || treeCellInfo.row &gt; gSearchView.rowCount-1)</span>
<a href="#l20.274"></a><span id="l20.274" class="difflineplus">+  if (treeCellInfo.row == -1 || treeCellInfo.row &gt; gSearchView.rowCount - 1)</span>
<a href="#l20.275"></a><span id="l20.275">     return;</span>
<a href="#l20.276"></a><span id="l20.276"> </span>
<a href="#l20.277"></a><span id="l20.277">   if (treeCellInfo.col.id == &quot;subscribedColumn2&quot;) {</span>
<a href="#l20.278"></a><span id="l20.278">     if (event.detail != 2) {</span>
<a href="#l20.279"></a><span id="l20.279">       // single clicked on the check box</span>
<a href="#l20.280"></a><span id="l20.280">       // (in the &quot;subscribedColumn2&quot; column) reverse state</span>
<a href="#l20.281"></a><span id="l20.281">       // if double click, do nothing</span>
<a href="#l20.282"></a><span id="l20.282">       ReverseStateFromRow(treeCellInfo.row);</span>
<a href="#l20.283"></a><span id="l20.283" class="difflineat">@@ -284,206 +264,185 @@ function SearchOnClick(event)</span>
<a href="#l20.284"></a><span id="l20.284">     // double clicked on a row, reverse state</span>
<a href="#l20.285"></a><span id="l20.285">     ReverseStateFromRow(treeCellInfo.row);</span>
<a href="#l20.286"></a><span id="l20.286">   }</span>
<a href="#l20.287"></a><span id="l20.287"> </span>
<a href="#l20.288"></a><span id="l20.288">   // invalidate the row</span>
<a href="#l20.289"></a><span id="l20.289">   InvalidateSearchTreeRow(treeCellInfo.row);</span>
<a href="#l20.290"></a><span id="l20.290"> }</span>
<a href="#l20.291"></a><span id="l20.291"> </span>
<a href="#l20.292"></a><span id="l20.292" class="difflineminus">-function ReverseStateFromRow(aRow)</span>
<a href="#l20.293"></a><span id="l20.293" class="difflineminus">-{</span>
<a href="#l20.294"></a><span id="l20.294" class="difflineplus">+function ReverseStateFromRow(aRow) {</span>
<a href="#l20.295"></a><span id="l20.295">   // To determine if the row is subscribed or not,</span>
<a href="#l20.296"></a><span id="l20.296">   // we get the properties for the &quot;subscribedColumn2&quot; cell in the row</span>
<a href="#l20.297"></a><span id="l20.297">   // and look for the &quot;subscribed&quot; property.</span>
<a href="#l20.298"></a><span id="l20.298">   // If the &quot;subscribed&quot; string is in the list of properties</span>
<a href="#l20.299"></a><span id="l20.299">   // we are subscribed.</span>
<a href="#l20.300"></a><span id="l20.300" class="difflineminus">-  let col = gSearchTree.columns[&quot;nameColumn2&quot;];</span>
<a href="#l20.301"></a><span id="l20.301" class="difflineplus">+  let col = gSearchTree.columns.nameColumn2;</span>
<a href="#l20.302"></a><span id="l20.302">   let name = gSearchView.getCellValue(aRow, col);</span>
<a href="#l20.303"></a><span id="l20.303">   let isSubscribed = gSubscribableServer.isSubscribed(name);</span>
<a href="#l20.304"></a><span id="l20.304">   SetStateFromRow(aRow, !isSubscribed);</span>
<a href="#l20.305"></a><span id="l20.305"> }</span>
<a href="#l20.306"></a><span id="l20.306"> </span>
<a href="#l20.307"></a><span id="l20.307" class="difflineminus">-function SetStateFromRow(row, state)</span>
<a href="#l20.308"></a><span id="l20.308" class="difflineminus">-{</span>
<a href="#l20.309"></a><span id="l20.309" class="difflineminus">-  var col = gSearchTree.columns[&quot;nameColumn2&quot;];</span>
<a href="#l20.310"></a><span id="l20.310" class="difflineplus">+function SetStateFromRow(row, state) {</span>
<a href="#l20.311"></a><span id="l20.311" class="difflineplus">+  var col = gSearchTree.columns.nameColumn2;</span>
<a href="#l20.312"></a><span id="l20.312">   var name = gSearchView.getCellValue(row, col);</span>
<a href="#l20.313"></a><span id="l20.313">   SetState(name, state);</span>
<a href="#l20.314"></a><span id="l20.314"> }</span>
<a href="#l20.315"></a><span id="l20.315"> </span>
<a href="#l20.316"></a><span id="l20.316" class="difflineminus">-function SetSubscribeState(state)</span>
<a href="#l20.317"></a><span id="l20.317" class="difflineminus">-{</span>
<a href="#l20.318"></a><span id="l20.318" class="difflineplus">+function SetSubscribeState(state) {</span>
<a href="#l20.319"></a><span id="l20.319">   try {</span>
<a href="#l20.320"></a><span id="l20.320">     // we need to iterate over the tree selection, and set the state for</span>
<a href="#l20.321"></a><span id="l20.321">     // all rows in the selection</span>
<a href="#l20.322"></a><span id="l20.322">     var inSearchMode = InSearchMode();</span>
<a href="#l20.323"></a><span id="l20.323">     var view = inSearchMode ? gSearchView : gSubscribeTree.view;</span>
<a href="#l20.324"></a><span id="l20.324">     var colId = inSearchMode ? &quot;nameColumn2&quot; : &quot;nameColumn&quot;;</span>
<a href="#l20.325"></a><span id="l20.325"> </span>
<a href="#l20.326"></a><span id="l20.326">     var sel = view.selection;</span>
<a href="#l20.327"></a><span id="l20.327">     for (var i = 0; i &lt; sel.getRangeCount(); ++i) {</span>
<a href="#l20.328"></a><span id="l20.328">       var start = {}, end = {};</span>
<a href="#l20.329"></a><span id="l20.329">       sel.getRangeAt(i, start, end);</span>
<a href="#l20.330"></a><span id="l20.330">       for (var k = start.value; k &lt;= end.value; ++k) {</span>
<a href="#l20.331"></a><span id="l20.331" class="difflineminus">-        if (inSearchMode)</span>
<a href="#l20.332"></a><span id="l20.332" class="difflineplus">+        if (inSearchMode) {</span>
<a href="#l20.333"></a><span id="l20.333">           SetStateFromRow(k, state);</span>
<a href="#l20.334"></a><span id="l20.334" class="difflineminus">-        else {</span>
<a href="#l20.335"></a><span id="l20.335" class="difflineplus">+        } else {</span>
<a href="#l20.336"></a><span id="l20.336">           let name = view.getCellValue(k, gSubscribeTree.columns[colId]);</span>
<a href="#l20.337"></a><span id="l20.337">           SetState(name, state, k);</span>
<a href="#l20.338"></a><span id="l20.338">         }</span>
<a href="#l20.339"></a><span id="l20.339">       }</span>
<a href="#l20.340"></a><span id="l20.340">     }</span>
<a href="#l20.341"></a><span id="l20.341"> </span>
<a href="#l20.342"></a><span id="l20.342">     if (inSearchMode) {</span>
<a href="#l20.343"></a><span id="l20.343">       // force a repaint</span>
<a href="#l20.344"></a><span id="l20.344">       InvalidateSearchTree();</span>
<a href="#l20.345"></a><span id="l20.345">     }</span>
<a href="#l20.346"></a><span id="l20.346" class="difflineminus">-  }</span>
<a href="#l20.347"></a><span id="l20.347" class="difflineminus">-  catch (ex) {</span>
<a href="#l20.348"></a><span id="l20.348" class="difflineplus">+  } catch (ex) {</span>
<a href="#l20.349"></a><span id="l20.349">     dump(&quot;SetSubscribedState failed:  &quot; + ex + &quot;\n&quot;);</span>
<a href="#l20.350"></a><span id="l20.350">   }</span>
<a href="#l20.351"></a><span id="l20.351"> }</span>
<a href="#l20.352"></a><span id="l20.352"> </span>
<a href="#l20.353"></a><span id="l20.353" class="difflineminus">-function ReverseStateFromNode(row)</span>
<a href="#l20.354"></a><span id="l20.354" class="difflineminus">-{</span>
<a href="#l20.355"></a><span id="l20.355" class="difflineminus">-  let name = gSubscribeTree.view.getCellValue(row, gSubscribeTree.columns[&quot;nameColumn&quot;]);</span>
<a href="#l20.356"></a><span id="l20.356" class="difflineplus">+function ReverseStateFromNode(row) {</span>
<a href="#l20.357"></a><span id="l20.357" class="difflineplus">+  let name = gSubscribeTree.view.getCellValue(row, gSubscribeTree.columns.nameColumn);</span>
<a href="#l20.358"></a><span id="l20.358">   SetState(name, !gSubscribableServer.isSubscribed(name), row);</span>
<a href="#l20.359"></a><span id="l20.359"> }</span>
<a href="#l20.360"></a><span id="l20.360"> </span>
<a href="#l20.361"></a><span id="l20.361" class="difflineminus">-function SubscribeOnClick(event)</span>
<a href="#l20.362"></a><span id="l20.362" class="difflineminus">-{</span>
<a href="#l20.363"></a><span id="l20.363" class="difflineplus">+function SubscribeOnClick(event) {</span>
<a href="#l20.364"></a><span id="l20.364">   // we only care about button 0 (left click) events</span>
<a href="#l20.365"></a><span id="l20.365">   if (event.button != 0 || event.originalTarget.localName != &quot;treechildren&quot;)</span>
<a href="#l20.366"></a><span id="l20.366">    return;</span>
<a href="#l20.367"></a><span id="l20.367"> </span>
<a href="#l20.368"></a><span id="l20.368">   let treeCellInfo = gSubscribeTree.getCellAt(event.clientX, event.clientY);</span>
<a href="#l20.369"></a><span id="l20.369">   if (treeCellInfo.row == -1 || treeCellInfo.row &gt; (gSubscribeTree.view.rowCount - 1))</span>
<a href="#l20.370"></a><span id="l20.370">     return;</span>
<a href="#l20.371"></a><span id="l20.371"> </span>
<a href="#l20.372"></a><span id="l20.372">   if (event.detail == 2) {</span>
<a href="#l20.373"></a><span id="l20.373">     // only toggle subscribed state when double clicking something</span>
<a href="#l20.374"></a><span id="l20.374">     // that isn't a container</span>
<a href="#l20.375"></a><span id="l20.375">     if (!gSubscribeTree.view.isContainer(treeCellInfo.row)) {</span>
<a href="#l20.376"></a><span id="l20.376">       ReverseStateFromNode(treeCellInfo.row);</span>
<a href="#l20.377"></a><span id="l20.377" class="difflineminus">-      return;</span>
<a href="#l20.378"></a><span id="l20.378">     }</span>
<a href="#l20.379"></a><span id="l20.379" class="difflineminus">-  }</span>
<a href="#l20.380"></a><span id="l20.380" class="difflineminus">-  else if (event.detail == 1)</span>
<a href="#l20.381"></a><span id="l20.381" class="difflineminus">-  {</span>
<a href="#l20.382"></a><span id="l20.382" class="difflineplus">+  } else if (event.detail == 1) {</span>
<a href="#l20.383"></a><span id="l20.383">     // if the user single clicks on the subscribe check box, we handle it here</span>
<a href="#l20.384"></a><span id="l20.384">     if (treeCellInfo.col.id == &quot;subscribedColumn&quot;)</span>
<a href="#l20.385"></a><span id="l20.385">       ReverseStateFromNode(treeCellInfo.row);</span>
<a href="#l20.386"></a><span id="l20.386">   }</span>
<a href="#l20.387"></a><span id="l20.387"> }</span>
<a href="#l20.388"></a><span id="l20.388"> </span>
<a href="#l20.389"></a><span id="l20.389" class="difflineminus">-function Refresh()</span>
<a href="#l20.390"></a><span id="l20.390" class="difflineminus">-{</span>
<a href="#l20.391"></a><span id="l20.391" class="difflineplus">+function Refresh() {</span>
<a href="#l20.392"></a><span id="l20.392">   // clear out the textfield's entry</span>
<a href="#l20.393"></a><span id="l20.393">   gNameField.value = &quot;&quot;;</span>
<a href="#l20.394"></a><span id="l20.394"> </span>
<a href="#l20.395"></a><span id="l20.395">   var newGroupsTab = document.getElementById(&quot;newGroupsTab&quot;);</span>
<a href="#l20.396"></a><span id="l20.396">   SetUpTree(true, newGroupsTab.selected);</span>
<a href="#l20.397"></a><span id="l20.397"> }</span>
<a href="#l20.398"></a><span id="l20.398"> </span>
<a href="#l20.399"></a><span id="l20.399" class="difflineminus">-function ShowCurrentList()</span>
<a href="#l20.400"></a><span id="l20.400" class="difflineminus">-{</span>
<a href="#l20.401"></a><span id="l20.401" class="difflineplus">+function ShowCurrentList() {</span>
<a href="#l20.402"></a><span id="l20.402">   // clear out the textfield's entry on call of Refresh()</span>
<a href="#l20.403"></a><span id="l20.403">   gNameField.value = &quot;&quot;;</span>
<a href="#l20.404"></a><span id="l20.404"> </span>
<a href="#l20.405"></a><span id="l20.405">   // make sure the current list tab is selected</span>
<a href="#l20.406"></a><span id="l20.406">   document.getElementById(&quot;subscribeTabs&quot;).selectedIndex = 0;</span>
<a href="#l20.407"></a><span id="l20.407"> </span>
<a href="#l20.408"></a><span id="l20.408">   // try loading the hostinfo before talk to server</span>
<a href="#l20.409"></a><span id="l20.409">   SetUpTree(false, false);</span>
<a href="#l20.410"></a><span id="l20.410"> }</span>
<a href="#l20.411"></a><span id="l20.411"> </span>
<a href="#l20.412"></a><span id="l20.412" class="difflineminus">-function ShowNewGroupsList()</span>
<a href="#l20.413"></a><span id="l20.413" class="difflineminus">-{</span>
<a href="#l20.414"></a><span id="l20.414" class="difflineplus">+function ShowNewGroupsList() {</span>
<a href="#l20.415"></a><span id="l20.415">   // clear out the textfield's entry</span>
<a href="#l20.416"></a><span id="l20.416">   gNameField.value = &quot;&quot;;</span>
<a href="#l20.417"></a><span id="l20.417"> </span>
<a href="#l20.418"></a><span id="l20.418">   // make sure the new groups tab is selected</span>
<a href="#l20.419"></a><span id="l20.419">   document.getElementById(&quot;subscribeTabs&quot;).selectedIndex = 1;</span>
<a href="#l20.420"></a><span id="l20.420"> </span>
<a href="#l20.421"></a><span id="l20.421">   // force it to talk to the server and get new groups</span>
<a href="#l20.422"></a><span id="l20.422">   SetUpTree(true, true);</span>
<a href="#l20.423"></a><span id="l20.423"> }</span>
<a href="#l20.424"></a><span id="l20.424"> </span>
<a href="#l20.425"></a><span id="l20.425" class="difflineminus">-function InvalidateSearchTreeRow(row)</span>
<a href="#l20.426"></a><span id="l20.426" class="difflineminus">-{</span>
<a href="#l20.427"></a><span id="l20.427" class="difflineminus">-    gSearchTree.invalidateRow(row);</span>
<a href="#l20.428"></a><span id="l20.428" class="difflineplus">+function InvalidateSearchTreeRow(row) {</span>
<a href="#l20.429"></a><span id="l20.429" class="difflineplus">+  gSearchTree.invalidateRow(row);</span>
<a href="#l20.430"></a><span id="l20.430"> }</span>
<a href="#l20.431"></a><span id="l20.431"> </span>
<a href="#l20.432"></a><span id="l20.432" class="difflineminus">-function InvalidateSearchTree()</span>
<a href="#l20.433"></a><span id="l20.433" class="difflineminus">-{</span>
<a href="#l20.434"></a><span id="l20.434" class="difflineminus">-    gSearchTree.invalidate();</span>
<a href="#l20.435"></a><span id="l20.435" class="difflineplus">+function InvalidateSearchTree() {</span>
<a href="#l20.436"></a><span id="l20.436" class="difflineplus">+  gSearchTree.invalidate();</span>
<a href="#l20.437"></a><span id="l20.437"> }</span>
<a href="#l20.438"></a><span id="l20.438"> </span>
<a href="#l20.439"></a><span id="l20.439" class="difflineminus">-function SwitchToNormalView()</span>
<a href="#l20.440"></a><span id="l20.440" class="difflineminus">-{</span>
<a href="#l20.441"></a><span id="l20.441" class="difflineplus">+function SwitchToNormalView() {</span>
<a href="#l20.442"></a><span id="l20.442">   // the first card in the deck is the &quot;normal&quot; view</span>
<a href="#l20.443"></a><span id="l20.443" class="difflineminus">-  gSubscribeDeck.setAttribute(&quot;selectedIndex&quot;,&quot;0&quot;);</span>
<a href="#l20.444"></a><span id="l20.444" class="difflineplus">+  gSubscribeDeck.setAttribute(&quot;selectedIndex&quot;, &quot;0&quot;);</span>
<a href="#l20.445"></a><span id="l20.445"> }</span>
<a href="#l20.446"></a><span id="l20.446"> </span>
<a href="#l20.447"></a><span id="l20.447" class="difflineminus">-function SwitchToSearchView()</span>
<a href="#l20.448"></a><span id="l20.448" class="difflineminus">-{</span>
<a href="#l20.449"></a><span id="l20.449" class="difflineplus">+function SwitchToSearchView() {</span>
<a href="#l20.450"></a><span id="l20.450">   // the second card in the deck is the &quot;search&quot; view</span>
<a href="#l20.451"></a><span id="l20.451" class="difflineminus">-  gSubscribeDeck.setAttribute(&quot;selectedIndex&quot;,&quot;1&quot;);</span>
<a href="#l20.452"></a><span id="l20.452" class="difflineplus">+  gSubscribeDeck.setAttribute(&quot;selectedIndex&quot;, &quot;1&quot;);</span>
<a href="#l20.453"></a><span id="l20.453"> }</span>
<a href="#l20.454"></a><span id="l20.454"> </span>
<a href="#l20.455"></a><span id="l20.455" class="difflineminus">-function Search()</span>
<a href="#l20.456"></a><span id="l20.456" class="difflineminus">-{</span>
<a href="#l20.457"></a><span id="l20.457" class="difflineplus">+function Search() {</span>
<a href="#l20.458"></a><span id="l20.458">   var searchValue = gNameField.value;</span>
<a href="#l20.459"></a><span id="l20.459">   if (searchValue.length &amp;&amp; gSubscribableServer.supportsSubscribeSearch) {</span>
<a href="#l20.460"></a><span id="l20.460">     SwitchToSearchView();</span>
<a href="#l20.461"></a><span id="l20.461">     gSubscribableServer.setSearchValue(searchValue);</span>
<a href="#l20.462"></a><span id="l20.462"> </span>
<a href="#l20.463"></a><span id="l20.463">     if (!gSearchView &amp;&amp; gSubscribableServer) {</span>
<a href="#l20.464"></a><span id="l20.464">     gSearchView = gSubscribableServer.QueryInterface(Ci.nsITreeView);</span>
<a href="#l20.465"></a><span id="l20.465">       gSearchView.selection = null;</span>
<a href="#l20.466"></a><span id="l20.466">     gSearchTree.view = gSearchView;</span>
<a href="#l20.467"></a><span id="l20.467">   }</span>
<a href="#l20.468"></a><span id="l20.468" class="difflineminus">-  }</span>
<a href="#l20.469"></a><span id="l20.469" class="difflineminus">-  else {</span>
<a href="#l20.470"></a><span id="l20.470" class="difflineplus">+  } else {</span>
<a href="#l20.471"></a><span id="l20.471">     SwitchToNormalView();</span>
<a href="#l20.472"></a><span id="l20.472">   }</span>
<a href="#l20.473"></a><span id="l20.473"> }</span>
<a href="#l20.474"></a><span id="l20.474"> </span>
<a href="#l20.475"></a><span id="l20.475" class="difflineminus">-function CleanUpSearchView()</span>
<a href="#l20.476"></a><span id="l20.476" class="difflineminus">-{</span>
<a href="#l20.477"></a><span id="l20.477" class="difflineplus">+function CleanUpSearchView() {</span>
<a href="#l20.478"></a><span id="l20.478">   if (gSearchView) {</span>
<a href="#l20.479"></a><span id="l20.479">     gSearchView.selection = null;</span>
<a href="#l20.480"></a><span id="l20.480">     gSearchView = null;</span>
<a href="#l20.481"></a><span id="l20.481">   }</span>
<a href="#l20.482"></a><span id="l20.482"> }</span>
<a href="#l20.483"></a><span id="l20.483"> </span>
<a href="#l20.484"></a><span id="l20.484" class="difflineminus">-function onSearchTreeKeyPress(event)</span>
<a href="#l20.485"></a><span id="l20.485" class="difflineminus">-{</span>
<a href="#l20.486"></a><span id="l20.486" class="difflineplus">+function onSearchTreeKeyPress(event) {</span>
<a href="#l20.487"></a><span id="l20.487">   // for now, only do something on space key</span>
<a href="#l20.488"></a><span id="l20.488">   if (event.charCode != KeyEvent.DOM_VK_SPACE)</span>
<a href="#l20.489"></a><span id="l20.489">     return;</span>
<a href="#l20.490"></a><span id="l20.490"> </span>
<a href="#l20.491"></a><span id="l20.491">   var treeSelection = gSearchView.selection;</span>
<a href="#l20.492"></a><span id="l20.492" class="difflineminus">-  for (var i=0;i&lt;treeSelection.getRangeCount();i++) {</span>
<a href="#l20.493"></a><span id="l20.493" class="difflineplus">+  for (let i = 0; i &lt; treeSelection.getRangeCount(); i++) {</span>
<a href="#l20.494"></a><span id="l20.494">     var start = {}, end = {};</span>
<a href="#l20.495"></a><span id="l20.495" class="difflineminus">-    treeSelection.getRangeAt(i,start,end);</span>
<a href="#l20.496"></a><span id="l20.496" class="difflineminus">-    for (var k=start.value;k&lt;=end.value;k++)</span>
<a href="#l20.497"></a><span id="l20.497" class="difflineplus">+    treeSelection.getRangeAt(i, start, end);</span>
<a href="#l20.498"></a><span id="l20.498" class="difflineplus">+    for (let k = start.value; k &lt;= end.value; k++)</span>
<a href="#l20.499"></a><span id="l20.499">       ReverseStateFromRow(k);</span>
<a href="#l20.500"></a><span id="l20.500"> </span>
<a href="#l20.501"></a><span id="l20.501">     // force a repaint</span>
<a href="#l20.502"></a><span id="l20.502">     InvalidateSearchTree();</span>
<a href="#l20.503"></a><span id="l20.503">   }</span>
<a href="#l20.504"></a><span id="l20.504"> }</span>
<a href="#l20.505"></a><span id="l20.505"> </span>
<a href="#l20.506"></a><span id="l20.506" class="difflineminus">-function onSubscribeTreeKeyPress(event)</span>
<a href="#l20.507"></a><span id="l20.507" class="difflineminus">-{</span>
<a href="#l20.508"></a><span id="l20.508" class="difflineplus">+function onSubscribeTreeKeyPress(event) {</span>
<a href="#l20.509"></a><span id="l20.509">   // for now, only do something on space key</span>
<a href="#l20.510"></a><span id="l20.510">   if (event.charCode != KeyEvent.DOM_VK_SPACE)</span>
<a href="#l20.511"></a><span id="l20.511">     return;</span>
<a href="#l20.512"></a><span id="l20.512"> </span>
<a href="#l20.513"></a><span id="l20.513">   var treeSelection = gSubscribeTree.view.selection;</span>
<a href="#l20.514"></a><span id="l20.514" class="difflineminus">-  for (var i=0;i&lt;treeSelection.getRangeCount();i++) {</span>
<a href="#l20.515"></a><span id="l20.515" class="difflineplus">+  for (let i = 0; i &lt; treeSelection.getRangeCount(); i++) {</span>
<a href="#l20.516"></a><span id="l20.516">     var start = {}, end = {};</span>
<a href="#l20.517"></a><span id="l20.517" class="difflineminus">-    treeSelection.getRangeAt(i,start,end);</span>
<a href="#l20.518"></a><span id="l20.518" class="difflineminus">-    for (var k=start.value;k&lt;=end.value;k++)</span>
<a href="#l20.519"></a><span id="l20.519" class="difflineplus">+    treeSelection.getRangeAt(i, start, end);</span>
<a href="#l20.520"></a><span id="l20.520" class="difflineplus">+    for (let k = start.value; k &lt;= end.value; k++)</span>
<a href="#l20.521"></a><span id="l20.521">       ReverseStateFromNode(k);</span>
<a href="#l20.522"></a><span id="l20.522">   }</span>
<a href="#l20.523"></a><span id="l20.523"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/content/virtualFolderListEdit.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/content/virtualFolderListEdit.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,61 +1,63 @@</span>
<a href="#l21.4"></a><span id="l21.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.5"></a><span id="l21.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.6"></a><span id="l21.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l21.7"></a><span id="l21.7"> </span>
<a href="#l21.8"></a><span id="l21.8" class="difflineplus">+/* import-globals-from ../../../mail/base/content/folderPane.js */</span>
<a href="#l21.9"></a><span id="l21.9" class="difflineplus">+</span>
<a href="#l21.10"></a><span id="l21.10"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l21.11"></a><span id="l21.11"> </span>
<a href="#l21.12"></a><span id="l21.12"> var gSelectVirtual = {</span>
<a href="#l21.13"></a><span id="l21.13">   _treeElement: null,</span>
<a href="#l21.14"></a><span id="l21.14">   _selectedList: new Set(),</span>
<a href="#l21.15"></a><span id="l21.15"> </span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-  load: function() {</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineplus">+  load() {</span>
<a href="#l21.18"></a><span id="l21.18">     if (window.arguments[0].searchFolderURIs) {</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-      let srchFolderUriArray = window.arguments[0].searchFolderURIs.split('|');</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineplus">+      let srchFolderUriArray = window.arguments[0].searchFolderURIs.split(&quot;|&quot;);</span>
<a href="#l21.21"></a><span id="l21.21">       for (let uri of srchFolderUriArray) {</span>
<a href="#l21.22"></a><span id="l21.22">         this._selectedList.add(MailUtils.getOrCreateFolder(uri));</span>
<a href="#l21.23"></a><span id="l21.23">       }</span>
<a href="#l21.24"></a><span id="l21.24">     }</span>
<a href="#l21.25"></a><span id="l21.25"> </span>
<a href="#l21.26"></a><span id="l21.26">     // Now tweak the folder tree for our purposes here.</span>
<a href="#l21.27"></a><span id="l21.27">     let oldProps = ftvItem.prototype.getProperties;</span>
<a href="#l21.28"></a><span id="l21.28">     ftvItem.prototype.getProperties = function(aColumn) {</span>
<a href="#l21.29"></a><span id="l21.29">       if (!aColumn || aColumn.id != &quot;selectedCol&quot;)</span>
<a href="#l21.30"></a><span id="l21.30">         return oldProps.call(this, aColumn);</span>
<a href="#l21.31"></a><span id="l21.31"> </span>
<a href="#l21.32"></a><span id="l21.32">       let properties = &quot;selectedColumn&quot;;</span>
<a href="#l21.33"></a><span id="l21.33">       if (gSelectVirtual._selectedList.has(this._folder))</span>
<a href="#l21.34"></a><span id="l21.34">         properties += &quot; selected-true&quot;;</span>
<a href="#l21.35"></a><span id="l21.35"> </span>
<a href="#l21.36"></a><span id="l21.36">       return properties;</span>
<a href="#l21.37"></a><span id="l21.37" class="difflineminus">-    }</span>
<a href="#l21.38"></a><span id="l21.38" class="difflineplus">+    };</span>
<a href="#l21.39"></a><span id="l21.39"> </span>
<a href="#l21.40"></a><span id="l21.40">     let modeVirtual = {</span>
<a href="#l21.41"></a><span id="l21.41">       __proto__: IFolderTreeMode,</span>
<a href="#l21.42"></a><span id="l21.42"> </span>
<a href="#l21.43"></a><span id="l21.43" class="difflineminus">-      generateMap: function(ftv) {</span>
<a href="#l21.44"></a><span id="l21.44" class="difflineplus">+      generateMap(ftv) {</span>
<a href="#l21.45"></a><span id="l21.45">         let accounts = gFolderTreeView._sortedAccounts();</span>
<a href="#l21.46"></a><span id="l21.46">         // Force each root folder to do its local subfolder discovery.</span>
<a href="#l21.47"></a><span id="l21.47">         MailUtils.discoverFolders();</span>
<a href="#l21.48"></a><span id="l21.48">         let filterVirtual = function(aFolder) {</span>
<a href="#l21.49"></a><span id="l21.49">           return !aFolder.getFlag(Ci.nsMsgFolderFlags.Virtual);</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineminus">-        }</span>
<a href="#l21.51"></a><span id="l21.51" class="difflineplus">+        };</span>
<a href="#l21.52"></a><span id="l21.52">         return accounts.map(acct =&gt; new ftvItem(acct.incomingServer.rootFolder,</span>
<a href="#l21.53"></a><span id="l21.53">                                                 filterVirtual));</span>
<a href="#l21.54"></a><span id="l21.54" class="difflineminus">-      }</span>
<a href="#l21.55"></a><span id="l21.55" class="difflineplus">+      },</span>
<a href="#l21.56"></a><span id="l21.56">     };</span>
<a href="#l21.57"></a><span id="l21.57">     this._treeElement = document.getElementById(&quot;folderPickerTree&quot;);</span>
<a href="#l21.58"></a><span id="l21.58"> </span>
<a href="#l21.59"></a><span id="l21.59">     gFolderTreeView.registerFolderTreeMode(this._treeElement.getAttribute(&quot;mode&quot;),</span>
<a href="#l21.60"></a><span id="l21.60">                                            modeVirtual, &quot;Virtual Folders&quot;);</span>
<a href="#l21.61"></a><span id="l21.61">     gFolderTreeView.load(this._treeElement);</span>
<a href="#l21.62"></a><span id="l21.62">   },</span>
<a href="#l21.63"></a><span id="l21.63"> </span>
<a href="#l21.64"></a><span id="l21.64" class="difflineminus">-  onKeyPress: function(aEvent) {</span>
<a href="#l21.65"></a><span id="l21.65" class="difflineplus">+  onKeyPress(aEvent) {</span>
<a href="#l21.66"></a><span id="l21.66">     // For now, only do something on space key.</span>
<a href="#l21.67"></a><span id="l21.67">     if (aEvent.charCode != aEvent.DOM_VK_SPACE)</span>
<a href="#l21.68"></a><span id="l21.68">       return;</span>
<a href="#l21.69"></a><span id="l21.69"> </span>
<a href="#l21.70"></a><span id="l21.70">     let selection = this._treeElement.view.selection;</span>
<a href="#l21.71"></a><span id="l21.71">     let start = {};</span>
<a href="#l21.72"></a><span id="l21.72">     let end = {};</span>
<a href="#l21.73"></a><span id="l21.73">     let numRanges = selection.getRangeCount();</span>
<a href="#l21.74"></a><span id="l21.74" class="difflineat">@@ -63,46 +65,46 @@ var gSelectVirtual = {</span>
<a href="#l21.75"></a><span id="l21.75">     for (let range = 0; range &lt; numRanges; range++) {</span>
<a href="#l21.76"></a><span id="l21.76">       selection.getRangeAt(range, start, end);</span>
<a href="#l21.77"></a><span id="l21.77">       for (let i = start.value; i &lt;= end.value; i++) {</span>
<a href="#l21.78"></a><span id="l21.78">         this._toggle(i);</span>
<a href="#l21.79"></a><span id="l21.79">       }</span>
<a href="#l21.80"></a><span id="l21.80">     }</span>
<a href="#l21.81"></a><span id="l21.81">   },</span>
<a href="#l21.82"></a><span id="l21.82"> </span>
<a href="#l21.83"></a><span id="l21.83" class="difflineminus">-  onClick: function(aEvent) {</span>
<a href="#l21.84"></a><span id="l21.84" class="difflineplus">+  onClick(aEvent) {</span>
<a href="#l21.85"></a><span id="l21.85">     // We only care about button 0 (left click) events.</span>
<a href="#l21.86"></a><span id="l21.86">     if (aEvent.button != 0)</span>
<a href="#l21.87"></a><span id="l21.87">       return;</span>
<a href="#l21.88"></a><span id="l21.88"> </span>
<a href="#l21.89"></a><span id="l21.89">     let treeCellInfo = this._treeElement.getCellAt(aEvent.clientX, aEvent.clientY);</span>
<a href="#l21.90"></a><span id="l21.90">     if (treeCellInfo.row == -1 || treeCellInfo.col.id != &quot;selectedCol&quot;)</span>
<a href="#l21.91"></a><span id="l21.91">       return;</span>
<a href="#l21.92"></a><span id="l21.92"> </span>
<a href="#l21.93"></a><span id="l21.93">     this._toggle(treeCellInfo.row);</span>
<a href="#l21.94"></a><span id="l21.94">   },</span>
<a href="#l21.95"></a><span id="l21.95"> </span>
<a href="#l21.96"></a><span id="l21.96" class="difflineminus">-  _toggle: function(aRow) {</span>
<a href="#l21.97"></a><span id="l21.97" class="difflineplus">+  _toggle(aRow) {</span>
<a href="#l21.98"></a><span id="l21.98">     let folder = gFolderTreeView._rowMap[aRow]._folder;</span>
<a href="#l21.99"></a><span id="l21.99">     if (this._selectedList.has(folder))</span>
<a href="#l21.100"></a><span id="l21.100">       this._selectedList.delete(folder);</span>
<a href="#l21.101"></a><span id="l21.101">     else</span>
<a href="#l21.102"></a><span id="l21.102">       this._selectedList.add(folder);</span>
<a href="#l21.103"></a><span id="l21.103"> </span>
<a href="#l21.104"></a><span id="l21.104">     gFolderTreeView._tree.invalidateRow(aRow);</span>
<a href="#l21.105"></a><span id="l21.105">   },</span>
<a href="#l21.106"></a><span id="l21.106"> </span>
<a href="#l21.107"></a><span id="l21.107" class="difflineminus">-  onAccept: function() {</span>
<a href="#l21.108"></a><span id="l21.108" class="difflineplus">+  onAccept() {</span>
<a href="#l21.109"></a><span id="l21.109">     gFolderTreeView.unload();</span>
<a href="#l21.110"></a><span id="l21.110">     // XXX We should just pass the folder objects around...</span>
<a href="#l21.111"></a><span id="l21.111">     let uris = [...this._selectedList.values()].map(folder =&gt; folder.URI).join(&quot;|&quot;);</span>
<a href="#l21.112"></a><span id="l21.112"> </span>
<a href="#l21.113"></a><span id="l21.113">     if (window.arguments[0].okCallback)</span>
<a href="#l21.114"></a><span id="l21.114">       window.arguments[0].okCallback(uris);</span>
<a href="#l21.115"></a><span id="l21.115">   },</span>
<a href="#l21.116"></a><span id="l21.116"> </span>
<a href="#l21.117"></a><span id="l21.117" class="difflineminus">-  onCancel: function() {</span>
<a href="#l21.118"></a><span id="l21.118" class="difflineplus">+  onCancel() {</span>
<a href="#l21.119"></a><span id="l21.119">     gFolderTreeView.unload();</span>
<a href="#l21.120"></a><span id="l21.120" class="difflineminus">-  }</span>
<a href="#l21.121"></a><span id="l21.121" class="difflineplus">+  },</span>
<a href="#l21.122"></a><span id="l21.122"> };</span>
<a href="#l21.123"></a><span id="l21.123"> </span>
<a href="#l21.124"></a><span id="l21.124"> document.addEventListener(&quot;dialogaccept&quot;, gSelectVirtual.onAccept);</span>
<a href="#l21.125"></a><span id="l21.125"> document.addEventListener(&quot;dialogcancel&quot;, gSelectVirtual.onCancel);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/content/virtualFolderProperties.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/content/virtualFolderProperties.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -1,13 +1,15 @@</span>
<a href="#l22.4"></a><span id="l22.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l22.5"></a><span id="l22.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.6"></a><span id="l22.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l22.7"></a><span id="l22.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.8"></a><span id="l22.8"> </span>
<a href="#l22.9"></a><span id="l22.9" class="difflineplus">+/* import-globals-from ../search/content/searchTerm.js */</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineplus">+</span>
<a href="#l22.11"></a><span id="l22.11"> var gPickedFolder;</span>
<a href="#l22.12"></a><span id="l22.12"> var gMailView = null;</span>
<a href="#l22.13"></a><span id="l22.13"> var msgWindow; // important, don't change the name of this variable. it's really a global used by commandglue.js</span>
<a href="#l22.14"></a><span id="l22.14"> var gSearchTermSession; // really an in memory temporary filter we use to read in and write out the search terms</span>
<a href="#l22.15"></a><span id="l22.15"> var gSearchFolderURIs = &quot;&quot;;</span>
<a href="#l22.16"></a><span id="l22.16"> var gMessengerBundle = null;</span>
<a href="#l22.17"></a><span id="l22.17"> </span>
<a href="#l22.18"></a><span id="l22.18"> var nsMsgSearchScope = Ci.nsMsgSearchScope;</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineat">@@ -18,60 +20,54 @@ var {MailServices} = ChromeUtils.import(</span>
<a href="#l22.20"></a><span id="l22.20"> var {</span>
<a href="#l22.21"></a><span id="l22.21">   VirtualFolderHelper,</span>
<a href="#l22.22"></a><span id="l22.22"> } = ChromeUtils.import(&quot;resource:///modules/virtualFolderWrapper.js&quot;);</span>
<a href="#l22.23"></a><span id="l22.23"> var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l22.24"></a><span id="l22.24"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l22.25"></a><span id="l22.25"> </span>
<a href="#l22.26"></a><span id="l22.26"> document.addEventListener(&quot;dialogaccept&quot;, onOK);</span>
<a href="#l22.27"></a><span id="l22.27"> </span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-function onLoad()</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">-{</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineplus">+function onLoad() {</span>
<a href="#l22.31"></a><span id="l22.31">   var windowArgs = window.arguments[0];</span>
<a href="#l22.32"></a><span id="l22.32">   var acceptButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l22.33"></a><span id="l22.33"> </span>
<a href="#l22.34"></a><span id="l22.34">   gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l22.35"></a><span id="l22.35"> </span>
<a href="#l22.36"></a><span id="l22.36">   // call this when OK is pressed</span>
<a href="#l22.37"></a><span id="l22.37">   msgWindow = windowArgs.msgWindow;</span>
<a href="#l22.38"></a><span id="l22.38"> </span>
<a href="#l22.39"></a><span id="l22.39">   initializeSearchWidgets();</span>
<a href="#l22.40"></a><span id="l22.40"> </span>
<a href="#l22.41"></a><span id="l22.41">   setSearchScope(nsMsgSearchScope.offlineMail);</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-  if (windowArgs.editExistingFolder)</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-  {</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineplus">+  if (windowArgs.editExistingFolder) {</span>
<a href="#l22.45"></a><span id="l22.45">     acceptButton.label =</span>
<a href="#l22.46"></a><span id="l22.46">         document.documentElement.getAttribute(&quot;editFolderAcceptButtonLabel&quot;);</span>
<a href="#l22.47"></a><span id="l22.47">     acceptButton.accesskey =</span>
<a href="#l22.48"></a><span id="l22.48">         document.documentElement.getAttribute(&quot;editFolderAcceptButtonAccessKey&quot;);</span>
<a href="#l22.49"></a><span id="l22.49">     InitDialogWithVirtualFolder(windowArgs.folder);</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-  }</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-  else // we are creating a new virtual folder</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-  {</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineplus">+  } else { // we are creating a new virtual folder</span>
<a href="#l22.54"></a><span id="l22.54">     acceptButton.label =</span>
<a href="#l22.55"></a><span id="l22.55">         document.documentElement.getAttribute(&quot;newFolderAcceptButtonLabel&quot;);</span>
<a href="#l22.56"></a><span id="l22.56">     acceptButton.accesskey =</span>
<a href="#l22.57"></a><span id="l22.57">         document.documentElement.getAttribute(&quot;newFolderAcceptButtonAccessKey&quot;);</span>
<a href="#l22.58"></a><span id="l22.58">     // it is possible that we were given arguments to pre-fill the dialog with...</span>
<a href="#l22.59"></a><span id="l22.59">     gSearchTermSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l22.60"></a><span id="l22.60">                            .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l22.61"></a><span id="l22.61"> </span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-    if (windowArgs.searchTerms) // then add them to our search session</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-    {</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineplus">+    if (windowArgs.searchTerms) { // then add them to our search session</span>
<a href="#l22.65"></a><span id="l22.65">       for (let searchTerm of fixIterator(windowArgs.searchTerms,</span>
<a href="#l22.66"></a><span id="l22.66">                                          Ci.nsIMsgSearchTerm))</span>
<a href="#l22.67"></a><span id="l22.67">         gSearchTermSession.appendTerm(searchTerm);</span>
<a href="#l22.68"></a><span id="l22.68">     }</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-    if (windowArgs.folder)</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-    {</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineplus">+    if (windowArgs.folder) {</span>
<a href="#l22.72"></a><span id="l22.72">       // pre select the folderPicker, based on what they selected in the folder pane</span>
<a href="#l22.73"></a><span id="l22.73">       gPickedFolder = windowArgs.folder;</span>
<a href="#l22.74"></a><span id="l22.74">       try {</span>
<a href="#l22.75"></a><span id="l22.75">         document.getElementById(&quot;msgNewFolderPopup&quot;).selectFolder(windowArgs.folder);</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-      } catch(ex) {</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineplus">+      } catch (ex) {</span>
<a href="#l22.78"></a><span id="l22.78">         document.getElementById(&quot;msgNewFolderPicker&quot;)</span>
<a href="#l22.79"></a><span id="l22.79">                 .setAttribute(&quot;label&quot;, windowArgs.folder.prettyName);</span>
<a href="#l22.80"></a><span id="l22.80">       }</span>
<a href="#l22.81"></a><span id="l22.81"> </span>
<a href="#l22.82"></a><span id="l22.82">       // if the passed in URI is not a server then pre-select it as the folder to search</span>
<a href="#l22.83"></a><span id="l22.83">       if (!windowArgs.folder.isServer)</span>
<a href="#l22.84"></a><span id="l22.84">         gSearchFolderURIs = windowArgs.folder.URI;</span>
<a href="#l22.85"></a><span id="l22.85">     }</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineat">@@ -84,63 +80,58 @@ function onLoad()</span>
<a href="#l22.87"></a><span id="l22.87">     if (windowArgs.searchFolderURIs)</span>
<a href="#l22.88"></a><span id="l22.88">       gSearchFolderURIs = windowArgs.searchFolderURIs;</span>
<a href="#l22.89"></a><span id="l22.89"> </span>
<a href="#l22.90"></a><span id="l22.90">     setupSearchRows(gSearchTermSession.searchTerms);</span>
<a href="#l22.91"></a><span id="l22.91">     doEnabling(); // we only need to disable/enable the OK button for new virtual folders</span>
<a href="#l22.92"></a><span id="l22.92">   }</span>
<a href="#l22.93"></a><span id="l22.93"> </span>
<a href="#l22.94"></a><span id="l22.94">   if (typeof windowArgs.searchOnline != &quot;undefined&quot;)</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineminus">-    document.getElementById('searchOnline').checked = windowArgs.searchOnline;</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineplus">+    document.getElementById(&quot;searchOnline&quot;).checked = windowArgs.searchOnline;</span>
<a href="#l22.97"></a><span id="l22.97">   updateOnlineSearchState();</span>
<a href="#l22.98"></a><span id="l22.98">   updateFoldersCount();</span>
<a href="#l22.99"></a><span id="l22.99"> }</span>
<a href="#l22.100"></a><span id="l22.100"> </span>
<a href="#l22.101"></a><span id="l22.101" class="difflineminus">-function setupSearchRows(aSearchTerms)</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineminus">-{</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineplus">+function setupSearchRows(aSearchTerms) {</span>
<a href="#l22.104"></a><span id="l22.104">   if (aSearchTerms &amp;&amp; aSearchTerms.length &gt; 0)</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineminus">-    initializeSearchRows(nsMsgSearchScope.offlineMail, aSearchTerms); // load the search terms for the folder</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineplus">+    initializeSearchRows(Ci.nsMsgSearchScope.offlineMail, aSearchTerms); // load the search terms for the folder</span>
<a href="#l22.107"></a><span id="l22.107">   else</span>
<a href="#l22.108"></a><span id="l22.108">     onMore(null);</span>
<a href="#l22.109"></a><span id="l22.109"> }</span>
<a href="#l22.110"></a><span id="l22.110"> </span>
<a href="#l22.111"></a><span id="l22.111" class="difflineminus">-function updateOnlineSearchState()</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineminus">-{</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineplus">+function updateOnlineSearchState() {</span>
<a href="#l22.114"></a><span id="l22.114">   var enableCheckbox = false;</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineminus">-  var checkbox = document.getElementById('searchOnline');</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineplus">+  var checkbox = document.getElementById(&quot;searchOnline&quot;);</span>
<a href="#l22.117"></a><span id="l22.117">   // only enable the checkbox for selection, for online servers</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineminus">-  var srchFolderUriArray = gSearchFolderURIs.split('|');</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineminus">-  if (srchFolderUriArray[0])</span>
<a href="#l22.120"></a><span id="l22.120" class="difflineminus">-  {</span>
<a href="#l22.121"></a><span id="l22.121" class="difflineplus">+  var srchFolderUriArray = gSearchFolderURIs.split(&quot;|&quot;);</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineplus">+  if (srchFolderUriArray[0]) {</span>
<a href="#l22.123"></a><span id="l22.123">     var realFolder = MailUtils.getOrCreateFolder(srchFolderUriArray[0]);</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineminus">-    enableCheckbox =  realFolder.server.offlineSupportLevel; // anything greater than 0 is an online server like IMAP or news</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineplus">+    enableCheckbox = realFolder.server.offlineSupportLevel; // anything greater than 0 is an online server like IMAP or news</span>
<a href="#l22.126"></a><span id="l22.126">   }</span>
<a href="#l22.127"></a><span id="l22.127"> </span>
<a href="#l22.128"></a><span id="l22.128" class="difflineminus">-  if (enableCheckbox)</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineminus">-    checkbox.removeAttribute('disabled');</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineminus">-  else</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineminus">-  {</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineminus">-    checkbox.setAttribute('disabled', true);</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineplus">+  if (enableCheckbox) {</span>
<a href="#l22.134"></a><span id="l22.134" class="difflineplus">+    checkbox.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineplus">+  } else {</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineplus">+    checkbox.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l22.137"></a><span id="l22.137">     checkbox.checked = false;</span>
<a href="#l22.138"></a><span id="l22.138">   }</span>
<a href="#l22.139"></a><span id="l22.139"> }</span>
<a href="#l22.140"></a><span id="l22.140"> </span>
<a href="#l22.141"></a><span id="l22.141" class="difflineminus">-function InitDialogWithVirtualFolder(aVirtualFolder)</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineminus">-{</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineplus">+function InitDialogWithVirtualFolder(aVirtualFolder) {</span>
<a href="#l22.144"></a><span id="l22.144">   let virtualFolderWrapper =</span>
<a href="#l22.145"></a><span id="l22.145">     VirtualFolderHelper.wrapVirtualFolder(window.arguments[0].folder);</span>
<a href="#l22.146"></a><span id="l22.146"> </span>
<a href="#l22.147"></a><span id="l22.147">   // when editing an existing folder, hide the folder picker that stores the parent location of the folder</span>
<a href="#l22.148"></a><span id="l22.148">   document.getElementById(&quot;chooseFolderLocationRow&quot;).collapsed = true;</span>
<a href="#l22.149"></a><span id="l22.149">   let folderNameField = document.getElementById(&quot;existingName&quot;);</span>
<a href="#l22.150"></a><span id="l22.150">   folderNameField.hidden = false;</span>
<a href="#l22.151"></a><span id="l22.151"> </span>
<a href="#l22.152"></a><span id="l22.152">   gSearchFolderURIs = virtualFolderWrapper.searchFolderURIs;</span>
<a href="#l22.153"></a><span id="l22.153">   updateFoldersCount();</span>
<a href="#l22.154"></a><span id="l22.154" class="difflineminus">-  document.getElementById('searchOnline').checked = virtualFolderWrapper.onlineSearch;</span>
<a href="#l22.155"></a><span id="l22.155" class="difflineplus">+  document.getElementById(&quot;searchOnline&quot;).checked = virtualFolderWrapper.onlineSearch;</span>
<a href="#l22.156"></a><span id="l22.156">   gSearchTermSession = virtualFolderWrapper.searchTermsSession;</span>
<a href="#l22.157"></a><span id="l22.157"> </span>
<a href="#l22.158"></a><span id="l22.158">   setupSearchRows(gSearchTermSession.searchTerms);</span>
<a href="#l22.159"></a><span id="l22.159"> </span>
<a href="#l22.160"></a><span id="l22.160">   // set the name of the folder</span>
<a href="#l22.161"></a><span id="l22.161">   let folderBundle = document.getElementById(&quot;bundle_folder&quot;);</span>
<a href="#l22.162"></a><span id="l22.162">   let name = folderBundle.getFormattedString(&quot;verboseFolderFormat&quot;,</span>
<a href="#l22.163"></a><span id="l22.163">                [aVirtualFolder.prettyName, aVirtualFolder.server.prettyName]);</span>
<a href="#l22.164"></a><span id="l22.164" class="difflineat">@@ -151,31 +142,28 @@ function InitDialogWithVirtualFolder(aVi</span>
<a href="#l22.165"></a><span id="l22.165"> }</span>
<a href="#l22.166"></a><span id="l22.166"> </span>
<a href="#l22.167"></a><span id="l22.167"> function onFolderPick(aEvent) {</span>
<a href="#l22.168"></a><span id="l22.168">   gPickedFolder = aEvent.target._folder;</span>
<a href="#l22.169"></a><span id="l22.169">   document.getElementById(&quot;msgNewFolderPopup&quot;)</span>
<a href="#l22.170"></a><span id="l22.170">           .selectFolder(gPickedFolder);</span>
<a href="#l22.171"></a><span id="l22.171"> }</span>
<a href="#l22.172"></a><span id="l22.172"> </span>
<a href="#l22.173"></a><span id="l22.173" class="difflineminus">-function onOK(event)</span>
<a href="#l22.174"></a><span id="l22.174" class="difflineminus">-{</span>
<a href="#l22.175"></a><span id="l22.175" class="difflineplus">+function onOK(event) {</span>
<a href="#l22.176"></a><span id="l22.176">   var name = document.getElementById(&quot;name&quot;).value;</span>
<a href="#l22.177"></a><span id="l22.177" class="difflineminus">-  var searchOnline = document.getElementById('searchOnline').checked;</span>
<a href="#l22.178"></a><span id="l22.178" class="difflineplus">+  var searchOnline = document.getElementById(&quot;searchOnline&quot;).checked;</span>
<a href="#l22.179"></a><span id="l22.179"> </span>
<a href="#l22.180"></a><span id="l22.180" class="difflineminus">-  if (!gSearchFolderURIs)</span>
<a href="#l22.181"></a><span id="l22.181" class="difflineminus">-  {</span>
<a href="#l22.182"></a><span id="l22.182" class="difflineplus">+  if (!gSearchFolderURIs) {</span>
<a href="#l22.183"></a><span id="l22.183">     Services.prompt.alert(window, null,</span>
<a href="#l22.184"></a><span id="l22.184" class="difflineminus">-                          gMessengerBundle.getString('alertNoSearchFoldersSelected'));</span>
<a href="#l22.185"></a><span id="l22.185" class="difflineplus">+                          gMessengerBundle.getString(&quot;alertNoSearchFoldersSelected&quot;));</span>
<a href="#l22.186"></a><span id="l22.186">     event.preventDefault();</span>
<a href="#l22.187"></a><span id="l22.187">     return;</span>
<a href="#l22.188"></a><span id="l22.188">   }</span>
<a href="#l22.189"></a><span id="l22.189"> </span>
<a href="#l22.190"></a><span id="l22.190" class="difflineminus">-  if (window.arguments[0].editExistingFolder)</span>
<a href="#l22.191"></a><span id="l22.191" class="difflineminus">-  {</span>
<a href="#l22.192"></a><span id="l22.192" class="difflineplus">+  if (window.arguments[0].editExistingFolder) {</span>
<a href="#l22.193"></a><span id="l22.193">     // update the search terms</span>
<a href="#l22.194"></a><span id="l22.194">     saveSearchTerms(gSearchTermSession.searchTerms, gSearchTermSession);</span>
<a href="#l22.195"></a><span id="l22.195">     // save the settings</span>
<a href="#l22.196"></a><span id="l22.196">     let virtualFolderWrapper =</span>
<a href="#l22.197"></a><span id="l22.197">       VirtualFolderHelper.wrapVirtualFolder(window.arguments[0].folder);</span>
<a href="#l22.198"></a><span id="l22.198">     virtualFolderWrapper.searchTerms = gSearchTermSession.searchTerms;</span>
<a href="#l22.199"></a><span id="l22.199">     virtualFolderWrapper.searchFolders = gSearchFolderURIs;</span>
<a href="#l22.200"></a><span id="l22.200">     virtualFolderWrapper.onlineSearch = searchOnline;</span>
<a href="#l22.201"></a><span id="l22.201" class="difflineat">@@ -183,73 +171,67 @@ function onOK(event)</span>
<a href="#l22.202"></a><span id="l22.202"> </span>
<a href="#l22.203"></a><span id="l22.203">     MailServices.accounts.saveVirtualFolders();</span>
<a href="#l22.204"></a><span id="l22.204"> </span>
<a href="#l22.205"></a><span id="l22.205">     if (window.arguments[0].onOKCallback)</span>
<a href="#l22.206"></a><span id="l22.206">       window.arguments[0].onOKCallback(virtualFolderWrapper.virtualFolder.URI);</span>
<a href="#l22.207"></a><span id="l22.207">     return;</span>
<a href="#l22.208"></a><span id="l22.208">   }</span>
<a href="#l22.209"></a><span id="l22.209">   var uri = gPickedFolder.URI;</span>
<a href="#l22.210"></a><span id="l22.210" class="difflineminus">-  if (name &amp;&amp; uri) // create a new virtual folder</span>
<a href="#l22.211"></a><span id="l22.211" class="difflineminus">-  {</span>
<a href="#l22.212"></a><span id="l22.212" class="difflineplus">+  if (name &amp;&amp; uri) { // create a new virtual folder</span>
<a href="#l22.213"></a><span id="l22.213">     // check to see if we already have a folder with the same name and alert the user if so...</span>
<a href="#l22.214"></a><span id="l22.214">     var parentFolder = MailUtils.getOrCreateFolder(uri);</span>
<a href="#l22.215"></a><span id="l22.215"> </span>
<a href="#l22.216"></a><span id="l22.216">     // sanity check the name based on the logic used by nsMsgBaseUtils.cpp. It can't start with a '.', it can't end with a '.', '~' or ' '.</span>
<a href="#l22.217"></a><span id="l22.217">     // it can't contain a ';' or '#'.</span>
<a href="#l22.218"></a><span id="l22.218" class="difflineminus">-    if (/^\.|[\.\~ ]$|[\;\#]/.test(name))</span>
<a href="#l22.219"></a><span id="l22.219" class="difflineminus">-    {</span>
<a href="#l22.220"></a><span id="l22.220" class="difflineplus">+    if (/^\.|[\.\~ ]$|[\;\#]/.test(name)) {</span>
<a href="#l22.221"></a><span id="l22.221">       Services.prompt.alert(window, null,</span>
<a href="#l22.222"></a><span id="l22.222">                             gMessengerBundle.getString(&quot;folderCreationFailed&quot;));</span>
<a href="#l22.223"></a><span id="l22.223">       event.preventDefault();</span>
<a href="#l22.224"></a><span id="l22.224">       return;</span>
<a href="#l22.225"></a><span id="l22.225" class="difflineminus">-    }</span>
<a href="#l22.226"></a><span id="l22.226" class="difflineminus">-    else if (parentFolder.containsChildNamed(name))</span>
<a href="#l22.227"></a><span id="l22.227" class="difflineminus">-    {</span>
<a href="#l22.228"></a><span id="l22.228" class="difflineplus">+    } else if (parentFolder.containsChildNamed(name)) {</span>
<a href="#l22.229"></a><span id="l22.229">       Services.prompt.alert(window, null,</span>
<a href="#l22.230"></a><span id="l22.230">                             gMessengerBundle.getString(&quot;folderExists&quot;));</span>
<a href="#l22.231"></a><span id="l22.231">       event.preventDefault();</span>
<a href="#l22.232"></a><span id="l22.232">       return;</span>
<a href="#l22.233"></a><span id="l22.233">     }</span>
<a href="#l22.234"></a><span id="l22.234"> </span>
<a href="#l22.235"></a><span id="l22.235">     saveSearchTerms(gSearchTermSession.searchTerms, gSearchTermSession);</span>
<a href="#l22.236"></a><span id="l22.236">     VirtualFolderHelper.createNewVirtualFolder(name, parentFolder, gSearchFolderURIs,</span>
<a href="#l22.237"></a><span id="l22.237">                                                gSearchTermSession.searchTerms,</span>
<a href="#l22.238"></a><span id="l22.238">                                                searchOnline);</span>
<a href="#l22.239"></a><span id="l22.239">   }</span>
<a href="#l22.240"></a><span id="l22.240"> }</span>
<a href="#l22.241"></a><span id="l22.241"> </span>
<a href="#l22.242"></a><span id="l22.242" class="difflineminus">-function doEnabling()</span>
<a href="#l22.243"></a><span id="l22.243" class="difflineminus">-{</span>
<a href="#l22.244"></a><span id="l22.244" class="difflineplus">+function doEnabling() {</span>
<a href="#l22.245"></a><span id="l22.245">   var acceptButton = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l22.246"></a><span id="l22.246">   acceptButton.disabled = !document.getElementById(&quot;name&quot;).value;</span>
<a href="#l22.247"></a><span id="l22.247"> }</span>
<a href="#l22.248"></a><span id="l22.248"> </span>
<a href="#l22.249"></a><span id="l22.249" class="difflineminus">-function chooseFoldersToSearch()</span>
<a href="#l22.250"></a><span id="l22.250" class="difflineminus">-{</span>
<a href="#l22.251"></a><span id="l22.251" class="difflineplus">+function chooseFoldersToSearch() {</span>
<a href="#l22.252"></a><span id="l22.252">   // if we have some search folders already, then root the folder picker dialog off the account</span>
<a href="#l22.253"></a><span id="l22.253">   // for those folders. Otherwise fall back to the preselectedfolderURI which is the parent folder</span>
<a href="#l22.254"></a><span id="l22.254">   // for this new virtual folder.</span>
<a href="#l22.255"></a><span id="l22.255" class="difflineminus">-  var dialog = window.openDialog(&quot;chrome://messenger/content/virtualFolderListEdit.xul&quot;, &quot;&quot;,</span>
<a href="#l22.256"></a><span id="l22.256" class="difflineminus">-                                 &quot;chrome,titlebar,modal,centerscreen,resizable&quot;,</span>
<a href="#l22.257"></a><span id="l22.257" class="difflineminus">-                                 {searchFolderURIs:gSearchFolderURIs,</span>
<a href="#l22.258"></a><span id="l22.258" class="difflineminus">-                                  okCallback:onFolderListDialogCallback});</span>
<a href="#l22.259"></a><span id="l22.259" class="difflineplus">+  window.openDialog(&quot;chrome://messenger/content/virtualFolderListEdit.xul&quot;, &quot;&quot;,</span>
<a href="#l22.260"></a><span id="l22.260" class="difflineplus">+                    &quot;chrome,titlebar,modal,centerscreen,resizable&quot;,</span>
<a href="#l22.261"></a><span id="l22.261" class="difflineplus">+                    {</span>
<a href="#l22.262"></a><span id="l22.262" class="difflineplus">+                      searchFolderURIs: gSearchFolderURIs,</span>
<a href="#l22.263"></a><span id="l22.263" class="difflineplus">+                      okCallback: onFolderListDialogCallback,</span>
<a href="#l22.264"></a><span id="l22.264" class="difflineplus">+                    });</span>
<a href="#l22.265"></a><span id="l22.265"> }</span>
<a href="#l22.266"></a><span id="l22.266"> </span>
<a href="#l22.267"></a><span id="l22.267"> // callback routine from chooseFoldersToSearch</span>
<a href="#l22.268"></a><span id="l22.268" class="difflineminus">-function onFolderListDialogCallback(searchFolderURIs)</span>
<a href="#l22.269"></a><span id="l22.269" class="difflineminus">-{</span>
<a href="#l22.270"></a><span id="l22.270" class="difflineplus">+function onFolderListDialogCallback(searchFolderURIs) {</span>
<a href="#l22.271"></a><span id="l22.271">   gSearchFolderURIs = searchFolderURIs;</span>
<a href="#l22.272"></a><span id="l22.272">   updateFoldersCount();</span>
<a href="#l22.273"></a><span id="l22.273">   updateOnlineSearchState(); // we may have changed the server type we are searching...</span>
<a href="#l22.274"></a><span id="l22.274"> }</span>
<a href="#l22.275"></a><span id="l22.275"> </span>
<a href="#l22.276"></a><span id="l22.276" class="difflineminus">-function updateFoldersCount()</span>
<a href="#l22.277"></a><span id="l22.277" class="difflineminus">-{</span>
<a href="#l22.278"></a><span id="l22.278" class="difflineminus">-  let srchFolderUriArray = gSearchFolderURIs.split('|');</span>
<a href="#l22.279"></a><span id="l22.279" class="difflineplus">+function updateFoldersCount() {</span>
<a href="#l22.280"></a><span id="l22.280" class="difflineplus">+  let srchFolderUriArray = gSearchFolderURIs.split(&quot;|&quot;);</span>
<a href="#l22.281"></a><span id="l22.281">   let folderCount = gSearchFolderURIs ? srchFolderUriArray.length : 0;</span>
<a href="#l22.282"></a><span id="l22.282">   let foldersList = document.getElementById(&quot;chosenFoldersCount&quot;);</span>
<a href="#l22.283"></a><span id="l22.283">   foldersList.textContent =</span>
<a href="#l22.284"></a><span id="l22.284">     PluralForm.get(folderCount, gMessengerBundle.getString(&quot;virtualFolderSourcesChosen&quot;))</span>
<a href="#l22.285"></a><span id="l22.285">               .replace(&quot;#1&quot;, folderCount);</span>
<a href="#l22.286"></a><span id="l22.286">   if (folderCount &gt; 0) {</span>
<a href="#l22.287"></a><span id="l22.287">     let folderNames = [];</span>
<a href="#l22.288"></a><span id="l22.288">     for (let folderURI of srchFolderUriArray) {</span>
<a href="#l22.289"></a><span id="l22.289" class="difflineat">@@ -259,13 +241,12 @@ function updateFoldersCount()</span>
<a href="#l22.290"></a><span id="l22.290">       folderNames.push(name);</span>
<a href="#l22.291"></a><span id="l22.291">     }</span>
<a href="#l22.292"></a><span id="l22.292">     foldersList.setAttribute(&quot;tooltiptext&quot;, folderNames.join(&quot;\n&quot;));</span>
<a href="#l22.293"></a><span id="l22.293">   } else {</span>
<a href="#l22.294"></a><span id="l22.294">     foldersList.removeAttribute(&quot;tooltiptext&quot;);</span>
<a href="#l22.295"></a><span id="l22.295">   }</span>
<a href="#l22.296"></a><span id="l22.296"> }</span>
<a href="#l22.297"></a><span id="l22.297"> </span>
<a href="#l22.298"></a><span id="l22.298" class="difflineminus">-function onEnterInSearchTerm()</span>
<a href="#l22.299"></a><span id="l22.299" class="difflineminus">-{</span>
<a href="#l22.300"></a><span id="l22.300" class="difflineplus">+function onEnterInSearchTerm() {</span>
<a href="#l22.301"></a><span id="l22.301">   // stub function called by the core search widget code...</span>
<a href="#l22.302"></a><span id="l22.302">   // nothing for us to do here</span>
<a href="#l22.303"></a><span id="l22.303"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountManager.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountManager.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -20,16 +20,20 @@</span>
<a href="#l23.4"></a><span id="l23.4">  * - the card containing the relevant page is brought to the front</span>
<a href="#l23.5"></a><span id="l23.5">  * - each form element in the page is filled in with an appropriate value</span>
<a href="#l23.6"></a><span id="l23.6">  *   from the current account's hashtable</span>
<a href="#l23.7"></a><span id="l23.7">  * - in the IFRAME inside the page, if there is an onInit() method,</span>
<a href="#l23.8"></a><span id="l23.8">  *   it is called. The onInit method can further update this page based</span>
<a href="#l23.9"></a><span id="l23.9">  *   on values set in the previous step.</span>
<a href="#l23.10"></a><span id="l23.10">  */</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+/* import-globals-from accountUtils.js */</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+/* import-globals-from am-prefs.js */</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+/* import-globals-from amUtils.js */</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+</span>
<a href="#l23.16"></a><span id="l23.16"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l23.17"></a><span id="l23.17"> var {BrowserUtils} = ChromeUtils.import(&quot;resource://gre/modules/BrowserUtils.jsm&quot;);</span>
<a href="#l23.18"></a><span id="l23.18"> var {Gloda} = ChromeUtils.import(&quot;resource:///modules/gloda/gloda.js&quot;);</span>
<a href="#l23.19"></a><span id="l23.19"> var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l23.20"></a><span id="l23.20"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l23.21"></a><span id="l23.21"> var {allAccountsSorted} = ChromeUtils.import(&quot;resource:///modules/folderUtils.jsm&quot;);</span>
<a href="#l23.22"></a><span id="l23.22"> var {cleanUpHostName, isLegalHostNameOrIP} = ChromeUtils.import(&quot;resource:///modules/hostnameUtils.jsm&quot;);</span>
<a href="#l23.23"></a><span id="l23.23"> </span>
<a href="#l23.24"></a><span id="l23.24" class="difflineat">@@ -84,38 +88,37 @@ var gDangerousLocalStorageDirs = [</span>
<a href="#l23.25"></a><span id="l23.25">   { dirsvc: &quot;Trsh&quot;,     OS: &quot;Darwin&quot; },</span>
<a href="#l23.26"></a><span id="l23.26">   // Mac OS system folder</span>
<a href="#l23.27"></a><span id="l23.27">   { dir:    &quot;/System&quot;,  OS: &quot;Darwin&quot; },</span>
<a href="#l23.28"></a><span id="l23.28">   // devices folder</span>
<a href="#l23.29"></a><span id="l23.29">   { dir:    &quot;/dev&quot;,     OS: &quot;Darwin,Linux&quot; },</span>
<a href="#l23.30"></a><span id="l23.30">   // process info folder</span>
<a href="#l23.31"></a><span id="l23.31">   { dir:    &quot;/proc&quot;,    OS: &quot;Linux&quot; },</span>
<a href="#l23.32"></a><span id="l23.32">   // system state folder</span>
<a href="#l23.33"></a><span id="l23.33" class="difflineminus">-  { dir:    &quot;/sys&quot;,     OS: &quot;Linux&quot; }</span>
<a href="#l23.34"></a><span id="l23.34" class="difflineplus">+  { dir:    &quot;/sys&quot;,     OS: &quot;Linux&quot; },</span>
<a href="#l23.35"></a><span id="l23.35"> ];</span>
<a href="#l23.36"></a><span id="l23.36"> </span>
<a href="#l23.37"></a><span id="l23.37"> // This sets an attribute in a xul element so that we can later</span>
<a href="#l23.38"></a><span id="l23.38"> // know what value to substitute in a prefstring.  Different</span>
<a href="#l23.39"></a><span id="l23.39"> // preference types set different attributes.  We get the value</span>
<a href="#l23.40"></a><span id="l23.40"> // in the same way as the function getAccountValue() determines it.</span>
<a href="#l23.41"></a><span id="l23.41"> function updateElementWithKeys(account, element, type) {</span>
<a href="#l23.42"></a><span id="l23.42" class="difflineminus">-  switch (type)</span>
<a href="#l23.43"></a><span id="l23.43" class="difflineminus">-  {</span>
<a href="#l23.44"></a><span id="l23.44" class="difflineplus">+  switch (type) {</span>
<a href="#l23.45"></a><span id="l23.45">     case &quot;identity&quot;:</span>
<a href="#l23.46"></a><span id="l23.46" class="difflineminus">-      element[&quot;identitykey&quot;] = account.defaultIdentity.key;</span>
<a href="#l23.47"></a><span id="l23.47" class="difflineplus">+      element.identitykey = account.defaultIdentity.key;</span>
<a href="#l23.48"></a><span id="l23.48">       break;</span>
<a href="#l23.49"></a><span id="l23.49">     case &quot;pop3&quot;:</span>
<a href="#l23.50"></a><span id="l23.50">     case &quot;imap&quot;:</span>
<a href="#l23.51"></a><span id="l23.51">     case &quot;nntp&quot;:</span>
<a href="#l23.52"></a><span id="l23.52">     case &quot;server&quot;:</span>
<a href="#l23.53"></a><span id="l23.53" class="difflineminus">-      element[&quot;serverkey&quot;] = account.incomingServer.key;</span>
<a href="#l23.54"></a><span id="l23.54" class="difflineplus">+      element.serverkey = account.incomingServer.key;</span>
<a href="#l23.55"></a><span id="l23.55">       break;</span>
<a href="#l23.56"></a><span id="l23.56">     case &quot;smtp&quot;:</span>
<a href="#l23.57"></a><span id="l23.57">       if (MailServices.smtp.defaultServer)</span>
<a href="#l23.58"></a><span id="l23.58" class="difflineminus">-        element[&quot;serverkey&quot;] = MailServices.smtp.defaultServer.key;</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineplus">+        element.serverkey = MailServices.smtp.defaultServer.key;</span>
<a href="#l23.60"></a><span id="l23.60">       break;</span>
<a href="#l23.61"></a><span id="l23.61">     default:</span>
<a href="#l23.62"></a><span id="l23.62"> //      dump(&quot;unknown element type! &quot;+type+&quot;\n&quot;);</span>
<a href="#l23.63"></a><span id="l23.63">   }</span>
<a href="#l23.64"></a><span id="l23.64"> }</span>
<a href="#l23.65"></a><span id="l23.65"> </span>
<a href="#l23.66"></a><span id="l23.66"> function hideShowControls(serverType) {</span>
<a href="#l23.67"></a><span id="l23.67">   let controls = document.querySelectorAll(&quot;[hidefor]&quot;);</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineat">@@ -149,34 +152,33 @@ function onLoad() {</span>
<a href="#l23.69"></a><span id="l23.69">   // Arguments can have two properties: (1) &quot;server,&quot; the nsIMsgIncomingServer</span>
<a href="#l23.70"></a><span id="l23.70">   // to select initially and (2) &quot;selectPage,&quot; the page for that server to that</span>
<a href="#l23.71"></a><span id="l23.71">   // should be selected.</span>
<a href="#l23.72"></a><span id="l23.72">   if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0]) {</span>
<a href="#l23.73"></a><span id="l23.73">     selectedServer = window.arguments[0].server;</span>
<a href="#l23.74"></a><span id="l23.74">     selectPage = window.arguments[0].selectPage;</span>
<a href="#l23.75"></a><span id="l23.75">   }</span>
<a href="#l23.76"></a><span id="l23.76"> </span>
<a href="#l23.77"></a><span id="l23.77" class="difflineminus">-  accountArray = new Object();</span>
<a href="#l23.78"></a><span id="l23.78" class="difflineminus">-  gGenericAttributeTypes = new Object();</span>
<a href="#l23.79"></a><span id="l23.79" class="difflineplus">+  accountArray = {};</span>
<a href="#l23.80"></a><span id="l23.80" class="difflineplus">+  gGenericAttributeTypes = {};</span>
<a href="#l23.81"></a><span id="l23.81"> </span>
<a href="#l23.82"></a><span id="l23.82">   gAccountTree.load();</span>
<a href="#l23.83"></a><span id="l23.83"> </span>
<a href="#l23.84"></a><span id="l23.84">   setTimeout(selectServer, 0, selectedServer, selectPage);</span>
<a href="#l23.85"></a><span id="l23.85"> </span>
<a href="#l23.86"></a><span id="l23.86">   // Make sure the account manager window fits the screen.</span>
<a href="#l23.87"></a><span id="l23.87">   document.getElementById(&quot;accountManager&quot;).style.maxHeight =</span>
<a href="#l23.88"></a><span id="l23.88">     (window.screen.availHeight - 30) + &quot;px&quot;;</span>
<a href="#l23.89"></a><span id="l23.89"> }</span>
<a href="#l23.90"></a><span id="l23.90"> </span>
<a href="#l23.91"></a><span id="l23.91"> function onUnload() {</span>
<a href="#l23.92"></a><span id="l23.92">   gAccountTree.unload();</span>
<a href="#l23.93"></a><span id="l23.93"> }</span>
<a href="#l23.94"></a><span id="l23.94"> </span>
<a href="#l23.95"></a><span id="l23.95" class="difflineminus">-function selectServer(server, selectPageId)</span>
<a href="#l23.96"></a><span id="l23.96" class="difflineminus">-{</span>
<a href="#l23.97"></a><span id="l23.97" class="difflineplus">+function selectServer(server, selectPageId) {</span>
<a href="#l23.98"></a><span id="l23.98">   let childrenNode = document.getElementById(&quot;account-tree-children&quot;);</span>
<a href="#l23.99"></a><span id="l23.99"> </span>
<a href="#l23.100"></a><span id="l23.100">   // Default to showing the first account.</span>
<a href="#l23.101"></a><span id="l23.101">   let accountNode = childrenNode.firstChild;</span>
<a href="#l23.102"></a><span id="l23.102"> </span>
<a href="#l23.103"></a><span id="l23.103">   // Find the tree-node for the account we want to select</span>
<a href="#l23.104"></a><span id="l23.104">   if (server) {</span>
<a href="#l23.105"></a><span id="l23.105">     for (let i = 0; i &lt; childrenNode.childNodes.length; i++) {</span>
<a href="#l23.106"></a><span id="l23.106" class="difflineat">@@ -209,18 +211,17 @@ function selectServer(server, selectPage</span>
<a href="#l23.107"></a><span id="l23.107"> </span>
<a href="#l23.108"></a><span id="l23.108">   let lastItem = accountNode.lastChild.lastChild;</span>
<a href="#l23.109"></a><span id="l23.109">   if (lastItem.localName == &quot;treeitem&quot;)</span>
<a href="#l23.110"></a><span id="l23.110">     index = accountTree.view.getIndexOfItem(lastItem);</span>
<a href="#l23.111"></a><span id="l23.111"> </span>
<a href="#l23.112"></a><span id="l23.112">   accountTree.ensureRowIsVisible(index);</span>
<a href="#l23.113"></a><span id="l23.113"> }</span>
<a href="#l23.114"></a><span id="l23.114"> </span>
<a href="#l23.115"></a><span id="l23.115" class="difflineminus">-function replaceWithDefaultSmtpServer(deletedSmtpServerKey)</span>
<a href="#l23.116"></a><span id="l23.116" class="difflineminus">-{</span>
<a href="#l23.117"></a><span id="l23.117" class="difflineplus">+function replaceWithDefaultSmtpServer(deletedSmtpServerKey) {</span>
<a href="#l23.118"></a><span id="l23.118">   // First we replace the smtpserverkey in every identity.</span>
<a href="#l23.119"></a><span id="l23.119">   let am = MailServices.accounts;</span>
<a href="#l23.120"></a><span id="l23.120">   for (let identity of fixIterator(am.allIdentities,</span>
<a href="#l23.121"></a><span id="l23.121">                                    Ci.nsIMsgIdentity)) {</span>
<a href="#l23.122"></a><span id="l23.122">     if (identity.smtpServerKey == deletedSmtpServerKey)</span>
<a href="#l23.123"></a><span id="l23.123">       identity.smtpServerKey = &quot;&quot;;</span>
<a href="#l23.124"></a><span id="l23.124">   }</span>
<a href="#l23.125"></a><span id="l23.125"> </span>
<a href="#l23.126"></a><span id="l23.126" class="difflineat">@@ -257,18 +258,18 @@ function onAccept(aDoChecks) {</span>
<a href="#l23.127"></a><span id="l23.127">     if (!checkUserServerChanges(true))</span>
<a href="#l23.128"></a><span id="l23.128">       return false;</span>
<a href="#l23.129"></a><span id="l23.129"> </span>
<a href="#l23.130"></a><span id="l23.130">     if (!checkAccountNameIsValid())</span>
<a href="#l23.131"></a><span id="l23.131">       return false;</span>
<a href="#l23.132"></a><span id="l23.132">   }</span>
<a href="#l23.133"></a><span id="l23.133"> </span>
<a href="#l23.134"></a><span id="l23.134">   // Run checks as if the page was being left.</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineminus">-  if (&quot;onLeave&quot; in top.frames[&quot;contentFrame&quot;]) {</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineminus">-    if (!top.frames[&quot;contentFrame&quot;].onLeave()) {</span>
<a href="#l23.137"></a><span id="l23.137" class="difflineplus">+  if (&quot;onLeave&quot; in top.frames.contentFrame) {</span>
<a href="#l23.138"></a><span id="l23.138" class="difflineplus">+    if (!top.frames.contentFrame.onLeave()) {</span>
<a href="#l23.139"></a><span id="l23.139">       // Prevent closing Account manager if user declined the changes.</span>
<a href="#l23.140"></a><span id="l23.140">       return false;</span>
<a href="#l23.141"></a><span id="l23.141">     }</span>
<a href="#l23.142"></a><span id="l23.142">   }</span>
<a href="#l23.143"></a><span id="l23.143"> </span>
<a href="#l23.144"></a><span id="l23.144">   if (!onSave())</span>
<a href="#l23.145"></a><span id="l23.145">     return false;</span>
<a href="#l23.146"></a><span id="l23.146"> </span>
<a href="#l23.147"></a><span id="l23.147" class="difflineat">@@ -285,18 +286,17 @@ function onAccept(aDoChecks) {</span>
<a href="#l23.148"></a><span id="l23.148"> }</span>
<a href="#l23.149"></a><span id="l23.149"> </span>
<a href="#l23.150"></a><span id="l23.150"> /**</span>
<a href="#l23.151"></a><span id="l23.151">  * Runs when Cancel button is used.</span>
<a href="#l23.152"></a><span id="l23.152">  *</span>
<a href="#l23.153"></a><span id="l23.153">  * This function must not be called onCancel(), because it would call itself</span>
<a href="#l23.154"></a><span id="l23.154">  * recursively for pages that don't have an onCancel() implementation.</span>
<a href="#l23.155"></a><span id="l23.155">  */</span>
<a href="#l23.156"></a><span id="l23.156" class="difflineminus">-function onNotAccept(event)</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineminus">-{</span>
<a href="#l23.158"></a><span id="l23.158" class="difflineplus">+function onNotAccept(event) {</span>
<a href="#l23.159"></a><span id="l23.159">   // If onCancel() present in current page frame, call it.</span>
<a href="#l23.160"></a><span id="l23.160">   if (&quot;onCancel&quot; in top.frames.contentFrame) {</span>
<a href="#l23.161"></a><span id="l23.161">     top.frames.contentFrame.onCancel(event);</span>
<a href="#l23.162"></a><span id="l23.162">   }</span>
<a href="#l23.163"></a><span id="l23.163"> }</span>
<a href="#l23.164"></a><span id="l23.164"> </span>
<a href="#l23.165"></a><span id="l23.165"> /**</span>
<a href="#l23.166"></a><span id="l23.166">  * See if the given path to a directory is usable on the current OS.</span>
<a href="#l23.167"></a><span id="l23.167" class="difflineat">@@ -317,17 +317,17 @@ function checkDirectoryIsValid(aLocalPat</span>
<a href="#l23.168"></a><span id="l23.168">   if (Services.appinfo.OS == &quot;WINNT&quot;) {</span>
<a href="#l23.169"></a><span id="l23.169">     // Do not allow some special filenames on Windows.</span>
<a href="#l23.170"></a><span id="l23.170">     // Taken from mozilla/widget/windows/nsDataObj.cpp::MangleTextToValidFilename()</span>
<a href="#l23.171"></a><span id="l23.171">     let dirLeafName = aLocalPath.leafName;</span>
<a href="#l23.172"></a><span id="l23.172">     const kForbiddenNames = [</span>
<a href="#l23.173"></a><span id="l23.173">       &quot;COM1&quot;, &quot;COM2&quot;, &quot;COM3&quot;, &quot;COM4&quot;, &quot;COM5&quot;, &quot;COM6&quot;, &quot;COM7&quot;, &quot;COM8&quot;, &quot;COM9&quot;,</span>
<a href="#l23.174"></a><span id="l23.174">       &quot;LPT1&quot;, &quot;LPT2&quot;, &quot;LPT3&quot;, &quot;LPT4&quot;, &quot;LPT5&quot;, &quot;LPT6&quot;, &quot;LPT7&quot;, &quot;LPT8&quot;, &quot;LPT9&quot;,</span>
<a href="#l23.175"></a><span id="l23.175">       &quot;CON&quot;, &quot;PRN&quot;, &quot;AUX&quot;, &quot;NUL&quot;, &quot;CLOCK$&quot; ];</span>
<a href="#l23.176"></a><span id="l23.176" class="difflineminus">-    if (kForbiddenNames.indexOf(dirLeafName) != -1)</span>
<a href="#l23.177"></a><span id="l23.177" class="difflineplus">+    if (kForbiddenNames.includes(dirLeafName))</span>
<a href="#l23.178"></a><span id="l23.178">       return false;</span>
<a href="#l23.179"></a><span id="l23.179">   }</span>
<a href="#l23.180"></a><span id="l23.180"> </span>
<a href="#l23.181"></a><span id="l23.181">   // The directory must be readable and writable to work as a mail store.</span>
<a href="#l23.182"></a><span id="l23.182">   if (!(aLocalPath.isReadable() &amp;&amp; aLocalPath.isWritable()))</span>
<a href="#l23.183"></a><span id="l23.183">     return false;</span>
<a href="#l23.184"></a><span id="l23.184"> </span>
<a href="#l23.185"></a><span id="l23.185">   return true;</span>
<a href="#l23.186"></a><span id="l23.186" class="difflineat">@@ -356,33 +356,32 @@ function checkDirectoryIsAllowed(aLocalP</span>
<a href="#l23.187"></a><span id="l23.187">    *                       Darwin = OS X</span>
<a href="#l23.188"></a><span id="l23.188">    *                       Linux  = Linux</span>
<a href="#l23.189"></a><span id="l23.189">    *        safeSubdirs : An array of directory names that are allowed to be used</span>
<a href="#l23.190"></a><span id="l23.190">    *                      under the tested directory.</span>
<a href="#l23.191"></a><span id="l23.191">    * @param aLocalPath  An nsIFile of the directory to check, intended for message storage.</span>
<a href="#l23.192"></a><span id="l23.192">    */</span>
<a href="#l23.193"></a><span id="l23.193">   function checkLocalDirectoryIsSafe(aDirToCheck, aLocalPath) {</span>
<a href="#l23.194"></a><span id="l23.194">     if (aDirToCheck.OS) {</span>
<a href="#l23.195"></a><span id="l23.195" class="difflineminus">-      if (aDirToCheck.OS.split(&quot;,&quot;).indexOf(Services.appinfo.OS) == -1)</span>
<a href="#l23.196"></a><span id="l23.196" class="difflineplus">+      if (!(aDirToCheck.OS.split(&quot;,&quot;).includes(Services.appinfo.OS)))</span>
<a href="#l23.197"></a><span id="l23.197">         return true;</span>
<a href="#l23.198"></a><span id="l23.198">     }</span>
<a href="#l23.199"></a><span id="l23.199"> </span>
<a href="#l23.200"></a><span id="l23.200">     let testDir = null;</span>
<a href="#l23.201"></a><span id="l23.201">     if (&quot;dirsvc&quot; in aDirToCheck) {</span>
<a href="#l23.202"></a><span id="l23.202">       try {</span>
<a href="#l23.203"></a><span id="l23.203">         testDir = Services.dirsvc.get(aDirToCheck.dirsvc, Ci.nsIFile);</span>
<a href="#l23.204"></a><span id="l23.204">       } catch (e) {</span>
<a href="#l23.205"></a><span id="l23.205">         Cu.reportError(&quot;The special folder &quot; + aDirToCheck.dirsvc +</span>
<a href="#l23.206"></a><span id="l23.206">           &quot; cannot be retrieved on this platform: &quot; + e);</span>
<a href="#l23.207"></a><span id="l23.207">       }</span>
<a href="#l23.208"></a><span id="l23.208"> </span>
<a href="#l23.209"></a><span id="l23.209">       if (!testDir)</span>
<a href="#l23.210"></a><span id="l23.210">         return true;</span>
<a href="#l23.211"></a><span id="l23.211" class="difflineminus">-    }</span>
<a href="#l23.212"></a><span id="l23.212" class="difflineminus">-    else if (&quot;dir&quot; in aDirToCheck) {</span>
<a href="#l23.213"></a><span id="l23.213" class="difflineplus">+    } else if (&quot;dir&quot; in aDirToCheck) {</span>
<a href="#l23.214"></a><span id="l23.214">       testDir = Cc[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l23.215"></a><span id="l23.215">                   .createInstance(Ci.nsIFile);</span>
<a href="#l23.216"></a><span id="l23.216">       testDir.initWithPath(aDirToCheck.dir);</span>
<a href="#l23.217"></a><span id="l23.217">       if (!testDir.exists())</span>
<a href="#l23.218"></a><span id="l23.218">         return true;</span>
<a href="#l23.219"></a><span id="l23.219">     } else {</span>
<a href="#l23.220"></a><span id="l23.220">       Cu.reportError(&quot;No directory to check?&quot;);</span>
<a href="#l23.221"></a><span id="l23.221">       return true;</span>
<a href="#l23.222"></a><span id="l23.222" class="difflineat">@@ -442,17 +441,17 @@ function checkDirectoryIsAllowed(aLocalP</span>
<a href="#l23.223"></a><span id="l23.223">  * aLocalPath  the nsIFile of a directory to check.</span>
<a href="#l23.224"></a><span id="l23.224">  */</span>
<a href="#l23.225"></a><span id="l23.225"> function checkDirectoryIsUsable(aLocalPath) {</span>
<a href="#l23.226"></a><span id="l23.226">   const kAlertTitle = document.getElementById(&quot;bundle_prefs&quot;)</span>
<a href="#l23.227"></a><span id="l23.227">                               .getString(&quot;prefPanel-server&quot;);</span>
<a href="#l23.228"></a><span id="l23.228">   const originalPath = aLocalPath;</span>
<a href="#l23.229"></a><span id="l23.229"> </span>
<a href="#l23.230"></a><span id="l23.230">   let invalidPath = false;</span>
<a href="#l23.231"></a><span id="l23.231" class="difflineminus">-  try{</span>
<a href="#l23.232"></a><span id="l23.232" class="difflineplus">+  try {</span>
<a href="#l23.233"></a><span id="l23.233">     aLocalPath.normalize();</span>
<a href="#l23.234"></a><span id="l23.234">   } catch (e) { invalidPath = true; }</span>
<a href="#l23.235"></a><span id="l23.235"> </span>
<a href="#l23.236"></a><span id="l23.236">   if (invalidPath || !checkDirectoryIsValid(aLocalPath)) {</span>
<a href="#l23.237"></a><span id="l23.237">     let alertString = document.getElementById(&quot;bundle_prefs&quot;)</span>
<a href="#l23.238"></a><span id="l23.238">                               .getFormattedString(&quot;localDirectoryInvalid&quot;,</span>
<a href="#l23.239"></a><span id="l23.239">                                                   [originalPath.path]);</span>
<a href="#l23.240"></a><span id="l23.240">     Services.prompt.alert(window, kAlertTitle, alertString);</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineat">@@ -466,18 +465,17 @@ function checkDirectoryIsUsable(aLocalPa</span>
<a href="#l23.242"></a><span id="l23.242">     Services.prompt.alert(window, kAlertTitle, alertNotAllowed);</span>
<a href="#l23.243"></a><span id="l23.243">     return false;</span>
<a href="#l23.244"></a><span id="l23.244">   }</span>
<a href="#l23.245"></a><span id="l23.245"> </span>
<a href="#l23.246"></a><span id="l23.246">   // Check that no other account has this same or dependent local directory.</span>
<a href="#l23.247"></a><span id="l23.247">   let allServers = MailServices.accounts.allServers;</span>
<a href="#l23.248"></a><span id="l23.248"> </span>
<a href="#l23.249"></a><span id="l23.249">   for (let server of fixIterator(allServers,</span>
<a href="#l23.250"></a><span id="l23.250" class="difflineminus">-                                 Ci.nsIMsgIncomingServer))</span>
<a href="#l23.251"></a><span id="l23.251" class="difflineminus">-  {</span>
<a href="#l23.252"></a><span id="l23.252" class="difflineplus">+                                 Ci.nsIMsgIncomingServer)) {</span>
<a href="#l23.253"></a><span id="l23.253">     if (server.key == currentAccount.incomingServer.key)</span>
<a href="#l23.254"></a><span id="l23.254">       continue;</span>
<a href="#l23.255"></a><span id="l23.255"> </span>
<a href="#l23.256"></a><span id="l23.256">     let serverPath = server.localPath;</span>
<a href="#l23.257"></a><span id="l23.257">     try {</span>
<a href="#l23.258"></a><span id="l23.258">       serverPath.normalize();</span>
<a href="#l23.259"></a><span id="l23.259">       let alertStringID = null;</span>
<a href="#l23.260"></a><span id="l23.260">       if (serverPath.equals(aLocalPath))</span>
<a href="#l23.261"></a><span id="l23.261" class="difflineat">@@ -519,17 +517,17 @@ function checkUserServerChanges(showAler</span>
<a href="#l23.262"></a><span id="l23.262"> </span>
<a href="#l23.263"></a><span id="l23.263">   var accountValues = getValueArrayFor(currentAccount);</span>
<a href="#l23.264"></a><span id="l23.264">   if (!accountValues)</span>
<a href="#l23.265"></a><span id="l23.265">     return true;</span>
<a href="#l23.266"></a><span id="l23.266"> </span>
<a href="#l23.267"></a><span id="l23.267">   let currentServer = currentAccount ? currentAccount.incomingServer : null;</span>
<a href="#l23.268"></a><span id="l23.268"> </span>
<a href="#l23.269"></a><span id="l23.269">   // If this type doesn't exist (just removed) then return.</span>
<a href="#l23.270"></a><span id="l23.270" class="difflineminus">-  if (!(&quot;server&quot; in accountValues) || !accountValues[&quot;server&quot;])</span>
<a href="#l23.271"></a><span id="l23.271" class="difflineplus">+  if (!(&quot;server&quot; in accountValues) || !accountValues.server)</span>
<a href="#l23.272"></a><span id="l23.272">     return true;</span>
<a href="#l23.273"></a><span id="l23.273"> </span>
<a href="#l23.274"></a><span id="l23.274">   // Get the new username, hostname and type from the page.</span>
<a href="#l23.275"></a><span id="l23.275">   var typeElem = getPageFormElement(&quot;server.type&quot;);</span>
<a href="#l23.276"></a><span id="l23.276">   var hostElem = getPageFormElement(&quot;server.realHostName&quot;);</span>
<a href="#l23.277"></a><span id="l23.277">   var userElem = getPageFormElement(&quot;server.realUsername&quot;);</span>
<a href="#l23.278"></a><span id="l23.278">   if (typeElem &amp;&amp; userElem &amp;&amp; hostElem) {</span>
<a href="#l23.279"></a><span id="l23.279">   var newType = getFormElementValue(typeElem);</span>
<a href="#l23.280"></a><span id="l23.280" class="difflineat">@@ -548,21 +546,19 @@ function checkUserServerChanges(showAler</span>
<a href="#l23.281"></a><span id="l23.281">   }</span>
<a href="#l23.282"></a><span id="l23.282">   alertText = null;</span>
<a href="#l23.283"></a><span id="l23.283">   // If something is changed then check if the new user/host already exists.</span>
<a href="#l23.284"></a><span id="l23.284">   if ((oldUser != newUser) || (oldHost != newHost)) {</span>
<a href="#l23.285"></a><span id="l23.285">     newUser = newUser.trim();</span>
<a href="#l23.286"></a><span id="l23.286">     newHost = cleanUpHostName(newHost);</span>
<a href="#l23.287"></a><span id="l23.287">     if (checkUser &amp;&amp; (newUser == &quot;&quot;)) {</span>
<a href="#l23.288"></a><span id="l23.288">       alertText = prefBundle.getString(&quot;userNameEmpty&quot;);</span>
<a href="#l23.289"></a><span id="l23.289" class="difflineminus">-    }</span>
<a href="#l23.290"></a><span id="l23.290" class="difflineminus">-    else if (!isLegalHostNameOrIP(newHost)) {</span>
<a href="#l23.291"></a><span id="l23.291" class="difflineplus">+    } else if (!isLegalHostNameOrIP(newHost)) {</span>
<a href="#l23.292"></a><span id="l23.292">       alertText = prefBundle.getString(&quot;enterValidServerName&quot;);</span>
<a href="#l23.293"></a><span id="l23.293" class="difflineminus">-    }</span>
<a href="#l23.294"></a><span id="l23.294" class="difflineminus">-    else {</span>
<a href="#l23.295"></a><span id="l23.295" class="difflineplus">+    } else {</span>
<a href="#l23.296"></a><span id="l23.296">       let sameServer = MailServices.accounts</span>
<a href="#l23.297"></a><span id="l23.297">                                    .findRealServer(newUser, newHost, newType, 0);</span>
<a href="#l23.298"></a><span id="l23.298">       if (sameServer &amp;&amp; (sameServer != currentServer)) {</span>
<a href="#l23.299"></a><span id="l23.299">         alertText = prefBundle.getString(&quot;modifiedAccountExists&quot;);</span>
<a href="#l23.300"></a><span id="l23.300">       } else {</span>
<a href="#l23.301"></a><span id="l23.301">         // New hostname passed all checks. We may have cleaned it up so set</span>
<a href="#l23.302"></a><span id="l23.302">         // the new value back into the input element.</span>
<a href="#l23.303"></a><span id="l23.303">         setFormElementValue(hostElem, newHost);</span>
<a href="#l23.304"></a><span id="l23.304" class="difflineat">@@ -686,23 +682,21 @@ function onSave() {</span>
<a href="#l23.305"></a><span id="l23.305"> </span>
<a href="#l23.306"></a><span id="l23.306">  return true;</span>
<a href="#l23.307"></a><span id="l23.307"> }</span>
<a href="#l23.308"></a><span id="l23.308"> </span>
<a href="#l23.309"></a><span id="l23.309"> function onAddAccount() {</span>
<a href="#l23.310"></a><span id="l23.310">   MsgAccountWizard();</span>
<a href="#l23.311"></a><span id="l23.311"> }</span>
<a href="#l23.312"></a><span id="l23.312"> </span>
<a href="#l23.313"></a><span id="l23.313" class="difflineminus">-function AddMailAccount()</span>
<a href="#l23.314"></a><span id="l23.314" class="difflineminus">-{</span>
<a href="#l23.315"></a><span id="l23.315" class="difflineplus">+function AddMailAccount() {</span>
<a href="#l23.316"></a><span id="l23.316">   NewMailAccount(MailServices.mailSession.topmostMsgWindow);</span>
<a href="#l23.317"></a><span id="l23.317"> }</span>
<a href="#l23.318"></a><span id="l23.318"> </span>
<a href="#l23.319"></a><span id="l23.319" class="difflineminus">-function AddIMAccount()</span>
<a href="#l23.320"></a><span id="l23.320" class="difflineminus">-{</span>
<a href="#l23.321"></a><span id="l23.321" class="difflineplus">+function AddIMAccount() {</span>
<a href="#l23.322"></a><span id="l23.322">   window.openDialog(&quot;chrome://messenger/content/chat/imAccountWizard.xul&quot;,</span>
<a href="#l23.323"></a><span id="l23.323">                     &quot;&quot;, &quot;chrome,modal,titlebar,centerscreen&quot;);</span>
<a href="#l23.324"></a><span id="l23.324"> }</span>
<a href="#l23.325"></a><span id="l23.325"> </span>
<a href="#l23.326"></a><span id="l23.326"> /**</span>
<a href="#l23.327"></a><span id="l23.327">  * Highlight the default account row in the account tree,</span>
<a href="#l23.328"></a><span id="l23.328">  * optionally un-highlight the previous one.</span>
<a href="#l23.329"></a><span id="l23.329">  *</span>
<a href="#l23.330"></a><span id="l23.330" class="difflineat">@@ -783,17 +777,17 @@ function onRemoveAccount(event) {</span>
<a href="#l23.331"></a><span id="l23.331">     return;</span>
<a href="#l23.332"></a><span id="l23.332"> </span>
<a href="#l23.333"></a><span id="l23.333">   let serverList = [];</span>
<a href="#l23.334"></a><span id="l23.334">   let accountTreeNode = document.getElementById(&quot;account-tree-children&quot;);</span>
<a href="#l23.335"></a><span id="l23.335">   // build the list of servers in the account tree (order is important)</span>
<a href="#l23.336"></a><span id="l23.336">   for (let i = 0; i &lt; accountTreeNode.childNodes.length; i++) {</span>
<a href="#l23.337"></a><span id="l23.337">     if (&quot;_account&quot; in accountTreeNode.childNodes[i]) {</span>
<a href="#l23.338"></a><span id="l23.338">       let curServer = accountTreeNode.childNodes[i]._account.incomingServer;</span>
<a href="#l23.339"></a><span id="l23.339" class="difflineminus">-      if (serverList.indexOf(curServer) == -1)</span>
<a href="#l23.340"></a><span id="l23.340" class="difflineplus">+      if (!serverList.includes(curServer))</span>
<a href="#l23.341"></a><span id="l23.341">         serverList.push(curServer);</span>
<a href="#l23.342"></a><span id="l23.342">     }</span>
<a href="#l23.343"></a><span id="l23.343">   }</span>
<a href="#l23.344"></a><span id="l23.344"> </span>
<a href="#l23.345"></a><span id="l23.345">   // get position of the current server in the server list</span>
<a href="#l23.346"></a><span id="l23.346">   let serverIndex = serverList.indexOf(server);</span>
<a href="#l23.347"></a><span id="l23.347"> </span>
<a href="#l23.348"></a><span id="l23.348">   // After the current server is deleted, choose the next server/account,</span>
<a href="#l23.349"></a><span id="l23.349" class="difflineat">@@ -802,18 +796,21 @@ function onRemoveAccount(event) {</span>
<a href="#l23.350"></a><span id="l23.350">     serverIndex--;</span>
<a href="#l23.351"></a><span id="l23.351">   else</span>
<a href="#l23.352"></a><span id="l23.352">     serverIndex++;</span>
<a href="#l23.353"></a><span id="l23.353"> </span>
<a href="#l23.354"></a><span id="l23.354">   // Need to save these before the account and its server is removed.</span>
<a href="#l23.355"></a><span id="l23.355">   let serverId = server.serverURI;</span>
<a href="#l23.356"></a><span id="l23.356"> </span>
<a href="#l23.357"></a><span id="l23.357">   // Confirm account deletion.</span>
<a href="#l23.358"></a><span id="l23.358" class="difflineminus">-  let removeArgs = { server: server, account: currentAccount,</span>
<a href="#l23.359"></a><span id="l23.359" class="difflineminus">-                     result: false };</span>
<a href="#l23.360"></a><span id="l23.360" class="difflineplus">+  let removeArgs = {</span>
<a href="#l23.361"></a><span id="l23.361" class="difflineplus">+    server,</span>
<a href="#l23.362"></a><span id="l23.362" class="difflineplus">+    account: currentAccount,</span>
<a href="#l23.363"></a><span id="l23.363" class="difflineplus">+    result: false,</span>
<a href="#l23.364"></a><span id="l23.364" class="difflineplus">+  };</span>
<a href="#l23.365"></a><span id="l23.365"> </span>
<a href="#l23.366"></a><span id="l23.366">   window.openDialog(&quot;chrome://messenger/content/removeAccount.xul&quot;,</span>
<a href="#l23.367"></a><span id="l23.367">                     &quot;removeAccount&quot;,</span>
<a href="#l23.368"></a><span id="l23.368">                     &quot;chrome,titlebar,modal,centerscreen,resizable=no&quot;,</span>
<a href="#l23.369"></a><span id="l23.369">                     removeArgs);</span>
<a href="#l23.370"></a><span id="l23.370"> </span>
<a href="#l23.371"></a><span id="l23.371">   // If result is true, the account was removed.</span>
<a href="#l23.372"></a><span id="l23.372">   if (!removeArgs.result)</span>
<a href="#l23.373"></a><span id="l23.373" class="difflineat">@@ -829,51 +826,50 @@ function onRemoveAccount(event) {</span>
<a href="#l23.374"></a><span id="l23.374">     selectServer(serverList[serverIndex], null);</span>
<a href="#l23.375"></a><span id="l23.375"> </span>
<a href="#l23.376"></a><span id="l23.376">   // Either the default account was deleted so there is a new one</span>
<a href="#l23.377"></a><span id="l23.377">   // or the default account was not changed. Either way, there is</span>
<a href="#l23.378"></a><span id="l23.378">   // no need to unmark the old one.</span>
<a href="#l23.379"></a><span id="l23.379">   markDefaultServer(MailServices.accounts.defaultAccount, null);</span>
<a href="#l23.380"></a><span id="l23.380"> }</span>
<a href="#l23.381"></a><span id="l23.381"> </span>
<a href="#l23.382"></a><span id="l23.382" class="difflineminus">-function saveAccount(accountValues, account)</span>
<a href="#l23.383"></a><span id="l23.383" class="difflineminus">-{</span>
<a href="#l23.384"></a><span id="l23.384" class="difflineplus">+function saveAccount(accountValues, account) {</span>
<a href="#l23.385"></a><span id="l23.385">   var identity = null;</span>
<a href="#l23.386"></a><span id="l23.386">   var server = null;</span>
<a href="#l23.387"></a><span id="l23.387"> </span>
<a href="#l23.388"></a><span id="l23.388">   if (account) {</span>
<a href="#l23.389"></a><span id="l23.389">     identity = account.defaultIdentity;</span>
<a href="#l23.390"></a><span id="l23.390">     server = account.incomingServer;</span>
<a href="#l23.391"></a><span id="l23.391">   }</span>
<a href="#l23.392"></a><span id="l23.392"> </span>
<a href="#l23.393"></a><span id="l23.393">   for (var type in accountValues) {</span>
<a href="#l23.394"></a><span id="l23.394">     var typeArray = accountValues[type];</span>
<a href="#l23.395"></a><span id="l23.395"> </span>
<a href="#l23.396"></a><span id="l23.396">     for (var slot in typeArray) {</span>
<a href="#l23.397"></a><span id="l23.397">       var dest;</span>
<a href="#l23.398"></a><span id="l23.398">       try {</span>
<a href="#l23.399"></a><span id="l23.399" class="difflineminus">-      if (type == &quot;identity&quot;)</span>
<a href="#l23.400"></a><span id="l23.400" class="difflineminus">-        dest = identity;</span>
<a href="#l23.401"></a><span id="l23.401" class="difflineminus">-      else if (type == &quot;server&quot;)</span>
<a href="#l23.402"></a><span id="l23.402" class="difflineminus">-        dest = server;</span>
<a href="#l23.403"></a><span id="l23.403" class="difflineminus">-      else if (type == &quot;pop3&quot;)</span>
<a href="#l23.404"></a><span id="l23.404" class="difflineminus">-        dest = server.QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l23.405"></a><span id="l23.405" class="difflineminus">-      else if (type == &quot;imap&quot;)</span>
<a href="#l23.406"></a><span id="l23.406" class="difflineminus">-        dest = server.QueryInterface(Ci.nsIImapIncomingServer);</span>
<a href="#l23.407"></a><span id="l23.407" class="difflineminus">-      else if (type == &quot;none&quot;)</span>
<a href="#l23.408"></a><span id="l23.408" class="difflineminus">-        dest = server.QueryInterface(Ci.nsINoIncomingServer);</span>
<a href="#l23.409"></a><span id="l23.409" class="difflineminus">-      else if (type == &quot;nntp&quot;)</span>
<a href="#l23.410"></a><span id="l23.410" class="difflineminus">-        dest = server.QueryInterface(Ci.nsINntpIncomingServer);</span>
<a href="#l23.411"></a><span id="l23.411" class="difflineminus">-      else if (type == &quot;smtp&quot;)</span>
<a href="#l23.412"></a><span id="l23.412" class="difflineminus">-        dest = MailServices.smtp.defaultServer;</span>
<a href="#l23.413"></a><span id="l23.413" class="difflineminus">-</span>
<a href="#l23.414"></a><span id="l23.414" class="difflineplus">+        if (type == &quot;identity&quot;)</span>
<a href="#l23.415"></a><span id="l23.415" class="difflineplus">+          dest = identity;</span>
<a href="#l23.416"></a><span id="l23.416" class="difflineplus">+        else if (type == &quot;server&quot;)</span>
<a href="#l23.417"></a><span id="l23.417" class="difflineplus">+          dest = server;</span>
<a href="#l23.418"></a><span id="l23.418" class="difflineplus">+        else if (type == &quot;pop3&quot;)</span>
<a href="#l23.419"></a><span id="l23.419" class="difflineplus">+          dest = server.QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l23.420"></a><span id="l23.420" class="difflineplus">+        else if (type == &quot;imap&quot;)</span>
<a href="#l23.421"></a><span id="l23.421" class="difflineplus">+          dest = server.QueryInterface(Ci.nsIImapIncomingServer);</span>
<a href="#l23.422"></a><span id="l23.422" class="difflineplus">+        else if (type == &quot;none&quot;)</span>
<a href="#l23.423"></a><span id="l23.423" class="difflineplus">+          dest = server.QueryInterface(Ci.nsINoIncomingServer);</span>
<a href="#l23.424"></a><span id="l23.424" class="difflineplus">+        else if (type == &quot;nntp&quot;)</span>
<a href="#l23.425"></a><span id="l23.425" class="difflineplus">+          dest = server.QueryInterface(Ci.nsINntpIncomingServer);</span>
<a href="#l23.426"></a><span id="l23.426" class="difflineplus">+        else if (type == &quot;smtp&quot;)</span>
<a href="#l23.427"></a><span id="l23.427" class="difflineplus">+          dest = MailServices.smtp.defaultServer;</span>
<a href="#l23.428"></a><span id="l23.428">       } catch (ex) {</span>
<a href="#l23.429"></a><span id="l23.429">         // don't do anything, just means we don't support that</span>
<a href="#l23.430"></a><span id="l23.430">       }</span>
<a href="#l23.431"></a><span id="l23.431" class="difflineminus">-      if (dest == undefined) continue;</span>
<a href="#l23.432"></a><span id="l23.432" class="difflineplus">+      if (dest == undefined)</span>
<a href="#l23.433"></a><span id="l23.433" class="difflineplus">+        continue;</span>
<a href="#l23.434"></a><span id="l23.434"> </span>
<a href="#l23.435"></a><span id="l23.435">       if ((type in gGenericAttributeTypes) &amp;&amp; (slot in gGenericAttributeTypes[type])) {</span>
<a href="#l23.436"></a><span id="l23.436">         var methodName = &quot;get&quot;;</span>
<a href="#l23.437"></a><span id="l23.437">         switch (gGenericAttributeTypes[type][slot]) {</span>
<a href="#l23.438"></a><span id="l23.438">           case &quot;int&quot;:</span>
<a href="#l23.439"></a><span id="l23.439">             methodName += &quot;Int&quot;;</span>
<a href="#l23.440"></a><span id="l23.440">             break;</span>
<a href="#l23.441"></a><span id="l23.441">           case &quot;wstring&quot;:</span>
<a href="#l23.442"></a><span id="l23.442" class="difflineat">@@ -890,41 +886,40 @@ function saveAccount(accountValues, acco</span>
<a href="#l23.443"></a><span id="l23.443">             if (typeArray[slot] == &quot;false&quot;)</span>
<a href="#l23.444"></a><span id="l23.444">               typeArray[slot] = false;</span>
<a href="#l23.445"></a><span id="l23.445">             else if (typeArray[slot] == &quot;true&quot;)</span>
<a href="#l23.446"></a><span id="l23.446">               typeArray[slot] = true;</span>
<a href="#l23.447"></a><span id="l23.447"> </span>
<a href="#l23.448"></a><span id="l23.448">             methodName += &quot;Bool&quot;;</span>
<a href="#l23.449"></a><span id="l23.449">             break;</span>
<a href="#l23.450"></a><span id="l23.450">           default:</span>
<a href="#l23.451"></a><span id="l23.451" class="difflineminus">-            dump(&quot;unexpected preftype: &quot; + preftype + &quot;\n&quot;);</span>
<a href="#l23.452"></a><span id="l23.452" class="difflineplus">+            dump(&quot;unexpected preftype: &quot; + gGenericAttributeTypes[type][slot] + &quot;\n&quot;);</span>
<a href="#l23.453"></a><span id="l23.453">             break;</span>
<a href="#l23.454"></a><span id="l23.454">         }</span>
<a href="#l23.455"></a><span id="l23.455">         methodName += ((methodName + &quot;Value&quot;) in dest ? &quot;Value&quot; : &quot;Attribute&quot;);</span>
<a href="#l23.456"></a><span id="l23.456">         if (dest[methodName](slot) != typeArray[slot]) {</span>
<a href="#l23.457"></a><span id="l23.457">           methodName = methodName.replace(&quot;get&quot;, &quot;set&quot;);</span>
<a href="#l23.458"></a><span id="l23.458">           dest[methodName](slot, typeArray[slot]);</span>
<a href="#l23.459"></a><span id="l23.459">         }</span>
<a href="#l23.460"></a><span id="l23.460" class="difflineminus">-      }</span>
<a href="#l23.461"></a><span id="l23.461" class="difflineminus">-      else if (slot in dest &amp;&amp; typeArray[slot] != undefined &amp;&amp; dest[slot] != typeArray[slot]) {</span>
<a href="#l23.462"></a><span id="l23.462" class="difflineplus">+      } else if (slot in dest &amp;&amp; typeArray[slot] != undefined &amp;&amp; dest[slot] != typeArray[slot]) {</span>
<a href="#l23.463"></a><span id="l23.463">         try {</span>
<a href="#l23.464"></a><span id="l23.464">           dest[slot] = typeArray[slot];</span>
<a href="#l23.465"></a><span id="l23.465">         } catch (ex) {</span>
<a href="#l23.466"></a><span id="l23.466">           // hrm... need to handle special types here</span>
<a href="#l23.467"></a><span id="l23.467">         }</span>
<a href="#l23.468"></a><span id="l23.468">       }</span>
<a href="#l23.469"></a><span id="l23.469">     }</span>
<a href="#l23.470"></a><span id="l23.470">   }</span>
<a href="#l23.471"></a><span id="l23.471"> </span>
<a href="#l23.472"></a><span id="l23.472">   // if we made account changes to the spam settings, we'll need to re-initialize</span>
<a href="#l23.473"></a><span id="l23.473">   // our settings object</span>
<a href="#l23.474"></a><span id="l23.474">   if (server &amp;&amp; server.spamSettings) {</span>
<a href="#l23.475"></a><span id="l23.475">     try {</span>
<a href="#l23.476"></a><span id="l23.476">       server.spamSettings.initialize(server);</span>
<a href="#l23.477"></a><span id="l23.477" class="difflineminus">-    } catch(e) {</span>
<a href="#l23.478"></a><span id="l23.478" class="difflineplus">+    } catch (e) {</span>
<a href="#l23.479"></a><span id="l23.479">       let accountName = getAccountValue(account, getValueArrayFor(account), &quot;server&quot;,</span>
<a href="#l23.480"></a><span id="l23.480">                                         &quot;prettyName&quot;, null, false);</span>
<a href="#l23.481"></a><span id="l23.481">       let alertText = document.getElementById(&quot;bundle_prefs&quot;)</span>
<a href="#l23.482"></a><span id="l23.482">                               .getFormattedString(&quot;junkSettingsBroken&quot;, [accountName]);</span>
<a href="#l23.483"></a><span id="l23.483">       let review = Services.prompt.confirmEx(window, null, alertText,</span>
<a href="#l23.484"></a><span id="l23.484">         (Services.prompt.BUTTON_POS_0 * Services.prompt.BUTTON_TITLE_YES) +</span>
<a href="#l23.485"></a><span id="l23.485">         (Services.prompt.BUTTON_POS_1 * Services.prompt.BUTTON_TITLE_NO),</span>
<a href="#l23.486"></a><span id="l23.486">         null, null, null, null, {});</span>
<a href="#l23.487"></a><span id="l23.487" class="difflineat">@@ -1019,43 +1014,41 @@ function updateBlockedItems(aItems, aMus</span>
<a href="#l23.488"></a><span id="l23.488">         (!aMustBeTrue || Services.prefs.getBoolPref(prefstring)))</span>
<a href="#l23.489"></a><span id="l23.489">       item.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l23.490"></a><span id="l23.490">   }</span>
<a href="#l23.491"></a><span id="l23.491"> }</span>
<a href="#l23.492"></a><span id="l23.492"> </span>
<a href="#l23.493"></a><span id="l23.493"> /**</span>
<a href="#l23.494"></a><span id="l23.494">  * Set enabled/disabled state for the control.</span>
<a href="#l23.495"></a><span id="l23.495">  */</span>
<a href="#l23.496"></a><span id="l23.496" class="difflineminus">-function setEnabled(control, enabled)</span>
<a href="#l23.497"></a><span id="l23.497" class="difflineminus">-{</span>
<a href="#l23.498"></a><span id="l23.498" class="difflineplus">+function setEnabled(control, enabled) {</span>
<a href="#l23.499"></a><span id="l23.499">   if (!control)</span>
<a href="#l23.500"></a><span id="l23.500">     return;</span>
<a href="#l23.501"></a><span id="l23.501"> </span>
<a href="#l23.502"></a><span id="l23.502">   if (enabled)</span>
<a href="#l23.503"></a><span id="l23.503">     control.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l23.504"></a><span id="l23.504">   else</span>
<a href="#l23.505"></a><span id="l23.505">     control.setAttribute(&quot;disabled&quot;, true);</span>
<a href="#l23.506"></a><span id="l23.506"> }</span>
<a href="#l23.507"></a><span id="l23.507"> </span>
<a href="#l23.508"></a><span id="l23.508"> // Called when someone clicks on an account. Figure out context by what they</span>
<a href="#l23.509"></a><span id="l23.509"> // clicked on. This is also called when an account is removed. In this case,</span>
<a href="#l23.510"></a><span id="l23.510"> // nothing is selected.</span>
<a href="#l23.511"></a><span id="l23.511" class="difflineminus">-function onAccountTreeSelect(pageId, account)</span>
<a href="#l23.512"></a><span id="l23.512" class="difflineminus">-{</span>
<a href="#l23.513"></a><span id="l23.513" class="difflineplus">+function onAccountTreeSelect(pageId, account) {</span>
<a href="#l23.514"></a><span id="l23.514">   let tree = document.getElementById(&quot;accounttree&quot;);</span>
<a href="#l23.515"></a><span id="l23.515"> </span>
<a href="#l23.516"></a><span id="l23.516">   let changeView = pageId &amp;&amp; account;</span>
<a href="#l23.517"></a><span id="l23.517">   if (!changeView) {</span>
<a href="#l23.518"></a><span id="l23.518">     if (tree.view.selection.count &lt; 1)</span>
<a href="#l23.519"></a><span id="l23.519">       return false;</span>
<a href="#l23.520"></a><span id="l23.520"> </span>
<a href="#l23.521"></a><span id="l23.521">     let node = tree.view.getItemAtIndex(tree.currentIndex);</span>
<a href="#l23.522"></a><span id="l23.522">     account = (&quot;_account&quot; in node) ? node._account : null;</span>
<a href="#l23.523"></a><span id="l23.523"> </span>
<a href="#l23.524"></a><span id="l23.524" class="difflineminus">-    pageId = node.getAttribute(&quot;PageTag&quot;)</span>
<a href="#l23.525"></a><span id="l23.525" class="difflineplus">+    pageId = node.getAttribute(&quot;PageTag&quot;);</span>
<a href="#l23.526"></a><span id="l23.526">   }</span>
<a href="#l23.527"></a><span id="l23.527"> </span>
<a href="#l23.528"></a><span id="l23.528">   if (pageId == currentPageId &amp;&amp; account == currentAccount)</span>
<a href="#l23.529"></a><span id="l23.529">     return true;</span>
<a href="#l23.530"></a><span id="l23.530"> </span>
<a href="#l23.531"></a><span id="l23.531">   if (document.getElementById(&quot;contentFrame&quot;).contentDocument.getElementById(&quot;server.localPath&quot;)) {</span>
<a href="#l23.532"></a><span id="l23.532">     // Check if user/host names have been changed or the Local Directory is invalid.</span>
<a href="#l23.533"></a><span id="l23.533">     if (!checkUserServerChanges(false)) {</span>
<a href="#l23.534"></a><span id="l23.534" class="difflineat">@@ -1080,18 +1073,18 @@ function onAccountTreeSelect(pageId, acc</span>
<a href="#l23.535"></a><span id="l23.535">   if (currentPageId) {</span>
<a href="#l23.536"></a><span id="l23.536">     // Change focus to the account tree first so that any 'onchange' handlers</span>
<a href="#l23.537"></a><span id="l23.537">     // on elements in the current page have a chance to run before the page</span>
<a href="#l23.538"></a><span id="l23.538">     // is saved and replaced by the new one.</span>
<a href="#l23.539"></a><span id="l23.539">     tree.focus();</span>
<a href="#l23.540"></a><span id="l23.540">   }</span>
<a href="#l23.541"></a><span id="l23.541"> </span>
<a href="#l23.542"></a><span id="l23.542">   // Provide opportunity to do cleanups or checks when the current page is being left.</span>
<a href="#l23.543"></a><span id="l23.543" class="difflineminus">-  if (&quot;onLeave&quot; in top.frames[&quot;contentFrame&quot;])</span>
<a href="#l23.544"></a><span id="l23.544" class="difflineminus">-    top.frames[&quot;contentFrame&quot;].onLeave();</span>
<a href="#l23.545"></a><span id="l23.545" class="difflineplus">+  if (&quot;onLeave&quot; in top.frames.contentFrame)</span>
<a href="#l23.546"></a><span id="l23.546" class="difflineplus">+    top.frames.contentFrame.onLeave();</span>
<a href="#l23.547"></a><span id="l23.547"> </span>
<a href="#l23.548"></a><span id="l23.548">   // save the previous page</span>
<a href="#l23.549"></a><span id="l23.549">   savePage(currentAccount);</span>
<a href="#l23.550"></a><span id="l23.550"> </span>
<a href="#l23.551"></a><span id="l23.551">   let changeAccount = (account != currentAccount);</span>
<a href="#l23.552"></a><span id="l23.552"> </span>
<a href="#l23.553"></a><span id="l23.553">   if (changeView)</span>
<a href="#l23.554"></a><span id="l23.554">     selectServer(account.incomingServer, pageId);</span>
<a href="#l23.555"></a><span id="l23.555" class="difflineat">@@ -1120,68 +1113,65 @@ function onAccountTreeSelect(pageId, acc</span>
<a href="#l23.556"></a><span id="l23.556"> function onPanelLoaded(pageId) {</span>
<a href="#l23.557"></a><span id="l23.557">   if (pageId != pendingPageId) {</span>
<a href="#l23.558"></a><span id="l23.558">     // if we're reloading the current page, we'll assume the</span>
<a href="#l23.559"></a><span id="l23.559">     // page has asked itself to be completely reloaded from</span>
<a href="#l23.560"></a><span id="l23.560">     // the prefs. to do this, clear out the the old entry in</span>
<a href="#l23.561"></a><span id="l23.561">     // the account data, and then restore theh page</span>
<a href="#l23.562"></a><span id="l23.562">     if (pageId == currentPageId) {</span>
<a href="#l23.563"></a><span id="l23.563">       var serverId = currentAccount ?</span>
<a href="#l23.564"></a><span id="l23.564" class="difflineminus">-                     currentAccount.incomingServer.serverURI : &quot;global&quot;</span>
<a href="#l23.565"></a><span id="l23.565" class="difflineplus">+                     currentAccount.incomingServer.serverURI :</span>
<a href="#l23.566"></a><span id="l23.566" class="difflineplus">+                     &quot;global&quot;;</span>
<a href="#l23.567"></a><span id="l23.567">       delete accountArray[serverId];</span>
<a href="#l23.568"></a><span id="l23.568">       restorePage(currentPageId, currentAccount);</span>
<a href="#l23.569"></a><span id="l23.569">     }</span>
<a href="#l23.570"></a><span id="l23.570">   } else {</span>
<a href="#l23.571"></a><span id="l23.571">     restorePage(pendingPageId, pendingAccount);</span>
<a href="#l23.572"></a><span id="l23.572">   }</span>
<a href="#l23.573"></a><span id="l23.573"> </span>
<a href="#l23.574"></a><span id="l23.574">   // probably unnecessary, but useful for debugging</span>
<a href="#l23.575"></a><span id="l23.575">   pendingAccount = null;</span>
<a href="#l23.576"></a><span id="l23.576">   pendingPageId = null;</span>
<a href="#l23.577"></a><span id="l23.577"> }</span>
<a href="#l23.578"></a><span id="l23.578"> </span>
<a href="#l23.579"></a><span id="l23.579" class="difflineminus">-function pageURL(pageId)</span>
<a href="#l23.580"></a><span id="l23.580" class="difflineminus">-{</span>
<a href="#l23.581"></a><span id="l23.581" class="difflineplus">+function pageURL(pageId) {</span>
<a href="#l23.582"></a><span id="l23.582">   // If we have a special non account manager pane (e.g. about:blank),</span>
<a href="#l23.583"></a><span id="l23.583">   // do not translate it into ChromePackageName URL.</span>
<a href="#l23.584"></a><span id="l23.584">   if (!pageId.startsWith(&quot;am-&quot;))</span>
<a href="#l23.585"></a><span id="l23.585">     return pageId;</span>
<a href="#l23.586"></a><span id="l23.586"> </span>
<a href="#l23.587"></a><span id="l23.587">   let chromePackageName;</span>
<a href="#l23.588"></a><span id="l23.588">   try {</span>
<a href="#l23.589"></a><span id="l23.589">     // we could compare against &quot;main&quot;,&quot;server&quot;,&quot;copies&quot;,&quot;offline&quot;,&quot;addressing&quot;,</span>
<a href="#l23.590"></a><span id="l23.590">     // &quot;smtp&quot; and &quot;advanced&quot; first to save the work, but don't,</span>
<a href="#l23.591"></a><span id="l23.591">     // as some of these might be turned into extensions (for thunderbird)</span>
<a href="#l23.592"></a><span id="l23.592">     let packageName = pageId.split(&quot;am-&quot;)[1].split(&quot;.xul&quot;)[0];</span>
<a href="#l23.593"></a><span id="l23.593">     chromePackageName = MailServices.accounts.getChromePackageName(packageName);</span>
<a href="#l23.594"></a><span id="l23.594" class="difflineminus">-  }</span>
<a href="#l23.595"></a><span id="l23.595" class="difflineminus">-  catch (ex) {</span>
<a href="#l23.596"></a><span id="l23.596" class="difflineplus">+  } catch (ex) {</span>
<a href="#l23.597"></a><span id="l23.597">     chromePackageName = &quot;messenger&quot;;</span>
<a href="#l23.598"></a><span id="l23.598">   }</span>
<a href="#l23.599"></a><span id="l23.599">   return &quot;chrome://&quot; + chromePackageName + &quot;/content/&quot; + pageId;</span>
<a href="#l23.600"></a><span id="l23.600"> }</span>
<a href="#l23.601"></a><span id="l23.601"> </span>
<a href="#l23.602"></a><span id="l23.602" class="difflineminus">-function loadPage(pageId)</span>
<a href="#l23.603"></a><span id="l23.603" class="difflineminus">-{</span>
<a href="#l23.604"></a><span id="l23.604" class="difflineplus">+function loadPage(pageId) {</span>
<a href="#l23.605"></a><span id="l23.605">   const loadURIOptions = {</span>
<a href="#l23.606"></a><span id="l23.606">     triggeringPrincipal: Services.scriptSecurityManager.getSystemPrincipal(),</span>
<a href="#l23.607"></a><span id="l23.607">   };</span>
<a href="#l23.608"></a><span id="l23.608">   document.getElementById(&quot;contentFrame&quot;)</span>
<a href="#l23.609"></a><span id="l23.609">           .webNavigation.loadURI(pageURL(pageId), loadURIOptions);</span>
<a href="#l23.610"></a><span id="l23.610"> }</span>
<a href="#l23.611"></a><span id="l23.611"> </span>
<a href="#l23.612"></a><span id="l23.612"> // save the values of the widgets to the given server</span>
<a href="#l23.613"></a><span id="l23.613" class="difflineminus">-function savePage(account)</span>
<a href="#l23.614"></a><span id="l23.614" class="difflineminus">-{</span>
<a href="#l23.615"></a><span id="l23.615" class="difflineplus">+function savePage(account) {</span>
<a href="#l23.616"></a><span id="l23.616">   if (!account)</span>
<a href="#l23.617"></a><span id="l23.617">     return;</span>
<a href="#l23.618"></a><span id="l23.618"> </span>
<a href="#l23.619"></a><span id="l23.619">   // tell the page that it's about to save</span>
<a href="#l23.620"></a><span id="l23.620" class="difflineminus">-  if (&quot;onSave&quot; in top.frames[&quot;contentFrame&quot;])</span>
<a href="#l23.621"></a><span id="l23.621" class="difflineminus">-    top.frames[&quot;contentFrame&quot;].onSave();</span>
<a href="#l23.622"></a><span id="l23.622" class="difflineplus">+  if (&quot;onSave&quot; in top.frames.contentFrame)</span>
<a href="#l23.623"></a><span id="l23.623" class="difflineplus">+    top.frames.contentFrame.onSave();</span>
<a href="#l23.624"></a><span id="l23.624"> </span>
<a href="#l23.625"></a><span id="l23.625">   var accountValues = getValueArrayFor(account);</span>
<a href="#l23.626"></a><span id="l23.626">   if (!accountValues)</span>
<a href="#l23.627"></a><span id="l23.627">     return;</span>
<a href="#l23.628"></a><span id="l23.628"> </span>
<a href="#l23.629"></a><span id="l23.629">   var pageElements = getPageFormElements();</span>
<a href="#l23.630"></a><span id="l23.630">   if (!pageElements)</span>
<a href="#l23.631"></a><span id="l23.631">     return;</span>
<a href="#l23.632"></a><span id="l23.632" class="difflineat">@@ -1199,30 +1189,30 @@ function savePage(account)</span>
<a href="#l23.633"></a><span id="l23.633">                         getFormElementValue(pageElements[i]));</span>
<a href="#l23.634"></a><span id="l23.634">       }</span>
<a href="#l23.635"></a><span id="l23.635">     }</span>
<a href="#l23.636"></a><span id="l23.636">   }</span>
<a href="#l23.637"></a><span id="l23.637"> }</span>
<a href="#l23.638"></a><span id="l23.638"> </span>
<a href="#l23.639"></a><span id="l23.639"> function setAccountValue(accountValues, type, slot, value) {</span>
<a href="#l23.640"></a><span id="l23.640">   if (!(type in accountValues))</span>
<a href="#l23.641"></a><span id="l23.641" class="difflineminus">-    accountValues[type] = new Object();</span>
<a href="#l23.642"></a><span id="l23.642" class="difflineplus">+    accountValues[type] = {};</span>
<a href="#l23.643"></a><span id="l23.643"> </span>
<a href="#l23.644"></a><span id="l23.644">   accountValues[type][slot] = value;</span>
<a href="#l23.645"></a><span id="l23.645"> }</span>
<a href="#l23.646"></a><span id="l23.646"> </span>
<a href="#l23.647"></a><span id="l23.647"> function getAccountValue(account, accountValues, type, slot, preftype, isGeneric) {</span>
<a href="#l23.648"></a><span id="l23.648">   if (!(type in accountValues))</span>
<a href="#l23.649"></a><span id="l23.649" class="difflineminus">-    accountValues[type] = new Object();</span>
<a href="#l23.650"></a><span id="l23.650" class="difflineplus">+    accountValues[type] = {};</span>
<a href="#l23.651"></a><span id="l23.651"> </span>
<a href="#l23.652"></a><span id="l23.652">   // fill in the slot from the account if necessary</span>
<a href="#l23.653"></a><span id="l23.653">   if (!(slot in accountValues[type]) || accountValues[type][slot] == undefined) {</span>
<a href="#l23.654"></a><span id="l23.654">     var server;</span>
<a href="#l23.655"></a><span id="l23.655">     if (account)</span>
<a href="#l23.656"></a><span id="l23.656" class="difflineminus">-      server= account.incomingServer;</span>
<a href="#l23.657"></a><span id="l23.657" class="difflineplus">+      server = account.incomingServer;</span>
<a href="#l23.658"></a><span id="l23.658">     var source = null;</span>
<a href="#l23.659"></a><span id="l23.659">     try {</span>
<a href="#l23.660"></a><span id="l23.660">     if (type == &quot;identity&quot;)</span>
<a href="#l23.661"></a><span id="l23.661">       source = account.defaultIdentity;</span>
<a href="#l23.662"></a><span id="l23.662">     else if (type == &quot;server&quot;)</span>
<a href="#l23.663"></a><span id="l23.663">       source = account.incomingServer;</span>
<a href="#l23.664"></a><span id="l23.664">     else if (type == &quot;pop3&quot;)</span>
<a href="#l23.665"></a><span id="l23.665">       source = server.QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l23.666"></a><span id="l23.666" class="difflineat">@@ -1235,17 +1225,17 @@ function getAccountValue(account, accoun</span>
<a href="#l23.667"></a><span id="l23.667">     else if (type == &quot;smtp&quot;)</span>
<a href="#l23.668"></a><span id="l23.668">       source = MailServices.smtp.defaultServer;</span>
<a href="#l23.669"></a><span id="l23.669">     } catch (ex) {</span>
<a href="#l23.670"></a><span id="l23.670">     }</span>
<a href="#l23.671"></a><span id="l23.671"> </span>
<a href="#l23.672"></a><span id="l23.672">     if (source) {</span>
<a href="#l23.673"></a><span id="l23.673">       if (isGeneric) {</span>
<a href="#l23.674"></a><span id="l23.674">         if (!(type in gGenericAttributeTypes))</span>
<a href="#l23.675"></a><span id="l23.675" class="difflineminus">-          gGenericAttributeTypes[type] = new Object();</span>
<a href="#l23.676"></a><span id="l23.676" class="difflineplus">+          gGenericAttributeTypes[type] = {};</span>
<a href="#l23.677"></a><span id="l23.677"> </span>
<a href="#l23.678"></a><span id="l23.678">         // we need the preftype later, for setting when we save.</span>
<a href="#l23.679"></a><span id="l23.679">         gGenericAttributeTypes[type][slot] = preftype;</span>
<a href="#l23.680"></a><span id="l23.680">         var methodName = &quot;get&quot;;</span>
<a href="#l23.681"></a><span id="l23.681">         switch (preftype) {</span>
<a href="#l23.682"></a><span id="l23.682">           case &quot;int&quot;:</span>
<a href="#l23.683"></a><span id="l23.683">             methodName += &quot;Int&quot;;</span>
<a href="#l23.684"></a><span id="l23.684">             break;</span>
<a href="#l23.685"></a><span id="l23.685" class="difflineat">@@ -1259,42 +1249,39 @@ function getAccountValue(account, accoun</span>
<a href="#l23.686"></a><span id="l23.686">             methodName += &quot;Bool&quot;;</span>
<a href="#l23.687"></a><span id="l23.687">             break;</span>
<a href="#l23.688"></a><span id="l23.688">           default:</span>
<a href="#l23.689"></a><span id="l23.689">             dump(&quot;unexpected preftype: &quot; + preftype + &quot;\n&quot;);</span>
<a href="#l23.690"></a><span id="l23.690">             break;</span>
<a href="#l23.691"></a><span id="l23.691">         }</span>
<a href="#l23.692"></a><span id="l23.692">         methodName += ((methodName + &quot;Value&quot;) in source ? &quot;Value&quot; : &quot;Attribute&quot;);</span>
<a href="#l23.693"></a><span id="l23.693">         accountValues[type][slot] = source[methodName](slot);</span>
<a href="#l23.694"></a><span id="l23.694" class="difflineminus">-      }</span>
<a href="#l23.695"></a><span id="l23.695" class="difflineminus">-      else if (slot in source) {</span>
<a href="#l23.696"></a><span id="l23.696" class="difflineplus">+      } else if (slot in source) {</span>
<a href="#l23.697"></a><span id="l23.697">         accountValues[type][slot] = source[slot];</span>
<a href="#l23.698"></a><span id="l23.698">       } else {</span>
<a href="#l23.699"></a><span id="l23.699">         accountValues[type][slot] = null;</span>
<a href="#l23.700"></a><span id="l23.700">       }</span>
<a href="#l23.701"></a><span id="l23.701" class="difflineminus">-    }</span>
<a href="#l23.702"></a><span id="l23.702" class="difflineminus">-    else {</span>
<a href="#l23.703"></a><span id="l23.703" class="difflineplus">+    } else {</span>
<a href="#l23.704"></a><span id="l23.704">       accountValues[type][slot] = null;</span>
<a href="#l23.705"></a><span id="l23.705">     }</span>
<a href="#l23.706"></a><span id="l23.706">   }</span>
<a href="#l23.707"></a><span id="l23.707">   return accountValues[type][slot];</span>
<a href="#l23.708"></a><span id="l23.708"> }</span>
<a href="#l23.709"></a><span id="l23.709"> </span>
<a href="#l23.710"></a><span id="l23.710"> // restore the values of the widgets from the given server</span>
<a href="#l23.711"></a><span id="l23.711" class="difflineminus">-function restorePage(pageId, account)</span>
<a href="#l23.712"></a><span id="l23.712" class="difflineminus">-{</span>
<a href="#l23.713"></a><span id="l23.713" class="difflineplus">+function restorePage(pageId, account) {</span>
<a href="#l23.714"></a><span id="l23.714">   if (!account)</span>
<a href="#l23.715"></a><span id="l23.715">     return;</span>
<a href="#l23.716"></a><span id="l23.716"> </span>
<a href="#l23.717"></a><span id="l23.717">   var accountValues = getValueArrayFor(account);</span>
<a href="#l23.718"></a><span id="l23.718">   if (!accountValues)</span>
<a href="#l23.719"></a><span id="l23.719">     return;</span>
<a href="#l23.720"></a><span id="l23.720"> </span>
<a href="#l23.721"></a><span id="l23.721" class="difflineminus">-  if (&quot;onPreInit&quot; in top.frames[&quot;contentFrame&quot;])</span>
<a href="#l23.722"></a><span id="l23.722" class="difflineminus">-    top.frames[&quot;contentFrame&quot;].onPreInit(account, accountValues);</span>
<a href="#l23.723"></a><span id="l23.723" class="difflineplus">+  if (&quot;onPreInit&quot; in top.frames.contentFrame)</span>
<a href="#l23.724"></a><span id="l23.724" class="difflineplus">+    top.frames.contentFrame.onPreInit(account, accountValues);</span>
<a href="#l23.725"></a><span id="l23.725"> </span>
<a href="#l23.726"></a><span id="l23.726">   var pageElements = getPageFormElements();</span>
<a href="#l23.727"></a><span id="l23.727">   if (!pageElements)</span>
<a href="#l23.728"></a><span id="l23.728">     return;</span>
<a href="#l23.729"></a><span id="l23.729"> </span>
<a href="#l23.730"></a><span id="l23.730">   // restore the value from the account</span>
<a href="#l23.731"></a><span id="l23.731">   for (let i = 0; i &lt; pageElements.length; i++) {</span>
<a href="#l23.732"></a><span id="l23.732">     if (pageElements[i].id) {</span>
<a href="#l23.733"></a><span id="l23.733" class="difflineat">@@ -1307,38 +1294,38 @@ function restorePage(pageId, account)</span>
<a href="#l23.734"></a><span id="l23.734">         // elements that do have data, we get the values at poke them in.</span>
<a href="#l23.735"></a><span id="l23.735">         if (pageElements[i].localName != &quot;button&quot;) {</span>
<a href="#l23.736"></a><span id="l23.736">           var value = getAccountValue(account, accountValues, type, slot, pageElements[i].getAttribute(&quot;preftype&quot;), (pageElements[i].getAttribute(&quot;genericattr&quot;) == &quot;true&quot;));</span>
<a href="#l23.737"></a><span id="l23.737">           setFormElementValue(pageElements[i], value);</span>
<a href="#l23.738"></a><span id="l23.738">         }</span>
<a href="#l23.739"></a><span id="l23.739">         var element = pageElements[i];</span>
<a href="#l23.740"></a><span id="l23.740">         switch (type) {</span>
<a href="#l23.741"></a><span id="l23.741">           case &quot;identity&quot;:</span>
<a href="#l23.742"></a><span id="l23.742" class="difflineminus">-            element[&quot;identitykey&quot;] = account.defaultIdentity.key;</span>
<a href="#l23.743"></a><span id="l23.743" class="difflineplus">+            element.identitykey = account.defaultIdentity.key;</span>
<a href="#l23.744"></a><span id="l23.744">             break;</span>
<a href="#l23.745"></a><span id="l23.745">           case &quot;pop3&quot;:</span>
<a href="#l23.746"></a><span id="l23.746">           case &quot;imap&quot;:</span>
<a href="#l23.747"></a><span id="l23.747">           case &quot;nntp&quot;:</span>
<a href="#l23.748"></a><span id="l23.748">           case &quot;server&quot;:</span>
<a href="#l23.749"></a><span id="l23.749" class="difflineminus">-            element[&quot;serverkey&quot;] = account.incomingServer.key;</span>
<a href="#l23.750"></a><span id="l23.750" class="difflineplus">+            element.serverkey = account.incomingServer.key;</span>
<a href="#l23.751"></a><span id="l23.751">             break;</span>
<a href="#l23.752"></a><span id="l23.752">           case &quot;smtp&quot;:</span>
<a href="#l23.753"></a><span id="l23.753">             if (MailServices.smtp.defaultServer)</span>
<a href="#l23.754"></a><span id="l23.754" class="difflineminus">-              element[&quot;serverkey&quot;] = MailServices.smtp.defaultServer.key;</span>
<a href="#l23.755"></a><span id="l23.755" class="difflineplus">+              element.serverkey = MailServices.smtp.defaultServer.key;</span>
<a href="#l23.756"></a><span id="l23.756">             break;</span>
<a href="#l23.757"></a><span id="l23.757">         }</span>
<a href="#l23.758"></a><span id="l23.758">         var isLocked = getAccountValueIsLocked(pageElements[i]);</span>
<a href="#l23.759"></a><span id="l23.759">         setEnabled(pageElements[i], !isLocked);</span>
<a href="#l23.760"></a><span id="l23.760">       }</span>
<a href="#l23.761"></a><span id="l23.761">     }</span>
<a href="#l23.762"></a><span id="l23.762">   }</span>
<a href="#l23.763"></a><span id="l23.763"> </span>
<a href="#l23.764"></a><span id="l23.764">   // tell the page that new values have been loaded</span>
<a href="#l23.765"></a><span id="l23.765" class="difflineminus">-  if (&quot;onInit&quot; in top.frames[&quot;contentFrame&quot;])</span>
<a href="#l23.766"></a><span id="l23.766" class="difflineminus">-    top.frames[&quot;contentFrame&quot;].onInit(pageId, account.incomingServer.serverURI);</span>
<a href="#l23.767"></a><span id="l23.767" class="difflineplus">+  if (&quot;onInit&quot; in top.frames.contentFrame)</span>
<a href="#l23.768"></a><span id="l23.768" class="difflineplus">+    top.frames.contentFrame.onInit(pageId, account.incomingServer.serverURI);</span>
<a href="#l23.769"></a><span id="l23.769"> </span>
<a href="#l23.770"></a><span id="l23.770">   // everything has succeeded, vervied by setting currentPageId</span>
<a href="#l23.771"></a><span id="l23.771">   currentPageId = pageId;</span>
<a href="#l23.772"></a><span id="l23.772">   currentAccount = account;</span>
<a href="#l23.773"></a><span id="l23.773"> }</span>
<a href="#l23.774"></a><span id="l23.774"> </span>
<a href="#l23.775"></a><span id="l23.775"> /**</span>
<a href="#l23.776"></a><span id="l23.776">  * Gets the value of a widget in current the account settings page,</span>
<a href="#l23.777"></a><span id="l23.777" class="difflineat">@@ -1364,18 +1351,17 @@ function getFormElementValue(formElement</span>
<a href="#l23.778"></a><span id="l23.778">         return localfile;</span>
<a href="#l23.779"></a><span id="l23.779">       }</span>
<a href="#l23.780"></a><span id="l23.780">       return null;</span>
<a href="#l23.781"></a><span id="l23.781">     }</span>
<a href="#l23.782"></a><span id="l23.782">     if ((type == &quot;textbox&quot;) || (&quot;value&quot; in formElement)) {</span>
<a href="#l23.783"></a><span id="l23.783">       return formElement.value.trim();</span>
<a href="#l23.784"></a><span id="l23.784">     }</span>
<a href="#l23.785"></a><span id="l23.785">     return null;</span>
<a href="#l23.786"></a><span id="l23.786" class="difflineminus">-  }</span>
<a href="#l23.787"></a><span id="l23.787" class="difflineminus">-  catch (ex) {</span>
<a href="#l23.788"></a><span id="l23.788" class="difflineplus">+  } catch (ex) {</span>
<a href="#l23.789"></a><span id="l23.789">     Cu.reportError(&quot;getFormElementValue failed, ex=&quot; + ex + &quot;\n&quot;);</span>
<a href="#l23.790"></a><span id="l23.790">   }</span>
<a href="#l23.791"></a><span id="l23.791">   return null;</span>
<a href="#l23.792"></a><span id="l23.792"> }</span>
<a href="#l23.793"></a><span id="l23.793"> </span>
<a href="#l23.794"></a><span id="l23.794"> /**</span>
<a href="#l23.795"></a><span id="l23.795">  * Sets the value of a widget in current the account settings page,</span>
<a href="#l23.796"></a><span id="l23.796">  * automatically setting the right property of it depending on element type.</span>
<a href="#l23.797"></a><span id="l23.797" class="difflineat">@@ -1383,148 +1369,138 @@ function getFormElementValue(formElement</span>
<a href="#l23.798"></a><span id="l23.798">  * @param formElement  A XUL input element.</span>
<a href="#l23.799"></a><span id="l23.799">  * @param value        The value to store in the element.</span>
<a href="#l23.800"></a><span id="l23.800">  */</span>
<a href="#l23.801"></a><span id="l23.801"> function setFormElementValue(formElement, value) {</span>
<a href="#l23.802"></a><span id="l23.802">   var type = formElement.localName;</span>
<a href="#l23.803"></a><span id="l23.803">   if (type == &quot;checkbox&quot;) {</span>
<a href="#l23.804"></a><span id="l23.804">     if (value == null) {</span>
<a href="#l23.805"></a><span id="l23.805">       formElement.checked = false;</span>
<a href="#l23.806"></a><span id="l23.806" class="difflineplus">+    } else if (formElement.getAttribute(&quot;reversed&quot;)) {</span>
<a href="#l23.807"></a><span id="l23.807" class="difflineplus">+      formElement.checked = !value;</span>
<a href="#l23.808"></a><span id="l23.808">     } else {</span>
<a href="#l23.809"></a><span id="l23.809" class="difflineminus">-      if (formElement.getAttribute(&quot;reversed&quot;))</span>
<a href="#l23.810"></a><span id="l23.810" class="difflineminus">-        formElement.checked = !value;</span>
<a href="#l23.811"></a><span id="l23.811" class="difflineminus">-      else</span>
<a href="#l23.812"></a><span id="l23.812" class="difflineminus">-        formElement.checked = value;</span>
<a href="#l23.813"></a><span id="l23.813" class="difflineplus">+      formElement.checked = value;</span>
<a href="#l23.814"></a><span id="l23.814">     }</span>
<a href="#l23.815"></a><span id="l23.815" class="difflineminus">-  }</span>
<a href="#l23.816"></a><span id="l23.816" class="difflineminus">-  else if (type == &quot;radiogroup&quot; || type == &quot;menulist&quot;) {</span>
<a href="#l23.817"></a><span id="l23.817" class="difflineplus">+  } else if (type == &quot;radiogroup&quot; || type == &quot;menulist&quot;) {</span>
<a href="#l23.818"></a><span id="l23.818">     if (value == null)</span>
<a href="#l23.819"></a><span id="l23.819">       formElement.selectedIndex = 0;</span>
<a href="#l23.820"></a><span id="l23.820">     else</span>
<a href="#l23.821"></a><span id="l23.821">       formElement.value = value;</span>
<a href="#l23.822"></a><span id="l23.822" class="difflineminus">-  }</span>
<a href="#l23.823"></a><span id="l23.823" class="difflineminus">-  // handle nsIFile</span>
<a href="#l23.824"></a><span id="l23.824" class="difflineminus">-  else if (type == &quot;textbox&quot; &amp;&amp;</span>
<a href="#l23.825"></a><span id="l23.825" class="difflineminus">-           formElement.getAttribute(&quot;datatype&quot;) == &quot;nsIFile&quot;) {</span>
<a href="#l23.826"></a><span id="l23.826" class="difflineplus">+  } else if (type == &quot;textbox&quot; &amp;&amp; formElement.getAttribute(&quot;datatype&quot;) == &quot;nsIFile&quot;) {</span>
<a href="#l23.827"></a><span id="l23.827" class="difflineplus">+    // handle nsIFile</span>
<a href="#l23.828"></a><span id="l23.828">     if (value) {</span>
<a href="#l23.829"></a><span id="l23.829">       let localfile = value.QueryInterface(Ci.nsIFile);</span>
<a href="#l23.830"></a><span id="l23.830">       try {</span>
<a href="#l23.831"></a><span id="l23.831">         formElement.value = localfile.path;</span>
<a href="#l23.832"></a><span id="l23.832">       } catch (ex) {</span>
<a href="#l23.833"></a><span id="l23.833">         dump(&quot;Still need to fix uninitialized nsIFile problem!\n&quot;);</span>
<a href="#l23.834"></a><span id="l23.834">       }</span>
<a href="#l23.835"></a><span id="l23.835">     } else {</span>
<a href="#l23.836"></a><span id="l23.836">       formElement.value = &quot;&quot;;</span>
<a href="#l23.837"></a><span id="l23.837">     }</span>
<a href="#l23.838"></a><span id="l23.838" class="difflineminus">-  }</span>
<a href="#l23.839"></a><span id="l23.839" class="difflineminus">-  else if (type == &quot;textbox&quot;) {</span>
<a href="#l23.840"></a><span id="l23.840" class="difflineplus">+  } else if (type == &quot;textbox&quot;) {</span>
<a href="#l23.841"></a><span id="l23.841">     if (value == null)</span>
<a href="#l23.842"></a><span id="l23.842">       formElement.value = null;</span>
<a href="#l23.843"></a><span id="l23.843">     else</span>
<a href="#l23.844"></a><span id="l23.844">       formElement.value = value;</span>
<a href="#l23.845"></a><span id="l23.845" class="difflineminus">-  }</span>
<a href="#l23.846"></a><span id="l23.846" class="difflineminus">-  else if (type == &quot;label&quot;) {</span>
<a href="#l23.847"></a><span id="l23.847" class="difflineplus">+  } else if (type == &quot;label&quot;) {</span>
<a href="#l23.848"></a><span id="l23.848">     formElement.value = value || &quot;&quot;;</span>
<a href="#l23.849"></a><span id="l23.849" class="difflineminus">-  }</span>
<a href="#l23.850"></a><span id="l23.850" class="difflineminus">-  // let the form figure out what to do with it</span>
<a href="#l23.851"></a><span id="l23.851" class="difflineminus">-  else {</span>
<a href="#l23.852"></a><span id="l23.852" class="difflineminus">-    if (value == null)</span>
<a href="#l23.853"></a><span id="l23.853" class="difflineminus">-      formElement.value = null;</span>
<a href="#l23.854"></a><span id="l23.854" class="difflineminus">-    else</span>
<a href="#l23.855"></a><span id="l23.855" class="difflineminus">-      formElement.value = value;</span>
<a href="#l23.856"></a><span id="l23.856" class="difflineplus">+  } else if (value == null) { // let the form figure out what to do with it</span>
<a href="#l23.857"></a><span id="l23.857" class="difflineplus">+    formElement.value = null;</span>
<a href="#l23.858"></a><span id="l23.858" class="difflineplus">+  } else {</span>
<a href="#l23.859"></a><span id="l23.859" class="difflineplus">+    formElement.value = value;</span>
<a href="#l23.860"></a><span id="l23.860">   }</span>
<a href="#l23.861"></a><span id="l23.861"> }</span>
<a href="#l23.862"></a><span id="l23.862"> </span>
<a href="#l23.863"></a><span id="l23.863"> //</span>
<a href="#l23.864"></a><span id="l23.864"> // conversion routines - get data associated</span>
<a href="#l23.865"></a><span id="l23.865"> // with a given pageId, serverId, etc</span>
<a href="#l23.866"></a><span id="l23.866"> //</span>
<a href="#l23.867"></a><span id="l23.867"> </span>
<a href="#l23.868"></a><span id="l23.868"> // helper routine for account manager panels to get the current account for the selected server</span>
<a href="#l23.869"></a><span id="l23.869" class="difflineminus">-function getCurrentAccount()</span>
<a href="#l23.870"></a><span id="l23.870" class="difflineminus">-{</span>
<a href="#l23.871"></a><span id="l23.871" class="difflineplus">+function getCurrentAccount() {</span>
<a href="#l23.872"></a><span id="l23.872">   return currentAccount;</span>
<a href="#l23.873"></a><span id="l23.873"> }</span>
<a href="#l23.874"></a><span id="l23.874"> </span>
<a href="#l23.875"></a><span id="l23.875"> /**</span>
<a href="#l23.876"></a><span id="l23.876">  * Get the array of persisted form elements for the given page.</span>
<a href="#l23.877"></a><span id="l23.877">  */</span>
<a href="#l23.878"></a><span id="l23.878"> function getPageFormElements() {</span>
<a href="#l23.879"></a><span id="l23.879">   // Uses getElementsByAttribute() which returns a live NodeList which is usually</span>
<a href="#l23.880"></a><span id="l23.880">   // faster than e.g. querySelector().</span>
<a href="#l23.881"></a><span id="l23.881" class="difflineminus">-  if (&quot;getElementsByAttribute&quot; in top.frames[&quot;contentFrame&quot;].document)</span>
<a href="#l23.882"></a><span id="l23.882" class="difflineminus">-    return top.frames[&quot;contentFrame&quot;].document</span>
<a href="#l23.883"></a><span id="l23.883" class="difflineplus">+  if (&quot;getElementsByAttribute&quot; in top.frames.contentFrame.document) {</span>
<a href="#l23.884"></a><span id="l23.884" class="difflineplus">+    return top.frames.contentFrame.document</span>
<a href="#l23.885"></a><span id="l23.885">               .getElementsByAttribute(&quot;wsm_persist&quot;, &quot;true&quot;);</span>
<a href="#l23.886"></a><span id="l23.886" class="difflineplus">+  }</span>
<a href="#l23.887"></a><span id="l23.887"> </span>
<a href="#l23.888"></a><span id="l23.888">   return null;</span>
<a href="#l23.889"></a><span id="l23.889"> }</span>
<a href="#l23.890"></a><span id="l23.890"> </span>
<a href="#l23.891"></a><span id="l23.891"> /**</span>
<a href="#l23.892"></a><span id="l23.892">  * Get a single persisted form element in the current page.</span>
<a href="#l23.893"></a><span id="l23.893">  *</span>
<a href="#l23.894"></a><span id="l23.894">  * @param aId  ID of the element requested.</span>
<a href="#l23.895"></a><span id="l23.895">  */</span>
<a href="#l23.896"></a><span id="l23.896"> function getPageFormElement(aId) {</span>
<a href="#l23.897"></a><span id="l23.897" class="difflineminus">-  let elem = top.frames[&quot;contentFrame&quot;].document.getElementById(aId);</span>
<a href="#l23.898"></a><span id="l23.898" class="difflineplus">+  let elem = top.frames.contentFrame.document.getElementById(aId);</span>
<a href="#l23.899"></a><span id="l23.899">   if (elem &amp;&amp; (elem.getAttribute(&quot;wsm_persist&quot;) == &quot;true&quot;))</span>
<a href="#l23.900"></a><span id="l23.900">     return elem;</span>
<a href="#l23.901"></a><span id="l23.901"> </span>
<a href="#l23.902"></a><span id="l23.902">   return null;</span>
<a href="#l23.903"></a><span id="l23.903"> }</span>
<a href="#l23.904"></a><span id="l23.904"> </span>
<a href="#l23.905"></a><span id="l23.905"> // get the value array for the given account</span>
<a href="#l23.906"></a><span id="l23.906"> function getValueArrayFor(account) {</span>
<a href="#l23.907"></a><span id="l23.907">   var serverId = account ? account.incomingServer.serverURI : &quot;global&quot;;</span>
<a href="#l23.908"></a><span id="l23.908"> </span>
<a href="#l23.909"></a><span id="l23.909">   if (!(serverId in accountArray)) {</span>
<a href="#l23.910"></a><span id="l23.910" class="difflineminus">-    accountArray[serverId] = new Object();</span>
<a href="#l23.911"></a><span id="l23.911" class="difflineplus">+    accountArray[serverId] = {};</span>
<a href="#l23.912"></a><span id="l23.912">     accountArray[serverId]._account = account;</span>
<a href="#l23.913"></a><span id="l23.913">   }</span>
<a href="#l23.914"></a><span id="l23.914"> </span>
<a href="#l23.915"></a><span id="l23.915">   return accountArray[serverId];</span>
<a href="#l23.916"></a><span id="l23.916"> }</span>
<a href="#l23.917"></a><span id="l23.917"> </span>
<a href="#l23.918"></a><span id="l23.918"> var gAccountTree = {</span>
<a href="#l23.919"></a><span id="l23.919" class="difflineminus">-  load: function at_load() {</span>
<a href="#l23.920"></a><span id="l23.920" class="difflineplus">+  load() {</span>
<a href="#l23.921"></a><span id="l23.921">     this._build();</span>
<a href="#l23.922"></a><span id="l23.922"> </span>
<a href="#l23.923"></a><span id="l23.923">     MailServices.accounts.addIncomingServerListener(this);</span>
<a href="#l23.924"></a><span id="l23.924">   },</span>
<a href="#l23.925"></a><span id="l23.925" class="difflineminus">-  unload: function at_unload() {</span>
<a href="#l23.926"></a><span id="l23.926" class="difflineplus">+  unload() {</span>
<a href="#l23.927"></a><span id="l23.927">     MailServices.accounts.removeIncomingServerListener(this);</span>
<a href="#l23.928"></a><span id="l23.928">   },</span>
<a href="#l23.929"></a><span id="l23.929" class="difflineminus">-  onServerLoaded: function at_onServerLoaded(aServer) {</span>
<a href="#l23.930"></a><span id="l23.930" class="difflineplus">+  onServerLoaded(aServer) {</span>
<a href="#l23.931"></a><span id="l23.931">     this._build();</span>
<a href="#l23.932"></a><span id="l23.932">   },</span>
<a href="#l23.933"></a><span id="l23.933" class="difflineminus">-  onServerUnloaded: function at_onServerUnloaded(aServer) {</span>
<a href="#l23.934"></a><span id="l23.934" class="difflineplus">+  onServerUnloaded(aServer) {</span>
<a href="#l23.935"></a><span id="l23.935">     this._build();</span>
<a href="#l23.936"></a><span id="l23.936">   },</span>
<a href="#l23.937"></a><span id="l23.937" class="difflineminus">-  onServerChanged: function at_onServerChanged(aServer) {},</span>
<a href="#l23.938"></a><span id="l23.938" class="difflineplus">+  onServerChanged(aServer) {},</span>
<a href="#l23.939"></a><span id="l23.939"> </span>
<a href="#l23.940"></a><span id="l23.940">   _dataStore: Services.xulStore,</span>
<a href="#l23.941"></a><span id="l23.941"> </span>
<a href="#l23.942"></a><span id="l23.942">   /**</span>
<a href="#l23.943"></a><span id="l23.943">    * Retrieve from XULStore.json whether the account should be expanded (open)</span>
<a href="#l23.944"></a><span id="l23.944">    * in the account tree.</span>
<a href="#l23.945"></a><span id="l23.945">    *</span>
<a href="#l23.946"></a><span id="l23.946">    * @param aAccountKey  key of the account to check</span>
<a href="#l23.947"></a><span id="l23.947">    */</span>
<a href="#l23.948"></a><span id="l23.948" class="difflineminus">-  _getAccountOpenState: function at_getAccountOpenState(aAccountKey) {</span>
<a href="#l23.949"></a><span id="l23.949" class="difflineplus">+  _getAccountOpenState(aAccountKey) {</span>
<a href="#l23.950"></a><span id="l23.950">     if (!this._dataStore.hasValue(document.documentURI, aAccountKey, &quot;open&quot;)) {</span>
<a href="#l23.951"></a><span id="l23.951" class="difflineminus">-    // If there was no value stored, use opened state.</span>
<a href="#l23.952"></a><span id="l23.952" class="difflineplus">+      // If there was no value stored, use opened state.</span>
<a href="#l23.953"></a><span id="l23.953">       return &quot;true&quot;;</span>
<a href="#l23.954"></a><span id="l23.954" class="difflineminus">-    } else {</span>
<a href="#l23.955"></a><span id="l23.955" class="difflineminus">-      // Retrieve the persisted value from XULStore.json.</span>
<a href="#l23.956"></a><span id="l23.956" class="difflineminus">-      // It is stored under the URI of the current document and ID of the XUL element.</span>
<a href="#l23.957"></a><span id="l23.957" class="difflineminus">-      return this._dataStore</span>
<a href="#l23.958"></a><span id="l23.958" class="difflineminus">-                 .getValue(document.documentURI, aAccountKey, &quot;open&quot;);</span>
<a href="#l23.959"></a><span id="l23.959">     }</span>
<a href="#l23.960"></a><span id="l23.960" class="difflineplus">+    // Retrieve the persisted value from XULStore.json.</span>
<a href="#l23.961"></a><span id="l23.961" class="difflineplus">+    // It is stored under the URI of the current document and ID of the XUL element.</span>
<a href="#l23.962"></a><span id="l23.962" class="difflineplus">+    return this._dataStore</span>
<a href="#l23.963"></a><span id="l23.963" class="difflineplus">+               .getValue(document.documentURI, aAccountKey, &quot;open&quot;);</span>
<a href="#l23.964"></a><span id="l23.964">   },</span>
<a href="#l23.965"></a><span id="l23.965"> </span>
<a href="#l23.966"></a><span id="l23.966" class="difflineminus">-  _build: function at_build() {</span>
<a href="#l23.967"></a><span id="l23.967" class="difflineplus">+  _build() {</span>
<a href="#l23.968"></a><span id="l23.968">     var bundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l23.969"></a><span id="l23.969">     function getString(aString) { return bundle.getString(aString); }</span>
<a href="#l23.970"></a><span id="l23.970">     var panels = [{string: getString(&quot;prefPanel-server&quot;), src: &quot;am-server.xul&quot;},</span>
<a href="#l23.971"></a><span id="l23.971">                   {string: getString(&quot;prefPanel-copies&quot;), src: &quot;am-copies.xul&quot;},</span>
<a href="#l23.972"></a><span id="l23.972">                   {string: getString(&quot;prefPanel-synchronization&quot;), src: &quot;am-offline.xul&quot;},</span>
<a href="#l23.973"></a><span id="l23.973">                   {string: getString(&quot;prefPanel-diskspace&quot;), src: &quot;am-offline.xul&quot;},</span>
<a href="#l23.974"></a><span id="l23.974">                   {string: getString(&quot;prefPanel-addressing&quot;), src: &quot;am-addressing.xul&quot;},</span>
<a href="#l23.975"></a><span id="l23.975">                   {string: getString(&quot;prefPanel-junk&quot;), src: &quot;am-junk.xul&quot;}];</span>
<a href="#l23.976"></a><span id="l23.976" class="difflineat">@@ -1584,40 +1560,40 @@ var gAccountTree = {</span>
<a href="#l23.977"></a><span id="l23.977">                         .getService(Ci.nsIMsgAccountManagerExtension);</span>
<a href="#l23.978"></a><span id="l23.978">             if (svc.showPanel(server)) {</span>
<a href="#l23.979"></a><span id="l23.979">               let bundleName = &quot;chrome://&quot; + svc.chromePackageName +</span>
<a href="#l23.980"></a><span id="l23.980">                                &quot;/locale/am-&quot; + svc.name + &quot;.properties&quot;;</span>
<a href="#l23.981"></a><span id="l23.981">               let bundle = Services.strings.createBundle(bundleName);</span>
<a href="#l23.982"></a><span id="l23.982">               let title = bundle.GetStringFromName(&quot;prefPanel-&quot; + svc.name);</span>
<a href="#l23.983"></a><span id="l23.983">               panelsToKeep.push({string: title, src: &quot;am-&quot; + svc.name + &quot;.xul&quot;});</span>
<a href="#l23.984"></a><span id="l23.984">             }</span>
<a href="#l23.985"></a><span id="l23.985" class="difflineminus">-          } catch(e) {</span>
<a href="#l23.986"></a><span id="l23.986" class="difflineplus">+          } catch (e) {</span>
<a href="#l23.987"></a><span id="l23.987">             // Fetching of this extension panel failed so do not show it,</span>
<a href="#l23.988"></a><span id="l23.988">             // just log error.</span>
<a href="#l23.989"></a><span id="l23.989">             let extName = data || &quot;(unknown)&quot;;</span>
<a href="#l23.990"></a><span id="l23.990">             Cu.reportError(&quot;Error accessing panel from extension '&quot; +</span>
<a href="#l23.991"></a><span id="l23.991">                            extName + &quot;': &quot; + e);</span>
<a href="#l23.992"></a><span id="l23.992">           }</span>
<a href="#l23.993"></a><span id="l23.993">         }</span>
<a href="#l23.994"></a><span id="l23.994">         amChrome = server.accountManagerChrome;</span>
<a href="#l23.995"></a><span id="l23.995" class="difflineminus">-      } catch(e) {</span>
<a href="#l23.996"></a><span id="l23.996" class="difflineplus">+      } catch (e) {</span>
<a href="#l23.997"></a><span id="l23.997">         // Show only a placeholder in the account list saying this account</span>
<a href="#l23.998"></a><span id="l23.998">         // is broken, with no child panels.</span>
<a href="#l23.999"></a><span id="l23.999">         let accountID = (accountName || accountKey);</span>
<a href="#l23.1000"></a><span id="l23.1000">         Cu.reportError(&quot;Error accessing account &quot; + accountID + &quot;: &quot; + e);</span>
<a href="#l23.1001"></a><span id="l23.1001">         accountName = &quot;Invalid account &quot; + accountID;</span>
<a href="#l23.1002"></a><span id="l23.1002">         panelsToKeep.length = 0;</span>
<a href="#l23.1003"></a><span id="l23.1003">       }</span>
<a href="#l23.1004"></a><span id="l23.1004"> </span>
<a href="#l23.1005"></a><span id="l23.1005">       // Create the top level tree-item.</span>
<a href="#l23.1006"></a><span id="l23.1006" class="difflineminus">-      var treeitem = document.createElement(&quot;treeitem&quot;);</span>
<a href="#l23.1007"></a><span id="l23.1007" class="difflineplus">+      let treeitem = document.createElement(&quot;treeitem&quot;);</span>
<a href="#l23.1008"></a><span id="l23.1008">       mainTree.appendChild(treeitem);</span>
<a href="#l23.1009"></a><span id="l23.1009" class="difflineminus">-      var treerow = document.createElement(&quot;treerow&quot;);</span>
<a href="#l23.1010"></a><span id="l23.1010" class="difflineplus">+      let treerow = document.createElement(&quot;treerow&quot;);</span>
<a href="#l23.1011"></a><span id="l23.1011">       treeitem.appendChild(treerow);</span>
<a href="#l23.1012"></a><span id="l23.1012" class="difflineminus">-      var treecell = document.createElement(&quot;treecell&quot;);</span>
<a href="#l23.1013"></a><span id="l23.1013" class="difflineplus">+      let treecell = document.createElement(&quot;treecell&quot;);</span>
<a href="#l23.1014"></a><span id="l23.1014">       treerow.appendChild(treecell);</span>
<a href="#l23.1015"></a><span id="l23.1015">       treecell.setAttribute(&quot;label&quot;, accountName);</span>
<a href="#l23.1016"></a><span id="l23.1016">       treeitem.setAttribute(&quot;PageTag&quot;, amChrome);</span>
<a href="#l23.1017"></a><span id="l23.1017">       // Add icons based on account type.</span>
<a href="#l23.1018"></a><span id="l23.1018">       if (server) {</span>
<a href="#l23.1019"></a><span id="l23.1019">         treecell.setAttribute(&quot;properties&quot;, &quot;folderNameCol isServer-true&quot; +</span>
<a href="#l23.1020"></a><span id="l23.1020">                               &quot; serverType-&quot; + server.type);</span>
<a href="#l23.1021"></a><span id="l23.1021">         // For IM accounts, we can try to fetch a protocol specific icon.</span>
<a href="#l23.1022"></a><span id="l23.1022" class="difflineat">@@ -1650,20 +1626,20 @@ var gAccountTree = {</span>
<a href="#l23.1023"></a><span id="l23.1023">         treeitem.setAttribute(&quot;persist&quot;, &quot;open&quot;);</span>
<a href="#l23.1024"></a><span id="l23.1024">       }</span>
<a href="#l23.1025"></a><span id="l23.1025">       treeitem._account = account;</span>
<a href="#l23.1026"></a><span id="l23.1026">     }</span>
<a href="#l23.1027"></a><span id="l23.1027"> </span>
<a href="#l23.1028"></a><span id="l23.1028">     markDefaultServer(MailServices.accounts.defaultAccount, null);</span>
<a href="#l23.1029"></a><span id="l23.1029"> </span>
<a href="#l23.1030"></a><span id="l23.1030">     // Now add the outgoing server node.</span>
<a href="#l23.1031"></a><span id="l23.1031" class="difflineminus">-    var treeitem = document.createElement(&quot;treeitem&quot;);</span>
<a href="#l23.1032"></a><span id="l23.1032" class="difflineplus">+    let treeitem = document.createElement(&quot;treeitem&quot;);</span>
<a href="#l23.1033"></a><span id="l23.1033">     mainTree.appendChild(treeitem);</span>
<a href="#l23.1034"></a><span id="l23.1034" class="difflineminus">-    var treerow = document.createElement(&quot;treerow&quot;);</span>
<a href="#l23.1035"></a><span id="l23.1035" class="difflineplus">+    let treerow = document.createElement(&quot;treerow&quot;);</span>
<a href="#l23.1036"></a><span id="l23.1036">     treeitem.appendChild(treerow);</span>
<a href="#l23.1037"></a><span id="l23.1037" class="difflineminus">-    var treecell = document.createElement(&quot;treecell&quot;);</span>
<a href="#l23.1038"></a><span id="l23.1038" class="difflineplus">+    let treecell = document.createElement(&quot;treecell&quot;);</span>
<a href="#l23.1039"></a><span id="l23.1039">     treerow.appendChild(treecell);</span>
<a href="#l23.1040"></a><span id="l23.1040">     treecell.setAttribute(&quot;label&quot;, getString(&quot;prefPanel-smtp&quot;));</span>
<a href="#l23.1041"></a><span id="l23.1041">     treeitem.setAttribute(&quot;PageTag&quot;, &quot;am-smtp.xul&quot;);</span>
<a href="#l23.1042"></a><span id="l23.1042">     treecell.setAttribute(&quot;properties&quot;,</span>
<a href="#l23.1043"></a><span id="l23.1043">                           &quot;folderNameCol isServer-true serverType-smtp&quot;);</span>
<a href="#l23.1044"></a><span id="l23.1044" class="difflineminus">-  }</span>
<a href="#l23.1045"></a><span id="l23.1045" class="difflineplus">+  },</span>
<a href="#l23.1046"></a><span id="l23.1046"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountManager.xul</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountManager.xul</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -16,17 +16,19 @@</span>
<a href="#l24.4"></a><span id="l24.4">         buttons=&quot;accept,cancel&quot;</span>
<a href="#l24.5"></a><span id="l24.5">         onload=&quot;onLoad(event);&quot;</span>
<a href="#l24.6"></a><span id="l24.6">         onunload=&quot;onUnload();&quot;&gt;</span>
<a href="#l24.7"></a><span id="l24.7"> &lt;stringbundle id=&quot;bundle_brand&quot; src=&quot;chrome://branding/locale/brand.properties&quot;/&gt;</span>
<a href="#l24.8"></a><span id="l24.8"> &lt;stringbundle id=&quot;bundle_prefs&quot; src=&quot;chrome://messenger/locale/prefs.properties&quot;/&gt;</span>
<a href="#l24.9"></a><span id="l24.9"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/accountUtils.js&quot;/&gt;</span>
<a href="#l24.10"></a><span id="l24.10"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/am-prefs.js&quot;/&gt;</span>
<a href="#l24.11"></a><span id="l24.11"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/AccountManager.js&quot;/&gt;</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+#ifdef MOZ_SUITE</span>
<a href="#l24.13"></a><span id="l24.13"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/am-help.js&quot;/&gt;</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+#endif</span>
<a href="#l24.15"></a><span id="l24.15"> &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/amUtils.js&quot;/&gt;</span>
<a href="#l24.16"></a><span id="l24.16"> </span>
<a href="#l24.17"></a><span id="l24.17">   &lt;hbox flex=&quot;1&quot;&gt;</span>
<a href="#l24.18"></a><span id="l24.18">     &lt;vbox style=&quot;&amp;accountTree.width;&quot;&gt;</span>
<a href="#l24.19"></a><span id="l24.19">       &lt;tree flex=&quot;1&quot; onselect=&quot;onAccountTreeSelect(null, null);&quot; id=&quot;accounttree&quot;</span>
<a href="#l24.20"></a><span id="l24.20">             seltype=&quot;single&quot; hidecolumnpicker=&quot;true&quot;&gt;</span>
<a href="#l24.21"></a><span id="l24.21">         &lt;treecols&gt;</span>
<a href="#l24.22"></a><span id="l24.22">           &lt;treecol id=&quot;AccountCol&quot; flex=&quot;1&quot; primary=&quot;true&quot; hideheader=&quot;true&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountWizard.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountWizard.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -1,13 +1,22 @@</span>
<a href="#l25.4"></a><span id="l25.4"> /* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l25.5"></a><span id="l25.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.6"></a><span id="l25.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.7"></a><span id="l25.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.8"></a><span id="l25.8"> </span>
<a href="#l25.9"></a><span id="l25.9" class="difflineplus">+/* import-globals-from accountUtils.js */</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineplus">+/* import-globals-from amUtils.js */</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineplus">+/* import-globals-from aw-accounttype.js */</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+/* import-globals-from aw-identity.js */</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+/* import-globals-from aw-incoming.js */</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+/* import-globals-from aw-outgoing.js */</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+/* import-globals-from aw-accname.js */</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+/* import-globals-from aw-done.js */</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+</span>
<a href="#l25.18"></a><span id="l25.18"> /* the okCallback is used for sending a callback for the parent window */</span>
<a href="#l25.19"></a><span id="l25.19"> var okCallback = null;</span>
<a href="#l25.20"></a><span id="l25.20"> /* The account wizard creates new accounts */</span>
<a href="#l25.21"></a><span id="l25.21"> </span>
<a href="#l25.22"></a><span id="l25.22"> /*</span>
<a href="#l25.23"></a><span id="l25.23">   data flow into the account wizard like this:</span>
<a href="#l25.24"></a><span id="l25.24"> </span>
<a href="#l25.25"></a><span id="l25.25">   For new accounts:</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineat">@@ -93,39 +102,35 @@ function onAccountWizardLoad() {</span>
<a href="#l25.27"></a><span id="l25.27">   let donePage = document.getElementById(&quot;done&quot;);</span>
<a href="#l25.28"></a><span id="l25.28">   donePage.addEventListener(&quot;pageshow&quot;, donePageInit);</span>
<a href="#l25.29"></a><span id="l25.29"> </span>
<a href="#l25.30"></a><span id="l25.30">   gPrefsBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l25.31"></a><span id="l25.31">   gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l25.32"></a><span id="l25.32"> </span>
<a href="#l25.33"></a><span id="l25.33">   /* We are checking here for the callback argument */</span>
<a href="#l25.34"></a><span id="l25.34">   if (window.arguments &amp;&amp; window.arguments[0]) {</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineminus">-    if(window.arguments[0].okCallback )</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineminus">-    {</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineminus">-      //dump(&quot;There is okCallback&quot;);</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+    if (window.arguments[0].okCallback) {</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineplus">+      // dump(&quot;There is okCallback&quot;);</span>
<a href="#l25.40"></a><span id="l25.40">       top.okCallback = window.arguments[0].okCallback;</span>
<a href="#l25.41"></a><span id="l25.41">     }</span>
<a href="#l25.42"></a><span id="l25.42">   }</span>
<a href="#l25.43"></a><span id="l25.43"> </span>
<a href="#l25.44"></a><span id="l25.44">   checkForInvalidAccounts();</span>
<a href="#l25.45"></a><span id="l25.45"> </span>
<a href="#l25.46"></a><span id="l25.46">   // It is fine if there is no default account, this is expected the first</span>
<a href="#l25.47"></a><span id="l25.47">   // time you launch mail on a new profile.</span>
<a href="#l25.48"></a><span id="l25.48">   gDefaultAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l25.49"></a><span id="l25.49"> </span>
<a href="#l25.50"></a><span id="l25.50">   // Set default value for global inbox checkbox</span>
<a href="#l25.51"></a><span id="l25.51">   var checkGlobalInbox = document.getElementById(&quot;deferStorage&quot;);</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-  try {</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineminus">-    checkGlobalInbox.checked = Services.prefs.getBoolPref(&quot;mail.accountwizard.deferstorage&quot;);</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineminus">-  } catch(e) {}</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+  checkGlobalInbox.checked = Services.prefs.getBoolPref(&quot;mail.accountwizard.deferstorage&quot;, false);</span>
<a href="#l25.56"></a><span id="l25.56"> }</span>
<a href="#l25.57"></a><span id="l25.57"> </span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-function onCancel()</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineminus">-{</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-  if (&quot;ActivationOnCancel&quot; in this &amp;&amp; ActivationOnCancel())</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineplus">+function onCancel() {</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineplus">+  if (&quot;ActivationOnCancel&quot; in this &amp;&amp; this.ActivationOnCancel())</span>
<a href="#l25.63"></a><span id="l25.63">     return false;</span>
<a href="#l25.64"></a><span id="l25.64">   var firstInvalidAccount = getFirstInvalidAccount();</span>
<a href="#l25.65"></a><span id="l25.65">   var closeWizard = true;</span>
<a href="#l25.66"></a><span id="l25.66"> </span>
<a href="#l25.67"></a><span id="l25.67">   // if the user cancels the the wizard when it pops up because of</span>
<a href="#l25.68"></a><span id="l25.68">   // an invalid account (example, a webmail account that activation started)</span>
<a href="#l25.69"></a><span id="l25.69">   // we just force create it by setting some values and calling the FinishAccount()</span>
<a href="#l25.70"></a><span id="l25.70">   // see bug #47521 for the full discussion</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineat">@@ -139,52 +144,50 @@ function onCancel()</span>
<a href="#l25.72"></a><span id="l25.72">     // set the email if it doesn't exist</span>
<a href="#l25.73"></a><span id="l25.73">     if (!pageData.identity.email || !pageData.identity.email.value) {</span>
<a href="#l25.74"></a><span id="l25.74">       setPageData(pageData, &quot;identity&quot;, &quot;email&quot;, &quot;user@domain.invalid&quot;);</span>
<a href="#l25.75"></a><span id="l25.75">     }</span>
<a href="#l25.76"></a><span id="l25.76"> </span>
<a href="#l25.77"></a><span id="l25.77">     // call FinishAccount() and not onFinish(), since the &quot;finish&quot;</span>
<a href="#l25.78"></a><span id="l25.78">     // button may be disabled</span>
<a href="#l25.79"></a><span id="l25.79">     FinishAccount();</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineminus">-  }</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineminus">-  else {</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineplus">+  } else {</span>
<a href="#l25.83"></a><span id="l25.83">     // since this is not an invalid account</span>
<a href="#l25.84"></a><span id="l25.84">     // really cancel if the user hits the &quot;cancel&quot; button</span>
<a href="#l25.85"></a><span id="l25.85">     // if the length of the account list is less than 1, there are no accounts</span>
<a href="#l25.86"></a><span id="l25.86">     if (MailServices.accounts.accounts.length &lt; 1) {</span>
<a href="#l25.87"></a><span id="l25.87">       let confirmMsg = gPrefsBundle.getString(&quot;cancelWizard&quot;);</span>
<a href="#l25.88"></a><span id="l25.88">       let confirmTitle = gPrefsBundle.getString(&quot;accountWizard&quot;);</span>
<a href="#l25.89"></a><span id="l25.89">       let result = Services.prompt.confirmEx(window, confirmTitle, confirmMsg,</span>
<a href="#l25.90"></a><span id="l25.90">         (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l25.91"></a><span id="l25.91">         (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_1),</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineminus">-        gPrefsBundle.getString('WizardExit'),</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineminus">-        gPrefsBundle.getString('WizardContinue'),</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineminus">-        null, null, {value:0});</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineplus">+        gPrefsBundle.getString(&quot;WizardExit&quot;),</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineplus">+        gPrefsBundle.getString(&quot;WizardContinue&quot;),</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+        null, null, {value: 0});</span>
<a href="#l25.98"></a><span id="l25.98"> </span>
<a href="#l25.99"></a><span id="l25.99">       if (result == 1)</span>
<a href="#l25.100"></a><span id="l25.100">         closeWizard = false;</span>
<a href="#l25.101"></a><span id="l25.101">     }</span>
<a href="#l25.102"></a><span id="l25.102"> </span>
<a href="#l25.103"></a><span id="l25.103" class="difflineminus">-    if(top.okCallback &amp;&amp; closeWizard) {</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineplus">+    if (top.okCallback &amp;&amp; closeWizard) {</span>
<a href="#l25.105"></a><span id="l25.105">       var state = false;</span>
<a href="#l25.106"></a><span id="l25.106">       top.okCallback(state);</span>
<a href="#l25.107"></a><span id="l25.107">     }</span>
<a href="#l25.108"></a><span id="l25.108">   }</span>
<a href="#l25.109"></a><span id="l25.109">   return closeWizard;</span>
<a href="#l25.110"></a><span id="l25.110"> }</span>
<a href="#l25.111"></a><span id="l25.111"> </span>
<a href="#l25.112"></a><span id="l25.112" class="difflineminus">-function FinishAccount()</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineminus">-{</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineplus">+function FinishAccount() {</span>
<a href="#l25.115"></a><span id="l25.115">   try {</span>
<a href="#l25.116"></a><span id="l25.116">     var pageData = GetPageData();</span>
<a href="#l25.117"></a><span id="l25.117"> </span>
<a href="#l25.118"></a><span id="l25.118" class="difflineminus">-    var accountData= gCurrentAccountData;</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineplus">+    var accountData = gCurrentAccountData;</span>
<a href="#l25.120"></a><span id="l25.120"> </span>
<a href="#l25.121"></a><span id="l25.121">     if (!accountData)</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineminus">-      accountData = new Object;</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineplus">+      accountData = {};</span>
<a href="#l25.124"></a><span id="l25.124"> </span>
<a href="#l25.125"></a><span id="l25.125">     // we may need local folders before account is &quot;Finished&quot;</span>
<a href="#l25.126"></a><span id="l25.126">     // if it's a pop3 account which defers to Local Folders.</span>
<a href="#l25.127"></a><span id="l25.127">     verifyLocalFoldersAccount();</span>
<a href="#l25.128"></a><span id="l25.128"> </span>
<a href="#l25.129"></a><span id="l25.129">     PageDataToAccountData(pageData, accountData);</span>
<a href="#l25.130"></a><span id="l25.130"> </span>
<a href="#l25.131"></a><span id="l25.131">     FixupAccountDataForIsp(accountData);</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineat">@@ -207,68 +210,61 @@ function FinishAccount()</span>
<a href="#l25.133"></a><span id="l25.133">       if (document.getElementById(&quot;downloadMsgs&quot;).checked) {</span>
<a href="#l25.134"></a><span id="l25.134">         window.opener.gNewAccountToLoad = gCurrentAccount; // load messages for new POP account</span>
<a href="#l25.135"></a><span id="l25.135">       }</span>
<a href="#l25.136"></a><span id="l25.136">     }</span>
<a href="#l25.137"></a><span id="l25.137"> </span>
<a href="#l25.138"></a><span id="l25.138">     // in case we crash, force us a save of the prefs file NOW</span>
<a href="#l25.139"></a><span id="l25.139">     try {</span>
<a href="#l25.140"></a><span id="l25.140">       MailServices.accounts.saveAccountInfo();</span>
<a href="#l25.141"></a><span id="l25.141" class="difflineminus">-    }</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineminus">-    catch (ex) {</span>
<a href="#l25.143"></a><span id="l25.143" class="difflineplus">+    } catch (ex) {</span>
<a href="#l25.144"></a><span id="l25.144">       dump(&quot;Error saving account info: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l25.145"></a><span id="l25.145">     }</span>
<a href="#l25.146"></a><span id="l25.146">     window.close();</span>
<a href="#l25.147"></a><span id="l25.147" class="difflineminus">-    if(top.okCallback)</span>
<a href="#l25.148"></a><span id="l25.148" class="difflineminus">-    {</span>
<a href="#l25.149"></a><span id="l25.149" class="difflineplus">+    if (top.okCallback) {</span>
<a href="#l25.150"></a><span id="l25.150">       var state = true;</span>
<a href="#l25.151"></a><span id="l25.151" class="difflineminus">-      //dump(&quot;finish callback&quot;);</span>
<a href="#l25.152"></a><span id="l25.152" class="difflineplus">+      // dump(&quot;finish callback&quot;);</span>
<a href="#l25.153"></a><span id="l25.153">       top.okCallback(state);</span>
<a href="#l25.154"></a><span id="l25.154">     }</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineminus">-  }</span>
<a href="#l25.156"></a><span id="l25.156" class="difflineminus">-  catch(ex) {</span>
<a href="#l25.157"></a><span id="l25.157" class="difflineminus">-    dump(&quot;FinishAccount failed, &quot; + ex +&quot;\n&quot;);</span>
<a href="#l25.158"></a><span id="l25.158" class="difflineplus">+  } catch (ex) {</span>
<a href="#l25.159"></a><span id="l25.159" class="difflineplus">+    dump(&quot;FinishAccount failed, &quot; + ex + &quot;\n&quot;);</span>
<a href="#l25.160"></a><span id="l25.160">   }</span>
<a href="#l25.161"></a><span id="l25.161"> }</span>
<a href="#l25.162"></a><span id="l25.162"> </span>
<a href="#l25.163"></a><span id="l25.163"> // prepopulate pageData with stuff from accountData</span>
<a href="#l25.164"></a><span id="l25.164"> // use: to prepopulate the wizard with account information</span>
<a href="#l25.165"></a><span id="l25.165" class="difflineminus">-function AccountDataToPageData(accountData, pageData)</span>
<a href="#l25.166"></a><span id="l25.166" class="difflineminus">-{</span>
<a href="#l25.167"></a><span id="l25.167" class="difflineplus">+function AccountDataToPageData(accountData, pageData) {</span>
<a href="#l25.168"></a><span id="l25.168">   if (!accountData) {</span>
<a href="#l25.169"></a><span id="l25.169">     dump(&quot;null account data! clearing..\n&quot;);</span>
<a href="#l25.170"></a><span id="l25.170">     // handle null accountData as if it were an empty object</span>
<a href="#l25.171"></a><span id="l25.171">     // so that we clear-out any old pagedata from a</span>
<a href="#l25.172"></a><span id="l25.172">     // previous accountdata. The trick is that</span>
<a href="#l25.173"></a><span id="l25.173">     // with an empty object, accountData.identity.slot is undefined,</span>
<a href="#l25.174"></a><span id="l25.174">     // so this will clear out the prefill data in setPageData</span>
<a href="#l25.175"></a><span id="l25.175"> </span>
<a href="#l25.176"></a><span id="l25.176" class="difflineminus">-    accountData = new Object;</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineminus">-    accountData.incomingServer = new Object;</span>
<a href="#l25.178"></a><span id="l25.178" class="difflineminus">-    accountData.identity = new Object;</span>
<a href="#l25.179"></a><span id="l25.179" class="difflineminus">-    accountData.smtp = new Object;</span>
<a href="#l25.180"></a><span id="l25.180" class="difflineplus">+    accountData = {};</span>
<a href="#l25.181"></a><span id="l25.181" class="difflineplus">+    accountData.incomingServer = {};</span>
<a href="#l25.182"></a><span id="l25.182" class="difflineplus">+    accountData.identity = {};</span>
<a href="#l25.183"></a><span id="l25.183" class="difflineplus">+    accountData.smtp = {};</span>
<a href="#l25.184"></a><span id="l25.184">   }</span>
<a href="#l25.185"></a><span id="l25.185"> </span>
<a href="#l25.186"></a><span id="l25.186">   var server = accountData.incomingServer;</span>
<a href="#l25.187"></a><span id="l25.187"> </span>
<a href="#l25.188"></a><span id="l25.188">   if (server.type == undefined) {</span>
<a href="#l25.189"></a><span id="l25.189">     // clear out the old server data</span>
<a href="#l25.190"></a><span id="l25.190" class="difflineminus">-    //setPageData(pageData, &quot;accounttype&quot;, &quot;mailaccount&quot;, undefined);</span>
<a href="#l25.191"></a><span id="l25.191" class="difflineminus">-    //        setPageData(pageData, &quot;accounttype&quot;, &quot;newsaccount&quot;, undefined);</span>
<a href="#l25.192"></a><span id="l25.192" class="difflineplus">+    // setPageData(pageData, &quot;accounttype&quot;, &quot;mailaccount&quot;, undefined);</span>
<a href="#l25.193"></a><span id="l25.193" class="difflineplus">+    // setPageData(pageData, &quot;accounttype&quot;, &quot;newsaccount&quot;, undefined);</span>
<a href="#l25.194"></a><span id="l25.194">     setPageData(pageData, &quot;server&quot;, &quot;servertype&quot;, undefined);</span>
<a href="#l25.195"></a><span id="l25.195">     setPageData(pageData, &quot;server&quot;, &quot;hostname&quot;, undefined);</span>
<a href="#l25.196"></a><span id="l25.196" class="difflineminus">-</span>
<a href="#l25.197"></a><span id="l25.197" class="difflineminus">-  }</span>
<a href="#l25.198"></a><span id="l25.198" class="difflineminus">-  else {</span>
<a href="#l25.199"></a><span id="l25.199" class="difflineplus">+  } else {</span>
<a href="#l25.200"></a><span id="l25.200">     if (server.type == &quot;nntp&quot;) {</span>
<a href="#l25.201"></a><span id="l25.201">       setPageData(pageData, &quot;accounttype&quot;, &quot;newsaccount&quot;, true);</span>
<a href="#l25.202"></a><span id="l25.202">       setPageData(pageData, &quot;accounttype&quot;, &quot;mailaccount&quot;, false);</span>
<a href="#l25.203"></a><span id="l25.203">       setPageData(pageData, &quot;newsserver&quot;, &quot;hostname&quot;, server.hostName);</span>
<a href="#l25.204"></a><span id="l25.204" class="difflineminus">-    }</span>
<a href="#l25.205"></a><span id="l25.205" class="difflineminus">-    else {</span>
<a href="#l25.206"></a><span id="l25.206" class="difflineplus">+    } else {</span>
<a href="#l25.207"></a><span id="l25.207">       setPageData(pageData, &quot;accounttype&quot;, &quot;mailaccount&quot;, true);</span>
<a href="#l25.208"></a><span id="l25.208">       setPageData(pageData, &quot;accounttype&quot;, &quot;newsaccount&quot;, false);</span>
<a href="#l25.209"></a><span id="l25.209">       setPageData(pageData, &quot;server&quot;, &quot;servertype&quot;, server.type);</span>
<a href="#l25.210"></a><span id="l25.210">       setPageData(pageData, &quot;server&quot;, &quot;hostname&quot;, server.hostName);</span>
<a href="#l25.211"></a><span id="l25.211">     }</span>
<a href="#l25.212"></a><span id="l25.212">     setPageData(pageData, &quot;accounttype&quot;, &quot;otheraccount&quot;, false);</span>
<a href="#l25.213"></a><span id="l25.213">   }</span>
<a href="#l25.214"></a><span id="l25.214"> </span>
<a href="#l25.215"></a><span id="l25.215" class="difflineat">@@ -277,18 +273,17 @@ function AccountDataToPageData(accountDa</span>
<a href="#l25.216"></a><span id="l25.216">   setPageData(pageData, &quot;accname&quot;, &quot;prettyName&quot;, server.prettyName || &quot;&quot;);</span>
<a href="#l25.217"></a><span id="l25.217">   setPageData(pageData, &quot;accname&quot;, &quot;userset&quot;, false);</span>
<a href="#l25.218"></a><span id="l25.218"> </span>
<a href="#l25.219"></a><span id="l25.219">   var identity;</span>
<a href="#l25.220"></a><span id="l25.220"> </span>
<a href="#l25.221"></a><span id="l25.221">   if (accountData.identity) {</span>
<a href="#l25.222"></a><span id="l25.222">       dump(&quot;This is an accountdata\n&quot;);</span>
<a href="#l25.223"></a><span id="l25.223">       identity = accountData.identity;</span>
<a href="#l25.224"></a><span id="l25.224" class="difflineminus">-  }</span>
<a href="#l25.225"></a><span id="l25.225" class="difflineminus">-  else if (accountData.identities) {</span>
<a href="#l25.226"></a><span id="l25.226" class="difflineplus">+  } else if (accountData.identities) {</span>
<a href="#l25.227"></a><span id="l25.227">       identity = accountData.identities.queryElementAt(0, Ci.nsIMsgIdentity);</span>
<a href="#l25.228"></a><span id="l25.228">       dump(&quot;this is an account, id= &quot; + identity + &quot;\n&quot;);</span>
<a href="#l25.229"></a><span id="l25.229">   }</span>
<a href="#l25.230"></a><span id="l25.230"> </span>
<a href="#l25.231"></a><span id="l25.231">   setPageData(pageData, &quot;identity&quot;, &quot;email&quot;, identity.email || &quot;&quot;);</span>
<a href="#l25.232"></a><span id="l25.232">   setPageData(pageData, &quot;identity&quot;, &quot;fullName&quot;, identity.fullName || &quot;&quot;);</span>
<a href="#l25.233"></a><span id="l25.233"> </span>
<a href="#l25.234"></a><span id="l25.234">   var smtp;</span>
<a href="#l25.235"></a><span id="l25.235" class="difflineat">@@ -297,59 +292,56 @@ function AccountDataToPageData(accountDa</span>
<a href="#l25.236"></a><span id="l25.236">       smtp = accountData.smtp;</span>
<a href="#l25.237"></a><span id="l25.237">       setPageData(pageData, &quot;server&quot;, &quot;smtphostname&quot;, smtp.hostname);</span>
<a href="#l25.238"></a><span id="l25.238">       setPageData(pageData, &quot;login&quot;, &quot;smtpusername&quot;, smtp.username);</span>
<a href="#l25.239"></a><span id="l25.239">   }</span>
<a href="#l25.240"></a><span id="l25.240"> }</span>
<a href="#l25.241"></a><span id="l25.241"> </span>
<a href="#l25.242"></a><span id="l25.242"> // take data from each page of pageData and dump it into accountData</span>
<a href="#l25.243"></a><span id="l25.243"> // use: to put results of wizard into a account-oriented object</span>
<a href="#l25.244"></a><span id="l25.244" class="difflineminus">-function PageDataToAccountData(pageData, accountData)</span>
<a href="#l25.245"></a><span id="l25.245" class="difflineminus">-{</span>
<a href="#l25.246"></a><span id="l25.246" class="difflineplus">+function PageDataToAccountData(pageData, accountData) {</span>
<a href="#l25.247"></a><span id="l25.247">   if (!accountData.identity)</span>
<a href="#l25.248"></a><span id="l25.248" class="difflineminus">-    accountData.identity = new Object;</span>
<a href="#l25.249"></a><span id="l25.249" class="difflineplus">+    accountData.identity = {};</span>
<a href="#l25.250"></a><span id="l25.250">   if (!accountData.incomingServer)</span>
<a href="#l25.251"></a><span id="l25.251" class="difflineminus">-    accountData.incomingServer = new Object;</span>
<a href="#l25.252"></a><span id="l25.252" class="difflineplus">+    accountData.incomingServer = {};</span>
<a href="#l25.253"></a><span id="l25.253">   if (!accountData.smtp)</span>
<a href="#l25.254"></a><span id="l25.254" class="difflineminus">-    accountData.smtp = new Object;</span>
<a href="#l25.255"></a><span id="l25.255" class="difflineplus">+    accountData.smtp = {};</span>
<a href="#l25.256"></a><span id="l25.256">   if (!accountData.pop3)</span>
<a href="#l25.257"></a><span id="l25.257" class="difflineminus">-    accountData.pop3 = new Object;</span>
<a href="#l25.258"></a><span id="l25.258" class="difflineplus">+    accountData.pop3 = {};</span>
<a href="#l25.259"></a><span id="l25.259">   if (!accountData.imap)</span>
<a href="#l25.260"></a><span id="l25.260" class="difflineminus">-    accountData.imap = new Object;</span>
<a href="#l25.261"></a><span id="l25.261" class="difflineplus">+    accountData.imap = {};</span>
<a href="#l25.262"></a><span id="l25.262"> </span>
<a href="#l25.263"></a><span id="l25.263">   var identity = accountData.identity;</span>
<a href="#l25.264"></a><span id="l25.264">   var server = accountData.incomingServer;</span>
<a href="#l25.265"></a><span id="l25.265">   var smtp = accountData.smtp;</span>
<a href="#l25.266"></a><span id="l25.266">   var pop3 = accountData.pop3;</span>
<a href="#l25.267"></a><span id="l25.267">   var imap = accountData.imap;</span>
<a href="#l25.268"></a><span id="l25.268"> </span>
<a href="#l25.269"></a><span id="l25.269">   if (pageData.identity.email)</span>
<a href="#l25.270"></a><span id="l25.270">     identity.email = pageData.identity.email.value;</span>
<a href="#l25.271"></a><span id="l25.271">   if (pageData.identity.fullName)</span>
<a href="#l25.272"></a><span id="l25.272">     identity.fullName = pageData.identity.fullName.value;</span>
<a href="#l25.273"></a><span id="l25.273"> </span>
<a href="#l25.274"></a><span id="l25.274">   server.type = getCurrentServerType(pageData);</span>
<a href="#l25.275"></a><span id="l25.275">   server.hostName = getCurrentHostname(pageData);</span>
<a href="#l25.276"></a><span id="l25.276" class="difflineminus">-  if (getCurrentServerIsDeferred(pageData))</span>
<a href="#l25.277"></a><span id="l25.277" class="difflineminus">-  {</span>
<a href="#l25.278"></a><span id="l25.278" class="difflineminus">-    try</span>
<a href="#l25.279"></a><span id="l25.279" class="difflineminus">-    {</span>
<a href="#l25.280"></a><span id="l25.280" class="difflineplus">+  if (getCurrentServerIsDeferred(pageData)) {</span>
<a href="#l25.281"></a><span id="l25.281" class="difflineplus">+    try {</span>
<a href="#l25.282"></a><span id="l25.282">       let localFoldersServer = MailServices.accounts.localFoldersServer;</span>
<a href="#l25.283"></a><span id="l25.283">       let localFoldersAccount = MailServices.accounts.FindAccountForServer(localFoldersServer);</span>
<a href="#l25.284"></a><span id="l25.284">       pop3.deferredToAccount = localFoldersAccount.key;</span>
<a href="#l25.285"></a><span id="l25.285">       pop3.deferGetNewMail = true;</span>
<a href="#l25.286"></a><span id="l25.286">       server[&quot;ServerType-pop3&quot;] = pop3;</span>
<a href="#l25.287"></a><span id="l25.287" class="difflineplus">+    } catch (ex) {</span>
<a href="#l25.288"></a><span id="l25.288" class="difflineplus">+      dump(&quot;exception setting up deferred account&quot; + ex);</span>
<a href="#l25.289"></a><span id="l25.289">     }</span>
<a href="#l25.290"></a><span id="l25.290" class="difflineminus">-    catch (ex) {dump (&quot;exception setting up deferred account&quot; + ex);}</span>
<a href="#l25.291"></a><span id="l25.291">   }</span>
<a href="#l25.292"></a><span id="l25.292">   if (serverIsNntp(pageData)) {</span>
<a href="#l25.293"></a><span id="l25.293">     // this stuff probably not relevant</span>
<a href="#l25.294"></a><span id="l25.294">     dump(&quot;not setting username/password/etc\n&quot;);</span>
<a href="#l25.295"></a><span id="l25.295" class="difflineminus">-  }</span>
<a href="#l25.296"></a><span id="l25.296" class="difflineminus">-  else {</span>
<a href="#l25.297"></a><span id="l25.297" class="difflineplus">+  } else {</span>
<a href="#l25.298"></a><span id="l25.298">     if (pageData.login) {</span>
<a href="#l25.299"></a><span id="l25.299">       if (pageData.login.username)</span>
<a href="#l25.300"></a><span id="l25.300">         server.username = pageData.login.username.value;</span>
<a href="#l25.301"></a><span id="l25.301">       if (pageData.login.password)</span>
<a href="#l25.302"></a><span id="l25.302">         server.password = pageData.login.password.value;</span>
<a href="#l25.303"></a><span id="l25.303">       if (pageData.login.smtpusername)</span>
<a href="#l25.304"></a><span id="l25.304">         smtp.username = pageData.login.smtpusername.value;</span>
<a href="#l25.305"></a><span id="l25.305">     }</span>
<a href="#l25.306"></a><span id="l25.306" class="difflineat">@@ -359,68 +351,59 @@ function PageDataToAccountData(pageData,</span>
<a href="#l25.307"></a><span id="l25.307">       dump(&quot;pageData.server.smtphostname.value = &quot; + pageData.server.smtphostname + &quot;\n&quot;);</span>
<a href="#l25.308"></a><span id="l25.308">       if (pageData.server.smtphostname &amp;&amp;</span>
<a href="#l25.309"></a><span id="l25.309">           pageData.server.smtphostname.value)</span>
<a href="#l25.310"></a><span id="l25.310">         smtp.hostname = pageData.server.smtphostname.value;</span>
<a href="#l25.311"></a><span id="l25.311">     }</span>
<a href="#l25.312"></a><span id="l25.312">     if (pageData.identity &amp;&amp; pageData.identity.smtpServerKey)</span>
<a href="#l25.313"></a><span id="l25.313">       identity.smtpServerKey = pageData.identity.smtpServerKey.value;</span>
<a href="#l25.314"></a><span id="l25.314"> </span>
<a href="#l25.315"></a><span id="l25.315" class="difflineminus">-    if (pageData.server.port &amp;&amp;</span>
<a href="#l25.316"></a><span id="l25.316" class="difflineminus">-        pageData.server.port.value)</span>
<a href="#l25.317"></a><span id="l25.317" class="difflineminus">-    {</span>
<a href="#l25.318"></a><span id="l25.318" class="difflineminus">-      if (server.type == 'imap')</span>
<a href="#l25.319"></a><span id="l25.319" class="difflineminus">-      {</span>
<a href="#l25.320"></a><span id="l25.320" class="difflineplus">+    if (pageData.server.port &amp;&amp; pageData.server.port.value) {</span>
<a href="#l25.321"></a><span id="l25.321" class="difflineplus">+      if (server.type == &quot;imap&quot;) {</span>
<a href="#l25.322"></a><span id="l25.322">         imap.port = pageData.server.port.value;</span>
<a href="#l25.323"></a><span id="l25.323">         server[&quot;ServerType-imap&quot;] = imap;</span>
<a href="#l25.324"></a><span id="l25.324" class="difflineminus">-      }</span>
<a href="#l25.325"></a><span id="l25.325" class="difflineminus">-      else if (server.type == 'pop3')</span>
<a href="#l25.326"></a><span id="l25.326" class="difflineminus">-      {</span>
<a href="#l25.327"></a><span id="l25.327" class="difflineplus">+      } else if (server.type == &quot;pop3&quot;) {</span>
<a href="#l25.328"></a><span id="l25.328">         pop3.port = pageData.server.port.value;</span>
<a href="#l25.329"></a><span id="l25.329">         server[&quot;ServerType-pop3&quot;] = pop3;</span>
<a href="#l25.330"></a><span id="l25.330">       }</span>
<a href="#l25.331"></a><span id="l25.331">     }</span>
<a href="#l25.332"></a><span id="l25.332"> </span>
<a href="#l25.333"></a><span id="l25.333">     if (pageData.server.leaveMessagesOnServer &amp;&amp;</span>
<a href="#l25.334"></a><span id="l25.334" class="difflineminus">-        pageData.server.leaveMessagesOnServer.value)</span>
<a href="#l25.335"></a><span id="l25.335" class="difflineminus">-    {</span>
<a href="#l25.336"></a><span id="l25.336" class="difflineplus">+        pageData.server.leaveMessagesOnServer.value) {</span>
<a href="#l25.337"></a><span id="l25.337">       pop3.leaveMessagesOnServer = pageData.server.leaveMessagesOnServer.value;</span>
<a href="#l25.338"></a><span id="l25.338">       server[&quot;ServerType-pop3&quot;] = pop3;</span>
<a href="#l25.339"></a><span id="l25.339">     }</span>
<a href="#l25.340"></a><span id="l25.340">   }</span>
<a href="#l25.341"></a><span id="l25.341"> </span>
<a href="#l25.342"></a><span id="l25.342">   if (pageData.accname) {</span>
<a href="#l25.343"></a><span id="l25.343">     if (pageData.accname.prettyName)</span>
<a href="#l25.344"></a><span id="l25.344">       server.prettyName = pageData.accname.prettyName.value;</span>
<a href="#l25.345"></a><span id="l25.345">   }</span>
<a href="#l25.346"></a><span id="l25.346" class="difflineminus">-</span>
<a href="#l25.347"></a><span id="l25.347"> }</span>
<a href="#l25.348"></a><span id="l25.348"> </span>
<a href="#l25.349"></a><span id="l25.349"> // given an accountData structure, create an account</span>
<a href="#l25.350"></a><span id="l25.350"> // (but don't fill in any fields, that's for finishAccount()</span>
<a href="#l25.351"></a><span id="l25.351" class="difflineminus">-function createAccount(accountData)</span>
<a href="#l25.352"></a><span id="l25.352" class="difflineminus">-{</span>
<a href="#l25.353"></a><span id="l25.353" class="difflineplus">+function createAccount(accountData) {</span>
<a href="#l25.354"></a><span id="l25.354">   // Retrieve the server (data) from the account data.</span>
<a href="#l25.355"></a><span id="l25.355">   var server = accountData.incomingServer;</span>
<a href="#l25.356"></a><span id="l25.356"> </span>
<a href="#l25.357"></a><span id="l25.357">   // for news, username is always null</span>
<a href="#l25.358"></a><span id="l25.358">   var username = (server.type == &quot;nntp&quot;) ? null : server.username;</span>
<a href="#l25.359"></a><span id="l25.359">   dump(&quot;MailServices.accounts.createIncomingServer(&quot; +</span>
<a href="#l25.360"></a><span id="l25.360">        username + &quot;, &quot; + server.hostName + &quot;, &quot; + server.type + &quot;)\n&quot;);</span>
<a href="#l25.361"></a><span id="l25.361">   // Create a (actual) server.</span>
<a href="#l25.362"></a><span id="l25.362">   server = MailServices.accounts.createIncomingServer(username, server.hostName, server.type);</span>
<a href="#l25.363"></a><span id="l25.363"> </span>
<a href="#l25.364"></a><span id="l25.364">   dump(&quot;MailServices.accounts.createAccount()\n&quot;);</span>
<a href="#l25.365"></a><span id="l25.365">   // Create an account.</span>
<a href="#l25.366"></a><span id="l25.366">   let account = MailServices.accounts.createAccount();</span>
<a href="#l25.367"></a><span id="l25.367"> </span>
<a href="#l25.368"></a><span id="l25.368">   // only create an identity for this account if we really have one</span>
<a href="#l25.369"></a><span id="l25.369">   // (use the email address as a check)</span>
<a href="#l25.370"></a><span id="l25.370" class="difflineminus">-  if (accountData.identity &amp;&amp; accountData.identity.email)</span>
<a href="#l25.371"></a><span id="l25.371" class="difflineminus">-  {</span>
<a href="#l25.372"></a><span id="l25.372" class="difflineplus">+  if (accountData.identity &amp;&amp; accountData.identity.email) {</span>
<a href="#l25.373"></a><span id="l25.373">     dump(&quot;MailServices.accounts.createIdentity()\n&quot;);</span>
<a href="#l25.374"></a><span id="l25.374">     // Create an identity.</span>
<a href="#l25.375"></a><span id="l25.375">     let identity = MailServices.accounts.createIdentity();</span>
<a href="#l25.376"></a><span id="l25.376"> </span>
<a href="#l25.377"></a><span id="l25.377">     // New nntp identities should use plain text by default;</span>
<a href="#l25.378"></a><span id="l25.378">     // we want that GNKSA (The Good Net-Keeping Seal of Approval).</span>
<a href="#l25.379"></a><span id="l25.379">     if (server.type == &quot;nntp&quot;)</span>
<a href="#l25.380"></a><span id="l25.380">       identity.composeHtml = false;</span>
<a href="#l25.381"></a><span id="l25.381" class="difflineat">@@ -435,20 +418,18 @@ function createAccount(accountData)</span>
<a href="#l25.382"></a><span id="l25.382">   // Set the new account to use the new server.</span>
<a href="#l25.383"></a><span id="l25.383">   account.incomingServer = server;</span>
<a href="#l25.384"></a><span id="l25.384">   server.valid = true;</span>
<a href="#l25.385"></a><span id="l25.385">   return account;</span>
<a href="#l25.386"></a><span id="l25.386"> }</span>
<a href="#l25.387"></a><span id="l25.387"> </span>
<a href="#l25.388"></a><span id="l25.388"> // given an accountData structure, copy the data into the</span>
<a href="#l25.389"></a><span id="l25.389"> // given account, incoming server, and so forth</span>
<a href="#l25.390"></a><span id="l25.390" class="difflineminus">-function finishAccount(account, accountData)</span>
<a href="#l25.391"></a><span id="l25.391" class="difflineminus">-{</span>
<a href="#l25.392"></a><span id="l25.392" class="difflineplus">+function finishAccount(account, accountData) {</span>
<a href="#l25.393"></a><span id="l25.393">   if (accountData.incomingServer) {</span>
<a href="#l25.394"></a><span id="l25.394" class="difflineminus">-</span>
<a href="#l25.395"></a><span id="l25.395">     var destServer = account.incomingServer;</span>
<a href="#l25.396"></a><span id="l25.396">     var srcServer = accountData.incomingServer;</span>
<a href="#l25.397"></a><span id="l25.397">     copyObjectToInterface(destServer, srcServer, true);</span>
<a href="#l25.398"></a><span id="l25.398"> </span>
<a href="#l25.399"></a><span id="l25.399">     // See if there are any protocol-specific attributes.</span>
<a href="#l25.400"></a><span id="l25.400">     // If so, we use the type to get the IID, QueryInterface</span>
<a href="#l25.401"></a><span id="l25.401">     // as appropriate, then copy the data over.</span>
<a href="#l25.402"></a><span id="l25.402">     const typeProperty = &quot;ServerType-&quot; + srcServer.type;</span>
<a href="#l25.403"></a><span id="l25.403" class="difflineat">@@ -460,64 +441,61 @@ function finishAccount(account, accountD</span>
<a href="#l25.404"></a><span id="l25.404">       var IID;</span>
<a href="#l25.405"></a><span id="l25.405">       try {</span>
<a href="#l25.406"></a><span id="l25.406">         IID = destServer.protocolInfo.serverIID;</span>
<a href="#l25.407"></a><span id="l25.407">       } catch (ex) {</span>
<a href="#l25.408"></a><span id="l25.408">         Cu.reportError(&quot;Could not get IID for &quot; + srcServer.type + &quot;: &quot; + ex);</span>
<a href="#l25.409"></a><span id="l25.409">       }</span>
<a href="#l25.410"></a><span id="l25.410"> </span>
<a href="#l25.411"></a><span id="l25.411">       if (IID) {</span>
<a href="#l25.412"></a><span id="l25.412" class="difflineminus">-        destProtocolServer = destServer.QueryInterface(IID);</span>
<a href="#l25.413"></a><span id="l25.413" class="difflineminus">-        srcProtocolServer = srcServer[&quot;ServerType-&quot; + srcServer.type];</span>
<a href="#l25.414"></a><span id="l25.414" class="difflineplus">+        let destProtocolServer = destServer.QueryInterface(IID);</span>
<a href="#l25.415"></a><span id="l25.415" class="difflineplus">+        let srcProtocolServer = srcServer[&quot;ServerType-&quot; + srcServer.type];</span>
<a href="#l25.416"></a><span id="l25.416"> </span>
<a href="#l25.417"></a><span id="l25.417">         dump(&quot;Copying over &quot; + srcServer.type + &quot;-specific data\n&quot;);</span>
<a href="#l25.418"></a><span id="l25.418">         copyObjectToInterface(destProtocolServer, srcProtocolServer, false);</span>
<a href="#l25.419"></a><span id="l25.419">       }</span>
<a href="#l25.420"></a><span id="l25.420">     }</span>
<a href="#l25.421"></a><span id="l25.421"> </span>
<a href="#l25.422"></a><span id="l25.422" class="difflineminus">-    account.incomingServer.valid=true;</span>
<a href="#l25.423"></a><span id="l25.423" class="difflineplus">+    account.incomingServer.valid = true;</span>
<a href="#l25.424"></a><span id="l25.424">     // hack to cause an account loaded notification now the server is valid</span>
<a href="#l25.425"></a><span id="l25.425" class="difflineminus">-    account.incomingServer = account.incomingServer;</span>
<a href="#l25.426"></a><span id="l25.426" class="difflineplus">+    account.incomingServer = account.incomingServer; // eslint-disable-line no-self-assign</span>
<a href="#l25.427"></a><span id="l25.427">   }</span>
<a href="#l25.428"></a><span id="l25.428"> </span>
<a href="#l25.429"></a><span id="l25.429">   // copy identity info</span>
<a href="#l25.430"></a><span id="l25.430">   var destIdentity = account.identities.length ?</span>
<a href="#l25.431"></a><span id="l25.431">                      account.identities.queryElementAt(0, nsIMsgIdentity) :</span>
<a href="#l25.432"></a><span id="l25.432">                      null;</span>
<a href="#l25.433"></a><span id="l25.433"> </span>
<a href="#l25.434"></a><span id="l25.434" class="difflineminus">-  if (destIdentity) // does this account have an identity?</span>
<a href="#l25.435"></a><span id="l25.435" class="difflineminus">-  {</span>
<a href="#l25.436"></a><span id="l25.436" class="difflineplus">+  if (destIdentity) { // does this account have an identity?</span>
<a href="#l25.437"></a><span id="l25.437">       if (accountData.identity &amp;&amp; accountData.identity.email) {</span>
<a href="#l25.438"></a><span id="l25.438">           // fixup the email address if we have a default domain</span>
<a href="#l25.439"></a><span id="l25.439" class="difflineminus">-          var emailArray = accountData.identity.email.split('@');</span>
<a href="#l25.440"></a><span id="l25.440" class="difflineplus">+          let emailArray = accountData.identity.email.split(&quot;@&quot;);</span>
<a href="#l25.441"></a><span id="l25.441">           if (emailArray.length &lt; 2 &amp;&amp; accountData.domain) {</span>
<a href="#l25.442"></a><span id="l25.442" class="difflineminus">-              accountData.identity.email += '@' + accountData.domain;</span>
<a href="#l25.443"></a><span id="l25.443" class="difflineplus">+              accountData.identity.email += &quot;@&quot; + accountData.domain;</span>
<a href="#l25.444"></a><span id="l25.444">           }</span>
<a href="#l25.445"></a><span id="l25.445"> </span>
<a href="#l25.446"></a><span id="l25.446">           copyObjectToInterface(destIdentity, accountData.identity, true);</span>
<a href="#l25.447"></a><span id="l25.447" class="difflineminus">-          destIdentity.valid=true;</span>
<a href="#l25.448"></a><span id="l25.448" class="difflineplus">+          destIdentity.valid = true;</span>
<a href="#l25.449"></a><span id="l25.449">       }</span>
<a href="#l25.450"></a><span id="l25.450"> </span>
<a href="#l25.451"></a><span id="l25.451">       /**</span>
<a href="#l25.452"></a><span id="l25.452">        * If signature file need to be set, get the path to the signature file.</span>
<a href="#l25.453"></a><span id="l25.453">        * Signature files, if exist, are placed under default location. Get</span>
<a href="#l25.454"></a><span id="l25.454">        * default files location for messenger using directory service. Signature</span>
<a href="#l25.455"></a><span id="l25.455">        * file name should be extracted from the account data to build the complete</span>
<a href="#l25.456"></a><span id="l25.456">        * path for signature file. Once the path is built, set the identity's signature pref.</span>
<a href="#l25.457"></a><span id="l25.457">        */</span>
<a href="#l25.458"></a><span id="l25.458" class="difflineminus">-      if (destIdentity.attachSignature)</span>
<a href="#l25.459"></a><span id="l25.459" class="difflineminus">-      {</span>
<a href="#l25.460"></a><span id="l25.460" class="difflineplus">+      if (destIdentity.attachSignature) {</span>
<a href="#l25.461"></a><span id="l25.461">           var sigFileName = accountData.signatureFileName;</span>
<a href="#l25.462"></a><span id="l25.462">           let sigFile = MailServices.mailSession.getDataFilesDir(&quot;messenger&quot;);</span>
<a href="#l25.463"></a><span id="l25.463">           sigFile.append(sigFileName);</span>
<a href="#l25.464"></a><span id="l25.464">           destIdentity.signature = sigFile;</span>
<a href="#l25.465"></a><span id="l25.465">       }</span>
<a href="#l25.466"></a><span id="l25.466"> </span>
<a href="#l25.467"></a><span id="l25.467" class="difflineminus">-      if (accountData.smtp.hostname &amp;&amp; !destIdentity.smtpServerKey)</span>
<a href="#l25.468"></a><span id="l25.468" class="difflineminus">-      {</span>
<a href="#l25.469"></a><span id="l25.469" class="difflineplus">+      if (accountData.smtp.hostname &amp;&amp; !destIdentity.smtpServerKey) {</span>
<a href="#l25.470"></a><span id="l25.470">           // hostname + no key =&gt; create a new SMTP server.</span>
<a href="#l25.471"></a><span id="l25.471"> </span>
<a href="#l25.472"></a><span id="l25.472">           let smtpServer = MailServices.smtp.createServer();</span>
<a href="#l25.473"></a><span id="l25.473">           var isDefaultSmtpServer;</span>
<a href="#l25.474"></a><span id="l25.474">           if (!MailServices.smtp.defaultServer.hostname) {</span>
<a href="#l25.475"></a><span id="l25.475">             MailServices.smtp.defaultServer = smtpServer;</span>
<a href="#l25.476"></a><span id="l25.476">             isDefaultSmtpServer = true;</span>
<a href="#l25.477"></a><span id="l25.477">           }</span>
<a href="#l25.478"></a><span id="l25.478" class="difflineat">@@ -527,29 +505,26 @@ function finishAccount(account, accountD</span>
<a href="#l25.479"></a><span id="l25.479">           // If it's the default server we created, make the identity use</span>
<a href="#l25.480"></a><span id="l25.480">           // &quot;Use Default&quot; by default.</span>
<a href="#l25.481"></a><span id="l25.481">           destIdentity.smtpServerKey =</span>
<a href="#l25.482"></a><span id="l25.482">             (isDefaultSmtpServer) ? &quot;&quot; : smtpServer.key;</span>
<a href="#l25.483"></a><span id="l25.483">        }</span>
<a href="#l25.484"></a><span id="l25.484">    } // if the account has an identity...</span>
<a href="#l25.485"></a><span id="l25.485"> </span>
<a href="#l25.486"></a><span id="l25.486">    if (this.FinishAccountHook != undefined) {</span>
<a href="#l25.487"></a><span id="l25.487" class="difflineminus">-       FinishAccountHook(accountData.domain);</span>
<a href="#l25.488"></a><span id="l25.488" class="difflineplus">+       this.FinishAccountHook(accountData.domain);</span>
<a href="#l25.489"></a><span id="l25.489">    }</span>
<a href="#l25.490"></a><span id="l25.490"> }</span>
<a href="#l25.491"></a><span id="l25.491"> </span>
<a href="#l25.492"></a><span id="l25.492"> // Helper method used by copyObjectToInterface which attempts to set dest[attribute] as a generic</span>
<a href="#l25.493"></a><span id="l25.493"> // attribute on the xpconnect object, src.</span>
<a href="#l25.494"></a><span id="l25.494"> // This routine skips any attribute that begins with ServerType-</span>
<a href="#l25.495"></a><span id="l25.495" class="difflineminus">-function setGenericAttribute(dest, src, attribute)</span>
<a href="#l25.496"></a><span id="l25.496" class="difflineminus">-{</span>
<a href="#l25.497"></a><span id="l25.497" class="difflineminus">-  if (!(attribute.toLowerCase().startsWith(&quot;servertype-&quot;)) &amp;&amp; src[attribute])</span>
<a href="#l25.498"></a><span id="l25.498" class="difflineminus">-  {</span>
<a href="#l25.499"></a><span id="l25.499" class="difflineminus">-    switch (typeof src[attribute])</span>
<a href="#l25.500"></a><span id="l25.500" class="difflineminus">-    {</span>
<a href="#l25.501"></a><span id="l25.501" class="difflineplus">+function setGenericAttribute(dest, src, attribute) {</span>
<a href="#l25.502"></a><span id="l25.502" class="difflineplus">+  if (!(attribute.toLowerCase().startsWith(&quot;servertype-&quot;)) &amp;&amp; src[attribute]) {</span>
<a href="#l25.503"></a><span id="l25.503" class="difflineplus">+    switch (typeof src[attribute]) {</span>
<a href="#l25.504"></a><span id="l25.504">       case &quot;string&quot;:</span>
<a href="#l25.505"></a><span id="l25.505">         dest.setUnicharAttribute(attribute, src[attribute]);</span>
<a href="#l25.506"></a><span id="l25.506">         break;</span>
<a href="#l25.507"></a><span id="l25.507">       case &quot;boolean&quot;:</span>
<a href="#l25.508"></a><span id="l25.508">         dest.setBoolAttribute(attribute, src[attribute]);</span>
<a href="#l25.509"></a><span id="l25.509">         break;</span>
<a href="#l25.510"></a><span id="l25.510">       case &quot;number&quot;:</span>
<a href="#l25.511"></a><span id="l25.511">         dest.setIntAttribute(attribute, src[attribute]);</span>
<a href="#l25.512"></a><span id="l25.512" class="difflineat">@@ -561,108 +536,94 @@ function setGenericAttribute(dest, src, </span>
<a href="#l25.513"></a><span id="l25.513">   }</span>
<a href="#l25.514"></a><span id="l25.514"> }</span>
<a href="#l25.515"></a><span id="l25.515"> </span>
<a href="#l25.516"></a><span id="l25.516"> // copy over all attributes from dest into src that already exist in src</span>
<a href="#l25.517"></a><span id="l25.517"> // the assumption is that src is an XPConnect interface full of attributes</span>
<a href="#l25.518"></a><span id="l25.518"> // @param useGenericFallback if we can't set an attribute directly on src, then fall back</span>
<a href="#l25.519"></a><span id="l25.519"> //        and try setting it generically. This assumes that src supports setIntAttribute, setUnicharAttribute</span>
<a href="#l25.520"></a><span id="l25.520"> //        and setBoolAttribute.</span>
<a href="#l25.521"></a><span id="l25.521" class="difflineminus">-function copyObjectToInterface(dest, src, useGenericFallback)</span>
<a href="#l25.522"></a><span id="l25.522" class="difflineminus">-{</span>
<a href="#l25.523"></a><span id="l25.523" class="difflineplus">+function copyObjectToInterface(dest, src, useGenericFallback) {</span>
<a href="#l25.524"></a><span id="l25.524">   if (!dest) return;</span>
<a href="#l25.525"></a><span id="l25.525">   if (!src) return;</span>
<a href="#l25.526"></a><span id="l25.526"> </span>
<a href="#l25.527"></a><span id="l25.527">   var attribute;</span>
<a href="#l25.528"></a><span id="l25.528" class="difflineminus">-  for (attribute in src)</span>
<a href="#l25.529"></a><span id="l25.529" class="difflineminus">-  {</span>
<a href="#l25.530"></a><span id="l25.530" class="difflineminus">-    if (dest.__lookupSetter__(attribute))</span>
<a href="#l25.531"></a><span id="l25.531" class="difflineminus">-    {</span>
<a href="#l25.532"></a><span id="l25.532" class="difflineplus">+  for (attribute in src) {</span>
<a href="#l25.533"></a><span id="l25.533" class="difflineplus">+    if (dest.__lookupSetter__(attribute)) {</span>
<a href="#l25.534"></a><span id="l25.534">       if (dest[attribute] != src[attribute])</span>
<a href="#l25.535"></a><span id="l25.535">         dest[attribute] = src[attribute];</span>
<a href="#l25.536"></a><span id="l25.536" class="difflineplus">+    } else if (useGenericFallback) { // fall back to setting the attribute generically</span>
<a href="#l25.537"></a><span id="l25.537" class="difflineplus">+      setGenericAttribute(dest, src, attribute);</span>
<a href="#l25.538"></a><span id="l25.538">     }</span>
<a href="#l25.539"></a><span id="l25.539" class="difflineminus">-    else if (useGenericFallback) // fall back to setting the attribute generically</span>
<a href="#l25.540"></a><span id="l25.540" class="difflineminus">-      setGenericAttribute(dest, src, attribute);</span>
<a href="#l25.541"></a><span id="l25.541">   } // for each attribute in src we want to copy</span>
<a href="#l25.542"></a><span id="l25.542"> }</span>
<a href="#l25.543"></a><span id="l25.543"> </span>
<a href="#l25.544"></a><span id="l25.544"> // check if there already is a &quot;Local Folders&quot;</span>
<a href="#l25.545"></a><span id="l25.545"> // if not, create it.</span>
<a href="#l25.546"></a><span id="l25.546" class="difflineminus">-function verifyLocalFoldersAccount()</span>
<a href="#l25.547"></a><span id="l25.547" class="difflineminus">-{</span>
<a href="#l25.548"></a><span id="l25.548" class="difflineplus">+function verifyLocalFoldersAccount() {</span>
<a href="#l25.549"></a><span id="l25.549">   var localMailServer = null;</span>
<a href="#l25.550"></a><span id="l25.550">   try {</span>
<a href="#l25.551"></a><span id="l25.551">     localMailServer = MailServices.accounts.localFoldersServer;</span>
<a href="#l25.552"></a><span id="l25.552" class="difflineminus">-  }</span>
<a href="#l25.553"></a><span id="l25.553" class="difflineminus">-  catch (ex) {</span>
<a href="#l25.554"></a><span id="l25.554" class="difflineplus">+  } catch (ex) {</span>
<a href="#l25.555"></a><span id="l25.555">          // dump(&quot;exception in findserver: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l25.556"></a><span id="l25.556">     localMailServer = null;</span>
<a href="#l25.557"></a><span id="l25.557">   }</span>
<a href="#l25.558"></a><span id="l25.558"> </span>
<a href="#l25.559"></a><span id="l25.559">   try {</span>
<a href="#l25.560"></a><span id="l25.560" class="difflineminus">-    if (!localMailServer)</span>
<a href="#l25.561"></a><span id="l25.561" class="difflineminus">-    {</span>
<a href="#l25.562"></a><span id="l25.562" class="difflineplus">+    if (!localMailServer) {</span>
<a href="#l25.563"></a><span id="l25.563">       // dump(&quot;Creating local mail account\n&quot;);</span>
<a href="#l25.564"></a><span id="l25.564">       // creates a copy of the identity you pass in</span>
<a href="#l25.565"></a><span id="l25.565">       MailServices.accounts.createLocalMailAccount();</span>
<a href="#l25.566"></a><span id="l25.566">       try {</span>
<a href="#l25.567"></a><span id="l25.567">         localMailServer = MailServices.accounts.localFoldersServer;</span>
<a href="#l25.568"></a><span id="l25.568" class="difflineminus">-      }</span>
<a href="#l25.569"></a><span id="l25.569" class="difflineminus">-      catch (ex) {</span>
<a href="#l25.570"></a><span id="l25.570" class="difflineplus">+      } catch (ex) {</span>
<a href="#l25.571"></a><span id="l25.571">         dump(&quot;error!  we should have found the local mail server after we created it.\n&quot;);</span>
<a href="#l25.572"></a><span id="l25.572">         localMailServer = null;</span>
<a href="#l25.573"></a><span id="l25.573">       }</span>
<a href="#l25.574"></a><span id="l25.574">     }</span>
<a href="#l25.575"></a><span id="l25.575" class="difflineplus">+  } catch (ex) {</span>
<a href="#l25.576"></a><span id="l25.576" class="difflineplus">+    dump(&quot;Error in verifyLocalFoldersAccount&quot; + ex + &quot;\n&quot;);</span>
<a href="#l25.577"></a><span id="l25.577">   }</span>
<a href="#l25.578"></a><span id="l25.578" class="difflineminus">-  catch (ex) {dump(&quot;Error in verifyLocalFoldersAccount&quot; + ex + &quot;\n&quot;);  }</span>
<a href="#l25.579"></a><span id="l25.579" class="difflineminus">-</span>
<a href="#l25.580"></a><span id="l25.580"> }</span>
<a href="#l25.581"></a><span id="l25.581"> </span>
<a href="#l25.582"></a><span id="l25.582" class="difflineminus">-function setupCopiesAndFoldersServer(account, accountIsDeferred, accountData)</span>
<a href="#l25.583"></a><span id="l25.583" class="difflineminus">-{</span>
<a href="#l25.584"></a><span id="l25.584" class="difflineplus">+function setupCopiesAndFoldersServer(account, accountIsDeferred, accountData) {</span>
<a href="#l25.585"></a><span id="l25.585">   try {</span>
<a href="#l25.586"></a><span id="l25.586">     var server = account.incomingServer;</span>
<a href="#l25.587"></a><span id="l25.587"> </span>
<a href="#l25.588"></a><span id="l25.588">     // This function sets up the default send preferences. The send preferences</span>
<a href="#l25.589"></a><span id="l25.589">     // go on identities, so there is no need to continue without any identities.</span>
<a href="#l25.590"></a><span id="l25.590">     if (server.type == &quot;rss&quot; || account.identities.length == 0)</span>
<a href="#l25.591"></a><span id="l25.591">       return false;</span>
<a href="#l25.592"></a><span id="l25.592">     let identity = account.identities.queryElementAt(0, Ci.nsIMsgIdentity);</span>
<a href="#l25.593"></a><span id="l25.593">     // For this server, do we default the folder prefs to this server, or to the &quot;Local Folders&quot; server</span>
<a href="#l25.594"></a><span id="l25.594">     // If it's deferred, we use the local folders account.</span>
<a href="#l25.595"></a><span id="l25.595">     var defaultCopiesAndFoldersPrefsToServer = !accountIsDeferred &amp;&amp; server.defaultCopiesAndFoldersPrefsToServer;</span>
<a href="#l25.596"></a><span id="l25.596"> </span>
<a href="#l25.597"></a><span id="l25.597">     var copiesAndFoldersServer = null;</span>
<a href="#l25.598"></a><span id="l25.598" class="difflineminus">-    if (defaultCopiesAndFoldersPrefsToServer)</span>
<a href="#l25.599"></a><span id="l25.599" class="difflineminus">-    {</span>
<a href="#l25.600"></a><span id="l25.600" class="difflineplus">+    if (defaultCopiesAndFoldersPrefsToServer) {</span>
<a href="#l25.601"></a><span id="l25.601">       copiesAndFoldersServer = server;</span>
<a href="#l25.602"></a><span id="l25.602" class="difflineminus">-    }</span>
<a href="#l25.603"></a><span id="l25.603" class="difflineminus">-    else</span>
<a href="#l25.604"></a><span id="l25.604" class="difflineminus">-    {</span>
<a href="#l25.605"></a><span id="l25.605" class="difflineminus">-      if (!MailServices.accounts.localFoldersServer)</span>
<a href="#l25.606"></a><span id="l25.606" class="difflineminus">-      {</span>
<a href="#l25.607"></a><span id="l25.607" class="difflineplus">+    } else {</span>
<a href="#l25.608"></a><span id="l25.608" class="difflineplus">+      if (!MailServices.accounts.localFoldersServer) {</span>
<a href="#l25.609"></a><span id="l25.609">         dump(&quot;error!  we should have a local mail server at this point\n&quot;);</span>
<a href="#l25.610"></a><span id="l25.610">         return false;</span>
<a href="#l25.611"></a><span id="l25.611">       }</span>
<a href="#l25.612"></a><span id="l25.612">       copiesAndFoldersServer = MailServices.accounts.localFoldersServer;</span>
<a href="#l25.613"></a><span id="l25.613">     }</span>
<a href="#l25.614"></a><span id="l25.614"> </span>
<a href="#l25.615"></a><span id="l25.615">     setDefaultCopiesAndFoldersPrefs(identity, copiesAndFoldersServer, accountData);</span>
<a href="#l25.616"></a><span id="l25.616" class="difflineminus">-</span>
<a href="#l25.617"></a><span id="l25.617">   } catch (ex) {</span>
<a href="#l25.618"></a><span id="l25.618">     // return false (meaning we did not setupCopiesAndFoldersServer)</span>
<a href="#l25.619"></a><span id="l25.619">     // on any error</span>
<a href="#l25.620"></a><span id="l25.620">     dump(&quot;Error in setupCopiesAndFoldersServer: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l25.621"></a><span id="l25.621">     return false;</span>
<a href="#l25.622"></a><span id="l25.622">   }</span>
<a href="#l25.623"></a><span id="l25.623">   return true;</span>
<a href="#l25.624"></a><span id="l25.624"> }</span>
<a href="#l25.625"></a><span id="l25.625"> </span>
<a href="#l25.626"></a><span id="l25.626" class="difflineminus">-function setDefaultCopiesAndFoldersPrefs(identity, server, accountData)</span>
<a href="#l25.627"></a><span id="l25.627" class="difflineminus">-{</span>
<a href="#l25.628"></a><span id="l25.628" class="difflineplus">+function setDefaultCopiesAndFoldersPrefs(identity, server, accountData) {</span>
<a href="#l25.629"></a><span id="l25.629">   var rootFolder = server.rootFolder;</span>
<a href="#l25.630"></a><span id="l25.630"> </span>
<a href="#l25.631"></a><span id="l25.631">   // we need to do this or it is possible that the server's draft,</span>
<a href="#l25.632"></a><span id="l25.632">   // stationery fcc folder will not be in rdf</span>
<a href="#l25.633"></a><span id="l25.633">   //</span>
<a href="#l25.634"></a><span id="l25.634">   // this can happen in a couple cases</span>
<a href="#l25.635"></a><span id="l25.635">   // 1) the first account we create, creates the local mail.  since</span>
<a href="#l25.636"></a><span id="l25.636">   // local mail was just created, it obviously hasn't been opened,</span>
<a href="#l25.637"></a><span id="l25.637" class="difflineat">@@ -696,54 +657,50 @@ function setDefaultCopiesAndFoldersPrefs</span>
<a href="#l25.638"></a><span id="l25.638">   // Note the capital F, D and S!</span>
<a href="#l25.639"></a><span id="l25.639">   var draftFolder = (accountData.identity &amp;&amp; accountData.identity.DraftFolder ?</span>
<a href="#l25.640"></a><span id="l25.640">     accountData.identity.DraftFolder : &quot;Drafts&quot;);</span>
<a href="#l25.641"></a><span id="l25.641">   var stationeryFolder = (accountData.identity &amp;&amp; accountData.identity.StationeryFolder ?</span>
<a href="#l25.642"></a><span id="l25.642">     accountData.identity.StationeryFolder : &quot;Templates&quot;);</span>
<a href="#l25.643"></a><span id="l25.643">   var fccFolder = (accountData.identity &amp;&amp; accountData.identity.FccFolder ?</span>
<a href="#l25.644"></a><span id="l25.644">     accountData.identity.FccFolder : &quot;Sent&quot;);</span>
<a href="#l25.645"></a><span id="l25.645"> </span>
<a href="#l25.646"></a><span id="l25.646" class="difflineminus">-  identity.draftFolder = msgFolder.server.serverURI+ folderDelim + draftFolder;</span>
<a href="#l25.647"></a><span id="l25.647" class="difflineminus">-  identity.stationeryFolder = msgFolder.server.serverURI+ folderDelim + stationeryFolder;</span>
<a href="#l25.648"></a><span id="l25.648" class="difflineminus">-  identity.fccFolder = msgFolder.server.serverURI+ folderDelim + fccFolder;</span>
<a href="#l25.649"></a><span id="l25.649" class="difflineplus">+  identity.draftFolder = msgFolder.server.serverURI + folderDelim + draftFolder;</span>
<a href="#l25.650"></a><span id="l25.650" class="difflineplus">+  identity.stationeryFolder = msgFolder.server.serverURI + folderDelim + stationeryFolder;</span>
<a href="#l25.651"></a><span id="l25.651" class="difflineplus">+  identity.fccFolder = msgFolder.server.serverURI + folderDelim + fccFolder;</span>
<a href="#l25.652"></a><span id="l25.652"> </span>
<a href="#l25.653"></a><span id="l25.653">   // Note the capital F, D and S!</span>
<a href="#l25.654"></a><span id="l25.654">   identity.fccFolderPickerMode = (accountData.identity &amp;&amp;</span>
<a href="#l25.655"></a><span id="l25.655">     accountData.identity.FccFolder ? 1 : gDefaultSpecialFolderPickerMode);</span>
<a href="#l25.656"></a><span id="l25.656">   identity.draftsFolderPickerMode = (accountData.identity &amp;&amp;</span>
<a href="#l25.657"></a><span id="l25.657">     accountData.identity.DraftFolder ? 1 : gDefaultSpecialFolderPickerMode);</span>
<a href="#l25.658"></a><span id="l25.658">   identity.tmplFolderPickerMode = (accountData.identity &amp;&amp;</span>
<a href="#l25.659"></a><span id="l25.659">     accountData.identity.StationeryFolder ? 1 : gDefaultSpecialFolderPickerMode);</span>
<a href="#l25.660"></a><span id="l25.660"> }</span>
<a href="#l25.661"></a><span id="l25.661"> </span>
<a href="#l25.662"></a><span id="l25.662" class="difflineminus">-function AccountExists(userName, hostName, serverType)</span>
<a href="#l25.663"></a><span id="l25.663" class="difflineminus">-{</span>
<a href="#l25.664"></a><span id="l25.664" class="difflineplus">+function AccountExists(userName, hostName, serverType) {</span>
<a href="#l25.665"></a><span id="l25.665">   return MailServices.accounts.findRealServer(userName, hostName, serverType, 0);</span>
<a href="#l25.666"></a><span id="l25.666"> }</span>
<a href="#l25.667"></a><span id="l25.667"> </span>
<a href="#l25.668"></a><span id="l25.668" class="difflineminus">-function getFirstInvalidAccount()</span>
<a href="#l25.669"></a><span id="l25.669" class="difflineminus">-{</span>
<a href="#l25.670"></a><span id="l25.670" class="difflineplus">+function getFirstInvalidAccount() {</span>
<a href="#l25.671"></a><span id="l25.671">   let invalidAccounts = getInvalidAccounts(MailServices.accounts.accounts);</span>
<a href="#l25.672"></a><span id="l25.672"> </span>
<a href="#l25.673"></a><span id="l25.673">   if (invalidAccounts.length &gt; 0)</span>
<a href="#l25.674"></a><span id="l25.674">     return invalidAccounts[0];</span>
<a href="#l25.675"></a><span id="l25.675" class="difflineminus">-  else</span>
<a href="#l25.676"></a><span id="l25.676" class="difflineminus">-    return null;</span>
<a href="#l25.677"></a><span id="l25.677" class="difflineplus">+  return null;</span>
<a href="#l25.678"></a><span id="l25.678"> }</span>
<a href="#l25.679"></a><span id="l25.679"> </span>
<a href="#l25.680"></a><span id="l25.680" class="difflineminus">-function checkForInvalidAccounts()</span>
<a href="#l25.681"></a><span id="l25.681" class="difflineminus">-{</span>
<a href="#l25.682"></a><span id="l25.682" class="difflineplus">+function checkForInvalidAccounts() {</span>
<a href="#l25.683"></a><span id="l25.683">   var firstInvalidAccount = getFirstInvalidAccount();</span>
<a href="#l25.684"></a><span id="l25.684"> </span>
<a href="#l25.685"></a><span id="l25.685">   if (firstInvalidAccount) {</span>
<a href="#l25.686"></a><span id="l25.686">     var pageData = GetPageData();</span>
<a href="#l25.687"></a><span id="l25.687">     dump(&quot;We have an invalid account, &quot; + firstInvalidAccount + &quot;, let's use that!\n&quot;);</span>
<a href="#l25.688"></a><span id="l25.688">     gCurrentAccount = firstInvalidAccount;</span>
<a href="#l25.689"></a><span id="l25.689"> </span>
<a href="#l25.690"></a><span id="l25.690" class="difflineminus">-    var accountData = new Object;</span>
<a href="#l25.691"></a><span id="l25.691" class="difflineplus">+    var accountData = {};</span>
<a href="#l25.692"></a><span id="l25.692">     accountData.incomingServer = firstInvalidAccount.incomingServer;</span>
<a href="#l25.693"></a><span id="l25.693">     accountData.identity = firstInvalidAccount.identities.queryElementAt(0,</span>
<a href="#l25.694"></a><span id="l25.694">       nsIMsgIdentity);</span>
<a href="#l25.695"></a><span id="l25.695">     accountData.smtp = MailServices.smtp.defaultServer;</span>
<a href="#l25.696"></a><span id="l25.696">     AccountDataToPageData(accountData, pageData);</span>
<a href="#l25.697"></a><span id="l25.697"> </span>
<a href="#l25.698"></a><span id="l25.698">     gCurrentAccountData = accountData;</span>
<a href="#l25.699"></a><span id="l25.699"> </span>
<a href="#l25.700"></a><span id="l25.700" class="difflineat">@@ -755,40 +712,37 @@ function checkForInvalidAccounts()</span>
<a href="#l25.701"></a><span id="l25.701"> </span>
<a href="#l25.702"></a><span id="l25.702"> // sets the page data, automatically creating the arrays as necessary</span>
<a href="#l25.703"></a><span id="l25.703"> function setPageData(pageData, tag, slot, value) {</span>
<a href="#l25.704"></a><span id="l25.704">   if (!pageData[tag]) pageData[tag] = [];</span>
<a href="#l25.705"></a><span id="l25.705"> </span>
<a href="#l25.706"></a><span id="l25.706">   if (value == undefined) {</span>
<a href="#l25.707"></a><span id="l25.707">     // clear out this slot</span>
<a href="#l25.708"></a><span id="l25.708">     if (pageData[tag][slot]) delete pageData[tag][slot];</span>
<a href="#l25.709"></a><span id="l25.709" class="difflineminus">-  }</span>
<a href="#l25.710"></a><span id="l25.710" class="difflineminus">-  else {</span>
<a href="#l25.711"></a><span id="l25.711" class="difflineplus">+  } else {</span>
<a href="#l25.712"></a><span id="l25.712">     // pre-fill this slot</span>
<a href="#l25.713"></a><span id="l25.713">     if (!pageData[tag][slot]) pageData[tag][slot] = [];</span>
<a href="#l25.714"></a><span id="l25.714">     pageData[tag][slot].id = slot;</span>
<a href="#l25.715"></a><span id="l25.715">     pageData[tag][slot].value = value;</span>
<a href="#l25.716"></a><span id="l25.716">   }</span>
<a href="#l25.717"></a><span id="l25.717"> }</span>
<a href="#l25.718"></a><span id="l25.718"> </span>
<a href="#l25.719"></a><span id="l25.719"> // value of checkbox on the first page</span>
<a href="#l25.720"></a><span id="l25.720"> function serverIsNntp(pageData) {</span>
<a href="#l25.721"></a><span id="l25.721">   if (pageData.accounttype.newsaccount)</span>
<a href="#l25.722"></a><span id="l25.722">     return pageData.accounttype.newsaccount.value;</span>
<a href="#l25.723"></a><span id="l25.723">   return false;</span>
<a href="#l25.724"></a><span id="l25.724"> }</span>
<a href="#l25.725"></a><span id="l25.725"> </span>
<a href="#l25.726"></a><span id="l25.726" class="difflineminus">-function getUsernameFromEmail(aEmail)</span>
<a href="#l25.727"></a><span id="l25.727" class="difflineminus">-{</span>
<a href="#l25.728"></a><span id="l25.728" class="difflineplus">+function getUsernameFromEmail(aEmail) {</span>
<a href="#l25.729"></a><span id="l25.729">   var username = aEmail.substr(0, aEmail.indexOf(&quot;@&quot;));</span>
<a href="#l25.730"></a><span id="l25.730">   return username;</span>
<a href="#l25.731"></a><span id="l25.731"> }</span>
<a href="#l25.732"></a><span id="l25.732"> </span>
<a href="#l25.733"></a><span id="l25.733" class="difflineminus">-function getCurrentUserName(pageData)</span>
<a href="#l25.734"></a><span id="l25.734" class="difflineminus">-{</span>
<a href="#l25.735"></a><span id="l25.735" class="difflineplus">+function getCurrentUserName(pageData) {</span>
<a href="#l25.736"></a><span id="l25.736">   var userName = &quot;&quot;;</span>
<a href="#l25.737"></a><span id="l25.737"> </span>
<a href="#l25.738"></a><span id="l25.738">   if (pageData.login) {</span>
<a href="#l25.739"></a><span id="l25.739">     if (pageData.login.username) {</span>
<a href="#l25.740"></a><span id="l25.740">       userName = pageData.login.username.value;</span>
<a href="#l25.741"></a><span id="l25.741">     }</span>
<a href="#l25.742"></a><span id="l25.742">   }</span>
<a href="#l25.743"></a><span id="l25.743">   if (userName == &quot;&quot;) {</span>
<a href="#l25.744"></a><span id="l25.744" class="difflineat">@@ -813,33 +767,30 @@ function getCurrentServerIsDeferred(page</span>
<a href="#l25.745"></a><span id="l25.745">     serverDeferred = pageData.server.deferStorage.value;</span>
<a href="#l25.746"></a><span id="l25.746"> </span>
<a href="#l25.747"></a><span id="l25.747">   return serverDeferred;</span>
<a href="#l25.748"></a><span id="l25.748"> }</span>
<a href="#l25.749"></a><span id="l25.749"> </span>
<a href="#l25.750"></a><span id="l25.750"> function getCurrentHostname(pageData) {</span>
<a href="#l25.751"></a><span id="l25.751">   if (serverIsNntp(pageData))</span>
<a href="#l25.752"></a><span id="l25.752">     return pageData.newsserver.hostname.value;</span>
<a href="#l25.753"></a><span id="l25.753" class="difflineminus">-  else</span>
<a href="#l25.754"></a><span id="l25.754" class="difflineminus">-    return pageData.server.hostname.value;</span>
<a href="#l25.755"></a><span id="l25.755" class="difflineplus">+  return pageData.server.hostname.value;</span>
<a href="#l25.756"></a><span id="l25.756"> }</span>
<a href="#l25.757"></a><span id="l25.757"> </span>
<a href="#l25.758"></a><span id="l25.758" class="difflineminus">-function GetPageData()</span>
<a href="#l25.759"></a><span id="l25.759" class="difflineminus">-{</span>
<a href="#l25.760"></a><span id="l25.760" class="difflineplus">+function GetPageData() {</span>
<a href="#l25.761"></a><span id="l25.761">   if (!gPageData)</span>
<a href="#l25.762"></a><span id="l25.762" class="difflineminus">-    gPageData = new Object;</span>
<a href="#l25.763"></a><span id="l25.763" class="difflineplus">+    gPageData = {};</span>
<a href="#l25.764"></a><span id="l25.764"> </span>
<a href="#l25.765"></a><span id="l25.765">   return gPageData;</span>
<a href="#l25.766"></a><span id="l25.766"> }</span>
<a href="#l25.767"></a><span id="l25.767"> </span>
<a href="#l25.768"></a><span id="l25.768"> // does any cleanup work for the the account data</span>
<a href="#l25.769"></a><span id="l25.769"> // - sets the username from the email address if it's not already set</span>
<a href="#l25.770"></a><span id="l25.770"> // - anything else?</span>
<a href="#l25.771"></a><span id="l25.771" class="difflineminus">-function FixupAccountDataForIsp(accountData)</span>
<a href="#l25.772"></a><span id="l25.772" class="difflineminus">-{</span>
<a href="#l25.773"></a><span id="l25.773" class="difflineplus">+function FixupAccountDataForIsp(accountData) {</span>
<a href="#l25.774"></a><span id="l25.774">   // no fixup for news</span>
<a href="#l25.775"></a><span id="l25.775">   // setting the username does bad things</span>
<a href="#l25.776"></a><span id="l25.776">   // see bugs #42105 and #154213</span>
<a href="#l25.777"></a><span id="l25.777">   if (accountData.incomingServer.type == &quot;nntp&quot;)</span>
<a href="#l25.778"></a><span id="l25.778">     return;</span>
<a href="#l25.779"></a><span id="l25.779"> </span>
<a href="#l25.780"></a><span id="l25.780">   var email = accountData.identity.email;</span>
<a href="#l25.781"></a><span id="l25.781"> </span>
<a href="#l25.782"></a><span id="l25.782" class="difflineat">@@ -868,18 +819,17 @@ function onFlush() {</span>
<a href="#l25.783"></a><span id="l25.783">   Services.prefs.setBoolPref(&quot;nglayout.debug.disable_xul_cache&quot;, true);</span>
<a href="#l25.784"></a><span id="l25.784">   Services.prefs.setBoolPref(&quot;nglayout.debug.disable_xul_cache&quot;, false);</span>
<a href="#l25.785"></a><span id="l25.785"> }</span>
<a href="#l25.786"></a><span id="l25.786"> </span>
<a href="#l25.787"></a><span id="l25.787"> /** If there are no default accounts..</span>
<a href="#l25.788"></a><span id="l25.788">   * this is will be the new default, so enable</span>
<a href="#l25.789"></a><span id="l25.789">   * check for mail at startup</span>
<a href="#l25.790"></a><span id="l25.790">   */</span>
<a href="#l25.791"></a><span id="l25.791" class="difflineminus">-function EnableCheckMailAtStartUpIfNeeded(newAccount)</span>
<a href="#l25.792"></a><span id="l25.792" class="difflineminus">-{</span>
<a href="#l25.793"></a><span id="l25.793" class="difflineplus">+function EnableCheckMailAtStartUpIfNeeded(newAccount) {</span>
<a href="#l25.794"></a><span id="l25.794">   // Check if default account existed.</span>
<a href="#l25.795"></a><span id="l25.795">   // If no such account, make this one the default account</span>
<a href="#l25.796"></a><span id="l25.796">   // and turn on the new mail check at startup for the current account</span>
<a href="#l25.797"></a><span id="l25.797">   if (!gDefaultAccount) {</span>
<a href="#l25.798"></a><span id="l25.798">     MailServices.accounts.defaultAccount = newAccount;</span>
<a href="#l25.799"></a><span id="l25.799">     newAccount.incomingServer.loginAtStartUp = true;</span>
<a href="#l25.800"></a><span id="l25.800">     newAccount.incomingServer.downloadOnBiff = true;</span>
<a href="#l25.801"></a><span id="l25.801">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/base/prefs/content/AccountWizard.xul</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/base/prefs/content/AccountWizard.xul</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -21,17 +21,16 @@</span>
<a href="#l26.4"></a><span id="l26.4">         style=&quot;&amp;accountWizard.size;&quot;</span>
<a href="#l26.5"></a><span id="l26.5">         xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7">   &lt;stringbundle id=&quot;bundle_prefs&quot; src=&quot;chrome://messenger/locale/prefs.properties&quot;/&gt;</span>
<a href="#l26.8"></a><span id="l26.8">   &lt;stringbundle id=&quot;bundle_messenger&quot; src=&quot;chrome://messenger/locale/messenger.properties&quot;/&gt;</span>
<a href="#l26.9"></a><span id="l26.9">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/accountUtils.js&quot;/&gt;</span>
<a href="#l26.10"></a><span id="l26.10">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/amUtils.js&quot;/&gt;</span>
<a href="#l26.11"></a><span id="l26.11">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/AccountWizard.js&quot;/&gt;</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/ispUtils.js&quot;/&gt;</span>
<a href="#l26.13"></a><span id="l26.13">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/aw-accounttype.js&quot;/&gt;</span>
<a href="#l26.14"></a><span id="l26.14">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/aw-identity.js&quot;/&gt;</span>
<a href="#l26.15"></a><span id="l26.15">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/aw-incoming.js&quot;/&gt;</span>
<a href="#l26.16"></a><span id="l26.16">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/aw-outgoing.js&quot;/&gt;</span>
<a href="#l26.17"></a><span id="l26.17">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/aw-accname.js&quot;/&gt;</span>
<a href="#l26.18"></a><span id="l26.18">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/aw-done.js&quot;/&gt;</span>
<a href="#l26.19"></a><span id="l26.19"> </span>
<a href="#l26.20"></a><span id="l26.20">   &lt;!-- Account Type page : Displays choices of mail and news accounts that user can create --&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/base/prefs/content/SmtpServerEdit.js</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/base/prefs/content/SmtpServerEdit.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -15,24 +15,22 @@ var gSmtpHostname;</span>
<a href="#l27.4"></a><span id="l27.4"> var gSmtpPort;</span>
<a href="#l27.5"></a><span id="l27.5"> var gSmtpAuthMethod;</span>
<a href="#l27.6"></a><span id="l27.6"> var gSmtpSocketType;</span>
<a href="#l27.7"></a><span id="l27.7"> var gPort;</span>
<a href="#l27.8"></a><span id="l27.8"> var gDefaultPort;</span>
<a href="#l27.9"></a><span id="l27.9"> </span>
<a href="#l27.10"></a><span id="l27.10"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l27.11"></a><span id="l27.11"> </span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-function onLoad(event)</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineminus">-{</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+function onLoad(event) {</span>
<a href="#l27.15"></a><span id="l27.15">   gSmtpServer = window.arguments[0].server;</span>
<a href="#l27.16"></a><span id="l27.16">   initSmtpSettings(gSmtpServer);</span>
<a href="#l27.17"></a><span id="l27.17"> }</span>
<a href="#l27.18"></a><span id="l27.18"> </span>
<a href="#l27.19"></a><span id="l27.19" class="difflineminus">-function onAccept(event)</span>
<a href="#l27.20"></a><span id="l27.20" class="difflineminus">-{</span>
<a href="#l27.21"></a><span id="l27.21" class="difflineplus">+function onAccept(event) {</span>
<a href="#l27.22"></a><span id="l27.22">   if (!isLegalHostNameOrIP(cleanUpHostName(gSmtpHostname.value))) {</span>
<a href="#l27.23"></a><span id="l27.23">     let prefsBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l27.24"></a><span id="l27.24">     let brandBundle = document.getElementById(&quot;bundle_brand&quot;);</span>
<a href="#l27.25"></a><span id="l27.25">     let alertTitle = brandBundle.getString(&quot;brandShortName&quot;);</span>
<a href="#l27.26"></a><span id="l27.26">     let alertMsg = prefsBundle.getString(&quot;enterValidServerName&quot;);</span>
<a href="#l27.27"></a><span id="l27.27">     Services.prompt.alert(window, alertTitle, alertMsg);</span>
<a href="#l27.28"></a><span id="l27.28"> </span>
<a href="#l27.29"></a><span id="l27.29">     window.arguments[0].result = false;</span>
<a href="#l27.30"></a><span id="l27.30" class="difflineat">@@ -106,92 +104,85 @@ function initSmtpSettings(server) {</span>
<a href="#l27.31"></a><span id="l27.31">     hideUnlessSelected(document.getElementById(&quot;authMethod-any&quot;));</span>
<a href="#l27.32"></a><span id="l27.32"> </span>
<a href="#l27.33"></a><span id="l27.33">     // &quot;STARTTLS, if available&quot; is vulnerable to MITM attacks so we shouldn't</span>
<a href="#l27.34"></a><span id="l27.34">     // allow users to choose it anymore. Hide the option unless the user already</span>
<a href="#l27.35"></a><span id="l27.35">     // has it set.</span>
<a href="#l27.36"></a><span id="l27.36">     hideUnlessSelected(document.getElementById(&quot;connectionSecurityType-1&quot;));</span>
<a href="#l27.37"></a><span id="l27.37"> }</span>
<a href="#l27.38"></a><span id="l27.38"> </span>
<a href="#l27.39"></a><span id="l27.39" class="difflineminus">-function hideUnlessSelected(element)</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineminus">-{</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineplus">+function hideUnlessSelected(element) {</span>
<a href="#l27.42"></a><span id="l27.42">   element.hidden = !element.selected;</span>
<a href="#l27.43"></a><span id="l27.43"> }</span>
<a href="#l27.44"></a><span id="l27.44"> </span>
<a href="#l27.45"></a><span id="l27.45" class="difflineminus">-function setLabelFromStringBundle(elementID, stringName)</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineminus">-{</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineplus">+function setLabelFromStringBundle(elementID, stringName) {</span>
<a href="#l27.48"></a><span id="l27.48">   document.getElementById(elementID).label =</span>
<a href="#l27.49"></a><span id="l27.49">     document.getElementById(&quot;bundle_messenger&quot;).getString(stringName);</span>
<a href="#l27.50"></a><span id="l27.50"> }</span>
<a href="#l27.51"></a><span id="l27.51"> </span>
<a href="#l27.52"></a><span id="l27.52"> // Disables xul elements that have associated preferences locked.</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineminus">-function onLockPreference()</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineminus">-{</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineplus">+function onLockPreference() {</span>
<a href="#l27.56"></a><span id="l27.56">   try {</span>
<a href="#l27.57"></a><span id="l27.57">     let allPrefElements = {</span>
<a href="#l27.58"></a><span id="l27.58">       hostname:     gSmtpHostname,</span>
<a href="#l27.59"></a><span id="l27.59">       description:  gSmtpDescription,</span>
<a href="#l27.60"></a><span id="l27.60">       port:         gSmtpPort,</span>
<a href="#l27.61"></a><span id="l27.61">       authMethod:   gSmtpAuthMethod,</span>
<a href="#l27.62"></a><span id="l27.62" class="difflineminus">-      try_ssl:      gSmtpSocketType</span>
<a href="#l27.63"></a><span id="l27.63" class="difflineplus">+      try_ssl:      gSmtpSocketType,</span>
<a href="#l27.64"></a><span id="l27.64">     };</span>
<a href="#l27.65"></a><span id="l27.65">     disableIfLocked(allPrefElements);</span>
<a href="#l27.66"></a><span id="l27.66">   } catch (e) { // non-fatal</span>
<a href="#l27.67"></a><span id="l27.67">     Cu.reportError(&quot;Error while getting locked prefs: &quot; + e);</span>
<a href="#l27.68"></a><span id="l27.68">   }</span>
<a href="#l27.69"></a><span id="l27.69"> }</span>
<a href="#l27.70"></a><span id="l27.70"> </span>
<a href="#l27.71"></a><span id="l27.71"> /**</span>
<a href="#l27.72"></a><span id="l27.72">  * Does the work of disabling an element given the array which contains xul id/prefstring pairs.</span>
<a href="#l27.73"></a><span id="l27.73">  *</span>
<a href="#l27.74"></a><span id="l27.74">  * @param prefstrArray  array of XUL elements to check</span>
<a href="#l27.75"></a><span id="l27.75">  *</span>
<a href="#l27.76"></a><span id="l27.76">  * TODO: try to merge this with disableIfLocked function in am-offline.js (bug 755885)</span>
<a href="#l27.77"></a><span id="l27.77">  */</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineminus">-function disableIfLocked(prefstrArray)</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineminus">-{</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineplus">+function disableIfLocked(prefstrArray) {</span>
<a href="#l27.81"></a><span id="l27.81">   let finalPrefString = &quot;mail.smtpserver.&quot; +</span>
<a href="#l27.82"></a><span id="l27.82">     MailServices.smtp.defaultServer.key + &quot;.&quot;;</span>
<a href="#l27.83"></a><span id="l27.83">   let smtpPrefBranch = Services.prefs.getBranch(finalPrefString);</span>
<a href="#l27.84"></a><span id="l27.84"> </span>
<a href="#l27.85"></a><span id="l27.85">   for (let prefstring in prefstrArray)</span>
<a href="#l27.86"></a><span id="l27.86">     if (smtpPrefBranch.prefIsLocked(prefstring))</span>
<a href="#l27.87"></a><span id="l27.87">       prefstrArray[prefstring].disabled = true;</span>
<a href="#l27.88"></a><span id="l27.88"> }</span>
<a href="#l27.89"></a><span id="l27.89"> </span>
<a href="#l27.90"></a><span id="l27.90" class="difflineminus">-function saveSmtpSettings(server)</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineminus">-{</span>
<a href="#l27.92"></a><span id="l27.92" class="difflineminus">-    //dump(&quot;Saving to &quot; + server + &quot;\n&quot;);</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineplus">+function saveSmtpSettings(server) {</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineplus">+    // dump(&quot;Saving to &quot; + server + &quot;\n&quot;);</span>
<a href="#l27.95"></a><span id="l27.95">     if (server) {</span>
<a href="#l27.96"></a><span id="l27.96">         server.hostname = cleanUpHostName(gSmtpHostname.value);</span>
<a href="#l27.97"></a><span id="l27.97">         server.description = gSmtpDescription.value;</span>
<a href="#l27.98"></a><span id="l27.98">         server.port = gSmtpPort.value;</span>
<a href="#l27.99"></a><span id="l27.99">         server.authMethod = gSmtpAuthMethod.value;</span>
<a href="#l27.100"></a><span id="l27.100">         server.username = gSmtpUsername.value;</span>
<a href="#l27.101"></a><span id="l27.101">         server.socketType = gSmtpSocketType.value;</span>
<a href="#l27.102"></a><span id="l27.102">     }</span>
<a href="#l27.103"></a><span id="l27.103"> }</span>
<a href="#l27.104"></a><span id="l27.104"> </span>
<a href="#l27.105"></a><span id="l27.105" class="difflineminus">-function authMethodChanged(userAction)</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineminus">-{</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineplus">+function authMethodChanged(userAction) {</span>
<a href="#l27.108"></a><span id="l27.108">   var noUsername = gSmtpAuthMethod.value == Ci.nsMsgAuthMethod.none;</span>
<a href="#l27.109"></a><span id="l27.109">   gSmtpUsername.disabled = noUsername;</span>
<a href="#l27.110"></a><span id="l27.110">   gSmtpUsernameLabel.disabled = noUsername;</span>
<a href="#l27.111"></a><span id="l27.111"> }</span>
<a href="#l27.112"></a><span id="l27.112"> </span>
<a href="#l27.113"></a><span id="l27.113"> /**</span>
<a href="#l27.114"></a><span id="l27.114">  * Resets the default port to SMTP or SMTPS, dependending on</span>
<a href="#l27.115"></a><span id="l27.115">  * the |gSmtpSocketType| value, and sets the port to use to this default,</span>
<a href="#l27.116"></a><span id="l27.116">  * if that's appropriate.</span>
<a href="#l27.117"></a><span id="l27.117">  *</span>
<a href="#l27.118"></a><span id="l27.118">  * @param userAction  false for dialog initialization,</span>
<a href="#l27.119"></a><span id="l27.119">  *                    true for user action.</span>
<a href="#l27.120"></a><span id="l27.120">  */</span>
<a href="#l27.121"></a><span id="l27.121" class="difflineminus">-function sslChanged(userAction)</span>
<a href="#l27.122"></a><span id="l27.122" class="difflineminus">-{</span>
<a href="#l27.123"></a><span id="l27.123" class="difflineplus">+function sslChanged(userAction) {</span>
<a href="#l27.124"></a><span id="l27.124">   const DEFAULT_SMTP_PORT = &quot;587&quot;;</span>
<a href="#l27.125"></a><span id="l27.125">   const DEFAULT_SMTPS_PORT = &quot;465&quot;;</span>
<a href="#l27.126"></a><span id="l27.126">   var socketType = gSmtpSocketType.value;</span>
<a href="#l27.127"></a><span id="l27.127">   var otherDefaultPort;</span>
<a href="#l27.128"></a><span id="l27.128">   var prevDefaultPort = gDefaultPort.value;</span>
<a href="#l27.129"></a><span id="l27.129"> </span>
<a href="#l27.130"></a><span id="l27.130">   if (socketType == Ci.nsMsgSocketType.SSL) {</span>
<a href="#l27.131"></a><span id="l27.131">     gDefaultPort.value = DEFAULT_SMTPS_PORT;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountUtils.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountUtils.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -1,26 +1,29 @@</span>
<a href="#l28.4"></a><span id="l28.4"> /* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l28.5"></a><span id="l28.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l28.6"></a><span id="l28.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l28.7"></a><span id="l28.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l28.8"></a><span id="l28.8"> </span>
<a href="#l28.9"></a><span id="l28.9" class="difflineplus">+/* import-globals-from AccountManager.js */</span>
<a href="#l28.10"></a><span id="l28.10" class="difflineplus">+/* globals SelectFolder */// From messageWindow.js or msgMail3PaneWindow.js.</span>
<a href="#l28.11"></a><span id="l28.11" class="difflineplus">+/* globals MsgGetMessage */// From mailWindowOverlay.js.</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+</span>
<a href="#l28.13"></a><span id="l28.13"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l28.14"></a><span id="l28.14"> var {AppConstants} = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l28.15"></a><span id="l28.15"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l28.16"></a><span id="l28.16"> </span>
<a href="#l28.17"></a><span id="l28.17" class="difflineminus">-var gAnyValidIdentity = false; //If there are no valid identities for any account</span>
<a href="#l28.18"></a><span id="l28.18" class="difflineplus">+var gAnyValidIdentity = false; // If there are no valid identities for any account</span>
<a href="#l28.19"></a><span id="l28.19"> // returns the first account with an invalid server or identity</span>
<a href="#l28.20"></a><span id="l28.20"> </span>
<a href="#l28.21"></a><span id="l28.21"> var gNewAccountToLoad = null;   // used to load new messages if we come from the mail3pane</span>
<a href="#l28.22"></a><span id="l28.22"> </span>
<a href="#l28.23"></a><span id="l28.23" class="difflineminus">-function getInvalidAccounts(accounts)</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineminus">-{</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+function getInvalidAccounts(accounts) {</span>
<a href="#l28.26"></a><span id="l28.26">     let numAccounts = accounts.length;</span>
<a href="#l28.27"></a><span id="l28.27" class="difflineminus">-    let invalidAccounts = new Array;</span>
<a href="#l28.28"></a><span id="l28.28" class="difflineplus">+    let invalidAccounts = [];</span>
<a href="#l28.29"></a><span id="l28.29">     let numIdentities = 0;</span>
<a href="#l28.30"></a><span id="l28.30">     for (let i = 0; i &lt; numAccounts; i++) {</span>
<a href="#l28.31"></a><span id="l28.31">         let account = accounts.queryElementAt(i, Ci.nsIMsgAccount);</span>
<a href="#l28.32"></a><span id="l28.32">         try {</span>
<a href="#l28.33"></a><span id="l28.33">             if (!account.incomingServer.valid) {</span>
<a href="#l28.34"></a><span id="l28.34">                 invalidAccounts[invalidAccounts.length] = account;</span>
<a href="#l28.35"></a><span id="l28.35">                 // skip to the next account</span>
<a href="#l28.36"></a><span id="l28.36">                 continue;</span>
<a href="#l28.37"></a><span id="l28.37" class="difflineat">@@ -32,18 +35,17 @@ function getInvalidAccounts(accounts)</span>
<a href="#l28.38"></a><span id="l28.38"> </span>
<a href="#l28.39"></a><span id="l28.39">         var identities = account.identities;</span>
<a href="#l28.40"></a><span id="l28.40">         numIdentities = identities.length;</span>
<a href="#l28.41"></a><span id="l28.41"> </span>
<a href="#l28.42"></a><span id="l28.42">         for (var j = 0; j &lt; numIdentities; j++) {</span>
<a href="#l28.43"></a><span id="l28.43">             let identity = identities.queryElementAt(j, Ci.nsIMsgIdentity);</span>
<a href="#l28.44"></a><span id="l28.44">             if (identity.valid) {</span>
<a href="#l28.45"></a><span id="l28.45">               gAnyValidIdentity = true;</span>
<a href="#l28.46"></a><span id="l28.46" class="difflineminus">-            }</span>
<a href="#l28.47"></a><span id="l28.47" class="difflineminus">-            else {</span>
<a href="#l28.48"></a><span id="l28.48" class="difflineplus">+            } else {</span>
<a href="#l28.49"></a><span id="l28.49">               invalidAccounts[invalidAccounts.length] = account;</span>
<a href="#l28.50"></a><span id="l28.50">             }</span>
<a href="#l28.51"></a><span id="l28.51">         }</span>
<a href="#l28.52"></a><span id="l28.52">     }</span>
<a href="#l28.53"></a><span id="l28.53">     return invalidAccounts;</span>
<a href="#l28.54"></a><span id="l28.54"> }</span>
<a href="#l28.55"></a><span id="l28.55"> </span>
<a href="#l28.56"></a><span id="l28.56"> function showMailIntegrationDialog() {</span>
<a href="#l28.57"></a><span id="l28.57" class="difflineat">@@ -73,21 +75,19 @@ function showMailIntegrationDialog() {</span>
<a href="#l28.58"></a><span id="l28.58">  *                      compose window. This last condition is so that we open</span>
<a href="#l28.59"></a><span id="l28.59">  *                      the account wizard if the user does not have any</span>
<a href="#l28.60"></a><span id="l28.60">  *                      identities defined and tries to compose mail.</span>
<a href="#l28.61"></a><span id="l28.61">  * @param wizardOpen optional param that allows the caller to specify a</span>
<a href="#l28.62"></a><span id="l28.62">  *                   different method to open a wizard. The wizardOpen method</span>
<a href="#l28.63"></a><span id="l28.63">  *                   takes wizardCallback as an argument. The wizardCallback</span>
<a href="#l28.64"></a><span id="l28.64">  *                   doesn't take any arguments.</span>
<a href="#l28.65"></a><span id="l28.65">  */</span>
<a href="#l28.66"></a><span id="l28.66" class="difflineminus">-function verifyAccounts(wizardCallback, needsIdentity, wizardOpen)</span>
<a href="#l28.67"></a><span id="l28.67" class="difflineminus">-{</span>
<a href="#l28.68"></a><span id="l28.68" class="difflineplus">+function verifyAccounts(wizardCallback, needsIdentity, wizardOpen) {</span>
<a href="#l28.69"></a><span id="l28.69">   var openWizard = false;</span>
<a href="#l28.70"></a><span id="l28.70">   var prefillAccount;</span>
<a href="#l28.71"></a><span id="l28.71" class="difflineminus">-  var state=true;</span>
<a href="#l28.72"></a><span id="l28.72">   var ret = true;</span>
<a href="#l28.73"></a><span id="l28.73"> </span>
<a href="#l28.74"></a><span id="l28.74">     try {</span>
<a href="#l28.75"></a><span id="l28.75">         // migrate quoting preferences from global to per account. This function returns</span>
<a href="#l28.76"></a><span id="l28.76">         // true if it had to migrate, which we will use to mean this is a just migrated</span>
<a href="#l28.77"></a><span id="l28.77">         // or new profile</span>
<a href="#l28.78"></a><span id="l28.78">         var newProfile = migrateGlobalQuotingPrefs(MailServices.accounts.allIdentities);</span>
<a href="#l28.79"></a><span id="l28.79"> </span>
<a href="#l28.80"></a><span id="l28.80" class="difflineat">@@ -101,95 +101,80 @@ function verifyAccounts(wizardCallback, </span>
<a href="#l28.81"></a><span id="l28.81">         }</span>
<a href="#l28.82"></a><span id="l28.82"> </span>
<a href="#l28.83"></a><span id="l28.83">         // if there are no accounts, or all accounts are &quot;invalid&quot;</span>
<a href="#l28.84"></a><span id="l28.84">         // then kick off the account migration. Or if this is a new (to Mozilla) profile.</span>
<a href="#l28.85"></a><span id="l28.85">         // MCD can set up accounts without the profile being used yet</span>
<a href="#l28.86"></a><span id="l28.86">         if (newProfile) {</span>
<a href="#l28.87"></a><span id="l28.87">           // check if MCD is configured. If not, say this is not a new profile</span>
<a href="#l28.88"></a><span id="l28.88">           // so that we don't accidentally remigrate non MCD profiles.</span>
<a href="#l28.89"></a><span id="l28.89" class="difflineminus">-          var adminUrl;</span>
<a href="#l28.90"></a><span id="l28.90" class="difflineminus">-          try {</span>
<a href="#l28.91"></a><span id="l28.91" class="difflineminus">-            adminUrl = Services.prefs.getCharPref(&quot;autoadmin.global_config_url&quot;);</span>
<a href="#l28.92"></a><span id="l28.92" class="difflineminus">-          }</span>
<a href="#l28.93"></a><span id="l28.93" class="difflineminus">-          catch (ex) {}</span>
<a href="#l28.94"></a><span id="l28.94" class="difflineplus">+          var adminUrl = Services.prefs.getCharPref(&quot;autoadmin.global_config_url&quot;, &quot;&quot;);</span>
<a href="#l28.95"></a><span id="l28.95">           if (!adminUrl)</span>
<a href="#l28.96"></a><span id="l28.96">             newProfile = false;</span>
<a href="#l28.97"></a><span id="l28.97">         }</span>
<a href="#l28.98"></a><span id="l28.98" class="difflineminus">-        if ((newProfile  &amp;&amp; !accountCount) || accountCount == invalidAccounts.length)</span>
<a href="#l28.99"></a><span id="l28.99" class="difflineplus">+        if ((newProfile &amp;&amp; !accountCount) || accountCount == invalidAccounts.length)</span>
<a href="#l28.100"></a><span id="l28.100">           openWizard = true;</span>
<a href="#l28.101"></a><span id="l28.101"> </span>
<a href="#l28.102"></a><span id="l28.102">         // openWizard is true if messenger migration returns some kind of</span>
<a href="#l28.103"></a><span id="l28.103">         // error (including those cases where there is nothing to migrate).</span>
<a href="#l28.104"></a><span id="l28.104">         // prefillAccount is non-null if there is at least one invalid account.</span>
<a href="#l28.105"></a><span id="l28.105">         // gAnyValidIdentity is true when you've got at least one *valid*</span>
<a href="#l28.106"></a><span id="l28.106">         // identity. Since local and RSS folders are identity-less accounts, if you</span>
<a href="#l28.107"></a><span id="l28.107">         // only have one of those, it will be false.</span>
<a href="#l28.108"></a><span id="l28.108">         // needsIdentity is true only when verifyAccounts is called from the</span>
<a href="#l28.109"></a><span id="l28.109">         // compose window. This last condition is so that we open the account</span>
<a href="#l28.110"></a><span id="l28.110">         // wizard if the user does not have any identities defined and tries to</span>
<a href="#l28.111"></a><span id="l28.111">         // compose mail.</span>
<a href="#l28.112"></a><span id="l28.112"> </span>
<a href="#l28.113"></a><span id="l28.113" class="difflineminus">-        if (openWizard || prefillAccount || ((!gAnyValidIdentity) &amp;&amp; needsIdentity))</span>
<a href="#l28.114"></a><span id="l28.114" class="difflineminus">-        {</span>
<a href="#l28.115"></a><span id="l28.115" class="difflineplus">+        if (openWizard || prefillAccount || ((!gAnyValidIdentity) &amp;&amp; needsIdentity)) {</span>
<a href="#l28.116"></a><span id="l28.116">           if (wizardOpen != undefined)</span>
<a href="#l28.117"></a><span id="l28.117" class="difflineminus">-            wizardOpen(wizardCallback)</span>
<a href="#l28.118"></a><span id="l28.118" class="difflineplus">+            wizardOpen(wizardCallback);</span>
<a href="#l28.119"></a><span id="l28.119">           else</span>
<a href="#l28.120"></a><span id="l28.120">             MsgAccountWizard(wizardCallback);</span>
<a href="#l28.121"></a><span id="l28.121">           ret = false;</span>
<a href="#l28.122"></a><span id="l28.122" class="difflineminus">-        }</span>
<a href="#l28.123"></a><span id="l28.123" class="difflineminus">-        else</span>
<a href="#l28.124"></a><span id="l28.124" class="difflineminus">-        {</span>
<a href="#l28.125"></a><span id="l28.125" class="difflineplus">+        } else {</span>
<a href="#l28.126"></a><span id="l28.126">           var localFoldersExists;</span>
<a href="#l28.127"></a><span id="l28.127" class="difflineminus">-          try</span>
<a href="#l28.128"></a><span id="l28.128" class="difflineminus">-          {</span>
<a href="#l28.129"></a><span id="l28.129" class="difflineplus">+          try {</span>
<a href="#l28.130"></a><span id="l28.130">             localFoldersExists = MailServices.accounts.localFoldersServer;</span>
<a href="#l28.131"></a><span id="l28.131" class="difflineminus">-          }</span>
<a href="#l28.132"></a><span id="l28.132" class="difflineminus">-          catch (ex)</span>
<a href="#l28.133"></a><span id="l28.133" class="difflineminus">-          {</span>
<a href="#l28.134"></a><span id="l28.134" class="difflineplus">+          } catch (ex) {</span>
<a href="#l28.135"></a><span id="l28.135">             localFoldersExists = false;</span>
<a href="#l28.136"></a><span id="l28.136">           }</span>
<a href="#l28.137"></a><span id="l28.137"> </span>
<a href="#l28.138"></a><span id="l28.138">           // we didn't create the MsgAccountWizard - we need to verify that local folders exists.</span>
<a href="#l28.139"></a><span id="l28.139">           if (!localFoldersExists)</span>
<a href="#l28.140"></a><span id="l28.140">             MailServices.accounts.createLocalMailAccount();</span>
<a href="#l28.141"></a><span id="l28.141">         }</span>
<a href="#l28.142"></a><span id="l28.142"> </span>
<a href="#l28.143"></a><span id="l28.143">         // This will do nothing on platforms without a shell service</span>
<a href="#l28.144"></a><span id="l28.144" class="difflineminus">-        const NS_SHELLSERVICE_CID = &quot;@mozilla.org/suite/shell-service;1&quot;</span>
<a href="#l28.145"></a><span id="l28.145" class="difflineminus">-        if (NS_SHELLSERVICE_CID in Cc)</span>
<a href="#l28.146"></a><span id="l28.146" class="difflineminus">-        {</span>
<a href="#l28.147"></a><span id="l28.147" class="difflineplus">+        if (&quot;@mozilla.org/suite/shell-service;1&quot; in Cc) {</span>
<a href="#l28.148"></a><span id="l28.148">           // hack, set a time out to do this, so that the window can load first</span>
<a href="#l28.149"></a><span id="l28.149">           setTimeout(showMailIntegrationDialog, 0);</span>
<a href="#l28.150"></a><span id="l28.150">         }</span>
<a href="#l28.151"></a><span id="l28.151">         return ret;</span>
<a href="#l28.152"></a><span id="l28.152" class="difflineminus">-    }</span>
<a href="#l28.153"></a><span id="l28.153" class="difflineminus">-    catch (ex) {</span>
<a href="#l28.154"></a><span id="l28.154" class="difflineplus">+    } catch (ex) {</span>
<a href="#l28.155"></a><span id="l28.155">         dump(&quot;error verifying accounts &quot; + ex + &quot;\n&quot;);</span>
<a href="#l28.156"></a><span id="l28.156">         return false;</span>
<a href="#l28.157"></a><span id="l28.157">     }</span>
<a href="#l28.158"></a><span id="l28.158"> }</span>
<a href="#l28.159"></a><span id="l28.159"> </span>
<a href="#l28.160"></a><span id="l28.160"> // we do this from a timer because if this is called from the onload=</span>
<a href="#l28.161"></a><span id="l28.161"> // handler, then the parent window doesn't appear until after the wizard</span>
<a href="#l28.162"></a><span id="l28.162"> // has closed, and this is confusing to the user</span>
<a href="#l28.163"></a><span id="l28.163" class="difflineminus">-function MsgAccountWizard(wizardCallback)</span>
<a href="#l28.164"></a><span id="l28.164" class="difflineminus">-{</span>
<a href="#l28.165"></a><span id="l28.165" class="difflineplus">+function MsgAccountWizard(wizardCallback) {</span>
<a href="#l28.166"></a><span id="l28.166">   setTimeout(function() { msgOpenAccountWizard(wizardCallback); }, 0);</span>
<a href="#l28.167"></a><span id="l28.167"> }</span>
<a href="#l28.168"></a><span id="l28.168"> </span>
<a href="#l28.169"></a><span id="l28.169"> /**</span>
<a href="#l28.170"></a><span id="l28.170">  * Open the Old Mail Account Wizard, or focus it if it's already open.</span>
<a href="#l28.171"></a><span id="l28.171">  *</span>
<a href="#l28.172"></a><span id="l28.172">  * @param wizardCallback if the wizard is run, callback when it is done.</span>
<a href="#l28.173"></a><span id="l28.173">  * @param type - optional account type token, for Tb.</span>
<a href="#l28.174"></a><span id="l28.174">  * @see msgNewMailAccount below for the new implementation.</span>
<a href="#l28.175"></a><span id="l28.175">  */</span>
<a href="#l28.176"></a><span id="l28.176" class="difflineminus">-function msgOpenAccountWizard(wizardCallback, type)</span>
<a href="#l28.177"></a><span id="l28.177" class="difflineminus">-{</span>
<a href="#l28.178"></a><span id="l28.178" class="difflineplus">+function msgOpenAccountWizard(wizardCallback, type) {</span>
<a href="#l28.179"></a><span id="l28.179">   gNewAccountToLoad = null;</span>
<a href="#l28.180"></a><span id="l28.180"> </span>
<a href="#l28.181"></a><span id="l28.181">   window.openDialog(&quot;chrome://messenger/content/AccountWizard.xul&quot;, &quot;AccountWizard&quot;,</span>
<a href="#l28.182"></a><span id="l28.182">                     &quot;chrome,modal,titlebar,centerscreen&quot;,</span>
<a href="#l28.183"></a><span id="l28.183">                     {okCallback: wizardCallback, acctType: type});</span>
<a href="#l28.184"></a><span id="l28.184"> </span>
<a href="#l28.185"></a><span id="l28.185">   loadInboxForNewAccount();</span>
<a href="#l28.186"></a><span id="l28.186"> </span>
<a href="#l28.187"></a><span id="l28.187" class="difflineat">@@ -198,29 +183,33 @@ function msgOpenAccountWizard(wizardCall</span>
<a href="#l28.188"></a><span id="l28.188">   // TODO Better fix: select newly created account (in all cases)</span>
<a href="#l28.189"></a><span id="l28.189">   if (typeof(getCurrentAccount) == &quot;function&quot; &amp;&amp; // in AccountManager, not menu</span>
<a href="#l28.190"></a><span id="l28.190">       !getCurrentAccount())</span>
<a href="#l28.191"></a><span id="l28.191">     selectServer(null, null);</span>
<a href="#l28.192"></a><span id="l28.192"> }</span>
<a href="#l28.193"></a><span id="l28.193"> </span>
<a href="#l28.194"></a><span id="l28.194"> function initAccountWizardTB(args) {</span>
<a href="#l28.195"></a><span id="l28.195">   let type = args[0] &amp;&amp; args[0].acctType;</span>
<a href="#l28.196"></a><span id="l28.196" class="difflineminus">-  let selType = type == &quot;newsgroups&quot; ? &quot;newsaccount&quot; :</span>
<a href="#l28.197"></a><span id="l28.197" class="difflineminus">-                type == &quot;movemail&quot; ? &quot;movemail&quot; : null;</span>
<a href="#l28.198"></a><span id="l28.198" class="difflineplus">+  let selType = null;</span>
<a href="#l28.199"></a><span id="l28.199" class="difflineplus">+  if (type == &quot;newsgroups&quot;) {</span>
<a href="#l28.200"></a><span id="l28.200" class="difflineplus">+    selType = &quot;newsaccount&quot;;</span>
<a href="#l28.201"></a><span id="l28.201" class="difflineplus">+  } else if (type == &quot;movemail&quot;) {</span>
<a href="#l28.202"></a><span id="l28.202" class="difflineplus">+    selType = &quot;Movemail&quot;;</span>
<a href="#l28.203"></a><span id="l28.203" class="difflineplus">+  }</span>
<a href="#l28.204"></a><span id="l28.204">   let accountwizard = document.getElementById(&quot;AccountWizard&quot;);</span>
<a href="#l28.205"></a><span id="l28.205">   let acctyperadio = document.getElementById(&quot;acctyperadio&quot;);</span>
<a href="#l28.206"></a><span id="l28.206">   let feedRadio = acctyperadio.querySelector(&quot;radio[value='Feeds']&quot;);</span>
<a href="#l28.207"></a><span id="l28.207">   if (feedRadio)</span>
<a href="#l28.208"></a><span id="l28.208">     feedRadio.remove();</span>
<a href="#l28.209"></a><span id="l28.209">   if (selType) {</span>
<a href="#l28.210"></a><span id="l28.210" class="difflineminus">-    acctyperadio.selectedItem = acctyperadio.querySelector(&quot;radio[value='&quot;+selType+&quot;']&quot;);</span>
<a href="#l28.211"></a><span id="l28.211" class="difflineplus">+    acctyperadio.selectedItem = acctyperadio.querySelector(&quot;radio[value='&quot; + selType + &quot;']&quot;);</span>
<a href="#l28.212"></a><span id="l28.212">     accountwizard.advance(&quot;identitypage&quot;);</span>
<a href="#l28.213"></a><span id="l28.213" class="difflineplus">+  } else {</span>
<a href="#l28.214"></a><span id="l28.214" class="difflineplus">+    acctyperadio.selectedItem = acctyperadio.getItemAtIndex(0);</span>
<a href="#l28.215"></a><span id="l28.215">   }</span>
<a href="#l28.216"></a><span id="l28.216" class="difflineminus">-  else</span>
<a href="#l28.217"></a><span id="l28.217" class="difflineminus">-    acctyperadio.selectedItem = acctyperadio.getItemAtIndex(0);</span>
<a href="#l28.218"></a><span id="l28.218"> }</span>
<a href="#l28.219"></a><span id="l28.219"> </span>
<a href="#l28.220"></a><span id="l28.220"> function AddFeedAccount() {</span>
<a href="#l28.221"></a><span id="l28.221">   window.openDialog(&quot;chrome://messenger-newsblog/content/feedAccountWizard.xul&quot;,</span>
<a href="#l28.222"></a><span id="l28.222">                     &quot;&quot;, &quot;chrome,modal,titlebar,centerscreen&quot;);</span>
<a href="#l28.223"></a><span id="l28.223"> }</span>
<a href="#l28.224"></a><span id="l28.224"> </span>
<a href="#l28.225"></a><span id="l28.225"> /**</span>
<a href="#l28.226"></a><span id="l28.226" class="difflineat">@@ -228,72 +217,66 @@ function AddFeedAccount() {</span>
<a href="#l28.227"></a><span id="l28.227">  * and page of settings. If the window is already open it is only focused.</span>
<a href="#l28.228"></a><span id="l28.228">  *</span>
<a href="#l28.229"></a><span id="l28.229">  * @param selectPage  The xul file name for the viewing page or</span>
<a href="#l28.230"></a><span id="l28.230">  *                    null for the account main page. Other pages are</span>
<a href="#l28.231"></a><span id="l28.231">  *                    'am-server.xul', 'am-copies.xul', 'am-offline.xul',</span>
<a href="#l28.232"></a><span id="l28.232">  *                    'am-addressing.xul', 'am-smtp.xul'</span>
<a href="#l28.233"></a><span id="l28.233">  * @param  aServer    The server of the account to select. Optional.</span>
<a href="#l28.234"></a><span id="l28.234">  */</span>
<a href="#l28.235"></a><span id="l28.235" class="difflineminus">-function MsgAccountManager(selectPage, aServer)</span>
<a href="#l28.236"></a><span id="l28.236" class="difflineminus">-{</span>
<a href="#l28.237"></a><span id="l28.237" class="difflineplus">+function MsgAccountManager(selectPage, aServer) {</span>
<a href="#l28.238"></a><span id="l28.238">     var existingAccountManager = Services.wm.getMostRecentWindow(&quot;mailnews:accountmanager&quot;);</span>
<a href="#l28.239"></a><span id="l28.239"> </span>
<a href="#l28.240"></a><span id="l28.240" class="difflineminus">-    if (existingAccountManager)</span>
<a href="#l28.241"></a><span id="l28.241" class="difflineplus">+    if (existingAccountManager) {</span>
<a href="#l28.242"></a><span id="l28.242">         existingAccountManager.focus();</span>
<a href="#l28.243"></a><span id="l28.243" class="difflineminus">-    else {</span>
<a href="#l28.244"></a><span id="l28.244" class="difflineplus">+    } else {</span>
<a href="#l28.245"></a><span id="l28.245">         if (!aServer) {</span>
<a href="#l28.246"></a><span id="l28.246" class="difflineminus">-          if (typeof GetSelectedMsgFolders === &quot;function&quot;) {</span>
<a href="#l28.247"></a><span id="l28.247" class="difflineminus">-            let folders = GetSelectedMsgFolders();</span>
<a href="#l28.248"></a><span id="l28.248" class="difflineplus">+          if (typeof window.GetSelectedMsgFolders === &quot;function&quot;) {</span>
<a href="#l28.249"></a><span id="l28.249" class="difflineplus">+            let folders = window.GetSelectedMsgFolders();</span>
<a href="#l28.250"></a><span id="l28.250">             if (folders.length &gt; 0)</span>
<a href="#l28.251"></a><span id="l28.251">               aServer = folders[0].server;</span>
<a href="#l28.252"></a><span id="l28.252">           }</span>
<a href="#l28.253"></a><span id="l28.253" class="difflineminus">-          if (!aServer &amp;&amp; (typeof GetDefaultAccountRootFolder === &quot;function&quot;)) {</span>
<a href="#l28.254"></a><span id="l28.254" class="difflineminus">-            let folder = GetDefaultAccountRootFolder();</span>
<a href="#l28.255"></a><span id="l28.255" class="difflineplus">+          if (!aServer &amp;&amp; (typeof window.GetDefaultAccountRootFolder === &quot;function&quot;)) {</span>
<a href="#l28.256"></a><span id="l28.256" class="difflineplus">+            let folder = window.GetDefaultAccountRootFolder();</span>
<a href="#l28.257"></a><span id="l28.257">             if (folder instanceof Ci.nsIMsgFolder)</span>
<a href="#l28.258"></a><span id="l28.258">               aServer = folder.server;</span>
<a href="#l28.259"></a><span id="l28.259">           }</span>
<a href="#l28.260"></a><span id="l28.260">         }</span>
<a href="#l28.261"></a><span id="l28.261"> </span>
<a href="#l28.262"></a><span id="l28.262">         window.openDialog(&quot;chrome://messenger/content/AccountManager.xul&quot;,</span>
<a href="#l28.263"></a><span id="l28.263">                           &quot;AccountManager&quot;,</span>
<a href="#l28.264"></a><span id="l28.264">                           &quot;chrome,centerscreen,modal,titlebar,resizable&quot;,</span>
<a href="#l28.265"></a><span id="l28.265" class="difflineminus">-                          { server: aServer, selectPage: selectPage });</span>
<a href="#l28.266"></a><span id="l28.266" class="difflineplus">+                          { server: aServer, selectPage });</span>
<a href="#l28.267"></a><span id="l28.267">     }</span>
<a href="#l28.268"></a><span id="l28.268"> }</span>
<a href="#l28.269"></a><span id="l28.269"> </span>
<a href="#l28.270"></a><span id="l28.270" class="difflineminus">-function loadInboxForNewAccount()</span>
<a href="#l28.271"></a><span id="l28.271" class="difflineminus">-{</span>
<a href="#l28.272"></a><span id="l28.272" class="difflineplus">+function loadInboxForNewAccount() {</span>
<a href="#l28.273"></a><span id="l28.273">   // gNewAccountToLoad is set in the final screen of the Account Wizard if a POP account</span>
<a href="#l28.274"></a><span id="l28.274">   // was created, the download messages box is checked, and the wizard was opened from the 3pane</span>
<a href="#l28.275"></a><span id="l28.275">   if (gNewAccountToLoad) {</span>
<a href="#l28.276"></a><span id="l28.276">     var rootMsgFolder = gNewAccountToLoad.incomingServer.rootMsgFolder;</span>
<a href="#l28.277"></a><span id="l28.277">     const kInboxFlag = Ci.nsMsgFolderFlags.Inbox;</span>
<a href="#l28.278"></a><span id="l28.278">     var inboxFolder = rootMsgFolder.getFolderWithFlags(kInboxFlag);</span>
<a href="#l28.279"></a><span id="l28.279">     SelectFolder(inboxFolder.URI);</span>
<a href="#l28.280"></a><span id="l28.280">     window.focus();</span>
<a href="#l28.281"></a><span id="l28.281">     setTimeout(MsgGetMessage, 0);</span>
<a href="#l28.282"></a><span id="l28.282">     gNewAccountToLoad = null;</span>
<a href="#l28.283"></a><span id="l28.283">   }</span>
<a href="#l28.284"></a><span id="l28.284"> }</span>
<a href="#l28.285"></a><span id="l28.285"> </span>
<a href="#l28.286"></a><span id="l28.286"> // returns true if we migrated - it knows this because 4.x did not have the</span>
<a href="#l28.287"></a><span id="l28.287"> // pref mailnews.quotingPrefs.version, so if it's not set, we're either</span>
<a href="#l28.288"></a><span id="l28.288"> // migrating from 4.x, or a much older version of Mozilla.</span>
<a href="#l28.289"></a><span id="l28.289" class="difflineminus">-function migrateGlobalQuotingPrefs(allIdentities)</span>
<a href="#l28.290"></a><span id="l28.290" class="difflineminus">-{</span>
<a href="#l28.291"></a><span id="l28.291" class="difflineplus">+function migrateGlobalQuotingPrefs(allIdentities) {</span>
<a href="#l28.292"></a><span id="l28.292">   // if reply_on_top and auto_quote exist then, if non-default</span>
<a href="#l28.293"></a><span id="l28.293">   // migrate and delete, if default just delete.</span>
<a href="#l28.294"></a><span id="l28.294">   var reply_on_top = 0;</span>
<a href="#l28.295"></a><span id="l28.295">   var auto_quote = true;</span>
<a href="#l28.296"></a><span id="l28.296" class="difflineminus">-  var quotingPrefs = 0;</span>
<a href="#l28.297"></a><span id="l28.297" class="difflineplus">+  var quotingPrefs = Services.prefs.getIntPref(&quot;mailnews.quotingPrefs.version&quot;, 0);</span>
<a href="#l28.298"></a><span id="l28.298">   var migrated = false;</span>
<a href="#l28.299"></a><span id="l28.299" class="difflineminus">-  try {</span>
<a href="#l28.300"></a><span id="l28.300" class="difflineminus">-    quotingPrefs = Services.prefs.getIntPref(&quot;mailnews.quotingPrefs.version&quot;);</span>
<a href="#l28.301"></a><span id="l28.301" class="difflineminus">-  } catch (ex) {}</span>
<a href="#l28.302"></a><span id="l28.302"> </span>
<a href="#l28.303"></a><span id="l28.303">   // If the quotingPrefs version is 0 then we need to migrate our preferences</span>
<a href="#l28.304"></a><span id="l28.304">   if (quotingPrefs == 0) {</span>
<a href="#l28.305"></a><span id="l28.305">     migrated = true;</span>
<a href="#l28.306"></a><span id="l28.306">     try {</span>
<a href="#l28.307"></a><span id="l28.307">       reply_on_top = Services.prefs.getIntPref(&quot;mailnews.reply_on_top&quot;);</span>
<a href="#l28.308"></a><span id="l28.308">       auto_quote = Services.prefs.getBoolPref(&quot;mail.auto_quote&quot;);</span>
<a href="#l28.309"></a><span id="l28.309">     } catch (ex) {}</span>
<a href="#l28.310"></a><span id="l28.310" class="difflineat">@@ -312,18 +295,17 @@ function migrateGlobalQuotingPrefs(allId</span>
<a href="#l28.311"></a><span id="l28.311">     Services.prefs.setIntPref(&quot;mailnews.quotingPrefs.version&quot;, 1);</span>
<a href="#l28.312"></a><span id="l28.312">   }</span>
<a href="#l28.313"></a><span id="l28.313">   return migrated;</span>
<a href="#l28.314"></a><span id="l28.314"> }</span>
<a href="#l28.315"></a><span id="l28.315"> </span>
<a href="#l28.316"></a><span id="l28.316"> // we do this from a timer because if this is called from the onload=</span>
<a href="#l28.317"></a><span id="l28.317"> // handler, then the parent window doesn't appear until after the wizard</span>
<a href="#l28.318"></a><span id="l28.318"> // has closed, and this is confusing to the user</span>
<a href="#l28.319"></a><span id="l28.319" class="difflineminus">-function NewMailAccount(msgWindow, okCallback, extraData)</span>
<a href="#l28.320"></a><span id="l28.320" class="difflineminus">-{</span>
<a href="#l28.321"></a><span id="l28.321" class="difflineplus">+function NewMailAccount(msgWindow, okCallback, extraData) {</span>
<a href="#l28.322"></a><span id="l28.322">   if (!msgWindow)</span>
<a href="#l28.323"></a><span id="l28.323">     throw new Error(&quot;NewMailAccount must be given a msgWindow.&quot;);</span>
<a href="#l28.324"></a><span id="l28.324"> </span>
<a href="#l28.325"></a><span id="l28.325">   // Populate the extra data.</span>
<a href="#l28.326"></a><span id="l28.326">   if (!extraData)</span>
<a href="#l28.327"></a><span id="l28.327">     extraData = {};</span>
<a href="#l28.328"></a><span id="l28.328">   extraData.msgWindow = msgWindow;</span>
<a href="#l28.329"></a><span id="l28.329"> </span>
<a href="#l28.330"></a><span id="l28.330" class="difflineat">@@ -371,17 +353,17 @@ function NewMailAccountProvisioner(aMsgW</span>
<a href="#l28.331"></a><span id="l28.331">   if (!tabmail) {</span>
<a href="#l28.332"></a><span id="l28.332">     Cu.reportError(&quot;Could not find a tabmail in the 3pane!&quot;);</span>
<a href="#l28.333"></a><span id="l28.333">     return;</span>
<a href="#l28.334"></a><span id="l28.334">   }</span>
<a href="#l28.335"></a><span id="l28.335"> </span>
<a href="#l28.336"></a><span id="l28.336">   // If there's already an accountProvisionerTab open, just focus it instead</span>
<a href="#l28.337"></a><span id="l28.337">   // of opening a new dialog.</span>
<a href="#l28.338"></a><span id="l28.338">   let apTab = tabmail.getTabInfoForCurrentOrFirstModeInstance(</span>
<a href="#l28.339"></a><span id="l28.339" class="difflineminus">-    tabmail.tabModes[&quot;accountProvisionerTab&quot;]);</span>
<a href="#l28.340"></a><span id="l28.340" class="difflineplus">+    tabmail.tabModes.accountProvisionerTab);</span>
<a href="#l28.341"></a><span id="l28.341"> </span>
<a href="#l28.342"></a><span id="l28.342">   if (apTab) {</span>
<a href="#l28.343"></a><span id="l28.343">     tabmail.switchToTab(apTab);</span>
<a href="#l28.344"></a><span id="l28.344">     return;</span>
<a href="#l28.345"></a><span id="l28.345">   }</span>
<a href="#l28.346"></a><span id="l28.346"> </span>
<a href="#l28.347"></a><span id="l28.347">   // XXX make sure these are all defined in all contexts... to be on the safe</span>
<a href="#l28.348"></a><span id="l28.348">   // side, just get a mail:3pane and borrow the functions from it?</span>
<a href="#l28.349"></a><span id="l28.349" class="difflineat">@@ -425,31 +407,28 @@ function NewMailAccountProvisioner(aMsgW</span>
<a href="#l28.350"></a><span id="l28.350">  *</span>
<a href="#l28.351"></a><span id="l28.351">  * @param msgWindow a msgWindow for us to use to verify the accounts.</span>
<a href="#l28.352"></a><span id="l28.352">  * @param okCallback an optional callback for us to call back to if</span>
<a href="#l28.353"></a><span id="l28.353">  *                   everything's okay.</span>
<a href="#l28.354"></a><span id="l28.354">  * @param extraData an optional param that allows us to pass data in and</span>
<a href="#l28.355"></a><span id="l28.355">  *                  out.  Used in the upcoming AccountProvisioner add-on.</span>
<a href="#l28.356"></a><span id="l28.356">  * @see msgOpenAccountWizard above for the previous implementation.</span>
<a href="#l28.357"></a><span id="l28.357">  */</span>
<a href="#l28.358"></a><span id="l28.358" class="difflineminus">-function msgNewMailAccount(msgWindow, okCallback, extraData)</span>
<a href="#l28.359"></a><span id="l28.359" class="difflineminus">-{</span>
<a href="#l28.360"></a><span id="l28.360" class="difflineplus">+function msgNewMailAccount(msgWindow, okCallback, extraData) {</span>
<a href="#l28.361"></a><span id="l28.361">   if (!msgWindow)</span>
<a href="#l28.362"></a><span id="l28.362">     throw new Error(&quot;msgNewMailAccount must be given a msgWindow.&quot;);</span>
<a href="#l28.363"></a><span id="l28.363"> </span>
<a href="#l28.364"></a><span id="l28.364">   let existingWindow = Services.wm.getMostRecentWindow(&quot;mail:autoconfig&quot;);</span>
<a href="#l28.365"></a><span id="l28.365">   if (existingWindow) {</span>
<a href="#l28.366"></a><span id="l28.366">     existingWindow.focus();</span>
<a href="#l28.367"></a><span id="l28.367">   } else if (AppConstants.MOZ_APP_NAME == &quot;thunderbird&quot;) {</span>
<a href="#l28.368"></a><span id="l28.368">     // disabling modal for the time being, see 688273 REMOVEME</span>
<a href="#l28.369"></a><span id="l28.369">     window.openDialog(&quot;chrome://messenger/content/accountcreation/emailWizard.xul&quot;,</span>
<a href="#l28.370"></a><span id="l28.370">                       &quot;AccountSetup&quot;, &quot;chrome,titlebar,centerscreen&quot;,</span>
<a href="#l28.371"></a><span id="l28.371" class="difflineminus">-                      {msgWindow:msgWindow,</span>
<a href="#l28.372"></a><span id="l28.372" class="difflineminus">-                       okCallback:okCallback,</span>
<a href="#l28.373"></a><span id="l28.373" class="difflineminus">-                       extraData:extraData});</span>
<a href="#l28.374"></a><span id="l28.374" class="difflineplus">+                      { msgWindow, okCallback, extraData });</span>
<a href="#l28.375"></a><span id="l28.375">   }</span>
<a href="#l28.376"></a><span id="l28.376"> </span>
<a href="#l28.377"></a><span id="l28.377">   /*</span>
<a href="#l28.378"></a><span id="l28.378">   // TODO: Enable this block of code once the dialog above is made modal.</span>
<a href="#l28.379"></a><span id="l28.379">   // If we started with no servers at all and &quot;smtp servers&quot; list selected,</span>
<a href="#l28.380"></a><span id="l28.380">   // refresh display somehow. Bug 58506.</span>
<a href="#l28.381"></a><span id="l28.381">   // TODO Better fix: select newly created account (in all cases)</span>
<a href="#l28.382"></a><span id="l28.382">   let existingAccountManager =</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-addressing.js</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-addressing.js</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -1,68 +1,61 @@</span>
<a href="#l29.4"></a><span id="l29.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l29.5"></a><span id="l29.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l29.6"></a><span id="l29.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l29.7"></a><span id="l29.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l29.8"></a><span id="l29.8"> </span>
<a href="#l29.9"></a><span id="l29.9" class="difflineplus">+/* import-globals-from am-prefs.js */</span>
<a href="#l29.10"></a><span id="l29.10" class="difflineplus">+/* import-globals-from amUtils.js */</span>
<a href="#l29.11"></a><span id="l29.11" class="difflineplus">+</span>
<a href="#l29.12"></a><span id="l29.12"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l29.13"></a><span id="l29.13"> </span>
<a href="#l29.14"></a><span id="l29.14" class="difflineminus">-function onLoad()</span>
<a href="#l29.15"></a><span id="l29.15" class="difflineminus">-{</span>
<a href="#l29.16"></a><span id="l29.16" class="difflineminus">-  parent.onPanelLoaded('am-addressing.xul');</span>
<a href="#l29.17"></a><span id="l29.17" class="difflineplus">+function onLoad() {</span>
<a href="#l29.18"></a><span id="l29.18" class="difflineplus">+  parent.onPanelLoaded(&quot;am-addressing.xul&quot;);</span>
<a href="#l29.19"></a><span id="l29.19"> }</span>
<a href="#l29.20"></a><span id="l29.20"> </span>
<a href="#l29.21"></a><span id="l29.21" class="difflineminus">-function onInit(aPageId, aServerId)</span>
<a href="#l29.22"></a><span id="l29.22" class="difflineminus">-{</span>
<a href="#l29.23"></a><span id="l29.23" class="difflineplus">+function onInit(aPageId, aServerId) {</span>
<a href="#l29.24"></a><span id="l29.24">   onInitCompositionAndAddressing();</span>
<a href="#l29.25"></a><span id="l29.25"> }</span>
<a href="#l29.26"></a><span id="l29.26"> </span>
<a href="#l29.27"></a><span id="l29.27" class="difflineminus">-function onInitCompositionAndAddressing()</span>
<a href="#l29.28"></a><span id="l29.28" class="difflineminus">-{</span>
<a href="#l29.29"></a><span id="l29.29" class="difflineplus">+function onInitCompositionAndAddressing() {</span>
<a href="#l29.30"></a><span id="l29.30">   LDAPenabling();</span>
<a href="#l29.31"></a><span id="l29.31">   quoteEnabling();</span>
<a href="#l29.32"></a><span id="l29.32"> }</span>
<a href="#l29.33"></a><span id="l29.33"> </span>
<a href="#l29.34"></a><span id="l29.34" class="difflineminus">-function onEditDirectories()</span>
<a href="#l29.35"></a><span id="l29.35" class="difflineminus">-{</span>
<a href="#l29.36"></a><span id="l29.36" class="difflineplus">+function onEditDirectories() {</span>
<a href="#l29.37"></a><span id="l29.37">   window.openDialog(&quot;chrome://messenger/content/addressbook/pref-editdirectories.xul&quot;,</span>
<a href="#l29.38"></a><span id="l29.38">                     &quot;editDirectories&quot;, &quot;chrome,modal=yes,resizable=no&quot;, null);</span>
<a href="#l29.39"></a><span id="l29.39"> }</span>
<a href="#l29.40"></a><span id="l29.40"> </span>
<a href="#l29.41"></a><span id="l29.41" class="difflineminus">-function onPreInit(account, accountValues)</span>
<a href="#l29.42"></a><span id="l29.42" class="difflineminus">-{</span>
<a href="#l29.43"></a><span id="l29.43" class="difflineplus">+function onPreInit(account, accountValues) {</span>
<a href="#l29.44"></a><span id="l29.44"> }</span>
<a href="#l29.45"></a><span id="l29.45"> </span>
<a href="#l29.46"></a><span id="l29.46" class="difflineminus">-function LDAPenabling()</span>
<a href="#l29.47"></a><span id="l29.47" class="difflineminus">-{</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineplus">+function LDAPenabling() {</span>
<a href="#l29.49"></a><span id="l29.49">   onCheckItem(&quot;identity.directoryServer&quot;, [&quot;directories&quot;]);</span>
<a href="#l29.50"></a><span id="l29.50">   onCheckItem(&quot;editButton&quot;, [&quot;directories&quot;]);</span>
<a href="#l29.51"></a><span id="l29.51"> }</span>
<a href="#l29.52"></a><span id="l29.52"> </span>
<a href="#l29.53"></a><span id="l29.53" class="difflineminus">-function quoteEnabling()</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineminus">-{</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineplus">+function quoteEnabling() {</span>
<a href="#l29.56"></a><span id="l29.56">   var placebox = document.getElementById(&quot;placeBox&quot;);</span>
<a href="#l29.57"></a><span id="l29.57"> </span>
<a href="#l29.58"></a><span id="l29.58">   if (document.getElementById(&quot;identity.replyOnTop&quot;).value == &quot;1&quot;) {</span>
<a href="#l29.59"></a><span id="l29.59">     placebox.firstChild.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l29.60"></a><span id="l29.60">     placebox.lastChild.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineminus">-  }</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineminus">-  else {</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineplus">+  } else {</span>
<a href="#l29.64"></a><span id="l29.64">     placebox.firstChild.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l29.65"></a><span id="l29.65">     placebox.lastChild.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l29.66"></a><span id="l29.66">   }</span>
<a href="#l29.67"></a><span id="l29.67"> }</span>
<a href="#l29.68"></a><span id="l29.68"> </span>
<a href="#l29.69"></a><span id="l29.69"> /**</span>
<a href="#l29.70"></a><span id="l29.70">  * Open the Preferences dialog on the tab with Addressing options.</span>
<a href="#l29.71"></a><span id="l29.71">  */</span>
<a href="#l29.72"></a><span id="l29.72" class="difflineminus">-function showGlobalAddressingPrefs()</span>
<a href="#l29.73"></a><span id="l29.73" class="difflineminus">-{</span>
<a href="#l29.74"></a><span id="l29.74" class="difflineplus">+function showGlobalAddressingPrefs() {</span>
<a href="#l29.75"></a><span id="l29.75">   openPrefsFromAccountManager(&quot;paneCompose&quot;, &quot;addressingTab&quot;, null, &quot;addressing_pane&quot;);</span>
<a href="#l29.76"></a><span id="l29.76"> }</span>
<a href="#l29.77"></a><span id="l29.77"> </span>
<a href="#l29.78"></a><span id="l29.78"> /**</span>
<a href="#l29.79"></a><span id="l29.79">  * Open the Preferences dialog on the tab with Composing options.</span>
<a href="#l29.80"></a><span id="l29.80">  */</span>
<a href="#l29.81"></a><span id="l29.81" class="difflineminus">-function showGlobalComposingPrefs()</span>
<a href="#l29.82"></a><span id="l29.82" class="difflineminus">-{</span>
<a href="#l29.83"></a><span id="l29.83" class="difflineplus">+function showGlobalComposingPrefs() {</span>
<a href="#l29.84"></a><span id="l29.84">   openPrefsFromAccountManager(&quot;paneCompose&quot;, &quot;generalTab&quot;, null, &quot;composing_messages_pane&quot;);</span>
<a href="#l29.85"></a><span id="l29.85"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-copies.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-copies.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -1,42 +1,41 @@</span>
<a href="#l30.4"></a><span id="l30.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l30.5"></a><span id="l30.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l30.6"></a><span id="l30.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l30.7"></a><span id="l30.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l30.8"></a><span id="l30.8"> </span>
<a href="#l30.9"></a><span id="l30.9" class="difflineplus">+/* import-globals-from AccountManager.js */</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineplus">+</span>
<a href="#l30.11"></a><span id="l30.11"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l30.12"></a><span id="l30.12"> </span>
<a href="#l30.13"></a><span id="l30.13"> var gFccRadioElemChoice, gDraftsRadioElemChoice, gArchivesRadioElemChoice, gTmplRadioElemChoice;</span>
<a href="#l30.14"></a><span id="l30.14"> var gFccRadioElemChoiceLocked, gDraftsRadioElemChoiceLocked, gArchivesRadioElemChoiceLocked, gTmplRadioElemChoiceLocked;</span>
<a href="#l30.15"></a><span id="l30.15"> var gDefaultPickerMode = &quot;1&quot;;</span>
<a href="#l30.16"></a><span id="l30.16"> </span>
<a href="#l30.17"></a><span id="l30.17"> var gFccFolderWithDelim, gDraftsFolderWithDelim, gArchivesFolderWithDelim, gTemplatesFolderWithDelim;</span>
<a href="#l30.18"></a><span id="l30.18"> var gAccount;</span>
<a href="#l30.19"></a><span id="l30.19"> var gCurrentServerId;</span>
<a href="#l30.20"></a><span id="l30.20"> </span>
<a href="#l30.21"></a><span id="l30.21" class="difflineminus">-function onPreInit(account, accountValues)</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineminus">-{</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+function onPreInit(account, accountValues) {</span>
<a href="#l30.24"></a><span id="l30.24">   gAccount = account;</span>
<a href="#l30.25"></a><span id="l30.25">   var type = parent.getAccountValue(account, accountValues, &quot;server&quot;, &quot;type&quot;, null, false);</span>
<a href="#l30.26"></a><span id="l30.26">   hideShowControls(type);</span>
<a href="#l30.27"></a><span id="l30.27"> }</span>
<a href="#l30.28"></a><span id="l30.28"> </span>
<a href="#l30.29"></a><span id="l30.29"> /*</span>
<a href="#l30.30"></a><span id="l30.30">  * Set the global radio element choices and initialize folder/account pickers.</span>
<a href="#l30.31"></a><span id="l30.31">  * Also, initialize other UI elements (cc, bcc, fcc picker controller checkboxes).</span>
<a href="#l30.32"></a><span id="l30.32">  */</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineminus">-function onInit(aPageId, aServerId)</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineminus">-{</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+function onInit(aPageId, aServerId) {</span>
<a href="#l30.36"></a><span id="l30.36">   gCurrentServerId = aServerId;</span>
<a href="#l30.37"></a><span id="l30.37">     onInitCopiesAndFolders();</span>
<a href="#l30.38"></a><span id="l30.38"> }</span>
<a href="#l30.39"></a><span id="l30.39"> </span>
<a href="#l30.40"></a><span id="l30.40" class="difflineminus">-function onInitCopiesAndFolders()</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineminus">-{</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineplus">+function onInitCopiesAndFolders() {</span>
<a href="#l30.43"></a><span id="l30.43">     SetGlobalRadioElemChoices();</span>
<a href="#l30.44"></a><span id="l30.44"> </span>
<a href="#l30.45"></a><span id="l30.45">     SetFolderDisplay(gFccRadioElemChoice, gFccRadioElemChoiceLocked,</span>
<a href="#l30.46"></a><span id="l30.46">                      &quot;fcc&quot;,</span>
<a href="#l30.47"></a><span id="l30.47">                      &quot;msgFccAccountPicker&quot;,</span>
<a href="#l30.48"></a><span id="l30.48">                      &quot;identity.fccFolder&quot;,</span>
<a href="#l30.49"></a><span id="l30.49">                      &quot;msgFccFolderPicker&quot;);</span>
<a href="#l30.50"></a><span id="l30.50"> </span>
<a href="#l30.51"></a><span id="l30.51" class="difflineat">@@ -62,18 +61,17 @@ function onInitCopiesAndFolders()</span>
<a href="#l30.52"></a><span id="l30.52">     setupBccTextbox(true);</span>
<a href="#l30.53"></a><span id="l30.53">     setupFccItems();</span>
<a href="#l30.54"></a><span id="l30.54">     setupArchiveItems();</span>
<a href="#l30.55"></a><span id="l30.55"> </span>
<a href="#l30.56"></a><span id="l30.56">     SetSpecialFolderNamesWithDelims();</span>
<a href="#l30.57"></a><span id="l30.57"> }</span>
<a href="#l30.58"></a><span id="l30.58"> </span>
<a href="#l30.59"></a><span id="l30.59"> // Initialize the picker mode choices (account/folder picker) into global vars</span>
<a href="#l30.60"></a><span id="l30.60" class="difflineminus">-function SetGlobalRadioElemChoices()</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineminus">-{</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineplus">+function SetGlobalRadioElemChoices() {</span>
<a href="#l30.63"></a><span id="l30.63">     var pickerModeElement = document.getElementById(&quot;identity.fccFolderPickerMode&quot;);</span>
<a href="#l30.64"></a><span id="l30.64">     gFccRadioElemChoice = pickerModeElement.getAttribute(&quot;value&quot;);</span>
<a href="#l30.65"></a><span id="l30.65">     gFccRadioElemChoiceLocked = pickerModeElement.getAttribute(&quot;disabled&quot;);</span>
<a href="#l30.66"></a><span id="l30.66">     if (!gFccRadioElemChoice) gFccRadioElemChoice = gDefaultPickerMode;</span>
<a href="#l30.67"></a><span id="l30.67"> </span>
<a href="#l30.68"></a><span id="l30.68">     pickerModeElement = document.getElementById(&quot;identity.archivesFolderPickerMode&quot;);</span>
<a href="#l30.69"></a><span id="l30.69">     gArchivesRadioElemChoice = pickerModeElement.getAttribute(&quot;value&quot;);</span>
<a href="#l30.70"></a><span id="l30.70">     gArchivesRadioElemChoiceLocked = pickerModeElement.getAttribute(&quot;disabled&quot;);</span>
<a href="#l30.71"></a><span id="l30.71" class="difflineat">@@ -95,18 +93,17 @@ function SetGlobalRadioElemChoices()</span>
<a href="#l30.72"></a><span id="l30.72">  * preferences file. Default picker mode, if none specified at this stage, is</span>
<a href="#l30.73"></a><span id="l30.73">  * set to 1 i.e., Other picker displaying the folder value read from the</span>
<a href="#l30.74"></a><span id="l30.74">  * preferences file.</span>
<a href="#l30.75"></a><span id="l30.75">  */</span>
<a href="#l30.76"></a><span id="l30.76"> function SetFolderDisplay(pickerMode, disableMode,</span>
<a href="#l30.77"></a><span id="l30.77">                           radioElemPrefix,</span>
<a href="#l30.78"></a><span id="l30.78">                           accountPickerId,</span>
<a href="#l30.79"></a><span id="l30.79">                           folderPickedField,</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineminus">-                          folderPickerId)</span>
<a href="#l30.81"></a><span id="l30.81" class="difflineminus">-{</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineplus">+                          folderPickerId) {</span>
<a href="#l30.83"></a><span id="l30.83">     if (!pickerMode)</span>
<a href="#l30.84"></a><span id="l30.84">         pickerMode = gDefaultPickerMode;</span>
<a href="#l30.85"></a><span id="l30.85"> </span>
<a href="#l30.86"></a><span id="l30.86">     var selectAccountRadioId = radioElemPrefix + &quot;_selectAccount&quot;;</span>
<a href="#l30.87"></a><span id="l30.87">     var selectAccountRadioElem = document.getElementById(selectAccountRadioId);</span>
<a href="#l30.88"></a><span id="l30.88">     var selectFolderRadioId = radioElemPrefix + &quot;_selectFolder&quot;;</span>
<a href="#l30.89"></a><span id="l30.89">     var selectFolderRadioElem = document.getElementById(selectFolderRadioId);</span>
<a href="#l30.90"></a><span id="l30.90">     var accountPicker = document.getElementById(accountPickerId);</span>
<a href="#l30.91"></a><span id="l30.91" class="difflineat">@@ -117,40 +114,39 @@ function SetFolderDisplay(pickerMode, di</span>
<a href="#l30.92"></a><span id="l30.92">     // Get message folder from the given uri.</span>
<a href="#l30.93"></a><span id="l30.93">     // There is no need to check for the existence of special folders as</span>
<a href="#l30.94"></a><span id="l30.94">     // these folders are created on demand at runtime in case of imap accounts.</span>
<a href="#l30.95"></a><span id="l30.95">     // For POP3 accounts, special folders are created at the account creation time.</span>
<a href="#l30.96"></a><span id="l30.96">     var msgFolder = MailUtils.getOrCreateFolder(uri);</span>
<a href="#l30.97"></a><span id="l30.97">     InitFolderDisplay(msgFolder.server.rootFolder, accountPicker);</span>
<a href="#l30.98"></a><span id="l30.98">     InitFolderDisplay(msgFolder, folderPicker);</span>
<a href="#l30.99"></a><span id="l30.99"> </span>
<a href="#l30.100"></a><span id="l30.100" class="difflineminus">-    switch (pickerMode)</span>
<a href="#l30.101"></a><span id="l30.101" class="difflineminus">-    {</span>
<a href="#l30.102"></a><span id="l30.102" class="difflineplus">+    switch (pickerMode) {</span>
<a href="#l30.103"></a><span id="l30.103">         case &quot;0&quot; :</span>
<a href="#l30.104"></a><span id="l30.104">             rg.selectedItem = selectAccountRadioElem;</span>
<a href="#l30.105"></a><span id="l30.105">             SetPickerEnabling(accountPickerId, folderPickerId);</span>
<a href="#l30.106"></a><span id="l30.106">             break;</span>
<a href="#l30.107"></a><span id="l30.107"> </span>
<a href="#l30.108"></a><span id="l30.108" class="difflineminus">-        case &quot;1&quot;  :</span>
<a href="#l30.109"></a><span id="l30.109" class="difflineplus">+        case &quot;1&quot; :</span>
<a href="#l30.110"></a><span id="l30.110">             rg.selectedItem = selectFolderRadioElem;</span>
<a href="#l30.111"></a><span id="l30.111">             SetPickerEnabling(folderPickerId, accountPickerId);</span>
<a href="#l30.112"></a><span id="l30.112">             break;</span>
<a href="#l30.113"></a><span id="l30.113"> </span>
<a href="#l30.114"></a><span id="l30.114">         default :</span>
<a href="#l30.115"></a><span id="l30.115">             dump(&quot;Error in setting initial folder display on pickers\n&quot;);</span>
<a href="#l30.116"></a><span id="l30.116">             break;</span>
<a href="#l30.117"></a><span id="l30.117">     }</span>
<a href="#l30.118"></a><span id="l30.118"> </span>
<a href="#l30.119"></a><span id="l30.119">     // Check to see if we need to lock page elements. Disable radio buttons</span>
<a href="#l30.120"></a><span id="l30.120">     // and account/folder pickers when locked.</span>
<a href="#l30.121"></a><span id="l30.121">     if (disableMode) {</span>
<a href="#l30.122"></a><span id="l30.122" class="difflineminus">-      selectAccountRadioElem.setAttribute(&quot;disabled&quot;,&quot;true&quot;);</span>
<a href="#l30.123"></a><span id="l30.123" class="difflineminus">-      selectFolderRadioElem.setAttribute(&quot;disabled&quot;,&quot;true&quot;);</span>
<a href="#l30.124"></a><span id="l30.124" class="difflineminus">-      accountPicker.setAttribute(&quot;disabled&quot;,&quot;true&quot;);</span>
<a href="#l30.125"></a><span id="l30.125" class="difflineminus">-      folderPicker.setAttribute(&quot;disabled&quot;,&quot;true&quot;);</span>
<a href="#l30.126"></a><span id="l30.126" class="difflineplus">+      selectAccountRadioElem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l30.127"></a><span id="l30.127" class="difflineplus">+      selectFolderRadioElem.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineplus">+      accountPicker.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l30.129"></a><span id="l30.129" class="difflineplus">+      folderPicker.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l30.130"></a><span id="l30.130">     }</span>
<a href="#l30.131"></a><span id="l30.131"> }</span>
<a href="#l30.132"></a><span id="l30.132"> </span>
<a href="#l30.133"></a><span id="l30.133"> // Initialize the folder display based on prefs values</span>
<a href="#l30.134"></a><span id="l30.134"> function InitFolderDisplay(folder, folderPicker) {</span>
<a href="#l30.135"></a><span id="l30.135">     folderPicker.menupopup.selectFolder(folder);</span>
<a href="#l30.136"></a><span id="l30.136">     folderPicker.folder = folder;</span>
<a href="#l30.137"></a><span id="l30.137"> }</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineat">@@ -158,145 +154,137 @@ function InitFolderDisplay(folder, folde</span>
<a href="#l30.139"></a><span id="l30.139"> /**</span>
<a href="#l30.140"></a><span id="l30.140">  * Capture any menulist changes and update the folder property.</span>
<a href="#l30.141"></a><span id="l30.141">  *</span>
<a href="#l30.142"></a><span id="l30.142">  * @param aGroup the prefix for the menulist we're handling (e.g. &quot;drafts&quot;)</span>
<a href="#l30.143"></a><span id="l30.143">  * @param aType &quot;Account&quot; for the account picker or &quot;Folder&quot; for the folder</span>
<a href="#l30.144"></a><span id="l30.144">  *        picker</span>
<a href="#l30.145"></a><span id="l30.145">  * @param aEvent the event that we're responding to</span>
<a href="#l30.146"></a><span id="l30.146">  */</span>
<a href="#l30.147"></a><span id="l30.147" class="difflineminus">-function noteSelectionChange(aGroup, aType, aEvent)</span>
<a href="#l30.148"></a><span id="l30.148" class="difflineminus">-{</span>
<a href="#l30.149"></a><span id="l30.149" class="difflineminus">-  var checkedElem = document.getElementById(aGroup+&quot;_select&quot;+aType);</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineplus">+function noteSelectionChange(aGroup, aType, aEvent) {</span>
<a href="#l30.151"></a><span id="l30.151" class="difflineplus">+  var checkedElem = document.getElementById(aGroup + &quot;_select&quot; + aType);</span>
<a href="#l30.152"></a><span id="l30.152">   var folder = aEvent.target._folder;</span>
<a href="#l30.153"></a><span id="l30.153">   var modeValue = checkedElem.value;</span>
<a href="#l30.154"></a><span id="l30.154">   var radioGroup = checkedElem.radioGroup.getAttribute(&quot;id&quot;);</span>
<a href="#l30.155"></a><span id="l30.155">   var picker;</span>
<a href="#l30.156"></a><span id="l30.156"> </span>
<a href="#l30.157"></a><span id="l30.157">   switch (radioGroup) {</span>
<a href="#l30.158"></a><span id="l30.158">     case &quot;doFcc&quot; :</span>
<a href="#l30.159"></a><span id="l30.159">       gFccRadioElemChoice = modeValue;</span>
<a href="#l30.160"></a><span id="l30.160" class="difflineminus">-      picker = document.getElementById(&quot;msgFcc&quot;+aType+&quot;Picker&quot;);</span>
<a href="#l30.161"></a><span id="l30.161" class="difflineplus">+      picker = document.getElementById(&quot;msgFcc&quot; + aType + &quot;Picker&quot;);</span>
<a href="#l30.162"></a><span id="l30.162">       break;</span>
<a href="#l30.163"></a><span id="l30.163"> </span>
<a href="#l30.164"></a><span id="l30.164">     case &quot;messageArchives&quot; :</span>
<a href="#l30.165"></a><span id="l30.165">       gArchivesRadioElemChoice = modeValue;</span>
<a href="#l30.166"></a><span id="l30.166" class="difflineminus">-      picker = document.getElementById(&quot;msgArchives&quot;+aType+&quot;Picker&quot;);</span>
<a href="#l30.167"></a><span id="l30.167" class="difflineplus">+      picker = document.getElementById(&quot;msgArchives&quot; + aType + &quot;Picker&quot;);</span>
<a href="#l30.168"></a><span id="l30.168">       updateArchiveHierarchyButton(folder);</span>
<a href="#l30.169"></a><span id="l30.169">       break;</span>
<a href="#l30.170"></a><span id="l30.170"> </span>
<a href="#l30.171"></a><span id="l30.171">     case &quot;messageDrafts&quot; :</span>
<a href="#l30.172"></a><span id="l30.172">       gDraftsRadioElemChoice = modeValue;</span>
<a href="#l30.173"></a><span id="l30.173" class="difflineminus">-      picker = document.getElementById(&quot;msgDrafts&quot;+aType+&quot;Picker&quot;);</span>
<a href="#l30.174"></a><span id="l30.174" class="difflineplus">+      picker = document.getElementById(&quot;msgDrafts&quot; + aType + &quot;Picker&quot;);</span>
<a href="#l30.175"></a><span id="l30.175">       break;</span>
<a href="#l30.176"></a><span id="l30.176"> </span>
<a href="#l30.177"></a><span id="l30.177">     case &quot;messageTemplates&quot; :</span>
<a href="#l30.178"></a><span id="l30.178">       gTmplRadioElemChoice = modeValue;</span>
<a href="#l30.179"></a><span id="l30.179" class="difflineminus">-      picker = document.getElementById(&quot;msgStationery&quot;+aType+&quot;Picker&quot;);</span>
<a href="#l30.180"></a><span id="l30.180" class="difflineplus">+      picker = document.getElementById(&quot;msgStationery&quot; + aType + &quot;Picker&quot;);</span>
<a href="#l30.181"></a><span id="l30.181">       break;</span>
<a href="#l30.182"></a><span id="l30.182">   }</span>
<a href="#l30.183"></a><span id="l30.183"> </span>
<a href="#l30.184"></a><span id="l30.184">   picker.folder = folder;</span>
<a href="#l30.185"></a><span id="l30.185">   picker.menupopup.selectFolder(folder);</span>
<a href="#l30.186"></a><span id="l30.186"> }</span>
<a href="#l30.187"></a><span id="l30.187"> </span>
<a href="#l30.188"></a><span id="l30.188"> // Need to append special folders when account picker is selected.</span>
<a href="#l30.189"></a><span id="l30.189"> // Create a set of global special folder vars to be suffixed to the</span>
<a href="#l30.190"></a><span id="l30.190"> // server URI of the selected account.</span>
<a href="#l30.191"></a><span id="l30.191" class="difflineminus">-function SetSpecialFolderNamesWithDelims()</span>
<a href="#l30.192"></a><span id="l30.192" class="difflineminus">-{</span>
<a href="#l30.193"></a><span id="l30.193" class="difflineplus">+function SetSpecialFolderNamesWithDelims() {</span>
<a href="#l30.194"></a><span id="l30.194">     var folderDelim = &quot;/&quot;;</span>
<a href="#l30.195"></a><span id="l30.195">     /* we use internal names known to everyone like &quot;Sent&quot;, &quot;Templates&quot; and &quot;Drafts&quot; */</span>
<a href="#l30.196"></a><span id="l30.196"> </span>
<a href="#l30.197"></a><span id="l30.197">     gFccFolderWithDelim = folderDelim + &quot;Sent&quot;;</span>
<a href="#l30.198"></a><span id="l30.198">     gArchivesFolderWithDelim = folderDelim + &quot;Archives&quot;;</span>
<a href="#l30.199"></a><span id="l30.199">     gDraftsFolderWithDelim = folderDelim + &quot;Drafts&quot;;</span>
<a href="#l30.200"></a><span id="l30.200">     gTemplatesFolderWithDelim = folderDelim + &quot;Templates&quot;;</span>
<a href="#l30.201"></a><span id="l30.201"> }</span>
<a href="#l30.202"></a><span id="l30.202"> </span>
<a href="#l30.203"></a><span id="l30.203"> // Save all changes on this page</span>
<a href="#l30.204"></a><span id="l30.204" class="difflineminus">-function onSave()</span>
<a href="#l30.205"></a><span id="l30.205" class="difflineminus">-{</span>
<a href="#l30.206"></a><span id="l30.206" class="difflineplus">+function onSave() {</span>
<a href="#l30.207"></a><span id="l30.207">     onSaveCopiesAndFolders();</span>
<a href="#l30.208"></a><span id="l30.208"> }</span>
<a href="#l30.209"></a><span id="l30.209"> </span>
<a href="#l30.210"></a><span id="l30.210" class="difflineminus">-function onSaveCopiesAndFolders()</span>
<a href="#l30.211"></a><span id="l30.211" class="difflineminus">-{</span>
<a href="#l30.212"></a><span id="l30.212" class="difflineminus">-    SaveFolderSettings( gFccRadioElemChoice,</span>
<a href="#l30.213"></a><span id="l30.213" class="difflineplus">+function onSaveCopiesAndFolders() {</span>
<a href="#l30.214"></a><span id="l30.214" class="difflineplus">+    SaveFolderSettings(gFccRadioElemChoice,</span>
<a href="#l30.215"></a><span id="l30.215">                         &quot;doFcc&quot;,</span>
<a href="#l30.216"></a><span id="l30.216">                         gFccFolderWithDelim,</span>
<a href="#l30.217"></a><span id="l30.217">                         &quot;msgFccAccountPicker&quot;,</span>
<a href="#l30.218"></a><span id="l30.218">                         &quot;msgFccFolderPicker&quot;,</span>
<a href="#l30.219"></a><span id="l30.219">                         &quot;identity.fccFolder&quot;,</span>
<a href="#l30.220"></a><span id="l30.220" class="difflineminus">-                        &quot;identity.fccFolderPickerMode&quot; );</span>
<a href="#l30.221"></a><span id="l30.221" class="difflineplus">+                        &quot;identity.fccFolderPickerMode&quot;);</span>
<a href="#l30.222"></a><span id="l30.222"> </span>
<a href="#l30.223"></a><span id="l30.223" class="difflineminus">-    SaveFolderSettings( gArchivesRadioElemChoice,</span>
<a href="#l30.224"></a><span id="l30.224" class="difflineplus">+    SaveFolderSettings(gArchivesRadioElemChoice,</span>
<a href="#l30.225"></a><span id="l30.225">                         &quot;messageArchives&quot;,</span>
<a href="#l30.226"></a><span id="l30.226">                         gArchivesFolderWithDelim,</span>
<a href="#l30.227"></a><span id="l30.227">                         &quot;msgArchivesAccountPicker&quot;,</span>
<a href="#l30.228"></a><span id="l30.228">                         &quot;msgArchivesFolderPicker&quot;,</span>
<a href="#l30.229"></a><span id="l30.229">                         &quot;identity.archiveFolder&quot;,</span>
<a href="#l30.230"></a><span id="l30.230" class="difflineminus">-                        &quot;identity.archivesFolderPickerMode&quot; );</span>
<a href="#l30.231"></a><span id="l30.231" class="difflineplus">+                        &quot;identity.archivesFolderPickerMode&quot;);</span>
<a href="#l30.232"></a><span id="l30.232"> </span>
<a href="#l30.233"></a><span id="l30.233" class="difflineminus">-    SaveFolderSettings( gDraftsRadioElemChoice,</span>
<a href="#l30.234"></a><span id="l30.234" class="difflineplus">+    SaveFolderSettings(gDraftsRadioElemChoice,</span>
<a href="#l30.235"></a><span id="l30.235">                         &quot;messageDrafts&quot;,</span>
<a href="#l30.236"></a><span id="l30.236">                         gDraftsFolderWithDelim,</span>
<a href="#l30.237"></a><span id="l30.237">                         &quot;msgDraftsAccountPicker&quot;,</span>
<a href="#l30.238"></a><span id="l30.238">                         &quot;msgDraftsFolderPicker&quot;,</span>
<a href="#l30.239"></a><span id="l30.239">                         &quot;identity.draftFolder&quot;,</span>
<a href="#l30.240"></a><span id="l30.240" class="difflineminus">-                        &quot;identity.draftsFolderPickerMode&quot; );</span>
<a href="#l30.241"></a><span id="l30.241" class="difflineplus">+                        &quot;identity.draftsFolderPickerMode&quot;);</span>
<a href="#l30.242"></a><span id="l30.242"> </span>
<a href="#l30.243"></a><span id="l30.243" class="difflineminus">-    SaveFolderSettings( gTmplRadioElemChoice,</span>
<a href="#l30.244"></a><span id="l30.244" class="difflineplus">+    SaveFolderSettings(gTmplRadioElemChoice,</span>
<a href="#l30.245"></a><span id="l30.245">                         &quot;messageTemplates&quot;,</span>
<a href="#l30.246"></a><span id="l30.246">                         gTemplatesFolderWithDelim,</span>
<a href="#l30.247"></a><span id="l30.247">                         &quot;msgStationeryAccountPicker&quot;,</span>
<a href="#l30.248"></a><span id="l30.248">                         &quot;msgStationeryFolderPicker&quot;,</span>
<a href="#l30.249"></a><span id="l30.249">                         &quot;identity.stationeryFolder&quot;,</span>
<a href="#l30.250"></a><span id="l30.250" class="difflineminus">-                        &quot;identity.tmplFolderPickerMode&quot; );</span>
<a href="#l30.251"></a><span id="l30.251" class="difflineplus">+                        &quot;identity.tmplFolderPickerMode&quot;);</span>
<a href="#l30.252"></a><span id="l30.252"> }</span>
<a href="#l30.253"></a><span id="l30.253"> </span>
<a href="#l30.254"></a><span id="l30.254"> // Save folder settings and radio element choices</span>
<a href="#l30.255"></a><span id="l30.255"> function SaveFolderSettings(radioElemChoice,</span>
<a href="#l30.256"></a><span id="l30.256">                             radioGroupId,</span>
<a href="#l30.257"></a><span id="l30.257">                             folderSuffix,</span>
<a href="#l30.258"></a><span id="l30.258">                             accountPickerId,</span>
<a href="#l30.259"></a><span id="l30.259">                             folderPickerId,</span>
<a href="#l30.260"></a><span id="l30.260">                             folderElementId,</span>
<a href="#l30.261"></a><span id="l30.261" class="difflineminus">-                            folderPickerModeId)</span>
<a href="#l30.262"></a><span id="l30.262" class="difflineminus">-{</span>
<a href="#l30.263"></a><span id="l30.263" class="difflineplus">+                            folderPickerModeId) {</span>
<a href="#l30.264"></a><span id="l30.264">     var formElement = document.getElementById(folderElementId);</span>
<a href="#l30.265"></a><span id="l30.265">     var uri;</span>
<a href="#l30.266"></a><span id="l30.266"> </span>
<a href="#l30.267"></a><span id="l30.267">     if (radioElemChoice == &quot;0&quot; ||</span>
<a href="#l30.268"></a><span id="l30.268">         !document.getElementById(folderPickerId).value) {</span>
<a href="#l30.269"></a><span id="l30.269">       // Default or revert to default if no folder chosen.</span>
<a href="#l30.270"></a><span id="l30.270">       radioElemChoice = &quot;0&quot;;</span>
<a href="#l30.271"></a><span id="l30.271">       uri = document.getElementById(accountPickerId).folder.URI;</span>
<a href="#l30.272"></a><span id="l30.272">       if (uri) {</span>
<a href="#l30.273"></a><span id="l30.273">         // Create Folder URI.</span>
<a href="#l30.274"></a><span id="l30.274">         uri = uri + folderSuffix;</span>
<a href="#l30.275"></a><span id="l30.275">       }</span>
<a href="#l30.276"></a><span id="l30.276" class="difflineminus">-    }</span>
<a href="#l30.277"></a><span id="l30.277" class="difflineminus">-    else if (radioElemChoice == &quot;1&quot;) {</span>
<a href="#l30.278"></a><span id="l30.278" class="difflineplus">+    } else if (radioElemChoice == &quot;1&quot;) {</span>
<a href="#l30.279"></a><span id="l30.279">       uri = document.getElementById(folderPickerId).folder.URI;</span>
<a href="#l30.280"></a><span id="l30.280" class="difflineminus">-    }</span>
<a href="#l30.281"></a><span id="l30.281" class="difflineminus">-    else {</span>
<a href="#l30.282"></a><span id="l30.282" class="difflineminus">-      dump (&quot;Error saving folder preferences.\n&quot;);</span>
<a href="#l30.283"></a><span id="l30.283" class="difflineplus">+    } else {</span>
<a href="#l30.284"></a><span id="l30.284" class="difflineplus">+      dump(&quot;Error saving folder preferences.\n&quot;);</span>
<a href="#l30.285"></a><span id="l30.285">       return;</span>
<a href="#l30.286"></a><span id="l30.286">     }</span>
<a href="#l30.287"></a><span id="l30.287"> </span>
<a href="#l30.288"></a><span id="l30.288">     formElement.setAttribute(&quot;value&quot;, uri);</span>
<a href="#l30.289"></a><span id="l30.289"> </span>
<a href="#l30.290"></a><span id="l30.290">     formElement = document.getElementById(folderPickerModeId);</span>
<a href="#l30.291"></a><span id="l30.291">     formElement.setAttribute(&quot;value&quot;, radioElemChoice);</span>
<a href="#l30.292"></a><span id="l30.292"> }</span>
<a href="#l30.293"></a><span id="l30.293"> </span>
<a href="#l30.294"></a><span id="l30.294"> // Check the Fcc Self item and setup associated picker state</span>
<a href="#l30.295"></a><span id="l30.295" class="difflineminus">-function setupFccItems()</span>
<a href="#l30.296"></a><span id="l30.296" class="difflineminus">-{</span>
<a href="#l30.297"></a><span id="l30.297" class="difflineplus">+function setupFccItems() {</span>
<a href="#l30.298"></a><span id="l30.298">   let checked = document.getElementById(&quot;identity.doFcc&quot;).checked;</span>
<a href="#l30.299"></a><span id="l30.299">   document.querySelectorAll(&quot;.depends-on-do-fcc&quot;).forEach(e =&gt; {</span>
<a href="#l30.300"></a><span id="l30.300">     if (checked) {</span>
<a href="#l30.301"></a><span id="l30.301">       e.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l30.302"></a><span id="l30.302">     } else {</span>
<a href="#l30.303"></a><span id="l30.303">       e.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l30.304"></a><span id="l30.304">     }</span>
<a href="#l30.305"></a><span id="l30.305">   });</span>
<a href="#l30.306"></a><span id="l30.306" class="difflineat">@@ -319,66 +307,64 @@ function setupFccItems()</span>
<a href="#l30.307"></a><span id="l30.307"> </span>
<a href="#l30.308"></a><span id="l30.308">     default :</span>
<a href="#l30.309"></a><span id="l30.309">       dump(&quot;Error in setting Fcc elements.\n&quot;);</span>
<a href="#l30.310"></a><span id="l30.310">       break;</span>
<a href="#l30.311"></a><span id="l30.311">   }</span>
<a href="#l30.312"></a><span id="l30.312"> }</span>
<a href="#l30.313"></a><span id="l30.313"> </span>
<a href="#l30.314"></a><span id="l30.314"> // Disable CC textbox if CC checkbox is not checked</span>
<a href="#l30.315"></a><span id="l30.315" class="difflineminus">-function setupCcTextbox(init)</span>
<a href="#l30.316"></a><span id="l30.316" class="difflineminus">-{</span>
<a href="#l30.317"></a><span id="l30.317" class="difflineplus">+function setupCcTextbox(init) {</span>
<a href="#l30.318"></a><span id="l30.318">     var ccChecked = document.getElementById(&quot;identity.doCc&quot;).checked;</span>
<a href="#l30.319"></a><span id="l30.319">     var ccTextbox = document.getElementById(&quot;identity.doCcList&quot;);</span>
<a href="#l30.320"></a><span id="l30.320"> </span>
<a href="#l30.321"></a><span id="l30.321">     ccTextbox.disabled = !ccChecked;</span>
<a href="#l30.322"></a><span id="l30.322"> </span>
<a href="#l30.323"></a><span id="l30.323">     if (ccChecked) {</span>
<a href="#l30.324"></a><span id="l30.324">         if (ccTextbox.value == &quot;&quot;) {</span>
<a href="#l30.325"></a><span id="l30.325">             ccTextbox.value = document.getElementById(&quot;identity.email&quot;).value;</span>
<a href="#l30.326"></a><span id="l30.326">             if (!init)</span>
<a href="#l30.327"></a><span id="l30.327">                 ccTextbox.select();</span>
<a href="#l30.328"></a><span id="l30.328">         }</span>
<a href="#l30.329"></a><span id="l30.329">     } else if ((ccTextbox.value == document.getElementById(&quot;identity.email&quot;).value) ||</span>
<a href="#l30.330"></a><span id="l30.330" class="difflineminus">-               (init &amp;&amp; ccTextbox.getAttribute(&quot;value&quot;) == &quot;&quot;))</span>
<a href="#l30.331"></a><span id="l30.331" class="difflineplus">+               (init &amp;&amp; ccTextbox.getAttribute(&quot;value&quot;) == &quot;&quot;)) {</span>
<a href="#l30.332"></a><span id="l30.332">         ccTextbox.value = &quot;&quot;;</span>
<a href="#l30.333"></a><span id="l30.333" class="difflineplus">+    }</span>
<a href="#l30.334"></a><span id="l30.334"> }</span>
<a href="#l30.335"></a><span id="l30.335"> </span>
<a href="#l30.336"></a><span id="l30.336"> // Disable BCC textbox if BCC checkbox is not checked</span>
<a href="#l30.337"></a><span id="l30.337" class="difflineminus">-function setupBccTextbox(init)</span>
<a href="#l30.338"></a><span id="l30.338" class="difflineminus">-{</span>
<a href="#l30.339"></a><span id="l30.339" class="difflineplus">+function setupBccTextbox(init) {</span>
<a href="#l30.340"></a><span id="l30.340">     var bccChecked = document.getElementById(&quot;identity.doBcc&quot;).checked;</span>
<a href="#l30.341"></a><span id="l30.341">     var bccTextbox = document.getElementById(&quot;identity.doBccList&quot;);</span>
<a href="#l30.342"></a><span id="l30.342"> </span>
<a href="#l30.343"></a><span id="l30.343">     bccTextbox.disabled = !bccChecked;</span>
<a href="#l30.344"></a><span id="l30.344"> </span>
<a href="#l30.345"></a><span id="l30.345">     if (bccChecked) {</span>
<a href="#l30.346"></a><span id="l30.346">         if (bccTextbox.value == &quot;&quot;) {</span>
<a href="#l30.347"></a><span id="l30.347">             bccTextbox.value = document.getElementById(&quot;identity.email&quot;).value;</span>
<a href="#l30.348"></a><span id="l30.348">             if (!init)</span>
<a href="#l30.349"></a><span id="l30.349">                 bccTextbox.select();</span>
<a href="#l30.350"></a><span id="l30.350">         }</span>
<a href="#l30.351"></a><span id="l30.351">     } else if ((bccTextbox.value == document.getElementById(&quot;identity.email&quot;).value) ||</span>
<a href="#l30.352"></a><span id="l30.352" class="difflineminus">-               (init &amp;&amp; bccTextbox.getAttribute(&quot;value&quot;) == &quot;&quot;))</span>
<a href="#l30.353"></a><span id="l30.353" class="difflineplus">+               (init &amp;&amp; bccTextbox.getAttribute(&quot;value&quot;) == &quot;&quot;)) {</span>
<a href="#l30.354"></a><span id="l30.354">         bccTextbox.value = &quot;&quot;;</span>
<a href="#l30.355"></a><span id="l30.355" class="difflineplus">+    }</span>
<a href="#l30.356"></a><span id="l30.356"> }</span>
<a href="#l30.357"></a><span id="l30.357"> </span>
<a href="#l30.358"></a><span id="l30.358"> // Enable and disable pickers based on the radio element clicked</span>
<a href="#l30.359"></a><span id="l30.359" class="difflineminus">-function SetPickerEnabling(enablePickerId, disablePickerId)</span>
<a href="#l30.360"></a><span id="l30.360" class="difflineminus">-{</span>
<a href="#l30.361"></a><span id="l30.361" class="difflineplus">+function SetPickerEnabling(enablePickerId, disablePickerId) {</span>
<a href="#l30.362"></a><span id="l30.362">     var activePicker = document.getElementById(enablePickerId);</span>
<a href="#l30.363"></a><span id="l30.363">     activePicker.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l30.364"></a><span id="l30.364"> </span>
<a href="#l30.365"></a><span id="l30.365">     var inactivePicker = document.getElementById(disablePickerId);</span>
<a href="#l30.366"></a><span id="l30.366">     inactivePicker.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l30.367"></a><span id="l30.367"> }</span>
<a href="#l30.368"></a><span id="l30.368"> </span>
<a href="#l30.369"></a><span id="l30.369"> // Set radio element choices and picker states</span>
<a href="#l30.370"></a><span id="l30.370" class="difflineminus">-function setPickersState(enablePickerId, disablePickerId, event)</span>
<a href="#l30.371"></a><span id="l30.371" class="difflineminus">-{</span>
<a href="#l30.372"></a><span id="l30.372" class="difflineplus">+function setPickersState(enablePickerId, disablePickerId, event) {</span>
<a href="#l30.373"></a><span id="l30.373">   SetPickerEnabling(enablePickerId, disablePickerId);</span>
<a href="#l30.374"></a><span id="l30.374"> </span>
<a href="#l30.375"></a><span id="l30.375">   var radioElemValue = event.target.value;</span>
<a href="#l30.376"></a><span id="l30.376"> </span>
<a href="#l30.377"></a><span id="l30.377">   switch (event.target.id) {</span>
<a href="#l30.378"></a><span id="l30.378">     case &quot;fcc_selectAccount&quot;:</span>
<a href="#l30.379"></a><span id="l30.379">     case &quot;fcc_selectFolder&quot;:</span>
<a href="#l30.380"></a><span id="l30.380">       gFccRadioElemChoice = radioElemValue;</span>
<a href="#l30.381"></a><span id="l30.381" class="difflineat">@@ -394,24 +380,22 @@ function setPickersState(enablePickerId,</span>
<a href="#l30.382"></a><span id="l30.382">       gDraftsRadioElemChoice = radioElemValue;</span>
<a href="#l30.383"></a><span id="l30.383">       break;</span>
<a href="#l30.384"></a><span id="l30.384">     case &quot;tmpl_selectAccount&quot;:</span>
<a href="#l30.385"></a><span id="l30.385">     case &quot;tmpl_selectFolder&quot;:</span>
<a href="#l30.386"></a><span id="l30.386">       gTmplRadioElemChoice = radioElemValue;</span>
<a href="#l30.387"></a><span id="l30.387">       break;</span>
<a href="#l30.388"></a><span id="l30.388">     default:</span>
<a href="#l30.389"></a><span id="l30.389">       dump(&quot;Error in setting picker state.\n&quot;);</span>
<a href="#l30.390"></a><span id="l30.390" class="difflineminus">-      return;</span>
<a href="#l30.391"></a><span id="l30.391">   }</span>
<a href="#l30.392"></a><span id="l30.392"> }</span>
<a href="#l30.393"></a><span id="l30.393"> </span>
<a href="#l30.394"></a><span id="l30.394"> // This routine is to restore the correct radio element</span>
<a href="#l30.395"></a><span id="l30.395"> // state when the fcc self checkbox broadcasts the change</span>
<a href="#l30.396"></a><span id="l30.396" class="difflineminus">-function SetRadioButtons(selectPickerId, unselectPickerId)</span>
<a href="#l30.397"></a><span id="l30.397" class="difflineminus">-{</span>
<a href="#l30.398"></a><span id="l30.398" class="difflineplus">+function SetRadioButtons(selectPickerId, unselectPickerId) {</span>
<a href="#l30.399"></a><span id="l30.399">   var activeRadioElem = document.getElementById(selectPickerId);</span>
<a href="#l30.400"></a><span id="l30.400">   activeRadioElem.radioGroup.selectedItem = activeRadioElem;</span>
<a href="#l30.401"></a><span id="l30.401"> }</span>
<a href="#l30.402"></a><span id="l30.402"> </span>
<a href="#l30.403"></a><span id="l30.403"> /**</span>
<a href="#l30.404"></a><span id="l30.404">  * Enable/disable the archive hierarchy button depending on what folder is</span>
<a href="#l30.405"></a><span id="l30.405">  * currently selected (Gmail IMAP folders should have the button disabled, since</span>
<a href="#l30.406"></a><span id="l30.406">  * changing the archive hierarchy does nothing there.</span>
<a href="#l30.407"></a><span id="l30.407" class="difflineat">@@ -456,17 +440,16 @@ function setupArchiveItems() {</span>
<a href="#l30.408"></a><span id="l30.408">         SetPickerEnabling(&quot;msgArchivesFolderPicker&quot;, &quot;msgArchivesAccountPicker&quot;);</span>
<a href="#l30.409"></a><span id="l30.409">       SetRadioButtons(&quot;archive_selectFolder&quot;, &quot;archive_selectAccount&quot;);</span>
<a href="#l30.410"></a><span id="l30.410">       updateArchiveHierarchyButton(document.getElementById(</span>
<a href="#l30.411"></a><span id="l30.411">                                    &quot;msgArchivesFolderPicker&quot;).folder);</span>
<a href="#l30.412"></a><span id="l30.412">       break;</span>
<a href="#l30.413"></a><span id="l30.413"> </span>
<a href="#l30.414"></a><span id="l30.414">     default:</span>
<a href="#l30.415"></a><span id="l30.415">       dump(&quot;Error in setting Archive elements.\n&quot;);</span>
<a href="#l30.416"></a><span id="l30.416" class="difflineminus">-      return;</span>
<a href="#l30.417"></a><span id="l30.417">   }</span>
<a href="#l30.418"></a><span id="l30.418"> }</span>
<a href="#l30.419"></a><span id="l30.419"> </span>
<a href="#l30.420"></a><span id="l30.420"> /**</span>
<a href="#l30.421"></a><span id="l30.421">  * Open a dialog to edit the folder hierarchy used when archiving messages.</span>
<a href="#l30.422"></a><span id="l30.422">  */</span>
<a href="#l30.423"></a><span id="l30.423"> function ChangeArchiveHierarchy() {</span>
<a href="#l30.424"></a><span id="l30.424">   let identity = parent.gIdentity || parent.getCurrentAccount().defaultIdentity;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-help.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-help.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -1,13 +1,17 @@</span>
<a href="#l31.4"></a><span id="l31.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l31.5"></a><span id="l31.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l31.6"></a><span id="l31.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l31.7"></a><span id="l31.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l31.8"></a><span id="l31.8"> </span>
<a href="#l31.9"></a><span id="l31.9" class="difflineplus">+// This file is SeaMonkey-only.</span>
<a href="#l31.10"></a><span id="l31.10" class="difflineplus">+</span>
<a href="#l31.11"></a><span id="l31.11" class="difflineplus">+/* globals openHelp */// suite/components/helpviewer/content/contextHelp.js</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+</span>
<a href="#l31.13"></a><span id="l31.13"> /**</span>
<a href="#l31.14"></a><span id="l31.14">  * Key value pairs to derive the tag based on the page loaded.</span>
<a href="#l31.15"></a><span id="l31.15">  * Each key is the page loaded when user clicks on one of the items on</span>
<a href="#l31.16"></a><span id="l31.16">  * the accounttree of the AccountManager window.</span>
<a href="#l31.17"></a><span id="l31.17">  * Value is a tag that is preset which will be used to display</span>
<a href="#l31.18"></a><span id="l31.18">  * context sensitive help.</span>
<a href="#l31.19"></a><span id="l31.19">  */</span>
<a href="#l31.20"></a><span id="l31.20"> var pageTagPairs = {</span>
<a href="#l31.21"></a><span id="l31.21" class="difflineat">@@ -16,22 +20,21 @@ var pageTagPairs = {</span>
<a href="#l31.22"></a><span id="l31.22">   &quot;chrome://messenger/content/am-copies.xul&quot;: &quot;mail_copies&quot;,</span>
<a href="#l31.23"></a><span id="l31.23">   &quot;chrome://messenger/content/am-addressing.xul&quot;: &quot;mail_addressing_settings&quot;,</span>
<a href="#l31.24"></a><span id="l31.24">   &quot;chrome://messenger/content/am-junk.xul&quot;: &quot;mail-account-junk&quot;,</span>
<a href="#l31.25"></a><span id="l31.25">   &quot;chrome://messenger/content/am-offline.xul&quot;: &quot;mail-offline-accounts&quot;,</span>
<a href="#l31.26"></a><span id="l31.26">   &quot;chrome://messenger/content/am-smtp.xul&quot;: &quot;mail_smtp&quot;,</span>
<a href="#l31.27"></a><span id="l31.27">   &quot;chrome://messenger/content/am-smime.xul&quot;: &quot;mail_security_settings&quot;,</span>
<a href="#l31.28"></a><span id="l31.28">   &quot;chrome://messenger/content/am-serverwithnoidentities.xul&quot;: &quot;mail_local_folders_settings&quot;,</span>
<a href="#l31.29"></a><span id="l31.29">   &quot;chrome://messenger/content/am-mdn.xul&quot;: &quot;mail-account-receipts&quot;,</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineminus">-}</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+};</span>
<a href="#l31.32"></a><span id="l31.32"> </span>
<a href="#l31.33"></a><span id="l31.33" class="difflineminus">-function doHelpButton()</span>
<a href="#l31.34"></a><span id="l31.34" class="difflineminus">-{</span>
<a href="#l31.35"></a><span id="l31.35" class="difflineplus">+function doHelpButton() {</span>
<a href="#l31.36"></a><span id="l31.36">   // Get the URI of the page loaded in the AccountManager's content frame.</span>
<a href="#l31.37"></a><span id="l31.37" class="difflineminus">-  var pageSourceURI = contentFrame.location.href;</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineplus">+  var pageSourceURI = top.frames.contentFrame.location.href;</span>
<a href="#l31.39"></a><span id="l31.39">   // Get the help tag corresponding to the page loaded.</span>
<a href="#l31.40"></a><span id="l31.40">   var helpTag = pageTagPairs[pageSourceURI];</span>
<a href="#l31.41"></a><span id="l31.41"> </span>
<a href="#l31.42"></a><span id="l31.42">   // If the help tag is generic or offline, check if there is a need to set tags per server type</span>
<a href="#l31.43"></a><span id="l31.43">   if ((helpTag == &quot;mail&quot;) || (helpTag == &quot;mail-offline-accounts&quot;)) {</span>
<a href="#l31.44"></a><span id="l31.44">     // Get server type, as we may need to set help tags per server type for some pages</span>
<a href="#l31.45"></a><span id="l31.45">     var serverType = GetServerType();</span>
<a href="#l31.46"></a><span id="l31.46"> </span>
<a href="#l31.47"></a><span id="l31.47" class="difflineat">@@ -52,25 +55,24 @@ function doHelpButton()</span>
<a href="#l31.48"></a><span id="l31.48">         helpTag = &quot;mail_offline_&quot; + serverType;</span>
<a href="#l31.49"></a><span id="l31.49">         break;</span>
<a href="#l31.50"></a><span id="l31.50"> </span>
<a href="#l31.51"></a><span id="l31.51">       default :</span>
<a href="#l31.52"></a><span id="l31.52">         break;</span>
<a href="#l31.53"></a><span id="l31.53">     }</span>
<a href="#l31.54"></a><span id="l31.54">   }</span>
<a href="#l31.55"></a><span id="l31.55"> </span>
<a href="#l31.56"></a><span id="l31.56" class="difflineminus">-  if ( helpTag )</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineplus">+  if (helpTag)</span>
<a href="#l31.58"></a><span id="l31.58">     openHelp(helpTag);</span>
<a href="#l31.59"></a><span id="l31.59">   else</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineminus">-    openHelp('mail');</span>
<a href="#l31.61"></a><span id="l31.61" class="difflineplus">+    openHelp(&quot;mail&quot;);</span>
<a href="#l31.62"></a><span id="l31.62"> }</span>
<a href="#l31.63"></a><span id="l31.63"> </span>
<a href="#l31.64"></a><span id="l31.64"> /**</span>
<a href="#l31.65"></a><span id="l31.65">  * Get server type of the selected item</span>
<a href="#l31.66"></a><span id="l31.66">  */</span>
<a href="#l31.67"></a><span id="l31.67" class="difflineminus">-function GetServerType()</span>
<a href="#l31.68"></a><span id="l31.68" class="difflineminus">-{</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineplus">+function GetServerType() {</span>
<a href="#l31.70"></a><span id="l31.70">   var serverType = null;</span>
<a href="#l31.71"></a><span id="l31.71">   var currentAccount = parent.getCurrentAccount();</span>
<a href="#l31.72"></a><span id="l31.72">   if (currentAccount)</span>
<a href="#l31.73"></a><span id="l31.73">     serverType = currentAccount.incomingServer.type;</span>
<a href="#l31.74"></a><span id="l31.74">   return serverType;</span>
<a href="#l31.75"></a><span id="l31.75"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-identities-list.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-identities-list.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -13,18 +13,17 @@ var gEditButton;</span>
<a href="#l32.4"></a><span id="l32.4"> var gSetDefaultButton;</span>
<a href="#l32.5"></a><span id="l32.5"> var gDeleteButton;</span>
<a href="#l32.6"></a><span id="l32.6"> </span>
<a href="#l32.7"></a><span id="l32.7"> var gAccount = null;  // the account we are showing the identities for</span>
<a href="#l32.8"></a><span id="l32.8"> </span>
<a href="#l32.9"></a><span id="l32.9"> document.addEventListener(&quot;dialogaccept&quot;, onOk);</span>
<a href="#l32.10"></a><span id="l32.10"> document.addEventListener(&quot;dialogcancel&quot;, onOk);</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-function onLoad()</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineminus">-{</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineplus">+function onLoad() {</span>
<a href="#l32.15"></a><span id="l32.15">   gIdentityListBox  = document.getElementById(&quot;identitiesList&quot;);</span>
<a href="#l32.16"></a><span id="l32.16">   gAddButton        = document.getElementById(&quot;cmd_add&quot;);</span>
<a href="#l32.17"></a><span id="l32.17">   gEditButton       = document.getElementById(&quot;cmd_edit&quot;);</span>
<a href="#l32.18"></a><span id="l32.18">   gSetDefaultButton = document.getElementById(&quot;cmd_default&quot;);</span>
<a href="#l32.19"></a><span id="l32.19">   gDeleteButton     = document.getElementById(&quot;cmd_delete&quot;);</span>
<a href="#l32.20"></a><span id="l32.20"> </span>
<a href="#l32.21"></a><span id="l32.21">   // extract the account</span>
<a href="#l32.22"></a><span id="l32.22">   gAccount = window.arguments[0].account;</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineat">@@ -36,29 +35,25 @@ function onLoad()</span>
<a href="#l32.24"></a><span id="l32.24">   refreshIdentityList(0);</span>
<a href="#l32.25"></a><span id="l32.25"> }</span>
<a href="#l32.26"></a><span id="l32.26"> </span>
<a href="#l32.27"></a><span id="l32.27"> /**</span>
<a href="#l32.28"></a><span id="l32.28">  * Rebuilds the listbox holding the list of identities.</span>
<a href="#l32.29"></a><span id="l32.29">  *</span>
<a href="#l32.30"></a><span id="l32.30">  * @param aSelectIndex  Attempt to select the identity with this index.</span>
<a href="#l32.31"></a><span id="l32.31">  */</span>
<a href="#l32.32"></a><span id="l32.32" class="difflineminus">-function refreshIdentityList(aSelectIndex)</span>
<a href="#l32.33"></a><span id="l32.33" class="difflineminus">-{</span>
<a href="#l32.34"></a><span id="l32.34" class="difflineplus">+function refreshIdentityList(aSelectIndex) {</span>
<a href="#l32.35"></a><span id="l32.35">   // Remove all children.</span>
<a href="#l32.36"></a><span id="l32.36">   while (gIdentityListBox.hasChildNodes())</span>
<a href="#l32.37"></a><span id="l32.37">     gIdentityListBox.lastChild.remove();</span>
<a href="#l32.38"></a><span id="l32.38"> </span>
<a href="#l32.39"></a><span id="l32.39">   // Build the list from the identities array.</span>
<a href="#l32.40"></a><span id="l32.40">   let identities = gAccount.identities;</span>
<a href="#l32.41"></a><span id="l32.41" class="difflineminus">-  for (let identity of fixIterator(identities,</span>
<a href="#l32.42"></a><span id="l32.42" class="difflineminus">-                                   Ci.nsIMsgIdentity))</span>
<a href="#l32.43"></a><span id="l32.43" class="difflineminus">-  {</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineminus">-    if (identity.valid)</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineminus">-    {</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineplus">+  for (let identity of fixIterator(identities, Ci.nsIMsgIdentity)) {</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+    if (identity.valid) {</span>
<a href="#l32.48"></a><span id="l32.48">       let label = document.createElement(&quot;label&quot;);</span>
<a href="#l32.49"></a><span id="l32.49">       label.setAttribute(&quot;value&quot;, identity.identityName);</span>
<a href="#l32.50"></a><span id="l32.50"> </span>
<a href="#l32.51"></a><span id="l32.51">       let listitem = document.createElement(&quot;richlistitem&quot;);</span>
<a href="#l32.52"></a><span id="l32.52">       listitem.appendChild(label);</span>
<a href="#l32.53"></a><span id="l32.53">       listitem.setAttribute(&quot;key&quot;, identity.key);</span>
<a href="#l32.54"></a><span id="l32.54">       gIdentityListBox.appendChild(listitem);</span>
<a href="#l32.55"></a><span id="l32.55">     }</span>
<a href="#l32.56"></a><span id="l32.56" class="difflineat">@@ -74,93 +69,85 @@ function refreshIdentityList(aSelectInde</span>
<a href="#l32.57"></a><span id="l32.57">   gIdentityListBox.selectedIndex = aSelectIndex;</span>
<a href="#l32.58"></a><span id="l32.58"> }</span>
<a href="#l32.59"></a><span id="l32.59"> </span>
<a href="#l32.60"></a><span id="l32.60"> /**</span>
<a href="#l32.61"></a><span id="l32.61">  * Opens the identity editor dialog.</span>
<a href="#l32.62"></a><span id="l32.62">  *</span>
<a href="#l32.63"></a><span id="l32.63">  * @param identity  the identity (if any) to load in the dialog</span>
<a href="#l32.64"></a><span id="l32.64">  */</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineminus">-function openIdentityEditor(identity)</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineminus">-{</span>
<a href="#l32.67"></a><span id="l32.67" class="difflineminus">-  let args = { identity: identity, account: gAccount, result: false };</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineplus">+function openIdentityEditor(identity) {</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineplus">+  let args = { identity, account: gAccount, result: false };</span>
<a href="#l32.70"></a><span id="l32.70"> </span>
<a href="#l32.71"></a><span id="l32.71">   let indexToSelect = identity ? gIdentityListBox.selectedIndex :</span>
<a href="#l32.72"></a><span id="l32.72">                                  gIdentityListBox.itemCount;</span>
<a href="#l32.73"></a><span id="l32.73"> </span>
<a href="#l32.74"></a><span id="l32.74">   window.openDialog(&quot;am-identity-edit.xul&quot;, &quot;&quot;,</span>
<a href="#l32.75"></a><span id="l32.75">                     &quot;chrome,modal,resizable,centerscreen&quot;, args);</span>
<a href="#l32.76"></a><span id="l32.76"> </span>
<a href="#l32.77"></a><span id="l32.77">   if (args.result)</span>
<a href="#l32.78"></a><span id="l32.78">     refreshIdentityList(indexToSelect);</span>
<a href="#l32.79"></a><span id="l32.79"> }</span>
<a href="#l32.80"></a><span id="l32.80"> </span>
<a href="#l32.81"></a><span id="l32.81" class="difflineminus">-function getSelectedIdentity()</span>
<a href="#l32.82"></a><span id="l32.82" class="difflineminus">-{</span>
<a href="#l32.83"></a><span id="l32.83" class="difflineplus">+function getSelectedIdentity() {</span>
<a href="#l32.84"></a><span id="l32.84">   if (gIdentityListBox.selectedItems.length != 1)</span>
<a href="#l32.85"></a><span id="l32.85">     return null;</span>
<a href="#l32.86"></a><span id="l32.86"> </span>
<a href="#l32.87"></a><span id="l32.87">   var identityKey = gIdentityListBox.selectedItems[0].getAttribute(&quot;key&quot;);</span>
<a href="#l32.88"></a><span id="l32.88">   let identities = gAccount.identities;</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineminus">-  for (let identity of fixIterator(identities,</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineminus">-                                   Ci.nsIMsgIdentity))</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineminus">-  {</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineplus">+  for (let identity of fixIterator(identities, Ci.nsIMsgIdentity)) {</span>
<a href="#l32.93"></a><span id="l32.93">     if (identity.valid &amp;&amp; identity.key == identityKey)</span>
<a href="#l32.94"></a><span id="l32.94">       return identity;</span>
<a href="#l32.95"></a><span id="l32.95">   }</span>
<a href="#l32.96"></a><span id="l32.96"> </span>
<a href="#l32.97"></a><span id="l32.97">   return null; // no identity found</span>
<a href="#l32.98"></a><span id="l32.98"> }</span>
<a href="#l32.99"></a><span id="l32.99"> </span>
<a href="#l32.100"></a><span id="l32.100" class="difflineminus">-function onEdit(event)</span>
<a href="#l32.101"></a><span id="l32.101" class="difflineminus">-{</span>
<a href="#l32.102"></a><span id="l32.102" class="difflineminus">-  var id = (event.target.localName == 'listbox') ? null : getSelectedIdentity();</span>
<a href="#l32.103"></a><span id="l32.103" class="difflineplus">+function onEdit(event) {</span>
<a href="#l32.104"></a><span id="l32.104" class="difflineplus">+  var id = (event.target.localName == &quot;listbox&quot;) ? null : getSelectedIdentity();</span>
<a href="#l32.105"></a><span id="l32.105">   openIdentityEditor(id);</span>
<a href="#l32.106"></a><span id="l32.106"> }</span>
<a href="#l32.107"></a><span id="l32.107"> </span>
<a href="#l32.108"></a><span id="l32.108"> /**</span>
<a href="#l32.109"></a><span id="l32.109">  * Enable/disable buttons depending on number of identities and current selection.</span>
<a href="#l32.110"></a><span id="l32.110">  */</span>
<a href="#l32.111"></a><span id="l32.111" class="difflineminus">-function updateButtons()</span>
<a href="#l32.112"></a><span id="l32.112" class="difflineminus">-{</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineplus">+function updateButtons() {</span>
<a href="#l32.114"></a><span id="l32.114">   // In this listbox there should always be one item selected.</span>
<a href="#l32.115"></a><span id="l32.115">   if (gIdentityListBox.selectedItems.length != 1 || gIdentityListBox.itemCount == 0) {</span>
<a href="#l32.116"></a><span id="l32.116">     // But in case this is not met (e.g. there is no identity for some reason,</span>
<a href="#l32.117"></a><span id="l32.117">     // or the list is being rebuilt), disable all buttons.</span>
<a href="#l32.118"></a><span id="l32.118">     gEditButton.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l32.119"></a><span id="l32.119">     gDeleteButton.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l32.120"></a><span id="l32.120">     gSetDefaultButton.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l32.121"></a><span id="l32.121">     return;</span>
<a href="#l32.122"></a><span id="l32.122">   }</span>
<a href="#l32.123"></a><span id="l32.123"> </span>
<a href="#l32.124"></a><span id="l32.124">   gEditButton.setAttribute(&quot;disabled&quot;, &quot;false&quot;);</span>
<a href="#l32.125"></a><span id="l32.125">   gDeleteButton.setAttribute(&quot;disabled&quot;, (gIdentityListBox.itemCount &lt;= 1) ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l32.126"></a><span id="l32.126">   gSetDefaultButton.setAttribute(&quot;disabled&quot;, (gIdentityListBox.selectedIndex == 0) ? &quot;true&quot; : &quot;false&quot;);</span>
<a href="#l32.127"></a><span id="l32.127">   // The Add command is always enabled.</span>
<a href="#l32.128"></a><span id="l32.128"> }</span>
<a href="#l32.129"></a><span id="l32.129"> </span>
<a href="#l32.130"></a><span id="l32.130" class="difflineminus">-function onSetDefault(event)</span>
<a href="#l32.131"></a><span id="l32.131" class="difflineminus">-{</span>
<a href="#l32.132"></a><span id="l32.132" class="difflineplus">+function onSetDefault(event) {</span>
<a href="#l32.133"></a><span id="l32.133">   let identity = getSelectedIdentity();</span>
<a href="#l32.134"></a><span id="l32.134">   if (!identity)</span>
<a href="#l32.135"></a><span id="l32.135">     return;</span>
<a href="#l32.136"></a><span id="l32.136"> </span>
<a href="#l32.137"></a><span id="l32.137">   // If the first identity is selected, there is nothing to do.</span>
<a href="#l32.138"></a><span id="l32.138">   if (gIdentityListBox.selectedIndex == 0)</span>
<a href="#l32.139"></a><span id="l32.139">     return;</span>
<a href="#l32.140"></a><span id="l32.140"> </span>
<a href="#l32.141"></a><span id="l32.141">   gAccount.defaultIdentity = identity;</span>
<a href="#l32.142"></a><span id="l32.142">   // Rebuilt the identity list and select the moved identity again.</span>
<a href="#l32.143"></a><span id="l32.143">   refreshIdentityList(0);</span>
<a href="#l32.144"></a><span id="l32.144">   // Update gloda's myContact with the new default identity.</span>
<a href="#l32.145"></a><span id="l32.145">   Gloda._initMyIdentities();</span>
<a href="#l32.146"></a><span id="l32.146"> }</span>
<a href="#l32.147"></a><span id="l32.147"> </span>
<a href="#l32.148"></a><span id="l32.148" class="difflineminus">-function onDelete(event)</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineminus">-{</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineplus">+function onDelete(event) {</span>
<a href="#l32.151"></a><span id="l32.151">   if (gIdentityListBox.itemCount &lt;= 1)  // don't support deleting the last identity</span>
<a href="#l32.152"></a><span id="l32.152">     return;</span>
<a href="#l32.153"></a><span id="l32.153"> </span>
<a href="#l32.154"></a><span id="l32.154">   // get delete confirmation</span>
<a href="#l32.155"></a><span id="l32.155">   let selectedIdentity = getSelectedIdentity();</span>
<a href="#l32.156"></a><span id="l32.156"> </span>
<a href="#l32.157"></a><span id="l32.157">   let prefsBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l32.158"></a><span id="l32.158">   let confirmTitle = prefsBundle.getFormattedString(&quot;identity-delete-confirm-title&quot;,</span>
<a href="#l32.159"></a><span id="l32.159" class="difflineat">@@ -177,12 +164,11 @@ function onDelete(event)</span>
<a href="#l32.160"></a><span id="l32.160"> </span>
<a href="#l32.161"></a><span id="l32.161">   let selectedItemIndex = gIdentityListBox.selectedIndex;</span>
<a href="#l32.162"></a><span id="l32.162"> </span>
<a href="#l32.163"></a><span id="l32.163">   gAccount.removeIdentity(selectedIdentity);</span>
<a href="#l32.164"></a><span id="l32.164"> </span>
<a href="#l32.165"></a><span id="l32.165">   refreshIdentityList(selectedItemIndex);</span>
<a href="#l32.166"></a><span id="l32.166"> }</span>
<a href="#l32.167"></a><span id="l32.167"> </span>
<a href="#l32.168"></a><span id="l32.168" class="difflineminus">-function onOk()</span>
<a href="#l32.169"></a><span id="l32.169" class="difflineminus">-{</span>
<a href="#l32.170"></a><span id="l32.170" class="difflineplus">+function onOk() {</span>
<a href="#l32.171"></a><span id="l32.171">   window.arguments[0].result = true;</span>
<a href="#l32.172"></a><span id="l32.172"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-identity-edit.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-identity-edit.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -1,23 +1,25 @@</span>
<a href="#l33.4"></a><span id="l33.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l33.5"></a><span id="l33.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l33.6"></a><span id="l33.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l33.7"></a><span id="l33.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l33.8"></a><span id="l33.8"> </span>
<a href="#l33.9"></a><span id="l33.9" class="difflineplus">+/* import-globals-from am-addressing.js */</span>
<a href="#l33.10"></a><span id="l33.10" class="difflineplus">+/* import-globals-from am-copies.js */</span>
<a href="#l33.11"></a><span id="l33.11" class="difflineplus">+</span>
<a href="#l33.12"></a><span id="l33.12"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l33.13"></a><span id="l33.13"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l33.14"></a><span id="l33.14"> </span>
<a href="#l33.15"></a><span id="l33.15"> var gIdentity = null;  // the identity we are editing (may be null for a new identity)</span>
<a href="#l33.16"></a><span id="l33.16"> var gAccount = null;   // the account the identity is (or will be) associated with</span>
<a href="#l33.17"></a><span id="l33.17"> </span>
<a href="#l33.18"></a><span id="l33.18"> document.addEventListener(&quot;dialogaccept&quot;, onOk);</span>
<a href="#l33.19"></a><span id="l33.19"> </span>
<a href="#l33.20"></a><span id="l33.20" class="difflineminus">-function onLoadIdentityProperties()</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineminus">-{</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+function onLoadIdentityProperties() {</span>
<a href="#l33.23"></a><span id="l33.23">   // extract the account</span>
<a href="#l33.24"></a><span id="l33.24">   gIdentity = window.arguments[0].identity;</span>
<a href="#l33.25"></a><span id="l33.25">   gAccount = window.arguments[0].account;</span>
<a href="#l33.26"></a><span id="l33.26">   let prefBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l33.27"></a><span id="l33.27"> </span>
<a href="#l33.28"></a><span id="l33.28">   // Make the dialog the same height and 90% of the width of the main Account</span>
<a href="#l33.29"></a><span id="l33.29">   // manager page when the Account manager is not maximized.</span>
<a href="#l33.30"></a><span id="l33.30">   let accountDialog = Services.wm.getMostRecentWindow(&quot;mailnews:accountmanager&quot;)</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineat">@@ -40,116 +42,108 @@ function onLoadIdentityProperties()</span>
<a href="#l33.32"></a><span id="l33.32">   loadSMTPServerList();</span>
<a href="#l33.33"></a><span id="l33.33"> </span>
<a href="#l33.34"></a><span id="l33.34">   initIdentityValues(gIdentity);</span>
<a href="#l33.35"></a><span id="l33.35">   initCopiesAndFolder(gIdentity);</span>
<a href="#l33.36"></a><span id="l33.36">   initCompositionAndAddressing(gIdentity);</span>
<a href="#l33.37"></a><span id="l33.37"> }</span>
<a href="#l33.38"></a><span id="l33.38"> </span>
<a href="#l33.39"></a><span id="l33.39"> // based on the values of gIdentity, initialize the identity fields we expose to the user</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineminus">-function initIdentityValues(identity)</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineminus">-{</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+function initIdentityValues(identity) {</span>
<a href="#l33.43"></a><span id="l33.43">   function initSmtpServer(aServerKey) {</span>
<a href="#l33.44"></a><span id="l33.44">     // Select a server in the SMTP server menulist by its key.</span>
<a href="#l33.45"></a><span id="l33.45">     // The value of the identity.smtpServerKey is null when the</span>
<a href="#l33.46"></a><span id="l33.46">     // &quot;use default server&quot; option is used so, if we get that passed in, select</span>
<a href="#l33.47"></a><span id="l33.47">     // the useDefaultItem representing this option by using the value of &quot;&quot;.</span>
<a href="#l33.48"></a><span id="l33.48">     document.getElementById(&quot;identity.smtpServerKey&quot;).value = aServerKey || &quot;&quot;;</span>
<a href="#l33.49"></a><span id="l33.49">   }</span>
<a href="#l33.50"></a><span id="l33.50"> </span>
<a href="#l33.51"></a><span id="l33.51" class="difflineminus">-  if (identity)</span>
<a href="#l33.52"></a><span id="l33.52" class="difflineminus">-  {</span>
<a href="#l33.53"></a><span id="l33.53" class="difflineminus">-    document.getElementById('identity.fullName').value = identity.fullName;</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineminus">-    document.getElementById('identity.email').value = identity.email;</span>
<a href="#l33.55"></a><span id="l33.55" class="difflineminus">-    document.getElementById('identity.replyTo').value = identity.replyTo;</span>
<a href="#l33.56"></a><span id="l33.56" class="difflineminus">-    document.getElementById('identity.organization').value = identity.organization;</span>
<a href="#l33.57"></a><span id="l33.57" class="difflineminus">-    document.getElementById('identity.attachSignature').checked = identity.attachSignature;</span>
<a href="#l33.58"></a><span id="l33.58" class="difflineminus">-    document.getElementById('identity.htmlSigText').value = identity.htmlSigText;</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineminus">-    document.getElementById('identity.htmlSigFormat').checked = identity.htmlSigFormat;</span>
<a href="#l33.60"></a><span id="l33.60" class="difflineplus">+  if (identity) {</span>
<a href="#l33.61"></a><span id="l33.61" class="difflineplus">+    document.getElementById(&quot;identity.fullName&quot;).value = identity.fullName;</span>
<a href="#l33.62"></a><span id="l33.62" class="difflineplus">+    document.getElementById(&quot;identity.email&quot;).value = identity.email;</span>
<a href="#l33.63"></a><span id="l33.63" class="difflineplus">+    document.getElementById(&quot;identity.replyTo&quot;).value = identity.replyTo;</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineplus">+    document.getElementById(&quot;identity.organization&quot;).value = identity.organization;</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+    document.getElementById(&quot;identity.attachSignature&quot;).checked = identity.attachSignature;</span>
<a href="#l33.66"></a><span id="l33.66" class="difflineplus">+    document.getElementById(&quot;identity.htmlSigText&quot;).value = identity.htmlSigText;</span>
<a href="#l33.67"></a><span id="l33.67" class="difflineplus">+    document.getElementById(&quot;identity.htmlSigFormat&quot;).checked = identity.htmlSigFormat;</span>
<a href="#l33.68"></a><span id="l33.68"> </span>
<a href="#l33.69"></a><span id="l33.69">     if (identity.signature)</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineminus">-      document.getElementById('identity.signature').value = identity.signature.path;</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineplus">+      document.getElementById(&quot;identity.signature&quot;).value = identity.signature.path;</span>
<a href="#l33.72"></a><span id="l33.72"> </span>
<a href="#l33.73"></a><span id="l33.73" class="difflineminus">-    document.getElementById('identity.attachVCard').checked = identity.attachVCard;</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineminus">-    document.getElementById('identity.escapedVCard').value = identity.escapedVCard;</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineplus">+    document.getElementById(&quot;identity.attachVCard&quot;).checked = identity.attachVCard;</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineplus">+    document.getElementById(&quot;identity.escapedVCard&quot;).value = identity.escapedVCard;</span>
<a href="#l33.77"></a><span id="l33.77">     initSmtpServer(identity.smtpServerKey);</span>
<a href="#l33.78"></a><span id="l33.78"> </span>
<a href="#l33.79"></a><span id="l33.79">     // This field does not exist for the default identity shown in the am-main.xul pane.</span>
<a href="#l33.80"></a><span id="l33.80">     let idLabel = document.getElementById(&quot;identity.label&quot;);</span>
<a href="#l33.81"></a><span id="l33.81">     if (idLabel)</span>
<a href="#l33.82"></a><span id="l33.82">       idLabel.value = identity.label;</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineminus">-  }</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineminus">-  else</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineminus">-  {</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineplus">+  } else {</span>
<a href="#l33.87"></a><span id="l33.87">     // We're adding an identity, use the best default we have.</span>
<a href="#l33.88"></a><span id="l33.88">     initSmtpServer(gAccount.defaultIdentity.smtpServerKey);</span>
<a href="#l33.89"></a><span id="l33.89">   }</span>
<a href="#l33.90"></a><span id="l33.90"> </span>
<a href="#l33.91"></a><span id="l33.91">   setupSignatureItems();</span>
<a href="#l33.92"></a><span id="l33.92"> }</span>
<a href="#l33.93"></a><span id="l33.93"> </span>
<a href="#l33.94"></a><span id="l33.94" class="difflineminus">-function initCopiesAndFolder(identity)</span>
<a href="#l33.95"></a><span id="l33.95" class="difflineminus">-{</span>
<a href="#l33.96"></a><span id="l33.96" class="difflineplus">+function initCopiesAndFolder(identity) {</span>
<a href="#l33.97"></a><span id="l33.97">   // if we are editing an existing identity, use it...otherwise copy our values from the default identity</span>
<a href="#l33.98"></a><span id="l33.98">   var copiesAndFoldersIdentity = identity ? identity : gAccount.defaultIdentity;</span>
<a href="#l33.99"></a><span id="l33.99"> </span>
<a href="#l33.100"></a><span id="l33.100" class="difflineminus">-  document.getElementById('identity.fccFolder').value = copiesAndFoldersIdentity.fccFolder;</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineminus">-  document.getElementById('identity.draftFolder').value = copiesAndFoldersIdentity.draftFolder;</span>
<a href="#l33.102"></a><span id="l33.102" class="difflineminus">-  document.getElementById('identity.archiveFolder').value = copiesAndFoldersIdentity.archiveFolder;</span>
<a href="#l33.103"></a><span id="l33.103" class="difflineminus">-  document.getElementById('identity.stationeryFolder').value = copiesAndFoldersIdentity.stationeryFolder;</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineplus">+  document.getElementById(&quot;identity.fccFolder&quot;).value = copiesAndFoldersIdentity.fccFolder;</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineplus">+  document.getElementById(&quot;identity.draftFolder&quot;).value = copiesAndFoldersIdentity.draftFolder;</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineplus">+  document.getElementById(&quot;identity.archiveFolder&quot;).value = copiesAndFoldersIdentity.archiveFolder;</span>
<a href="#l33.107"></a><span id="l33.107" class="difflineplus">+  document.getElementById(&quot;identity.stationeryFolder&quot;).value = copiesAndFoldersIdentity.stationeryFolder;</span>
<a href="#l33.108"></a><span id="l33.108"> </span>
<a href="#l33.109"></a><span id="l33.109" class="difflineminus">-  document.getElementById('identity.fccFolderPickerMode').value = copiesAndFoldersIdentity.fccFolderPickerMode ? copiesAndFoldersIdentity.fccFolderPickerMode : 0;</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineminus">-  document.getElementById('identity.draftsFolderPickerMode').value = copiesAndFoldersIdentity.draftsFolderPickerMode ? copiesAndFoldersIdentity.draftsFolderPickerMode : 0;</span>
<a href="#l33.111"></a><span id="l33.111" class="difflineminus">-  document.getElementById('identity.archivesFolderPickerMode').value = copiesAndFoldersIdentity.archivesFolderPickerMode ? copiesAndFoldersIdentity.archivesFolderPickerMode : 0;</span>
<a href="#l33.112"></a><span id="l33.112" class="difflineminus">-  document.getElementById('identity.tmplFolderPickerMode').value = copiesAndFoldersIdentity.tmplFolderPickerMode ? copiesAndFoldersIdentity.tmplFolderPickerMode : 0;</span>
<a href="#l33.113"></a><span id="l33.113" class="difflineplus">+  document.getElementById(&quot;identity.fccFolderPickerMode&quot;).value = copiesAndFoldersIdentity.fccFolderPickerMode ? copiesAndFoldersIdentity.fccFolderPickerMode : 0;</span>
<a href="#l33.114"></a><span id="l33.114" class="difflineplus">+  document.getElementById(&quot;identity.draftsFolderPickerMode&quot;).value = copiesAndFoldersIdentity.draftsFolderPickerMode ? copiesAndFoldersIdentity.draftsFolderPickerMode : 0;</span>
<a href="#l33.115"></a><span id="l33.115" class="difflineplus">+  document.getElementById(&quot;identity.archivesFolderPickerMode&quot;).value = copiesAndFoldersIdentity.archivesFolderPickerMode ? copiesAndFoldersIdentity.archivesFolderPickerMode : 0;</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineplus">+  document.getElementById(&quot;identity.tmplFolderPickerMode&quot;).value = copiesAndFoldersIdentity.tmplFolderPickerMode ? copiesAndFoldersIdentity.tmplFolderPickerMode : 0;</span>
<a href="#l33.117"></a><span id="l33.117"> </span>
<a href="#l33.118"></a><span id="l33.118" class="difflineminus">-  document.getElementById('identity.doCc').checked = copiesAndFoldersIdentity.doCc;</span>
<a href="#l33.119"></a><span id="l33.119" class="difflineminus">-  document.getElementById('identity.doCcList').value = copiesAndFoldersIdentity.doCcList;</span>
<a href="#l33.120"></a><span id="l33.120" class="difflineminus">-  document.getElementById('identity.doBcc').checked = copiesAndFoldersIdentity.doBcc;</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineminus">-  document.getElementById('identity.doBccList').value = copiesAndFoldersIdentity.doBccList;</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineminus">-  document.getElementById('identity.doFcc').checked = copiesAndFoldersIdentity.doFcc;</span>
<a href="#l33.123"></a><span id="l33.123" class="difflineminus">-  document.getElementById('identity.fccReplyFollowsParent').checked = copiesAndFoldersIdentity.fccReplyFollowsParent;</span>
<a href="#l33.124"></a><span id="l33.124" class="difflineminus">-  document.getElementById('identity.showSaveMsgDlg').checked = copiesAndFoldersIdentity.showSaveMsgDlg;</span>
<a href="#l33.125"></a><span id="l33.125" class="difflineminus">-  document.getElementById('identity.archiveEnabled').checked = copiesAndFoldersIdentity.archiveEnabled;</span>
<a href="#l33.126"></a><span id="l33.126" class="difflineplus">+  document.getElementById(&quot;identity.doCc&quot;).checked = copiesAndFoldersIdentity.doCc;</span>
<a href="#l33.127"></a><span id="l33.127" class="difflineplus">+  document.getElementById(&quot;identity.doCcList&quot;).value = copiesAndFoldersIdentity.doCcList;</span>
<a href="#l33.128"></a><span id="l33.128" class="difflineplus">+  document.getElementById(&quot;identity.doBcc&quot;).checked = copiesAndFoldersIdentity.doBcc;</span>
<a href="#l33.129"></a><span id="l33.129" class="difflineplus">+  document.getElementById(&quot;identity.doBccList&quot;).value = copiesAndFoldersIdentity.doBccList;</span>
<a href="#l33.130"></a><span id="l33.130" class="difflineplus">+  document.getElementById(&quot;identity.doFcc&quot;).checked = copiesAndFoldersIdentity.doFcc;</span>
<a href="#l33.131"></a><span id="l33.131" class="difflineplus">+  document.getElementById(&quot;identity.fccReplyFollowsParent&quot;).checked = copiesAndFoldersIdentity.fccReplyFollowsParent;</span>
<a href="#l33.132"></a><span id="l33.132" class="difflineplus">+  document.getElementById(&quot;identity.showSaveMsgDlg&quot;).checked = copiesAndFoldersIdentity.showSaveMsgDlg;</span>
<a href="#l33.133"></a><span id="l33.133" class="difflineplus">+  document.getElementById(&quot;identity.archiveEnabled&quot;).checked = copiesAndFoldersIdentity.archiveEnabled;</span>
<a href="#l33.134"></a><span id="l33.134"> </span>
<a href="#l33.135"></a><span id="l33.135">   onInitCopiesAndFolders(); // am-copies.js method</span>
<a href="#l33.136"></a><span id="l33.136"> }</span>
<a href="#l33.137"></a><span id="l33.137"> </span>
<a href="#l33.138"></a><span id="l33.138" class="difflineminus">-function initCompositionAndAddressing(identity)</span>
<a href="#l33.139"></a><span id="l33.139" class="difflineminus">-{</span>
<a href="#l33.140"></a><span id="l33.140" class="difflineplus">+function initCompositionAndAddressing(identity) {</span>
<a href="#l33.141"></a><span id="l33.141">   // if we are editing an existing identity, use it...otherwise copy our values from the default identity</span>
<a href="#l33.142"></a><span id="l33.142">   var addressingIdentity = identity ? identity : gAccount.defaultIdentity;</span>
<a href="#l33.143"></a><span id="l33.143"> </span>
<a href="#l33.144"></a><span id="l33.144" class="difflineminus">-  document.getElementById('identity.directoryServer').value = addressingIdentity.directoryServer;</span>
<a href="#l33.145"></a><span id="l33.145" class="difflineminus">-  document.getElementById('identity.overrideGlobal_Pref').value = addressingIdentity.overrideGlobalPref;</span>
<a href="#l33.146"></a><span id="l33.146" class="difflineminus">-  let autoCompleteElement = document.getElementById('identity.autocompleteToMyDomain');</span>
<a href="#l33.147"></a><span id="l33.147" class="difflineplus">+  document.getElementById(&quot;identity.directoryServer&quot;).value = addressingIdentity.directoryServer;</span>
<a href="#l33.148"></a><span id="l33.148" class="difflineplus">+  document.getElementById(&quot;identity.overrideGlobal_Pref&quot;).value = addressingIdentity.overrideGlobalPref;</span>
<a href="#l33.149"></a><span id="l33.149" class="difflineplus">+  let autoCompleteElement = document.getElementById(&quot;identity.autocompleteToMyDomain&quot;);</span>
<a href="#l33.150"></a><span id="l33.150">   if (autoCompleteElement) // Thunderbird does not have this element.</span>
<a href="#l33.151"></a><span id="l33.151">     autoCompleteElement.checked = addressingIdentity.autocompleteToMyDomain;</span>
<a href="#l33.152"></a><span id="l33.152"> </span>
<a href="#l33.153"></a><span id="l33.153" class="difflineminus">-  document.getElementById('identity.composeHtml').checked = addressingIdentity.composeHtml;</span>
<a href="#l33.154"></a><span id="l33.154" class="difflineminus">-  document.getElementById('identity.autoQuote').checked = addressingIdentity.autoQuote;</span>
<a href="#l33.155"></a><span id="l33.155" class="difflineminus">-  document.getElementById('identity.replyOnTop').value = addressingIdentity.replyOnTop;</span>
<a href="#l33.156"></a><span id="l33.156" class="difflineminus">-  document.getElementById('identity.sig_bottom').value = addressingIdentity.sigBottom;</span>
<a href="#l33.157"></a><span id="l33.157" class="difflineminus">-  document.getElementById('identity.sig_on_reply').checked = addressingIdentity.sigOnReply;</span>
<a href="#l33.158"></a><span id="l33.158" class="difflineminus">-  document.getElementById('identity.sig_on_fwd').checked = addressingIdentity.sigOnForward;</span>
<a href="#l33.159"></a><span id="l33.159" class="difflineplus">+  document.getElementById(&quot;identity.composeHtml&quot;).checked = addressingIdentity.composeHtml;</span>
<a href="#l33.160"></a><span id="l33.160" class="difflineplus">+  document.getElementById(&quot;identity.autoQuote&quot;).checked = addressingIdentity.autoQuote;</span>
<a href="#l33.161"></a><span id="l33.161" class="difflineplus">+  document.getElementById(&quot;identity.replyOnTop&quot;).value = addressingIdentity.replyOnTop;</span>
<a href="#l33.162"></a><span id="l33.162" class="difflineplus">+  document.getElementById(&quot;identity.sig_bottom&quot;).value = addressingIdentity.sigBottom;</span>
<a href="#l33.163"></a><span id="l33.163" class="difflineplus">+  document.getElementById(&quot;identity.sig_on_reply&quot;).checked = addressingIdentity.sigOnReply;</span>
<a href="#l33.164"></a><span id="l33.164" class="difflineplus">+  document.getElementById(&quot;identity.sig_on_fwd&quot;).checked = addressingIdentity.sigOnForward;</span>
<a href="#l33.165"></a><span id="l33.165"> </span>
<a href="#l33.166"></a><span id="l33.166">   onInitCompositionAndAddressing(); // am-addressing.js method</span>
<a href="#l33.167"></a><span id="l33.167"> }</span>
<a href="#l33.168"></a><span id="l33.168"> </span>
<a href="#l33.169"></a><span id="l33.169" class="difflineminus">-function onOk(event)</span>
<a href="#l33.170"></a><span id="l33.170" class="difflineminus">-{</span>
<a href="#l33.171"></a><span id="l33.171" class="difflineplus">+function onOk(event) {</span>
<a href="#l33.172"></a><span id="l33.172">   if (!validEmailAddress()) {</span>
<a href="#l33.173"></a><span id="l33.173">     event.preventDefault();</span>
<a href="#l33.174"></a><span id="l33.174">     return;</span>
<a href="#l33.175"></a><span id="l33.175">   }</span>
<a href="#l33.176"></a><span id="l33.176"> </span>
<a href="#l33.177"></a><span id="l33.177">   // if we are adding a new identity, create an identity, set the fields and add it to the</span>
<a href="#l33.178"></a><span id="l33.178">   // account.</span>
<a href="#l33.179"></a><span id="l33.179" class="difflineminus">-  if (!gIdentity)</span>
<a href="#l33.180"></a><span id="l33.180" class="difflineminus">-  {</span>
<a href="#l33.181"></a><span id="l33.181" class="difflineplus">+  if (!gIdentity) {</span>
<a href="#l33.182"></a><span id="l33.182">     // ask the account manager to create a new identity for us</span>
<a href="#l33.183"></a><span id="l33.183">     gIdentity = MailServices.accounts.createIdentity();</span>
<a href="#l33.184"></a><span id="l33.184"> </span>
<a href="#l33.185"></a><span id="l33.185">     // copy in the default identity settings so we inherit lots of stuff like the default drafts folder, etc.</span>
<a href="#l33.186"></a><span id="l33.186">     gIdentity.copy(gAccount.defaultIdentity);</span>
<a href="#l33.187"></a><span id="l33.187"> </span>
<a href="#l33.188"></a><span id="l33.188">     // assume the identity is valid by default?</span>
<a href="#l33.189"></a><span id="l33.189">     gIdentity.valid = true;</span>
<a href="#l33.190"></a><span id="l33.190" class="difflineat">@@ -165,109 +159,101 @@ function onOk(event)</span>
<a href="#l33.191"></a><span id="l33.191">   saveCopiesAndFolderSettings(gIdentity);</span>
<a href="#l33.192"></a><span id="l33.192">   saveAddressingAndCompositionSettings(gIdentity);</span>
<a href="#l33.193"></a><span id="l33.193"> </span>
<a href="#l33.194"></a><span id="l33.194">   window.arguments[0].result = true;</span>
<a href="#l33.195"></a><span id="l33.195"> }</span>
<a href="#l33.196"></a><span id="l33.196"> </span>
<a href="#l33.197"></a><span id="l33.197"> // returns false and prompts the user if</span>
<a href="#l33.198"></a><span id="l33.198"> // the identity does not have an email address</span>
<a href="#l33.199"></a><span id="l33.199" class="difflineminus">-function validEmailAddress()</span>
<a href="#l33.200"></a><span id="l33.200" class="difflineminus">-{</span>
<a href="#l33.201"></a><span id="l33.201" class="difflineminus">-  var emailAddress = document.getElementById('identity.email').value;</span>
<a href="#l33.202"></a><span id="l33.202" class="difflineplus">+function validEmailAddress() {</span>
<a href="#l33.203"></a><span id="l33.203" class="difflineplus">+  var emailAddress = document.getElementById(&quot;identity.email&quot;).value;</span>
<a href="#l33.204"></a><span id="l33.204"> </span>
<a href="#l33.205"></a><span id="l33.205">   // quickly test for an @ sign to test for an email address. We don't have</span>
<a href="#l33.206"></a><span id="l33.206">   // to be anymore precise than that.</span>
<a href="#l33.207"></a><span id="l33.207" class="difflineminus">-  if (!emailAddress.includes(&quot;@&quot;))</span>
<a href="#l33.208"></a><span id="l33.208" class="difflineminus">-  {</span>
<a href="#l33.209"></a><span id="l33.209" class="difflineplus">+  if (!emailAddress.includes(&quot;@&quot;)) {</span>
<a href="#l33.210"></a><span id="l33.210">     // alert user about an invalid email address</span>
<a href="#l33.211"></a><span id="l33.211"> </span>
<a href="#l33.212"></a><span id="l33.212">     var prefBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l33.213"></a><span id="l33.213"> </span>
<a href="#l33.214"></a><span id="l33.214">     Services.prompt.alert(window, prefBundle.getString(&quot;identity-edit-req-title&quot;),</span>
<a href="#l33.215"></a><span id="l33.215">                           prefBundle.getString(&quot;identity-edit-req&quot;));</span>
<a href="#l33.216"></a><span id="l33.216">     return false;</span>
<a href="#l33.217"></a><span id="l33.217">   }</span>
<a href="#l33.218"></a><span id="l33.218"> </span>
<a href="#l33.219"></a><span id="l33.219">   return true;</span>
<a href="#l33.220"></a><span id="l33.220"> }</span>
<a href="#l33.221"></a><span id="l33.221"> </span>
<a href="#l33.222"></a><span id="l33.222" class="difflineminus">-function saveIdentitySettings(identity)</span>
<a href="#l33.223"></a><span id="l33.223" class="difflineminus">-{</span>
<a href="#l33.224"></a><span id="l33.224" class="difflineminus">-  if (identity)</span>
<a href="#l33.225"></a><span id="l33.225" class="difflineminus">-  {</span>
<a href="#l33.226"></a><span id="l33.226" class="difflineminus">-    let idLabel = document.getElementById('identity.label');</span>
<a href="#l33.227"></a><span id="l33.227" class="difflineplus">+function saveIdentitySettings(identity) {</span>
<a href="#l33.228"></a><span id="l33.228" class="difflineplus">+  if (identity) {</span>
<a href="#l33.229"></a><span id="l33.229" class="difflineplus">+    let idLabel = document.getElementById(&quot;identity.label&quot;);</span>
<a href="#l33.230"></a><span id="l33.230">     if (idLabel)</span>
<a href="#l33.231"></a><span id="l33.231">       identity.label = idLabel.value;</span>
<a href="#l33.232"></a><span id="l33.232" class="difflineminus">-    identity.fullName = document.getElementById('identity.fullName').value;</span>
<a href="#l33.233"></a><span id="l33.233" class="difflineminus">-    identity.email = document.getElementById('identity.email').value;</span>
<a href="#l33.234"></a><span id="l33.234" class="difflineminus">-    identity.replyTo = document.getElementById('identity.replyTo').value;</span>
<a href="#l33.235"></a><span id="l33.235" class="difflineminus">-    identity.organization = document.getElementById('identity.organization').value;</span>
<a href="#l33.236"></a><span id="l33.236" class="difflineminus">-    identity.attachSignature = document.getElementById('identity.attachSignature').checked;</span>
<a href="#l33.237"></a><span id="l33.237" class="difflineminus">-    identity.htmlSigText = document.getElementById('identity.htmlSigText').value;</span>
<a href="#l33.238"></a><span id="l33.238" class="difflineminus">-    identity.htmlSigFormat = document.getElementById('identity.htmlSigFormat').checked;</span>
<a href="#l33.239"></a><span id="l33.239" class="difflineplus">+    identity.fullName = document.getElementById(&quot;identity.fullName&quot;).value;</span>
<a href="#l33.240"></a><span id="l33.240" class="difflineplus">+    identity.email = document.getElementById(&quot;identity.email&quot;).value;</span>
<a href="#l33.241"></a><span id="l33.241" class="difflineplus">+    identity.replyTo = document.getElementById(&quot;identity.replyTo&quot;).value;</span>
<a href="#l33.242"></a><span id="l33.242" class="difflineplus">+    identity.organization = document.getElementById(&quot;identity.organization&quot;).value;</span>
<a href="#l33.243"></a><span id="l33.243" class="difflineplus">+    identity.attachSignature = document.getElementById(&quot;identity.attachSignature&quot;).checked;</span>
<a href="#l33.244"></a><span id="l33.244" class="difflineplus">+    identity.htmlSigText = document.getElementById(&quot;identity.htmlSigText&quot;).value;</span>
<a href="#l33.245"></a><span id="l33.245" class="difflineplus">+    identity.htmlSigFormat = document.getElementById(&quot;identity.htmlSigFormat&quot;).checked;</span>
<a href="#l33.246"></a><span id="l33.246"> </span>
<a href="#l33.247"></a><span id="l33.247" class="difflineminus">-    identity.attachVCard = document.getElementById('identity.attachVCard').checked;</span>
<a href="#l33.248"></a><span id="l33.248" class="difflineminus">-    identity.escapedVCard = document.getElementById('identity.escapedVCard').value;</span>
<a href="#l33.249"></a><span id="l33.249" class="difflineminus">-    identity.smtpServerKey = document.getElementById('identity.smtpServerKey').value;</span>
<a href="#l33.250"></a><span id="l33.250" class="difflineplus">+    identity.attachVCard = document.getElementById(&quot;identity.attachVCard&quot;).checked;</span>
<a href="#l33.251"></a><span id="l33.251" class="difflineplus">+    identity.escapedVCard = document.getElementById(&quot;identity.escapedVCard&quot;).value;</span>
<a href="#l33.252"></a><span id="l33.252" class="difflineplus">+    identity.smtpServerKey = document.getElementById(&quot;identity.smtpServerKey&quot;).value;</span>
<a href="#l33.253"></a><span id="l33.253"> </span>
<a href="#l33.254"></a><span id="l33.254" class="difflineminus">-    var attachSignaturePath = document.getElementById('identity.signature').value;</span>
<a href="#l33.255"></a><span id="l33.255" class="difflineplus">+    let attachSignaturePath = document.getElementById(&quot;identity.signature&quot;).value;</span>
<a href="#l33.256"></a><span id="l33.256">     identity.signature = null; // this is important so we don't accidentally inherit the default</span>
<a href="#l33.257"></a><span id="l33.257"> </span>
<a href="#l33.258"></a><span id="l33.258" class="difflineminus">-    if (attachSignaturePath)</span>
<a href="#l33.259"></a><span id="l33.259" class="difflineminus">-    {</span>
<a href="#l33.260"></a><span id="l33.260" class="difflineplus">+    if (attachSignaturePath) {</span>
<a href="#l33.261"></a><span id="l33.261">       // convert signature path back into a nsIFile</span>
<a href="#l33.262"></a><span id="l33.262">       var sfile = Cc[&quot;@mozilla.org/file/local;1&quot;]</span>
<a href="#l33.263"></a><span id="l33.263">                   .createInstance(Ci.nsIFile);</span>
<a href="#l33.264"></a><span id="l33.264">       sfile.initWithPath(attachSignaturePath);</span>
<a href="#l33.265"></a><span id="l33.265">       if (sfile.exists())</span>
<a href="#l33.266"></a><span id="l33.266">         identity.signature = sfile;</span>
<a href="#l33.267"></a><span id="l33.267">     }</span>
<a href="#l33.268"></a><span id="l33.268">   }</span>
<a href="#l33.269"></a><span id="l33.269"> }</span>
<a href="#l33.270"></a><span id="l33.270"> </span>
<a href="#l33.271"></a><span id="l33.271" class="difflineminus">-function saveCopiesAndFolderSettings(identity)</span>
<a href="#l33.272"></a><span id="l33.272" class="difflineminus">-{</span>
<a href="#l33.273"></a><span id="l33.273" class="difflineplus">+function saveCopiesAndFolderSettings(identity) {</span>
<a href="#l33.274"></a><span id="l33.274">   onSaveCopiesAndFolders(); // am-copies.js routine</span>
<a href="#l33.275"></a><span id="l33.275"> </span>
<a href="#l33.276"></a><span id="l33.276" class="difflineminus">-  identity.fccFolder =  document.getElementById('identity.fccFolder').value;</span>
<a href="#l33.277"></a><span id="l33.277" class="difflineminus">-  identity.draftFolder = document.getElementById('identity.draftFolder').value;</span>
<a href="#l33.278"></a><span id="l33.278" class="difflineminus">-  identity.archiveFolder = document.getElementById('identity.archiveFolder').value;</span>
<a href="#l33.279"></a><span id="l33.279" class="difflineminus">-  identity.stationeryFolder = document.getElementById('identity.stationeryFolder').value;</span>
<a href="#l33.280"></a><span id="l33.280" class="difflineminus">-  identity.fccFolderPickerMode = document.getElementById('identity.fccFolderPickerMode').value;</span>
<a href="#l33.281"></a><span id="l33.281" class="difflineminus">-  identity.draftsFolderPickerMode = document.getElementById('identity.draftsFolderPickerMode').value;</span>
<a href="#l33.282"></a><span id="l33.282" class="difflineminus">-  identity.archivesFolderPickerMode = document.getElementById('identity.archivesFolderPickerMode').value;</span>
<a href="#l33.283"></a><span id="l33.283" class="difflineminus">-  identity.tmplFolderPickerMode = document.getElementById('identity.tmplFolderPickerMode').value;</span>
<a href="#l33.284"></a><span id="l33.284" class="difflineminus">-  identity.doCc = document.getElementById('identity.doCc').checked;</span>
<a href="#l33.285"></a><span id="l33.285" class="difflineminus">-  identity.doCcList = document.getElementById('identity.doCcList').value;</span>
<a href="#l33.286"></a><span id="l33.286" class="difflineminus">-  identity.doBcc = document.getElementById('identity.doBcc').checked;</span>
<a href="#l33.287"></a><span id="l33.287" class="difflineminus">-  identity.doBccList = document.getElementById('identity.doBccList').value;</span>
<a href="#l33.288"></a><span id="l33.288" class="difflineminus">-  identity.doFcc = document.getElementById('identity.doFcc').checked;</span>
<a href="#l33.289"></a><span id="l33.289" class="difflineminus">-  identity.fccReplyFollowsParent = document.getElementById('identity.fccReplyFollowsParent').checked;</span>
<a href="#l33.290"></a><span id="l33.290" class="difflineminus">-  identity.showSaveMsgDlg = document.getElementById('identity.showSaveMsgDlg').checked;</span>
<a href="#l33.291"></a><span id="l33.291" class="difflineminus">-  identity.archiveEnabled = document.getElementById('identity.archiveEnabled').checked;</span>
<a href="#l33.292"></a><span id="l33.292" class="difflineplus">+  identity.fccFolder =  document.getElementById(&quot;identity.fccFolder&quot;).value;</span>
<a href="#l33.293"></a><span id="l33.293" class="difflineplus">+  identity.draftFolder = document.getElementById(&quot;identity.draftFolder&quot;).value;</span>
<a href="#l33.294"></a><span id="l33.294" class="difflineplus">+  identity.archiveFolder = document.getElementById(&quot;identity.archiveFolder&quot;).value;</span>
<a href="#l33.295"></a><span id="l33.295" class="difflineplus">+  identity.stationeryFolder = document.getElementById(&quot;identity.stationeryFolder&quot;).value;</span>
<a href="#l33.296"></a><span id="l33.296" class="difflineplus">+  identity.fccFolderPickerMode = document.getElementById(&quot;identity.fccFolderPickerMode&quot;).value;</span>
<a href="#l33.297"></a><span id="l33.297" class="difflineplus">+  identity.draftsFolderPickerMode = document.getElementById(&quot;identity.draftsFolderPickerMode&quot;).value;</span>
<a href="#l33.298"></a><span id="l33.298" class="difflineplus">+  identity.archivesFolderPickerMode = document.getElementById(&quot;identity.archivesFolderPickerMode&quot;).value;</span>
<a href="#l33.299"></a><span id="l33.299" class="difflineplus">+  identity.tmplFolderPickerMode = document.getElementById(&quot;identity.tmplFolderPickerMode&quot;).value;</span>
<a href="#l33.300"></a><span id="l33.300" class="difflineplus">+  identity.doCc = document.getElementById(&quot;identity.doCc&quot;).checked;</span>
<a href="#l33.301"></a><span id="l33.301" class="difflineplus">+  identity.doCcList = document.getElementById(&quot;identity.doCcList&quot;).value;</span>
<a href="#l33.302"></a><span id="l33.302" class="difflineplus">+  identity.doBcc = document.getElementById(&quot;identity.doBcc&quot;).checked;</span>
<a href="#l33.303"></a><span id="l33.303" class="difflineplus">+  identity.doBccList = document.getElementById(&quot;identity.doBccList&quot;).value;</span>
<a href="#l33.304"></a><span id="l33.304" class="difflineplus">+  identity.doFcc = document.getElementById(&quot;identity.doFcc&quot;).checked;</span>
<a href="#l33.305"></a><span id="l33.305" class="difflineplus">+  identity.fccReplyFollowsParent = document.getElementById(&quot;identity.fccReplyFollowsParent&quot;).checked;</span>
<a href="#l33.306"></a><span id="l33.306" class="difflineplus">+  identity.showSaveMsgDlg = document.getElementById(&quot;identity.showSaveMsgDlg&quot;).checked;</span>
<a href="#l33.307"></a><span id="l33.307" class="difflineplus">+  identity.archiveEnabled = document.getElementById(&quot;identity.archiveEnabled&quot;).checked;</span>
<a href="#l33.308"></a><span id="l33.308"> }</span>
<a href="#l33.309"></a><span id="l33.309"> </span>
<a href="#l33.310"></a><span id="l33.310" class="difflineminus">-function saveAddressingAndCompositionSettings(identity)</span>
<a href="#l33.311"></a><span id="l33.311" class="difflineminus">-{</span>
<a href="#l33.312"></a><span id="l33.312" class="difflineminus">-  identity.directoryServer = document.getElementById('identity.directoryServer').value;</span>
<a href="#l33.313"></a><span id="l33.313" class="difflineminus">-  identity.overrideGlobalPref = document.getElementById('identity.overrideGlobal_Pref').value == &quot;true&quot;;</span>
<a href="#l33.314"></a><span id="l33.314" class="difflineminus">-  let autoCompleteElement = document.getElementById('identity.autocompleteToMyDomain');</span>
<a href="#l33.315"></a><span id="l33.315" class="difflineplus">+function saveAddressingAndCompositionSettings(identity) {</span>
<a href="#l33.316"></a><span id="l33.316" class="difflineplus">+  identity.directoryServer = document.getElementById(&quot;identity.directoryServer&quot;).value;</span>
<a href="#l33.317"></a><span id="l33.317" class="difflineplus">+  identity.overrideGlobalPref = document.getElementById(&quot;identity.overrideGlobal_Pref&quot;).value == &quot;true&quot;;</span>
<a href="#l33.318"></a><span id="l33.318" class="difflineplus">+  let autoCompleteElement = document.getElementById(&quot;identity.autocompleteToMyDomain&quot;);</span>
<a href="#l33.319"></a><span id="l33.319">   if (autoCompleteElement) // Thunderbird does not have this element.</span>
<a href="#l33.320"></a><span id="l33.320">     identity.autocompleteToMyDomain = autoCompleteElement.checked;</span>
<a href="#l33.321"></a><span id="l33.321" class="difflineminus">-  identity.composeHtml = document.getElementById('identity.composeHtml').checked;</span>
<a href="#l33.322"></a><span id="l33.322" class="difflineminus">-  identity.autoQuote = document.getElementById('identity.autoQuote').checked;</span>
<a href="#l33.323"></a><span id="l33.323" class="difflineminus">-  identity.replyOnTop = document.getElementById('identity.replyOnTop').value;</span>
<a href="#l33.324"></a><span id="l33.324" class="difflineminus">-  identity.sigBottom = document.getElementById('identity.sig_bottom').value == 'true';</span>
<a href="#l33.325"></a><span id="l33.325" class="difflineminus">-  identity.sigOnReply = document.getElementById('identity.sig_on_reply').checked;</span>
<a href="#l33.326"></a><span id="l33.326" class="difflineminus">-  identity.sigOnForward = document.getElementById('identity.sig_on_fwd').checked;</span>
<a href="#l33.327"></a><span id="l33.327" class="difflineplus">+  identity.composeHtml = document.getElementById(&quot;identity.composeHtml&quot;).checked;</span>
<a href="#l33.328"></a><span id="l33.328" class="difflineplus">+  identity.autoQuote = document.getElementById(&quot;identity.autoQuote&quot;).checked;</span>
<a href="#l33.329"></a><span id="l33.329" class="difflineplus">+  identity.replyOnTop = document.getElementById(&quot;identity.replyOnTop&quot;).value;</span>
<a href="#l33.330"></a><span id="l33.330" class="difflineplus">+  identity.sigBottom = document.getElementById(&quot;identity.sig_bottom&quot;).value == &quot;true&quot;;</span>
<a href="#l33.331"></a><span id="l33.331" class="difflineplus">+  identity.sigOnReply = document.getElementById(&quot;identity.sig_on_reply&quot;).checked;</span>
<a href="#l33.332"></a><span id="l33.332" class="difflineplus">+  identity.sigOnForward = document.getElementById(&quot;identity.sig_on_fwd&quot;).checked;</span>
<a href="#l33.333"></a><span id="l33.333"> }</span>
<a href="#l33.334"></a><span id="l33.334"> </span>
<a href="#l33.335"></a><span id="l33.335" class="difflineminus">-function selectFile()</span>
<a href="#l33.336"></a><span id="l33.336" class="difflineminus">-{</span>
<a href="#l33.337"></a><span id="l33.337" class="difflineplus">+function selectFile() {</span>
<a href="#l33.338"></a><span id="l33.338">   const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l33.339"></a><span id="l33.339"> </span>
<a href="#l33.340"></a><span id="l33.340">   var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l33.341"></a><span id="l33.341">              .createInstance(nsIFilePicker);</span>
<a href="#l33.342"></a><span id="l33.342"> </span>
<a href="#l33.343"></a><span id="l33.343">   var prefBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l33.344"></a><span id="l33.344">   var title = prefBundle.getString(&quot;choosefile&quot;);</span>
<a href="#l33.345"></a><span id="l33.345">   fp.init(window, title, nsIFilePicker.modeOpen);</span>
<a href="#l33.346"></a><span id="l33.346" class="difflineat">@@ -283,143 +269,132 @@ function selectFile()</span>
<a href="#l33.347"></a><span id="l33.347">   fp.open(rv =&gt; {</span>
<a href="#l33.348"></a><span id="l33.348">     if (rv != nsIFilePicker.returnOK || !fp.file) {</span>
<a href="#l33.349"></a><span id="l33.349">       return;</span>
<a href="#l33.350"></a><span id="l33.350">     }</span>
<a href="#l33.351"></a><span id="l33.351">     document.getElementById(&quot;identity.signature&quot;).value = fp.file.path;</span>
<a href="#l33.352"></a><span id="l33.352">   });</span>
<a href="#l33.353"></a><span id="l33.353"> }</span>
<a href="#l33.354"></a><span id="l33.354"> </span>
<a href="#l33.355"></a><span id="l33.355" class="difflineminus">-function GetSigFolder()</span>
<a href="#l33.356"></a><span id="l33.356" class="difflineminus">-{</span>
<a href="#l33.357"></a><span id="l33.357" class="difflineplus">+function GetSigFolder() {</span>
<a href="#l33.358"></a><span id="l33.358">   var sigFolder = null;</span>
<a href="#l33.359"></a><span id="l33.359" class="difflineminus">-  try</span>
<a href="#l33.360"></a><span id="l33.360" class="difflineminus">-  {</span>
<a href="#l33.361"></a><span id="l33.361" class="difflineplus">+  try {</span>
<a href="#l33.362"></a><span id="l33.362">     var account = parent.getCurrentAccount();</span>
<a href="#l33.363"></a><span id="l33.363">     var identity = account.defaultIdentity;</span>
<a href="#l33.364"></a><span id="l33.364">     var signatureFile = identity.signature;</span>
<a href="#l33.365"></a><span id="l33.365"> </span>
<a href="#l33.366"></a><span id="l33.366" class="difflineminus">-    if (signatureFile)</span>
<a href="#l33.367"></a><span id="l33.367" class="difflineminus">-    {</span>
<a href="#l33.368"></a><span id="l33.368" class="difflineplus">+    if (signatureFile) {</span>
<a href="#l33.369"></a><span id="l33.369">       signatureFile = signatureFile.QueryInterface(Ci.nsIFile);</span>
<a href="#l33.370"></a><span id="l33.370">       sigFolder = signatureFile.parent;</span>
<a href="#l33.371"></a><span id="l33.371"> </span>
<a href="#l33.372"></a><span id="l33.372">       if (!sigFolder.exists())</span>
<a href="#l33.373"></a><span id="l33.373">           sigFolder = null;</span>
<a href="#l33.374"></a><span id="l33.374">     }</span>
<a href="#l33.375"></a><span id="l33.375" class="difflineminus">-  }</span>
<a href="#l33.376"></a><span id="l33.376" class="difflineminus">-  catch (ex) {</span>
<a href="#l33.377"></a><span id="l33.377" class="difflineplus">+  } catch (ex) {</span>
<a href="#l33.378"></a><span id="l33.378">       dump(&quot;failed to get signature folder..\n&quot;);</span>
<a href="#l33.379"></a><span id="l33.379">   }</span>
<a href="#l33.380"></a><span id="l33.380">   return sigFolder;</span>
<a href="#l33.381"></a><span id="l33.381"> }</span>
<a href="#l33.382"></a><span id="l33.382"> </span>
<a href="#l33.383"></a><span id="l33.383"> // Signature textbox is active unless option to select from file is checked.</span>
<a href="#l33.384"></a><span id="l33.384"> // If a signature is need to be attached, the associated items which</span>
<a href="#l33.385"></a><span id="l33.385"> // displays the absolute path to the signature (in a textbox) and the way</span>
<a href="#l33.386"></a><span id="l33.386"> // to select a new signature file (a button) are enabled. Otherwise, they</span>
<a href="#l33.387"></a><span id="l33.387"> // are disabled. Check to see if the attachSignature is locked to block</span>
<a href="#l33.388"></a><span id="l33.388"> // broadcasting events.</span>
<a href="#l33.389"></a><span id="l33.389" class="difflineminus">-function setupSignatureItems()</span>
<a href="#l33.390"></a><span id="l33.390" class="difflineminus">-{</span>
<a href="#l33.391"></a><span id="l33.391" class="difflineplus">+function setupSignatureItems() {</span>
<a href="#l33.392"></a><span id="l33.392">   var signature = document.getElementById(&quot;identity.signature&quot;);</span>
<a href="#l33.393"></a><span id="l33.393">   var browse = document.getElementById(&quot;identity.sigbrowsebutton&quot;);</span>
<a href="#l33.394"></a><span id="l33.394">   var htmlSigText = document.getElementById(&quot;identity.htmlSigText&quot;);</span>
<a href="#l33.395"></a><span id="l33.395">   var htmlSigFormat = document.getElementById(&quot;identity.htmlSigFormat&quot;);</span>
<a href="#l33.396"></a><span id="l33.396">   var attachSignature = document.getElementById(&quot;identity.attachSignature&quot;);</span>
<a href="#l33.397"></a><span id="l33.397">   var checked = attachSignature.checked;</span>
<a href="#l33.398"></a><span id="l33.398"> </span>
<a href="#l33.399"></a><span id="l33.399" class="difflineminus">-  if (checked)</span>
<a href="#l33.400"></a><span id="l33.400" class="difflineminus">-  {</span>
<a href="#l33.401"></a><span id="l33.401" class="difflineplus">+  if (checked) {</span>
<a href="#l33.402"></a><span id="l33.402">     htmlSigText.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l33.403"></a><span id="l33.403">     htmlSigFormat.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l33.404"></a><span id="l33.404" class="difflineminus">-  }</span>
<a href="#l33.405"></a><span id="l33.405" class="difflineminus">-  else</span>
<a href="#l33.406"></a><span id="l33.406" class="difflineminus">-  {</span>
<a href="#l33.407"></a><span id="l33.407" class="difflineplus">+  } else {</span>
<a href="#l33.408"></a><span id="l33.408">     htmlSigText.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l33.409"></a><span id="l33.409">     htmlSigFormat.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l33.410"></a><span id="l33.410">   }</span>
<a href="#l33.411"></a><span id="l33.411"> </span>
<a href="#l33.412"></a><span id="l33.412">   if (checked &amp;&amp; !getAccountValueIsLocked(signature))</span>
<a href="#l33.413"></a><span id="l33.413">     signature.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l33.414"></a><span id="l33.414">   else</span>
<a href="#l33.415"></a><span id="l33.415">     signature.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l33.416"></a><span id="l33.416"> </span>
<a href="#l33.417"></a><span id="l33.417">   if (checked &amp;&amp; !getAccountValueIsLocked(browse))</span>
<a href="#l33.418"></a><span id="l33.418">     browse.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l33.419"></a><span id="l33.419">   else</span>
<a href="#l33.420"></a><span id="l33.420">     browse.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l33.421"></a><span id="l33.421"> }</span>
<a href="#l33.422"></a><span id="l33.422"> </span>
<a href="#l33.423"></a><span id="l33.423" class="difflineminus">-function editVCardCallback(escapedVCardStr)</span>
<a href="#l33.424"></a><span id="l33.424" class="difflineminus">-{</span>
<a href="#l33.425"></a><span id="l33.425" class="difflineplus">+function editVCardCallback(escapedVCardStr) {</span>
<a href="#l33.426"></a><span id="l33.426">   var escapedVCard = document.getElementById(&quot;identity.escapedVCard&quot;);</span>
<a href="#l33.427"></a><span id="l33.427">   escapedVCard.value = escapedVCardStr;</span>
<a href="#l33.428"></a><span id="l33.428"> }</span>
<a href="#l33.429"></a><span id="l33.429"> </span>
<a href="#l33.430"></a><span id="l33.430" class="difflineminus">-function editVCard()</span>
<a href="#l33.431"></a><span id="l33.431" class="difflineminus">-{</span>
<a href="#l33.432"></a><span id="l33.432" class="difflineplus">+function editVCard() {</span>
<a href="#l33.433"></a><span id="l33.433">   var escapedVCard = document.getElementById(&quot;identity.escapedVCard&quot;);</span>
<a href="#l33.434"></a><span id="l33.434"> </span>
<a href="#l33.435"></a><span id="l33.435">   // read vCard hidden value from UI</span>
<a href="#l33.436"></a><span id="l33.436">   window.openDialog(&quot;chrome://messenger/content/addressbook/abNewCardDialog.xul&quot;,</span>
<a href="#l33.437"></a><span id="l33.437">                     &quot;&quot;,</span>
<a href="#l33.438"></a><span id="l33.438">                     &quot;chrome,modal,resizable=no,centerscreen&quot;,</span>
<a href="#l33.439"></a><span id="l33.439" class="difflineminus">-                    {escapedVCardStr:escapedVCard.value, okCallback:editVCardCallback,</span>
<a href="#l33.440"></a><span id="l33.440" class="difflineminus">-                     titleProperty:&quot;editVCardTitle&quot;, hideABPicker:true});</span>
<a href="#l33.441"></a><span id="l33.441" class="difflineplus">+                    {</span>
<a href="#l33.442"></a><span id="l33.442" class="difflineplus">+                      escapedVCardStr: escapedVCard.value,</span>
<a href="#l33.443"></a><span id="l33.443" class="difflineplus">+                      okCallback: editVCardCallback,</span>
<a href="#l33.444"></a><span id="l33.444" class="difflineplus">+                      titleProperty: &quot;editVCardTitle&quot;,</span>
<a href="#l33.445"></a><span id="l33.445" class="difflineplus">+                      hideABPicker: true,</span>
<a href="#l33.446"></a><span id="l33.446" class="difflineplus">+                    });</span>
<a href="#l33.447"></a><span id="l33.447"> }</span>
<a href="#l33.448"></a><span id="l33.448"> </span>
<a href="#l33.449"></a><span id="l33.449" class="difflineminus">-function getAccountForFolderPickerState()</span>
<a href="#l33.450"></a><span id="l33.450" class="difflineminus">-{</span>
<a href="#l33.451"></a><span id="l33.451" class="difflineplus">+function getAccountForFolderPickerState() {</span>
<a href="#l33.452"></a><span id="l33.452">   return gAccount;</span>
<a href="#l33.453"></a><span id="l33.453"> }</span>
<a href="#l33.454"></a><span id="l33.454"> </span>
<a href="#l33.455"></a><span id="l33.455"> /**</span>
<a href="#l33.456"></a><span id="l33.456">  * Build the SMTP server list for display.</span>
<a href="#l33.457"></a><span id="l33.457">  */</span>
<a href="#l33.458"></a><span id="l33.458" class="difflineminus">-function loadSMTPServerList()</span>
<a href="#l33.459"></a><span id="l33.459" class="difflineminus">-{</span>
<a href="#l33.460"></a><span id="l33.460" class="difflineplus">+function loadSMTPServerList() {</span>
<a href="#l33.461"></a><span id="l33.461">   var smtpServerList = document.getElementById(&quot;identity.smtpServerKey&quot;);</span>
<a href="#l33.462"></a><span id="l33.462">   let servers = MailServices.smtp.servers;</span>
<a href="#l33.463"></a><span id="l33.463">   let defaultServer = MailServices.smtp.defaultServer;</span>
<a href="#l33.464"></a><span id="l33.464">   let currentValue = smtpServerList.value;</span>
<a href="#l33.465"></a><span id="l33.465"> </span>
<a href="#l33.466"></a><span id="l33.466">   var smtpPopup = smtpServerList.menupopup;</span>
<a href="#l33.467"></a><span id="l33.467">   while (smtpPopup.lastChild.nodeName != &quot;menuseparator&quot;)</span>
<a href="#l33.468"></a><span id="l33.468">     smtpPopup.lastChild.remove();</span>
<a href="#l33.469"></a><span id="l33.469"> </span>
<a href="#l33.470"></a><span id="l33.470" class="difflineminus">-  while (servers.hasMoreElements())</span>
<a href="#l33.471"></a><span id="l33.471" class="difflineminus">-  {</span>
<a href="#l33.472"></a><span id="l33.472" class="difflineplus">+  while (servers.hasMoreElements()) {</span>
<a href="#l33.473"></a><span id="l33.473">     var server = servers.getNext();</span>
<a href="#l33.474"></a><span id="l33.474"> </span>
<a href="#l33.475"></a><span id="l33.475" class="difflineminus">-    if (server instanceof Ci.nsISmtpServer)</span>
<a href="#l33.476"></a><span id="l33.476" class="difflineminus">-    {</span>
<a href="#l33.477"></a><span id="l33.477" class="difflineplus">+    if (server instanceof Ci.nsISmtpServer) {</span>
<a href="#l33.478"></a><span id="l33.478">       var serverName = &quot;&quot;;</span>
<a href="#l33.479"></a><span id="l33.479">       if (server.description)</span>
<a href="#l33.480"></a><span id="l33.480" class="difflineminus">-        serverName = server.description + ' - ';</span>
<a href="#l33.481"></a><span id="l33.481" class="difflineplus">+        serverName = server.description + &quot; - &quot;;</span>
<a href="#l33.482"></a><span id="l33.482">       else if (server.username)</span>
<a href="#l33.483"></a><span id="l33.483" class="difflineminus">-        serverName = server.username + ' - ';</span>
<a href="#l33.484"></a><span id="l33.484" class="difflineplus">+        serverName = server.username + &quot; - &quot;;</span>
<a href="#l33.485"></a><span id="l33.485">       serverName += server.hostname;</span>
<a href="#l33.486"></a><span id="l33.486"> </span>
<a href="#l33.487"></a><span id="l33.487">       if (defaultServer.key == server.key)</span>
<a href="#l33.488"></a><span id="l33.488">         serverName += &quot; &quot; + document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l33.489"></a><span id="l33.489">                                     .getString(&quot;defaultServerTag&quot;);</span>
<a href="#l33.490"></a><span id="l33.490"> </span>
<a href="#l33.491"></a><span id="l33.491">       smtpServerList.appendItem(serverName, server.key);</span>
<a href="#l33.492"></a><span id="l33.492">     }</span>
<a href="#l33.493"></a><span id="l33.493">   }</span>
<a href="#l33.494"></a><span id="l33.494"> </span>
<a href="#l33.495"></a><span id="l33.495">   smtpServerList.value = currentValue;</span>
<a href="#l33.496"></a><span id="l33.496"> }</span>
<a href="#l33.497"></a><span id="l33.497"> </span>
<a href="#l33.498"></a><span id="l33.498"> /**</span>
<a href="#l33.499"></a><span id="l33.499">  * Open dialog for editing properties of currently selected SMTP server.</span>
<a href="#l33.500"></a><span id="l33.500">  */</span>
<a href="#l33.501"></a><span id="l33.501" class="difflineminus">-function editCurrentSMTP()</span>
<a href="#l33.502"></a><span id="l33.502" class="difflineminus">-{</span>
<a href="#l33.503"></a><span id="l33.503" class="difflineplus">+function editCurrentSMTP() {</span>
<a href="#l33.504"></a><span id="l33.504">   let smtpKey = document.getElementById(&quot;identity.smtpServerKey&quot;).value;</span>
<a href="#l33.505"></a><span id="l33.505">   let server = (smtpKey === &quot;&quot;) ? MailServices.smtp.defaultServer :</span>
<a href="#l33.506"></a><span id="l33.506">                                   MailServices.smtp.getServerByKey(smtpKey);</span>
<a href="#l33.507"></a><span id="l33.507"> </span>
<a href="#l33.508"></a><span id="l33.508">   let args = editSMTPServer(server);</span>
<a href="#l33.509"></a><span id="l33.509">   if (args.result)</span>
<a href="#l33.510"></a><span id="l33.510">     loadSMTPServerList();</span>
<a href="#l33.511"></a><span id="l33.511"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-junk.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-junk.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -1,24 +1,25 @@</span>
<a href="#l34.4"></a><span id="l34.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l34.5"></a><span id="l34.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l34.6"></a><span id="l34.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l34.7"></a><span id="l34.7" class="difflineminus">- * file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l34.8"></a><span id="l34.8" class="difflineminus">- */</span>
<a href="#l34.9"></a><span id="l34.9" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l34.10"></a><span id="l34.10" class="difflineplus">+</span>
<a href="#l34.11"></a><span id="l34.11" class="difflineplus">+/* import-globals-from AccountManager.js */</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineplus">+</span>
<a href="#l34.13"></a><span id="l34.13"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l34.14"></a><span id="l34.14"> var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l34.15"></a><span id="l34.15"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l34.16"></a><span id="l34.16"> </span>
<a href="#l34.17"></a><span id="l34.17"> var gDeferredToAccount = &quot;&quot;;</span>
<a href="#l34.18"></a><span id="l34.18"> </span>
<a href="#l34.19"></a><span id="l34.19" class="difflineminus">-function onInit(aPageId, aServerId)</span>
<a href="#l34.20"></a><span id="l34.20" class="difflineminus">-{</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineplus">+function onInit(aPageId, aServerId) {</span>
<a href="#l34.22"></a><span id="l34.22">   // manually adjust several pref UI elements</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineminus">-  document.getElementById('server.spamLevel.visible').setAttribute(&quot;checked&quot;,</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineminus">-    document.getElementById('server.spamLevel').value &gt; 0);</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+  document.getElementById(&quot;server.spamLevel.visible&quot;).setAttribute(&quot;checked&quot;,</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineplus">+    document.getElementById(&quot;server.spamLevel&quot;).value &gt; 0);</span>
<a href="#l34.27"></a><span id="l34.27"> </span>
<a href="#l34.28"></a><span id="l34.28">   let deferredToURI = null;</span>
<a href="#l34.29"></a><span id="l34.29">   if (gDeferredToAccount)</span>
<a href="#l34.30"></a><span id="l34.30">     deferredToURI = MailServices.accounts</span>
<a href="#l34.31"></a><span id="l34.31">                                 .getAccount(gDeferredToAccount)</span>
<a href="#l34.32"></a><span id="l34.32">                                 .incomingServer.serverURI;</span>
<a href="#l34.33"></a><span id="l34.33"> </span>
<a href="#l34.34"></a><span id="l34.34">   let spamActionTargetAccountElement =</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineat">@@ -102,54 +103,50 @@ function onInit(aPageId, aServerId)</span>
<a href="#l34.36"></a><span id="l34.36">     serverFilterList.selectedIndex = 0;</span>
<a href="#l34.37"></a><span id="l34.37"> </span>
<a href="#l34.38"></a><span id="l34.38">   // enable or disable the useServerFilter checkbox</span>
<a href="#l34.39"></a><span id="l34.39">   onCheckItem(&quot;useServerFilterList&quot;, [&quot;server.useServerFilter&quot;]);</span>
<a href="#l34.40"></a><span id="l34.40"> </span>
<a href="#l34.41"></a><span id="l34.41">   updateJunkTargetsAndRetention();</span>
<a href="#l34.42"></a><span id="l34.42"> }</span>
<a href="#l34.43"></a><span id="l34.43"> </span>
<a href="#l34.44"></a><span id="l34.44" class="difflineminus">-function onPreInit(account, accountValues)</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineminus">-{</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+function onPreInit(account, accountValues) {</span>
<a href="#l34.47"></a><span id="l34.47">   if (getAccountValue(account, accountValues, &quot;server&quot;, &quot;type&quot;, null, false) == &quot;pop3&quot;)</span>
<a href="#l34.48"></a><span id="l34.48">     gDeferredToAccount = getAccountValue(account, accountValues,</span>
<a href="#l34.49"></a><span id="l34.49">                                          &quot;pop3&quot;, &quot;deferredToAccount&quot;,</span>
<a href="#l34.50"></a><span id="l34.50">                                          null, false);</span>
<a href="#l34.51"></a><span id="l34.51"> </span>
<a href="#l34.52"></a><span id="l34.52">   buildServerFilterMenuList();</span>
<a href="#l34.53"></a><span id="l34.53"> }</span>
<a href="#l34.54"></a><span id="l34.54"> </span>
<a href="#l34.55"></a><span id="l34.55"> /**</span>
<a href="#l34.56"></a><span id="l34.56">  * Called when someone checks or unchecks the adaptive junk mail checkbox.</span>
<a href="#l34.57"></a><span id="l34.57">  * set the value of the hidden element accordingly</span>
<a href="#l34.58"></a><span id="l34.58">  *</span>
<a href="#l34.59"></a><span id="l34.59">  * @param aValue  the boolean value of the checkbox</span>
<a href="#l34.60"></a><span id="l34.60">  */</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineminus">-function updateSpamLevel(aValue)</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineminus">-{</span>
<a href="#l34.63"></a><span id="l34.63" class="difflineminus">-  document.getElementById('server.spamLevel').value = aValue ? 100 : 0;</span>
<a href="#l34.64"></a><span id="l34.64" class="difflineplus">+function updateSpamLevel(aValue) {</span>
<a href="#l34.65"></a><span id="l34.65" class="difflineplus">+  document.getElementById(&quot;server.spamLevel&quot;).value = aValue ? 100 : 0;</span>
<a href="#l34.66"></a><span id="l34.66">   onAdaptiveJunkToggle();</span>
<a href="#l34.67"></a><span id="l34.67"> }</span>
<a href="#l34.68"></a><span id="l34.68"> </span>
<a href="#l34.69"></a><span id="l34.69"> /**</span>
<a href="#l34.70"></a><span id="l34.70">  * Propagate changes to the server filter menu list back to</span>
<a href="#l34.71"></a><span id="l34.71">  * our hidden wsm element.</span>
<a href="#l34.72"></a><span id="l34.72">  */</span>
<a href="#l34.73"></a><span id="l34.73" class="difflineminus">-function onServerFilterListChange()</span>
<a href="#l34.74"></a><span id="l34.74" class="difflineminus">-{</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineminus">-  document.getElementById('server.serverFilterName').value =</span>
<a href="#l34.76"></a><span id="l34.76" class="difflineplus">+function onServerFilterListChange() {</span>
<a href="#l34.77"></a><span id="l34.77" class="difflineplus">+  document.getElementById(&quot;server.serverFilterName&quot;).value =</span>
<a href="#l34.78"></a><span id="l34.78">     document.getElementById(&quot;useServerFilterList&quot;).value;</span>
<a href="#l34.79"></a><span id="l34.79"> }</span>
<a href="#l34.80"></a><span id="l34.80"> </span>
<a href="#l34.81"></a><span id="l34.81"> /**</span>
<a href="#l34.82"></a><span id="l34.82">  * Called when someone checks or unchecks the adaptive junk mail checkbox.</span>
<a href="#l34.83"></a><span id="l34.83">  * We need to enable or disable the whitelist accordingly.</span>
<a href="#l34.84"></a><span id="l34.84">  */</span>
<a href="#l34.85"></a><span id="l34.85" class="difflineminus">-function onAdaptiveJunkToggle()</span>
<a href="#l34.86"></a><span id="l34.86" class="difflineminus">-{</span>
<a href="#l34.87"></a><span id="l34.87" class="difflineplus">+function onAdaptiveJunkToggle() {</span>
<a href="#l34.88"></a><span id="l34.88">   onCheckItem(&quot;whiteListAbURI&quot;, [&quot;server.spamLevel.visible&quot;]);</span>
<a href="#l34.89"></a><span id="l34.89">   onCheckItem(&quot;whiteListLabel&quot;, [&quot;server.spamLevel.visible&quot;]);</span>
<a href="#l34.90"></a><span id="l34.90"> </span>
<a href="#l34.91"></a><span id="l34.91">   // Enable/disable individual listbox rows.</span>
<a href="#l34.92"></a><span id="l34.92">   // Setting enable/disable on the parent listbox does not seem to work.</span>
<a href="#l34.93"></a><span id="l34.93">   let wList = document.getElementById(&quot;whiteListAbURI&quot;);</span>
<a href="#l34.94"></a><span id="l34.94">   let wListDisabled = wList.disabled;</span>
<a href="#l34.95"></a><span id="l34.95"> </span>
<a href="#l34.96"></a><span id="l34.96" class="difflineat">@@ -173,43 +170,40 @@ function updateJunkTargetsAndRetention()</span>
<a href="#l34.97"></a><span id="l34.97">   updateJunkRetention();</span>
<a href="#l34.98"></a><span id="l34.98"> }</span>
<a href="#l34.99"></a><span id="l34.99"> </span>
<a href="#l34.100"></a><span id="l34.100"> /**</span>
<a href="#l34.101"></a><span id="l34.101">  * Enable/disable the folder pickers depending on which radio item is selected.</span>
<a href="#l34.102"></a><span id="l34.102">  */</span>
<a href="#l34.103"></a><span id="l34.103"> function updateJunkTargets() {</span>
<a href="#l34.104"></a><span id="l34.104">   onCheckItem(&quot;actionTargetAccount&quot;, [&quot;server.moveOnSpam&quot;, &quot;moveTargetMode0&quot;]);</span>
<a href="#l34.105"></a><span id="l34.105" class="difflineminus">-  onCheckItem(&quot;actionTargetFolder&quot;,  [&quot;server.moveOnSpam&quot;, &quot;moveTargetMode1&quot;]);</span>
<a href="#l34.106"></a><span id="l34.106" class="difflineplus">+  onCheckItem(&quot;actionTargetFolder&quot;, [&quot;server.moveOnSpam&quot;, &quot;moveTargetMode1&quot;]);</span>
<a href="#l34.107"></a><span id="l34.107"> }</span>
<a href="#l34.108"></a><span id="l34.108"> </span>
<a href="#l34.109"></a><span id="l34.109"> /**</span>
<a href="#l34.110"></a><span id="l34.110">  * Enable/disable the junk deletion interval depending on the state</span>
<a href="#l34.111"></a><span id="l34.111">  * of the controlling checkbox.</span>
<a href="#l34.112"></a><span id="l34.112">  */</span>
<a href="#l34.113"></a><span id="l34.113"> function updateJunkRetention() {</span>
<a href="#l34.114"></a><span id="l34.114">   onCheckItem(&quot;server.purgeSpamInterval&quot;, [&quot;server.purgeSpam&quot;, &quot;server.moveOnSpam&quot;]);</span>
<a href="#l34.115"></a><span id="l34.115"> }</span>
<a href="#l34.116"></a><span id="l34.116"> </span>
<a href="#l34.117"></a><span id="l34.117" class="difflineminus">-function onSave()</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineminus">-{</span>
<a href="#l34.119"></a><span id="l34.119" class="difflineplus">+function onSave() {</span>
<a href="#l34.120"></a><span id="l34.120">   onSaveWhiteList();</span>
<a href="#l34.121"></a><span id="l34.121"> }</span>
<a href="#l34.122"></a><span id="l34.122"> </span>
<a href="#l34.123"></a><span id="l34.123"> /**</span>
<a href="#l34.124"></a><span id="l34.124">  * Propagate changes to the whitelist menu list back to</span>
<a href="#l34.125"></a><span id="l34.125">  * our hidden wsm element.</span>
<a href="#l34.126"></a><span id="l34.126">  */</span>
<a href="#l34.127"></a><span id="l34.127" class="difflineminus">-function onSaveWhiteList()</span>
<a href="#l34.128"></a><span id="l34.128" class="difflineminus">-{</span>
<a href="#l34.129"></a><span id="l34.129" class="difflineplus">+function onSaveWhiteList() {</span>
<a href="#l34.130"></a><span id="l34.130">   var wList = document.getElementById(&quot;whiteListAbURI&quot;);</span>
<a href="#l34.131"></a><span id="l34.131">   var wlArray = [];</span>
<a href="#l34.132"></a><span id="l34.132"> </span>
<a href="#l34.133"></a><span id="l34.133" class="difflineminus">-  for (var i = 0; i &lt; wList.getRowCount(); i++)</span>
<a href="#l34.134"></a><span id="l34.134" class="difflineminus">-  {</span>
<a href="#l34.135"></a><span id="l34.135" class="difflineplus">+  for (let i = 0; i &lt; wList.getRowCount(); i++) {</span>
<a href="#l34.136"></a><span id="l34.136">     // Due to bug 448582, do not trust any properties of the listitems</span>
<a href="#l34.137"></a><span id="l34.137">     // as they may not return the right value or may even not exist.</span>
<a href="#l34.138"></a><span id="l34.138">     // Always get the attributes only.</span>
<a href="#l34.139"></a><span id="l34.139">     var wlNode = wList.getItemAtIndex(i);</span>
<a href="#l34.140"></a><span id="l34.140">     if (wlNode.firstChild.getAttribute(&quot;checked&quot;) == &quot;true&quot;) {</span>
<a href="#l34.141"></a><span id="l34.141">       let abURI = wlNode.getAttribute(&quot;value&quot;);</span>
<a href="#l34.142"></a><span id="l34.142">       wlArray.push(abURI);</span>
<a href="#l34.143"></a><span id="l34.143">     }</span>
<a href="#l34.144"></a><span id="l34.144" class="difflineat">@@ -218,42 +212,39 @@ function onSaveWhiteList()</span>
<a href="#l34.145"></a><span id="l34.145">   document.getElementById(&quot;server.whiteListAbURI&quot;).setAttribute(&quot;value&quot;, wlValue);</span>
<a href="#l34.146"></a><span id="l34.146">   document.getElementById(&quot;server.useWhiteList&quot;).checked = (wlValue != &quot;&quot;);</span>
<a href="#l34.147"></a><span id="l34.147"> }</span>
<a href="#l34.148"></a><span id="l34.148"> </span>
<a href="#l34.149"></a><span id="l34.149"> /**</span>
<a href="#l34.150"></a><span id="l34.150">  * Called when a new value is chosen in one of the junk target folder pickers.</span>
<a href="#l34.151"></a><span id="l34.151">  * Sets the menu label according to the folder name.</span>
<a href="#l34.152"></a><span id="l34.152">  */</span>
<a href="#l34.153"></a><span id="l34.153" class="difflineminus">-function onActionTargetChange(aEvent, aWSMElementId)</span>
<a href="#l34.154"></a><span id="l34.154" class="difflineminus">-{</span>
<a href="#l34.155"></a><span id="l34.155" class="difflineplus">+function onActionTargetChange(aEvent, aWSMElementId) {</span>
<a href="#l34.156"></a><span id="l34.156">   let folder = aEvent.target._folder;</span>
<a href="#l34.157"></a><span id="l34.157">   document.getElementById(aWSMElementId).value = folder.URI;</span>
<a href="#l34.158"></a><span id="l34.158">   document.getElementById(&quot;actionFolderPopup&quot;).selectFolder(folder);</span>
<a href="#l34.159"></a><span id="l34.159"> }</span>
<a href="#l34.160"></a><span id="l34.160"> </span>
<a href="#l34.161"></a><span id="l34.161"> /**</span>
<a href="#l34.162"></a><span id="l34.162">  * Enumerates over the &quot;ISPDL&quot; directories, calling buildServerFilterListFromDir</span>
<a href="#l34.163"></a><span id="l34.163">  * for each one.</span>
<a href="#l34.164"></a><span id="l34.164">  */</span>
<a href="#l34.165"></a><span id="l34.165" class="difflineminus">-function buildServerFilterMenuList()</span>
<a href="#l34.166"></a><span id="l34.166" class="difflineminus">-{</span>
<a href="#l34.167"></a><span id="l34.167" class="difflineplus">+function buildServerFilterMenuList() {</span>
<a href="#l34.168"></a><span id="l34.168">   const KEY_ISP_DIRECTORY_LIST = &quot;ISPDL&quot;;</span>
<a href="#l34.169"></a><span id="l34.169">   let ispHeaderList = document.getElementById(&quot;useServerFilterList&quot;);</span>
<a href="#l34.170"></a><span id="l34.170"> </span>
<a href="#l34.171"></a><span id="l34.171">   // Ensure the menulist is empty.</span>
<a href="#l34.172"></a><span id="l34.172">   ispHeaderList.removeAllItems();</span>
<a href="#l34.173"></a><span id="l34.173"> </span>
<a href="#l34.174"></a><span id="l34.174">   // Now walk through the isp directories looking for sfd files.</span>
<a href="#l34.175"></a><span id="l34.175">   let ispDirectories = Services.dirsvc.get(KEY_ISP_DIRECTORY_LIST,</span>
<a href="#l34.176"></a><span id="l34.176">                                            Ci.nsISimpleEnumerator);</span>
<a href="#l34.177"></a><span id="l34.177"> </span>
<a href="#l34.178"></a><span id="l34.178">   let menuEntries = [];</span>
<a href="#l34.179"></a><span id="l34.179" class="difflineminus">-  while (ispDirectories.hasMoreElements())</span>
<a href="#l34.180"></a><span id="l34.180" class="difflineminus">-  {</span>
<a href="#l34.181"></a><span id="l34.181" class="difflineplus">+  while (ispDirectories.hasMoreElements()) {</span>
<a href="#l34.182"></a><span id="l34.182">     let ispDirectory = ispDirectories.getNext()</span>
<a href="#l34.183"></a><span id="l34.183">                                      .QueryInterface(Ci.nsIFile);</span>
<a href="#l34.184"></a><span id="l34.184">     if (ispDirectory)</span>
<a href="#l34.185"></a><span id="l34.185">       menuEntries.push.apply(menuEntries, buildServerFilterListFromDir(ispDirectory, menuEntries));</span>
<a href="#l34.186"></a><span id="l34.186">   }</span>
<a href="#l34.187"></a><span id="l34.187"> </span>
<a href="#l34.188"></a><span id="l34.188">   menuEntries.sort((a, b) =&gt; a.localeCompare(b));</span>
<a href="#l34.189"></a><span id="l34.189">   for (let entry of menuEntries) {</span>
<a href="#l34.190"></a><span id="l34.190" class="difflineat">@@ -264,36 +255,34 @@ function buildServerFilterMenuList()</span>
<a href="#l34.191"></a><span id="l34.191"> /**</span>
<a href="#l34.192"></a><span id="l34.192">  * Helper function called by buildServerFilterMenuList. Enumerates over the</span>
<a href="#l34.193"></a><span id="l34.193">  * passed in directory looking for .sfd files. For each entry found, it gets</span>
<a href="#l34.194"></a><span id="l34.194">  * appended to the menu list.</span>
<a href="#l34.195"></a><span id="l34.195">  *</span>
<a href="#l34.196"></a><span id="l34.196">  * @param aDir              directory to look for .sfd files</span>
<a href="#l34.197"></a><span id="l34.197">  * @param aExistingEntries  Filter names already found.</span>
<a href="#l34.198"></a><span id="l34.198">  */</span>
<a href="#l34.199"></a><span id="l34.199" class="difflineminus">-function buildServerFilterListFromDir(aDir, aExistingEntries)</span>
<a href="#l34.200"></a><span id="l34.200" class="difflineminus">-{</span>
<a href="#l34.201"></a><span id="l34.201" class="difflineplus">+function buildServerFilterListFromDir(aDir, aExistingEntries) {</span>
<a href="#l34.202"></a><span id="l34.202">   let newEntries = [];</span>
<a href="#l34.203"></a><span id="l34.203">   // Now iterate over each file in the directory looking for .sfd files.</span>
<a href="#l34.204"></a><span id="l34.204">   const kSuffix = &quot;.sfd&quot;;</span>
<a href="#l34.205"></a><span id="l34.205">   let entries = aDir.directoryEntries</span>
<a href="#l34.206"></a><span id="l34.206">                     .QueryInterface(Ci.nsIDirectoryEnumerator);</span>
<a href="#l34.207"></a><span id="l34.207"> </span>
<a href="#l34.208"></a><span id="l34.208">   while (entries.hasMoreElements()) {</span>
<a href="#l34.209"></a><span id="l34.209">     let entry = entries.nextFile;</span>
<a href="#l34.210"></a><span id="l34.210">     // we only care about files that end in .sfd</span>
<a href="#l34.211"></a><span id="l34.211">     if (entry.isFile() &amp;&amp; entry.leafName.endsWith(kSuffix)) {</span>
<a href="#l34.212"></a><span id="l34.212">       let fileName = entry.leafName.slice(0, -kSuffix.length);</span>
<a href="#l34.213"></a><span id="l34.213">       // If we've already added an item with this name, then don't add it again.</span>
<a href="#l34.214"></a><span id="l34.214" class="difflineminus">-      if (aExistingEntries.indexOf(fileName) == -1)</span>
<a href="#l34.215"></a><span id="l34.215" class="difflineplus">+      if (!aExistingEntries.includes(fileName))</span>
<a href="#l34.216"></a><span id="l34.216">         newEntries.push(fileName);</span>
<a href="#l34.217"></a><span id="l34.217">     }</span>
<a href="#l34.218"></a><span id="l34.218">   }</span>
<a href="#l34.219"></a><span id="l34.219">   return newEntries;</span>
<a href="#l34.220"></a><span id="l34.220"> }</span>
<a href="#l34.221"></a><span id="l34.221"> </span>
<a href="#l34.222"></a><span id="l34.222"> /**</span>
<a href="#l34.223"></a><span id="l34.223">  * Open the Preferences dialog on the Junk settings tab.</span>
<a href="#l34.224"></a><span id="l34.224">  */</span>
<a href="#l34.225"></a><span id="l34.225" class="difflineminus">-function showGlobalJunkPrefs()</span>
<a href="#l34.226"></a><span id="l34.226" class="difflineminus">-{</span>
<a href="#l34.227"></a><span id="l34.227" class="difflineplus">+function showGlobalJunkPrefs() {</span>
<a href="#l34.228"></a><span id="l34.228">   openPrefsFromAccountManager(&quot;paneSecurity&quot;, &quot;junkTab&quot;, null, &quot;junk_pane&quot;);</span>
<a href="#l34.229"></a><span id="l34.229"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-main.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-main.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -1,51 +1,50 @@</span>
<a href="#l35.4"></a><span id="l35.4"> /* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l35.5"></a><span id="l35.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l35.6"></a><span id="l35.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l35.7"></a><span id="l35.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l35.8"></a><span id="l35.8"> </span>
<a href="#l35.9"></a><span id="l35.9" class="difflineplus">+/* import-globals-from am-identity-edit.js */</span>
<a href="#l35.10"></a><span id="l35.10" class="difflineplus">+</span>
<a href="#l35.11"></a><span id="l35.11"> var gAccount;</span>
<a href="#l35.12"></a><span id="l35.12"> </span>
<a href="#l35.13"></a><span id="l35.13" class="difflineminus">-function onInit(aPageId, aServerId)</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineminus">-{</span>
<a href="#l35.15"></a><span id="l35.15" class="difflineplus">+function onInit(aPageId, aServerId) {</span>
<a href="#l35.16"></a><span id="l35.16">   var accountName = document.getElementById(&quot;server.prettyName&quot;);</span>
<a href="#l35.17"></a><span id="l35.17">   var title = document.querySelector(&quot;#am-main-title .dialogheader-title&quot;);</span>
<a href="#l35.18"></a><span id="l35.18">   var defaultTitle = title.getAttribute(&quot;defaultTitle&quot;);</span>
<a href="#l35.19"></a><span id="l35.19">   var titleValue;</span>
<a href="#l35.20"></a><span id="l35.20"> </span>
<a href="#l35.21"></a><span id="l35.21" class="difflineminus">-  if(accountName.value)</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineminus">-    titleValue = defaultTitle+&quot; - &lt;&quot;+accountName.value+&quot;&gt;&quot;;</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineplus">+  if (accountName.value)</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+    titleValue = defaultTitle + &quot; - &lt;&quot; + accountName.value + &quot;&gt;&quot;;</span>
<a href="#l35.25"></a><span id="l35.25">   else</span>
<a href="#l35.26"></a><span id="l35.26">     titleValue = defaultTitle;</span>
<a href="#l35.27"></a><span id="l35.27"> </span>
<a href="#l35.28"></a><span id="l35.28">   title.setAttribute(&quot;value&quot;, titleValue);</span>
<a href="#l35.29"></a><span id="l35.29">   document.title = titleValue;</span>
<a href="#l35.30"></a><span id="l35.30"> </span>
<a href="#l35.31"></a><span id="l35.31">   setupSignatureItems();</span>
<a href="#l35.32"></a><span id="l35.32"> }</span>
<a href="#l35.33"></a><span id="l35.33"> </span>
<a href="#l35.34"></a><span id="l35.34" class="difflineminus">-function onPreInit(account, accountValues)</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineminus">-{</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+function onPreInit(account, accountValues) {</span>
<a href="#l35.37"></a><span id="l35.37">   gAccount = account;</span>
<a href="#l35.38"></a><span id="l35.38">   loadSMTPServerList();</span>
<a href="#l35.39"></a><span id="l35.39"> }</span>
<a href="#l35.40"></a><span id="l35.40"> </span>
<a href="#l35.41"></a><span id="l35.41" class="difflineminus">-function manageIdentities()</span>
<a href="#l35.42"></a><span id="l35.42" class="difflineminus">-{</span>
<a href="#l35.43"></a><span id="l35.43" class="difflineplus">+function manageIdentities() {</span>
<a href="#l35.44"></a><span id="l35.44">   // We want to save the current identity information before bringing up the multiple identities</span>
<a href="#l35.45"></a><span id="l35.45">   // UI. This ensures that the changes are reflected in the identity list dialog</span>
<a href="#l35.46"></a><span id="l35.46">   // onSave();</span>
<a href="#l35.47"></a><span id="l35.47"> </span>
<a href="#l35.48"></a><span id="l35.48">   if (!gAccount)</span>
<a href="#l35.49"></a><span id="l35.49">     return;</span>
<a href="#l35.50"></a><span id="l35.50"> </span>
<a href="#l35.51"></a><span id="l35.51">   var accountName = document.getElementById(&quot;server.prettyName&quot;).value;</span>
<a href="#l35.52"></a><span id="l35.52"> </span>
<a href="#l35.53"></a><span id="l35.53" class="difflineminus">-  var args = { account: gAccount, accountName: accountName, result: false };</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineplus">+  var args = { account: gAccount, accountName, result: false };</span>
<a href="#l35.55"></a><span id="l35.55"> </span>
<a href="#l35.56"></a><span id="l35.56">   // save the current identity settings so they show up correctly</span>
<a href="#l35.57"></a><span id="l35.57">   // if the user just changed them in the manage identities dialog</span>
<a href="#l35.58"></a><span id="l35.58">   var identity = gAccount.defaultIdentity;</span>
<a href="#l35.59"></a><span id="l35.59">   saveIdentitySettings(identity);</span>
<a href="#l35.60"></a><span id="l35.60"> </span>
<a href="#l35.61"></a><span id="l35.61">   window.openDialog(&quot;am-identities-list.xul&quot;, &quot;&quot;, &quot;chrome,modal,resizable=no,centerscreen&quot;, args);</span>
<a href="#l35.62"></a><span id="l35.62"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-offline.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-offline.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -1,26 +1,29 @@</span>
<a href="#l36.4"></a><span id="l36.4"> /* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l36.5"></a><span id="l36.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l36.6"></a><span id="l36.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l36.7"></a><span id="l36.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l36.8"></a><span id="l36.8"> </span>
<a href="#l36.9"></a><span id="l36.9" class="difflineplus">+/* import-globals-from AccountManager.js */</span>
<a href="#l36.10"></a><span id="l36.10" class="difflineplus">+/* import-globals-from ../../content/retention.js */</span>
<a href="#l36.11"></a><span id="l36.11" class="difflineplus">+</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l36.13"></a><span id="l36.13"> var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l36.14"></a><span id="l36.14"> </span>
<a href="#l36.15"></a><span id="l36.15"> var gIncomingServer;</span>
<a href="#l36.16"></a><span id="l36.16"> var gServerType;</span>
<a href="#l36.17"></a><span id="l36.17"> var gImapIncomingServer;</span>
<a href="#l36.18"></a><span id="l36.18"> var gPref = null;</span>
<a href="#l36.19"></a><span id="l36.19"> var gLockedPref = null;</span>
<a href="#l36.20"></a><span id="l36.20"> var gOfflineMap = null; // map of folder URLs to offline flags</span>
<a href="#l36.21"></a><span id="l36.21"> var gOfflineFolders;    // initial state of allFoldersOffline checkbox</span>
<a href="#l36.22"></a><span id="l36.22"> var gToggleOccurred = false;</span>
<a href="#l36.23"></a><span id="l36.23"> </span>
<a href="#l36.24"></a><span id="l36.24" class="difflineminus">-function onInit(aPageId, aServerId)</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineminus">-{</span>
<a href="#l36.26"></a><span id="l36.26" class="difflineplus">+function onInit(aPageId, aServerId) {</span>
<a href="#l36.27"></a><span id="l36.27">     onLockPreference();</span>
<a href="#l36.28"></a><span id="l36.28"> </span>
<a href="#l36.29"></a><span id="l36.29">     // init values here</span>
<a href="#l36.30"></a><span id="l36.30">     initServerSettings();</span>
<a href="#l36.31"></a><span id="l36.31">     initRetentionSettings();</span>
<a href="#l36.32"></a><span id="l36.32">     initDownloadSettings();</span>
<a href="#l36.33"></a><span id="l36.33">     initOfflineSettings();</span>
<a href="#l36.34"></a><span id="l36.34"> </span>
<a href="#l36.35"></a><span id="l36.35" class="difflineat">@@ -29,50 +32,46 @@ function onInit(aPageId, aServerId)</span>
<a href="#l36.36"></a><span id="l36.36">     onCheckItem(&quot;nntp.removeBodyMin&quot;, &quot;nntp.removeBody&quot;);</span>
<a href="#l36.37"></a><span id="l36.37">     onCheckKeepMsg();</span>
<a href="#l36.38"></a><span id="l36.38"> }</span>
<a href="#l36.39"></a><span id="l36.39"> </span>
<a href="#l36.40"></a><span id="l36.40"> /**</span>
<a href="#l36.41"></a><span id="l36.41">  * Store initial offline flag for each folder and the allFoldersOffline</span>
<a href="#l36.42"></a><span id="l36.42">  * checkbox. Use to restore the flags and checkbox if edits are canceled.</span>
<a href="#l36.43"></a><span id="l36.43">  */</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineminus">-function initOfflineSettings()</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineminus">-{</span>
<a href="#l36.46"></a><span id="l36.46" class="difflineplus">+function initOfflineSettings() {</span>
<a href="#l36.47"></a><span id="l36.47">     gOfflineMap = collectOfflineFolders();</span>
<a href="#l36.48"></a><span id="l36.48">     gOfflineFolders = document.getElementById(&quot;offline.folders&quot;).checked;</span>
<a href="#l36.49"></a><span id="l36.49">     gToggleOccurred = false;</span>
<a href="#l36.50"></a><span id="l36.50"> }</span>
<a href="#l36.51"></a><span id="l36.51"> </span>
<a href="#l36.52"></a><span id="l36.52" class="difflineminus">-function initServerSettings()</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineminus">-{</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineplus">+function initServerSettings() {</span>
<a href="#l36.55"></a><span id="l36.55">     document.getElementById(&quot;offline.notDownload&quot;).checked =  gIncomingServer.limitOfflineMessageSize;</span>
<a href="#l36.56"></a><span id="l36.56">     document.getElementById(&quot;autosync.notDownload&quot;).checked =  gIncomingServer.limitOfflineMessageSize;</span>
<a href="#l36.57"></a><span id="l36.57" class="difflineminus">-    if(gIncomingServer.maxMessageSize &gt; 0)</span>
<a href="#l36.58"></a><span id="l36.58" class="difflineplus">+    if (gIncomingServer.maxMessageSize &gt; 0)</span>
<a href="#l36.59"></a><span id="l36.59">         document.getElementById(&quot;offline.notDownloadMin&quot;).value = gIncomingServer.maxMessageSize;</span>
<a href="#l36.60"></a><span id="l36.60">     else</span>
<a href="#l36.61"></a><span id="l36.61">         document.getElementById(&quot;offline.notDownloadMin&quot;).value = &quot;50&quot;;</span>
<a href="#l36.62"></a><span id="l36.62"> </span>
<a href="#l36.63"></a><span id="l36.63" class="difflineminus">-    if(gServerType == &quot;imap&quot;) {</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineplus">+    if (gServerType == &quot;imap&quot;) {</span>
<a href="#l36.65"></a><span id="l36.65">         gImapIncomingServer = gIncomingServer.QueryInterface(Ci.nsIImapIncomingServer);</span>
<a href="#l36.66"></a><span id="l36.66">         document.getElementById(&quot;offline.folders&quot;).checked =  gImapIncomingServer.offlineDownload;</span>
<a href="#l36.67"></a><span id="l36.67">     }</span>
<a href="#l36.68"></a><span id="l36.68"> }</span>
<a href="#l36.69"></a><span id="l36.69"> </span>
<a href="#l36.70"></a><span id="l36.70" class="difflineminus">-function initRetentionSettings()</span>
<a href="#l36.71"></a><span id="l36.71" class="difflineminus">-{</span>
<a href="#l36.72"></a><span id="l36.72" class="difflineplus">+function initRetentionSettings() {</span>
<a href="#l36.73"></a><span id="l36.73">   let retentionSettings = gIncomingServer.retentionSettings;</span>
<a href="#l36.74"></a><span id="l36.74">   initCommonRetentionSettings(retentionSettings);</span>
<a href="#l36.75"></a><span id="l36.75"> </span>
<a href="#l36.76"></a><span id="l36.76">   document.getElementById(&quot;nntp.removeBody&quot;).checked = retentionSettings.cleanupBodiesByDays;</span>
<a href="#l36.77"></a><span id="l36.77">   document.getElementById(&quot;nntp.removeBodyMin&quot;).value =</span>
<a href="#l36.78"></a><span id="l36.78">     (retentionSettings.daysToKeepBodies &gt; 0) ? retentionSettings.daysToKeepBodies : 30;</span>
<a href="#l36.79"></a><span id="l36.79"> }</span>
<a href="#l36.80"></a><span id="l36.80"> </span>
<a href="#l36.81"></a><span id="l36.81" class="difflineminus">-function initDownloadSettings()</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineminus">-{</span>
<a href="#l36.83"></a><span id="l36.83" class="difflineplus">+function initDownloadSettings() {</span>
<a href="#l36.84"></a><span id="l36.84">   let downloadSettings = gIncomingServer.downloadSettings;</span>
<a href="#l36.85"></a><span id="l36.85">   document.getElementById(&quot;nntp.downloadMsg&quot;).checked = downloadSettings.downloadByDate;</span>
<a href="#l36.86"></a><span id="l36.86">   document.getElementById(&quot;nntp.notDownloadRead&quot;).checked = downloadSettings.downloadUnreadOnly;</span>
<a href="#l36.87"></a><span id="l36.87">   document.getElementById(&quot;nntp.downloadMsgMin&quot;).value =</span>
<a href="#l36.88"></a><span id="l36.88">     (downloadSettings.ageLimitOfMsgsToDownload &gt; 0) ?</span>
<a href="#l36.89"></a><span id="l36.89">       downloadSettings.ageLimitOfMsgsToDownload : 30;</span>
<a href="#l36.90"></a><span id="l36.90"> </span>
<a href="#l36.91"></a><span id="l36.91">   // Figure out what the most natural division of the autosync pref into</span>
<a href="#l36.92"></a><span id="l36.92" class="difflineat">@@ -90,18 +89,17 @@ function initDownloadSettings()</span>
<a href="#l36.93"></a><span id="l36.93">   if (autosyncPrefValue &lt;= 0) {</span>
<a href="#l36.94"></a><span id="l36.94">     // Special-case values &lt;= 0 to have an interval of &quot;All&quot; and disabled</span>
<a href="#l36.95"></a><span id="l36.95">     // controls for value and interval.</span>
<a href="#l36.96"></a><span id="l36.96">     autosyncSelect.value = 0;</span>
<a href="#l36.97"></a><span id="l36.97">     autosyncInterval.value = 1;</span>
<a href="#l36.98"></a><span id="l36.98">     autosyncInterval.disabled = true;</span>
<a href="#l36.99"></a><span id="l36.99">     autosyncValue.value = 30;</span>
<a href="#l36.100"></a><span id="l36.100">     autosyncValue.disabled = true;</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineminus">-  }</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineminus">-  else {</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineplus">+  } else {</span>
<a href="#l36.104"></a><span id="l36.104">     // Otherwise, get the list of possible intervals, in order from</span>
<a href="#l36.105"></a><span id="l36.105">     // largest to smallest.</span>
<a href="#l36.106"></a><span id="l36.106">     let valuesToTest = [];</span>
<a href="#l36.107"></a><span id="l36.107">     for (let i = autosyncInterval.itemCount - 1; i &gt;= 0; i--)</span>
<a href="#l36.108"></a><span id="l36.108">       valuesToTest.push(autosyncInterval.getItemAtIndex(i).value);</span>
<a href="#l36.109"></a><span id="l36.109"> </span>
<a href="#l36.110"></a><span id="l36.110">     // and find the first one that divides the preference evenly.</span>
<a href="#l36.111"></a><span id="l36.111">     for (let i in valuesToTest) {</span>
<a href="#l36.112"></a><span id="l36.112" class="difflineat">@@ -114,18 +112,17 @@ function initDownloadSettings()</span>
<a href="#l36.113"></a><span id="l36.113">     }</span>
<a href="#l36.114"></a><span id="l36.114">     autosyncInterval.disabled = false;</span>
<a href="#l36.115"></a><span id="l36.115">     autosyncValue.disabled = false;</span>
<a href="#l36.116"></a><span id="l36.116">   }</span>
<a href="#l36.117"></a><span id="l36.117">   autosyncPref.value = autosyncPrefValue;</span>
<a href="#l36.118"></a><span id="l36.118"> }</span>
<a href="#l36.119"></a><span id="l36.119"> </span>
<a href="#l36.120"></a><span id="l36.120"> </span>
<a href="#l36.121"></a><span id="l36.121" class="difflineminus">-function onPreInit(account, accountValues)</span>
<a href="#l36.122"></a><span id="l36.122" class="difflineminus">-{</span>
<a href="#l36.123"></a><span id="l36.123" class="difflineplus">+function onPreInit(account, accountValues) {</span>
<a href="#l36.124"></a><span id="l36.124">   gServerType = getAccountValue(account, accountValues, &quot;server&quot;, &quot;type&quot;, null, false);</span>
<a href="#l36.125"></a><span id="l36.125">   hideShowControls(gServerType);</span>
<a href="#l36.126"></a><span id="l36.126">   gIncomingServer = account.incomingServer;</span>
<a href="#l36.127"></a><span id="l36.127">   gIncomingServer.type = gServerType;</span>
<a href="#l36.128"></a><span id="l36.128"> </span>
<a href="#l36.129"></a><span id="l36.129">   // 10 is OFFLINE_SUPPORT_LEVEL_REGULAR, see nsIMsgIncomingServer.idl</span>
<a href="#l36.130"></a><span id="l36.130">   // currently, there is no offline without diskspace</span>
<a href="#l36.131"></a><span id="l36.131">   var titleStringID = (gIncomingServer.offlineSupportLevel &gt;= 10) ?</span>
<a href="#l36.132"></a><span id="l36.132" class="difflineat">@@ -145,28 +142,26 @@ function onPreInit(account, accountValue</span>
<a href="#l36.133"></a><span id="l36.133">       var retentionLabel = document.getElementById(&quot;retentionDescriptionPop&quot;);</span>
<a href="#l36.134"></a><span id="l36.134">       retentionLabel.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l36.135"></a><span id="l36.135">       var applyToFlaggedCheckbox = document.getElementById(&quot;retention.applyToFlagged&quot;);</span>
<a href="#l36.136"></a><span id="l36.136">       applyToFlaggedCheckbox.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l36.137"></a><span id="l36.137">     }</span>
<a href="#l36.138"></a><span id="l36.138">   }</span>
<a href="#l36.139"></a><span id="l36.139"> }</span>
<a href="#l36.140"></a><span id="l36.140"> </span>
<a href="#l36.141"></a><span id="l36.141" class="difflineminus">-function onClickSelect()</span>
<a href="#l36.142"></a><span id="l36.142" class="difflineminus">-{</span>
<a href="#l36.143"></a><span id="l36.143" class="difflineplus">+function onClickSelect() {</span>
<a href="#l36.144"></a><span id="l36.144">     top.window.openDialog(&quot;chrome://messenger/content/msgSelectOfflineFolders.xul&quot;,</span>
<a href="#l36.145"></a><span id="l36.145">                           &quot;&quot;, &quot;centerscreen,chrome,modal,titlebar,resizable=yes&quot;);</span>
<a href="#l36.146"></a><span id="l36.146">     return true;</span>
<a href="#l36.147"></a><span id="l36.147"> }</span>
<a href="#l36.148"></a><span id="l36.148"> </span>
<a href="#l36.149"></a><span id="l36.149"> /**</span>
<a href="#l36.150"></a><span id="l36.150">  * Handle updates to the Autosync</span>
<a href="#l36.151"></a><span id="l36.151">  */</span>
<a href="#l36.152"></a><span id="l36.152" class="difflineminus">-function onAutosyncChange()</span>
<a href="#l36.153"></a><span id="l36.153" class="difflineminus">-{</span>
<a href="#l36.154"></a><span id="l36.154" class="difflineplus">+function onAutosyncChange() {</span>
<a href="#l36.155"></a><span id="l36.155">   let autosyncSelect = document.getElementById(&quot;autosyncSelect&quot;);</span>
<a href="#l36.156"></a><span id="l36.156">   let autosyncInterval = document.getElementById(&quot;autosyncInterval&quot;);</span>
<a href="#l36.157"></a><span id="l36.157">   let autosyncValue = document.getElementById(&quot;autosyncValue&quot;);</span>
<a href="#l36.158"></a><span id="l36.158">   let autosyncPref = document.getElementById(&quot;imap.autoSyncMaxAgeDays&quot;);</span>
<a href="#l36.159"></a><span id="l36.159"> </span>
<a href="#l36.160"></a><span id="l36.160">   // If we're not done initializing, don't do anything.</span>
<a href="#l36.161"></a><span id="l36.161">   // (See initDownloadSettings() for more details.)</span>
<a href="#l36.162"></a><span id="l36.162">   if (autosyncPref.value == &quot;&quot;)</span>
<a href="#l36.163"></a><span id="l36.163" class="difflineat">@@ -186,38 +181,35 @@ function onAutosyncChange()</span>
<a href="#l36.164"></a><span id="l36.164">   if (autosyncValue.value &gt; max)</span>
<a href="#l36.165"></a><span id="l36.165">     autosyncValue.value = Math.floor(max);</span>
<a href="#l36.166"></a><span id="l36.166"> </span>
<a href="#l36.167"></a><span id="l36.167">   autosyncInterval.disabled = false;</span>
<a href="#l36.168"></a><span id="l36.168">   autosyncValue.disabled = false;</span>
<a href="#l36.169"></a><span id="l36.169">   autosyncPref.value = autosyncValue.value * autosyncInterval.value;</span>
<a href="#l36.170"></a><span id="l36.170"> }</span>
<a href="#l36.171"></a><span id="l36.171"> </span>
<a href="#l36.172"></a><span id="l36.172" class="difflineminus">-function onAutosyncNotDownload()</span>
<a href="#l36.173"></a><span id="l36.173" class="difflineminus">-{</span>
<a href="#l36.174"></a><span id="l36.174" class="difflineplus">+function onAutosyncNotDownload() {</span>
<a href="#l36.175"></a><span id="l36.175">   // This function is called when the autosync version of offline.notDownload</span>
<a href="#l36.176"></a><span id="l36.176">   // is changed it simply copies the new checkbox value over to the element</span>
<a href="#l36.177"></a><span id="l36.177">   // driving the preference.</span>
<a href="#l36.178"></a><span id="l36.178">   document.getElementById(&quot;offline.notDownload&quot;).checked =</span>
<a href="#l36.179"></a><span id="l36.179">     document.getElementById(&quot;autosync.notDownload&quot;).checked;</span>
<a href="#l36.180"></a><span id="l36.180">   onCheckItem(&quot;offline.notDownloadMin&quot;, &quot;offline.notDownload&quot;);</span>
<a href="#l36.181"></a><span id="l36.181"> }</span>
<a href="#l36.182"></a><span id="l36.182"> </span>
<a href="#l36.183"></a><span id="l36.183" class="difflineminus">-function onCancel()</span>
<a href="#l36.184"></a><span id="l36.184" class="difflineminus">-{</span>
<a href="#l36.185"></a><span id="l36.185" class="difflineplus">+function onCancel() {</span>
<a href="#l36.186"></a><span id="l36.186">     // restore the offline flags for all folders</span>
<a href="#l36.187"></a><span id="l36.187">     restoreOfflineFolders(gOfflineMap);</span>
<a href="#l36.188"></a><span id="l36.188">     document.getElementById(&quot;offline.folders&quot;).checked = gOfflineFolders;</span>
<a href="#l36.189"></a><span id="l36.189"> }</span>
<a href="#l36.190"></a><span id="l36.190"> </span>
<a href="#l36.191"></a><span id="l36.191"> /**</span>
<a href="#l36.192"></a><span id="l36.192">  * Prompt to avoid unexpected folder sync changes.</span>
<a href="#l36.193"></a><span id="l36.193">  */</span>
<a href="#l36.194"></a><span id="l36.194" class="difflineminus">-function onLeave()</span>
<a href="#l36.195"></a><span id="l36.195" class="difflineminus">-{</span>
<a href="#l36.196"></a><span id="l36.196" class="difflineplus">+function onLeave() {</span>
<a href="#l36.197"></a><span id="l36.197">   let changed = false;</span>
<a href="#l36.198"></a><span id="l36.198">   if (gToggleOccurred) {</span>
<a href="#l36.199"></a><span id="l36.199">     let allFolders = gIncomingServer.rootFolder.descendants;</span>
<a href="#l36.200"></a><span id="l36.200">     for (let folder of fixIterator(allFolders, Ci.nsIMsgFolder)) {</span>
<a href="#l36.201"></a><span id="l36.201">       if (gOfflineMap[folder.folderURL] !=</span>
<a href="#l36.202"></a><span id="l36.202">           folder.getFlag(Ci.nsMsgFolderFlags.Offline)) {</span>
<a href="#l36.203"></a><span id="l36.203">         // A change to the Offline flag to a folder was made.</span>
<a href="#l36.204"></a><span id="l36.204">         changed = true;</span>
<a href="#l36.205"></a><span id="l36.205" class="difflineat">@@ -235,30 +227,29 @@ function onLeave()</span>
<a href="#l36.206"></a><span id="l36.206">     let title = prefBundle.getString(&quot;confirmSyncChangesTitle&quot;);</span>
<a href="#l36.207"></a><span id="l36.207">     let question = prefBundle.getString(&quot;confirmSyncChanges&quot;);</span>
<a href="#l36.208"></a><span id="l36.208">     let discard = prefBundle.getString(&quot;confirmSyncChangesDiscard&quot;);</span>
<a href="#l36.209"></a><span id="l36.209">     let result = Services.prompt</span>
<a href="#l36.210"></a><span id="l36.210">                          .confirmEx(window, title, question,</span>
<a href="#l36.211"></a><span id="l36.211">                                     (Services.prompt.BUTTON_TITLE_SAVE * Services.prompt.BUTTON_POS_0) +</span>
<a href="#l36.212"></a><span id="l36.212">                                     (Services.prompt.BUTTON_TITLE_IS_STRING * Services.prompt.BUTTON_POS_1),</span>
<a href="#l36.213"></a><span id="l36.213">                                     null, discard, null,</span>
<a href="#l36.214"></a><span id="l36.214" class="difflineminus">-                                    null, {value:0});</span>
<a href="#l36.215"></a><span id="l36.215" class="difflineplus">+                                    null, {value: 0});</span>
<a href="#l36.216"></a><span id="l36.216">     if (result == 1) {</span>
<a href="#l36.217"></a><span id="l36.217">       // User clicked Discard button, so restore the online/offline changes for</span>
<a href="#l36.218"></a><span id="l36.218">       // the current account.  Changes made through the &quot;Advanced...&quot; dialog to</span>
<a href="#l36.219"></a><span id="l36.219">       // other accounts will not be restored.</span>
<a href="#l36.220"></a><span id="l36.220">       onCancel();</span>
<a href="#l36.221"></a><span id="l36.221">       return false;</span>
<a href="#l36.222"></a><span id="l36.222">     }</span>
<a href="#l36.223"></a><span id="l36.223">   }</span>
<a href="#l36.224"></a><span id="l36.224">   return true;</span>
<a href="#l36.225"></a><span id="l36.225"> }</span>
<a href="#l36.226"></a><span id="l36.226"> </span>
<a href="#l36.227"></a><span id="l36.227" class="difflineminus">-function onSave()</span>
<a href="#l36.228"></a><span id="l36.228" class="difflineminus">-{</span>
<a href="#l36.229"></a><span id="l36.229" class="difflineplus">+function onSave() {</span>
<a href="#l36.230"></a><span id="l36.230">     var downloadSettings =</span>
<a href="#l36.231"></a><span id="l36.231">       Cc[&quot;@mozilla.org/msgDatabase/downloadSettings;1&quot;]</span>
<a href="#l36.232"></a><span id="l36.232">         .createInstance(Ci.nsIMsgDownloadSettings);</span>
<a href="#l36.233"></a><span id="l36.233"> </span>
<a href="#l36.234"></a><span id="l36.234">     gIncomingServer.limitOfflineMessageSize = document.getElementById(&quot;offline.notDownload&quot;).checked;</span>
<a href="#l36.235"></a><span id="l36.235">     gIncomingServer.maxMessageSize = document.getElementById(&quot;offline.notDownloadMin&quot;).value;</span>
<a href="#l36.236"></a><span id="l36.236"> </span>
<a href="#l36.237"></a><span id="l36.237">     var retentionSettings = saveCommonRetentionSettings(gIncomingServer.retentionSettings);</span>
<a href="#l36.238"></a><span id="l36.238" class="difflineat">@@ -277,125 +268,115 @@ function onSave()</span>
<a href="#l36.239"></a><span id="l36.239">         // Set the pref on the incomingserver, and set the flag on all folders.</span>
<a href="#l36.240"></a><span id="l36.240">         gImapIncomingServer.offlineDownload = document.getElementById(&quot;offline.folders&quot;).checked;</span>
<a href="#l36.241"></a><span id="l36.241">     }</span>
<a href="#l36.242"></a><span id="l36.242"> }</span>
<a href="#l36.243"></a><span id="l36.243"> </span>
<a href="#l36.244"></a><span id="l36.244"> // Does the work of disabling an element given the array which contains xul id/prefstring pairs.</span>
<a href="#l36.245"></a><span id="l36.245"> // Also saves the id/locked state in an array so that other areas of the code can avoid</span>
<a href="#l36.246"></a><span id="l36.246"> // stomping on the disabled state indiscriminately.</span>
<a href="#l36.247"></a><span id="l36.247" class="difflineminus">-function disableIfLocked( prefstrArray )</span>
<a href="#l36.248"></a><span id="l36.248" class="difflineminus">-{</span>
<a href="#l36.249"></a><span id="l36.249" class="difflineplus">+function disableIfLocked(prefstrArray) {</span>
<a href="#l36.250"></a><span id="l36.250">     if (!gLockedPref)</span>
<a href="#l36.251"></a><span id="l36.251" class="difflineminus">-      gLockedPref = new Array;</span>
<a href="#l36.252"></a><span id="l36.252" class="difflineplus">+      gLockedPref = [];</span>
<a href="#l36.253"></a><span id="l36.253"> </span>
<a href="#l36.254"></a><span id="l36.254" class="difflineminus">-    for (var i=0; i&lt;prefstrArray.length; i++) {</span>
<a href="#l36.255"></a><span id="l36.255" class="difflineplus">+    for (let i = 0; i &lt; prefstrArray.length; i++) {</span>
<a href="#l36.256"></a><span id="l36.256">         var id = prefstrArray[i].id;</span>
<a href="#l36.257"></a><span id="l36.257">         var element = document.getElementById(id);</span>
<a href="#l36.258"></a><span id="l36.258">         if (gPref.prefIsLocked(prefstrArray[i].prefstring)) {</span>
<a href="#l36.259"></a><span id="l36.259">             element.disabled = true;</span>
<a href="#l36.260"></a><span id="l36.260">             gLockedPref[id] = true;</span>
<a href="#l36.261"></a><span id="l36.261">         } else {</span>
<a href="#l36.262"></a><span id="l36.262">             element.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l36.263"></a><span id="l36.263">             gLockedPref[id] = false;</span>
<a href="#l36.264"></a><span id="l36.264">         }</span>
<a href="#l36.265"></a><span id="l36.265">     }</span>
<a href="#l36.266"></a><span id="l36.266"> }</span>
<a href="#l36.267"></a><span id="l36.267"> </span>
<a href="#l36.268"></a><span id="l36.268"> // Disables xul elements that have associated preferences locked.</span>
<a href="#l36.269"></a><span id="l36.269" class="difflineminus">-function onLockPreference()</span>
<a href="#l36.270"></a><span id="l36.270" class="difflineminus">-{</span>
<a href="#l36.271"></a><span id="l36.271" class="difflineminus">-    var isDownloadLocked = false;</span>
<a href="#l36.272"></a><span id="l36.272" class="difflineminus">-    var isGetNewLocked = false;</span>
<a href="#l36.273"></a><span id="l36.273" class="difflineplus">+function onLockPreference() {</span>
<a href="#l36.274"></a><span id="l36.274">     var initPrefString = &quot;mail.server&quot;;</span>
<a href="#l36.275"></a><span id="l36.275">     var finalPrefString;</span>
<a href="#l36.276"></a><span id="l36.276"> </span>
<a href="#l36.277"></a><span id="l36.277">     // This panel does not use the code in AccountManager.js to handle</span>
<a href="#l36.278"></a><span id="l36.278">     // the load/unload/disable.  keep in mind new prefstrings and changes</span>
<a href="#l36.279"></a><span id="l36.279">     // to code in AccountManager, and update these as well.</span>
<a href="#l36.280"></a><span id="l36.280">     var allPrefElements = [</span>
<a href="#l36.281"></a><span id="l36.281" class="difflineminus">-      { prefstring:&quot;limit_offline_message_size&quot;, id:&quot;offline.notDownload&quot;},</span>
<a href="#l36.282"></a><span id="l36.282" class="difflineminus">-      { prefstring:&quot;limit_offline_message_size&quot;, id:&quot;autosync.notDownload&quot;},</span>
<a href="#l36.283"></a><span id="l36.283" class="difflineminus">-      { prefstring:&quot;max_size&quot;, id:&quot;offline.notDownloadMin&quot;},</span>
<a href="#l36.284"></a><span id="l36.284" class="difflineminus">-      { prefstring:&quot;downloadUnreadOnly&quot;, id:&quot;nntp.notDownloadRead&quot;},</span>
<a href="#l36.285"></a><span id="l36.285" class="difflineminus">-      { prefstring:&quot;downloadByDate&quot;, id:&quot;nntp.downloadMsg&quot;},</span>
<a href="#l36.286"></a><span id="l36.286" class="difflineminus">-      { prefstring:&quot;ageLimit&quot;, id:&quot;nntp.downloadMsgMin&quot;},</span>
<a href="#l36.287"></a><span id="l36.287" class="difflineminus">-      { prefstring:&quot;retainBy&quot;, id:&quot;retention.keepMsg&quot;},</span>
<a href="#l36.288"></a><span id="l36.288" class="difflineminus">-      { prefstring:&quot;daysToKeepHdrs&quot;, id:&quot;retention.keepOldMsgMin&quot;},</span>
<a href="#l36.289"></a><span id="l36.289" class="difflineminus">-      { prefstring:&quot;numHdrsToKeep&quot;, id:&quot;retention.keepNewMsgMin&quot;},</span>
<a href="#l36.290"></a><span id="l36.290" class="difflineminus">-      { prefstring:&quot;daysToKeepBodies&quot;, id:&quot;nntp.removeBodyMin&quot;},</span>
<a href="#l36.291"></a><span id="l36.291" class="difflineminus">-      { prefstring:&quot;cleanupBodies&quot;, id:&quot;nntp.removeBody&quot; },</span>
<a href="#l36.292"></a><span id="l36.292" class="difflineminus">-      { prefstring:&quot;applyToFlagged&quot;, id:&quot;retention.applyToFlagged&quot;},</span>
<a href="#l36.293"></a><span id="l36.293" class="difflineminus">-      { prefstring:&quot;disable_button.selectFolder&quot;, id:&quot;selectNewsgroupsButton&quot;},</span>
<a href="#l36.294"></a><span id="l36.294" class="difflineminus">-      { prefstring:&quot;disable_button.selectFolder&quot;, id:&quot;selectImapFoldersButton&quot;}</span>
<a href="#l36.295"></a><span id="l36.295" class="difflineplus">+      { prefstring: &quot;limit_offline_message_size&quot;, id: &quot;offline.notDownload&quot; },</span>
<a href="#l36.296"></a><span id="l36.296" class="difflineplus">+      { prefstring: &quot;limit_offline_message_size&quot;, id: &quot;autosync.notDownload&quot; },</span>
<a href="#l36.297"></a><span id="l36.297" class="difflineplus">+      { prefstring: &quot;max_size&quot;, id: &quot;offline.notDownloadMin&quot; },</span>
<a href="#l36.298"></a><span id="l36.298" class="difflineplus">+      { prefstring: &quot;downloadUnreadOnly&quot;, id: &quot;nntp.notDownloadRead&quot; },</span>
<a href="#l36.299"></a><span id="l36.299" class="difflineplus">+      { prefstring: &quot;downloadByDate&quot;, id: &quot;nntp.downloadMsg&quot; },</span>
<a href="#l36.300"></a><span id="l36.300" class="difflineplus">+      { prefstring: &quot;ageLimit&quot;, id: &quot;nntp.downloadMsgMin&quot; },</span>
<a href="#l36.301"></a><span id="l36.301" class="difflineplus">+      { prefstring: &quot;retainBy&quot;, id: &quot;retention.keepMsg&quot; },</span>
<a href="#l36.302"></a><span id="l36.302" class="difflineplus">+      { prefstring: &quot;daysToKeepHdrs&quot;, id: &quot;retention.keepOldMsgMin&quot; },</span>
<a href="#l36.303"></a><span id="l36.303" class="difflineplus">+      { prefstring: &quot;numHdrsToKeep&quot;, id: &quot;retention.keepNewMsgMin&quot; },</span>
<a href="#l36.304"></a><span id="l36.304" class="difflineplus">+      { prefstring: &quot;daysToKeepBodies&quot;, id: &quot;nntp.removeBodyMin&quot; },</span>
<a href="#l36.305"></a><span id="l36.305" class="difflineplus">+      { prefstring: &quot;cleanupBodies&quot;, id: &quot;nntp.removeBody&quot; },</span>
<a href="#l36.306"></a><span id="l36.306" class="difflineplus">+      { prefstring: &quot;applyToFlagged&quot;, id: &quot;retention.applyToFlagged&quot; },</span>
<a href="#l36.307"></a><span id="l36.307" class="difflineplus">+      { prefstring: &quot;disable_button.selectFolder&quot;, id: &quot;selectNewsgroupsButton&quot; },</span>
<a href="#l36.308"></a><span id="l36.308" class="difflineplus">+      { prefstring: &quot;disable_button.selectFolder&quot;, id: &quot;selectImapFoldersButton&quot; },</span>
<a href="#l36.309"></a><span id="l36.309">     ];</span>
<a href="#l36.310"></a><span id="l36.310"> </span>
<a href="#l36.311"></a><span id="l36.311">     finalPrefString = initPrefString + &quot;.&quot; + gIncomingServer.key + &quot;.&quot;;</span>
<a href="#l36.312"></a><span id="l36.312">     gPref = Services.prefs.getBranch(finalPrefString);</span>
<a href="#l36.313"></a><span id="l36.313"> </span>
<a href="#l36.314"></a><span id="l36.314" class="difflineminus">-    disableIfLocked( allPrefElements );</span>
<a href="#l36.315"></a><span id="l36.315" class="difflineplus">+    disableIfLocked(allPrefElements);</span>
<a href="#l36.316"></a><span id="l36.316"> }</span>
<a href="#l36.317"></a><span id="l36.317"> </span>
<a href="#l36.318"></a><span id="l36.318" class="difflineminus">-function onCheckItem(changeElementId, checkElementId)</span>
<a href="#l36.319"></a><span id="l36.319" class="difflineminus">-{</span>
<a href="#l36.320"></a><span id="l36.320" class="difflineplus">+function onCheckItem(changeElementId, checkElementId) {</span>
<a href="#l36.321"></a><span id="l36.321">     var element = document.getElementById(changeElementId);</span>
<a href="#l36.322"></a><span id="l36.322">     var checked = document.getElementById(checkElementId).checked;</span>
<a href="#l36.323"></a><span id="l36.323" class="difflineminus">-    if(checked &amp;&amp; !gLockedPref[checkElementId] ) {</span>
<a href="#l36.324"></a><span id="l36.324" class="difflineplus">+    if (checked &amp;&amp; !gLockedPref[checkElementId]) {</span>
<a href="#l36.325"></a><span id="l36.325">         element.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l36.326"></a><span id="l36.326" class="difflineminus">-    }</span>
<a href="#l36.327"></a><span id="l36.327" class="difflineminus">-    else {</span>
<a href="#l36.328"></a><span id="l36.328" class="difflineplus">+    } else {</span>
<a href="#l36.329"></a><span id="l36.329">         element.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l36.330"></a><span id="l36.330">     }</span>
<a href="#l36.331"></a><span id="l36.331"> }</span>
<a href="#l36.332"></a><span id="l36.332"> </span>
<a href="#l36.333"></a><span id="l36.333" class="difflineminus">-function toggleOffline()</span>
<a href="#l36.334"></a><span id="l36.334" class="difflineminus">-{</span>
<a href="#l36.335"></a><span id="l36.335" class="difflineplus">+function toggleOffline() {</span>
<a href="#l36.336"></a><span id="l36.336">     let offline = document.getElementById(&quot;offline.folders&quot;).checked;</span>
<a href="#l36.337"></a><span id="l36.337">     let allFolders = gIncomingServer.rootFolder.descendants;</span>
<a href="#l36.338"></a><span id="l36.338">     for (let folder of fixIterator(allFolders, Ci.nsIMsgFolder)) {</span>
<a href="#l36.339"></a><span id="l36.339">       if (offline)</span>
<a href="#l36.340"></a><span id="l36.340">         folder.setFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l36.341"></a><span id="l36.341">       else</span>
<a href="#l36.342"></a><span id="l36.342">         folder.clearFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l36.343"></a><span id="l36.343">     }</span>
<a href="#l36.344"></a><span id="l36.344">     gToggleOccurred = true;</span>
<a href="#l36.345"></a><span id="l36.345"> }</span>
<a href="#l36.346"></a><span id="l36.346"> </span>
<a href="#l36.347"></a><span id="l36.347" class="difflineminus">-function collectOfflineFolders()</span>
<a href="#l36.348"></a><span id="l36.348" class="difflineminus">-{</span>
<a href="#l36.349"></a><span id="l36.349" class="difflineplus">+function collectOfflineFolders() {</span>
<a href="#l36.350"></a><span id="l36.350">     let offlineFolderMap = {};</span>
<a href="#l36.351"></a><span id="l36.351">     let allFolders = gIncomingServer.rootFolder.descendants;</span>
<a href="#l36.352"></a><span id="l36.352">     for (let folder of fixIterator(allFolders, Ci.nsIMsgFolder))</span>
<a href="#l36.353"></a><span id="l36.353">       offlineFolderMap[folder.folderURL] = folder.getFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l36.354"></a><span id="l36.354"> </span>
<a href="#l36.355"></a><span id="l36.355">     return offlineFolderMap;</span>
<a href="#l36.356"></a><span id="l36.356"> }</span>
<a href="#l36.357"></a><span id="l36.357"> </span>
<a href="#l36.358"></a><span id="l36.358" class="difflineminus">-function restoreOfflineFolders(offlineFolderMap)</span>
<a href="#l36.359"></a><span id="l36.359" class="difflineminus">-{</span>
<a href="#l36.360"></a><span id="l36.360" class="difflineplus">+function restoreOfflineFolders(offlineFolderMap) {</span>
<a href="#l36.361"></a><span id="l36.361">     let allFolders = gIncomingServer.rootFolder.descendants;</span>
<a href="#l36.362"></a><span id="l36.362">     for (let folder of fixIterator(allFolders, Ci.nsIMsgFolder)) {</span>
<a href="#l36.363"></a><span id="l36.363">       if (offlineFolderMap[folder.folderURL])</span>
<a href="#l36.364"></a><span id="l36.364">         folder.setFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l36.365"></a><span id="l36.365">       else</span>
<a href="#l36.366"></a><span id="l36.366">         folder.clearFlag(Ci.nsMsgFolderFlags.Offline);</span>
<a href="#l36.367"></a><span id="l36.367">     }</span>
<a href="#l36.368"></a><span id="l36.368"> }</span>
<a href="#l36.369"></a><span id="l36.369"> </span>
<a href="#l36.370"></a><span id="l36.370"> /**</span>
<a href="#l36.371"></a><span id="l36.371">  * Checks if the user selected a permanent removal of messages from a server</span>
<a href="#l36.372"></a><span id="l36.372">  * listed in the confirmfor attribute and warns about it.</span>
<a href="#l36.373"></a><span id="l36.373">  *</span>
<a href="#l36.374"></a><span id="l36.374">  * @param aRadio  The radiogroup element containing the retention options.</span>
<a href="#l36.375"></a><span id="l36.375">  */</span>
<a href="#l36.376"></a><span id="l36.376" class="difflineminus">-function warnServerRemove(aRadio)</span>
<a href="#l36.377"></a><span id="l36.377" class="difflineminus">-{</span>
<a href="#l36.378"></a><span id="l36.378" class="difflineplus">+function warnServerRemove(aRadio) {</span>
<a href="#l36.379"></a><span id="l36.379">   let confirmFor = aRadio.getAttribute(&quot;confirmfor&quot;);</span>
<a href="#l36.380"></a><span id="l36.380"> </span>
<a href="#l36.381"></a><span id="l36.381" class="difflineminus">-  if (confirmFor &amp;&amp; confirmFor.split(',').includes(gServerType) &amp;&amp; aRadio.value != 1) {</span>
<a href="#l36.382"></a><span id="l36.382" class="difflineplus">+  if (confirmFor &amp;&amp; confirmFor.split(&quot;,&quot;).includes(gServerType) &amp;&amp; aRadio.value != 1) {</span>
<a href="#l36.383"></a><span id="l36.383">     let prefBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l36.384"></a><span id="l36.384">     let title = prefBundle.getString(&quot;removeFromServerTitle&quot;);</span>
<a href="#l36.385"></a><span id="l36.385">     let question = prefBundle.getString(&quot;removeFromServer&quot;);</span>
<a href="#l36.386"></a><span id="l36.386">     if (!Services.prompt.confirm(window, title, question)) {</span>
<a href="#l36.387"></a><span id="l36.387">       // If the user doesn't agree, fall back to not deleting anything.</span>
<a href="#l36.388"></a><span id="l36.388">       aRadio.value = 1;</span>
<a href="#l36.389"></a><span id="l36.389">       onCheckKeepMsg();</span>
<a href="#l36.390"></a><span id="l36.390">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-offline.xul</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-offline.xul</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -145,17 +145,17 @@</span>
<a href="#l37.4"></a><span id="l37.4">     &lt;hbox align=&quot;center&quot; class=&quot;indent&quot;&gt;</span>
<a href="#l37.5"></a><span id="l37.5">       &lt;checkbox id=&quot;retention.applyToFlagged&quot;</span>
<a href="#l37.6"></a><span id="l37.6">                 label=&quot;&amp;retentionApplyToFlagged.label;&quot; hidefor=&quot;&quot;</span>
<a href="#l37.7"></a><span id="l37.7">                 accesskey=&quot;&amp;retentionApplyToFlagged.accesskey;&quot;</span>
<a href="#l37.8"></a><span id="l37.8">                 checked=&quot;true&quot;/&gt;</span>
<a href="#l37.9"></a><span id="l37.9">     &lt;/hbox&gt;</span>
<a href="#l37.10"></a><span id="l37.10">     &lt;hbox align=&quot;center&quot; class=&quot;indent&quot; hidefor=&quot;movemail,pop3,imap,none,rss&quot;&gt;</span>
<a href="#l37.11"></a><span id="l37.11">         &lt;checkbox id=&quot;nntp.removeBody&quot; accesskey=&quot;&amp;nntpRemoveMsgBody.accesskey;&quot;</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-                  label=&quot;&amp;nntpRemoveMsgBody.label;&quot; oncommand=&quot;onCheckItem('nntp.removeBodyMin','nntp.removeBody');&quot;/&gt;</span>
<a href="#l37.13"></a><span id="l37.13" class="difflineplus">+                  label=&quot;&amp;nntpRemoveMsgBody.label;&quot; oncommand=&quot;onCheckItem('nntp.removeBodyMin', 'nntp.removeBody');&quot;/&gt;</span>
<a href="#l37.14"></a><span id="l37.14">         &lt;textbox id=&quot;nntp.removeBodyMin&quot; size=&quot;2&quot; value=&quot;30&quot;</span>
<a href="#l37.15"></a><span id="l37.15">                  type=&quot;number&quot; min=&quot;1&quot;</span>
<a href="#l37.16"></a><span id="l37.16">                  aria-labelledby=&quot;nntp.removeBody nntp.removeBodyMin daysOldMsg&quot;/&gt;</span>
<a href="#l37.17"></a><span id="l37.17">         &lt;label value=&quot;&amp;daysOld.label;&quot; control=&quot;nntp.removeBodyMin&quot; id=&quot;daysOldMsg&quot;/&gt;</span>
<a href="#l37.18"></a><span id="l37.18">     &lt;/hbox&gt;</span>
<a href="#l37.19"></a><span id="l37.19">     &lt;/vbox&gt;</span>
<a href="#l37.20"></a><span id="l37.20">     &lt;/groupbox&gt;</span>
<a href="#l37.21"></a><span id="l37.21">   &lt;/vbox&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-prefs.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-prefs.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -16,18 +16,17 @@ var {Services} = ChromeUtils.import(&quot;res</span>
<a href="#l38.4"></a><span id="l38.4">  * @param aStr  The string is a prefstring with a token %tokenname%.</span>
<a href="#l38.5"></a><span id="l38.5">  * @param aElement  The xul element has an attribute of name |tokenname|</span>
<a href="#l38.6"></a><span id="l38.6">  *                  whose value is substituted into the string and returned</span>
<a href="#l38.7"></a><span id="l38.7">  *                  by the function.</span>
<a href="#l38.8"></a><span id="l38.8">  *</span>
<a href="#l38.9"></a><span id="l38.9">  * Any tokens which do not have associated attribute value</span>
<a href="#l38.10"></a><span id="l38.10">  * are not substituted, and left in the string as-is.</span>
<a href="#l38.11"></a><span id="l38.11">  */</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineminus">-function substPrefTokens(aStr, aElement)</span>
<a href="#l38.13"></a><span id="l38.13" class="difflineminus">-{</span>
<a href="#l38.14"></a><span id="l38.14" class="difflineplus">+function substPrefTokens(aStr, aElement) {</span>
<a href="#l38.15"></a><span id="l38.15">   let tokenpat = /%(\w+)%/;</span>
<a href="#l38.16"></a><span id="l38.16">   let token;</span>
<a href="#l38.17"></a><span id="l38.17">   let newprefstr = &quot;&quot;;</span>
<a href="#l38.18"></a><span id="l38.18"> </span>
<a href="#l38.19"></a><span id="l38.19">   let prefPartsArray = aStr.split(&quot;.&quot;);</span>
<a href="#l38.20"></a><span id="l38.20">   /* here's a little loop that goes through</span>
<a href="#l38.21"></a><span id="l38.21">      each part of the string separated by a dot, and</span>
<a href="#l38.22"></a><span id="l38.22">      if any parts are of the form %string%, it will replace</span>
<a href="#l38.23"></a><span id="l38.23" class="difflineat">@@ -58,18 +57,17 @@ function substPrefTokens(aStr, aElement)</span>
<a href="#l38.24"></a><span id="l38.24">  * A simple function to check if a pref in an element is locked.</span>
<a href="#l38.25"></a><span id="l38.25">  *</span>
<a href="#l38.26"></a><span id="l38.26">  * @param aElement  a xul element with the pref related attributes</span>
<a href="#l38.27"></a><span id="l38.27">  *                 (pref, preftype, prefstring)</span>
<a href="#l38.28"></a><span id="l38.28">  * @return  whether the prefstring specified in that element is</span>
<a href="#l38.29"></a><span id="l38.29">  *          locked (true/false).</span>
<a href="#l38.30"></a><span id="l38.30">  *          If it does not have a valid prefstring, a false is returned.</span>
<a href="#l38.31"></a><span id="l38.31">  */</span>
<a href="#l38.32"></a><span id="l38.32" class="difflineminus">-function getAccountValueIsLocked(aElement)</span>
<a href="#l38.33"></a><span id="l38.33" class="difflineminus">-{</span>
<a href="#l38.34"></a><span id="l38.34" class="difflineplus">+function getAccountValueIsLocked(aElement) {</span>
<a href="#l38.35"></a><span id="l38.35">   let prefstring = aElement.getAttribute(&quot;prefstring&quot;);</span>
<a href="#l38.36"></a><span id="l38.36">   if (prefstring) {</span>
<a href="#l38.37"></a><span id="l38.37">     let prefstr = substPrefTokens(prefstring, aElement);</span>
<a href="#l38.38"></a><span id="l38.38">     // see if the prefstring is locked</span>
<a href="#l38.39"></a><span id="l38.39">     if (prefstr)</span>
<a href="#l38.40"></a><span id="l38.40">       return Services.prefs.prefIsLocked(prefstr);</span>
<a href="#l38.41"></a><span id="l38.41">   }</span>
<a href="#l38.42"></a><span id="l38.42">   return false;</span>
<a href="#l38.43"></a><span id="l38.43" class="difflineat">@@ -81,18 +79,17 @@ function getAccountValueIsLocked(aElemen</span>
<a href="#l38.44"></a><span id="l38.44">  *</span>
<a href="#l38.45"></a><span id="l38.45">  * @param aChangeElementId  Slave element which should be enabled</span>
<a href="#l38.46"></a><span id="l38.46">  *                          if all the checkElementIDs are checked.</span>
<a href="#l38.47"></a><span id="l38.47">  *                          Otherwise it gets disabled.</span>
<a href="#l38.48"></a><span id="l38.48">  * @param aCheckElementIds  An array of IDs of the master elements.</span>
<a href="#l38.49"></a><span id="l38.49">  *</span>
<a href="#l38.50"></a><span id="l38.50">  * See bug 728681 for the pattern on how this is used.</span>
<a href="#l38.51"></a><span id="l38.51">  */</span>
<a href="#l38.52"></a><span id="l38.52" class="difflineminus">-function onCheckItem(aChangeElementId, aCheckElementIds)</span>
<a href="#l38.53"></a><span id="l38.53" class="difflineminus">-{</span>
<a href="#l38.54"></a><span id="l38.54" class="difflineplus">+function onCheckItem(aChangeElementId, aCheckElementIds) {</span>
<a href="#l38.55"></a><span id="l38.55">   let elementToControl = document.getElementById(aChangeElementId);</span>
<a href="#l38.56"></a><span id="l38.56">   let disabled = false;</span>
<a href="#l38.57"></a><span id="l38.57"> </span>
<a href="#l38.58"></a><span id="l38.58">   for (let notifyId of aCheckElementIds) {</span>
<a href="#l38.59"></a><span id="l38.59">     let notifyElement = document.getElementById(notifyId);</span>
<a href="#l38.60"></a><span id="l38.60">     let notifyElementState = null;</span>
<a href="#l38.61"></a><span id="l38.61">     if (&quot;checked&quot; in notifyElement)</span>
<a href="#l38.62"></a><span id="l38.62">       notifyElementState = notifyElement.checked;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-server-advanced.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-server-advanced.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -10,66 +10,57 @@ document.addEventListener(&quot;dialogaccept&quot;</span>
<a href="#l39.4"></a><span id="l39.4"> </span>
<a href="#l39.5"></a><span id="l39.5"> // pull stuff out of window.arguments</span>
<a href="#l39.6"></a><span id="l39.6"> var gServerSettings = window.arguments[0];</span>
<a href="#l39.7"></a><span id="l39.7"> </span>
<a href="#l39.8"></a><span id="l39.8"> var gFirstDeferredAccount;</span>
<a href="#l39.9"></a><span id="l39.9"> // initialize the controls with the &quot;gServerSettings&quot; argument</span>
<a href="#l39.10"></a><span id="l39.10"> </span>
<a href="#l39.11"></a><span id="l39.11"> var gControls;</span>
<a href="#l39.12"></a><span id="l39.12" class="difflineminus">-function getControls()</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineminus">-{</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+function getControls() {</span>
<a href="#l39.15"></a><span id="l39.15">   if (!gControls)</span>
<a href="#l39.16"></a><span id="l39.16">     gControls = document.getElementsByAttribute(&quot;amsa_persist&quot;, &quot;true&quot;);</span>
<a href="#l39.17"></a><span id="l39.17">   return gControls;</span>
<a href="#l39.18"></a><span id="l39.18"> }</span>
<a href="#l39.19"></a><span id="l39.19"> </span>
<a href="#l39.20"></a><span id="l39.20" class="difflineminus">-function getLocalFoldersAccount()</span>
<a href="#l39.21"></a><span id="l39.21" class="difflineminus">-{</span>
<a href="#l39.22"></a><span id="l39.22" class="difflineplus">+function getLocalFoldersAccount() {</span>
<a href="#l39.23"></a><span id="l39.23">   return MailServices.accounts</span>
<a href="#l39.24"></a><span id="l39.24">     .FindAccountForServer(MailServices.accounts.localFoldersServer);</span>
<a href="#l39.25"></a><span id="l39.25"> }</span>
<a href="#l39.26"></a><span id="l39.26"> </span>
<a href="#l39.27"></a><span id="l39.27" class="difflineminus">-function onLoad()</span>
<a href="#l39.28"></a><span id="l39.28" class="difflineminus">-{</span>
<a href="#l39.29"></a><span id="l39.29" class="difflineplus">+function onLoad() {</span>
<a href="#l39.30"></a><span id="l39.30">   var prettyName = gServerSettings.serverPrettyName;</span>
<a href="#l39.31"></a><span id="l39.31"> </span>
<a href="#l39.32"></a><span id="l39.32">   if (prettyName)</span>
<a href="#l39.33"></a><span id="l39.33">     document.getElementById(&quot;serverPrettyName&quot;).value =</span>
<a href="#l39.34"></a><span id="l39.34">       document.getElementById(&quot;bundle_prefs&quot;)</span>
<a href="#l39.35"></a><span id="l39.35">               .getFormattedString(&quot;forAccount&quot;, [prettyName]);</span>
<a href="#l39.36"></a><span id="l39.36"> </span>
<a href="#l39.37"></a><span id="l39.37" class="difflineminus">-  if (gServerSettings.serverType == &quot;imap&quot;)</span>
<a href="#l39.38"></a><span id="l39.38" class="difflineminus">-  {</span>
<a href="#l39.39"></a><span id="l39.39" class="difflineplus">+  if (gServerSettings.serverType == &quot;imap&quot;) {</span>
<a href="#l39.40"></a><span id="l39.40">     document.getElementById(&quot;pop3Panel&quot;).hidden = true;</span>
<a href="#l39.41"></a><span id="l39.41" class="difflineminus">-  }</span>
<a href="#l39.42"></a><span id="l39.42" class="difflineminus">-  else if (gServerSettings.serverType == &quot;pop3&quot;)</span>
<a href="#l39.43"></a><span id="l39.43" class="difflineminus">-  {</span>
<a href="#l39.44"></a><span id="l39.44" class="difflineplus">+  } else if (gServerSettings.serverType == &quot;pop3&quot;) {</span>
<a href="#l39.45"></a><span id="l39.45">     document.getElementById(&quot;imapPanel&quot;).hidden = true;</span>
<a href="#l39.46"></a><span id="l39.46">     let radioGroup = document.getElementById(&quot;folderStorage&quot;);</span>
<a href="#l39.47"></a><span id="l39.47"> </span>
<a href="#l39.48"></a><span id="l39.48">     gFirstDeferredAccount = gServerSettings.deferredToAccount;</span>
<a href="#l39.49"></a><span id="l39.49">     let folderPopup = document.getElementById(&quot;deferredServerPopup&quot;);</span>
<a href="#l39.50"></a><span id="l39.50"> </span>
<a href="#l39.51"></a><span id="l39.51">     // The current account should not be shown in the folder picker</span>
<a href="#l39.52"></a><span id="l39.52">     // of the &quot;other account&quot; option.</span>
<a href="#l39.53"></a><span id="l39.53">     folderPopup._teardown();</span>
<a href="#l39.54"></a><span id="l39.54">     folderPopup.setAttribute(&quot;excludeServers&quot;,</span>
<a href="#l39.55"></a><span id="l39.55">                              gServerSettings.account.incomingServer.key);</span>
<a href="#l39.56"></a><span id="l39.56">     folderPopup._ensureInitialized();</span>
<a href="#l39.57"></a><span id="l39.57"> </span>
<a href="#l39.58"></a><span id="l39.58" class="difflineminus">-    if (gFirstDeferredAccount.length)</span>
<a href="#l39.59"></a><span id="l39.59" class="difflineminus">-    {</span>
<a href="#l39.60"></a><span id="l39.60" class="difflineplus">+    if (gFirstDeferredAccount.length) {</span>
<a href="#l39.61"></a><span id="l39.61">       // The current account is deferred.</span>
<a href="#l39.62"></a><span id="l39.62">       let account = MailServices.accounts.getAccount(gFirstDeferredAccount);</span>
<a href="#l39.63"></a><span id="l39.63">       radioGroup.value = &quot;otherAccount&quot;;</span>
<a href="#l39.64"></a><span id="l39.64">       folderPopup.selectFolder(account.incomingServer.rootFolder);</span>
<a href="#l39.65"></a><span id="l39.65" class="difflineminus">-    }</span>
<a href="#l39.66"></a><span id="l39.66" class="difflineminus">-    else</span>
<a href="#l39.67"></a><span id="l39.67" class="difflineminus">-    {</span>
<a href="#l39.68"></a><span id="l39.68" class="difflineplus">+    } else {</span>
<a href="#l39.69"></a><span id="l39.69">       // Current account is not deferred.</span>
<a href="#l39.70"></a><span id="l39.70">       radioGroup.value = &quot;currentAccount&quot;;</span>
<a href="#l39.71"></a><span id="l39.71">       // If there are no suitable accounts to defer to, then the menulist is</span>
<a href="#l39.72"></a><span id="l39.72">       // disabled by the picker with an appropriate message.</span>
<a href="#l39.73"></a><span id="l39.73">       folderPopup.selectFolder();</span>
<a href="#l39.74"></a><span id="l39.74">       if (gServerSettings.account.incomingServer.isDeferredTo) {</span>
<a href="#l39.75"></a><span id="l39.75">         // Some other account already defers to this account</span>
<a href="#l39.76"></a><span id="l39.76">         // therefore this one can't be deferred further.</span>
<a href="#l39.77"></a><span id="l39.77" class="difflineat">@@ -78,82 +69,73 @@ function onLoad()</span>
<a href="#l39.78"></a><span id="l39.78">     }</span>
<a href="#l39.79"></a><span id="l39.79"> </span>
<a href="#l39.80"></a><span id="l39.80">     let picker = document.getElementById(&quot;deferredServerFolderPicker&quot;);</span>
<a href="#l39.81"></a><span id="l39.81">     picker.disabled = radioGroup.selectedIndex != 1;</span>
<a href="#l39.82"></a><span id="l39.82">   }</span>
<a href="#l39.83"></a><span id="l39.83"> </span>
<a href="#l39.84"></a><span id="l39.84">   var controls = getControls();</span>
<a href="#l39.85"></a><span id="l39.85"> </span>
<a href="#l39.86"></a><span id="l39.86" class="difflineminus">-  for (var i = 0; i &lt; controls.length; i++)</span>
<a href="#l39.87"></a><span id="l39.87" class="difflineminus">-  {</span>
<a href="#l39.88"></a><span id="l39.88" class="difflineplus">+  for (let i = 0; i &lt; controls.length; i++) {</span>
<a href="#l39.89"></a><span id="l39.89">     var slot = controls[i].id;</span>
<a href="#l39.90"></a><span id="l39.90" class="difflineminus">-    if (slot in gServerSettings)</span>
<a href="#l39.91"></a><span id="l39.91" class="difflineminus">-    {</span>
<a href="#l39.92"></a><span id="l39.92" class="difflineplus">+    if (slot in gServerSettings) {</span>
<a href="#l39.93"></a><span id="l39.93">       if (controls[i].localName == &quot;checkbox&quot;)</span>
<a href="#l39.94"></a><span id="l39.94">         controls[i].checked = gServerSettings[slot];</span>
<a href="#l39.95"></a><span id="l39.95">       else</span>
<a href="#l39.96"></a><span id="l39.96">         controls[i].value = gServerSettings[slot];</span>
<a href="#l39.97"></a><span id="l39.97">     }</span>
<a href="#l39.98"></a><span id="l39.98">   }</span>
<a href="#l39.99"></a><span id="l39.99"> }</span>
<a href="#l39.100"></a><span id="l39.100"> </span>
<a href="#l39.101"></a><span id="l39.101" class="difflineminus">-function onOk(event)</span>
<a href="#l39.102"></a><span id="l39.102" class="difflineminus">-{</span>
<a href="#l39.103"></a><span id="l39.103" class="difflineplus">+function onOk(event) {</span>
<a href="#l39.104"></a><span id="l39.104">   // Handle account deferral settings for POP3 accounts.</span>
<a href="#l39.105"></a><span id="l39.105" class="difflineminus">-  if (gServerSettings.serverType == &quot;pop3&quot;)</span>
<a href="#l39.106"></a><span id="l39.106" class="difflineminus">-  {</span>
<a href="#l39.107"></a><span id="l39.107" class="difflineplus">+  if (gServerSettings.serverType == &quot;pop3&quot;) {</span>
<a href="#l39.108"></a><span id="l39.108">     var radioGroup = document.getElementById(&quot;folderStorage&quot;);</span>
<a href="#l39.109"></a><span id="l39.109">     var gPrefsBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l39.110"></a><span id="l39.110">     let picker = document.getElementById(&quot;deferredServerFolderPicker&quot;);</span>
<a href="#l39.111"></a><span id="l39.111"> </span>
<a href="#l39.112"></a><span id="l39.112">     // This account wasn't previously deferred, but is now deferred.</span>
<a href="#l39.113"></a><span id="l39.113" class="difflineminus">-    if (radioGroup.value != &quot;currentAccount&quot; &amp;&amp; !gFirstDeferredAccount.length)</span>
<a href="#l39.114"></a><span id="l39.114" class="difflineminus">-    {</span>
<a href="#l39.115"></a><span id="l39.115" class="difflineplus">+    if (radioGroup.value != &quot;currentAccount&quot; &amp;&amp; !gFirstDeferredAccount.length) {</span>
<a href="#l39.116"></a><span id="l39.116">       // If the user hasn't selected a folder, keep the default.</span>
<a href="#l39.117"></a><span id="l39.117">       if (!picker.selectedItem)</span>
<a href="#l39.118"></a><span id="l39.118">         return;</span>
<a href="#l39.119"></a><span id="l39.119"> </span>
<a href="#l39.120"></a><span id="l39.120">       var confirmDeferAccount =</span>
<a href="#l39.121"></a><span id="l39.121">         gPrefsBundle.getString(&quot;confirmDeferAccountWarning&quot;);</span>
<a href="#l39.122"></a><span id="l39.122"> </span>
<a href="#l39.123"></a><span id="l39.123">       var confirmTitle = gPrefsBundle.getString(&quot;confirmDeferAccountTitle&quot;);</span>
<a href="#l39.124"></a><span id="l39.124"> </span>
<a href="#l39.125"></a><span id="l39.125">       if (!Services.prompt.confirm(window, confirmTitle, confirmDeferAccount)) {</span>
<a href="#l39.126"></a><span id="l39.126">         event.preventDefault();</span>
<a href="#l39.127"></a><span id="l39.127">         return;</span>
<a href="#l39.128"></a><span id="l39.128">       }</span>
<a href="#l39.129"></a><span id="l39.129">     }</span>
<a href="#l39.130"></a><span id="l39.130" class="difflineminus">-    switch (radioGroup.value)</span>
<a href="#l39.131"></a><span id="l39.131" class="difflineminus">-    {</span>
<a href="#l39.132"></a><span id="l39.132" class="difflineplus">+    switch (radioGroup.value) {</span>
<a href="#l39.133"></a><span id="l39.133">       case &quot;currentAccount&quot;:</span>
<a href="#l39.134"></a><span id="l39.134" class="difflineminus">-        gServerSettings['deferredToAccount'] = &quot;&quot;;</span>
<a href="#l39.135"></a><span id="l39.135" class="difflineplus">+        gServerSettings.deferredToAccount = &quot;&quot;;</span>
<a href="#l39.136"></a><span id="l39.136">         break;</span>
<a href="#l39.137"></a><span id="l39.137">       case &quot;otherAccount&quot;:</span>
<a href="#l39.138"></a><span id="l39.138">         let server = picker.selectedItem._folder.server;</span>
<a href="#l39.139"></a><span id="l39.139">         let account = MailServices.accounts.FindAccountForServer(server);</span>
<a href="#l39.140"></a><span id="l39.140" class="difflineminus">-        gServerSettings['deferredToAccount'] = account.key;</span>
<a href="#l39.141"></a><span id="l39.141" class="difflineplus">+        gServerSettings.deferredToAccount = account.key;</span>
<a href="#l39.142"></a><span id="l39.142">         break;</span>
<a href="#l39.143"></a><span id="l39.143">     }</span>
<a href="#l39.144"></a><span id="l39.144">   }</span>
<a href="#l39.145"></a><span id="l39.145"> </span>
<a href="#l39.146"></a><span id="l39.146">   // Save the controls back to the &quot;gServerSettings&quot; array.</span>
<a href="#l39.147"></a><span id="l39.147">   var controls = getControls();</span>
<a href="#l39.148"></a><span id="l39.148" class="difflineminus">-  for (var i = 0; i &lt; controls.length; i++)</span>
<a href="#l39.149"></a><span id="l39.149" class="difflineminus">-  {</span>
<a href="#l39.150"></a><span id="l39.150" class="difflineplus">+  for (let i = 0; i &lt; controls.length; i++) {</span>
<a href="#l39.151"></a><span id="l39.151">     var slot = controls[i].id;</span>
<a href="#l39.152"></a><span id="l39.152" class="difflineminus">-    if (slot in gServerSettings)</span>
<a href="#l39.153"></a><span id="l39.153" class="difflineminus">-    {</span>
<a href="#l39.154"></a><span id="l39.154" class="difflineplus">+    if (slot in gServerSettings) {</span>
<a href="#l39.155"></a><span id="l39.155">       if (controls[i].localName == &quot;checkbox&quot;)</span>
<a href="#l39.156"></a><span id="l39.156">         gServerSettings[slot] = controls[i].checked;</span>
<a href="#l39.157"></a><span id="l39.157">       else</span>
<a href="#l39.158"></a><span id="l39.158">         gServerSettings[slot] = controls[i].value;</span>
<a href="#l39.159"></a><span id="l39.159">     }</span>
<a href="#l39.160"></a><span id="l39.160">   }</span>
<a href="#l39.161"></a><span id="l39.161"> }</span>
<a href="#l39.162"></a><span id="l39.162"> </span>
<a href="#l39.163"></a><span id="l39.163"> </span>
<a href="#l39.164"></a><span id="l39.164"> // Set radio element choices and picker states</span>
<a href="#l39.165"></a><span id="l39.165" class="difflineminus">-function updateInboxAccount(enablePicker)</span>
<a href="#l39.166"></a><span id="l39.166" class="difflineminus">-{</span>
<a href="#l39.167"></a><span id="l39.167" class="difflineplus">+function updateInboxAccount(enablePicker) {</span>
<a href="#l39.168"></a><span id="l39.168">   document.getElementById(&quot;deferredServerFolderPicker&quot;).disabled = !enablePicker;</span>
<a href="#l39.169"></a><span id="l39.169">   document.getElementById(&quot;deferGetNewMail&quot;).disabled = !enablePicker;</span>
<a href="#l39.170"></a><span id="l39.170"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-server.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-server.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -1,13 +1,15 @@</span>
<a href="#l40.4"></a><span id="l40.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*-</span>
<a href="#l40.5"></a><span id="l40.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l40.6"></a><span id="l40.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l40.7"></a><span id="l40.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l40.8"></a><span id="l40.8"> </span>
<a href="#l40.9"></a><span id="l40.9" class="difflineplus">+/* import-globals-from AccountManager.js */</span>
<a href="#l40.10"></a><span id="l40.10" class="difflineplus">+</span>
<a href="#l40.11"></a><span id="l40.11"> var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l40.12"></a><span id="l40.12"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l40.13"></a><span id="l40.13"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l40.14"></a><span id="l40.14"> var {BrowserUtils} = ChromeUtils.import(&quot;resource://gre/modules/BrowserUtils.jsm&quot;);</span>
<a href="#l40.15"></a><span id="l40.15"> </span>
<a href="#l40.16"></a><span id="l40.16"> var gServer;</span>
<a href="#l40.17"></a><span id="l40.17"> var gOriginalStoreType;</span>
<a href="#l40.18"></a><span id="l40.18"> </span>
<a href="#l40.19"></a><span id="l40.19" class="difflineat">@@ -20,17 +22,17 @@ function clickStoreTypeMenu(aStoreTypeEl</span>
<a href="#l40.20"></a><span id="l40.20">     return;</span>
<a href="#l40.21"></a><span id="l40.21">   }</span>
<a href="#l40.22"></a><span id="l40.22"> </span>
<a href="#l40.23"></a><span id="l40.23">   // Response from migration dialog modal. If the conversion is complete</span>
<a href="#l40.24"></a><span id="l40.24">   // 'response.newRootFolder' will hold the path to the new account root folder,</span>
<a href="#l40.25"></a><span id="l40.25">   // otherwise 'response.newRootFolder' will be null.</span>
<a href="#l40.26"></a><span id="l40.26">   let response = { newRootFolder: null };</span>
<a href="#l40.27"></a><span id="l40.27">   // Send 'response' as an argument to converterDialog.xhtml.</span>
<a href="#l40.28"></a><span id="l40.28" class="difflineminus">-  window.openDialog(&quot;converterDialog.xhtml&quot;,&quot;mailnews:mailstoreconverter&quot;,</span>
<a href="#l40.29"></a><span id="l40.29" class="difflineplus">+  window.openDialog(&quot;converterDialog.xhtml&quot;, &quot;mailnews:mailstoreconverter&quot;,</span>
<a href="#l40.30"></a><span id="l40.30">                     &quot;modal,centerscreen,resizable=no,width=700,height=130&quot;, gServer,</span>
<a href="#l40.31"></a><span id="l40.31">                     aStoreTypeElement.value, response);</span>
<a href="#l40.32"></a><span id="l40.32">   changeStoreType(response);</span>
<a href="#l40.33"></a><span id="l40.33"> }</span>
<a href="#l40.34"></a><span id="l40.34"> </span>
<a href="#l40.35"></a><span id="l40.35"> /**</span>
<a href="#l40.36"></a><span id="l40.36">  * Revert store type to the original store type if converter modal closes</span>
<a href="#l40.37"></a><span id="l40.37">  * before migration is complete, otherwise change original store type to</span>
<a href="#l40.38"></a><span id="l40.38" class="difflineat">@@ -57,27 +59,25 @@ function changeStoreType(aResponse) {</span>
<a href="#l40.39"></a><span id="l40.39">   } else {</span>
<a href="#l40.40"></a><span id="l40.40">     // The conversion failed or was cancelled.</span>
<a href="#l40.41"></a><span id="l40.41">     // Restore selected item to what was selected before conversion.</span>
<a href="#l40.42"></a><span id="l40.42">     document.getElementById(&quot;server.storeTypeMenulist&quot;).value =</span>
<a href="#l40.43"></a><span id="l40.43">       gOriginalStoreType;</span>
<a href="#l40.44"></a><span id="l40.44">   }</span>
<a href="#l40.45"></a><span id="l40.45"> }</span>
<a href="#l40.46"></a><span id="l40.46"> </span>
<a href="#l40.47"></a><span id="l40.47" class="difflineminus">-function onSave()</span>
<a href="#l40.48"></a><span id="l40.48" class="difflineminus">-{</span>
<a href="#l40.49"></a><span id="l40.49" class="difflineplus">+function onSave() {</span>
<a href="#l40.50"></a><span id="l40.50">   let storeContractID = document.getElementById(&quot;server.storeTypeMenulist&quot;)</span>
<a href="#l40.51"></a><span id="l40.51">                                 .selectedItem</span>
<a href="#l40.52"></a><span id="l40.52">                                 .value;</span>
<a href="#l40.53"></a><span id="l40.53">   document.getElementById(&quot;server.storeContractID&quot;)</span>
<a href="#l40.54"></a><span id="l40.54">           .setAttribute(&quot;value&quot;, storeContractID);</span>
<a href="#l40.55"></a><span id="l40.55"> }</span>
<a href="#l40.56"></a><span id="l40.56"> </span>
<a href="#l40.57"></a><span id="l40.57" class="difflineminus">-function onInit(aPageId, aServerId)</span>
<a href="#l40.58"></a><span id="l40.58" class="difflineminus">-{</span>
<a href="#l40.59"></a><span id="l40.59" class="difflineplus">+function onInit(aPageId, aServerId) {</span>
<a href="#l40.60"></a><span id="l40.60">   initServerType();</span>
<a href="#l40.61"></a><span id="l40.61"> </span>
<a href="#l40.62"></a><span id="l40.62">   onCheckItem(&quot;server.biffMinutes&quot;, [&quot;server.doBiff&quot;]);</span>
<a href="#l40.63"></a><span id="l40.63">   onCheckItem(&quot;nntp.maxArticles&quot;, [&quot;nntp.notifyOn&quot;]);</span>
<a href="#l40.64"></a><span id="l40.64">   setupMailOnServerUI();</span>
<a href="#l40.65"></a><span id="l40.65">   setupFixedUI();</span>
<a href="#l40.66"></a><span id="l40.66">   let serverType = document.getElementById(&quot;server.type&quot;).getAttribute(&quot;value&quot;);</span>
<a href="#l40.67"></a><span id="l40.67">   if (serverType == &quot;imap&quot;)</span>
<a href="#l40.68"></a><span id="l40.68" class="difflineat">@@ -102,32 +102,29 @@ function onInit(aPageId, aServerId)</span>
<a href="#l40.69"></a><span id="l40.69">   // Disable store type change if store has not been used yet.</span>
<a href="#l40.70"></a><span id="l40.70">   storeTypeElement.setAttribute(&quot;disabled&quot;,</span>
<a href="#l40.71"></a><span id="l40.71">     gServer.getBoolValue(&quot;canChangeStoreType&quot;) ?</span>
<a href="#l40.72"></a><span id="l40.72">       &quot;false&quot; : !Services.prefs.getBoolPref(&quot;mail.store_conversion_enabled&quot;));</span>
<a href="#l40.73"></a><span id="l40.73">   // Initialise 'gOriginalStoreType' to the item that was originally selected.</span>
<a href="#l40.74"></a><span id="l40.74">   gOriginalStoreType = storeTypeElement.value;</span>
<a href="#l40.75"></a><span id="l40.75"> }</span>
<a href="#l40.76"></a><span id="l40.76"> </span>
<a href="#l40.77"></a><span id="l40.77" class="difflineminus">-function onPreInit(account, accountValues)</span>
<a href="#l40.78"></a><span id="l40.78" class="difflineminus">-{</span>
<a href="#l40.79"></a><span id="l40.79" class="difflineplus">+function onPreInit(account, accountValues) {</span>
<a href="#l40.80"></a><span id="l40.80">   var type = parent.getAccountValue(account, accountValues, &quot;server&quot;, &quot;type&quot;, null, false);</span>
<a href="#l40.81"></a><span id="l40.81">   hideShowControls(type);</span>
<a href="#l40.82"></a><span id="l40.82"> </span>
<a href="#l40.83"></a><span id="l40.83">   gServer = account.incomingServer;</span>
<a href="#l40.84"></a><span id="l40.84"> </span>
<a href="#l40.85"></a><span id="l40.85" class="difflineminus">-  if(!account.incomingServer.canEmptyTrashOnExit)</span>
<a href="#l40.86"></a><span id="l40.86" class="difflineminus">-  {</span>
<a href="#l40.87"></a><span id="l40.87" class="difflineplus">+  if (!account.incomingServer.canEmptyTrashOnExit) {</span>
<a href="#l40.88"></a><span id="l40.88">     document.getElementById(&quot;server.emptyTrashOnExit&quot;).setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l40.89"></a><span id="l40.89">     document.getElementById(&quot;imap.deleteModel.box&quot;).setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l40.90"></a><span id="l40.90">   }</span>
<a href="#l40.91"></a><span id="l40.91"> }</span>
<a href="#l40.92"></a><span id="l40.92"> </span>
<a href="#l40.93"></a><span id="l40.93" class="difflineminus">-function initServerType()</span>
<a href="#l40.94"></a><span id="l40.94" class="difflineminus">-{</span>
<a href="#l40.95"></a><span id="l40.95" class="difflineplus">+function initServerType() {</span>
<a href="#l40.96"></a><span id="l40.96">   var serverType = document.getElementById(&quot;server.type&quot;).getAttribute(&quot;value&quot;);</span>
<a href="#l40.97"></a><span id="l40.97">   var propertyName = &quot;serverType-&quot; + serverType;</span>
<a href="#l40.98"></a><span id="l40.98"> </span>
<a href="#l40.99"></a><span id="l40.99">   var messengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l40.100"></a><span id="l40.100">   var verboseName = messengerBundle.getString(propertyName);</span>
<a href="#l40.101"></a><span id="l40.101">   setDivText(&quot;servertype.verbose&quot;, verboseName);</span>
<a href="#l40.102"></a><span id="l40.102"> </span>
<a href="#l40.103"></a><span id="l40.103">   secureSelect(true);</span>
<a href="#l40.104"></a><span id="l40.104" class="difflineat">@@ -146,82 +143,72 @@ function initServerType()</span>
<a href="#l40.105"></a><span id="l40.105"> </span>
<a href="#l40.106"></a><span id="l40.106">   // Hide deprecated/hidden auth options, unless selected</span>
<a href="#l40.107"></a><span id="l40.107">   hideUnlessSelected(document.getElementById(&quot;authMethod-no&quot;));</span>
<a href="#l40.108"></a><span id="l40.108">   hideUnlessSelected(document.getElementById(&quot;authMethod-old&quot;));</span>
<a href="#l40.109"></a><span id="l40.109">   hideUnlessSelected(document.getElementById(&quot;authMethod-anysecure&quot;));</span>
<a href="#l40.110"></a><span id="l40.110">   hideUnlessSelected(document.getElementById(&quot;authMethod-any&quot;));</span>
<a href="#l40.111"></a><span id="l40.111"> }</span>
<a href="#l40.112"></a><span id="l40.112"> </span>
<a href="#l40.113"></a><span id="l40.113" class="difflineminus">-function hideUnlessSelected(element)</span>
<a href="#l40.114"></a><span id="l40.114" class="difflineminus">-{</span>
<a href="#l40.115"></a><span id="l40.115" class="difflineplus">+function hideUnlessSelected(element) {</span>
<a href="#l40.116"></a><span id="l40.116">   element.hidden = !element.selected;</span>
<a href="#l40.117"></a><span id="l40.117"> }</span>
<a href="#l40.118"></a><span id="l40.118"> </span>
<a href="#l40.119"></a><span id="l40.119" class="difflineminus">-function setLabelFromStringBundle(elementID, stringName)</span>
<a href="#l40.120"></a><span id="l40.120" class="difflineminus">-{</span>
<a href="#l40.121"></a><span id="l40.121" class="difflineplus">+function setLabelFromStringBundle(elementID, stringName) {</span>
<a href="#l40.122"></a><span id="l40.122">   document.getElementById(elementID).label =</span>
<a href="#l40.123"></a><span id="l40.123">       document.getElementById(&quot;bundle_messenger&quot;).getString(stringName);</span>
<a href="#l40.124"></a><span id="l40.124"> }</span>
<a href="#l40.125"></a><span id="l40.125"> </span>
<a href="#l40.126"></a><span id="l40.126" class="difflineminus">-function setDivText(divname, value)</span>
<a href="#l40.127"></a><span id="l40.127" class="difflineminus">-{</span>
<a href="#l40.128"></a><span id="l40.128" class="difflineplus">+function setDivText(divname, value) {</span>
<a href="#l40.129"></a><span id="l40.129">   var div = document.getElementById(divname);</span>
<a href="#l40.130"></a><span id="l40.130">   if (!div)</span>
<a href="#l40.131"></a><span id="l40.131">     return;</span>
<a href="#l40.132"></a><span id="l40.132">   div.setAttribute(&quot;value&quot;, value);</span>
<a href="#l40.133"></a><span id="l40.133"> }</span>
<a href="#l40.134"></a><span id="l40.134"> </span>
<a href="#l40.135"></a><span id="l40.135"> </span>
<a href="#l40.136"></a><span id="l40.136" class="difflineminus">-function onAdvanced()</span>
<a href="#l40.137"></a><span id="l40.137" class="difflineminus">-{</span>
<a href="#l40.138"></a><span id="l40.138" class="difflineplus">+function onAdvanced() {</span>
<a href="#l40.139"></a><span id="l40.139">   // Store the server type and, if an IMAP or POP3 server,</span>
<a href="#l40.140"></a><span id="l40.140">   // the settings needed for the IMAP/POP3 tab into the array</span>
<a href="#l40.141"></a><span id="l40.141">   var serverSettings = {};</span>
<a href="#l40.142"></a><span id="l40.142">   var serverType = document.getElementById(&quot;server.type&quot;).getAttribute(&quot;value&quot;);</span>
<a href="#l40.143"></a><span id="l40.143">   serverSettings.serverType = serverType;</span>
<a href="#l40.144"></a><span id="l40.144"> </span>
<a href="#l40.145"></a><span id="l40.145">   serverSettings.serverPrettyName = gServer.prettyName;</span>
<a href="#l40.146"></a><span id="l40.146">   serverSettings.account = top.getCurrentAccount();</span>
<a href="#l40.147"></a><span id="l40.147"> </span>
<a href="#l40.148"></a><span id="l40.148" class="difflineminus">-  if (serverType == &quot;imap&quot;)</span>
<a href="#l40.149"></a><span id="l40.149" class="difflineminus">-  {</span>
<a href="#l40.150"></a><span id="l40.150" class="difflineplus">+  if (serverType == &quot;imap&quot;) {</span>
<a href="#l40.151"></a><span id="l40.151">     serverSettings.dualUseFolders = document.getElementById(&quot;imap.dualUseFolders&quot;).checked;</span>
<a href="#l40.152"></a><span id="l40.152">     serverSettings.usingSubscription = document.getElementById(&quot;imap.usingSubscription&quot;).checked;</span>
<a href="#l40.153"></a><span id="l40.153">     serverSettings.maximumConnectionsNumber = document.getElementById(&quot;imap.maximumConnectionsNumber&quot;).getAttribute(&quot;value&quot;);</span>
<a href="#l40.154"></a><span id="l40.154">     // string prefs</span>
<a href="#l40.155"></a><span id="l40.155">     serverSettings.personalNamespace = document.getElementById(&quot;imap.personalNamespace&quot;).getAttribute(&quot;value&quot;);</span>
<a href="#l40.156"></a><span id="l40.156">     serverSettings.publicNamespace = document.getElementById(&quot;imap.publicNamespace&quot;).getAttribute(&quot;value&quot;);</span>
<a href="#l40.157"></a><span id="l40.157">     serverSettings.serverDirectory = document.getElementById(&quot;imap.serverDirectory&quot;).getAttribute(&quot;value&quot;);</span>
<a href="#l40.158"></a><span id="l40.158">     serverSettings.otherUsersNamespace = document.getElementById(&quot;imap.otherUsersNamespace&quot;).getAttribute(&quot;value&quot;);</span>
<a href="#l40.159"></a><span id="l40.159">     serverSettings.overrideNamespaces = document.getElementById(&quot;imap.overrideNamespaces&quot;).checked;</span>
<a href="#l40.160"></a><span id="l40.160" class="difflineminus">-  }</span>
<a href="#l40.161"></a><span id="l40.161" class="difflineminus">-  else if (serverType == &quot;pop3&quot;)</span>
<a href="#l40.162"></a><span id="l40.162" class="difflineminus">-  {</span>
<a href="#l40.163"></a><span id="l40.163" class="difflineplus">+  } else if (serverType == &quot;pop3&quot;) {</span>
<a href="#l40.164"></a><span id="l40.164">     serverSettings.deferGetNewMail = document.getElementById(&quot;pop3.deferGetNewMail&quot;).checked;</span>
<a href="#l40.165"></a><span id="l40.165">     serverSettings.deferredToAccount = document.getElementById(&quot;pop3.deferredToAccount&quot;).getAttribute(&quot;value&quot;);</span>
<a href="#l40.166"></a><span id="l40.166">   }</span>
<a href="#l40.167"></a><span id="l40.167"> </span>
<a href="#l40.168"></a><span id="l40.168">   window.openDialog(&quot;chrome://messenger/content/am-server-advanced.xul&quot;,</span>
<a href="#l40.169"></a><span id="l40.169">                     &quot;_blank&quot;, &quot;chrome,modal,titlebar&quot;, serverSettings);</span>
<a href="#l40.170"></a><span id="l40.170"> </span>
<a href="#l40.171"></a><span id="l40.171" class="difflineminus">-  if (serverType == &quot;imap&quot;)</span>
<a href="#l40.172"></a><span id="l40.172" class="difflineminus">-  {</span>
<a href="#l40.173"></a><span id="l40.173" class="difflineplus">+  if (serverType == &quot;imap&quot;) {</span>
<a href="#l40.174"></a><span id="l40.174">     document.getElementById(&quot;imap.dualUseFolders&quot;).checked = serverSettings.dualUseFolders;</span>
<a href="#l40.175"></a><span id="l40.175">     document.getElementById(&quot;imap.usingSubscription&quot;).checked = serverSettings.usingSubscription;</span>
<a href="#l40.176"></a><span id="l40.176">     document.getElementById(&quot;imap.maximumConnectionsNumber&quot;).setAttribute(&quot;value&quot;, serverSettings.maximumConnectionsNumber);</span>
<a href="#l40.177"></a><span id="l40.177">     // string prefs</span>
<a href="#l40.178"></a><span id="l40.178">     document.getElementById(&quot;imap.personalNamespace&quot;).setAttribute(&quot;value&quot;, serverSettings.personalNamespace);</span>
<a href="#l40.179"></a><span id="l40.179">     document.getElementById(&quot;imap.publicNamespace&quot;).setAttribute(&quot;value&quot;, serverSettings.publicNamespace);</span>
<a href="#l40.180"></a><span id="l40.180">     document.getElementById(&quot;imap.serverDirectory&quot;).setAttribute(&quot;value&quot;, serverSettings.serverDirectory);</span>
<a href="#l40.181"></a><span id="l40.181">     document.getElementById(&quot;imap.otherUsersNamespace&quot;).setAttribute(&quot;value&quot;, serverSettings.otherUsersNamespace);</span>
<a href="#l40.182"></a><span id="l40.182">     document.getElementById(&quot;imap.overrideNamespaces&quot;).checked = serverSettings.overrideNamespaces;</span>
<a href="#l40.183"></a><span id="l40.183" class="difflineminus">-  }</span>
<a href="#l40.184"></a><span id="l40.184" class="difflineminus">-  else if (serverType == &quot;pop3&quot;)</span>
<a href="#l40.185"></a><span id="l40.185" class="difflineminus">-  {</span>
<a href="#l40.186"></a><span id="l40.186" class="difflineplus">+  } else if (serverType == &quot;pop3&quot;) {</span>
<a href="#l40.187"></a><span id="l40.187">     document.getElementById(&quot;pop3.deferGetNewMail&quot;).checked = serverSettings.deferGetNewMail;</span>
<a href="#l40.188"></a><span id="l40.188">     document.getElementById(&quot;pop3.deferredToAccount&quot;).setAttribute(&quot;value&quot;, serverSettings.deferredToAccount);</span>
<a href="#l40.189"></a><span id="l40.189">     let pop3Server = gServer.QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l40.190"></a><span id="l40.190">     // we're explicitly setting this so we'll go through the SetDeferredToAccount method</span>
<a href="#l40.191"></a><span id="l40.191">     pop3Server.deferredToAccount = serverSettings.deferredToAccount;</span>
<a href="#l40.192"></a><span id="l40.192">     // Setting the server to be deferred causes a rebuild of the account tree,</span>
<a href="#l40.193"></a><span id="l40.193">     // losing the current selection. Reselect the current server again as it</span>
<a href="#l40.194"></a><span id="l40.194">     // didn't really disappear.</span>
<a href="#l40.195"></a><span id="l40.195" class="difflineat">@@ -267,20 +254,18 @@ function onAdvanced()</span>
<a href="#l40.196"></a><span id="l40.196">                                spamActionTargetAccount);</span>
<a href="#l40.197"></a><span id="l40.197">         parent.setAccountValue(accountValues, &quot;server&quot;, &quot;spamActionTargetFolder&quot;,</span>
<a href="#l40.198"></a><span id="l40.198">                                spamActionTargetFolder);</span>
<a href="#l40.199"></a><span id="l40.199">       }</span>
<a href="#l40.200"></a><span id="l40.200">     }</span>
<a href="#l40.201"></a><span id="l40.201">   }</span>
<a href="#l40.202"></a><span id="l40.202"> }</span>
<a href="#l40.203"></a><span id="l40.203"> </span>
<a href="#l40.204"></a><span id="l40.204" class="difflineminus">-function secureSelect(aLoading)</span>
<a href="#l40.205"></a><span id="l40.205" class="difflineminus">-{</span>
<a href="#l40.206"></a><span id="l40.206" class="difflineplus">+function secureSelect(aLoading) {</span>
<a href="#l40.207"></a><span id="l40.207">     var socketType = document.getElementById(&quot;server.socketType&quot;).value;</span>
<a href="#l40.208"></a><span id="l40.208" class="difflineminus">-    var serverType = document.getElementById(&quot;server.type&quot;).value;</span>
<a href="#l40.209"></a><span id="l40.209">     var defaultPort = gServer.protocolInfo.getDefaultServerPort(false);</span>
<a href="#l40.210"></a><span id="l40.210">     var defaultPortSecure = gServer.protocolInfo.getDefaultServerPort(true);</span>
<a href="#l40.211"></a><span id="l40.211">     var port = document.getElementById(&quot;server.port&quot;);</span>
<a href="#l40.212"></a><span id="l40.212">     var portDefault = document.getElementById(&quot;defaultPort&quot;);</span>
<a href="#l40.213"></a><span id="l40.213">     var prevDefaultPort = portDefault.value;</span>
<a href="#l40.214"></a><span id="l40.214"> </span>
<a href="#l40.215"></a><span id="l40.215">     if (socketType == Ci.nsMsgSocketType.SSL) {</span>
<a href="#l40.216"></a><span id="l40.216">       portDefault.value = defaultPortSecure;</span>
<a href="#l40.217"></a><span id="l40.217" class="difflineat">@@ -294,49 +279,45 @@ function secureSelect(aLoading)</span>
<a href="#l40.218"></a><span id="l40.218"> </span>
<a href="#l40.219"></a><span id="l40.219">     // switch &quot;insecure password&quot; label</span>
<a href="#l40.220"></a><span id="l40.220">     setLabelFromStringBundle(&quot;authMethod-password-cleartext&quot;,</span>
<a href="#l40.221"></a><span id="l40.221">         socketType == Ci.nsMsgSocketType.SSL ||</span>
<a href="#l40.222"></a><span id="l40.222">         socketType == Ci.nsMsgSocketType.alwaysSTARTTLS ?</span>
<a href="#l40.223"></a><span id="l40.223">         &quot;authPasswordCleartextViaSSL&quot; : &quot;authPasswordCleartextInsecurely&quot;);</span>
<a href="#l40.224"></a><span id="l40.224"> }</span>
<a href="#l40.225"></a><span id="l40.225"> </span>
<a href="#l40.226"></a><span id="l40.226" class="difflineminus">-function setupMailOnServerUI()</span>
<a href="#l40.227"></a><span id="l40.227" class="difflineminus">-{</span>
<a href="#l40.228"></a><span id="l40.228" class="difflineplus">+function setupMailOnServerUI() {</span>
<a href="#l40.229"></a><span id="l40.229">   onCheckItem(&quot;pop3.deleteMailLeftOnServer&quot;, [&quot;pop3.leaveMessagesOnServer&quot;]);</span>
<a href="#l40.230"></a><span id="l40.230">   setupAgeMsgOnServerUI();</span>
<a href="#l40.231"></a><span id="l40.231"> }</span>
<a href="#l40.232"></a><span id="l40.232"> </span>
<a href="#l40.233"></a><span id="l40.233" class="difflineminus">-function setupAgeMsgOnServerUI()</span>
<a href="#l40.234"></a><span id="l40.234" class="difflineminus">-{</span>
<a href="#l40.235"></a><span id="l40.235" class="difflineplus">+function setupAgeMsgOnServerUI() {</span>
<a href="#l40.236"></a><span id="l40.236">   const kLeaveMsgsId = &quot;pop3.leaveMessagesOnServer&quot;;</span>
<a href="#l40.237"></a><span id="l40.237">   const kDeleteByAgeId = &quot;pop3.deleteByAgeFromServer&quot;;</span>
<a href="#l40.238"></a><span id="l40.238">   onCheckItem(kDeleteByAgeId, [kLeaveMsgsId]);</span>
<a href="#l40.239"></a><span id="l40.239">   onCheckItem(&quot;daysEnd&quot;, [kLeaveMsgsId]);</span>
<a href="#l40.240"></a><span id="l40.240">   onCheckItem(&quot;pop3.numDaysToLeaveOnServer&quot;, [kLeaveMsgsId, kDeleteByAgeId]);</span>
<a href="#l40.241"></a><span id="l40.241"> }</span>
<a href="#l40.242"></a><span id="l40.242"> </span>
<a href="#l40.243"></a><span id="l40.243" class="difflineminus">-function setupFixedUI()</span>
<a href="#l40.244"></a><span id="l40.244" class="difflineminus">-{</span>
<a href="#l40.245"></a><span id="l40.245" class="difflineplus">+function setupFixedUI() {</span>
<a href="#l40.246"></a><span id="l40.246">   var controls = [document.getElementById(&quot;fixedServerName&quot;),</span>
<a href="#l40.247"></a><span id="l40.247">                   document.getElementById(&quot;fixedUserName&quot;),</span>
<a href="#l40.248"></a><span id="l40.248">                   document.getElementById(&quot;fixedServerPort&quot;)];</span>
<a href="#l40.249"></a><span id="l40.249"> </span>
<a href="#l40.250"></a><span id="l40.250">   var len = controls.length;</span>
<a href="#l40.251"></a><span id="l40.251" class="difflineminus">-  for (var i=0; i&lt;len; i++) {</span>
<a href="#l40.252"></a><span id="l40.252" class="difflineplus">+  for (let i = 0; i &lt; len; i++) {</span>
<a href="#l40.253"></a><span id="l40.253">     var fixedElement = controls[i];</span>
<a href="#l40.254"></a><span id="l40.254">     var otherElement = document.getElementById(fixedElement.getAttribute(&quot;use&quot;));</span>
<a href="#l40.255"></a><span id="l40.255"> </span>
<a href="#l40.256"></a><span id="l40.256">     fixedElement.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l40.257"></a><span id="l40.257">     otherElement.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l40.258"></a><span id="l40.258">   }</span>
<a href="#l40.259"></a><span id="l40.259"> }</span>
<a href="#l40.260"></a><span id="l40.260"> </span>
<a href="#l40.261"></a><span id="l40.261" class="difflineminus">-function BrowseForNewsrc()</span>
<a href="#l40.262"></a><span id="l40.262" class="difflineminus">-{</span>
<a href="#l40.263"></a><span id="l40.263" class="difflineplus">+function BrowseForNewsrc() {</span>
<a href="#l40.264"></a><span id="l40.264">   const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l40.265"></a><span id="l40.265">   const nsIFile = Ci.nsIFile;</span>
<a href="#l40.266"></a><span id="l40.266"> </span>
<a href="#l40.267"></a><span id="l40.267">   var newsrcTextBox = document.getElementById(&quot;nntp.newsrcFilePath&quot;);</span>
<a href="#l40.268"></a><span id="l40.268">   var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;].createInstance(nsIFilePicker);</span>
<a href="#l40.269"></a><span id="l40.269">   fp.init(window,</span>
<a href="#l40.270"></a><span id="l40.270">           document.getElementById(&quot;browseForNewsrc&quot;).getAttribute(&quot;filepickertitle&quot;),</span>
<a href="#l40.271"></a><span id="l40.271">           nsIFilePicker.modeSave);</span>
<a href="#l40.272"></a><span id="l40.272" class="difflineat">@@ -360,54 +341,51 @@ function BrowseForNewsrc()</span>
<a href="#l40.273"></a><span id="l40.273">   fp.open(rv =&gt; {</span>
<a href="#l40.274"></a><span id="l40.274">     if (rv != nsIFilePicker.returnOK || !fp.file) {</span>
<a href="#l40.275"></a><span id="l40.275">       return;</span>
<a href="#l40.276"></a><span id="l40.276">     }</span>
<a href="#l40.277"></a><span id="l40.277">     newsrcTextBox.value = fp.file.path;</span>
<a href="#l40.278"></a><span id="l40.278">   });</span>
<a href="#l40.279"></a><span id="l40.279"> }</span>
<a href="#l40.280"></a><span id="l40.280"> </span>
<a href="#l40.281"></a><span id="l40.281" class="difflineminus">-function setupImapDeleteUI(aServerId)</span>
<a href="#l40.282"></a><span id="l40.282" class="difflineminus">-{</span>
<a href="#l40.283"></a><span id="l40.283" class="difflineplus">+function setupImapDeleteUI(aServerId) {</span>
<a href="#l40.284"></a><span id="l40.284">   // read delete_model preference</span>
<a href="#l40.285"></a><span id="l40.285">   var deleteModel = document.getElementById(&quot;imap.deleteModel&quot;).getAttribute(&quot;value&quot;);</span>
<a href="#l40.286"></a><span id="l40.286">   selectImapDeleteModel(deleteModel);</span>
<a href="#l40.287"></a><span id="l40.287"> </span>
<a href="#l40.288"></a><span id="l40.288">   // read trash folder path preference</span>
<a href="#l40.289"></a><span id="l40.289">   var trashFolderName = getTrashFolderName();</span>
<a href="#l40.290"></a><span id="l40.290"> </span>
<a href="#l40.291"></a><span id="l40.291">   // set folderPicker menulist</span>
<a href="#l40.292"></a><span id="l40.292">   var trashPopup = document.getElementById(&quot;msgTrashFolderPopup&quot;);</span>
<a href="#l40.293"></a><span id="l40.293">   trashPopup._teardown();</span>
<a href="#l40.294"></a><span id="l40.294">   trashPopup._parentFolder = MailUtils.getOrCreateFolder(aServerId);</span>
<a href="#l40.295"></a><span id="l40.295">   trashPopup._ensureInitialized();</span>
<a href="#l40.296"></a><span id="l40.296"> </span>
<a href="#l40.297"></a><span id="l40.297">   // Convert the folder path in Unicode to MUTF-7.</span>
<a href="#l40.298"></a><span id="l40.298" class="difflineminus">-  let manager = Cc['@mozilla.org/charset-converter-manager;1']</span>
<a href="#l40.299"></a><span id="l40.299" class="difflineplus">+  let manager = Cc[&quot;@mozilla.org/charset-converter-manager;1&quot;]</span>
<a href="#l40.300"></a><span id="l40.300">                   .getService(Ci.nsICharsetConverterManager);</span>
<a href="#l40.301"></a><span id="l40.301">   // Escape backslash and double-quote with another backslash before encoding.</span>
<a href="#l40.302"></a><span id="l40.302" class="difflineminus">-  let trashMutf7 = manager.unicodeToMutf7(trashFolderName.replace(/([\\&quot;])/g, '\\$1'));</span>
<a href="#l40.303"></a><span id="l40.303" class="difflineplus">+  let trashMutf7 = manager.unicodeToMutf7(trashFolderName.replace(/([\\&quot;])/g, &quot;\\$1&quot;));</span>
<a href="#l40.304"></a><span id="l40.304">   // TODO: There is something wrong here, selectFolder() fails even if the</span>
<a href="#l40.305"></a><span id="l40.305">   // folder does exist. Try to fix in bug 802609.</span>
<a href="#l40.306"></a><span id="l40.306">   let trashFolder = MailUtils.getOrCreateFolder(aServerId + &quot;/&quot; + trashMutf7);</span>
<a href="#l40.307"></a><span id="l40.307">   try {</span>
<a href="#l40.308"></a><span id="l40.308">     trashPopup.selectFolder(trashFolder);</span>
<a href="#l40.309"></a><span id="l40.309" class="difflineminus">-  } catch(ex) {</span>
<a href="#l40.310"></a><span id="l40.310" class="difflineplus">+  } catch (ex) {</span>
<a href="#l40.311"></a><span id="l40.311">     trashPopup.parentNode.setAttribute(&quot;label&quot;, trashFolder.prettyName);</span>
<a href="#l40.312"></a><span id="l40.312">   }</span>
<a href="#l40.313"></a><span id="l40.313">   trashPopup.parentNode.folder = trashFolder;</span>
<a href="#l40.314"></a><span id="l40.314"> }</span>
<a href="#l40.315"></a><span id="l40.315"> </span>
<a href="#l40.316"></a><span id="l40.316" class="difflineminus">-function selectImapDeleteModel(choice)</span>
<a href="#l40.317"></a><span id="l40.317" class="difflineminus">-{</span>
<a href="#l40.318"></a><span id="l40.318" class="difflineplus">+function selectImapDeleteModel(choice) {</span>
<a href="#l40.319"></a><span id="l40.319">   // set deleteModel to selected mode</span>
<a href="#l40.320"></a><span id="l40.320">   document.getElementById(&quot;imap.deleteModel&quot;).setAttribute(&quot;value&quot;, choice);</span>
<a href="#l40.321"></a><span id="l40.321"> </span>
<a href="#l40.322"></a><span id="l40.322" class="difflineminus">-  switch (choice)</span>
<a href="#l40.323"></a><span id="l40.323" class="difflineminus">-  {</span>
<a href="#l40.324"></a><span id="l40.324" class="difflineplus">+  switch (choice) {</span>
<a href="#l40.325"></a><span id="l40.325">     case &quot;0&quot; : // markDeleted</span>
<a href="#l40.326"></a><span id="l40.326">       // disable folderPicker</span>
<a href="#l40.327"></a><span id="l40.327">       document.getElementById(&quot;msgTrashFolderPicker&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l40.328"></a><span id="l40.328">       break;</span>
<a href="#l40.329"></a><span id="l40.329">     case &quot;1&quot; : // moveToTrashFolder</span>
<a href="#l40.330"></a><span id="l40.330">       // enable folderPicker</span>
<a href="#l40.331"></a><span id="l40.331">       document.getElementById(&quot;msgTrashFolderPicker&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l40.332"></a><span id="l40.332">       break;</span>
<a href="#l40.333"></a><span id="l40.333" class="difflineat">@@ -417,42 +395,40 @@ function selectImapDeleteModel(choice)</span>
<a href="#l40.334"></a><span id="l40.334">       break;</span>
<a href="#l40.335"></a><span id="l40.335">     default :</span>
<a href="#l40.336"></a><span id="l40.336">       dump(&quot;Error in enabling/disabling server.TrashFolderPicker\n&quot;);</span>
<a href="#l40.337"></a><span id="l40.337">       break;</span>
<a href="#l40.338"></a><span id="l40.338">   }</span>
<a href="#l40.339"></a><span id="l40.339"> }</span>
<a href="#l40.340"></a><span id="l40.340"> </span>
<a href="#l40.341"></a><span id="l40.341"> // Capture any menulist changes from folderPicker</span>
<a href="#l40.342"></a><span id="l40.342" class="difflineminus">-function folderPickerChange(aEvent)</span>
<a href="#l40.343"></a><span id="l40.343" class="difflineminus">-{</span>
<a href="#l40.344"></a><span id="l40.344" class="difflineplus">+function folderPickerChange(aEvent) {</span>
<a href="#l40.345"></a><span id="l40.345">   var folder = aEvent.target._folder;</span>
<a href="#l40.346"></a><span id="l40.346">   // Since we need to deal with localised folder names, we simply use</span>
<a href="#l40.347"></a><span id="l40.347">   // the path of the URI like we do in nsImapIncomingServer::DiscoveryDone().</span>
<a href="#l40.348"></a><span id="l40.348">   // Note that the path is returned with a leading slash which we need to remove.</span>
<a href="#l40.349"></a><span id="l40.349">   var folderPath = Services.io.newURI(folder.URI).pathQueryRef.substring(1);</span>
<a href="#l40.350"></a><span id="l40.350">   // We need to convert that from MUTF-7 to Unicode.</span>
<a href="#l40.351"></a><span id="l40.351" class="difflineminus">-  var manager = Cc['@mozilla.org/charset-converter-manager;1']</span>
<a href="#l40.352"></a><span id="l40.352" class="difflineplus">+  var manager = Cc[&quot;@mozilla.org/charset-converter-manager;1&quot;]</span>
<a href="#l40.353"></a><span id="l40.353">                   .getService(Ci.nsICharsetConverterManager);</span>
<a href="#l40.354"></a><span id="l40.354">   var trashUnicode = manager.mutf7ToUnicode(</span>
<a href="#l40.355"></a><span id="l40.355">     Services.netUtils.unescapeString(folderPath, Ci.nsINetUtil.ESCAPE_URL_PATH));</span>
<a href="#l40.356"></a><span id="l40.356"> </span>
<a href="#l40.357"></a><span id="l40.357">   // Set the value to be persisted.</span>
<a href="#l40.358"></a><span id="l40.358">   document.getElementById(&quot;imap.trashFolderName&quot;)</span>
<a href="#l40.359"></a><span id="l40.359">           .setAttribute(&quot;value&quot;, trashUnicode);</span>
<a href="#l40.360"></a><span id="l40.360"> </span>
<a href="#l40.361"></a><span id="l40.361">   // Update the widget to show/do correct things even for subfolders.</span>
<a href="#l40.362"></a><span id="l40.362">   var trashFolderPicker = document.getElementById(&quot;msgTrashFolderPicker&quot;);</span>
<a href="#l40.363"></a><span id="l40.363">   trashFolderPicker.menupopup.selectFolder(folder);</span>
<a href="#l40.364"></a><span id="l40.364"> }</span>
<a href="#l40.365"></a><span id="l40.365"> </span>
<a href="#l40.366"></a><span id="l40.366"> // Get trash_folder_name from prefs. Despite its name this returns</span>
<a href="#l40.367"></a><span id="l40.367"> // a folder path, for example INBOX/Trash.</span>
<a href="#l40.368"></a><span id="l40.368" class="difflineminus">-function getTrashFolderName()</span>
<a href="#l40.369"></a><span id="l40.369" class="difflineminus">-{</span>
<a href="#l40.370"></a><span id="l40.370" class="difflineplus">+function getTrashFolderName() {</span>
<a href="#l40.371"></a><span id="l40.371">   var trashFolderName = document.getElementById(&quot;imap.trashFolderName&quot;).getAttribute(&quot;value&quot;);</span>
<a href="#l40.372"></a><span id="l40.372">   // if the preference hasn't been set, set it to a sane default</span>
<a href="#l40.373"></a><span id="l40.373">   if (!trashFolderName) {</span>
<a href="#l40.374"></a><span id="l40.374">     trashFolderName = &quot;Trash&quot;;  // XXX Is this a useful default?</span>
<a href="#l40.375"></a><span id="l40.375" class="difflineminus">-    document.getElementById(&quot;imap.trashFolderName&quot;).setAttribute(&quot;value&quot;,trashFolderName);</span>
<a href="#l40.376"></a><span id="l40.376" class="difflineplus">+    document.getElementById(&quot;imap.trashFolderName&quot;).setAttribute(&quot;value&quot;, trashFolderName);</span>
<a href="#l40.377"></a><span id="l40.377">   }</span>
<a href="#l40.378"></a><span id="l40.378">   return trashFolderName;</span>
<a href="#l40.379"></a><span id="l40.379"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-serverwithnoidentities.js</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-serverwithnoidentities.js</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -1,13 +1,14 @@</span>
<a href="#l41.4"></a><span id="l41.4"> /* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l41.5"></a><span id="l41.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l41.6"></a><span id="l41.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l41.7"></a><span id="l41.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l41.8"></a><span id="l41.8"> </span>
<a href="#l41.9"></a><span id="l41.9" class="difflineplus">+var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l41.10"></a><span id="l41.10"> var {BrowserUtils} = ChromeUtils.import(&quot;resource://gre/modules/BrowserUtils.jsm&quot;);</span>
<a href="#l41.11"></a><span id="l41.11"> </span>
<a href="#l41.12"></a><span id="l41.12"> var gAccount;</span>
<a href="#l41.13"></a><span id="l41.13"> var gOriginalStoreType;</span>
<a href="#l41.14"></a><span id="l41.14"> </span>
<a href="#l41.15"></a><span id="l41.15"> /**</span>
<a href="#l41.16"></a><span id="l41.16">  * Called when the store type menu is clicked.</span>
<a href="#l41.17"></a><span id="l41.17">  * @param {Object} aStoreTypeElement - store type menu list element.</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineat">@@ -17,17 +18,17 @@ function clickStoreTypeMenu(aStoreTypeEl</span>
<a href="#l41.19"></a><span id="l41.19">     return;</span>
<a href="#l41.20"></a><span id="l41.20">   }</span>
<a href="#l41.21"></a><span id="l41.21"> </span>
<a href="#l41.22"></a><span id="l41.22">   // Response from migration dialog modal. If the conversion is complete</span>
<a href="#l41.23"></a><span id="l41.23">   // 'response.newRootFolder' will hold the path to the new account root folder,</span>
<a href="#l41.24"></a><span id="l41.24">   // otherwise 'response.newRootFolder' will be null.</span>
<a href="#l41.25"></a><span id="l41.25">   let response = { newRootFolder: null };</span>
<a href="#l41.26"></a><span id="l41.26">   // Send 'response' as an argument to converterDialog.xhtml.</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineminus">-  window.openDialog(&quot;converterDialog.xhtml&quot;,&quot;mailnews:mailstoreconverter&quot;,</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineplus">+  window.openDialog(&quot;converterDialog.xhtml&quot;, &quot;mailnews:mailstoreconverter&quot;,</span>
<a href="#l41.29"></a><span id="l41.29">                     &quot;modal,centerscreen,width=800,height=180&quot;,</span>
<a href="#l41.30"></a><span id="l41.30">                     gAccount.incomingServer,</span>
<a href="#l41.31"></a><span id="l41.31">                     aStoreTypeElement.value, response);</span>
<a href="#l41.32"></a><span id="l41.32">   changeStoreType(response);</span>
<a href="#l41.33"></a><span id="l41.33"> }</span>
<a href="#l41.34"></a><span id="l41.34"> </span>
<a href="#l41.35"></a><span id="l41.35"> /**</span>
<a href="#l41.36"></a><span id="l41.36">  * Revert store type to the original store type if converter modal closes</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineat">@@ -67,17 +68,16 @@ function onInit(aPageId, aServerId) {</span>
<a href="#l41.38"></a><span id="l41.38">   // Initialise 'gOriginalStoreType' to the item that was originally selected.</span>
<a href="#l41.39"></a><span id="l41.39">   gOriginalStoreType = storeTypeElement.value;</span>
<a href="#l41.40"></a><span id="l41.40"> }</span>
<a href="#l41.41"></a><span id="l41.41"> </span>
<a href="#l41.42"></a><span id="l41.42"> function onPreInit(account, accountValues) {</span>
<a href="#l41.43"></a><span id="l41.43">   gAccount = account;</span>
<a href="#l41.44"></a><span id="l41.44"> }</span>
<a href="#l41.45"></a><span id="l41.45"> </span>
<a href="#l41.46"></a><span id="l41.46" class="difflineminus">-function onSave()</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineminus">-{</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineplus">+function onSave() {</span>
<a href="#l41.49"></a><span id="l41.49">   let storeContractID = document.getElementById(&quot;server.storeTypeMenulist&quot;)</span>
<a href="#l41.50"></a><span id="l41.50">                                 .selectedItem</span>
<a href="#l41.51"></a><span id="l41.51">                                 .value;</span>
<a href="#l41.52"></a><span id="l41.52">   document.getElementById(&quot;server.storeContractID&quot;)</span>
<a href="#l41.53"></a><span id="l41.53">           .setAttribute(&quot;value&quot;, storeContractID);</span>
<a href="#l41.54"></a><span id="l41.54"> }</span>
<a href="#l41.55"></a><span id="l41.55"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/base/prefs/content/am-smtp.js</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/base/prefs/content/am-smtp.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -1,135 +1,123 @@</span>
<a href="#l42.4"></a><span id="l42.4"> /* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l42.5"></a><span id="l42.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l42.6"></a><span id="l42.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l42.7"></a><span id="l42.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l42.8"></a><span id="l42.8"> </span>
<a href="#l42.9"></a><span id="l42.9" class="difflineplus">+/* import-globals-from amUtils.js */</span>
<a href="#l42.10"></a><span id="l42.10" class="difflineplus">+</span>
<a href="#l42.11"></a><span id="l42.11"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l42.12"></a><span id="l42.12"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l42.13"></a><span id="l42.13"> </span>
<a href="#l42.14"></a><span id="l42.14" class="difflineminus">-var gSmtpServerListWindow =</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineminus">-{</span>
<a href="#l42.16"></a><span id="l42.16" class="difflineplus">+var gSmtpServerListWindow = {</span>
<a href="#l42.17"></a><span id="l42.17">   mBundle: null,</span>
<a href="#l42.18"></a><span id="l42.18">   mServerList: null,</span>
<a href="#l42.19"></a><span id="l42.19">   mAddButton: null,</span>
<a href="#l42.20"></a><span id="l42.20">   mEditButton: null,</span>
<a href="#l42.21"></a><span id="l42.21">   mDeleteButton: null,</span>
<a href="#l42.22"></a><span id="l42.22">   mSetDefaultServerButton: null,</span>
<a href="#l42.23"></a><span id="l42.23"> </span>
<a href="#l42.24"></a><span id="l42.24" class="difflineminus">-  onLoad: function()</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineminus">-  {</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineminus">-    parent.onPanelLoaded('am-smtp.xul');</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineplus">+  onLoad() {</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineplus">+    parent.onPanelLoaded(&quot;am-smtp.xul&quot;);</span>
<a href="#l42.29"></a><span id="l42.29"> </span>
<a href="#l42.30"></a><span id="l42.30">     this.mBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l42.31"></a><span id="l42.31">     this.mServerList = document.getElementById(&quot;smtpList&quot;);</span>
<a href="#l42.32"></a><span id="l42.32">     this.mAddButton = document.getElementById(&quot;addButton&quot;);</span>
<a href="#l42.33"></a><span id="l42.33">     this.mEditButton = document.getElementById(&quot;editButton&quot;);</span>
<a href="#l42.34"></a><span id="l42.34">     this.mDeleteButton = document.getElementById(&quot;deleteButton&quot;);</span>
<a href="#l42.35"></a><span id="l42.35">     this.mSetDefaultServerButton = document.getElementById(&quot;setDefaultButton&quot;);</span>
<a href="#l42.36"></a><span id="l42.36"> </span>
<a href="#l42.37"></a><span id="l42.37">     this.refreshServerList(&quot;&quot;, false);</span>
<a href="#l42.38"></a><span id="l42.38"> </span>
<a href="#l42.39"></a><span id="l42.39">     this.updateButtons();</span>
<a href="#l42.40"></a><span id="l42.40">   },</span>
<a href="#l42.41"></a><span id="l42.41"> </span>
<a href="#l42.42"></a><span id="l42.42" class="difflineminus">-  onSelectionChanged: function(aEvent)</span>
<a href="#l42.43"></a><span id="l42.43" class="difflineminus">-  {</span>
<a href="#l42.44"></a><span id="l42.44" class="difflineplus">+  onSelectionChanged(aEvent) {</span>
<a href="#l42.45"></a><span id="l42.45">     var server = this.getSelectedServer();</span>
<a href="#l42.46"></a><span id="l42.46">     if (!server)</span>
<a href="#l42.47"></a><span id="l42.47">       return;</span>
<a href="#l42.48"></a><span id="l42.48"> </span>
<a href="#l42.49"></a><span id="l42.49">     this.updateButtons();</span>
<a href="#l42.50"></a><span id="l42.50">     this.updateServerInfoBox(server);</span>
<a href="#l42.51"></a><span id="l42.51">   },</span>
<a href="#l42.52"></a><span id="l42.52"> </span>
<a href="#l42.53"></a><span id="l42.53" class="difflineminus">-  onDeleteServer: function (aEvent)</span>
<a href="#l42.54"></a><span id="l42.54" class="difflineminus">-  {</span>
<a href="#l42.55"></a><span id="l42.55" class="difflineplus">+  onDeleteServer(aEvent) {</span>
<a href="#l42.56"></a><span id="l42.56">     var server = this.getSelectedServer();</span>
<a href="#l42.57"></a><span id="l42.57">     if (!server)</span>
<a href="#l42.58"></a><span id="l42.58">       return;</span>
<a href="#l42.59"></a><span id="l42.59"> </span>
<a href="#l42.60"></a><span id="l42.60">     // confirm deletion</span>
<a href="#l42.61"></a><span id="l42.61">     let cancel = Services.prompt.confirmEx(window,</span>
<a href="#l42.62"></a><span id="l42.62">       this.mBundle.getString(&quot;smtpServers-confirmServerDeletionTitle&quot;),</span>
<a href="#l42.63"></a><span id="l42.63">       this.mBundle.getFormattedString(&quot;smtpServers-confirmServerDeletion&quot;,</span>
<a href="#l42.64"></a><span id="l42.64">                                       [server.hostname], 1),</span>
<a href="#l42.65"></a><span id="l42.65">       Services.prompt.STD_YES_NO_BUTTONS, null, null, null, null, { });</span>
<a href="#l42.66"></a><span id="l42.66"> </span>
<a href="#l42.67"></a><span id="l42.67" class="difflineminus">-    if (!cancel)</span>
<a href="#l42.68"></a><span id="l42.68" class="difflineminus">-    {</span>
<a href="#l42.69"></a><span id="l42.69" class="difflineplus">+    if (!cancel) {</span>
<a href="#l42.70"></a><span id="l42.70">       MailServices.smtp.deleteServer(server);</span>
<a href="#l42.71"></a><span id="l42.71">       parent.replaceWithDefaultSmtpServer(server.key);</span>
<a href="#l42.72"></a><span id="l42.72">       this.refreshServerList(&quot;&quot;, true);</span>
<a href="#l42.73"></a><span id="l42.73">     }</span>
<a href="#l42.74"></a><span id="l42.74">   },</span>
<a href="#l42.75"></a><span id="l42.75"> </span>
<a href="#l42.76"></a><span id="l42.76" class="difflineminus">-  onAddServer: function (aEvent)</span>
<a href="#l42.77"></a><span id="l42.77" class="difflineminus">-  {</span>
<a href="#l42.78"></a><span id="l42.78" class="difflineplus">+  onAddServer(aEvent) {</span>
<a href="#l42.79"></a><span id="l42.79">     this.openServerEditor(null);</span>
<a href="#l42.80"></a><span id="l42.80">   },</span>
<a href="#l42.81"></a><span id="l42.81"> </span>
<a href="#l42.82"></a><span id="l42.82" class="difflineminus">-  onEditServer: function (aEvent)</span>
<a href="#l42.83"></a><span id="l42.83" class="difflineminus">-  {</span>
<a href="#l42.84"></a><span id="l42.84" class="difflineplus">+  onEditServer(aEvent) {</span>
<a href="#l42.85"></a><span id="l42.85">     let server = this.getSelectedServer();</span>
<a href="#l42.86"></a><span id="l42.86">     if (!server)</span>
<a href="#l42.87"></a><span id="l42.87">       return;</span>
<a href="#l42.88"></a><span id="l42.88"> </span>
<a href="#l42.89"></a><span id="l42.89">     this.openServerEditor(server);</span>
<a href="#l42.90"></a><span id="l42.90">   },</span>
<a href="#l42.91"></a><span id="l42.91"> </span>
<a href="#l42.92"></a><span id="l42.92" class="difflineminus">-  onSetDefaultServer: function(aEvent)</span>
<a href="#l42.93"></a><span id="l42.93" class="difflineminus">-  {</span>
<a href="#l42.94"></a><span id="l42.94" class="difflineplus">+  onSetDefaultServer(aEvent) {</span>
<a href="#l42.95"></a><span id="l42.95">     let server = this.getSelectedServer();</span>
<a href="#l42.96"></a><span id="l42.96">     if (!server)</span>
<a href="#l42.97"></a><span id="l42.97">       return;</span>
<a href="#l42.98"></a><span id="l42.98"> </span>
<a href="#l42.99"></a><span id="l42.99">     MailServices.smtp.defaultServer = server;</span>
<a href="#l42.100"></a><span id="l42.100">     this.refreshServerList(MailServices.smtp.defaultServer.key, true);</span>
<a href="#l42.101"></a><span id="l42.101">   },</span>
<a href="#l42.102"></a><span id="l42.102"> </span>
<a href="#l42.103"></a><span id="l42.103" class="difflineminus">-  updateButtons: function()</span>
<a href="#l42.104"></a><span id="l42.104" class="difflineminus">-  {</span>
<a href="#l42.105"></a><span id="l42.105" class="difflineplus">+  updateButtons() {</span>
<a href="#l42.106"></a><span id="l42.106">     let server = this.getSelectedServer();</span>
<a href="#l42.107"></a><span id="l42.107"> </span>
<a href="#l42.108"></a><span id="l42.108">     // can't delete default server</span>
<a href="#l42.109"></a><span id="l42.109" class="difflineminus">-    if (server &amp;&amp; MailServices.smtp.defaultServer == server)</span>
<a href="#l42.110"></a><span id="l42.110" class="difflineminus">-    {</span>
<a href="#l42.111"></a><span id="l42.111" class="difflineplus">+    if (server &amp;&amp; MailServices.smtp.defaultServer == server) {</span>
<a href="#l42.112"></a><span id="l42.112">       this.mSetDefaultServerButton.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l42.113"></a><span id="l42.113">       this.mDeleteButton.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l42.114"></a><span id="l42.114" class="difflineminus">-    }</span>
<a href="#l42.115"></a><span id="l42.115" class="difflineminus">-    else</span>
<a href="#l42.116"></a><span id="l42.116" class="difflineminus">-    {</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineplus">+    } else {</span>
<a href="#l42.118"></a><span id="l42.118">       this.mSetDefaultServerButton.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l42.119"></a><span id="l42.119">       this.mDeleteButton.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l42.120"></a><span id="l42.120">     }</span>
<a href="#l42.121"></a><span id="l42.121"> </span>
<a href="#l42.122"></a><span id="l42.122">     if (!server)</span>
<a href="#l42.123"></a><span id="l42.123">       this.mEditButton.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l42.124"></a><span id="l42.124">     else</span>
<a href="#l42.125"></a><span id="l42.125">       this.mEditButton.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l42.126"></a><span id="l42.126">   },</span>
<a href="#l42.127"></a><span id="l42.127"> </span>
<a href="#l42.128"></a><span id="l42.128" class="difflineminus">-  updateServerInfoBox: function(aServer)</span>
<a href="#l42.129"></a><span id="l42.129" class="difflineminus">-  {</span>
<a href="#l42.130"></a><span id="l42.130" class="difflineplus">+  updateServerInfoBox(aServer) {</span>
<a href="#l42.131"></a><span id="l42.131">     var noneSelected = this.mBundle.getString(&quot;smtpServerList-NotSpecified&quot;);</span>
<a href="#l42.132"></a><span id="l42.132"> </span>
<a href="#l42.133"></a><span id="l42.133" class="difflineminus">-    document.getElementById('nameValue').value = aServer.hostname;</span>
<a href="#l42.134"></a><span id="l42.134" class="difflineminus">-    document.getElementById('descriptionValue').value = aServer.description || noneSelected;</span>
<a href="#l42.135"></a><span id="l42.135" class="difflineminus">-    document.getElementById('portValue').value = aServer.port;</span>
<a href="#l42.136"></a><span id="l42.136" class="difflineminus">-    document.getElementById('userNameValue').value = aServer.username || noneSelected;</span>
<a href="#l42.137"></a><span id="l42.137" class="difflineminus">-    document.getElementById('useSecureConnectionValue').value =</span>
<a href="#l42.138"></a><span id="l42.138" class="difflineplus">+    document.getElementById(&quot;nameValue&quot;).value = aServer.hostname;</span>
<a href="#l42.139"></a><span id="l42.139" class="difflineplus">+    document.getElementById(&quot;descriptionValue&quot;).value = aServer.description || noneSelected;</span>
<a href="#l42.140"></a><span id="l42.140" class="difflineplus">+    document.getElementById(&quot;portValue&quot;).value = aServer.port;</span>
<a href="#l42.141"></a><span id="l42.141" class="difflineplus">+    document.getElementById(&quot;userNameValue&quot;).value = aServer.username || noneSelected;</span>
<a href="#l42.142"></a><span id="l42.142" class="difflineplus">+    document.getElementById(&quot;useSecureConnectionValue&quot;).value =</span>
<a href="#l42.143"></a><span id="l42.143">       this.mBundle.getString(&quot;smtpServer-ConnectionSecurityType-&quot; +</span>
<a href="#l42.144"></a><span id="l42.144">       aServer.socketType);</span>
<a href="#l42.145"></a><span id="l42.145"> </span>
<a href="#l42.146"></a><span id="l42.146">     const AuthMethod = Ci.nsMsgAuthMethod;</span>
<a href="#l42.147"></a><span id="l42.147">     const SocketType = Ci.nsMsgSocketType;</span>
<a href="#l42.148"></a><span id="l42.148">     var authStr = &quot;&quot;;</span>
<a href="#l42.149"></a><span id="l42.149" class="difflineminus">-    switch (aServer.authMethod)</span>
<a href="#l42.150"></a><span id="l42.150" class="difflineminus">-    {</span>
<a href="#l42.151"></a><span id="l42.151" class="difflineplus">+    switch (aServer.authMethod) {</span>
<a href="#l42.152"></a><span id="l42.152">       case AuthMethod.none:</span>
<a href="#l42.153"></a><span id="l42.153">         authStr = &quot;authNo&quot;;</span>
<a href="#l42.154"></a><span id="l42.154">         break;</span>
<a href="#l42.155"></a><span id="l42.155">       case AuthMethod.passwordEncrypted:</span>
<a href="#l42.156"></a><span id="l42.156">         authStr = &quot;authPasswordEncrypted&quot;;</span>
<a href="#l42.157"></a><span id="l42.157">         break;</span>
<a href="#l42.158"></a><span id="l42.158">       case AuthMethod.GSSAPI:</span>
<a href="#l42.159"></a><span id="l42.159">         authStr = &quot;authKerberos&quot;;</span>
<a href="#l42.160"></a><span id="l42.160" class="difflineat">@@ -154,18 +142,17 @@ var gSmtpServerListWindow =</span>
<a href="#l42.161"></a><span id="l42.161">         Cu.reportError(&quot;Warning: unknown value for smtpserver... authMethod: &quot; +</span>
<a href="#l42.162"></a><span id="l42.162">           aServer.authMethod);</span>
<a href="#l42.163"></a><span id="l42.163">     }</span>
<a href="#l42.164"></a><span id="l42.164">     if (authStr)</span>
<a href="#l42.165"></a><span id="l42.165">       document.getElementById(&quot;authMethodValue&quot;).value =</span>
<a href="#l42.166"></a><span id="l42.166">           this.mBundle.getString(authStr);</span>
<a href="#l42.167"></a><span id="l42.167">   },</span>
<a href="#l42.168"></a><span id="l42.168"> </span>
<a href="#l42.169"></a><span id="l42.169" class="difflineminus">-  refreshServerList: function(aServerKeyToSelect, aFocusList)</span>
<a href="#l42.170"></a><span id="l42.170" class="difflineminus">-  {</span>
<a href="#l42.171"></a><span id="l42.171" class="difflineplus">+  refreshServerList(aServerKeyToSelect, aFocusList) {</span>
<a href="#l42.172"></a><span id="l42.172">     // remove all children</span>
<a href="#l42.173"></a><span id="l42.173">     while (this.mServerList.hasChildNodes())</span>
<a href="#l42.174"></a><span id="l42.174">       this.mServerList.lastChild.remove();</span>
<a href="#l42.175"></a><span id="l42.175"> </span>
<a href="#l42.176"></a><span id="l42.176">     this.fillSmtpServers(this.mServerList,</span>
<a href="#l42.177"></a><span id="l42.177">                          MailServices.smtp.servers,</span>
<a href="#l42.178"></a><span id="l42.178">                          MailServices.smtp.defaultServer);</span>
<a href="#l42.179"></a><span id="l42.179"> </span>
<a href="#l42.180"></a><span id="l42.180" class="difflineat">@@ -173,91 +160,83 @@ var gSmtpServerListWindow =</span>
<a href="#l42.181"></a><span id="l42.181">       this.setSelectedServer(this.mServerList.querySelector('[key=&quot;' + aServerKeyToSelect + '&quot;]'));</span>
<a href="#l42.182"></a><span id="l42.182">     else // select the default server</span>
<a href="#l42.183"></a><span id="l42.183">       this.setSelectedServer(this.mServerList.querySelector('[default=&quot;true&quot;]'));</span>
<a href="#l42.184"></a><span id="l42.184"> </span>
<a href="#l42.185"></a><span id="l42.185">     if (aFocusList)</span>
<a href="#l42.186"></a><span id="l42.186">       this.mServerList.focus();</span>
<a href="#l42.187"></a><span id="l42.187">   },</span>
<a href="#l42.188"></a><span id="l42.188"> </span>
<a href="#l42.189"></a><span id="l42.189" class="difflineminus">-  fillSmtpServers: function(aListBox, aServers, aDefaultServer)</span>
<a href="#l42.190"></a><span id="l42.190" class="difflineminus">-  {</span>
<a href="#l42.191"></a><span id="l42.191" class="difflineplus">+  fillSmtpServers(aListBox, aServers, aDefaultServer) {</span>
<a href="#l42.192"></a><span id="l42.192">     if (!aListBox || !aServers)</span>
<a href="#l42.193"></a><span id="l42.193">       return;</span>
<a href="#l42.194"></a><span id="l42.194"> </span>
<a href="#l42.195"></a><span id="l42.195" class="difflineminus">-    while (aServers.hasMoreElements())</span>
<a href="#l42.196"></a><span id="l42.196" class="difflineminus">-    {</span>
<a href="#l42.197"></a><span id="l42.197" class="difflineplus">+    while (aServers.hasMoreElements()) {</span>
<a href="#l42.198"></a><span id="l42.198">       var server = aServers.getNext();</span>
<a href="#l42.199"></a><span id="l42.199"> </span>
<a href="#l42.200"></a><span id="l42.200" class="difflineminus">-      if (server instanceof Ci.nsISmtpServer)</span>
<a href="#l42.201"></a><span id="l42.201" class="difflineminus">-      {</span>
<a href="#l42.202"></a><span id="l42.202" class="difflineplus">+      if (server instanceof Ci.nsISmtpServer) {</span>
<a href="#l42.203"></a><span id="l42.203">         var isDefault = (aDefaultServer.key == server.key);</span>
<a href="#l42.204"></a><span id="l42.204"> </span>
<a href="#l42.205"></a><span id="l42.205">         var listitem = this.createSmtpListItem(server, isDefault);</span>
<a href="#l42.206"></a><span id="l42.206">         aListBox.appendChild(listitem);</span>
<a href="#l42.207"></a><span id="l42.207">       }</span>
<a href="#l42.208"></a><span id="l42.208">     }</span>
<a href="#l42.209"></a><span id="l42.209">   },</span>
<a href="#l42.210"></a><span id="l42.210"> </span>
<a href="#l42.211"></a><span id="l42.211" class="difflineminus">-  createSmtpListItem: function(aServer, aIsDefault)</span>
<a href="#l42.212"></a><span id="l42.212" class="difflineminus">-  {</span>
<a href="#l42.213"></a><span id="l42.213" class="difflineplus">+  createSmtpListItem(aServer, aIsDefault) {</span>
<a href="#l42.214"></a><span id="l42.214">     var listitem = document.createElement(&quot;richlistitem&quot;);</span>
<a href="#l42.215"></a><span id="l42.215">     var serverName = &quot;&quot;;</span>
<a href="#l42.216"></a><span id="l42.216"> </span>
<a href="#l42.217"></a><span id="l42.217">     if (aServer.description)</span>
<a href="#l42.218"></a><span id="l42.218" class="difflineminus">-      serverName = aServer.description + ' - ';</span>
<a href="#l42.219"></a><span id="l42.219" class="difflineplus">+      serverName = aServer.description + &quot; - &quot;;</span>
<a href="#l42.220"></a><span id="l42.220">     else if (aServer.username)</span>
<a href="#l42.221"></a><span id="l42.221" class="difflineminus">-      serverName = aServer.username + ' - ';</span>
<a href="#l42.222"></a><span id="l42.222" class="difflineplus">+      serverName = aServer.username + &quot; - &quot;;</span>
<a href="#l42.223"></a><span id="l42.223"> </span>
<a href="#l42.224"></a><span id="l42.224">     serverName += aServer.hostname;</span>
<a href="#l42.225"></a><span id="l42.225"> </span>
<a href="#l42.226"></a><span id="l42.226" class="difflineminus">-    if (aIsDefault)</span>
<a href="#l42.227"></a><span id="l42.227" class="difflineminus">-    {</span>
<a href="#l42.228"></a><span id="l42.228" class="difflineplus">+    if (aIsDefault) {</span>
<a href="#l42.229"></a><span id="l42.229">       serverName += &quot; &quot; + this.mBundle.getString(&quot;defaultServerTag&quot;);</span>
<a href="#l42.230"></a><span id="l42.230">       listitem.setAttribute(&quot;default&quot;, &quot;true&quot;);</span>
<a href="#l42.231"></a><span id="l42.231">     }</span>
<a href="#l42.232"></a><span id="l42.232"> </span>
<a href="#l42.233"></a><span id="l42.233">     let label = document.createElement(&quot;label&quot;);</span>
<a href="#l42.234"></a><span id="l42.234">     label.setAttribute(&quot;value&quot;, serverName);</span>
<a href="#l42.235"></a><span id="l42.235">     listitem.appendChild(label);</span>
<a href="#l42.236"></a><span id="l42.236">     listitem.setAttribute(&quot;key&quot;, aServer.key);</span>
<a href="#l42.237"></a><span id="l42.237">     listitem.setAttribute(&quot;class&quot;, &quot;smtpServerListItem&quot;);</span>
<a href="#l42.238"></a><span id="l42.238"> </span>
<a href="#l42.239"></a><span id="l42.239">     // give it some unique id</span>
<a href="#l42.240"></a><span id="l42.240">     listitem.id = &quot;smtpServer.&quot; + aServer.key;</span>
<a href="#l42.241"></a><span id="l42.241">     return listitem;</span>
<a href="#l42.242"></a><span id="l42.242">   },</span>
<a href="#l42.243"></a><span id="l42.243"> </span>
<a href="#l42.244"></a><span id="l42.244" class="difflineminus">-  openServerEditor: function(aServer)</span>
<a href="#l42.245"></a><span id="l42.245" class="difflineminus">-  {</span>
<a href="#l42.246"></a><span id="l42.246" class="difflineplus">+  openServerEditor(aServer) {</span>
<a href="#l42.247"></a><span id="l42.247">     let args = editSMTPServer(aServer);</span>
<a href="#l42.248"></a><span id="l42.248"> </span>
<a href="#l42.249"></a><span id="l42.249">     // now re-select the server which was just added</span>
<a href="#l42.250"></a><span id="l42.250">     if (args.result)</span>
<a href="#l42.251"></a><span id="l42.251">       this.refreshServerList(aServer ? aServer.key : args.addSmtpServer, true);</span>
<a href="#l42.252"></a><span id="l42.252"> </span>
<a href="#l42.253"></a><span id="l42.253">     return args.result;</span>
<a href="#l42.254"></a><span id="l42.254">   },</span>
<a href="#l42.255"></a><span id="l42.255"> </span>
<a href="#l42.256"></a><span id="l42.256" class="difflineminus">-  setSelectedServer: function(aServer)</span>
<a href="#l42.257"></a><span id="l42.257" class="difflineminus">-  {</span>
<a href="#l42.258"></a><span id="l42.258" class="difflineplus">+  setSelectedServer(aServer) {</span>
<a href="#l42.259"></a><span id="l42.259">     if (!aServer)</span>
<a href="#l42.260"></a><span id="l42.260">       return;</span>
<a href="#l42.261"></a><span id="l42.261"> </span>
<a href="#l42.262"></a><span id="l42.262">     setTimeout(function(aServerList) {</span>
<a href="#l42.263"></a><span id="l42.263">       aServerList.ensureElementIsVisible(aServer);</span>
<a href="#l42.264"></a><span id="l42.264">       aServerList.selectItem(aServer);</span>
<a href="#l42.265"></a><span id="l42.265">     }, 0, this.mServerList);</span>
<a href="#l42.266"></a><span id="l42.266">   },</span>
<a href="#l42.267"></a><span id="l42.267"> </span>
<a href="#l42.268"></a><span id="l42.268" class="difflineminus">-  getSelectedServer: function()</span>
<a href="#l42.269"></a><span id="l42.269" class="difflineminus">-  {</span>
<a href="#l42.270"></a><span id="l42.270" class="difflineplus">+  getSelectedServer() {</span>
<a href="#l42.271"></a><span id="l42.271">     // The list of servers is a single selection listbox</span>
<a href="#l42.272"></a><span id="l42.272">     // therefore 1 item is always selected.</span>
<a href="#l42.273"></a><span id="l42.273">     // But if there are no SMTP servers defined yet, nothing will be selected.</span>
<a href="#l42.274"></a><span id="l42.274">     let selection = this.mServerList.selectedItem;</span>
<a href="#l42.275"></a><span id="l42.275">     if (!selection)</span>
<a href="#l42.276"></a><span id="l42.276">       return null;</span>
<a href="#l42.277"></a><span id="l42.277"> </span>
<a href="#l42.278"></a><span id="l42.278">     let serverKey = selection.getAttribute(&quot;key&quot;);</span>
<a href="#l42.279"></a><span id="l42.279">     return MailServices.smtp.getServerByKey(serverKey);</span>
<a href="#l42.280"></a><span id="l42.280" class="difflineminus">-  }</span>
<a href="#l42.281"></a><span id="l42.281" class="difflineplus">+  },</span>
<a href="#l42.282"></a><span id="l42.282"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/base/prefs/content/amUtils.js</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/base/prefs/content/amUtils.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -3,18 +3,17 @@</span>
<a href="#l43.4"></a><span id="l43.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l43.5"></a><span id="l43.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l43.6"></a><span id="l43.6"> </span>
<a href="#l43.7"></a><span id="l43.7"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l43.8"></a><span id="l43.8"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l43.9"></a><span id="l43.9"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l43.10"></a><span id="l43.10"> var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l43.11"></a><span id="l43.11"> </span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-function BrowseForLocalFolders()</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineminus">-{</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineplus">+function BrowseForLocalFolders() {</span>
<a href="#l43.15"></a><span id="l43.15">   const nsIFilePicker = Ci.nsIFilePicker;</span>
<a href="#l43.16"></a><span id="l43.16">   const nsIFile = Ci.nsIFile;</span>
<a href="#l43.17"></a><span id="l43.17"> </span>
<a href="#l43.18"></a><span id="l43.18">   var currentFolderTextBox = document.getElementById(&quot;server.localPath&quot;);</span>
<a href="#l43.19"></a><span id="l43.19">   var fp = Cc[&quot;@mozilla.org/filepicker;1&quot;]</span>
<a href="#l43.20"></a><span id="l43.20">              .createInstance(nsIFilePicker);</span>
<a href="#l43.21"></a><span id="l43.21"> </span>
<a href="#l43.22"></a><span id="l43.22">   fp.init(window,</span>
<a href="#l43.23"></a><span id="l43.23" class="difflineat">@@ -44,18 +43,17 @@ function BrowseForLocalFolders()</span>
<a href="#l43.24"></a><span id="l43.24"> </span>
<a href="#l43.25"></a><span id="l43.25"> /**</span>
<a href="#l43.26"></a><span id="l43.26">  * Return server/folder name formatted with server name if needed.</span>
<a href="#l43.27"></a><span id="l43.27">  *</span>
<a href="#l43.28"></a><span id="l43.28">  * @param aTargetFolder  nsIMsgFolder to format name for</span>
<a href="#l43.29"></a><span id="l43.29">  *                       If target.isServer then only its name is returned.</span>
<a href="#l43.30"></a><span id="l43.30">  *                       Otherwise return the name as &quot;&lt;foldername&gt; on &lt;servername&gt;&quot;.</span>
<a href="#l43.31"></a><span id="l43.31">  */</span>
<a href="#l43.32"></a><span id="l43.32" class="difflineminus">-function prettyFolderName(aTargetFolder)</span>
<a href="#l43.33"></a><span id="l43.33" class="difflineminus">-{</span>
<a href="#l43.34"></a><span id="l43.34" class="difflineplus">+function prettyFolderName(aTargetFolder) {</span>
<a href="#l43.35"></a><span id="l43.35">   if (aTargetFolder.isServer)</span>
<a href="#l43.36"></a><span id="l43.36">     return aTargetFolder.prettyName;</span>
<a href="#l43.37"></a><span id="l43.37"> </span>
<a href="#l43.38"></a><span id="l43.38">   return document.getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l43.39"></a><span id="l43.39">                  .getFormattedString(&quot;verboseFolderFormat&quot;,</span>
<a href="#l43.40"></a><span id="l43.40">                                      [aTargetFolder.prettyName,</span>
<a href="#l43.41"></a><span id="l43.41">                                       aTargetFolder.server.prettyName]);</span>
<a href="#l43.42"></a><span id="l43.42"> }</span>
<a href="#l43.43"></a><span id="l43.43" class="difflineat">@@ -63,18 +61,17 @@ function prettyFolderName(aTargetFolder)</span>
<a href="#l43.44"></a><span id="l43.44"> /**</span>
<a href="#l43.45"></a><span id="l43.45">  * Checks validity of junk target server name and folder.</span>
<a href="#l43.46"></a><span id="l43.46">  *</span>
<a href="#l43.47"></a><span id="l43.47">  * @param aTargetURI  the URI specification to check</span>
<a href="#l43.48"></a><span id="l43.48">  * @param aIsServer   true if the URI specifies only a server (without folder)</span>
<a href="#l43.49"></a><span id="l43.49">  *</span>
<a href="#l43.50"></a><span id="l43.50">  * @return  the value of aTargetURI if it is valid (usable), otherwise null</span>
<a href="#l43.51"></a><span id="l43.51">  */</span>
<a href="#l43.52"></a><span id="l43.52" class="difflineminus">-function checkJunkTargetFolder(aTargetURI, aIsServer)</span>
<a href="#l43.53"></a><span id="l43.53" class="difflineminus">-{</span>
<a href="#l43.54"></a><span id="l43.54" class="difflineplus">+function checkJunkTargetFolder(aTargetURI, aIsServer) {</span>
<a href="#l43.55"></a><span id="l43.55">   try {</span>
<a href="#l43.56"></a><span id="l43.56">     // Does the target account exist?</span>
<a href="#l43.57"></a><span id="l43.57">     let targetServer;</span>
<a href="#l43.58"></a><span id="l43.58">     if (aIsServer) {</span>
<a href="#l43.59"></a><span id="l43.59">       targetServer = MailUtils.getOrCreateFolder(aTargetURI + &quot;/Junk&quot;).server;</span>
<a href="#l43.60"></a><span id="l43.60">     } else {</span>
<a href="#l43.61"></a><span id="l43.61">       targetServer = MailUtils.getExistingFolder(aTargetURI).server;</span>
<a href="#l43.62"></a><span id="l43.62">     }</span>
<a href="#l43.63"></a><span id="l43.63" class="difflineat">@@ -93,18 +90,17 @@ function checkJunkTargetFolder(aTargetUR</span>
<a href="#l43.64"></a><span id="l43.64">  * Finds a usable target for storing Junk mail.</span>
<a href="#l43.65"></a><span id="l43.65">  * If the passed in server URI is not usable, choose Local Folders.</span>
<a href="#l43.66"></a><span id="l43.66">  *</span>
<a href="#l43.67"></a><span id="l43.67">  * @param aTargetURI  the URI of a server or folder to try first</span>
<a href="#l43.68"></a><span id="l43.68">  * @param aIsServer   true if the URI specifies only a server (without folder)</span>
<a href="#l43.69"></a><span id="l43.69">  *</span>
<a href="#l43.70"></a><span id="l43.70">  * @return  the server/folder URI of a usable target for storing Junk</span>
<a href="#l43.71"></a><span id="l43.71">  */</span>
<a href="#l43.72"></a><span id="l43.72" class="difflineminus">-function chooseJunkTargetFolder(aTargetURI, aIsServer)</span>
<a href="#l43.73"></a><span id="l43.73" class="difflineminus">-{</span>
<a href="#l43.74"></a><span id="l43.74" class="difflineplus">+function chooseJunkTargetFolder(aTargetURI, aIsServer) {</span>
<a href="#l43.75"></a><span id="l43.75">   let server = null;</span>
<a href="#l43.76"></a><span id="l43.76"> </span>
<a href="#l43.77"></a><span id="l43.77">   if (aTargetURI) {</span>
<a href="#l43.78"></a><span id="l43.78">     server = MailUtils.getOrCreateFolder(aTargetURI).server;</span>
<a href="#l43.79"></a><span id="l43.79">     if (!server.canCreateFoldersOnServer || !server.canSearchMessages ||</span>
<a href="#l43.80"></a><span id="l43.80">         (server.rootFolder != server.rootMsgFolder))</span>
<a href="#l43.81"></a><span id="l43.81">       server = null;</span>
<a href="#l43.82"></a><span id="l43.82">   }</span>
<a href="#l43.83"></a><span id="l43.83" class="difflineat">@@ -132,18 +128,17 @@ function chooseJunkTargetFolder(aTargetU</span>
<a href="#l43.84"></a><span id="l43.84">  *          newTargetAccount new safe junk target folder</span>
<a href="#l43.85"></a><span id="l43.85">  *          newMoveOnSpam    new moveOnSpam value</span>
<a href="#l43.86"></a><span id="l43.86">  */</span>
<a href="#l43.87"></a><span id="l43.87"> function sanitizeJunkTargets(aSpamActionTargetAccount,</span>
<a href="#l43.88"></a><span id="l43.88">                              aSpamActionTargetFolder,</span>
<a href="#l43.89"></a><span id="l43.89">                              aProposedTarget,</span>
<a href="#l43.90"></a><span id="l43.90">                              aMoveTargetModeValue,</span>
<a href="#l43.91"></a><span id="l43.91">                              aServerSpamSettings,</span>
<a href="#l43.92"></a><span id="l43.92" class="difflineminus">-                             aMoveOnSpam)</span>
<a href="#l43.93"></a><span id="l43.93" class="difflineminus">-{</span>
<a href="#l43.94"></a><span id="l43.94" class="difflineplus">+                             aMoveOnSpam) {</span>
<a href="#l43.95"></a><span id="l43.95">   // Check if folder targets are valid.</span>
<a href="#l43.96"></a><span id="l43.96">   aSpamActionTargetAccount = checkJunkTargetFolder(aSpamActionTargetAccount, true);</span>
<a href="#l43.97"></a><span id="l43.97">   if (!aSpamActionTargetAccount) {</span>
<a href="#l43.98"></a><span id="l43.98">     // If aSpamActionTargetAccount is not valid,</span>
<a href="#l43.99"></a><span id="l43.99">     // reset to default behavior to NOT move junk messages...</span>
<a href="#l43.100"></a><span id="l43.100">     if (aMoveTargetModeValue == aServerSpamSettings.MOVE_TARGET_MODE_ACCOUNT)</span>
<a href="#l43.101"></a><span id="l43.101">       aMoveOnSpam = false;</span>
<a href="#l43.102"></a><span id="l43.102"> </span>
<a href="#l43.103"></a><span id="l43.103" class="difflineat">@@ -191,21 +186,19 @@ function openPrefsFromAccountManager(aTB</span>
<a href="#l43.104"></a><span id="l43.104"> </span>
<a href="#l43.105"></a><span id="l43.105"> /**</span>
<a href="#l43.106"></a><span id="l43.106">  * Check if the given account name already exists in any account.</span>
<a href="#l43.107"></a><span id="l43.107">  *</span>
<a href="#l43.108"></a><span id="l43.108">  * @param aAccountName  The account name string to look for.</span>
<a href="#l43.109"></a><span id="l43.109">  * @param aAccountKey   Optional. The key of an account that is skipped when</span>
<a href="#l43.110"></a><span id="l43.110">  *                      searching the name. If unset, do not skip any account.</span>
<a href="#l43.111"></a><span id="l43.111">  */</span>
<a href="#l43.112"></a><span id="l43.112" class="difflineminus">-function accountNameExists(aAccountName, aAccountKey)</span>
<a href="#l43.113"></a><span id="l43.113" class="difflineminus">-{</span>
<a href="#l43.114"></a><span id="l43.114" class="difflineplus">+function accountNameExists(aAccountName, aAccountKey) {</span>
<a href="#l43.115"></a><span id="l43.115">   for (let account of fixIterator(MailServices.accounts.accounts,</span>
<a href="#l43.116"></a><span id="l43.116" class="difflineminus">-                                  Ci.nsIMsgAccount))</span>
<a href="#l43.117"></a><span id="l43.117" class="difflineminus">-  {</span>
<a href="#l43.118"></a><span id="l43.118" class="difflineplus">+                                  Ci.nsIMsgAccount)) {</span>
<a href="#l43.119"></a><span id="l43.119">     if (account.key != aAccountKey &amp;&amp; account.incomingServer &amp;&amp;</span>
<a href="#l43.120"></a><span id="l43.120">         aAccountName == account.incomingServer.prettyName) {</span>
<a href="#l43.121"></a><span id="l43.121">       return true;</span>
<a href="#l43.122"></a><span id="l43.122">     }</span>
<a href="#l43.123"></a><span id="l43.123">   }</span>
<a href="#l43.124"></a><span id="l43.124"> </span>
<a href="#l43.125"></a><span id="l43.125">   return false;</span>
<a href="#l43.126"></a><span id="l43.126"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/base/prefs/content/aw-accname.js</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/base/prefs/content/aw-accname.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -1,19 +1,20 @@</span>
<a href="#l44.4"></a><span id="l44.4"> /* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l44.5"></a><span id="l44.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l44.6"></a><span id="l44.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l44.7"></a><span id="l44.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l44.8"></a><span id="l44.8"> </span>
<a href="#l44.9"></a><span id="l44.9" class="difflineplus">+/* import-globals-from AccountWizard.js */</span>
<a href="#l44.10"></a><span id="l44.10" class="difflineplus">+</span>
<a href="#l44.11"></a><span id="l44.11"> var gPrefsBundle;</span>
<a href="#l44.12"></a><span id="l44.12"> </span>
<a href="#l44.13"></a><span id="l44.13" class="difflineminus">-function acctNamePageValidate()</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineminus">-{</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+function acctNamePageValidate() {</span>
<a href="#l44.16"></a><span id="l44.16">   var accountname = document.getElementById(&quot;prettyName&quot;).value;</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineminus">-  var canAdvance = accountname ? true : false;</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineplus">+  var canAdvance = !!accountname;</span>
<a href="#l44.19"></a><span id="l44.19"> </span>
<a href="#l44.20"></a><span id="l44.20">   // Check if this accountname already exists. If so, return false so that</span>
<a href="#l44.21"></a><span id="l44.21">   // user can enter a different unique account name.</span>
<a href="#l44.22"></a><span id="l44.22">   if (canAdvance &amp;&amp; accountNameExists(accountname))</span>
<a href="#l44.23"></a><span id="l44.23">     canAdvance = false;</span>
<a href="#l44.24"></a><span id="l44.24"> </span>
<a href="#l44.25"></a><span id="l44.25">   document.documentElement.canAdvance = canAdvance;</span>
<a href="#l44.26"></a><span id="l44.26"> }</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineat">@@ -22,21 +23,20 @@ function acctNamePageUnload() {</span>
<a href="#l44.28"></a><span id="l44.28">   var pageData = parent.GetPageData();</span>
<a href="#l44.29"></a><span id="l44.29">   var accountname = document.getElementById(&quot;prettyName&quot;).value;</span>
<a href="#l44.30"></a><span id="l44.30">   setPageData(pageData, &quot;accname&quot;, &quot;prettyName&quot;, accountname);</span>
<a href="#l44.31"></a><span id="l44.31">   // Set this to true so we know the user has set the name.</span>
<a href="#l44.32"></a><span id="l44.32">   setPageData(pageData, &quot;accname&quot;, &quot;userset&quot;, true);</span>
<a href="#l44.33"></a><span id="l44.33">   return true;</span>
<a href="#l44.34"></a><span id="l44.34"> }</span>
<a href="#l44.35"></a><span id="l44.35"> </span>
<a href="#l44.36"></a><span id="l44.36" class="difflineminus">-function acctNamePageInit()</span>
<a href="#l44.37"></a><span id="l44.37" class="difflineminus">-{</span>
<a href="#l44.38"></a><span id="l44.38" class="difflineplus">+function acctNamePageInit() {</span>
<a href="#l44.39"></a><span id="l44.39">     gPrefsBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l44.40"></a><span id="l44.40">     var accountNameInput = document.getElementById(&quot;prettyName&quot;);</span>
<a href="#l44.41"></a><span id="l44.41" class="difflineminus">-    if (accountNameInput.value==&quot;&quot;) {</span>
<a href="#l44.42"></a><span id="l44.42" class="difflineplus">+    if (accountNameInput.value == &quot;&quot;) {</span>
<a href="#l44.43"></a><span id="l44.43">         var pageData = parent.GetPageData();</span>
<a href="#l44.44"></a><span id="l44.44">         var type = parent.getCurrentServerType(pageData);</span>
<a href="#l44.45"></a><span id="l44.45">         var accountName;</span>
<a href="#l44.46"></a><span id="l44.46"> </span>
<a href="#l44.47"></a><span id="l44.47">         if (type == &quot;nntp&quot;)</span>
<a href="#l44.48"></a><span id="l44.48">             accountName = pageData.newsserver.hostname.value;</span>
<a href="#l44.49"></a><span id="l44.49">         else</span>
<a href="#l44.50"></a><span id="l44.50">             accountName = pageData.identity.email.value;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/base/prefs/content/aw-accounttype.js</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/base/prefs/content/aw-accounttype.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -1,15 +1,16 @@</span>
<a href="#l45.4"></a><span id="l45.4"> /* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l45.5"></a><span id="l45.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l45.6"></a><span id="l45.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l45.7"></a><span id="l45.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l45.8"></a><span id="l45.8"> </span>
<a href="#l45.9"></a><span id="l45.9" class="difflineminus">-function setAccountTypeData()</span>
<a href="#l45.10"></a><span id="l45.10" class="difflineminus">-{</span>
<a href="#l45.11"></a><span id="l45.11" class="difflineplus">+/* import-globals-from AccountWizard.js */</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineplus">+</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineplus">+function setAccountTypeData() {</span>
<a href="#l45.14"></a><span id="l45.14">   var rg = document.getElementById(&quot;acctyperadio&quot;);</span>
<a href="#l45.15"></a><span id="l45.15">   var selectedItemId = rg.selectedItem.id;</span>
<a href="#l45.16"></a><span id="l45.16">   var mail = selectedItemId == &quot;mailaccount&quot;;</span>
<a href="#l45.17"></a><span id="l45.17">   var news = selectedItemId == &quot;newsaccount&quot;;</span>
<a href="#l45.18"></a><span id="l45.18"> </span>
<a href="#l45.19"></a><span id="l45.19">   var pageData = parent.GetPageData();</span>
<a href="#l45.20"></a><span id="l45.20">   setPageData(pageData, &quot;accounttype&quot;, &quot;mailaccount&quot;, mail);</span>
<a href="#l45.21"></a><span id="l45.21">   setPageData(pageData, &quot;accounttype&quot;, &quot;newsaccount&quot;, news);</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineat">@@ -45,22 +46,22 @@ function setupWizardPanels() {</span>
<a href="#l45.23"></a><span id="l45.23">   } else { // An account created by an extension and XUL overlays</span>
<a href="#l45.24"></a><span id="l45.24">     let pages = document.getElementById(&quot;acctyperadio&quot;).selectedItem.value;</span>
<a href="#l45.25"></a><span id="l45.25">     if (pages == &quot;movemail&quot;) {</span>
<a href="#l45.26"></a><span id="l45.26">       wizardPanels = [&quot;identitypage&quot;, &quot;outgoingpage&quot;, &quot;accnamepage&quot;];</span>
<a href="#l45.27"></a><span id="l45.27">       setPageData(pageData, &quot;server&quot;, &quot;servertype&quot;, &quot;movemail&quot;);</span>
<a href="#l45.28"></a><span id="l45.28">       setPageData(pageData, &quot;server&quot;, &quot;hostname&quot;, &quot;localhost&quot;);</span>
<a href="#l45.29"></a><span id="l45.29">       setPageData(pageData, &quot;server&quot;, &quot;port&quot;, &quot;&quot;);</span>
<a href="#l45.30"></a><span id="l45.30">     } else {</span>
<a href="#l45.31"></a><span id="l45.31" class="difflineminus">-      wizardPanels = button.value.split(/ *, */);</span>
<a href="#l45.32"></a><span id="l45.32" class="difflineplus">+      wizardPanels = pages.split(/ *, */);</span>
<a href="#l45.33"></a><span id="l45.33">     }</span>
<a href="#l45.34"></a><span id="l45.34">   }</span>
<a href="#l45.35"></a><span id="l45.35">   wizardPanels.push(&quot;done&quot;);</span>
<a href="#l45.36"></a><span id="l45.36"> </span>
<a href="#l45.37"></a><span id="l45.37">   // Set up order of panels</span>
<a href="#l45.38"></a><span id="l45.38">   for (let i = 0; i &lt; (wizardPanels.length - 1); i++)</span>
<a href="#l45.39"></a><span id="l45.39">     setNextPage(wizardPanels[i], wizardPanels[i + 1]);</span>
<a href="#l45.40"></a><span id="l45.40"> </span>
<a href="#l45.41"></a><span id="l45.41">   // make the account type page go to the very first of our approved wizard panels...this is usually going to</span>
<a href="#l45.42"></a><span id="l45.42">   // be accounttype --&gt; identitypage unless we were configured to skip the identity page</span>
<a href="#l45.43"></a><span id="l45.43" class="difflineminus">-  setNextPage(&quot;accounttype&quot;,wizardPanels[0]);</span>
<a href="#l45.44"></a><span id="l45.44" class="difflineplus">+  setNextPage(&quot;accounttype&quot;, wizardPanels[0]);</span>
<a href="#l45.45"></a><span id="l45.45"> }</span>
<a href="#l45.46"></a><span id="l45.46"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/base/prefs/content/aw-done.js</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/base/prefs/content/aw-done.js</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -1,13 +1,15 @@</span>
<a href="#l46.4"></a><span id="l46.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l46.5"></a><span id="l46.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l46.6"></a><span id="l46.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l46.7"></a><span id="l46.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l46.8"></a><span id="l46.8"> </span>
<a href="#l46.9"></a><span id="l46.9" class="difflineplus">+/* import-globals-from AccountWizard.js */</span>
<a href="#l46.10"></a><span id="l46.10" class="difflineplus">+</span>
<a href="#l46.11"></a><span id="l46.11"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l46.12"></a><span id="l46.12"> </span>
<a href="#l46.13"></a><span id="l46.13"> var gPrefsBundle;</span>
<a href="#l46.14"></a><span id="l46.14"> </span>
<a href="#l46.15"></a><span id="l46.15"> function donePageInit() {</span>
<a href="#l46.16"></a><span id="l46.16">     var pageData = parent.GetPageData();</span>
<a href="#l46.17"></a><span id="l46.17">     gPrefsBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l46.18"></a><span id="l46.18"> </span>
<a href="#l46.19"></a><span id="l46.19" class="difflineat">@@ -17,97 +19,94 @@ function donePageInit() {</span>
<a href="#l46.20"></a><span id="l46.20"> </span>
<a href="#l46.21"></a><span id="l46.21">     var email = &quot;&quot;;</span>
<a href="#l46.22"></a><span id="l46.22">     if (pageData.identity &amp;&amp; pageData.identity.email) {</span>
<a href="#l46.23"></a><span id="l46.23">         // fixup the email</span>
<a href="#l46.24"></a><span id="l46.24">         email = pageData.identity.email.value;</span>
<a href="#l46.25"></a><span id="l46.25">     }</span>
<a href="#l46.26"></a><span id="l46.26">     setDivTextFromForm(&quot;identity.email&quot;, email);</span>
<a href="#l46.27"></a><span id="l46.27"> </span>
<a href="#l46.28"></a><span id="l46.28" class="difflineminus">-    var userName=&quot;&quot;;</span>
<a href="#l46.29"></a><span id="l46.29" class="difflineplus">+    let userName = &quot;&quot;;</span>
<a href="#l46.30"></a><span id="l46.30">     if (pageData.login &amp;&amp; pageData.login.username)</span>
<a href="#l46.31"></a><span id="l46.31">         userName = pageData.login.username.value;</span>
<a href="#l46.32"></a><span id="l46.32">     if (!userName &amp;&amp; email)</span>
<a href="#l46.33"></a><span id="l46.33">         userName = getUsernameFromEmail(email);</span>
<a href="#l46.34"></a><span id="l46.34"> </span>
<a href="#l46.35"></a><span id="l46.35">     // Hide the &quot;username&quot; field if we don't want to show information</span>
<a href="#l46.36"></a><span id="l46.36">     // on the incoming server.</span>
<a href="#l46.37"></a><span id="l46.37">     setDivTextFromForm(&quot;server.username&quot;, hideIncoming ? null : userName);</span>
<a href="#l46.38"></a><span id="l46.38"> </span>
<a href="#l46.39"></a><span id="l46.39" class="difflineminus">-    var smtpUserName=&quot;&quot;;</span>
<a href="#l46.40"></a><span id="l46.40" class="difflineplus">+    let smtpUserName = &quot;&quot;;</span>
<a href="#l46.41"></a><span id="l46.41">     if (pageData.login &amp;&amp; pageData.login.smtpusername)</span>
<a href="#l46.42"></a><span id="l46.42">         smtpUserName = pageData.login.smtpusername.value;</span>
<a href="#l46.43"></a><span id="l46.43">     if (!smtpUserName &amp;&amp; email)</span>
<a href="#l46.44"></a><span id="l46.44">         smtpUserName = getUsernameFromEmail(email);</span>
<a href="#l46.45"></a><span id="l46.45">     setDivTextFromForm(&quot;smtpServer.username&quot;, smtpUserName);</span>
<a href="#l46.46"></a><span id="l46.46"> </span>
<a href="#l46.47"></a><span id="l46.47">     if (pageData.accname &amp;&amp; pageData.accname.prettyName) {</span>
<a href="#l46.48"></a><span id="l46.48">       setDivTextFromForm(&quot;account.name&quot;, pageData.accname.prettyName.value);</span>
<a href="#l46.49"></a><span id="l46.49">     } else {</span>
<a href="#l46.50"></a><span id="l46.50">       setDivTextFromForm(&quot;account.name&quot;, &quot;&quot;);</span>
<a href="#l46.51"></a><span id="l46.51">     }</span>
<a href="#l46.52"></a><span id="l46.52"> </span>
<a href="#l46.53"></a><span id="l46.53">     // Show mail servers (incoming &amp; outgoing) details based on current account</span>
<a href="#l46.54"></a><span id="l46.54">     // data.</span>
<a href="#l46.55"></a><span id="l46.55">     if (!serverIsNntp(pageData)) {</span>
<a href="#l46.56"></a><span id="l46.56" class="difflineminus">-        var incomingServerName=&quot;&quot;;</span>
<a href="#l46.57"></a><span id="l46.57" class="difflineplus">+        let incomingServerName = &quot;&quot;;</span>
<a href="#l46.58"></a><span id="l46.58">         if (pageData.server &amp;&amp; pageData.server.hostname) {</span>
<a href="#l46.59"></a><span id="l46.59">             incomingServerName = pageData.server.hostname.value;</span>
<a href="#l46.60"></a><span id="l46.60">         }</span>
<a href="#l46.61"></a><span id="l46.61">         // Hide the incoming server name field if the user specified</span>
<a href="#l46.62"></a><span id="l46.62">         // wizardHideIncoming in the ISP defaults file</span>
<a href="#l46.63"></a><span id="l46.63">         setDivTextFromForm(&quot;server.name&quot;, hideIncoming ? null : incomingServerName);</span>
<a href="#l46.64"></a><span id="l46.64">         setDivTextFromForm(&quot;server.port&quot;, pageData.server.port ? pageData.server.port.value : null);</span>
<a href="#l46.65"></a><span id="l46.65" class="difflineminus">-        var incomingServerType=&quot;&quot;;</span>
<a href="#l46.66"></a><span id="l46.66" class="difflineplus">+        let incomingServerType = &quot;&quot;;</span>
<a href="#l46.67"></a><span id="l46.67">         if (pageData.server &amp;&amp; pageData.server.servertype) {</span>
<a href="#l46.68"></a><span id="l46.68">             incomingServerType = pageData.server.servertype.value;</span>
<a href="#l46.69"></a><span id="l46.69">         }</span>
<a href="#l46.70"></a><span id="l46.70">         setDivTextFromForm(&quot;server.type&quot;, incomingServerType.toUpperCase());</span>
<a href="#l46.71"></a><span id="l46.71"> </span>
<a href="#l46.72"></a><span id="l46.72" class="difflineminus">-        var smtpServerName=&quot;&quot;;</span>
<a href="#l46.73"></a><span id="l46.73" class="difflineplus">+        let smtpServerName = &quot;&quot;;</span>
<a href="#l46.74"></a><span id="l46.74">         if (pageData.server &amp;&amp; pageData.server.smtphostname) {</span>
<a href="#l46.75"></a><span id="l46.75">           let smtpServer = MailServices.smtp.defaultServer;</span>
<a href="#l46.76"></a><span id="l46.76">           smtpServerName = pageData.server.smtphostname.value;</span>
<a href="#l46.77"></a><span id="l46.77">           if (!smtpServerName &amp;&amp; smtpServer &amp;&amp; smtpServer.hostname)</span>
<a href="#l46.78"></a><span id="l46.78">               smtpServerName = smtpServer.hostname;</span>
<a href="#l46.79"></a><span id="l46.79">         }</span>
<a href="#l46.80"></a><span id="l46.80">         setDivTextFromForm(&quot;smtpServer.name&quot;, smtpServerName);</span>
<a href="#l46.81"></a><span id="l46.81" class="difflineminus">-    }</span>
<a href="#l46.82"></a><span id="l46.82" class="difflineminus">-    else {</span>
<a href="#l46.83"></a><span id="l46.83" class="difflineplus">+    } else {</span>
<a href="#l46.84"></a><span id="l46.84">         setDivTextFromForm(&quot;server.name&quot;, null);</span>
<a href="#l46.85"></a><span id="l46.85">         setDivTextFromForm(&quot;server.type&quot;, null);</span>
<a href="#l46.86"></a><span id="l46.86">         setDivTextFromForm(&quot;server.port&quot;, null);</span>
<a href="#l46.87"></a><span id="l46.87">         setDivTextFromForm(&quot;smtpServer.name&quot;, null);</span>
<a href="#l46.88"></a><span id="l46.88">     }</span>
<a href="#l46.89"></a><span id="l46.89"> </span>
<a href="#l46.90"></a><span id="l46.90">     if (serverIsNntp(pageData)) {</span>
<a href="#l46.91"></a><span id="l46.91" class="difflineminus">-        var newsServerName=&quot;&quot;;</span>
<a href="#l46.92"></a><span id="l46.92" class="difflineplus">+        let newsServerName = &quot;&quot;;</span>
<a href="#l46.93"></a><span id="l46.93">         if (pageData.newsserver &amp;&amp; pageData.newsserver.hostname)</span>
<a href="#l46.94"></a><span id="l46.94">             newsServerName = pageData.newsserver.hostname.value;</span>
<a href="#l46.95"></a><span id="l46.95">         if (newsServerName) {</span>
<a href="#l46.96"></a><span id="l46.96">             // No need to show username for news account</span>
<a href="#l46.97"></a><span id="l46.97">             setDivTextFromForm(&quot;server.username&quot;, null);</span>
<a href="#l46.98"></a><span id="l46.98">         }</span>
<a href="#l46.99"></a><span id="l46.99">         setDivTextFromForm(&quot;newsServer.name&quot;, newsServerName);</span>
<a href="#l46.100"></a><span id="l46.100">         setDivTextFromForm(&quot;server.port&quot;, null);</span>
<a href="#l46.101"></a><span id="l46.101" class="difflineminus">-    }</span>
<a href="#l46.102"></a><span id="l46.102" class="difflineminus">-    else {</span>
<a href="#l46.103"></a><span id="l46.103" class="difflineplus">+    } else {</span>
<a href="#l46.104"></a><span id="l46.104">         setDivTextFromForm(&quot;newsServer.name&quot;, null);</span>
<a href="#l46.105"></a><span id="l46.105">     }</span>
<a href="#l46.106"></a><span id="l46.106"> </span>
<a href="#l46.107"></a><span id="l46.107">     var isPop = false;</span>
<a href="#l46.108"></a><span id="l46.108">     if (pageData.server &amp;&amp; pageData.server.servertype) {</span>
<a href="#l46.109"></a><span id="l46.109">       isPop = (pageData.server.servertype.value == &quot;pop3&quot;);</span>
<a href="#l46.110"></a><span id="l46.110">     }</span>
<a href="#l46.111"></a><span id="l46.111"> </span>
<a href="#l46.112"></a><span id="l46.112">     hideShowDownloadMsgsUI(isPop);</span>
<a href="#l46.113"></a><span id="l46.113"> }</span>
<a href="#l46.114"></a><span id="l46.114"> </span>
<a href="#l46.115"></a><span id="l46.115" class="difflineminus">-function hideShowDownloadMsgsUI(isPop)</span>
<a href="#l46.116"></a><span id="l46.116" class="difflineminus">-{</span>
<a href="#l46.117"></a><span id="l46.117" class="difflineplus">+function hideShowDownloadMsgsUI(isPop) {</span>
<a href="#l46.118"></a><span id="l46.118">   // only show the &quot;download messages now&quot; UI</span>
<a href="#l46.119"></a><span id="l46.119">   // if this is a pop account, we are online, and this was opened</span>
<a href="#l46.120"></a><span id="l46.120">   // from the 3 pane</span>
<a href="#l46.121"></a><span id="l46.121">   var downloadMsgs = document.getElementById(&quot;downloadMsgs&quot;);</span>
<a href="#l46.122"></a><span id="l46.122">   if (isPop) {</span>
<a href="#l46.123"></a><span id="l46.123">     if (!Services.io.offline) {</span>
<a href="#l46.124"></a><span id="l46.124">       if (window.opener.location.href == &quot;chrome://messenger/content/messenger.xul&quot;) {</span>
<a href="#l46.125"></a><span id="l46.125">         downloadMsgs.hidden = false;</span>
<a href="#l46.126"></a><span id="l46.126" class="difflineat">@@ -116,26 +115,24 @@ function hideShowDownloadMsgsUI(isPop)</span>
<a href="#l46.127"></a><span id="l46.127">     }</span>
<a href="#l46.128"></a><span id="l46.128">   }</span>
<a href="#l46.129"></a><span id="l46.129"> </span>
<a href="#l46.130"></a><span id="l46.130">   // else hide it</span>
<a href="#l46.131"></a><span id="l46.131">   downloadMsgs.hidden = true;</span>
<a href="#l46.132"></a><span id="l46.132"> }</span>
<a href="#l46.133"></a><span id="l46.133"> </span>
<a href="#l46.134"></a><span id="l46.134"> function setDivTextFromForm(divid, value) {</span>
<a href="#l46.135"></a><span id="l46.135" class="difflineminus">-</span>
<a href="#l46.136"></a><span id="l46.136">     // collapse the row if the div has no value</span>
<a href="#l46.137"></a><span id="l46.137">     var div = document.getElementById(divid);</span>
<a href="#l46.138"></a><span id="l46.138">     if (!value) {</span>
<a href="#l46.139"></a><span id="l46.139" class="difflineminus">-        div.setAttribute(&quot;collapsed&quot;,&quot;true&quot;);</span>
<a href="#l46.140"></a><span id="l46.140" class="difflineplus">+        div.setAttribute(&quot;collapsed&quot;, &quot;true&quot;);</span>
<a href="#l46.141"></a><span id="l46.141">         return;</span>
<a href="#l46.142"></a><span id="l46.142">     }</span>
<a href="#l46.143"></a><span id="l46.143" class="difflineminus">-    else {</span>
<a href="#l46.144"></a><span id="l46.144" class="difflineminus">-        div.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l46.145"></a><span id="l46.145" class="difflineminus">-    }</span>
<a href="#l46.146"></a><span id="l46.146" class="difflineplus">+</span>
<a href="#l46.147"></a><span id="l46.147" class="difflineplus">+    div.removeAttribute(&quot;collapsed&quot;);</span>
<a href="#l46.148"></a><span id="l46.148"> </span>
<a href="#l46.149"></a><span id="l46.149">     // otherwise fill in the .text element</span>
<a href="#l46.150"></a><span id="l46.150" class="difflineminus">-    div = document.getElementById(divid+&quot;.text&quot;);</span>
<a href="#l46.151"></a><span id="l46.151" class="difflineplus">+    div = document.getElementById(divid + &quot;.text&quot;);</span>
<a href="#l46.152"></a><span id="l46.152">     if (!div) return;</span>
<a href="#l46.153"></a><span id="l46.153"> </span>
<a href="#l46.154"></a><span id="l46.154">     // set the value</span>
<a href="#l46.155"></a><span id="l46.155">     div.setAttribute(&quot;value&quot;, value);</span>
<a href="#l46.156"></a><span id="l46.156"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/base/prefs/content/aw-identity.js</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/base/prefs/content/aw-identity.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -1,18 +1,19 @@</span>
<a href="#l47.4"></a><span id="l47.4"> /* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l47.5"></a><span id="l47.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l47.6"></a><span id="l47.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l47.7"></a><span id="l47.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l47.8"></a><span id="l47.8"> </span>
<a href="#l47.9"></a><span id="l47.9" class="difflineplus">+/* import-globals-from AccountWizard.js */</span>
<a href="#l47.10"></a><span id="l47.10" class="difflineplus">+</span>
<a href="#l47.11"></a><span id="l47.11"> var gCurrentDomain;</span>
<a href="#l47.12"></a><span id="l47.12"> var gPrefsBundle;</span>
<a href="#l47.13"></a><span id="l47.13"> </span>
<a href="#l47.14"></a><span id="l47.14" class="difflineminus">-function identityPageValidate()</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineminus">-{</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineplus">+function identityPageValidate() {</span>
<a href="#l47.17"></a><span id="l47.17">   var canAdvance = false;</span>
<a href="#l47.18"></a><span id="l47.18">   var name = document.getElementById(&quot;fullName&quot;).value;</span>
<a href="#l47.19"></a><span id="l47.19">   let email = document.getElementById(&quot;email&quot;).value.trim();</span>
<a href="#l47.20"></a><span id="l47.20"> </span>
<a href="#l47.21"></a><span id="l47.21">   if (name &amp;&amp; email) {</span>
<a href="#l47.22"></a><span id="l47.22">     canAdvance = gCurrentDomain ? emailNameIsLegal(email) : emailNameAndDomainAreLegal(email);</span>
<a href="#l47.23"></a><span id="l47.23"> </span>
<a href="#l47.24"></a><span id="l47.24">     if (gCurrentDomain &amp;&amp; canAdvance) {</span>
<a href="#l47.25"></a><span id="l47.25" class="difflineat">@@ -27,89 +28,82 @@ function identityPageValidate()</span>
<a href="#l47.26"></a><span id="l47.26">           parent.AccountExists(usernameWithDomain, hostName, serverType))</span>
<a href="#l47.27"></a><span id="l47.27">         canAdvance = false;</span>
<a href="#l47.28"></a><span id="l47.28">     }</span>
<a href="#l47.29"></a><span id="l47.29">   }</span>
<a href="#l47.30"></a><span id="l47.30"> </span>
<a href="#l47.31"></a><span id="l47.31">   document.documentElement.canAdvance = canAdvance;</span>
<a href="#l47.32"></a><span id="l47.32"> }</span>
<a href="#l47.33"></a><span id="l47.33"> </span>
<a href="#l47.34"></a><span id="l47.34" class="difflineminus">-function identityPageUnload()</span>
<a href="#l47.35"></a><span id="l47.35" class="difflineminus">-{</span>
<a href="#l47.36"></a><span id="l47.36" class="difflineplus">+function identityPageUnload() {</span>
<a href="#l47.37"></a><span id="l47.37">   var pageData = parent.GetPageData();</span>
<a href="#l47.38"></a><span id="l47.38">   var name = document.getElementById(&quot;fullName&quot;).value;</span>
<a href="#l47.39"></a><span id="l47.39">   let email = document.getElementById(&quot;email&quot;).value.trim();</span>
<a href="#l47.40"></a><span id="l47.40">   setPageData(pageData, &quot;identity&quot;, &quot;fullName&quot;, name);</span>
<a href="#l47.41"></a><span id="l47.41">   setPageData(pageData, &quot;identity&quot;, &quot;email&quot;, email);</span>
<a href="#l47.42"></a><span id="l47.42"> </span>
<a href="#l47.43"></a><span id="l47.43">   return true;</span>
<a href="#l47.44"></a><span id="l47.44"> }</span>
<a href="#l47.45"></a><span id="l47.45"> </span>
<a href="#l47.46"></a><span id="l47.46"> // This is for the case when the code appends the domain</span>
<a href="#l47.47"></a><span id="l47.47"> // unnecessarily.</span>
<a href="#l47.48"></a><span id="l47.48"> // This simply gets rid  of &quot;@domain&quot; from &quot;foo@domain&quot;</span>
<a href="#l47.49"></a><span id="l47.49"> </span>
<a href="#l47.50"></a><span id="l47.50" class="difflineminus">-function fixPreFilledEmail()</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineminus">-{</span>
<a href="#l47.52"></a><span id="l47.52" class="difflineplus">+function fixPreFilledEmail() {</span>
<a href="#l47.53"></a><span id="l47.53">   var emailElement = document.getElementById(&quot;email&quot;);</span>
<a href="#l47.54"></a><span id="l47.54">   var email = emailElement.value;</span>
<a href="#l47.55"></a><span id="l47.55" class="difflineminus">-  var emailArray = email.split('@');</span>
<a href="#l47.56"></a><span id="l47.56" class="difflineplus">+  var emailArray = email.split(&quot;@&quot;);</span>
<a href="#l47.57"></a><span id="l47.57"> </span>
<a href="#l47.58"></a><span id="l47.58">   if (gCurrentDomain) {</span>
<a href="#l47.59"></a><span id="l47.59">     // check if user entered an @ sign even though we have a domain</span>
<a href="#l47.60"></a><span id="l47.60">     if (emailArray.length &gt;= 2) {</span>
<a href="#l47.61"></a><span id="l47.61">       email = emailArray[0];</span>
<a href="#l47.62"></a><span id="l47.62">       emailElement.value = email;</span>
<a href="#l47.63"></a><span id="l47.63">     }</span>
<a href="#l47.64"></a><span id="l47.64">   }</span>
<a href="#l47.65"></a><span id="l47.65"> }</span>
<a href="#l47.66"></a><span id="l47.66"> </span>
<a href="#l47.67"></a><span id="l47.67"> /**</span>
<a href="#l47.68"></a><span id="l47.68">  * This function checks for common illegal characters.</span>
<a href="#l47.69"></a><span id="l47.69">  * It shouldn't be too strict, since we do more extensive tests later.</span>
<a href="#l47.70"></a><span id="l47.70">  */</span>
<a href="#l47.71"></a><span id="l47.71" class="difflineminus">-function emailNameIsLegal(aString)</span>
<a href="#l47.72"></a><span id="l47.72" class="difflineminus">-{</span>
<a href="#l47.73"></a><span id="l47.73" class="difflineplus">+function emailNameIsLegal(aString) {</span>
<a href="#l47.74"></a><span id="l47.74">   return aString &amp;&amp; !/[^!-?A-~]/.test(aString);</span>
<a href="#l47.75"></a><span id="l47.75"> }</span>
<a href="#l47.76"></a><span id="l47.76"> </span>
<a href="#l47.77"></a><span id="l47.77" class="difflineminus">-function emailNameAndDomainAreLegal(aString)</span>
<a href="#l47.78"></a><span id="l47.78" class="difflineminus">-{</span>
<a href="#l47.79"></a><span id="l47.79" class="difflineplus">+function emailNameAndDomainAreLegal(aString) {</span>
<a href="#l47.80"></a><span id="l47.80">   return /^[!-?A-~]+\@[A-Za-z0-9.-]+$/.test(aString);</span>
<a href="#l47.81"></a><span id="l47.81"> }</span>
<a href="#l47.82"></a><span id="l47.82"> </span>
<a href="#l47.83"></a><span id="l47.83" class="difflineminus">-function identityPageInit()</span>
<a href="#l47.84"></a><span id="l47.84" class="difflineminus">-{</span>
<a href="#l47.85"></a><span id="l47.85" class="difflineplus">+function identityPageInit() {</span>
<a href="#l47.86"></a><span id="l47.86">   gCurrentDomain = null;</span>
<a href="#l47.87"></a><span id="l47.87">   gPrefsBundle = document.getElementById(&quot;bundle_prefs&quot;);</span>
<a href="#l47.88"></a><span id="l47.88">   clearEmailTextItems();</span>
<a href="#l47.89"></a><span id="l47.89">   setEmailDescriptionText();</span>
<a href="#l47.90"></a><span id="l47.90">   checkForFullName();</span>
<a href="#l47.91"></a><span id="l47.91">   checkForEmail();</span>
<a href="#l47.92"></a><span id="l47.92">   fixPreFilledEmail();</span>
<a href="#l47.93"></a><span id="l47.93">   identityPageValidate();</span>
<a href="#l47.94"></a><span id="l47.94"> }</span>
<a href="#l47.95"></a><span id="l47.95"> </span>
<a href="#l47.96"></a><span id="l47.96" class="difflineminus">-function clearEmailTextItems()</span>
<a href="#l47.97"></a><span id="l47.97" class="difflineminus">-{</span>
<a href="#l47.98"></a><span id="l47.98" class="difflineplus">+function clearEmailTextItems() {</span>
<a href="#l47.99"></a><span id="l47.99">   var emailDescText = document.getElementById(&quot;emailDescText&quot;);</span>
<a href="#l47.100"></a><span id="l47.100"> </span>
<a href="#l47.101"></a><span id="l47.101">   if (emailDescText.hasChildNodes())</span>
<a href="#l47.102"></a><span id="l47.102">     emailDescText.firstChild.remove();</span>
<a href="#l47.103"></a><span id="l47.103"> </span>
<a href="#l47.104"></a><span id="l47.104">   var postEmailText = document.getElementById(&quot;postEmailText&quot;);</span>
<a href="#l47.105"></a><span id="l47.105">   postEmailText.setAttribute(&quot;value&quot;, &quot;&quot;);</span>
<a href="#l47.106"></a><span id="l47.106">   postEmailText.hidden = true;</span>
<a href="#l47.107"></a><span id="l47.107"> }</span>
<a href="#l47.108"></a><span id="l47.108"> </span>
<a href="#l47.109"></a><span id="l47.109"> // Use email example data that ISP has provided. ISP data, if available</span>
<a href="#l47.110"></a><span id="l47.110"> // for the choice user has made, will be read into CurrentAccountData.</span>
<a href="#l47.111"></a><span id="l47.111"> // Default example data from properties will be used when the info is missing.</span>
<a href="#l47.112"></a><span id="l47.112" class="difflineminus">-function setEmailDescriptionText()</span>
<a href="#l47.113"></a><span id="l47.113" class="difflineminus">-{</span>
<a href="#l47.114"></a><span id="l47.114" class="difflineplus">+function setEmailDescriptionText() {</span>
<a href="#l47.115"></a><span id="l47.115">     var emailDescText = document.getElementById(&quot;emailDescText&quot;);</span>
<a href="#l47.116"></a><span id="l47.116">     var emailFieldLabel = document.getElementById(&quot;emailFieldLabel&quot;);</span>
<a href="#l47.117"></a><span id="l47.117"> </span>
<a href="#l47.118"></a><span id="l47.118">     // Set the default field label</span>
<a href="#l47.119"></a><span id="l47.119">     emailFieldLabel.setAttribute(&quot;value&quot;, gPrefsBundle.getString(&quot;emailFieldText&quot;));</span>
<a href="#l47.120"></a><span id="l47.120"> </span>
<a href="#l47.121"></a><span id="l47.121">     // Check for obtained values and set with default values if needed</span>
<a href="#l47.122"></a><span id="l47.122">     var username = gPrefsBundle.getString(&quot;exampleEmailUserName&quot;);</span>
<a href="#l47.123"></a><span id="l47.123" class="difflineat">@@ -125,16 +119,15 @@ function setEmailDescriptionText()</span>
<a href="#l47.124"></a><span id="l47.124">     emailDescText.appendChild(emailDescTextNode);</span>
<a href="#l47.125"></a><span id="l47.125"> }</span>
<a href="#l47.126"></a><span id="l47.126"> </span>
<a href="#l47.127"></a><span id="l47.127"> function checkForFullName() {</span>
<a href="#l47.128"></a><span id="l47.128">   // var name = document.getElementById(&quot;fullName&quot;);</span>
<a href="#l47.129"></a><span id="l47.129">   // We currently have no way to propose any useful name here.</span>
<a href="#l47.130"></a><span id="l47.130"> }</span>
<a href="#l47.131"></a><span id="l47.131"> </span>
<a href="#l47.132"></a><span id="l47.132" class="difflineminus">-function checkForEmail()</span>
<a href="#l47.133"></a><span id="l47.133" class="difflineminus">-{</span>
<a href="#l47.134"></a><span id="l47.134" class="difflineplus">+function checkForEmail() {</span>
<a href="#l47.135"></a><span id="l47.135">     var email = document.getElementById(&quot;email&quot;);</span>
<a href="#l47.136"></a><span id="l47.136">     var pageData = parent.GetPageData();</span>
<a href="#l47.137"></a><span id="l47.137">     if (pageData &amp;&amp; pageData.identity &amp;&amp; pageData.identity.email) {</span>
<a href="#l47.138"></a><span id="l47.138">         email.value = pageData.identity.email.value;</span>
<a href="#l47.139"></a><span id="l47.139">     }</span>
<a href="#l47.140"></a><span id="l47.140"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/base/prefs/content/aw-incoming.js</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/base/prefs/content/aw-incoming.js</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -1,21 +1,22 @@</span>
<a href="#l48.4"></a><span id="l48.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l48.5"></a><span id="l48.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l48.6"></a><span id="l48.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l48.7"></a><span id="l48.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l48.8"></a><span id="l48.8"> </span>
<a href="#l48.9"></a><span id="l48.9" class="difflineplus">+/* import-globals-from AccountWizard.js */</span>
<a href="#l48.10"></a><span id="l48.10" class="difflineplus">+</span>
<a href="#l48.11"></a><span id="l48.11"> var {cleanUpHostName, isLegalHostNameOrIP} = ChromeUtils.import(&quot;resource:///modules/hostnameUtils.jsm&quot;);</span>
<a href="#l48.12"></a><span id="l48.12"> </span>
<a href="#l48.13"></a><span id="l48.13"> var gOnMailServersPage;</span>
<a href="#l48.14"></a><span id="l48.14"> var gOnNewsServerPage;</span>
<a href="#l48.15"></a><span id="l48.15"> var gProtocolInfo = null;</span>
<a href="#l48.16"></a><span id="l48.16"> </span>
<a href="#l48.17"></a><span id="l48.17" class="difflineminus">-function incomingPageValidate()</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineminus">-{</span>
<a href="#l48.19"></a><span id="l48.19" class="difflineplus">+function incomingPageValidate() {</span>
<a href="#l48.20"></a><span id="l48.20">   var canAdvance = true;</span>
<a href="#l48.21"></a><span id="l48.21">   var hostName;</span>
<a href="#l48.22"></a><span id="l48.22"> </span>
<a href="#l48.23"></a><span id="l48.23">   if (gOnMailServersPage) {</span>
<a href="#l48.24"></a><span id="l48.24">     hostName = document.getElementById(&quot;incomingServer&quot;).value;</span>
<a href="#l48.25"></a><span id="l48.25">     if (!isLegalHostNameOrIP(cleanUpHostName(hostName)))</span>
<a href="#l48.26"></a><span id="l48.26">       canAdvance = false;</span>
<a href="#l48.27"></a><span id="l48.27">   }</span>
<a href="#l48.28"></a><span id="l48.28" class="difflineat">@@ -32,56 +33,52 @@ function incomingPageValidate()</span>
<a href="#l48.29"></a><span id="l48.29">     if (gProtocolInfo &amp;&amp; gProtocolInfo.requiresUsername &amp;&amp; !username ||</span>
<a href="#l48.30"></a><span id="l48.30">         parent.AccountExists(username, hostName, serverType))</span>
<a href="#l48.31"></a><span id="l48.31">       canAdvance = false;</span>
<a href="#l48.32"></a><span id="l48.32">   }</span>
<a href="#l48.33"></a><span id="l48.33"> </span>
<a href="#l48.34"></a><span id="l48.34">   document.documentElement.canAdvance = canAdvance;</span>
<a href="#l48.35"></a><span id="l48.35"> }</span>
<a href="#l48.36"></a><span id="l48.36"> </span>
<a href="#l48.37"></a><span id="l48.37" class="difflineminus">-function incomingPageUnload()</span>
<a href="#l48.38"></a><span id="l48.38" class="difflineminus">-{</span>
<a href="#l48.39"></a><span id="l48.39" class="difflineplus">+function incomingPageUnload() {</span>
<a href="#l48.40"></a><span id="l48.40">   var pageData = parent.GetPageData();</span>
<a href="#l48.41"></a><span id="l48.41"> </span>
<a href="#l48.42"></a><span id="l48.42">   if (gOnMailServersPage) {</span>
<a href="#l48.43"></a><span id="l48.43">     var incomingServerName = document.getElementById(&quot;incomingServer&quot;);</span>
<a href="#l48.44"></a><span id="l48.44">     setPageData(pageData, &quot;server&quot;, &quot;hostname&quot;, cleanUpHostName(incomingServerName.value));</span>
<a href="#l48.45"></a><span id="l48.45">     var serverport = document.getElementById(&quot;serverPort&quot;).value;</span>
<a href="#l48.46"></a><span id="l48.46">     setPageData(pageData, &quot;server&quot;, &quot;port&quot;, serverport);</span>
<a href="#l48.47"></a><span id="l48.47">     var username = document.getElementById(&quot;username&quot;).value;</span>
<a href="#l48.48"></a><span id="l48.48">     setPageData(pageData, &quot;login&quot;, &quot;username&quot;, username);</span>
<a href="#l48.49"></a><span id="l48.49" class="difflineminus">-  }</span>
<a href="#l48.50"></a><span id="l48.50" class="difflineminus">-  else if (gOnNewsServerPage) {</span>
<a href="#l48.51"></a><span id="l48.51" class="difflineplus">+  } else if (gOnNewsServerPage) {</span>
<a href="#l48.52"></a><span id="l48.52">     var newsServerName = document.getElementById(&quot;newsServer&quot;);</span>
<a href="#l48.53"></a><span id="l48.53">     setPageData(pageData, &quot;newsserver&quot;, &quot;hostname&quot;, cleanUpHostName(newsServerName.value));</span>
<a href="#l48.54"></a><span id="l48.54">   }</span>
<a href="#l48.55"></a><span id="l48.55"> </span>
<a href="#l48.56"></a><span id="l48.56">   return true;</span>
<a href="#l48.57"></a><span id="l48.57"> }</span>
<a href="#l48.58"></a><span id="l48.58"> </span>
<a href="#l48.59"></a><span id="l48.59"> function incomingPageInit() {</span>
<a href="#l48.60"></a><span id="l48.60">   gOnMailServersPage = (document.documentElement.currentPage.id == &quot;incomingpage&quot;);</span>
<a href="#l48.61"></a><span id="l48.61">   gOnNewsServerPage = (document.documentElement.currentPage.id == &quot;newsserver&quot;);</span>
<a href="#l48.62"></a><span id="l48.62" class="difflineminus">-  if (gOnNewsServerPage)</span>
<a href="#l48.63"></a><span id="l48.63" class="difflineminus">-  {</span>
<a href="#l48.64"></a><span id="l48.64" class="difflineplus">+  var pageData = parent.GetPageData();</span>
<a href="#l48.65"></a><span id="l48.65" class="difflineplus">+  if (gOnNewsServerPage) {</span>
<a href="#l48.66"></a><span id="l48.66">     var newsServer = document.getElementById(&quot;newsServer&quot;);</span>
<a href="#l48.67"></a><span id="l48.67" class="difflineminus">-    var pageData = parent.GetPageData();</span>
<a href="#l48.68"></a><span id="l48.68">     if (pageData.newsserver &amp;&amp; pageData.newsserver.hostname)</span>
<a href="#l48.69"></a><span id="l48.69">       newsServer.value = pageData.newsserver.hostname.value;</span>
<a href="#l48.70"></a><span id="l48.70">   }</span>
<a href="#l48.71"></a><span id="l48.71"> </span>
<a href="#l48.72"></a><span id="l48.72">   var incomingServerbox = document.getElementById(&quot;incomingServerbox&quot;);</span>
<a href="#l48.73"></a><span id="l48.73">   var serverTypeBox = document.getElementById(&quot;serverTypeBox&quot;);</span>
<a href="#l48.74"></a><span id="l48.74">   if (incomingServerbox &amp;&amp; serverTypeBox) {</span>
<a href="#l48.75"></a><span id="l48.75">     incomingServerbox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l48.76"></a><span id="l48.76">     serverTypeBox.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l48.77"></a><span id="l48.77">   }</span>
<a href="#l48.78"></a><span id="l48.78"> </span>
<a href="#l48.79"></a><span id="l48.79">   // Server type selection (pop3 or imap) is for mail accounts only</span>
<a href="#l48.80"></a><span id="l48.80" class="difflineminus">-  var pageData = parent.GetPageData();</span>
<a href="#l48.81"></a><span id="l48.81">   var isMailAccount = pageData.accounttype.mailaccount.value;</span>
<a href="#l48.82"></a><span id="l48.82">   var isOtherAccount = pageData.accounttype.otheraccount.value;</span>
<a href="#l48.83"></a><span id="l48.83">   if (isMailAccount) {</span>
<a href="#l48.84"></a><span id="l48.84">     var serverTypeRadioGroup = document.getElementById(&quot;servertype&quot;);</span>
<a href="#l48.85"></a><span id="l48.85">     /*</span>
<a href="#l48.86"></a><span id="l48.86">      * Check to see if the radiogroup has any value. If there is no</span>
<a href="#l48.87"></a><span id="l48.87">      * value, this must be the first time user visiting this page in the</span>
<a href="#l48.88"></a><span id="l48.88">      * account setup process. So, the default is set to pop3. If there</span>
<a href="#l48.89"></a><span id="l48.89" class="difflineat">@@ -101,18 +98,17 @@ function incomingPageInit() {</span>
<a href="#l48.90"></a><span id="l48.90">                &quot;imap&quot; : &quot;pop3&quot;);</span>
<a href="#l48.91"></a><span id="l48.91">       serverTypeRadioGroup.selectedItem = serverTypeRadioItem;      // Set pop3 server type as default selection</span>
<a href="#l48.92"></a><span id="l48.92">     }</span>
<a href="#l48.93"></a><span id="l48.93">     var leaveMessages = document.getElementById(&quot;leaveMessagesOnServer&quot;);</span>
<a href="#l48.94"></a><span id="l48.94">     var deferStorage = document.getElementById(&quot;deferStorage&quot;);</span>
<a href="#l48.95"></a><span id="l48.95">     setServerType();</span>
<a href="#l48.96"></a><span id="l48.96">     setServerPrefs(leaveMessages);</span>
<a href="#l48.97"></a><span id="l48.97">     setServerPrefs(deferStorage);</span>
<a href="#l48.98"></a><span id="l48.98" class="difflineminus">-  }</span>
<a href="#l48.99"></a><span id="l48.99" class="difflineminus">-  else if (isOtherAccount) {</span>
<a href="#l48.100"></a><span id="l48.100" class="difflineplus">+  } else if (isOtherAccount) {</span>
<a href="#l48.101"></a><span id="l48.101">     document.getElementById(&quot;deferStorageBox&quot;).hidden = true;</span>
<a href="#l48.102"></a><span id="l48.102">   }</span>
<a href="#l48.103"></a><span id="l48.103"> </span>
<a href="#l48.104"></a><span id="l48.104">   if (pageData.server &amp;&amp; pageData.server.hostname) {</span>
<a href="#l48.105"></a><span id="l48.105">     var incomingServerTextBox = document.getElementById(&quot;incomingServer&quot;);</span>
<a href="#l48.106"></a><span id="l48.106">     if (incomingServerTextBox &amp;&amp; incomingServerTextBox.value == &quot;&quot;)</span>
<a href="#l48.107"></a><span id="l48.107">       incomingServerTextBox.value = pageData.server.hostname.value;</span>
<a href="#l48.108"></a><span id="l48.108">   }</span>
<a href="#l48.109"></a><span id="l48.109" class="difflineat">@@ -128,30 +124,28 @@ function incomingPageInit() {</span>
<a href="#l48.110"></a><span id="l48.110">     if (gProtocolInfo.requiresUsername) {</span>
<a href="#l48.111"></a><span id="l48.111">       // since we require a username, use the uid from the email address</span>
<a href="#l48.112"></a><span id="l48.112">       loginNameInput.value = parent.getUsernameFromEmail(pageData.identity.email.value);</span>
<a href="#l48.113"></a><span id="l48.113">     }</span>
<a href="#l48.114"></a><span id="l48.114">   }</span>
<a href="#l48.115"></a><span id="l48.115">   incomingPageValidate();</span>
<a href="#l48.116"></a><span id="l48.116"> }</span>
<a href="#l48.117"></a><span id="l48.117"> </span>
<a href="#l48.118"></a><span id="l48.118" class="difflineminus">-function setServerType()</span>
<a href="#l48.119"></a><span id="l48.119" class="difflineminus">-{</span>
<a href="#l48.120"></a><span id="l48.120" class="difflineplus">+function setServerType() {</span>
<a href="#l48.121"></a><span id="l48.121">   var pageData = parent.GetPageData();</span>
<a href="#l48.122"></a><span id="l48.122">   var serverType = document.getElementById(&quot;servertype&quot;).value;</span>
<a href="#l48.123"></a><span id="l48.123">   var deferStorageBox = document.getElementById(&quot;deferStorageBox&quot;);</span>
<a href="#l48.124"></a><span id="l48.124">   var leaveMessages = document.getElementById(&quot;leaveMsgsOnSrvrBox&quot;);</span>
<a href="#l48.125"></a><span id="l48.125">   var port = serverType == &quot;pop3&quot; ? 110 : 143;</span>
<a href="#l48.126"></a><span id="l48.126"> </span>
<a href="#l48.127"></a><span id="l48.127">   document.getElementById(&quot;serverPort&quot;).value = port;</span>
<a href="#l48.128"></a><span id="l48.128">   document.getElementById(&quot;defaultPortValue&quot;).value = port;</span>
<a href="#l48.129"></a><span id="l48.129"> </span>
<a href="#l48.130"></a><span id="l48.130">   deferStorageBox.hidden = serverType == &quot;imap&quot;;</span>
<a href="#l48.131"></a><span id="l48.131">   leaveMessages.hidden = serverType == &quot;imap&quot;;</span>
<a href="#l48.132"></a><span id="l48.132">   setPageData(pageData, &quot;server&quot;, &quot;servertype&quot;, serverType);</span>
<a href="#l48.133"></a><span id="l48.133">   setPageData(pageData, &quot;server&quot;, &quot;port&quot;, port);</span>
<a href="#l48.134"></a><span id="l48.134">   incomingPageValidate();</span>
<a href="#l48.135"></a><span id="l48.135"> }</span>
<a href="#l48.136"></a><span id="l48.136"> </span>
<a href="#l48.137"></a><span id="l48.137" class="difflineminus">-function setServerPrefs(aThis)</span>
<a href="#l48.138"></a><span id="l48.138" class="difflineminus">-{</span>
<a href="#l48.139"></a><span id="l48.139" class="difflineplus">+function setServerPrefs(aThis) {</span>
<a href="#l48.140"></a><span id="l48.140">   setPageData(parent.GetPageData(), &quot;server&quot;, aThis.id, aThis.checked);</span>
<a href="#l48.141"></a><span id="l48.141"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/base/prefs/content/aw-outgoing.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/base/prefs/content/aw-outgoing.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -1,13 +1,15 @@</span>
<a href="#l49.4"></a><span id="l49.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l49.5"></a><span id="l49.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l49.6"></a><span id="l49.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l49.7"></a><span id="l49.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l49.8"></a><span id="l49.8"> </span>
<a href="#l49.9"></a><span id="l49.9" class="difflineplus">+/* import-globals-from AccountWizard.js */</span>
<a href="#l49.10"></a><span id="l49.10" class="difflineplus">+</span>
<a href="#l49.11"></a><span id="l49.11"> var {cleanUpHostName, isLegalHostNameOrIP} = ChromeUtils.import(&quot;resource:///modules/hostnameUtils.jsm&quot;);</span>
<a href="#l49.12"></a><span id="l49.12"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l49.13"></a><span id="l49.13"> </span>
<a href="#l49.14"></a><span id="l49.14"> var gProtocolInfo = null;</span>
<a href="#l49.15"></a><span id="l49.15"> var gPrefsBundle;</span>
<a href="#l49.16"></a><span id="l49.16"> </span>
<a href="#l49.17"></a><span id="l49.17"> function outgoingPageValidate() {</span>
<a href="#l49.18"></a><span id="l49.18">   let canAdvance = true;</span>
<a href="#l49.19"></a><span id="l49.19" class="difflineat">@@ -52,91 +54,85 @@ function outgoingPageInit() {</span>
<a href="#l49.20"></a><span id="l49.20">     var haveSmtpBox = document.getElementById(&quot;haveSmtp&quot;);</span>
<a href="#l49.21"></a><span id="l49.21"> </span>
<a href="#l49.22"></a><span id="l49.22">     var boxToHide;</span>
<a href="#l49.23"></a><span id="l49.23">     var boxToShow;</span>
<a href="#l49.24"></a><span id="l49.24"> </span>
<a href="#l49.25"></a><span id="l49.25">     if (smtpServer &amp;&amp; smtpServer.hostname) {</span>
<a href="#l49.26"></a><span id="l49.26">       // we have a hostname, so modify and show the static text and</span>
<a href="#l49.27"></a><span id="l49.27">       // store the value of the default smtp server in the textbox.</span>
<a href="#l49.28"></a><span id="l49.28" class="difflineminus">-      modifyStaticText(smtpServer.hostname, &quot;1&quot;)</span>
<a href="#l49.29"></a><span id="l49.29" class="difflineplus">+      modifyStaticText(smtpServer.hostname, &quot;1&quot;);</span>
<a href="#l49.30"></a><span id="l49.30">       boxToShow = haveSmtpBox;</span>
<a href="#l49.31"></a><span id="l49.31">       boxToHide = noSmtpBox;</span>
<a href="#l49.32"></a><span id="l49.32" class="difflineminus">-    }</span>
<a href="#l49.33"></a><span id="l49.33" class="difflineminus">-    else {</span>
<a href="#l49.34"></a><span id="l49.34" class="difflineplus">+    } else {</span>
<a href="#l49.35"></a><span id="l49.35">       // no default hostname yet</span>
<a href="#l49.36"></a><span id="l49.36">       boxToShow = noSmtpBox;</span>
<a href="#l49.37"></a><span id="l49.37">       boxToHide = haveSmtpBox;</span>
<a href="#l49.38"></a><span id="l49.38">     }</span>
<a href="#l49.39"></a><span id="l49.39"> </span>
<a href="#l49.40"></a><span id="l49.40">     if (boxToHide)</span>
<a href="#l49.41"></a><span id="l49.41">       boxToHide.setAttribute(&quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l49.42"></a><span id="l49.42"> </span>
<a href="#l49.43"></a><span id="l49.43">     if (boxToShow)</span>
<a href="#l49.44"></a><span id="l49.44">       boxToShow.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l49.45"></a><span id="l49.45"> </span>
<a href="#l49.46"></a><span id="l49.46">     var smtpNameInput = document.getElementById(&quot;smtpusername&quot;);</span>
<a href="#l49.47"></a><span id="l49.47">     smtpServer = MailServices.smtp.defaultServer;</span>
<a href="#l49.48"></a><span id="l49.48">     if (smtpServer &amp;&amp; smtpServer.hostname &amp;&amp; smtpServer.username) {</span>
<a href="#l49.49"></a><span id="l49.49">       // we have a default SMTP server, so modify and show the static text</span>
<a href="#l49.50"></a><span id="l49.50">       // and store the username for the default server in the textbox.</span>
<a href="#l49.51"></a><span id="l49.51" class="difflineminus">-      modifyStaticText(smtpServer.username, &quot;2&quot;)</span>
<a href="#l49.52"></a><span id="l49.52" class="difflineplus">+      modifyStaticText(smtpServer.username, &quot;2&quot;);</span>
<a href="#l49.53"></a><span id="l49.53">       hideShowLoginSettings(2, 1, 3);</span>
<a href="#l49.54"></a><span id="l49.54">       smtpNameInput.value = smtpServer.username;</span>
<a href="#l49.55"></a><span id="l49.55" class="difflineminus">-    }</span>
<a href="#l49.56"></a><span id="l49.56" class="difflineminus">-    else {</span>
<a href="#l49.57"></a><span id="l49.57" class="difflineplus">+    } else {</span>
<a href="#l49.58"></a><span id="l49.58">       // no default SMTP server yet, so need to compare</span>
<a href="#l49.59"></a><span id="l49.59">       // incoming and outgoing server names</span>
<a href="#l49.60"></a><span id="l49.60">       var smtpServerName = pageData.server.smtphostname.value;</span>
<a href="#l49.61"></a><span id="l49.61">       var incomingServerName = pageData.server.hostname.value;</span>
<a href="#l49.62"></a><span id="l49.62">       if (smtpServerName == incomingServerName) {</span>
<a href="#l49.63"></a><span id="l49.63">         // incoming and outgoing server names are the same, so show</span>
<a href="#l49.64"></a><span id="l49.64">         // the static text and make sure textbox blank for later tests.</span>
<a href="#l49.65"></a><span id="l49.65" class="difflineminus">-        modifyStaticText(smtpServerName, &quot;3&quot;)</span>
<a href="#l49.66"></a><span id="l49.66" class="difflineplus">+        modifyStaticText(smtpServerName, &quot;3&quot;);</span>
<a href="#l49.67"></a><span id="l49.67">         hideShowLoginSettings(3, 1, 2);</span>
<a href="#l49.68"></a><span id="l49.68">         smtpNameInput.value = &quot;&quot;;</span>
<a href="#l49.69"></a><span id="l49.69" class="difflineminus">-      }</span>
<a href="#l49.70"></a><span id="l49.70" class="difflineminus">-      else {</span>
<a href="#l49.71"></a><span id="l49.71" class="difflineplus">+      } else {</span>
<a href="#l49.72"></a><span id="l49.72">         // incoming and outgoing server names are different, so set smtp</span>
<a href="#l49.73"></a><span id="l49.73">         // username's textbox to be the same as incoming's one, unless already set.</span>
<a href="#l49.74"></a><span id="l49.74">         hideShowLoginSettings(1, 2, 3);</span>
<a href="#l49.75"></a><span id="l49.75" class="difflineplus">+        var loginNameInput = document.getElementById(&quot;username&quot;);</span>
<a href="#l49.76"></a><span id="l49.76">         smtpNameInput.value = smtpNameInput.value || loginNameInput.value;</span>
<a href="#l49.77"></a><span id="l49.77">       }</span>
<a href="#l49.78"></a><span id="l49.78">     }</span>
<a href="#l49.79"></a><span id="l49.79">     outgoingPageValidate();</span>
<a href="#l49.80"></a><span id="l49.80"> }</span>
<a href="#l49.81"></a><span id="l49.81"> </span>
<a href="#l49.82"></a><span id="l49.82" class="difflineminus">-function modifyStaticText(smtpMod, smtpBox)</span>
<a href="#l49.83"></a><span id="l49.83" class="difflineminus">-{</span>
<a href="#l49.84"></a><span id="l49.84" class="difflineplus">+function modifyStaticText(smtpMod, smtpBox) {</span>
<a href="#l49.85"></a><span id="l49.85">   // modify the value in the smtp display if we already have a</span>
<a href="#l49.86"></a><span id="l49.86">   // smtp server so that the single string displays the hostname</span>
<a href="#l49.87"></a><span id="l49.87">   // or username for the smtp server.</span>
<a href="#l49.88"></a><span id="l49.88" class="difflineminus">-  var smtpStatic = document.getElementById(&quot;smtpStaticText&quot;+smtpBox);</span>
<a href="#l49.89"></a><span id="l49.89" class="difflineplus">+  var smtpStatic = document.getElementById(&quot;smtpStaticText&quot; + smtpBox);</span>
<a href="#l49.90"></a><span id="l49.90">   if (smtpStatic &amp;&amp; smtpStatic.hasChildNodes())</span>
<a href="#l49.91"></a><span id="l49.91">     smtpStatic.childNodes[0].nodeValue = smtpStatic.getAttribute(&quot;prefix&quot;) +</span>
<a href="#l49.92"></a><span id="l49.92">                                          smtpMod + smtpStatic.getAttribute(&quot;suffix&quot;);</span>
<a href="#l49.93"></a><span id="l49.93"> }</span>
<a href="#l49.94"></a><span id="l49.94"> </span>
<a href="#l49.95"></a><span id="l49.95" class="difflineminus">-function hideShowLoginSettings(aEle, bEle, cEle)</span>
<a href="#l49.96"></a><span id="l49.96" class="difflineminus">-{</span>
<a href="#l49.97"></a><span id="l49.97" class="difflineplus">+function hideShowLoginSettings(aEle, bEle, cEle) {</span>
<a href="#l49.98"></a><span id="l49.98">     document.getElementById(&quot;loginSet&quot; + aEle).hidden = false;</span>
<a href="#l49.99"></a><span id="l49.99">     document.getElementById(&quot;loginSet&quot; + bEle).hidden = true;</span>
<a href="#l49.100"></a><span id="l49.100">     document.getElementById(&quot;loginSet&quot; + cEle).hidden = true;</span>
<a href="#l49.101"></a><span id="l49.101"> }</span>
<a href="#l49.102"></a><span id="l49.102"> </span>
<a href="#l49.103"></a><span id="l49.103" class="difflineminus">-var savedPassword=&quot;&quot;;</span>
<a href="#l49.104"></a><span id="l49.104" class="difflineplus">+var savedPassword = &quot;&quot;;</span>
<a href="#l49.105"></a><span id="l49.105"> </span>
<a href="#l49.106"></a><span id="l49.106"> function onSavePassword(target) {</span>
<a href="#l49.107"></a><span id="l49.107">     dump(&quot;savePassword changed! (&quot; + target.checked + &quot;)\n&quot;);</span>
<a href="#l49.108"></a><span id="l49.108">     var passwordField = document.getElementById(&quot;server.password&quot;);</span>
<a href="#l49.109"></a><span id="l49.109">     if (!passwordField) return;</span>
<a href="#l49.110"></a><span id="l49.110"> </span>
<a href="#l49.111"></a><span id="l49.111">     if (target.checked) {</span>
<a href="#l49.112"></a><span id="l49.112">         passwordField.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l49.113"></a><span id="l49.113">         passwordField.value = savedPassword;</span>
<a href="#l49.114"></a><span id="l49.114" class="difflineminus">-    }</span>
<a href="#l49.115"></a><span id="l49.115" class="difflineminus">-    else {</span>
<a href="#l49.116"></a><span id="l49.116" class="difflineplus">+    } else {</span>
<a href="#l49.117"></a><span id="l49.117">         passwordField.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l49.118"></a><span id="l49.118">         savedPassword = passwordField.value;</span>
<a href="#l49.119"></a><span id="l49.119">         passwordField.value = &quot;&quot;;</span>
<a href="#l49.120"></a><span id="l49.120">     }</span>
<a href="#l49.121"></a><span id="l49.121" class="difflineminus">-</span>
<a href="#l49.122"></a><span id="l49.122"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mailnews/base/prefs/content/converterDialog.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mailnews/base/prefs/content/converterDialog.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -101,32 +101,32 @@ function placeAccountName(aServer) {</span>
<a href="#l50.4"></a><span id="l50.4">     // its hostname which is &quot;Local Folders&quot;.</span>
<a href="#l50.5"></a><span id="l50.5">     // TODO: maybe test against .key != MailServices.accounts.localFoldersServer.key ?</span>
<a href="#l50.6"></a><span id="l50.6">     let deferredToAccountName = deferredToAccount.incomingServer.hostName;</span>
<a href="#l50.7"></a><span id="l50.7">     if (deferredToAccountName != &quot;Local Folders&quot;) {</span>
<a href="#l50.8"></a><span id="l50.8">       deferredToAccountName = deferredToAccount.incomingServer.username;</span>
<a href="#l50.9"></a><span id="l50.9">     }</span>
<a href="#l50.10"></a><span id="l50.10"> </span>
<a href="#l50.11"></a><span id="l50.11">     if (aServer.rootFolder.filePath.path != deferredToRootFolder) {</span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-      document.getElementById(&quot;warningSpan&quot;).innerHTML =</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+      document.getElementById(&quot;warningSpan&quot;).textContent =</span>
<a href="#l50.14"></a><span id="l50.14">         bundle.formatStringFromName(</span>
<a href="#l50.15"></a><span id="l50.15">           &quot;converterDialog.warningForDeferredAccount&quot;,</span>
<a href="#l50.16"></a><span id="l50.16">           [aServer.username, deferredToAccountName, deferredToAccountName,</span>
<a href="#l50.17"></a><span id="l50.17">           deferredAccountsString,</span>
<a href="#l50.18"></a><span id="l50.18">           accountsToConvert, storeContractId, brandShortName], 7);</span>
<a href="#l50.19"></a><span id="l50.19">     } else {</span>
<a href="#l50.20"></a><span id="l50.20" class="difflineminus">-      document.getElementById(&quot;warningSpan&quot;).innerHTML =</span>
<a href="#l50.21"></a><span id="l50.21" class="difflineplus">+      document.getElementById(&quot;warningSpan&quot;).textContent =</span>
<a href="#l50.22"></a><span id="l50.22">         bundle.formatStringFromName(</span>
<a href="#l50.23"></a><span id="l50.23">           &quot;converterDialog.warningForDeferredToAccount&quot;,</span>
<a href="#l50.24"></a><span id="l50.24">           [deferredToAccountName,</span>
<a href="#l50.25"></a><span id="l50.25">           deferredAccountsString,</span>
<a href="#l50.26"></a><span id="l50.26">           accountsToConvert, storeContractId, brandShortName], 5);</span>
<a href="#l50.27"></a><span id="l50.27">     }</span>
<a href="#l50.28"></a><span id="l50.28"> </span>
<a href="#l50.29"></a><span id="l50.29" class="difflineminus">-    document.getElementById(&quot;messageSpan&quot;).innerHTML =</span>
<a href="#l50.30"></a><span id="l50.30" class="difflineplus">+    document.getElementById(&quot;messageSpan&quot;).textContent =</span>
<a href="#l50.31"></a><span id="l50.31">       bundle.formatStringFromName(&quot;converterDialog.messageForDeferredAccount&quot;,</span>
<a href="#l50.32"></a><span id="l50.32">                                   [accountsToConvert, storeContractId], 2);</span>
<a href="#l50.33"></a><span id="l50.33">     gServer = deferredToAccount.incomingServer;</span>
<a href="#l50.34"></a><span id="l50.34">   } else {</span>
<a href="#l50.35"></a><span id="l50.35">     // No account is deferred.</span>
<a href="#l50.36"></a><span id="l50.36">     let storeContractId = Services.prefs.getCharPref(</span>
<a href="#l50.37"></a><span id="l50.37">       &quot;mail.server.&quot; + aServer.key + &quot;.storeContractID&quot;);</span>
<a href="#l50.38"></a><span id="l50.38">     if (storeContractId == &quot;@mozilla.org/msgstore/berkeleystore;1&quot;) {</span>
<a href="#l50.39"></a><span id="l50.39" class="difflineat">@@ -137,21 +137,21 @@ function placeAccountName(aServer) {</span>
<a href="#l50.40"></a><span id="l50.40"> </span>
<a href="#l50.41"></a><span id="l50.41">     let tempName = aServer.username;</span>
<a href="#l50.42"></a><span id="l50.42">     if (tempName == &quot;nobody&quot;) {</span>
<a href="#l50.43"></a><span id="l50.43">       tempName = &quot;Local Folders&quot;;</span>
<a href="#l50.44"></a><span id="l50.44">     } else if (!tempName) {</span>
<a href="#l50.45"></a><span id="l50.45">       tempName = aServer.hostName;</span>
<a href="#l50.46"></a><span id="l50.46">     }</span>
<a href="#l50.47"></a><span id="l50.47"> </span>
<a href="#l50.48"></a><span id="l50.48" class="difflineminus">-    document.getElementById(&quot;warningSpan&quot;).innerHTML =</span>
<a href="#l50.49"></a><span id="l50.49" class="difflineplus">+    document.getElementById(&quot;warningSpan&quot;).textContent =</span>
<a href="#l50.50"></a><span id="l50.50">       bundle.formatStringFromName(&quot;converterDialog.warning&quot;,</span>
<a href="#l50.51"></a><span id="l50.51">                                   [tempName, storeContractId, brandShortName],</span>
<a href="#l50.52"></a><span id="l50.52">                                   3);</span>
<a href="#l50.53"></a><span id="l50.53" class="difflineminus">-    document.getElementById(&quot;messageSpan&quot;).innerHTML =</span>
<a href="#l50.54"></a><span id="l50.54" class="difflineplus">+    document.getElementById(&quot;messageSpan&quot;).textContent =</span>
<a href="#l50.55"></a><span id="l50.55">       bundle.formatStringFromName(&quot;converterDialog.message&quot;,</span>
<a href="#l50.56"></a><span id="l50.56">                                   [tempName, storeContractId], 2);</span>
<a href="#l50.57"></a><span id="l50.57">     gServer = aServer;</span>
<a href="#l50.58"></a><span id="l50.58">   }</span>
<a href="#l50.59"></a><span id="l50.59"> </span>
<a href="#l50.60"></a><span id="l50.60">   // Forces the resize of the dialog to the actual content</span>
<a href="#l50.61"></a><span id="l50.61">   window.sizeToContent();</span>
<a href="#l50.62"></a><span id="l50.62"> }</span>
<a href="#l50.63"></a><span id="l50.63" class="difflineat">@@ -165,17 +165,17 @@ function startContinue(aSelectedStoreTyp</span>
<a href="#l50.64"></a><span id="l50.64">   gResponse = aResponse;</span>
<a href="#l50.65"></a><span id="l50.65">   gFolder = gServer.rootFolder.filePath;</span>
<a href="#l50.66"></a><span id="l50.66"> </span>
<a href="#l50.67"></a><span id="l50.67">   let bundle = Services.strings</span>
<a href="#l50.68"></a><span id="l50.68">     .createBundle(&quot;chrome://messenger/locale/converterDialog.properties&quot;);</span>
<a href="#l50.69"></a><span id="l50.69"> </span>
<a href="#l50.70"></a><span id="l50.70">   document.getElementById(&quot;progress&quot;).addEventListener(&quot;progress&quot;, function(e) {</span>
<a href="#l50.71"></a><span id="l50.71">    document.getElementById(&quot;progress&quot;).value = e.detail;</span>
<a href="#l50.72"></a><span id="l50.72" class="difflineminus">-   document.getElementById(&quot;progressPrcnt&quot;).innerHTML =</span>
<a href="#l50.73"></a><span id="l50.73" class="difflineplus">+   document.getElementById(&quot;progressPrcnt&quot;).textContent =</span>
<a href="#l50.74"></a><span id="l50.74">      bundle.formatStringFromName(&quot;converterDialog.percentDone&quot;, [e.detail], 1);</span>
<a href="#l50.75"></a><span id="l50.75">   });</span>
<a href="#l50.76"></a><span id="l50.76"> </span>
<a href="#l50.77"></a><span id="l50.77">   document.getElementById(&quot;warning&quot;).setAttribute(&quot;hidden&quot;, &quot;hidden&quot;);</span>
<a href="#l50.78"></a><span id="l50.78">   document.getElementById(&quot;progressDiv&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l50.79"></a><span id="l50.79"> </span>
<a href="#l50.80"></a><span id="l50.80">   // Storing original prefs and root folder path</span>
<a href="#l50.81"></a><span id="l50.81">   // to revert changes in case of error.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mailnews/base/prefs/content/removeAccount.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mailnews/base/prefs/content/removeAccount.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -62,17 +62,17 @@ function enableRemove() {</span>
<a href="#l51.4"></a><span id="l51.4">  * Show the local directory.</span>
<a href="#l51.5"></a><span id="l51.5">  */</span>
<a href="#l51.6"></a><span id="l51.6"> function openLocalDirectory() {</span>
<a href="#l51.7"></a><span id="l51.7">   let nsLocalFile = Components.Constructor(&quot;@mozilla.org/file/local;1&quot;,</span>
<a href="#l51.8"></a><span id="l51.8">                                            &quot;nsIFile&quot;, &quot;initWithPath&quot;);</span>
<a href="#l51.9"></a><span id="l51.9">   let localDir = gServer.localPath.path;</span>
<a href="#l51.10"></a><span id="l51.10">   try {</span>
<a href="#l51.11"></a><span id="l51.11">     new nsLocalFile(localDir).reveal();</span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-  } catch(e) {</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+  } catch (e) {</span>
<a href="#l51.14"></a><span id="l51.14">     // Reveal may fail e.g. on Linux, then just show the path as a string.</span>
<a href="#l51.15"></a><span id="l51.15">     document.getElementById(&quot;localDirectory&quot;).value = localDir;</span>
<a href="#l51.16"></a><span id="l51.16">     document.getElementById(&quot;localDirectory&quot;).collapsed = false;</span>
<a href="#l51.17"></a><span id="l51.17">   }</span>
<a href="#l51.18"></a><span id="l51.18"> }</span>
<a href="#l51.19"></a><span id="l51.19"> </span>
<a href="#l51.20"></a><span id="l51.20"> function showInfo() {</span>
<a href="#l51.21"></a><span id="l51.21">   let descs = document.querySelectorAll(&quot;vbox.indent&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mailnews/base/search/content/CustomHeaders.js</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mailnews/base/search/content/CustomHeaders.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -6,198 +6,171 @@</span>
<a href="#l52.4"></a><span id="l52.4"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l52.5"></a><span id="l52.5"> </span>
<a href="#l52.6"></a><span id="l52.6"> var gAddButton;</span>
<a href="#l52.7"></a><span id="l52.7"> var gRemoveButton;</span>
<a href="#l52.8"></a><span id="l52.8"> var gHeaderInputElement;</span>
<a href="#l52.9"></a><span id="l52.9"> var gArrayHdrs;</span>
<a href="#l52.10"></a><span id="l52.10"> var gHdrsList;</span>
<a href="#l52.11"></a><span id="l52.11"> var gContainer;</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-var gFilterBundle=null;</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineminus">-var gCustomBundle=null;</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineplus">+var gFilterBundle = null;</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineplus">+var gCustomBundle = null;</span>
<a href="#l52.16"></a><span id="l52.16"> </span>
<a href="#l52.17"></a><span id="l52.17"> document.addEventListener(&quot;dialogaccept&quot;, onOk);</span>
<a href="#l52.18"></a><span id="l52.18"> document.addEventListener(&quot;dialogextra1&quot;, onAddHeader);</span>
<a href="#l52.19"></a><span id="l52.19"> document.addEventListener(&quot;dialogextra2&quot;, onRemoveHeader);</span>
<a href="#l52.20"></a><span id="l52.20"> </span>
<a href="#l52.21"></a><span id="l52.21" class="difflineminus">-function onLoad()</span>
<a href="#l52.22"></a><span id="l52.22" class="difflineminus">-{</span>
<a href="#l52.23"></a><span id="l52.23" class="difflineplus">+function onLoad() {</span>
<a href="#l52.24"></a><span id="l52.24">     let hdrs = Services.prefs.getCharPref(&quot;mailnews.customHeaders&quot;);</span>
<a href="#l52.25"></a><span id="l52.25">     gHeaderInputElement = document.getElementById(&quot;headerInput&quot;);</span>
<a href="#l52.26"></a><span id="l52.26">     gHeaderInputElement.focus();</span>
<a href="#l52.27"></a><span id="l52.27"> </span>
<a href="#l52.28"></a><span id="l52.28">     gHdrsList = document.getElementById(&quot;headerList&quot;);</span>
<a href="#l52.29"></a><span id="l52.29" class="difflineminus">-    gArrayHdrs = new Array();</span>
<a href="#l52.30"></a><span id="l52.30" class="difflineplus">+    gArrayHdrs = [];</span>
<a href="#l52.31"></a><span id="l52.31">     gAddButton = document.getElementById(&quot;addButton&quot;);</span>
<a href="#l52.32"></a><span id="l52.32">     gRemoveButton = document.getElementById(&quot;removeButton&quot;);</span>
<a href="#l52.33"></a><span id="l52.33"> </span>
<a href="#l52.34"></a><span id="l52.34">     initializeDialog(hdrs);</span>
<a href="#l52.35"></a><span id="l52.35">     updateAddButton(true);</span>
<a href="#l52.36"></a><span id="l52.36">     updateRemoveButton();</span>
<a href="#l52.37"></a><span id="l52.37"> }</span>
<a href="#l52.38"></a><span id="l52.38"> </span>
<a href="#l52.39"></a><span id="l52.39" class="difflineminus">-function initializeDialog(hdrs)</span>
<a href="#l52.40"></a><span id="l52.40" class="difflineminus">-{</span>
<a href="#l52.41"></a><span id="l52.41" class="difflineminus">-  if (hdrs)</span>
<a href="#l52.42"></a><span id="l52.42" class="difflineminus">-  {</span>
<a href="#l52.43"></a><span id="l52.43" class="difflineminus">-    hdrs = hdrs.replace(/\s+/g,'');  //remove white spaces before splitting</span>
<a href="#l52.44"></a><span id="l52.44" class="difflineplus">+function initializeDialog(hdrs) {</span>
<a href="#l52.45"></a><span id="l52.45" class="difflineplus">+  if (hdrs) {</span>
<a href="#l52.46"></a><span id="l52.46" class="difflineplus">+    hdrs = hdrs.replace(/\s+/g, &quot;&quot;);  // remove white spaces before splitting</span>
<a href="#l52.47"></a><span id="l52.47">     gArrayHdrs = hdrs.split(&quot;:&quot;);</span>
<a href="#l52.48"></a><span id="l52.48">     for (var i = 0; i &lt; gArrayHdrs.length; i++)</span>
<a href="#l52.49"></a><span id="l52.49">       if (!gArrayHdrs[i])</span>
<a href="#l52.50"></a><span id="l52.50" class="difflineminus">-        gArrayHdrs.splice(i,1);  //remove any null elements</span>
<a href="#l52.51"></a><span id="l52.51" class="difflineplus">+        gArrayHdrs.splice(i, 1);  // remove any null elements</span>
<a href="#l52.52"></a><span id="l52.52">     initializeRows();</span>
<a href="#l52.53"></a><span id="l52.53">   }</span>
<a href="#l52.54"></a><span id="l52.54"> }</span>
<a href="#l52.55"></a><span id="l52.55"> </span>
<a href="#l52.56"></a><span id="l52.56" class="difflineminus">-function initializeRows()</span>
<a href="#l52.57"></a><span id="l52.57" class="difflineminus">-{</span>
<a href="#l52.58"></a><span id="l52.58" class="difflineplus">+function initializeRows() {</span>
<a href="#l52.59"></a><span id="l52.59">   for (var i = 0; i &lt; gArrayHdrs.length; i++)</span>
<a href="#l52.60"></a><span id="l52.60">     addRow(TrimString(gArrayHdrs[i]));</span>
<a href="#l52.61"></a><span id="l52.61"> }</span>
<a href="#l52.62"></a><span id="l52.62"> </span>
<a href="#l52.63"></a><span id="l52.63" class="difflineminus">-function onTextInput()</span>
<a href="#l52.64"></a><span id="l52.64" class="difflineminus">-{</span>
<a href="#l52.65"></a><span id="l52.65" class="difflineplus">+function onTextInput() {</span>
<a href="#l52.66"></a><span id="l52.66">   // enable the add button if the user has started to type text</span>
<a href="#l52.67"></a><span id="l52.67" class="difflineminus">-  updateAddButton( (gHeaderInputElement.value == &quot;&quot;) );</span>
<a href="#l52.68"></a><span id="l52.68" class="difflineplus">+  updateAddButton((gHeaderInputElement.value == &quot;&quot;));</span>
<a href="#l52.69"></a><span id="l52.69"> }</span>
<a href="#l52.70"></a><span id="l52.70"> </span>
<a href="#l52.71"></a><span id="l52.71" class="difflineminus">-function onOk()</span>
<a href="#l52.72"></a><span id="l52.72" class="difflineminus">-{</span>
<a href="#l52.73"></a><span id="l52.73" class="difflineminus">-  if (gArrayHdrs.length)</span>
<a href="#l52.74"></a><span id="l52.74" class="difflineminus">-  {</span>
<a href="#l52.75"></a><span id="l52.75" class="difflineplus">+function onOk() {</span>
<a href="#l52.76"></a><span id="l52.76" class="difflineplus">+  if (gArrayHdrs.length) {</span>
<a href="#l52.77"></a><span id="l52.77">     var hdrs;</span>
<a href="#l52.78"></a><span id="l52.78">     if (gArrayHdrs.length == 1)</span>
<a href="#l52.79"></a><span id="l52.79">       hdrs = gArrayHdrs;</span>
<a href="#l52.80"></a><span id="l52.80">     else</span>
<a href="#l52.81"></a><span id="l52.81">       hdrs = gArrayHdrs.join(&quot;: &quot;);</span>
<a href="#l52.82"></a><span id="l52.82">     Services.prefs.setCharPref(&quot;mailnews.customHeaders&quot;, hdrs);</span>
<a href="#l52.83"></a><span id="l52.83">     // flush prefs to disk, in case we crash, to avoid dataloss and problems with filters that use the custom headers</span>
<a href="#l52.84"></a><span id="l52.84">     Services.prefs.savePrefFile(null);</span>
<a href="#l52.85"></a><span id="l52.85" class="difflineminus">-  }</span>
<a href="#l52.86"></a><span id="l52.86" class="difflineminus">-  else</span>
<a href="#l52.87"></a><span id="l52.87" class="difflineminus">-  {</span>
<a href="#l52.88"></a><span id="l52.88" class="difflineminus">-    Services.prefs.clearUserPref(&quot;mailnews.customHeaders&quot;); //clear the pref, no custom headers</span>
<a href="#l52.89"></a><span id="l52.89" class="difflineplus">+  } else {</span>
<a href="#l52.90"></a><span id="l52.90" class="difflineplus">+    Services.prefs.clearUserPref(&quot;mailnews.customHeaders&quot;); // clear the pref, no custom headers</span>
<a href="#l52.91"></a><span id="l52.91">   }</span>
<a href="#l52.92"></a><span id="l52.92"> </span>
<a href="#l52.93"></a><span id="l52.93">   window.arguments[0].selectedVal = gHdrsList.selectedItem ? gHdrsList.selectedItem.label : null;</span>
<a href="#l52.94"></a><span id="l52.94"> }</span>
<a href="#l52.95"></a><span id="l52.95"> </span>
<a href="#l52.96"></a><span id="l52.96" class="difflineminus">-function customHeaderOverflow()</span>
<a href="#l52.97"></a><span id="l52.97" class="difflineminus">-{</span>
<a href="#l52.98"></a><span id="l52.98" class="difflineplus">+function customHeaderOverflow() {</span>
<a href="#l52.99"></a><span id="l52.99">   var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l52.100"></a><span id="l52.100" class="difflineminus">-  if (gArrayHdrs.length &gt;= (nsMsgSearchAttrib.kNumMsgSearchAttributes - nsMsgSearchAttrib.OtherHeader - 1))</span>
<a href="#l52.101"></a><span id="l52.101" class="difflineminus">-  {</span>
<a href="#l52.102"></a><span id="l52.102" class="difflineplus">+  if (gArrayHdrs.length &gt;= (nsMsgSearchAttrib.kNumMsgSearchAttributes - nsMsgSearchAttrib.OtherHeader - 1)) {</span>
<a href="#l52.103"></a><span id="l52.103">     if (!gFilterBundle)</span>
<a href="#l52.104"></a><span id="l52.104">       gFilterBundle = document.getElementById(&quot;bundle_filter&quot;);</span>
<a href="#l52.105"></a><span id="l52.105"> </span>
<a href="#l52.106"></a><span id="l52.106">     var alertText = gFilterBundle.getString(&quot;customHeaderOverflow&quot;);</span>
<a href="#l52.107"></a><span id="l52.107">     Services.prompt.alert(window, null, alertText);</span>
<a href="#l52.108"></a><span id="l52.108">     return true;</span>
<a href="#l52.109"></a><span id="l52.109">   }</span>
<a href="#l52.110"></a><span id="l52.110">   return false;</span>
<a href="#l52.111"></a><span id="l52.111"> }</span>
<a href="#l52.112"></a><span id="l52.112"> </span>
<a href="#l52.113"></a><span id="l52.113" class="difflineminus">-function onAddHeader()</span>
<a href="#l52.114"></a><span id="l52.114" class="difflineminus">-{</span>
<a href="#l52.115"></a><span id="l52.115" class="difflineplus">+function onAddHeader() {</span>
<a href="#l52.116"></a><span id="l52.116">   var newHdr = TrimString(gHeaderInputElement.value);</span>
<a href="#l52.117"></a><span id="l52.117"> </span>
<a href="#l52.118"></a><span id="l52.118" class="difflineminus">-  if (!isRFC2822Header(newHdr))  // if user entered an invalid rfc822 header field name, bail out.</span>
<a href="#l52.119"></a><span id="l52.119" class="difflineminus">-  {</span>
<a href="#l52.120"></a><span id="l52.120" class="difflineplus">+  if (!isRFC2822Header(newHdr)) { // if user entered an invalid rfc822 header field name, bail out.</span>
<a href="#l52.121"></a><span id="l52.121">     if (!gCustomBundle)</span>
<a href="#l52.122"></a><span id="l52.122">       gCustomBundle = document.getElementById(&quot;bundle_custom&quot;);</span>
<a href="#l52.123"></a><span id="l52.123"> </span>
<a href="#l52.124"></a><span id="l52.124">     var alertText = gCustomBundle.getString(&quot;colonInHeaderName&quot;);</span>
<a href="#l52.125"></a><span id="l52.125">     Services.prompt.alert(window, null, alertText);</span>
<a href="#l52.126"></a><span id="l52.126">     return;</span>
<a href="#l52.127"></a><span id="l52.127">   }</span>
<a href="#l52.128"></a><span id="l52.128"> </span>
<a href="#l52.129"></a><span id="l52.129">   gHeaderInputElement.value = &quot;&quot;;</span>
<a href="#l52.130"></a><span id="l52.130">   if (!newHdr || customHeaderOverflow())</span>
<a href="#l52.131"></a><span id="l52.131">     return;</span>
<a href="#l52.132"></a><span id="l52.132" class="difflineminus">-  if (!duplicateHdrExists(newHdr))</span>
<a href="#l52.133"></a><span id="l52.133" class="difflineminus">-  {</span>
<a href="#l52.134"></a><span id="l52.134" class="difflineplus">+  if (!duplicateHdrExists(newHdr)) {</span>
<a href="#l52.135"></a><span id="l52.135">     gArrayHdrs[gArrayHdrs.length] = newHdr;</span>
<a href="#l52.136"></a><span id="l52.136">     var newItem = addRow(newHdr);</span>
<a href="#l52.137"></a><span id="l52.137" class="difflineminus">-    gHdrsList.selectItem (newItem); // make sure the new entry is selected in the tree</span>
<a href="#l52.138"></a><span id="l52.138" class="difflineplus">+    gHdrsList.selectItem(newItem); // make sure the new entry is selected in the tree</span>
<a href="#l52.139"></a><span id="l52.139">     // now disable the add button</span>
<a href="#l52.140"></a><span id="l52.140">     updateAddButton(true);</span>
<a href="#l52.141"></a><span id="l52.141">     gHeaderInputElement.focus(); // refocus the input field for the next custom header</span>
<a href="#l52.142"></a><span id="l52.142">   }</span>
<a href="#l52.143"></a><span id="l52.143"> }</span>
<a href="#l52.144"></a><span id="l52.144"> </span>
<a href="#l52.145"></a><span id="l52.145" class="difflineminus">-function isRFC2822Header(hdr)</span>
<a href="#l52.146"></a><span id="l52.146" class="difflineminus">-{</span>
<a href="#l52.147"></a><span id="l52.147" class="difflineplus">+function isRFC2822Header(hdr) {</span>
<a href="#l52.148"></a><span id="l52.148">   var charCode;</span>
<a href="#l52.149"></a><span id="l52.149" class="difflineminus">-  for (var i = 0; i &lt; hdr.length; i++)</span>
<a href="#l52.150"></a><span id="l52.150" class="difflineminus">-  {</span>
<a href="#l52.151"></a><span id="l52.151" class="difflineplus">+  for (var i = 0; i &lt; hdr.length; i++) {</span>
<a href="#l52.152"></a><span id="l52.152">     charCode = hdr.charCodeAt(i);</span>
<a href="#l52.153"></a><span id="l52.153" class="difflineminus">-    //58 is for colon and 33 and 126 are us-ascii bounds that should be used for header field name, as per rfc2822</span>
<a href="#l52.154"></a><span id="l52.154" class="difflineplus">+    // 58 is for colon and 33 and 126 are us-ascii bounds that should be used for header field name, as per rfc2822</span>
<a href="#l52.155"></a><span id="l52.155"> </span>
<a href="#l52.156"></a><span id="l52.156">     if (charCode &lt; 33 || charCode == 58 || charCode &gt; 126)</span>
<a href="#l52.157"></a><span id="l52.157">       return false;</span>
<a href="#l52.158"></a><span id="l52.158">   }</span>
<a href="#l52.159"></a><span id="l52.159">   return true;</span>
<a href="#l52.160"></a><span id="l52.160"> }</span>
<a href="#l52.161"></a><span id="l52.161"> </span>
<a href="#l52.162"></a><span id="l52.162" class="difflineminus">-function duplicateHdrExists(hdr)</span>
<a href="#l52.163"></a><span id="l52.163" class="difflineminus">-{</span>
<a href="#l52.164"></a><span id="l52.164" class="difflineminus">-  for (var i = 0;i &lt; gArrayHdrs.length; i++)</span>
<a href="#l52.165"></a><span id="l52.165" class="difflineminus">-  {</span>
<a href="#l52.166"></a><span id="l52.166" class="difflineplus">+function duplicateHdrExists(hdr) {</span>
<a href="#l52.167"></a><span id="l52.167" class="difflineplus">+  for (var i = 0; i &lt; gArrayHdrs.length; i++) {</span>
<a href="#l52.168"></a><span id="l52.168">     if (gArrayHdrs[i] == hdr)</span>
<a href="#l52.169"></a><span id="l52.169">       return true;</span>
<a href="#l52.170"></a><span id="l52.170">   }</span>
<a href="#l52.171"></a><span id="l52.171">   return false;</span>
<a href="#l52.172"></a><span id="l52.172"> }</span>
<a href="#l52.173"></a><span id="l52.173"> </span>
<a href="#l52.174"></a><span id="l52.174" class="difflineminus">-function onRemoveHeader()</span>
<a href="#l52.175"></a><span id="l52.175" class="difflineminus">-{</span>
<a href="#l52.176"></a><span id="l52.176" class="difflineminus">-  var listitem = gHdrsList.selectedItems[0]</span>
<a href="#l52.177"></a><span id="l52.177" class="difflineplus">+function onRemoveHeader() {</span>
<a href="#l52.178"></a><span id="l52.178" class="difflineplus">+  var listitem = gHdrsList.selectedItems[0];</span>
<a href="#l52.179"></a><span id="l52.179">   if (!listitem) return;</span>
<a href="#l52.180"></a><span id="l52.180">   listitem.remove();</span>
<a href="#l52.181"></a><span id="l52.181">   var selectedHdr = GetListItemAttributeStr(listitem);</span>
<a href="#l52.182"></a><span id="l52.182" class="difflineminus">-  var j=0;</span>
<a href="#l52.183"></a><span id="l52.183" class="difflineminus">-  for (var i = 0; i &lt; gArrayHdrs.length; i++)</span>
<a href="#l52.184"></a><span id="l52.184" class="difflineminus">-  {</span>
<a href="#l52.185"></a><span id="l52.185" class="difflineminus">-    if (gArrayHdrs[i] == selectedHdr)</span>
<a href="#l52.186"></a><span id="l52.186" class="difflineminus">-    {</span>
<a href="#l52.187"></a><span id="l52.187" class="difflineminus">-      gArrayHdrs.splice(i,1);</span>
<a href="#l52.188"></a><span id="l52.188" class="difflineplus">+  for (let i = 0; i &lt; gArrayHdrs.length; i++) {</span>
<a href="#l52.189"></a><span id="l52.189" class="difflineplus">+    if (gArrayHdrs[i] == selectedHdr) {</span>
<a href="#l52.190"></a><span id="l52.190" class="difflineplus">+      gArrayHdrs.splice(i, 1);</span>
<a href="#l52.191"></a><span id="l52.191">       break;</span>
<a href="#l52.192"></a><span id="l52.192">     }</span>
<a href="#l52.193"></a><span id="l52.193">   }</span>
<a href="#l52.194"></a><span id="l52.194"> }</span>
<a href="#l52.195"></a><span id="l52.195"> </span>
<a href="#l52.196"></a><span id="l52.196" class="difflineminus">-function GetListItemAttributeStr(listitem)</span>
<a href="#l52.197"></a><span id="l52.197" class="difflineminus">-{</span>
<a href="#l52.198"></a><span id="l52.198" class="difflineplus">+function GetListItemAttributeStr(listitem) {</span>
<a href="#l52.199"></a><span id="l52.199">    if (listitem)</span>
<a href="#l52.200"></a><span id="l52.200">      return TrimString(listitem.getAttribute(&quot;label&quot;));</span>
<a href="#l52.201"></a><span id="l52.201"> </span>
<a href="#l52.202"></a><span id="l52.202">    return &quot;&quot;;</span>
<a href="#l52.203"></a><span id="l52.203"> }</span>
<a href="#l52.204"></a><span id="l52.204"> </span>
<a href="#l52.205"></a><span id="l52.205" class="difflineminus">-function addRow(newHdr)</span>
<a href="#l52.206"></a><span id="l52.206" class="difflineminus">-{</span>
<a href="#l52.207"></a><span id="l52.207" class="difflineplus">+function addRow(newHdr) {</span>
<a href="#l52.208"></a><span id="l52.208">   return gHdrsList.appendItem(newHdr, &quot;&quot;);</span>
<a href="#l52.209"></a><span id="l52.209"> }</span>
<a href="#l52.210"></a><span id="l52.210"> </span>
<a href="#l52.211"></a><span id="l52.211" class="difflineminus">-function updateAddButton(aDisable)</span>
<a href="#l52.212"></a><span id="l52.212" class="difflineminus">-{</span>
<a href="#l52.213"></a><span id="l52.213" class="difflineplus">+function updateAddButton(aDisable) {</span>
<a href="#l52.214"></a><span id="l52.214">   // only update the button if the disabled state changed</span>
<a href="#l52.215"></a><span id="l52.215">   if (aDisable == gAddButton.disabled)</span>
<a href="#l52.216"></a><span id="l52.216">     return;</span>
<a href="#l52.217"></a><span id="l52.217"> </span>
<a href="#l52.218"></a><span id="l52.218">   gAddButton.disabled = aDisable;</span>
<a href="#l52.219"></a><span id="l52.219">   document.documentElement.defaultButton = aDisable ? &quot;accept&quot; : &quot;extra1&quot;;</span>
<a href="#l52.220"></a><span id="l52.220"> }</span>
<a href="#l52.221"></a><span id="l52.221"> </span>
<a href="#l52.222"></a><span id="l52.222" class="difflineminus">-function updateRemoveButton()</span>
<a href="#l52.223"></a><span id="l52.223" class="difflineminus">-{</span>
<a href="#l52.224"></a><span id="l52.224" class="difflineplus">+function updateRemoveButton() {</span>
<a href="#l52.225"></a><span id="l52.225">   var headerSelected = (gHdrsList.selectedItems.length &gt; 0);</span>
<a href="#l52.226"></a><span id="l52.226">   gRemoveButton.disabled = !headerSelected;</span>
<a href="#l52.227"></a><span id="l52.227">   if (gRemoveButton.disabled)</span>
<a href="#l52.228"></a><span id="l52.228">     gHeaderInputElement.focus();</span>
<a href="#l52.229"></a><span id="l52.229"> }</span>
<a href="#l52.230"></a><span id="l52.230"> </span>
<a href="#l52.231"></a><span id="l52.231" class="difflineminus">-//Remove whitespace from both ends of a string</span>
<a href="#l52.232"></a><span id="l52.232" class="difflineminus">-function TrimString(string)</span>
<a href="#l52.233"></a><span id="l52.233" class="difflineminus">-{</span>
<a href="#l52.234"></a><span id="l52.234" class="difflineplus">+// Remove whitespace from both ends of a string</span>
<a href="#l52.235"></a><span id="l52.235" class="difflineplus">+function TrimString(string) {</span>
<a href="#l52.236"></a><span id="l52.236">   if (!string) return &quot;&quot;;</span>
<a href="#l52.237"></a><span id="l52.237">   return string.trim();</span>
<a href="#l52.238"></a><span id="l52.238"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mailnews/base/search/content/FilterEditor.js</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mailnews/base/search/content/FilterEditor.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -1,28 +1,29 @@</span>
<a href="#l53.4"></a><span id="l53.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l53.5"></a><span id="l53.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l53.6"></a><span id="l53.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l53.7"></a><span id="l53.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l53.8"></a><span id="l53.8"> </span>
<a href="#l53.9"></a><span id="l53.9" class="difflineplus">+/* import-globals-from searchTerm.js */</span>
<a href="#l53.10"></a><span id="l53.10" class="difflineplus">+</span>
<a href="#l53.11"></a><span id="l53.11"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l53.12"></a><span id="l53.12"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l53.13"></a><span id="l53.13"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l53.14"></a><span id="l53.14"> </span>
<a href="#l53.15"></a><span id="l53.15"> // The actual filter that we're editing if it is a _saved_ filter or prefill;</span>
<a href="#l53.16"></a><span id="l53.16"> // void otherwise.</span>
<a href="#l53.17"></a><span id="l53.17"> var gFilter;</span>
<a href="#l53.18"></a><span id="l53.18"> // cache the key elements we need</span>
<a href="#l53.19"></a><span id="l53.19"> var gFilterList;</span>
<a href="#l53.20"></a><span id="l53.20"> // The filter name as it appears in the &quot;Filter Name&quot; field of dialog.</span>
<a href="#l53.21"></a><span id="l53.21"> var gFilterNameElement;</span>
<a href="#l53.22"></a><span id="l53.22"> var gFilterTypeSelector;</span>
<a href="#l53.23"></a><span id="l53.23"> var gFilterBundle;</span>
<a href="#l53.24"></a><span id="l53.24"> var gPreFillName;</span>
<a href="#l53.25"></a><span id="l53.25" class="difflineminus">-var gSessionFolderListenerAdded = false;</span>
<a href="#l53.26"></a><span id="l53.26"> var gFilterActionList;</span>
<a href="#l53.27"></a><span id="l53.27"> var gCustomActions = null;</span>
<a href="#l53.28"></a><span id="l53.28"> var gFilterType;</span>
<a href="#l53.29"></a><span id="l53.29"> var gFilterPosition = 0;</span>
<a href="#l53.30"></a><span id="l53.30"> </span>
<a href="#l53.31"></a><span id="l53.31"> var gFilterActionStrings = [&quot;none&quot;, &quot;movemessage&quot;, &quot;setpriorityto&quot;, &quot;deletemessage&quot;,</span>
<a href="#l53.32"></a><span id="l53.32">                             &quot;markasread&quot;, &quot;ignorethread&quot;, &quot;watchthread&quot;, &quot;markasflagged&quot;,</span>
<a href="#l53.33"></a><span id="l53.33">                             &quot;label&quot;, &quot;replytomessage&quot;, &quot;forwardmessage&quot;, &quot;stopexecution&quot;,</span>
<a href="#l53.34"></a><span id="l53.34" class="difflineat">@@ -39,56 +40,48 @@ var gFilterEditorMsgWindow = null;</span>
<a href="#l53.35"></a><span id="l53.35"> </span>
<a href="#l53.36"></a><span id="l53.36"> var nsMsgFilterAction = Ci.nsMsgFilterAction;</span>
<a href="#l53.37"></a><span id="l53.37"> var nsMsgFilterType   = Ci.nsMsgFilterType;</span>
<a href="#l53.38"></a><span id="l53.38"> var nsIMsgRuleAction  = Ci.nsIMsgRuleAction;</span>
<a href="#l53.39"></a><span id="l53.39"> var nsMsgSearchScope  = Ci.nsMsgSearchScope;</span>
<a href="#l53.40"></a><span id="l53.40"> </span>
<a href="#l53.41"></a><span id="l53.41"> document.addEventListener(&quot;dialogaccept&quot;, onAccept);</span>
<a href="#l53.42"></a><span id="l53.42"> </span>
<a href="#l53.43"></a><span id="l53.43" class="difflineminus">-function filterEditorOnLoad()</span>
<a href="#l53.44"></a><span id="l53.44" class="difflineminus">-{</span>
<a href="#l53.45"></a><span id="l53.45" class="difflineplus">+function filterEditorOnLoad() {</span>
<a href="#l53.46"></a><span id="l53.46">   getCustomActions();</span>
<a href="#l53.47"></a><span id="l53.47">   initializeSearchWidgets();</span>
<a href="#l53.48"></a><span id="l53.48">   initializeFilterWidgets();</span>
<a href="#l53.49"></a><span id="l53.49"> </span>
<a href="#l53.50"></a><span id="l53.50">   gFilterBundle = document.getElementById(&quot;bundle_filter&quot;);</span>
<a href="#l53.51"></a><span id="l53.51"> </span>
<a href="#l53.52"></a><span id="l53.52" class="difflineminus">-  if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0])</span>
<a href="#l53.53"></a><span id="l53.53" class="difflineminus">-  {</span>
<a href="#l53.54"></a><span id="l53.54" class="difflineplus">+  if (&quot;arguments&quot; in window &amp;&amp; window.arguments[0]) {</span>
<a href="#l53.55"></a><span id="l53.55">     var args = window.arguments[0];</span>
<a href="#l53.56"></a><span id="l53.56"> </span>
<a href="#l53.57"></a><span id="l53.57" class="difflineminus">-    if (&quot;filterList&quot; in args)</span>
<a href="#l53.58"></a><span id="l53.58" class="difflineminus">-    {</span>
<a href="#l53.59"></a><span id="l53.59" class="difflineplus">+    if (&quot;filterList&quot; in args) {</span>
<a href="#l53.60"></a><span id="l53.60">       gFilterList = args.filterList;</span>
<a href="#l53.61"></a><span id="l53.61">       // the postPlugin filters cannot be applied to servers that are</span>
<a href="#l53.62"></a><span id="l53.62">       // deferred, (you must define them on the deferredTo server instead).</span>
<a href="#l53.63"></a><span id="l53.63">       let server = gFilterList.folder.server;</span>
<a href="#l53.64"></a><span id="l53.64">       if (server.rootFolder != server.rootMsgFolder)</span>
<a href="#l53.65"></a><span id="l53.65">         gFilterTypeSelector.disableDeferredAccount();</span>
<a href="#l53.66"></a><span id="l53.66">     }</span>
<a href="#l53.67"></a><span id="l53.67"> </span>
<a href="#l53.68"></a><span id="l53.68" class="difflineminus">-    if (&quot;filterPosition&quot; in args)</span>
<a href="#l53.69"></a><span id="l53.69" class="difflineminus">-    {</span>
<a href="#l53.70"></a><span id="l53.70" class="difflineplus">+    if (&quot;filterPosition&quot; in args) {</span>
<a href="#l53.71"></a><span id="l53.71">       gFilterPosition = args.filterPosition;</span>
<a href="#l53.72"></a><span id="l53.72">     }</span>
<a href="#l53.73"></a><span id="l53.73"> </span>
<a href="#l53.74"></a><span id="l53.74" class="difflineminus">-    if (&quot;filter&quot; in args)</span>
<a href="#l53.75"></a><span id="l53.75" class="difflineminus">-    {</span>
<a href="#l53.76"></a><span id="l53.76" class="difflineplus">+    if (&quot;filter&quot; in args) {</span>
<a href="#l53.77"></a><span id="l53.77">       // editing a filter</span>
<a href="#l53.78"></a><span id="l53.78">       gFilter = window.arguments[0].filter;</span>
<a href="#l53.79"></a><span id="l53.79">       initializeDialog(gFilter);</span>
<a href="#l53.80"></a><span id="l53.80" class="difflineminus">-    }</span>
<a href="#l53.81"></a><span id="l53.81" class="difflineminus">-    else</span>
<a href="#l53.82"></a><span id="l53.82" class="difflineminus">-    {</span>
<a href="#l53.83"></a><span id="l53.83" class="difflineplus">+    } else {</span>
<a href="#l53.84"></a><span id="l53.84">       if (gFilterList)</span>
<a href="#l53.85"></a><span id="l53.85">           setSearchScope(getScopeFromFilterList(gFilterList));</span>
<a href="#l53.86"></a><span id="l53.86">       // if doing prefill filter create a new filter and populate it.</span>
<a href="#l53.87"></a><span id="l53.87" class="difflineminus">-      if (&quot;filterName&quot; in args)</span>
<a href="#l53.88"></a><span id="l53.88" class="difflineminus">-      {</span>
<a href="#l53.89"></a><span id="l53.89" class="difflineplus">+      if (&quot;filterName&quot; in args) {</span>
<a href="#l53.90"></a><span id="l53.90">         gPreFillName = args.filterName;</span>
<a href="#l53.91"></a><span id="l53.91"> </span>
<a href="#l53.92"></a><span id="l53.92">         // Passing null as the parameter to createFilter to keep the name empty</span>
<a href="#l53.93"></a><span id="l53.93">         // until later where we assign the name.</span>
<a href="#l53.94"></a><span id="l53.94">         gFilter = gFilterList.createFilter(null);</span>
<a href="#l53.95"></a><span id="l53.95"> </span>
<a href="#l53.96"></a><span id="l53.96">         var term = gFilter.createTerm();</span>
<a href="#l53.97"></a><span id="l53.97"> </span>
<a href="#l53.98"></a><span id="l53.98" class="difflineat">@@ -117,35 +110,31 @@ function filterEditorOnLoad()</span>
<a href="#l53.99"></a><span id="l53.99">         // the default action for news filters is Delete</span>
<a href="#l53.100"></a><span id="l53.100">         // for everything else, it's MoveToFolder</span>
<a href="#l53.101"></a><span id="l53.101">         var filterAction = gFilter.createAction();</span>
<a href="#l53.102"></a><span id="l53.102">         filterAction.type = (getScopeFromFilterList(gFilterList) ==</span>
<a href="#l53.103"></a><span id="l53.103">             nsMsgSearchScope.newsFilter) ?</span>
<a href="#l53.104"></a><span id="l53.104">             nsMsgFilterAction.Delete : nsMsgFilterAction.MoveToFolder;</span>
<a href="#l53.105"></a><span id="l53.105">         gFilter.appendAction(filterAction);</span>
<a href="#l53.106"></a><span id="l53.106">         initializeDialog(gFilter);</span>
<a href="#l53.107"></a><span id="l53.107" class="difflineminus">-      }</span>
<a href="#l53.108"></a><span id="l53.108" class="difflineminus">-      else if (&quot;copiedFilter&quot; in args)</span>
<a href="#l53.109"></a><span id="l53.109" class="difflineminus">-      {</span>
<a href="#l53.110"></a><span id="l53.110" class="difflineplus">+      } else if (&quot;copiedFilter&quot; in args) {</span>
<a href="#l53.111"></a><span id="l53.111">         // we are copying a filter</span>
<a href="#l53.112"></a><span id="l53.112">         let copiedFilter = args.copiedFilter;</span>
<a href="#l53.113"></a><span id="l53.113">         let copiedName = gFilterBundle.getFormattedString(&quot;copyToNewFilterName&quot;,</span>
<a href="#l53.114"></a><span id="l53.114">           [copiedFilter.filterName]);</span>
<a href="#l53.115"></a><span id="l53.115">         let newFilter = gFilterList.createFilter(copiedName);</span>
<a href="#l53.116"></a><span id="l53.116"> </span>
<a href="#l53.117"></a><span id="l53.117">         // copy the actions</span>
<a href="#l53.118"></a><span id="l53.118" class="difflineminus">-        for (let i = 0; i &lt; copiedFilter.actionCount; i++)</span>
<a href="#l53.119"></a><span id="l53.119" class="difflineminus">-        {</span>
<a href="#l53.120"></a><span id="l53.120" class="difflineplus">+        for (let i = 0; i &lt; copiedFilter.actionCount; i++) {</span>
<a href="#l53.121"></a><span id="l53.121">           let filterAction = copiedFilter.getActionAt(i);</span>
<a href="#l53.122"></a><span id="l53.122">           newFilter.appendAction(filterAction);</span>
<a href="#l53.123"></a><span id="l53.123">         }</span>
<a href="#l53.124"></a><span id="l53.124"> </span>
<a href="#l53.125"></a><span id="l53.125">         // copy the search terms</span>
<a href="#l53.126"></a><span id="l53.126" class="difflineminus">-        for (let i = 0; i &lt; copiedFilter.searchTerms.length; i++)</span>
<a href="#l53.127"></a><span id="l53.127" class="difflineminus">-        {</span>
<a href="#l53.128"></a><span id="l53.128" class="difflineplus">+        for (let i = 0; i &lt; copiedFilter.searchTerms.length; i++) {</span>
<a href="#l53.129"></a><span id="l53.129">           let searchTerm = copiedFilter.searchTerms.queryElementAt(i,</span>
<a href="#l53.130"></a><span id="l53.130">             Ci.nsIMsgSearchTerm);</span>
<a href="#l53.131"></a><span id="l53.131"> </span>
<a href="#l53.132"></a><span id="l53.132">           let newTerm = newFilter.createTerm();</span>
<a href="#l53.133"></a><span id="l53.133">           newTerm.attrib = searchTerm.attrib;</span>
<a href="#l53.134"></a><span id="l53.134">           newTerm.op = searchTerm.op;</span>
<a href="#l53.135"></a><span id="l53.135">           newTerm.booleanAnd = searchTerm.booleanAnd;</span>
<a href="#l53.136"></a><span id="l53.136">           newTerm.value = searchTerm.value;</span>
<a href="#l53.137"></a><span id="l53.137" class="difflineat">@@ -158,59 +147,48 @@ function filterEditorOnLoad()</span>
<a href="#l53.138"></a><span id="l53.138">         gFilter = newFilter;</span>
<a href="#l53.139"></a><span id="l53.139"> </span>
<a href="#l53.140"></a><span id="l53.140">         initializeDialog(gFilter);</span>
<a href="#l53.141"></a><span id="l53.141"> </span>
<a href="#l53.142"></a><span id="l53.142">         // We reset the filter name, because otherwise the saveFilter()</span>
<a href="#l53.143"></a><span id="l53.143">         // function thinks we are editing a filter, and will thus skip the name</span>
<a href="#l53.144"></a><span id="l53.144">         // uniqueness check.</span>
<a href="#l53.145"></a><span id="l53.145">         gFilter.filterName = &quot;&quot;;</span>
<a href="#l53.146"></a><span id="l53.146" class="difflineminus">-      }</span>
<a href="#l53.147"></a><span id="l53.147" class="difflineminus">-      else</span>
<a href="#l53.148"></a><span id="l53.148" class="difflineminus">-      {</span>
<a href="#l53.149"></a><span id="l53.149" class="difflineplus">+      } else {</span>
<a href="#l53.150"></a><span id="l53.150">         // fake the first more button press</span>
<a href="#l53.151"></a><span id="l53.151">         onMore(null);</span>
<a href="#l53.152"></a><span id="l53.152">       }</span>
<a href="#l53.153"></a><span id="l53.153">     }</span>
<a href="#l53.154"></a><span id="l53.154">   }</span>
<a href="#l53.155"></a><span id="l53.155"> </span>
<a href="#l53.156"></a><span id="l53.156" class="difflineminus">-  if (!gFilter)</span>
<a href="#l53.157"></a><span id="l53.157" class="difflineminus">-  {</span>
<a href="#l53.158"></a><span id="l53.158" class="difflineplus">+  if (!gFilter) {</span>
<a href="#l53.159"></a><span id="l53.159">     // This is a new filter. Set to both Incoming and Manual contexts.</span>
<a href="#l53.160"></a><span id="l53.160">     gFilterTypeSelector.setType(nsMsgFilterType.Incoming | nsMsgFilterType.Manual);</span>
<a href="#l53.161"></a><span id="l53.161">   }</span>
<a href="#l53.162"></a><span id="l53.162"> </span>
<a href="#l53.163"></a><span id="l53.163">   // in the case of a new filter, we may not have an action row yet.</span>
<a href="#l53.164"></a><span id="l53.164">   ensureActionRow();</span>
<a href="#l53.165"></a><span id="l53.165">   gFilterType = gFilterTypeSelector.getType();</span>
<a href="#l53.166"></a><span id="l53.166"> </span>
<a href="#l53.167"></a><span id="l53.167">   gFilterNameElement.select();</span>
<a href="#l53.168"></a><span id="l53.168">   // This call is required on mac and linux.  It has no effect under win32.  See bug 94800.</span>
<a href="#l53.169"></a><span id="l53.169">   gFilterNameElement.focus();</span>
<a href="#l53.170"></a><span id="l53.170"> }</span>
<a href="#l53.171"></a><span id="l53.171"> </span>
<a href="#l53.172"></a><span id="l53.172" class="difflineminus">-function filterEditorOnUnload()</span>
<a href="#l53.173"></a><span id="l53.173" class="difflineminus">-{</span>
<a href="#l53.174"></a><span id="l53.174" class="difflineminus">-  if (gSessionFolderListenerAdded)</span>
<a href="#l53.175"></a><span id="l53.175" class="difflineminus">-    MailServices.mailSession.RemoveFolderListener(gFolderListener);</span>
<a href="#l53.176"></a><span id="l53.176" class="difflineminus">-}</span>
<a href="#l53.177"></a><span id="l53.177" class="difflineminus">-</span>
<a href="#l53.178"></a><span id="l53.178" class="difflineminus">-function onEnterInSearchTerm(event)</span>
<a href="#l53.179"></a><span id="l53.179" class="difflineminus">-{</span>
<a href="#l53.180"></a><span id="l53.180" class="difflineplus">+function onEnterInSearchTerm(event) {</span>
<a href="#l53.181"></a><span id="l53.181">   if (event.ctrlKey || (Services.appinfo.OS == &quot;Darwin&quot; &amp;&amp; event.metaKey)) {</span>
<a href="#l53.182"></a><span id="l53.182">     // If accel key (Ctrl on Win/Linux, Cmd on Mac) was held too, accept the dialog.</span>
<a href="#l53.183"></a><span id="l53.183">     document.getElementById(&quot;FilterEditor&quot;).acceptDialog();</span>
<a href="#l53.184"></a><span id="l53.184">   } else {</span>
<a href="#l53.185"></a><span id="l53.185">     // If only plain Enter was pressed, add a new rule line.</span>
<a href="#l53.186"></a><span id="l53.186">     onMore(event);</span>
<a href="#l53.187"></a><span id="l53.187">   }</span>
<a href="#l53.188"></a><span id="l53.188"> }</span>
<a href="#l53.189"></a><span id="l53.189"> </span>
<a href="#l53.190"></a><span id="l53.190" class="difflineminus">-function onAccept(event)</span>
<a href="#l53.191"></a><span id="l53.191" class="difflineminus">-{</span>
<a href="#l53.192"></a><span id="l53.192" class="difflineplus">+function onAccept(event) {</span>
<a href="#l53.193"></a><span id="l53.193">   try {</span>
<a href="#l53.194"></a><span id="l53.194">     if (!saveFilter()) {</span>
<a href="#l53.195"></a><span id="l53.195">       event.preventDefault();</span>
<a href="#l53.196"></a><span id="l53.196">       return;</span>
<a href="#l53.197"></a><span id="l53.197">     }</span>
<a href="#l53.198"></a><span id="l53.198">   } catch (e) {</span>
<a href="#l53.199"></a><span id="l53.199">     Cu.reportError(e);</span>
<a href="#l53.200"></a><span id="l53.200">     event.preventDefault();</span>
<a href="#l53.201"></a><span id="l53.201" class="difflineat">@@ -219,113 +197,76 @@ function onAccept(event)</span>
<a href="#l53.202"></a><span id="l53.202"> </span>
<a href="#l53.203"></a><span id="l53.203">   // parent should refresh filter list..</span>
<a href="#l53.204"></a><span id="l53.204">   // this should REALLY only happen when some criteria changes that</span>
<a href="#l53.205"></a><span id="l53.205">   // are displayed in the filter dialog, like the filter name</span>
<a href="#l53.206"></a><span id="l53.206">   window.arguments[0].refresh = true;</span>
<a href="#l53.207"></a><span id="l53.207">   window.arguments[0].newFilter = gFilter;</span>
<a href="#l53.208"></a><span id="l53.208"> }</span>
<a href="#l53.209"></a><span id="l53.209"> </span>
<a href="#l53.210"></a><span id="l53.210" class="difflineminus">-// the folderListener object</span>
<a href="#l53.211"></a><span id="l53.211" class="difflineminus">-var gFolderListener = {</span>
<a href="#l53.212"></a><span id="l53.212" class="difflineminus">-  OnItemAdded: function(parentItem, item) {},</span>
<a href="#l53.213"></a><span id="l53.213" class="difflineminus">-</span>
<a href="#l53.214"></a><span id="l53.214" class="difflineminus">-  OnItemRemoved: function(parentItem, item){},</span>
<a href="#l53.215"></a><span id="l53.215" class="difflineminus">-</span>
<a href="#l53.216"></a><span id="l53.216" class="difflineminus">-  OnItemPropertyChanged: function(item, property, oldValue, newValue) {},</span>
<a href="#l53.217"></a><span id="l53.217" class="difflineminus">-</span>
<a href="#l53.218"></a><span id="l53.218" class="difflineminus">-  OnItemIntPropertyChanged: function(item, property, oldValue, newValue) {},</span>
<a href="#l53.219"></a><span id="l53.219" class="difflineminus">-</span>
<a href="#l53.220"></a><span id="l53.220" class="difflineminus">-  OnItemBoolPropertyChanged: function(item, property, oldValue, newValue) {},</span>
<a href="#l53.221"></a><span id="l53.221" class="difflineminus">-</span>
<a href="#l53.222"></a><span id="l53.222" class="difflineminus">-  OnItemUnicharPropertyChanged: function(item, property, oldValue, newValue){},</span>
<a href="#l53.223"></a><span id="l53.223" class="difflineminus">-  OnItemPropertyFlagChanged: function(item, property, oldFlag, newFlag) {},</span>
<a href="#l53.224"></a><span id="l53.224" class="difflineminus">-</span>
<a href="#l53.225"></a><span id="l53.225" class="difflineminus">-  OnItemEvent: function(folder, event)</span>
<a href="#l53.226"></a><span id="l53.226" class="difflineminus">-  {</span>
<a href="#l53.227"></a><span id="l53.227" class="difflineminus">-    if (event == &quot;FolderCreateCompleted&quot;)</span>
<a href="#l53.228"></a><span id="l53.228" class="difflineminus">-    {</span>
<a href="#l53.229"></a><span id="l53.229" class="difflineminus">-      gActionTargetElement.selectFolder(folder);</span>
<a href="#l53.230"></a><span id="l53.230" class="difflineminus">-      SetBusyCursor(window, false);</span>
<a href="#l53.231"></a><span id="l53.231" class="difflineminus">-    }</span>
<a href="#l53.232"></a><span id="l53.232" class="difflineminus">-    else if (event == &quot;FolderCreateFailed&quot;)</span>
<a href="#l53.233"></a><span id="l53.233" class="difflineminus">-      SetBusyCursor(window, false);</span>
<a href="#l53.234"></a><span id="l53.234" class="difflineminus">-  }</span>
<a href="#l53.235"></a><span id="l53.235" class="difflineminus">-}</span>
<a href="#l53.236"></a><span id="l53.236" class="difflineminus">-</span>
<a href="#l53.237"></a><span id="l53.237" class="difflineminus">-function duplicateFilterNameExists(filterName)</span>
<a href="#l53.238"></a><span id="l53.238" class="difflineminus">-{</span>
<a href="#l53.239"></a><span id="l53.239" class="difflineplus">+function duplicateFilterNameExists(filterName) {</span>
<a href="#l53.240"></a><span id="l53.240">   if (gFilterList)</span>
<a href="#l53.241"></a><span id="l53.241">     for (var i = 0; i &lt; gFilterList.filterCount; i++)</span>
<a href="#l53.242"></a><span id="l53.242">       if (filterName == gFilterList.getFilterAt(i).filterName)</span>
<a href="#l53.243"></a><span id="l53.243">         return true;</span>
<a href="#l53.244"></a><span id="l53.244">   return false;</span>
<a href="#l53.245"></a><span id="l53.245"> }</span>
<a href="#l53.246"></a><span id="l53.246"> </span>
<a href="#l53.247"></a><span id="l53.247" class="difflineminus">-function getScopeFromFilterList(filterList)</span>
<a href="#l53.248"></a><span id="l53.248" class="difflineminus">-{</span>
<a href="#l53.249"></a><span id="l53.249" class="difflineminus">-  if (!filterList)</span>
<a href="#l53.250"></a><span id="l53.250" class="difflineminus">-  {</span>
<a href="#l53.251"></a><span id="l53.251" class="difflineplus">+function getScopeFromFilterList(filterList) {</span>
<a href="#l53.252"></a><span id="l53.252" class="difflineplus">+  if (!filterList) {</span>
<a href="#l53.253"></a><span id="l53.253">     dump(&quot;yikes, null filterList\n&quot;);</span>
<a href="#l53.254"></a><span id="l53.254">     return nsMsgSearchScope.offlineMail;</span>
<a href="#l53.255"></a><span id="l53.255">   }</span>
<a href="#l53.256"></a><span id="l53.256">   return filterList.folder.server.filterScope;</span>
<a href="#l53.257"></a><span id="l53.257"> }</span>
<a href="#l53.258"></a><span id="l53.258"> </span>
<a href="#l53.259"></a><span id="l53.259" class="difflineminus">-function getScope(filter)</span>
<a href="#l53.260"></a><span id="l53.260" class="difflineminus">-{</span>
<a href="#l53.261"></a><span id="l53.261" class="difflineplus">+function getScope(filter) {</span>
<a href="#l53.262"></a><span id="l53.262">   return getScopeFromFilterList(filter.filterList);</span>
<a href="#l53.263"></a><span id="l53.263"> }</span>
<a href="#l53.264"></a><span id="l53.264"> </span>
<a href="#l53.265"></a><span id="l53.265" class="difflineminus">-function initializeFilterWidgets()</span>
<a href="#l53.266"></a><span id="l53.266" class="difflineminus">-{</span>
<a href="#l53.267"></a><span id="l53.267" class="difflineplus">+function initializeFilterWidgets() {</span>
<a href="#l53.268"></a><span id="l53.268">   gFilterNameElement = document.getElementById(&quot;filterName&quot;);</span>
<a href="#l53.269"></a><span id="l53.269">   gFilterActionList = document.getElementById(&quot;filterActionList&quot;);</span>
<a href="#l53.270"></a><span id="l53.270">   initializeFilterTypeSelector();</span>
<a href="#l53.271"></a><span id="l53.271"> }</span>
<a href="#l53.272"></a><span id="l53.272"> </span>
<a href="#l53.273"></a><span id="l53.273" class="difflineminus">-function initializeFilterTypeSelector()</span>
<a href="#l53.274"></a><span id="l53.274" class="difflineminus">-{</span>
<a href="#l53.275"></a><span id="l53.275" class="difflineplus">+function initializeFilterTypeSelector() {</span>
<a href="#l53.276"></a><span id="l53.276">   /**</span>
<a href="#l53.277"></a><span id="l53.277">    * This object controls code interaction with the widget allowing specifying</span>
<a href="#l53.278"></a><span id="l53.278">    * the filter type (event when the filter is run).</span>
<a href="#l53.279"></a><span id="l53.279">    */</span>
<a href="#l53.280"></a><span id="l53.280">   gFilterTypeSelector = {</span>
<a href="#l53.281"></a><span id="l53.281">     checkBoxManual: document.getElementById(&quot;runManual&quot;),</span>
<a href="#l53.282"></a><span id="l53.282" class="difflineminus">-    checkBoxIncoming : document.getElementById(&quot;runIncoming&quot;),</span>
<a href="#l53.283"></a><span id="l53.283" class="difflineplus">+    checkBoxIncoming: document.getElementById(&quot;runIncoming&quot;),</span>
<a href="#l53.284"></a><span id="l53.284"> </span>
<a href="#l53.285"></a><span id="l53.285">     menulistIncoming: document.getElementById(&quot;pluginsRunOrder&quot;),</span>
<a href="#l53.286"></a><span id="l53.286"> </span>
<a href="#l53.287"></a><span id="l53.287">     menuitemBeforePlugins: document.getElementById(&quot;runBeforePlugins&quot;),</span>
<a href="#l53.288"></a><span id="l53.288">     menuitemAfterPlugins: document.getElementById(&quot;runAfterPlugins&quot;),</span>
<a href="#l53.289"></a><span id="l53.289"> </span>
<a href="#l53.290"></a><span id="l53.290">     checkBoxArchive: document.getElementById(&quot;runArchive&quot;),</span>
<a href="#l53.291"></a><span id="l53.291">     checkBoxOutgoing: document.getElementById(&quot;runOutgoing&quot;),</span>
<a href="#l53.292"></a><span id="l53.292"> </span>
<a href="#l53.293"></a><span id="l53.293">     /**</span>
<a href="#l53.294"></a><span id="l53.294">      * Returns the currently set filter type (checkboxes) in terms</span>
<a href="#l53.295"></a><span id="l53.295">      * of a Ci.nsMsgFilterType value.</span>
<a href="#l53.296"></a><span id="l53.296">      */</span>
<a href="#l53.297"></a><span id="l53.297" class="difflineminus">-    getType: function()</span>
<a href="#l53.298"></a><span id="l53.298" class="difflineminus">-    {</span>
<a href="#l53.299"></a><span id="l53.299" class="difflineplus">+    getType() {</span>
<a href="#l53.300"></a><span id="l53.300">       let type = nsMsgFilterType.None;</span>
<a href="#l53.301"></a><span id="l53.301"> </span>
<a href="#l53.302"></a><span id="l53.302">       if (this.checkBoxManual.checked)</span>
<a href="#l53.303"></a><span id="l53.303">         type |= nsMsgFilterType.Manual;</span>
<a href="#l53.304"></a><span id="l53.304"> </span>
<a href="#l53.305"></a><span id="l53.305">       if (this.checkBoxIncoming.checked) {</span>
<a href="#l53.306"></a><span id="l53.306">         if (this.menulistIncoming.selectedItem == this.menuitemAfterPlugins) {</span>
<a href="#l53.307"></a><span id="l53.307">           type |= nsMsgFilterType.PostPlugin;</span>
<a href="#l53.308"></a><span id="l53.308" class="difflineplus">+        } else if (getScopeFromFilterList(gFilterList) == nsMsgSearchScope.newsFilter) {</span>
<a href="#l53.309"></a><span id="l53.309" class="difflineplus">+          type |= nsMsgFilterType.NewsRule;</span>
<a href="#l53.310"></a><span id="l53.310">         } else {</span>
<a href="#l53.311"></a><span id="l53.311" class="difflineminus">-          // this.menuitemBeforePlugins selected</span>
<a href="#l53.312"></a><span id="l53.312" class="difflineminus">-          if (getScopeFromFilterList(gFilterList) ==</span>
<a href="#l53.313"></a><span id="l53.313" class="difflineminus">-              nsMsgSearchScope.newsFilter)</span>
<a href="#l53.314"></a><span id="l53.314" class="difflineminus">-            type |= nsMsgFilterType.NewsRule;</span>
<a href="#l53.315"></a><span id="l53.315" class="difflineminus">-          else</span>
<a href="#l53.316"></a><span id="l53.316" class="difflineminus">-            type |= nsMsgFilterType.InboxRule;</span>
<a href="#l53.317"></a><span id="l53.317" class="difflineplus">+          type |= nsMsgFilterType.InboxRule;</span>
<a href="#l53.318"></a><span id="l53.318">         }</span>
<a href="#l53.319"></a><span id="l53.319">       }</span>
<a href="#l53.320"></a><span id="l53.320"> </span>
<a href="#l53.321"></a><span id="l53.321">       if (this.checkBoxArchive.checked)</span>
<a href="#l53.322"></a><span id="l53.322">         type |= nsMsgFilterType.Archive;</span>
<a href="#l53.323"></a><span id="l53.323"> </span>
<a href="#l53.324"></a><span id="l53.324">       if (this.checkBoxOutgoing.checked)</span>
<a href="#l53.325"></a><span id="l53.325">         type |= nsMsgFilterType.PostOutgoing;</span>
<a href="#l53.326"></a><span id="l53.326" class="difflineat">@@ -334,18 +275,17 @@ function initializeFilterTypeSelector()</span>
<a href="#l53.327"></a><span id="l53.327">     },</span>
<a href="#l53.328"></a><span id="l53.328"> </span>
<a href="#l53.329"></a><span id="l53.329">     /**</span>
<a href="#l53.330"></a><span id="l53.330">      * Sets the checkboxes to represent the filter type passed in.</span>
<a href="#l53.331"></a><span id="l53.331">      *</span>
<a href="#l53.332"></a><span id="l53.332">      * @param aType  the filter type to set in terms</span>
<a href="#l53.333"></a><span id="l53.333">      *               of Ci.nsMsgFilterType values.</span>
<a href="#l53.334"></a><span id="l53.334">      */</span>
<a href="#l53.335"></a><span id="l53.335" class="difflineminus">-    setType: function(aType)</span>
<a href="#l53.336"></a><span id="l53.336" class="difflineminus">-    {</span>
<a href="#l53.337"></a><span id="l53.337" class="difflineplus">+    setType(aType) {</span>
<a href="#l53.338"></a><span id="l53.338">       // If there is no type (event) requested, force &quot;when manually run&quot;</span>
<a href="#l53.339"></a><span id="l53.339">       if (aType == nsMsgFilterType.None)</span>
<a href="#l53.340"></a><span id="l53.340">         aType = nsMsgFilterType.Manual;</span>
<a href="#l53.341"></a><span id="l53.341"> </span>
<a href="#l53.342"></a><span id="l53.342">       this.checkBoxManual.checked   = aType &amp; nsMsgFilterType.Manual;</span>
<a href="#l53.343"></a><span id="l53.343"> </span>
<a href="#l53.344"></a><span id="l53.344">       this.checkBoxIncoming.checked = aType &amp; (nsMsgFilterType.PostPlugin |</span>
<a href="#l53.345"></a><span id="l53.345">                                                nsMsgFilterType.Incoming);</span>
<a href="#l53.346"></a><span id="l53.346" class="difflineat">@@ -359,220 +299,192 @@ function initializeFilterTypeSelector()</span>
<a href="#l53.347"></a><span id="l53.347"> </span>
<a href="#l53.348"></a><span id="l53.348">       this.updateClassificationMenu();</span>
<a href="#l53.349"></a><span id="l53.349">     },</span>
<a href="#l53.350"></a><span id="l53.350"> </span>
<a href="#l53.351"></a><span id="l53.351">     /**</span>
<a href="#l53.352"></a><span id="l53.352">      * Enable the &quot;before/after classification&quot; menulist depending on</span>
<a href="#l53.353"></a><span id="l53.353">      * whether &quot;run when incoming mail&quot; is selected.</span>
<a href="#l53.354"></a><span id="l53.354">      */</span>
<a href="#l53.355"></a><span id="l53.355" class="difflineminus">-    updateClassificationMenu: function()</span>
<a href="#l53.356"></a><span id="l53.356" class="difflineminus">-    {</span>
<a href="#l53.357"></a><span id="l53.357" class="difflineplus">+    updateClassificationMenu() {</span>
<a href="#l53.358"></a><span id="l53.358">       this.menulistIncoming.disabled = !this.checkBoxIncoming.checked;</span>
<a href="#l53.359"></a><span id="l53.359">       updateFilterType();</span>
<a href="#l53.360"></a><span id="l53.360">     },</span>
<a href="#l53.361"></a><span id="l53.361"> </span>
<a href="#l53.362"></a><span id="l53.362">     /**</span>
<a href="#l53.363"></a><span id="l53.363">      * Disable the options unsuitable for deferred accounts.</span>
<a href="#l53.364"></a><span id="l53.364">      */</span>
<a href="#l53.365"></a><span id="l53.365" class="difflineminus">-    disableDeferredAccount: function()</span>
<a href="#l53.366"></a><span id="l53.366" class="difflineminus">-    {</span>
<a href="#l53.367"></a><span id="l53.367" class="difflineplus">+    disableDeferredAccount() {</span>
<a href="#l53.368"></a><span id="l53.368">       this.menuitemAfterPlugins.disabled = true;</span>
<a href="#l53.369"></a><span id="l53.369">       this.checkBoxOutgoing.disabled = true;</span>
<a href="#l53.370"></a><span id="l53.370" class="difflineminus">-    }</span>
<a href="#l53.371"></a><span id="l53.371" class="difflineplus">+    },</span>
<a href="#l53.372"></a><span id="l53.372">   };</span>
<a href="#l53.373"></a><span id="l53.373"> }</span>
<a href="#l53.374"></a><span id="l53.374"> </span>
<a href="#l53.375"></a><span id="l53.375" class="difflineminus">-function initializeDialog(filter)</span>
<a href="#l53.376"></a><span id="l53.376" class="difflineminus">-{</span>
<a href="#l53.377"></a><span id="l53.377" class="difflineplus">+function initializeDialog(filter) {</span>
<a href="#l53.378"></a><span id="l53.378">   gFilterNameElement.value = filter.filterName;</span>
<a href="#l53.379"></a><span id="l53.379" class="difflineminus">-  let filterType = filter.filterType;</span>
<a href="#l53.380"></a><span id="l53.380">   gFilterTypeSelector.setType(filter.filterType);</span>
<a href="#l53.381"></a><span id="l53.381"> </span>
<a href="#l53.382"></a><span id="l53.382">   let numActions = filter.actionCount;</span>
<a href="#l53.383"></a><span id="l53.383" class="difflineminus">-  for (let actionIndex = 0; actionIndex &lt; numActions; actionIndex++)</span>
<a href="#l53.384"></a><span id="l53.384" class="difflineminus">-  {</span>
<a href="#l53.385"></a><span id="l53.385" class="difflineplus">+  for (let actionIndex = 0; actionIndex &lt; numActions; actionIndex++) {</span>
<a href="#l53.386"></a><span id="l53.386">     let filterAction = filter.getActionAt(actionIndex);</span>
<a href="#l53.387"></a><span id="l53.387"> </span>
<a href="#l53.388"></a><span id="l53.388">     let newActionRow = document.createElement(&quot;richlistitem&quot;);</span>
<a href="#l53.389"></a><span id="l53.389" class="difflineminus">-    newActionRow.setAttribute('initialActionIndex', actionIndex);</span>
<a href="#l53.390"></a><span id="l53.390" class="difflineminus">-    newActionRow.className = 'ruleaction';</span>
<a href="#l53.391"></a><span id="l53.391" class="difflineplus">+    newActionRow.setAttribute(&quot;initialActionIndex&quot;, actionIndex);</span>
<a href="#l53.392"></a><span id="l53.392" class="difflineplus">+    newActionRow.className = &quot;ruleaction&quot;;</span>
<a href="#l53.393"></a><span id="l53.393">     gFilterActionList.appendChild(newActionRow);</span>
<a href="#l53.394"></a><span id="l53.394" class="difflineminus">-    newActionRow.setAttribute('value',</span>
<a href="#l53.395"></a><span id="l53.395" class="difflineplus">+    newActionRow.setAttribute(&quot;value&quot;,</span>
<a href="#l53.396"></a><span id="l53.396">         filterAction.type == nsMsgFilterAction.Custom ?</span>
<a href="#l53.397"></a><span id="l53.397">         filterAction.customId : gFilterActionStrings[filterAction.type]);</span>
<a href="#l53.398"></a><span id="l53.398" class="difflineminus">-    newActionRow.setAttribute('onfocus', 'this.storeFocus();');</span>
<a href="#l53.399"></a><span id="l53.399" class="difflineplus">+    newActionRow.setAttribute(&quot;onfocus&quot;, &quot;this.storeFocus();&quot;);</span>
<a href="#l53.400"></a><span id="l53.400">   }</span>
<a href="#l53.401"></a><span id="l53.401"> </span>
<a href="#l53.402"></a><span id="l53.402">   var gSearchScope = getFilterScope(getScope(filter), filter.filterType, filter.filterList);</span>
<a href="#l53.403"></a><span id="l53.403">   initializeSearchRows(gSearchScope, filter.searchTerms);</span>
<a href="#l53.404"></a><span id="l53.404">   setFilterScope(filter.filterType, filter.filterList);</span>
<a href="#l53.405"></a><span id="l53.405"> }</span>
<a href="#l53.406"></a><span id="l53.406"> </span>
<a href="#l53.407"></a><span id="l53.407" class="difflineminus">-function ensureActionRow()</span>
<a href="#l53.408"></a><span id="l53.408" class="difflineminus">-{</span>
<a href="#l53.409"></a><span id="l53.409" class="difflineplus">+function ensureActionRow() {</span>
<a href="#l53.410"></a><span id="l53.410">   // make sure we have at least one action row visible to the user</span>
<a href="#l53.411"></a><span id="l53.411" class="difflineminus">-  if (!gFilterActionList.getRowCount())</span>
<a href="#l53.412"></a><span id="l53.412" class="difflineminus">-  {</span>
<a href="#l53.413"></a><span id="l53.413" class="difflineplus">+  if (!gFilterActionList.getRowCount()) {</span>
<a href="#l53.414"></a><span id="l53.414">     let newActionRow = document.createElement(&quot;richlistitem&quot;);</span>
<a href="#l53.415"></a><span id="l53.415" class="difflineminus">-    newActionRow.className = 'ruleaction';</span>
<a href="#l53.416"></a><span id="l53.416" class="difflineplus">+    newActionRow.className = &quot;ruleaction&quot;;</span>
<a href="#l53.417"></a><span id="l53.417">     gFilterActionList.appendChild(newActionRow);</span>
<a href="#l53.418"></a><span id="l53.418">     newActionRow.mRemoveButton.disabled = true;</span>
<a href="#l53.419"></a><span id="l53.419">   }</span>
<a href="#l53.420"></a><span id="l53.420"> }</span>
<a href="#l53.421"></a><span id="l53.421"> </span>
<a href="#l53.422"></a><span id="l53.422"> // move to overlay</span>
<a href="#l53.423"></a><span id="l53.423" class="difflineminus">-function saveFilter()</span>
<a href="#l53.424"></a><span id="l53.424" class="difflineminus">-{</span>
<a href="#l53.425"></a><span id="l53.425" class="difflineplus">+function saveFilter() {</span>
<a href="#l53.426"></a><span id="l53.426">   // See if at least one filter type (activation event) is selected.</span>
<a href="#l53.427"></a><span id="l53.427">   if (gFilterType == nsMsgFilterType.None) {</span>
<a href="#l53.428"></a><span id="l53.428">     Services.prompt.alert(window,</span>
<a href="#l53.429"></a><span id="l53.429">                           gFilterBundle.getString(&quot;mustHaveFilterTypeTitle&quot;),</span>
<a href="#l53.430"></a><span id="l53.430">                           gFilterBundle.getString(&quot;mustHaveFilterTypeMessage&quot;));</span>
<a href="#l53.431"></a><span id="l53.431">     return false;</span>
<a href="#l53.432"></a><span id="l53.432">   }</span>
<a href="#l53.433"></a><span id="l53.433"> </span>
<a href="#l53.434"></a><span id="l53.434">   let filterName = gFilterNameElement.value;</span>
<a href="#l53.435"></a><span id="l53.435">   // If we think have a duplicate, then we need to check that if we</span>
<a href="#l53.436"></a><span id="l53.436">   // have an original filter name (i.e. we are editing a filter), then</span>
<a href="#l53.437"></a><span id="l53.437">   // we must check that the original is not the current as that is what</span>
<a href="#l53.438"></a><span id="l53.438">   // the duplicateFilterNameExists function will have picked up.</span>
<a href="#l53.439"></a><span id="l53.439" class="difflineminus">-  if ((!gFilter || gFilter.filterName != filterName) &amp;&amp; duplicateFilterNameExists(filterName))</span>
<a href="#l53.440"></a><span id="l53.440" class="difflineminus">-  {</span>
<a href="#l53.441"></a><span id="l53.441" class="difflineplus">+  if ((!gFilter || gFilter.filterName != filterName) &amp;&amp; duplicateFilterNameExists(filterName)) {</span>
<a href="#l53.442"></a><span id="l53.442">     Services.prompt.alert(window,</span>
<a href="#l53.443"></a><span id="l53.443">                           gFilterBundle.getString(&quot;cannotHaveDuplicateFilterTitle&quot;),</span>
<a href="#l53.444"></a><span id="l53.444">                           gFilterBundle.getString(&quot;cannotHaveDuplicateFilterMessage&quot;));</span>
<a href="#l53.445"></a><span id="l53.445">     return false;</span>
<a href="#l53.446"></a><span id="l53.446">   }</span>
<a href="#l53.447"></a><span id="l53.447"> </span>
<a href="#l53.448"></a><span id="l53.448">   // Check that all of the search attributes and operators are valid.</span>
<a href="#l53.449"></a><span id="l53.449">   function rule_desc(index, obj) {</span>
<a href="#l53.450"></a><span id="l53.450">     return (index + 1) + &quot; (&quot; + obj.searchattribute.label + &quot;, &quot; + obj.searchoperator.label + &quot;)&quot;;</span>
<a href="#l53.451"></a><span id="l53.451">   }</span>
<a href="#l53.452"></a><span id="l53.452"> </span>
<a href="#l53.453"></a><span id="l53.453">   let invalidRule = false;</span>
<a href="#l53.454"></a><span id="l53.454" class="difflineminus">-  for (let index = 0; index &lt; gSearchTerms.length; index++)</span>
<a href="#l53.455"></a><span id="l53.455" class="difflineminus">-  {</span>
<a href="#l53.456"></a><span id="l53.456" class="difflineplus">+  for (let index = 0; index &lt; gSearchTerms.length; index++) {</span>
<a href="#l53.457"></a><span id="l53.457">     let obj = gSearchTerms[index].obj;</span>
<a href="#l53.458"></a><span id="l53.458">     // We don't need to check validity of matchAll terms</span>
<a href="#l53.459"></a><span id="l53.459">     if (obj.matchAll)</span>
<a href="#l53.460"></a><span id="l53.460">       continue;</span>
<a href="#l53.461"></a><span id="l53.461"> </span>
<a href="#l53.462"></a><span id="l53.462">     // the term might be an offscreen one that we haven't initialized yet</span>
<a href="#l53.463"></a><span id="l53.463">     let searchTerm = obj.searchTerm;</span>
<a href="#l53.464"></a><span id="l53.464">     if (!searchTerm &amp;&amp; !gSearchTerms[index].initialized)</span>
<a href="#l53.465"></a><span id="l53.465">       continue;</span>
<a href="#l53.466"></a><span id="l53.466"> </span>
<a href="#l53.467"></a><span id="l53.467" class="difflineminus">-    if (isNaN(obj.searchattribute.value)) // is this a custom term?</span>
<a href="#l53.468"></a><span id="l53.468" class="difflineminus">-    {</span>
<a href="#l53.469"></a><span id="l53.469" class="difflineplus">+    if (isNaN(obj.searchattribute.value)) { // is this a custom term?</span>
<a href="#l53.470"></a><span id="l53.470">       let customTerm = MailServices.filters.getCustomTerm(obj.searchattribute.value);</span>
<a href="#l53.471"></a><span id="l53.471" class="difflineminus">-      if (!customTerm)</span>
<a href="#l53.472"></a><span id="l53.472" class="difflineminus">-      {</span>
<a href="#l53.473"></a><span id="l53.473" class="difflineplus">+      if (!customTerm) {</span>
<a href="#l53.474"></a><span id="l53.474">         invalidRule = true;</span>
<a href="#l53.475"></a><span id="l53.475">         Cu.reportError(&quot;Filter not saved because custom search term '&quot; +</span>
<a href="#l53.476"></a><span id="l53.476">                        obj.searchattribute.value + &quot;' in rule &quot; + rule_desc(index, obj) + &quot; not found&quot;);</span>
<a href="#l53.477"></a><span id="l53.477" class="difflineminus">-      }</span>
<a href="#l53.478"></a><span id="l53.478" class="difflineminus">-      else</span>
<a href="#l53.479"></a><span id="l53.479" class="difflineminus">-      {</span>
<a href="#l53.480"></a><span id="l53.480" class="difflineminus">-        if (!customTerm.getAvailable(obj.searchScope, obj.searchattribute.value))</span>
<a href="#l53.481"></a><span id="l53.481" class="difflineminus">-        {</span>
<a href="#l53.482"></a><span id="l53.482" class="difflineplus">+      } else if (!customTerm.getAvailable(obj.searchScope, obj.searchattribute.value)) {</span>
<a href="#l53.483"></a><span id="l53.483">           invalidRule = true;</span>
<a href="#l53.484"></a><span id="l53.484">           Cu.reportError(&quot;Filter not saved because custom search term '&quot; +</span>
<a href="#l53.485"></a><span id="l53.485">                          customTerm.name + &quot;' in rule &quot; + rule_desc(index, obj) + &quot; not available&quot;);</span>
<a href="#l53.486"></a><span id="l53.486">         }</span>
<a href="#l53.487"></a><span id="l53.487" class="difflineminus">-      }</span>
<a href="#l53.488"></a><span id="l53.488" class="difflineminus">-    }</span>
<a href="#l53.489"></a><span id="l53.489" class="difflineminus">-    else</span>
<a href="#l53.490"></a><span id="l53.490" class="difflineminus">-    {</span>
<a href="#l53.491"></a><span id="l53.491" class="difflineplus">+    } else {</span>
<a href="#l53.492"></a><span id="l53.492">       let otherHeader = Ci.nsMsgSearchAttrib.OtherHeader;</span>
<a href="#l53.493"></a><span id="l53.493">       let attribValue = (obj.searchattribute.value &gt; otherHeader) ?</span>
<a href="#l53.494"></a><span id="l53.494">         otherHeader : obj.searchattribute.value;</span>
<a href="#l53.495"></a><span id="l53.495">       if (!obj.searchattribute</span>
<a href="#l53.496"></a><span id="l53.496" class="difflineminus">-            .validityTable</span>
<a href="#l53.497"></a><span id="l53.497" class="difflineminus">-            .getAvailable(attribValue, obj.searchoperator.value))</span>
<a href="#l53.498"></a><span id="l53.498" class="difflineminus">-      {</span>
<a href="#l53.499"></a><span id="l53.499" class="difflineplus">+              .validityTable</span>
<a href="#l53.500"></a><span id="l53.500" class="difflineplus">+              .getAvailable(attribValue, obj.searchoperator.value)) {</span>
<a href="#l53.501"></a><span id="l53.501">         invalidRule = true;</span>
<a href="#l53.502"></a><span id="l53.502">         Cu.reportError(&quot;Filter not saved because standard search term '&quot; +</span>
<a href="#l53.503"></a><span id="l53.503">                        attribValue + &quot;' in rule &quot; + rule_desc(index, obj) + &quot; not available in this context&quot;);</span>
<a href="#l53.504"></a><span id="l53.504">       }</span>
<a href="#l53.505"></a><span id="l53.505">     }</span>
<a href="#l53.506"></a><span id="l53.506"> </span>
<a href="#l53.507"></a><span id="l53.507">     if (invalidRule) {</span>
<a href="#l53.508"></a><span id="l53.508">       Services.prompt.alert(window,</span>
<a href="#l53.509"></a><span id="l53.509">                             gFilterBundle.getString(&quot;searchTermsInvalidTitle&quot;),</span>
<a href="#l53.510"></a><span id="l53.510">                             gFilterBundle.getFormattedString(&quot;searchTermsInvalidRule&quot;,</span>
<a href="#l53.511"></a><span id="l53.511">                                                              [obj.searchattribute.label,</span>
<a href="#l53.512"></a><span id="l53.512">                                                               obj.searchoperator.label]));</span>
<a href="#l53.513"></a><span id="l53.513">       return false;</span>
<a href="#l53.514"></a><span id="l53.514">     }</span>
<a href="#l53.515"></a><span id="l53.515" class="difflineminus">-</span>
<a href="#l53.516"></a><span id="l53.516">   }</span>
<a href="#l53.517"></a><span id="l53.517"> </span>
<a href="#l53.518"></a><span id="l53.518">   // before we go any further, validate each specified filter action, abort the save</span>
<a href="#l53.519"></a><span id="l53.519">   // if any of the actions is invalid...</span>
<a href="#l53.520"></a><span id="l53.520" class="difflineminus">-  for (let index = 0; index &lt; gFilterActionList.itemCount; index++)</span>
<a href="#l53.521"></a><span id="l53.521" class="difflineminus">-  {</span>
<a href="#l53.522"></a><span id="l53.522" class="difflineplus">+  for (let index = 0; index &lt; gFilterActionList.itemCount; index++) {</span>
<a href="#l53.523"></a><span id="l53.523">     var listItem = gFilterActionList.getItemAtIndex(index);</span>
<a href="#l53.524"></a><span id="l53.524">     if (!listItem.validateAction())</span>
<a href="#l53.525"></a><span id="l53.525">       return false;</span>
<a href="#l53.526"></a><span id="l53.526">   }</span>
<a href="#l53.527"></a><span id="l53.527"> </span>
<a href="#l53.528"></a><span id="l53.528">   // if we made it here, all of the actions are valid, so go ahead and save the filter</span>
<a href="#l53.529"></a><span id="l53.529">   let isNewFilter;</span>
<a href="#l53.530"></a><span id="l53.530" class="difflineminus">-  if (!gFilter)</span>
<a href="#l53.531"></a><span id="l53.531" class="difflineminus">-  {</span>
<a href="#l53.532"></a><span id="l53.532" class="difflineplus">+  if (!gFilter) {</span>
<a href="#l53.533"></a><span id="l53.533">     // This is a new filter</span>
<a href="#l53.534"></a><span id="l53.534">     gFilter = gFilterList.createFilter(filterName);</span>
<a href="#l53.535"></a><span id="l53.535">     isNewFilter = true;</span>
<a href="#l53.536"></a><span id="l53.536">     gFilter.enabled = true;</span>
<a href="#l53.537"></a><span id="l53.537" class="difflineminus">-  }</span>
<a href="#l53.538"></a><span id="l53.538" class="difflineminus">-  else</span>
<a href="#l53.539"></a><span id="l53.539" class="difflineminus">-  {</span>
<a href="#l53.540"></a><span id="l53.540" class="difflineplus">+  } else {</span>
<a href="#l53.541"></a><span id="l53.541">     // We are working with an existing filter object,</span>
<a href="#l53.542"></a><span id="l53.542">     // either editing or using prefill</span>
<a href="#l53.543"></a><span id="l53.543">     gFilter.filterName = filterName;</span>
<a href="#l53.544"></a><span id="l53.544" class="difflineminus">-    //Prefilter is treated as a new filter.</span>
<a href="#l53.545"></a><span id="l53.545" class="difflineminus">-    if (gPreFillName)</span>
<a href="#l53.546"></a><span id="l53.546" class="difflineminus">-    {</span>
<a href="#l53.547"></a><span id="l53.547" class="difflineplus">+    // Prefilter is treated as a new filter.</span>
<a href="#l53.548"></a><span id="l53.548" class="difflineplus">+    if (gPreFillName) {</span>
<a href="#l53.549"></a><span id="l53.549">       isNewFilter = true;</span>
<a href="#l53.550"></a><span id="l53.550">       gFilter.enabled = true;</span>
<a href="#l53.551"></a><span id="l53.551" class="difflineplus">+    } else {</span>
<a href="#l53.552"></a><span id="l53.552" class="difflineplus">+      isNewFilter = false;</span>
<a href="#l53.553"></a><span id="l53.553">     }</span>
<a href="#l53.554"></a><span id="l53.554" class="difflineminus">-    else</span>
<a href="#l53.555"></a><span id="l53.555" class="difflineminus">-      isNewFilter = false;</span>
<a href="#l53.556"></a><span id="l53.556"> </span>
<a href="#l53.557"></a><span id="l53.557">     gFilter.clearActionList();</span>
<a href="#l53.558"></a><span id="l53.558">   }</span>
<a href="#l53.559"></a><span id="l53.559"> </span>
<a href="#l53.560"></a><span id="l53.560">   // add each filteraction to the filter</span>
<a href="#l53.561"></a><span id="l53.561">   for (let index = 0; index &lt; gFilterActionList.itemCount; index++)</span>
<a href="#l53.562"></a><span id="l53.562">     gFilterActionList.getItemAtIndex(index).saveToFilter(gFilter);</span>
<a href="#l53.563"></a><span id="l53.563"> </span>
<a href="#l53.564"></a><span id="l53.564">   // If we do not have a filter name at this point, generate one.</span>
<a href="#l53.565"></a><span id="l53.565">   if (!gFilter.filterName)</span>
<a href="#l53.566"></a><span id="l53.566">     AssignMeaningfulName();</span>
<a href="#l53.567"></a><span id="l53.567"> </span>
<a href="#l53.568"></a><span id="l53.568">   gFilter.filterType = gFilterType;</span>
<a href="#l53.569"></a><span id="l53.569">   saveSearchTerms(gFilter.searchTerms, gFilter);</span>
<a href="#l53.570"></a><span id="l53.570"> </span>
<a href="#l53.571"></a><span id="l53.571" class="difflineminus">-  if (isNewFilter)</span>
<a href="#l53.572"></a><span id="l53.572" class="difflineminus">-  {</span>
<a href="#l53.573"></a><span id="l53.573" class="difflineplus">+  if (isNewFilter) {</span>
<a href="#l53.574"></a><span id="l53.574">     // new filter - insert into gFilterList</span>
<a href="#l53.575"></a><span id="l53.575">     gFilterList.insertFilterAt(gFilterPosition, gFilter);</span>
<a href="#l53.576"></a><span id="l53.576">   }</span>
<a href="#l53.577"></a><span id="l53.577"> </span>
<a href="#l53.578"></a><span id="l53.578">   // success!</span>
<a href="#l53.579"></a><span id="l53.579">   return true;</span>
<a href="#l53.580"></a><span id="l53.580"> }</span>
<a href="#l53.581"></a><span id="l53.581"> </span>
<a href="#l53.582"></a><span id="l53.582"> /**</span>
<a href="#l53.583"></a><span id="l53.583">  * Check if the list of actions the user created will be executed in a different order.</span>
<a href="#l53.584"></a><span id="l53.584">  * Exposes a note to the user if that is the case.</span>
<a href="#l53.585"></a><span id="l53.585">  */</span>
<a href="#l53.586"></a><span id="l53.586" class="difflineminus">-function checkActionsReorder()</span>
<a href="#l53.587"></a><span id="l53.587" class="difflineminus">-{</span>
<a href="#l53.588"></a><span id="l53.588" class="difflineplus">+function checkActionsReorder() {</span>
<a href="#l53.589"></a><span id="l53.589">   setTimeout(_checkActionsReorder, 0);</span>
<a href="#l53.590"></a><span id="l53.590"> }</span>
<a href="#l53.591"></a><span id="l53.591"> </span>
<a href="#l53.592"></a><span id="l53.592"> /**</span>
<a href="#l53.593"></a><span id="l53.593">  * This should be called from setTimeout otherwise some of the elements calling</span>
<a href="#l53.594"></a><span id="l53.594">  * may not be fully initialized yet (e.g. we get &quot;.saveToFilter is not a function&quot;).</span>
<a href="#l53.595"></a><span id="l53.595">  * It is OK to schedule multiple timeouts with this function.</span>
<a href="#l53.596"></a><span id="l53.596">  */</span>
<a href="#l53.597"></a><span id="l53.597" class="difflineat">@@ -588,35 +500,33 @@ function _checkActionsReorder() {</span>
<a href="#l53.598"></a><span id="l53.598"> </span>
<a href="#l53.599"></a><span id="l53.599">   // Now get the actions out of the filter in the order they will be executed in.</span>
<a href="#l53.600"></a><span id="l53.600">   gActionListOrdered = gTempFilter.sortedActionList;</span>
<a href="#l53.601"></a><span id="l53.601"> </span>
<a href="#l53.602"></a><span id="l53.602">   // Compare the two lists.</span>
<a href="#l53.603"></a><span id="l53.603">   let statusBar = document.getElementById(&quot;statusbar&quot;);</span>
<a href="#l53.604"></a><span id="l53.604">   for (let index = 0; index &lt; gActionListOrdered.length; index++) {</span>
<a href="#l53.605"></a><span id="l53.605">     if (index != gTempFilter.getActionIndex(</span>
<a href="#l53.606"></a><span id="l53.606" class="difflineminus">-        gActionListOrdered.queryElementAt(index, nsIMsgRuleAction)))</span>
<a href="#l53.607"></a><span id="l53.607" class="difflineminus">-    {</span>
<a href="#l53.608"></a><span id="l53.608" class="difflineplus">+        gActionListOrdered.queryElementAt(index, nsIMsgRuleAction))) {</span>
<a href="#l53.609"></a><span id="l53.609">       // If the lists are not the same unhide the status bar and show warning.</span>
<a href="#l53.610"></a><span id="l53.610">       statusBar.style.visibility = &quot;visible&quot;;</span>
<a href="#l53.611"></a><span id="l53.611">       return;</span>
<a href="#l53.612"></a><span id="l53.612">     }</span>
<a href="#l53.613"></a><span id="l53.613">   }</span>
<a href="#l53.614"></a><span id="l53.614"> </span>
<a href="#l53.615"></a><span id="l53.615">   statusBar.style.visibility = &quot;hidden&quot;;</span>
<a href="#l53.616"></a><span id="l53.616"> }</span>
<a href="#l53.617"></a><span id="l53.617"> </span>
<a href="#l53.618"></a><span id="l53.618"> /**</span>
<a href="#l53.619"></a><span id="l53.619">  * Show a dialog with the ordered list of actions.</span>
<a href="#l53.620"></a><span id="l53.620">  * The fetching of action label and argument is separated from checkActionsReorder</span>
<a href="#l53.621"></a><span id="l53.621">  * function to make that one more lightweight. The list is built only upon</span>
<a href="#l53.622"></a><span id="l53.622">  * user request.</span>
<a href="#l53.623"></a><span id="l53.623">  */</span>
<a href="#l53.624"></a><span id="l53.624" class="difflineminus">-function showActionsOrder()</span>
<a href="#l53.625"></a><span id="l53.625" class="difflineminus">-{</span>
<a href="#l53.626"></a><span id="l53.626" class="difflineplus">+function showActionsOrder() {</span>
<a href="#l53.627"></a><span id="l53.627">   // Fetch the actions and arguments as a string.</span>
<a href="#l53.628"></a><span id="l53.628">   let actionStrings = [];</span>
<a href="#l53.629"></a><span id="l53.629">   for (let index = 0; index &lt; gFilterActionList.itemCount; index++)</span>
<a href="#l53.630"></a><span id="l53.630">     gFilterActionList.getItemAtIndex(index).getActionStrings(actionStrings);</span>
<a href="#l53.631"></a><span id="l53.631"> </span>
<a href="#l53.632"></a><span id="l53.632">   // Present a nicely formatted list of action names and arguments.</span>
<a href="#l53.633"></a><span id="l53.633">   let actionList = gFilterBundle.getString(&quot;filterActionOrderExplanation&quot;);</span>
<a href="#l53.634"></a><span id="l53.634">   for (let i = 0; i &lt; gActionListOrdered.length; i++) {</span>
<a href="#l53.635"></a><span id="l53.635" class="difflineat">@@ -625,222 +535,154 @@ function showActionsOrder()</span>
<a href="#l53.636"></a><span id="l53.636">     let action = actionStrings[actionIndex];</span>
<a href="#l53.637"></a><span id="l53.637">     actionList += gFilterBundle.getFormattedString(&quot;filterActionItem&quot;,</span>
<a href="#l53.638"></a><span id="l53.638">       [(i + 1), action.label, action.argument]);</span>
<a href="#l53.639"></a><span id="l53.639">   }</span>
<a href="#l53.640"></a><span id="l53.640"> </span>
<a href="#l53.641"></a><span id="l53.641">   Services.prompt.confirmEx(window,</span>
<a href="#l53.642"></a><span id="l53.642">                             gFilterBundle.getString(&quot;filterActionOrderTitle&quot;),</span>
<a href="#l53.643"></a><span id="l53.643">                             actionList, Services.prompt.BUTTON_TITLE_OK,</span>
<a href="#l53.644"></a><span id="l53.644" class="difflineminus">-                            null, null, null, null, {value:false});</span>
<a href="#l53.645"></a><span id="l53.645" class="difflineplus">+                            null, null, null, null, {value: false});</span>
<a href="#l53.646"></a><span id="l53.646"> }</span>
<a href="#l53.647"></a><span id="l53.647"> </span>
<a href="#l53.648"></a><span id="l53.648" class="difflineminus">-function AssignMeaningfulName()</span>
<a href="#l53.649"></a><span id="l53.649" class="difflineminus">-{</span>
<a href="#l53.650"></a><span id="l53.650" class="difflineplus">+function AssignMeaningfulName() {</span>
<a href="#l53.651"></a><span id="l53.651">   // termRoot points to the first search object, which is the one we care about.</span>
<a href="#l53.652"></a><span id="l53.652">   let termRoot = gSearchTerms[0].obj;</span>
<a href="#l53.653"></a><span id="l53.653">   // stub is used as the base name for a filter.</span>
<a href="#l53.654"></a><span id="l53.654">   let stub;</span>
<a href="#l53.655"></a><span id="l53.655"> </span>
<a href="#l53.656"></a><span id="l53.656">   // If this is a Match All Messages Filter, we already know the name to assign.</span>
<a href="#l53.657"></a><span id="l53.657" class="difflineminus">-  if (termRoot.matchAll)</span>
<a href="#l53.658"></a><span id="l53.658" class="difflineminus">-    stub = gFilterBundle.getString( &quot;matchAllFilterName&quot; );</span>
<a href="#l53.659"></a><span id="l53.659" class="difflineminus">-  else</span>
<a href="#l53.660"></a><span id="l53.660" class="difflineminus">-  {</span>
<a href="#l53.661"></a><span id="l53.661" class="difflineplus">+  if (termRoot.matchAll) {</span>
<a href="#l53.662"></a><span id="l53.662" class="difflineplus">+    stub = gFilterBundle.getString(&quot;matchAllFilterName&quot;);</span>
<a href="#l53.663"></a><span id="l53.663" class="difflineplus">+  } else {</span>
<a href="#l53.664"></a><span id="l53.664">     // Assign a name based on the first search term.</span>
<a href="#l53.665"></a><span id="l53.665">     let searchValue = termRoot.searchvalue;</span>
<a href="#l53.666"></a><span id="l53.666" class="difflineminus">-    let selIndex = searchValue.getAttribute( &quot;selectedIndex&quot; );</span>
<a href="#l53.667"></a><span id="l53.667" class="difflineplus">+    let selIndex = searchValue.getAttribute(&quot;selectedIndex&quot;);</span>
<a href="#l53.668"></a><span id="l53.668">     let children = searchValue.childNodes;</span>
<a href="#l53.669"></a><span id="l53.669">     let activeItem = children[selIndex];</span>
<a href="#l53.670"></a><span id="l53.670">     let attribs = Ci.nsMsgSearchAttrib;</span>
<a href="#l53.671"></a><span id="l53.671"> </span>
<a href="#l53.672"></a><span id="l53.672">     // Term, Operator and Value are the three parts of a filter match</span>
<a href="#l53.673"></a><span id="l53.673">     // Term and Operator are easy to retrieve</span>
<a href="#l53.674"></a><span id="l53.674">     let term = termRoot.searchattribute.label;</span>
<a href="#l53.675"></a><span id="l53.675">     let operator = termRoot.searchoperator.label;</span>
<a href="#l53.676"></a><span id="l53.676"> </span>
<a href="#l53.677"></a><span id="l53.677">     // Values are either popup menu items or edit fields.</span>
<a href="#l53.678"></a><span id="l53.678">     // For popup menus use activeItem.label; for</span>
<a href="#l53.679"></a><span id="l53.679">     // edit fields, activeItem.value</span>
<a href="#l53.680"></a><span id="l53.680">     let value;</span>
<a href="#l53.681"></a><span id="l53.681" class="difflineminus">-    switch (Number(termRoot.searchattribute.value))</span>
<a href="#l53.682"></a><span id="l53.682" class="difflineminus">-    {</span>
<a href="#l53.683"></a><span id="l53.683" class="difflineplus">+    switch (Number(termRoot.searchattribute.value)) {</span>
<a href="#l53.684"></a><span id="l53.684">       case attribs.Priority:</span>
<a href="#l53.685"></a><span id="l53.685">       case attribs.MsgStatus:</span>
<a href="#l53.686"></a><span id="l53.686">       case attribs.Keywords:</span>
<a href="#l53.687"></a><span id="l53.687">       case attribs.HasAttachmentStatus:</span>
<a href="#l53.688"></a><span id="l53.688">       case attribs.JunkStatus:</span>
<a href="#l53.689"></a><span id="l53.689">       case attribs.JunkScoreOrigin:</span>
<a href="#l53.690"></a><span id="l53.690">         if (activeItem)</span>
<a href="#l53.691"></a><span id="l53.691">           value = activeItem.label;</span>
<a href="#l53.692"></a><span id="l53.692">         else</span>
<a href="#l53.693"></a><span id="l53.693">           value = &quot;&quot;;</span>
<a href="#l53.694"></a><span id="l53.694">         break;</span>
<a href="#l53.695"></a><span id="l53.695"> </span>
<a href="#l53.696"></a><span id="l53.696">       default:</span>
<a href="#l53.697"></a><span id="l53.697" class="difflineminus">-        try</span>
<a href="#l53.698"></a><span id="l53.698" class="difflineminus">-        {</span>
<a href="#l53.699"></a><span id="l53.699" class="difflineplus">+        try {</span>
<a href="#l53.700"></a><span id="l53.700">           value = activeItem.value;</span>
<a href="#l53.701"></a><span id="l53.701" class="difflineminus">-        }</span>
<a href="#l53.702"></a><span id="l53.702" class="difflineminus">-        catch (ex)</span>
<a href="#l53.703"></a><span id="l53.703" class="difflineminus">-        {</span>
<a href="#l53.704"></a><span id="l53.704" class="difflineplus">+        } catch (ex) {</span>
<a href="#l53.705"></a><span id="l53.705">           // We should never get here, but for safety's sake,</span>
<a href="#l53.706"></a><span id="l53.706">           // let's name the filter &quot;Untitled Filter&quot;.</span>
<a href="#l53.707"></a><span id="l53.707" class="difflineminus">-          stub = gFilterBundle.getString( &quot;untitledFilterName&quot; );</span>
<a href="#l53.708"></a><span id="l53.708" class="difflineplus">+          stub = gFilterBundle.getString(&quot;untitledFilterName&quot;);</span>
<a href="#l53.709"></a><span id="l53.709">           // Do not 'Return'. Instead fall through and deal with the untitled filter below.</span>
<a href="#l53.710"></a><span id="l53.710">         }</span>
<a href="#l53.711"></a><span id="l53.711">         break;</span>
<a href="#l53.712"></a><span id="l53.712">     }</span>
<a href="#l53.713"></a><span id="l53.713">     // We are now ready to name the filter.</span>
<a href="#l53.714"></a><span id="l53.714">     // If at this point stub is empty, we know that this is not a Match All Filter</span>
<a href="#l53.715"></a><span id="l53.715">     // and is not an &quot;untitledFilterName&quot; Filter, so assign it a name using</span>
<a href="#l53.716"></a><span id="l53.716">     // a string format from the Filter Bundle.</span>
<a href="#l53.717"></a><span id="l53.717">     if (!stub)</span>
<a href="#l53.718"></a><span id="l53.718">       stub = gFilterBundle.getFormattedString(&quot;filterAutoNameStr&quot;, [term, operator, value]);</span>
<a href="#l53.719"></a><span id="l53.719">   }</span>
<a href="#l53.720"></a><span id="l53.720"> </span>
<a href="#l53.721"></a><span id="l53.721">   // Whatever name we have used, 'uniquify' it.</span>
<a href="#l53.722"></a><span id="l53.722">   let tempName = stub;</span>
<a href="#l53.723"></a><span id="l53.723">   let count = 1;</span>
<a href="#l53.724"></a><span id="l53.724" class="difflineminus">-  while (duplicateFilterNameExists(tempName))</span>
<a href="#l53.725"></a><span id="l53.725" class="difflineminus">-  {</span>
<a href="#l53.726"></a><span id="l53.726" class="difflineplus">+  while (duplicateFilterNameExists(tempName)) {</span>
<a href="#l53.727"></a><span id="l53.727">     count++;</span>
<a href="#l53.728"></a><span id="l53.728">     tempName = stub + &quot; &quot; + count;</span>
<a href="#l53.729"></a><span id="l53.729">   }</span>
<a href="#l53.730"></a><span id="l53.730">   gFilter.filterName = tempName;</span>
<a href="#l53.731"></a><span id="l53.731"> }</span>
<a href="#l53.732"></a><span id="l53.732"> </span>
<a href="#l53.733"></a><span id="l53.733" class="difflineminus">-</span>
<a href="#l53.734"></a><span id="l53.734" class="difflineminus">-function GetFirstSelectedMsgFolder()</span>
<a href="#l53.735"></a><span id="l53.735" class="difflineminus">-{</span>
<a href="#l53.736"></a><span id="l53.736" class="difflineminus">-  var selectedFolder = gActionTargetElement.getAttribute(&quot;uri&quot;);</span>
<a href="#l53.737"></a><span id="l53.737" class="difflineminus">-  if (!selectedFolder)</span>
<a href="#l53.738"></a><span id="l53.738" class="difflineminus">-    return null;</span>
<a href="#l53.739"></a><span id="l53.739" class="difflineminus">-</span>
<a href="#l53.740"></a><span id="l53.740" class="difflineminus">-  var msgFolder = MailUtils.getExistingFolder(selectedFolder);</span>
<a href="#l53.741"></a><span id="l53.741" class="difflineminus">-  return msgFolder;</span>
<a href="#l53.742"></a><span id="l53.742" class="difflineminus">-}</span>
<a href="#l53.743"></a><span id="l53.743" class="difflineminus">-</span>
<a href="#l53.744"></a><span id="l53.744" class="difflineminus">-function SearchNewFolderOkCallback(name, uri)</span>
<a href="#l53.745"></a><span id="l53.745" class="difflineminus">-{</span>
<a href="#l53.746"></a><span id="l53.746" class="difflineminus">-  var msgFolder = MailUtils.getExistingFolder(uri);</span>
<a href="#l53.747"></a><span id="l53.747" class="difflineminus">-  var imapFolder = null;</span>
<a href="#l53.748"></a><span id="l53.748" class="difflineminus">-  try</span>
<a href="#l53.749"></a><span id="l53.749" class="difflineminus">-  {</span>
<a href="#l53.750"></a><span id="l53.750" class="difflineminus">-    imapFolder = msgFolder.QueryInterface(Ci.nsIMsgImapMailFolder);</span>
<a href="#l53.751"></a><span id="l53.751" class="difflineminus">-  }</span>
<a href="#l53.752"></a><span id="l53.752" class="difflineminus">-  catch(ex) {}</span>
<a href="#l53.753"></a><span id="l53.753" class="difflineminus">-  if (imapFolder) //imapFolder creation is asynchronous.</span>
<a href="#l53.754"></a><span id="l53.754" class="difflineminus">-  {</span>
<a href="#l53.755"></a><span id="l53.755" class="difflineminus">-    if (!gSessionFolderListenerAdded) {</span>
<a href="#l53.756"></a><span id="l53.756" class="difflineminus">-      try</span>
<a href="#l53.757"></a><span id="l53.757" class="difflineminus">-      {</span>
<a href="#l53.758"></a><span id="l53.758" class="difflineminus">-        let notifyFlags = Ci.nsIFolderListener.event;</span>
<a href="#l53.759"></a><span id="l53.759" class="difflineminus">-        MailServices.mailSession.AddFolderListener(gFolderListener, notifyFlags);</span>
<a href="#l53.760"></a><span id="l53.760" class="difflineminus">-        gSessionFolderListenerAdded = true;</span>
<a href="#l53.761"></a><span id="l53.761" class="difflineminus">-      }</span>
<a href="#l53.762"></a><span id="l53.762" class="difflineminus">-      catch (ex)</span>
<a href="#l53.763"></a><span id="l53.763" class="difflineminus">-      {</span>
<a href="#l53.764"></a><span id="l53.764" class="difflineminus">-        Cu.reportError(&quot;Error adding to session: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l53.765"></a><span id="l53.765" class="difflineminus">-      }</span>
<a href="#l53.766"></a><span id="l53.766" class="difflineminus">-    }</span>
<a href="#l53.767"></a><span id="l53.767" class="difflineminus">-  }</span>
<a href="#l53.768"></a><span id="l53.768" class="difflineminus">-</span>
<a href="#l53.769"></a><span id="l53.769" class="difflineminus">-  var msgWindow = GetFilterEditorMsgWindow();</span>
<a href="#l53.770"></a><span id="l53.770" class="difflineminus">-</span>
<a href="#l53.771"></a><span id="l53.771" class="difflineminus">-  if (imapFolder)</span>
<a href="#l53.772"></a><span id="l53.772" class="difflineminus">-    SetBusyCursor(window, true);</span>
<a href="#l53.773"></a><span id="l53.773" class="difflineminus">-</span>
<a href="#l53.774"></a><span id="l53.774" class="difflineminus">-  msgFolder.createSubfolder(name, msgWindow);</span>
<a href="#l53.775"></a><span id="l53.775" class="difflineminus">-</span>
<a href="#l53.776"></a><span id="l53.776" class="difflineminus">-  if (!imapFolder)</span>
<a href="#l53.777"></a><span id="l53.777" class="difflineminus">-  {</span>
<a href="#l53.778"></a><span id="l53.778" class="difflineminus">-    var curFolder = uri+&quot;/&quot;+encodeURIComponent(name);</span>
<a href="#l53.779"></a><span id="l53.779" class="difflineminus">-    let folder = MailUtils.getOrCreateFolder(curFolder);</span>
<a href="#l53.780"></a><span id="l53.780" class="difflineminus">-    gActionTargetElement.selectFolder(folder);</span>
<a href="#l53.781"></a><span id="l53.781" class="difflineminus">-  }</span>
<a href="#l53.782"></a><span id="l53.782" class="difflineminus">-}</span>
<a href="#l53.783"></a><span id="l53.783" class="difflineminus">-</span>
<a href="#l53.784"></a><span id="l53.784" class="difflineminus">-function UpdateAfterCustomHeaderChange()</span>
<a href="#l53.785"></a><span id="l53.785" class="difflineminus">-{</span>
<a href="#l53.786"></a><span id="l53.786" class="difflineplus">+function UpdateAfterCustomHeaderChange() {</span>
<a href="#l53.787"></a><span id="l53.787">   updateSearchAttributes();</span>
<a href="#l53.788"></a><span id="l53.788"> }</span>
<a href="#l53.789"></a><span id="l53.789"> </span>
<a href="#l53.790"></a><span id="l53.790" class="difflineminus">-//if you use msgWindow, please make sure that destructor gets called when you close the &quot;window&quot;</span>
<a href="#l53.791"></a><span id="l53.791" class="difflineminus">-function GetFilterEditorMsgWindow()</span>
<a href="#l53.792"></a><span id="l53.792" class="difflineminus">-{</span>
<a href="#l53.793"></a><span id="l53.793" class="difflineminus">-  if (!gFilterEditorMsgWindow)</span>
<a href="#l53.794"></a><span id="l53.794" class="difflineminus">-  {</span>
<a href="#l53.795"></a><span id="l53.795" class="difflineplus">+// if you use msgWindow, please make sure that destructor gets called when you close the &quot;window&quot;</span>
<a href="#l53.796"></a><span id="l53.796" class="difflineplus">+function GetFilterEditorMsgWindow() {</span>
<a href="#l53.797"></a><span id="l53.797" class="difflineplus">+  if (!gFilterEditorMsgWindow) {</span>
<a href="#l53.798"></a><span id="l53.798">     var msgWindowContractID = &quot;@mozilla.org/messenger/msgwindow;1&quot;;</span>
<a href="#l53.799"></a><span id="l53.799">     var nsIMsgWindow = Ci.nsIMsgWindow;</span>
<a href="#l53.800"></a><span id="l53.800">     gFilterEditorMsgWindow = Cc[msgWindowContractID].createInstance(nsIMsgWindow);</span>
<a href="#l53.801"></a><span id="l53.801">     gFilterEditorMsgWindow.domWindow = window;</span>
<a href="#l53.802"></a><span id="l53.802">     gFilterEditorMsgWindow.rootDocShell.appType = Ci.nsIDocShell.APP_TYPE_MAIL;</span>
<a href="#l53.803"></a><span id="l53.803">   }</span>
<a href="#l53.804"></a><span id="l53.804">   return gFilterEditorMsgWindow;</span>
<a href="#l53.805"></a><span id="l53.805"> }</span>
<a href="#l53.806"></a><span id="l53.806"> </span>
<a href="#l53.807"></a><span id="l53.807" class="difflineminus">-function SetBusyCursor(window, enable)</span>
<a href="#l53.808"></a><span id="l53.808" class="difflineminus">-{</span>
<a href="#l53.809"></a><span id="l53.809" class="difflineplus">+function SetBusyCursor(window, enable) {</span>
<a href="#l53.810"></a><span id="l53.810">   // setCursor() is only available for chrome windows.</span>
<a href="#l53.811"></a><span id="l53.811">   // However one of our frames is the start page which</span>
<a href="#l53.812"></a><span id="l53.812">   // is a non-chrome window, so check if this window has a</span>
<a href="#l53.813"></a><span id="l53.813">   // setCursor method</span>
<a href="#l53.814"></a><span id="l53.814" class="difflineminus">-  if (&quot;setCursor&quot; in window)</span>
<a href="#l53.815"></a><span id="l53.815" class="difflineminus">-  {</span>
<a href="#l53.816"></a><span id="l53.816" class="difflineplus">+  if (&quot;setCursor&quot; in window) {</span>
<a href="#l53.817"></a><span id="l53.817">     if (enable)</span>
<a href="#l53.818"></a><span id="l53.818">         window.setCursor(&quot;wait&quot;);</span>
<a href="#l53.819"></a><span id="l53.819">     else</span>
<a href="#l53.820"></a><span id="l53.820">         window.setCursor(&quot;auto&quot;);</span>
<a href="#l53.821"></a><span id="l53.821">   }</span>
<a href="#l53.822"></a><span id="l53.822"> }</span>
<a href="#l53.823"></a><span id="l53.823"> </span>
<a href="#l53.824"></a><span id="l53.824" class="difflineminus">-function doHelpButton()</span>
<a href="#l53.825"></a><span id="l53.825" class="difflineminus">-{</span>
<a href="#l53.826"></a><span id="l53.826" class="difflineplus">+/* globals openHelp */// suite/components/helpviewer/content/contextHelp.js</span>
<a href="#l53.827"></a><span id="l53.827" class="difflineplus">+function doHelpButton() {</span>
<a href="#l53.828"></a><span id="l53.828">   openHelp(&quot;mail-filters&quot;);</span>
<a href="#l53.829"></a><span id="l53.829"> }</span>
<a href="#l53.830"></a><span id="l53.830"> </span>
<a href="#l53.831"></a><span id="l53.831" class="difflineminus">-function getCustomActions()</span>
<a href="#l53.832"></a><span id="l53.832" class="difflineminus">-{</span>
<a href="#l53.833"></a><span id="l53.833" class="difflineminus">-  if (!gCustomActions)</span>
<a href="#l53.834"></a><span id="l53.834" class="difflineminus">-  {</span>
<a href="#l53.835"></a><span id="l53.835" class="difflineplus">+function getCustomActions() {</span>
<a href="#l53.836"></a><span id="l53.836" class="difflineplus">+  if (!gCustomActions) {</span>
<a href="#l53.837"></a><span id="l53.837">     gCustomActions = [];</span>
<a href="#l53.838"></a><span id="l53.838">     let customActionsEnum = MailServices.filters.getCustomActions();</span>
<a href="#l53.839"></a><span id="l53.839">     while (customActionsEnum.hasMoreElements())</span>
<a href="#l53.840"></a><span id="l53.840">       gCustomActions.push(customActionsEnum.getNext().QueryInterface(</span>
<a href="#l53.841"></a><span id="l53.841">                            Ci.nsIMsgFilterCustomAction));</span>
<a href="#l53.842"></a><span id="l53.842">   }</span>
<a href="#l53.843"></a><span id="l53.843"> }</span>
<a href="#l53.844"></a><span id="l53.844"> </span>
<a href="#l53.845"></a><span id="l53.845" class="difflineminus">-function updateFilterType()</span>
<a href="#l53.846"></a><span id="l53.846" class="difflineminus">-{</span>
<a href="#l53.847"></a><span id="l53.847" class="difflineplus">+function updateFilterType() {</span>
<a href="#l53.848"></a><span id="l53.848">   gFilterType = gFilterTypeSelector.getType();</span>
<a href="#l53.849"></a><span id="l53.849">   setFilterScope(gFilterType, gFilterList);</span>
<a href="#l53.850"></a><span id="l53.850"> </span>
<a href="#l53.851"></a><span id="l53.851">   // set valid actions</span>
<a href="#l53.852"></a><span id="l53.852" class="difflineminus">-  var ruleActions = gFilterActionList.getElementsByAttribute('class', 'ruleaction');</span>
<a href="#l53.853"></a><span id="l53.853" class="difflineplus">+  var ruleActions = gFilterActionList.getElementsByAttribute(&quot;class&quot;, &quot;ruleaction&quot;);</span>
<a href="#l53.854"></a><span id="l53.854">   for (var i = 0; i &lt; ruleActions.length; i++)</span>
<a href="#l53.855"></a><span id="l53.855">     ruleActions[i].mRuleActionType.hideInvalidActions();</span>
<a href="#l53.856"></a><span id="l53.856"> }</span>
<a href="#l53.857"></a><span id="l53.857"> </span>
<a href="#l53.858"></a><span id="l53.858"> // Given a filter type, set the global search scope to the filter scope</span>
<a href="#l53.859"></a><span id="l53.859" class="difflineminus">-function setFilterScope(aFilterType, aFilterList)</span>
<a href="#l53.860"></a><span id="l53.860" class="difflineminus">-{</span>
<a href="#l53.861"></a><span id="l53.861" class="difflineplus">+function setFilterScope(aFilterType, aFilterList) {</span>
<a href="#l53.862"></a><span id="l53.862">   let filterScope = getFilterScope(getScopeFromFilterList(aFilterList),</span>
<a href="#l53.863"></a><span id="l53.863">                                    aFilterType, aFilterList);</span>
<a href="#l53.864"></a><span id="l53.864">   setSearchScope(filterScope);</span>
<a href="#l53.865"></a><span id="l53.865"> }</span>
<a href="#l53.866"></a><span id="l53.866"> </span>
<a href="#l53.867"></a><span id="l53.867"> //</span>
<a href="#l53.868"></a><span id="l53.868"> // Given the base filter scope for a server, and the filter</span>
<a href="#l53.869"></a><span id="l53.869"> // type, return the scope used for filter. This assumes a</span>
<a href="#l53.870"></a><span id="l53.870"> // hierarchy of contexts, with incoming the most restrictive,</span>
<a href="#l53.871"></a><span id="l53.871"> // followed by manual and post-plugin.</span>
<a href="#l53.872"></a><span id="l53.872" class="difflineminus">-function getFilterScope(aServerFilterScope, aFilterType, aFilterList)</span>
<a href="#l53.873"></a><span id="l53.873" class="difflineminus">-{</span>
<a href="#l53.874"></a><span id="l53.874" class="difflineplus">+function getFilterScope(aServerFilterScope, aFilterType, aFilterList) {</span>
<a href="#l53.875"></a><span id="l53.875">   if (aFilterType &amp; nsMsgFilterType.Incoming)</span>
<a href="#l53.876"></a><span id="l53.876">     return aServerFilterScope;</span>
<a href="#l53.877"></a><span id="l53.877"> </span>
<a href="#l53.878"></a><span id="l53.878">   // Manual or PostPlugin</span>
<a href="#l53.879"></a><span id="l53.879">   // local mail allows body and junk types</span>
<a href="#l53.880"></a><span id="l53.880">   if (aServerFilterScope == nsMsgSearchScope.offlineMailFilter)</span>
<a href="#l53.881"></a><span id="l53.881">     return nsMsgSearchScope.offlineMail;</span>
<a href="#l53.882"></a><span id="l53.882">   // IMAP and NEWS online don't allow body</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mailnews/base/search/content/FilterEditor.xul</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mailnews/base/search/content/FilterEditor.xul</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -17,18 +17,17 @@</span>
<a href="#l54.4"></a><span id="l54.4"> </span>
<a href="#l54.5"></a><span id="l54.5"> &lt;dialog id=&quot;FilterEditor&quot;</span>
<a href="#l54.6"></a><span id="l54.6">   xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot; xmlns:html=&quot;http://www.w3.org/1999/xhtml&quot;</span>
<a href="#l54.7"></a><span id="l54.7">   title=&quot;&amp;window.title;&quot;</span>
<a href="#l54.8"></a><span id="l54.8">   style=&quot;&amp;filterEditorDialog.dimensions;&quot;</span>
<a href="#l54.9"></a><span id="l54.9">   windowtype=&quot;mailnews:filtereditor&quot;</span>
<a href="#l54.10"></a><span id="l54.10">   persist=&quot;width height screenX screenY&quot;</span>
<a href="#l54.11"></a><span id="l54.11">   buttons=&quot;accept,cancel&quot;</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-  onload=&quot;filterEditorOnLoad();&quot;</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineminus">-  onunload=&quot;filterEditorOnUnload();&quot;&gt;</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineplus">+  onload=&quot;filterEditorOnLoad();&quot;&gt;</span>
<a href="#l54.15"></a><span id="l54.15"> </span>
<a href="#l54.16"></a><span id="l54.16">   &lt;stringbundleset id=&quot;stringbundleset&quot;&gt;</span>
<a href="#l54.17"></a><span id="l54.17">     &lt;stringbundle id=&quot;bundle_messenger&quot; src=&quot;chrome://messenger/locale/messenger.properties&quot;/&gt;</span>
<a href="#l54.18"></a><span id="l54.18">     &lt;stringbundle id=&quot;bundle_filter&quot; src=&quot;chrome://messenger/locale/filter.properties&quot;/&gt;</span>
<a href="#l54.19"></a><span id="l54.19">     &lt;stringbundle id=&quot;bundle_search&quot; src=&quot;chrome://messenger/locale/search.properties&quot;/&gt;</span>
<a href="#l54.20"></a><span id="l54.20">   &lt;/stringbundleset&gt;</span>
<a href="#l54.21"></a><span id="l54.21"> </span>
<a href="#l54.22"></a><span id="l54.22">   &lt;script type=&quot;application/javascript&quot; src=&quot;chrome://messenger/content/searchWidgets.js&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mailnews/base/search/content/searchTerm.js</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mailnews/base/search/content/searchTerm.js</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -1,49 +1,50 @@</span>
<a href="#l55.4"></a><span id="l55.4"> /* -*- Mode: Java; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l55.5"></a><span id="l55.5"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l55.6"></a><span id="l55.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l55.7"></a><span id="l55.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l55.8"></a><span id="l55.8"> </span>
<a href="#l55.9"></a><span id="l55.9" class="difflineminus">-var gTotalSearchTerms=0;</span>
<a href="#l55.10"></a><span id="l55.10" class="difflineplus">+/* import-globals-from ../../../../mail/base/content/ABSearchDialog.js */</span>
<a href="#l55.11"></a><span id="l55.11" class="difflineplus">+</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineplus">+var gTotalSearchTerms = 0;</span>
<a href="#l55.13"></a><span id="l55.13"> var gSearchTermList;</span>
<a href="#l55.14"></a><span id="l55.14" class="difflineminus">-var gSearchTerms = new Array;</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineminus">-var gSearchRemovedTerms = new Array;</span>
<a href="#l55.16"></a><span id="l55.16" class="difflineplus">+var gSearchTerms = [];</span>
<a href="#l55.17"></a><span id="l55.17" class="difflineplus">+var gSearchRemovedTerms = [];</span>
<a href="#l55.18"></a><span id="l55.18"> var gSearchScope;</span>
<a href="#l55.19"></a><span id="l55.19"> var gSearchBooleanRadiogroup;</span>
<a href="#l55.20"></a><span id="l55.20"> </span>
<a href="#l55.21"></a><span id="l55.21"> var gUniqueSearchTermCounter = 0; // gets bumped every time we add a search term so we can always</span>
<a href="#l55.22"></a><span id="l55.22">                                   // dynamically generate unique IDs for the terms.</span>
<a href="#l55.23"></a><span id="l55.23"> </span>
<a href="#l55.24"></a><span id="l55.24"> // cache these so we don't have to hit the string bundle for them</span>
<a href="#l55.25"></a><span id="l55.25"> var gMoreButtonTooltipText;</span>
<a href="#l55.26"></a><span id="l55.26"> var gLessButtonTooltipText;</span>
<a href="#l55.27"></a><span id="l55.27"> var gLoading = true;</span>
<a href="#l55.28"></a><span id="l55.28"> </span>
<a href="#l55.29"></a><span id="l55.29"> </span>
<a href="#l55.30"></a><span id="l55.30"> function searchTermContainer() {}</span>
<a href="#l55.31"></a><span id="l55.31"> </span>
<a href="#l55.32"></a><span id="l55.32"> searchTermContainer.prototype = {</span>
<a href="#l55.33"></a><span id="l55.33" class="difflineminus">-    internalSearchTerm : '',</span>
<a href="#l55.34"></a><span id="l55.34" class="difflineminus">-    internalBooleanAnd : '',</span>
<a href="#l55.35"></a><span id="l55.35" class="difflineplus">+    internalSearchTerm: &quot;&quot;,</span>
<a href="#l55.36"></a><span id="l55.36" class="difflineplus">+    internalBooleanAnd: &quot;&quot;,</span>
<a href="#l55.37"></a><span id="l55.37"> </span>
<a href="#l55.38"></a><span id="l55.38">     // this.searchTerm: the actual nsIMsgSearchTerm object</span>
<a href="#l55.39"></a><span id="l55.39">     get searchTerm() { return this.internalSearchTerm; },</span>
<a href="#l55.40"></a><span id="l55.40">     set searchTerm(val) {</span>
<a href="#l55.41"></a><span id="l55.41">         this.internalSearchTerm = val;</span>
<a href="#l55.42"></a><span id="l55.42"> </span>
<a href="#l55.43"></a><span id="l55.43">         var term = val;</span>
<a href="#l55.44"></a><span id="l55.44">         // val is a nsIMsgSearchTerm</span>
<a href="#l55.45"></a><span id="l55.45" class="difflineminus">-        var searchAttribute=this.searchattribute;</span>
<a href="#l55.46"></a><span id="l55.46" class="difflineminus">-        var searchOperator=this.searchoperator;</span>
<a href="#l55.47"></a><span id="l55.47" class="difflineminus">-        var searchValue=this.searchvalue;</span>
<a href="#l55.48"></a><span id="l55.48" class="difflineplus">+        var searchAttribute = this.searchattribute;</span>
<a href="#l55.49"></a><span id="l55.49" class="difflineplus">+        var searchOperator = this.searchoperator;</span>
<a href="#l55.50"></a><span id="l55.50" class="difflineplus">+        var searchValue = this.searchvalue;</span>
<a href="#l55.51"></a><span id="l55.51"> </span>
<a href="#l55.52"></a><span id="l55.52">         // now reflect all attributes of the searchterm into the widgets</span>
<a href="#l55.53"></a><span id="l55.53" class="difflineminus">-        if (searchAttribute)</span>
<a href="#l55.54"></a><span id="l55.54" class="difflineminus">-        {</span>
<a href="#l55.55"></a><span id="l55.55" class="difflineplus">+        if (searchAttribute) {</span>
<a href="#l55.56"></a><span id="l55.56">           // for custom, the value is the custom id, not the integer attribute</span>
<a href="#l55.57"></a><span id="l55.57">           if (term.attrib == Ci.nsMsgSearchAttrib.Custom)</span>
<a href="#l55.58"></a><span id="l55.58">             searchAttribute.value = term.customId;</span>
<a href="#l55.59"></a><span id="l55.59">           else</span>
<a href="#l55.60"></a><span id="l55.60">             searchAttribute.value = term.attrib;</span>
<a href="#l55.61"></a><span id="l55.61">         }</span>
<a href="#l55.62"></a><span id="l55.62">         if (searchOperator) searchOperator.value = val.op;</span>
<a href="#l55.63"></a><span id="l55.63">         if (searchValue) searchValue.value = term.value;</span>
<a href="#l55.64"></a><span id="l55.64" class="difflineat">@@ -56,25 +57,26 @@ searchTermContainer.prototype = {</span>
<a href="#l55.65"></a><span id="l55.65">     // searchscope - just forward to the searchattribute</span>
<a href="#l55.66"></a><span id="l55.66">     get searchScope() {</span>
<a href="#l55.67"></a><span id="l55.67">         if (this.searchattribute)</span>
<a href="#l55.68"></a><span id="l55.68">           return this.searchattribute.searchScope;</span>
<a href="#l55.69"></a><span id="l55.69">         return undefined;</span>
<a href="#l55.70"></a><span id="l55.70">     },</span>
<a href="#l55.71"></a><span id="l55.71">     set searchScope(val) {</span>
<a href="#l55.72"></a><span id="l55.72">         var searchAttribute = this.searchattribute;</span>
<a href="#l55.73"></a><span id="l55.73" class="difflineminus">-        if (searchAttribute) searchAttribute.searchScope=val;</span>
<a href="#l55.74"></a><span id="l55.74" class="difflineplus">+        if (searchAttribute)</span>
<a href="#l55.75"></a><span id="l55.75" class="difflineplus">+          searchAttribute.searchScope = val;</span>
<a href="#l55.76"></a><span id="l55.76">         return val;</span>
<a href="#l55.77"></a><span id="l55.77">     },</span>
<a href="#l55.78"></a><span id="l55.78"> </span>
<a href="#l55.79"></a><span id="l55.79" class="difflineminus">-    saveId: function (element, slot) {</span>
<a href="#l55.80"></a><span id="l55.80" class="difflineplus">+    saveId(element, slot) {</span>
<a href="#l55.81"></a><span id="l55.81">         this[slot] = element.id;</span>
<a href="#l55.82"></a><span id="l55.82">     },</span>
<a href="#l55.83"></a><span id="l55.83"> </span>
<a href="#l55.84"></a><span id="l55.84" class="difflineminus">-    getElement: function (slot) {</span>
<a href="#l55.85"></a><span id="l55.85" class="difflineplus">+    getElement(slot) {</span>
<a href="#l55.86"></a><span id="l55.86">         return document.getElementById(this[slot]);</span>
<a href="#l55.87"></a><span id="l55.87">     },</span>
<a href="#l55.88"></a><span id="l55.88"> </span>
<a href="#l55.89"></a><span id="l55.89">     // three well-defined properties:</span>
<a href="#l55.90"></a><span id="l55.90">     // searchattribute, searchoperator, searchvalue</span>
<a href="#l55.91"></a><span id="l55.91">     // the trick going on here is that we're storing the Element's Id,</span>
<a href="#l55.92"></a><span id="l55.92">     // not the element itself, because the XBL object may change out</span>
<a href="#l55.93"></a><span id="l55.93">     // from underneath us</span>
<a href="#l55.94"></a><span id="l55.94" class="difflineat">@@ -96,146 +98,139 @@ searchTermContainer.prototype = {</span>
<a href="#l55.95"></a><span id="l55.95"> </span>
<a href="#l55.96"></a><span id="l55.96">     booleanNodes: null,</span>
<a href="#l55.97"></a><span id="l55.97">     get booleanAnd() { return this.internalBooleanAnd; },</span>
<a href="#l55.98"></a><span id="l55.98">     set booleanAnd(val) {</span>
<a href="#l55.99"></a><span id="l55.99">         this.internalBooleanAnd = val;</span>
<a href="#l55.100"></a><span id="l55.100">         return val;</span>
<a href="#l55.101"></a><span id="l55.101">     },</span>
<a href="#l55.102"></a><span id="l55.102"> </span>
<a href="#l55.103"></a><span id="l55.103" class="difflineminus">-    save: function () {</span>
<a href="#l55.104"></a><span id="l55.104" class="difflineplus">+    save() {</span>
<a href="#l55.105"></a><span id="l55.105">         var searchTerm = this.searchTerm;</span>
<a href="#l55.106"></a><span id="l55.106">         var nsMsgSearchAttrib = Ci.nsMsgSearchAttrib;</span>
<a href="#l55.107"></a><span id="l55.107"> </span>
<a href="#l55.108"></a><span id="l55.108" class="difflineminus">-        if (isNaN(this.searchattribute.value)) // is this a custom term?</span>
<a href="#l55.109"></a><span id="l55.109" class="difflineminus">-        {</span>
<a href="#l55.110"></a><span id="l55.110" class="difflineplus">+        if (isNaN(this.searchattribute.value)) { // is this a custom term?</span>
<a href="#l55.111"></a><span id="l55.111">           searchTerm.attrib = nsMsgSearchAttrib.Custom;</span>
<a href="#l55.112"></a><span id="l55.112">           searchTerm.customId = this.searchattribute.value;</span>
<a href="#l55.113"></a><span id="l55.113" class="difflineminus">-        }</span>
<a href="#l55.114"></a><span id="l55.114" class="difflineminus">-        else</span>
<a href="#l55.115"></a><span id="l55.115" class="difflineminus">-        {</span>
<a href="#l55.116"></a><span id="l55.116" class="difflineplus">+        } else {</span>
<a href="#l55.117"></a><span id="l55.117">           searchTerm.attrib = this.searchattribute.value;</span>
<a href="#l55.118"></a><span id="l55.118">         }</span>
<a href="#l55.119"></a><span id="l55.119"> </span>
<a href="#l55.120"></a><span id="l55.120">         if (this.searchattribute.value &gt; nsMsgSearchAttrib.OtherHeader &amp;&amp; this.searchattribute.value &lt; nsMsgSearchAttrib.kNumMsgSearchAttributes)</span>
<a href="#l55.121"></a><span id="l55.121">           searchTerm.arbitraryHeader = this.searchattribute.label;</span>
<a href="#l55.122"></a><span id="l55.122">         searchTerm.op = this.searchoperator.value;</span>
<a href="#l55.123"></a><span id="l55.123">         if (this.searchvalue.value)</span>
<a href="#l55.124"></a><span id="l55.124">             this.searchvalue.save();</span>
<a href="#l55.125"></a><span id="l55.125">         else</span>
<a href="#l55.126"></a><span id="l55.126">             this.searchvalue.saveTo(searchTerm.value);</span>
<a href="#l55.127"></a><span id="l55.127">         searchTerm.value = this.searchvalue.value;</span>
<a href="#l55.128"></a><span id="l55.128">         searchTerm.booleanAnd = this.booleanAnd;</span>
<a href="#l55.129"></a><span id="l55.129">         searchTerm.matchAll = this.matchAll;</span>
<a href="#l55.130"></a><span id="l55.130">     },</span>
<a href="#l55.131"></a><span id="l55.131">     // if you have a search term element with no search term</span>
<a href="#l55.132"></a><span id="l55.132" class="difflineminus">-    saveTo: function(searchTerm) {</span>
<a href="#l55.133"></a><span id="l55.133" class="difflineplus">+    saveTo(searchTerm) {</span>
<a href="#l55.134"></a><span id="l55.134">         this.internalSearchTerm = searchTerm;</span>
<a href="#l55.135"></a><span id="l55.135">         this.save();</span>
<a href="#l55.136"></a><span id="l55.136" class="difflineminus">-    }</span>
<a href="#l55.137"></a><span id="l55.137" class="difflineminus">-}</span>
<a href="#l55.138"></a><span id="l55.138" class="difflineplus">+    },</span>
<a href="#l55.139"></a><span id="l55.139" class="difflineplus">+};</span>
<a href="#l55.140"></a><span id="l55.140"> </span>
<a href="#l55.141"></a><span id="l55.141"> var nsIMsgSearchTerm = Ci.nsIMsgSearchTerm;</span>
<a href="#l55.142"></a><span id="l55.142"> </span>
<a href="#l55.143"></a><span id="l55.143" class="difflineminus">-function initializeSearchWidgets()</span>
<a href="#l55.144"></a><span id="l55.144" class="difflineminus">-{</span>
<a href="#l55.145"></a><span id="l55.145" class="difflineplus">+function initializeSearchWidgets() {</span>
<a href="#l55.146"></a><span id="l55.146">     gSearchBooleanRadiogroup = document.getElementById(&quot;booleanAndGroup&quot;);</span>
<a href="#l55.147"></a><span id="l55.147">     gSearchTermList = document.getElementById(&quot;searchTermList&quot;);</span>
<a href="#l55.148"></a><span id="l55.148"> </span>
<a href="#l55.149"></a><span id="l55.149">     // initialize some strings</span>
<a href="#l55.150"></a><span id="l55.150" class="difflineminus">-    var bundle = document.getElementById('bundle_search');</span>
<a href="#l55.151"></a><span id="l55.151" class="difflineminus">-    gMoreButtonTooltipText = bundle.getString('moreButtonTooltipText');</span>
<a href="#l55.152"></a><span id="l55.152" class="difflineminus">-    gLessButtonTooltipText = bundle.getString('lessButtonTooltipText');</span>
<a href="#l55.153"></a><span id="l55.153" class="difflineplus">+    var bundle = document.getElementById(&quot;bundle_search&quot;);</span>
<a href="#l55.154"></a><span id="l55.154" class="difflineplus">+    gMoreButtonTooltipText = bundle.getString(&quot;moreButtonTooltipText&quot;);</span>
<a href="#l55.155"></a><span id="l55.155" class="difflineplus">+    gLessButtonTooltipText = bundle.getString(&quot;lessButtonTooltipText&quot;);</span>
<a href="#l55.156"></a><span id="l55.156"> }</span>
<a href="#l55.157"></a><span id="l55.157"> </span>
<a href="#l55.158"></a><span id="l55.158" class="difflineminus">-function initializeBooleanWidgets()</span>
<a href="#l55.159"></a><span id="l55.159" class="difflineminus">-{</span>
<a href="#l55.160"></a><span id="l55.160" class="difflineplus">+function initializeBooleanWidgets() {</span>
<a href="#l55.161"></a><span id="l55.161">     var booleanAnd = true;</span>
<a href="#l55.162"></a><span id="l55.162">     var matchAll = false;</span>
<a href="#l55.163"></a><span id="l55.163">     // get the boolean value from the first term</span>
<a href="#l55.164"></a><span id="l55.164">     var firstTerm = gSearchTerms[0].searchTerm;</span>
<a href="#l55.165"></a><span id="l55.165" class="difflineminus">-    if (firstTerm)</span>
<a href="#l55.166"></a><span id="l55.166" class="difflineminus">-    {</span>
<a href="#l55.167"></a><span id="l55.167" class="difflineplus">+    if (firstTerm) {</span>
<a href="#l55.168"></a><span id="l55.168">         // If there is a second term, it should actually define whether we're</span>
<a href="#l55.169"></a><span id="l55.169">         //  using 'and' or not.  Note that our UI is not as rich as the</span>
<a href="#l55.170"></a><span id="l55.170">         //  underlying search model, so there's the potential to lose here when</span>
<a href="#l55.171"></a><span id="l55.171">         //  grouping is involved.</span>
<a href="#l55.172"></a><span id="l55.172">         booleanAnd = (gSearchTerms.length &gt; 1) ?</span>
<a href="#l55.173"></a><span id="l55.173">             gSearchTerms[1].searchTerm.booleanAnd : firstTerm.booleanAnd;</span>
<a href="#l55.174"></a><span id="l55.174">         matchAll = firstTerm.matchAll;</span>
<a href="#l55.175"></a><span id="l55.175">     }</span>
<a href="#l55.176"></a><span id="l55.176">     // target radio items have value=&quot;and&quot; or value=&quot;or&quot; or &quot;all&quot;</span>
<a href="#l55.177"></a><span id="l55.177" class="difflineminus">-    gSearchBooleanRadiogroup.value = matchAll</span>
<a href="#l55.178"></a><span id="l55.178" class="difflineminus">-      ? &quot;matchAll&quot;</span>
<a href="#l55.179"></a><span id="l55.179" class="difflineminus">-      : (booleanAnd ? &quot;and&quot; : &quot;or&quot;)</span>
<a href="#l55.180"></a><span id="l55.180" class="difflineplus">+    if (matchAll) {</span>
<a href="#l55.181"></a><span id="l55.181" class="difflineplus">+      gSearchBooleanRadiogroup.value = &quot;matchAll&quot;;</span>
<a href="#l55.182"></a><span id="l55.182" class="difflineplus">+    } else if (booleanAnd) {</span>
<a href="#l55.183"></a><span id="l55.183" class="difflineplus">+      gSearchBooleanRadiogroup.value = &quot;and&quot;;</span>
<a href="#l55.184"></a><span id="l55.184" class="difflineplus">+    } else {</span>
<a href="#l55.185"></a><span id="l55.185" class="difflineplus">+      gSearchBooleanRadiogroup.value = &quot;or&quot;;</span>
<a href="#l55.186"></a><span id="l55.186" class="difflineplus">+    }</span>
<a href="#l55.187"></a><span id="l55.187">     var searchTerms = document.getElementById(&quot;searchTermList&quot;);</span>
<a href="#l55.188"></a><span id="l55.188">     if (searchTerms)</span>
<a href="#l55.189"></a><span id="l55.189">       updateSearchTermsListbox(matchAll);</span>
<a href="#l55.190"></a><span id="l55.190"> }</span>
<a href="#l55.191"></a><span id="l55.191"> </span>
<a href="#l55.192"></a><span id="l55.192" class="difflineminus">-function initializeSearchRows(scope, searchTerms)</span>
<a href="#l55.193"></a><span id="l55.193" class="difflineminus">-{</span>
<a href="#l55.194"></a><span id="l55.194" class="difflineplus">+function initializeSearchRows(scope, searchTerms) {</span>
<a href="#l55.195"></a><span id="l55.195">     for (let i = 0; i &lt; searchTerms.length; i++) {</span>
<a href="#l55.196"></a><span id="l55.196">         let searchTerm = searchTerms.queryElementAt(i, nsIMsgSearchTerm);</span>
<a href="#l55.197"></a><span id="l55.197">         createSearchRow(i, scope, searchTerm, false);</span>
<a href="#l55.198"></a><span id="l55.198">         gTotalSearchTerms++;</span>
<a href="#l55.199"></a><span id="l55.199">     }</span>
<a href="#l55.200"></a><span id="l55.200">     initializeBooleanWidgets();</span>
<a href="#l55.201"></a><span id="l55.201">     updateRemoveRowButton();</span>
<a href="#l55.202"></a><span id="l55.202"> }</span>
<a href="#l55.203"></a><span id="l55.203"> </span>
<a href="#l55.204"></a><span id="l55.204"> /**</span>
<a href="#l55.205"></a><span id="l55.205">  * Enables/disables all the visible elements inside the search terms listbox.</span>
<a href="#l55.206"></a><span id="l55.206">  *</span>
<a href="#l55.207"></a><span id="l55.207">  * @param matchAllValue boolean value from the first search term</span>
<a href="#l55.208"></a><span id="l55.208">  */</span>
<a href="#l55.209"></a><span id="l55.209" class="difflineminus">-function updateSearchTermsListbox(matchAllValue)</span>
<a href="#l55.210"></a><span id="l55.210" class="difflineminus">-{</span>
<a href="#l55.211"></a><span id="l55.211" class="difflineplus">+function updateSearchTermsListbox(matchAllValue) {</span>
<a href="#l55.212"></a><span id="l55.212">   var searchTerms = document.getElementById(&quot;searchTermList&quot;);</span>
<a href="#l55.213"></a><span id="l55.213">   searchTerms.setAttribute(&quot;disabled&quot;, matchAllValue);</span>
<a href="#l55.214"></a><span id="l55.214">   var searchAttributeList = searchTerms.getElementsByTagName(&quot;search-attribute&quot;);</span>
<a href="#l55.215"></a><span id="l55.215">   var searchOperatorList = searchTerms.getElementsByTagName(&quot;search-operator&quot;);</span>
<a href="#l55.216"></a><span id="l55.216">   var searchValueList = searchTerms.getElementsByTagName(&quot;search-value&quot;);</span>
<a href="#l55.217"></a><span id="l55.217" class="difflineminus">-  for (var i = 0; i &lt; searchAttributeList.length; i++) {</span>
<a href="#l55.218"></a><span id="l55.218" class="difflineplus">+  for (let i = 0; i &lt; searchAttributeList.length; i++) {</span>
<a href="#l55.219"></a><span id="l55.219">       searchAttributeList[i].setAttribute(&quot;disabled&quot;, matchAllValue);</span>
<a href="#l55.220"></a><span id="l55.220">       searchOperatorList[i].setAttribute(&quot;disabled&quot;, matchAllValue);</span>
<a href="#l55.221"></a><span id="l55.221">       searchValueList[i].setAttribute(&quot;disabled&quot;, matchAllValue);</span>
<a href="#l55.222"></a><span id="l55.222">       if (!matchAllValue)</span>
<a href="#l55.223"></a><span id="l55.223">         searchValueList[i].removeAttribute(&quot;disabled&quot;);</span>
<a href="#l55.224"></a><span id="l55.224">   }</span>
<a href="#l55.225"></a><span id="l55.225">   var moreOrLessButtonsList = searchTerms.getElementsByTagName(&quot;button&quot;);</span>
<a href="#l55.226"></a><span id="l55.226" class="difflineminus">-  for (var i = 0; i &lt; moreOrLessButtonsList.length; i++) {</span>
<a href="#l55.227"></a><span id="l55.227" class="difflineplus">+  for (let i = 0; i &lt; moreOrLessButtonsList.length; i++) {</span>
<a href="#l55.228"></a><span id="l55.228">       moreOrLessButtonsList[i].setAttribute(&quot;disabled&quot;, matchAllValue);</span>
<a href="#l55.229"></a><span id="l55.229">   }</span>
<a href="#l55.230"></a><span id="l55.230">   if (!matchAllValue)</span>
<a href="#l55.231"></a><span id="l55.231">     updateRemoveRowButton();</span>
<a href="#l55.232"></a><span id="l55.232"> }</span>
<a href="#l55.233"></a><span id="l55.233"> </span>
<a href="#l55.234"></a><span id="l55.234"> // enables/disables the less button for the first row of search terms.</span>
<a href="#l55.235"></a><span id="l55.235" class="difflineminus">-function updateRemoveRowButton()</span>
<a href="#l55.236"></a><span id="l55.236" class="difflineminus">-{</span>
<a href="#l55.237"></a><span id="l55.237" class="difflineplus">+function updateRemoveRowButton() {</span>
<a href="#l55.238"></a><span id="l55.238">   var firstListItem = gSearchTermList.getItemAtIndex(0);</span>
<a href="#l55.239"></a><span id="l55.239">   if (firstListItem)</span>
<a href="#l55.240"></a><span id="l55.240">     firstListItem.lastChild.lastChild.setAttribute(&quot;disabled&quot;, gTotalSearchTerms == 1);</span>
<a href="#l55.241"></a><span id="l55.241"> }</span>
<a href="#l55.242"></a><span id="l55.242"> </span>
<a href="#l55.243"></a><span id="l55.243"> // Returns the actual list item row index in the list of search rows</span>
<a href="#l55.244"></a><span id="l55.244"> // that contains the passed in element id.</span>
<a href="#l55.245"></a><span id="l55.245" class="difflineminus">-function getSearchRowIndexForElement(aElement)</span>
<a href="#l55.246"></a><span id="l55.246" class="difflineminus">-{</span>
<a href="#l55.247"></a><span id="l55.247" class="difflineplus">+function getSearchRowIndexForElement(aElement) {</span>
<a href="#l55.248"></a><span id="l55.248">   var listItem = aElement;</span>
<a href="#l55.249"></a><span id="l55.249"> </span>
<a href="#l55.250"></a><span id="l55.250">   while (listItem &amp;&amp; listItem.localName != &quot;richlistitem&quot;)</span>
<a href="#l55.251"></a><span id="l55.251">     listItem = listItem.parentNode;</span>
<a href="#l55.252"></a><span id="l55.252"> </span>
<a href="#l55.253"></a><span id="l55.253">   return gSearchTermList.getIndexOfItem(listItem);</span>
<a href="#l55.254"></a><span id="l55.254"> }</span>
<a href="#l55.255"></a><span id="l55.255"> </span>
<a href="#l55.256"></a><span id="l55.256" class="difflineminus">-function onMore(event)</span>
<a href="#l55.257"></a><span id="l55.257" class="difflineminus">-{</span>
<a href="#l55.258"></a><span id="l55.258" class="difflineplus">+function onMore(event) {</span>
<a href="#l55.259"></a><span id="l55.259">   // if we have an event, extract the list row index and use that as the row number</span>
<a href="#l55.260"></a><span id="l55.260">   // for our insertion point. If there is no event, append to the end....</span>
<a href="#l55.261"></a><span id="l55.261">   var rowIndex;</span>
<a href="#l55.262"></a><span id="l55.262"> </span>
<a href="#l55.263"></a><span id="l55.263">   if (event)</span>
<a href="#l55.264"></a><span id="l55.264">     rowIndex = getSearchRowIndexForElement(event.target) + 1;</span>
<a href="#l55.265"></a><span id="l55.265">   else</span>
<a href="#l55.266"></a><span id="l55.266">     rowIndex = gSearchTermList.getRowCount();</span>
<a href="#l55.267"></a><span id="l55.267" class="difflineat">@@ -243,101 +238,93 @@ function onMore(event)</span>
<a href="#l55.268"></a><span id="l55.268">   createSearchRow(rowIndex, gSearchScope, null, event != null);</span>
<a href="#l55.269"></a><span id="l55.269">   gTotalSearchTerms++;</span>
<a href="#l55.270"></a><span id="l55.270">   updateRemoveRowButton();</span>
<a href="#l55.271"></a><span id="l55.271"> </span>
<a href="#l55.272"></a><span id="l55.272">   // the user just added a term, so scroll to it</span>
<a href="#l55.273"></a><span id="l55.273">   gSearchTermList.ensureIndexIsVisible(rowIndex);</span>
<a href="#l55.274"></a><span id="l55.274"> }</span>
<a href="#l55.275"></a><span id="l55.275"> </span>
<a href="#l55.276"></a><span id="l55.276" class="difflineminus">-function onLess(event)</span>
<a href="#l55.277"></a><span id="l55.277" class="difflineminus">-{</span>
<a href="#l55.278"></a><span id="l55.278" class="difflineminus">-  if (event &amp;&amp; gTotalSearchTerms &gt; 1)</span>
<a href="#l55.279"></a><span id="l55.279" class="difflineminus">-  {</span>
<a href="#l55.280"></a><span id="l55.280" class="difflineplus">+function onLess(event) {</span>
<a href="#l55.281"></a><span id="l55.281" class="difflineplus">+  if (event &amp;&amp; gTotalSearchTerms &gt; 1) {</span>
<a href="#l55.282"></a><span id="l55.282">     removeSearchRow(getSearchRowIndexForElement(event.target));</span>
<a href="#l55.283"></a><span id="l55.283">     --gTotalSearchTerms;</span>
<a href="#l55.284"></a><span id="l55.284">   }</span>
<a href="#l55.285"></a><span id="l55.285"> </span>
<a href="#l55.286"></a><span id="l55.286">   updateRemoveRowButton();</span>
<a href="#l55.287"></a><span id="l55.287"> }</span>
<a href="#l55.288"></a><span id="l55.288"> </span>
<a href="#l55.289"></a><span id="l55.289"> // set scope on all visible searchattribute tags</span>
<a href="#l55.290"></a><span id="l55.290" class="difflineminus">-function setSearchScope(scope)</span>
<a href="#l55.291"></a><span id="l55.291" class="difflineminus">-{</span>
<a href="#l55.292"></a><span id="l55.292" class="difflineplus">+function setSearchScope(scope) {</span>
<a href="#l55.293"></a><span id="l55.293">   gSearchScope = scope;</span>
<a href="#l55.294"></a><span id="l55.294" class="difflineminus">-  for (var i = 0; i &lt; gSearchTerms.length; i++)</span>
<a href="#l55.295"></a><span id="l55.295" class="difflineminus">-  {</span>
<a href="#l55.296"></a><span id="l55.296" class="difflineplus">+  for (var i = 0; i &lt; gSearchTerms.length; i++) {</span>
<a href="#l55.297"></a><span id="l55.297">     // don't set element attributes if XBL hasn't loaded</span>
<a href="#l55.298"></a><span id="l55.298" class="difflineminus">-    if (!(gSearchTerms[i].obj.searchattribute.searchScope === undefined))</span>
<a href="#l55.299"></a><span id="l55.299" class="difflineminus">-    {</span>
<a href="#l55.300"></a><span id="l55.300" class="difflineplus">+    if (!(gSearchTerms[i].obj.searchattribute.searchScope === undefined)) {</span>
<a href="#l55.301"></a><span id="l55.301">       gSearchTerms[i].obj.searchattribute.searchScope = scope;</span>
<a href="#l55.302"></a><span id="l55.302">       // act like the user &quot;selected&quot; this, see bug #202848</span>
<a href="#l55.303"></a><span id="l55.303">       gSearchTerms[i].obj.searchattribute.onSelect(null /* no event */);</span>
<a href="#l55.304"></a><span id="l55.304">     }</span>
<a href="#l55.305"></a><span id="l55.305">     gSearchTerms[i].scope = scope;</span>
<a href="#l55.306"></a><span id="l55.306">   }</span>
<a href="#l55.307"></a><span id="l55.307"> }</span>
<a href="#l55.308"></a><span id="l55.308"> </span>
<a href="#l55.309"></a><span id="l55.309" class="difflineminus">-function updateSearchAttributes()</span>
<a href="#l55.310"></a><span id="l55.310" class="difflineminus">-{</span>
<a href="#l55.311"></a><span id="l55.311" class="difflineminus">-    for (var i=0; i&lt;gSearchTerms.length; i++)</span>
<a href="#l55.312"></a><span id="l55.312" class="difflineplus">+function updateSearchAttributes() {</span>
<a href="#l55.313"></a><span id="l55.313" class="difflineplus">+    for (var i = 0; i &lt; gSearchTerms.length; i++)</span>
<a href="#l55.314"></a><span id="l55.314">         gSearchTerms[i].obj.searchattribute.refreshList();</span>
<a href="#l55.315"></a><span id="l55.315">     }</span>
<a href="#l55.316"></a><span id="l55.316"> </span>
<a href="#l55.317"></a><span id="l55.317"> function booleanChanged(event) {</span>
<a href="#l55.318"></a><span id="l55.318">     // when boolean changes, we have to update all the attributes on the search terms</span>
<a href="#l55.319"></a><span id="l55.319">     var newBoolValue = (event.target.getAttribute(&quot;value&quot;) == &quot;and&quot;);</span>
<a href="#l55.320"></a><span id="l55.320">     var matchAllValue = (event.target.getAttribute(&quot;value&quot;) == &quot;matchAll&quot;);</span>
<a href="#l55.321"></a><span id="l55.321">     if (document.getElementById(&quot;abPopup&quot;)) {</span>
<a href="#l55.322"></a><span id="l55.322">       var selectedAB = document.getElementById(&quot;abPopup&quot;).selectedItem.value;</span>
<a href="#l55.323"></a><span id="l55.323">       setSearchScope(GetScopeForDirectoryURI(selectedAB));</span>
<a href="#l55.324"></a><span id="l55.324">     }</span>
<a href="#l55.325"></a><span id="l55.325" class="difflineminus">-    for (var i=0; i&lt;gSearchTerms.length; i++) {</span>
<a href="#l55.326"></a><span id="l55.326" class="difflineplus">+    for (var i = 0; i &lt; gSearchTerms.length; i++) {</span>
<a href="#l55.327"></a><span id="l55.327">         let searchTerm = gSearchTerms[i].obj;</span>
<a href="#l55.328"></a><span id="l55.328">         // If term is not yet initialized in the UI, change the original object.</span>
<a href="#l55.329"></a><span id="l55.329">         if (!searchTerm || !gSearchTerms[i].initialized)</span>
<a href="#l55.330"></a><span id="l55.330">             searchTerm = gSearchTerms[i].searchTerm;</span>
<a href="#l55.331"></a><span id="l55.331"> </span>
<a href="#l55.332"></a><span id="l55.332">         searchTerm.booleanAnd = newBoolValue;</span>
<a href="#l55.333"></a><span id="l55.333">         searchTerm.matchAll = matchAllValue;</span>
<a href="#l55.334"></a><span id="l55.334">     }</span>
<a href="#l55.335"></a><span id="l55.335">     var searchTerms = document.getElementById(&quot;searchTermList&quot;);</span>
<a href="#l55.336"></a><span id="l55.336" class="difflineminus">-    if (searchTerms)</span>
<a href="#l55.337"></a><span id="l55.337" class="difflineminus">-    {</span>
<a href="#l55.338"></a><span id="l55.338" class="difflineplus">+    if (searchTerms) {</span>
<a href="#l55.339"></a><span id="l55.339">       if (!matchAllValue &amp;&amp; searchTerms.hidden &amp;&amp; !gTotalSearchTerms)</span>
<a href="#l55.340"></a><span id="l55.340">         onMore(null); // fake to get empty row.</span>
<a href="#l55.341"></a><span id="l55.341">       updateSearchTermsListbox(matchAllValue);</span>
<a href="#l55.342"></a><span id="l55.342">     }</span>
<a href="#l55.343"></a><span id="l55.343"> }</span>
<a href="#l55.344"></a><span id="l55.344"> </span>
<a href="#l55.345"></a><span id="l55.345"> /**</span>
<a href="#l55.346"></a><span id="l55.346">  * Create a new search row with all the needed elements.</span>
<a href="#l55.347"></a><span id="l55.347">  *</span>
<a href="#l55.348"></a><span id="l55.348">  * @param index       index of the position in the menulist where to add the row</span>
<a href="#l55.349"></a><span id="l55.349">  * @param scope       a nsMsgSearchScope constant indicating scope of this search rule</span>
<a href="#l55.350"></a><span id="l55.350">  * @param searchTerm  nsIMsgSearchTerm object to hold the search term</span>
<a href="#l55.351"></a><span id="l55.351">  * @param aUserAdded  boolean indicating if the row addition was initiated by the user</span>
<a href="#l55.352"></a><span id="l55.352">  *                    (e.g. via the '+' button)</span>
<a href="#l55.353"></a><span id="l55.353">  */</span>
<a href="#l55.354"></a><span id="l55.354" class="difflineminus">-function createSearchRow(index, scope, searchTerm, aUserAdded)</span>
<a href="#l55.355"></a><span id="l55.355" class="difflineminus">-{</span>
<a href="#l55.356"></a><span id="l55.356" class="difflineplus">+function createSearchRow(index, scope, searchTerm, aUserAdded) {</span>
<a href="#l55.357"></a><span id="l55.357">     var searchAttr = document.createElement(&quot;search-attribute&quot;);</span>
<a href="#l55.358"></a><span id="l55.358">     var searchOp = document.createElement(&quot;search-operator&quot;);</span>
<a href="#l55.359"></a><span id="l55.359">     var searchVal = document.createElement(&quot;search-value&quot;);</span>
<a href="#l55.360"></a><span id="l55.360"> </span>
<a href="#l55.361"></a><span id="l55.361">     var moreButton = document.createElement(&quot;button&quot;);</span>
<a href="#l55.362"></a><span id="l55.362">     var lessButton = document.createElement(&quot;button&quot;);</span>
<a href="#l55.363"></a><span id="l55.363">     moreButton.setAttribute(&quot;class&quot;, &quot;small-button&quot;);</span>
<a href="#l55.364"></a><span id="l55.364">     moreButton.setAttribute(&quot;oncommand&quot;, &quot;onMore(event);&quot;);</span>
<a href="#l55.365"></a><span id="l55.365" class="difflineminus">-    moreButton.setAttribute('label', '+');</span>
<a href="#l55.366"></a><span id="l55.366" class="difflineminus">-    moreButton.setAttribute('tooltiptext', gMoreButtonTooltipText);</span>
<a href="#l55.367"></a><span id="l55.367" class="difflineplus">+    moreButton.setAttribute(&quot;label&quot;, &quot;+&quot;);</span>
<a href="#l55.368"></a><span id="l55.368" class="difflineplus">+    moreButton.setAttribute(&quot;tooltiptext&quot;, gMoreButtonTooltipText);</span>
<a href="#l55.369"></a><span id="l55.369">     lessButton.setAttribute(&quot;class&quot;, &quot;small-button&quot;);</span>
<a href="#l55.370"></a><span id="l55.370">     lessButton.setAttribute(&quot;oncommand&quot;, &quot;onLess(event);&quot;);</span>
<a href="#l55.371"></a><span id="l55.371" class="difflineminus">-    lessButton.setAttribute('label', '\u2212');</span>
<a href="#l55.372"></a><span id="l55.372" class="difflineminus">-    lessButton.setAttribute('tooltiptext', gLessButtonTooltipText);</span>
<a href="#l55.373"></a><span id="l55.373" class="difflineplus">+    lessButton.setAttribute(&quot;label&quot;, &quot;\u2212&quot;);</span>
<a href="#l55.374"></a><span id="l55.374" class="difflineplus">+    lessButton.setAttribute(&quot;tooltiptext&quot;, gLessButtonTooltipText);</span>
<a href="#l55.375"></a><span id="l55.375"> </span>
<a href="#l55.376"></a><span id="l55.376">     // now set up ids:</span>
<a href="#l55.377"></a><span id="l55.377">     searchAttr.id = &quot;searchAttr&quot; + gUniqueSearchTermCounter;</span>
<a href="#l55.378"></a><span id="l55.378">     searchOp.id  = &quot;searchOp&quot; + gUniqueSearchTermCounter;</span>
<a href="#l55.379"></a><span id="l55.379">     searchVal.id = &quot;searchVal&quot; + gUniqueSearchTermCounter;</span>
<a href="#l55.380"></a><span id="l55.380"> </span>
<a href="#l55.381"></a><span id="l55.381">     searchAttr.setAttribute(&quot;for&quot;, searchOp.id + &quot;,&quot; + searchVal.id);</span>
<a href="#l55.382"></a><span id="l55.382">     searchOp.setAttribute(&quot;opfor&quot;, searchVal.id);</span>
<a href="#l55.383"></a><span id="l55.383" class="difflineat">@@ -348,71 +335,63 @@ function createSearchRow(index, scope, s</span>
<a href="#l55.384"></a><span id="l55.384">     searchrow.id = &quot;searchRow&quot; + gUniqueSearchTermCounter;</span>
<a href="#l55.385"></a><span id="l55.385"> </span>
<a href="#l55.386"></a><span id="l55.386">     var searchTermObj = new searchTermContainer;</span>
<a href="#l55.387"></a><span id="l55.387">     searchTermObj.searchattribute = searchAttr;</span>
<a href="#l55.388"></a><span id="l55.388">     searchTermObj.searchoperator = searchOp;</span>
<a href="#l55.389"></a><span id="l55.389">     searchTermObj.searchvalue = searchVal;</span>
<a href="#l55.390"></a><span id="l55.390"> </span>
<a href="#l55.391"></a><span id="l55.391">     // now insert the new search term into our list of terms</span>
<a href="#l55.392"></a><span id="l55.392" class="difflineminus">-    gSearchTerms.splice(index, 0, {obj:searchTermObj, scope:scope, searchTerm:searchTerm, initialized:false});</span>
<a href="#l55.393"></a><span id="l55.393" class="difflineplus">+    gSearchTerms.splice(index, 0, {obj: searchTermObj, scope, searchTerm, initialized: false});</span>
<a href="#l55.394"></a><span id="l55.394"> </span>
<a href="#l55.395"></a><span id="l55.395" class="difflineminus">-    var editFilter = null;</span>
<a href="#l55.396"></a><span id="l55.396" class="difflineminus">-    try { editFilter = gFilter; } catch(e) { }</span>
<a href="#l55.397"></a><span id="l55.397" class="difflineminus">-</span>
<a href="#l55.398"></a><span id="l55.398" class="difflineminus">-    var editMailView = null;</span>
<a href="#l55.399"></a><span id="l55.399" class="difflineminus">-    try { editMailView = gMailView; } catch(e) { }</span>
<a href="#l55.400"></a><span id="l55.400" class="difflineplus">+    var editFilter = window.gFilter || null;</span>
<a href="#l55.401"></a><span id="l55.401" class="difflineplus">+    var editMailView = window.gMailView || null;</span>
<a href="#l55.402"></a><span id="l55.402"> </span>
<a href="#l55.403"></a><span id="l55.403">     if ((!editFilter &amp;&amp; !editMailView) ||</span>
<a href="#l55.404"></a><span id="l55.404">         (editFilter &amp;&amp; index == gTotalSearchTerms) ||</span>
<a href="#l55.405"></a><span id="l55.405">         (editMailView &amp;&amp; index == gTotalSearchTerms))</span>
<a href="#l55.406"></a><span id="l55.406">       gLoading = false;</span>
<a href="#l55.407"></a><span id="l55.407"> </span>
<a href="#l55.408"></a><span id="l55.408">     // index is index of new row</span>
<a href="#l55.409"></a><span id="l55.409">     // gTotalSearchTerms has not been updated yet</span>
<a href="#l55.410"></a><span id="l55.410">     if (gLoading || index == gTotalSearchTerms) {</span>
<a href="#l55.411"></a><span id="l55.411">       gSearchTermList.appendChild(searchrow);</span>
<a href="#l55.412"></a><span id="l55.412" class="difflineminus">-    }</span>
<a href="#l55.413"></a><span id="l55.413" class="difflineminus">-    else {</span>
<a href="#l55.414"></a><span id="l55.414" class="difflineplus">+    } else {</span>
<a href="#l55.415"></a><span id="l55.415">       var currentItem = gSearchTermList.getItemAtIndex(index);</span>
<a href="#l55.416"></a><span id="l55.416">       gSearchTermList.insertBefore(searchrow, currentItem);</span>
<a href="#l55.417"></a><span id="l55.417">     }</span>
<a href="#l55.418"></a><span id="l55.418"> </span>
<a href="#l55.419"></a><span id="l55.419">     // If this row was added by user action, focus the value field.</span>
<a href="#l55.420"></a><span id="l55.420">     if (aUserAdded) {</span>
<a href="#l55.421"></a><span id="l55.421">       document.commandDispatcher.advanceFocusIntoSubtree(searchVal);</span>
<a href="#l55.422"></a><span id="l55.422">       searchrow.setAttribute(&quot;highlight&quot;, &quot;true&quot;);</span>
<a href="#l55.423"></a><span id="l55.423">     }</span>
<a href="#l55.424"></a><span id="l55.424"> </span>
<a href="#l55.425"></a><span id="l55.425">     // bump our unique search term counter</span>
<a href="#l55.426"></a><span id="l55.426">     gUniqueSearchTermCounter++;</span>
<a href="#l55.427"></a><span id="l55.427"> }</span>
<a href="#l55.428"></a><span id="l55.428"> </span>
<a href="#l55.429"></a><span id="l55.429" class="difflineminus">-function initializeTermFromId(id)</span>
<a href="#l55.430"></a><span id="l55.430" class="difflineminus">-{</span>
<a href="#l55.431"></a><span id="l55.431" class="difflineplus">+function initializeTermFromId(id) {</span>
<a href="#l55.432"></a><span id="l55.432">   initializeTermFromIndex(getSearchRowIndexForElement(document.getElementById(id)));</span>
<a href="#l55.433"></a><span id="l55.433"> }</span>
<a href="#l55.434"></a><span id="l55.434"> </span>
<a href="#l55.435"></a><span id="l55.435" class="difflineminus">-function initializeTermFromIndex(index)</span>
<a href="#l55.436"></a><span id="l55.436" class="difflineminus">-{</span>
<a href="#l55.437"></a><span id="l55.437" class="difflineplus">+function initializeTermFromIndex(index) {</span>
<a href="#l55.438"></a><span id="l55.438">     var searchTermObj = gSearchTerms[index].obj;</span>
<a href="#l55.439"></a><span id="l55.439"> </span>
<a href="#l55.440"></a><span id="l55.440">     searchTermObj.searchScope = gSearchTerms[index].scope;</span>
<a href="#l55.441"></a><span id="l55.441">     // the search term will initialize the searchTerm element, including</span>
<a href="#l55.442"></a><span id="l55.442">     // .booleanAnd</span>
<a href="#l55.443"></a><span id="l55.443" class="difflineminus">-    if (gSearchTerms[index].searchTerm)</span>
<a href="#l55.444"></a><span id="l55.444" class="difflineplus">+    if (gSearchTerms[index].searchTerm) {</span>
<a href="#l55.445"></a><span id="l55.445">         searchTermObj.searchTerm = gSearchTerms[index].searchTerm;</span>
<a href="#l55.446"></a><span id="l55.446">     // here, we don't have a searchTerm, so it's probably a new element -</span>
<a href="#l55.447"></a><span id="l55.447">     // we'll initialize the .booleanAnd from the existing setting in</span>
<a href="#l55.448"></a><span id="l55.448">     // the UI</span>
<a href="#l55.449"></a><span id="l55.449" class="difflineminus">-    else</span>
<a href="#l55.450"></a><span id="l55.450" class="difflineminus">-    {</span>
<a href="#l55.451"></a><span id="l55.451" class="difflineplus">+    } else {</span>
<a href="#l55.452"></a><span id="l55.452">       searchTermObj.booleanAnd = (gSearchBooleanRadiogroup.value == &quot;and&quot;);</span>
<a href="#l55.453"></a><span id="l55.453" class="difflineminus">-      if (index)</span>
<a href="#l55.454"></a><span id="l55.454" class="difflineminus">-      {</span>
<a href="#l55.455"></a><span id="l55.455" class="difflineplus">+      if (index) {</span>
<a href="#l55.456"></a><span id="l55.456">         // If we weren't pre-initialized with a searchTerm then steal the</span>
<a href="#l55.457"></a><span id="l55.457">         // search attribute and operator from the previous row.</span>
<a href="#l55.458"></a><span id="l55.458">         searchTermObj.searchattribute.value =  gSearchTerms[index - 1].obj.searchattribute.value;</span>
<a href="#l55.459"></a><span id="l55.459">         searchTermObj.searchoperator.value = gSearchTerms[index - 1].obj.searchoperator.value;</span>
<a href="#l55.460"></a><span id="l55.460">       }</span>
<a href="#l55.461"></a><span id="l55.461">     }</span>
<a href="#l55.462"></a><span id="l55.462"> </span>
<a href="#l55.463"></a><span id="l55.463">     gSearchTerms[index].initialized = true;</span>
<a href="#l55.464"></a><span id="l55.464" class="difflineat">@@ -421,18 +400,17 @@ function initializeTermFromIndex(index)</span>
<a href="#l55.465"></a><span id="l55.465"> /**</span>
<a href="#l55.466"></a><span id="l55.466">  * Creates a &lt;richlistitem&gt; using the array children as the children</span>
<a href="#l55.467"></a><span id="l55.467">  * of each listcell.</span>
<a href="#l55.468"></a><span id="l55.468">  * @param aChildren  An array of XUL elements to put into the listitem.</span>
<a href="#l55.469"></a><span id="l55.469">  *                   Each array member is put into a separate listcell.</span>
<a href="#l55.470"></a><span id="l55.470">  *                   If the member itself is an array of elements,</span>
<a href="#l55.471"></a><span id="l55.471">  *                   all of them are put into the same listcell.</span>
<a href="#l55.472"></a><span id="l55.472">  */</span>
<a href="#l55.473"></a><span id="l55.473" class="difflineminus">-function constructRow(aChildren)</span>
<a href="#l55.474"></a><span id="l55.474" class="difflineminus">-{</span>
<a href="#l55.475"></a><span id="l55.475" class="difflineplus">+function constructRow(aChildren) {</span>
<a href="#l55.476"></a><span id="l55.476">     let cols = gSearchTermList.firstChild.childNodes; // treecol elements</span>
<a href="#l55.477"></a><span id="l55.477">     let listitem = document.createElement(&quot;richlistitem&quot;);</span>
<a href="#l55.478"></a><span id="l55.478">     listitem.setAttribute(&quot;allowevents&quot;, &quot;true&quot;);</span>
<a href="#l55.479"></a><span id="l55.479">     for (let i = 0; i &lt; aChildren.length; i++) {</span>
<a href="#l55.480"></a><span id="l55.480">       let listcell = document.createElement(&quot;hbox&quot;);</span>
<a href="#l55.481"></a><span id="l55.481">       if (cols[i].hasAttribute(&quot;flex&quot;))</span>
<a href="#l55.482"></a><span id="l55.482">         listcell.setAttribute(&quot;flex&quot;, cols[i].getAttribute(&quot;flex&quot;));</span>
<a href="#l55.483"></a><span id="l55.483">       let child = aChildren[i];</span>
<a href="#l55.484"></a><span id="l55.484" class="difflineat">@@ -444,18 +422,17 @@ function constructRow(aChildren)</span>
<a href="#l55.485"></a><span id="l55.485">         child.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l55.486"></a><span id="l55.486">         listcell.appendChild(child);</span>
<a href="#l55.487"></a><span id="l55.487">       }</span>
<a href="#l55.488"></a><span id="l55.488">       listitem.appendChild(listcell);</span>
<a href="#l55.489"></a><span id="l55.489">     }</span>
<a href="#l55.490"></a><span id="l55.490">     return listitem;</span>
<a href="#l55.491"></a><span id="l55.491"> }</span>
<a href="#l55.492"></a><span id="l55.492"> </span>
<a href="#l55.493"></a><span id="l55.493" class="difflineminus">-function removeSearchRow(index)</span>
<a href="#l55.494"></a><span id="l55.494" class="difflineminus">-{</span>
<a href="#l55.495"></a><span id="l55.495" class="difflineplus">+function removeSearchRow(index) {</span>
<a href="#l55.496"></a><span id="l55.496">     var searchTermObj = gSearchTerms[index].obj;</span>
<a href="#l55.497"></a><span id="l55.497">     if (!searchTermObj) {</span>
<a href="#l55.498"></a><span id="l55.498">         return;</span>
<a href="#l55.499"></a><span id="l55.499">     }</span>
<a href="#l55.500"></a><span id="l55.500"> </span>
<a href="#l55.501"></a><span id="l55.501">     // if it is an existing (but offscreen) term,</span>
<a href="#l55.502"></a><span id="l55.502">     // make sure it is initialized before we remove it.</span>
<a href="#l55.503"></a><span id="l55.503">     if (!gSearchTerms[index].searchTerm &amp;&amp; !gSearchTerms[index].initialized)</span>
<a href="#l55.504"></a><span id="l55.504" class="difflineat">@@ -474,33 +451,32 @@ function removeSearchRow(index)</span>
<a href="#l55.505"></a><span id="l55.505">         dump(&quot;Error: couldn't find parent listitem!\n&quot;);</span>
<a href="#l55.506"></a><span id="l55.506">         return;</span>
<a href="#l55.507"></a><span id="l55.507">     }</span>
<a href="#l55.508"></a><span id="l55.508"> </span>
<a href="#l55.509"></a><span id="l55.509"> </span>
<a href="#l55.510"></a><span id="l55.510">     if (searchTermObj.searchTerm) {</span>
<a href="#l55.511"></a><span id="l55.511">         gSearchRemovedTerms.push(searchTermObj.searchTerm);</span>
<a href="#l55.512"></a><span id="l55.512">     } else {</span>
<a href="#l55.513"></a><span id="l55.513" class="difflineminus">-        //dump(&quot;That wasn't real. ignoring \n&quot;);</span>
<a href="#l55.514"></a><span id="l55.514" class="difflineplus">+        // dump(&quot;That wasn't real. ignoring \n&quot;);</span>
<a href="#l55.515"></a><span id="l55.515">     }</span>
<a href="#l55.516"></a><span id="l55.516"> </span>
<a href="#l55.517"></a><span id="l55.517">     listitem.remove();</span>
<a href="#l55.518"></a><span id="l55.518"> </span>
<a href="#l55.519"></a><span id="l55.519">     // now remove the item from our list of terms</span>
<a href="#l55.520"></a><span id="l55.520">     gSearchTerms.splice(index, 1);</span>
<a href="#l55.521"></a><span id="l55.521"> }</span>
<a href="#l55.522"></a><span id="l55.522"> </span>
<a href="#l55.523"></a><span id="l55.523"> // save the search terms from the UI back to the actual search terms</span>
<a href="#l55.524"></a><span id="l55.524"> // searchTerms: nsIMutableArray of terms</span>
<a href="#l55.525"></a><span id="l55.525"> // termOwner:   object which can contain and create the terms</span>
<a href="#l55.526"></a><span id="l55.526"> //              (will be unnecessary if we just make terms creatable</span>
<a href="#l55.527"></a><span id="l55.527"> //               via XPCOM)</span>
<a href="#l55.528"></a><span id="l55.528" class="difflineminus">-function saveSearchTerms(searchTerms, termOwner)</span>
<a href="#l55.529"></a><span id="l55.529" class="difflineminus">-{</span>
<a href="#l55.530"></a><span id="l55.530" class="difflineminus">-    var matchAll = gSearchBooleanRadiogroup.value == 'matchAll';</span>
<a href="#l55.531"></a><span id="l55.531" class="difflineplus">+function saveSearchTerms(searchTerms, termOwner) {</span>
<a href="#l55.532"></a><span id="l55.532" class="difflineplus">+    var matchAll = gSearchBooleanRadiogroup.value == &quot;matchAll&quot;;</span>
<a href="#l55.533"></a><span id="l55.533">     var i;</span>
<a href="#l55.534"></a><span id="l55.534">     for (i = 0; i &lt; gSearchRemovedTerms.length; i++)</span>
<a href="#l55.535"></a><span id="l55.535">         searchTerms.removeElementAt(searchTerms.indexOf(0, gSearchRemovedTerms[i]));</span>
<a href="#l55.536"></a><span id="l55.536"> </span>
<a href="#l55.537"></a><span id="l55.537">     for (i = 0; i &lt; gSearchTerms.length; i++) {</span>
<a href="#l55.538"></a><span id="l55.538">         try {</span>
<a href="#l55.539"></a><span id="l55.539">             gSearchTerms[i].obj.matchAll = matchAll;</span>
<a href="#l55.540"></a><span id="l55.540">             var searchTerm = gSearchTerms[i].obj.searchTerm;</span>
<a href="#l55.541"></a><span id="l55.541" class="difflineat">@@ -519,21 +495,19 @@ function saveSearchTerms(searchTerms, te</span>
<a href="#l55.542"></a><span id="l55.542">             }</span>
<a href="#l55.543"></a><span id="l55.543">             searchTerms.replaceElementAt(searchTerm, i);</span>
<a href="#l55.544"></a><span id="l55.544">         } catch (ex) {</span>
<a href="#l55.545"></a><span id="l55.545">             dump(&quot;** Error saving element &quot; + i + &quot;: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l55.546"></a><span id="l55.546">         }</span>
<a href="#l55.547"></a><span id="l55.547">     }</span>
<a href="#l55.548"></a><span id="l55.548"> }</span>
<a href="#l55.549"></a><span id="l55.549"> </span>
<a href="#l55.550"></a><span id="l55.550" class="difflineminus">-function onReset(event)</span>
<a href="#l55.551"></a><span id="l55.551" class="difflineminus">-{</span>
<a href="#l55.552"></a><span id="l55.552" class="difflineminus">-    while (gTotalSearchTerms&gt;0)</span>
<a href="#l55.553"></a><span id="l55.553" class="difflineplus">+function onReset(event) {</span>
<a href="#l55.554"></a><span id="l55.554" class="difflineplus">+    while (gTotalSearchTerms &gt; 0)</span>
<a href="#l55.555"></a><span id="l55.555">         removeSearchRow(--gTotalSearchTerms);</span>
<a href="#l55.556"></a><span id="l55.556">     onMore(null);</span>
<a href="#l55.557"></a><span id="l55.557"> }</span>
<a href="#l55.558"></a><span id="l55.558"> </span>
<a href="#l55.559"></a><span id="l55.559" class="difflineminus">-function hideMatchAllItem()</span>
<a href="#l55.560"></a><span id="l55.560" class="difflineminus">-{</span>
<a href="#l55.561"></a><span id="l55.561" class="difflineminus">-    var allItems = document.getElementById('matchAllItem');</span>
<a href="#l55.562"></a><span id="l55.562" class="difflineplus">+function hideMatchAllItem() {</span>
<a href="#l55.563"></a><span id="l55.563" class="difflineplus">+    var allItems = document.getElementById(&quot;matchAllItem&quot;);</span>
<a href="#l55.564"></a><span id="l55.564">     if (allItems)</span>
<a href="#l55.565"></a><span id="l55.565">       allItems.hidden = true;</span>
<a href="#l55.566"></a><span id="l55.566"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mailnews/base/search/content/searchWidgets.js</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mailnews/base/search/content/searchWidgets.js</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -1,16 +1,19 @@</span>
<a href="#l56.4"></a><span id="l56.4"> /**</span>
<a href="#l56.5"></a><span id="l56.5">  * This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l56.6"></a><span id="l56.6">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l56.7"></a><span id="l56.7">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l56.8"></a><span id="l56.8"> </span>
<a href="#l56.9"></a><span id="l56.9" class="difflineminus">-/* global MozXULElement, gFilter, gFilterList, onEnterInSearchTerm, convertDateToString */</span>
<a href="#l56.10"></a><span id="l56.10" class="difflineminus">-/* global convertPRTimeToString, convertStringToPRTime */</span>
<a href="#l56.11"></a><span id="l56.11" class="difflineplus">+/* global MozXULElement, gFilter, gFilterList, onEnterInSearchTerm, convertDateToString,</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineplus">+   convertPRTimeToString, convertStringToPRTime, UpdateAfterCustomHeaderChange,</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineplus">+   initializeTermFromId */</span>
<a href="#l56.14"></a><span id="l56.14"> </span>
<a href="#l56.15"></a><span id="l56.15" class="difflineplus">+var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l56.16"></a><span id="l56.16" class="difflineplus">+var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l56.17"></a><span id="l56.17"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l56.18"></a><span id="l56.18"> </span>
<a href="#l56.19"></a><span id="l56.19"> const updateParentNode = (parentNode) =&gt; {</span>
<a href="#l56.20"></a><span id="l56.20">   if (parentNode.hasAttribute(&quot;initialActionIndex&quot;)) {</span>
<a href="#l56.21"></a><span id="l56.21">     let actionIndex = parentNode.getAttribute(&quot;initialActionIndex&quot;);</span>
<a href="#l56.22"></a><span id="l56.22">     let filterAction = gFilter.getActionAt(actionIndex);</span>
<a href="#l56.23"></a><span id="l56.23">     parentNode.initWithAction(filterAction);</span>
<a href="#l56.24"></a><span id="l56.24">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mailnews/base/search/content/searchWidgets.xml</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mailnews/base/search/content/searchWidgets.xml</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -8,28 +8,29 @@</span>
<a href="#l57.4"></a><span id="l57.4">   This file has the following external dependencies:</span>
<a href="#l57.5"></a><span id="l57.5">       -gFilterActionStrings from FilterEditor.js</span>
<a href="#l57.6"></a><span id="l57.6">       -gFilterList from FilterEditor.js</span>
<a href="#l57.7"></a><span id="l57.7">       -gFilter from FilterEditor.js</span>
<a href="#l57.8"></a><span id="l57.8">       -gCustomActions from FilterEditor.js</span>
<a href="#l57.9"></a><span id="l57.9">       -gFilterType from FilterEditor.js</span>
<a href="#l57.10"></a><span id="l57.10">       -checkActionsReorder from FilterEditor.js</span>
<a href="#l57.11"></a><span id="l57.11"> --&gt;</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineplus">+&lt;!-- import-globals-from FilterEditor.js --&gt;</span>
<a href="#l57.13"></a><span id="l57.13"> </span>
<a href="#l57.14"></a><span id="l57.14"> &lt;!DOCTYPE dialog [</span>
<a href="#l57.15"></a><span id="l57.15">   &lt;!ENTITY % filterEditorDTD SYSTEM &quot;chrome://messenger/locale/FilterEditor.dtd&quot; &gt;</span>
<a href="#l57.16"></a><span id="l57.16"> %filterEditorDTD;</span>
<a href="#l57.17"></a><span id="l57.17">   &lt;!ENTITY % messengerDTD    SYSTEM &quot;chrome://messenger/locale/messenger.dtd&quot; &gt;</span>
<a href="#l57.18"></a><span id="l57.18"> %messengerDTD;</span>
<a href="#l57.19"></a><span id="l57.19"> ]&gt;</span>
<a href="#l57.20"></a><span id="l57.20"> </span>
<a href="#l57.21"></a><span id="l57.21" class="difflineminus">-&lt;bindings   id=&quot;filterBindings&quot;</span>
<a href="#l57.22"></a><span id="l57.22" class="difflineminus">-            xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l57.23"></a><span id="l57.23" class="difflineminus">-            xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l57.24"></a><span id="l57.24" class="difflineminus">-            xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l57.25"></a><span id="l57.25" class="difflineplus">+&lt;bindings id=&quot;filterBindings&quot;</span>
<a href="#l57.26"></a><span id="l57.26" class="difflineplus">+          xmlns=&quot;http://www.mozilla.org/xbl&quot;</span>
<a href="#l57.27"></a><span id="l57.27" class="difflineplus">+          xmlns:xul=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l57.28"></a><span id="l57.28" class="difflineplus">+          xmlns:xbl=&quot;http://www.mozilla.org/xbl&quot;&gt;</span>
<a href="#l57.29"></a><span id="l57.29"> </span>
<a href="#l57.30"></a><span id="l57.30">   &lt;binding id=&quot;ruleactiontype-menulist&quot;&gt;</span>
<a href="#l57.31"></a><span id="l57.31">     &lt;content&gt;</span>
<a href="#l57.32"></a><span id="l57.32">       &lt;xul:menulist class=&quot;ruleaction-type&quot;&gt;</span>
<a href="#l57.33"></a><span id="l57.33">           &lt;xul:menupopup&gt;</span>
<a href="#l57.34"></a><span id="l57.34">             &lt;xul:menuitem label=&quot;&amp;moveMessage.label;&quot; value=&quot;movemessage&quot; enablefornews=&quot;false&quot;/&gt;</span>
<a href="#l57.35"></a><span id="l57.35">             &lt;xul:menuitem label=&quot;&amp;copyMessage.label;&quot; value=&quot;copymessage&quot;/&gt;</span>
<a href="#l57.36"></a><span id="l57.36">             &lt;xul:menuseparator enablefornews=&quot;false&quot;/&gt;</span>
<a href="#l57.37"></a><span id="l57.37" class="difflineat">@@ -60,41 +61,38 @@</span>
<a href="#l57.38"></a><span id="l57.38">       &lt;constructor&gt;</span>
<a href="#l57.39"></a><span id="l57.39">         &lt;![CDATA[</span>
<a href="#l57.40"></a><span id="l57.40">           // Force initialization of the menulist custom element first.</span>
<a href="#l57.41"></a><span id="l57.41">           customElements.upgrade(this.menulist);</span>
<a href="#l57.42"></a><span id="l57.42">           this.addCustomActions();</span>
<a href="#l57.43"></a><span id="l57.43">           this.hideInvalidActions();</span>
<a href="#l57.44"></a><span id="l57.44">           // differentiate between creating a new, next available action,</span>
<a href="#l57.45"></a><span id="l57.45">           // and creating a row which will be initialized with an action</span>
<a href="#l57.46"></a><span id="l57.46" class="difflineminus">-          if (!this.parentNode.hasAttribute('initialActionIndex'))</span>
<a href="#l57.47"></a><span id="l57.47" class="difflineminus">-          {</span>
<a href="#l57.48"></a><span id="l57.48" class="difflineplus">+          if (!this.parentNode.hasAttribute(&quot;initialActionIndex&quot;)) {</span>
<a href="#l57.49"></a><span id="l57.49">             var unavailableActions = this.usedActionsList();</span>
<a href="#l57.50"></a><span id="l57.50">             // select the first one that's not in the list</span>
<a href="#l57.51"></a><span id="l57.51" class="difflineminus">-            for (var index = 0; index &lt; this.menuitems.length; index++)</span>
<a href="#l57.52"></a><span id="l57.52" class="difflineminus">-            {</span>
<a href="#l57.53"></a><span id="l57.53" class="difflineplus">+            for (let index = 0; index &lt; this.menuitems.length; index++) {</span>
<a href="#l57.54"></a><span id="l57.54">               var menu = this.menuitems[index];</span>
<a href="#l57.55"></a><span id="l57.55" class="difflineminus">-              if (!(menu.value in unavailableActions) &amp;&amp; !menu.hidden)</span>
<a href="#l57.56"></a><span id="l57.56" class="difflineminus">-              {</span>
<a href="#l57.57"></a><span id="l57.57" class="difflineplus">+              if (!(menu.value in unavailableActions) &amp;&amp; !menu.hidden) {</span>
<a href="#l57.58"></a><span id="l57.58">                 this.menulist.value = menu.value;</span>
<a href="#l57.59"></a><span id="l57.59" class="difflineminus">-                this.parentNode.setAttribute('value', menu.value);</span>
<a href="#l57.60"></a><span id="l57.60" class="difflineplus">+                this.parentNode.setAttribute(&quot;value&quot;, menu.value);</span>
<a href="#l57.61"></a><span id="l57.61">                 break;</span>
<a href="#l57.62"></a><span id="l57.62">               }</span>
<a href="#l57.63"></a><span id="l57.63">             }</span>
<a href="#l57.64"></a><span id="l57.64" class="difflineminus">-          }</span>
<a href="#l57.65"></a><span id="l57.65" class="difflineminus">-          else</span>
<a href="#l57.66"></a><span id="l57.66" class="difflineminus">-          {</span>
<a href="#l57.67"></a><span id="l57.67" class="difflineplus">+          } else {</span>
<a href="#l57.68"></a><span id="l57.68">             this.parentNode.mActionTypeInitialized = true;</span>
<a href="#l57.69"></a><span id="l57.69">             this.parentNode.clearInitialActionIndex();</span>
<a href="#l57.70"></a><span id="l57.70">           }</span>
<a href="#l57.71"></a><span id="l57.71">         ]]&gt;</span>
<a href="#l57.72"></a><span id="l57.72">       &lt;/constructor&gt;</span>
<a href="#l57.73"></a><span id="l57.73"> </span>
<a href="#l57.74"></a><span id="l57.74">       &lt;field name=&quot;menulist&quot;&gt;document.getAnonymousNodes(this)[0]&lt;/field&gt;</span>
<a href="#l57.75"></a><span id="l57.75" class="difflineminus">-      &lt;field name=&quot;menuitems&quot;&gt;this.menulist.getElementsByTagNameNS(this.menulist.namespaceURI, 'menuitem')&lt;/field&gt;</span>
<a href="#l57.76"></a><span id="l57.76" class="difflineplus">+      &lt;field name=&quot;menuitems&quot;&gt;&lt;![CDATA[</span>
<a href="#l57.77"></a><span id="l57.77" class="difflineplus">+        this.menulist.getElementsByTagNameNS(this.menulist.namespaceURI, &quot;menuitem&quot;)</span>
<a href="#l57.78"></a><span id="l57.78" class="difflineplus">+      ]]&gt;&lt;/field&gt;</span>
<a href="#l57.79"></a><span id="l57.79"> </span>
<a href="#l57.80"></a><span id="l57.80">       &lt;method name=&quot;hideInvalidActions&quot;&gt;</span>
<a href="#l57.81"></a><span id="l57.81">         &lt;body&gt;</span>
<a href="#l57.82"></a><span id="l57.82">           &lt;![CDATA[</span>
<a href="#l57.83"></a><span id="l57.83">             let menupopup = this.menulist.menupopup;</span>
<a href="#l57.84"></a><span id="l57.84">             let scope = getScopeFromFilterList(gFilterList);</span>
<a href="#l57.85"></a><span id="l57.85"> </span>
<a href="#l57.86"></a><span id="l57.86">             // walk through the list of filter actions and hide any actions which aren't valid</span>
<a href="#l57.87"></a><span id="l57.87" class="difflineat">@@ -133,18 +131,17 @@</span>
<a href="#l57.88"></a><span id="l57.88">           ]]&gt;</span>
<a href="#l57.89"></a><span id="l57.89">         &lt;/body&gt;</span>
<a href="#l57.90"></a><span id="l57.90">       &lt;/method&gt;</span>
<a href="#l57.91"></a><span id="l57.91"> </span>
<a href="#l57.92"></a><span id="l57.92">       &lt;method name=&quot;addCustomActions&quot;&gt;</span>
<a href="#l57.93"></a><span id="l57.93">         &lt;body&gt;</span>
<a href="#l57.94"></a><span id="l57.94">           &lt;![CDATA[</span>
<a href="#l57.95"></a><span id="l57.95">             var menupopup = this.menulist.menupopup;</span>
<a href="#l57.96"></a><span id="l57.96" class="difflineminus">-            for (var i = 0; i &lt; gCustomActions.length; i++)</span>
<a href="#l57.97"></a><span id="l57.97" class="difflineminus">-            {</span>
<a href="#l57.98"></a><span id="l57.98" class="difflineplus">+            for (let i = 0; i &lt; gCustomActions.length; i++) {</span>
<a href="#l57.99"></a><span id="l57.99">               var customAction = gCustomActions[i];</span>
<a href="#l57.100"></a><span id="l57.100">               var menuitem = document.createElementNS(</span>
<a href="#l57.101"></a><span id="l57.101">                 &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;,</span>
<a href="#l57.102"></a><span id="l57.102">                 &quot;xul:menuitem&quot;);</span>
<a href="#l57.103"></a><span id="l57.103">               menuitem.setAttribute(&quot;label&quot;, customAction.name);</span>
<a href="#l57.104"></a><span id="l57.104">               menuitem.setAttribute(&quot;value&quot;, customAction.id);</span>
<a href="#l57.105"></a><span id="l57.105">               menuitem.setAttribute(&quot;isCustom&quot;, &quot;true&quot;);</span>
<a href="#l57.106"></a><span id="l57.106">               menupopup.appendChild(menuitem);</span>
<a href="#l57.107"></a><span id="l57.107" class="difflineat">@@ -156,54 +153,50 @@</span>
<a href="#l57.108"></a><span id="l57.108">       &lt;!-- returns a hash containing all of the filter actions which are currently being used by other filteractionrows --&gt;</span>
<a href="#l57.109"></a><span id="l57.109">       &lt;method name=&quot;usedActionsList&quot;&gt;</span>
<a href="#l57.110"></a><span id="l57.110">         &lt;body&gt;</span>
<a href="#l57.111"></a><span id="l57.111">           &lt;![CDATA[</span>
<a href="#l57.112"></a><span id="l57.112">             var usedActions = {};</span>
<a href="#l57.113"></a><span id="l57.113">             var currentFilterActionRow = this.parentNode;</span>
<a href="#l57.114"></a><span id="l57.114">             var listBox = currentFilterActionRow.mListBox; // need to account for the list item</span>
<a href="#l57.115"></a><span id="l57.115">             // now iterate over each list item in the list box</span>
<a href="#l57.116"></a><span id="l57.116" class="difflineminus">-            for (var index = 0; index &lt; listBox.getRowCount(); index++)</span>
<a href="#l57.117"></a><span id="l57.117" class="difflineminus">-            {</span>
<a href="#l57.118"></a><span id="l57.118" class="difflineplus">+            for (let index = 0; index &lt; listBox.getRowCount(); index++) {</span>
<a href="#l57.119"></a><span id="l57.119">               var filterActionRow = listBox.getItemAtIndex(index);</span>
<a href="#l57.120"></a><span id="l57.120" class="difflineminus">-              if (filterActionRow != currentFilterActionRow)</span>
<a href="#l57.121"></a><span id="l57.121" class="difflineminus">-              {</span>
<a href="#l57.122"></a><span id="l57.122" class="difflineminus">-                var actionValue = filterActionRow.getAttribute('value');</span>
<a href="#l57.123"></a><span id="l57.123" class="difflineplus">+              if (filterActionRow != currentFilterActionRow) {</span>
<a href="#l57.124"></a><span id="l57.124" class="difflineplus">+                let actionValue = filterActionRow.getAttribute(&quot;value&quot;);</span>
<a href="#l57.125"></a><span id="l57.125"> </span>
<a href="#l57.126"></a><span id="l57.126">                 // let custom actions decide if dups are allowed</span>
<a href="#l57.127"></a><span id="l57.127">                 var isCustom = false;</span>
<a href="#l57.128"></a><span id="l57.128" class="difflineminus">-                for (var i = 0; i &lt; gCustomActions.length; i++)</span>
<a href="#l57.129"></a><span id="l57.129" class="difflineminus">-                {</span>
<a href="#l57.130"></a><span id="l57.130" class="difflineminus">-                  if (gCustomActions[i].id == actionValue)</span>
<a href="#l57.131"></a><span id="l57.131" class="difflineminus">-                  {</span>
<a href="#l57.132"></a><span id="l57.132" class="difflineplus">+                for (let i = 0; i &lt; gCustomActions.length; i++) {</span>
<a href="#l57.133"></a><span id="l57.133" class="difflineplus">+                  if (gCustomActions[i].id == actionValue) {</span>
<a href="#l57.134"></a><span id="l57.134">                     isCustom = true;</span>
<a href="#l57.135"></a><span id="l57.135">                     if (!gCustomActions[i].allowDuplicates)</span>
<a href="#l57.136"></a><span id="l57.136">                       usedActions[actionValue] = true;</span>
<a href="#l57.137"></a><span id="l57.137">                     break;</span>
<a href="#l57.138"></a><span id="l57.138">                   }</span>
<a href="#l57.139"></a><span id="l57.139">                 }</span>
<a href="#l57.140"></a><span id="l57.140"> </span>
<a href="#l57.141"></a><span id="l57.141">                 if (!isCustom) {</span>
<a href="#l57.142"></a><span id="l57.142">                   // The following actions can appear more than once in a single filter</span>
<a href="#l57.143"></a><span id="l57.143">                   // so do not set them as already used.</span>
<a href="#l57.144"></a><span id="l57.144" class="difflineminus">-                  if (actionValue != 'addtagtomessage' &amp;&amp;</span>
<a href="#l57.145"></a><span id="l57.145" class="difflineminus">-                      actionValue != 'forwardmessage' &amp;&amp;</span>
<a href="#l57.146"></a><span id="l57.146" class="difflineminus">-                      actionValue != 'copymessage')</span>
<a href="#l57.147"></a><span id="l57.147" class="difflineplus">+                  if (actionValue != &quot;addtagtomessage&quot; &amp;&amp;</span>
<a href="#l57.148"></a><span id="l57.148" class="difflineplus">+                      actionValue != &quot;forwardmessage&quot; &amp;&amp;</span>
<a href="#l57.149"></a><span id="l57.149" class="difflineplus">+                      actionValue != &quot;copymessage&quot;)</span>
<a href="#l57.150"></a><span id="l57.150">                     usedActions[actionValue] = true;</span>
<a href="#l57.151"></a><span id="l57.151">                   // If either Delete message or Move message exists, disable the other one.</span>
<a href="#l57.152"></a><span id="l57.152">                   // It does not make sense to apply both to the same message.</span>
<a href="#l57.153"></a><span id="l57.153" class="difflineminus">-                  if (actionValue == 'deletemessage')</span>
<a href="#l57.154"></a><span id="l57.154" class="difflineminus">-                    usedActions['movemessage'] = true;</span>
<a href="#l57.155"></a><span id="l57.155" class="difflineminus">-                  else if (actionValue == 'movemessage')</span>
<a href="#l57.156"></a><span id="l57.156" class="difflineminus">-                    usedActions['deletemessage'] = true;</span>
<a href="#l57.157"></a><span id="l57.157" class="difflineplus">+                  if (actionValue == &quot;deletemessage&quot;)</span>
<a href="#l57.158"></a><span id="l57.158" class="difflineplus">+                    usedActions.movemessage = true;</span>
<a href="#l57.159"></a><span id="l57.159" class="difflineplus">+                  else if (actionValue == &quot;movemessage&quot;)</span>
<a href="#l57.160"></a><span id="l57.160" class="difflineplus">+                    usedActions.deletemessage = true;</span>
<a href="#l57.161"></a><span id="l57.161">                   // The same with Mark as read/Mark as Unread.</span>
<a href="#l57.162"></a><span id="l57.162" class="difflineminus">-                  else if (actionValue == 'markasread')</span>
<a href="#l57.163"></a><span id="l57.163" class="difflineminus">-                    usedActions['markasunread'] = true;</span>
<a href="#l57.164"></a><span id="l57.164" class="difflineminus">-                  else if (actionValue == 'markasunread')</span>
<a href="#l57.165"></a><span id="l57.165" class="difflineminus">-                    usedActions['markasread'] = true;</span>
<a href="#l57.166"></a><span id="l57.166" class="difflineplus">+                  else if (actionValue == &quot;markasread&quot;)</span>
<a href="#l57.167"></a><span id="l57.167" class="difflineplus">+                    usedActions.markasunread = true;</span>
<a href="#l57.168"></a><span id="l57.168" class="difflineplus">+                  else if (actionValue == &quot;markasunread&quot;)</span>
<a href="#l57.169"></a><span id="l57.169" class="difflineplus">+                    usedActions.markasread = true;</span>
<a href="#l57.170"></a><span id="l57.170">                 }</span>
<a href="#l57.171"></a><span id="l57.171">               }</span>
<a href="#l57.172"></a><span id="l57.172">             }</span>
<a href="#l57.173"></a><span id="l57.173">             return usedActions;</span>
<a href="#l57.174"></a><span id="l57.174">           ]]&gt;</span>
<a href="#l57.175"></a><span id="l57.175">         &lt;/body&gt;</span>
<a href="#l57.176"></a><span id="l57.176">       &lt;/method&gt;</span>
<a href="#l57.177"></a><span id="l57.177"> </span>
<a href="#l57.178"></a><span id="l57.178" class="difflineat">@@ -251,45 +244,43 @@</span>
<a href="#l57.179"></a><span id="l57.179"> </span>
<a href="#l57.180"></a><span id="l57.180">               while (enumerator.hasMoreElements()) {</span>
<a href="#l57.181"></a><span id="l57.181">                 let header = enumerator.getNext();</span>
<a href="#l57.182"></a><span id="l57.182">                 if (header instanceof Ci.nsIMsgDBHdr) {</span>
<a href="#l57.183"></a><span id="l57.183">                   templateFound = true;</span>
<a href="#l57.184"></a><span id="l57.184">                   if (!populateTemplateList)</span>
<a href="#l57.185"></a><span id="l57.185">                     return true;</span>
<a href="#l57.186"></a><span id="l57.186">                   let msgTemplateUri = msgFolder.URI + &quot;?messageId=&quot; +</span>
<a href="#l57.187"></a><span id="l57.187" class="difflineminus">-                    header.messageId + '&amp;subject=' + header.mime2DecodedSubject;</span>
<a href="#l57.188"></a><span id="l57.188" class="difflineminus">-                  let newItem = templateMenuList.appendItem(header.mime2DecodedSubject,</span>
<a href="#l57.189"></a><span id="l57.189" class="difflineminus">-                                                            msgTemplateUri);</span>
<a href="#l57.190"></a><span id="l57.190" class="difflineplus">+                    header.messageId + &quot;&amp;subject=&quot; + header.mime2DecodedSubject;</span>
<a href="#l57.191"></a><span id="l57.191" class="difflineplus">+                  templateMenuList.appendItem(header.mime2DecodedSubject, msgTemplateUri);</span>
<a href="#l57.192"></a><span id="l57.192">                 }</span>
<a href="#l57.193"></a><span id="l57.193">               }</span>
<a href="#l57.194"></a><span id="l57.194">             }</span>
<a href="#l57.195"></a><span id="l57.195"> </span>
<a href="#l57.196"></a><span id="l57.196">             return templateFound;</span>
<a href="#l57.197"></a><span id="l57.197">           ]]&gt;</span>
<a href="#l57.198"></a><span id="l57.198">         &lt;/body&gt;</span>
<a href="#l57.199"></a><span id="l57.199">       &lt;/method&gt;</span>
<a href="#l57.200"></a><span id="l57.200"> </span>
<a href="#l57.201"></a><span id="l57.201">     &lt;/implementation&gt;</span>
<a href="#l57.202"></a><span id="l57.202"> </span>
<a href="#l57.203"></a><span id="l57.203">     &lt;handlers&gt;</span>
<a href="#l57.204"></a><span id="l57.204">       &lt;handler event=&quot;command&quot;&gt;</span>
<a href="#l57.205"></a><span id="l57.205">         &lt;![CDATA[</span>
<a href="#l57.206"></a><span id="l57.206" class="difflineminus">-          this.parentNode.setAttribute('value', this.menulist.value);</span>
<a href="#l57.207"></a><span id="l57.207" class="difflineplus">+          this.parentNode.setAttribute(&quot;value&quot;, this.menulist.value);</span>
<a href="#l57.208"></a><span id="l57.208">           checkActionsReorder();</span>
<a href="#l57.209"></a><span id="l57.209">         ]]&gt;</span>
<a href="#l57.210"></a><span id="l57.210">       &lt;/handler&gt;</span>
<a href="#l57.211"></a><span id="l57.211"> </span>
<a href="#l57.212"></a><span id="l57.212">       &lt;handler event=&quot;popupshowing&quot;&gt;</span>
<a href="#l57.213"></a><span id="l57.213">         &lt;![CDATA[</span>
<a href="#l57.214"></a><span id="l57.214">           var unavailableActions = this.usedActionsList();</span>
<a href="#l57.215"></a><span id="l57.215" class="difflineminus">-          for (var index = 0; index &lt; this.menuitems.length; index++)</span>
<a href="#l57.216"></a><span id="l57.216" class="difflineminus">-          {</span>
<a href="#l57.217"></a><span id="l57.217" class="difflineplus">+          for (let index = 0; index &lt; this.menuitems.length; index++) {</span>
<a href="#l57.218"></a><span id="l57.218">             var menu = this.menuitems[index];</span>
<a href="#l57.219"></a><span id="l57.219" class="difflineminus">-            menu.setAttribute('disabled', menu.value in unavailableActions);</span>
<a href="#l57.220"></a><span id="l57.220" class="difflineplus">+            menu.setAttribute(&quot;disabled&quot;, menu.value in unavailableActions);</span>
<a href="#l57.221"></a><span id="l57.221">           }</span>
<a href="#l57.222"></a><span id="l57.222">         ]]&gt;</span>
<a href="#l57.223"></a><span id="l57.223">       &lt;/handler&gt;</span>
<a href="#l57.224"></a><span id="l57.224">     &lt;/handlers&gt;</span>
<a href="#l57.225"></a><span id="l57.225">   &lt;/binding&gt;</span>
<a href="#l57.226"></a><span id="l57.226"> </span>
<a href="#l57.227"></a><span id="l57.227">   &lt;!-- This binding exists to disable the default binding of a richlistitem</span>
<a href="#l57.228"></a><span id="l57.228">        in the search terms. --&gt;</span>
<a href="#l57.229"></a><span id="l57.229" class="difflineat">@@ -349,50 +340,46 @@</span>
<a href="#l57.230"></a><span id="l57.230">         &lt;body&gt;</span>
<a href="#l57.231"></a><span id="l57.231">           &lt;![CDATA[</span>
<a href="#l57.232"></a><span id="l57.232">             // we should only remove the initialActionIndex after we have been told that</span>
<a href="#l57.233"></a><span id="l57.233">             // both the rule action type and the rule action target have both been built since they both need</span>
<a href="#l57.234"></a><span id="l57.234">             // this piece of information. This complication arises because both of these child elements are getting</span>
<a href="#l57.235"></a><span id="l57.235">             // bound asynchronously after the search row has been constructed</span>
<a href="#l57.236"></a><span id="l57.236"> </span>
<a href="#l57.237"></a><span id="l57.237">             if (this.mActionTypeInitialized &amp;&amp; this.mRuleActionTargetInitialized)</span>
<a href="#l57.238"></a><span id="l57.238" class="difflineminus">-              this.removeAttribute('initialActionIndex');</span>
<a href="#l57.239"></a><span id="l57.239" class="difflineplus">+              this.removeAttribute(&quot;initialActionIndex&quot;);</span>
<a href="#l57.240"></a><span id="l57.240">           ]]&gt;</span>
<a href="#l57.241"></a><span id="l57.241">         &lt;/body&gt;</span>
<a href="#l57.242"></a><span id="l57.242">       &lt;/method&gt;</span>
<a href="#l57.243"></a><span id="l57.243"> </span>
<a href="#l57.244"></a><span id="l57.244">       &lt;method name=&quot;initWithAction&quot;&gt;</span>
<a href="#l57.245"></a><span id="l57.245">         &lt;parameter name=&quot;aFilterAction&quot;/&gt;</span>
<a href="#l57.246"></a><span id="l57.246">         &lt;body&gt;</span>
<a href="#l57.247"></a><span id="l57.247">           &lt;![CDATA[</span>
<a href="#l57.248"></a><span id="l57.248">             var filterActionStr;</span>
<a href="#l57.249"></a><span id="l57.249">             var actionTarget = document.getAnonymousNodes(this)[1];</span>
<a href="#l57.250"></a><span id="l57.250">             let actionItem = actionTarget.ruleactiontargetElement;</span>
<a href="#l57.251"></a><span id="l57.251">             var nsMsgFilterAction = Ci.nsMsgFilterAction;</span>
<a href="#l57.252"></a><span id="l57.252" class="difflineminus">-            switch (aFilterAction.type)</span>
<a href="#l57.253"></a><span id="l57.253" class="difflineminus">-            {</span>
<a href="#l57.254"></a><span id="l57.254" class="difflineplus">+            switch (aFilterAction.type) {</span>
<a href="#l57.255"></a><span id="l57.255">               case nsMsgFilterAction.Custom:</span>
<a href="#l57.256"></a><span id="l57.256">                 filterActionStr = aFilterAction.customId;</span>
<a href="#l57.257"></a><span id="l57.257">                 if (actionItem)</span>
<a href="#l57.258"></a><span id="l57.258">                   actionItem.childNodes[0].value = aFilterAction.strValue;</span>
<a href="#l57.259"></a><span id="l57.259"> </span>
<a href="#l57.260"></a><span id="l57.260">                 // Make sure the custom action has been added. If not, it</span>
<a href="#l57.261"></a><span id="l57.261">                 // probably was from an extension that has been removed. We'll</span>
<a href="#l57.262"></a><span id="l57.262">                 // show a dummy menuitem to warn the user.</span>
<a href="#l57.263"></a><span id="l57.263">                 var needCustomLabel = true;</span>
<a href="#l57.264"></a><span id="l57.264" class="difflineminus">-                for (var i = 0; i &lt; gCustomActions.length; i++)</span>
<a href="#l57.265"></a><span id="l57.265" class="difflineminus">-                {</span>
<a href="#l57.266"></a><span id="l57.266" class="difflineminus">-                  if (gCustomActions[i].id == filterActionStr)</span>
<a href="#l57.267"></a><span id="l57.267" class="difflineminus">-                  {</span>
<a href="#l57.268"></a><span id="l57.268" class="difflineplus">+                for (let i = 0; i &lt; gCustomActions.length; i++) {</span>
<a href="#l57.269"></a><span id="l57.269" class="difflineplus">+                  if (gCustomActions[i].id == filterActionStr) {</span>
<a href="#l57.270"></a><span id="l57.270">                     needCustomLabel = false;</span>
<a href="#l57.271"></a><span id="l57.271">                     break;</span>
<a href="#l57.272"></a><span id="l57.272">                   }</span>
<a href="#l57.273"></a><span id="l57.273">                 }</span>
<a href="#l57.274"></a><span id="l57.274" class="difflineminus">-                if (needCustomLabel)</span>
<a href="#l57.275"></a><span id="l57.275" class="difflineminus">-                {</span>
<a href="#l57.276"></a><span id="l57.276" class="difflineplus">+                if (needCustomLabel) {</span>
<a href="#l57.277"></a><span id="l57.277">                   var menuitem = document.createElementNS(</span>
<a href="#l57.278"></a><span id="l57.278">                       &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;,</span>
<a href="#l57.279"></a><span id="l57.279">                       &quot;xul:menuitem&quot;);</span>
<a href="#l57.280"></a><span id="l57.280">                   menuitem.setAttribute(&quot;label&quot;,</span>
<a href="#l57.281"></a><span id="l57.281">                       gFilterBundle.getString(&quot;filterMissingCustomAction&quot;));</span>
<a href="#l57.282"></a><span id="l57.282">                   menuitem.setAttribute(&quot;value&quot;, filterActionStr);</span>
<a href="#l57.283"></a><span id="l57.283">                   menuitem.disabled = true;</span>
<a href="#l57.284"></a><span id="l57.284">                   this.mRuleActionType.menulist.menupopup.appendChild(menuitem);</span>
<a href="#l57.285"></a><span id="l57.285" class="difflineat">@@ -440,54 +427,53 @@</span>
<a href="#l57.286"></a><span id="l57.286">       &lt;/method&gt;</span>
<a href="#l57.287"></a><span id="l57.287"> </span>
<a href="#l57.288"></a><span id="l57.288">       &lt;method name=&quot;validateAction&quot;&gt;</span>
<a href="#l57.289"></a><span id="l57.289">         &lt;body&gt;</span>
<a href="#l57.290"></a><span id="l57.290">           &lt;![CDATA[</span>
<a href="#l57.291"></a><span id="l57.291">             // returns true if this row represents a valid filter action and false otherwise.</span>
<a href="#l57.292"></a><span id="l57.292">             // This routine also prompts the user.</span>
<a href="#l57.293"></a><span id="l57.293">             ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;, this);</span>
<a href="#l57.294"></a><span id="l57.294" class="difflineminus">-            var filterActionString = this.getAttribute('value');</span>
<a href="#l57.295"></a><span id="l57.295" class="difflineplus">+            var filterActionString = this.getAttribute(&quot;value&quot;);</span>
<a href="#l57.296"></a><span id="l57.296">             var actionTarget = document.getAnonymousNodes(this)[1];</span>
<a href="#l57.297"></a><span id="l57.297">             let actionTargetLabel = actionTarget.ruleactiontargetElement &amp;&amp;</span>
<a href="#l57.298"></a><span id="l57.298">                                     actionTarget.ruleactiontargetElement.childNodes[0].value;</span>
<a href="#l57.299"></a><span id="l57.299">             var errorString, customError;</span>
<a href="#l57.300"></a><span id="l57.300"> </span>
<a href="#l57.301"></a><span id="l57.301" class="difflineminus">-            switch (filterActionString)</span>
<a href="#l57.302"></a><span id="l57.302" class="difflineminus">-            {</span>
<a href="#l57.303"></a><span id="l57.303" class="difflineplus">+            switch (filterActionString) {</span>
<a href="#l57.304"></a><span id="l57.304">               case &quot;movemessage&quot;:</span>
<a href="#l57.305"></a><span id="l57.305">               case &quot;copymessage&quot;:</span>
<a href="#l57.306"></a><span id="l57.306">                 let msgFolder = actionTargetLabel ?</span>
<a href="#l57.307"></a><span id="l57.307">                   this.MailUtils.getOrCreateFolder(actionTargetLabel) : null;</span>
<a href="#l57.308"></a><span id="l57.308">                 if (!msgFolder || !msgFolder.canFileMessages)</span>
<a href="#l57.309"></a><span id="l57.309">                   errorString = &quot;mustSelectFolder&quot;;</span>
<a href="#l57.310"></a><span id="l57.310">                 break;</span>
<a href="#l57.311"></a><span id="l57.311">               case &quot;forwardmessage&quot;:</span>
<a href="#l57.312"></a><span id="l57.312">                 if (actionTargetLabel.length &lt; 3 ||</span>
<a href="#l57.313"></a><span id="l57.313" class="difflineminus">-                    actionTargetLabel.indexOf('@') &lt; 1)</span>
<a href="#l57.314"></a><span id="l57.314" class="difflineplus">+                    actionTargetLabel.indexOf(&quot;@&quot;) &lt; 1)</span>
<a href="#l57.315"></a><span id="l57.315">                   errorString = &quot;enterValidEmailAddress&quot;;</span>
<a href="#l57.316"></a><span id="l57.316">                 break;</span>
<a href="#l57.317"></a><span id="l57.317">               case &quot;replytomessage&quot;:</span>
<a href="#l57.318"></a><span id="l57.318">                 if (!actionTarget.ruleactiontargetElement.childNodes[0].selectedItem)</span>
<a href="#l57.319"></a><span id="l57.319">                    errorString = &quot;pickTemplateToReplyWith&quot;;</span>
<a href="#l57.320"></a><span id="l57.320">                 break;</span>
<a href="#l57.321"></a><span id="l57.321">               default:</span>
<a href="#l57.322"></a><span id="l57.322">                 // some custom actions have no action value node</span>
<a href="#l57.323"></a><span id="l57.323">                 if (!document.getAnonymousNodes(actionTarget))</span>
<a href="#l57.324"></a><span id="l57.324">                   return true;</span>
<a href="#l57.325"></a><span id="l57.325">                 // locate the correct custom action, and check validity</span>
<a href="#l57.326"></a><span id="l57.326" class="difflineminus">-                for (var i = 0; i &lt; gCustomActions.length; i++)</span>
<a href="#l57.327"></a><span id="l57.327" class="difflineminus">-                  if (gCustomActions[i].id == filterActionString)</span>
<a href="#l57.328"></a><span id="l57.328" class="difflineminus">-                  {</span>
<a href="#l57.329"></a><span id="l57.329" class="difflineplus">+                for (let i = 0; i &lt; gCustomActions.length; i++) {</span>
<a href="#l57.330"></a><span id="l57.330" class="difflineplus">+                  if (gCustomActions[i].id == filterActionString) {</span>
<a href="#l57.331"></a><span id="l57.331">                     customError =</span>
<a href="#l57.332"></a><span id="l57.332">                         gCustomActions[i].validateActionValue(</span>
<a href="#l57.333"></a><span id="l57.333">                           actionTargetLabel,</span>
<a href="#l57.334"></a><span id="l57.334">                           gFilterList.folder, gFilterType);</span>
<a href="#l57.335"></a><span id="l57.335">                     break;</span>
<a href="#l57.336"></a><span id="l57.336">                   }</span>
<a href="#l57.337"></a><span id="l57.337" class="difflineplus">+                }</span>
<a href="#l57.338"></a><span id="l57.338">                 break;</span>
<a href="#l57.339"></a><span id="l57.339">             }</span>
<a href="#l57.340"></a><span id="l57.340"> </span>
<a href="#l57.341"></a><span id="l57.341">             errorString = errorString ?</span>
<a href="#l57.342"></a><span id="l57.342">                           gFilterBundle.getString(errorString) :</span>
<a href="#l57.343"></a><span id="l57.343">                           customError;</span>
<a href="#l57.344"></a><span id="l57.344">             if (errorString)</span>
<a href="#l57.345"></a><span id="l57.345">               Services.prompt.alert(window, null, errorString);</span>
<a href="#l57.346"></a><span id="l57.346" class="difflineat">@@ -498,23 +484,22 @@</span>
<a href="#l57.347"></a><span id="l57.347">       &lt;/method&gt;</span>
<a href="#l57.348"></a><span id="l57.348"> </span>
<a href="#l57.349"></a><span id="l57.349">       &lt;method name=&quot;saveToFilter&quot;&gt;</span>
<a href="#l57.350"></a><span id="l57.350">         &lt;parameter name=&quot;aFilter&quot;/&gt;</span>
<a href="#l57.351"></a><span id="l57.351">         &lt;body&gt;</span>
<a href="#l57.352"></a><span id="l57.352">           &lt;![CDATA[</span>
<a href="#l57.353"></a><span id="l57.353">             // create a new filter action, fill it in, and then append it to the filter</span>
<a href="#l57.354"></a><span id="l57.354">             var filterAction = aFilter.createAction();</span>
<a href="#l57.355"></a><span id="l57.355" class="difflineminus">-            var filterActionString = this.getAttribute('value');</span>
<a href="#l57.356"></a><span id="l57.356" class="difflineplus">+            var filterActionString = this.getAttribute(&quot;value&quot;);</span>
<a href="#l57.357"></a><span id="l57.357">             filterAction.type = gFilterActionStrings.indexOf(filterActionString);</span>
<a href="#l57.358"></a><span id="l57.358">             var actionTarget = document.getAnonymousNodes(this)[1];</span>
<a href="#l57.359"></a><span id="l57.359">             let actionItem = actionTarget.ruleactiontargetElement;</span>
<a href="#l57.360"></a><span id="l57.360">             var nsMsgFilterAction = Ci.nsMsgFilterAction;</span>
<a href="#l57.361"></a><span id="l57.361" class="difflineminus">-            switch (filterAction.type)</span>
<a href="#l57.362"></a><span id="l57.362" class="difflineminus">-            {</span>
<a href="#l57.363"></a><span id="l57.363" class="difflineplus">+            switch (filterAction.type) {</span>
<a href="#l57.364"></a><span id="l57.364">               case nsMsgFilterAction.Label:</span>
<a href="#l57.365"></a><span id="l57.365">                 filterAction.label = actionItem.childNodes[0].getAttribute(&quot;value&quot;);</span>
<a href="#l57.366"></a><span id="l57.366">                 break;</span>
<a href="#l57.367"></a><span id="l57.367">               case nsMsgFilterAction.ChangePriority:</span>
<a href="#l57.368"></a><span id="l57.368">                 filterAction.priority = actionItem.childNodes[0].getAttribute(&quot;value&quot;);</span>
<a href="#l57.369"></a><span id="l57.369">                 break;</span>
<a href="#l57.370"></a><span id="l57.370">               case nsMsgFilterAction.MoveToFolder:</span>
<a href="#l57.371"></a><span id="l57.371">               case nsMsgFilterAction.CopyToFolder:</span>
<a href="#l57.372"></a><span id="l57.372" class="difflineat">@@ -540,22 +525,28 @@</span>
<a href="#l57.373"></a><span id="l57.373">         &lt;parameter name=&quot;aActionStrings&quot;/&gt;</span>
<a href="#l57.374"></a><span id="l57.374">         &lt;body&gt;</span>
<a href="#l57.375"></a><span id="l57.375">           &lt;![CDATA[</span>
<a href="#l57.376"></a><span id="l57.376">             // Collect the action names and arguments in a plain string form.</span>
<a href="#l57.377"></a><span id="l57.377">             let actionTarget = document.getAnonymousNodes(this)[1];</span>
<a href="#l57.378"></a><span id="l57.378">             let actionItem = actionTarget.ruleactiontargetElement;</span>
<a href="#l57.379"></a><span id="l57.379">             let actionItemLabel = actionItem &amp;&amp; actionItem.childNodes[0].label;</span>
<a href="#l57.380"></a><span id="l57.380"> </span>
<a href="#l57.381"></a><span id="l57.381" class="difflineminus">-            aActionStrings.push({</span>
<a href="#l57.382"></a><span id="l57.382" class="difflineplus">+            let actionString = {</span>
<a href="#l57.383"></a><span id="l57.383">               label: document.getAnonymousNodes(this.mRuleActionType)[0].label,</span>
<a href="#l57.384"></a><span id="l57.384" class="difflineminus">-              argument: actionItem ?</span>
<a href="#l57.385"></a><span id="l57.385" class="difflineminus">-                        (actionItemLabel ?</span>
<a href="#l57.386"></a><span id="l57.386" class="difflineminus">-                         actionItemLabel : actionItem.childNodes[0].value) : &quot;&quot;</span>
<a href="#l57.387"></a><span id="l57.387" class="difflineminus">-            });</span>
<a href="#l57.388"></a><span id="l57.388" class="difflineplus">+              argument: &quot;&quot;,</span>
<a href="#l57.389"></a><span id="l57.389" class="difflineplus">+            };</span>
<a href="#l57.390"></a><span id="l57.390" class="difflineplus">+            if (actionItem) {</span>
<a href="#l57.391"></a><span id="l57.391" class="difflineplus">+              if (actionItemLabel) {</span>
<a href="#l57.392"></a><span id="l57.392" class="difflineplus">+                actionString.argument = actionItemLabel;</span>
<a href="#l57.393"></a><span id="l57.393" class="difflineplus">+              } else {</span>
<a href="#l57.394"></a><span id="l57.394" class="difflineplus">+                actionString.argument = actionItem.childNodes[0].value;</span>
<a href="#l57.395"></a><span id="l57.395" class="difflineplus">+              }</span>
<a href="#l57.396"></a><span id="l57.396" class="difflineplus">+            }</span>
<a href="#l57.397"></a><span id="l57.397" class="difflineplus">+            aActionStrings.push(actionString);</span>
<a href="#l57.398"></a><span id="l57.398">           ]]&gt;</span>
<a href="#l57.399"></a><span id="l57.399">         &lt;/body&gt;</span>
<a href="#l57.400"></a><span id="l57.400">       &lt;/method&gt;</span>
<a href="#l57.401"></a><span id="l57.401"> </span>
<a href="#l57.402"></a><span id="l57.402">       &lt;method name=&quot;updateRemoveButton&quot;&gt;</span>
<a href="#l57.403"></a><span id="l57.403">         &lt;body&gt;</span>
<a href="#l57.404"></a><span id="l57.404">           &lt;![CDATA[</span>
<a href="#l57.405"></a><span id="l57.405">             // if we only have one row of actions, then disable the remove button for that row</span>
<a href="#l57.406"></a><span id="l57.406" class="difflineat">@@ -563,18 +554,18 @@</span>
<a href="#l57.407"></a><span id="l57.407">           ]]&gt;</span>
<a href="#l57.408"></a><span id="l57.408">         &lt;/body&gt;</span>
<a href="#l57.409"></a><span id="l57.409">       &lt;/method&gt;</span>
<a href="#l57.410"></a><span id="l57.410"> </span>
<a href="#l57.411"></a><span id="l57.411">       &lt;method name=&quot;addRow&quot;&gt;</span>
<a href="#l57.412"></a><span id="l57.412">         &lt;body&gt;</span>
<a href="#l57.413"></a><span id="l57.413">           &lt;![CDATA[</span>
<a href="#l57.414"></a><span id="l57.414">             let listItem = document.createElement(&quot;richlistitem&quot;);</span>
<a href="#l57.415"></a><span id="l57.415" class="difflineminus">-            listItem.className = 'ruleaction';</span>
<a href="#l57.416"></a><span id="l57.416" class="difflineminus">-            listItem.setAttribute('onfocus','this.storeFocus();');</span>
<a href="#l57.417"></a><span id="l57.417" class="difflineplus">+            listItem.className = &quot;ruleaction&quot;;</span>
<a href="#l57.418"></a><span id="l57.418" class="difflineplus">+            listItem.setAttribute(&quot;onfocus&quot;, &quot;this.storeFocus();&quot;);</span>
<a href="#l57.419"></a><span id="l57.419">             this.mListBox.insertBefore(listItem, this.nextSibling);</span>
<a href="#l57.420"></a><span id="l57.420">             this.mListBox.ensureElementIsVisible(listItem);</span>
<a href="#l57.421"></a><span id="l57.421"> </span>
<a href="#l57.422"></a><span id="l57.422">             // make sure the first remove button is enabled</span>
<a href="#l57.423"></a><span id="l57.423">             this.updateRemoveButton();</span>
<a href="#l57.424"></a><span id="l57.424">             checkActionsReorder();</span>
<a href="#l57.425"></a><span id="l57.425">           ]]&gt;</span>
<a href="#l57.426"></a><span id="l57.426">         &lt;/body&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mailnews/base/search/content/viewLog.js</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mailnews/base/search/content/viewLog.js</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -1,36 +1,33 @@</span>
<a href="#l58.4"></a><span id="l58.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l58.5"></a><span id="l58.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l58.6"></a><span id="l58.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l58.7"></a><span id="l58.7"> </span>
<a href="#l58.8"></a><span id="l58.8"> var gFilterList;</span>
<a href="#l58.9"></a><span id="l58.9"> var gLogFilters;</span>
<a href="#l58.10"></a><span id="l58.10"> var gLogView;</span>
<a href="#l58.11"></a><span id="l58.11"> </span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-function onLoad()</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineminus">-{</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineplus">+function onLoad() {</span>
<a href="#l58.15"></a><span id="l58.15">   gFilterList = window.arguments[0].filterList;</span>
<a href="#l58.16"></a><span id="l58.16"> </span>
<a href="#l58.17"></a><span id="l58.17">   gLogFilters = document.getElementById(&quot;logFilters&quot;);</span>
<a href="#l58.18"></a><span id="l58.18">   gLogFilters.checked = gFilterList.loggingEnabled;</span>
<a href="#l58.19"></a><span id="l58.19"> </span>
<a href="#l58.20"></a><span id="l58.20">   gLogView = document.getElementById(&quot;logView&quot;);</span>
<a href="#l58.21"></a><span id="l58.21"> </span>
<a href="#l58.22"></a><span id="l58.22">   // for security, disable JS</span>
<a href="#l58.23"></a><span id="l58.23">   gLogView.docShell.allowJavascript = false;</span>
<a href="#l58.24"></a><span id="l58.24"> </span>
<a href="#l58.25"></a><span id="l58.25">   gLogView.setAttribute(&quot;src&quot;, gFilterList.logURL);</span>
<a href="#l58.26"></a><span id="l58.26"> }</span>
<a href="#l58.27"></a><span id="l58.27"> </span>
<a href="#l58.28"></a><span id="l58.28" class="difflineminus">-function toggleLogFilters()</span>
<a href="#l58.29"></a><span id="l58.29" class="difflineminus">-{</span>
<a href="#l58.30"></a><span id="l58.30" class="difflineplus">+function toggleLogFilters() {</span>
<a href="#l58.31"></a><span id="l58.31">   gFilterList.loggingEnabled =  gLogFilters.checked;</span>
<a href="#l58.32"></a><span id="l58.32"> }</span>
<a href="#l58.33"></a><span id="l58.33"> </span>
<a href="#l58.34"></a><span id="l58.34" class="difflineminus">-function clearLog()</span>
<a href="#l58.35"></a><span id="l58.35" class="difflineminus">-{</span>
<a href="#l58.36"></a><span id="l58.36" class="difflineplus">+function clearLog() {</span>
<a href="#l58.37"></a><span id="l58.37">   gFilterList.clearLog();</span>
<a href="#l58.38"></a><span id="l58.38"> </span>
<a href="#l58.39"></a><span id="l58.39">   // reload the newly truncated file</span>
<a href="#l58.40"></a><span id="l58.40">   gLogView.reload();</span>
<a href="#l58.41"></a><span id="l58.41"> }</span>
<a href="#l58.42"></a><span id="l58.42"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgTraitService.js</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgTraitService.js</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -7,232 +7,183 @@ var {XPCOMUtils} = ChromeUtils.import(&quot;r</span>
<a href="#l59.4"></a><span id="l59.4"> </span>
<a href="#l59.5"></a><span id="l59.5"> // local static variables</span>
<a href="#l59.6"></a><span id="l59.6"> </span>
<a href="#l59.7"></a><span id="l59.7"> var _lastIndex = 0;  // the first index will be one</span>
<a href="#l59.8"></a><span id="l59.8"> var _traits = {};</span>
<a href="#l59.9"></a><span id="l59.9"> </span>
<a href="#l59.10"></a><span id="l59.10"> var traitsBranch = Services.prefs.getBranch(&quot;mailnews.traits.&quot;);</span>
<a href="#l59.11"></a><span id="l59.11"> </span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-function _registerTrait(aId, aIndex)</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineminus">-{</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineplus">+function _registerTrait(aId, aIndex) {</span>
<a href="#l59.15"></a><span id="l59.15">   var trait = {};</span>
<a href="#l59.16"></a><span id="l59.16">   trait.enabled = false;</span>
<a href="#l59.17"></a><span id="l59.17">   trait.name = &quot;&quot;;</span>
<a href="#l59.18"></a><span id="l59.18">   trait.antiId = &quot;&quot;;</span>
<a href="#l59.19"></a><span id="l59.19">   trait.index = aIndex;</span>
<a href="#l59.20"></a><span id="l59.20">   _traits[aId] = trait;</span>
<a href="#l59.21"></a><span id="l59.21" class="difflineminus">-  return;</span>
<a href="#l59.22"></a><span id="l59.22"> }</span>
<a href="#l59.23"></a><span id="l59.23"> </span>
<a href="#l59.24"></a><span id="l59.24"> function nsMsgTraitService() {}</span>
<a href="#l59.25"></a><span id="l59.25"> </span>
<a href="#l59.26"></a><span id="l59.26" class="difflineminus">-nsMsgTraitService.prototype =</span>
<a href="#l59.27"></a><span id="l59.27" class="difflineminus">-{</span>
<a href="#l59.28"></a><span id="l59.28" class="difflineplus">+nsMsgTraitService.prototype = {</span>
<a href="#l59.29"></a><span id="l59.29">   // Component setup</span>
<a href="#l59.30"></a><span id="l59.30">   classID: Components.ID(&quot;{A2E95F4F-DA72-4a41-9493-661AD353C00A}&quot;),</span>
<a href="#l59.31"></a><span id="l59.31"> </span>
<a href="#l59.32"></a><span id="l59.32">   QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgTraitService]),</span>
<a href="#l59.33"></a><span id="l59.33"> </span>
<a href="#l59.34"></a><span id="l59.34">   // nsIMsgTraitService implementation</span>
<a href="#l59.35"></a><span id="l59.35"> </span>
<a href="#l59.36"></a><span id="l59.36" class="difflineminus">-  get lastIndex()</span>
<a href="#l59.37"></a><span id="l59.37" class="difflineminus">-  {</span>
<a href="#l59.38"></a><span id="l59.38" class="difflineplus">+  get lastIndex() {</span>
<a href="#l59.39"></a><span id="l59.39">     return _lastIndex;</span>
<a href="#l59.40"></a><span id="l59.40">   },</span>
<a href="#l59.41"></a><span id="l59.41"> </span>
<a href="#l59.42"></a><span id="l59.42" class="difflineminus">-  registerTrait: function(aId)</span>
<a href="#l59.43"></a><span id="l59.43" class="difflineminus">-  {</span>
<a href="#l59.44"></a><span id="l59.44" class="difflineplus">+  registerTrait(aId) {</span>
<a href="#l59.45"></a><span id="l59.45">     if (_traits[aId])</span>
<a href="#l59.46"></a><span id="l59.46">       return 0;  // meaning already registered</span>
<a href="#l59.47"></a><span id="l59.47">     _registerTrait(aId, ++_lastIndex);</span>
<a href="#l59.48"></a><span id="l59.48">     traitsBranch.setBoolPref(&quot;enabled.&quot; + _lastIndex, false);</span>
<a href="#l59.49"></a><span id="l59.49">     traitsBranch.setCharPref(&quot;id.&quot; + _lastIndex, aId);</span>
<a href="#l59.50"></a><span id="l59.50">     return _lastIndex;</span>
<a href="#l59.51"></a><span id="l59.51">   },</span>
<a href="#l59.52"></a><span id="l59.52"> </span>
<a href="#l59.53"></a><span id="l59.53" class="difflineminus">-  unRegisterTrait: function(aId)</span>
<a href="#l59.54"></a><span id="l59.54" class="difflineminus">-  {</span>
<a href="#l59.55"></a><span id="l59.55" class="difflineminus">-    if (_traits[aId])</span>
<a href="#l59.56"></a><span id="l59.56" class="difflineminus">-    {</span>
<a href="#l59.57"></a><span id="l59.57" class="difflineplus">+  unRegisterTrait(aId) {</span>
<a href="#l59.58"></a><span id="l59.58" class="difflineplus">+    if (_traits[aId]) {</span>
<a href="#l59.59"></a><span id="l59.59">       var index = _traits[aId].index;</span>
<a href="#l59.60"></a><span id="l59.60">       _traits[aId] = null;</span>
<a href="#l59.61"></a><span id="l59.61">       traitsBranch.clearUserPref(&quot;id.&quot; + index);</span>
<a href="#l59.62"></a><span id="l59.62">       traitsBranch.clearUserPref(&quot;enabled.&quot; + index);</span>
<a href="#l59.63"></a><span id="l59.63">       traitsBranch.clearUserPref(&quot;antiId.&quot; + index);</span>
<a href="#l59.64"></a><span id="l59.64">       traitsBranch.clearUserPref(&quot;name.&quot; + index);</span>
<a href="#l59.65"></a><span id="l59.65">     }</span>
<a href="#l59.66"></a><span id="l59.66" class="difflineminus">-    return;</span>
<a href="#l59.67"></a><span id="l59.67">   },</span>
<a href="#l59.68"></a><span id="l59.68"> </span>
<a href="#l59.69"></a><span id="l59.69" class="difflineminus">-  isRegistered: function(aId)</span>
<a href="#l59.70"></a><span id="l59.70" class="difflineminus">-  {</span>
<a href="#l59.71"></a><span id="l59.71" class="difflineminus">-    return _traits[aId] ? true : false;</span>
<a href="#l59.72"></a><span id="l59.72" class="difflineplus">+  isRegistered(aId) {</span>
<a href="#l59.73"></a><span id="l59.73" class="difflineplus">+    return !!_traits[aId];</span>
<a href="#l59.74"></a><span id="l59.74">   },</span>
<a href="#l59.75"></a><span id="l59.75"> </span>
<a href="#l59.76"></a><span id="l59.76" class="difflineminus">-  setName: function(aId, aName)</span>
<a href="#l59.77"></a><span id="l59.77" class="difflineminus">-  {</span>
<a href="#l59.78"></a><span id="l59.78" class="difflineplus">+  setName(aId, aName) {</span>
<a href="#l59.79"></a><span id="l59.79">     traitsBranch.setCharPref(&quot;name.&quot; + _traits[aId].index, aName);</span>
<a href="#l59.80"></a><span id="l59.80">     _traits[aId].name = aName;</span>
<a href="#l59.81"></a><span id="l59.81">   },</span>
<a href="#l59.82"></a><span id="l59.82"> </span>
<a href="#l59.83"></a><span id="l59.83" class="difflineminus">-  getName: function(aId)</span>
<a href="#l59.84"></a><span id="l59.84" class="difflineminus">-  {</span>
<a href="#l59.85"></a><span id="l59.85" class="difflineplus">+  getName(aId) {</span>
<a href="#l59.86"></a><span id="l59.86">     return _traits[aId].name;</span>
<a href="#l59.87"></a><span id="l59.87">   },</span>
<a href="#l59.88"></a><span id="l59.88"> </span>
<a href="#l59.89"></a><span id="l59.89" class="difflineminus">-  getIndex: function(aId)</span>
<a href="#l59.90"></a><span id="l59.90" class="difflineminus">-  {</span>
<a href="#l59.91"></a><span id="l59.91" class="difflineplus">+  getIndex(aId) {</span>
<a href="#l59.92"></a><span id="l59.92">     return _traits[aId].index;</span>
<a href="#l59.93"></a><span id="l59.93">   },</span>
<a href="#l59.94"></a><span id="l59.94"> </span>
<a href="#l59.95"></a><span id="l59.95" class="difflineminus">-  getId: function(aIndex)</span>
<a href="#l59.96"></a><span id="l59.96" class="difflineminus">-  {</span>
<a href="#l59.97"></a><span id="l59.97" class="difflineplus">+  getId(aIndex) {</span>
<a href="#l59.98"></a><span id="l59.98">     for (let id in _traits)</span>
<a href="#l59.99"></a><span id="l59.99">       if (_traits[id].index == aIndex)</span>
<a href="#l59.100"></a><span id="l59.100">         return id;</span>
<a href="#l59.101"></a><span id="l59.101">     return null;</span>
<a href="#l59.102"></a><span id="l59.102">   },</span>
<a href="#l59.103"></a><span id="l59.103"> </span>
<a href="#l59.104"></a><span id="l59.104" class="difflineminus">-  setEnabled: function(aId, aEnabled)</span>
<a href="#l59.105"></a><span id="l59.105" class="difflineminus">-  {</span>
<a href="#l59.106"></a><span id="l59.106" class="difflineplus">+  setEnabled(aId, aEnabled) {</span>
<a href="#l59.107"></a><span id="l59.107">     traitsBranch.setBoolPref(&quot;enabled.&quot; + _traits[aId].index, aEnabled);</span>
<a href="#l59.108"></a><span id="l59.108">     _traits[aId].enabled = aEnabled;</span>
<a href="#l59.109"></a><span id="l59.109">   },</span>
<a href="#l59.110"></a><span id="l59.110"> </span>
<a href="#l59.111"></a><span id="l59.111" class="difflineminus">-  getEnabled: function(aId)</span>
<a href="#l59.112"></a><span id="l59.112" class="difflineminus">-  {</span>
<a href="#l59.113"></a><span id="l59.113" class="difflineplus">+  getEnabled(aId) {</span>
<a href="#l59.114"></a><span id="l59.114">     return _traits[aId].enabled;</span>
<a href="#l59.115"></a><span id="l59.115">   },</span>
<a href="#l59.116"></a><span id="l59.116"> </span>
<a href="#l59.117"></a><span id="l59.117" class="difflineminus">-  setAntiId: function(aId, aAntiId)</span>
<a href="#l59.118"></a><span id="l59.118" class="difflineminus">-  {</span>
<a href="#l59.119"></a><span id="l59.119" class="difflineplus">+  setAntiId(aId, aAntiId) {</span>
<a href="#l59.120"></a><span id="l59.120">     traitsBranch.setCharPref(&quot;antiId.&quot; + _traits[aId].index, aAntiId);</span>
<a href="#l59.121"></a><span id="l59.121">     _traits[aId].antiId = aAntiId;</span>
<a href="#l59.122"></a><span id="l59.122">   },</span>
<a href="#l59.123"></a><span id="l59.123"> </span>
<a href="#l59.124"></a><span id="l59.124" class="difflineminus">-  getAntiId: function(aId)</span>
<a href="#l59.125"></a><span id="l59.125" class="difflineminus">-  {</span>
<a href="#l59.126"></a><span id="l59.126" class="difflineplus">+  getAntiId(aId) {</span>
<a href="#l59.127"></a><span id="l59.127">     return _traits[aId].antiId;</span>
<a href="#l59.128"></a><span id="l59.128">   },</span>
<a href="#l59.129"></a><span id="l59.129"> </span>
<a href="#l59.130"></a><span id="l59.130" class="difflineminus">-  getEnabledIndices: function(aCount, aProIndices, aAntiIndices)</span>
<a href="#l59.131"></a><span id="l59.131" class="difflineminus">-  {</span>
<a href="#l59.132"></a><span id="l59.132" class="difflineplus">+  getEnabledIndices(aCount, aProIndices, aAntiIndices) {</span>
<a href="#l59.133"></a><span id="l59.133">     let proIndices = [];</span>
<a href="#l59.134"></a><span id="l59.134">     let antiIndices = [];</span>
<a href="#l59.135"></a><span id="l59.135">     for (let id in _traits)</span>
<a href="#l59.136"></a><span id="l59.136" class="difflineminus">-      if (_traits[id].enabled)</span>
<a href="#l59.137"></a><span id="l59.137" class="difflineminus">-      {</span>
<a href="#l59.138"></a><span id="l59.138" class="difflineplus">+      if (_traits[id].enabled) {</span>
<a href="#l59.139"></a><span id="l59.139">         proIndices.push(_traits[id].index);</span>
<a href="#l59.140"></a><span id="l59.140">         antiIndices.push(_traits[_traits[id].antiId].index);</span>
<a href="#l59.141"></a><span id="l59.141">       }</span>
<a href="#l59.142"></a><span id="l59.142">     aCount.value = proIndices.length;</span>
<a href="#l59.143"></a><span id="l59.143">     aProIndices.value = proIndices;</span>
<a href="#l59.144"></a><span id="l59.144">     aAntiIndices.value = antiIndices;</span>
<a href="#l59.145"></a><span id="l59.145" class="difflineminus">-    return;</span>
<a href="#l59.146"></a><span id="l59.146">   },</span>
<a href="#l59.147"></a><span id="l59.147"> </span>
<a href="#l59.148"></a><span id="l59.148" class="difflineminus">-  addAlias: function addAlias(aTraitIndex, aTraitAliasIndex)</span>
<a href="#l59.149"></a><span id="l59.149" class="difflineminus">-  {</span>
<a href="#l59.150"></a><span id="l59.150" class="difflineminus">-    let aliasesString = &quot;&quot;;</span>
<a href="#l59.151"></a><span id="l59.151" class="difflineminus">-    try {</span>
<a href="#l59.152"></a><span id="l59.152" class="difflineminus">-      aliasesString = traitsBranch.getCharPref(&quot;aliases.&quot; + aTraitIndex);</span>
<a href="#l59.153"></a><span id="l59.153" class="difflineminus">-    }</span>
<a href="#l59.154"></a><span id="l59.154" class="difflineminus">-    catch (e) {}</span>
<a href="#l59.155"></a><span id="l59.155" class="difflineplus">+  addAlias(aTraitIndex, aTraitAliasIndex) {</span>
<a href="#l59.156"></a><span id="l59.156" class="difflineplus">+    let aliasesString = traitsBranch.getCharPref(&quot;aliases.&quot; + aTraitIndex, &quot;&quot;);</span>
<a href="#l59.157"></a><span id="l59.157">     let aliases;</span>
<a href="#l59.158"></a><span id="l59.158">     if (aliasesString.length)</span>
<a href="#l59.159"></a><span id="l59.159">       aliases = aliasesString.split(&quot;,&quot;);</span>
<a href="#l59.160"></a><span id="l59.160">     else</span>
<a href="#l59.161"></a><span id="l59.161">       aliases = [];</span>
<a href="#l59.162"></a><span id="l59.162" class="difflineminus">-    if (aliases.indexOf(aTraitAliasIndex.toString()) == -1)</span>
<a href="#l59.163"></a><span id="l59.163" class="difflineminus">-    {</span>
<a href="#l59.164"></a><span id="l59.164" class="difflineplus">+    if (!aliases.includes(aTraitAliasIndex.toString())) {</span>
<a href="#l59.165"></a><span id="l59.165">       aliases.push(aTraitAliasIndex);</span>
<a href="#l59.166"></a><span id="l59.166">       traitsBranch.setCharPref(&quot;aliases.&quot; + aTraitIndex, aliases.join());</span>
<a href="#l59.167"></a><span id="l59.167">     }</span>
<a href="#l59.168"></a><span id="l59.168">   },</span>
<a href="#l59.169"></a><span id="l59.169"> </span>
<a href="#l59.170"></a><span id="l59.170" class="difflineminus">-  removeAlias: function removeAlias(aTraitIndex, aTraitAliasIndex)</span>
<a href="#l59.171"></a><span id="l59.171" class="difflineminus">-  {</span>
<a href="#l59.172"></a><span id="l59.172" class="difflineminus">-    let aliasesString = &quot;&quot;;</span>
<a href="#l59.173"></a><span id="l59.173" class="difflineminus">-    try {</span>
<a href="#l59.174"></a><span id="l59.174" class="difflineminus">-      aliasesString = traitsBranch.getCharPref(&quot;aliases.&quot; + aTraitIndex);</span>
<a href="#l59.175"></a><span id="l59.175" class="difflineminus">-    }</span>
<a href="#l59.176"></a><span id="l59.176" class="difflineminus">-    catch (e) {</span>
<a href="#l59.177"></a><span id="l59.177" class="difflineminus">-      return;</span>
<a href="#l59.178"></a><span id="l59.178" class="difflineminus">-    }</span>
<a href="#l59.179"></a><span id="l59.179" class="difflineplus">+  removeAlias(aTraitIndex, aTraitAliasIndex) {</span>
<a href="#l59.180"></a><span id="l59.180" class="difflineplus">+    let aliasesString = traitsBranch.getCharPref(&quot;aliases.&quot; + aTraitIndex, &quot;&quot;);</span>
<a href="#l59.181"></a><span id="l59.181">     let aliases;</span>
<a href="#l59.182"></a><span id="l59.182">     if (aliasesString.length)</span>
<a href="#l59.183"></a><span id="l59.183">       aliases = aliasesString.split(&quot;,&quot;);</span>
<a href="#l59.184"></a><span id="l59.184">     else</span>
<a href="#l59.185"></a><span id="l59.185">       aliases = [];</span>
<a href="#l59.186"></a><span id="l59.186" class="difflineminus">-    let location;</span>
<a href="#l59.187"></a><span id="l59.187" class="difflineminus">-    if ((location = aliases.indexOf(aTraitAliasIndex.toString())) != -1)</span>
<a href="#l59.188"></a><span id="l59.188" class="difflineminus">-    {</span>
<a href="#l59.189"></a><span id="l59.189" class="difflineplus">+    let location = aliases.indexOf(aTraitAliasIndex.toString());</span>
<a href="#l59.190"></a><span id="l59.190" class="difflineplus">+    if (location != -1) {</span>
<a href="#l59.191"></a><span id="l59.191">       aliases.splice(location, 1);</span>
<a href="#l59.192"></a><span id="l59.192">       traitsBranch.setCharPref(&quot;aliases.&quot; + aTraitIndex, aliases.join());</span>
<a href="#l59.193"></a><span id="l59.193">     }</span>
<a href="#l59.194"></a><span id="l59.194">   },</span>
<a href="#l59.195"></a><span id="l59.195"> </span>
<a href="#l59.196"></a><span id="l59.196" class="difflineminus">-  getAliases: function getAliases(aTraitIndex, aLength)</span>
<a href="#l59.197"></a><span id="l59.197" class="difflineminus">-  {</span>
<a href="#l59.198"></a><span id="l59.198" class="difflineminus">-    let aliasesString = &quot;&quot;;</span>
<a href="#l59.199"></a><span id="l59.199" class="difflineminus">-    try {</span>
<a href="#l59.200"></a><span id="l59.200" class="difflineminus">-      aliasesString = traitsBranch.getCharPref(&quot;aliases.&quot; + aTraitIndex);</span>
<a href="#l59.201"></a><span id="l59.201" class="difflineminus">-    }</span>
<a href="#l59.202"></a><span id="l59.202" class="difflineminus">-    catch (e) {}</span>
<a href="#l59.203"></a><span id="l59.203" class="difflineminus">-</span>
<a href="#l59.204"></a><span id="l59.204" class="difflineplus">+  getAliases(aTraitIndex, aLength) {</span>
<a href="#l59.205"></a><span id="l59.205" class="difflineplus">+    let aliasesString = traitsBranch.getCharPref(&quot;aliases.&quot; + aTraitIndex, &quot;&quot;);</span>
<a href="#l59.206"></a><span id="l59.206">     let aliases;</span>
<a href="#l59.207"></a><span id="l59.207">     if (aliasesString.length)</span>
<a href="#l59.208"></a><span id="l59.208">       aliases = aliasesString.split(&quot;,&quot;);</span>
<a href="#l59.209"></a><span id="l59.209">     else</span>
<a href="#l59.210"></a><span id="l59.210">       aliases = [];</span>
<a href="#l59.211"></a><span id="l59.211">     aLength.value = aliases.length;</span>
<a href="#l59.212"></a><span id="l59.212">     return aliases;</span>
<a href="#l59.213"></a><span id="l59.213">   },</span>
<a href="#l59.214"></a><span id="l59.214"> };</span>
<a href="#l59.215"></a><span id="l59.215"> </span>
<a href="#l59.216"></a><span id="l59.216"> // initialization</span>
<a href="#l59.217"></a><span id="l59.217"> </span>
<a href="#l59.218"></a><span id="l59.218"> _init();</span>
<a href="#l59.219"></a><span id="l59.219"> </span>
<a href="#l59.220"></a><span id="l59.220" class="difflineminus">-function _init()</span>
<a href="#l59.221"></a><span id="l59.221" class="difflineminus">-{</span>
<a href="#l59.222"></a><span id="l59.222" class="difflineplus">+function _init() {</span>
<a href="#l59.223"></a><span id="l59.223">   // get existing traits</span>
<a href="#l59.224"></a><span id="l59.224">   var idBranch = Services.prefs.getBranch(&quot;mailnews.traits.id.&quot;);</span>
<a href="#l59.225"></a><span id="l59.225">   var nameBranch = Services.prefs.getBranch(&quot;mailnews.traits.name.&quot;);</span>
<a href="#l59.226"></a><span id="l59.226">   var enabledBranch = Services.prefs.getBranch(&quot;mailnews.traits.enabled.&quot;);</span>
<a href="#l59.227"></a><span id="l59.227">   var antiIdBranch = Services.prefs.getBranch(&quot;mailnews.traits.antiId.&quot;);</span>
<a href="#l59.228"></a><span id="l59.228">   _lastIndex = Services.prefs.getBranch(&quot;mailnews.traits.&quot;).getIntPref(&quot;lastIndex&quot;);</span>
<a href="#l59.229"></a><span id="l59.229">   var ids = idBranch.getChildList(&quot;&quot;);</span>
<a href="#l59.230"></a><span id="l59.230" class="difflineminus">-  for (var i = 0; i &lt; ids.length; i++)</span>
<a href="#l59.231"></a><span id="l59.231" class="difflineminus">-  {</span>
<a href="#l59.232"></a><span id="l59.232" class="difflineplus">+  for (let i = 0; i &lt; ids.length; i++) {</span>
<a href="#l59.233"></a><span id="l59.233">     var id = idBranch.getCharPref(ids[i]);</span>
<a href="#l59.234"></a><span id="l59.234">     var index = parseInt(ids[i]);</span>
<a href="#l59.235"></a><span id="l59.235">     _registerTrait(id, index, false);</span>
<a href="#l59.236"></a><span id="l59.236"> </span>
<a href="#l59.237"></a><span id="l59.237" class="difflineminus">-    // Read in values, ignore errors since that usually means the</span>
<a href="#l59.238"></a><span id="l59.238" class="difflineminus">-    // value does not exist</span>
<a href="#l59.239"></a><span id="l59.239" class="difflineminus">-    try {</span>
<a href="#l59.240"></a><span id="l59.240" class="difflineplus">+    if (nameBranch.getPrefType(ids[i]) == Services.prefs.PREF_STRING) {</span>
<a href="#l59.241"></a><span id="l59.241">       _traits[id].name = nameBranch.getCharPref(ids[i]);</span>
<a href="#l59.242"></a><span id="l59.242">     }</span>
<a href="#l59.243"></a><span id="l59.243" class="difflineminus">-    catch (e) {}</span>
<a href="#l59.244"></a><span id="l59.244" class="difflineminus">-</span>
<a href="#l59.245"></a><span id="l59.245" class="difflineminus">-    try {</span>
<a href="#l59.246"></a><span id="l59.246" class="difflineplus">+    if (enabledBranch.getPrefType(ids[i]) == Services.prefs.PREF_BOOL) {</span>
<a href="#l59.247"></a><span id="l59.247">       _traits[id].enabled = enabledBranch.getBoolPref(ids[i]);</span>
<a href="#l59.248"></a><span id="l59.248">     }</span>
<a href="#l59.249"></a><span id="l59.249" class="difflineminus">-    catch (e) {}</span>
<a href="#l59.250"></a><span id="l59.250" class="difflineminus">-</span>
<a href="#l59.251"></a><span id="l59.251" class="difflineminus">-    try {</span>
<a href="#l59.252"></a><span id="l59.252" class="difflineplus">+    if (antiIdBranch.getPrefType(ids[i]) == Services.prefs.PREF_STRING) {</span>
<a href="#l59.253"></a><span id="l59.253">       _traits[id].antiId = antiIdBranch.getCharPref(ids[i]);</span>
<a href="#l59.254"></a><span id="l59.254">     }</span>
<a href="#l59.255"></a><span id="l59.255" class="difflineminus">-    catch (e) {}</span>
<a href="#l59.256"></a><span id="l59.256"> </span>
<a href="#l59.257"></a><span id="l59.257">     if (_lastIndex &lt; index)</span>
<a href="#l59.258"></a><span id="l59.258">       _lastIndex = index;</span>
<a href="#l59.259"></a><span id="l59.259">   }</span>
<a href="#l59.260"></a><span id="l59.260"> </span>
<a href="#l59.261"></a><span id="l59.261" class="difflineminus">-  //for (traitId in _traits)</span>
<a href="#l59.262"></a><span id="l59.262" class="difflineplus">+  // for (traitId in _traits)</span>
<a href="#l59.263"></a><span id="l59.263">   //  dump(&quot;\nindex of &quot; + traitId + &quot; is &quot; + _traits[traitId].index);</span>
<a href="#l59.264"></a><span id="l59.264" class="difflineminus">-  //dump(&quot;\n&quot;);</span>
<a href="#l59.265"></a><span id="l59.265" class="difflineplus">+  // dump(&quot;\n&quot;);</span>
<a href="#l59.266"></a><span id="l59.266"> }</span>
<a href="#l59.267"></a><span id="l59.267"> </span>
<a href="#l59.268"></a><span id="l59.268"> var components = [nsMsgTraitService];</span>
<a href="#l59.269"></a><span id="l59.269"> var NSGetFactory = XPCOMUtils.generateNSGetFactory(components);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mailnews/base/src/folderLookupService.js</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mailnews/base/src/folderLookupService.js</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -37,17 +37,17 @@ function folderLookupService() {</span>
<a href="#l60.4"></a><span id="l60.4">   gCreated = true;</span>
<a href="#l60.5"></a><span id="l60.5"> }</span>
<a href="#l60.6"></a><span id="l60.6"> folderLookupService.prototype = {</span>
<a href="#l60.7"></a><span id="l60.7">   // XPCOM registration stuff</span>
<a href="#l60.8"></a><span id="l60.8">   QueryInterface: ChromeUtils.generateQI([Ci.nsIFolderLookupService]),</span>
<a href="#l60.9"></a><span id="l60.9">   classID: Components.ID(&quot;{a30be08c-afc8-4fed-9af7-79778a23db23}&quot;),</span>
<a href="#l60.10"></a><span id="l60.10"> </span>
<a href="#l60.11"></a><span id="l60.11">   // nsIFolderLookupService impl</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-  getFolderForURL: function (aUrl) {</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+  getFolderForURL(aUrl) {</span>
<a href="#l60.14"></a><span id="l60.14">     let folder = null;</span>
<a href="#l60.15"></a><span id="l60.15">     // First, see if the folder is in our cache.</span>
<a href="#l60.16"></a><span id="l60.16">     if (this._map.has(aUrl)) {</span>
<a href="#l60.17"></a><span id="l60.17">       let valid = false;</span>
<a href="#l60.18"></a><span id="l60.18">       try {</span>
<a href="#l60.19"></a><span id="l60.19">         folder = this._map.get(aUrl).QueryReferent(Ci.nsIMsgFolder);</span>
<a href="#l60.20"></a><span id="l60.20">         // We don't want to return &quot;dangling&quot; (parentless) folders.</span>
<a href="#l60.21"></a><span id="l60.21">         valid = isValidFolder(folder);</span>
<a href="#l60.22"></a><span id="l60.22" class="difflineat">@@ -80,34 +80,34 @@ folderLookupService.prototype = {</span>
<a href="#l60.23"></a><span id="l60.23"> </span>
<a href="#l60.24"></a><span id="l60.24">     // Add the new folder to our map. Store a weak reference instead, so that</span>
<a href="#l60.25"></a><span id="l60.25">     // the folder can be closed when necessary.</span>
<a href="#l60.26"></a><span id="l60.26">     let weakRef = folder.QueryInterface(Ci.nsISupportsWeakReference)</span>
<a href="#l60.27"></a><span id="l60.27">                         .GetWeakReference();</span>
<a href="#l60.28"></a><span id="l60.28">     this._map.set(aUrl, weakRef);</span>
<a href="#l60.29"></a><span id="l60.29">     return folder;</span>
<a href="#l60.30"></a><span id="l60.30">   },</span>
<a href="#l60.31"></a><span id="l60.31" class="difflineminus">-  getOrCreateFolderForURL: function (aUrl) {</span>
<a href="#l60.32"></a><span id="l60.32" class="difflineplus">+  getOrCreateFolderForURL(aUrl) {</span>
<a href="#l60.33"></a><span id="l60.33">     // Check that aUrl has an active scheme, in case this folder is from</span>
<a href="#l60.34"></a><span id="l60.34">     // an extension that is currently disabled or hasn't started up yet.</span>
<a href="#l60.35"></a><span id="l60.35">     // Extract the scheme in the same way that the RDF service does.</span>
<a href="#l60.36"></a><span id="l60.36">     let scheme = aUrl.match(/\w*/)[0];</span>
<a href="#l60.37"></a><span id="l60.37">     let contractID = &quot;@mozilla.org/rdf/resource-factory;1?name=&quot; + scheme;</span>
<a href="#l60.38"></a><span id="l60.38" class="difflineminus">-    if (!(contractID in Components.classes))</span>
<a href="#l60.39"></a><span id="l60.39" class="difflineplus">+    if (!(contractID in Cc))</span>
<a href="#l60.40"></a><span id="l60.40">       return null;</span>
<a href="#l60.41"></a><span id="l60.41"> </span>
<a href="#l60.42"></a><span id="l60.42">     // NOTE: this doesn't update _map, but it'll work fine and</span>
<a href="#l60.43"></a><span id="l60.43">     // it's a transitional function we want deleted anyway.</span>
<a href="#l60.44"></a><span id="l60.44">     let rdf = Cc[&quot;@mozilla.org/rdf/rdf-service;1&quot;]</span>
<a href="#l60.45"></a><span id="l60.45">                 .getService(Ci.nsIRDFService);</span>
<a href="#l60.46"></a><span id="l60.46">     try {</span>
<a href="#l60.47"></a><span id="l60.47">       let folder = rdf.GetResource(aUrl)</span>
<a href="#l60.48"></a><span id="l60.48">                       .QueryInterface(Ci.nsIMsgFolder);</span>
<a href="#l60.49"></a><span id="l60.49">       return folder;</span>
<a href="#l60.50"></a><span id="l60.50">     } catch (e) {</span>
<a href="#l60.51"></a><span id="l60.51">       // If the QI fails, then we somehow picked up an RDF resource that isn't</span>
<a href="#l60.52"></a><span id="l60.52">       // a folder. Return null in this case.</span>
<a href="#l60.53"></a><span id="l60.53">       return null;</span>
<a href="#l60.54"></a><span id="l60.54">     }</span>
<a href="#l60.55"></a><span id="l60.55" class="difflineminus">-  }</span>
<a href="#l60.56"></a><span id="l60.56" class="difflineplus">+  },</span>
<a href="#l60.57"></a><span id="l60.57"> };</span>
<a href="#l60.58"></a><span id="l60.58"> </span>
<a href="#l60.59"></a><span id="l60.59"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([folderLookupService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mailnews/base/src/msgAsyncPrompter.js</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mailnews/base/src/msgAsyncPrompter.js</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -11,22 +11,22 @@ function runnablePrompter(asyncPrompter,</span>
<a href="#l61.4"></a><span id="l61.4">   this._asyncPrompter = asyncPrompter;</span>
<a href="#l61.5"></a><span id="l61.5">   this._hashKey = hashKey;</span>
<a href="#l61.6"></a><span id="l61.6"> }</span>
<a href="#l61.7"></a><span id="l61.7"> </span>
<a href="#l61.8"></a><span id="l61.8"> runnablePrompter.prototype = {</span>
<a href="#l61.9"></a><span id="l61.9">   _asyncPrompter: null,</span>
<a href="#l61.10"></a><span id="l61.10">   _hashKey: null,</span>
<a href="#l61.11"></a><span id="l61.11"> </span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-  _promiseAuthPrompt: function(listener) {</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineplus">+  _promiseAuthPrompt(listener) {</span>
<a href="#l61.14"></a><span id="l61.14">     return new Promise((resolve, reject) =&gt; {</span>
<a href="#l61.15"></a><span id="l61.15">       try {</span>
<a href="#l61.16"></a><span id="l61.16">         listener.onPromptStartAsync({ onAuthResult: resolve });</span>
<a href="#l61.17"></a><span id="l61.17">       } catch (e) {</span>
<a href="#l61.18"></a><span id="l61.18" class="difflineminus">-        if (e.result == Components.results.NS_ERROR_XPC_JSOBJECT_HAS_NO_FUNCTION_NAMED) {</span>
<a href="#l61.19"></a><span id="l61.19" class="difflineplus">+        if (e.result == Cr.NS_ERROR_XPC_JSOBJECT_HAS_NO_FUNCTION_NAMED) {</span>
<a href="#l61.20"></a><span id="l61.20">           // Fall back to onPromptStart, for add-ons compat</span>
<a href="#l61.21"></a><span id="l61.21">           Deprecated.warning(&quot;onPromptStart has been replaced by onPromptStartAsync&quot;,</span>
<a href="#l61.22"></a><span id="l61.22">                              &quot;https://bugzilla.mozilla.org/show_bug.cgi?id=1176399&quot;);</span>
<a href="#l61.23"></a><span id="l61.23">           let ok = listener.onPromptStart();</span>
<a href="#l61.24"></a><span id="l61.24">           resolve(ok);</span>
<a href="#l61.25"></a><span id="l61.25">         } else {</span>
<a href="#l61.26"></a><span id="l61.26">           reject(e);</span>
<a href="#l61.27"></a><span id="l61.27">         }</span>
<a href="#l61.28"></a><span id="l61.28" class="difflineat">@@ -59,17 +59,17 @@ runnablePrompter.prototype = {</span>
<a href="#l61.29"></a><span id="l61.29">         // Log the error for extension devs and others to pick up.</span>
<a href="#l61.30"></a><span id="l61.30">         Cu.reportError(&quot;runnablePrompter:run: consumer.onPrompt* reported an exception: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l61.31"></a><span id="l61.31">       }</span>
<a href="#l61.32"></a><span id="l61.32">     }</span>
<a href="#l61.33"></a><span id="l61.33">     this._asyncPrompter._asyncPromptInProgress--;</span>
<a href="#l61.34"></a><span id="l61.34"> </span>
<a href="#l61.35"></a><span id="l61.35">     this._asyncPrompter._log.debug(&quot;Finished running prompter for &quot; + this._hashKey);</span>
<a href="#l61.36"></a><span id="l61.36">     this._asyncPrompter._doAsyncAuthPrompt();</span>
<a href="#l61.37"></a><span id="l61.37" class="difflineminus">-  }</span>
<a href="#l61.38"></a><span id="l61.38" class="difflineplus">+  },</span>
<a href="#l61.39"></a><span id="l61.39"> };</span>
<a href="#l61.40"></a><span id="l61.40"> </span>
<a href="#l61.41"></a><span id="l61.41"> function msgAsyncPrompter() {</span>
<a href="#l61.42"></a><span id="l61.42">   this._pendingPrompts = {};</span>
<a href="#l61.43"></a><span id="l61.43">   // By default, only log warnings to the error console and errors to dump().</span>
<a href="#l61.44"></a><span id="l61.44">   // You can use the preferences:</span>
<a href="#l61.45"></a><span id="l61.45">   //   msgAsyncPrompter.logging.console</span>
<a href="#l61.46"></a><span id="l61.46">   //   msgAsyncPrompter.logging.dump</span>
<a href="#l61.47"></a><span id="l61.47" class="difflineat">@@ -83,43 +83,43 @@ function msgAsyncPrompter() {</span>
<a href="#l61.48"></a><span id="l61.48"> msgAsyncPrompter.prototype = {</span>
<a href="#l61.49"></a><span id="l61.49">   classID: Components.ID(&quot;{49b04761-23dd-45d7-903d-619418a4d319}&quot;),</span>
<a href="#l61.50"></a><span id="l61.50">   QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgAsyncPrompter]),</span>
<a href="#l61.51"></a><span id="l61.51"> </span>
<a href="#l61.52"></a><span id="l61.52">   _pendingPrompts: null,</span>
<a href="#l61.53"></a><span id="l61.53">   _asyncPromptInProgress: 0,</span>
<a href="#l61.54"></a><span id="l61.54">   _log: null,</span>
<a href="#l61.55"></a><span id="l61.55"> </span>
<a href="#l61.56"></a><span id="l61.56" class="difflineminus">-  queueAsyncAuthPrompt: function(aKey, aJumpQueue, aCaller) {</span>
<a href="#l61.57"></a><span id="l61.57" class="difflineplus">+  queueAsyncAuthPrompt(aKey, aJumpQueue, aCaller) {</span>
<a href="#l61.58"></a><span id="l61.58">     if (aKey in this._pendingPrompts) {</span>
<a href="#l61.59"></a><span id="l61.59">       this._log.debug(&quot;Prompt bound to an existing one in the queue, key: &quot; + aKey);</span>
<a href="#l61.60"></a><span id="l61.60">       this._pendingPrompts[aKey].consumers.push(aCaller);</span>
<a href="#l61.61"></a><span id="l61.61">       return;</span>
<a href="#l61.62"></a><span id="l61.62">     }</span>
<a href="#l61.63"></a><span id="l61.63"> </span>
<a href="#l61.64"></a><span id="l61.64">     this._log.debug(&quot;Adding new prompt to the queue, key: &quot; + aKey);</span>
<a href="#l61.65"></a><span id="l61.65">     let asyncPrompt = {</span>
<a href="#l61.66"></a><span id="l61.66">       first: aCaller,</span>
<a href="#l61.67"></a><span id="l61.67" class="difflineminus">-      consumers: []</span>
<a href="#l61.68"></a><span id="l61.68" class="difflineplus">+      consumers: [],</span>
<a href="#l61.69"></a><span id="l61.69">     };</span>
<a href="#l61.70"></a><span id="l61.70"> </span>
<a href="#l61.71"></a><span id="l61.71">     this._pendingPrompts[aKey] = asyncPrompt;</span>
<a href="#l61.72"></a><span id="l61.72">     if (aJumpQueue) {</span>
<a href="#l61.73"></a><span id="l61.73">       this._asyncPromptInProgress++;</span>
<a href="#l61.74"></a><span id="l61.74"> </span>
<a href="#l61.75"></a><span id="l61.75">       this._log.debug(&quot;Forcing runnablePrompter for &quot; + aKey);</span>
<a href="#l61.76"></a><span id="l61.76"> </span>
<a href="#l61.77"></a><span id="l61.77">       let runnable = new runnablePrompter(this, aKey);</span>
<a href="#l61.78"></a><span id="l61.78">       Services.tm.mainThread.dispatch(runnable, Ci.nsIThread.DISPATCH_NORMAL);</span>
<a href="#l61.79"></a><span id="l61.79" class="difflineplus">+    } else {</span>
<a href="#l61.80"></a><span id="l61.80" class="difflineplus">+      this._doAsyncAuthPrompt();</span>
<a href="#l61.81"></a><span id="l61.81">     }</span>
<a href="#l61.82"></a><span id="l61.82" class="difflineminus">-    else</span>
<a href="#l61.83"></a><span id="l61.83" class="difflineminus">-      this._doAsyncAuthPrompt();</span>
<a href="#l61.84"></a><span id="l61.84">   },</span>
<a href="#l61.85"></a><span id="l61.85"> </span>
<a href="#l61.86"></a><span id="l61.86" class="difflineminus">-  _doAsyncAuthPrompt: function() {</span>
<a href="#l61.87"></a><span id="l61.87" class="difflineplus">+  _doAsyncAuthPrompt() {</span>
<a href="#l61.88"></a><span id="l61.88">     if (this._asyncPromptInProgress &gt; 0) {</span>
<a href="#l61.89"></a><span id="l61.89">       this._log.debug(&quot;_doAsyncAuthPrompt bypassed - prompt already in progress&quot;);</span>
<a href="#l61.90"></a><span id="l61.90">       return;</span>
<a href="#l61.91"></a><span id="l61.91">     }</span>
<a href="#l61.92"></a><span id="l61.92"> </span>
<a href="#l61.93"></a><span id="l61.93">     // Find the first prompt key we have in the queue.</span>
<a href="#l61.94"></a><span id="l61.94">     let hashKey = null;</span>
<a href="#l61.95"></a><span id="l61.95">     for (hashKey in this._pendingPrompts)</span>
<a href="#l61.96"></a><span id="l61.96" class="difflineat">@@ -129,13 +129,13 @@ msgAsyncPrompter.prototype = {</span>
<a href="#l61.97"></a><span id="l61.97">       return;</span>
<a href="#l61.98"></a><span id="l61.98"> </span>
<a href="#l61.99"></a><span id="l61.99">     this._asyncPromptInProgress++;</span>
<a href="#l61.100"></a><span id="l61.100"> </span>
<a href="#l61.101"></a><span id="l61.101">     this._log.debug(&quot;Dispatching runnablePrompter for &quot; + hashKey);</span>
<a href="#l61.102"></a><span id="l61.102"> </span>
<a href="#l61.103"></a><span id="l61.103">     let runnable = new runnablePrompter(this, hashKey);</span>
<a href="#l61.104"></a><span id="l61.104">     Services.tm.mainThread.dispatch(runnable, Ci.nsIThread.DISPATCH_NORMAL);</span>
<a href="#l61.105"></a><span id="l61.105" class="difflineminus">-  }</span>
<a href="#l61.106"></a><span id="l61.106" class="difflineplus">+  },</span>
<a href="#l61.107"></a><span id="l61.107"> };</span>
<a href="#l61.108"></a><span id="l61.108"> </span>
<a href="#l61.109"></a><span id="l61.109"> var components = [msgAsyncPrompter];</span>
<a href="#l61.110"></a><span id="l61.110"> var NSGetFactory = XPCOMUtils.generateNSGetFactory(components);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mailnews/base/src/msgOAuth2Module.js</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mailnews/base/src/msgOAuth2Module.js</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l62.4"></a><span id="l62.4"> &quot;use strict&quot;;</span>
<a href="#l62.5"></a><span id="l62.5"> </span>
<a href="#l62.6"></a><span id="l62.6"> var {OAuth2} = ChromeUtils.import(&quot;resource:///modules/OAuth2.jsm&quot;);</span>
<a href="#l62.7"></a><span id="l62.7"> var {OAuth2Providers} = ChromeUtils.import(&quot;resource:///modules/OAuth2Providers.jsm&quot;);</span>
<a href="#l62.8"></a><span id="l62.8"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l62.9"></a><span id="l62.9"> var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l62.10"></a><span id="l62.10"> </span>
<a href="#l62.11"></a><span id="l62.11"> function OAuth2Module() {</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-  this._refreshToken = '';</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+  this._refreshToken = &quot;&quot;;</span>
<a href="#l62.14"></a><span id="l62.14"> }</span>
<a href="#l62.15"></a><span id="l62.15"> OAuth2Module.prototype = {</span>
<a href="#l62.16"></a><span id="l62.16">   // XPCOM registration stuff</span>
<a href="#l62.17"></a><span id="l62.17">   QueryInterface: ChromeUtils.generateQI([Ci.msgIOAuth2Module]),</span>
<a href="#l62.18"></a><span id="l62.18">   classID: Components.ID(&quot;{b63d8e4c-bf60-439b-be0e-7c9f67291042}&quot;),</span>
<a href="#l62.19"></a><span id="l62.19"> </span>
<a href="#l62.20"></a><span id="l62.20">   _loadOAuthClientDetails(aIssuer) {</span>
<a href="#l62.21"></a><span id="l62.21">     let details = OAuth2Providers.getIssuerDetails(aIssuer);</span>
<a href="#l62.22"></a><span id="l62.22" class="difflineat">@@ -37,24 +37,23 @@ OAuth2Module.prototype = {</span>
<a href="#l62.23"></a><span id="l62.23">     let issuer = Services.prefs.getStringPref(root + &quot;oauth2.issuer&quot;, &quot;&quot;);</span>
<a href="#l62.24"></a><span id="l62.24">     let scope = Services.prefs.getStringPref(root + &quot;oauth2.scope&quot;, &quot;&quot;);</span>
<a href="#l62.25"></a><span id="l62.25"> </span>
<a href="#l62.26"></a><span id="l62.26">     // These properties are absolutely essential to OAuth2 support. If we don't</span>
<a href="#l62.27"></a><span id="l62.27">     // have them, we don't support OAuth2.</span>
<a href="#l62.28"></a><span id="l62.28">     if (!issuer || !scope) {</span>
<a href="#l62.29"></a><span id="l62.29">       // Since we currently only support gmail, init values if server matches.</span>
<a href="#l62.30"></a><span id="l62.30">       let details = OAuth2Providers.getHostnameDetails(aHostname);</span>
<a href="#l62.31"></a><span id="l62.31" class="difflineminus">-      if (details)</span>
<a href="#l62.32"></a><span id="l62.32" class="difflineminus">-      {</span>
<a href="#l62.33"></a><span id="l62.33" class="difflineplus">+      if (details) {</span>
<a href="#l62.34"></a><span id="l62.34">         [issuer, scope] = details;</span>
<a href="#l62.35"></a><span id="l62.35">         Services.prefs.setStringPref(root + &quot;oauth2.issuer&quot;, issuer);</span>
<a href="#l62.36"></a><span id="l62.36">         Services.prefs.setStringPref(root + &quot;oauth2.scope&quot;, scope);</span>
<a href="#l62.37"></a><span id="l62.37" class="difflineplus">+      } else {</span>
<a href="#l62.38"></a><span id="l62.38" class="difflineplus">+        return false;</span>
<a href="#l62.39"></a><span id="l62.39">       }</span>
<a href="#l62.40"></a><span id="l62.40" class="difflineminus">-      else</span>
<a href="#l62.41"></a><span id="l62.41" class="difflineminus">-        return false;</span>
<a href="#l62.42"></a><span id="l62.42">     }</span>
<a href="#l62.43"></a><span id="l62.43"> </span>
<a href="#l62.44"></a><span id="l62.44">     // Find the app key we need for the OAuth2 string. Eventually, this should</span>
<a href="#l62.45"></a><span id="l62.45">     // be using dynamic client registration, but there are no current</span>
<a href="#l62.46"></a><span id="l62.46">     // implementations that we can test this with.</span>
<a href="#l62.47"></a><span id="l62.47">     this._loadOAuthClientDetails(issuer);</span>
<a href="#l62.48"></a><span id="l62.48"> </span>
<a href="#l62.49"></a><span id="l62.49">     // Username is needed to generate the XOAUTH2 string.</span>
<a href="#l62.50"></a><span id="l62.50" class="difflineat">@@ -67,97 +66,97 @@ OAuth2Module.prototype = {</span>
<a href="#l62.51"></a><span id="l62.51">     // Define the OAuth property and store it.</span>
<a href="#l62.52"></a><span id="l62.52">     this._oauth = new OAuth2(this._authURI, scope, this._appKey,</span>
<a href="#l62.53"></a><span id="l62.53">       this._appSecret);</span>
<a href="#l62.54"></a><span id="l62.54">     this._oauth.authURI = this._authURI;</span>
<a href="#l62.55"></a><span id="l62.55">     this._oauth.tokenURI = this._tokenURI;</span>
<a href="#l62.56"></a><span id="l62.56"> </span>
<a href="#l62.57"></a><span id="l62.57">     // Try hinting the username...</span>
<a href="#l62.58"></a><span id="l62.58">     this._oauth.extraAuthParams = [</span>
<a href="#l62.59"></a><span id="l62.59" class="difflineminus">-      [&quot;login_hint&quot;, aUsername]</span>
<a href="#l62.60"></a><span id="l62.60" class="difflineplus">+      [&quot;login_hint&quot;, aUsername],</span>
<a href="#l62.61"></a><span id="l62.61">     ];</span>
<a href="#l62.62"></a><span id="l62.62"> </span>
<a href="#l62.63"></a><span id="l62.63">     // Set the window title to something more useful than &quot;Unnamed&quot;</span>
<a href="#l62.64"></a><span id="l62.64">     this._oauth.requestWindowTitle =</span>
<a href="#l62.65"></a><span id="l62.65">       Services.strings.createBundle(&quot;chrome://messenger/locale/messenger.properties&quot;)</span>
<a href="#l62.66"></a><span id="l62.66">                       .formatStringFromName(&quot;oauth2WindowTitle&quot;,</span>
<a href="#l62.67"></a><span id="l62.67">                                             [aUsername, aHostname], 2);</span>
<a href="#l62.68"></a><span id="l62.68"> </span>
<a href="#l62.69"></a><span id="l62.69">     // This stores the refresh token in the login manager.</span>
<a href="#l62.70"></a><span id="l62.70">     Object.defineProperty(this._oauth, &quot;refreshToken&quot;, {</span>
<a href="#l62.71"></a><span id="l62.71">       get: () =&gt; this.refreshToken,</span>
<a href="#l62.72"></a><span id="l62.72" class="difflineminus">-      set: (token) =&gt; this.refreshToken = token</span>
<a href="#l62.73"></a><span id="l62.73" class="difflineplus">+      set: (token) =&gt; this.refreshToken = token,</span>
<a href="#l62.74"></a><span id="l62.74">     });</span>
<a href="#l62.75"></a><span id="l62.75"> </span>
<a href="#l62.76"></a><span id="l62.76">     return true;</span>
<a href="#l62.77"></a><span id="l62.77">   },</span>
<a href="#l62.78"></a><span id="l62.78"> </span>
<a href="#l62.79"></a><span id="l62.79">   get refreshToken() {</span>
<a href="#l62.80"></a><span id="l62.80">     let logins = Services.logins.findLogins({}, this._loginUrl, null, this._scope);</span>
<a href="#l62.81"></a><span id="l62.81">     for (let login of logins) {</span>
<a href="#l62.82"></a><span id="l62.82">       if (login.username == this._username)</span>
<a href="#l62.83"></a><span id="l62.83">         return login.password;</span>
<a href="#l62.84"></a><span id="l62.84">     }</span>
<a href="#l62.85"></a><span id="l62.85" class="difflineminus">-    return '';</span>
<a href="#l62.86"></a><span id="l62.86" class="difflineplus">+    return &quot;&quot;;</span>
<a href="#l62.87"></a><span id="l62.87">   },</span>
<a href="#l62.88"></a><span id="l62.88">   set refreshToken(token) {</span>
<a href="#l62.89"></a><span id="l62.89">     // Check if we already have a login with this username, and modify the</span>
<a href="#l62.90"></a><span id="l62.90">     // password on that, if we do.</span>
<a href="#l62.91"></a><span id="l62.91">     let logins = Services.logins.findLogins({}, this._loginUrl, null, this._scope);</span>
<a href="#l62.92"></a><span id="l62.92">     for (let login of logins) {</span>
<a href="#l62.93"></a><span id="l62.93">       if (login.username == this._username) {</span>
<a href="#l62.94"></a><span id="l62.94">         if (token) {</span>
<a href="#l62.95"></a><span id="l62.95">           let propBag = Cc[&quot;@mozilla.org/hash-property-bag;1&quot;].</span>
<a href="#l62.96"></a><span id="l62.96">                         createInstance(Ci.nsIWritablePropertyBag);</span>
<a href="#l62.97"></a><span id="l62.97">           propBag.setProperty(&quot;password&quot;, token);</span>
<a href="#l62.98"></a><span id="l62.98">           Services.logins.modifyLogin(login, propBag);</span>
<a href="#l62.99"></a><span id="l62.99" class="difflineplus">+        } else {</span>
<a href="#l62.100"></a><span id="l62.100" class="difflineplus">+          Services.logins.removeLogin(login);</span>
<a href="#l62.101"></a><span id="l62.101">         }</span>
<a href="#l62.102"></a><span id="l62.102" class="difflineminus">-        else</span>
<a href="#l62.103"></a><span id="l62.103" class="difflineminus">-          Services.logins.removeLogin(login);</span>
<a href="#l62.104"></a><span id="l62.104">         return token;</span>
<a href="#l62.105"></a><span id="l62.105">       }</span>
<a href="#l62.106"></a><span id="l62.106">     }</span>
<a href="#l62.107"></a><span id="l62.107"> </span>
<a href="#l62.108"></a><span id="l62.108">     // Unless the token is null, we need to create and fill in a new login</span>
<a href="#l62.109"></a><span id="l62.109">     if (token) {</span>
<a href="#l62.110"></a><span id="l62.110">       let login = Cc[&quot;@mozilla.org/login-manager/loginInfo;1&quot;]</span>
<a href="#l62.111"></a><span id="l62.111">                     .createInstance(Ci.nsILoginInfo);</span>
<a href="#l62.112"></a><span id="l62.112">       login.init(this._loginUrl, null, this._scope, this._username, token,</span>
<a href="#l62.113"></a><span id="l62.113" class="difflineminus">-        '', '');</span>
<a href="#l62.114"></a><span id="l62.114" class="difflineplus">+        &quot;&quot;, &quot;&quot;);</span>
<a href="#l62.115"></a><span id="l62.115">       Services.logins.addLogin(login);</span>
<a href="#l62.116"></a><span id="l62.116">     }</span>
<a href="#l62.117"></a><span id="l62.117">     return token;</span>
<a href="#l62.118"></a><span id="l62.118">   },</span>
<a href="#l62.119"></a><span id="l62.119"> </span>
<a href="#l62.120"></a><span id="l62.120">   connect(aWithUI, aListener) {</span>
<a href="#l62.121"></a><span id="l62.121">     let oauth = this._oauth;</span>
<a href="#l62.122"></a><span id="l62.122">     let promptlistener = {</span>
<a href="#l62.123"></a><span id="l62.123" class="difflineminus">-      onPromptStartAsync: function(callback) {</span>
<a href="#l62.124"></a><span id="l62.124" class="difflineplus">+      onPromptStartAsync(callback) {</span>
<a href="#l62.125"></a><span id="l62.125">         this.onPromptAuthAvailable(callback);</span>
<a href="#l62.126"></a><span id="l62.126">       },</span>
<a href="#l62.127"></a><span id="l62.127"> </span>
<a href="#l62.128"></a><span id="l62.128">       onPromptAuthAvailable: (callback) =&gt; {</span>
<a href="#l62.129"></a><span id="l62.129">         oauth.connect(() =&gt; {</span>
<a href="#l62.130"></a><span id="l62.130">           aListener.onSuccess(btoa(`user=${this._username}\x01auth=Bearer ${oauth.accessToken}\x01\x01`));</span>
<a href="#l62.131"></a><span id="l62.131">           if (callback) {</span>
<a href="#l62.132"></a><span id="l62.132">             callback.onAuthResult(true);</span>
<a href="#l62.133"></a><span id="l62.133">           }</span>
<a href="#l62.134"></a><span id="l62.134">         }, () =&gt; {</span>
<a href="#l62.135"></a><span id="l62.135" class="difflineminus">-          aListener.onFailure(Components.results.NS_ERROR_ABORT);</span>
<a href="#l62.136"></a><span id="l62.136" class="difflineplus">+          aListener.onFailure(Cr.NS_ERROR_ABORT);</span>
<a href="#l62.137"></a><span id="l62.137">           if (callback) {</span>
<a href="#l62.138"></a><span id="l62.138">             callback.onAuthResult(false);</span>
<a href="#l62.139"></a><span id="l62.139">           }</span>
<a href="#l62.140"></a><span id="l62.140">         }, aWithUI, false);</span>
<a href="#l62.141"></a><span id="l62.141">       },</span>
<a href="#l62.142"></a><span id="l62.142" class="difflineminus">-      onPromptCanceled: function() {</span>
<a href="#l62.143"></a><span id="l62.143" class="difflineminus">-        aListener.onFailure(Components.results.NS_ERROR_ABORT);</span>
<a href="#l62.144"></a><span id="l62.144" class="difflineplus">+      onPromptCanceled() {</span>
<a href="#l62.145"></a><span id="l62.145" class="difflineplus">+        aListener.onFailure(Cr.NS_ERROR_ABORT);</span>
<a href="#l62.146"></a><span id="l62.146">       },</span>
<a href="#l62.147"></a><span id="l62.147" class="difflineminus">-      onPromptStart: function() {}</span>
<a href="#l62.148"></a><span id="l62.148" class="difflineplus">+      onPromptStart() {},</span>
<a href="#l62.149"></a><span id="l62.149">     };</span>
<a href="#l62.150"></a><span id="l62.150"> </span>
<a href="#l62.151"></a><span id="l62.151" class="difflineminus">-    let asyncprompter = Components.classes[&quot;@mozilla.org/messenger/msgAsyncPrompter;1&quot;]</span>
<a href="#l62.152"></a><span id="l62.152" class="difflineminus">-                                  .getService(Components.interfaces.nsIMsgAsyncPrompter);</span>
<a href="#l62.153"></a><span id="l62.153" class="difflineplus">+    let asyncprompter = Cc[&quot;@mozilla.org/messenger/msgAsyncPrompter;1&quot;]</span>
<a href="#l62.154"></a><span id="l62.154" class="difflineplus">+                          .getService(Ci.nsIMsgAsyncPrompter);</span>
<a href="#l62.155"></a><span id="l62.155">     let promptkey = this._loginUrl + &quot;/&quot; + this._username;</span>
<a href="#l62.156"></a><span id="l62.156">     asyncprompter.queueAsyncAuthPrompt(promptkey, false, promptlistener);</span>
<a href="#l62.157"></a><span id="l62.157">   },</span>
<a href="#l62.158"></a><span id="l62.158"> };</span>
<a href="#l62.159"></a><span id="l62.159"> </span>
<a href="#l62.160"></a><span id="l62.160"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([OAuth2Module]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mailnews/base/src/newMailNotificationService.js</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mailnews/base/src/newMailNotificationService.js</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -25,18 +25,17 @@ var countInboxesPref = &quot;mail.notificatio</span>
<a href="#l63.4"></a><span id="l63.4"> var countNewMessagesPref = &quot;mail.biff.use_new_count_in_mac_dock&quot;;</span>
<a href="#l63.5"></a><span id="l63.5"> // When we go cross-platform we should migrate to</span>
<a href="#l63.6"></a><span id="l63.6"> // const countNewMessagesPref = &quot;mail.notification.count.new&quot;;</span>
<a href="#l63.7"></a><span id="l63.7"> </span>
<a href="#l63.8"></a><span id="l63.8"> // Helper function to retrieve a boolean preference with a default</span>
<a href="#l63.9"></a><span id="l63.9"> function getBoolPref(pref, defaultValue) {</span>
<a href="#l63.10"></a><span id="l63.10">   try {</span>
<a href="#l63.11"></a><span id="l63.11">     return Services.prefs.getBoolPref(pref);</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-  }</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineminus">-  catch(e) {</span>
<a href="#l63.14"></a><span id="l63.14" class="difflineplus">+  } catch (e) {</span>
<a href="#l63.15"></a><span id="l63.15">     return defaultValue;</span>
<a href="#l63.16"></a><span id="l63.16">   }</span>
<a href="#l63.17"></a><span id="l63.17"> }</span>
<a href="#l63.18"></a><span id="l63.18"> </span>
<a href="#l63.19"></a><span id="l63.19"> </span>
<a href="#l63.20"></a><span id="l63.20"> // constructor</span>
<a href="#l63.21"></a><span id="l63.21"> function NewMailNotificationService() {</span>
<a href="#l63.22"></a><span id="l63.22">   this._mUnreadCount = 0;</span>
<a href="#l63.23"></a><span id="l63.23" class="difflineat">@@ -66,50 +65,47 @@ NewMailNotificationService.prototype = {</span>
<a href="#l63.24"></a><span id="l63.24">   _mNewCount: 0,</span>
<a href="#l63.25"></a><span id="l63.25">   _listeners: null,</span>
<a href="#l63.26"></a><span id="l63.26">   _log: null,</span>
<a href="#l63.27"></a><span id="l63.27"> </span>
<a href="#l63.28"></a><span id="l63.28">   get countNew() {</span>
<a href="#l63.29"></a><span id="l63.29">     return getBoolPref(countNewMessagesPref, false);</span>
<a href="#l63.30"></a><span id="l63.30">   },</span>
<a href="#l63.31"></a><span id="l63.31"> </span>
<a href="#l63.32"></a><span id="l63.32" class="difflineminus">-  observe: function NMNS_Observe(aSubject, aTopic, aData) {</span>
<a href="#l63.33"></a><span id="l63.33" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l63.34"></a><span id="l63.34">     // Set up to catch updates to unread count</span>
<a href="#l63.35"></a><span id="l63.35">     this._log.info(&quot;NMNS_Observe: &quot; + aTopic);</span>
<a href="#l63.36"></a><span id="l63.36"> </span>
<a href="#l63.37"></a><span id="l63.37">     try {</span>
<a href="#l63.38"></a><span id="l63.38">       if (aTopic == &quot;mail-startup-done&quot;) {</span>
<a href="#l63.39"></a><span id="l63.39">         try {</span>
<a href="#l63.40"></a><span id="l63.40">           Services.obs.removeObserver(this, &quot;mail-startup-done&quot;);</span>
<a href="#l63.41"></a><span id="l63.41" class="difflineminus">-        }</span>
<a href="#l63.42"></a><span id="l63.42" class="difflineminus">-        catch (e) {</span>
<a href="#l63.43"></a><span id="l63.43" class="difflineplus">+        } catch (e) {</span>
<a href="#l63.44"></a><span id="l63.44">           this._log.error(&quot;NMNS_Observe: unable to deregister mail-startup-done listener: &quot; + e);</span>
<a href="#l63.45"></a><span id="l63.45">         }</span>
<a href="#l63.46"></a><span id="l63.46">         Services.obs.addObserver(this, &quot;profile-before-change&quot;);</span>
<a href="#l63.47"></a><span id="l63.47">         MailServices.mailSession.AddFolderListener(this, Ci.nsIFolderListener.intPropertyChanged |</span>
<a href="#l63.48"></a><span id="l63.48">                                                          Ci.nsIFolderListener.added |</span>
<a href="#l63.49"></a><span id="l63.49">                                                          Ci.nsIFolderListener.removed |</span>
<a href="#l63.50"></a><span id="l63.50">                                                          Ci.nsIFolderListener.propertyFlagChanged);</span>
<a href="#l63.51"></a><span id="l63.51">         this._initUnreadCount();</span>
<a href="#l63.52"></a><span id="l63.52" class="difflineminus">-      }</span>
<a href="#l63.53"></a><span id="l63.53" class="difflineminus">-      else if (aTopic == &quot;profile-before-change&quot;) {</span>
<a href="#l63.54"></a><span id="l63.54" class="difflineplus">+      } else if (aTopic == &quot;profile-before-change&quot;) {</span>
<a href="#l63.55"></a><span id="l63.55">         try {</span>
<a href="#l63.56"></a><span id="l63.56">           MailServices.mailSession.RemoveFolderListener(this);</span>
<a href="#l63.57"></a><span id="l63.57">           Services.obs.removeObserver(this, &quot;profile-before-change&quot;);</span>
<a href="#l63.58"></a><span id="l63.58" class="difflineminus">-        }</span>
<a href="#l63.59"></a><span id="l63.59" class="difflineminus">-        catch (e) {</span>
<a href="#l63.60"></a><span id="l63.60" class="difflineplus">+        } catch (e) {</span>
<a href="#l63.61"></a><span id="l63.61">           this._log.error(&quot;NMNS_Observe: unable to deregister listeners at shutdown: &quot; + e);</span>
<a href="#l63.62"></a><span id="l63.62">         }</span>
<a href="#l63.63"></a><span id="l63.63">       }</span>
<a href="#l63.64"></a><span id="l63.64">     } catch (error) {</span>
<a href="#l63.65"></a><span id="l63.65">       this._log.error(&quot;NMNS_Observe failed: &quot; + error);</span>
<a href="#l63.66"></a><span id="l63.66">     }</span>
<a href="#l63.67"></a><span id="l63.67">   },</span>
<a href="#l63.68"></a><span id="l63.68"> </span>
<a href="#l63.69"></a><span id="l63.69" class="difflineminus">-  _initUnreadCount: function NMNS_initUnreadCount() {</span>
<a href="#l63.70"></a><span id="l63.70" class="difflineplus">+  _initUnreadCount() {</span>
<a href="#l63.71"></a><span id="l63.71">     let total = 0;</span>
<a href="#l63.72"></a><span id="l63.72">     let allServers = MailServices.accounts.allServers;</span>
<a href="#l63.73"></a><span id="l63.73">     for (let i = 0; i &lt; allServers.length; i++) {</span>
<a href="#l63.74"></a><span id="l63.74">       let currentServer = allServers.queryElementAt(i, Ci.nsIMsgIncomingServer);</span>
<a href="#l63.75"></a><span id="l63.75">       this._log.debug(&quot;NMNS_initUnread: server &quot; + currentServer.prettyName + &quot; type &quot; + currentServer.type);</span>
<a href="#l63.76"></a><span id="l63.76">       // Don't bother counting RSS or NNTP servers</span>
<a href="#l63.77"></a><span id="l63.77">       let type = currentServer.type;</span>
<a href="#l63.78"></a><span id="l63.78">       if (type == &quot;rss&quot; || type == &quot;nntp&quot;)</span>
<a href="#l63.79"></a><span id="l63.79" class="difflineat">@@ -123,17 +119,17 @@ NewMailNotificationService.prototype = {</span>
<a href="#l63.80"></a><span id="l63.80">     this._mUnreadCount = total;</span>
<a href="#l63.81"></a><span id="l63.81">     if (!this.countNew) {</span>
<a href="#l63.82"></a><span id="l63.82">       this._log.info(&quot;NMNS_initUnread notifying listeners: &quot; + total + &quot; total unread messages&quot;);</span>
<a href="#l63.83"></a><span id="l63.83">       this._notifyListeners(NMNS.count, &quot;onCountChanged&quot;, total);</span>
<a href="#l63.84"></a><span id="l63.84">     }</span>
<a href="#l63.85"></a><span id="l63.85">   },</span>
<a href="#l63.86"></a><span id="l63.86"> </span>
<a href="#l63.87"></a><span id="l63.87">   // Count all the unread messages below the given folder</span>
<a href="#l63.88"></a><span id="l63.88" class="difflineminus">-  _countUnread: function NMNS_countUnread(folder) {</span>
<a href="#l63.89"></a><span id="l63.89" class="difflineplus">+  _countUnread(folder) {</span>
<a href="#l63.90"></a><span id="l63.90">     this._log.trace(&quot;NMNS_countUnread: parent folder &quot; + folder.URI);</span>
<a href="#l63.91"></a><span id="l63.91">     let unreadCount = 0;</span>
<a href="#l63.92"></a><span id="l63.92"> </span>
<a href="#l63.93"></a><span id="l63.93">     if (this.confirmShouldCount(folder)) {</span>
<a href="#l63.94"></a><span id="l63.94">       let count = folder.getNumUnread(false);</span>
<a href="#l63.95"></a><span id="l63.95">       this._log.debug(&quot;NMNS_countUnread: folder &quot; + folder.URI + &quot;, &quot; + count + &quot; unread&quot;);</span>
<a href="#l63.96"></a><span id="l63.96">       if (count &gt; 0)</span>
<a href="#l63.97"></a><span id="l63.97">         unreadCount += count;</span>
<a href="#l63.98"></a><span id="l63.98" class="difflineat">@@ -148,18 +144,18 @@ NewMailNotificationService.prototype = {</span>
<a href="#l63.99"></a><span id="l63.99">           unreadCount += count;</span>
<a href="#l63.100"></a><span id="l63.100">       }</span>
<a href="#l63.101"></a><span id="l63.101">     }</span>
<a href="#l63.102"></a><span id="l63.102">     return unreadCount;</span>
<a href="#l63.103"></a><span id="l63.103">   },</span>
<a href="#l63.104"></a><span id="l63.104"> </span>
<a href="#l63.105"></a><span id="l63.105">   // Filter out special folders and then ask for observers to see if</span>
<a href="#l63.106"></a><span id="l63.106">   // we should monitor unread messages in this folder</span>
<a href="#l63.107"></a><span id="l63.107" class="difflineminus">-  confirmShouldCount: function NMNS_confirmShouldCount(aFolder) {</span>
<a href="#l63.108"></a><span id="l63.108" class="difflineminus">-    let shouldCount = Cc['@mozilla.org/supports-PRBool;1'].createInstance(Ci.nsISupportsPRBool);</span>
<a href="#l63.109"></a><span id="l63.109" class="difflineplus">+  confirmShouldCount(aFolder) {</span>
<a href="#l63.110"></a><span id="l63.110" class="difflineplus">+    let shouldCount = Cc[&quot;@mozilla.org/supports-PRBool;1&quot;].createInstance(Ci.nsISupportsPRBool);</span>
<a href="#l63.111"></a><span id="l63.111">     shouldCount.data = true;</span>
<a href="#l63.112"></a><span id="l63.112">     this._log.trace(&quot;NMNS_confirmShouldCount: folder &quot; + aFolder.URI + &quot; flags &quot; + aFolder.flags);</span>
<a href="#l63.113"></a><span id="l63.113">     let srv = null;</span>
<a href="#l63.114"></a><span id="l63.114"> </span>
<a href="#l63.115"></a><span id="l63.115">     // If it's not a mail folder we don't count it by default</span>
<a href="#l63.116"></a><span id="l63.116">     if (!(aFolder.flags &amp; Ci.nsMsgFolderFlags.Mail))</span>
<a href="#l63.117"></a><span id="l63.117">       shouldCount.data = false;</span>
<a href="#l63.118"></a><span id="l63.118"> </span>
<a href="#l63.119"></a><span id="l63.119" class="difflineat">@@ -186,36 +182,34 @@ NewMailNotificationService.prototype = {</span>
<a href="#l63.120"></a><span id="l63.120"> </span>
<a href="#l63.121"></a><span id="l63.121">     this._log.trace(&quot;NMNS_confirmShouldCount: before observers &quot; + shouldCount.data);</span>
<a href="#l63.122"></a><span id="l63.122">     Services.obs.notifyObservers(shouldCount, &quot;before-count-unread-for-folder&quot;, aFolder.URI);</span>
<a href="#l63.123"></a><span id="l63.123">     this._log.trace(&quot;NMNS_confirmShouldCount: after observers &quot; + shouldCount.data);</span>
<a href="#l63.124"></a><span id="l63.124"> </span>
<a href="#l63.125"></a><span id="l63.125">     return shouldCount.data;</span>
<a href="#l63.126"></a><span id="l63.126">   },</span>
<a href="#l63.127"></a><span id="l63.127"> </span>
<a href="#l63.128"></a><span id="l63.128" class="difflineminus">-  OnItemIntPropertyChanged: function NMNS_OnItemIntPropertyChanged(folder, property, oldValue, newValue) {</span>
<a href="#l63.129"></a><span id="l63.129" class="difflineplus">+  OnItemIntPropertyChanged(folder, property, oldValue, newValue) {</span>
<a href="#l63.130"></a><span id="l63.130">     try {</span>
<a href="#l63.131"></a><span id="l63.131">       if (property == &quot;FolderSize&quot;)</span>
<a href="#l63.132"></a><span id="l63.132">         return;</span>
<a href="#l63.133"></a><span id="l63.133">       this._log.trace(&quot;NMNS_OnItemIntPropertyChanged: folder &quot; + folder.URI + &quot; &quot; + property + &quot; &quot; + oldValue + &quot; &quot; + newValue);</span>
<a href="#l63.134"></a><span id="l63.134">       if (property == &quot;BiffState&quot;) {</span>
<a href="#l63.135"></a><span id="l63.135">         this._biffStateChanged(folder, oldValue, newValue);</span>
<a href="#l63.136"></a><span id="l63.136" class="difflineminus">-      }</span>
<a href="#l63.137"></a><span id="l63.137" class="difflineminus">-      else if (property == &quot;TotalUnreadMessages&quot;) {</span>
<a href="#l63.138"></a><span id="l63.138" class="difflineplus">+      } else if (property == &quot;TotalUnreadMessages&quot;) {</span>
<a href="#l63.139"></a><span id="l63.139">         this._updateUnreadCount(folder, oldValue, newValue);</span>
<a href="#l63.140"></a><span id="l63.140" class="difflineminus">-      }</span>
<a href="#l63.141"></a><span id="l63.141" class="difflineminus">-      else if (property == &quot;NewMailReceived&quot;) {</span>
<a href="#l63.142"></a><span id="l63.142" class="difflineplus">+      } else if (property == &quot;NewMailReceived&quot;) {</span>
<a href="#l63.143"></a><span id="l63.143">         this._newMailReceived(folder, oldValue, newValue);</span>
<a href="#l63.144"></a><span id="l63.144">       }</span>
<a href="#l63.145"></a><span id="l63.145">     } catch (error) {</span>
<a href="#l63.146"></a><span id="l63.146">       this._log.error(&quot;NMNS_OnItemIntPropertyChanged: exception &quot; + error);</span>
<a href="#l63.147"></a><span id="l63.147">     }</span>
<a href="#l63.148"></a><span id="l63.148">   },</span>
<a href="#l63.149"></a><span id="l63.149"> </span>
<a href="#l63.150"></a><span id="l63.150" class="difflineminus">-  _biffStateChanged: function NMNS_biffStateChanged(folder, oldValue, newValue) {</span>
<a href="#l63.151"></a><span id="l63.151" class="difflineplus">+  _biffStateChanged(folder, oldValue, newValue) {</span>
<a href="#l63.152"></a><span id="l63.152">     if (newValue == Ci.nsIMsgFolder.nsMsgBiffState_NewMail) {</span>
<a href="#l63.153"></a><span id="l63.153">       if (folder.server &amp;&amp; !folder.server.performingBiff) {</span>
<a href="#l63.154"></a><span id="l63.154">         this._log.debug(&quot;NMNS_biffStateChanged: folder &quot; + folder.URI + &quot; notified, but server not performing biff&quot;);</span>
<a href="#l63.155"></a><span id="l63.155">         return;</span>
<a href="#l63.156"></a><span id="l63.156">       }</span>
<a href="#l63.157"></a><span id="l63.157"> </span>
<a href="#l63.158"></a><span id="l63.158">       // Biff notifications come in for the top level of the server, we need to look for</span>
<a href="#l63.159"></a><span id="l63.159">       // the folder that actually contains the new mail</span>
<a href="#l63.160"></a><span id="l63.160" class="difflineat">@@ -242,134 +236,129 @@ NewMailNotificationService.prototype = {</span>
<a href="#l63.161"></a><span id="l63.161">         }</span>
<a href="#l63.162"></a><span id="l63.162">       }</span>
<a href="#l63.163"></a><span id="l63.163">       if (newCount &gt; 0) {</span>
<a href="#l63.164"></a><span id="l63.164">         this._mNewCount += newCount;</span>
<a href="#l63.165"></a><span id="l63.165">         this._log.debug(&quot;NMNS_biffStateChanged: &quot; + folder.URI + &quot; New mail count &quot; + this._mNewCount);</span>
<a href="#l63.166"></a><span id="l63.166">         if (this.countNew)</span>
<a href="#l63.167"></a><span id="l63.167">           this._notifyListeners(NMNS.count, &quot;onCountChanged&quot;, this._mNewCount);</span>
<a href="#l63.168"></a><span id="l63.168">       }</span>
<a href="#l63.169"></a><span id="l63.169" class="difflineminus">-    }</span>
<a href="#l63.170"></a><span id="l63.170" class="difflineminus">-    else if (newValue == Ci.nsIMsgFolder.nsMsgBiffState_NoMail) {</span>
<a href="#l63.171"></a><span id="l63.171" class="difflineplus">+    } else if (newValue == Ci.nsIMsgFolder.nsMsgBiffState_NoMail) {</span>
<a href="#l63.172"></a><span id="l63.172">       // Dodgy - when any folder tells us it has no mail, clear all unread mail</span>
<a href="#l63.173"></a><span id="l63.173">       this._mNewCount = 0;</span>
<a href="#l63.174"></a><span id="l63.174">       this._log.debug(&quot;NMNS_biffStateChanged: &quot; + folder.URI + &quot; New mail count 0&quot;);</span>
<a href="#l63.175"></a><span id="l63.175">       if (this.countNew)</span>
<a href="#l63.176"></a><span id="l63.176">         this._notifyListeners(NMNS.count, &quot;onCountChanged&quot;, this._mNewCount);</span>
<a href="#l63.177"></a><span id="l63.177">     }</span>
<a href="#l63.178"></a><span id="l63.178">   },</span>
<a href="#l63.179"></a><span id="l63.179"> </span>
<a href="#l63.180"></a><span id="l63.180" class="difflineminus">-  _newMailReceived: function NMNS_newMailReceived(folder, oldValue, newValue) {</span>
<a href="#l63.181"></a><span id="l63.181" class="difflineplus">+  _newMailReceived(folder, oldValue, newValue) {</span>
<a href="#l63.182"></a><span id="l63.182">     if (!this.confirmShouldCount(folder))</span>
<a href="#l63.183"></a><span id="l63.183">       return;</span>
<a href="#l63.184"></a><span id="l63.184"> </span>
<a href="#l63.185"></a><span id="l63.185">     if (!oldValue || (oldValue &lt; 0))</span>
<a href="#l63.186"></a><span id="l63.186">       oldValue = 0;</span>
<a href="#l63.187"></a><span id="l63.187">     let oldTotal = this._mNewCount;</span>
<a href="#l63.188"></a><span id="l63.188">     this._mNewCount += (newValue - oldValue);</span>
<a href="#l63.189"></a><span id="l63.189">     this._log.debug(&quot;NMNS_newMailReceived: &quot; + folder.URI +</span>
<a href="#l63.190"></a><span id="l63.190">                     &quot; Old folder &quot; + oldValue + &quot; New folder &quot; + newValue +</span>
<a href="#l63.191"></a><span id="l63.191">                     &quot; Old total &quot; + oldTotal + &quot; New total &quot; + this._mNewCount);</span>
<a href="#l63.192"></a><span id="l63.192">     if (this.countNew)</span>
<a href="#l63.193"></a><span id="l63.193">       this._notifyListeners(NMNS.count, &quot;onCountChanged&quot;, this._mNewCount);</span>
<a href="#l63.194"></a><span id="l63.194">   },</span>
<a href="#l63.195"></a><span id="l63.195"> </span>
<a href="#l63.196"></a><span id="l63.196" class="difflineminus">-  _updateUnreadCount: function NMNS_updateUnreadCount(folder, oldValue, newValue) {</span>
<a href="#l63.197"></a><span id="l63.197" class="difflineplus">+  _updateUnreadCount(folder, oldValue, newValue) {</span>
<a href="#l63.198"></a><span id="l63.198">     if (!this.confirmShouldCount(folder))</span>
<a href="#l63.199"></a><span id="l63.199">       return;</span>
<a href="#l63.200"></a><span id="l63.200"> </span>
<a href="#l63.201"></a><span id="l63.201">     // treat &quot;count unknown&quot; as zero</span>
<a href="#l63.202"></a><span id="l63.202">     if (oldValue &lt; 0)</span>
<a href="#l63.203"></a><span id="l63.203">       oldValue = 0;</span>
<a href="#l63.204"></a><span id="l63.204">     if (newValue &lt; 0)</span>
<a href="#l63.205"></a><span id="l63.205">       newValue = 0;</span>
<a href="#l63.206"></a><span id="l63.206"> </span>
<a href="#l63.207"></a><span id="l63.207">     this._mUnreadCount += (newValue - oldValue);</span>
<a href="#l63.208"></a><span id="l63.208">     if (!this.countNew) {</span>
<a href="#l63.209"></a><span id="l63.209">       this._log.info(&quot;NMNS_updateUnreadCount notifying listeners: unread count &quot; + this._mUnreadCount);</span>
<a href="#l63.210"></a><span id="l63.210">       this._notifyListeners(NMNS.count, &quot;onCountChanged&quot;, this._mUnreadCount);</span>
<a href="#l63.211"></a><span id="l63.211">     }</span>
<a href="#l63.212"></a><span id="l63.212">   },</span>
<a href="#l63.213"></a><span id="l63.213"> </span>
<a href="#l63.214"></a><span id="l63.214" class="difflineminus">-  OnItemAdded: function NMNS_OnItemAdded(parentItem, item) {</span>
<a href="#l63.215"></a><span id="l63.215" class="difflineplus">+  OnItemAdded(parentItem, item) {</span>
<a href="#l63.216"></a><span id="l63.216">     if (item instanceof Ci.nsIMsgDBHdr) {</span>
<a href="#l63.217"></a><span id="l63.217">       if (this.confirmShouldCount(item.folder)) {</span>
<a href="#l63.218"></a><span id="l63.218">         this._log.trace(&quot;NMNS_OnItemAdded: item &quot; + item.folder.getUriForMsg(item) + &quot; added to &quot; + item.folder.folderURL);</span>
<a href="#l63.219"></a><span id="l63.219">       }</span>
<a href="#l63.220"></a><span id="l63.220">     }</span>
<a href="#l63.221"></a><span id="l63.221">   },</span>
<a href="#l63.222"></a><span id="l63.222"> </span>
<a href="#l63.223"></a><span id="l63.223" class="difflineminus">-  OnItemPropertyFlagChanged: function NMNS_OnItemPropertyFlagChanged(item,</span>
<a href="#l63.224"></a><span id="l63.224" class="difflineminus">-                                                                    property,</span>
<a href="#l63.225"></a><span id="l63.225" class="difflineminus">-                                                                    oldFlag,</span>
<a href="#l63.226"></a><span id="l63.226" class="difflineminus">-                                                                    newFlag) {</span>
<a href="#l63.227"></a><span id="l63.227" class="difflineplus">+  OnItemPropertyFlagChanged(item, property, oldFlag, newFlag) {</span>
<a href="#l63.228"></a><span id="l63.228">     if (item instanceof Ci.nsIMsgDBHdr) {</span>
<a href="#l63.229"></a><span id="l63.229">       if ((oldFlag &amp; Ci.nsMsgMessageFlags.New)</span>
<a href="#l63.230"></a><span id="l63.230">           &amp;&amp; !(newFlag &amp; Ci.nsMsgMessageFlags.New)) {</span>
<a href="#l63.231"></a><span id="l63.231">         this._log.trace(&quot;NMNS_OnItemPropertyFlagChanged: item &quot; + item.folder.getUriForMsg(item) + &quot; marked read&quot;);</span>
<a href="#l63.232"></a><span id="l63.232" class="difflineminus">-      }</span>
<a href="#l63.233"></a><span id="l63.233" class="difflineminus">-      else if (newFlag &amp; Ci.nsMsgMessageFlags.New) {</span>
<a href="#l63.234"></a><span id="l63.234" class="difflineplus">+      } else if (newFlag &amp; Ci.nsMsgMessageFlags.New) {</span>
<a href="#l63.235"></a><span id="l63.235">         this._log.trace(&quot;NMNS_OnItemPropertyFlagChanged: item &quot; + item.folder.getUriForMsg(item) + &quot; marked unread&quot;);</span>
<a href="#l63.236"></a><span id="l63.236">       }</span>
<a href="#l63.237"></a><span id="l63.237">     }</span>
<a href="#l63.238"></a><span id="l63.238">   },</span>
<a href="#l63.239"></a><span id="l63.239"> </span>
<a href="#l63.240"></a><span id="l63.240" class="difflineminus">-  OnItemRemoved: function NMNS_OnItemRemoved(parentItem, item) {</span>
<a href="#l63.241"></a><span id="l63.241" class="difflineplus">+  OnItemRemoved(parentItem, item) {</span>
<a href="#l63.242"></a><span id="l63.242">     if (item instanceof Ci.nsIMsgDBHdr &amp;&amp; !item.isRead) {</span>
<a href="#l63.243"></a><span id="l63.243">       this._log.trace(&quot;NMNS_OnItemRemoved: unread item &quot; + item.folder.getUriForMsg(item) + &quot; removed from &quot; + item.folder.folderURL);</span>
<a href="#l63.244"></a><span id="l63.244">     }</span>
<a href="#l63.245"></a><span id="l63.245">   },</span>
<a href="#l63.246"></a><span id="l63.246"> </span>
<a href="#l63.247"></a><span id="l63.247"> </span>
<a href="#l63.248"></a><span id="l63.248">   // Implement mozINewMailNotificationService</span>
<a href="#l63.249"></a><span id="l63.249"> </span>
<a href="#l63.250"></a><span id="l63.250">   get messageCount() {</span>
<a href="#l63.251"></a><span id="l63.251">     if (this.countNew)</span>
<a href="#l63.252"></a><span id="l63.252">       return this._mNewCount;</span>
<a href="#l63.253"></a><span id="l63.253">     return this._mUnreadCount;</span>
<a href="#l63.254"></a><span id="l63.254">   },</span>
<a href="#l63.255"></a><span id="l63.255"> </span>
<a href="#l63.256"></a><span id="l63.256" class="difflineminus">-  addListener: function NMNS_addListener(aListener, flags) {</span>
<a href="#l63.257"></a><span id="l63.257" class="difflineplus">+  addListener(aListener, flags) {</span>
<a href="#l63.258"></a><span id="l63.258">     this._log.trace(&quot;NMNS_addListener: listener &quot; + aListener.toSource + &quot; flags &quot; + flags);</span>
<a href="#l63.259"></a><span id="l63.259">     for (let i = 0; i &lt; this._listeners.length; i++) {</span>
<a href="#l63.260"></a><span id="l63.260">       let l = this._listeners[i];</span>
<a href="#l63.261"></a><span id="l63.261">       if (l.obj === aListener) {</span>
<a href="#l63.262"></a><span id="l63.262">         l.flags = flags;</span>
<a href="#l63.263"></a><span id="l63.263">         return;</span>
<a href="#l63.264"></a><span id="l63.264">       }</span>
<a href="#l63.265"></a><span id="l63.265">     }</span>
<a href="#l63.266"></a><span id="l63.266">     // If we get here, the listener wasn't already in the list</span>
<a href="#l63.267"></a><span id="l63.267" class="difflineminus">-    this._listeners.push({obj: aListener, flags: flags});</span>
<a href="#l63.268"></a><span id="l63.268" class="difflineplus">+    this._listeners.push({obj: aListener, flags});</span>
<a href="#l63.269"></a><span id="l63.269">   },</span>
<a href="#l63.270"></a><span id="l63.270"> </span>
<a href="#l63.271"></a><span id="l63.271" class="difflineminus">-  removeListener: function NMNS_removeListener(aListener) {</span>
<a href="#l63.272"></a><span id="l63.272" class="difflineplus">+  removeListener(aListener) {</span>
<a href="#l63.273"></a><span id="l63.273">     this._log.trace(&quot;NMNS_removeListener: listener &quot; + aListener.toSource);</span>
<a href="#l63.274"></a><span id="l63.274">     for (let i = 0; i &lt; this._listeners.length; i++) {</span>
<a href="#l63.275"></a><span id="l63.275">       let l = this._listeners[i];</span>
<a href="#l63.276"></a><span id="l63.276">       if (l.obj === aListener) {</span>
<a href="#l63.277"></a><span id="l63.277">         this._listeners.splice(i, 1);</span>
<a href="#l63.278"></a><span id="l63.278">         return;</span>
<a href="#l63.279"></a><span id="l63.279">       }</span>
<a href="#l63.280"></a><span id="l63.280">     }</span>
<a href="#l63.281"></a><span id="l63.281">   },</span>
<a href="#l63.282"></a><span id="l63.282"> </span>
<a href="#l63.283"></a><span id="l63.283" class="difflineminus">-  _listenersForFlag: function NMNS_listenersForFlag(flag) {</span>
<a href="#l63.284"></a><span id="l63.284" class="difflineplus">+  _listenersForFlag(flag) {</span>
<a href="#l63.285"></a><span id="l63.285">     this._log.trace(&quot;NMNS_listenersForFlag &quot; + flag + &quot; length &quot; + this._listeners.length + &quot; &quot; + this._listeners.toSource());</span>
<a href="#l63.286"></a><span id="l63.286">     let list = [];</span>
<a href="#l63.287"></a><span id="l63.287">     for (let i = 0; i &lt; this._listeners.length; i++) {</span>
<a href="#l63.288"></a><span id="l63.288">       let l = this._listeners[i];</span>
<a href="#l63.289"></a><span id="l63.289">       if (l.flags &amp; flag) {</span>
<a href="#l63.290"></a><span id="l63.290">         list.push(l.obj);</span>
<a href="#l63.291"></a><span id="l63.291">       }</span>
<a href="#l63.292"></a><span id="l63.292">     }</span>
<a href="#l63.293"></a><span id="l63.293">     return list;</span>
<a href="#l63.294"></a><span id="l63.294">   },</span>
<a href="#l63.295"></a><span id="l63.295"> </span>
<a href="#l63.296"></a><span id="l63.296" class="difflineminus">-  _notifyListeners: function NMNS_notifyListeners(flag, func, value) {</span>
<a href="#l63.297"></a><span id="l63.297" class="difflineplus">+  _notifyListeners(flag, func, value) {</span>
<a href="#l63.298"></a><span id="l63.298">     let list = this._listenersForFlag(flag);</span>
<a href="#l63.299"></a><span id="l63.299">     for (let i = 0; i &lt; list.length; i++) {</span>
<a href="#l63.300"></a><span id="l63.300">       this._log.debug(&quot;NMNS_notifyListeners &quot; + flag + &quot; &quot; + func + &quot; &quot; + value);</span>
<a href="#l63.301"></a><span id="l63.301" class="difflineminus">-      list[i][func].call(list[i], value);</span>
<a href="#l63.302"></a><span id="l63.302" class="difflineplus">+      list[i][func](value);</span>
<a href="#l63.303"></a><span id="l63.303">     }</span>
<a href="#l63.304"></a><span id="l63.304" class="difflineminus">-  }</span>
<a href="#l63.305"></a><span id="l63.305" class="difflineplus">+  },</span>
<a href="#l63.306"></a><span id="l63.306"> };</span>
<a href="#l63.307"></a><span id="l63.307"> </span>
<a href="#l63.308"></a><span id="l63.308"> var NSGetFactory = XPCOMUtils.generateNSGetFactory([NewMailNotificationService]);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mailnews/base/src/nsMailNewsCommandLineHandler.js</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mailnews/base/src/nsMailNewsCommandLineHandler.js</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -7,41 +7,39 @@ var {XPCOMUtils} = ChromeUtils.import(&quot;r</span>
<a href="#l64.4"></a><span id="l64.4"> var {AppConstants} = ChromeUtils.import(&quot;resource://gre/modules/AppConstants.jsm&quot;);</span>
<a href="#l64.5"></a><span id="l64.5"> </span>
<a href="#l64.6"></a><span id="l64.6"> var MAPI_STARTUP_ARG = &quot;MapiStartup&quot;;</span>
<a href="#l64.7"></a><span id="l64.7"> var MESSAGE_ID_PARAM = &quot;?messageid=&quot;;</span>
<a href="#l64.8"></a><span id="l64.8"> </span>
<a href="#l64.9"></a><span id="l64.9"> var CMDLINEHANDLER_CID = Components.ID(&quot;{2f86d554-f9d9-4e76-8eb7-243f047333ee}&quot;);</span>
<a href="#l64.10"></a><span id="l64.10"> var CMDLINEHANDLER_CONTRACTID = &quot;@mozilla.org/commandlinehandler/general-startup;1?type=mail&quot;;</span>
<a href="#l64.11"></a><span id="l64.11"> </span>
<a href="#l64.12"></a><span id="l64.12" class="difflineminus">-var nsMailNewsCommandLineHandler =</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineminus">-{</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineplus">+var nsMailNewsCommandLineHandler = {</span>
<a href="#l64.15"></a><span id="l64.15">   get _messenger() {</span>
<a href="#l64.16"></a><span id="l64.16">     delete this._messenger;</span>
<a href="#l64.17"></a><span id="l64.17">     return this._messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l64.18"></a><span id="l64.18">                                .createInstance(Ci.nsIMessenger);</span>
<a href="#l64.19"></a><span id="l64.19">   },</span>
<a href="#l64.20"></a><span id="l64.20"> </span>
<a href="#l64.21"></a><span id="l64.21">   /* nsICommandLineHandler */</span>
<a href="#l64.22"></a><span id="l64.22"> </span>
<a href="#l64.23"></a><span id="l64.23">   /**</span>
<a href="#l64.24"></a><span id="l64.24">    * Handles the following command line arguments:</span>
<a href="#l64.25"></a><span id="l64.25">    * - -mail: opens the mail folder view</span>
<a href="#l64.26"></a><span id="l64.26">    * - -MapiStartup: indicates that this startup is due to MAPI.</span>
<a href="#l64.27"></a><span id="l64.27">    *   Don't do anything for now.</span>
<a href="#l64.28"></a><span id="l64.28">    */</span>
<a href="#l64.29"></a><span id="l64.29" class="difflineminus">-  handle: function nsMailNewsCommandLineHandler_handle(aCommandLine) {</span>
<a href="#l64.30"></a><span id="l64.30" class="difflineplus">+  handle(aCommandLine) {</span>
<a href="#l64.31"></a><span id="l64.31">     // Do this here because xpcshell isn't too happy with this at startup</span>
<a href="#l64.32"></a><span id="l64.32">     var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l64.33"></a><span id="l64.33">     // -mail &lt;URL&gt;</span>
<a href="#l64.34"></a><span id="l64.34">     let mailURL = null;</span>
<a href="#l64.35"></a><span id="l64.35">     try {</span>
<a href="#l64.36"></a><span id="l64.36">       mailURL = aCommandLine.handleFlagWithParam(&quot;mail&quot;, false);</span>
<a href="#l64.37"></a><span id="l64.37" class="difflineminus">-    }</span>
<a href="#l64.38"></a><span id="l64.38" class="difflineminus">-    catch (e) {</span>
<a href="#l64.39"></a><span id="l64.39" class="difflineplus">+    } catch (e) {</span>
<a href="#l64.40"></a><span id="l64.40">       // We're going to cover -mail without a parameter later</span>
<a href="#l64.41"></a><span id="l64.41">     }</span>
<a href="#l64.42"></a><span id="l64.42"> </span>
<a href="#l64.43"></a><span id="l64.43">     if (mailURL &amp;&amp; mailURL.length &gt; 0) {</span>
<a href="#l64.44"></a><span id="l64.44">       let msgHdr = null;</span>
<a href="#l64.45"></a><span id="l64.45">       if (/^(mailbox|imap|news)-message:\/\//.test(mailURL)) {</span>
<a href="#l64.46"></a><span id="l64.46">         // This might be a standard message URI, or one with a messageID</span>
<a href="#l64.47"></a><span id="l64.47">         // parameter. Handle both cases.</span>
<a href="#l64.48"></a><span id="l64.48" class="difflineat">@@ -55,107 +53,98 @@ var nsMailNewsCommandLineHandler =</span>
<a href="#l64.49"></a><span id="l64.49">           let messageID = mailURL.slice(messageIDIndex + MESSAGE_ID_PARAM.length);</span>
<a href="#l64.50"></a><span id="l64.50">           // Make sure the folder tree is initialized</span>
<a href="#l64.51"></a><span id="l64.51">           MailUtils.discoverFolders();</span>
<a href="#l64.52"></a><span id="l64.52"> </span>
<a href="#l64.53"></a><span id="l64.53">           let folder = MailUtils.getExistingFolder(folderURI);</span>
<a href="#l64.54"></a><span id="l64.54">           // The folder might not exist, so guard against that</span>
<a href="#l64.55"></a><span id="l64.55">           if (folder &amp;&amp; messageID.length &gt; 0)</span>
<a href="#l64.56"></a><span id="l64.56">             msgHdr = folder.msgDatabase.getMsgHdrForMessageID(messageID);</span>
<a href="#l64.57"></a><span id="l64.57" class="difflineminus">-        }</span>
<a href="#l64.58"></a><span id="l64.58" class="difflineminus">-        else {</span>
<a href="#l64.59"></a><span id="l64.59" class="difflineplus">+        } else {</span>
<a href="#l64.60"></a><span id="l64.60">           // message URI</span>
<a href="#l64.61"></a><span id="l64.61">           msgHdr = this._messenger.msgHdrFromURI(mailURL);</span>
<a href="#l64.62"></a><span id="l64.62">         }</span>
<a href="#l64.63"></a><span id="l64.63" class="difflineminus">-      }</span>
<a href="#l64.64"></a><span id="l64.64" class="difflineminus">-      else {</span>
<a href="#l64.65"></a><span id="l64.65" class="difflineplus">+      } else {</span>
<a href="#l64.66"></a><span id="l64.66">         // Necko URL, so convert it into a message header</span>
<a href="#l64.67"></a><span id="l64.67">         let neckoURL = null;</span>
<a href="#l64.68"></a><span id="l64.68">         try {</span>
<a href="#l64.69"></a><span id="l64.69">           neckoURL = Services.io.newURI(mailURL);</span>
<a href="#l64.70"></a><span id="l64.70" class="difflineminus">-        }</span>
<a href="#l64.71"></a><span id="l64.71" class="difflineminus">-        catch (e) {</span>
<a href="#l64.72"></a><span id="l64.72" class="difflineplus">+        } catch (e) {</span>
<a href="#l64.73"></a><span id="l64.73">           // We failed to convert the URI. Oh well.</span>
<a href="#l64.74"></a><span id="l64.74">         }</span>
<a href="#l64.75"></a><span id="l64.75"> </span>
<a href="#l64.76"></a><span id="l64.76">         if (neckoURL instanceof Ci.nsIMsgMessageUrl)</span>
<a href="#l64.77"></a><span id="l64.77">           msgHdr = neckoURL.messageHeader;</span>
<a href="#l64.78"></a><span id="l64.78">       }</span>
<a href="#l64.79"></a><span id="l64.79"> </span>
<a href="#l64.80"></a><span id="l64.80">       if (msgHdr) {</span>
<a href="#l64.81"></a><span id="l64.81">         aCommandLine.preventDefault = true;</span>
<a href="#l64.82"></a><span id="l64.82">         MailUtils.displayMessage(msgHdr);</span>
<a href="#l64.83"></a><span id="l64.83" class="difflineminus">-      }</span>
<a href="#l64.84"></a><span id="l64.84" class="difflineminus">-      else if (AppConstants.MOZ_APP_NAME == &quot;seamonkey&quot; &amp;&amp;</span>
<a href="#l64.85"></a><span id="l64.85" class="difflineminus">-               /\.(eml|msg)$/i.test(mailURL)) {</span>
<a href="#l64.86"></a><span id="l64.86" class="difflineplus">+      } else if (AppConstants.MOZ_APP_NAME == &quot;seamonkey&quot; &amp;&amp; /\.(eml|msg)$/i.test(mailURL)) {</span>
<a href="#l64.87"></a><span id="l64.87">         try {</span>
<a href="#l64.88"></a><span id="l64.88">           let file = aCommandLine.resolveFile(mailURL);</span>
<a href="#l64.89"></a><span id="l64.89">           // No point in trying to open a file if it doesn't exist or is empty</span>
<a href="#l64.90"></a><span id="l64.90">           if (file.exists() &amp;&amp; file.fileSize &gt; 0) {</span>
<a href="#l64.91"></a><span id="l64.91">             // Get the URL for this file</span>
<a href="#l64.92"></a><span id="l64.92">             let fileURL = Services.io.newFileURI(file)</span>
<a href="#l64.93"></a><span id="l64.93">                                   .QueryInterface(Ci.nsIFileURL);</span>
<a href="#l64.94"></a><span id="l64.94">             fileURL = fileURL.mutate().setQuery(&quot;type=application/x-message-display&quot;).finalize();</span>
<a href="#l64.95"></a><span id="l64.95">             // Open this file in a new message window.</span>
<a href="#l64.96"></a><span id="l64.96">             Services.ww.openWindow(null,</span>
<a href="#l64.97"></a><span id="l64.97">                                    &quot;chrome://messenger/content/messageWindow.xul&quot;,</span>
<a href="#l64.98"></a><span id="l64.98">                                    &quot;_blank&quot;, &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l64.99"></a><span id="l64.99">                                    fileURL);</span>
<a href="#l64.100"></a><span id="l64.100">             aCommandLine.preventDefault = true;</span>
<a href="#l64.101"></a><span id="l64.101">           }</span>
<a href="#l64.102"></a><span id="l64.102" class="difflineminus">-        }</span>
<a href="#l64.103"></a><span id="l64.103" class="difflineminus">-        catch (e) {</span>
<a href="#l64.104"></a><span id="l64.104" class="difflineplus">+        } catch (e) {</span>
<a href="#l64.105"></a><span id="l64.105">         }</span>
<a href="#l64.106"></a><span id="l64.106" class="difflineminus">-      }</span>
<a href="#l64.107"></a><span id="l64.107" class="difflineminus">-      else {</span>
<a href="#l64.108"></a><span id="l64.108" class="difflineplus">+      } else {</span>
<a href="#l64.109"></a><span id="l64.109">         dump(&quot;Unrecognized URL: &quot; + mailURL + &quot;\n&quot;);</span>
<a href="#l64.110"></a><span id="l64.110">         Services.console.logStringMessage(&quot;Unrecognized URL: &quot; + mailURL);</span>
<a href="#l64.111"></a><span id="l64.111">       }</span>
<a href="#l64.112"></a><span id="l64.112">     }</span>
<a href="#l64.113"></a><span id="l64.113"> </span>
<a href="#l64.114"></a><span id="l64.114">     // -mail (no parameter)</span>
<a href="#l64.115"></a><span id="l64.115">     let mailFlag = aCommandLine.handleFlag(&quot;mail&quot;, false);</span>
<a href="#l64.116"></a><span id="l64.116">     if (mailFlag) {</span>
<a href="#l64.117"></a><span id="l64.117">       // Focus the 3pane window if one is present, else open one</span>
<a href="#l64.118"></a><span id="l64.118">       let mail3PaneWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l64.119"></a><span id="l64.119">       if (mail3PaneWindow) {</span>
<a href="#l64.120"></a><span id="l64.120">         mail3PaneWindow.focus();</span>
<a href="#l64.121"></a><span id="l64.121" class="difflineminus">-      }</span>
<a href="#l64.122"></a><span id="l64.122" class="difflineminus">-      else {</span>
<a href="#l64.123"></a><span id="l64.123" class="difflineplus">+      } else {</span>
<a href="#l64.124"></a><span id="l64.124">         Services.ww.openWindow(null, &quot;chrome://messenger/content/&quot;, &quot;_blank&quot;,</span>
<a href="#l64.125"></a><span id="l64.125">             &quot;chrome,extrachrome,menubar,resizable,scrollbars,status,toolbar,dialog=no&quot;,</span>
<a href="#l64.126"></a><span id="l64.126">             null);</span>
<a href="#l64.127"></a><span id="l64.127">       }</span>
<a href="#l64.128"></a><span id="l64.128">       aCommandLine.preventDefault = true;</span>
<a href="#l64.129"></a><span id="l64.129">     }</span>
<a href="#l64.130"></a><span id="l64.130"> </span>
<a href="#l64.131"></a><span id="l64.131">     // -MapiStartup</span>
<a href="#l64.132"></a><span id="l64.132">     aCommandLine.handleFlag(MAPI_STARTUP_ARG, false);</span>
<a href="#l64.133"></a><span id="l64.133">   },</span>
<a href="#l64.134"></a><span id="l64.134"> </span>
<a href="#l64.135"></a><span id="l64.135">   helpInfo: &quot;  -mail              Open the mail folder view.\n&quot; +</span>
<a href="#l64.136"></a><span id="l64.136">             &quot;  -mail &lt;URL&gt;        Open the message specified by this URL.\n&quot;,</span>
<a href="#l64.137"></a><span id="l64.137"> </span>
<a href="#l64.138"></a><span id="l64.138">   /* nsIFactory */</span>
<a href="#l64.139"></a><span id="l64.139" class="difflineminus">-  createInstance: function(outer, iid) {</span>
<a href="#l64.140"></a><span id="l64.140" class="difflineplus">+  createInstance(outer, iid) {</span>
<a href="#l64.141"></a><span id="l64.141">     if (outer != null)</span>
<a href="#l64.142"></a><span id="l64.142">       throw Cr.NS_ERROR_NO_AGGREGATION;</span>
<a href="#l64.143"></a><span id="l64.143"> </span>
<a href="#l64.144"></a><span id="l64.144">     return this.QueryInterface(iid);</span>
<a href="#l64.145"></a><span id="l64.145">   },</span>
<a href="#l64.146"></a><span id="l64.146"> </span>
<a href="#l64.147"></a><span id="l64.147">   QueryInterface: ChromeUtils.generateQI([Ci.nsICommandLineHandler,</span>
<a href="#l64.148"></a><span id="l64.148" class="difflineminus">-                                          Ci.nsIFactory])</span>
<a href="#l64.149"></a><span id="l64.149" class="difflineplus">+                                          Ci.nsIFactory]),</span>
<a href="#l64.150"></a><span id="l64.150"> };</span>
<a href="#l64.151"></a><span id="l64.151"> </span>
<a href="#l64.152"></a><span id="l64.152"> function mailNewsCommandLineHandlerModule() {}</span>
<a href="#l64.153"></a><span id="l64.153" class="difflineminus">-mailNewsCommandLineHandlerModule.prototype =</span>
<a href="#l64.154"></a><span id="l64.154" class="difflineminus">-{</span>
<a href="#l64.155"></a><span id="l64.155" class="difflineplus">+mailNewsCommandLineHandlerModule.prototype = {</span>
<a href="#l64.156"></a><span id="l64.156">   // XPCOM registration</span>
<a href="#l64.157"></a><span id="l64.157">   classID: CMDLINEHANDLER_CID,</span>
<a href="#l64.158"></a><span id="l64.158"> </span>
<a href="#l64.159"></a><span id="l64.159">   QueryInterface: ChromeUtils.generateQI([Ci.nsIModule]),</span>
<a href="#l64.160"></a><span id="l64.160"> </span>
<a href="#l64.161"></a><span id="l64.161" class="difflineminus">-  _xpcom_factory: nsMailNewsCommandLineHandler</span>
<a href="#l64.162"></a><span id="l64.162" class="difflineplus">+  _xpcom_factory: nsMailNewsCommandLineHandler,</span>
<a href="#l64.163"></a><span id="l64.163"> };</span>
<a href="#l64.164"></a><span id="l64.164"> </span>
<a href="#l64.165"></a><span id="l64.165"> var components = [mailNewsCommandLineHandlerModule];</span>
<a href="#l64.166"></a><span id="l64.166"> var NSGetFactory = XPCOMUtils.generateNSGetFactory(components);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mailnews/base/src/virtualFolderWrapper.js</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mailnews/base/src/virtualFolderWrapper.js</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l65.4"></a><span id="l65.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l65.5"></a><span id="l65.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l65.6"></a><span id="l65.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l65.7"></a><span id="l65.7"> </span>
<a href="#l65.8"></a><span id="l65.8"> /*</span>
<a href="#l65.9"></a><span id="l65.9">  * Wrap everything about virtual folders.</span>
<a href="#l65.10"></a><span id="l65.10">  */</span>
<a href="#l65.11"></a><span id="l65.11"> </span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-this.EXPORTED_SYMBOLS = ['VirtualFolderHelper'];</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;VirtualFolderHelper&quot;];</span>
<a href="#l65.14"></a><span id="l65.14"> </span>
<a href="#l65.15"></a><span id="l65.15"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l65.16"></a><span id="l65.16"> var {MailUtils} = ChromeUtils.import(&quot;resource:///modules/MailUtils.jsm&quot;);</span>
<a href="#l65.17"></a><span id="l65.17"> var {fixIterator} = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l65.18"></a><span id="l65.18"> </span>
<a href="#l65.19"></a><span id="l65.19"> var VirtualFolderHelper = {</span>
<a href="#l65.20"></a><span id="l65.20">   /**</span>
<a href="#l65.21"></a><span id="l65.21">    * Create a new virtual folder (an actual nsIMsgFolder that did not previously</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineat">@@ -30,18 +30,18 @@ var VirtualFolderHelper = {</span>
<a href="#l65.23"></a><span id="l65.23">    * @param aOnlineSearch Should the search attempt to use the server's search</span>
<a href="#l65.24"></a><span id="l65.24">    *     capabilities when possible and appropriate?</span>
<a href="#l65.25"></a><span id="l65.25">    *</span>
<a href="#l65.26"></a><span id="l65.26">    * @return The VirtualFolderWrapper wrapping the newly created folder.  You</span>
<a href="#l65.27"></a><span id="l65.27">    *     would probably only want this for its virtualFolder attribute which has</span>
<a href="#l65.28"></a><span id="l65.28">    *     the nsIMsgFolder we created.  Be careful about accessing any of the</span>
<a href="#l65.29"></a><span id="l65.29">    *     other attributes, as they will bring its message database back to life.</span>
<a href="#l65.30"></a><span id="l65.30">    */</span>
<a href="#l65.31"></a><span id="l65.31" class="difflineminus">-  createNewVirtualFolder: function (aFolderName, aParentFolder, aSearchFolders,</span>
<a href="#l65.32"></a><span id="l65.32" class="difflineminus">-                                    aSearchTerms, aOnlineSearch) {</span>
<a href="#l65.33"></a><span id="l65.33" class="difflineplus">+  createNewVirtualFolder(aFolderName, aParentFolder, aSearchFolders,</span>
<a href="#l65.34"></a><span id="l65.34" class="difflineplus">+                         aSearchTerms, aOnlineSearch) {</span>
<a href="#l65.35"></a><span id="l65.35">     let msgFolder = aParentFolder.addSubfolder(aFolderName);</span>
<a href="#l65.36"></a><span id="l65.36">     msgFolder.prettyName = aFolderName;</span>
<a href="#l65.37"></a><span id="l65.37">     msgFolder.setFlag(Ci.nsMsgFolderFlags.Virtual);</span>
<a href="#l65.38"></a><span id="l65.38"> </span>
<a href="#l65.39"></a><span id="l65.39">     let wrappedVirt = new VirtualFolderWrapper(msgFolder);</span>
<a href="#l65.40"></a><span id="l65.40">     wrappedVirt.searchTerms = aSearchTerms;</span>
<a href="#l65.41"></a><span id="l65.41">     wrappedVirt.searchFolders = aSearchFolders;</span>
<a href="#l65.42"></a><span id="l65.42">     wrappedVirt.onlineSearch = aOnlineSearch;</span>
<a href="#l65.43"></a><span id="l65.43" class="difflineat">@@ -55,17 +55,17 @@ var VirtualFolderHelper = {</span>
<a href="#l65.44"></a><span id="l65.44"> </span>
<a href="#l65.45"></a><span id="l65.45">     return wrappedVirt;</span>
<a href="#l65.46"></a><span id="l65.46">   },</span>
<a href="#l65.47"></a><span id="l65.47"> </span>
<a href="#l65.48"></a><span id="l65.48">   /**</span>
<a href="#l65.49"></a><span id="l65.49">    * Given an existing nsIMsgFolder that is a virtual folder, wrap it into a</span>
<a href="#l65.50"></a><span id="l65.50">    *  VirtualFolderWrapper.</span>
<a href="#l65.51"></a><span id="l65.51">    */</span>
<a href="#l65.52"></a><span id="l65.52" class="difflineminus">-  wrapVirtualFolder: function (aMsgFolder) {</span>
<a href="#l65.53"></a><span id="l65.53" class="difflineplus">+  wrapVirtualFolder(aMsgFolder) {</span>
<a href="#l65.54"></a><span id="l65.54">     return new VirtualFolderWrapper(aMsgFolder);</span>
<a href="#l65.55"></a><span id="l65.55">   },</span>
<a href="#l65.56"></a><span id="l65.56"> };</span>
<a href="#l65.57"></a><span id="l65.57"> </span>
<a href="#l65.58"></a><span id="l65.58"> /**</span>
<a href="#l65.59"></a><span id="l65.59">  * Abstracts dealing with the properties of a virtual folder that differentiate</span>
<a href="#l65.60"></a><span id="l65.60">  *  it from a non-virtual folder.  A virtual folder is an odd duck.  When</span>
<a href="#l65.61"></a><span id="l65.61">  *  holding an nsIMsgFolder that is a virtual folder, it is distinguished by</span>
<a href="#l65.62"></a><span id="l65.62" class="difflineat">@@ -100,17 +100,17 @@ var VirtualFolderHelper = {</span>
<a href="#l65.63"></a><span id="l65.63">  *  that you are playing your part in not leaking memory by only using the</span>
<a href="#l65.64"></a><span id="l65.64">  *  wrapper when you have a serious need to access the database, and by</span>
<a href="#l65.65"></a><span id="l65.65">  *  forcing the folder to forget about the database when you are done by</span>
<a href="#l65.66"></a><span id="l65.66">  *  setting the database to null (unless you know with confidence someone else</span>
<a href="#l65.67"></a><span id="l65.67">  *  definitely wants the database around and will clean it up.)</span>
<a href="#l65.68"></a><span id="l65.68">  */</span>
<a href="#l65.69"></a><span id="l65.69"> function VirtualFolderWrapper(aVirtualFolder) {</span>
<a href="#l65.70"></a><span id="l65.70">   this.virtualFolder = aVirtualFolder;</span>
<a href="#l65.71"></a><span id="l65.71" class="difflineminus">-};</span>
<a href="#l65.72"></a><span id="l65.72" class="difflineplus">+}</span>
<a href="#l65.73"></a><span id="l65.73"> VirtualFolderWrapper.prototype = {</span>
<a href="#l65.74"></a><span id="l65.74">   /**</span>
<a href="#l65.75"></a><span id="l65.75">    * @return the list of nsIMsgFolders that this virtual folder is a</span>
<a href="#l65.76"></a><span id="l65.76">    *     search over.</span>
<a href="#l65.77"></a><span id="l65.77">    */</span>
<a href="#l65.78"></a><span id="l65.78">   get searchFolders() {</span>
<a href="#l65.79"></a><span id="l65.79">     let virtualFolderUris =</span>
<a href="#l65.80"></a><span id="l65.80">       this.dbFolderInfo.getCharProperty(&quot;searchFolderUri&quot;).split(&quot;|&quot;);</span>
<a href="#l65.81"></a><span id="l65.81" class="difflineat">@@ -125,18 +125,17 @@ VirtualFolderWrapper.prototype = {</span>
<a href="#l65.82"></a><span id="l65.82">    * Set the search folders that back this virtual folder.</span>
<a href="#l65.83"></a><span id="l65.83">    *</span>
<a href="#l65.84"></a><span id="l65.84">    * @param aFolders Either a &quot;|&quot;-delimited string of folder URIs or a list of</span>
<a href="#l65.85"></a><span id="l65.85">    *     nsIMsgFolders that fixIterator can traverse (JS array/nsIMutableArray).</span>
<a href="#l65.86"></a><span id="l65.86">    */</span>
<a href="#l65.87"></a><span id="l65.87">   set searchFolders(aFolders) {</span>
<a href="#l65.88"></a><span id="l65.88">     if (typeof(aFolders) == &quot;string&quot;) {</span>
<a href="#l65.89"></a><span id="l65.89">       this.dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, aFolders);</span>
<a href="#l65.90"></a><span id="l65.90" class="difflineminus">-    }</span>
<a href="#l65.91"></a><span id="l65.91" class="difflineminus">-    else {</span>
<a href="#l65.92"></a><span id="l65.92" class="difflineplus">+    } else {</span>
<a href="#l65.93"></a><span id="l65.93">       let uris = Array.from(fixIterator(aFolders, Ci.nsIMsgFolder))</span>
<a href="#l65.94"></a><span id="l65.94">                       .map(folder =&gt; folder.URI);</span>
<a href="#l65.95"></a><span id="l65.95">       this.dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, uris.join(&quot;|&quot;));</span>
<a href="#l65.96"></a><span id="l65.96">     }</span>
<a href="#l65.97"></a><span id="l65.97">   },</span>
<a href="#l65.98"></a><span id="l65.98"> </span>
<a href="#l65.99"></a><span id="l65.99">   /**</span>
<a href="#l65.100"></a><span id="l65.100">    * @return a &quot;|&quot;-delimited string containing the URIs of the folders that back</span>
<a href="#l65.101"></a><span id="l65.101" class="difflineat">@@ -233,14 +232,13 @@ VirtualFolderWrapper.prototype = {</span>
<a href="#l65.102"></a><span id="l65.102">   },</span>
<a href="#l65.103"></a><span id="l65.103"> </span>
<a href="#l65.104"></a><span id="l65.104">   /**</span>
<a href="#l65.105"></a><span id="l65.105">    * Avoid memory bloat by making the virtual folder forget about its database.</span>
<a href="#l65.106"></a><span id="l65.106">    *  If the database is actually in use (read: someone is keeping it alive by</span>
<a href="#l65.107"></a><span id="l65.107">    *  having references to it from places other than the nsIMsgFolder), the</span>
<a href="#l65.108"></a><span id="l65.108">    *  folder will be able to re-establish the reference for minimal cost.</span>
<a href="#l65.109"></a><span id="l65.109">    */</span>
<a href="#l65.110"></a><span id="l65.110" class="difflineminus">-  cleanUpMessageDatabase:</span>
<a href="#l65.111"></a><span id="l65.111" class="difflineminus">-      function VirtualFolderWrapper_cleanUpMessageDatabase() {</span>
<a href="#l65.112"></a><span id="l65.112" class="difflineplus">+  cleanUpMessageDatabase() {</span>
<a href="#l65.113"></a><span id="l65.113">     this.virtualFolder.msgDatabase.Close(true);</span>
<a href="#l65.114"></a><span id="l65.114">     this.virtualFolder.msgDatabase = null;</span>
<a href="#l65.115"></a><span id="l65.115" class="difflineminus">-  }</span>
<a href="#l65.116"></a><span id="l65.116" class="difflineplus">+  },</span>
<a href="#l65.117"></a><span id="l65.117"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mailnews/base/util/IOUtils.js</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mailnews/base/util/IOUtils.js</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -4,27 +4,26 @@</span>
<a href="#l66.4"></a><span id="l66.4"> </span>
<a href="#l66.5"></a><span id="l66.5"> this.EXPORTED_SYMBOLS = [&quot;IOUtils&quot;];</span>
<a href="#l66.6"></a><span id="l66.6"> </span>
<a href="#l66.7"></a><span id="l66.7"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l66.8"></a><span id="l66.8"> </span>
<a href="#l66.9"></a><span id="l66.9"> var kStringBlockSize = 4096;</span>
<a href="#l66.10"></a><span id="l66.10"> var kStreamBlockSize = 8192;</span>
<a href="#l66.11"></a><span id="l66.11"> </span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-var IOUtils =</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineminus">-{</span>
<a href="#l66.14"></a><span id="l66.14" class="difflineplus">+var IOUtils = {</span>
<a href="#l66.15"></a><span id="l66.15">   /**</span>
<a href="#l66.16"></a><span id="l66.16">    * Read a file containing ASCII text into a string.</span>
<a href="#l66.17"></a><span id="l66.17">    *</span>
<a href="#l66.18"></a><span id="l66.18">    * @param aFile  An nsIFile representing the file to read or a string containing</span>
<a href="#l66.19"></a><span id="l66.19">    *               the file name of a file under user's profile.</span>
<a href="#l66.20"></a><span id="l66.20">    * @returns A string containing the contents of the file, presumed to be ASCII</span>
<a href="#l66.21"></a><span id="l66.21">    *          text. If the file didn't exist, returns null.</span>
<a href="#l66.22"></a><span id="l66.22">    */</span>
<a href="#l66.23"></a><span id="l66.23" class="difflineminus">-  loadFileToString: function(aFile) {</span>
<a href="#l66.24"></a><span id="l66.24" class="difflineplus">+  loadFileToString(aFile) {</span>
<a href="#l66.25"></a><span id="l66.25">     let file;</span>
<a href="#l66.26"></a><span id="l66.26">     if (!(aFile instanceof Ci.nsIFile)) {</span>
<a href="#l66.27"></a><span id="l66.27">       file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l66.28"></a><span id="l66.28">       file.append(aFile);</span>
<a href="#l66.29"></a><span id="l66.29">     } else {</span>
<a href="#l66.30"></a><span id="l66.30">       file = aFile;</span>
<a href="#l66.31"></a><span id="l66.31">     }</span>
<a href="#l66.32"></a><span id="l66.32"> </span>
<a href="#l66.33"></a><span id="l66.33" class="difflineat">@@ -56,17 +55,17 @@ var IOUtils =</span>
<a href="#l66.34"></a><span id="l66.34">    * and contain only the given text.</span>
<a href="#l66.35"></a><span id="l66.35">    *</span>
<a href="#l66.36"></a><span id="l66.36">    * @param aFile   An nsIFile representing the file to write or a string containing</span>
<a href="#l66.37"></a><span id="l66.37">    *                the file name of a file under user's profile.</span>
<a href="#l66.38"></a><span id="l66.38">    * @param aData   The string to write.</span>
<a href="#l66.39"></a><span id="l66.39">    * @param aPerms  The octal file permissions for the created file. If unset</span>
<a href="#l66.40"></a><span id="l66.40">    *                the default of 0o600 is used.</span>
<a href="#l66.41"></a><span id="l66.41">    */</span>
<a href="#l66.42"></a><span id="l66.42" class="difflineminus">-  saveStringToFile: function(aFile, aData, aPerms = 0o600) {</span>
<a href="#l66.43"></a><span id="l66.43" class="difflineplus">+  saveStringToFile(aFile, aData, aPerms = 0o600) {</span>
<a href="#l66.44"></a><span id="l66.44">     let file;</span>
<a href="#l66.45"></a><span id="l66.45">     if (!(aFile instanceof Ci.nsIFile)) {</span>
<a href="#l66.46"></a><span id="l66.46">       file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l66.47"></a><span id="l66.47">       file.append(aFile);</span>
<a href="#l66.48"></a><span id="l66.48">     } else {</span>
<a href="#l66.49"></a><span id="l66.49">       file = aFile;</span>
<a href="#l66.50"></a><span id="l66.50">     }</span>
<a href="#l66.51"></a><span id="l66.51"> </span>
<a href="#l66.52"></a><span id="l66.52" class="difflineat">@@ -87,17 +86,17 @@ var IOUtils =</span>
<a href="#l66.53"></a><span id="l66.53">   /**</span>
<a href="#l66.54"></a><span id="l66.54">    * Saves the given input stream to a file.</span>
<a href="#l66.55"></a><span id="l66.55">    *</span>
<a href="#l66.56"></a><span id="l66.56">    * @param aIStream The input stream to save.</span>
<a href="#l66.57"></a><span id="l66.57">    * @param aFile    The file to which the stream is saved.</span>
<a href="#l66.58"></a><span id="l66.58">    * @param aPerms   The octal file permissions for the created file. If unset</span>
<a href="#l66.59"></a><span id="l66.59">    *                 the default of 0o600 is used.</span>
<a href="#l66.60"></a><span id="l66.60">    */</span>
<a href="#l66.61"></a><span id="l66.61" class="difflineminus">-  saveStreamToFile: function(aIStream, aFile, aPerms = 0o600) {</span>
<a href="#l66.62"></a><span id="l66.62" class="difflineplus">+  saveStreamToFile(aIStream, aFile, aPerms = 0o600) {</span>
<a href="#l66.63"></a><span id="l66.63">     if (!(aIStream instanceof Ci.nsIInputStream))</span>
<a href="#l66.64"></a><span id="l66.64">       throw new Error(&quot;Invalid stream passed to saveStreamToFile&quot;);</span>
<a href="#l66.65"></a><span id="l66.65">     if (!(aFile instanceof Ci.nsIFile))</span>
<a href="#l66.66"></a><span id="l66.66">       throw new Error(&quot;Invalid file passed to saveStreamToFile&quot;);</span>
<a href="#l66.67"></a><span id="l66.67"> </span>
<a href="#l66.68"></a><span id="l66.68">     let fstream = Cc[&quot;@mozilla.org/network/safe-file-output-stream;1&quot;]</span>
<a href="#l66.69"></a><span id="l66.69">                     .createInstance(Ci.nsIFileOutputStream);</span>
<a href="#l66.70"></a><span id="l66.70">     let buffer  = Cc[&quot;@mozilla.org/network/buffered-output-stream;1&quot;]</span>
<a href="#l66.71"></a><span id="l66.71" class="difflineat">@@ -123,12 +122,12 @@ var IOUtils =</span>
<a href="#l66.72"></a><span id="l66.72">     // Close the input stream.</span>
<a href="#l66.73"></a><span id="l66.73">     aIStream.close();</span>
<a href="#l66.74"></a><span id="l66.74">     return aFile;</span>
<a href="#l66.75"></a><span id="l66.75">   },</span>
<a href="#l66.76"></a><span id="l66.76"> </span>
<a href="#l66.77"></a><span id="l66.77">   /**</span>
<a href="#l66.78"></a><span id="l66.78">    * Returns size of system memory.</span>
<a href="#l66.79"></a><span id="l66.79">    */</span>
<a href="#l66.80"></a><span id="l66.80" class="difflineminus">-  getPhysicalMemorySize: function() {</span>
<a href="#l66.81"></a><span id="l66.81" class="difflineplus">+  getPhysicalMemorySize() {</span>
<a href="#l66.82"></a><span id="l66.82">     return Services.sysinfo.getPropertyAsInt64(&quot;memsize&quot;);</span>
<a href="#l66.83"></a><span id="l66.83">   },</span>
<a href="#l66.84"></a><span id="l66.84"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mailnews/base/util/JXON.js</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mailnews/base/util/JXON.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -9,50 +9,46 @@ var EXPORTED_SYMBOLS = [&quot;JXON&quot;];</span>
<a href="#l67.4"></a><span id="l67.4"> </span>
<a href="#l67.5"></a><span id="l67.5"> var JXON = new (function() {</span>
<a href="#l67.6"></a><span id="l67.6">   const sValueProp = &quot;value&quot;; /* you can customize these values */</span>
<a href="#l67.7"></a><span id="l67.7">   const sAttributesProp = &quot;attr&quot;;</span>
<a href="#l67.8"></a><span id="l67.8">   const sAttrPref = &quot;@&quot;;</span>
<a href="#l67.9"></a><span id="l67.9">   const sElementListPrefix = &quot;$&quot;;</span>
<a href="#l67.10"></a><span id="l67.10">   const sConflictSuffix = &quot;_&quot;; // used when there's a name conflict with special JXON properties</span>
<a href="#l67.11"></a><span id="l67.11">   const aCache = [];</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-  const rIsNull = /^\s*$/;</span>
<a href="#l67.13"></a><span id="l67.13">   const rIsBool = /^(?:true|false)$/i;</span>
<a href="#l67.14"></a><span id="l67.14"> </span>
<a href="#l67.15"></a><span id="l67.15">   function parseText(sValue) {</span>
<a href="#l67.16"></a><span id="l67.16" class="difflineminus">-    //if (rIsNull.test(sValue))</span>
<a href="#l67.17"></a><span id="l67.17" class="difflineminus">-    //  return null;</span>
<a href="#l67.18"></a><span id="l67.18">     if (rIsBool.test(sValue))</span>
<a href="#l67.19"></a><span id="l67.19">       return sValue.toLowerCase() === &quot;true&quot;;</span>
<a href="#l67.20"></a><span id="l67.20">     if (isFinite(sValue))</span>
<a href="#l67.21"></a><span id="l67.21">       return parseFloat(sValue);</span>
<a href="#l67.22"></a><span id="l67.22">     if (isFinite(Date.parse(sValue)))</span>
<a href="#l67.23"></a><span id="l67.23">       return new Date(sValue);</span>
<a href="#l67.24"></a><span id="l67.24">     return sValue;</span>
<a href="#l67.25"></a><span id="l67.25" class="difflineminus">-  };</span>
<a href="#l67.26"></a><span id="l67.26" class="difflineplus">+  }</span>
<a href="#l67.27"></a><span id="l67.27"> </span>
<a href="#l67.28"></a><span id="l67.28">   function EmptyTree() {</span>
<a href="#l67.29"></a><span id="l67.29">   }</span>
<a href="#l67.30"></a><span id="l67.30">   EmptyTree.prototype = {</span>
<a href="#l67.31"></a><span id="l67.31" class="difflineminus">-    toString : function () {</span>
<a href="#l67.32"></a><span id="l67.32" class="difflineplus">+    toString() {</span>
<a href="#l67.33"></a><span id="l67.33">       return &quot;null&quot;;</span>
<a href="#l67.34"></a><span id="l67.34">     },</span>
<a href="#l67.35"></a><span id="l67.35" class="difflineminus">-    valueOf : function () {</span>
<a href="#l67.36"></a><span id="l67.36" class="difflineplus">+    valueOf() {</span>
<a href="#l67.37"></a><span id="l67.37">       return null;</span>
<a href="#l67.38"></a><span id="l67.38">     },</span>
<a href="#l67.39"></a><span id="l67.39">   };</span>
<a href="#l67.40"></a><span id="l67.40"> </span>
<a href="#l67.41"></a><span id="l67.41">   function objectify(vValue) {</span>
<a href="#l67.42"></a><span id="l67.42">     if (vValue === null)</span>
<a href="#l67.43"></a><span id="l67.43">       return new EmptyTree();</span>
<a href="#l67.44"></a><span id="l67.44">     else if (vValue instanceof Object)</span>
<a href="#l67.45"></a><span id="l67.45">       return vValue;</span>
<a href="#l67.46"></a><span id="l67.46" class="difflineminus">-    else</span>
<a href="#l67.47"></a><span id="l67.47" class="difflineminus">-      return new vValue.constructor(vValue); // What does this? copy?</span>
<a href="#l67.48"></a><span id="l67.48" class="difflineminus">-  };</span>
<a href="#l67.49"></a><span id="l67.49" class="difflineplus">+    return new vValue.constructor(vValue); // What does this? copy?</span>
<a href="#l67.50"></a><span id="l67.50" class="difflineplus">+  }</span>
<a href="#l67.51"></a><span id="l67.51"> </span>
<a href="#l67.52"></a><span id="l67.52">   function createObjTree(oParentNode, nVerb, bFreeze, bNesteAttr) {</span>
<a href="#l67.53"></a><span id="l67.53">     const nLevelStart = aCache.length;</span>
<a href="#l67.54"></a><span id="l67.54">     const bChildren = oParentNode.hasChildNodes();</span>
<a href="#l67.55"></a><span id="l67.55">     const bAttributes = oParentNode.attributes &amp;&amp;</span>
<a href="#l67.56"></a><span id="l67.56">                         oParentNode.attributes.length;</span>
<a href="#l67.57"></a><span id="l67.57">     const bHighVerb = Boolean(nVerb &amp; 2);</span>
<a href="#l67.58"></a><span id="l67.58"> </span>
<a href="#l67.59"></a><span id="l67.59" class="difflineat">@@ -117,17 +113,17 @@ var JXON = new (function() {</span>
<a href="#l67.60"></a><span id="l67.60">       vResult = vBuiltVal;</span>
<a href="#l67.61"></a><span id="l67.61"> </span>
<a href="#l67.62"></a><span id="l67.62">     if (bFreeze &amp;&amp; (bHighVerb || nLength &gt; 0))</span>
<a href="#l67.63"></a><span id="l67.63">       Object.freeze(vResult);</span>
<a href="#l67.64"></a><span id="l67.64"> </span>
<a href="#l67.65"></a><span id="l67.65">     aCache.length = nLevelStart;</span>
<a href="#l67.66"></a><span id="l67.66"> </span>
<a href="#l67.67"></a><span id="l67.67">     return vResult;</span>
<a href="#l67.68"></a><span id="l67.68" class="difflineminus">-  };</span>
<a href="#l67.69"></a><span id="l67.69" class="difflineplus">+  }</span>
<a href="#l67.70"></a><span id="l67.70"> </span>
<a href="#l67.71"></a><span id="l67.71">   function loadObjTree(oXMLDoc, oParentEl, oParentObj) {</span>
<a href="#l67.72"></a><span id="l67.72">     var vValue, oChild;</span>
<a href="#l67.73"></a><span id="l67.73"> </span>
<a href="#l67.74"></a><span id="l67.74">     if (oParentObj instanceof String || oParentObj instanceof Number ||</span>
<a href="#l67.75"></a><span id="l67.75">         oParentObj instanceof Boolean)</span>
<a href="#l67.76"></a><span id="l67.76">       oParentEl.appendChild(oXMLDoc.createTextNode(oParentObj.toString())); /* verbosity level is 0 */</span>
<a href="#l67.77"></a><span id="l67.77">     else if (oParentObj.constructor === Date)</span>
<a href="#l67.78"></a><span id="l67.78" class="difflineat">@@ -157,17 +153,17 @@ var JXON = new (function() {</span>
<a href="#l67.79"></a><span id="l67.79">         oChild = oXMLDoc.createElement(sName);</span>
<a href="#l67.80"></a><span id="l67.80">         if (vValue instanceof Object)</span>
<a href="#l67.81"></a><span id="l67.81">           loadObjTree(oXMLDoc, oChild, vValue);</span>
<a href="#l67.82"></a><span id="l67.82">         else if (vValue !== null &amp;&amp; vValue !== true)</span>
<a href="#l67.83"></a><span id="l67.83">           oChild.appendChild(oXMLDoc.createTextNode(vValue.toString()));</span>
<a href="#l67.84"></a><span id="l67.84">         oParentEl.appendChild(oChild);</span>
<a href="#l67.85"></a><span id="l67.85">      }</span>
<a href="#l67.86"></a><span id="l67.86">    }</span>
<a href="#l67.87"></a><span id="l67.87" class="difflineminus">-  };</span>
<a href="#l67.88"></a><span id="l67.88" class="difflineplus">+  }</span>
<a href="#l67.89"></a><span id="l67.89"> </span>
<a href="#l67.90"></a><span id="l67.90">   this.build = function(oXMLParent, nVerbosity /* optional */, bFreeze /* optional */, bNesteAttributes /* optional */) {</span>
<a href="#l67.91"></a><span id="l67.91">     const _nVerb =</span>
<a href="#l67.92"></a><span id="l67.92">         typeof nVerbosity === &quot;number&quot; ? nVerbosity &amp; 3 :</span>
<a href="#l67.93"></a><span id="l67.93">         /* put here the default verbosity level: */ 1;</span>
<a href="#l67.94"></a><span id="l67.94">     return createObjTree(oXMLParent, _nVerb, bFreeze || false,</span>
<a href="#l67.95"></a><span id="l67.95">         (bNesteAttributes !== undefined) ? bNesteAttributes : _nVerb === 3);</span>
<a href="#l67.96"></a><span id="l67.96">   };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mailnews/base/util/OAuth2.jsm</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mailnews/base/util/OAuth2.jsm</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -4,22 +4,21 @@</span>
<a href="#l68.4"></a><span id="l68.4"> </span>
<a href="#l68.5"></a><span id="l68.5"> /**</span>
<a href="#l68.6"></a><span id="l68.6">  * Provides OAuth 2.0 authentication</span>
<a href="#l68.7"></a><span id="l68.7">  */</span>
<a href="#l68.8"></a><span id="l68.8"> var EXPORTED_SYMBOLS = [&quot;OAuth2&quot;];</span>
<a href="#l68.9"></a><span id="l68.9"> </span>
<a href="#l68.10"></a><span id="l68.10"> const {httpRequest} = ChromeUtils.import(&quot;resource://gre/modules/Http.jsm&quot;);</span>
<a href="#l68.11"></a><span id="l68.11"> const {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l68.13"></a><span id="l68.13"> const {Log4Moz} = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l68.14"></a><span id="l68.14"> </span>
<a href="#l68.15"></a><span id="l68.15"> function parseURLData(aData) {</span>
<a href="#l68.16"></a><span id="l68.16">   let result = {};</span>
<a href="#l68.17"></a><span id="l68.17" class="difflineminus">-  aData.split(/[?#]/, 2)[1].split(&quot;&amp;&quot;).forEach(function (aParam) {</span>
<a href="#l68.18"></a><span id="l68.18" class="difflineplus">+  aData.split(/[?#]/, 2)[1].split(&quot;&amp;&quot;).forEach(function(aParam) {</span>
<a href="#l68.19"></a><span id="l68.19">     let [key, value] = aParam.split(&quot;=&quot;);</span>
<a href="#l68.20"></a><span id="l68.20">     result[key] = value;</span>
<a href="#l68.21"></a><span id="l68.21">   });</span>
<a href="#l68.22"></a><span id="l68.22">   return result;</span>
<a href="#l68.23"></a><span id="l68.23"> }</span>
<a href="#l68.24"></a><span id="l68.24"> </span>
<a href="#l68.25"></a><span id="l68.25"> // Only allow one connecting window per endpoint.</span>
<a href="#l68.26"></a><span id="l68.26"> var gConnecting = {};</span>
<a href="#l68.27"></a><span id="l68.27" class="difflineat">@@ -34,32 +33,30 @@ function OAuth2(aBaseURI, aScope, aAppKe</span>
<a href="#l68.28"></a><span id="l68.28"> </span>
<a href="#l68.29"></a><span id="l68.29">     this.log = Log4Moz.getConfiguredLogger(&quot;TBOAuth&quot;);</span>
<a href="#l68.30"></a><span id="l68.30"> }</span>
<a href="#l68.31"></a><span id="l68.31"> </span>
<a href="#l68.32"></a><span id="l68.32"> OAuth2.CODE_AUTHORIZATION = &quot;authorization_code&quot;;</span>
<a href="#l68.33"></a><span id="l68.33"> OAuth2.CODE_REFRESH = &quot;refresh_token&quot;;</span>
<a href="#l68.34"></a><span id="l68.34"> </span>
<a href="#l68.35"></a><span id="l68.35"> OAuth2.prototype = {</span>
<a href="#l68.36"></a><span id="l68.36" class="difflineminus">-</span>
<a href="#l68.37"></a><span id="l68.37">     responseType: &quot;code&quot;,</span>
<a href="#l68.38"></a><span id="l68.38">     consumerKey: null,</span>
<a href="#l68.39"></a><span id="l68.39">     consumerSecret: null,</span>
<a href="#l68.40"></a><span id="l68.40">     completionURI: &quot;http://localhost&quot;,</span>
<a href="#l68.41"></a><span id="l68.41">     requestWindowURI: &quot;chrome://messenger/content/browserRequest.xul&quot;,</span>
<a href="#l68.42"></a><span id="l68.42">     requestWindowFeatures: &quot;chrome,private,centerscreen,width=980,height=750&quot;,</span>
<a href="#l68.43"></a><span id="l68.43">     requestWindowTitle: &quot;&quot;,</span>
<a href="#l68.44"></a><span id="l68.44">     scope: null,</span>
<a href="#l68.45"></a><span id="l68.45"> </span>
<a href="#l68.46"></a><span id="l68.46">     accessToken: null,</span>
<a href="#l68.47"></a><span id="l68.47">     refreshToken: null,</span>
<a href="#l68.48"></a><span id="l68.48">     tokenExpires: 0,</span>
<a href="#l68.49"></a><span id="l68.49"> </span>
<a href="#l68.50"></a><span id="l68.50" class="difflineminus">-    connect: function connect(aSuccess, aFailure, aWithUI, aRefresh) {</span>
<a href="#l68.51"></a><span id="l68.51" class="difflineminus">-</span>
<a href="#l68.52"></a><span id="l68.52" class="difflineplus">+    connect(aSuccess, aFailure, aWithUI, aRefresh) {</span>
<a href="#l68.53"></a><span id="l68.53">         this.connectSuccessCallback = aSuccess;</span>
<a href="#l68.54"></a><span id="l68.54">         this.connectFailureCallback = aFailure;</span>
<a href="#l68.55"></a><span id="l68.55"> </span>
<a href="#l68.56"></a><span id="l68.56">         if (!aRefresh &amp;&amp; this.accessToken) {</span>
<a href="#l68.57"></a><span id="l68.57">             aSuccess();</span>
<a href="#l68.58"></a><span id="l68.58">         } else if (this.refreshToken) {</span>
<a href="#l68.59"></a><span id="l68.59">             this.requestAccessToken(this.refreshToken, OAuth2.CODE_REFRESH);</span>
<a href="#l68.60"></a><span id="l68.60">         } else {</span>
<a href="#l68.61"></a><span id="l68.61" class="difflineat">@@ -70,163 +67,163 @@ OAuth2.prototype = {</span>
<a href="#l68.62"></a><span id="l68.62">             if (gConnecting[this.authURI]) {</span>
<a href="#l68.63"></a><span id="l68.63">                 aFailure(&quot;Window already open&quot;);</span>
<a href="#l68.64"></a><span id="l68.64">                 return;</span>
<a href="#l68.65"></a><span id="l68.65">             }</span>
<a href="#l68.66"></a><span id="l68.66">             this.requestAuthorization();</span>
<a href="#l68.67"></a><span id="l68.67">         }</span>
<a href="#l68.68"></a><span id="l68.68">     },</span>
<a href="#l68.69"></a><span id="l68.69"> </span>
<a href="#l68.70"></a><span id="l68.70" class="difflineminus">-    requestAuthorization: function requestAuthorization() {</span>
<a href="#l68.71"></a><span id="l68.71" class="difflineplus">+    requestAuthorization() {</span>
<a href="#l68.72"></a><span id="l68.72">         let params = [</span>
<a href="#l68.73"></a><span id="l68.73">             [&quot;response_type&quot;, this.responseType],</span>
<a href="#l68.74"></a><span id="l68.74">             [&quot;client_id&quot;, this.consumerKey],</span>
<a href="#l68.75"></a><span id="l68.75">             [&quot;redirect_uri&quot;, this.completionURI],</span>
<a href="#l68.76"></a><span id="l68.76">         ];</span>
<a href="#l68.77"></a><span id="l68.77">         // The scope can be optional.</span>
<a href="#l68.78"></a><span id="l68.78">         if (this.scope) {</span>
<a href="#l68.79"></a><span id="l68.79">             params.push([&quot;scope&quot;, this.scope]);</span>
<a href="#l68.80"></a><span id="l68.80">         }</span>
<a href="#l68.81"></a><span id="l68.81"> </span>
<a href="#l68.82"></a><span id="l68.82">         // Add extra parameters</span>
<a href="#l68.83"></a><span id="l68.83">         params.push(...this.extraAuthParams);</span>
<a href="#l68.84"></a><span id="l68.84"> </span>
<a href="#l68.85"></a><span id="l68.85">         // Now map the parameters to a string</span>
<a href="#l68.86"></a><span id="l68.86" class="difflineminus">-        params = params.map(([k,v]) =&gt; k + &quot;=&quot; + encodeURIComponent(v)).join(&quot;&amp;&quot;);</span>
<a href="#l68.87"></a><span id="l68.87" class="difflineplus">+        params = params.map(([k, v]) =&gt; k + &quot;=&quot; + encodeURIComponent(v)).join(&quot;&amp;&quot;);</span>
<a href="#l68.88"></a><span id="l68.88"> </span>
<a href="#l68.89"></a><span id="l68.89">         this._browserRequest = {</span>
<a href="#l68.90"></a><span id="l68.90">             account: this,</span>
<a href="#l68.91"></a><span id="l68.91">             url: this.authURI + &quot;?&quot; + params,</span>
<a href="#l68.92"></a><span id="l68.92">             _active: true,</span>
<a href="#l68.93"></a><span id="l68.93">             iconURI: &quot;&quot;,</span>
<a href="#l68.94"></a><span id="l68.94" class="difflineminus">-            cancelled: function() {</span>
<a href="#l68.95"></a><span id="l68.95" class="difflineplus">+            cancelled() {</span>
<a href="#l68.96"></a><span id="l68.96">                 if (!this._active) {</span>
<a href="#l68.97"></a><span id="l68.97">                     return;</span>
<a href="#l68.98"></a><span id="l68.98">                 }</span>
<a href="#l68.99"></a><span id="l68.99"> </span>
<a href="#l68.100"></a><span id="l68.100">                 this.account.finishAuthorizationRequest();</span>
<a href="#l68.101"></a><span id="l68.101">                 this.account.onAuthorizationFailed(Cr.NS_ERROR_ABORT, '{ &quot;error&quot;: &quot;cancelled&quot;}');</span>
<a href="#l68.102"></a><span id="l68.102">             },</span>
<a href="#l68.103"></a><span id="l68.103"> </span>
<a href="#l68.104"></a><span id="l68.104" class="difflineminus">-            loaded: function (aWindow, aWebProgress) {</span>
<a href="#l68.105"></a><span id="l68.105" class="difflineplus">+            loaded(aWindow, aWebProgress) {</span>
<a href="#l68.106"></a><span id="l68.106">                 if (!this._active) {</span>
<a href="#l68.107"></a><span id="l68.107">                     return;</span>
<a href="#l68.108"></a><span id="l68.108">                 }</span>
<a href="#l68.109"></a><span id="l68.109"> </span>
<a href="#l68.110"></a><span id="l68.110">                 this._listener = {</span>
<a href="#l68.111"></a><span id="l68.111">                     window: aWindow,</span>
<a href="#l68.112"></a><span id="l68.112">                     webProgress: aWebProgress,</span>
<a href="#l68.113"></a><span id="l68.113">                     _parent: this.account,</span>
<a href="#l68.114"></a><span id="l68.114"> </span>
<a href="#l68.115"></a><span id="l68.115">                     QueryInterface: ChromeUtils.generateQI([Ci.nsIWebProgressListener,</span>
<a href="#l68.116"></a><span id="l68.116">                                                             Ci.nsISupportsWeakReference]),</span>
<a href="#l68.117"></a><span id="l68.117"> </span>
<a href="#l68.118"></a><span id="l68.118" class="difflineminus">-                    _cleanUp: function() {</span>
<a href="#l68.119"></a><span id="l68.119" class="difflineplus">+                    _cleanUp() {</span>
<a href="#l68.120"></a><span id="l68.120">                       this.webProgress.removeProgressListener(this);</span>
<a href="#l68.121"></a><span id="l68.121">                       this.window.close();</span>
<a href="#l68.122"></a><span id="l68.122">                       delete this.window;</span>
<a href="#l68.123"></a><span id="l68.123">                     },</span>
<a href="#l68.124"></a><span id="l68.124"> </span>
<a href="#l68.125"></a><span id="l68.125" class="difflineminus">-                    _checkForRedirect: function(aURL) {</span>
<a href="#l68.126"></a><span id="l68.126" class="difflineplus">+                    _checkForRedirect(aURL) {</span>
<a href="#l68.127"></a><span id="l68.127">                       if (aURL.indexOf(this._parent.completionURI) != 0)</span>
<a href="#l68.128"></a><span id="l68.128">                         return;</span>
<a href="#l68.129"></a><span id="l68.129"> </span>
<a href="#l68.130"></a><span id="l68.130">                       this._parent.finishAuthorizationRequest();</span>
<a href="#l68.131"></a><span id="l68.131">                       this._parent.onAuthorizationReceived(aURL);</span>
<a href="#l68.132"></a><span id="l68.132">                     },</span>
<a href="#l68.133"></a><span id="l68.133"> </span>
<a href="#l68.134"></a><span id="l68.134" class="difflineminus">-                    onStateChange: function(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l68.135"></a><span id="l68.135" class="difflineplus">+                    onStateChange(aWebProgress, aRequest, aStateFlags, aStatus) {</span>
<a href="#l68.136"></a><span id="l68.136">                       const wpl = Ci.nsIWebProgressListener;</span>
<a href="#l68.137"></a><span id="l68.137">                       if (aStateFlags &amp; (wpl.STATE_START | wpl.STATE_IS_NETWORK))</span>
<a href="#l68.138"></a><span id="l68.138">                         this._checkForRedirect(aRequest.name);</span>
<a href="#l68.139"></a><span id="l68.139">                     },</span>
<a href="#l68.140"></a><span id="l68.140" class="difflineminus">-                    onLocationChange: function(aWebProgress, aRequest, aLocation) {</span>
<a href="#l68.141"></a><span id="l68.141" class="difflineplus">+                    onLocationChange(aWebProgress, aRequest, aLocation) {</span>
<a href="#l68.142"></a><span id="l68.142">                       this._checkForRedirect(aLocation.spec);</span>
<a href="#l68.143"></a><span id="l68.143">                     },</span>
<a href="#l68.144"></a><span id="l68.144" class="difflineminus">-                    onProgressChange: function() {},</span>
<a href="#l68.145"></a><span id="l68.145" class="difflineminus">-                    onStatusChange: function() {},</span>
<a href="#l68.146"></a><span id="l68.146" class="difflineminus">-                    onSecurityChange: function() {},</span>
<a href="#l68.147"></a><span id="l68.147" class="difflineplus">+                    onProgressChange() {},</span>
<a href="#l68.148"></a><span id="l68.148" class="difflineplus">+                    onStatusChange() {},</span>
<a href="#l68.149"></a><span id="l68.149" class="difflineplus">+                    onSecurityChange() {},</span>
<a href="#l68.150"></a><span id="l68.150">                 };</span>
<a href="#l68.151"></a><span id="l68.151">                 aWebProgress.addProgressListener(this._listener,</span>
<a href="#l68.152"></a><span id="l68.152">                                                  Ci.nsIWebProgress.NOTIFY_ALL);</span>
<a href="#l68.153"></a><span id="l68.153">                 aWindow.document.title = this.account.requestWindowTitle;</span>
<a href="#l68.154"></a><span id="l68.154" class="difflineminus">-            }</span>
<a href="#l68.155"></a><span id="l68.155" class="difflineplus">+            },</span>
<a href="#l68.156"></a><span id="l68.156">         };</span>
<a href="#l68.157"></a><span id="l68.157"> </span>
<a href="#l68.158"></a><span id="l68.158">         this.wrappedJSObject = this._browserRequest;</span>
<a href="#l68.159"></a><span id="l68.159">         gConnecting[this.authURI] = true;</span>
<a href="#l68.160"></a><span id="l68.160">         Services.ww.openWindow(null, this.requestWindowURI, null, this.requestWindowFeatures, this);</span>
<a href="#l68.161"></a><span id="l68.161">     },</span>
<a href="#l68.162"></a><span id="l68.162" class="difflineminus">-    finishAuthorizationRequest: function() {</span>
<a href="#l68.163"></a><span id="l68.163" class="difflineplus">+    finishAuthorizationRequest() {</span>
<a href="#l68.164"></a><span id="l68.164">         gConnecting[this.authURI] = false;</span>
<a href="#l68.165"></a><span id="l68.165">         if (!(&quot;_browserRequest&quot; in this)) {</span>
<a href="#l68.166"></a><span id="l68.166">             return;</span>
<a href="#l68.167"></a><span id="l68.167">         }</span>
<a href="#l68.168"></a><span id="l68.168"> </span>
<a href="#l68.169"></a><span id="l68.169">         this._browserRequest._active = false;</span>
<a href="#l68.170"></a><span id="l68.170">         if (&quot;_listener&quot; in this._browserRequest) {</span>
<a href="#l68.171"></a><span id="l68.171">             this._browserRequest._listener._cleanUp();</span>
<a href="#l68.172"></a><span id="l68.172">         }</span>
<a href="#l68.173"></a><span id="l68.173">         delete this._browserRequest;</span>
<a href="#l68.174"></a><span id="l68.174">     },</span>
<a href="#l68.175"></a><span id="l68.175"> </span>
<a href="#l68.176"></a><span id="l68.176" class="difflineminus">-    onAuthorizationReceived: function(aData) {</span>
<a href="#l68.177"></a><span id="l68.177" class="difflineplus">+    onAuthorizationReceived(aData) {</span>
<a href="#l68.178"></a><span id="l68.178">         this.log.info(&quot;authorization received&quot; + aData);</span>
<a href="#l68.179"></a><span id="l68.179">         let results = parseURLData(aData);</span>
<a href="#l68.180"></a><span id="l68.180">         if (this.responseType == &quot;code&quot; &amp;&amp; results.code) {</span>
<a href="#l68.181"></a><span id="l68.181">             this.requestAccessToken(results.code, OAuth2.CODE_AUTHORIZATION);</span>
<a href="#l68.182"></a><span id="l68.182">         } else if (this.responseType == &quot;token&quot;) {</span>
<a href="#l68.183"></a><span id="l68.183">             this.onAccessTokenReceived(JSON.stringify(results));</span>
<a href="#l68.184"></a><span id="l68.184" class="difflineplus">+        } else {</span>
<a href="#l68.185"></a><span id="l68.185" class="difflineplus">+            this.onAuthorizationFailed(null, aData);</span>
<a href="#l68.186"></a><span id="l68.186">         }</span>
<a href="#l68.187"></a><span id="l68.187" class="difflineminus">-        else</span>
<a href="#l68.188"></a><span id="l68.188" class="difflineminus">-          this.onAuthorizationFailed(null, aData);</span>
<a href="#l68.189"></a><span id="l68.189">     },</span>
<a href="#l68.190"></a><span id="l68.190"> </span>
<a href="#l68.191"></a><span id="l68.191" class="difflineminus">-    onAuthorizationFailed: function(aError, aData) {</span>
<a href="#l68.192"></a><span id="l68.192" class="difflineplus">+    onAuthorizationFailed(aError, aData) {</span>
<a href="#l68.193"></a><span id="l68.193">         this.connectFailureCallback(aData);</span>
<a href="#l68.194"></a><span id="l68.194">     },</span>
<a href="#l68.195"></a><span id="l68.195"> </span>
<a href="#l68.196"></a><span id="l68.196" class="difflineminus">-    requestAccessToken: function requestAccessToken(aCode, aType) {</span>
<a href="#l68.197"></a><span id="l68.197" class="difflineplus">+    requestAccessToken(aCode, aType) {</span>
<a href="#l68.198"></a><span id="l68.198">         let params = [</span>
<a href="#l68.199"></a><span id="l68.199">             [&quot;client_id&quot;, this.consumerKey],</span>
<a href="#l68.200"></a><span id="l68.200">             [&quot;client_secret&quot;, this.consumerSecret],</span>
<a href="#l68.201"></a><span id="l68.201">             [&quot;grant_type&quot;, aType],</span>
<a href="#l68.202"></a><span id="l68.202">         ];</span>
<a href="#l68.203"></a><span id="l68.203"> </span>
<a href="#l68.204"></a><span id="l68.204">         if (aType == OAuth2.CODE_AUTHORIZATION) {</span>
<a href="#l68.205"></a><span id="l68.205">             params.push([&quot;code&quot;, aCode]);</span>
<a href="#l68.206"></a><span id="l68.206">             params.push([&quot;redirect_uri&quot;, this.completionURI]);</span>
<a href="#l68.207"></a><span id="l68.207">         } else if (aType == OAuth2.CODE_REFRESH) {</span>
<a href="#l68.208"></a><span id="l68.208">             params.push([&quot;refresh_token&quot;, aCode]);</span>
<a href="#l68.209"></a><span id="l68.209">         }</span>
<a href="#l68.210"></a><span id="l68.210"> </span>
<a href="#l68.211"></a><span id="l68.211">         let options = {</span>
<a href="#l68.212"></a><span id="l68.212">           postData: params,</span>
<a href="#l68.213"></a><span id="l68.213">           onLoad: this.onAccessTokenReceived.bind(this),</span>
<a href="#l68.214"></a><span id="l68.214" class="difflineminus">-          onError: this.onAccessTokenFailed.bind(this)</span>
<a href="#l68.215"></a><span id="l68.215" class="difflineminus">-        }</span>
<a href="#l68.216"></a><span id="l68.216" class="difflineplus">+          onError: this.onAccessTokenFailed.bind(this),</span>
<a href="#l68.217"></a><span id="l68.217" class="difflineplus">+        };</span>
<a href="#l68.218"></a><span id="l68.218">         httpRequest(this.tokenURI, options);</span>
<a href="#l68.219"></a><span id="l68.219">     },</span>
<a href="#l68.220"></a><span id="l68.220"> </span>
<a href="#l68.221"></a><span id="l68.221" class="difflineminus">-    onAccessTokenFailed: function onAccessTokenFailed(aError, aData) {</span>
<a href="#l68.222"></a><span id="l68.222" class="difflineplus">+    onAccessTokenFailed(aError, aData) {</span>
<a href="#l68.223"></a><span id="l68.223">         if (aError != &quot;offline&quot;) {</span>
<a href="#l68.224"></a><span id="l68.224">             this.refreshToken = null;</span>
<a href="#l68.225"></a><span id="l68.225">         }</span>
<a href="#l68.226"></a><span id="l68.226">         this.connectFailureCallback(aData);</span>
<a href="#l68.227"></a><span id="l68.227">     },</span>
<a href="#l68.228"></a><span id="l68.228"> </span>
<a href="#l68.229"></a><span id="l68.229" class="difflineminus">-    onAccessTokenReceived: function onRequestTokenReceived(aData) {</span>
<a href="#l68.230"></a><span id="l68.230" class="difflineplus">+    onAccessTokenReceived(aData) {</span>
<a href="#l68.231"></a><span id="l68.231">         let result = JSON.parse(aData);</span>
<a href="#l68.232"></a><span id="l68.232"> </span>
<a href="#l68.233"></a><span id="l68.233">         this.accessToken = result.access_token;</span>
<a href="#l68.234"></a><span id="l68.234">         if (&quot;refresh_token&quot; in result) {</span>
<a href="#l68.235"></a><span id="l68.235">             this.refreshToken = result.refresh_token;</span>
<a href="#l68.236"></a><span id="l68.236">         }</span>
<a href="#l68.237"></a><span id="l68.237">         if (&quot;expires_in&quot; in result) {</span>
<a href="#l68.238"></a><span id="l68.238">             this.tokenExpires = (new Date()).getTime() + (result.expires_in * 1000);</span>
<a href="#l68.239"></a><span id="l68.239">         } else {</span>
<a href="#l68.240"></a><span id="l68.240">             this.tokenExpires = Number.MAX_VALUE;</span>
<a href="#l68.241"></a><span id="l68.241">         }</span>
<a href="#l68.242"></a><span id="l68.242">         this.tokenType = result.token_type;</span>
<a href="#l68.243"></a><span id="l68.243"> </span>
<a href="#l68.244"></a><span id="l68.244">         this.connectSuccessCallback();</span>
<a href="#l68.245"></a><span id="l68.245" class="difflineminus">-    }</span>
<a href="#l68.246"></a><span id="l68.246" class="difflineplus">+    },</span>
<a href="#l68.247"></a><span id="l68.247"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/mailnews/base/util/OAuth2Providers.jsm</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/mailnews/base/util/OAuth2Providers.jsm</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -26,40 +26,40 @@ var kHostnames = new Map([</span>
<a href="#l69.4"></a><span id="l69.4"> </span>
<a href="#l69.5"></a><span id="l69.5"> // map of issuers to appKey, appSecret, authURI, tokenURI</span>
<a href="#l69.6"></a><span id="l69.6"> </span>
<a href="#l69.7"></a><span id="l69.7"> // For the moment, these details are hard-coded, since Google does not</span>
<a href="#l69.8"></a><span id="l69.8"> // provide dynamic client registration. Don't copy these values for your</span>
<a href="#l69.9"></a><span id="l69.9"> // own application--register it yourself. This code (and possibly even the</span>
<a href="#l69.10"></a><span id="l69.10"> // registration itself) will disappear when this is switched to dynamic</span>
<a href="#l69.11"></a><span id="l69.11"> // client registration.</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineminus">-var kIssuers = new Map ([</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+var kIssuers = new Map([</span>
<a href="#l69.14"></a><span id="l69.14">   [&quot;accounts.google.com&quot;, [</span>
<a href="#l69.15"></a><span id="l69.15" class="difflineminus">-    '406964657835-aq8lmia8j95dhl1a2bvharmfk3t1hgqj.apps.googleusercontent.com',</span>
<a href="#l69.16"></a><span id="l69.16" class="difflineminus">-    'kSmqreRr0qwBWJgbf5Y-PjSU',</span>
<a href="#l69.17"></a><span id="l69.17" class="difflineminus">-    'https://accounts.google.com/o/oauth2/auth',</span>
<a href="#l69.18"></a><span id="l69.18" class="difflineminus">-    'https://www.googleapis.com/oauth2/v3/token'</span>
<a href="#l69.19"></a><span id="l69.19" class="difflineplus">+    &quot;406964657835-aq8lmia8j95dhl1a2bvharmfk3t1hgqj.apps.googleusercontent.com&quot;,</span>
<a href="#l69.20"></a><span id="l69.20" class="difflineplus">+    &quot;kSmqreRr0qwBWJgbf5Y-PjSU&quot;,</span>
<a href="#l69.21"></a><span id="l69.21" class="difflineplus">+    &quot;https://accounts.google.com/o/oauth2/auth&quot;,</span>
<a href="#l69.22"></a><span id="l69.22" class="difflineplus">+    &quot;https://www.googleapis.com/oauth2/v3/token&quot;,</span>
<a href="#l69.23"></a><span id="l69.23">   ]],</span>
<a href="#l69.24"></a><span id="l69.24">   [&quot;o2.mail.ru&quot;, [</span>
<a href="#l69.25"></a><span id="l69.25" class="difflineminus">-    'thunderbird',</span>
<a href="#l69.26"></a><span id="l69.26" class="difflineminus">-    'I0dCAXrcaNFujaaY',</span>
<a href="#l69.27"></a><span id="l69.27" class="difflineminus">-    'https://o2.mail.ru/login',</span>
<a href="#l69.28"></a><span id="l69.28" class="difflineminus">-    'https://o2.mail.ru/token'</span>
<a href="#l69.29"></a><span id="l69.29" class="difflineplus">+    &quot;thunderbird&quot;,</span>
<a href="#l69.30"></a><span id="l69.30" class="difflineplus">+    &quot;I0dCAXrcaNFujaaY&quot;,</span>
<a href="#l69.31"></a><span id="l69.31" class="difflineplus">+    &quot;https://o2.mail.ru/login&quot;,</span>
<a href="#l69.32"></a><span id="l69.32" class="difflineplus">+    &quot;https://o2.mail.ru/token&quot;,</span>
<a href="#l69.33"></a><span id="l69.33">   ]],</span>
<a href="#l69.34"></a><span id="l69.34">   [&quot;login.yahoo.com&quot;, [</span>
<a href="#l69.35"></a><span id="l69.35" class="difflineminus">-    'dj0yJmk9NUtCTWFMNVpTaVJmJmQ9WVdrOVJ6UjVTa2xJTXpRbWNHbzlNQS0tJnM9Y29uc3VtZXJzZWNyZXQmeD0yYw--',</span>
<a href="#l69.36"></a><span id="l69.36" class="difflineminus">-    'f2de6a30ae123cdbc258c15e0812799010d589cc',</span>
<a href="#l69.37"></a><span id="l69.37" class="difflineminus">-    'https://api.login.yahoo.com/oauth2/request_auth',</span>
<a href="#l69.38"></a><span id="l69.38" class="difflineminus">-    'https://api.login.yahoo.com/oauth2/get_token'</span>
<a href="#l69.39"></a><span id="l69.39" class="difflineplus">+    &quot;dj0yJmk9NUtCTWFMNVpTaVJmJmQ9WVdrOVJ6UjVTa2xJTXpRbWNHbzlNQS0tJnM9Y29uc3VtZXJzZWNyZXQmeD0yYw--&quot;,</span>
<a href="#l69.40"></a><span id="l69.40" class="difflineplus">+    &quot;f2de6a30ae123cdbc258c15e0812799010d589cc&quot;,</span>
<a href="#l69.41"></a><span id="l69.41" class="difflineplus">+    &quot;https://api.login.yahoo.com/oauth2/request_auth&quot;,</span>
<a href="#l69.42"></a><span id="l69.42" class="difflineplus">+    &quot;https://api.login.yahoo.com/oauth2/get_token&quot;,</span>
<a href="#l69.43"></a><span id="l69.43">   ]],</span>
<a href="#l69.44"></a><span id="l69.44">   [&quot;login.aol.com&quot;, [</span>
<a href="#l69.45"></a><span id="l69.45" class="difflineminus">-    'dj0yJmk9OXRHc1FqZHRQYzVvJmQ9WVdrOU1UQnJOR0pvTjJrbWNHbzlNQS0tJnM9Y29uc3VtZXJzZWNyZXQmeD02NQ--',</span>
<a href="#l69.46"></a><span id="l69.46" class="difflineminus">-    '79c1c11991d148ddd02a919000d69879942fc278',</span>
<a href="#l69.47"></a><span id="l69.47" class="difflineminus">-    'https://api.login.aol.com/oauth2/request_auth',</span>
<a href="#l69.48"></a><span id="l69.48" class="difflineminus">-    'https://api.login.aol.com/oauth2/get_token'</span>
<a href="#l69.49"></a><span id="l69.49" class="difflineplus">+    &quot;dj0yJmk9OXRHc1FqZHRQYzVvJmQ9WVdrOU1UQnJOR0pvTjJrbWNHbzlNQS0tJnM9Y29uc3VtZXJzZWNyZXQmeD02NQ--&quot;,</span>
<a href="#l69.50"></a><span id="l69.50" class="difflineplus">+    &quot;79c1c11991d148ddd02a919000d69879942fc278&quot;,</span>
<a href="#l69.51"></a><span id="l69.51" class="difflineplus">+    &quot;https://api.login.aol.com/oauth2/request_auth&quot;,</span>
<a href="#l69.52"></a><span id="l69.52" class="difflineplus">+    &quot;https://api.login.aol.com/oauth2/get_token&quot;,</span>
<a href="#l69.53"></a><span id="l69.53">   ]],</span>
<a href="#l69.54"></a><span id="l69.54"> ]);</span>
<a href="#l69.55"></a><span id="l69.55"> </span>
<a href="#l69.56"></a><span id="l69.56"> /**</span>
<a href="#l69.57"></a><span id="l69.57">  *  OAuth2Providers: Methods to lookup OAuth2 parameters for supported</span>
<a href="#l69.58"></a><span id="l69.58">  *                   email providers.</span>
<a href="#l69.59"></a><span id="l69.59">  */</span>
<a href="#l69.60"></a><span id="l69.60"> var OAuth2Providers = {</span>
<a href="#l69.61"></a><span id="l69.61" class="difflineat">@@ -70,24 +70,28 @@ var OAuth2Providers = {</span>
<a href="#l69.62"></a><span id="l69.62">    * @param aHostname  String representing the url for an imap or smtp</span>
<a href="#l69.63"></a><span id="l69.63">    *                   server (example &quot;imap.googlemail.com&quot;).</span>
<a href="#l69.64"></a><span id="l69.64">    *</span>
<a href="#l69.65"></a><span id="l69.65">    * @returns          Array with [issuer, scope] for the hostname if found,</span>
<a href="#l69.66"></a><span id="l69.66">    *                   else undefined. issuer is a string representing the</span>
<a href="#l69.67"></a><span id="l69.67">    *                   organization, scope is an oauth parameter describing\</span>
<a href="#l69.68"></a><span id="l69.68">    *                   the required access level.</span>
<a href="#l69.69"></a><span id="l69.69">    */</span>
<a href="#l69.70"></a><span id="l69.70" class="difflineminus">-  getHostnameDetails: function (aHostname) { return kHostnames.get(aHostname);},</span>
<a href="#l69.71"></a><span id="l69.71" class="difflineplus">+  getHostnameDetails(aHostname) {</span>
<a href="#l69.72"></a><span id="l69.72" class="difflineplus">+    return kHostnames.get(aHostname);</span>
<a href="#l69.73"></a><span id="l69.73" class="difflineplus">+  },</span>
<a href="#l69.74"></a><span id="l69.74"> </span>
<a href="#l69.75"></a><span id="l69.75">   /**</span>
<a href="#l69.76"></a><span id="l69.76">    * Map an issuer to OAuth2 account details.</span>
<a href="#l69.77"></a><span id="l69.77">    *</span>
<a href="#l69.78"></a><span id="l69.78">    * @param aIssuer    The organization issuing oauth2 parameters, example</span>
<a href="#l69.79"></a><span id="l69.79">    *                   &quot;accounts.google.com&quot;.</span>
<a href="#l69.80"></a><span id="l69.80">    *</span>
<a href="#l69.81"></a><span id="l69.81">    * @return           Array containing [appKey, appSecret, authURI, tokenURI]</span>
<a href="#l69.82"></a><span id="l69.82">    *                   where appKey and appDetails are strings representing the</span>
<a href="#l69.83"></a><span id="l69.83">    *                   account registered for Thunderbird with the organization,</span>
<a href="#l69.84"></a><span id="l69.84">    *                   authURI and tokenURI are url strings representing</span>
<a href="#l69.85"></a><span id="l69.85">    *                   endpoints to access OAuth2 authentication.</span>
<a href="#l69.86"></a><span id="l69.86">    */</span>
<a href="#l69.87"></a><span id="l69.87" class="difflineminus">-  getIssuerDetails: function (aIssuer) { return kIssuers.get(aIssuer);}</span>
<a href="#l69.88"></a><span id="l69.88" class="difflineminus">-}</span>
<a href="#l69.89"></a><span id="l69.89" class="difflineplus">+  getIssuerDetails(aIssuer) {</span>
<a href="#l69.90"></a><span id="l69.90" class="difflineplus">+    return kIssuers.get(aIssuer);</span>
<a href="#l69.91"></a><span id="l69.91" class="difflineplus">+  },</span>
<a href="#l69.92"></a><span id="l69.92" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/mailnews/base/util/StringBundle.js</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/mailnews/base/util/StringBundle.js</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -67,30 +67,29 @@ StringBundle.prototype = {</span>
<a href="#l70.4"></a><span id="l70.4">    *</span>
<a href="#l70.5"></a><span id="l70.5">    * @param key {String}</span>
<a href="#l70.6"></a><span id="l70.6">    *        the identifier of the string to get</span>
<a href="#l70.7"></a><span id="l70.7">    * @param args {array} [optional]</span>
<a href="#l70.8"></a><span id="l70.8">    *        an array of arguments that replace occurrences of %S in the string</span>
<a href="#l70.9"></a><span id="l70.9">    *</span>
<a href="#l70.10"></a><span id="l70.10">    * @returns {String} the value of the string</span>
<a href="#l70.11"></a><span id="l70.11">    */</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-  get: function(key, args) {</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+  get(key, args) {</span>
<a href="#l70.14"></a><span id="l70.14">     if (args)</span>
<a href="#l70.15"></a><span id="l70.15">       return this.stringBundle.formatStringFromName(key, args, args.length);</span>
<a href="#l70.16"></a><span id="l70.16" class="difflineminus">-    else</span>
<a href="#l70.17"></a><span id="l70.17" class="difflineminus">-      return this.stringBundle.GetStringFromName(key);</span>
<a href="#l70.18"></a><span id="l70.18" class="difflineplus">+    return this.stringBundle.GetStringFromName(key);</span>
<a href="#l70.19"></a><span id="l70.19">   },</span>
<a href="#l70.20"></a><span id="l70.20"> </span>
<a href="#l70.21"></a><span id="l70.21">   /**</span>
<a href="#l70.22"></a><span id="l70.22">    * Get all the strings in the bundle.</span>
<a href="#l70.23"></a><span id="l70.23">    *</span>
<a href="#l70.24"></a><span id="l70.24">    * @returns {Array}</span>
<a href="#l70.25"></a><span id="l70.25">    *          an array of objects with key and value properties</span>
<a href="#l70.26"></a><span id="l70.26">    */</span>
<a href="#l70.27"></a><span id="l70.27" class="difflineminus">-  getAll: function() {</span>
<a href="#l70.28"></a><span id="l70.28" class="difflineplus">+  getAll() {</span>
<a href="#l70.29"></a><span id="l70.29">     let strings = [];</span>
<a href="#l70.30"></a><span id="l70.30"> </span>
<a href="#l70.31"></a><span id="l70.31">     // FIXME: for performance, return an enumerable array that wraps the string</span>
<a href="#l70.32"></a><span id="l70.32">     // bundle's nsISimpleEnumerator (does JavaScript already support this?).</span>
<a href="#l70.33"></a><span id="l70.33"> </span>
<a href="#l70.34"></a><span id="l70.34">     let enumerator = this.stringBundle.getSimpleEnumeration();</span>
<a href="#l70.35"></a><span id="l70.35"> </span>
<a href="#l70.36"></a><span id="l70.36">     while (enumerator.hasMoreElements()) {</span>
<a href="#l70.37"></a><span id="l70.37" class="difflineat">@@ -138,28 +137,28 @@ StringBundle.prototype = {</span>
<a href="#l70.38"></a><span id="l70.38">    * @deprecated use |get| instead</span>
<a href="#l70.39"></a><span id="l70.39">    *</span>
<a href="#l70.40"></a><span id="l70.40">    * @param key {String}</span>
<a href="#l70.41"></a><span id="l70.41">    *        the identifier of the string to get</span>
<a href="#l70.42"></a><span id="l70.42">    *</span>
<a href="#l70.43"></a><span id="l70.43">    * @returns {String}</span>
<a href="#l70.44"></a><span id="l70.44">    *          the value of the string</span>
<a href="#l70.45"></a><span id="l70.45">    */</span>
<a href="#l70.46"></a><span id="l70.46" class="difflineminus">-  getString: function(key) {</span>
<a href="#l70.47"></a><span id="l70.47" class="difflineplus">+  getString(key) {</span>
<a href="#l70.48"></a><span id="l70.48">     return this.get(key);</span>
<a href="#l70.49"></a><span id="l70.49">   },</span>
<a href="#l70.50"></a><span id="l70.50"> </span>
<a href="#l70.51"></a><span id="l70.51">   /**</span>
<a href="#l70.52"></a><span id="l70.52">    * Get a formatted string from the bundle.</span>
<a href="#l70.53"></a><span id="l70.53">    * @deprecated use |get| instead</span>
<a href="#l70.54"></a><span id="l70.54">    *</span>
<a href="#l70.55"></a><span id="l70.55">    * @param key {string}</span>
<a href="#l70.56"></a><span id="l70.56">    *        the identifier of the string to get</span>
<a href="#l70.57"></a><span id="l70.57">    * @param args {array}</span>
<a href="#l70.58"></a><span id="l70.58">    *        an array of arguments that replace occurrences of %S in the string</span>
<a href="#l70.59"></a><span id="l70.59">    *</span>
<a href="#l70.60"></a><span id="l70.60">    * @returns {String}</span>
<a href="#l70.61"></a><span id="l70.61">    *          the formatted value of the string</span>
<a href="#l70.62"></a><span id="l70.62">    */</span>
<a href="#l70.63"></a><span id="l70.63" class="difflineminus">-  getFormattedString: function(key, args) {</span>
<a href="#l70.64"></a><span id="l70.64" class="difflineplus">+  getFormattedString(key, args) {</span>
<a href="#l70.65"></a><span id="l70.65">     return this.get(key, args);</span>
<a href="#l70.66"></a><span id="l70.66" class="difflineminus">-  }</span>
<a href="#l70.67"></a><span id="l70.67" class="difflineminus">-}</span>
<a href="#l70.68"></a><span id="l70.68" class="difflineplus">+  },</span>
<a href="#l70.69"></a><span id="l70.69" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/mailnews/base/util/converterWorker.js</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/mailnews/base/util/converterWorker.js</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -212,17 +212,16 @@ function mboxToMaildir(mboxPath, maildir</span>
<a href="#l71.4"></a><span id="l71.4">         endPos = pos;</span>
<a href="#l71.5"></a><span id="l71.5">       }</span>
<a href="#l71.6"></a><span id="l71.6">     }</span>
<a href="#l71.7"></a><span id="l71.7"> </span>
<a href="#l71.8"></a><span id="l71.8">     if (endPos &gt; pos) {</span>
<a href="#l71.9"></a><span id="l71.9">       writeToMsg(buf.substring(pos, endPos));</span>
<a href="#l71.10"></a><span id="l71.10">     }</span>
<a href="#l71.11"></a><span id="l71.11">     buf = buf.substring(endPos);</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-</span>
<a href="#l71.13"></a><span id="l71.13">   }</span>
<a href="#l71.14"></a><span id="l71.14">   closeExistingMsg();</span>
<a href="#l71.15"></a><span id="l71.15"> }</span>
<a href="#l71.16"></a><span id="l71.16"> </span>
<a href="#l71.17"></a><span id="l71.17"> /**</span>
<a href="#l71.18"></a><span id="l71.18">  * Check if directory is a subfolder directory.</span>
<a href="#l71.19"></a><span id="l71.19">  *</span>
<a href="#l71.20"></a><span id="l71.20">  * @param {String} name     - Name of directory to check.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/mailnews/base/util/errUtils.js</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/mailnews/base/util/errUtils.js</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -67,107 +67,105 @@ function logEvent(aEvent) {</span>
<a href="#l72.4"></a><span id="l72.4"> function errorWithDebug(aString) {</span>
<a href="#l72.5"></a><span id="l72.5">   dump(&quot;PROBLEM: &quot; + aString + &quot;\n&quot;);</span>
<a href="#l72.6"></a><span id="l72.6">   dump(&quot;CURRENT STACK (and throwing):\n&quot;);</span>
<a href="#l72.7"></a><span id="l72.7">   // skip this frame.</span>
<a href="#l72.8"></a><span id="l72.8">   dump(stringifier.getStack(1));</span>
<a href="#l72.9"></a><span id="l72.9">   return new Error(aString);</span>
<a href="#l72.10"></a><span id="l72.10"> }</span>
<a href="#l72.11"></a><span id="l72.11"> </span>
<a href="#l72.12"></a><span id="l72.12" class="difflineminus">-function Stringifier() {};</span>
<a href="#l72.13"></a><span id="l72.13" class="difflineplus">+function Stringifier() {}</span>
<a href="#l72.14"></a><span id="l72.14"> </span>
<a href="#l72.15"></a><span id="l72.15"> Stringifier.prototype = {</span>
<a href="#l72.16"></a><span id="l72.16" class="difflineminus">-  dumpObj: function (o, name) {</span>
<a href="#l72.17"></a><span id="l72.17" class="difflineplus">+  dumpObj(o, name) {</span>
<a href="#l72.18"></a><span id="l72.18">     this._reset();</span>
<a href="#l72.19"></a><span id="l72.19">     this._append(this.objectTreeAsString(o, true, true, 0));</span>
<a href="#l72.20"></a><span id="l72.20">     dump(this._asString());</span>
<a href="#l72.21"></a><span id="l72.21">   },</span>
<a href="#l72.22"></a><span id="l72.22"> </span>
<a href="#l72.23"></a><span id="l72.23" class="difflineminus">-  dumpDOM: function(node, level, recursive) {</span>
<a href="#l72.24"></a><span id="l72.24" class="difflineplus">+  dumpDOM(node, level, recursive) {</span>
<a href="#l72.25"></a><span id="l72.25">     this._reset();</span>
<a href="#l72.26"></a><span id="l72.26">     let s = this.DOMNodeAsString(node, level, recursive);</span>
<a href="#l72.27"></a><span id="l72.27">     dump(s);</span>
<a href="#l72.28"></a><span id="l72.28">   },</span>
<a href="#l72.29"></a><span id="l72.29"> </span>
<a href="#l72.30"></a><span id="l72.30" class="difflineminus">-  dumpEvent: function(event) {</span>
<a href="#l72.31"></a><span id="l72.31" class="difflineplus">+  dumpEvent(event) {</span>
<a href="#l72.32"></a><span id="l72.32">     dump(this.eventAsString(event));</span>
<a href="#l72.33"></a><span id="l72.33">   },</span>
<a href="#l72.34"></a><span id="l72.34"> </span>
<a href="#l72.35"></a><span id="l72.35" class="difflineminus">-  dumpException: function(exc, message) {</span>
<a href="#l72.36"></a><span id="l72.36" class="difflineplus">+  dumpException(exc, message) {</span>
<a href="#l72.37"></a><span id="l72.37">     dump(exc + &quot;\n&quot;);</span>
<a href="#l72.38"></a><span id="l72.38">     this._reset();</span>
<a href="#l72.39"></a><span id="l72.39">     if (message)</span>
<a href="#l72.40"></a><span id="l72.40">       this._append(&quot;Exception (&quot; + message + &quot;)\n&quot;);</span>
<a href="#l72.41"></a><span id="l72.41"> </span>
<a href="#l72.42"></a><span id="l72.42">     this._append(&quot;-- Exception object --\n&quot;);</span>
<a href="#l72.43"></a><span id="l72.43">     this._append(this.objectTreeAsString(exc));</span>
<a href="#l72.44"></a><span id="l72.44">     if (exc.stack) {</span>
<a href="#l72.45"></a><span id="l72.45">       this._append(&quot;-- Stack Trace --\n&quot;);</span>
<a href="#l72.46"></a><span id="l72.46">       this._append(exc.stack); // skip dumpException and logException</span>
<a href="#l72.47"></a><span id="l72.47">     }</span>
<a href="#l72.48"></a><span id="l72.48">     dump(this._asString());</span>
<a href="#l72.49"></a><span id="l72.49">   },</span>
<a href="#l72.50"></a><span id="l72.50"> </span>
<a href="#l72.51"></a><span id="l72.51" class="difflineminus">-  _reset: function() {</span>
<a href="#l72.52"></a><span id="l72.52" class="difflineplus">+  _reset() {</span>
<a href="#l72.53"></a><span id="l72.53">     this._buffer = [];</span>
<a href="#l72.54"></a><span id="l72.54">   },</span>
<a href="#l72.55"></a><span id="l72.55"> </span>
<a href="#l72.56"></a><span id="l72.56" class="difflineminus">-  _append: function(string) {</span>
<a href="#l72.57"></a><span id="l72.57" class="difflineplus">+  _append(string) {</span>
<a href="#l72.58"></a><span id="l72.58">     this._buffer.push(string);</span>
<a href="#l72.59"></a><span id="l72.59">   },</span>
<a href="#l72.60"></a><span id="l72.60"> </span>
<a href="#l72.61"></a><span id="l72.61" class="difflineminus">-  _asString: function() {</span>
<a href="#l72.62"></a><span id="l72.62" class="difflineminus">-    let str = this._buffer.join('');</span>
<a href="#l72.63"></a><span id="l72.63" class="difflineplus">+  _asString() {</span>
<a href="#l72.64"></a><span id="l72.64" class="difflineplus">+    let str = this._buffer.join(&quot;&quot;);</span>
<a href="#l72.65"></a><span id="l72.65">     this._reset();</span>
<a href="#l72.66"></a><span id="l72.66">     return str;</span>
<a href="#l72.67"></a><span id="l72.67">   },</span>
<a href="#l72.68"></a><span id="l72.68"> </span>
<a href="#l72.69"></a><span id="l72.69" class="difflineminus">-  getStack: function(skipCount) {</span>
<a href="#l72.70"></a><span id="l72.70" class="difflineplus">+  getStack(skipCount) {</span>
<a href="#l72.71"></a><span id="l72.71">     if (typeof Components != &quot;object&quot; || typeof Cc != &quot;object&quot;)</span>
<a href="#l72.72"></a><span id="l72.72">       return &quot;No stack trace available.&quot;;</span>
<a href="#l72.73"></a><span id="l72.73">     if (typeof(skipCount) === undefined)</span>
<a href="#l72.74"></a><span id="l72.74">       skipCount = 0;</span>
<a href="#l72.75"></a><span id="l72.75"> </span>
<a href="#l72.76"></a><span id="l72.76">     let frame = Components.stack.caller;</span>
<a href="#l72.77"></a><span id="l72.77">     let str = &quot;&lt;top&gt;&quot;;</span>
<a href="#l72.78"></a><span id="l72.78"> </span>
<a href="#l72.79"></a><span id="l72.79">     while (frame) {</span>
<a href="#l72.80"></a><span id="l72.80">       if (skipCount &gt; 0) {</span>
<a href="#l72.81"></a><span id="l72.81">         // Skip this frame.</span>
<a href="#l72.82"></a><span id="l72.82">         skipCount -= 1;</span>
<a href="#l72.83"></a><span id="l72.83" class="difflineminus">-      }</span>
<a href="#l72.84"></a><span id="l72.84" class="difflineminus">-      else {</span>
<a href="#l72.85"></a><span id="l72.85" class="difflineplus">+      } else {</span>
<a href="#l72.86"></a><span id="l72.86">         // Include the data from this frame.</span>
<a href="#l72.87"></a><span id="l72.87">         let name = frame.name ? frame.name : &quot;[anonymous]&quot;;</span>
<a href="#l72.88"></a><span id="l72.88" class="difflineminus">-        str += &quot;\n&quot; + name + &quot;@&quot; + frame.filename + ':' + frame.lineNumber;</span>
<a href="#l72.89"></a><span id="l72.89" class="difflineplus">+        str += &quot;\n&quot; + name + &quot;@&quot; + frame.filename + &quot;:&quot; + frame.lineNumber;</span>
<a href="#l72.90"></a><span id="l72.90">       }</span>
<a href="#l72.91"></a><span id="l72.91">       frame = frame.caller;</span>
<a href="#l72.92"></a><span id="l72.92">     }</span>
<a href="#l72.93"></a><span id="l72.93">     return str + &quot;\n&quot;;</span>
<a href="#l72.94"></a><span id="l72.94">   },</span>
<a href="#l72.95"></a><span id="l72.95"> </span>
<a href="#l72.96"></a><span id="l72.96" class="difflineminus">-  objectTreeAsString: function(o, recurse, compress, level) {</span>
<a href="#l72.97"></a><span id="l72.97" class="difflineplus">+  objectTreeAsString(o, recurse, compress, level) {</span>
<a href="#l72.98"></a><span id="l72.98">     let s = &quot;&quot;;</span>
<a href="#l72.99"></a><span id="l72.99">     if (recurse === undefined)</span>
<a href="#l72.100"></a><span id="l72.100">       recurse = 0;</span>
<a href="#l72.101"></a><span id="l72.101">     if (level === undefined)</span>
<a href="#l72.102"></a><span id="l72.102">       level = 0;</span>
<a href="#l72.103"></a><span id="l72.103">     if (compress === undefined)</span>
<a href="#l72.104"></a><span id="l72.104">       compress = true;</span>
<a href="#l72.105"></a><span id="l72.105">     let pfx = &quot;&quot;;</span>
<a href="#l72.106"></a><span id="l72.106"> </span>
<a href="#l72.107"></a><span id="l72.107">     for (var junk = 0; junk &lt; level; junk++)</span>
<a href="#l72.108"></a><span id="l72.108">       pfx += (compress) ? &quot;| &quot; : &quot;|  &quot;;</span>
<a href="#l72.109"></a><span id="l72.109"> </span>
<a href="#l72.110"></a><span id="l72.110">     let tee = (compress) ? &quot;+ &quot; : &quot;+- &quot;;</span>
<a href="#l72.111"></a><span id="l72.111"> </span>
<a href="#l72.112"></a><span id="l72.112">     if (typeof(o) != &quot;object&quot;) {</span>
<a href="#l72.113"></a><span id="l72.113">       s += pfx + tee + &quot; (&quot; + typeof(o) + &quot;) &quot; + o + &quot;\n&quot;;</span>
<a href="#l72.114"></a><span id="l72.114" class="difflineminus">-    }</span>
<a href="#l72.115"></a><span id="l72.115" class="difflineminus">-    else {</span>
<a href="#l72.116"></a><span id="l72.116" class="difflineplus">+    } else {</span>
<a href="#l72.117"></a><span id="l72.117">       for (let i in o) {</span>
<a href="#l72.118"></a><span id="l72.118">         try {</span>
<a href="#l72.119"></a><span id="l72.119">           let t = typeof o[i];</span>
<a href="#l72.120"></a><span id="l72.120">           switch (t) {</span>
<a href="#l72.121"></a><span id="l72.121">             case &quot;function&quot;:</span>
<a href="#l72.122"></a><span id="l72.122">               let sfunc = String(o[i]).split(&quot;\n&quot;);</span>
<a href="#l72.123"></a><span id="l72.123">               if (sfunc[2] == &quot;    [native code]&quot;)</span>
<a href="#l72.124"></a><span id="l72.124">                 sfunc = &quot;[native code]&quot;;</span>
<a href="#l72.125"></a><span id="l72.125" class="difflineat">@@ -198,56 +196,53 @@ Stringifier.prototype = {</span>
<a href="#l72.126"></a><span id="l72.126">         if (!compress)</span>
<a href="#l72.127"></a><span id="l72.127">           s += pfx + &quot;|\n&quot;;</span>
<a href="#l72.128"></a><span id="l72.128">       }</span>
<a href="#l72.129"></a><span id="l72.129">     }</span>
<a href="#l72.130"></a><span id="l72.130">     s += pfx + &quot;*\n&quot;;</span>
<a href="#l72.131"></a><span id="l72.131">     return s;</span>
<a href="#l72.132"></a><span id="l72.132">   },</span>
<a href="#l72.133"></a><span id="l72.133"> </span>
<a href="#l72.134"></a><span id="l72.134" class="difflineminus">-  _repeatStr: function (str, aCount) {</span>
<a href="#l72.135"></a><span id="l72.135" class="difflineplus">+  _repeatStr(str, aCount) {</span>
<a href="#l72.136"></a><span id="l72.136">     let res = &quot;&quot;;</span>
<a href="#l72.137"></a><span id="l72.137">     while (--aCount &gt;= 0)</span>
<a href="#l72.138"></a><span id="l72.138">       res += str;</span>
<a href="#l72.139"></a><span id="l72.139">     return res;</span>
<a href="#l72.140"></a><span id="l72.140">   },</span>
<a href="#l72.141"></a><span id="l72.141"> </span>
<a href="#l72.142"></a><span id="l72.142" class="difflineminus">-  DOMNodeAsString: function(node, level, recursive) {</span>
<a href="#l72.143"></a><span id="l72.143" class="difflineplus">+  DOMNodeAsString(node, level, recursive) {</span>
<a href="#l72.144"></a><span id="l72.144">     if (level === undefined)</span>
<a href="#l72.145"></a><span id="l72.145" class="difflineminus">-      level = 0</span>
<a href="#l72.146"></a><span id="l72.146" class="difflineplus">+      level = 0;</span>
<a href="#l72.147"></a><span id="l72.147">     if (recursive === undefined)</span>
<a href="#l72.148"></a><span id="l72.148">       recursive = true;</span>
<a href="#l72.149"></a><span id="l72.149" class="difflineminus">-    this._append(this._repeatStr(&quot; &quot;, 2*level) + &quot;&lt;&quot; + node.nodeName + &quot;\n&quot;);</span>
<a href="#l72.150"></a><span id="l72.150" class="difflineplus">+    this._append(this._repeatStr(&quot; &quot;, 2 * level) + &quot;&lt;&quot; + node.nodeName + &quot;\n&quot;);</span>
<a href="#l72.151"></a><span id="l72.151"> </span>
<a href="#l72.152"></a><span id="l72.152">     if (node.nodeType == 3) {</span>
<a href="#l72.153"></a><span id="l72.153" class="difflineminus">-        this._append(this._repeatStr(&quot; &quot;, (2*level) + 4) + node.nodeValue + &quot;'\n&quot;);</span>
<a href="#l72.154"></a><span id="l72.154" class="difflineminus">-    }</span>
<a href="#l72.155"></a><span id="l72.155" class="difflineminus">-    else {</span>
<a href="#l72.156"></a><span id="l72.156" class="difflineplus">+      this._append(this._repeatStr(&quot; &quot;, (2 * level) + 4) + node.nodeValue + &quot;'\n&quot;);</span>
<a href="#l72.157"></a><span id="l72.157" class="difflineplus">+    } else {</span>
<a href="#l72.158"></a><span id="l72.158">       if (node.attributes) {</span>
<a href="#l72.159"></a><span id="l72.159">         for (let i = 0; i &lt; node.attributes.length; i++) {</span>
<a href="#l72.160"></a><span id="l72.160" class="difflineminus">-          this._append(this._repeatStr(</span>
<a href="#l72.161"></a><span id="l72.161" class="difflineminus">-                         &quot; &quot;, (2*level) + 4) + node.attributes[i].nodeName +</span>
<a href="#l72.162"></a><span id="l72.162" class="difflineminus">-                         &quot;='&quot; + node.attributes[i].nodeValue + &quot;'\n&quot;);</span>
<a href="#l72.163"></a><span id="l72.163" class="difflineplus">+          this._append(this._repeatStr(&quot; &quot;, (2 * level) + 4) +</span>
<a href="#l72.164"></a><span id="l72.164" class="difflineplus">+                       node.attributes[i].nodeName + &quot;='&quot; + node.attributes[i].nodeValue + &quot;'\n&quot;);</span>
<a href="#l72.165"></a><span id="l72.165">         }</span>
<a href="#l72.166"></a><span id="l72.166">       }</span>
<a href="#l72.167"></a><span id="l72.167">       if (node.childNodes.length == 0) {</span>
<a href="#l72.168"></a><span id="l72.168" class="difflineminus">-        this._append(this._repeatStr(&quot; &quot;, (2*level)) + &quot;/&gt;\n&quot;);</span>
<a href="#l72.169"></a><span id="l72.169" class="difflineminus">-      }</span>
<a href="#l72.170"></a><span id="l72.170" class="difflineminus">-      else if (recursive) {</span>
<a href="#l72.171"></a><span id="l72.171" class="difflineminus">-        this._append(this._repeatStr(&quot; &quot;, (2*level)) + &quot;&gt;\n&quot;);</span>
<a href="#l72.172"></a><span id="l72.172" class="difflineplus">+        this._append(this._repeatStr(&quot; &quot;, (2 * level)) + &quot;/&gt;\n&quot;);</span>
<a href="#l72.173"></a><span id="l72.173" class="difflineplus">+      } else if (recursive) {</span>
<a href="#l72.174"></a><span id="l72.174" class="difflineplus">+        this._append(this._repeatStr(&quot; &quot;, (2 * level)) + &quot;&gt;\n&quot;);</span>
<a href="#l72.175"></a><span id="l72.175">         for (let i = 0; i &lt; node.childNodes.length; i++) {</span>
<a href="#l72.176"></a><span id="l72.176">           this._append(this.DOMNodeAsString(node.childNodes[i], level + 1));</span>
<a href="#l72.177"></a><span id="l72.177">         }</span>
<a href="#l72.178"></a><span id="l72.178" class="difflineminus">-        this._append(this._repeatStr(&quot; &quot;, 2*level) + &quot;&lt;/&quot; + node.nodeName + &quot;&gt;\n&quot;);</span>
<a href="#l72.179"></a><span id="l72.179" class="difflineplus">+        this._append(this._repeatStr(&quot; &quot;, 2 * level) + &quot;&lt;/&quot; + node.nodeName + &quot;&gt;\n&quot;);</span>
<a href="#l72.180"></a><span id="l72.180">       }</span>
<a href="#l72.181"></a><span id="l72.181">     }</span>
<a href="#l72.182"></a><span id="l72.182">     return this._asString();</span>
<a href="#l72.183"></a><span id="l72.183">   },</span>
<a href="#l72.184"></a><span id="l72.184"> </span>
<a href="#l72.185"></a><span id="l72.185" class="difflineminus">-  eventAsString: function (event) {</span>
<a href="#l72.186"></a><span id="l72.186" class="difflineplus">+  eventAsString(event) {</span>
<a href="#l72.187"></a><span id="l72.187">     this._reset();</span>
<a href="#l72.188"></a><span id="l72.188">     this._append(&quot;-EVENT --------------------------\n&quot;);</span>
<a href="#l72.189"></a><span id="l72.189">     this._append(&quot;type:           &quot; + event.type + &quot;\n&quot;);</span>
<a href="#l72.190"></a><span id="l72.190">     this._append(&quot;eventPhase:     &quot; + event.eventPhase + &quot;\n&quot;);</span>
<a href="#l72.191"></a><span id="l72.191">     if (&quot;charCode&quot; in event) {</span>
<a href="#l72.192"></a><span id="l72.192">       this._append(&quot;charCode: &quot; + event.charCode + &quot;\n&quot;);</span>
<a href="#l72.193"></a><span id="l72.193">       if (&quot;name&quot; in event)</span>
<a href="#l72.194"></a><span id="l72.194">         this._append(&quot;str(charCode):  '&quot; + String.fromCharCode(event.charCode) + &quot;'\n&quot;);</span>
<a href="#l72.195"></a><span id="l72.195" class="difflineat">@@ -257,52 +252,52 @@ Stringifier.prototype = {</span>
<a href="#l72.196"></a><span id="l72.196">       if (&quot;nodeName&quot; in event.target)</span>
<a href="#l72.197"></a><span id="l72.197">         this._append(&quot;target.nodeName: &quot; + event.target.nodeName + &quot;\n&quot;);</span>
<a href="#l72.198"></a><span id="l72.198">       if (&quot;getAttribute&quot; in event.target)</span>
<a href="#l72.199"></a><span id="l72.199">         this._append(&quot;target.id: &quot; + event.target.getAttribute(&quot;id&quot;) + &quot;\n&quot;);</span>
<a href="#l72.200"></a><span id="l72.200">     }</span>
<a href="#l72.201"></a><span id="l72.201">     if ((&quot;currentTarget&quot; in event) &amp;&amp; event.currentTarget) {</span>
<a href="#l72.202"></a><span id="l72.202">       this._append(&quot;currentTarget: &quot; + event.currentTarget + &quot;\n&quot;);</span>
<a href="#l72.203"></a><span id="l72.203">       if (&quot;nodeName&quot; in event.currentTarget)</span>
<a href="#l72.204"></a><span id="l72.204" class="difflineminus">-        this._append(&quot;currentTarget.nodeName: &quot;+ event.currentTarget.nodeName + &quot;\n&quot;);</span>
<a href="#l72.205"></a><span id="l72.205" class="difflineplus">+        this._append(&quot;currentTarget.nodeName: &quot; + event.currentTarget.nodeName + &quot;\n&quot;);</span>
<a href="#l72.206"></a><span id="l72.206">       if (&quot;getAttribute&quot; in event.currentTarget)</span>
<a href="#l72.207"></a><span id="l72.207" class="difflineminus">-        this._append(&quot;currentTarget.id: &quot;+ event.currentTarget.getAttribute(&quot;id&quot;) + &quot;\n&quot;);</span>
<a href="#l72.208"></a><span id="l72.208" class="difflineplus">+        this._append(&quot;currentTarget.id: &quot; + event.currentTarget.getAttribute(&quot;id&quot;) + &quot;\n&quot;);</span>
<a href="#l72.209"></a><span id="l72.209">     }</span>
<a href="#l72.210"></a><span id="l72.210">     if ((&quot;originalTarget&quot; in event) &amp;&amp; event.originalTarget) {</span>
<a href="#l72.211"></a><span id="l72.211">       this._append(&quot;originalTarget: &quot; + event.originalTarget + &quot;\n&quot;);</span>
<a href="#l72.212"></a><span id="l72.212">       if (&quot;nodeName&quot; in event.originalTarget)</span>
<a href="#l72.213"></a><span id="l72.213" class="difflineminus">-        this._append(&quot;originalTarget.nodeName: &quot;+ event.originalTarget.nodeName + &quot;\n&quot;);</span>
<a href="#l72.214"></a><span id="l72.214" class="difflineplus">+        this._append(&quot;originalTarget.nodeName: &quot; + event.originalTarget.nodeName + &quot;\n&quot;);</span>
<a href="#l72.215"></a><span id="l72.215">       if (&quot;getAttribute&quot; in event.originalTarget)</span>
<a href="#l72.216"></a><span id="l72.216" class="difflineminus">-        this._append(&quot;originalTarget.id: &quot;+ event.originalTarget.getAttribute(&quot;id&quot;) + &quot;\n&quot;);</span>
<a href="#l72.217"></a><span id="l72.217" class="difflineplus">+        this._append(&quot;originalTarget.id: &quot; + event.originalTarget.getAttribute(&quot;id&quot;) + &quot;\n&quot;);</span>
<a href="#l72.218"></a><span id="l72.218">     }</span>
<a href="#l72.219"></a><span id="l72.219">     let names = [</span>
<a href="#l72.220"></a><span id="l72.220" class="difflineminus">-        &quot;bubbles&quot;,</span>
<a href="#l72.221"></a><span id="l72.221" class="difflineminus">-        &quot;cancelable&quot;,</span>
<a href="#l72.222"></a><span id="l72.222" class="difflineminus">-        &quot;detail&quot;,</span>
<a href="#l72.223"></a><span id="l72.223" class="difflineminus">-        &quot;button&quot;,</span>
<a href="#l72.224"></a><span id="l72.224" class="difflineminus">-        &quot;keyCode&quot;,</span>
<a href="#l72.225"></a><span id="l72.225" class="difflineminus">-        &quot;isChar&quot;,</span>
<a href="#l72.226"></a><span id="l72.226" class="difflineminus">-        &quot;shiftKey&quot;,</span>
<a href="#l72.227"></a><span id="l72.227" class="difflineminus">-        &quot;altKey&quot;,</span>
<a href="#l72.228"></a><span id="l72.228" class="difflineminus">-        &quot;ctrlKey&quot;,</span>
<a href="#l72.229"></a><span id="l72.229" class="difflineminus">-        &quot;metaKey&quot;,</span>
<a href="#l72.230"></a><span id="l72.230" class="difflineminus">-        &quot;clientX&quot;,</span>
<a href="#l72.231"></a><span id="l72.231" class="difflineminus">-        &quot;clientY&quot;,</span>
<a href="#l72.232"></a><span id="l72.232" class="difflineminus">-        &quot;screenX&quot;,</span>
<a href="#l72.233"></a><span id="l72.233" class="difflineminus">-        &quot;screenY&quot;,</span>
<a href="#l72.234"></a><span id="l72.234" class="difflineminus">-        &quot;layerX&quot;,</span>
<a href="#l72.235"></a><span id="l72.235" class="difflineminus">-        &quot;layerY&quot;,</span>
<a href="#l72.236"></a><span id="l72.236" class="difflineminus">-        &quot;isTrusted&quot;,</span>
<a href="#l72.237"></a><span id="l72.237" class="difflineminus">-        &quot;timeStamp&quot;,</span>
<a href="#l72.238"></a><span id="l72.238" class="difflineminus">-        &quot;currentTargetXPath&quot;,</span>
<a href="#l72.239"></a><span id="l72.239" class="difflineminus">-        &quot;targetXPath&quot;,</span>
<a href="#l72.240"></a><span id="l72.240" class="difflineminus">-        &quot;originalTargetXPath&quot;</span>
<a href="#l72.241"></a><span id="l72.241" class="difflineminus">-                ];</span>
<a href="#l72.242"></a><span id="l72.242" class="difflineminus">-    for (let i in names) {</span>
<a href="#l72.243"></a><span id="l72.243" class="difflineminus">-      if (names[i] in event)</span>
<a href="#l72.244"></a><span id="l72.244" class="difflineminus">-        this._append(names[i] + &quot;: &quot; + event[names[i]] + &quot;\n&quot;);</span>
<a href="#l72.245"></a><span id="l72.245" class="difflineplus">+      &quot;bubbles&quot;,</span>
<a href="#l72.246"></a><span id="l72.246" class="difflineplus">+      &quot;cancelable&quot;,</span>
<a href="#l72.247"></a><span id="l72.247" class="difflineplus">+      &quot;detail&quot;,</span>
<a href="#l72.248"></a><span id="l72.248" class="difflineplus">+      &quot;button&quot;,</span>
<a href="#l72.249"></a><span id="l72.249" class="difflineplus">+      &quot;keyCode&quot;,</span>
<a href="#l72.250"></a><span id="l72.250" class="difflineplus">+      &quot;isChar&quot;,</span>
<a href="#l72.251"></a><span id="l72.251" class="difflineplus">+      &quot;shiftKey&quot;,</span>
<a href="#l72.252"></a><span id="l72.252" class="difflineplus">+      &quot;altKey&quot;,</span>
<a href="#l72.253"></a><span id="l72.253" class="difflineplus">+      &quot;ctrlKey&quot;,</span>
<a href="#l72.254"></a><span id="l72.254" class="difflineplus">+      &quot;metaKey&quot;,</span>
<a href="#l72.255"></a><span id="l72.255" class="difflineplus">+      &quot;clientX&quot;,</span>
<a href="#l72.256"></a><span id="l72.256" class="difflineplus">+      &quot;clientY&quot;,</span>
<a href="#l72.257"></a><span id="l72.257" class="difflineplus">+      &quot;screenX&quot;,</span>
<a href="#l72.258"></a><span id="l72.258" class="difflineplus">+      &quot;screenY&quot;,</span>
<a href="#l72.259"></a><span id="l72.259" class="difflineplus">+      &quot;layerX&quot;,</span>
<a href="#l72.260"></a><span id="l72.260" class="difflineplus">+      &quot;layerY&quot;,</span>
<a href="#l72.261"></a><span id="l72.261" class="difflineplus">+      &quot;isTrusted&quot;,</span>
<a href="#l72.262"></a><span id="l72.262" class="difflineplus">+      &quot;timeStamp&quot;,</span>
<a href="#l72.263"></a><span id="l72.263" class="difflineplus">+      &quot;currentTargetXPath&quot;,</span>
<a href="#l72.264"></a><span id="l72.264" class="difflineplus">+      &quot;targetXPath&quot;,</span>
<a href="#l72.265"></a><span id="l72.265" class="difflineplus">+      &quot;originalTargetXPath&quot;,</span>
<a href="#l72.266"></a><span id="l72.266" class="difflineplus">+    ];</span>
<a href="#l72.267"></a><span id="l72.267" class="difflineplus">+    for (let name of names) {</span>
<a href="#l72.268"></a><span id="l72.268" class="difflineplus">+      if (name in event)</span>
<a href="#l72.269"></a><span id="l72.269" class="difflineplus">+        this._append(name + &quot;: &quot; + event[name] + &quot;\n&quot;);</span>
<a href="#l72.270"></a><span id="l72.270">     }</span>
<a href="#l72.271"></a><span id="l72.271">     this._append(&quot;-------------------------------------\n&quot;);</span>
<a href="#l72.272"></a><span id="l72.272">     return this._asString();</span>
<a href="#l72.273"></a><span id="l72.273" class="difflineminus">-  }</span>
<a href="#l72.274"></a><span id="l72.274" class="difflineplus">+  },</span>
<a href="#l72.275"></a><span id="l72.275"> };</span>
<a href="#l72.276"></a><span id="l72.276"> </span>
<a href="#l72.277"></a><span id="l72.277"> var stringifier = new Stringifier();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1" class="difflineminus">--- a/mailnews/base/util/folderUtils.jsm</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineplus">+++ b/mailnews/base/util/folderUtils.jsm</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineat">@@ -77,26 +77,22 @@ function getFolderProperties(aFolder, aO</span>
<a href="#l73.4"></a><span id="l73.4"> </span>
<a href="#l73.5"></a><span id="l73.5">   // A folder has new messages, or a closed folder or any subfolder has new messages.</span>
<a href="#l73.6"></a><span id="l73.6">   if (aFolder.hasNewMessages ||</span>
<a href="#l73.7"></a><span id="l73.7">       (!aOpen &amp;&amp; aFolder.hasSubFolders &amp;&amp; aFolder.hasFolderOrSubfolderNewMessages))</span>
<a href="#l73.8"></a><span id="l73.8">     properties.push(&quot;newMessages-true&quot;);</span>
<a href="#l73.9"></a><span id="l73.9"> </span>
<a href="#l73.10"></a><span id="l73.10">   if (aFolder.isServer) {</span>
<a href="#l73.11"></a><span id="l73.11">     properties.push(&quot;isServer-true&quot;);</span>
<a href="#l73.12"></a><span id="l73.12" class="difflineminus">-  }</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineminus">-  else</span>
<a href="#l73.14"></a><span id="l73.14" class="difflineminus">-  {</span>
<a href="#l73.15"></a><span id="l73.15" class="difflineplus">+  } else {</span>
<a href="#l73.16"></a><span id="l73.16">     // We only set this if we're not a server</span>
<a href="#l73.17"></a><span id="l73.17">     let shallowUnread = aFolder.getNumUnread(false);</span>
<a href="#l73.18"></a><span id="l73.18">     if (shallowUnread &gt; 0) {</span>
<a href="#l73.19"></a><span id="l73.19">       properties.push(&quot;hasUnreadMessages-true&quot;);</span>
<a href="#l73.20"></a><span id="l73.20" class="difflineminus">-    }</span>
<a href="#l73.21"></a><span id="l73.21" class="difflineminus">-    else</span>
<a href="#l73.22"></a><span id="l73.22" class="difflineminus">-    {</span>
<a href="#l73.23"></a><span id="l73.23" class="difflineplus">+    } else {</span>
<a href="#l73.24"></a><span id="l73.24">       // Make sure that shallowUnread isn't negative</span>
<a href="#l73.25"></a><span id="l73.25">       shallowUnread = 0;</span>
<a href="#l73.26"></a><span id="l73.26">     }</span>
<a href="#l73.27"></a><span id="l73.27">     let deepUnread = aFolder.getNumUnread(true);</span>
<a href="#l73.28"></a><span id="l73.28">     if (deepUnread - shallowUnread &gt; 0)</span>
<a href="#l73.29"></a><span id="l73.29">       properties.push(&quot;subfoldersHaveUnreadMessages-true&quot;);</span>
<a href="#l73.30"></a><span id="l73.30">   }</span>
<a href="#l73.31"></a><span id="l73.31"> </span>
<a href="#l73.32"></a><span id="l73.32" class="difflineat">@@ -140,25 +136,21 @@ function compareAccounts(aAccount1, aAcc</span>
<a href="#l73.33"></a><span id="l73.33"> function allAccountsSorted(aExcludeIMAccounts) {</span>
<a href="#l73.34"></a><span id="l73.34">   // Get the account list, and add the proper items.</span>
<a href="#l73.35"></a><span id="l73.35">   let accountList = toArray(fixIterator(MailServices.accounts.accounts,</span>
<a href="#l73.36"></a><span id="l73.36">                                         Ci.nsIMsgAccount));</span>
<a href="#l73.37"></a><span id="l73.37"> </span>
<a href="#l73.38"></a><span id="l73.38">   // This is a HACK to work around bug 41133. If we have one of the</span>
<a href="#l73.39"></a><span id="l73.39">   // dummy &quot;news&quot; accounts there, that account won't have an</span>
<a href="#l73.40"></a><span id="l73.40">   // incomingServer attached to it, and everything will blow up.</span>
<a href="#l73.41"></a><span id="l73.41" class="difflineminus">-  accountList = accountList.filter(function hasServer(a) {</span>
<a href="#l73.42"></a><span id="l73.42" class="difflineminus">-    return a.incomingServer;</span>
<a href="#l73.43"></a><span id="l73.43" class="difflineminus">-  });</span>
<a href="#l73.44"></a><span id="l73.44" class="difflineplus">+  accountList = accountList.filter((a) =&gt; a.incomingServer);</span>
<a href="#l73.45"></a><span id="l73.45"> </span>
<a href="#l73.46"></a><span id="l73.46">   // Remove IM servers.</span>
<a href="#l73.47"></a><span id="l73.47">   if (aExcludeIMAccounts) {</span>
<a href="#l73.48"></a><span id="l73.48" class="difflineminus">-    accountList = accountList.filter(function(a) {</span>
<a href="#l73.49"></a><span id="l73.49" class="difflineminus">-      return a.incomingServer.type != &quot;im&quot;;</span>
<a href="#l73.50"></a><span id="l73.50" class="difflineminus">-    });</span>
<a href="#l73.51"></a><span id="l73.51" class="difflineplus">+    accountList = accountList.filter((a) =&gt; a.incomingServer.type != &quot;im&quot;);</span>
<a href="#l73.52"></a><span id="l73.52">   }</span>
<a href="#l73.53"></a><span id="l73.53"> </span>
<a href="#l73.54"></a><span id="l73.54">   return accountList.sort(compareAccounts);</span>
<a href="#l73.55"></a><span id="l73.55"> }</span>
<a href="#l73.56"></a><span id="l73.56"> </span>
<a href="#l73.57"></a><span id="l73.57"> /**</span>
<a href="#l73.58"></a><span id="l73.58">  * Returns the most recently used/modified folders from the passed in list.</span>
<a href="#l73.59"></a><span id="l73.59">  *</span>
<a href="#l73.60"></a><span id="l73.60" class="difflineat">@@ -179,34 +171,33 @@ function getMostRecentFolders(aFolderLis</span>
<a href="#l73.61"></a><span id="l73.61">    *</span>
<a href="#l73.62"></a><span id="l73.62">    * @param aFolder  The folder to check for recency.</span>
<a href="#l73.63"></a><span id="l73.63">    */</span>
<a href="#l73.64"></a><span id="l73.64">   let oldestTime = 0;</span>
<a href="#l73.65"></a><span id="l73.65">   function addIfRecent(aFolder) {</span>
<a href="#l73.66"></a><span id="l73.66">     let time = 0;</span>
<a href="#l73.67"></a><span id="l73.67">     try {</span>
<a href="#l73.68"></a><span id="l73.68">       time = Number(aFolder.getStringProperty(aTimeProperty)) || 0;</span>
<a href="#l73.69"></a><span id="l73.69" class="difflineminus">-    } catch(e) {}</span>
<a href="#l73.70"></a><span id="l73.70" class="difflineplus">+    } catch (e) {}</span>
<a href="#l73.71"></a><span id="l73.71">     if (time &lt;= oldestTime)</span>
<a href="#l73.72"></a><span id="l73.72">       return;</span>
<a href="#l73.73"></a><span id="l73.73"> </span>
<a href="#l73.74"></a><span id="l73.74">     if (recentFolders.length == aMaxHits) {</span>
<a href="#l73.75"></a><span id="l73.75" class="difflineminus">-      recentFolders.sort(function sort_folders_by_time(a, b) {</span>
<a href="#l73.76"></a><span id="l73.76" class="difflineminus">-                         return a.time &lt; b.time; });</span>
<a href="#l73.77"></a><span id="l73.77" class="difflineplus">+      recentFolders.sort((a, b) =&gt; a.time &lt; b.time);</span>
<a href="#l73.78"></a><span id="l73.78">       recentFolders.pop();</span>
<a href="#l73.79"></a><span id="l73.79">       oldestTime = recentFolders[recentFolders.length - 1].time;</span>
<a href="#l73.80"></a><span id="l73.80">     }</span>
<a href="#l73.81"></a><span id="l73.81" class="difflineminus">-    recentFolders.push({ folder: aFolder, time: time });</span>
<a href="#l73.82"></a><span id="l73.82" class="difflineplus">+    recentFolders.push({ folder: aFolder, time });</span>
<a href="#l73.83"></a><span id="l73.83">   }</span>
<a href="#l73.84"></a><span id="l73.84"> </span>
<a href="#l73.85"></a><span id="l73.85">   for (let folder of aFolderList) {</span>
<a href="#l73.86"></a><span id="l73.86">     addIfRecent(folder);</span>
<a href="#l73.87"></a><span id="l73.87">   }</span>
<a href="#l73.88"></a><span id="l73.88"> </span>
<a href="#l73.89"></a><span id="l73.89" class="difflineminus">-  return recentFolders.map(function (f) { return f.folder; });</span>
<a href="#l73.90"></a><span id="l73.90" class="difflineplus">+  return recentFolders.map((f) =&gt; f.folder);</span>
<a href="#l73.91"></a><span id="l73.91"> }</span>
<a href="#l73.92"></a><span id="l73.92"> </span>
<a href="#l73.93"></a><span id="l73.93"> /**</span>
<a href="#l73.94"></a><span id="l73.94">  * A locale dependent comparison function to produce a case-insensitive sort order</span>
<a href="#l73.95"></a><span id="l73.95">  * used to sort folder names.</span>
<a href="#l73.96"></a><span id="l73.96">  * Returns positive number if aString1 &gt; aString2, negative number if aString1 &gt; aString2,</span>
<a href="#l73.97"></a><span id="l73.97">  *         otherwise 0.</span>
<a href="#l73.98"></a><span id="l73.98">  *</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1" class="difflineminus">--- a/mailnews/base/util/hostnameUtils.jsm</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineplus">+++ b/mailnews/base/util/hostnameUtils.jsm</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineat">@@ -23,18 +23,17 @@ var kMaxPort = 65535;</span>
<a href="#l74.4"></a><span id="l74.4"> /**</span>
<a href="#l74.5"></a><span id="l74.5">  * Check if aHostName is an IP address or a valid hostname.</span>
<a href="#l74.6"></a><span id="l74.6">  *</span>
<a href="#l74.7"></a><span id="l74.7">  * @param aHostName                The string to check for validity.</span>
<a href="#l74.8"></a><span id="l74.8">  * @param aAllowExtendedIPFormats  Allow hex/octal formats in addition to decimal.</span>
<a href="#l74.9"></a><span id="l74.9">  * @return  Unobscured host name if aHostName is valid.</span>
<a href="#l74.10"></a><span id="l74.10">  *          Returns null if it's not.</span>
<a href="#l74.11"></a><span id="l74.11">  */</span>
<a href="#l74.12"></a><span id="l74.12" class="difflineminus">-function isLegalHostNameOrIP(aHostName, aAllowExtendedIPFormats)</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineminus">-{</span>
<a href="#l74.14"></a><span id="l74.14" class="difflineplus">+function isLegalHostNameOrIP(aHostName, aAllowExtendedIPFormats) {</span>
<a href="#l74.15"></a><span id="l74.15">   /*</span>
<a href="#l74.16"></a><span id="l74.16">    RFC 1123:</span>
<a href="#l74.17"></a><span id="l74.17">    Whenever a user inputs the identity of an Internet host, it SHOULD</span>
<a href="#l74.18"></a><span id="l74.18">    be possible to enter either (1) a host domain name or (2) an IP</span>
<a href="#l74.19"></a><span id="l74.19">    address in dotted-decimal (&quot;#.#.#.#&quot;) form.  The host SHOULD check</span>
<a href="#l74.20"></a><span id="l74.20">    the string syntactically for a dotted-decimal number before</span>
<a href="#l74.21"></a><span id="l74.21">    looking it up in the Domain Name System.</span>
<a href="#l74.22"></a><span id="l74.22">   */</span>
<a href="#l74.23"></a><span id="l74.23" class="difflineat">@@ -44,18 +43,17 @@ function isLegalHostNameOrIP(aHostName, </span>
<a href="#l74.24"></a><span id="l74.24"> }</span>
<a href="#l74.25"></a><span id="l74.25"> </span>
<a href="#l74.26"></a><span id="l74.26"> /**</span>
<a href="#l74.27"></a><span id="l74.27">  * Check if aHostName is a valid hostname.</span>
<a href="#l74.28"></a><span id="l74.28">  *</span>
<a href="#l74.29"></a><span id="l74.29">  * @return  The host name if it is valid.</span>
<a href="#l74.30"></a><span id="l74.30">  *          Returns null if it's not.</span>
<a href="#l74.31"></a><span id="l74.31">  */</span>
<a href="#l74.32"></a><span id="l74.32" class="difflineminus">-function isLegalHostName(aHostName)</span>
<a href="#l74.33"></a><span id="l74.33" class="difflineminus">-{</span>
<a href="#l74.34"></a><span id="l74.34" class="difflineplus">+function isLegalHostName(aHostName) {</span>
<a href="#l74.35"></a><span id="l74.35">   /*</span>
<a href="#l74.36"></a><span id="l74.36">    RFC 952:</span>
<a href="#l74.37"></a><span id="l74.37">    A &quot;name&quot; (Net, Host, Gateway, or Domain name) is a text string up</span>
<a href="#l74.38"></a><span id="l74.38">    to 24 characters drawn from the alphabet (A-Z), digits (0-9), minus</span>
<a href="#l74.39"></a><span id="l74.39">    sign (-), and period (.).  Note that periods are only allowed when</span>
<a href="#l74.40"></a><span id="l74.40">    they serve to delimit components of &quot;domain style names&quot;. (See</span>
<a href="#l74.41"></a><span id="l74.41">    RFC-921, &quot;Domain Name System Implementation Schedule&quot;, for</span>
<a href="#l74.42"></a><span id="l74.42">    background).  No blank or space characters are permitted as part of a</span>
<a href="#l74.43"></a><span id="l74.43" class="difflineat">@@ -96,18 +94,17 @@ function isLegalHostName(aHostName)</span>
<a href="#l74.44"></a><span id="l74.44">  *</span>
<a href="#l74.45"></a><span id="l74.45">  * @param aHostName                The string to check for validity.</span>
<a href="#l74.46"></a><span id="l74.46">  * @param aAllowExtendedIPFormats  If false, only IPv4 addresses in the common</span>
<a href="#l74.47"></a><span id="l74.47">                                    decimal format (4 components, each up to 255)</span>
<a href="#l74.48"></a><span id="l74.48">  *                                 will be accepted, no hex/octal formats.</span>
<a href="#l74.49"></a><span id="l74.49">  * @return  Unobscured canonicalized address if aHostName is an IPv4 address.</span>
<a href="#l74.50"></a><span id="l74.50">  *          Returns null if it's not.</span>
<a href="#l74.51"></a><span id="l74.51">  */</span>
<a href="#l74.52"></a><span id="l74.52" class="difflineminus">-function isLegalIPv4Address(aHostName, aAllowExtendedIPFormats)</span>
<a href="#l74.53"></a><span id="l74.53" class="difflineminus">-{</span>
<a href="#l74.54"></a><span id="l74.54" class="difflineplus">+function isLegalIPv4Address(aHostName, aAllowExtendedIPFormats) {</span>
<a href="#l74.55"></a><span id="l74.55">   // Scammers frequently obscure the IP address by encoding each component as</span>
<a href="#l74.56"></a><span id="l74.56">   // decimal, octal, hex or in some cases a mix match of each. There can even</span>
<a href="#l74.57"></a><span id="l74.57">   // be less than 4 components where the last number covers the missing components.</span>
<a href="#l74.58"></a><span id="l74.58">   // See the test at mailnews/base/test/unit/test_hostnameUtils.js for possible</span>
<a href="#l74.59"></a><span id="l74.59">   // combinations.</span>
<a href="#l74.60"></a><span id="l74.60"> </span>
<a href="#l74.61"></a><span id="l74.61">   if (!aHostName)</span>
<a href="#l74.62"></a><span id="l74.62">     return null;</span>
<a href="#l74.63"></a><span id="l74.63" class="difflineat">@@ -175,83 +172,76 @@ function isLegalIPv4Address(aHostName, a</span>
<a href="#l74.64"></a><span id="l74.64"> </span>
<a href="#l74.65"></a><span id="l74.65"> /**</span>
<a href="#l74.66"></a><span id="l74.66">  * Check if aHostName is a valid IPv6 address.</span>
<a href="#l74.67"></a><span id="l74.67">  *</span>
<a href="#l74.68"></a><span id="l74.68">  * @param aHostName  The string to check for validity.</span>
<a href="#l74.69"></a><span id="l74.69">  * @return  Unobscured canonicalized address if aHostName is an IPv6 address.</span>
<a href="#l74.70"></a><span id="l74.70">  *          Returns null if it's not.</span>
<a href="#l74.71"></a><span id="l74.71">  */</span>
<a href="#l74.72"></a><span id="l74.72" class="difflineminus">-function isLegalIPv6Address(aHostName)</span>
<a href="#l74.73"></a><span id="l74.73" class="difflineminus">-{</span>
<a href="#l74.74"></a><span id="l74.74" class="difflineplus">+function isLegalIPv6Address(aHostName) {</span>
<a href="#l74.75"></a><span id="l74.75">   if (!aHostName)</span>
<a href="#l74.76"></a><span id="l74.76">     return null;</span>
<a href="#l74.77"></a><span id="l74.77"> </span>
<a href="#l74.78"></a><span id="l74.78">   // Break the IP address down into individual components.</span>
<a href="#l74.79"></a><span id="l74.79">   let ipComponents = aHostName.toLowerCase().split(&quot;:&quot;);</span>
<a href="#l74.80"></a><span id="l74.80"> </span>
<a href="#l74.81"></a><span id="l74.81">   // Make sure there are at least 3 components.</span>
<a href="#l74.82"></a><span id="l74.82">   if (ipComponents.length &lt; 3)</span>
<a href="#l74.83"></a><span id="l74.83">     return null;</span>
<a href="#l74.84"></a><span id="l74.84"> </span>
<a href="#l74.85"></a><span id="l74.85">   let ipLength = ipComponents.length - 1;</span>
<a href="#l74.86"></a><span id="l74.86"> </span>
<a href="#l74.87"></a><span id="l74.87">   // Take care if the last part is written in decimal using dots as separators.</span>
<a href="#l74.88"></a><span id="l74.88">   let lastPart = isLegalIPv4Address(ipComponents[ipLength], false);</span>
<a href="#l74.89"></a><span id="l74.89" class="difflineminus">-  if (lastPart)</span>
<a href="#l74.90"></a><span id="l74.90" class="difflineminus">-  {</span>
<a href="#l74.91"></a><span id="l74.91" class="difflineplus">+  if (lastPart) {</span>
<a href="#l74.92"></a><span id="l74.92">     let lastPartComponents = lastPart.split(&quot;.&quot;);</span>
<a href="#l74.93"></a><span id="l74.93">     // Convert it into standard IPv6 components.</span>
<a href="#l74.94"></a><span id="l74.94">     ipComponents[ipLength] =</span>
<a href="#l74.95"></a><span id="l74.95">       ((lastPartComponents[0] &lt;&lt; 8) | lastPartComponents[1]).toString(16);</span>
<a href="#l74.96"></a><span id="l74.96">     ipComponents[ipLength + 1] =</span>
<a href="#l74.97"></a><span id="l74.97">       ((lastPartComponents[2] &lt;&lt; 8) | lastPartComponents[3]).toString(16);</span>
<a href="#l74.98"></a><span id="l74.98">   }</span>
<a href="#l74.99"></a><span id="l74.99"> </span>
<a href="#l74.100"></a><span id="l74.100">   // Make sure that there is only one empty component.</span>
<a href="#l74.101"></a><span id="l74.101">   let emptyIndex;</span>
<a href="#l74.102"></a><span id="l74.102" class="difflineminus">-  for (let i = 1; i &lt; ipComponents.length - 1; i++)</span>
<a href="#l74.103"></a><span id="l74.103" class="difflineminus">-  {</span>
<a href="#l74.104"></a><span id="l74.104" class="difflineminus">-    if (ipComponents[i] == &quot;&quot;)</span>
<a href="#l74.105"></a><span id="l74.105" class="difflineminus">-    {</span>
<a href="#l74.106"></a><span id="l74.106" class="difflineplus">+  for (let i = 1; i &lt; ipComponents.length - 1; i++) {</span>
<a href="#l74.107"></a><span id="l74.107" class="difflineplus">+    if (ipComponents[i] == &quot;&quot;) {</span>
<a href="#l74.108"></a><span id="l74.108">       // If we already found an empty component return null.</span>
<a href="#l74.109"></a><span id="l74.109">       if (emptyIndex)</span>
<a href="#l74.110"></a><span id="l74.110">         return null;</span>
<a href="#l74.111"></a><span id="l74.111"> </span>
<a href="#l74.112"></a><span id="l74.112">       emptyIndex = i;</span>
<a href="#l74.113"></a><span id="l74.113">     }</span>
<a href="#l74.114"></a><span id="l74.114">   }</span>
<a href="#l74.115"></a><span id="l74.115"> </span>
<a href="#l74.116"></a><span id="l74.116">   // If we found an empty component, extend it.</span>
<a href="#l74.117"></a><span id="l74.117" class="difflineminus">-  if (emptyIndex)</span>
<a href="#l74.118"></a><span id="l74.118" class="difflineminus">-  {</span>
<a href="#l74.119"></a><span id="l74.119" class="difflineplus">+  if (emptyIndex) {</span>
<a href="#l74.120"></a><span id="l74.120">     ipComponents[emptyIndex] = 0;</span>
<a href="#l74.121"></a><span id="l74.121"> </span>
<a href="#l74.122"></a><span id="l74.122">     // Add components so we have a total of 8.</span>
<a href="#l74.123"></a><span id="l74.123">     for (let count = ipComponents.length; count &lt; 8; count++)</span>
<a href="#l74.124"></a><span id="l74.124">       ipComponents.splice(emptyIndex, 0, 0);</span>
<a href="#l74.125"></a><span id="l74.125">   }</span>
<a href="#l74.126"></a><span id="l74.126"> </span>
<a href="#l74.127"></a><span id="l74.127">   // Make sure there are 8 components.</span>
<a href="#l74.128"></a><span id="l74.128">   if (ipComponents.length != 8)</span>
<a href="#l74.129"></a><span id="l74.129">     return null;</span>
<a href="#l74.130"></a><span id="l74.130"> </span>
<a href="#l74.131"></a><span id="l74.131">   // Format all components to 4 character hex value.</span>
<a href="#l74.132"></a><span id="l74.132" class="difflineminus">-  for (let i = 0; i &lt; ipComponents.length; i++)</span>
<a href="#l74.133"></a><span id="l74.133" class="difflineminus">-  {</span>
<a href="#l74.134"></a><span id="l74.134" class="difflineplus">+  for (let i = 0; i &lt; ipComponents.length; i++) {</span>
<a href="#l74.135"></a><span id="l74.135">     if (ipComponents[i] == &quot;&quot;)</span>
<a href="#l74.136"></a><span id="l74.136">       ipComponents[i] = 0;</span>
<a href="#l74.137"></a><span id="l74.137"> </span>
<a href="#l74.138"></a><span id="l74.138">     // Make sure the component is a number and it isn't larger than 0xffff.</span>
<a href="#l74.139"></a><span id="l74.139">     if (/^[0-9a-f]{1,4}$/.test(ipComponents[i])) {</span>
<a href="#l74.140"></a><span id="l74.140">       ipComponents[i] = parseInt(ipComponents[i], 16);</span>
<a href="#l74.141"></a><span id="l74.141">       if (isNaN(ipComponents[i]) || ipComponents[i] &gt; 0xffff)</span>
<a href="#l74.142"></a><span id="l74.142">         return null;</span>
<a href="#l74.143"></a><span id="l74.143" class="difflineminus">-    }</span>
<a href="#l74.144"></a><span id="l74.144" class="difflineminus">-    else {</span>
<a href="#l74.145"></a><span id="l74.145" class="difflineplus">+    } else {</span>
<a href="#l74.146"></a><span id="l74.146">       return null;</span>
<a href="#l74.147"></a><span id="l74.147">     }</span>
<a href="#l74.148"></a><span id="l74.148"> </span>
<a href="#l74.149"></a><span id="l74.149">     // Pad the component with 0:s.</span>
<a href="#l74.150"></a><span id="l74.150">     ipComponents[i] = (&quot;0000&quot; + ipComponents[i].toString(16)).substr(-4);</span>
<a href="#l74.151"></a><span id="l74.151">   }</span>
<a href="#l74.152"></a><span id="l74.152"> </span>
<a href="#l74.153"></a><span id="l74.153">   // TODO: support Zone indices in Link-local addresses? Currently they are rejected.</span>
<a href="#l74.154"></a><span id="l74.154" class="difflineat">@@ -266,50 +256,46 @@ function isLegalIPv6Address(aHostName)</span>
<a href="#l74.155"></a><span id="l74.155"> /**</span>
<a href="#l74.156"></a><span id="l74.156">  * Check if aHostName is a valid IP address (IPv4 or IPv6).</span>
<a href="#l74.157"></a><span id="l74.157">  *</span>
<a href="#l74.158"></a><span id="l74.158">  * @param aHostName                The string to check for validity.</span>
<a href="#l74.159"></a><span id="l74.159">  * @param aAllowExtendedIPFormats  Allow hex/octal formats in addition to decimal.</span>
<a href="#l74.160"></a><span id="l74.160">  * @return  Unobscured canonicalized IPv4 or IPv6 address if it is valid,</span>
<a href="#l74.161"></a><span id="l74.161">  *          otherwise null.</span>
<a href="#l74.162"></a><span id="l74.162">  */</span>
<a href="#l74.163"></a><span id="l74.163" class="difflineminus">-function isLegalIPAddress(aHostName, aAllowExtendedIPFormats)</span>
<a href="#l74.164"></a><span id="l74.164" class="difflineminus">-{</span>
<a href="#l74.165"></a><span id="l74.165" class="difflineplus">+function isLegalIPAddress(aHostName, aAllowExtendedIPFormats) {</span>
<a href="#l74.166"></a><span id="l74.166">   return isLegalIPv4Address(aHostName, aAllowExtendedIPFormats) ||</span>
<a href="#l74.167"></a><span id="l74.167">          isLegalIPv6Address(aHostName);</span>
<a href="#l74.168"></a><span id="l74.168"> }</span>
<a href="#l74.169"></a><span id="l74.169"> </span>
<a href="#l74.170"></a><span id="l74.170"> /**</span>
<a href="#l74.171"></a><span id="l74.171">  * Check if aIPAddress is a local or private IP address.</span>
<a href="#l74.172"></a><span id="l74.172">  *</span>
<a href="#l74.173"></a><span id="l74.173">  * @param aIPAddress  A valid IP address literal in canonical (unobscured) form.</span>
<a href="#l74.174"></a><span id="l74.174">  * @return            True if it is a local/private IPv4 or IPv6 address,</span>
<a href="#l74.175"></a><span id="l74.175">  *                    otherwise false.</span>
<a href="#l74.176"></a><span id="l74.176">  *</span>
<a href="#l74.177"></a><span id="l74.177">  * Note: if the passed in address is not in canonical (unobscured form),</span>
<a href="#l74.178"></a><span id="l74.178">  *       the result may be wrong.</span>
<a href="#l74.179"></a><span id="l74.179">  */</span>
<a href="#l74.180"></a><span id="l74.180" class="difflineminus">-function isLegalLocalIPAddress(aIPAddress)</span>
<a href="#l74.181"></a><span id="l74.181" class="difflineminus">-{</span>
<a href="#l74.182"></a><span id="l74.182" class="difflineplus">+function isLegalLocalIPAddress(aIPAddress) {</span>
<a href="#l74.183"></a><span id="l74.183">   // IPv4 address?</span>
<a href="#l74.184"></a><span id="l74.184">   let ipComponents = aIPAddress.split(&quot;.&quot;);</span>
<a href="#l74.185"></a><span id="l74.185" class="difflineminus">-  if (ipComponents.length == 4)</span>
<a href="#l74.186"></a><span id="l74.186" class="difflineminus">-  {</span>
<a href="#l74.187"></a><span id="l74.187" class="difflineplus">+  if (ipComponents.length == 4) {</span>
<a href="#l74.188"></a><span id="l74.188">      // Check if it's a local or private IPv4 address.</span>
<a href="#l74.189"></a><span id="l74.189">     return ipComponents[0] == 10 ||</span>
<a href="#l74.190"></a><span id="l74.190">            ipComponents[0] == 127 || // loopback address</span>
<a href="#l74.191"></a><span id="l74.191">           (ipComponents[0] == 192 &amp;&amp; ipComponents[1] == 168) ||</span>
<a href="#l74.192"></a><span id="l74.192">           (ipComponents[0] == 169 &amp;&amp; ipComponents[1] == 254) ||</span>
<a href="#l74.193"></a><span id="l74.193">           (ipComponents[0] == 172 &amp;&amp; ipComponents[1] &gt;= 16 &amp;&amp; ipComponents[1] &lt; 32);</span>
<a href="#l74.194"></a><span id="l74.194">   }</span>
<a href="#l74.195"></a><span id="l74.195"> </span>
<a href="#l74.196"></a><span id="l74.196">   // IPv6 address?</span>
<a href="#l74.197"></a><span id="l74.197">   ipComponents = aIPAddress.split(&quot;:&quot;);</span>
<a href="#l74.198"></a><span id="l74.198" class="difflineminus">-  if (ipComponents.length == 8)</span>
<a href="#l74.199"></a><span id="l74.199" class="difflineminus">-  {</span>
<a href="#l74.200"></a><span id="l74.200" class="difflineplus">+  if (ipComponents.length == 8) {</span>
<a href="#l74.201"></a><span id="l74.201">     // ::1/128 - localhost</span>
<a href="#l74.202"></a><span id="l74.202">     if (ipComponents[0] == &quot;0000&quot; &amp;&amp; ipComponents[1] == &quot;0000&quot; &amp;&amp;</span>
<a href="#l74.203"></a><span id="l74.203">         ipComponents[2] == &quot;0000&quot; &amp;&amp; ipComponents[3] == &quot;0000&quot; &amp;&amp;</span>
<a href="#l74.204"></a><span id="l74.204">         ipComponents[4] == &quot;0000&quot; &amp;&amp; ipComponents[5] == &quot;0000&quot; &amp;&amp;</span>
<a href="#l74.205"></a><span id="l74.205">         ipComponents[6] == &quot;0000&quot; &amp;&amp; ipComponents[7] == &quot;0001&quot;)</span>
<a href="#l74.206"></a><span id="l74.206">       return true;</span>
<a href="#l74.207"></a><span id="l74.207"> </span>
<a href="#l74.208"></a><span id="l74.208">     // fe80::/10 - link local addresses</span>
<a href="#l74.209"></a><span id="l74.209" class="difflineat">@@ -328,14 +314,13 @@ function isLegalLocalIPAddress(aIPAddres</span>
<a href="#l74.210"></a><span id="l74.210"> }</span>
<a href="#l74.211"></a><span id="l74.211"> </span>
<a href="#l74.212"></a><span id="l74.212"> /**</span>
<a href="#l74.213"></a><span id="l74.213">  * Clean up the hostname or IP. Usually used to sanitize a value input by the user.</span>
<a href="#l74.214"></a><span id="l74.214">  * It is usually applied before we know if the hostname is even valid.</span>
<a href="#l74.215"></a><span id="l74.215">  *</span>
<a href="#l74.216"></a><span id="l74.216">  * @param aHostName  The hostname or IP string to clean up.</span>
<a href="#l74.217"></a><span id="l74.217">  */</span>
<a href="#l74.218"></a><span id="l74.218" class="difflineminus">-function cleanUpHostName(aHostName)</span>
<a href="#l74.219"></a><span id="l74.219" class="difflineminus">-{</span>
<a href="#l74.220"></a><span id="l74.220" class="difflineplus">+function cleanUpHostName(aHostName) {</span>
<a href="#l74.221"></a><span id="l74.221">   // TODO: Bug 235312: if UTF8 string was input, convert to punycode using convertUTF8toACE()</span>
<a href="#l74.222"></a><span id="l74.222">   // but bug 563172 needs resolving first.</span>
<a href="#l74.223"></a><span id="l74.223">   return aHostName.trim();</span>
<a href="#l74.224"></a><span id="l74.224"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1" class="difflineminus">--- a/mailnews/base/util/iteratorUtils.jsm</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineplus">+++ b/mailnews/base/util/iteratorUtils.jsm</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineat">@@ -64,29 +64,28 @@ function fixIterator(aEnum, aIface) {</span>
<a href="#l75.4"></a><span id="l75.4">   // then the original input is sufficient to directly return. However, if we want</span>
<a href="#l75.5"></a><span id="l75.5">   // to support the aIface parameter, we need to do a lazy version of</span>
<a href="#l75.6"></a><span id="l75.6">   // Array.prototype.map.</span>
<a href="#l75.7"></a><span id="l75.7">   if (Array.isArray(aEnum) ||</span>
<a href="#l75.8"></a><span id="l75.8">       aEnum instanceof Ci.nsISimpleEnumerator ||</span>
<a href="#l75.9"></a><span id="l75.9">       ITERATOR_SYMBOL in aEnum) {</span>
<a href="#l75.10"></a><span id="l75.10">     if (!aIface) {</span>
<a href="#l75.11"></a><span id="l75.11">       return aEnum[ITERATOR_SYMBOL]();</span>
<a href="#l75.12"></a><span id="l75.12" class="difflineminus">-    } else {</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineminus">-      return (function*() {</span>
<a href="#l75.14"></a><span id="l75.14" class="difflineminus">-        for (let o of aEnum)</span>
<a href="#l75.15"></a><span id="l75.15" class="difflineminus">-          yield o.QueryInterface(aIface);</span>
<a href="#l75.16"></a><span id="l75.16" class="difflineminus">-      })();</span>
<a href="#l75.17"></a><span id="l75.17">     }</span>
<a href="#l75.18"></a><span id="l75.18" class="difflineplus">+    return (function* () {</span>
<a href="#l75.19"></a><span id="l75.19" class="difflineplus">+      for (let o of aEnum)</span>
<a href="#l75.20"></a><span id="l75.20" class="difflineplus">+        yield o.QueryInterface(aIface);</span>
<a href="#l75.21"></a><span id="l75.21" class="difflineplus">+    })();</span>
<a href="#l75.22"></a><span id="l75.22">   }</span>
<a href="#l75.23"></a><span id="l75.23"> </span>
<a href="#l75.24"></a><span id="l75.24">   let face = aIface || Ci.nsISupports;</span>
<a href="#l75.25"></a><span id="l75.25">   // Figure out which kind of array object we have.</span>
<a href="#l75.26"></a><span id="l75.26">   // First try nsIArray (covers nsIMutableArray too).</span>
<a href="#l75.27"></a><span id="l75.27">   if (aEnum instanceof Ci.nsIArray) {</span>
<a href="#l75.28"></a><span id="l75.28" class="difflineminus">-    return (function*() {</span>
<a href="#l75.29"></a><span id="l75.29" class="difflineplus">+    return (function* () {</span>
<a href="#l75.30"></a><span id="l75.30">       let count = aEnum.length;</span>
<a href="#l75.31"></a><span id="l75.31">       for (let i = 0; i &lt; count; i++)</span>
<a href="#l75.32"></a><span id="l75.32">         yield aEnum.queryElementAt(i, face);</span>
<a href="#l75.33"></a><span id="l75.33">     })();</span>
<a href="#l75.34"></a><span id="l75.34">   }</span>
<a href="#l75.35"></a><span id="l75.35"> </span>
<a href="#l75.36"></a><span id="l75.36">   // We got something unexpected, notify the caller loudly.</span>
<a href="#l75.37"></a><span id="l75.37">   throw new Error(&quot;An unsupported object sent to fixIterator: &quot; +</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1" class="difflineminus">--- a/mailnews/base/util/jsTreeSelection.js</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineplus">+++ b/mailnews/base/util/jsTreeSelection.js</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l76.4"></a><span id="l76.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l76.5"></a><span id="l76.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l76.6"></a><span id="l76.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l76.7"></a><span id="l76.7"> </span>
<a href="#l76.8"></a><span id="l76.8" class="difflineminus">-this.EXPORTED_SYMBOLS = ['JSTreeSelection'];</span>
<a href="#l76.9"></a><span id="l76.9" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;JSTreeSelection&quot;];</span>
<a href="#l76.10"></a><span id="l76.10"> </span>
<a href="#l76.11"></a><span id="l76.11"> var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l76.12"></a><span id="l76.12"> </span>
<a href="#l76.13"></a><span id="l76.13"> /**</span>
<a href="#l76.14"></a><span id="l76.14">  * Partial nsITreeSelection implementation so that we can have nsMsgDBViews that</span>
<a href="#l76.15"></a><span id="l76.15">  *  exist only for message display but do not need to be backed by a full</span>
<a href="#l76.16"></a><span id="l76.16">  *  tree view widget.  This could also hopefully be used for more xpcshell unit</span>
<a href="#l76.17"></a><span id="l76.17">  *  testing of the FolderDisplayWidget.  It might also be useful for creating</span>
<a href="#l76.18"></a><span id="l76.18" class="difflineat">@@ -100,133 +100,133 @@ JSTreeSelection.prototype = {</span>
<a href="#l76.19"></a><span id="l76.19">    *  but only the primary column shows up as selected.)</span>
<a href="#l76.20"></a><span id="l76.20">    *</span>
<a href="#l76.21"></a><span id="l76.21">    * @return false because we don't support single-selection.</span>
<a href="#l76.22"></a><span id="l76.22">    */</span>
<a href="#l76.23"></a><span id="l76.23">   get single() {</span>
<a href="#l76.24"></a><span id="l76.24">     return false;</span>
<a href="#l76.25"></a><span id="l76.25">   },</span>
<a href="#l76.26"></a><span id="l76.26"> </span>
<a href="#l76.27"></a><span id="l76.27" class="difflineminus">-  _updateCount: function JSTreeSelection__updateCount() {</span>
<a href="#l76.28"></a><span id="l76.28" class="difflineplus">+  _updateCount() {</span>
<a href="#l76.29"></a><span id="l76.29">     this._count = 0;</span>
<a href="#l76.30"></a><span id="l76.30">     for (let [low, high] of this._ranges) {</span>
<a href="#l76.31"></a><span id="l76.31">       this._count += high - low + 1;</span>
<a href="#l76.32"></a><span id="l76.32">     }</span>
<a href="#l76.33"></a><span id="l76.33">   },</span>
<a href="#l76.34"></a><span id="l76.34"> </span>
<a href="#l76.35"></a><span id="l76.35">   get count() {</span>
<a href="#l76.36"></a><span id="l76.36">     return this._count;</span>
<a href="#l76.37"></a><span id="l76.37">   },</span>
<a href="#l76.38"></a><span id="l76.38"> </span>
<a href="#l76.39"></a><span id="l76.39" class="difflineminus">-  isSelected: function JSTreeSelection_isSelected(aViewIndex) {</span>
<a href="#l76.40"></a><span id="l76.40" class="difflineplus">+  isSelected(aViewIndex) {</span>
<a href="#l76.41"></a><span id="l76.41">     for (let [low, high] of this._ranges) {</span>
<a href="#l76.42"></a><span id="l76.42">       if (aViewIndex &gt;= low &amp;&amp; aViewIndex &lt;= high)</span>
<a href="#l76.43"></a><span id="l76.43">         return true;</span>
<a href="#l76.44"></a><span id="l76.44">     }</span>
<a href="#l76.45"></a><span id="l76.45">     return false;</span>
<a href="#l76.46"></a><span id="l76.46">   },</span>
<a href="#l76.47"></a><span id="l76.47"> </span>
<a href="#l76.48"></a><span id="l76.48">   /**</span>
<a href="#l76.49"></a><span id="l76.49">    * Select the given row.  It does nothing if that row was already selected.</span>
<a href="#l76.50"></a><span id="l76.50">    */</span>
<a href="#l76.51"></a><span id="l76.51" class="difflineminus">-  select: function JSTreeSelection_select(aViewIndex) {</span>
<a href="#l76.52"></a><span id="l76.52" class="difflineplus">+  select(aViewIndex) {</span>
<a href="#l76.53"></a><span id="l76.53">     // current index will provide our effective shift pivot</span>
<a href="#l76.54"></a><span id="l76.54">     this._shiftSelectPivot = null;</span>
<a href="#l76.55"></a><span id="l76.55">     this.currentIndex = aViewIndex;</span>
<a href="#l76.56"></a><span id="l76.56"> </span>
<a href="#l76.57"></a><span id="l76.57">     if (this._count == 1 &amp;&amp; this._ranges[0][0] == aViewIndex)</span>
<a href="#l76.58"></a><span id="l76.58">       return;</span>
<a href="#l76.59"></a><span id="l76.59"> </span>
<a href="#l76.60"></a><span id="l76.60">     this._count = 1;</span>
<a href="#l76.61"></a><span id="l76.61">     this._ranges = [[aViewIndex, aViewIndex]];</span>
<a href="#l76.62"></a><span id="l76.62"> </span>
<a href="#l76.63"></a><span id="l76.63">     if (this._tree)</span>
<a href="#l76.64"></a><span id="l76.64">       this._tree.invalidate();</span>
<a href="#l76.65"></a><span id="l76.65"> </span>
<a href="#l76.66"></a><span id="l76.66">     this._fireSelectionChanged();</span>
<a href="#l76.67"></a><span id="l76.67">   },</span>
<a href="#l76.68"></a><span id="l76.68"> </span>
<a href="#l76.69"></a><span id="l76.69" class="difflineminus">-  timedSelect: function JSTreeSelection_timedSelect(aIndex, aDelay) {</span>
<a href="#l76.70"></a><span id="l76.70" class="difflineplus">+  timedSelect(aIndex, aDelay) {</span>
<a href="#l76.71"></a><span id="l76.71">     throw new Error(&quot;We do not implement timed selection.&quot;);</span>
<a href="#l76.72"></a><span id="l76.72">   },</span>
<a href="#l76.73"></a><span id="l76.73"> </span>
<a href="#l76.74"></a><span id="l76.74" class="difflineminus">-  toggleSelect: function JSTreeSelection_toggleSelect(aIndex) {</span>
<a href="#l76.75"></a><span id="l76.75" class="difflineplus">+  toggleSelect(aIndex) {</span>
<a href="#l76.76"></a><span id="l76.76">     this.currentIndex = aIndex;</span>
<a href="#l76.77"></a><span id="l76.77">     // If nothing's selected, select aIndex</span>
<a href="#l76.78"></a><span id="l76.78">     if (this._count == 0) {</span>
<a href="#l76.79"></a><span id="l76.79">       this._count = 1;</span>
<a href="#l76.80"></a><span id="l76.80">       this._ranges = [[aIndex, aIndex]];</span>
<a href="#l76.81"></a><span id="l76.81" class="difflineminus">-    }</span>
<a href="#l76.82"></a><span id="l76.82" class="difflineminus">-    else for (let [iTupe, [low, high]] of this._ranges.entries()) {</span>
<a href="#l76.83"></a><span id="l76.83" class="difflineminus">-      // below the range? add it to the existing range or create a new one</span>
<a href="#l76.84"></a><span id="l76.84" class="difflineminus">-      if (aIndex &lt; low) {</span>
<a href="#l76.85"></a><span id="l76.85" class="difflineminus">-        this._count++;</span>
<a href="#l76.86"></a><span id="l76.86" class="difflineminus">-        // is it just below an existing range? (range fusion only happens in the</span>
<a href="#l76.87"></a><span id="l76.87" class="difflineminus">-        //  high case, not here.)</span>
<a href="#l76.88"></a><span id="l76.88" class="difflineminus">-        if (aIndex == low - 1) {</span>
<a href="#l76.89"></a><span id="l76.89" class="difflineminus">-          this._ranges[iTupe][0] = aIndex;</span>
<a href="#l76.90"></a><span id="l76.90" class="difflineplus">+    } else {</span>
<a href="#l76.91"></a><span id="l76.91" class="difflineplus">+      for (let [iTupe, [low, high]] of this._ranges.entries()) {</span>
<a href="#l76.92"></a><span id="l76.92" class="difflineplus">+        // below the range? add it to the existing range or create a new one</span>
<a href="#l76.93"></a><span id="l76.93" class="difflineplus">+        if (aIndex &lt; low) {</span>
<a href="#l76.94"></a><span id="l76.94" class="difflineplus">+          this._count++;</span>
<a href="#l76.95"></a><span id="l76.95" class="difflineplus">+          // is it just below an existing range? (range fusion only happens in the</span>
<a href="#l76.96"></a><span id="l76.96" class="difflineplus">+          //  high case, not here.)</span>
<a href="#l76.97"></a><span id="l76.97" class="difflineplus">+          if (aIndex == low - 1) {</span>
<a href="#l76.98"></a><span id="l76.98" class="difflineplus">+            this._ranges[iTupe][0] = aIndex;</span>
<a href="#l76.99"></a><span id="l76.99" class="difflineplus">+            break;</span>
<a href="#l76.100"></a><span id="l76.100" class="difflineplus">+          }</span>
<a href="#l76.101"></a><span id="l76.101" class="difflineplus">+          // then it gets its own range</span>
<a href="#l76.102"></a><span id="l76.102" class="difflineplus">+          this._ranges.splice(iTupe, 0, [aIndex, aIndex]);</span>
<a href="#l76.103"></a><span id="l76.103">           break;</span>
<a href="#l76.104"></a><span id="l76.104">         }</span>
<a href="#l76.105"></a><span id="l76.105" class="difflineminus">-        // then it gets its own range</span>
<a href="#l76.106"></a><span id="l76.106" class="difflineminus">-        this._ranges.splice(iTupe, 0, [aIndex, aIndex]);</span>
<a href="#l76.107"></a><span id="l76.107" class="difflineminus">-        break;</span>
<a href="#l76.108"></a><span id="l76.108" class="difflineminus">-      }</span>
<a href="#l76.109"></a><span id="l76.109" class="difflineminus">-      // in the range?  will need to either nuke, shrink, or split the range to</span>
<a href="#l76.110"></a><span id="l76.110" class="difflineminus">-      //  remove it</span>
<a href="#l76.111"></a><span id="l76.111" class="difflineminus">-      if (aIndex &gt;= low &amp;&amp; aIndex &lt;= high) {</span>
<a href="#l76.112"></a><span id="l76.112" class="difflineminus">-        this._count--;</span>
<a href="#l76.113"></a><span id="l76.113" class="difflineminus">-        // nuke</span>
<a href="#l76.114"></a><span id="l76.114" class="difflineminus">-        if (aIndex == low &amp;&amp; aIndex == high)</span>
<a href="#l76.115"></a><span id="l76.115" class="difflineminus">-          this._ranges.splice(iTupe, 1);</span>
<a href="#l76.116"></a><span id="l76.116" class="difflineminus">-        // lower shrink</span>
<a href="#l76.117"></a><span id="l76.117" class="difflineminus">-        else if (aIndex == low)</span>
<a href="#l76.118"></a><span id="l76.118" class="difflineminus">-          this._ranges[iTupe][0] = aIndex + 1;</span>
<a href="#l76.119"></a><span id="l76.119" class="difflineminus">-        // upper shrink</span>
<a href="#l76.120"></a><span id="l76.120" class="difflineminus">-        else if (aIndex == high)</span>
<a href="#l76.121"></a><span id="l76.121" class="difflineminus">-          this._ranges[iTupe][1] = aIndex - 1;</span>
<a href="#l76.122"></a><span id="l76.122" class="difflineminus">-        // split</span>
<a href="#l76.123"></a><span id="l76.123" class="difflineminus">-        else</span>
<a href="#l76.124"></a><span id="l76.124" class="difflineminus">-          this._ranges.splice(iTupe, 1, [low, aIndex - 1], [aIndex + 1, high]);</span>
<a href="#l76.125"></a><span id="l76.125" class="difflineminus">-        break;</span>
<a href="#l76.126"></a><span id="l76.126" class="difflineminus">-      }</span>
<a href="#l76.127"></a><span id="l76.127" class="difflineminus">-      // just above the range?  fuse into the range, and possibly the next</span>
<a href="#l76.128"></a><span id="l76.128" class="difflineminus">-      //  range up.</span>
<a href="#l76.129"></a><span id="l76.129" class="difflineminus">-      if (aIndex == high + 1) {</span>
<a href="#l76.130"></a><span id="l76.130" class="difflineminus">-        this._count++;</span>
<a href="#l76.131"></a><span id="l76.131" class="difflineminus">-        // see if there is another range and there was just a gap of one between</span>
<a href="#l76.132"></a><span id="l76.132" class="difflineminus">-        //  the two ranges.</span>
<a href="#l76.133"></a><span id="l76.133" class="difflineminus">-        if ((iTupe + 1 &lt; this._ranges.length) &amp;&amp;</span>
<a href="#l76.134"></a><span id="l76.134" class="difflineminus">-            (this._ranges[iTupe+1][0] == aIndex + 1)) {</span>
<a href="#l76.135"></a><span id="l76.135" class="difflineminus">-          // yes, merge the ranges</span>
<a href="#l76.136"></a><span id="l76.136" class="difflineminus">-          this._ranges.splice(iTupe, 2, [low, this._ranges[iTupe+1][1]]);</span>
<a href="#l76.137"></a><span id="l76.137" class="difflineplus">+        // in the range?  will need to either nuke, shrink, or split the range to</span>
<a href="#l76.138"></a><span id="l76.138" class="difflineplus">+        //  remove it</span>
<a href="#l76.139"></a><span id="l76.139" class="difflineplus">+        if (aIndex &gt;= low &amp;&amp; aIndex &lt;= high) {</span>
<a href="#l76.140"></a><span id="l76.140" class="difflineplus">+          this._count--;</span>
<a href="#l76.141"></a><span id="l76.141" class="difflineplus">+          // nuke</span>
<a href="#l76.142"></a><span id="l76.142" class="difflineplus">+          if (aIndex == low &amp;&amp; aIndex == high)</span>
<a href="#l76.143"></a><span id="l76.143" class="difflineplus">+            this._ranges.splice(iTupe, 1);</span>
<a href="#l76.144"></a><span id="l76.144" class="difflineplus">+          // lower shrink</span>
<a href="#l76.145"></a><span id="l76.145" class="difflineplus">+          else if (aIndex == low)</span>
<a href="#l76.146"></a><span id="l76.146" class="difflineplus">+            this._ranges[iTupe][0] = aIndex + 1;</span>
<a href="#l76.147"></a><span id="l76.147" class="difflineplus">+          // upper shrink</span>
<a href="#l76.148"></a><span id="l76.148" class="difflineplus">+          else if (aIndex == high)</span>
<a href="#l76.149"></a><span id="l76.149" class="difflineplus">+            this._ranges[iTupe][1] = aIndex - 1;</span>
<a href="#l76.150"></a><span id="l76.150" class="difflineplus">+          // split</span>
<a href="#l76.151"></a><span id="l76.151" class="difflineplus">+          else</span>
<a href="#l76.152"></a><span id="l76.152" class="difflineplus">+            this._ranges.splice(iTupe, 1, [low, aIndex - 1], [aIndex + 1, high]);</span>
<a href="#l76.153"></a><span id="l76.153">           break;</span>
<a href="#l76.154"></a><span id="l76.154">         }</span>
<a href="#l76.155"></a><span id="l76.155" class="difflineminus">-        // nope, no merge required, just update the range</span>
<a href="#l76.156"></a><span id="l76.156" class="difflineminus">-        this._ranges[iTupe][1] = aIndex;</span>
<a href="#l76.157"></a><span id="l76.157" class="difflineminus">-        break;</span>
<a href="#l76.158"></a><span id="l76.158" class="difflineplus">+        // just above the range?  fuse into the range, and possibly the next</span>
<a href="#l76.159"></a><span id="l76.159" class="difflineplus">+        //  range up.</span>
<a href="#l76.160"></a><span id="l76.160" class="difflineplus">+        if (aIndex == high + 1) {</span>
<a href="#l76.161"></a><span id="l76.161" class="difflineplus">+          this._count++;</span>
<a href="#l76.162"></a><span id="l76.162" class="difflineplus">+          // see if there is another range and there was just a gap of one between</span>
<a href="#l76.163"></a><span id="l76.163" class="difflineplus">+          //  the two ranges.</span>
<a href="#l76.164"></a><span id="l76.164" class="difflineplus">+          if ((iTupe + 1 &lt; this._ranges.length) &amp;&amp;</span>
<a href="#l76.165"></a><span id="l76.165" class="difflineplus">+              (this._ranges[iTupe + 1][0] == aIndex + 1)) {</span>
<a href="#l76.166"></a><span id="l76.166" class="difflineplus">+            // yes, merge the ranges</span>
<a href="#l76.167"></a><span id="l76.167" class="difflineplus">+            this._ranges.splice(iTupe, 2, [low, this._ranges[iTupe + 1][1]]);</span>
<a href="#l76.168"></a><span id="l76.168" class="difflineplus">+            break;</span>
<a href="#l76.169"></a><span id="l76.169" class="difflineplus">+          }</span>
<a href="#l76.170"></a><span id="l76.170" class="difflineplus">+          // nope, no merge required, just update the range</span>
<a href="#l76.171"></a><span id="l76.171" class="difflineplus">+          this._ranges[iTupe][1] = aIndex;</span>
<a href="#l76.172"></a><span id="l76.172" class="difflineplus">+          break;</span>
<a href="#l76.173"></a><span id="l76.173" class="difflineplus">+        }</span>
<a href="#l76.174"></a><span id="l76.174" class="difflineplus">+        // otherwise we need to keep going</span>
<a href="#l76.175"></a><span id="l76.175">       }</span>
<a href="#l76.176"></a><span id="l76.176" class="difflineminus">-      // otherwise we need to keep going</span>
<a href="#l76.177"></a><span id="l76.177">     }</span>
<a href="#l76.178"></a><span id="l76.178"> </span>
<a href="#l76.179"></a><span id="l76.179">     if (this._tree)</span>
<a href="#l76.180"></a><span id="l76.180">       this._tree.invalidateRow(aIndex);</span>
<a href="#l76.181"></a><span id="l76.181">     this._fireSelectionChanged();</span>
<a href="#l76.182"></a><span id="l76.182">   },</span>
<a href="#l76.183"></a><span id="l76.183"> </span>
<a href="#l76.184"></a><span id="l76.184">   /**</span>
<a href="#l76.185"></a><span id="l76.185">    * @param aRangeStart If omitted, it implies a shift-selection is happening,</span>
<a href="#l76.186"></a><span id="l76.186">    *     in which case we use _shiftSelectPivot as the start if we have it,</span>
<a href="#l76.187"></a><span id="l76.187">    *     _currentIndex if we don't, and if we somehow didn't have a</span>
<a href="#l76.188"></a><span id="l76.188">    *     _currentIndex, we use the range end.</span>
<a href="#l76.189"></a><span id="l76.189">    * @param aRangeEnd Just the inclusive end of the range.</span>
<a href="#l76.190"></a><span id="l76.190">    * @param aAugment Does this set a new selection or should it be merged with</span>
<a href="#l76.191"></a><span id="l76.191">    *     the existing selection?</span>
<a href="#l76.192"></a><span id="l76.192">    */</span>
<a href="#l76.193"></a><span id="l76.193" class="difflineminus">-  rangedSelect: function JSTreeSelection_rangedSelect(aRangeStart, aRangeEnd,</span>
<a href="#l76.194"></a><span id="l76.194" class="difflineminus">-                                                      aAugment) {</span>
<a href="#l76.195"></a><span id="l76.195" class="difflineplus">+  rangedSelect(aRangeStart, aRangeEnd, aAugment) {</span>
<a href="#l76.196"></a><span id="l76.196">     if (aRangeStart == -1) {</span>
<a href="#l76.197"></a><span id="l76.197">       if (this._shiftSelectPivot != null)</span>
<a href="#l76.198"></a><span id="l76.198">         aRangeStart = this._shiftSelectPivot;</span>
<a href="#l76.199"></a><span id="l76.199">       else if (this._currentIndex != null)</span>
<a href="#l76.200"></a><span id="l76.200">         aRangeStart = this._currentIndex;</span>
<a href="#l76.201"></a><span id="l76.201">       else</span>
<a href="#l76.202"></a><span id="l76.202">         aRangeStart = aRangeEnd;</span>
<a href="#l76.203"></a><span id="l76.203">     }</span>
<a href="#l76.204"></a><span id="l76.204" class="difflineat">@@ -297,17 +297,17 @@ JSTreeSelection.prototype = {</span>
<a href="#l76.205"></a><span id="l76.205">     this._fireSelectionChanged();</span>
<a href="#l76.206"></a><span id="l76.206">   },</span>
<a href="#l76.207"></a><span id="l76.207"> </span>
<a href="#l76.208"></a><span id="l76.208">   /**</span>
<a href="#l76.209"></a><span id="l76.209">    * This is basically RangedSelect but without insertion of a new range and we</span>
<a href="#l76.210"></a><span id="l76.210">    *  don't need to worry about adjacency.</span>
<a href="#l76.211"></a><span id="l76.211">    * Oddly, nsTreeSelection doesn't fire a selection changed event here...</span>
<a href="#l76.212"></a><span id="l76.212">    */</span>
<a href="#l76.213"></a><span id="l76.213" class="difflineminus">-  clearRange: function JSTreeSelection_clearRange(aRangeStart, aRangeEnd) {</span>
<a href="#l76.214"></a><span id="l76.214" class="difflineplus">+  clearRange(aRangeStart, aRangeEnd) {</span>
<a href="#l76.215"></a><span id="l76.215">     // Iterate over our existing set of ranges, finding the 'range' of ranges</span>
<a href="#l76.216"></a><span id="l76.216">     //  that our clear range overlaps or simply obviates.</span>
<a href="#l76.217"></a><span id="l76.217">     // Overlap variables track blocks we need to keep some part of, Nuke</span>
<a href="#l76.218"></a><span id="l76.218">     //  variables are for blocks that get spliced out.  For our purposes, all</span>
<a href="#l76.219"></a><span id="l76.219">     //  overlap blocks are also nuke blocks.</span>
<a href="#l76.220"></a><span id="l76.220">     let lowOverlap, lowNuke, highNuke, highOverlap;</span>
<a href="#l76.221"></a><span id="l76.221">     for (let [iTupe, [low, high]] of this._ranges.entries()) {</span>
<a href="#l76.222"></a><span id="l76.222">       // If we completely include the range, it should be nuked</span>
<a href="#l76.223"></a><span id="l76.223" class="difflineat">@@ -353,36 +353,36 @@ JSTreeSelection.prototype = {</span>
<a href="#l76.224"></a><span id="l76.224">     // note! nsTreeSelection doesn't fire a selection changed event, so neither</span>
<a href="#l76.225"></a><span id="l76.225">     //  do we, but it seems like we should</span>
<a href="#l76.226"></a><span id="l76.226">   },</span>
<a href="#l76.227"></a><span id="l76.227"> </span>
<a href="#l76.228"></a><span id="l76.228">   /**</span>
<a href="#l76.229"></a><span id="l76.229">    * nsTreeSelection always fires a select notification when the range is</span>
<a href="#l76.230"></a><span id="l76.230">    *  cleared, even if there is no effective chance in selection.</span>
<a href="#l76.231"></a><span id="l76.231">    */</span>
<a href="#l76.232"></a><span id="l76.232" class="difflineminus">-  clearSelection: function JSTreeSelection_clearSelection() {</span>
<a href="#l76.233"></a><span id="l76.233" class="difflineplus">+  clearSelection() {</span>
<a href="#l76.234"></a><span id="l76.234">     this._shiftSelectPivot = null;</span>
<a href="#l76.235"></a><span id="l76.235">     this._count = 0;</span>
<a href="#l76.236"></a><span id="l76.236">     this._ranges = [];</span>
<a href="#l76.237"></a><span id="l76.237">     if (this._tree)</span>
<a href="#l76.238"></a><span id="l76.238">       this._tree.invalidate();</span>
<a href="#l76.239"></a><span id="l76.239">     this._fireSelectionChanged();</span>
<a href="#l76.240"></a><span id="l76.240">   },</span>
<a href="#l76.241"></a><span id="l76.241"> </span>
<a href="#l76.242"></a><span id="l76.242">   /**</span>
<a href="#l76.243"></a><span id="l76.243">    * Not even nsTreeSelection implements this.</span>
<a href="#l76.244"></a><span id="l76.244">    */</span>
<a href="#l76.245"></a><span id="l76.245" class="difflineminus">-  invertSelection: function JSTreeSelection_invertSelection() {</span>
<a href="#l76.246"></a><span id="l76.246" class="difflineplus">+  invertSelection() {</span>
<a href="#l76.247"></a><span id="l76.247">     throw new Error(&quot;Who really was going to use this?&quot;);</span>
<a href="#l76.248"></a><span id="l76.248">   },</span>
<a href="#l76.249"></a><span id="l76.249"> </span>
<a href="#l76.250"></a><span id="l76.250">   /**</span>
<a href="#l76.251"></a><span id="l76.251">    * Select all with no rows is a no-op, otherwise we select all and notify.</span>
<a href="#l76.252"></a><span id="l76.252">    */</span>
<a href="#l76.253"></a><span id="l76.253" class="difflineminus">-  selectAll: function JSTreeSelection_selectAll() {</span>
<a href="#l76.254"></a><span id="l76.254" class="difflineplus">+  selectAll() {</span>
<a href="#l76.255"></a><span id="l76.255">     if (!this._view)</span>
<a href="#l76.256"></a><span id="l76.256">       return;</span>
<a href="#l76.257"></a><span id="l76.257"> </span>
<a href="#l76.258"></a><span id="l76.258">     let view = this._view;</span>
<a href="#l76.259"></a><span id="l76.259">     let rowCount = view.rowCount;</span>
<a href="#l76.260"></a><span id="l76.260"> </span>
<a href="#l76.261"></a><span id="l76.261">     // no-ops-ville</span>
<a href="#l76.262"></a><span id="l76.262">     if (!rowCount)</span>
<a href="#l76.263"></a><span id="l76.263" class="difflineat">@@ -391,40 +391,38 @@ JSTreeSelection.prototype = {</span>
<a href="#l76.264"></a><span id="l76.264">     this._count = rowCount;</span>
<a href="#l76.265"></a><span id="l76.265">     this._ranges = [[0, rowCount - 1]];</span>
<a href="#l76.266"></a><span id="l76.266"> </span>
<a href="#l76.267"></a><span id="l76.267">     if (this._tree)</span>
<a href="#l76.268"></a><span id="l76.268">       this._tree.invalidate();</span>
<a href="#l76.269"></a><span id="l76.269">     this._fireSelectionChanged();</span>
<a href="#l76.270"></a><span id="l76.270">   },</span>
<a href="#l76.271"></a><span id="l76.271"> </span>
<a href="#l76.272"></a><span id="l76.272" class="difflineminus">-  getRangeCount: function JSTreeSelection_getRangeCount() {</span>
<a href="#l76.273"></a><span id="l76.273" class="difflineplus">+  getRangeCount() {</span>
<a href="#l76.274"></a><span id="l76.274">     return this._ranges.length;</span>
<a href="#l76.275"></a><span id="l76.275">   },</span>
<a href="#l76.276"></a><span id="l76.276" class="difflineminus">-  getRangeAt: function JSTreeSelection_getRangeAt(aRangeIndex, aMinObj,</span>
<a href="#l76.277"></a><span id="l76.277" class="difflineminus">-                                                  aMaxObj) {</span>
<a href="#l76.278"></a><span id="l76.278" class="difflineplus">+  getRangeAt(aRangeIndex, aMinObj, aMaxObj) {</span>
<a href="#l76.279"></a><span id="l76.279">     if (aRangeIndex &lt; 0 || aRangeIndex &gt; this._ranges.length)</span>
<a href="#l76.280"></a><span id="l76.280" class="difflineminus">-      throw new Exception(&quot;Try a real range index next time.&quot;);</span>
<a href="#l76.281"></a><span id="l76.281" class="difflineplus">+      throw new Error(&quot;Try a real range index next time.&quot;);</span>
<a href="#l76.282"></a><span id="l76.282">     [aMinObj.value, aMaxObj.value] = this._ranges[aRangeIndex];</span>
<a href="#l76.283"></a><span id="l76.283">   },</span>
<a href="#l76.284"></a><span id="l76.284"> </span>
<a href="#l76.285"></a><span id="l76.285" class="difflineminus">-  invalidateSelection: function JSTreeSelection_invalidateSelection() {</span>
<a href="#l76.286"></a><span id="l76.286" class="difflineplus">+  invalidateSelection() {</span>
<a href="#l76.287"></a><span id="l76.287">     if (this._tree)</span>
<a href="#l76.288"></a><span id="l76.288">       this._tree.invalidate();</span>
<a href="#l76.289"></a><span id="l76.289">   },</span>
<a href="#l76.290"></a><span id="l76.290"> </span>
<a href="#l76.291"></a><span id="l76.291">   /**</span>
<a href="#l76.292"></a><span id="l76.292">    * Helper method to adjust points in the face of row additions/removal.</span>
<a href="#l76.293"></a><span id="l76.293">    * @param aPoint The point, null if there isn't one, or an index otherwise.</span>
<a href="#l76.294"></a><span id="l76.294">    * @param aDeltaAt The row at which the change is happening.</span>
<a href="#l76.295"></a><span id="l76.295">    * @param aDelta The number of rows added if positive, or the (negative)</span>
<a href="#l76.296"></a><span id="l76.296">    *     number of rows removed.</span>
<a href="#l76.297"></a><span id="l76.297">    */</span>
<a href="#l76.298"></a><span id="l76.298" class="difflineminus">-  _adjustPoint: function JSTreeSelection__adjustPoint(aPoint, aDeltaAt,</span>
<a href="#l76.299"></a><span id="l76.299" class="difflineminus">-                                                      aDelta) {</span>
<a href="#l76.300"></a><span id="l76.300" class="difflineplus">+  _adjustPoint(aPoint, aDeltaAt, aDelta) {</span>
<a href="#l76.301"></a><span id="l76.301">     // if there is no point, no change</span>
<a href="#l76.302"></a><span id="l76.302">     if (aPoint == null)</span>
<a href="#l76.303"></a><span id="l76.303">       return aPoint;</span>
<a href="#l76.304"></a><span id="l76.304">     // if the point is before the change, no change</span>
<a href="#l76.305"></a><span id="l76.305">     if (aPoint &lt; aDeltaAt)</span>
<a href="#l76.306"></a><span id="l76.306">       return aPoint;</span>
<a href="#l76.307"></a><span id="l76.307">     // if it's a deletion and it includes the point, clear it</span>
<a href="#l76.308"></a><span id="l76.308">     if (aDelta &lt; 0 &amp;&amp; aPoint &gt;= aDeltaAt &amp;&amp; (aPoint + aDelta &lt; aDeltaAt))</span>
<a href="#l76.309"></a><span id="l76.309" class="difflineat">@@ -434,18 +432,17 @@ JSTreeSelection.prototype = {</span>
<a href="#l76.310"></a><span id="l76.310">   },</span>
<a href="#l76.311"></a><span id="l76.311">   /**</span>
<a href="#l76.312"></a><span id="l76.312">    * Find the index of the range, if any, that contains the given index, and</span>
<a href="#l76.313"></a><span id="l76.313">    *  the index at which to insert a range if one does not exist.</span>
<a href="#l76.314"></a><span id="l76.314">    *</span>
<a href="#l76.315"></a><span id="l76.315">    * @return A tuple containing: 1) the index if there is one, null otherwise,</span>
<a href="#l76.316"></a><span id="l76.316">    *     2) the index at which to insert a range that would contain the point.</span>
<a href="#l76.317"></a><span id="l76.317">    */</span>
<a href="#l76.318"></a><span id="l76.318" class="difflineminus">-  _findRangeContainingRow:</span>
<a href="#l76.319"></a><span id="l76.319" class="difflineminus">-      function JSTreeSelection__findRangeContainingRow(aIndex) {</span>
<a href="#l76.320"></a><span id="l76.320" class="difflineplus">+  _findRangeContainingRow(aIndex) {</span>
<a href="#l76.321"></a><span id="l76.321">     for (let [iTupe, [low, high]] of this._ranges.entries()) {</span>
<a href="#l76.322"></a><span id="l76.322">       if (aIndex &gt;= low &amp;&amp; aIndex &lt;= high)</span>
<a href="#l76.323"></a><span id="l76.323">         return [iTupe, iTupe];</span>
<a href="#l76.324"></a><span id="l76.324">       if (aIndex &lt; low)</span>
<a href="#l76.325"></a><span id="l76.325">         return [null, iTupe];</span>
<a href="#l76.326"></a><span id="l76.326">     }</span>
<a href="#l76.327"></a><span id="l76.327">     return [null, this._ranges.length];</span>
<a href="#l76.328"></a><span id="l76.328">   },</span>
<a href="#l76.329"></a><span id="l76.329" class="difflineat">@@ -459,42 +456,40 @@ JSTreeSelection.prototype = {</span>
<a href="#l76.330"></a><span id="l76.330">   /**</span>
<a href="#l76.331"></a><span id="l76.331">    * Start logging calls to adjustSelection made against this instance.  You</span>
<a href="#l76.332"></a><span id="l76.332">    *  would do this because you are replacing an existing selection object</span>
<a href="#l76.333"></a><span id="l76.333">    *  with this instance for the purposes of creating a transient selection.</span>
<a href="#l76.334"></a><span id="l76.334">    *  Of course, you want the original selection object to be up-to-date when</span>
<a href="#l76.335"></a><span id="l76.335">    *  you go to put it back, so then you can call replayAdjustSelectionLog</span>
<a href="#l76.336"></a><span id="l76.336">    *  with that selection object and everything will be peachy.</span>
<a href="#l76.337"></a><span id="l76.337">    */</span>
<a href="#l76.338"></a><span id="l76.338" class="difflineminus">-  logAdjustSelectionForReplay:</span>
<a href="#l76.339"></a><span id="l76.339" class="difflineminus">-      function JSTreeSelection_logAdjustSelectionForReplay() {</span>
<a href="#l76.340"></a><span id="l76.340" class="difflineplus">+  logAdjustSelectionForReplay() {</span>
<a href="#l76.341"></a><span id="l76.341">     this._adjustSelectionLog = [];</span>
<a href="#l76.342"></a><span id="l76.342">   },</span>
<a href="#l76.343"></a><span id="l76.343">   /**</span>
<a href="#l76.344"></a><span id="l76.344">    * Stop logging calls to adjustSelection and replay the existing log against</span>
<a href="#l76.345"></a><span id="l76.345">    *  aSelection.</span>
<a href="#l76.346"></a><span id="l76.346">    *</span>
<a href="#l76.347"></a><span id="l76.347">    * @param aSelection {nsITreeSelection}.</span>
<a href="#l76.348"></a><span id="l76.348">    */</span>
<a href="#l76.349"></a><span id="l76.349" class="difflineminus">-  replayAdjustSelectionLog:</span>
<a href="#l76.350"></a><span id="l76.350" class="difflineminus">-      function JSTreeSelection_replayAdjustSelectionLog(aSelection) {</span>
<a href="#l76.351"></a><span id="l76.351" class="difflineplus">+  replayAdjustSelectionLog(aSelection) {</span>
<a href="#l76.352"></a><span id="l76.352">     if (this._adjustSelectionLog.length) {</span>
<a href="#l76.353"></a><span id="l76.353">       // Temporarily disable selection events because adjustSelection is going</span>
<a href="#l76.354"></a><span id="l76.354">       //  to generate an event each time otherwise, and better 1 event than</span>
<a href="#l76.355"></a><span id="l76.355">       //  many.</span>
<a href="#l76.356"></a><span id="l76.356">       aSelection.selectEventsSuppressed = true;</span>
<a href="#l76.357"></a><span id="l76.357">       for (let [index, count] of this._adjustSelectionLog) {</span>
<a href="#l76.358"></a><span id="l76.358">         aSelection.adjustSelection(index, count);</span>
<a href="#l76.359"></a><span id="l76.359">       }</span>
<a href="#l76.360"></a><span id="l76.360">       aSelection.selectEventsSuppressed = false;</span>
<a href="#l76.361"></a><span id="l76.361">     }</span>
<a href="#l76.362"></a><span id="l76.362">     this._adjustSelectionLog = null;</span>
<a href="#l76.363"></a><span id="l76.363">   },</span>
<a href="#l76.364"></a><span id="l76.364"> </span>
<a href="#l76.365"></a><span id="l76.365" class="difflineminus">-  adjustSelection: function JSTreeSelection_adjustSelection(aIndex, aCount) {</span>
<a href="#l76.366"></a><span id="l76.366" class="difflineplus">+  adjustSelection(aIndex, aCount) {</span>
<a href="#l76.367"></a><span id="l76.367">     // nothing to do if there is no actual change</span>
<a href="#l76.368"></a><span id="l76.368">     if (!aCount)</span>
<a href="#l76.369"></a><span id="l76.369">       return;</span>
<a href="#l76.370"></a><span id="l76.370"> </span>
<a href="#l76.371"></a><span id="l76.371">     if (this._adjustSelectionLog)</span>
<a href="#l76.372"></a><span id="l76.372">       this._adjustSelectionLog.push([aIndex, aCount]);</span>
<a href="#l76.373"></a><span id="l76.373"> </span>
<a href="#l76.374"></a><span id="l76.374">     // adjust our points</span>
<a href="#l76.375"></a><span id="l76.375" class="difflineat">@@ -543,18 +538,18 @@ JSTreeSelection.prototype = {</span>
<a href="#l76.376"></a><span id="l76.376">       // for the first range, low may be below the index, in which case it</span>
<a href="#l76.377"></a><span id="l76.377">       //  should not get translated</span>
<a href="#l76.378"></a><span id="l76.378">       this._ranges[iTrans] = [(low &gt;= aIndex) ? low + aCount : low,</span>
<a href="#l76.379"></a><span id="l76.379">                               high + aCount];</span>
<a href="#l76.380"></a><span id="l76.380">     }</span>
<a href="#l76.381"></a><span id="l76.381">     // we may have to merge the lowest translated block because it may now be</span>
<a href="#l76.382"></a><span id="l76.382">     //  adjacent to the previous block</span>
<a href="#l76.383"></a><span id="l76.383">     if (iTrans &gt; 0 &amp;&amp; iTrans &lt; this._ranges.length &amp;&amp;</span>
<a href="#l76.384"></a><span id="l76.384" class="difflineminus">-        this._ranges[iTrans-1][1] == this_ranges[iTrans][0]) {</span>
<a href="#l76.385"></a><span id="l76.385" class="difflineminus">-      this._ranges[iTrans-1][1] = this._ranges[iTrans][1];</span>
<a href="#l76.386"></a><span id="l76.386" class="difflineplus">+        this._ranges[iTrans - 1][1] == this._ranges[iTrans][0]) {</span>
<a href="#l76.387"></a><span id="l76.387" class="difflineplus">+      this._ranges[iTrans - 1][1] = this._ranges[iTrans][1];</span>
<a href="#l76.388"></a><span id="l76.388">       this._ranges.splice(iTrans, 1);</span>
<a href="#l76.389"></a><span id="l76.389">     }</span>
<a href="#l76.390"></a><span id="l76.390"> </span>
<a href="#l76.391"></a><span id="l76.391">     if (this._tree)</span>
<a href="#l76.392"></a><span id="l76.392">       this._tree.invalidate();</span>
<a href="#l76.393"></a><span id="l76.393">     this.selectEventsSuppressed = saveSuppress;</span>
<a href="#l76.394"></a><span id="l76.394">   },</span>
<a href="#l76.395"></a><span id="l76.395"> </span>
<a href="#l76.396"></a><span id="l76.396" class="difflineat">@@ -572,17 +567,17 @@ JSTreeSelection.prototype = {</span>
<a href="#l76.397"></a><span id="l76.397">       this._fireSelectionChanged();</span>
<a href="#l76.398"></a><span id="l76.398">   },</span>
<a href="#l76.399"></a><span id="l76.399"> </span>
<a href="#l76.400"></a><span id="l76.400">   /**</span>
<a href="#l76.401"></a><span id="l76.401">    * Note that we bypass any XUL &quot;onselect&quot; handler that may exist and go</span>
<a href="#l76.402"></a><span id="l76.402">    *  straight to the view.  If you have a tree, you shouldn't be using us,</span>
<a href="#l76.403"></a><span id="l76.403">    *  so this seems aboot right.</span>
<a href="#l76.404"></a><span id="l76.404">    */</span>
<a href="#l76.405"></a><span id="l76.405" class="difflineminus">-  _fireSelectionChanged: function JSTreeSelection__fireSelectionChanged() {</span>
<a href="#l76.406"></a><span id="l76.406" class="difflineplus">+  _fireSelectionChanged() {</span>
<a href="#l76.407"></a><span id="l76.407">     // don't fire if we are suppressed; we will fire when un-suppressed</span>
<a href="#l76.408"></a><span id="l76.408">     if (this.selectEventsSuppressed)</span>
<a href="#l76.409"></a><span id="l76.409">       return;</span>
<a href="#l76.410"></a><span id="l76.410">     let view;</span>
<a href="#l76.411"></a><span id="l76.411">     if (this._tree &amp;&amp; this._tree.view)</span>
<a href="#l76.412"></a><span id="l76.412">       view = this._tree.view;</span>
<a href="#l76.413"></a><span id="l76.413">     else</span>
<a href="#l76.414"></a><span id="l76.414">       view = this._view;</span>
<a href="#l76.415"></a><span id="l76.415" class="difflineat">@@ -631,17 +626,17 @@ JSTreeSelection.prototype = {</span>
<a href="#l76.416"></a><span id="l76.416">    * when you would like to discard this selection for a real tree selection.</span>
<a href="#l76.417"></a><span id="l76.417">    * We assume that both selections are for the same tree.</span>
<a href="#l76.418"></a><span id="l76.418">    *</span>
<a href="#l76.419"></a><span id="l76.419">    * @note We don't transfer the correct shiftSelectPivot over.</span>
<a href="#l76.420"></a><span id="l76.420">    * @note This will fire a selectionChanged event on the tree view.</span>
<a href="#l76.421"></a><span id="l76.421">    *</span>
<a href="#l76.422"></a><span id="l76.422">    * @param aSelection an nsITreeSelection to duplicate this selection onto</span>
<a href="#l76.423"></a><span id="l76.423">    */</span>
<a href="#l76.424"></a><span id="l76.424" class="difflineminus">-  duplicateSelection: function JSTreeSelection_duplicateSelection(aSelection) {</span>
<a href="#l76.425"></a><span id="l76.425" class="difflineplus">+  duplicateSelection(aSelection) {</span>
<a href="#l76.426"></a><span id="l76.426">     aSelection.selectEventsSuppressed = true;</span>
<a href="#l76.427"></a><span id="l76.427">     aSelection.clearSelection();</span>
<a href="#l76.428"></a><span id="l76.428">     for (let [iTupe, [low, high]] of this._ranges.entries())</span>
<a href="#l76.429"></a><span id="l76.429">       aSelection.rangedSelect(low, high, iTupe &gt; 0);</span>
<a href="#l76.430"></a><span id="l76.430"> </span>
<a href="#l76.431"></a><span id="l76.431">     aSelection.currentIndex = this.currentIndex;</span>
<a href="#l76.432"></a><span id="l76.432">     // This will fire a selectionChanged event</span>
<a href="#l76.433"></a><span id="l76.433">     aSelection.selectEventsSuppressed = false;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1" class="difflineminus">--- a/mailnews/base/util/mailnewsMigrator.js</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineplus">+++ b/mailnews/base/util/mailnewsMigrator.js</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineat">@@ -15,171 +15,170 @@ this.EXPORTED_SYMBOLS = [ &quot;migrateMailne</span>
<a href="#l77.4"></a><span id="l77.4"> var {logException} = ChromeUtils.import(&quot;resource:///modules/errUtils.js&quot;);</span>
<a href="#l77.5"></a><span id="l77.5"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l77.6"></a><span id="l77.6"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l77.7"></a><span id="l77.7"> var kServerPrefVersion = 1;</span>
<a href="#l77.8"></a><span id="l77.8"> var kSmtpPrefVersion = 1;</span>
<a href="#l77.9"></a><span id="l77.9"> var kABRemoteContentPrefVersion = 1;</span>
<a href="#l77.10"></a><span id="l77.10"> var kDefaultCharsetsPrefVersion = 1;</span>
<a href="#l77.11"></a><span id="l77.11"> </span>
<a href="#l77.12"></a><span id="l77.12" class="difflineminus">-function migrateMailnews()</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineminus">-{</span>
<a href="#l77.14"></a><span id="l77.14" class="difflineplus">+function migrateMailnews() {</span>
<a href="#l77.15"></a><span id="l77.15">   try {</span>
<a href="#l77.16"></a><span id="l77.16">     MigrateServerAuthPref();</span>
<a href="#l77.17"></a><span id="l77.17" class="difflineminus">-  } catch (e) { logException(e); }</span>
<a href="#l77.18"></a><span id="l77.18" class="difflineplus">+  } catch (e) {</span>
<a href="#l77.19"></a><span id="l77.19" class="difflineplus">+    logException(e);</span>
<a href="#l77.20"></a><span id="l77.20" class="difflineplus">+  }</span>
<a href="#l77.21"></a><span id="l77.21"> </span>
<a href="#l77.22"></a><span id="l77.22">   try {</span>
<a href="#l77.23"></a><span id="l77.23">     MigrateABRemoteContentSettings();</span>
<a href="#l77.24"></a><span id="l77.24" class="difflineminus">-  } catch (e) { logException(e); }</span>
<a href="#l77.25"></a><span id="l77.25" class="difflineplus">+  } catch (e) {</span>
<a href="#l77.26"></a><span id="l77.26" class="difflineplus">+    logException(e);</span>
<a href="#l77.27"></a><span id="l77.27" class="difflineplus">+  }</span>
<a href="#l77.28"></a><span id="l77.28"> </span>
<a href="#l77.29"></a><span id="l77.29">   try {</span>
<a href="#l77.30"></a><span id="l77.30">     MigrateDefaultCharsets();</span>
<a href="#l77.31"></a><span id="l77.31" class="difflineminus">-  } catch (e) { logException(e); }</span>
<a href="#l77.32"></a><span id="l77.32" class="difflineplus">+  } catch (e) {</span>
<a href="#l77.33"></a><span id="l77.33" class="difflineplus">+    logException(e);</span>
<a href="#l77.34"></a><span id="l77.34" class="difflineplus">+  }</span>
<a href="#l77.35"></a><span id="l77.35"> }</span>
<a href="#l77.36"></a><span id="l77.36"> </span>
<a href="#l77.37"></a><span id="l77.37"> /**</span>
<a href="#l77.38"></a><span id="l77.38">  * Migrates from pref useSecAuth to pref authMethod</span>
<a href="#l77.39"></a><span id="l77.39">  */</span>
<a href="#l77.40"></a><span id="l77.40" class="difflineminus">-function MigrateServerAuthPref()</span>
<a href="#l77.41"></a><span id="l77.41" class="difflineminus">-{</span>
<a href="#l77.42"></a><span id="l77.42" class="difflineplus">+function MigrateServerAuthPref() {</span>
<a href="#l77.43"></a><span id="l77.43">   try {</span>
<a href="#l77.44"></a><span id="l77.44">     // comma-separated list of all accounts.</span>
<a href="#l77.45"></a><span id="l77.45">     var accounts = Services.prefs.getCharPref(&quot;mail.accountmanager.accounts&quot;)</span>
<a href="#l77.46"></a><span id="l77.46">         .split(&quot;,&quot;);</span>
<a href="#l77.47"></a><span id="l77.47" class="difflineminus">-    for (let i = 0; i &lt; accounts.length; i++)</span>
<a href="#l77.48"></a><span id="l77.48" class="difflineminus">-    {</span>
<a href="#l77.49"></a><span id="l77.49" class="difflineplus">+    for (let i = 0; i &lt; accounts.length; i++) {</span>
<a href="#l77.50"></a><span id="l77.50">       let accountKey = accounts[i]; // e.g. &quot;account1&quot;</span>
<a href="#l77.51"></a><span id="l77.51">       if (!accountKey)</span>
<a href="#l77.52"></a><span id="l77.52">         continue;</span>
<a href="#l77.53"></a><span id="l77.53">       let serverKey = Services.prefs.getCharPref(&quot;mail.account.&quot; + accountKey +</span>
<a href="#l77.54"></a><span id="l77.54">          &quot;.server&quot;);</span>
<a href="#l77.55"></a><span id="l77.55">       let server = &quot;mail.server.&quot; + serverKey + &quot;.&quot;;</span>
<a href="#l77.56"></a><span id="l77.56">       if (Services.prefs.prefHasUserValue(server + &quot;authMethod&quot;))</span>
<a href="#l77.57"></a><span id="l77.57">         continue;</span>
<a href="#l77.58"></a><span id="l77.58">       if (!Services.prefs.prefHasUserValue(server + &quot;useSecAuth&quot;) &amp;&amp;</span>
<a href="#l77.59"></a><span id="l77.59">           !Services.prefs.prefHasUserValue(server + &quot;auth_login&quot;))</span>
<a href="#l77.60"></a><span id="l77.60">         continue;</span>
<a href="#l77.61"></a><span id="l77.61">       if (Services.prefs.prefHasUserValue(server + &quot;migrated&quot;))</span>
<a href="#l77.62"></a><span id="l77.62">         continue;</span>
<a href="#l77.63"></a><span id="l77.63">       // auth_login = false =&gt; old-style auth</span>
<a href="#l77.64"></a><span id="l77.64">       // else: useSecAuth = true =&gt; &quot;secure auth&quot;</span>
<a href="#l77.65"></a><span id="l77.65">       // else: cleartext pw</span>
<a href="#l77.66"></a><span id="l77.66" class="difflineminus">-      let auth_login = true;</span>
<a href="#l77.67"></a><span id="l77.67" class="difflineminus">-      let useSecAuth = false; // old default, default pref now removed</span>
<a href="#l77.68"></a><span id="l77.68" class="difflineminus">-      try {</span>
<a href="#l77.69"></a><span id="l77.69" class="difflineminus">-        auth_login = Services.prefs.getBoolPref(server + &quot;auth_login&quot;);</span>
<a href="#l77.70"></a><span id="l77.70" class="difflineminus">-      } catch (e) {}</span>
<a href="#l77.71"></a><span id="l77.71" class="difflineminus">-      try {</span>
<a href="#l77.72"></a><span id="l77.72" class="difflineminus">-        useSecAuth = Services.prefs.getBoolPref(server + &quot;useSecAuth&quot;);</span>
<a href="#l77.73"></a><span id="l77.73" class="difflineminus">-      } catch (e) {}</span>
<a href="#l77.74"></a><span id="l77.74" class="difflineplus">+      let auth_login = Services.prefs.getBoolPref(server + &quot;auth_login&quot;, true);</span>
<a href="#l77.75"></a><span id="l77.75" class="difflineplus">+      // old default, default pref now removed</span>
<a href="#l77.76"></a><span id="l77.76" class="difflineplus">+      let useSecAuth = Services.prefs.getBoolPref(server + &quot;useSecAuth&quot;, false);</span>
<a href="#l77.77"></a><span id="l77.77"> </span>
<a href="#l77.78"></a><span id="l77.78" class="difflineminus">-      Services.prefs.setIntPref(server + &quot;authMethod&quot;,</span>
<a href="#l77.79"></a><span id="l77.79" class="difflineminus">-          auth_login ? (useSecAuth ?</span>
<a href="#l77.80"></a><span id="l77.80" class="difflineminus">-                           Ci.nsMsgAuthMethod.secure :</span>
<a href="#l77.81"></a><span id="l77.81" class="difflineminus">-                           Ci.nsMsgAuthMethod.passwordCleartext) :</span>
<a href="#l77.82"></a><span id="l77.82" class="difflineminus">-                       Ci.nsMsgAuthMethod.old);</span>
<a href="#l77.83"></a><span id="l77.83" class="difflineplus">+      if (auth_login) {</span>
<a href="#l77.84"></a><span id="l77.84" class="difflineplus">+        if (useSecAuth) {</span>
<a href="#l77.85"></a><span id="l77.85" class="difflineplus">+          Services.prefs.setIntPref(server + &quot;authMethod&quot;, Ci.nsMsgAuthMethod.secure);</span>
<a href="#l77.86"></a><span id="l77.86" class="difflineplus">+        } else {</span>
<a href="#l77.87"></a><span id="l77.87" class="difflineplus">+          Services.prefs.setIntPref(server + &quot;authMethod&quot;, Ci.nsMsgAuthMethod.passwordCleartext);</span>
<a href="#l77.88"></a><span id="l77.88" class="difflineplus">+        }</span>
<a href="#l77.89"></a><span id="l77.89" class="difflineplus">+      } else {</span>
<a href="#l77.90"></a><span id="l77.90" class="difflineplus">+        Services.prefs.setIntPref(server + &quot;authMethod&quot;, Ci.nsMsgAuthMethod.old);</span>
<a href="#l77.91"></a><span id="l77.91" class="difflineplus">+      }</span>
<a href="#l77.92"></a><span id="l77.92">       Services.prefs.setIntPref(server + &quot;migrated&quot;, kServerPrefVersion);</span>
<a href="#l77.93"></a><span id="l77.93">     }</span>
<a href="#l77.94"></a><span id="l77.94"> </span>
<a href="#l77.95"></a><span id="l77.95">     // same again for SMTP servers</span>
<a href="#l77.96"></a><span id="l77.96">     var smtpservers = Services.prefs.getCharPref(&quot;mail.smtpservers&quot;).split(&quot;,&quot;);</span>
<a href="#l77.97"></a><span id="l77.97" class="difflineminus">-    for (let i = 0; i &lt; smtpservers.length; i++)</span>
<a href="#l77.98"></a><span id="l77.98" class="difflineminus">-    {</span>
<a href="#l77.99"></a><span id="l77.99" class="difflineplus">+    for (let i = 0; i &lt; smtpservers.length; i++) {</span>
<a href="#l77.100"></a><span id="l77.100">       if (!smtpservers[i])</span>
<a href="#l77.101"></a><span id="l77.101">         continue;</span>
<a href="#l77.102"></a><span id="l77.102">       let server = &quot;mail.smtpserver.&quot; + smtpservers[i] + &quot;.&quot;;</span>
<a href="#l77.103"></a><span id="l77.103">       if (Services.prefs.prefHasUserValue(server + &quot;authMethod&quot;))</span>
<a href="#l77.104"></a><span id="l77.104">         continue;</span>
<a href="#l77.105"></a><span id="l77.105">       if (!Services.prefs.prefHasUserValue(server + &quot;useSecAuth&quot;) &amp;&amp;</span>
<a href="#l77.106"></a><span id="l77.106">           !Services.prefs.prefHasUserValue(server + &quot;auth_method&quot;))</span>
<a href="#l77.107"></a><span id="l77.107">         continue;</span>
<a href="#l77.108"></a><span id="l77.108">       if (Services.prefs.prefHasUserValue(server + &quot;migrated&quot;))</span>
<a href="#l77.109"></a><span id="l77.109">         continue;</span>
<a href="#l77.110"></a><span id="l77.110">       // auth_method = 0 =&gt; no auth</span>
<a href="#l77.111"></a><span id="l77.111">       // else: useSecAuth = true =&gt; &quot;secure auth&quot;</span>
<a href="#l77.112"></a><span id="l77.112">       // else: cleartext pw</span>
<a href="#l77.113"></a><span id="l77.113" class="difflineminus">-      let auth_method = 1;</span>
<a href="#l77.114"></a><span id="l77.114" class="difflineminus">-      let useSecAuth = false;</span>
<a href="#l77.115"></a><span id="l77.115" class="difflineminus">-      try {</span>
<a href="#l77.116"></a><span id="l77.116" class="difflineminus">-        auth_method = Services.prefs.getIntPref(server + &quot;auth_method&quot;);</span>
<a href="#l77.117"></a><span id="l77.117" class="difflineminus">-      } catch (e) {}</span>
<a href="#l77.118"></a><span id="l77.118" class="difflineminus">-      try {</span>
<a href="#l77.119"></a><span id="l77.119" class="difflineminus">-        useSecAuth = Services.prefs.getBoolPref(server + &quot;useSecAuth&quot;);</span>
<a href="#l77.120"></a><span id="l77.120" class="difflineminus">-      } catch (e) {}</span>
<a href="#l77.121"></a><span id="l77.121" class="difflineplus">+      let auth_method = Services.prefs.getIntPref(server + &quot;auth_method&quot;, 1);</span>
<a href="#l77.122"></a><span id="l77.122" class="difflineplus">+      let useSecAuth = Services.prefs.getBoolPref(server + &quot;useSecAuth&quot;, false);</span>
<a href="#l77.123"></a><span id="l77.123"> </span>
<a href="#l77.124"></a><span id="l77.124" class="difflineminus">-      Services.prefs.setIntPref(server + &quot;authMethod&quot;,</span>
<a href="#l77.125"></a><span id="l77.125" class="difflineminus">-          auth_method ? (useSecAuth ?</span>
<a href="#l77.126"></a><span id="l77.126" class="difflineminus">-                            Ci.nsMsgAuthMethod.secure :</span>
<a href="#l77.127"></a><span id="l77.127" class="difflineminus">-                            Ci.nsMsgAuthMethod.passwordCleartext) :</span>
<a href="#l77.128"></a><span id="l77.128" class="difflineminus">-                        Ci.nsMsgAuthMethod.none);</span>
<a href="#l77.129"></a><span id="l77.129" class="difflineplus">+      if (auth_method) {</span>
<a href="#l77.130"></a><span id="l77.130" class="difflineplus">+        if (useSecAuth) {</span>
<a href="#l77.131"></a><span id="l77.131" class="difflineplus">+          Services.prefs.setIntPref(server + &quot;authMethod&quot;, Ci.nsMsgAuthMethod.secure);</span>
<a href="#l77.132"></a><span id="l77.132" class="difflineplus">+        } else {</span>
<a href="#l77.133"></a><span id="l77.133" class="difflineplus">+          Services.prefs.setIntPref(server + &quot;authMethod&quot;, Ci.nsMsgAuthMethod.passwordCleartext);</span>
<a href="#l77.134"></a><span id="l77.134" class="difflineplus">+        }</span>
<a href="#l77.135"></a><span id="l77.135" class="difflineplus">+      } else {</span>
<a href="#l77.136"></a><span id="l77.136" class="difflineplus">+        Services.prefs.setIntPref(server + &quot;authMethod&quot;, Ci.nsMsgAuthMethod.none);</span>
<a href="#l77.137"></a><span id="l77.137" class="difflineplus">+      }</span>
<a href="#l77.138"></a><span id="l77.138">       Services.prefs.setIntPref(server + &quot;migrated&quot;, kSmtpPrefVersion);</span>
<a href="#l77.139"></a><span id="l77.139">     }</span>
<a href="#l77.140"></a><span id="l77.140" class="difflineminus">-  } catch(e) { logException(e); }</span>
<a href="#l77.141"></a><span id="l77.141" class="difflineplus">+  } catch (e) {</span>
<a href="#l77.142"></a><span id="l77.142" class="difflineplus">+    logException(e);</span>
<a href="#l77.143"></a><span id="l77.143" class="difflineplus">+  }</span>
<a href="#l77.144"></a><span id="l77.144"> }</span>
<a href="#l77.145"></a><span id="l77.145"> </span>
<a href="#l77.146"></a><span id="l77.146"> /**</span>
<a href="#l77.147"></a><span id="l77.147">  * The address book used to contain information about whether to allow remote</span>
<a href="#l77.148"></a><span id="l77.148">  * content for a given contact. Now we use the permission manager for that.</span>
<a href="#l77.149"></a><span id="l77.149">  * Do a one-time migration for it.</span>
<a href="#l77.150"></a><span id="l77.150">  */</span>
<a href="#l77.151"></a><span id="l77.151" class="difflineminus">-function MigrateABRemoteContentSettings()</span>
<a href="#l77.152"></a><span id="l77.152" class="difflineminus">-{</span>
<a href="#l77.153"></a><span id="l77.153" class="difflineplus">+function MigrateABRemoteContentSettings() {</span>
<a href="#l77.154"></a><span id="l77.154">   if (Services.prefs.prefHasUserValue(&quot;mail.ab_remote_content.migrated&quot;))</span>
<a href="#l77.155"></a><span id="l77.155">     return;</span>
<a href="#l77.156"></a><span id="l77.156"> </span>
<a href="#l77.157"></a><span id="l77.157">   // Search through all of our local address books looking for a match.</span>
<a href="#l77.158"></a><span id="l77.158">   let enumerator = MailServices.ab.directories;</span>
<a href="#l77.159"></a><span id="l77.159" class="difflineminus">-  while (enumerator.hasMoreElements())</span>
<a href="#l77.160"></a><span id="l77.160" class="difflineminus">-  {</span>
<a href="#l77.161"></a><span id="l77.161" class="difflineplus">+  while (enumerator.hasMoreElements()) {</span>
<a href="#l77.162"></a><span id="l77.162">     let migrateAddress = function(aEmail) {</span>
<a href="#l77.163"></a><span id="l77.163">       let uri = Services.io.newURI(</span>
<a href="#l77.164"></a><span id="l77.164">         &quot;chrome://messenger/content/email=&quot; + aEmail);</span>
<a href="#l77.165"></a><span id="l77.165">       Services.perms.add(uri, &quot;image&quot;, Services.perms.ALLOW_ACTION);</span>
<a href="#l77.166"></a><span id="l77.166" class="difflineminus">-    }</span>
<a href="#l77.167"></a><span id="l77.167" class="difflineplus">+    };</span>
<a href="#l77.168"></a><span id="l77.168"> </span>
<a href="#l77.169"></a><span id="l77.169">     let addrbook = enumerator.getNext()</span>
<a href="#l77.170"></a><span id="l77.170">       .QueryInterface(Ci.nsIAbDirectory);</span>
<a href="#l77.171"></a><span id="l77.171">     try {</span>
<a href="#l77.172"></a><span id="l77.172">       // If it's a read-only book, don't try to find a card as we we could never</span>
<a href="#l77.173"></a><span id="l77.173">       // have set the AllowRemoteContent property.</span>
<a href="#l77.174"></a><span id="l77.174">       if (addrbook.readOnly)</span>
<a href="#l77.175"></a><span id="l77.175">         continue;</span>
<a href="#l77.176"></a><span id="l77.176"> </span>
<a href="#l77.177"></a><span id="l77.177">       let childCards = addrbook.childCards;</span>
<a href="#l77.178"></a><span id="l77.178" class="difflineminus">-      while (childCards.hasMoreElements())</span>
<a href="#l77.179"></a><span id="l77.179" class="difflineminus">-      {</span>
<a href="#l77.180"></a><span id="l77.180" class="difflineplus">+      while (childCards.hasMoreElements()) {</span>
<a href="#l77.181"></a><span id="l77.181">         let card = childCards.getNext()</span>
<a href="#l77.182"></a><span id="l77.182">                              .QueryInterface(Ci.nsIAbCard);</span>
<a href="#l77.183"></a><span id="l77.183"> </span>
<a href="#l77.184"></a><span id="l77.184" class="difflineminus">-        if (card.getProperty(&quot;AllowRemoteContent&quot;, false) == false)</span>
<a href="#l77.185"></a><span id="l77.185" class="difflineplus">+        if (card.getProperty(&quot;AllowRemoteContent&quot;, &quot;0&quot;) == &quot;0&quot;)</span>
<a href="#l77.186"></a><span id="l77.186">           continue; // not allowed for this contact</span>
<a href="#l77.187"></a><span id="l77.187"> </span>
<a href="#l77.188"></a><span id="l77.188">         if (card.primaryEmail)</span>
<a href="#l77.189"></a><span id="l77.189">           migrateAddress(card.primaryEmail);</span>
<a href="#l77.190"></a><span id="l77.190"> </span>
<a href="#l77.191"></a><span id="l77.191">         if (card.getProperty(&quot;SecondEmail&quot;, &quot;&quot;))</span>
<a href="#l77.192"></a><span id="l77.192">           migrateAddress(card.getProperty(&quot;SecondEmail&quot;, &quot;&quot;));</span>
<a href="#l77.193"></a><span id="l77.193">       }</span>
<a href="#l77.194"></a><span id="l77.194" class="difflineminus">-    } catch (e) { logException(e); }</span>
<a href="#l77.195"></a><span id="l77.195" class="difflineplus">+    } catch (e) {</span>
<a href="#l77.196"></a><span id="l77.196" class="difflineplus">+      logException(e);</span>
<a href="#l77.197"></a><span id="l77.197" class="difflineplus">+    }</span>
<a href="#l77.198"></a><span id="l77.198">   }</span>
<a href="#l77.199"></a><span id="l77.199"> </span>
<a href="#l77.200"></a><span id="l77.200">   Services.prefs.setIntPref(&quot;mail.ab_remote_content.migrated&quot;,</span>
<a href="#l77.201"></a><span id="l77.201">                             kABRemoteContentPrefVersion);</span>
<a href="#l77.202"></a><span id="l77.202"> }</span>
<a href="#l77.203"></a><span id="l77.203"> </span>
<a href="#l77.204"></a><span id="l77.204"> /**</span>
<a href="#l77.205"></a><span id="l77.205">  * If the default sending or viewing charset is one that is no longer available,</span>
<a href="#l77.206"></a><span id="l77.206">  * change it back to the default.</span>
<a href="#l77.207"></a><span id="l77.207">  */</span>
<a href="#l77.208"></a><span id="l77.208" class="difflineminus">-function MigrateDefaultCharsets()</span>
<a href="#l77.209"></a><span id="l77.209" class="difflineminus">-{</span>
<a href="#l77.210"></a><span id="l77.210" class="difflineplus">+function MigrateDefaultCharsets() {</span>
<a href="#l77.211"></a><span id="l77.211">   if (Services.prefs.prefHasUserValue(&quot;mail.default_charsets.migrated&quot;))</span>
<a href="#l77.212"></a><span id="l77.212">     return;</span>
<a href="#l77.213"></a><span id="l77.213"> </span>
<a href="#l77.214"></a><span id="l77.214" class="difflineminus">-  let charsetConvertManager = Cc['@mozilla.org/charset-converter-manager;1']</span>
<a href="#l77.215"></a><span id="l77.215" class="difflineplus">+  let charsetConvertManager = Cc[&quot;@mozilla.org/charset-converter-manager;1&quot;]</span>
<a href="#l77.216"></a><span id="l77.216">     .getService(Ci.nsICharsetConverterManager);</span>
<a href="#l77.217"></a><span id="l77.217"> </span>
<a href="#l77.218"></a><span id="l77.218">   let sendCharsetStr = Services.prefs.getComplexValue(</span>
<a href="#l77.219"></a><span id="l77.219">       &quot;mailnews.send_default_charset&quot;,</span>
<a href="#l77.220"></a><span id="l77.220">       Ci.nsIPrefLocalizedString).data;</span>
<a href="#l77.221"></a><span id="l77.221"> </span>
<a href="#l77.222"></a><span id="l77.222">   try {</span>
<a href="#l77.223"></a><span id="l77.223">     charsetConvertManager.getCharsetTitle(sendCharsetStr);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1" class="difflineminus">--- a/mailnews/base/util/msgDBCacheManager.js</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineplus">+++ b/mailnews/base/util/msgDBCacheManager.js</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineat">@@ -16,31 +16,29 @@ var {Log4Moz} = ChromeUtils.import(&quot;reso</span>
<a href="#l78.4"></a><span id="l78.4"> var log = Log4Moz.getConfiguredLogger(&quot;mailnews.database.dbcache&quot;);</span>
<a href="#l78.5"></a><span id="l78.5"> </span>
<a href="#l78.6"></a><span id="l78.6"> /**</span>
<a href="#l78.7"></a><span id="l78.7">  */</span>
<a href="#l78.8"></a><span id="l78.8"> var DBCACHE_INTERVAL_DEFAULT_MS = 60000; // 1 minute</span>
<a href="#l78.9"></a><span id="l78.9"> </span>
<a href="#l78.10"></a><span id="l78.10"> /* :::::::: The Module ::::::::::::::: */</span>
<a href="#l78.11"></a><span id="l78.11"> </span>
<a href="#l78.12"></a><span id="l78.12" class="difflineminus">-var msgDBCacheManager =</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineminus">-{</span>
<a href="#l78.14"></a><span id="l78.14" class="difflineplus">+var msgDBCacheManager = {</span>
<a href="#l78.15"></a><span id="l78.15">   _initialized: false,</span>
<a href="#l78.16"></a><span id="l78.16"> </span>
<a href="#l78.17"></a><span id="l78.17">   _msgDBCacheTimer: null,</span>
<a href="#l78.18"></a><span id="l78.18"> </span>
<a href="#l78.19"></a><span id="l78.19">   _msgDBCacheTimerIntervalMS: DBCACHE_INTERVAL_DEFAULT_MS,</span>
<a href="#l78.20"></a><span id="l78.20"> </span>
<a href="#l78.21"></a><span id="l78.21">   _dbService: null,</span>
<a href="#l78.22"></a><span id="l78.22"> </span>
<a href="#l78.23"></a><span id="l78.23">   /**</span>
<a href="#l78.24"></a><span id="l78.24">    * This is called on startup</span>
<a href="#l78.25"></a><span id="l78.25">    */</span>
<a href="#l78.26"></a><span id="l78.26" class="difflineminus">-  init: function dbcachemgr_init()</span>
<a href="#l78.27"></a><span id="l78.27" class="difflineminus">-  {</span>
<a href="#l78.28"></a><span id="l78.28" class="difflineplus">+  init() {</span>
<a href="#l78.29"></a><span id="l78.29">     if (this._initialized)</span>
<a href="#l78.30"></a><span id="l78.30">       return;</span>
<a href="#l78.31"></a><span id="l78.31"> </span>
<a href="#l78.32"></a><span id="l78.32">     this._dbService = Cc[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l78.33"></a><span id="l78.33">                         .getService(Ci.nsIMsgDBService);</span>
<a href="#l78.34"></a><span id="l78.34"> </span>
<a href="#l78.35"></a><span id="l78.35">     // we listen for &quot;quit-application-granted&quot; instead of</span>
<a href="#l78.36"></a><span id="l78.36">     // &quot;quit-application-requested&quot; because other observers of the</span>
<a href="#l78.37"></a><span id="l78.37" class="difflineat">@@ -49,71 +47,67 @@ var msgDBCacheManager =</span>
<a href="#l78.38"></a><span id="l78.38"> </span>
<a href="#l78.39"></a><span id="l78.39">     this.startPeriodicCheck();</span>
<a href="#l78.40"></a><span id="l78.40"> </span>
<a href="#l78.41"></a><span id="l78.41">     this._initialized = true;</span>
<a href="#l78.42"></a><span id="l78.42">   },</span>
<a href="#l78.43"></a><span id="l78.43"> </span>
<a href="#l78.44"></a><span id="l78.44"> /* ........ Timer Callback ................*/</span>
<a href="#l78.45"></a><span id="l78.45"> </span>
<a href="#l78.46"></a><span id="l78.46" class="difflineminus">-  _dbCacheCheckTimerCallback: function dbCache_CheckTimerCallback()</span>
<a href="#l78.47"></a><span id="l78.47" class="difflineminus">-  {</span>
<a href="#l78.48"></a><span id="l78.48" class="difflineplus">+  _dbCacheCheckTimerCallback() {</span>
<a href="#l78.49"></a><span id="l78.49">     msgDBCacheManager.checkCachedDBs();</span>
<a href="#l78.50"></a><span id="l78.50">   },</span>
<a href="#l78.51"></a><span id="l78.51"> </span>
<a href="#l78.52"></a><span id="l78.52"> /* ........ Observer Notification Handler ................*/</span>
<a href="#l78.53"></a><span id="l78.53"> </span>
<a href="#l78.54"></a><span id="l78.54" class="difflineminus">-  observe: function dbCache_observe(aSubject, aTopic, aData) {</span>
<a href="#l78.55"></a><span id="l78.55" class="difflineplus">+  observe(aSubject, aTopic, aData) {</span>
<a href="#l78.56"></a><span id="l78.56">     switch (aTopic) {</span>
<a href="#l78.57"></a><span id="l78.57">     // This is observed before any windows start unloading if something other</span>
<a href="#l78.58"></a><span id="l78.58">     // than the last 3pane window closing requested the application be</span>
<a href="#l78.59"></a><span id="l78.59">     // shutdown. For example, when the user quits via the file menu.</span>
<a href="#l78.60"></a><span id="l78.60">     case &quot;quit-application-granted&quot;:</span>
<a href="#l78.61"></a><span id="l78.61">       Services.obs.removeObserver(this, &quot;quit-application-granted&quot;);</span>
<a href="#l78.62"></a><span id="l78.62">       this.stopPeriodicCheck();</span>
<a href="#l78.63"></a><span id="l78.63">       break;</span>
<a href="#l78.64"></a><span id="l78.64">     }</span>
<a href="#l78.65"></a><span id="l78.65">   },</span>
<a href="#l78.66"></a><span id="l78.66"> </span>
<a href="#l78.67"></a><span id="l78.67"> /* ........ Public API ................*/</span>
<a href="#l78.68"></a><span id="l78.68"> </span>
<a href="#l78.69"></a><span id="l78.69">   /**</span>
<a href="#l78.70"></a><span id="l78.70">    * Stops db cache check</span>
<a href="#l78.71"></a><span id="l78.71">    */</span>
<a href="#l78.72"></a><span id="l78.72" class="difflineminus">-  stopPeriodicCheck: function dbcache_stopPeriodicCheck()</span>
<a href="#l78.73"></a><span id="l78.73" class="difflineminus">-  {</span>
<a href="#l78.74"></a><span id="l78.74" class="difflineplus">+  stopPeriodicCheck() {</span>
<a href="#l78.75"></a><span id="l78.75">     if (this._dbCacheCheckTimer) {</span>
<a href="#l78.76"></a><span id="l78.76">       this._dbCacheCheckTimer.cancel();</span>
<a href="#l78.77"></a><span id="l78.77"> </span>
<a href="#l78.78"></a><span id="l78.78">       delete this._dbCacheCheckTimer;</span>
<a href="#l78.79"></a><span id="l78.79">       this._dbCacheCheckTimer = null;</span>
<a href="#l78.80"></a><span id="l78.80">     }</span>
<a href="#l78.81"></a><span id="l78.81">   },</span>
<a href="#l78.82"></a><span id="l78.82"> </span>
<a href="#l78.83"></a><span id="l78.83">   /**</span>
<a href="#l78.84"></a><span id="l78.84">    * Starts periodic db cache check</span>
<a href="#l78.85"></a><span id="l78.85">    */</span>
<a href="#l78.86"></a><span id="l78.86" class="difflineminus">-  startPeriodicCheck: function dbcache_startPeriodicCheck()</span>
<a href="#l78.87"></a><span id="l78.87" class="difflineminus">-  {</span>
<a href="#l78.88"></a><span id="l78.88" class="difflineplus">+  startPeriodicCheck() {</span>
<a href="#l78.89"></a><span id="l78.89">     if (!this._dbCacheCheckTimer) {</span>
<a href="#l78.90"></a><span id="l78.90">       this._dbCacheCheckTimer = Cc[&quot;@mozilla.org/timer;1&quot;]</span>
<a href="#l78.91"></a><span id="l78.91">                                    .createInstance(Ci.nsITimer);</span>
<a href="#l78.92"></a><span id="l78.92"> </span>
<a href="#l78.93"></a><span id="l78.93">       this._dbCacheCheckTimer.initWithCallback(</span>
<a href="#l78.94"></a><span id="l78.94">                                    this._dbCacheCheckTimerCallback,</span>
<a href="#l78.95"></a><span id="l78.95">                                    this._msgDBCacheTimerIntervalMS,</span>
<a href="#l78.96"></a><span id="l78.96">                                    Ci.nsITimer.TYPE_REPEATING_SLACK);</span>
<a href="#l78.97"></a><span id="l78.97">     }</span>
<a href="#l78.98"></a><span id="l78.98">   },</span>
<a href="#l78.99"></a><span id="l78.99"> </span>
<a href="#l78.100"></a><span id="l78.100">   /**</span>
<a href="#l78.101"></a><span id="l78.101">    * Checks if any DBs need to be closed due to inactivity or too many of them open.</span>
<a href="#l78.102"></a><span id="l78.102">    */</span>
<a href="#l78.103"></a><span id="l78.103" class="difflineminus">-  checkCachedDBs: function()</span>
<a href="#l78.104"></a><span id="l78.104" class="difflineminus">-  {</span>
<a href="#l78.105"></a><span id="l78.105" class="difflineplus">+  checkCachedDBs() {</span>
<a href="#l78.106"></a><span id="l78.106">     let idleLimit = Services.prefs.getIntPref(&quot;mail.db.idle_limit&quot;);</span>
<a href="#l78.107"></a><span id="l78.107">     let maxOpenDBs = Services.prefs.getIntPref(&quot;mail.db.max_open&quot;);</span>
<a href="#l78.108"></a><span id="l78.108"> </span>
<a href="#l78.109"></a><span id="l78.109">     // db.lastUseTime below is in microseconds while Date.now and idleLimit pref</span>
<a href="#l78.110"></a><span id="l78.110">     // is in milliseconds.</span>
<a href="#l78.111"></a><span id="l78.111">     let closeThreshold = (Date.now() - idleLimit) * 1000;</span>
<a href="#l78.112"></a><span id="l78.112">     let cachedDBs = this._dbService.openDBs;</span>
<a href="#l78.113"></a><span id="l78.113">     log.info(&quot;Periodic check of cached folder databases (DBs), count=&quot; + cachedDBs.length);</span>
<a href="#l78.114"></a><span id="l78.114" class="difflineat">@@ -133,18 +127,17 @@ var msgDBCacheManager =</span>
<a href="#l78.115"></a><span id="l78.115"> </span>
<a href="#l78.116"></a><span id="l78.116">       if (MailServices.mailSession.IsFolderOpenInWindow(db.folder)) {</span>
<a href="#l78.117"></a><span id="l78.117">         // The folder is open in a window so this DB must not be closed.</span>
<a href="#l78.118"></a><span id="l78.118">         log.debug(&quot;Skipping, DB open in window for folder: &quot; + db.folder.name);</span>
<a href="#l78.119"></a><span id="l78.119">         numOpenInWindow++;</span>
<a href="#l78.120"></a><span id="l78.120">         continue;</span>
<a href="#l78.121"></a><span id="l78.121">       }</span>
<a href="#l78.122"></a><span id="l78.122"> </span>
<a href="#l78.123"></a><span id="l78.123" class="difflineminus">-      if (db.lastUseTime &lt; closeThreshold)</span>
<a href="#l78.124"></a><span id="l78.124" class="difflineminus">-      {</span>
<a href="#l78.125"></a><span id="l78.125" class="difflineplus">+      if (db.lastUseTime &lt; closeThreshold) {</span>
<a href="#l78.126"></a><span id="l78.126">         // DB open too log without activity.</span>
<a href="#l78.127"></a><span id="l78.127">         log.debug(&quot;Closing expired DB for folder: &quot; + db.folder.name);</span>
<a href="#l78.128"></a><span id="l78.128">         db.folder.msgDatabase = null;</span>
<a href="#l78.129"></a><span id="l78.129">         numClosing++;</span>
<a href="#l78.130"></a><span id="l78.130">         continue;</span>
<a href="#l78.131"></a><span id="l78.131">       }</span>
<a href="#l78.132"></a><span id="l78.132"> </span>
<a href="#l78.133"></a><span id="l78.133">       // Database eligible for closing.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/mailnews/base/util/templateUtils.js</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/mailnews/base/util/templateUtils.js</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -8,23 +8,23 @@ var {PluralForm} = ChromeUtils.import(&quot;r</span>
<a href="#l79.4"></a><span id="l79.4"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l79.5"></a><span id="l79.5"> var {StringBundle} = ChromeUtils.import(&quot;resource:///modules/StringBundle.js&quot;);</span>
<a href="#l79.6"></a><span id="l79.6"> </span>
<a href="#l79.7"></a><span id="l79.7"> function PluralStringFormatter(aBundleURI) {</span>
<a href="#l79.8"></a><span id="l79.8">   this._bundle = new StringBundle(aBundleURI);</span>
<a href="#l79.9"></a><span id="l79.9"> }</span>
<a href="#l79.10"></a><span id="l79.10"> </span>
<a href="#l79.11"></a><span id="l79.11"> PluralStringFormatter.prototype = {</span>
<a href="#l79.12"></a><span id="l79.12" class="difflineminus">-  get: function(aStringName, aReplacements, aPluralCount) {</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineplus">+  get(aStringName, aReplacements, aPluralCount) {</span>
<a href="#l79.14"></a><span id="l79.14">     let str = this._bundle.get(aStringName);</span>
<a href="#l79.15"></a><span id="l79.15">     if (aPluralCount !== undefined)</span>
<a href="#l79.16"></a><span id="l79.16">       str = PluralForm.get(aPluralCount, str);</span>
<a href="#l79.17"></a><span id="l79.17">     if (aReplacements !== undefined) {</span>
<a href="#l79.18"></a><span id="l79.18">       for (let i = 0; i &lt; aReplacements.length; i++)</span>
<a href="#l79.19"></a><span id="l79.19" class="difflineminus">-        str = str.replace(&quot;#&quot; + (i+1), aReplacements[i]);</span>
<a href="#l79.20"></a><span id="l79.20" class="difflineplus">+        str = str.replace(&quot;#&quot; + (i + 1), aReplacements[i]);</span>
<a href="#l79.21"></a><span id="l79.21">     }</span>
<a href="#l79.22"></a><span id="l79.22">     return str;</span>
<a href="#l79.23"></a><span id="l79.23">   },</span>
<a href="#l79.24"></a><span id="l79.24"> };</span>
<a href="#l79.25"></a><span id="l79.25"> </span>
<a href="#l79.26"></a><span id="l79.26"> </span>
<a href="#l79.27"></a><span id="l79.27"> var gTemplateUtilsStrings = new PluralStringFormatter(</span>
<a href="#l79.28"></a><span id="l79.28">   &quot;chrome://messenger/locale/templateUtils.properties&quot;</span>
<a href="#l79.29"></a><span id="l79.29" class="difflineat">@@ -46,18 +46,17 @@ const _weekdayFormatter = new Services.i</span>
<a href="#l79.30"></a><span id="l79.30">  * &quot;yesterday&quot; (localized).  If it's in the last week, it returns the day</span>
<a href="#l79.31"></a><span id="l79.31">  * of the week. If it's before that, it returns the date.</span>
<a href="#l79.32"></a><span id="l79.32">  *</span>
<a href="#l79.33"></a><span id="l79.33">  * @param time {Date}</span>
<a href="#l79.34"></a><span id="l79.34">  *        the time (better be in the past!)</span>
<a href="#l79.35"></a><span id="l79.35">  * @return {string}  A &quot;human-friendly&quot; representation of that time</span>
<a href="#l79.36"></a><span id="l79.36">  *                   relative to now.</span>
<a href="#l79.37"></a><span id="l79.37">  */</span>
<a href="#l79.38"></a><span id="l79.38" class="difflineminus">-function makeFriendlyDateAgo(time)</span>
<a href="#l79.39"></a><span id="l79.39" class="difflineminus">-{</span>
<a href="#l79.40"></a><span id="l79.40" class="difflineplus">+function makeFriendlyDateAgo(time) {</span>
<a href="#l79.41"></a><span id="l79.41">   // Figure out when today begins</span>
<a href="#l79.42"></a><span id="l79.42">   let now = new Date();</span>
<a href="#l79.43"></a><span id="l79.43">   let today = new Date(now.getFullYear(), now.getMonth(),</span>
<a href="#l79.44"></a><span id="l79.44">                        now.getDate());</span>
<a href="#l79.45"></a><span id="l79.45"> </span>
<a href="#l79.46"></a><span id="l79.46">   // Get the end time to display</span>
<a href="#l79.47"></a><span id="l79.47">   let end = time;</span>
<a href="#l79.48"></a><span id="l79.48"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/mailnews/base/util/traceHelper.js</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/mailnews/base/util/traceHelper.js</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -1,13 +1,13 @@</span>
<a href="#l80.4"></a><span id="l80.4"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l80.5"></a><span id="l80.5">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l80.6"></a><span id="l80.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l80.7"></a><span id="l80.7"> </span>
<a href="#l80.8"></a><span id="l80.8" class="difflineminus">-this.EXPORTED_SYMBOLS = ['DebugTraceHelper'];</span>
<a href="#l80.9"></a><span id="l80.9" class="difflineplus">+this.EXPORTED_SYMBOLS = [&quot;DebugTraceHelper&quot;];</span>
<a href="#l80.10"></a><span id="l80.10"> </span>
<a href="#l80.11"></a><span id="l80.11"> var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l80.12"></a><span id="l80.12"> </span>
<a href="#l80.13"></a><span id="l80.13"> var SPACES = &quot;                                                   &quot;;</span>
<a href="#l80.14"></a><span id="l80.14"> var BRIGHT_COLORS = {</span>
<a href="#l80.15"></a><span id="l80.15">   red: &quot;\x1b[1;31m&quot;,</span>
<a href="#l80.16"></a><span id="l80.16">   green: &quot;\x1b[1;32m&quot;,</span>
<a href="#l80.17"></a><span id="l80.17">   yellow: &quot;\x1b[1;33m&quot;,</span>
<a href="#l80.18"></a><span id="l80.18" class="difflineat">@@ -42,17 +42,17 @@ var STOP_COLORS = &quot;\x1b[0m&quot;;</span>
<a href="#l80.19"></a><span id="l80.19">  * DebugTraceHelper.tracify(StandaloneMessageDisplayWidget.prototype,</span>
<a href="#l80.20"></a><span id="l80.20">  *                          &quot;StandaloneMessageDisplayWidget&quot;, /.+/, debugContext);</span>
<a href="#l80.21"></a><span id="l80.21">  * DebugTraceHelper.tracify(DBViewWrapper.prototype,</span>
<a href="#l80.22"></a><span id="l80.22">  *                          &quot;DBViewWrapper&quot;, /.+/, {color: &quot;green&quot;});</span>
<a href="#l80.23"></a><span id="l80.23">  * DebugTraceHelper.tracify(JSTreeSelection.prototype,</span>
<a href="#l80.24"></a><span id="l80.24">  *                          &quot;JSTreeSelection&quot;, /.+/, {color: &quot;yellow&quot;});</span>
<a href="#l80.25"></a><span id="l80.25">  */</span>
<a href="#l80.26"></a><span id="l80.26"> var DebugTraceHelper = {</span>
<a href="#l80.27"></a><span id="l80.27" class="difflineminus">-  tracify: function(aObj, aDesc, aPat, aContext, aSettings) {</span>
<a href="#l80.28"></a><span id="l80.28" class="difflineplus">+  tracify(aObj, aDesc, aPat, aContext, aSettings) {</span>
<a href="#l80.29"></a><span id="l80.29">     aContext.depth = 0;</span>
<a href="#l80.30"></a><span id="l80.30">     let color = aSettings.color || &quot;cyan&quot;;</span>
<a href="#l80.31"></a><span id="l80.31">     aSettings.introCode = BRIGHT_COLORS[color];</span>
<a href="#l80.32"></a><span id="l80.32">     aSettings.outroCode = DARK_COLORS[color];</span>
<a href="#l80.33"></a><span id="l80.33">     for (let key in aObj) {</span>
<a href="#l80.34"></a><span id="l80.34">       if (aPat.test(key)) {</span>
<a href="#l80.35"></a><span id="l80.35">         // ignore properties!</span>
<a href="#l80.36"></a><span id="l80.36">         if (aObj.__lookupGetter__(key) || aObj.__lookupSetter__(key))</span>
<a href="#l80.37"></a><span id="l80.37" class="difflineat">@@ -63,45 +63,43 @@ var DebugTraceHelper = {</span>
<a href="#l80.38"></a><span id="l80.38">         let name = key;</span>
<a href="#l80.39"></a><span id="l80.39">         let prev = aObj[name];</span>
<a href="#l80.40"></a><span id="l80.40">         aObj[name] = function(...aArgs) {</span>
<a href="#l80.41"></a><span id="l80.41">           let argstr = &quot;&quot;;</span>
<a href="#l80.42"></a><span id="l80.42">           for (let arg of aArgs) {</span>
<a href="#l80.43"></a><span id="l80.43">             if (arg == null)</span>
<a href="#l80.44"></a><span id="l80.44">               argstr += &quot; null&quot;;</span>
<a href="#l80.45"></a><span id="l80.45">             else if (typeof(arg) == &quot;function&quot;)</span>
<a href="#l80.46"></a><span id="l80.46" class="difflineminus">-              argstr += &quot; function &quot;+ arg.name;</span>
<a href="#l80.47"></a><span id="l80.47" class="difflineplus">+              argstr += &quot; function &quot; + arg.name;</span>
<a href="#l80.48"></a><span id="l80.48">             else</span>
<a href="#l80.49"></a><span id="l80.49">               argstr += &quot; &quot; + arg.toString();</span>
<a href="#l80.50"></a><span id="l80.50">           }</span>
<a href="#l80.51"></a><span id="l80.51"> </span>
<a href="#l80.52"></a><span id="l80.52">           let indent = SPACES.substr(0, aContext.depth++ * 2);</span>
<a href="#l80.53"></a><span id="l80.53">           dump(indent + &quot;--&gt; &quot; + aSettings.introCode + aDesc + &quot;::&quot; + name +</span>
<a href="#l80.54"></a><span id="l80.54">                &quot;:&quot; + argstr +</span>
<a href="#l80.55"></a><span id="l80.55">                STOP_COLORS + &quot;\n&quot;);</span>
<a href="#l80.56"></a><span id="l80.56">           let ret;</span>
<a href="#l80.57"></a><span id="l80.57">           try {</span>
<a href="#l80.58"></a><span id="l80.58">             ret = prev.apply(this, aArgs);</span>
<a href="#l80.59"></a><span id="l80.59" class="difflineminus">-          }</span>
<a href="#l80.60"></a><span id="l80.60" class="difflineminus">-          catch (ex) {</span>
<a href="#l80.61"></a><span id="l80.61" class="difflineplus">+          } catch (ex) {</span>
<a href="#l80.62"></a><span id="l80.62">             if (ex.stack) {</span>
<a href="#l80.63"></a><span id="l80.63">               dump(BRIGHT_COLORS.red + &quot;Exception: &quot; + ex + &quot;\n  &quot; +</span>
<a href="#l80.64"></a><span id="l80.64">                    ex.stack.replace(&quot;\n&quot;, &quot;\n  &quot;) + STOP_COLORS + &quot;\n&quot;);</span>
<a href="#l80.65"></a><span id="l80.65" class="difflineminus">-            }</span>
<a href="#l80.66"></a><span id="l80.66" class="difflineminus">-            else {</span>
<a href="#l80.67"></a><span id="l80.67" class="difflineplus">+            } else {</span>
<a href="#l80.68"></a><span id="l80.68">               dump(BRIGHT_COLORS.red + &quot;Exception: &quot; + ex.fileName + &quot;:&quot; +</span>
<a href="#l80.69"></a><span id="l80.69">                    ex.lineNumber + &quot;: &quot; + ex + STOP_COLORS + &quot;\n&quot;);</span>
<a href="#l80.70"></a><span id="l80.70">             }</span>
<a href="#l80.71"></a><span id="l80.71">             aContext.depth--;</span>
<a href="#l80.72"></a><span id="l80.72">             dump(indent + &quot;&lt;-- &quot; + aSettings.outroCode + aDesc + &quot;::&quot; + name +</span>
<a href="#l80.73"></a><span id="l80.73">                  STOP_COLORS + &quot;\n&quot;);</span>
<a href="#l80.74"></a><span id="l80.74">             throw ex;</span>
<a href="#l80.75"></a><span id="l80.75">           }</span>
<a href="#l80.76"></a><span id="l80.76">           aContext.depth--;</span>
<a href="#l80.77"></a><span id="l80.77">           dump(indent + &quot;&lt;-- &quot; + aSettings.outroCode + aDesc + &quot;::&quot; + name +</span>
<a href="#l80.78"></a><span id="l80.78">                &quot;: &quot; + (ret != null ? ret.toString() : &quot;null&quot;) +</span>
<a href="#l80.79"></a><span id="l80.79">                STOP_COLORS + &quot;\n&quot;);</span>
<a href="#l80.80"></a><span id="l80.80">           return ret;</span>
<a href="#l80.81"></a><span id="l80.81">         };</span>
<a href="#l80.82"></a><span id="l80.82">       }</span>
<a href="#l80.83"></a><span id="l80.83">     }</span>
<a href="#l80.84"></a><span id="l80.84" class="difflineminus">-  }</span>
<a href="#l80.85"></a><span id="l80.85" class="difflineplus">+  },</span>
<a href="#l80.86"></a><span id="l80.86"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/mailnews/jar.mn</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/mailnews/jar.mn</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -14,17 +14,19 @@ messenger.jar:</span>
<a href="#l81.4"></a><span id="l81.4">     content/messenger/addressbook/abDragDrop.js                                (addrbook/content/abDragDrop.js)</span>
<a href="#l81.5"></a><span id="l81.5">     content/messenger/addressbook/abMailListDialog.js                          (addrbook/content/abMailListDialog.js)</span>
<a href="#l81.6"></a><span id="l81.6">     content/messenger/addressbook/map-list.js                                  (addrbook/content/map-list.js)</span>
<a href="#l81.7"></a><span id="l81.7">     content/messagebody/addressbook/print.css                                  (addrbook/content/print.css)</span>
<a href="#l81.8"></a><span id="l81.8"> *   content/messenger/AccountManager.xul                                       (base/prefs/content/AccountManager.xul)</span>
<a href="#l81.9"></a><span id="l81.9">     content/messenger/AccountManager.js                                        (base/prefs/content/AccountManager.js)</span>
<a href="#l81.10"></a><span id="l81.10">     content/messenger/am-main.xul                                              (base/prefs/content/am-main.xul)</span>
<a href="#l81.11"></a><span id="l81.11">     content/messenger/am-main.js                                               (base/prefs/content/am-main.js)</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineplus">+#ifdef MOZ_SUITE</span>
<a href="#l81.13"></a><span id="l81.13">     content/messenger/am-help.js                                               (base/prefs/content/am-help.js)</span>
<a href="#l81.14"></a><span id="l81.14" class="difflineplus">+#endif</span>
<a href="#l81.15"></a><span id="l81.15">     content/messenger/am-server.xul                                            (base/prefs/content/am-server.xul)</span>
<a href="#l81.16"></a><span id="l81.16">     content/messenger/am-serverwithnoidentities.xul                            (base/prefs/content/am-serverwithnoidentities.xul)</span>
<a href="#l81.17"></a><span id="l81.17">     content/messenger/am-serverwithnoidentities.js                             (base/prefs/content/am-serverwithnoidentities.js)</span>
<a href="#l81.18"></a><span id="l81.18">     content/messenger/am-server.js                                             (base/prefs/content/am-server.js)</span>
<a href="#l81.19"></a><span id="l81.19"> *   content/messenger/am-copies.xul                                            (base/prefs/content/am-copies.xul)</span>
<a href="#l81.20"></a><span id="l81.20">     content/messenger/am-copies.js                                             (base/prefs/content/am-copies.js)</span>
<a href="#l81.21"></a><span id="l81.21">     content/messenger/am-junk.xul                                              (base/prefs/content/am-junk.xul)</span>
<a href="#l81.22"></a><span id="l81.22">     content/messenger/am-junk.js                                               (base/prefs/content/am-junk.js)</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

