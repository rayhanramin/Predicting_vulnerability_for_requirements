<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 12586:ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088" />
<meta property="og:url" content="/comm-central/rev/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088" />
<meta property="og:description" content="Bug 616222 - Make nsMsgAttachmentHandler ref-countable. r=m_kato" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088">shortlog</a> |
<a href="/comm-central/log/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088">files</a> |
changeset |
<a href="/comm-central/raw-rev/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088">raw</a>  | <a href="/comm-central/archive/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=616222">Bug 616222</a> - Make nsMsgAttachmentHandler ref-countable. r=m_kato
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#72;&#105;&#114;&#111;&#121;&#117;&#107;&#105;&#32;&#73;&#107;&#101;&#122;&#111;&#101;&#32;&#60;&#104;&#105;&#105;&#107;&#101;&#122;&#111;&#101;&#64;&#109;&#111;&#122;&#105;&#108;&#108;&#97;&#45;&#106;&#97;&#112;&#97;&#110;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 18 Jun 2013 11:24:14 -0400</td></tr>

<tr>
 <td>changeset 12586</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088">ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088</a></td>
</tr>



<tr>
<td>parent 12585</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/23f007e3461dc1ecf1e085266970ea78ef61f3d0">23f007e3461dc1ecf1e085266970ea78ef61f3d0</a>
</td>
</tr>

<tr>
<td>child 12587</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/2e455a3aafa8e3cca758c78141c45d8ba57f4f5f">2e455a3aafa8e3cca758c78141c45d8ba57f4f5f</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088">9254</a></td></tr>
<tr><td>push user</td><td>ryanvm@gmail.com</td></tr>
<tr><td>push date</td><td class="date age">Tue, 18 Jun 2013 15:25:05 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@2e455a3aafa8 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2e455a3aafa8e3cca758c78141c45d8ba57f4f5f">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=2e455a3aafa8e3cca758c78141c45d8ba57f4f5f&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2e455a3aafa8e3cca758c78141c45d8ba57f4f5f&newProject=comm-central&newRevision=4590ee122e963168ecf22e9192faa5505a321747&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2e455a3aafa8e3cca758c78141c45d8ba57f4f5f&newProject=comm-central&newRevision=4590ee122e963168ecf22e9192faa5505a321747&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=2e455a3aafa8e3cca758c78141c45d8ba57f4f5f&newProject=comm-central&newRevision=4590ee122e963168ecf22e9192faa5505a321747&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28m_kato%29&revcount=50">m_kato</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=616222">616222</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=616222">Bug 616222</a> - Make nsMsgAttachmentHandler ref-countable. r=m_kato</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/public/nsIMsgSend.idl">mailnews/compose/public/nsIMsgSend.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/public/nsIMsgSend.idl">file</a> |
<a href="/comm-central/annotate/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/public/nsIMsgSend.idl">annotate</a> |
<a href="/comm-central/diff/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/public/nsIMsgSend.idl">diff</a> |
<a href="/comm-central/comparison/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/public/nsIMsgSend.idl">comparison</a> |
<a href="/comm-central/log/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/public/nsIMsgSend.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/public/nsIURLFetcher.idl">mailnews/compose/public/nsIURLFetcher.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/public/nsIURLFetcher.idl">file</a> |
<a href="/comm-central/annotate/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/public/nsIURLFetcher.idl">annotate</a> |
<a href="/comm-central/diff/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/public/nsIURLFetcher.idl">diff</a> |
<a href="/comm-central/comparison/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/public/nsIURLFetcher.idl">comparison</a> |
<a href="/comm-central/log/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/public/nsIURLFetcher.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgAttachmentHandler.cpp">mailnews/compose/src/nsMsgAttachmentHandler.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgAttachmentHandler.cpp">file</a> |
<a href="/comm-central/annotate/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgAttachmentHandler.cpp">annotate</a> |
<a href="/comm-central/diff/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgAttachmentHandler.cpp">diff</a> |
<a href="/comm-central/comparison/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgAttachmentHandler.cpp">comparison</a> |
<a href="/comm-central/log/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgAttachmentHandler.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgAttachmentHandler.h">mailnews/compose/src/nsMsgAttachmentHandler.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgAttachmentHandler.h">file</a> |
<a href="/comm-central/annotate/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgAttachmentHandler.h">annotate</a> |
<a href="/comm-central/diff/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgAttachmentHandler.h">diff</a> |
<a href="/comm-central/comparison/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgAttachmentHandler.h">comparison</a> |
<a href="/comm-central/log/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgAttachmentHandler.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgSend.cpp">mailnews/compose/src/nsMsgSend.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgSend.cpp">file</a> |
<a href="/comm-central/annotate/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgSend.cpp">annotate</a> |
<a href="/comm-central/diff/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgSend.cpp">diff</a> |
<a href="/comm-central/comparison/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgSend.cpp">comparison</a> |
<a href="/comm-central/log/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgSend.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgSend.h">mailnews/compose/src/nsMsgSend.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgSend.h">file</a> |
<a href="/comm-central/annotate/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgSend.h">annotate</a> |
<a href="/comm-central/diff/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgSend.h">diff</a> |
<a href="/comm-central/comparison/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgSend.h">comparison</a> |
<a href="/comm-central/log/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsMsgSend.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsURLFetcher.cpp">mailnews/compose/src/nsURLFetcher.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsURLFetcher.cpp">file</a> |
<a href="/comm-central/annotate/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsURLFetcher.cpp">annotate</a> |
<a href="/comm-central/diff/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsURLFetcher.cpp">diff</a> |
<a href="/comm-central/comparison/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsURLFetcher.cpp">comparison</a> |
<a href="/comm-central/log/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsURLFetcher.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsURLFetcher.h">mailnews/compose/src/nsURLFetcher.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsURLFetcher.h">file</a> |
<a href="/comm-central/annotate/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsURLFetcher.h">annotate</a> |
<a href="/comm-central/diff/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsURLFetcher.h">diff</a> |
<a href="/comm-central/comparison/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsURLFetcher.h">comparison</a> |
<a href="/comm-central/log/ec86e36132dc50f6d14a8eefb4ce20a0d4dcd088/mailnews/compose/src/nsURLFetcher.h">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/compose/public/nsIMsgSend.idl</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/compose/public/nsIMsgSend.idl</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -140,22 +140,24 @@ interface nsIMsgEmbeddedImageData : nsIS</span>
<a href="#l1.4"></a><span id="l1.4">   attribute nsIURI uri;</span>
<a href="#l1.5"></a><span id="l1.5">   attribute ACString cid;</span>
<a href="#l1.6"></a><span id="l1.6">   attribute ACString name;</span>
<a href="#l1.7"></a><span id="l1.7"> };</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9"> %{ C++</span>
<a href="#l1.10"></a><span id="l1.10"> // Forward declaration</span>
<a href="#l1.11"></a><span id="l1.11"> class nsMsgAttachmentHandler;</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+#include &quot;nsTArray.h&quot;</span>
<a href="#l1.14"></a><span id="l1.14"> %}</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16" class="difflineminus">-[ptr] native nsMsgAttachmentHandler(nsMsgAttachmentHandler);</span>
<a href="#l1.17"></a><span id="l1.17"> [ptr] native nsMsgAttachedFile(nsMsgAttachedFile);</span>
<a href="#l1.18"></a><span id="l1.18" class="difflineplus">+[ptr] native nsMsgAttachmentHandlerArray(nsTArray&lt;nsRefPtr&lt;nsMsgAttachmentHandler&gt;&gt;);</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-[scriptable, uuid(bf4ed5b0-9560-11e2-9e96-0800200c9a66)]</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+[scriptable, uuid(648f8e40-3977-4dd8-88f1-b932bc654aef)]</span>
<a href="#l1.22"></a><span id="l1.22"> interface nsIMsgSend : nsISupports</span>
<a href="#l1.23"></a><span id="l1.23"> {</span>
<a href="#l1.24"></a><span id="l1.24">   //</span>
<a href="#l1.25"></a><span id="l1.25">   // This is the primary interface for creating and sending RFC822 messages</span>
<a href="#l1.26"></a><span id="l1.26">   // in the new architecture. Currently, this method supports many arguments</span>
<a href="#l1.27"></a><span id="l1.27">   // that change the behavior of the operation. This will change in time to </span>
<a href="#l1.28"></a><span id="l1.28">   // be separate calls that will be more singluar in nature.</span>
<a href="#l1.29"></a><span id="l1.29">   //</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineat">@@ -349,17 +351,17 @@ interface nsIMsgSend : nsISupports</span>
<a href="#l1.31"></a><span id="l1.31"> </span>
<a href="#l1.32"></a><span id="l1.32">     attribute nsMsgKey messageKey;</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34">     nsIPrompt getDefaultPrompt();</span>
<a href="#l1.35"></a><span id="l1.35"> </span>
<a href="#l1.36"></a><span id="l1.36">     /* process attachment */</span>
<a href="#l1.37"></a><span id="l1.37">     void gatherMimeAttachments();</span>
<a href="#l1.38"></a><span id="l1.38">     readonly attribute boolean processAttachmentsSynchronously;</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-    [noscript] nsMsgAttachmentHandler getAttachmentHandlers();</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+    [noscript] nsMsgAttachmentHandlerArray getAttachmentHandlers();</span>
<a href="#l1.41"></a><span id="l1.41">     readonly attribute unsigned long attachmentCount;</span>
<a href="#l1.42"></a><span id="l1.42">     attribute unsigned long pendingAttachmentCount;</span>
<a href="#l1.43"></a><span id="l1.43">     readonly attribute nsMsgDeliverMode deliveryMode;</span>
<a href="#l1.44"></a><span id="l1.44"> </span>
<a href="#l1.45"></a><span id="l1.45">     nsIMsgProgress getProgress();</span>
<a href="#l1.46"></a><span id="l1.46"> </span>
<a href="#l1.47"></a><span id="l1.47">     nsIOutputStream getOutputStream();</span>
<a href="#l1.48"></a><span id="l1.48"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/compose/public/nsIURLFetcher.idl</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/compose/public/nsIURLFetcher.idl</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -15,22 +15,24 @@</span>
<a href="#l2.4"></a><span id="l2.4"> //</span>
<a href="#l2.5"></a><span id="l2.5"> // For completion of send/message creation operations...</span>
<a href="#l2.6"></a><span id="l2.6"> typedef nsresult (*nsAttachSaveCompletionCallback) (nsresult aStatus,</span>
<a href="#l2.7"></a><span id="l2.7">                                                     const nsACString &amp;aContentType,</span>
<a href="#l2.8"></a><span id="l2.8">                                                     const nsACString &amp;aCharset,</span>
<a href="#l2.9"></a><span id="l2.9">                                                     int32_t totalSize, const PRUnichar* aMsg, </span>
<a href="#l2.10"></a><span id="l2.10">                                                     void *tagData);</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+class nsMsgAttachmentHandler;</span>
<a href="#l2.13"></a><span id="l2.13"> %}</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> native nsAttachSaveCompletionCallback(nsAttachSaveCompletionCallback);</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+[ptr] native nsMsgAttachmentHandler(nsMsgAttachmentHandler);</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19" class="difflineminus">-[noscript, uuid(4f3ad52d-888d-487d-961c-9c727c35434c)]</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+[noscript, uuid(7316af6b-050d-4697-9d39-b0b358514f5c)]</span>
<a href="#l2.21"></a><span id="l2.21"> interface nsIURLFetcher : nsISupports</span>
<a href="#l2.22"></a><span id="l2.22"> {</span>
<a href="#l2.23"></a><span id="l2.23">   boolean stillRunning();</span>
<a href="#l2.24"></a><span id="l2.24"> </span>
<a href="#l2.25"></a><span id="l2.25" class="difflineminus">-  void fireURLRequest(in nsIURI aURL, in nsIFile localFile, in nsIOutputStream fileStream, in nsAttachSaveCompletionCallback cb, in voidPtr tagData);</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+  void fireURLRequest(in nsIURI aURL, in nsIFile localFile, in nsIOutputStream fileStream, in nsAttachSaveCompletionCallback cb, in nsMsgAttachmentHandler tagData);</span>
<a href="#l2.27"></a><span id="l2.27"> </span>
<a href="#l2.28"></a><span id="l2.28" class="difflineminus">-  void initialize(in nsIFile localFile, in nsIOutputStream fileStream, in nsAttachSaveCompletionCallback cb, in voidPtr tagData);</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+  void initialize(in nsIFile localFile, in nsIOutputStream fileStream, in nsAttachSaveCompletionCallback cb, in nsMsgAttachmentHandler tagData);</span>
<a href="#l2.30"></a><span id="l2.30"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -1148,38 +1148,35 @@ nsMsgAttachmentHandler::UrlExit(nsresult</span>
<a href="#l3.4"></a><span id="l3.4">   m_mime_delivery_state-&gt;GetProcessAttachmentsSynchronously(&amp;processAttachmentsSynchronously);</span>
<a href="#l3.5"></a><span id="l3.5">   if (NS_SUCCEEDED(status) &amp;&amp; processAttachmentsSynchronously)</span>
<a href="#l3.6"></a><span id="l3.6">   {</span>
<a href="#l3.7"></a><span id="l3.7">     /* Find the next attachment which has not yet been loaded,</span>
<a href="#l3.8"></a><span id="l3.8">      if any, and start it going.</span>
<a href="#l3.9"></a><span id="l3.9">      */</span>
<a href="#l3.10"></a><span id="l3.10">     uint32_t i;</span>
<a href="#l3.11"></a><span id="l3.11">     nsMsgAttachmentHandler *next = 0;</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-    nsMsgAttachmentHandler *attachments = nullptr;</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-    uint32_t attachmentCount = 0;</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+    nsTArray&lt;nsRefPtr&lt;nsMsgAttachmentHandler&gt;&gt; *attachments;</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+    m_mime_delivery_state-&gt;GetAttachmentHandlers(&amp;attachments);</span>
<a href="#l3.17"></a><span id="l3.17"> </span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-    m_mime_delivery_state-&gt;GetAttachmentCount(&amp;attachmentCount);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineminus">-    if (attachmentCount)</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-      m_mime_delivery_state-&gt;GetAttachmentHandlers(&amp;attachments);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-    for (i = 0; i &lt; attachmentCount; i++)</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+    for (i = 0; i &lt; attachments-&gt;Length(); i++)</span>
<a href="#l3.24"></a><span id="l3.24">     {</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineminus">-      if (!attachments[i].m_done)</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+      if (!(*attachments)[i]-&gt;m_done)</span>
<a href="#l3.27"></a><span id="l3.27">       {</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineminus">-        next = &amp;attachments[i];</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+        next = (*attachments)[i];</span>
<a href="#l3.30"></a><span id="l3.30">         //</span>
<a href="#l3.31"></a><span id="l3.31">         // rhp: We need to get a little more understanding to failed URL</span>
<a href="#l3.32"></a><span id="l3.32">         // requests. So, at this point if most of next is NULL, then we</span>
<a href="#l3.33"></a><span id="l3.33">         // should just mark it fetched and move on! We probably ignored</span>
<a href="#l3.34"></a><span id="l3.34">         // this earlier on in the send process.</span>
<a href="#l3.35"></a><span id="l3.35">         //</span>
<a href="#l3.36"></a><span id="l3.36">         if ( (!next-&gt;mURL) &amp;&amp; (next-&gt;m_uri.IsEmpty()) )</span>
<a href="#l3.37"></a><span id="l3.37">         {</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineminus">-          attachments[i].m_done = true;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineminus">-          attachments[i].SetMimeDeliveryState(nullptr);</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+          (*attachments)[i]-&gt;m_done = true;</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+          (*attachments)[i]-&gt;SetMimeDeliveryState(nullptr);</span>
<a href="#l3.42"></a><span id="l3.42">           m_mime_delivery_state-&gt;GetPendingAttachmentCount(&amp;pendingAttachmentCount);</span>
<a href="#l3.43"></a><span id="l3.43">           m_mime_delivery_state-&gt;SetPendingAttachmentCount(pendingAttachmentCount - 1);</span>
<a href="#l3.44"></a><span id="l3.44">           next-&gt;mPartUserOmissionOverride = true;</span>
<a href="#l3.45"></a><span id="l3.45">           next = nullptr;</span>
<a href="#l3.46"></a><span id="l3.46">           continue;</span>
<a href="#l3.47"></a><span id="l3.47">         }</span>
<a href="#l3.48"></a><span id="l3.48"> </span>
<a href="#l3.49"></a><span id="l3.49">         break;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgAttachmentHandler.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgAttachmentHandler.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -58,16 +58,18 @@ class MimeEncoder;</span>
<a href="#l4.4"></a><span id="l4.4"> }</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> //</span>
<a href="#l4.7"></a><span id="l4.7"> // This is a class that deals with processing remote attachments. It implements</span>
<a href="#l4.8"></a><span id="l4.8"> // an nsIStreamListener interface to deal with incoming data</span>
<a href="#l4.9"></a><span id="l4.9"> //</span>
<a href="#l4.10"></a><span id="l4.10"> class nsMsgAttachmentHandler</span>
<a href="#l4.11"></a><span id="l4.11"> {</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+  NS_INLINE_DECL_THREADSAFE_REFCOUNTING(nsMsgAttachmentHandler)</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+</span>
<a href="#l4.14"></a><span id="l4.14">   typedef mozilla::mailnews::MimeEncoder MimeEncoder;</span>
<a href="#l4.15"></a><span id="l4.15"> public:</span>
<a href="#l4.16"></a><span id="l4.16">   nsMsgAttachmentHandler();</span>
<a href="#l4.17"></a><span id="l4.17">   ~nsMsgAttachmentHandler();</span>
<a href="#l4.18"></a><span id="l4.18"> public:</span>
<a href="#l4.19"></a><span id="l4.19">   nsresult              SnarfAttachment(nsMsgCompFields *compFields);</span>
<a href="#l4.20"></a><span id="l4.20">   nsresult              PickEncoding(const char *charset, nsIMsgSend* mime_delivery_state);</span>
<a href="#l4.21"></a><span id="l4.21">   nsresult              PickCharset();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.cpp</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -264,17 +264,16 @@ nsMsgComposeAndSend::nsMsgComposeAndSend</span>
<a href="#l5.4"></a><span id="l5.4">   m_digest_p = false;</span>
<a href="#l5.5"></a><span id="l5.5">   m_be_synchronous_p = false;</span>
<a href="#l5.6"></a><span id="l5.6">   m_attachment1_type = 0;</span>
<a href="#l5.7"></a><span id="l5.7">   m_attachment1_encoding = 0;</span>
<a href="#l5.8"></a><span id="l5.8">   m_attachment1_body = 0;</span>
<a href="#l5.9"></a><span id="l5.9">   m_attachment1_body_length = 0;</span>
<a href="#l5.10"></a><span id="l5.10">   m_attachment_count = 0;</span>
<a href="#l5.11"></a><span id="l5.11">   m_attachment_pending_count = 0;</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  m_attachments = nullptr;</span>
<a href="#l5.13"></a><span id="l5.13">   m_status = NS_OK;</span>
<a href="#l5.14"></a><span id="l5.14">   m_plaintext = nullptr;</span>
<a href="#l5.15"></a><span id="l5.15">   m_related_part = nullptr;</span>
<a href="#l5.16"></a><span id="l5.16">   m_related_body_part = nullptr;</span>
<a href="#l5.17"></a><span id="l5.17">   mOriginalHTMLBody = nullptr;</span>
<a href="#l5.18"></a><span id="l5.18"> </span>
<a href="#l5.19"></a><span id="l5.19">   mNeedToPerformSecondFCC = false;</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21" class="difflineat">@@ -294,35 +293,32 @@ nsMsgComposeAndSend::~nsMsgComposeAndSen</span>
<a href="#l5.22"></a><span id="l5.22">   PR_Free(m_attachment1_body);</span>
<a href="#l5.23"></a><span id="l5.23">   PR_Free(mOriginalHTMLBody);</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25">   if (m_plaintext)</span>
<a href="#l5.26"></a><span id="l5.26">   {</span>
<a href="#l5.27"></a><span id="l5.27">     if (m_plaintext-&gt;mTmpFile)</span>
<a href="#l5.28"></a><span id="l5.28">       m_plaintext-&gt;mTmpFile-&gt;Remove(false);</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30" class="difflineminus">-    delete m_plaintext;</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+    m_plaintext = nullptr;</span>
<a href="#l5.32"></a><span id="l5.32">   }</span>
<a href="#l5.33"></a><span id="l5.33"> </span>
<a href="#l5.34"></a><span id="l5.34">   if (mHTMLFile)</span>
<a href="#l5.35"></a><span id="l5.35">     mHTMLFile-&gt;Remove(false);</span>
<a href="#l5.36"></a><span id="l5.36"> </span>
<a href="#l5.37"></a><span id="l5.37">   if (mCopyFile)</span>
<a href="#l5.38"></a><span id="l5.38">     mCopyFile-&gt;Remove(false);</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40">   if (mCopyFile2)</span>
<a href="#l5.41"></a><span id="l5.41">     mCopyFile2-&gt;Remove(false);</span>
<a href="#l5.42"></a><span id="l5.42"> </span>
<a href="#l5.43"></a><span id="l5.43">   if (mTempFile &amp;&amp; !mReturnFile)</span>
<a href="#l5.44"></a><span id="l5.44">     mTempFile-&gt;Remove(false);</span>
<a href="#l5.45"></a><span id="l5.45"> </span>
<a href="#l5.46"></a><span id="l5.46" class="difflineminus">-  if (m_attachments)</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-  {</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineminus">-    delete[] m_attachments;</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineminus">-  }</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+  m_attachments.Clear();</span>
<a href="#l5.51"></a><span id="l5.51"> }</span>
<a href="#l5.52"></a><span id="l5.52"> </span>
<a href="#l5.53"></a><span id="l5.53"> NS_IMETHODIMP nsMsgComposeAndSend::GetDefaultPrompt(nsIPrompt ** aPrompt)</span>
<a href="#l5.54"></a><span id="l5.54"> {</span>
<a href="#l5.55"></a><span id="l5.55">   NS_ENSURE_ARG(aPrompt);</span>
<a href="#l5.56"></a><span id="l5.56">   *aPrompt = nullptr;</span>
<a href="#l5.57"></a><span id="l5.57"> </span>
<a href="#l5.58"></a><span id="l5.58">   nsresult rv = NS_OK;</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineat">@@ -545,17 +541,16 @@ nsMsgComposeAndSend::GatherMimeAttachmen</span>
<a href="#l5.60"></a><span id="l5.60">       goto FAILMEM;</span>
<a href="#l5.61"></a><span id="l5.61">     m_plaintext-&gt;SetMimeDeliveryState(this);</span>
<a href="#l5.62"></a><span id="l5.62">     m_plaintext-&gt;m_bogus_attachment = true;</span>
<a href="#l5.63"></a><span id="l5.63"> </span>
<a href="#l5.64"></a><span id="l5.64">     nsAutoCString tempURL;</span>
<a href="#l5.65"></a><span id="l5.65">     rv = NS_GetURLSpecFromFile(mHTMLFile, tempURL);</span>
<a href="#l5.66"></a><span id="l5.66">     if (NS_FAILED(rv) || NS_FAILED(nsMsgNewURL(getter_AddRefs(m_plaintext-&gt;mURL), tempURL.get())))</span>
<a href="#l5.67"></a><span id="l5.67">     {</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-      delete m_plaintext;</span>
<a href="#l5.69"></a><span id="l5.69">       m_plaintext = nullptr;</span>
<a href="#l5.70"></a><span id="l5.70">       goto FAILMEM;</span>
<a href="#l5.71"></a><span id="l5.71">     }</span>
<a href="#l5.72"></a><span id="l5.72"> </span>
<a href="#l5.73"></a><span id="l5.73">     m_plaintext-&gt;m_type = TEXT_HTML;</span>
<a href="#l5.74"></a><span id="l5.74">     m_plaintext-&gt;m_charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l5.75"></a><span id="l5.75">     m_plaintext-&gt;m_desiredType = TEXT_PLAIN;</span>
<a href="#l5.76"></a><span id="l5.76">     m_attachment_pending_count ++;</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineat">@@ -876,53 +871,53 @@ nsMsgComposeAndSend::GatherMimeAttachmen</span>
<a href="#l5.78"></a><span id="l5.78">     if (! buffer)</span>
<a href="#l5.79"></a><span id="l5.79">       goto FAILMEM;</span>
<a href="#l5.80"></a><span id="l5.80">     buffer_tail = buffer;</span>
<a href="#l5.81"></a><span id="l5.81"> </span>
<a href="#l5.82"></a><span id="l5.82">     // Gather all of the attachments for this message that are NOT</span>
<a href="#l5.83"></a><span id="l5.83">     // part of an enclosed MHTML message!</span>
<a href="#l5.84"></a><span id="l5.84">     for (i = 0; i &lt; m_attachment_count; i++)</span>
<a href="#l5.85"></a><span id="l5.85">     {</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-      nsMsgAttachmentHandler *ma = &amp;m_attachments[i];</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineplus">+      nsMsgAttachmentHandler *ma = m_attachments[i];</span>
<a href="#l5.88"></a><span id="l5.88">       if (!ma-&gt;mMHTMLPart)</span>
<a href="#l5.89"></a><span id="l5.89">         PreProcessPart(ma, toppart);</span>
<a href="#l5.90"></a><span id="l5.90">     }</span>
<a href="#l5.91"></a><span id="l5.91"> </span>
<a href="#l5.92"></a><span id="l5.92">     //</span>
<a href="#l5.93"></a><span id="l5.93">     // If we have a m_related_part as a container for children, then we have to</span>
<a href="#l5.94"></a><span id="l5.94">     // tack on these children for the part</span>
<a href="#l5.95"></a><span id="l5.95">     //</span>
<a href="#l5.96"></a><span id="l5.96">     if (m_related_part)</span>
<a href="#l5.97"></a><span id="l5.97">     {</span>
<a href="#l5.98"></a><span id="l5.98">       for (i = 0; i &lt; m_attachment_count; i++)</span>
<a href="#l5.99"></a><span id="l5.99">       {</span>
<a href="#l5.100"></a><span id="l5.100">         //</span>
<a href="#l5.101"></a><span id="l5.101">         // look for earlier part with the same content id. If we find it,</span>
<a href="#l5.102"></a><span id="l5.102">         // need to remember the mapping between our node index and the</span>
<a href="#l5.103"></a><span id="l5.103">         // part num of the earlier part.</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-        int32_t nodeIndex = m_attachments[i].mNodeIndex;</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineplus">+        int32_t nodeIndex = m_attachments[i]-&gt;mNodeIndex;</span>
<a href="#l5.106"></a><span id="l5.106">         if (nodeIndex != -1)</span>
<a href="#l5.107"></a><span id="l5.107">         {</span>
<a href="#l5.108"></a><span id="l5.108">           for (uint32_t j = 0; j &lt; i; j++)</span>
<a href="#l5.109"></a><span id="l5.109">           {</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-            if (m_attachments[j].mNodeIndex != -1 &amp;&amp;</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-                m_attachments[j].m_contentId.Equals(m_attachments[i].m_contentId))</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-              m_partNumbers[nodeIndex] = m_partNumbers[m_attachments[j].mNodeIndex];</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+            if (m_attachments[j]-&gt;mNodeIndex != -1 &amp;&amp;</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineplus">+                m_attachments[j]-&gt;m_contentId.Equals(m_attachments[i]-&gt;m_contentId))</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineplus">+              m_partNumbers[nodeIndex] = m_partNumbers[m_attachments[j]-&gt;mNodeIndex];</span>
<a href="#l5.116"></a><span id="l5.116">           }</span>
<a href="#l5.117"></a><span id="l5.117">         }</span>
<a href="#l5.118"></a><span id="l5.118">         // rhp: This is here because we could get here after saying OK</span>
<a href="#l5.119"></a><span id="l5.119">         // to a lot of prompts about not being able to fetch this part!</span>
<a href="#l5.120"></a><span id="l5.120">         //</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineminus">-        if (m_attachments[i].mPartUserOmissionOverride)</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+        if (m_attachments[i]-&gt;mPartUserOmissionOverride)</span>
<a href="#l5.123"></a><span id="l5.123">           continue;</span>
<a href="#l5.124"></a><span id="l5.124"> </span>
<a href="#l5.125"></a><span id="l5.125">         // Now, we need to add this part to the m_related_part member so the</span>
<a href="#l5.126"></a><span id="l5.126">         // message will be generated correctly.</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-        if (m_attachments[i].mMHTMLPart)</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-          PreProcessPart(&amp;(m_attachments[i]), m_related_part);</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineplus">+        if (m_attachments[i]-&gt;mMHTMLPart)</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+          PreProcessPart(m_attachments[i], m_related_part);</span>
<a href="#l5.131"></a><span id="l5.131">       }</span>
<a href="#l5.132"></a><span id="l5.132">     }</span>
<a href="#l5.133"></a><span id="l5.133"> </span>
<a href="#l5.134"></a><span id="l5.134">   }</span>
<a href="#l5.135"></a><span id="l5.135"> </span>
<a href="#l5.136"></a><span id="l5.136">   // Tell the user we are creating the message...</span>
<a href="#l5.137"></a><span id="l5.137">   mComposeBundle-&gt;GetStringFromID(NS_MSG_CREATING_MESSAGE, getter_Copies(msg));</span>
<a href="#l5.138"></a><span id="l5.138">   SetStatusMessage( msg );</span>
<a href="#l5.139"></a><span id="l5.139" class="difflineat">@@ -1822,120 +1817,120 @@ nsMsgComposeAndSend::ProcessMultipartRel</span>
<a href="#l5.140"></a><span id="l5.140">     {</span>
<a href="#l5.141"></a><span id="l5.141">       bool acceptObject = false;</span>
<a href="#l5.142"></a><span id="l5.142">       rv = GetEmbeddedObjectInfo(node, &amp;attachment, &amp;acceptObject);</span>
<a href="#l5.143"></a><span id="l5.143">       NS_ENSURE_SUCCESS(rv, NS_ERROR_MIME_MPART_ATTACHMENT_ERROR);</span>
<a href="#l5.144"></a><span id="l5.144">       if (!acceptObject)</span>
<a href="#l5.145"></a><span id="l5.145">         continue;</span>
<a href="#l5.146"></a><span id="l5.146">       nsString nodeValue;</span>
<a href="#l5.147"></a><span id="l5.147">       node-&gt;GetNodeValue(nodeValue);</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineminus">-      LossyCopyUTF16toASCII(nodeValue, m_attachments[i].m_contentId);</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+      LossyCopyUTF16toASCII(nodeValue, m_attachments[i]-&gt;m_contentId);</span>
<a href="#l5.150"></a><span id="l5.150">     }</span>
<a href="#l5.151"></a><span id="l5.151">     else</span>
<a href="#l5.152"></a><span id="l5.152">     {</span>
<a href="#l5.153"></a><span id="l5.153">       nsCOMPtr&lt;nsIMsgEmbeddedImageData&gt; imageData = do_QueryElementAt(mEmbeddedObjectList, locCount, &amp;rv);</span>
<a href="#l5.154"></a><span id="l5.154">       if (!imageData)</span>
<a href="#l5.155"></a><span id="l5.155">         return NS_ERROR_MIME_MPART_ATTACHMENT_ERROR;</span>
<a href="#l5.156"></a><span id="l5.156">       imageData-&gt;GetUri(getter_AddRefs(attachment.m_url));</span>
<a href="#l5.157"></a><span id="l5.157">       if (!attachment.m_url)</span>
<a href="#l5.158"></a><span id="l5.158">         return NS_ERROR_MIME_MPART_ATTACHMENT_ERROR;</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineminus">-      imageData-&gt;GetCid(m_attachments[i].m_contentId);</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+      imageData-&gt;GetCid(m_attachments[i]-&gt;m_contentId);</span>
<a href="#l5.161"></a><span id="l5.161">       imageData-&gt;GetName(attachment.m_realName);</span>
<a href="#l5.162"></a><span id="l5.162">     }</span>
<a href="#l5.163"></a><span id="l5.163"> </span>
<a href="#l5.164"></a><span id="l5.164"> </span>
<a href="#l5.165"></a><span id="l5.165">     // MUST set this to get placed in the correct part of the message</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-    m_attachments[i].mMHTMLPart = true;</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-    m_attachments[i].mDeleteFile = true;</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-    m_attachments[i].m_done = false;</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-    m_attachments[i].SetMimeDeliveryState(this);</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-    m_attachments[i].mNodeIndex = locCount;</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineplus">+    m_attachments[i]-&gt;mMHTMLPart = true;</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineplus">+</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineplus">+    m_attachments[i]-&gt;mDeleteFile = true;</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+    m_attachments[i]-&gt;m_done = false;</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+    m_attachments[i]-&gt;SetMimeDeliveryState(this);</span>
<a href="#l5.177"></a><span id="l5.177" class="difflineplus">+    m_attachments[i]-&gt;mNodeIndex = locCount;</span>
<a href="#l5.178"></a><span id="l5.178"> </span>
<a href="#l5.179"></a><span id="l5.179">     j++;</span>
<a href="#l5.180"></a><span id="l5.180">     domSaveArray[j].node = node;</span>
<a href="#l5.181"></a><span id="l5.181"> </span>
<a href="#l5.182"></a><span id="l5.182">     // check if we have alreay attached this object, don't need to attach it twice</span>
<a href="#l5.183"></a><span id="l5.183">     duplicateOf = -1;</span>
<a href="#l5.184"></a><span id="l5.184">     for (k = mPreloadedAttachmentCount; k &lt; i; k++)</span>
<a href="#l5.185"></a><span id="l5.185">     {</span>
<a href="#l5.186"></a><span id="l5.186">       bool isEqual = false;</span>
<a href="#l5.187"></a><span id="l5.187">       NS_ASSERTION(attachment.m_url, &quot;null attachment url!&quot;);</span>
<a href="#l5.188"></a><span id="l5.188">       if (attachment.m_url)</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-        (void)attachment.m_url-&gt;Equals(m_attachments[k].mURL, &amp;isEqual);</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineplus">+        (void)attachment.m_url-&gt;Equals(m_attachments[k]-&gt;mURL, &amp;isEqual);</span>
<a href="#l5.191"></a><span id="l5.191">       if (isEqual)</span>
<a href="#l5.192"></a><span id="l5.192">       {</span>
<a href="#l5.193"></a><span id="l5.193">         duplicateOf = k;</span>
<a href="#l5.194"></a><span id="l5.194">         break;</span>
<a href="#l5.195"></a><span id="l5.195">       }</span>
<a href="#l5.196"></a><span id="l5.196">     }</span>
<a href="#l5.197"></a><span id="l5.197"> </span>
<a href="#l5.198"></a><span id="l5.198">     if (duplicateOf == -1)</span>
<a href="#l5.199"></a><span id="l5.199">     {</span>
<a href="#l5.200"></a><span id="l5.200">       //</span>
<a href="#l5.201"></a><span id="l5.201">       // Now we have to get all of the interesting information from</span>
<a href="#l5.202"></a><span id="l5.202">       // the nsIDOMNode we have in hand...</span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-      m_attachments[i].mURL = attachment.m_url;</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineminus">-</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineminus">-      m_attachments[i].m_overrideType = attachment.m_realType;</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineminus">-      m_attachments[i].m_overrideEncoding = attachment.m_realEncoding;</span>
<a href="#l5.207"></a><span id="l5.207" class="difflineminus">-      m_attachments[i].m_desiredType = attachment.m_desiredType;</span>
<a href="#l5.208"></a><span id="l5.208" class="difflineminus">-      m_attachments[i].m_description = attachment.m_description;</span>
<a href="#l5.209"></a><span id="l5.209" class="difflineminus">-      m_attachments[i].m_realName = attachment.m_realName;</span>
<a href="#l5.210"></a><span id="l5.210" class="difflineminus">-      m_attachments[i].m_xMacType = attachment.m_xMacType;</span>
<a href="#l5.211"></a><span id="l5.211" class="difflineminus">-      m_attachments[i].m_xMacCreator = attachment.m_xMacCreator;</span>
<a href="#l5.212"></a><span id="l5.212" class="difflineminus">-</span>
<a href="#l5.213"></a><span id="l5.213" class="difflineminus">-      m_attachments[i].m_charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineminus">-      m_attachments[i].m_encoding = ENCODING_7BIT;</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineminus">-</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineminus">-      if (m_attachments[i].mURL)</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineminus">-        msg_pick_real_name(&amp;m_attachments[i], nullptr, mCompFields-&gt;GetCharacterSet());</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineminus">-</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-      if (m_attachments[i].m_contentId.IsEmpty())</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineplus">+      m_attachments[i]-&gt;mURL = attachment.m_url;</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineplus">+</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineplus">+      m_attachments[i]-&gt;m_overrideType = attachment.m_realType;</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineplus">+      m_attachments[i]-&gt;m_overrideEncoding = attachment.m_realEncoding;</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineplus">+      m_attachments[i]-&gt;m_desiredType = attachment.m_desiredType;</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineplus">+      m_attachments[i]-&gt;m_description = attachment.m_description;</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineplus">+      m_attachments[i]-&gt;m_realName = attachment.m_realName;</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineplus">+      m_attachments[i]-&gt;m_xMacType = attachment.m_xMacType;</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineplus">+      m_attachments[i]-&gt;m_xMacCreator = attachment.m_xMacCreator;</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineplus">+</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineplus">+      m_attachments[i]-&gt;m_charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineplus">+      m_attachments[i]-&gt;m_encoding = ENCODING_7BIT;</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineplus">+</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineplus">+      if (m_attachments[i]-&gt;mURL)</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineplus">+        msg_pick_real_name(m_attachments[i], nullptr, mCompFields-&gt;GetCharacterSet());</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineplus">+</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineplus">+      if (m_attachments[i]-&gt;m_contentId.IsEmpty())</span>
<a href="#l5.237"></a><span id="l5.237">       {</span>
<a href="#l5.238"></a><span id="l5.238">         //</span>
<a href="#l5.239"></a><span id="l5.239">         // Next, generate a content id for use with this part</span>
<a href="#l5.240"></a><span id="l5.240">         //</span>
<a href="#l5.241"></a><span id="l5.241">         nsCString email;</span>
<a href="#l5.242"></a><span id="l5.242">         mUserIdentity-&gt;GetEmail(email);</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-        m_attachments[i].m_contentId = mime_gen_content_id(locCount+1, email.get());</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineplus">+        m_attachments[i]-&gt;m_contentId = mime_gen_content_id(locCount+1, email.get());</span>
<a href="#l5.245"></a><span id="l5.245">       }</span>
<a href="#l5.246"></a><span id="l5.246"> </span>
<a href="#l5.247"></a><span id="l5.247">       //</span>
<a href="#l5.248"></a><span id="l5.248">       // Start counting the attachments which are going to come from mail folders</span>
<a href="#l5.249"></a><span id="l5.249">       // and from NNTP servers.</span>
<a href="#l5.250"></a><span id="l5.250">       //</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-      if (m_attachments[i].mURL)</span>
<a href="#l5.252"></a><span id="l5.252" class="difflineplus">+      if (m_attachments[i]-&gt;mURL)</span>
<a href="#l5.253"></a><span id="l5.253">       {</span>
<a href="#l5.254"></a><span id="l5.254" class="difflineminus">-        nsIURI *uri = m_attachments[i].mURL;</span>
<a href="#l5.255"></a><span id="l5.255" class="difflineplus">+        nsIURI *uri = m_attachments[i]-&gt;mURL;</span>
<a href="#l5.256"></a><span id="l5.256">         bool match = false;</span>
<a href="#l5.257"></a><span id="l5.257">         if ((NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;mailbox&quot;, &amp;match)) &amp;&amp; match) ||</span>
<a href="#l5.258"></a><span id="l5.258">            (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;imap&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l5.259"></a><span id="l5.259">           (*aMailboxCount)++;</span>
<a href="#l5.260"></a><span id="l5.260">         else if ((NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;news&quot;, &amp;match)) &amp;&amp; match) ||</span>
<a href="#l5.261"></a><span id="l5.261">                 (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;snews&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l5.262"></a><span id="l5.262">           (*aNewsCount)++;</span>
<a href="#l5.263"></a><span id="l5.263">       }</span>
<a href="#l5.264"></a><span id="l5.264">     }</span>
<a href="#l5.265"></a><span id="l5.265">     else</span>
<a href="#l5.266"></a><span id="l5.266">     {</span>
<a href="#l5.267"></a><span id="l5.267" class="difflineminus">-      m_attachments[i].m_contentId = m_attachments[duplicateOf].m_contentId;</span>
<a href="#l5.268"></a><span id="l5.268" class="difflineminus">-      m_attachments[i].SetMimeDeliveryState(nullptr);</span>
<a href="#l5.269"></a><span id="l5.269" class="difflineplus">+      m_attachments[i]-&gt;m_contentId = m_attachments[duplicateOf]-&gt;m_contentId;</span>
<a href="#l5.270"></a><span id="l5.270" class="difflineplus">+      m_attachments[i]-&gt;SetMimeDeliveryState(nullptr);</span>
<a href="#l5.271"></a><span id="l5.271">     }</span>
<a href="#l5.272"></a><span id="l5.272"> </span>
<a href="#l5.273"></a><span id="l5.273">     //</span>
<a href="#l5.274"></a><span id="l5.274">     // Ok, while we are here, we should whack the DOM with the generated</span>
<a href="#l5.275"></a><span id="l5.275">     // Content-ID for this object. This will be necessary for generating</span>
<a href="#l5.276"></a><span id="l5.276">     // the HTML we need.</span>
<a href="#l5.277"></a><span id="l5.277">     //</span>
<a href="#l5.278"></a><span id="l5.278">     nsString domURL;</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineminus">-    if (!m_attachments[duplicateOf == -1 ? i : duplicateOf].m_contentId.IsEmpty())</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+    if (!m_attachments[duplicateOf == -1 ? i : duplicateOf]-&gt;m_contentId.IsEmpty())</span>
<a href="#l5.281"></a><span id="l5.281">     {</span>
<a href="#l5.282"></a><span id="l5.282">       nsString   newSpec(NS_LITERAL_STRING(&quot;cid:&quot;));</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineminus">-      newSpec.Append(NS_ConvertASCIItoUTF16(m_attachments[duplicateOf == -1 ? i : duplicateOf].m_contentId));</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+      newSpec.AppendASCII(m_attachments[duplicateOf == -1 ? i : duplicateOf]-&gt;m_contentId.get());</span>
<a href="#l5.285"></a><span id="l5.285"> </span>
<a href="#l5.286"></a><span id="l5.286">       // Now, we know the types of objects this node can be, so we will do</span>
<a href="#l5.287"></a><span id="l5.287">       // our query interface here and see what we come up with</span>
<a href="#l5.288"></a><span id="l5.288">       nsCOMPtr&lt;nsIDOMHTMLBodyElement&gt;     body = (do_QueryInterface(domSaveArray[j].node));</span>
<a href="#l5.289"></a><span id="l5.289">       nsCOMPtr&lt;nsIDOMHTMLImageElement&gt;    image = (do_QueryInterface(domSaveArray[j].node));</span>
<a href="#l5.290"></a><span id="l5.290">       nsCOMPtr&lt;nsIDOMHTMLLinkElement&gt;     link = (do_QueryInterface(domSaveArray[j].node));</span>
<a href="#l5.291"></a><span id="l5.291">       nsCOMPtr&lt;nsIDOMHTMLAnchorElement&gt;   anchor = (do_QueryInterface(domSaveArray[j].node));</span>
<a href="#l5.292"></a><span id="l5.292"> </span>
<a href="#l5.293"></a><span id="l5.293" class="difflineat">@@ -2099,166 +2094,166 @@ nsMsgComposeAndSend::AddCompFieldLocalAt</span>
<a href="#l5.294"></a><span id="l5.294">     rv = attachments-&gt;GetNext(getter_AddRefs(element));</span>
<a href="#l5.295"></a><span id="l5.295">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.296"></a><span id="l5.296"> </span>
<a href="#l5.297"></a><span id="l5.297">     nsCOMPtr&lt;nsIMsgAttachment&gt; attachment = do_QueryInterface(element, &amp;rv);</span>
<a href="#l5.298"></a><span id="l5.298">     if (NS_SUCCEEDED(rv) &amp;&amp; attachment)</span>
<a href="#l5.299"></a><span id="l5.299">     {</span>
<a href="#l5.300"></a><span id="l5.300">       bool sendViaCloud = false;</span>
<a href="#l5.301"></a><span id="l5.301">       attachment-&gt;GetSendViaCloud(&amp;sendViaCloud);</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineminus">-      m_attachments[newLoc].mSendViaCloud = sendViaCloud;</span>
<a href="#l5.303"></a><span id="l5.303" class="difflineplus">+      m_attachments[newLoc]-&gt;mSendViaCloud = sendViaCloud;</span>
<a href="#l5.304"></a><span id="l5.304">       attachment-&gt;GetUrl(url);</span>
<a href="#l5.305"></a><span id="l5.305">       if (!url.IsEmpty())</span>
<a href="#l5.306"></a><span id="l5.306">       {</span>
<a href="#l5.307"></a><span id="l5.307">         bool sendViaCloud;</span>
<a href="#l5.308"></a><span id="l5.308">         attachment-&gt;GetSendViaCloud(&amp;sendViaCloud);</span>
<a href="#l5.309"></a><span id="l5.309">         if (sendViaCloud)</span>
<a href="#l5.310"></a><span id="l5.310">         {</span>
<a href="#l5.311"></a><span id="l5.311">           nsCString cloudProviderKey;</span>
<a href="#l5.312"></a><span id="l5.312">           // We'd like to output a part for the attachment, just an html part</span>
<a href="#l5.313"></a><span id="l5.313">           // with information about how to download the attachment.</span>
<a href="#l5.314"></a><span id="l5.314" class="difflineminus">-          // m_attachments[newLoc].m_done = true;</span>
<a href="#l5.315"></a><span id="l5.315" class="difflineminus">-          attachment-&gt;GetHtmlAnnotation(m_attachments[newLoc].mHtmlAnnotation);</span>
<a href="#l5.316"></a><span id="l5.316" class="difflineminus">-          m_attachments[newLoc].m_type = &quot;text/html&quot;;</span>
<a href="#l5.317"></a><span id="l5.317" class="difflineminus">-          attachment-&gt;GetCloudProviderKey(m_attachments[newLoc].mCloudProviderKey);</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineminus">-          attachment-&gt;GetContentLocation(m_attachments[newLoc].mCloudUrl);</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineplus">+          // m_attachments[newLoc]-&gt;m_done = true;</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineplus">+          attachment-&gt;GetHtmlAnnotation(m_attachments[newLoc]-&gt;mHtmlAnnotation);</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineplus">+          m_attachments[newLoc]-&gt;m_type.AssignLiteral(&quot;text/html&quot;);</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineplus">+          attachment-&gt;GetCloudProviderKey(m_attachments[newLoc]-&gt;mCloudProviderKey);</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineplus">+          attachment-&gt;GetContentLocation(m_attachments[newLoc]-&gt;mCloudUrl);</span>
<a href="#l5.324"></a><span id="l5.324">         }</span>
<a href="#l5.325"></a><span id="l5.325">         // Just look for local file:// attachments and do the right thing.</span>
<a href="#l5.326"></a><span id="l5.326">         if (nsMsgIsLocalFile(url.get()))</span>
<a href="#l5.327"></a><span id="l5.327">         {</span>
<a href="#l5.328"></a><span id="l5.328">           //</span>
<a href="#l5.329"></a><span id="l5.329">           // Now we have to setup the m_attachments entry for the file://</span>
<a href="#l5.330"></a><span id="l5.330">           // URL that is passed in...</span>
<a href="#l5.331"></a><span id="l5.331">           //</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineminus">-          m_attachments[newLoc].mDeleteFile = false;</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineminus">-</span>
<a href="#l5.334"></a><span id="l5.334" class="difflineminus">-          nsMsgNewURL(getter_AddRefs(m_attachments[newLoc].mURL), url.get());</span>
<a href="#l5.335"></a><span id="l5.335" class="difflineminus">-</span>
<a href="#l5.336"></a><span id="l5.336" class="difflineminus">-          if (m_attachments[newLoc].mTmpFile)</span>
<a href="#l5.337"></a><span id="l5.337" class="difflineplus">+          m_attachments[newLoc]-&gt;mDeleteFile = false;</span>
<a href="#l5.338"></a><span id="l5.338" class="difflineplus">+</span>
<a href="#l5.339"></a><span id="l5.339" class="difflineplus">+          nsMsgNewURL(getter_AddRefs(m_attachments[newLoc]-&gt;mURL), url.get());</span>
<a href="#l5.340"></a><span id="l5.340" class="difflineplus">+</span>
<a href="#l5.341"></a><span id="l5.341" class="difflineplus">+          if (m_attachments[newLoc]-&gt;mTmpFile)</span>
<a href="#l5.342"></a><span id="l5.342">           {</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineminus">-            if (m_attachments[newLoc].mDeleteFile)</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineminus">-              m_attachments[newLoc].mTmpFile-&gt;Remove(false);</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineminus">-            m_attachments[newLoc].mTmpFile =nullptr;</span>
<a href="#l5.346"></a><span id="l5.346" class="difflineplus">+            if (m_attachments[newLoc]-&gt;mDeleteFile)</span>
<a href="#l5.347"></a><span id="l5.347" class="difflineplus">+              m_attachments[newLoc]-&gt;mTmpFile-&gt;Remove(false);</span>
<a href="#l5.348"></a><span id="l5.348" class="difflineplus">+            m_attachments[newLoc]-&gt;mTmpFile =nullptr;</span>
<a href="#l5.349"></a><span id="l5.349">           }</span>
<a href="#l5.350"></a><span id="l5.350">           nsresult rv;</span>
<a href="#l5.351"></a><span id="l5.351">           nsCOMPtr&lt;nsIIOService&gt; ioService =</span>
<a href="#l5.352"></a><span id="l5.352">             mozilla::services::GetIOService();</span>
<a href="#l5.353"></a><span id="l5.353">           NS_ENSURE_TRUE(ioService, NS_ERROR_UNEXPECTED);</span>
<a href="#l5.354"></a><span id="l5.354">           nsCOMPtr &lt;nsIURI&gt; uri;</span>
<a href="#l5.355"></a><span id="l5.355">           rv = ioService-&gt;NewURI(url, nullptr, nullptr, getter_AddRefs(uri));</span>
<a href="#l5.356"></a><span id="l5.356">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.357"></a><span id="l5.357">           nsCOMPtr &lt;nsIFileURL&gt; fileURL = do_QueryInterface(uri);</span>
<a href="#l5.358"></a><span id="l5.358">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l5.359"></a><span id="l5.359">           nsCOMPtr &lt;nsIFile&gt; fileURLFile;</span>
<a href="#l5.360"></a><span id="l5.360">           fileURL-&gt;GetFile(getter_AddRefs(fileURLFile));</span>
<a href="#l5.361"></a><span id="l5.361" class="difflineminus">-          m_attachments[newLoc].mTmpFile = do_QueryInterface(fileURLFile);</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineminus">-          m_attachments[newLoc].mDeleteFile = false;</span>
<a href="#l5.363"></a><span id="l5.363" class="difflineminus">-          if (m_attachments[newLoc].mURL)</span>
<a href="#l5.364"></a><span id="l5.364" class="difflineplus">+          m_attachments[newLoc]-&gt;mTmpFile = do_QueryInterface(fileURLFile);</span>
<a href="#l5.365"></a><span id="l5.365" class="difflineplus">+          m_attachments[newLoc]-&gt;mDeleteFile = false;</span>
<a href="#l5.366"></a><span id="l5.366" class="difflineplus">+          if (m_attachments[newLoc]-&gt;mURL)</span>
<a href="#l5.367"></a><span id="l5.367">           {</span>
<a href="#l5.368"></a><span id="l5.368">             nsAutoString proposedName;</span>
<a href="#l5.369"></a><span id="l5.369">             attachment-&gt;GetName(proposedName);</span>
<a href="#l5.370"></a><span id="l5.370" class="difflineminus">-            msg_pick_real_name(&amp;m_attachments[newLoc], proposedName.get(), mCompFields-&gt;GetCharacterSet());</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineplus">+            msg_pick_real_name(m_attachments[newLoc], proposedName.get(), mCompFields-&gt;GetCharacterSet());</span>
<a href="#l5.372"></a><span id="l5.372">           }</span>
<a href="#l5.373"></a><span id="l5.373"> </span>
<a href="#l5.374"></a><span id="l5.374">           // Now, most importantly, we need to figure out what the content type is for</span>
<a href="#l5.375"></a><span id="l5.375">           // this attachment...If we can't, then just make it application/octet-stream</span>
<a href="#l5.376"></a><span id="l5.376"> </span>
<a href="#l5.377"></a><span id="l5.377">   #ifdef MAC_OSX</span>
<a href="#l5.378"></a><span id="l5.378">           //Mac always need to snarf the file to figure out how to send it, maybe we need to use apple double...</span>
<a href="#l5.379"></a><span id="l5.379">           //  unless caller has already set the content type, in which case, trust them.</span>
<a href="#l5.380"></a><span id="l5.380">           bool mustSnarfAttachment = true;</span>
<a href="#l5.381"></a><span id="l5.381">   #else</span>
<a href="#l5.382"></a><span id="l5.382">           bool mustSnarfAttachment = false;</span>
<a href="#l5.383"></a><span id="l5.383">   #endif</span>
<a href="#l5.384"></a><span id="l5.384">           if (sendViaCloud)</span>
<a href="#l5.385"></a><span id="l5.385">             mustSnarfAttachment = false;</span>
<a href="#l5.386"></a><span id="l5.386"> </span>
<a href="#l5.387"></a><span id="l5.387" class="difflineminus">-          attachment-&gt;GetContentType(getter_Copies(m_attachments[newLoc].m_type));</span>
<a href="#l5.388"></a><span id="l5.388" class="difflineminus">-          if (m_attachments[newLoc].m_type.IsEmpty())</span>
<a href="#l5.389"></a><span id="l5.389" class="difflineplus">+          attachment-&gt;GetContentType(getter_Copies(m_attachments[newLoc]-&gt;m_type));</span>
<a href="#l5.390"></a><span id="l5.390" class="difflineplus">+          if (m_attachments[newLoc]-&gt;m_type.IsEmpty())</span>
<a href="#l5.391"></a><span id="l5.391">           {</span>
<a href="#l5.392"></a><span id="l5.392">             nsresult  rv = NS_OK;</span>
<a href="#l5.393"></a><span id="l5.393">             nsCOMPtr&lt;nsIMIMEService&gt; mimeFinder (do_GetService(NS_MIMESERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l5.394"></a><span id="l5.394">             if (NS_SUCCEEDED(rv) &amp;&amp; mimeFinder)</span>
<a href="#l5.395"></a><span id="l5.395">             {</span>
<a href="#l5.396"></a><span id="l5.396">               nsCOMPtr&lt;nsIURL&gt; fileUrl(do_CreateInstance(NS_STANDARDURL_CONTRACTID));</span>
<a href="#l5.397"></a><span id="l5.397">               if (fileUrl)</span>
<a href="#l5.398"></a><span id="l5.398">               {</span>
<a href="#l5.399"></a><span id="l5.399">                 nsAutoCString fileExt;</span>
<a href="#l5.400"></a><span id="l5.400">                 //First try using the real file name</span>
<a href="#l5.401"></a><span id="l5.401" class="difflineminus">-                rv = fileUrl-&gt;SetFileName(m_attachments[newLoc].m_realName);</span>
<a href="#l5.402"></a><span id="l5.402" class="difflineplus">+                rv = fileUrl-&gt;SetFileName(m_attachments[newLoc]-&gt;m_realName);</span>
<a href="#l5.403"></a><span id="l5.403">                 if (NS_SUCCEEDED(rv))</span>
<a href="#l5.404"></a><span id="l5.404">                 {</span>
<a href="#l5.405"></a><span id="l5.405">                   rv = fileUrl-&gt;GetFileExtension(fileExt);</span>
<a href="#l5.406"></a><span id="l5.406">                   if (NS_SUCCEEDED(rv) &amp;&amp; !fileExt.IsEmpty()) {</span>
<a href="#l5.407"></a><span id="l5.407">                     nsAutoCString type;</span>
<a href="#l5.408"></a><span id="l5.408">                     mimeFinder-&gt;GetTypeFromExtension(fileExt, type);</span>
<a href="#l5.409"></a><span id="l5.409">   #ifndef XP_MACOSX</span>
<a href="#l5.410"></a><span id="l5.410">                     if (!type.Equals(&quot;multipart/appledouble&quot;))  // can't do apple double on non-macs</span>
<a href="#l5.411"></a><span id="l5.411">   #endif</span>
<a href="#l5.412"></a><span id="l5.412" class="difflineminus">-                    m_attachments[newLoc].m_type = type;</span>
<a href="#l5.413"></a><span id="l5.413" class="difflineplus">+                    m_attachments[newLoc]-&gt;m_type = type;</span>
<a href="#l5.414"></a><span id="l5.414">                   }</span>
<a href="#l5.415"></a><span id="l5.415">                 }</span>
<a href="#l5.416"></a><span id="l5.416"> </span>
<a href="#l5.417"></a><span id="l5.417">                 //Then try using the url if we still haven't figured out the content type</span>
<a href="#l5.418"></a><span id="l5.418" class="difflineminus">-                if (m_attachments[newLoc].m_type.IsEmpty())</span>
<a href="#l5.419"></a><span id="l5.419" class="difflineplus">+                if (m_attachments[newLoc]-&gt;m_type.IsEmpty())</span>
<a href="#l5.420"></a><span id="l5.420">                 {</span>
<a href="#l5.421"></a><span id="l5.421">                   rv = fileUrl-&gt;SetSpec(url);</span>
<a href="#l5.422"></a><span id="l5.422">                   if (NS_SUCCEEDED(rv))</span>
<a href="#l5.423"></a><span id="l5.423">                   {</span>
<a href="#l5.424"></a><span id="l5.424">                     rv = fileUrl-&gt;GetFileExtension(fileExt);</span>
<a href="#l5.425"></a><span id="l5.425">                     if (NS_SUCCEEDED(rv) &amp;&amp; !fileExt.IsEmpty()) {</span>
<a href="#l5.426"></a><span id="l5.426">                       nsAutoCString type;</span>
<a href="#l5.427"></a><span id="l5.427">                       mimeFinder-&gt;GetTypeFromExtension(fileExt, type);</span>
<a href="#l5.428"></a><span id="l5.428">   #ifndef XP_MACOSX</span>
<a href="#l5.429"></a><span id="l5.429">                     if (!type.Equals(&quot;multipart/appledouble&quot;))  // can't do apple double on non-macs</span>
<a href="#l5.430"></a><span id="l5.430">   #endif</span>
<a href="#l5.431"></a><span id="l5.431" class="difflineminus">-                      m_attachments[newLoc].m_type = type;</span>
<a href="#l5.432"></a><span id="l5.432" class="difflineplus">+                      m_attachments[newLoc]-&gt;m_type = type;</span>
<a href="#l5.433"></a><span id="l5.433">                     // rtf and vcs files may look like text to sniffers,</span>
<a href="#l5.434"></a><span id="l5.434">                     // but they're not human readable.</span>
<a href="#l5.435"></a><span id="l5.435">                     if (type.IsEmpty() &amp;&amp; !fileExt.IsEmpty() &amp;&amp;</span>
<a href="#l5.436"></a><span id="l5.436">                          (MsgLowerCaseEqualsLiteral(fileExt, &quot;rtf&quot;) ||</span>
<a href="#l5.437"></a><span id="l5.437">                           MsgLowerCaseEqualsLiteral(fileExt, &quot;vcs&quot;)))</span>
<a href="#l5.438"></a><span id="l5.438" class="difflineminus">-                      m_attachments[newLoc].m_type = APPLICATION_OCTET_STREAM;</span>
<a href="#l5.439"></a><span id="l5.439" class="difflineplus">+                      m_attachments[newLoc]-&gt;m_type = APPLICATION_OCTET_STREAM;</span>
<a href="#l5.440"></a><span id="l5.440">                     }</span>
<a href="#l5.441"></a><span id="l5.441">                   }</span>
<a href="#l5.442"></a><span id="l5.442">                 }</span>
<a href="#l5.443"></a><span id="l5.443">               }</span>
<a href="#l5.444"></a><span id="l5.444">             }</span>
<a href="#l5.445"></a><span id="l5.445">           }</span>
<a href="#l5.446"></a><span id="l5.446">           else</span>
<a href="#l5.447"></a><span id="l5.447">           {</span>
<a href="#l5.448"></a><span id="l5.448" class="difflineminus">-            attachment-&gt;GetContentTypeParam(getter_Copies(m_attachments[newLoc].m_typeParam));</span>
<a href="#l5.449"></a><span id="l5.449" class="difflineplus">+            attachment-&gt;GetContentTypeParam(getter_Copies(m_attachments[newLoc]-&gt;m_typeParam));</span>
<a href="#l5.450"></a><span id="l5.450">             mustSnarfAttachment = false;</span>
<a href="#l5.451"></a><span id="l5.451">           }</span>
<a href="#l5.452"></a><span id="l5.452"> </span>
<a href="#l5.453"></a><span id="l5.453">           //We need to snarf the file to figure out how to send it only if we don't have a content type...</span>
<a href="#l5.454"></a><span id="l5.454" class="difflineminus">-          if (mustSnarfAttachment || m_attachments[newLoc].m_type.IsEmpty())</span>
<a href="#l5.455"></a><span id="l5.455" class="difflineplus">+          if (mustSnarfAttachment || m_attachments[newLoc]-&gt;m_type.IsEmpty())</span>
<a href="#l5.456"></a><span id="l5.456">           {</span>
<a href="#l5.457"></a><span id="l5.457" class="difflineminus">-            m_attachments[newLoc].m_done = false;</span>
<a href="#l5.458"></a><span id="l5.458" class="difflineminus">-            m_attachments[newLoc].SetMimeDeliveryState(this);</span>
<a href="#l5.459"></a><span id="l5.459" class="difflineplus">+            m_attachments[newLoc]-&gt;m_done = false;</span>
<a href="#l5.460"></a><span id="l5.460" class="difflineplus">+            m_attachments[newLoc]-&gt;SetMimeDeliveryState(this);</span>
<a href="#l5.461"></a><span id="l5.461">           }</span>
<a href="#l5.462"></a><span id="l5.462">           else</span>
<a href="#l5.463"></a><span id="l5.463">           {</span>
<a href="#l5.464"></a><span id="l5.464" class="difflineminus">-            m_attachments[newLoc].m_done = true;</span>
<a href="#l5.465"></a><span id="l5.465" class="difflineminus">-            m_attachments[newLoc].SetMimeDeliveryState(nullptr);</span>
<a href="#l5.466"></a><span id="l5.466" class="difflineplus">+            m_attachments[newLoc]-&gt;m_done = true;</span>
<a href="#l5.467"></a><span id="l5.467" class="difflineplus">+            m_attachments[newLoc]-&gt;SetMimeDeliveryState(nullptr);</span>
<a href="#l5.468"></a><span id="l5.468">           }</span>
<a href="#l5.469"></a><span id="l5.469">           // For local files, if they are HTML docs and we don't have a charset, we should</span>
<a href="#l5.470"></a><span id="l5.470">           // sniff the file and see if we can figure it out.</span>
<a href="#l5.471"></a><span id="l5.471" class="difflineminus">-          if (!m_attachments[newLoc].m_type.IsEmpty())</span>
<a href="#l5.472"></a><span id="l5.472" class="difflineplus">+          if (!m_attachments[newLoc]-&gt;m_type.IsEmpty())</span>
<a href="#l5.473"></a><span id="l5.473">           {</span>
<a href="#l5.474"></a><span id="l5.474" class="difflineminus">-            if (m_attachments[newLoc].m_type.LowerCaseEqualsLiteral(TEXT_HTML))</span>
<a href="#l5.475"></a><span id="l5.475" class="difflineplus">+            if (m_attachments[newLoc]-&gt;m_type.LowerCaseEqualsLiteral(TEXT_HTML))</span>
<a href="#l5.476"></a><span id="l5.476">             {</span>
<a href="#l5.477"></a><span id="l5.477" class="difflineminus">-              char *tmpCharset = (char *)nsMsgI18NParseMetaCharset(m_attachments[newLoc].mTmpFile);</span>
<a href="#l5.478"></a><span id="l5.478" class="difflineplus">+              char *tmpCharset = (char *)nsMsgI18NParseMetaCharset(m_attachments[newLoc]-&gt;mTmpFile);</span>
<a href="#l5.479"></a><span id="l5.479">               if (tmpCharset[0] != '\0')</span>
<a href="#l5.480"></a><span id="l5.480" class="difflineminus">-                m_attachments[newLoc].m_charset = tmpCharset;</span>
<a href="#l5.481"></a><span id="l5.481" class="difflineplus">+                m_attachments[newLoc]-&gt;m_charset = tmpCharset;</span>
<a href="#l5.482"></a><span id="l5.482">             }</span>
<a href="#l5.483"></a><span id="l5.483">           }</span>
<a href="#l5.484"></a><span id="l5.484"> </span>
<a href="#l5.485"></a><span id="l5.485" class="difflineminus">-          attachment-&gt;GetMacType(getter_Copies(m_attachments[newLoc].m_xMacType));</span>
<a href="#l5.486"></a><span id="l5.486" class="difflineminus">-          attachment-&gt;GetMacCreator(getter_Copies(m_attachments[newLoc].m_xMacCreator));</span>
<a href="#l5.487"></a><span id="l5.487" class="difflineplus">+          attachment-&gt;GetMacType(getter_Copies(m_attachments[newLoc]-&gt;m_xMacType));</span>
<a href="#l5.488"></a><span id="l5.488" class="difflineplus">+          attachment-&gt;GetMacCreator(getter_Copies(m_attachments[newLoc]-&gt;m_xMacCreator));</span>
<a href="#l5.489"></a><span id="l5.489"> </span>
<a href="#l5.490"></a><span id="l5.490">           ++newLoc;</span>
<a href="#l5.491"></a><span id="l5.491">         }</span>
<a href="#l5.492"></a><span id="l5.492">       }</span>
<a href="#l5.493"></a><span id="l5.493">     }</span>
<a href="#l5.494"></a><span id="l5.494">   }</span>
<a href="#l5.495"></a><span id="l5.495">   return NS_OK;</span>
<a href="#l5.496"></a><span id="l5.496"> }</span>
<a href="#l5.497"></a><span id="l5.497" class="difflineat">@@ -2297,50 +2292,50 @@ nsMsgComposeAndSend::AddCompFieldRemoteA</span>
<a href="#l5.498"></a><span id="l5.498">         // Just look for files that are NOT local file attachments and do</span>
<a href="#l5.499"></a><span id="l5.499">         // the right thing.</span>
<a href="#l5.500"></a><span id="l5.500">         if (! nsMsgIsLocalFile(url.get()))</span>
<a href="#l5.501"></a><span id="l5.501">         {</span>
<a href="#l5.502"></a><span id="l5.502">           bool isAMessageAttachment = !PL_strncasecmp(url.get(), &quot;mailbox-message://&quot;, 18) ||</span>
<a href="#l5.503"></a><span id="l5.503">               !PL_strncasecmp(url.get(), &quot;imap-message://&quot;, 15) ||</span>
<a href="#l5.504"></a><span id="l5.504">               !PL_strncasecmp(url.get(), &quot;news-message://&quot;, 15);</span>
<a href="#l5.505"></a><span id="l5.505"> </span>
<a href="#l5.506"></a><span id="l5.506" class="difflineminus">-          m_attachments[newLoc].mDeleteFile = true;</span>
<a href="#l5.507"></a><span id="l5.507" class="difflineminus">-          m_attachments[newLoc].m_done = false;</span>
<a href="#l5.508"></a><span id="l5.508" class="difflineminus">-          m_attachments[newLoc].SetMimeDeliveryState(this);</span>
<a href="#l5.509"></a><span id="l5.509" class="difflineplus">+          m_attachments[newLoc]-&gt;mDeleteFile = true;</span>
<a href="#l5.510"></a><span id="l5.510" class="difflineplus">+          m_attachments[newLoc]-&gt;m_done = false;</span>
<a href="#l5.511"></a><span id="l5.511" class="difflineplus">+          m_attachments[newLoc]-&gt;SetMimeDeliveryState(this);</span>
<a href="#l5.512"></a><span id="l5.512"> </span>
<a href="#l5.513"></a><span id="l5.513">           if (!isAMessageAttachment)</span>
<a href="#l5.514"></a><span id="l5.514" class="difflineminus">-            nsMsgNewURL(getter_AddRefs(m_attachments[newLoc].mURL), url.get());</span>
<a href="#l5.515"></a><span id="l5.515" class="difflineminus">-</span>
<a href="#l5.516"></a><span id="l5.516" class="difflineminus">-          m_attachments[newLoc].m_encoding = ENCODING_7BIT;</span>
<a href="#l5.517"></a><span id="l5.517" class="difflineminus">-</span>
<a href="#l5.518"></a><span id="l5.518" class="difflineminus">-          attachment-&gt;GetMacType(getter_Copies(m_attachments[newLoc].m_xMacType));</span>
<a href="#l5.519"></a><span id="l5.519" class="difflineminus">-          attachment-&gt;GetMacCreator(getter_Copies(m_attachments[newLoc].m_xMacCreator));</span>
<a href="#l5.520"></a><span id="l5.520" class="difflineplus">+            nsMsgNewURL(getter_AddRefs(m_attachments[newLoc]-&gt;mURL), url.get());</span>
<a href="#l5.521"></a><span id="l5.521" class="difflineplus">+</span>
<a href="#l5.522"></a><span id="l5.522" class="difflineplus">+          m_attachments[newLoc]-&gt;m_encoding = ENCODING_7BIT;</span>
<a href="#l5.523"></a><span id="l5.523" class="difflineplus">+</span>
<a href="#l5.524"></a><span id="l5.524" class="difflineplus">+          attachment-&gt;GetMacType(getter_Copies(m_attachments[newLoc]-&gt;m_xMacType));</span>
<a href="#l5.525"></a><span id="l5.525" class="difflineplus">+          attachment-&gt;GetMacCreator(getter_Copies(m_attachments[newLoc]-&gt;m_xMacCreator));</span>
<a href="#l5.526"></a><span id="l5.526"> </span>
<a href="#l5.527"></a><span id="l5.527">           /* Count up attachments which are going to come from mail folders</span>
<a href="#l5.528"></a><span id="l5.528">              and from NNTP servers. */</span>
<a href="#l5.529"></a><span id="l5.529">           bool do_add_attachment = false;</span>
<a href="#l5.530"></a><span id="l5.530">           if (isAMessageAttachment)</span>
<a href="#l5.531"></a><span id="l5.531">           {</span>
<a href="#l5.532"></a><span id="l5.532">             do_add_attachment = true;</span>
<a href="#l5.533"></a><span id="l5.533">             if (!PL_strncasecmp(url.get(), &quot;news-message://&quot;, 15))</span>
<a href="#l5.534"></a><span id="l5.534">               (*aNewsCount)++;</span>
<a href="#l5.535"></a><span id="l5.535">             else</span>
<a href="#l5.536"></a><span id="l5.536">               (*aMailboxCount)++;</span>
<a href="#l5.537"></a><span id="l5.537"> </span>
<a href="#l5.538"></a><span id="l5.538" class="difflineminus">-            m_attachments[newLoc].m_uri = url;</span>
<a href="#l5.539"></a><span id="l5.539" class="difflineminus">-            m_attachments[newLoc].mURL = nullptr;</span>
<a href="#l5.540"></a><span id="l5.540" class="difflineplus">+            m_attachments[newLoc]-&gt;m_uri = url;</span>
<a href="#l5.541"></a><span id="l5.541" class="difflineplus">+            m_attachments[newLoc]-&gt;mURL = nullptr;</span>
<a href="#l5.542"></a><span id="l5.542">           }</span>
<a href="#l5.543"></a><span id="l5.543">           else</span>
<a href="#l5.544"></a><span id="l5.544" class="difflineminus">-            do_add_attachment = (nullptr != m_attachments[newLoc].mURL);</span>
<a href="#l5.545"></a><span id="l5.545" class="difflineminus">-          m_attachments[newLoc].mSendViaCloud = false;</span>
<a href="#l5.546"></a><span id="l5.546" class="difflineplus">+            do_add_attachment = (nullptr != m_attachments[newLoc]-&gt;mURL);</span>
<a href="#l5.547"></a><span id="l5.547" class="difflineplus">+          m_attachments[newLoc]-&gt;mSendViaCloud = false;</span>
<a href="#l5.548"></a><span id="l5.548">           if (do_add_attachment)</span>
<a href="#l5.549"></a><span id="l5.549">           {</span>
<a href="#l5.550"></a><span id="l5.550">             nsAutoString proposedName;</span>
<a href="#l5.551"></a><span id="l5.551">             attachment-&gt;GetName(proposedName);</span>
<a href="#l5.552"></a><span id="l5.552" class="difflineminus">-            msg_pick_real_name(&amp;m_attachments[newLoc], proposedName.get(), mCompFields-&gt;GetCharacterSet());</span>
<a href="#l5.553"></a><span id="l5.553" class="difflineplus">+            msg_pick_real_name(m_attachments[newLoc], proposedName.get(), mCompFields-&gt;GetCharacterSet());</span>
<a href="#l5.554"></a><span id="l5.554">             ++newLoc;</span>
<a href="#l5.555"></a><span id="l5.555">           }</span>
<a href="#l5.556"></a><span id="l5.556">         }</span>
<a href="#l5.557"></a><span id="l5.557">       }</span>
<a href="#l5.558"></a><span id="l5.558">     }</span>
<a href="#l5.559"></a><span id="l5.559">   }</span>
<a href="#l5.560"></a><span id="l5.560">   return NS_OK;</span>
<a href="#l5.561"></a><span id="l5.561"> }</span>
<a href="#l5.562"></a><span id="l5.562" class="difflineat">@@ -2379,19 +2374,20 @@ nsMsgComposeAndSend::HackAttachments(nsI</span>
<a href="#l5.563"></a><span id="l5.563"> </span>
<a href="#l5.564"></a><span id="l5.564">   int32_t tCount = 0;</span>
<a href="#l5.565"></a><span id="l5.565">   mRemoteAttachmentCount += numAttachments;</span>
<a href="#l5.566"></a><span id="l5.566">   tCount += numAttachments;</span>
<a href="#l5.567"></a><span id="l5.567"> </span>
<a href="#l5.568"></a><span id="l5.568">   m_attachment_count = mPreloadedAttachmentCount + mRemoteAttachmentCount;</span>
<a href="#l5.569"></a><span id="l5.569"> </span>
<a href="#l5.570"></a><span id="l5.570">   // Now create the array of attachment handlers...</span>
<a href="#l5.571"></a><span id="l5.571" class="difflineminus">-  m_attachments = (nsMsgAttachmentHandler *) new nsMsgAttachmentHandler[m_attachment_count];</span>
<a href="#l5.572"></a><span id="l5.572" class="difflineminus">-  if (! m_attachments)</span>
<a href="#l5.573"></a><span id="l5.573" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l5.574"></a><span id="l5.574" class="difflineplus">+  for (int i = 0; i &lt; m_attachment_count; i++) {</span>
<a href="#l5.575"></a><span id="l5.575" class="difflineplus">+    nsRefPtr&lt;nsMsgAttachmentHandler&gt; handler = new nsMsgAttachmentHandler;</span>
<a href="#l5.576"></a><span id="l5.576" class="difflineplus">+    m_attachments.AppendElement(handler);</span>
<a href="#l5.577"></a><span id="l5.577" class="difflineplus">+  }</span>
<a href="#l5.578"></a><span id="l5.578"> </span>
<a href="#l5.579"></a><span id="l5.579">   // clear this new memory...</span>
<a href="#l5.580"></a><span id="l5.580">   uint32_t     i;    // counter for location in attachment array...</span>
<a href="#l5.581"></a><span id="l5.581"> </span>
<a href="#l5.582"></a><span id="l5.582">   //</span>
<a href="#l5.583"></a><span id="l5.583">   // First, we need to attach the files that are defined in the comp fields...</span>
<a href="#l5.584"></a><span id="l5.584">   if (NS_FAILED(AddCompFieldLocalAttachments()))</span>
<a href="#l5.585"></a><span id="l5.585">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l5.586"></a><span id="l5.586" class="difflineat">@@ -2406,76 +2402,76 @@ nsMsgComposeAndSend::HackAttachments(nsI</span>
<a href="#l5.587"></a><span id="l5.587"> </span>
<a href="#l5.588"></a><span id="l5.588">     for (i = mCompFieldLocalAttachments; i &lt; mPreloadedAttachmentCount; i++)</span>
<a href="#l5.589"></a><span id="l5.589">     {</span>
<a href="#l5.590"></a><span id="l5.590">       nsCOMPtr&lt;nsIMsgAttachedFile&gt; attachedFile = do_QueryElementAt(preloadedAttachments, i);</span>
<a href="#l5.591"></a><span id="l5.591">       if (!attachedFile)</span>
<a href="#l5.592"></a><span id="l5.592">         continue;</span>
<a href="#l5.593"></a><span id="l5.593"> </span>
<a href="#l5.594"></a><span id="l5.594">       /* These attachments are already &quot;snarfed&quot;. */</span>
<a href="#l5.595"></a><span id="l5.595" class="difflineminus">-      m_attachments[i].mDeleteFile = false;</span>
<a href="#l5.596"></a><span id="l5.596" class="difflineminus">-      m_attachments[i].SetMimeDeliveryState(nullptr);</span>
<a href="#l5.597"></a><span id="l5.597" class="difflineminus">-      m_attachments[i].m_done = true;</span>
<a href="#l5.598"></a><span id="l5.598" class="difflineminus">-</span>
<a href="#l5.599"></a><span id="l5.599" class="difflineminus">-      attachedFile-&gt;GetOrigUrl(getter_AddRefs(m_attachments[i].mURL));</span>
<a href="#l5.600"></a><span id="l5.600" class="difflineminus">-</span>
<a href="#l5.601"></a><span id="l5.601" class="difflineminus">-      attachedFile-&gt;GetType(m_attachments[i].m_type);</span>
<a href="#l5.602"></a><span id="l5.602" class="difflineplus">+      m_attachments[i]-&gt;mDeleteFile = false;</span>
<a href="#l5.603"></a><span id="l5.603" class="difflineplus">+      m_attachments[i]-&gt;SetMimeDeliveryState(nullptr);</span>
<a href="#l5.604"></a><span id="l5.604" class="difflineplus">+      m_attachments[i]-&gt;m_done = true;</span>
<a href="#l5.605"></a><span id="l5.605" class="difflineplus">+</span>
<a href="#l5.606"></a><span id="l5.606" class="difflineplus">+      attachedFile-&gt;GetOrigUrl(getter_AddRefs(m_attachments[i]-&gt;mURL));</span>
<a href="#l5.607"></a><span id="l5.607" class="difflineplus">+</span>
<a href="#l5.608"></a><span id="l5.608" class="difflineplus">+      attachedFile-&gt;GetType(m_attachments[i]-&gt;m_type);</span>
<a href="#l5.609"></a><span id="l5.609"> </span>
<a href="#l5.610"></a><span id="l5.610">       // Set it to the compose fields for a default...</span>
<a href="#l5.611"></a><span id="l5.611" class="difflineminus">-      m_attachments[i].m_charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l5.612"></a><span id="l5.612" class="difflineplus">+      m_attachments[i]-&gt;m_charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l5.613"></a><span id="l5.613"> </span>
<a href="#l5.614"></a><span id="l5.614">       // If we still don't have a content type, we should really try sniff one out!</span>
<a href="#l5.615"></a><span id="l5.615" class="difflineminus">-      if (m_attachments[i].m_type.IsEmpty())</span>
<a href="#l5.616"></a><span id="l5.616" class="difflineminus">-        m_attachments[i].PickEncoding(mCompFields-&gt;GetCharacterSet(), this);</span>
<a href="#l5.617"></a><span id="l5.617" class="difflineplus">+      if (m_attachments[i]-&gt;m_type.IsEmpty())</span>
<a href="#l5.618"></a><span id="l5.618" class="difflineplus">+        m_attachments[i]-&gt;PickEncoding(mCompFields-&gt;GetCharacterSet(), this);</span>
<a href="#l5.619"></a><span id="l5.619"> </span>
<a href="#l5.620"></a><span id="l5.620">       // For local files, if they are HTML docs and we don't have a charset, we should</span>
<a href="#l5.621"></a><span id="l5.621">       // sniff the file and see if we can figure it out.</span>
<a href="#l5.622"></a><span id="l5.622" class="difflineminus">-      if (!m_attachments[i].m_type.IsEmpty())</span>
<a href="#l5.623"></a><span id="l5.623" class="difflineplus">+      if (!m_attachments[i]-&gt;m_type.IsEmpty())</span>
<a href="#l5.624"></a><span id="l5.624">       {</span>
<a href="#l5.625"></a><span id="l5.625">         nsCOMPtr&lt;nsIFile&gt; tmpFile;</span>
<a href="#l5.626"></a><span id="l5.626">         attachedFile-&gt;GetTmpFile(getter_AddRefs(tmpFile));</span>
<a href="#l5.627"></a><span id="l5.627" class="difflineminus">-        if (m_attachments[i].m_type.LowerCaseEqualsLiteral(TEXT_HTML) &amp;&amp; tmpFile)</span>
<a href="#l5.628"></a><span id="l5.628" class="difflineplus">+        if (m_attachments[i]-&gt;m_type.LowerCaseEqualsLiteral(TEXT_HTML) &amp;&amp; tmpFile)</span>
<a href="#l5.629"></a><span id="l5.629">         {</span>
<a href="#l5.630"></a><span id="l5.630">           char *tmpCharset = (char *)nsMsgI18NParseMetaCharset(tmpFile);</span>
<a href="#l5.631"></a><span id="l5.631">           if (tmpCharset[0] != '\0')</span>
<a href="#l5.632"></a><span id="l5.632" class="difflineminus">-            m_attachments[i].m_charset = tmpCharset;</span>
<a href="#l5.633"></a><span id="l5.633" class="difflineplus">+            m_attachments[i]-&gt;m_charset = tmpCharset;</span>
<a href="#l5.634"></a><span id="l5.634">         }</span>
<a href="#l5.635"></a><span id="l5.635">       }</span>
<a href="#l5.636"></a><span id="l5.636"> </span>
<a href="#l5.637"></a><span id="l5.637" class="difflineminus">-      attachedFile-&gt;GetDescription(m_attachments[i].m_description);</span>
<a href="#l5.638"></a><span id="l5.638" class="difflineminus">-      attachedFile-&gt;GetRealName(m_attachments[i].m_realName);</span>
<a href="#l5.639"></a><span id="l5.639" class="difflineminus">-      attachedFile-&gt;GetXMacType(m_attachments[i].m_xMacType);</span>
<a href="#l5.640"></a><span id="l5.640" class="difflineminus">-      attachedFile-&gt;GetXMacCreator(m_attachments[i].m_xMacCreator);</span>
<a href="#l5.641"></a><span id="l5.641" class="difflineminus">-      attachedFile-&gt;GetEncoding(m_attachments[i].m_encoding);</span>
<a href="#l5.642"></a><span id="l5.642" class="difflineminus">-</span>
<a href="#l5.643"></a><span id="l5.643" class="difflineminus">-      if (m_attachments[i].mTmpFile)</span>
<a href="#l5.644"></a><span id="l5.644" class="difflineplus">+      attachedFile-&gt;GetDescription(m_attachments[i]-&gt;m_description);</span>
<a href="#l5.645"></a><span id="l5.645" class="difflineplus">+      attachedFile-&gt;GetRealName(m_attachments[i]-&gt;m_realName);</span>
<a href="#l5.646"></a><span id="l5.646" class="difflineplus">+      attachedFile-&gt;GetXMacType(m_attachments[i]-&gt;m_xMacType);</span>
<a href="#l5.647"></a><span id="l5.647" class="difflineplus">+      attachedFile-&gt;GetXMacCreator(m_attachments[i]-&gt;m_xMacCreator);</span>
<a href="#l5.648"></a><span id="l5.648" class="difflineplus">+      attachedFile-&gt;GetEncoding(m_attachments[i]-&gt;m_encoding);</span>
<a href="#l5.649"></a><span id="l5.649" class="difflineplus">+</span>
<a href="#l5.650"></a><span id="l5.650" class="difflineplus">+      if (m_attachments[i]-&gt;mTmpFile)</span>
<a href="#l5.651"></a><span id="l5.651">       {</span>
<a href="#l5.652"></a><span id="l5.652" class="difflineminus">-        if (m_attachments[i].mDeleteFile)</span>
<a href="#l5.653"></a><span id="l5.653" class="difflineminus">-          m_attachments[i].mTmpFile-&gt;Remove(false);</span>
<a href="#l5.654"></a><span id="l5.654" class="difflineminus">-        m_attachments[i].mTmpFile = nullptr;</span>
<a href="#l5.655"></a><span id="l5.655" class="difflineplus">+        if (m_attachments[i]-&gt;mDeleteFile)</span>
<a href="#l5.656"></a><span id="l5.656" class="difflineplus">+          m_attachments[i]-&gt;mTmpFile-&gt;Remove(false);</span>
<a href="#l5.657"></a><span id="l5.657" class="difflineplus">+        m_attachments[i]-&gt;mTmpFile = nullptr;</span>
<a href="#l5.658"></a><span id="l5.658">       }</span>
<a href="#l5.659"></a><span id="l5.659" class="difflineminus">-      attachedFile-&gt;GetTmpFile(getter_AddRefs(m_attachments[i].mTmpFile));</span>
<a href="#l5.660"></a><span id="l5.660" class="difflineminus">-</span>
<a href="#l5.661"></a><span id="l5.661" class="difflineminus">-      attachedFile-&gt;GetSize(&amp;m_attachments[i].m_size);</span>
<a href="#l5.662"></a><span id="l5.662" class="difflineminus">-      attachedFile-&gt;GetUnprintableCount(&amp;m_attachments[i].m_unprintable_count);</span>
<a href="#l5.663"></a><span id="l5.663" class="difflineminus">-      attachedFile-&gt;GetHighbitCount(&amp;m_attachments[i].m_highbit_count);</span>
<a href="#l5.664"></a><span id="l5.664" class="difflineminus">-      attachedFile-&gt;GetCtlCount(&amp;m_attachments[i].m_ctl_count);</span>
<a href="#l5.665"></a><span id="l5.665" class="difflineminus">-      attachedFile-&gt;GetNullCount(&amp;m_attachments[i].m_null_count);</span>
<a href="#l5.666"></a><span id="l5.666" class="difflineminus">-      attachedFile-&gt;GetMaxLineLength(&amp;m_attachments[i].m_max_column);</span>
<a href="#l5.667"></a><span id="l5.667" class="difflineplus">+      attachedFile-&gt;GetTmpFile(getter_AddRefs(m_attachments[i]-&gt;mTmpFile));</span>
<a href="#l5.668"></a><span id="l5.668" class="difflineplus">+</span>
<a href="#l5.669"></a><span id="l5.669" class="difflineplus">+      attachedFile-&gt;GetSize(&amp;m_attachments[i]-&gt;m_size);</span>
<a href="#l5.670"></a><span id="l5.670" class="difflineplus">+      attachedFile-&gt;GetUnprintableCount(&amp;m_attachments[i]-&gt;m_unprintable_count);</span>
<a href="#l5.671"></a><span id="l5.671" class="difflineplus">+      attachedFile-&gt;GetHighbitCount(&amp;m_attachments[i]-&gt;m_highbit_count);</span>
<a href="#l5.672"></a><span id="l5.672" class="difflineplus">+      attachedFile-&gt;GetCtlCount(&amp;m_attachments[i]-&gt;m_ctl_count);</span>
<a href="#l5.673"></a><span id="l5.673" class="difflineplus">+      attachedFile-&gt;GetNullCount(&amp;m_attachments[i]-&gt;m_null_count);</span>
<a href="#l5.674"></a><span id="l5.674" class="difflineplus">+      attachedFile-&gt;GetMaxLineLength(&amp;m_attachments[i]-&gt;m_max_column);</span>
<a href="#l5.675"></a><span id="l5.675"> </span>
<a href="#l5.676"></a><span id="l5.676">       /* If the attachment has an encoding, and it's not one of</span>
<a href="#l5.677"></a><span id="l5.677">       the &quot;null&quot; encodings, then keep it. */</span>
<a href="#l5.678"></a><span id="l5.678" class="difflineminus">-      if (!m_attachments[i].m_encoding.IsEmpty() &amp;&amp;</span>
<a href="#l5.679"></a><span id="l5.679" class="difflineminus">-          !m_attachments[i].m_encoding.LowerCaseEqualsLiteral(ENCODING_7BIT) &amp;&amp;</span>
<a href="#l5.680"></a><span id="l5.680" class="difflineminus">-          !m_attachments[i].m_encoding.LowerCaseEqualsLiteral(ENCODING_8BIT) &amp;&amp;</span>
<a href="#l5.681"></a><span id="l5.681" class="difflineminus">-          !m_attachments[i].m_encoding.LowerCaseEqualsLiteral(ENCODING_BINARY))</span>
<a href="#l5.682"></a><span id="l5.682" class="difflineminus">-        m_attachments[i].m_already_encoded_p = true;</span>
<a href="#l5.683"></a><span id="l5.683" class="difflineminus">-</span>
<a href="#l5.684"></a><span id="l5.684" class="difflineminus">-            if (m_attachments[i].mURL)</span>
<a href="#l5.685"></a><span id="l5.685" class="difflineminus">-        msg_pick_real_name(&amp;m_attachments[i], nullptr, mCompFields-&gt;GetCharacterSet());</span>
<a href="#l5.686"></a><span id="l5.686" class="difflineplus">+      if (!m_attachments[i]-&gt;m_encoding.IsEmpty() &amp;&amp;</span>
<a href="#l5.687"></a><span id="l5.687" class="difflineplus">+          !m_attachments[i]-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_7BIT) &amp;&amp;</span>
<a href="#l5.688"></a><span id="l5.688" class="difflineplus">+          !m_attachments[i]-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_8BIT) &amp;&amp;</span>
<a href="#l5.689"></a><span id="l5.689" class="difflineplus">+          !m_attachments[i]-&gt;m_encoding.LowerCaseEqualsLiteral(ENCODING_BINARY))</span>
<a href="#l5.690"></a><span id="l5.690" class="difflineplus">+        m_attachments[i]-&gt;m_already_encoded_p = true;</span>
<a href="#l5.691"></a><span id="l5.691" class="difflineplus">+</span>
<a href="#l5.692"></a><span id="l5.692" class="difflineplus">+            if (m_attachments[i]-&gt;mURL)</span>
<a href="#l5.693"></a><span id="l5.693" class="difflineplus">+        msg_pick_real_name(m_attachments[i], nullptr, mCompFields-&gt;GetCharacterSet());</span>
<a href="#l5.694"></a><span id="l5.694">     }</span>
<a href="#l5.695"></a><span id="l5.695">   }</span>
<a href="#l5.696"></a><span id="l5.696"> </span>
<a href="#l5.697"></a><span id="l5.697">   // First, handle the multipart related attachments if any...</span>
<a href="#l5.698"></a><span id="l5.698">   //</span>
<a href="#l5.699"></a><span id="l5.699">   int32_t mailbox_count = 0, news_count = 0;</span>
<a href="#l5.700"></a><span id="l5.700">   int32_t multipartRelatedCount = GetMultipartRelatedCount();</span>
<a href="#l5.701"></a><span id="l5.701"> </span>
<a href="#l5.702"></a><span id="l5.702" class="difflineat">@@ -2505,50 +2501,50 @@ nsMsgComposeAndSend::HackAttachments(nsI</span>
<a href="#l5.703"></a><span id="l5.703">     int32_t     locCount = -1;</span>
<a href="#l5.704"></a><span id="l5.704"> </span>
<a href="#l5.705"></a><span id="l5.705">     for (i = (mPreloadedAttachmentCount + GetMultipartRelatedCount() + mCompFieldRemoteAttachments); i &lt; m_attachment_count; i++)</span>
<a href="#l5.706"></a><span id="l5.706">     {</span>
<a href="#l5.707"></a><span id="l5.707">       locCount++;</span>
<a href="#l5.708"></a><span id="l5.708">       nsCOMPtr&lt;nsIMsgAttachmentData&gt; attachment(do_QueryElementAt(attachments, i));</span>
<a href="#l5.709"></a><span id="l5.709">       if (!attachment)</span>
<a href="#l5.710"></a><span id="l5.710">         continue;</span>
<a href="#l5.711"></a><span id="l5.711" class="difflineminus">-      m_attachments[i].mDeleteFile = true;</span>
<a href="#l5.712"></a><span id="l5.712" class="difflineminus">-      m_attachments[i].m_done = false;</span>
<a href="#l5.713"></a><span id="l5.713" class="difflineminus">-      m_attachments[i].SetMimeDeliveryState(this);</span>
<a href="#l5.714"></a><span id="l5.714" class="difflineminus">-</span>
<a href="#l5.715"></a><span id="l5.715" class="difflineminus">-      attachment-&gt;GetUrl(getter_AddRefs(m_attachments[i].mURL));</span>
<a href="#l5.716"></a><span id="l5.716" class="difflineminus">-</span>
<a href="#l5.717"></a><span id="l5.717" class="difflineminus">-      attachment-&gt;GetRealType(m_attachments[i].m_overrideType);</span>
<a href="#l5.718"></a><span id="l5.718" class="difflineminus">-      m_attachments[i].m_charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l5.719"></a><span id="l5.719" class="difflineminus">-      attachment-&gt;GetRealEncoding(m_attachments[i].m_overrideEncoding);</span>
<a href="#l5.720"></a><span id="l5.720" class="difflineminus">-      attachment-&gt;GetDesiredType(m_attachments[i].m_desiredType);</span>
<a href="#l5.721"></a><span id="l5.721" class="difflineminus">-      attachment-&gt;GetDescription(m_attachments[i].m_description);</span>
<a href="#l5.722"></a><span id="l5.722" class="difflineminus">-      attachment-&gt;GetRealName(m_attachments[i].m_realName);</span>
<a href="#l5.723"></a><span id="l5.723" class="difflineminus">-      attachment-&gt;GetXMacType(m_attachments[i].m_xMacType);</span>
<a href="#l5.724"></a><span id="l5.724" class="difflineminus">-      attachment-&gt;GetXMacCreator(m_attachments[i].m_xMacCreator);</span>
<a href="#l5.725"></a><span id="l5.725" class="difflineminus">-      m_attachments[i].m_encoding = ENCODING_7BIT;</span>
<a href="#l5.726"></a><span id="l5.726" class="difflineplus">+      m_attachments[i]-&gt;mDeleteFile = true;</span>
<a href="#l5.727"></a><span id="l5.727" class="difflineplus">+      m_attachments[i]-&gt;m_done = false;</span>
<a href="#l5.728"></a><span id="l5.728" class="difflineplus">+      m_attachments[i]-&gt;SetMimeDeliveryState(this);</span>
<a href="#l5.729"></a><span id="l5.729" class="difflineplus">+</span>
<a href="#l5.730"></a><span id="l5.730" class="difflineplus">+      attachment-&gt;GetUrl(getter_AddRefs(m_attachments[i]-&gt;mURL));</span>
<a href="#l5.731"></a><span id="l5.731" class="difflineplus">+</span>
<a href="#l5.732"></a><span id="l5.732" class="difflineplus">+      attachment-&gt;GetRealType(m_attachments[i]-&gt;m_overrideType);</span>
<a href="#l5.733"></a><span id="l5.733" class="difflineplus">+      m_attachments[i]-&gt;m_charset = mCompFields-&gt;GetCharacterSet();</span>
<a href="#l5.734"></a><span id="l5.734" class="difflineplus">+      attachment-&gt;GetRealEncoding(m_attachments[i]-&gt;m_overrideEncoding);</span>
<a href="#l5.735"></a><span id="l5.735" class="difflineplus">+      attachment-&gt;GetDesiredType(m_attachments[i]-&gt;m_desiredType);</span>
<a href="#l5.736"></a><span id="l5.736" class="difflineplus">+      attachment-&gt;GetDescription(m_attachments[i]-&gt;m_description);</span>
<a href="#l5.737"></a><span id="l5.737" class="difflineplus">+      attachment-&gt;GetRealName(m_attachments[i]-&gt;m_realName);</span>
<a href="#l5.738"></a><span id="l5.738" class="difflineplus">+      attachment-&gt;GetXMacType(m_attachments[i]-&gt;m_xMacType);</span>
<a href="#l5.739"></a><span id="l5.739" class="difflineplus">+      attachment-&gt;GetXMacCreator(m_attachments[i]-&gt;m_xMacCreator);</span>
<a href="#l5.740"></a><span id="l5.740" class="difflineplus">+      m_attachments[i]-&gt;m_encoding = ENCODING_7BIT;</span>
<a href="#l5.741"></a><span id="l5.741"> </span>
<a href="#l5.742"></a><span id="l5.742">       // real name is set in the case of vcard so don't change it.  XXX STILL NEEDED?</span>
<a href="#l5.743"></a><span id="l5.743" class="difflineminus">-      // m_attachments[i].m_real_name = 0;</span>
<a href="#l5.744"></a><span id="l5.744" class="difflineplus">+      // m_attachments[i]-&gt;m_real_name = 0;</span>
<a href="#l5.745"></a><span id="l5.745"> </span>
<a href="#l5.746"></a><span id="l5.746">       /* Count up attachments which are going to come from mail folders</span>
<a href="#l5.747"></a><span id="l5.747">       and from NNTP servers. */</span>
<a href="#l5.748"></a><span id="l5.748" class="difflineminus">-    if (m_attachments[i].mURL)</span>
<a href="#l5.749"></a><span id="l5.749" class="difflineplus">+    if (m_attachments[i]-&gt;mURL)</span>
<a href="#l5.750"></a><span id="l5.750">     {</span>
<a href="#l5.751"></a><span id="l5.751" class="difflineminus">-    nsIURI *uri = m_attachments[i].mURL;</span>
<a href="#l5.752"></a><span id="l5.752" class="difflineplus">+    nsIURI *uri = m_attachments[i]-&gt;mURL;</span>
<a href="#l5.753"></a><span id="l5.753">     bool match = false;</span>
<a href="#l5.754"></a><span id="l5.754">     if ((NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;mailbox&quot;, &amp;match)) &amp;&amp; match) ||</span>
<a href="#l5.755"></a><span id="l5.755">       (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;imap&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l5.756"></a><span id="l5.756">       mailbox_count++;</span>
<a href="#l5.757"></a><span id="l5.757">     else if ((NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;news&quot;, &amp;match)) &amp;&amp; match) ||</span>
<a href="#l5.758"></a><span id="l5.758">            (NS_SUCCEEDED(uri-&gt;SchemeIs(&quot;snews&quot;, &amp;match)) &amp;&amp; match))</span>
<a href="#l5.759"></a><span id="l5.759">         news_count++;</span>
<a href="#l5.760"></a><span id="l5.760"> </span>
<a href="#l5.761"></a><span id="l5.761">       if (uri)</span>
<a href="#l5.762"></a><span id="l5.762" class="difflineminus">-        msg_pick_real_name(&amp;m_attachments[i], nullptr, mCompFields-&gt;GetCharacterSet());</span>
<a href="#l5.763"></a><span id="l5.763" class="difflineplus">+        msg_pick_real_name(m_attachments[i], nullptr, mCompFields-&gt;GetCharacterSet());</span>
<a href="#l5.764"></a><span id="l5.764">       }</span>
<a href="#l5.765"></a><span id="l5.765">     }</span>
<a href="#l5.766"></a><span id="l5.766">   }</span>
<a href="#l5.767"></a><span id="l5.767"> </span>
<a href="#l5.768"></a><span id="l5.768">   bool needToCallGatherMimeAttachments = true;</span>
<a href="#l5.769"></a><span id="l5.769"> </span>
<a href="#l5.770"></a><span id="l5.770">   if (m_attachment_count &gt; 0)</span>
<a href="#l5.771"></a><span id="l5.771">   {</span>
<a href="#l5.772"></a><span id="l5.772" class="difflineat">@@ -2559,63 +2555,63 @@ nsMsgComposeAndSend::HackAttachments(nsI</span>
<a href="#l5.773"></a><span id="l5.773"> </span>
<a href="#l5.774"></a><span id="l5.774">     m_attachment_pending_count = m_attachment_count;</span>
<a href="#l5.775"></a><span id="l5.775"> </span>
<a href="#l5.776"></a><span id="l5.776">     // Start the URL attachments loading (eventually, an exit routine will</span>
<a href="#l5.777"></a><span id="l5.777">     // call the done_callback).</span>
<a href="#l5.778"></a><span id="l5.778"> </span>
<a href="#l5.779"></a><span id="l5.779">     for (i = 0; i &lt; m_attachment_count; i++)</span>
<a href="#l5.780"></a><span id="l5.780">     {</span>
<a href="#l5.781"></a><span id="l5.781" class="difflineminus">-      if (m_attachments[i].m_done || m_attachments[i].mSendViaCloud)</span>
<a href="#l5.782"></a><span id="l5.782" class="difflineplus">+      if (m_attachments[i]-&gt;m_done || m_attachments[i]-&gt;mSendViaCloud)</span>
<a href="#l5.783"></a><span id="l5.783">       {</span>
<a href="#l5.784"></a><span id="l5.784">         m_attachment_pending_count--;</span>
<a href="#l5.785"></a><span id="l5.785">         continue;</span>
<a href="#l5.786"></a><span id="l5.786">       }</span>
<a href="#l5.787"></a><span id="l5.787"> </span>
<a href="#l5.788"></a><span id="l5.788">       //</span>
<a href="#l5.789"></a><span id="l5.789">       //  IF we get here and the URL is NULL, just dec the pending count and move on!!!</span>
<a href="#l5.790"></a><span id="l5.790">       //</span>
<a href="#l5.791"></a><span id="l5.791" class="difflineminus">-      if ( (!m_attachments[i].mURL) &amp;&amp; (!m_attachments[i].m_uri.Length()) )</span>
<a href="#l5.792"></a><span id="l5.792" class="difflineplus">+      if ( (!m_attachments[i]-&gt;mURL) &amp;&amp; (!m_attachments[i]-&gt;m_uri.Length()) )</span>
<a href="#l5.793"></a><span id="l5.793">       {</span>
<a href="#l5.794"></a><span id="l5.794" class="difflineminus">-        m_attachments[i].m_bogus_attachment = true;</span>
<a href="#l5.795"></a><span id="l5.795" class="difflineminus">-        m_attachments[i].m_done = true;</span>
<a href="#l5.796"></a><span id="l5.796" class="difflineminus">-        m_attachments[i].SetMimeDeliveryState(nullptr);</span>
<a href="#l5.797"></a><span id="l5.797" class="difflineplus">+        m_attachments[i]-&gt;m_bogus_attachment = true;</span>
<a href="#l5.798"></a><span id="l5.798" class="difflineplus">+        m_attachments[i]-&gt;m_done = true;</span>
<a href="#l5.799"></a><span id="l5.799" class="difflineplus">+        m_attachments[i]-&gt;SetMimeDeliveryState(nullptr);</span>
<a href="#l5.800"></a><span id="l5.800">         m_attachment_pending_count--;</span>
<a href="#l5.801"></a><span id="l5.801">         continue;</span>
<a href="#l5.802"></a><span id="l5.802">       }</span>
<a href="#l5.803"></a><span id="l5.803"> </span>
<a href="#l5.804"></a><span id="l5.804">       //</span>
<a href="#l5.805"></a><span id="l5.805">       // This only returns a failure code if NET_GetURL was not called</span>
<a href="#l5.806"></a><span id="l5.806">       // (and thus no exit routine was or will be called.)</span>
<a href="#l5.807"></a><span id="l5.807">       //</span>
<a href="#l5.808"></a><span id="l5.808"> </span>
<a href="#l5.809"></a><span id="l5.809">       // Display some feedback to user...</span>
<a href="#l5.810"></a><span id="l5.810">       PRUnichar     *printfString = nullptr;</span>
<a href="#l5.811"></a><span id="l5.811">       nsString msg;</span>
<a href="#l5.812"></a><span id="l5.812">       mComposeBundle-&gt;GetStringFromID(NS_MSG_GATHERING_ATTACHMENT, getter_Copies(msg));</span>
<a href="#l5.813"></a><span id="l5.813"> </span>
<a href="#l5.814"></a><span id="l5.814" class="difflineminus">-      printfString = nsTextFormatter::smprintf(msg.get(), m_attachments[i].m_realName.get());</span>
<a href="#l5.815"></a><span id="l5.815" class="difflineplus">+      printfString = nsTextFormatter::smprintf(msg.get(), m_attachments[i]-&gt;m_realName.get());</span>
<a href="#l5.816"></a><span id="l5.816"> </span>
<a href="#l5.817"></a><span id="l5.817">       if (printfString)</span>
<a href="#l5.818"></a><span id="l5.818">       {</span>
<a href="#l5.819"></a><span id="l5.819">         SetStatusMessage(nsDependentString(printfString));</span>
<a href="#l5.820"></a><span id="l5.820">         PR_Free(printfString);</span>
<a href="#l5.821"></a><span id="l5.821">       }</span>
<a href="#l5.822"></a><span id="l5.822"> </span>
<a href="#l5.823"></a><span id="l5.823">       /* As SnarfAttachment will call GatherMimeAttachments when it will be done (this is an async process),</span>
<a href="#l5.824"></a><span id="l5.824">          we need to avoid to call it ourself.</span>
<a href="#l5.825"></a><span id="l5.825">       */</span>
<a href="#l5.826"></a><span id="l5.826">       needToCallGatherMimeAttachments = false;</span>
<a href="#l5.827"></a><span id="l5.827"> </span>
<a href="#l5.828"></a><span id="l5.828" class="difflineminus">-      nsresult status = m_attachments[i].SnarfAttachment(mCompFields);</span>
<a href="#l5.829"></a><span id="l5.829" class="difflineplus">+      nsresult status = m_attachments[i]-&gt;SnarfAttachment(mCompFields);</span>
<a href="#l5.830"></a><span id="l5.830">       if (NS_FAILED(status))</span>
<a href="#l5.831"></a><span id="l5.831">       {</span>
<a href="#l5.832"></a><span id="l5.832">         nsString errorMsg;</span>
<a href="#l5.833"></a><span id="l5.833">         nsAutoString attachmentFileName;</span>
<a href="#l5.834"></a><span id="l5.834" class="difflineminus">-        nsresult rv = ConvertToUnicode(nsMsgI18NFileSystemCharset(), m_attachments[i].m_realName, attachmentFileName);</span>
<a href="#l5.835"></a><span id="l5.835" class="difflineplus">+        nsresult rv = ConvertToUnicode(nsMsgI18NFileSystemCharset(), m_attachments[i]-&gt;m_realName, attachmentFileName);</span>
<a href="#l5.836"></a><span id="l5.836">         if (NS_SUCCEEDED(rv))</span>
<a href="#l5.837"></a><span id="l5.837">         {</span>
<a href="#l5.838"></a><span id="l5.838">           nsCOMPtr&lt;nsIStringBundle&gt; bundle;</span>
<a href="#l5.839"></a><span id="l5.839">           const PRUnichar *params[] = { attachmentFileName.get() };</span>
<a href="#l5.840"></a><span id="l5.840">           mComposeBundle-&gt;FormatStringFromID(NS_ERROR_GET_CODE(NS_MSG_ERROR_ATTACHING_FILE), params, 1, getter_Copies(errorMsg));</span>
<a href="#l5.841"></a><span id="l5.841">           mSendReport-&gt;SetMessage(nsIMsgSendReport::process_Current, errorMsg.get(), false);</span>
<a href="#l5.842"></a><span id="l5.842">           mSendReport-&gt;SetError(nsIMsgSendReport::process_Current,</span>
<a href="#l5.843"></a><span id="l5.843">               // XXX The following applies NS_ERROR_GENERATE_FAILURE twice,</span>
<a href="#l5.844"></a><span id="l5.844" class="difflineat">@@ -4851,24 +4847,21 @@ nsresult nsMsgComposeAndSend::Abort()</span>
<a href="#l5.845"></a><span id="l5.845">   if (mAbortInProcess)</span>
<a href="#l5.846"></a><span id="l5.846">     return NS_OK;</span>
<a href="#l5.847"></a><span id="l5.847"> </span>
<a href="#l5.848"></a><span id="l5.848">   mAbortInProcess = true;</span>
<a href="#l5.849"></a><span id="l5.849"> </span>
<a href="#l5.850"></a><span id="l5.850">   if (m_plaintext)</span>
<a href="#l5.851"></a><span id="l5.851">     rv = m_plaintext-&gt;Abort();</span>
<a href="#l5.852"></a><span id="l5.852"> </span>
<a href="#l5.853"></a><span id="l5.853" class="difflineminus">-  if (m_attachments)</span>
<a href="#l5.854"></a><span id="l5.854" class="difflineplus">+  for (i = 0; i &lt; m_attachment_count; i ++)</span>
<a href="#l5.855"></a><span id="l5.855">   {</span>
<a href="#l5.856"></a><span id="l5.856" class="difflineminus">-    for (i = 0; i &lt; m_attachment_count; i ++)</span>
<a href="#l5.857"></a><span id="l5.857" class="difflineminus">-    {</span>
<a href="#l5.858"></a><span id="l5.858" class="difflineminus">-      nsMsgAttachmentHandler *ma = &amp;m_attachments[i];</span>
<a href="#l5.859"></a><span id="l5.859" class="difflineminus">-      if (ma)</span>
<a href="#l5.860"></a><span id="l5.860" class="difflineminus">-        rv = ma-&gt;Abort();</span>
<a href="#l5.861"></a><span id="l5.861" class="difflineminus">-    }</span>
<a href="#l5.862"></a><span id="l5.862" class="difflineplus">+    nsMsgAttachmentHandler *ma = m_attachments[i];</span>
<a href="#l5.863"></a><span id="l5.863" class="difflineplus">+    if (ma)</span>
<a href="#l5.864"></a><span id="l5.864" class="difflineplus">+      rv = ma-&gt;Abort();</span>
<a href="#l5.865"></a><span id="l5.865">   }</span>
<a href="#l5.866"></a><span id="l5.866"> </span>
<a href="#l5.867"></a><span id="l5.867">   /* stop the current running url */</span>
<a href="#l5.868"></a><span id="l5.868">   if (mRunningRequest)</span>
<a href="#l5.869"></a><span id="l5.869">   {</span>
<a href="#l5.870"></a><span id="l5.870">     mRunningRequest-&gt;Cancel(NS_ERROR_ABORT);</span>
<a href="#l5.871"></a><span id="l5.871">     mRunningRequest = nullptr;</span>
<a href="#l5.872"></a><span id="l5.872">   }</span>
<a href="#l5.873"></a><span id="l5.873" class="difflineat">@@ -4886,20 +4879,20 @@ nsresult nsMsgComposeAndSend::Abort()</span>
<a href="#l5.874"></a><span id="l5.874"> </span>
<a href="#l5.875"></a><span id="l5.875"> NS_IMETHODIMP nsMsgComposeAndSend::GetProcessAttachmentsSynchronously(bool *_retval)</span>
<a href="#l5.876"></a><span id="l5.876"> {</span>
<a href="#l5.877"></a><span id="l5.877">   NS_ENSURE_ARG(_retval);</span>
<a href="#l5.878"></a><span id="l5.878">   *_retval = m_be_synchronous_p;</span>
<a href="#l5.879"></a><span id="l5.879">   return NS_OK;</span>
<a href="#l5.880"></a><span id="l5.880"> }</span>
<a href="#l5.881"></a><span id="l5.881"> </span>
<a href="#l5.882"></a><span id="l5.882" class="difflineminus">-NS_IMETHODIMP nsMsgComposeAndSend::GetAttachmentHandlers(nsMsgAttachmentHandler * *_retval)</span>
<a href="#l5.883"></a><span id="l5.883" class="difflineplus">+NS_IMETHODIMP nsMsgComposeAndSend::GetAttachmentHandlers(nsTArray&lt;nsRefPtr&lt;nsMsgAttachmentHandler&gt;&gt; **_retval)</span>
<a href="#l5.884"></a><span id="l5.884"> {</span>
<a href="#l5.885"></a><span id="l5.885">   NS_ENSURE_ARG(_retval);</span>
<a href="#l5.886"></a><span id="l5.886" class="difflineminus">-  *_retval = m_attachments;</span>
<a href="#l5.887"></a><span id="l5.887" class="difflineplus">+  *_retval = &amp;m_attachments;</span>
<a href="#l5.888"></a><span id="l5.888">   return NS_OK;</span>
<a href="#l5.889"></a><span id="l5.889"> }</span>
<a href="#l5.890"></a><span id="l5.890"> </span>
<a href="#l5.891"></a><span id="l5.891"> NS_IMETHODIMP nsMsgComposeAndSend::GetAttachmentCount(uint32_t *aAttachmentCount)</span>
<a href="#l5.892"></a><span id="l5.892"> {</span>
<a href="#l5.893"></a><span id="l5.893">   NS_ENSURE_ARG(aAttachmentCount);</span>
<a href="#l5.894"></a><span id="l5.894">   *aAttachmentCount = m_attachment_count;</span>
<a href="#l5.895"></a><span id="l5.895">   return NS_OK;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/compose/src/nsMsgSend.h</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -313,28 +313,28 @@ public:</span>
<a href="#l6.4"></a><span id="l6.4">   char                    *m_attachment1_type;</span>
<a href="#l6.5"></a><span id="l6.5">   char                    *m_attachment1_encoding;</span>
<a href="#l6.6"></a><span id="l6.6">   nsAutoPtr&lt;MimeEncoder&gt;  m_attachment1_encoder;</span>
<a href="#l6.7"></a><span id="l6.7">   char                    *m_attachment1_body;</span>
<a href="#l6.8"></a><span id="l6.8">   uint32_t                m_attachment1_body_length;</span>
<a href="#l6.9"></a><span id="l6.9">   char                    *mOriginalHTMLBody;</span>
<a href="#l6.10"></a><span id="l6.10"> </span>
<a href="#l6.11"></a><span id="l6.11">   // The plaintext form of the first attachment, if needed.</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-  nsMsgAttachmentHandler  *m_plaintext;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+  nsRefPtr&lt;nsMsgAttachmentHandler&gt;  m_plaintext;</span>
<a href="#l6.14"></a><span id="l6.14"> </span>
<a href="#l6.15"></a><span id="l6.15">   // The multipart/related save object for HTML text.</span>
<a href="#l6.16"></a><span id="l6.16">   nsMsgSendPart           *m_related_part;</span>
<a href="#l6.17"></a><span id="l6.17">   nsMsgSendPart           *m_related_body_part;</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">   //</span>
<a href="#l6.20"></a><span id="l6.20">   // Subsequent attachments, if any.</span>
<a href="#l6.21"></a><span id="l6.21">   //</span>
<a href="#l6.22"></a><span id="l6.22">   uint32_t                m_attachment_count;</span>
<a href="#l6.23"></a><span id="l6.23">   uint32_t                m_attachment_pending_count;</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-  nsMsgAttachmentHandler  *m_attachments;</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+  nsTArray&lt; nsRefPtr&lt;nsMsgAttachmentHandler&gt; &gt;  m_attachments;</span>
<a href="#l6.26"></a><span id="l6.26">   nsresult                m_status; // in case some attachments fail but not all</span>
<a href="#l6.27"></a><span id="l6.27"> </span>
<a href="#l6.28"></a><span id="l6.28">   uint32_t                mPreloadedAttachmentCount;</span>
<a href="#l6.29"></a><span id="l6.29">   uint32_t                mRemoteAttachmentCount;</span>
<a href="#l6.30"></a><span id="l6.30">   int32_t                 mMultipartRelatedAttachmentCount; // the number of mpart related attachments, -1 means it has not been yet initialized</span>
<a href="#l6.31"></a><span id="l6.31"> </span>
<a href="#l6.32"></a><span id="l6.32">   uint32_t                mCompFieldLocalAttachments;     // the number of file:// attachments in the comp fields</span>
<a href="#l6.33"></a><span id="l6.33">   uint32_t                mCompFieldRemoteAttachments;    // the number of remote attachments in the comp fields</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/compose/src/nsURLFetcher.cpp</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/compose/src/nsURLFetcher.cpp</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -206,34 +206,33 @@ nsURLFetcher::OnDataAvailable(nsIRequest</span>
<a href="#l7.4"></a><span id="l7.4"> }</span>
<a href="#l7.5"></a><span id="l7.5"> </span>
<a href="#l7.6"></a><span id="l7.6"> </span>
<a href="#l7.7"></a><span id="l7.7"> // Methods for nsIStreamObserver </span>
<a href="#l7.8"></a><span id="l7.8"> nsresult</span>
<a href="#l7.9"></a><span id="l7.9"> nsURLFetcher::OnStartRequest(nsIRequest *request, nsISupports *ctxt)</span>
<a href="#l7.10"></a><span id="l7.10"> {</span>
<a href="#l7.11"></a><span id="l7.11">   /* check if the user has canceld the operation */</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  nsMsgAttachmentHandler *attachmentHdl = (nsMsgAttachmentHandler *)mTagData;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-  if (attachmentHdl)</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineplus">+  if (mTagData)</span>
<a href="#l7.15"></a><span id="l7.15">   {</span>
<a href="#l7.16"></a><span id="l7.16">     nsCOMPtr&lt;nsIMsgSend&gt; sendPtr;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-    attachmentHdl-&gt;GetMimeDeliveryState(getter_AddRefs(sendPtr));</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineplus">+    mTagData-&gt;GetMimeDeliveryState(getter_AddRefs(sendPtr));</span>
<a href="#l7.19"></a><span id="l7.19">     if (sendPtr)</span>
<a href="#l7.20"></a><span id="l7.20">     {</span>
<a href="#l7.21"></a><span id="l7.21">       nsCOMPtr&lt;nsIMsgProgress&gt; progress;</span>
<a href="#l7.22"></a><span id="l7.22">       sendPtr-&gt;GetProgress(getter_AddRefs(progress));</span>
<a href="#l7.23"></a><span id="l7.23">       if (progress)</span>
<a href="#l7.24"></a><span id="l7.24">       {</span>
<a href="#l7.25"></a><span id="l7.25">         bool cancel = false;</span>
<a href="#l7.26"></a><span id="l7.26">         progress-&gt;GetProcessCanceledByUser(&amp;cancel);</span>
<a href="#l7.27"></a><span id="l7.27">         if (cancel)</span>
<a href="#l7.28"></a><span id="l7.28">           return request-&gt;Cancel(NS_ERROR_ABORT);</span>
<a href="#l7.29"></a><span id="l7.29">       }</span>
<a href="#l7.30"></a><span id="l7.30">     }</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineminus">-    attachmentHdl-&gt;mRequest = request;</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+    mTagData-&gt;mRequest = request;</span>
<a href="#l7.33"></a><span id="l7.33">   }</span>
<a href="#l7.34"></a><span id="l7.34"> </span>
<a href="#l7.35"></a><span id="l7.35">   /* call our converter or consumer */</span>
<a href="#l7.36"></a><span id="l7.36">   if (mConverter)</span>
<a href="#l7.37"></a><span id="l7.37">     return mConverter-&gt;OnStartRequest(request, ctxt);</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39">   return NS_OK;</span>
<a href="#l7.40"></a><span id="l7.40"> }</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineat">@@ -249,19 +248,18 @@ nsURLFetcher::OnStopRequest(nsIRequest *</span>
<a href="#l7.42"></a><span id="l7.42">     return NS_OK;</span>
<a href="#l7.43"></a><span id="l7.43"> </span>
<a href="#l7.44"></a><span id="l7.44">   mOnStopRequestProcessed = true;</span>
<a href="#l7.45"></a><span id="l7.45"> </span>
<a href="#l7.46"></a><span id="l7.46">   /* first, call our converter or consumer */</span>
<a href="#l7.47"></a><span id="l7.47">   if (mConverter)</span>
<a href="#l7.48"></a><span id="l7.48">     (void) mConverter-&gt;OnStopRequest(request, ctxt, aStatus);</span>
<a href="#l7.49"></a><span id="l7.49"> </span>
<a href="#l7.50"></a><span id="l7.50" class="difflineminus">-  nsMsgAttachmentHandler *attachmentHdl = (nsMsgAttachmentHandler *)mTagData;</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-  if (attachmentHdl)</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineminus">-    attachmentHdl-&gt;mRequest = nullptr;</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+  if (mTagData)</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+    mTagData-&gt;mRequest = nullptr;</span>
<a href="#l7.55"></a><span id="l7.55"> </span>
<a href="#l7.56"></a><span id="l7.56">   //</span>
<a href="#l7.57"></a><span id="l7.57">   // Now complete the stream!</span>
<a href="#l7.58"></a><span id="l7.58">   //</span>
<a href="#l7.59"></a><span id="l7.59">   mStillRunning = false;</span>
<a href="#l7.60"></a><span id="l7.60"> </span>
<a href="#l7.61"></a><span id="l7.61">   // time to close the output stream...</span>
<a href="#l7.62"></a><span id="l7.62">   if (mOutStream)</span>
<a href="#l7.63"></a><span id="l7.63" class="difflineat">@@ -283,31 +281,31 @@ nsURLFetcher::OnStopRequest(nsIRequest *</span>
<a href="#l7.64"></a><span id="l7.64">   // Time to return...</span>
<a href="#l7.65"></a><span id="l7.65">   return NS_OK;</span>
<a href="#l7.66"></a><span id="l7.66"> }</span>
<a href="#l7.67"></a><span id="l7.67"> </span>
<a href="#l7.68"></a><span id="l7.68"> nsresult </span>
<a href="#l7.69"></a><span id="l7.69"> nsURLFetcher::Initialize(nsIFile *localFile, </span>
<a href="#l7.70"></a><span id="l7.70">                          nsIOutputStream *outputStream,</span>
<a href="#l7.71"></a><span id="l7.71">                          nsAttachSaveCompletionCallback cb, </span>
<a href="#l7.72"></a><span id="l7.72" class="difflineminus">-                         void *tagData)</span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+                         nsMsgAttachmentHandler *tagData)</span>
<a href="#l7.74"></a><span id="l7.74"> {</span>
<a href="#l7.75"></a><span id="l7.75">   if (!outputStream || !localFile)</span>
<a href="#l7.76"></a><span id="l7.76">     return NS_ERROR_INVALID_ARG;</span>
<a href="#l7.77"></a><span id="l7.77"> </span>
<a href="#l7.78"></a><span id="l7.78">   mOutStream = outputStream;</span>
<a href="#l7.79"></a><span id="l7.79">   mLocalFile = localFile;</span>
<a href="#l7.80"></a><span id="l7.80">   mCallback = cb;     //JFD: Please, no more callback, use a listener...</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineminus">-  mTagData = tagData; //JFD: TODO, WE SHOULD USE A NSCOMPTR to hold this stuff!!!</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+  mTagData = tagData;</span>
<a href="#l7.83"></a><span id="l7.83">   return NS_OK;</span>
<a href="#l7.84"></a><span id="l7.84"> }</span>
<a href="#l7.85"></a><span id="l7.85"> </span>
<a href="#l7.86"></a><span id="l7.86"> nsresult</span>
<a href="#l7.87"></a><span id="l7.87"> nsURLFetcher::FireURLRequest(nsIURI *aURL, nsIFile *localFile, nsIOutputStream *outputStream, </span>
<a href="#l7.88"></a><span id="l7.88" class="difflineminus">-                             nsAttachSaveCompletionCallback cb, void *tagData)</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+                             nsAttachSaveCompletionCallback cb, nsMsgAttachmentHandler *tagData)</span>
<a href="#l7.90"></a><span id="l7.90"> {</span>
<a href="#l7.91"></a><span id="l7.91">   nsresult rv;</span>
<a href="#l7.92"></a><span id="l7.92"> </span>
<a href="#l7.93"></a><span id="l7.93">   rv = Initialize(localFile, outputStream, cb, tagData);</span>
<a href="#l7.94"></a><span id="l7.94">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l7.95"></a><span id="l7.95"> </span>
<a href="#l7.96"></a><span id="l7.96">   //check to see if aURL is a local file or not</span>
<a href="#l7.97"></a><span id="l7.97">   aURL-&gt;SchemeIs(&quot;file&quot;, &amp;mIsFile);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/compose/src/nsURLFetcher.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/compose/src/nsURLFetcher.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -3,27 +3,30 @@</span>
<a href="#l8.4"></a><span id="l8.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.5"></a><span id="l8.5">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.6"></a><span id="l8.6"> #ifndef nsURLFetcher_h_</span>
<a href="#l8.7"></a><span id="l8.7"> #define nsURLFetcher_h_</span>
<a href="#l8.8"></a><span id="l8.8"> </span>
<a href="#l8.9"></a><span id="l8.9"> #include &quot;nsIURLFetcher.h&quot;</span>
<a href="#l8.10"></a><span id="l8.10"> </span>
<a href="#l8.11"></a><span id="l8.11"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l8.13"></a><span id="l8.13"> #include &quot;nsIInputStream.h&quot;</span>
<a href="#l8.14"></a><span id="l8.14"> #include &quot;nsIStreamListener.h&quot;</span>
<a href="#l8.15"></a><span id="l8.15"> </span>
<a href="#l8.16"></a><span id="l8.16"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l8.17"></a><span id="l8.17"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l8.18"></a><span id="l8.18"> #include &quot;nsCURILoader.h&quot;</span>
<a href="#l8.19"></a><span id="l8.19"> #include &quot;nsIURIContentListener.h&quot;</span>
<a href="#l8.20"></a><span id="l8.20"> #include &quot;nsIWebProgressListener.h&quot;</span>
<a href="#l8.21"></a><span id="l8.21"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l8.22"></a><span id="l8.22"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l8.23"></a><span id="l8.23"> </span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+class nsMsgAttachmentHandler;</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+</span>
<a href="#l8.26"></a><span id="l8.26"> class nsURLFetcher : public nsIURLFetcher,</span>
<a href="#l8.27"></a><span id="l8.27">                      public nsIStreamListener,</span>
<a href="#l8.28"></a><span id="l8.28">                      public nsIURIContentListener, </span>
<a href="#l8.29"></a><span id="l8.29">                      public nsIInterfaceRequestor,</span>
<a href="#l8.30"></a><span id="l8.30">                      public nsIWebProgressListener,</span>
<a href="#l8.31"></a><span id="l8.31">                      public nsSupportsWeakReference</span>
<a href="#l8.32"></a><span id="l8.32"> { </span>
<a href="#l8.33"></a><span id="l8.33"> public: </span>
<a href="#l8.34"></a><span id="l8.34" class="difflineat">@@ -60,17 +63,17 @@ private:</span>
<a href="#l8.35"></a><span id="l8.35">   nsCOMPtr&lt;nsIStreamListener&gt;     mConverter;               // the stream converter, if needed</span>
<a href="#l8.36"></a><span id="l8.36">   nsCString                  mConverterContentType;    // The content type of the converter</span>
<a href="#l8.37"></a><span id="l8.37">   bool                            mStillRunning;  // Are we still running?</span>
<a href="#l8.38"></a><span id="l8.38">   int32_t                         mTotalWritten;  // Size counter variable</span>
<a href="#l8.39"></a><span id="l8.39">   char                            *mBuffer;                 // Buffer used for reading the data</span>
<a href="#l8.40"></a><span id="l8.40">   uint32_t                        mBufferSize;              // Buffer size;</span>
<a href="#l8.41"></a><span id="l8.41">   nsCString                  mContentType;             // The content type retrieved from the server</span>
<a href="#l8.42"></a><span id="l8.42">   nsCString                  mCharset;                 // The charset retrieved from the server</span>
<a href="#l8.43"></a><span id="l8.43" class="difflineminus">-  void                            *mTagData;      // Tag data for callback...</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+  nsRefPtr&lt;nsMsgAttachmentHandler&gt; mTagData;      // Tag data for callback...</span>
<a href="#l8.45"></a><span id="l8.45">   nsAttachSaveCompletionCallback  mCallback;      // Callback to call once the file is saved...</span>
<a href="#l8.46"></a><span id="l8.46">   nsCOMPtr&lt;nsISupports&gt;           mLoadCookie;    // load cookie used by the uri loader when we fetch the url</span>
<a href="#l8.47"></a><span id="l8.47">   bool                            mOnStopRequestProcessed; // used to prevent calling OnStopRequest multiple times</span>
<a href="#l8.48"></a><span id="l8.48">   bool                            mIsFile;        // This is used to check whether the URI is a local file.</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50">   friend class nsURLFetcherStreamConsumer;</span>
<a href="#l8.51"></a><span id="l8.51"> }; </span>
<a href="#l8.52"></a><span id="l8.52"> </span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

