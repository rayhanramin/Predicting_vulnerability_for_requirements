<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2946:781f622cb9b73a2a0c825a1065716c9984d3b461</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 781f622cb9b73a2a0c825a1065716c9984d3b461" />
<meta property="og:url" content="/comm-central/rev/781f622cb9b73a2a0c825a1065716c9984d3b461" />
<meta property="og:description" content="Bug 498106 - Collapsed message pane doesn't stay collapsed on tab switch but does suppress message display.  fix message pane issues, implement simple tab persistence, add mozmill test v1. r+sr=bienvenu." />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 781f622cb9b73a2a0c825a1065716c9984d3b461 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/781f622cb9b73a2a0c825a1065716c9984d3b461">shortlog</a> |
<a href="/comm-central/log/781f622cb9b73a2a0c825a1065716c9984d3b461">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/781f622cb9b73a2a0c825a1065716c9984d3b461">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/781f622cb9b73a2a0c825a1065716c9984d3b461">files</a> |
changeset |
<a href="/comm-central/raw-rev/781f622cb9b73a2a0c825a1065716c9984d3b461">raw</a>  | <a href="/comm-central/archive/781f622cb9b73a2a0c825a1065716c9984d3b461.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=498106">Bug 498106</a> - Collapsed message pane doesn't stay collapsed on tab switch but does suppress message display.  fix message pane issues, implement simple tab persistence, add mozmill test v1. r+sr=bienvenu.
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#65;&#110;&#100;&#114;&#101;&#119;&#32;&#83;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#32;&#60;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#64;&#97;&#115;&#117;&#116;&#104;&#101;&#114;&#108;&#97;&#110;&#100;&#46;&#111;&#114;&#103;&#62;</td></tr>
<tr><td></td><td class="date age">Thu, 25 Jun 2009 23:56:03 -0700</td></tr>

<tr>
 <td>changeset 2946</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/781f622cb9b73a2a0c825a1065716c9984d3b461">781f622cb9b73a2a0c825a1065716c9984d3b461</a></td>
</tr>



<tr>
<td>parent 2945</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/87e6de24a564a56d4132785223071bb5ff938a03">87e6de24a564a56d4132785223071bb5ff938a03</a>
</td>
</tr>

<tr>
<td>child 2947</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/06ef7c2129938b47a3b0e88d5431a4718df494b7">06ef7c2129938b47a3b0e88d5431a4718df494b7</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=781f622cb9b73a2a0c825a1065716c9984d3b461">2387</a></td></tr>
<tr><td>push user</td><td>bugmail@asutherland.org</td></tr>
<tr><td>push date</td><td class="date age">Fri, 26 Jun 2009 06:56:17 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@781f622cb9b7 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=781f622cb9b73a2a0c825a1065716c9984d3b461">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=781f622cb9b73a2a0c825a1065716c9984d3b461&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=781f622cb9b73a2a0c825a1065716c9984d3b461&newProject=comm-central&newRevision=781f622cb9b73a2a0c825a1065716c9984d3b461&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=781f622cb9b73a2a0c825a1065716c9984d3b461&newProject=comm-central&newRevision=781f622cb9b73a2a0c825a1065716c9984d3b461&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=781f622cb9b73a2a0c825a1065716c9984d3b461&newProject=comm-central&newRevision=781f622cb9b73a2a0c825a1065716c9984d3b461&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=498106">498106</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=498106">Bug 498106</a> - Collapsed message pane doesn't stay collapsed on tab switch but does suppress message display.  fix message pane issues, implement simple tab persistence, add mozmill test v1. r+sr=bienvenu.</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/folderDisplay.js">mail/base/content/folderDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/folderDisplay.js">file</a> |
<a href="/comm-central/annotate/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/folderDisplay.js">annotate</a> |
<a href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/folderDisplay.js">diff</a> |
<a href="/comm-central/comparison/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/folderDisplay.js">comparison</a> |
<a href="/comm-central/log/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/folderDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindow.js">mail/base/content/mailWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindow.js">file</a> |
<a href="/comm-central/annotate/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindow.js">annotate</a> |
<a href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindow.js">diff</a> |
<a href="/comm-central/comparison/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindow.js">comparison</a> |
<a href="/comm-central/log/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindowOverlay.js">mail/base/content/mailWindowOverlay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindowOverlay.js">file</a> |
<a href="/comm-central/annotate/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindowOverlay.js">annotate</a> |
<a href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindowOverlay.js">diff</a> |
<a href="/comm-central/comparison/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindowOverlay.js">comparison</a> |
<a href="/comm-central/log/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindowOverlay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindowOverlay.xul">mail/base/content/mailWindowOverlay.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindowOverlay.xul">file</a> |
<a href="/comm-central/annotate/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindowOverlay.xul">annotate</a> |
<a href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindowOverlay.xul">diff</a> |
<a href="/comm-central/comparison/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindowOverlay.xul">comparison</a> |
<a href="/comm-central/log/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/mailWindowOverlay.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/messageDisplay.js">mail/base/content/messageDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/messageDisplay.js">file</a> |
<a href="/comm-central/annotate/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/messageDisplay.js">annotate</a> |
<a href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/messageDisplay.js">diff</a> |
<a href="/comm-central/comparison/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/messageDisplay.js">comparison</a> |
<a href="/comm-central/log/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/messageDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/messenger.xul">mail/base/content/messenger.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/messenger.xul">file</a> |
<a href="/comm-central/annotate/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/messenger.xul">annotate</a> |
<a href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/messenger.xul">diff</a> |
<a href="/comm-central/comparison/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/messenger.xul">comparison</a> |
<a href="/comm-central/log/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/messenger.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/msgMail3PaneWindow.js">mail/base/content/msgMail3PaneWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/msgMail3PaneWindow.js">file</a> |
<a href="/comm-central/annotate/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/msgMail3PaneWindow.js">annotate</a> |
<a href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/msgMail3PaneWindow.js">diff</a> |
<a href="/comm-central/comparison/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/msgMail3PaneWindow.js">comparison</a> |
<a href="/comm-central/log/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/msgMail3PaneWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/tabmail.xml">mail/base/content/tabmail.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/tabmail.xml">file</a> |
<a href="/comm-central/annotate/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/tabmail.xml">annotate</a> |
<a href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/tabmail.xml">diff</a> |
<a href="/comm-central/comparison/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/tabmail.xml">comparison</a> |
<a href="/comm-central/log/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/tabmail.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/widgetglue.js">mail/base/content/widgetglue.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/widgetglue.js">file</a> |
<a href="/comm-central/annotate/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/widgetglue.js">annotate</a> |
<a href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/widgetglue.js">diff</a> |
<a href="/comm-central/comparison/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/widgetglue.js">comparison</a> |
<a href="/comm-central/log/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/content/widgetglue.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/jar.mn">mail/base/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/jar.mn">file</a> |
<a href="/comm-central/annotate/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/jar.mn">annotate</a> |
<a href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/jar.mn">diff</a> |
<a href="/comm-central/comparison/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/jar.mn">comparison</a> |
<a href="/comm-central/log/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/base/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/test/mozmill/folder-display/test-message-pane-visibility.js">mail/test/mozmill/folder-display/test-message-pane-visibility.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/test/mozmill/folder-display/test-message-pane-visibility.js">file</a> |
<a href="/comm-central/annotate/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/test/mozmill/folder-display/test-message-pane-visibility.js">annotate</a> |
<a href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/test/mozmill/folder-display/test-message-pane-visibility.js">diff</a> |
<a href="/comm-central/comparison/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/test/mozmill/folder-display/test-message-pane-visibility.js">comparison</a> |
<a href="/comm-central/log/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/test/mozmill/folder-display/test-message-pane-visibility.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">mail/test/mozmill/shared-modules/test-folder-display-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">file</a> |
<a href="/comm-central/annotate/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">annotate</a> |
<a href="/comm-central/diff/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">diff</a> |
<a href="/comm-central/comparison/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">comparison</a> |
<a href="/comm-central/log/781f622cb9b73a2a0c825a1065716c9984d3b461/mail/test/mozmill/shared-modules/test-folder-display-helpers.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/folderDisplay.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/folderDisplay.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1244,30 +1244,29 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l1.4"></a><span id="l1.4">         }</span>
<a href="#l1.5"></a><span id="l1.5">       }</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">       // the tab mode knows whether we are folder or message display, which</span>
<a href="#l1.8"></a><span id="l1.8">       //  impacts the legal modes</span>
<a href="#l1.9"></a><span id="l1.9">       if (this._tabInfo)</span>
<a href="#l1.10"></a><span id="l1.10">         mailTabType._setPaneStates(this._tabInfo.mode.legalPanes,</span>
<a href="#l1.11"></a><span id="l1.11">           {folder: !this._tabInfo.folderPaneCollapsed,</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-           message: !this._tabInfo.messagePaneCollapsed});</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+           message: this.messageDisplay.visible});</span>
<a href="#l1.14"></a><span id="l1.14"> </span>
<a href="#l1.15"></a><span id="l1.15">       // update the columns and such that live inside the thread pane</span>
<a href="#l1.16"></a><span id="l1.16">       this._updateThreadDisplay();</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18">       this.messageDisplay.makeActive();</span>
<a href="#l1.19"></a><span id="l1.19">     }</span>
<a href="#l1.20"></a><span id="l1.20">     // account central stuff when we don't have a dbview</span>
<a href="#l1.21"></a><span id="l1.21">     else {</span>
<a href="#l1.22"></a><span id="l1.22">       this._showAccountCentral();</span>
<a href="#l1.23"></a><span id="l1.23">       if (this._tabInfo)</span>
<a href="#l1.24"></a><span id="l1.24" class="difflineminus">-        mailTabType._setPaneStates(this._tabInfo.mode.legalPanes,</span>
<a href="#l1.25"></a><span id="l1.25" class="difflineminus">-                                   {folder: !this._tabInfo.folderPaneCollapsed,</span>
<a href="#l1.26"></a><span id="l1.26" class="difflineminus">-                                    message: false});</span>
<a href="#l1.27"></a><span id="l1.27" class="difflineplus">+        mailTabType._setPaneStates(this._tabInfo.mode.accountCentralLegalPanes,</span>
<a href="#l1.28"></a><span id="l1.28" class="difflineplus">+          {folder: !this._tabInfo.folderPaneCollapsed});</span>
<a href="#l1.29"></a><span id="l1.29">     }</span>
<a href="#l1.30"></a><span id="l1.30"> </span>
<a href="#l1.31"></a><span id="l1.31">     this._updateContextDisplay();</span>
<a href="#l1.32"></a><span id="l1.32">   },</span>
<a href="#l1.33"></a><span id="l1.33"> </span>
<a href="#l1.34"></a><span id="l1.34">   /**</span>
<a href="#l1.35"></a><span id="l1.35">    * Cause the displayDeck to display the thread pane.</span>
<a href="#l1.36"></a><span id="l1.36">    */</span>
<a href="#l1.37"></a><span id="l1.37" class="difflineat">@@ -1375,17 +1374,23 @@ FolderDisplayWidget.prototype = {</span>
<a href="#l1.38"></a><span id="l1.38">    * @param aFolder The folder context for the command.</span>
<a href="#l1.39"></a><span id="l1.39">    */</span>
<a href="#l1.40"></a><span id="l1.40">   doCommandWithFolder: function FolderDisplayWidget_doCommandWithFolder(</span>
<a href="#l1.41"></a><span id="l1.41">       aCommandName, aFolder) {</span>
<a href="#l1.42"></a><span id="l1.42">     return this.view.dbView &amp;&amp;</span>
<a href="#l1.43"></a><span id="l1.43">            this.view.dbView.doCommandWithFolder(aCommandName, aFolder);</span>
<a href="#l1.44"></a><span id="l1.44">   },</span>
<a href="#l1.45"></a><span id="l1.45"> </span>
<a href="#l1.46"></a><span id="l1.46" class="difflineminus">-</span>
<a href="#l1.47"></a><span id="l1.47" class="difflineplus">+  /**</span>
<a href="#l1.48"></a><span id="l1.48" class="difflineplus">+   * @return true when account central is being displayed.</span>
<a href="#l1.49"></a><span id="l1.49" class="difflineplus">+   */</span>
<a href="#l1.50"></a><span id="l1.50" class="difflineplus">+  get isAccountCentralDisplayed</span>
<a href="#l1.51"></a><span id="l1.51" class="difflineplus">+      FolderDisplayWidget_isAccountCentralDisplayed() {</span>
<a href="#l1.52"></a><span id="l1.52" class="difflineplus">+    return (this.view.dbView == null);</span>
<a href="#l1.53"></a><span id="l1.53" class="difflineplus">+  },</span>
<a href="#l1.54"></a><span id="l1.54"> </span>
<a href="#l1.55"></a><span id="l1.55">   /**</span>
<a href="#l1.56"></a><span id="l1.56">    * Navigate using nsMsgNavigationType rules and ensuring the resulting row is</span>
<a href="#l1.57"></a><span id="l1.57">    *  visible.  This is trickier than it used to be because we now support</span>
<a href="#l1.58"></a><span id="l1.58">    *  treating collapsed threads as the set of all the messages in the collapsed</span>
<a href="#l1.59"></a><span id="l1.59">    *  thread rather than just the root message in that thread.</span>
<a href="#l1.60"></a><span id="l1.60">    *</span>
<a href="#l1.61"></a><span id="l1.61">    * @param aNavType {nsMsgNavigationType} navigation command.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/base/content/mailWindow.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/base/content/mailWindow.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -50,18 +50,16 @@ var accountManager;</span>
<a href="#l2.4"></a><span id="l2.4"> </span>
<a href="#l2.5"></a><span id="l2.5"> var gMessengerBundle;</span>
<a href="#l2.6"></a><span id="l2.6"> var gBrandBundle;</span>
<a href="#l2.7"></a><span id="l2.7"> </span>
<a href="#l2.8"></a><span id="l2.8"> Components.utils.import(&quot;resource://app/modules/gloda/log4moz.js&quot;);</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10"> var gContextMenu;</span>
<a href="#l2.11"></a><span id="l2.11"> var gMailWindowLog = Log4Moz.getConfiguredLogger(&quot;mailWindow&quot;, Log4Moz.Level.Debug, Log4Moz.Level.Debug, Log4Moz.Level.Debug);</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-var gAccountCentralLoaded = true;</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">-</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15"> /**</span>
<a href="#l2.16"></a><span id="l2.16">  * Indicate whether we are running on Mac OS X.  Our code is currently littered</span>
<a href="#l2.17"></a><span id="l2.17">  *  with #ifdef/#ifndef XP_MACOSX's that do not need to exist in js code.  Use</span>
<a href="#l2.18"></a><span id="l2.18">  *  of preprocessing makes error line numbers misleading, complicates</span>
<a href="#l2.19"></a><span id="l2.19">  *  development because preprocessed files can't be symlinked when using</span>
<a href="#l2.20"></a><span id="l2.20">  *  --enable-chrome-format=symlink, etc.</span>
<a href="#l2.21"></a><span id="l2.21">  */</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -502,75 +500,25 @@ function loadStartPage()</span>
<a href="#l2.23"></a><span id="l2.23">     }</span>
<a href="#l2.24"></a><span id="l2.24">   }</span>
<a href="#l2.25"></a><span id="l2.25">   else</span>
<a href="#l2.26"></a><span id="l2.26">   {</span>
<a href="#l2.27"></a><span id="l2.27">     GetMessagePaneFrame().location.href = &quot;about:blank&quot;;</span>
<a href="#l2.28"></a><span id="l2.28">   }</span>
<a href="#l2.29"></a><span id="l2.29"> }</span>
<a href="#l2.30"></a><span id="l2.30"> </span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-function ShowingThreadPane()</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-{</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineminus">-  var threadPaneSplitter = document.getElementById(&quot;threadpane-splitter&quot;);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineminus">-  threadPaneSplitter.collapsed = false;</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineminus">-  GetMessagePane().collapsed = (threadPaneSplitter.getAttribute(&quot;state&quot;) == &quot;collapsed&quot;);</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-  // XXX We need to force the tree to refresh its new height</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-  // so that it will correctly scroll to the newest message</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-  GetThreadTree().boxObject.height;</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-  document.getElementById(&quot;key_toggleMessagePane&quot;).removeAttribute(&quot;disabled&quot;);</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineminus">-}</span>
<a href="#l2.41"></a><span id="l2.41" class="difflineminus">-</span>
<a href="#l2.42"></a><span id="l2.42" class="difflineminus">-function HidingThreadPane()</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineminus">-{</span>
<a href="#l2.44"></a><span id="l2.44" class="difflineminus">-  GetUnreadCountElement().hidden = true;</span>
<a href="#l2.45"></a><span id="l2.45" class="difflineminus">-  GetTotalCountElement().hidden = true;</span>
<a href="#l2.46"></a><span id="l2.46" class="difflineminus">-  GetMessagePane().collapsed = true;</span>
<a href="#l2.47"></a><span id="l2.47" class="difflineminus">-  document.getElementById(&quot;threadpane-splitter&quot;).collapsed = true;</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineminus">-  document.getElementById(&quot;key_toggleMessagePane&quot;).setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l2.49"></a><span id="l2.49" class="difflineminus">-}</span>
<a href="#l2.50"></a><span id="l2.50" class="difflineminus">-</span>
<a href="#l2.51"></a><span id="l2.51"> // The zoom manager, view source and possibly some other functions still rely</span>
<a href="#l2.52"></a><span id="l2.52"> // on the getBrowser function.</span>
<a href="#l2.53"></a><span id="l2.53"> function getBrowser()</span>
<a href="#l2.54"></a><span id="l2.54"> {</span>
<a href="#l2.55"></a><span id="l2.55">   let tabmail = document.getElementById('tabmail');</span>
<a href="#l2.56"></a><span id="l2.56">   return tabmail ? tabmail.getBrowserForSelectedTab() :</span>
<a href="#l2.57"></a><span id="l2.57">                    document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l2.58"></a><span id="l2.58"> }</span>
<a href="#l2.59"></a><span id="l2.59"> </span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-// When the ThreadPane is hidden via the displayDeck, we should collapse the</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-// elements that are only meaningful to the thread pane. When AccountCentral is</span>
<a href="#l2.62"></a><span id="l2.62" class="difflineminus">-// shown via the displayDeck, we need to switch the displayDeck to show the</span>
<a href="#l2.63"></a><span id="l2.63" class="difflineminus">-// accountCentralBox, and load the iframe in the AccountCentral box with</span>
<a href="#l2.64"></a><span id="l2.64" class="difflineminus">-// corresponding page.</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-var gCurrentDisplayDeckId = &quot;&quot;;</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineminus">-function ObserveDisplayDeckChange(event)</span>
<a href="#l2.67"></a><span id="l2.67" class="difflineminus">-{</span>
<a href="#l2.68"></a><span id="l2.68" class="difflineminus">-  var selectedPanel = document.getElementById(&quot;displayDeck&quot;).selectedPanel;</span>
<a href="#l2.69"></a><span id="l2.69" class="difflineminus">-  var nowSelected = selectedPanel ? selectedPanel.id : null;</span>
<a href="#l2.70"></a><span id="l2.70" class="difflineminus">-  // onselect fires for every mouse click inside the deck, so ObserveDisplayDeckChange is getting called every time we click</span>
<a href="#l2.71"></a><span id="l2.71" class="difflineminus">-  // on a message in the thread pane. Only show / Hide elements if the selected deck is actually changing.</span>
<a href="#l2.72"></a><span id="l2.72" class="difflineminus">-  if (nowSelected != gCurrentDisplayDeckId)</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineminus">-  {</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-    if (nowSelected == &quot;threadPaneBox&quot;)</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineminus">-      ShowingThreadPane();</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineminus">-    else</span>
<a href="#l2.77"></a><span id="l2.77" class="difflineminus">-      HidingThreadPane();</span>
<a href="#l2.78"></a><span id="l2.78" class="difflineminus">-</span>
<a href="#l2.79"></a><span id="l2.79" class="difflineminus">-    if (nowSelected == &quot;accountCentralBox&quot;) {</span>
<a href="#l2.80"></a><span id="l2.80" class="difflineminus">-      if (!document.getElementById(&quot;folderPaneBox&quot;).collapsed)</span>
<a href="#l2.81"></a><span id="l2.81" class="difflineminus">-        document.getElementById(&quot;folderTree&quot;).focus();</span>
<a href="#l2.82"></a><span id="l2.82" class="difflineminus">-</span>
<a href="#l2.83"></a><span id="l2.83" class="difflineminus">-      gAccountCentralLoaded = true;</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineminus">-    } else</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineminus">-      gAccountCentralLoaded = false;</span>
<a href="#l2.86"></a><span id="l2.86" class="difflineminus">-    gCurrentDisplayDeckId = nowSelected;</span>
<a href="#l2.87"></a><span id="l2.87" class="difflineminus">-  }</span>
<a href="#l2.88"></a><span id="l2.88" class="difflineminus">-}</span>
<a href="#l2.89"></a><span id="l2.89" class="difflineminus">-</span>
<a href="#l2.90"></a><span id="l2.90"> // Given the server, open the twisty and the set the selection</span>
<a href="#l2.91"></a><span id="l2.91"> // on inbox of that server.</span>
<a href="#l2.92"></a><span id="l2.92"> // prompt if offline.</span>
<a href="#l2.93"></a><span id="l2.93"> function OpenInboxForServer(server)</span>
<a href="#l2.94"></a><span id="l2.94"> {</span>
<a href="#l2.95"></a><span id="l2.95">   gFolderTreeView.selectFolder(GetInboxFolder(server));</span>
<a href="#l2.96"></a><span id="l2.96"> </span>
<a href="#l2.97"></a><span id="l2.97">   if (MailOfflineMgr.isOnline() || MailOfflineMgr.getNewMail()) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -153,33 +153,39 @@ function InitEditMessagesMenu()</span>
<a href="#l3.4"></a><span id="l3.4">   }</span>
<a href="#l3.5"></a><span id="l3.5"> }</span>
<a href="#l3.6"></a><span id="l3.6"> </span>
<a href="#l3.7"></a><span id="l3.7"> function InitGoMessagesMenu()</span>
<a href="#l3.8"></a><span id="l3.8"> {</span>
<a href="#l3.9"></a><span id="l3.9">   document.commandDispatcher.updateCommands('create-menu-go');</span>
<a href="#l3.10"></a><span id="l3.10"> }</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+/**</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+ * This is called every time the view menu popup is displayed.  It is</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+ *  responsible for updating the menu items' state to reflect reality.</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+ */</span>
<a href="#l3.16"></a><span id="l3.16"> function view_init()</span>
<a href="#l3.17"></a><span id="l3.17"> {</span>
<a href="#l3.18"></a><span id="l3.18">   var isFeed = gFolderDisplay.selectedMessageIsFeed;</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20">   if (!gMessengerBundle)</span>
<a href="#l3.21"></a><span id="l3.21">     gMessengerBundle = document.getElementById(&quot;bundle_messenger&quot;);</span>
<a href="#l3.22"></a><span id="l3.22"> </span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+  let accountCentralDisplayed = gFolderDisplay.isAccountCentralDisplayed;</span>
<a href="#l3.24"></a><span id="l3.24">   var messagePaneMenuItem = document.getElementById(&quot;menu_showMessage&quot;);</span>
<a href="#l3.25"></a><span id="l3.25">   if (!messagePaneMenuItem.hidden) { // Hidden in the standalone msg window.</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineminus">-    messagePaneMenuItem.setAttribute(&quot;checked&quot;, !IsMessagePaneCollapsed());</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineminus">-    messagePaneMenuItem.disabled = gAccountCentralLoaded;</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+    messagePaneMenuItem.setAttribute(&quot;checked&quot;,</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+      accountCentralDisplayed ? false : gMessageDisplay.visible);</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+    messagePaneMenuItem.disabled = accountCentralDisplayed;</span>
<a href="#l3.31"></a><span id="l3.31">   }</span>
<a href="#l3.32"></a><span id="l3.32"> </span>
<a href="#l3.33"></a><span id="l3.33">   // Disable some menus if account manager is showing</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineminus">-  document.getElementById(&quot;viewSortMenu&quot;).disabled = gAccountCentralLoaded;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-  document.getElementById(&quot;viewMessageViewMenu&quot;).disabled = gAccountCentralLoaded;</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineminus">-  document.getElementById(&quot;viewMessagesMenu&quot;).disabled = gAccountCentralLoaded;</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  document.getElementById(&quot;viewSortMenu&quot;).disabled = accountCentralDisplayed;</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  document.getElementById(&quot;viewMessageViewMenu&quot;).disabled = accountCentralDisplayed;</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  document.getElementById(&quot;viewMessagesMenu&quot;).disabled = accountCentralDisplayed;</span>
<a href="#l3.40"></a><span id="l3.40"> </span>
<a href="#l3.41"></a><span id="l3.41">   // Hide the views menu item if the user doesn't have the views toolbar button</span>
<a href="#l3.42"></a><span id="l3.42">   // visible.</span>
<a href="#l3.43"></a><span id="l3.43">   var viewsToolbarButton = document.getElementById(&quot;mailviews-container&quot;);</span>
<a href="#l3.44"></a><span id="l3.44">   document.getElementById('viewMessageViewMenu').hidden = !viewsToolbarButton;</span>
<a href="#l3.45"></a><span id="l3.45"> </span>
<a href="#l3.46"></a><span id="l3.46">   // ... and also the separator.</span>
<a href="#l3.47"></a><span id="l3.47">   document.getElementById(&quot;viewMenuAfterTaskbarSeparator&quot;).hidden = !viewsToolbarButton;</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineat">@@ -1642,21 +1648,16 @@ function CreateToolbarTooltip(document, </span>
<a href="#l3.49"></a><span id="l3.49">  *     global.</span>
<a href="#l3.50"></a><span id="l3.50">  * @property {nsIMsgDBView} dbView The database view to use with the thread tree</span>
<a href="#l3.51"></a><span id="l3.51">  *     when this tab is displayed.  The value will be assigned to the global</span>
<a href="#l3.52"></a><span id="l3.52">  *     gDBView in the process.</span>
<a href="#l3.53"></a><span id="l3.53">  * @property {nsIMessenger} messenger Used to preserve &quot;messenger&quot; global value.</span>
<a href="#l3.54"></a><span id="l3.54">  *     The messenger object is the keeper of the 'undo' state and navigation</span>
<a href="#l3.55"></a><span id="l3.55">  *     history, which is why we do this.</span>
<a href="#l3.56"></a><span id="l3.56">  *</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineminus">- * @property {boolean} folderPaneCollapsed In &quot;folder&quot; mode, has the user</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineminus">- *     intentionally collapsed the folder pane.</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineminus">- * @property {boolean} messagePaneCollapsed In &quot;folder&quot; or &quot;glodaSearch&quot; mode,</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineminus">- *     has the user intentionally collapsed the message pane.</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineminus">- *</span>
<a href="#l3.62"></a><span id="l3.62">  * @property {nsIMsgDBHdr} hdr In &quot;message&quot; mode, the header of the message</span>
<a href="#l3.63"></a><span id="l3.63">  *     being displayed.</span>
<a href="#l3.64"></a><span id="l3.64">  * @property {nsIMsgSearchSession} searchSession Used to preserve gSearchSession</span>
<a href="#l3.65"></a><span id="l3.65">  *     global value.</span>
<a href="#l3.66"></a><span id="l3.66">  *</span>
<a href="#l3.67"></a><span id="l3.67">  */</span>
<a href="#l3.68"></a><span id="l3.68"> let mailTabType = {</span>
<a href="#l3.69"></a><span id="l3.69">   name: &quot;mail&quot;,</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineat">@@ -1677,66 +1678,132 @@ let mailTabType = {</span>
<a href="#l3.71"></a><span id="l3.71">       isDefault: true,</span>
<a href="#l3.72"></a><span id="l3.72">       type: &quot;folder&quot;,</span>
<a href="#l3.73"></a><span id="l3.73">       /// The set of panes that are legal to be displayed in this mode</span>
<a href="#l3.74"></a><span id="l3.74">       legalPanes: {</span>
<a href="#l3.75"></a><span id="l3.75">         folder: true,</span>
<a href="#l3.76"></a><span id="l3.76">         thread: true,</span>
<a href="#l3.77"></a><span id="l3.77">         message: true</span>
<a href="#l3.78"></a><span id="l3.78">       },</span>
<a href="#l3.79"></a><span id="l3.79" class="difflineplus">+      /// The set of panes that are legal when we are showing account central</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineplus">+      accountCentralLegalPanes: {</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineplus">+        folder: true,</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+        accountCentral: true,</span>
<a href="#l3.83"></a><span id="l3.83" class="difflineplus">+        message: false</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+      },</span>
<a href="#l3.85"></a><span id="l3.85">       openFirstTab: function(aTab) {</span>
<a href="#l3.86"></a><span id="l3.86">         this.openTab(aTab, true, new MessagePaneDisplayWidget());</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+        // persistence and restoreTab wants to know if we are the magic first tab</span>
<a href="#l3.88"></a><span id="l3.88" class="difflineplus">+        aTab.firstTab = true;</span>
<a href="#l3.89"></a><span id="l3.89">         aTab.folderDisplay.makeActive();</span>
<a href="#l3.90"></a><span id="l3.90">       },</span>
<a href="#l3.91"></a><span id="l3.91">       /**</span>
<a href="#l3.92"></a><span id="l3.92">        * @param aFolder The nsIMsgFolder to display.</span>
<a href="#l3.93"></a><span id="l3.93">        * @param aMsgHdr Optional message header to display.</span>
<a href="#l3.94"></a><span id="l3.94">        */</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-      openTab: function(aTab, aFolder, aMsgHdr) {</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+      openTab: function(aTab, aFolder, aMsgHdr, aOptions) {</span>
<a href="#l3.97"></a><span id="l3.97" class="difflineplus">+        if (aOptions === undefined)</span>
<a href="#l3.98"></a><span id="l3.98" class="difflineplus">+          aOptions = {};</span>
<a href="#l3.99"></a><span id="l3.99" class="difflineplus">+</span>
<a href="#l3.100"></a><span id="l3.100" class="difflineplus">+        // persistence and restoreTab wants to know if we are the magic first tab</span>
<a href="#l3.101"></a><span id="l3.101" class="difflineplus">+        aTab.firstTab = false;</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineplus">+</span>
<a href="#l3.103"></a><span id="l3.103">         // Get a tab that we can initialize our user preferences from.</span>
<a href="#l3.104"></a><span id="l3.104">         // (We don't want to assume that our immediate predecessor was a</span>
<a href="#l3.105"></a><span id="l3.105">         //  &quot;folder&quot; tab.)</span>
<a href="#l3.106"></a><span id="l3.106">         let modelTab = document.getElementById(&quot;tabmail&quot;)</span>
<a href="#l3.107"></a><span id="l3.107">                          .getTabInfoForCurrentOrFirstModeInstance(aTab.mode);</span>
<a href="#l3.108"></a><span id="l3.108" class="difflineminus">-        // copy its state</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineminus">-        aTab.folderPaneCollapsed = modelTab.folderPaneCollapsed;</span>
<a href="#l3.110"></a><span id="l3.110" class="difflineminus">-        aTab.messagePaneCollapsed = modelTab.messagePaneCollapsed;</span>
<a href="#l3.111"></a><span id="l3.111" class="difflineminus">-</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-        this.openTab(aTab, false,  new MessagePaneDisplayWidget());</span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+</span>
<a href="#l3.114"></a><span id="l3.114" class="difflineplus">+        if (modelTab)</span>
<a href="#l3.115"></a><span id="l3.115" class="difflineplus">+          aTab.folderPaneCollapsed = modelTab.folderPaneCollapsed;</span>
<a href="#l3.116"></a><span id="l3.116" class="difflineplus">+</span>
<a href="#l3.117"></a><span id="l3.117" class="difflineplus">+        // - figure out whether to show the message pane</span>
<a href="#l3.118"></a><span id="l3.118" class="difflineplus">+        let messagePaneShouldBeVisible;</span>
<a href="#l3.119"></a><span id="l3.119" class="difflineplus">+        // explicitly told to us?</span>
<a href="#l3.120"></a><span id="l3.120" class="difflineplus">+        if (&quot;messagePaneVisible&quot; in aOptions)</span>
<a href="#l3.121"></a><span id="l3.121" class="difflineplus">+          messagePaneShouldBeVisible = aOptions.messagePaneVisible;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineplus">+        // inherit from the previous tab (if we've got one)</span>
<a href="#l3.123"></a><span id="l3.123" class="difflineplus">+        else if (modelTab)</span>
<a href="#l3.124"></a><span id="l3.124" class="difflineplus">+          messagePaneShouldBeVisible = modelTab.messageDisplay.visible;</span>
<a href="#l3.125"></a><span id="l3.125" class="difflineplus">+        // who does't love a message pane?</span>
<a href="#l3.126"></a><span id="l3.126" class="difflineplus">+        else</span>
<a href="#l3.127"></a><span id="l3.127" class="difflineplus">+          messagePaneShouldBeVisible = true;</span>
<a href="#l3.128"></a><span id="l3.128" class="difflineplus">+</span>
<a href="#l3.129"></a><span id="l3.129" class="difflineplus">+        this.openTab(aTab, false,</span>
<a href="#l3.130"></a><span id="l3.130" class="difflineplus">+                     new MessagePaneDisplayWidget(messagePaneShouldBeVisible));</span>
<a href="#l3.131"></a><span id="l3.131"> </span>
<a href="#l3.132"></a><span id="l3.132">         // Clear selection, because context clicking on a folder and opening in a</span>
<a href="#l3.133"></a><span id="l3.133">         // new tab needs to have SelectFolder think the selection has changed.</span>
<a href="#l3.134"></a><span id="l3.134">         // We also need to clear these globals to subvert the code that prevents</span>
<a href="#l3.135"></a><span id="l3.135">         // folder loads when things haven't changed.</span>
<a href="#l3.136"></a><span id="l3.136">         var folderTree = document.getElementById(&quot;folderTree&quot;);</span>
<a href="#l3.137"></a><span id="l3.137">         folderTree.view.selection.clearSelection();</span>
<a href="#l3.138"></a><span id="l3.138">         folderTree.view.selection.currentIndex = -1;</span>
<a href="#l3.139"></a><span id="l3.139"> </span>
<a href="#l3.140"></a><span id="l3.140">         aTab.folderDisplay.makeActive();</span>
<a href="#l3.141"></a><span id="l3.141"> </span>
<a href="#l3.142"></a><span id="l3.142">         // selecting the folder effectively calls</span>
<a href="#l3.143"></a><span id="l3.143">         //  aTab.folderDisplay.show(aFolder)</span>
<a href="#l3.144"></a><span id="l3.144">         gFolderTreeView.selectFolder(aFolder);</span>
<a href="#l3.145"></a><span id="l3.145">         if(aMsgHdr)</span>
<a href="#l3.146"></a><span id="l3.146">           aTab.folderDisplay.selectMessage(aMsgHdr);</span>
<a href="#l3.147"></a><span id="l3.147" class="difflineplus">+</span>
<a href="#l3.148"></a><span id="l3.148" class="difflineplus">+        aTab.mode.onTitleChanged.call(this, aTab, aTab.tabNode);</span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+      },</span>
<a href="#l3.150"></a><span id="l3.150" class="difflineplus">+      persistTab: function(aTab) {</span>
<a href="#l3.151"></a><span id="l3.151" class="difflineplus">+        if (!aTab.folderDisplay.displayedFolder)</span>
<a href="#l3.152"></a><span id="l3.152" class="difflineplus">+          return null;</span>
<a href="#l3.153"></a><span id="l3.153" class="difflineplus">+        return {</span>
<a href="#l3.154"></a><span id="l3.154" class="difflineplus">+          folderURI: aTab.folderDisplay.displayedFolder.URI,</span>
<a href="#l3.155"></a><span id="l3.155" class="difflineplus">+          messagePaneVisible: aTab.messageDisplay.visible,</span>
<a href="#l3.156"></a><span id="l3.156" class="difflineplus">+          firstTab: aTab.firstTab</span>
<a href="#l3.157"></a><span id="l3.157" class="difflineplus">+        };</span>
<a href="#l3.158"></a><span id="l3.158" class="difflineplus">+      },</span>
<a href="#l3.159"></a><span id="l3.159" class="difflineplus">+      restoreTab: function(aTabmail, aPersistedState) {</span>
<a href="#l3.160"></a><span id="l3.160" class="difflineplus">+        let rdfService = Components.classes['@mozilla.org/rdf/rdf-service;1']</span>
<a href="#l3.161"></a><span id="l3.161" class="difflineplus">+                           .getService(Components.interfaces.nsIRDFService);</span>
<a href="#l3.162"></a><span id="l3.162" class="difflineplus">+        let folder = rdfService.GetResource(aPersistedState.folderURI)</span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+                       .QueryInterface(Components.interfaces.nsIMsgFolder);</span>
<a href="#l3.164"></a><span id="l3.164" class="difflineplus">+        // if the folder no longer exists, we can't restore the tab</span>
<a href="#l3.165"></a><span id="l3.165" class="difflineplus">+        if (folder) {</span>
<a href="#l3.166"></a><span id="l3.166" class="difflineplus">+          // If we are talking about the first tab, it already exists and we</span>
<a href="#l3.167"></a><span id="l3.167" class="difflineplus">+          //  should poke it.  We are assuming it is the currently displayed</span>
<a href="#l3.168"></a><span id="l3.168" class="difflineplus">+          //  tab because we are privvy to the implementation details and know</span>
<a href="#l3.169"></a><span id="l3.169" class="difflineplus">+          //  it to be true.</span>
<a href="#l3.170"></a><span id="l3.170" class="difflineplus">+          if (aPersistedState.firstTab) {</span>
<a href="#l3.171"></a><span id="l3.171" class="difflineplus">+            if (gMessageDisplay.visible != aPersistedState.messagePaneVisible) {</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineplus">+              MsgToggleMessagePane();</span>
<a href="#l3.173"></a><span id="l3.173" class="difflineplus">+              // For reasons that are not immediately obvious, sometimes the</span>
<a href="#l3.174"></a><span id="l3.174" class="difflineplus">+              //  message display is not active at this time.  In that case, we</span>
<a href="#l3.175"></a><span id="l3.175" class="difflineplus">+              //  need to explicitly set the _visible value because otherwise it</span>
<a href="#l3.176"></a><span id="l3.176" class="difflineplus">+              //  misses out on the toggle event.</span>
<a href="#l3.177"></a><span id="l3.177" class="difflineplus">+              if (!gMessageDisplay._active)</span>
<a href="#l3.178"></a><span id="l3.178" class="difflineplus">+                gMessageDisplay._visible = aPersistedState.messagePaneVisible;</span>
<a href="#l3.179"></a><span id="l3.179" class="difflineplus">+            }</span>
<a href="#l3.180"></a><span id="l3.180" class="difflineplus">+            gFolderTreeView.selectFolder(folder);</span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+          }</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+          else {</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+            aTabmail.openTab(&quot;folder&quot;, folder, null, aPersistedState);</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+          }</span>
<a href="#l3.185"></a><span id="l3.185" class="difflineplus">+        }</span>
<a href="#l3.186"></a><span id="l3.186">       },</span>
<a href="#l3.187"></a><span id="l3.187">       onTitleChanged: function(aTab, aTabNode) {</span>
<a href="#l3.188"></a><span id="l3.188">         if (!aTab.folderDisplay || !aTab.folderDisplay.displayedFolder) {</span>
<a href="#l3.189"></a><span id="l3.189">           // Don't show &quot;undefined&quot; as title when there is no account.</span>
<a href="#l3.190"></a><span id="l3.190">           aTab.title = &quot; &quot;;</span>
<a href="#l3.191"></a><span id="l3.191">           return;</span>
<a href="#l3.192"></a><span id="l3.192">         }</span>
<a href="#l3.193"></a><span id="l3.193">         // The user may have changed folders, triggering our onTitleChanged</span>
<a href="#l3.194"></a><span id="l3.194">         // callback.</span>
<a href="#l3.195"></a><span id="l3.195">         let folder = aTab.folderDisplay.displayedFolder;</span>
<a href="#l3.196"></a><span id="l3.196">         aTab.title = folder.prettyName;</span>
<a href="#l3.197"></a><span id="l3.197">         if (!folder.isServer &amp;&amp; this._getNumberOfRealAccounts() &gt; 1)</span>
<a href="#l3.198"></a><span id="l3.198">           aTab.title += &quot; - &quot; + folder.server.prettyName;</span>
<a href="#l3.199"></a><span id="l3.199"> </span>
<a href="#l3.200"></a><span id="l3.200" class="difflineminus">-        // Update the appropriate attributes on the tab.</span>
<a href="#l3.201"></a><span id="l3.201" class="difflineplus">+        // Update the appropriate attributes on the tab</span>
<a href="#l3.202"></a><span id="l3.202">         aTabNode.setAttribute('SpecialFolder',</span>
<a href="#l3.203"></a><span id="l3.203">                               getSpecialFolderString(folder));</span>
<a href="#l3.204"></a><span id="l3.204">         aTabNode.setAttribute('ServerType', folder.server.type);</span>
<a href="#l3.205"></a><span id="l3.205">         aTabNode.setAttribute('IsServer', folder.isServer);</span>
<a href="#l3.206"></a><span id="l3.206">         aTabNode.setAttribute('IsSecure', folder.server.isSecure);</span>
<a href="#l3.207"></a><span id="l3.207">       }</span>
<a href="#l3.208"></a><span id="l3.208">     },</span>
<a href="#l3.209"></a><span id="l3.209">     /**</span>
<a href="#l3.210"></a><span id="l3.210" class="difflineat">@@ -1763,20 +1830,37 @@ let mailTabType = {</span>
<a href="#l3.211"></a><span id="l3.211">           aTab.folderDisplay.show(aMsgHdr.folder);</span>
<a href="#l3.212"></a><span id="l3.212"> </span>
<a href="#l3.213"></a><span id="l3.213">         aTab.folderDisplay.selectMessage(aMsgHdr);</span>
<a href="#l3.214"></a><span id="l3.214"> </span>
<a href="#l3.215"></a><span id="l3.215">         // we only want to make it active after setting up the view and the message</span>
<a href="#l3.216"></a><span id="l3.216">         //  to avoid generating bogus summarization events.</span>
<a href="#l3.217"></a><span id="l3.217">         aTab.folderDisplay.makeActive();</span>
<a href="#l3.218"></a><span id="l3.218">       },</span>
<a href="#l3.219"></a><span id="l3.219" class="difflineplus">+      persistTab: function(aTab) {</span>
<a href="#l3.220"></a><span id="l3.220" class="difflineplus">+        let msgHdr = aTab.messageDisplay.displayedMessage;</span>
<a href="#l3.221"></a><span id="l3.221" class="difflineplus">+        return {</span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+          messageURI: msgHdr.folder.getUriForMsg(msgHdr)</span>
<a href="#l3.223"></a><span id="l3.223" class="difflineplus">+        };</span>
<a href="#l3.224"></a><span id="l3.224" class="difflineplus">+      },</span>
<a href="#l3.225"></a><span id="l3.225" class="difflineplus">+      restoreTab: function(aTabmail, aPersistedState) {</span>
<a href="#l3.226"></a><span id="l3.226" class="difflineplus">+        let msgHdr = messenger.msgHdrFromURI(aPersistedState.messageURI);</span>
<a href="#l3.227"></a><span id="l3.227" class="difflineplus">+        // if the message no longer exists, we can't restore the tab</span>
<a href="#l3.228"></a><span id="l3.228" class="difflineplus">+        if (msgHdr)</span>
<a href="#l3.229"></a><span id="l3.229" class="difflineplus">+          aTabmail.openTab(&quot;message&quot;, msgHdr);</span>
<a href="#l3.230"></a><span id="l3.230" class="difflineplus">+      },</span>
<a href="#l3.231"></a><span id="l3.231">       onTitleChanged: function(aTab, aTabNode, aMsgHdr) {</span>
<a href="#l3.232"></a><span id="l3.232" class="difflineplus">+        // Try and figure out the selected message if one was not provided.</span>
<a href="#l3.233"></a><span id="l3.233" class="difflineplus">+        // It is possible that the folder has yet to load, so it may still be</span>
<a href="#l3.234"></a><span id="l3.234" class="difflineplus">+        //  null.</span>
<a href="#l3.235"></a><span id="l3.235">         if (aMsgHdr == null)</span>
<a href="#l3.236"></a><span id="l3.236">           aMsgHdr = aTab.folderDisplay.selectedMessage;</span>
<a href="#l3.237"></a><span id="l3.237">         aTab.title = &quot;&quot;;</span>
<a href="#l3.238"></a><span id="l3.238" class="difflineplus">+        if (aMsgHdr == null)</span>
<a href="#l3.239"></a><span id="l3.239" class="difflineplus">+          return;</span>
<a href="#l3.240"></a><span id="l3.240">         if (aMsgHdr.flags &amp; Components.interfaces.nsMsgMessageFlags.HasRe)</span>
<a href="#l3.241"></a><span id="l3.241">           aTab.title = &quot;Re: &quot;;</span>
<a href="#l3.242"></a><span id="l3.242">         if (aMsgHdr.mime2DecodedSubject)</span>
<a href="#l3.243"></a><span id="l3.243">           aTab.title += aMsgHdr.mime2DecodedSubject;</span>
<a href="#l3.244"></a><span id="l3.244"> </span>
<a href="#l3.245"></a><span id="l3.245">         aTab.title += &quot; - &quot; + aMsgHdr.folder.prettyName;</span>
<a href="#l3.246"></a><span id="l3.246">         if (this._getNumberOfRealAccounts() &gt; 1)</span>
<a href="#l3.247"></a><span id="l3.247">           aTab.title += &quot; - &quot; + aMsgHdr.folder.server.prettyName;</span>
<a href="#l3.248"></a><span id="l3.248" class="difflineat">@@ -1890,94 +1974,120 @@ let mailTabType = {</span>
<a href="#l3.249"></a><span id="l3.249">    *  have three different layouts that are possible, each of which requires a</span>
<a href="#l3.250"></a><span id="l3.250">    *  slightly different DOM configuration, and accordingly for us to poke at</span>
<a href="#l3.251"></a><span id="l3.251">    *  different DOM nodes.  Things are made somewhat simpler by our decision</span>
<a href="#l3.252"></a><span id="l3.252">    *  that all tabs share the same layout.</span>
<a href="#l3.253"></a><span id="l3.253">    * This method takes the legal states and current display states and attempts</span>
<a href="#l3.254"></a><span id="l3.254">    *  to apply the appropriate logic to make it all work out.  This method is</span>
<a href="#l3.255"></a><span id="l3.255">    *  not in charge of figuring out or preserving display states.</span>
<a href="#l3.256"></a><span id="l3.256">    *</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">-   * We take a dictionary of desired visibility booleans as our argument because</span>
<a href="#l3.258"></a><span id="l3.258" class="difflineminus">-   * it is both readable and scalable.</span>
<a href="#l3.259"></a><span id="l3.259" class="difflineplus">+   * A brief primer on splitters and friends:</span>
<a href="#l3.260"></a><span id="l3.260" class="difflineplus">+   * - A collapsed splitter is not visible (and otherwise it is visible).</span>
<a href="#l3.261"></a><span id="l3.261" class="difflineplus">+   * - A collapsed node is not visible (and otherwise it is visible).</span>
<a href="#l3.262"></a><span id="l3.262" class="difflineplus">+   * - A splitter whose &quot;state&quot; is &quot;collapsed&quot; collapses the widget implied by</span>
<a href="#l3.263"></a><span id="l3.263" class="difflineplus">+   *    the value of the &quot;collapse&quot; attribute.  The splitter itself will be</span>
<a href="#l3.264"></a><span id="l3.264" class="difflineplus">+   *    visible unless &quot;collapsed&quot;.</span>
<a href="#l3.265"></a><span id="l3.265">    *</span>
<a href="#l3.266"></a><span id="l3.266">    * @param aLegalStates A dictionary where each key and value indicates whether</span>
<a href="#l3.267"></a><span id="l3.267">    *     the pane in question (key) is legal to be displayed in this mode.  If</span>
<a href="#l3.268"></a><span id="l3.268">    *     the value is true, then the pane is legal.  Omitted pane keys imply</span>
<a href="#l3.269"></a><span id="l3.269">    *     that the pane is illegal.  Keys are:</span>
<a href="#l3.270"></a><span id="l3.270">    *     - folder: The folder (tree) pane.</span>
<a href="#l3.271"></a><span id="l3.271">    *     - thread: The thread pane.</span>
<a href="#l3.272"></a><span id="l3.272" class="difflineplus">+   *     - accountCentral: While it's in a deck with the thread pane, this</span>
<a href="#l3.273"></a><span id="l3.273" class="difflineplus">+   *        is distinct from the thread pane because some other things depend</span>
<a href="#l3.274"></a><span id="l3.274" class="difflineplus">+   *        on whether it's actually the thread pane we are showing.</span>
<a href="#l3.275"></a><span id="l3.275">    *     - message: The message pane.  Required/assumed to be true for now.</span>
<a href="#l3.276"></a><span id="l3.276">    *     - glodaFacets: The gloda search facets pane.</span>
<a href="#l3.277"></a><span id="l3.277">    * @param aVisibleStates A dictionary where each value indicates whether the</span>
<a href="#l3.278"></a><span id="l3.278">    *     pane should be 'visible' (not collapsed).  Only panes that are governed</span>
<a href="#l3.279"></a><span id="l3.279">    *     by splitters are options here.  Keys are:</span>
<a href="#l3.280"></a><span id="l3.280">    *     - folder: The folder (tree) pane.</span>
<a href="#l3.281"></a><span id="l3.281">    *     - message: The message pane.</span>
<a href="#l3.282"></a><span id="l3.282">    */</span>
<a href="#l3.283"></a><span id="l3.283">   _setPaneStates: function mailTabType_setPaneStates(aLegalStates,</span>
<a href="#l3.284"></a><span id="l3.284">                                                      aVisibleStates) {</span>
<a href="#l3.285"></a><span id="l3.285" class="difflineplus">+    // The display deck hosts both the thread pane and account central.</span>
<a href="#l3.286"></a><span id="l3.286" class="difflineplus">+    let displayDeckLegal = aLegalStates.thread ||</span>
<a href="#l3.287"></a><span id="l3.287" class="difflineplus">+                           aLegalStates.accountCentral;</span>
<a href="#l3.288"></a><span id="l3.288" class="difflineplus">+</span>
<a href="#l3.289"></a><span id="l3.289">     let layout = pref.getIntPref(&quot;mail.pane_config.dynamic&quot;);</span>
<a href="#l3.290"></a><span id="l3.290">     if (layout == kWidePaneConfig)</span>
<a href="#l3.291"></a><span id="l3.291">     {</span>
<a href="#l3.292"></a><span id="l3.292">       // in the &quot;wide&quot; configuration, the #messengerBox is left holding the</span>
<a href="#l3.293"></a><span id="l3.293">       //  folder pane and thread pane, and the message pane has migrated to be</span>
<a href="#l3.294"></a><span id="l3.294">       //  its sibling (under #mailContent).</span>
<a href="#l3.295"></a><span id="l3.295">       // Accordingly, if both the folder and thread panes are illegal, we</span>
<a href="#l3.296"></a><span id="l3.296">       //  want to collapse the #messengerBox and make sure the #messagepanebox</span>
<a href="#l3.297"></a><span id="l3.297">       //  fills up the screen.  (For example, when in &quot;message&quot; mode.)</span>
<a href="#l3.298"></a><span id="l3.298" class="difflineminus">-      let collapseMessengerBox = !aLegalStates.folder &amp;&amp; !aLegalStates.thread;</span>
<a href="#l3.299"></a><span id="l3.299" class="difflineplus">+      let collapseMessengerBox = !aLegalStates.folder &amp;&amp; !displayDeckLegal;</span>
<a href="#l3.300"></a><span id="l3.300">       document.getElementById(&quot;messengerBox&quot;).collapsed = collapseMessengerBox;</span>
<a href="#l3.301"></a><span id="l3.301">       if (collapseMessengerBox)</span>
<a href="#l3.302"></a><span id="l3.302">         document.getElementById(&quot;messagepanebox&quot;).flex = 1;</span>
<a href="#l3.303"></a><span id="l3.303">     }</span>
<a href="#l3.304"></a><span id="l3.304"> </span>
<a href="#l3.305"></a><span id="l3.305">     // -- folder pane</span>
<a href="#l3.306"></a><span id="l3.306">     // collapse the splitter when not legal</span>
<a href="#l3.307"></a><span id="l3.307">     document.getElementById(&quot;folderpane_splitter&quot;).collapsed =</span>
<a href="#l3.308"></a><span id="l3.308">       !aLegalStates.folder;</span>
<a href="#l3.309"></a><span id="l3.309">     // collapse the folder pane when not visible</span>
<a href="#l3.310"></a><span id="l3.310">     document.getElementById(&quot;folderPaneBox&quot;).collapsed =</span>
<a href="#l3.311"></a><span id="l3.311">       !aLegalStates.folder || !aVisibleStates.folder;</span>
<a href="#l3.312"></a><span id="l3.312"> </span>
<a href="#l3.313"></a><span id="l3.313" class="difflineminus">-    // -- thread pane</span>
<a href="#l3.314"></a><span id="l3.314" class="difflineplus">+    // -- display deck (thread pane / account central)</span>
<a href="#l3.315"></a><span id="l3.315">     // in a vertical view, the threadContentArea sits in the #threadPaneBox</span>
<a href="#l3.316"></a><span id="l3.316">     //  next to the message pane and its splitter.</span>
<a href="#l3.317"></a><span id="l3.317">     if (layout == kVerticalMailLayout)</span>
<a href="#l3.318"></a><span id="l3.318">       document.getElementById(&quot;threadContentArea&quot;).collapsed =</span>
<a href="#l3.319"></a><span id="l3.319" class="difflineminus">-        !aLegalStates.thread;</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineplus">+        !displayDeckLegal;</span>
<a href="#l3.321"></a><span id="l3.321">     // whereas in the default view, the displayDeck is the one next to the</span>
<a href="#l3.322"></a><span id="l3.322">     //  message pane and its splitter</span>
<a href="#l3.323"></a><span id="l3.323">     else</span>
<a href="#l3.324"></a><span id="l3.324">       document.getElementById(&quot;displayDeck&quot;).collapsed =</span>
<a href="#l3.325"></a><span id="l3.325" class="difflineminus">-        !aLegalStates.thread;</span>
<a href="#l3.326"></a><span id="l3.326" class="difflineminus">-</span>
<a href="#l3.327"></a><span id="l3.327" class="difflineplus">+        !displayDeckLegal;</span>
<a href="#l3.328"></a><span id="l3.328" class="difflineplus">+</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineplus">+    // -- thread pane</span>
<a href="#l3.330"></a><span id="l3.330">     // the threadpane-splitter collapses the message pane (arguably a misnomer),</span>
<a href="#l3.331"></a><span id="l3.331">     //  but it only needs to exist when the thread-pane is legal</span>
<a href="#l3.332"></a><span id="l3.332">     document.getElementById(&quot;threadpane-splitter&quot;).collapsed =</span>
<a href="#l3.333"></a><span id="l3.333">       !aLegalStates.thread;</span>
<a href="#l3.334"></a><span id="l3.334" class="difflineplus">+    if (aLegalStates.thread &amp;&amp; aLegalStates.message)</span>
<a href="#l3.335"></a><span id="l3.335" class="difflineplus">+      document.getElementById(&quot;threadpane-splitter&quot;).setAttribute(&quot;state&quot;,</span>
<a href="#l3.336"></a><span id="l3.336" class="difflineplus">+        aVisibleStates.message ? &quot;open&quot; : &quot;collapsed&quot;);</span>
<a href="#l3.337"></a><span id="l3.337"> </span>
<a href="#l3.338"></a><span id="l3.338">     // Some things do not make sense if the thread pane is not legal.</span>
<a href="#l3.339"></a><span id="l3.339">     // (This is likely an example of something that should be using the command</span>
<a href="#l3.340"></a><span id="l3.340">     //  mechanism to update the UI elements as to the state of what the user</span>
<a href="#l3.341"></a><span id="l3.341">     //  is looking at, rather than home-brewing it in here.)</span>
<a href="#l3.342"></a><span id="l3.342">     try {</span>
<a href="#l3.343"></a><span id="l3.343">       // you can't quick-search if you don't have a collection of messages</span>
<a href="#l3.344"></a><span id="l3.344">       document.getElementById(&quot;search-container&quot;).collapsed =</span>
<a href="#l3.345"></a><span id="l3.345">         !aLegalStates.thread;</span>
<a href="#l3.346"></a><span id="l3.346">     } catch (ex) {}</span>
<a href="#l3.347"></a><span id="l3.347">     try {</span>
<a href="#l3.348"></a><span id="l3.348">       // views only work on the thread pane; no thread pane, no views</span>
<a href="#l3.349"></a><span id="l3.349">       document.getElementById(&quot;mailviews-container&quot;).collapsed =</span>
<a href="#l3.350"></a><span id="l3.350">         !aLegalStates.thread;</span>
<a href="#l3.351"></a><span id="l3.351">     } catch (ex) {}</span>
<a href="#l3.352"></a><span id="l3.352"> </span>
<a href="#l3.353"></a><span id="l3.353" class="difflineplus">+    // -- thread pane status bar helpers</span>
<a href="#l3.354"></a><span id="l3.354" class="difflineplus">+    GetUnreadCountElement().hidden = !aLegalStates.thread;</span>
<a href="#l3.355"></a><span id="l3.355" class="difflineplus">+    GetTotalCountElement().hidden = !aLegalStates.thread;</span>
<a href="#l3.356"></a><span id="l3.356" class="difflineplus">+</span>
<a href="#l3.357"></a><span id="l3.357">     // -- message pane</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineminus">-    // the message pane can only be collapsed when the thread pane is legal</span>
<a href="#l3.359"></a><span id="l3.359">     document.getElementById(&quot;messagepanebox&quot;).collapsed =</span>
<a href="#l3.360"></a><span id="l3.360" class="difflineminus">-      aLegalStates.thread &amp;&amp; !aVisibleStates.message;</span>
<a href="#l3.361"></a><span id="l3.361" class="difflineplus">+      !aLegalStates.message || !aVisibleStates.message;</span>
<a href="#l3.362"></a><span id="l3.362" class="difflineplus">+</span>
<a href="#l3.363"></a><span id="l3.363" class="difflineplus">+    // we are responsible for updating the keybinding; view_init takes care of</span>
<a href="#l3.364"></a><span id="l3.364" class="difflineplus">+    //  updating the menu item (on demand)</span>
<a href="#l3.365"></a><span id="l3.365" class="difflineplus">+    let messagePaneToggleKey = document.getElementById(&quot;key_toggleMessagePane&quot;);</span>
<a href="#l3.366"></a><span id="l3.366" class="difflineplus">+    if (aLegalStates.thread)</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineplus">+      messagePaneToggleKey.removeAttribute(&quot;disabled&quot;);</span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+    else</span>
<a href="#l3.369"></a><span id="l3.369" class="difflineplus">+      messagePaneToggleKey.setAttribute(&quot;disabled&quot;, &quot;true&quot;);</span>
<a href="#l3.370"></a><span id="l3.370"> </span>
<a href="#l3.371"></a><span id="l3.371">     // -- gloda facets</span>
<a href="#l3.372"></a><span id="l3.372">     document.getElementById(&quot;glodaSearchFacets&quot;).hidden =</span>
<a href="#l3.373"></a><span id="l3.373">       !aLegalStates.glodaFacets;</span>
<a href="#l3.374"></a><span id="l3.374">   },</span>
<a href="#l3.375"></a><span id="l3.375"> </span>
<a href="#l3.376"></a><span id="l3.376">   showTab: function(aTab) {</span>
<a href="#l3.377"></a><span id="l3.377">     // Set the messagepane as the primary browser for content.</span>
<a href="#l3.378"></a><span id="l3.378" class="difflineat">@@ -2224,17 +2334,17 @@ function MsgJunk()</span>
<a href="#l3.379"></a><span id="l3.379"> </span>
<a href="#l3.380"></a><span id="l3.380"> </span>
<a href="#l3.381"></a><span id="l3.381"> function UpdateJunkButton()</span>
<a href="#l3.382"></a><span id="l3.382"> {</span>
<a href="#l3.383"></a><span id="l3.383">   // The junk message should slave off the selected message, as the preview pane</span>
<a href="#l3.384"></a><span id="l3.384">   //  may not be visible</span>
<a href="#l3.385"></a><span id="l3.385">   let hdr = gFolderDisplay.selectedMessage;</span>
<a href="#l3.386"></a><span id="l3.386">   // But only the message display knows if we are dealing with a dummy.</span>
<a href="#l3.387"></a><span id="l3.387" class="difflineminus">-  if (gMessageDisplay.isDummy) // .eml file</span>
<a href="#l3.388"></a><span id="l3.388" class="difflineplus">+  if (!hdr || gMessageDisplay.isDummy) // .eml file</span>
<a href="#l3.389"></a><span id="l3.389">     return;</span>
<a href="#l3.390"></a><span id="l3.390">   let junkScore = hdr.getStringProperty(&quot;junkscore&quot;);</span>
<a href="#l3.391"></a><span id="l3.391">   let hideJunk = (junkScore != &quot;&quot;) &amp;&amp; (junkScore != &quot;0&quot;);</span>
<a href="#l3.392"></a><span id="l3.392">   if (gFolderDisplay.selectedMessageIsNews)</span>
<a href="#l3.393"></a><span id="l3.393">     hideJunk = true;</span>
<a href="#l3.394"></a><span id="l3.394"> </span>
<a href="#l3.395"></a><span id="l3.395">   getCurrentMsgHdrButtonBox().getButton('hdrJunkButton').disabled = hideJunk;</span>
<a href="#l3.396"></a><span id="l3.396"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/base/content/mailWindowOverlay.xul</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -441,17 +441,17 @@</span>
<a href="#l4.4"></a><span id="l4.4">   &lt;key keycode=&quot;VK_TAB&quot; oncommand=&quot;SwitchPaneFocus(event);&quot; modifiers=&quot;control,shift&quot;/&gt;</span>
<a href="#l4.5"></a><span id="l4.5">   &lt;key keycode=&quot;VK_TAB&quot; oncommand=&quot;SwitchPaneFocus(event);&quot; modifiers=&quot;control&quot;/&gt;</span>
<a href="#l4.6"></a><span id="l4.6">   &lt;key keycode=&quot;VK_F6&quot; oncommand=&quot;SwitchPaneFocus(event);&quot; modifiers=&quot;control,shift&quot;/&gt;</span>
<a href="#l4.7"></a><span id="l4.7">   &lt;key keycode=&quot;VK_F6&quot; oncommand=&quot;SwitchPaneFocus(event);&quot; modifiers=&quot;control&quot;/&gt;</span>
<a href="#l4.8"></a><span id="l4.8">   &lt;key keycode=&quot;VK_F6&quot; oncommand=&quot;SwitchPaneFocus(event);&quot; modifiers=&quot;shift&quot;/&gt;</span>
<a href="#l4.9"></a><span id="l4.9">   &lt;key keycode=&quot;VK_F6&quot; oncommand=&quot;SwitchPaneFocus(event);&quot;/&gt;</span>
<a href="#l4.10"></a><span id="l4.10"> </span>
<a href="#l4.11"></a><span id="l4.11">   &lt;!-- View Toggle Keys (F8) --&gt;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  &lt;key id=&quot;key_toggleMessagePane&quot; keycode=&quot;VK_F8&quot; oncommand=&quot;MsgToggleMessagePane();&quot; disabled=&quot;true&quot;/&gt;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  &lt;key id=&quot;key_toggleMessagePane&quot; keycode=&quot;VK_F8&quot; oncommand=&quot;MsgToggleMessagePane();&quot;/&gt;</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15">   &lt;!-- Tag Keys --&gt;</span>
<a href="#l4.16"></a><span id="l4.16">   &lt;!-- Includes both shifted and not, for Azerty and other layouts where the</span>
<a href="#l4.17"></a><span id="l4.17">        numeric keys are shifted. --&gt;</span>
<a href="#l4.18"></a><span id="l4.18">   &lt;key id=&quot;key_tag0&quot; key=&quot;&amp;tagCmd0.key;&quot; modifiers=&quot;shift any&quot;</span>
<a href="#l4.19"></a><span id="l4.19">        oncommand=&quot;RemoveAllMessageTags();&quot;/&gt;</span>
<a href="#l4.20"></a><span id="l4.20">   &lt;key id=&quot;key_tag1&quot; key=&quot;&amp;tagCmd1.key;&quot; modifiers=&quot;shift any&quot;</span>
<a href="#l4.21"></a><span id="l4.21">        oncommand=&quot;ToggleMessageTagKey(1);&quot;/&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/base/content/messageDisplay.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/base/content/messageDisplay.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -359,19 +359,19 @@ MessageDisplayWidget.prototype = {</span>
<a href="#l5.4"></a><span id="l5.4">     this._active = false;</span>
<a href="#l5.5"></a><span id="l5.5">   }</span>
<a href="#l5.6"></a><span id="l5.6"> };</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8"> /**</span>
<a href="#l5.9"></a><span id="l5.9">  * Display widget abstraction for the 3-pane message view's preview pane/message</span>
<a href="#l5.10"></a><span id="l5.10">  *  pane. Like the DisplayWidget, it is multiplexed.</span>
<a href="#l5.11"></a><span id="l5.11">  */</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-function MessagePaneDisplayWidget() {</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+function MessagePaneDisplayWidget(aBeVisible) {</span>
<a href="#l5.14"></a><span id="l5.14">   MessageDisplayWidget.call(this);</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-  this._visible = true;</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+  this._visible = aBeVisible == undefined ? true : aBeVisible;</span>
<a href="#l5.17"></a><span id="l5.17"> }</span>
<a href="#l5.18"></a><span id="l5.18"> MessagePaneDisplayWidget.prototype = {</span>
<a href="#l5.19"></a><span id="l5.19">   __proto__: MessageDisplayWidget.prototype,</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21">   get visible MessageDisplayWidget_get_visible() {</span>
<a href="#l5.22"></a><span id="l5.22">     return this._visible;</span>
<a href="#l5.23"></a><span id="l5.23">   },</span>
<a href="#l5.24"></a><span id="l5.24">   /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mail/base/content/messenger.xul</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mail/base/content/messenger.xul</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -240,17 +240,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">             &lt;/vbox&gt;</span>
<a href="#l6.5"></a><span id="l6.5"> </span>
<a href="#l6.6"></a><span id="l6.6">             &lt;splitter id=&quot;folderpane_splitter&quot; collapse=&quot;before&quot; persist=&quot;state&quot;/&gt;</span>
<a href="#l6.7"></a><span id="l6.7"> </span>
<a href="#l6.8"></a><span id="l6.8">             &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l6.9"></a><span id="l6.9">               &lt;box orient=&quot;vertical&quot; id=&quot;messagesBox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l6.10"></a><span id="l6.10">                 &lt;deck id=&quot;displayDeck&quot; flex=&quot;1&quot; selectedIndex=&quot;0&quot;</span>
<a href="#l6.11"></a><span id="l6.11">                       minheight=&quot;100&quot; height=&quot;100&quot; persist=&quot;height&quot;</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-                      onselect=&quot;ObserveDisplayDeckChange(event)&quot;&gt;</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineplus">+                      &gt;</span>
<a href="#l6.14"></a><span id="l6.14">                   &lt;!-- first panel in displayDeck is Account Central --&gt;</span>
<a href="#l6.15"></a><span id="l6.15">                   &lt;vbox id=&quot;accountCentralBox&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l6.16"></a><span id="l6.16">                     &lt;iframe name=&quot;accountCentralPane&quot; width=&quot;150&quot; flex=&quot;1&quot; src=&quot;about:blank&quot;/&gt;</span>
<a href="#l6.17"></a><span id="l6.17">                   &lt;/vbox&gt;</span>
<a href="#l6.18"></a><span id="l6.18">                   &lt;!-- The threadPaneBox is the basis for the vertical view and you</span>
<a href="#l6.19"></a><span id="l6.19">                        should not put anything in it, because the messagepane will</span>
<a href="#l6.20"></a><span id="l6.20">                        get transplanted in there. (In the vertical view, the elements</span>
<a href="#l6.21"></a><span id="l6.21">                        end up being: threadPaneBox, threadpane-splitter, messagepanebox)</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineat">@@ -356,17 +356,17 @@</span>
<a href="#l6.23"></a><span id="l6.23">                     &lt;treechildren ondraggesture=&quot;threadPaneOnDragStart(event);&quot;/&gt;</span>
<a href="#l6.24"></a><span id="l6.24">                   &lt;/tree&gt;</span>
<a href="#l6.25"></a><span id="l6.25">                  &lt;/vbox&gt;</span>
<a href="#l6.26"></a><span id="l6.26">                 &lt;/hbox&gt;</span>
<a href="#l6.27"></a><span id="l6.27">                 &lt;!-- extensions may overlay in additional panels; don't assume that there are only 2! --&gt;</span>
<a href="#l6.28"></a><span id="l6.28">                 &lt;/deck&gt; &lt;!-- displayDeck --&gt;</span>
<a href="#l6.29"></a><span id="l6.29"> </span>
<a href="#l6.30"></a><span id="l6.30">                 &lt;!-- if you change this id, please change GetThreadAndMessagePaneSplitter() and MsgToggleMessagePane() --&gt;</span>
<a href="#l6.31"></a><span id="l6.31" class="difflineminus">-                &lt;splitter id=&quot;threadpane-splitter&quot; collapse=&quot;after&quot; persist=&quot;state&quot; collapsed=&quot;true&quot;</span>
<a href="#l6.32"></a><span id="l6.32" class="difflineplus">+                &lt;splitter id=&quot;threadpane-splitter&quot; collapse=&quot;after&quot; collapsed=&quot;true&quot;</span>
<a href="#l6.33"></a><span id="l6.33">                           onmouseup=&quot;OnMouseUpThreadAndMessagePaneSplitter()&quot;/&gt;</span>
<a href="#l6.34"></a><span id="l6.34"> </span>
<a href="#l6.35"></a><span id="l6.35">                 &lt;vbox id=&quot;messagepanebox&quot; flex=&quot;2&quot; minheight=&quot;100&quot; height=&quot;200&quot;</span>
<a href="#l6.36"></a><span id="l6.36">                       minwidth=&quot;100&quot; width=&quot;200&quot; persist=&quot;height width&quot;&gt;</span>
<a href="#l6.37"></a><span id="l6.37">                   </span>
<a href="#l6.38"></a><span id="l6.38">                   &lt;!-- This next iframe is used to display summaries of --&gt;</span>
<a href="#l6.39"></a><span id="l6.39">                   &lt;!-- multiple selected messages or collapsed threads --&gt;</span>
<a href="#l6.40"></a><span id="l6.40">                   &lt;iframe id=&quot;multimessage&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mail/base/content/msgMail3PaneWindow.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -77,17 +77,16 @@ var gStartFolderUri = null;</span>
<a href="#l7.4"></a><span id="l7.4">  * of it, we alter the selection (but not the current index) to be the row they</span>
<a href="#l7.5"></a><span id="l7.5">  * clicked on.</span>
<a href="#l7.6"></a><span id="l7.6">  *</span>
<a href="#l7.7"></a><span id="l7.7">  * The value of this variable is an object with &quot;view&quot; and &quot;selection&quot; keys</span>
<a href="#l7.8"></a><span id="l7.8">  * and values.  The view value is the view whose selection we saved off, and</span>
<a href="#l7.9"></a><span id="l7.9">  * the selection value is the selection object we saved off.</span>
<a href="#l7.10"></a><span id="l7.10">  */</span>
<a href="#l7.11"></a><span id="l7.11"> var gRightMouseButtonSavedSelection = null;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-var gLoadStartFolder = true;</span>
<a href="#l7.13"></a><span id="l7.13"> var gNewAccountToLoad = null;</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> // Global var to keep track of if the 'Delete Message' or 'Move To' thread pane</span>
<a href="#l7.16"></a><span id="l7.16"> // context menu item was triggered.  This helps prevent the tree view from</span>
<a href="#l7.17"></a><span id="l7.17"> // not updating on one of those menu item commands.</span>
<a href="#l7.18"></a><span id="l7.18"> var gThreadPaneDeleteOrMoveOccurred = false;</span>
<a href="#l7.19"></a><span id="l7.19"> </span>
<a href="#l7.20"></a><span id="l7.20"> var gDisplayStartupPage = false;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineat">@@ -431,38 +430,101 @@ function HandleAppCommandEvent(evt)</span>
<a href="#l7.22"></a><span id="l7.22">  * Called by messenger.xul:onunload, the 3-pane window inside of tabs window.</span>
<a href="#l7.23"></a><span id="l7.23">  *  It's being unloaded!  Right now!</span>
<a href="#l7.24"></a><span id="l7.24">  */</span>
<a href="#l7.25"></a><span id="l7.25"> function OnUnloadMessenger()</span>
<a href="#l7.26"></a><span id="l7.26"> {</span>
<a href="#l7.27"></a><span id="l7.27">   accountManager.removeIncomingServerListener(gThreePaneIncomingServerListener);</span>
<a href="#l7.28"></a><span id="l7.28">   gPrefBranch.QueryInterface(Components.interfaces.nsIPrefBranch2);</span>
<a href="#l7.29"></a><span id="l7.29">   gPrefBranch.removeObserver(&quot;mail.pane_config.dynamic&quot;, MailPrefObserver);</span>
<a href="#l7.30"></a><span id="l7.30" class="difflineminus">-  document.getElementById('tabmail').closeTabs();</span>
<a href="#l7.31"></a><span id="l7.31" class="difflineplus">+</span>
<a href="#l7.32"></a><span id="l7.32" class="difflineplus">+  // - Persist the tab state and then close the tabs.</span>
<a href="#l7.33"></a><span id="l7.33" class="difflineplus">+  // XXX do not assume there is only ever one 3-pane.</span>
<a href="#l7.34"></a><span id="l7.34" class="difflineplus">+  let tabmail = document.getElementById('tabmail');</span>
<a href="#l7.35"></a><span id="l7.35" class="difflineplus">+  let tabsState = tabmail.persistTabs();</span>
<a href="#l7.36"></a><span id="l7.36" class="difflineplus">+  // build the state like we aren't assuming a single 3-pane</span>
<a href="#l7.37"></a><span id="l7.37" class="difflineplus">+  let state = {</span>
<a href="#l7.38"></a><span id="l7.38" class="difflineplus">+    rev: 0,</span>
<a href="#l7.39"></a><span id="l7.39" class="difflineplus">+    windows: [{</span>
<a href="#l7.40"></a><span id="l7.40" class="difflineplus">+        type: &quot;3pane&quot;,</span>
<a href="#l7.41"></a><span id="l7.41" class="difflineplus">+        tabs: tabsState</span>
<a href="#l7.42"></a><span id="l7.42" class="difflineplus">+      }</span>
<a href="#l7.43"></a><span id="l7.43" class="difflineplus">+    ]</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+  };</span>
<a href="#l7.45"></a><span id="l7.45" class="difflineplus">+  let data = JSON.stringify(state);</span>
<a href="#l7.46"></a><span id="l7.46" class="difflineplus">+  let file = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l7.47"></a><span id="l7.47" class="difflineplus">+                       .getService(Components.interfaces.nsIProperties)</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineplus">+                       .get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+  file.append(&quot;session.json&quot;);</span>
<a href="#l7.50"></a><span id="l7.50" class="difflineplus">+  let foStream = Components.classes[&quot;@mozilla.org/network/file-output-stream;1&quot;]</span>
<a href="#l7.51"></a><span id="l7.51" class="difflineplus">+                   .createInstance(Components.interfaces.nsIFileOutputStream);</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+  foStream.init(file, 0x02 | 0x08 | 0x20, 0666, 0);</span>
<a href="#l7.53"></a><span id="l7.53" class="difflineplus">+  foStream.write(data, data.length);</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineplus">+  foStream.close();</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineplus">+</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+  tabmail.closeTabs();</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+</span>
<a href="#l7.58"></a><span id="l7.58"> </span>
<a href="#l7.59"></a><span id="l7.59">   var mailSession = Components.classes[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l7.60"></a><span id="l7.60">                               .getService(Components.interfaces.nsIMsgMailSession);</span>
<a href="#l7.61"></a><span id="l7.61">   mailSession.RemoveFolderListener(folderListener);</span>
<a href="#l7.62"></a><span id="l7.62"> </span>
<a href="#l7.63"></a><span id="l7.63">   gPhishingDetector.shutdown();</span>
<a href="#l7.64"></a><span id="l7.64"> </span>
<a href="#l7.65"></a><span id="l7.65">   // FIX ME - later we will be able to use onload from the overlay</span>
<a href="#l7.66"></a><span id="l7.66">   OnUnloadMsgHeaderPane();</span>
<a href="#l7.67"></a><span id="l7.67"> </span>
<a href="#l7.68"></a><span id="l7.68">   UnloadPanes();</span>
<a href="#l7.69"></a><span id="l7.69"> </span>
<a href="#l7.70"></a><span id="l7.70">   OnMailWindowUnload();</span>
<a href="#l7.71"></a><span id="l7.71"> }</span>
<a href="#l7.72"></a><span id="l7.72"> </span>
<a href="#l7.73"></a><span id="l7.73" class="difflineplus">+// XXX provides GlodaUtils, remove once we migrate loadFileToString</span>
<a href="#l7.74"></a><span id="l7.74" class="difflineplus">+Components.utils.import(&quot;resource://app/modules/gloda/utils.js&quot;);</span>
<a href="#l7.75"></a><span id="l7.75" class="difflineplus">+</span>
<a href="#l7.76"></a><span id="l7.76" class="difflineplus">+/**</span>
<a href="#l7.77"></a><span id="l7.77" class="difflineplus">+ * Attempt to restore our tab states.  This should only be called by</span>
<a href="#l7.78"></a><span id="l7.78" class="difflineplus">+ *  loadStartFolder.</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineplus">+ */</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+function atStartupRestoreTabs() {</span>
<a href="#l7.81"></a><span id="l7.81" class="difflineplus">+  let file = Components.classes[&quot;@mozilla.org/file/directory_service;1&quot;]</span>
<a href="#l7.82"></a><span id="l7.82" class="difflineplus">+                       .getService(Components.interfaces.nsIProperties)</span>
<a href="#l7.83"></a><span id="l7.83" class="difflineplus">+                       .get(&quot;ProfD&quot;, Components.interfaces.nsIFile);</span>
<a href="#l7.84"></a><span id="l7.84" class="difflineplus">+  file.append(&quot;session.json&quot;);</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineplus">+  if (!file.exists())</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+    return false;</span>
<a href="#l7.87"></a><span id="l7.87" class="difflineplus">+</span>
<a href="#l7.88"></a><span id="l7.88" class="difflineplus">+  // XXX migrate loadFileToString to MessengerUtils once it exists (it's in</span>
<a href="#l7.89"></a><span id="l7.89" class="difflineplus">+  //  another patch)</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineplus">+  let data = GlodaUtils.loadFileToString(file);</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+</span>
<a href="#l7.92"></a><span id="l7.92" class="difflineplus">+  // delete the file before restoring state in case there is something</span>
<a href="#l7.93"></a><span id="l7.93" class="difflineplus">+  //  crash-inducing about the restoration process.  Also, this avoids weird</span>
<a href="#l7.94"></a><span id="l7.94" class="difflineplus">+  //  3pane behavior if you open any additional 3panes.</span>
<a href="#l7.95"></a><span id="l7.95" class="difflineplus">+  file.remove(false);</span>
<a href="#l7.96"></a><span id="l7.96" class="difflineplus">+</span>
<a href="#l7.97"></a><span id="l7.97" class="difflineplus">+  let state = JSON.parse(data);</span>
<a href="#l7.98"></a><span id="l7.98" class="difflineplus">+  let tabsState = state.windows[0].tabs;</span>
<a href="#l7.99"></a><span id="l7.99" class="difflineplus">+  let tabmail = document.getElementById('tabmail');</span>
<a href="#l7.100"></a><span id="l7.100" class="difflineplus">+  tabmail.restoreTabs(tabsState);</span>
<a href="#l7.101"></a><span id="l7.101" class="difflineplus">+</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineplus">+  return true;</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+}</span>
<a href="#l7.104"></a><span id="l7.104" class="difflineplus">+</span>
<a href="#l7.105"></a><span id="l7.105"> function loadStartFolder(initialUri)</span>
<a href="#l7.106"></a><span id="l7.106"> {</span>
<a href="#l7.107"></a><span id="l7.107">     var defaultServer = null;</span>
<a href="#l7.108"></a><span id="l7.108">     var startFolder;</span>
<a href="#l7.109"></a><span id="l7.109">     var isLoginAtStartUpEnabled = false;</span>
<a href="#l7.110"></a><span id="l7.110"> </span>
<a href="#l7.111"></a><span id="l7.111" class="difflineplus">+    let loadFolder = !atStartupRestoreTabs();</span>
<a href="#l7.112"></a><span id="l7.112" class="difflineplus">+    // If a URI was explicitly specified, we'll just clobber the default tab</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineplus">+    if (initialUri)</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+      loadFolder = true;</span>
<a href="#l7.115"></a><span id="l7.115" class="difflineplus">+</span>
<a href="#l7.116"></a><span id="l7.116">     //First get default account</span>
<a href="#l7.117"></a><span id="l7.117">     try</span>
<a href="#l7.118"></a><span id="l7.118">     {</span>
<a href="#l7.119"></a><span id="l7.119">         if(initialUri)</span>
<a href="#l7.120"></a><span id="l7.120">             startFolder = GetMsgFolderFromUri(initialUri);</span>
<a href="#l7.121"></a><span id="l7.121">         else</span>
<a href="#l7.122"></a><span id="l7.122">         {</span>
<a href="#l7.123"></a><span id="l7.123">             var defaultAccount = accountManager.defaultAccount;</span>
<a href="#l7.124"></a><span id="l7.124" class="difflineat">@@ -518,27 +580,29 @@ function loadStartFolder(initialUri)</span>
<a href="#l7.125"></a><span id="l7.125">             catch (ex) {</span>
<a href="#l7.126"></a><span id="l7.126">               // If user cancels an exception is expected.</span>
<a href="#l7.127"></a><span id="l7.127">             }</span>
<a href="#l7.128"></a><span id="l7.128">           }</span>
<a href="#l7.129"></a><span id="l7.129">         }</span>
<a href="#l7.130"></a><span id="l7.130">         // Perform biff on the server to check for new mail, except for imap</span>
<a href="#l7.131"></a><span id="l7.131">         // or a pop3 account that is deferred or deferred to,</span>
<a href="#l7.132"></a><span id="l7.132">         // or the case where initialUri is non-null (non-startup)</span>
<a href="#l7.133"></a><span id="l7.133" class="difflineminus">-        if (!initialUri &amp;&amp; isLoginAtStartUpEnabled &amp;&amp; gLoadStartFolder</span>
<a href="#l7.134"></a><span id="l7.134" class="difflineplus">+        if (!initialUri &amp;&amp; isLoginAtStartUpEnabled</span>
<a href="#l7.135"></a><span id="l7.135">             &amp;&amp; !defaultServer.isDeferredTo &amp;&amp;</span>
<a href="#l7.136"></a><span id="l7.136">             defaultServer.rootFolder == defaultServer.rootMsgFolder)</span>
<a href="#l7.137"></a><span id="l7.137">           defaultServer.performBiff(msgWindow);</span>
<a href="#l7.138"></a><span id="l7.138" class="difflineminus">-        try {</span>
<a href="#l7.139"></a><span id="l7.139" class="difflineminus">-          gFolderTreeView.selectFolder(startFolder);</span>
<a href="#l7.140"></a><span id="l7.140" class="difflineminus">-        } catch(ex) {</span>
<a href="#l7.141"></a><span id="l7.141" class="difflineminus">-          // This means we tried to select a folder that isn't in the current</span>
<a href="#l7.142"></a><span id="l7.142" class="difflineminus">-          // view. Just select the first one in the view then.</span>
<a href="#l7.143"></a><span id="l7.143" class="difflineminus">-          if (gFolderTreeView._rowMap.length)</span>
<a href="#l7.144"></a><span id="l7.144" class="difflineminus">-            gFolderTreeView.selectFolder(gFolderTreeView._rowMap[0]._folder);</span>
<a href="#l7.145"></a><span id="l7.145" class="difflineplus">+        if (loadFolder) {</span>
<a href="#l7.146"></a><span id="l7.146" class="difflineplus">+          try {</span>
<a href="#l7.147"></a><span id="l7.147" class="difflineplus">+            gFolderTreeView.selectFolder(startFolder);</span>
<a href="#l7.148"></a><span id="l7.148" class="difflineplus">+          } catch(ex) {</span>
<a href="#l7.149"></a><span id="l7.149" class="difflineplus">+            // This means we tried to select a folder that isn't in the current</span>
<a href="#l7.150"></a><span id="l7.150" class="difflineplus">+            // view. Just select the first one in the view then.</span>
<a href="#l7.151"></a><span id="l7.151" class="difflineplus">+            if (gFolderTreeView._rowMap.length)</span>
<a href="#l7.152"></a><span id="l7.152" class="difflineplus">+              gFolderTreeView.selectFolder(gFolderTreeView._rowMap[0]._folder);</span>
<a href="#l7.153"></a><span id="l7.153" class="difflineplus">+          }</span>
<a href="#l7.154"></a><span id="l7.154">         }</span>
<a href="#l7.155"></a><span id="l7.155">     }</span>
<a href="#l7.156"></a><span id="l7.156">     catch(ex)</span>
<a href="#l7.157"></a><span id="l7.157">     {</span>
<a href="#l7.158"></a><span id="l7.158">       // this is the case where we're trying to auto-subscribe to a folder.</span>
<a href="#l7.159"></a><span id="l7.159">       if (initialUri &amp;&amp; !startFolder.parent)</span>
<a href="#l7.160"></a><span id="l7.160">       {</span>
<a href="#l7.161"></a><span id="l7.161">         // hack to force display of thread pane.</span>
<a href="#l7.162"></a><span id="l7.162" class="difflineat">@@ -546,20 +610,17 @@ function loadStartFolder(initialUri)</span>
<a href="#l7.163"></a><span id="l7.163">         messenger.loadURL(window, initialUri);</span>
<a href="#l7.164"></a><span id="l7.164">         return;</span>
<a href="#l7.165"></a><span id="l7.165">       }</span>
<a href="#l7.166"></a><span id="l7.166"> </span>
<a href="#l7.167"></a><span id="l7.167">       dump(ex);</span>
<a href="#l7.168"></a><span id="l7.168">       dump('Exception in LoadStartFolder caused by no default account.  We know about this\n');</span>
<a href="#l7.169"></a><span id="l7.169">     }</span>
<a href="#l7.170"></a><span id="l7.170"> </span>
<a href="#l7.171"></a><span id="l7.171" class="difflineminus">-    // if gLoadStartFolder is true, then we must have just created a POP3 account</span>
<a href="#l7.172"></a><span id="l7.172" class="difflineminus">-    // and we aren't supposed to initially download mail. (Bug #270743)</span>
<a href="#l7.173"></a><span id="l7.173" class="difflineminus">-    if (gLoadStartFolder)</span>
<a href="#l7.174"></a><span id="l7.174" class="difflineminus">-      MsgGetMessagesForAllServers(defaultServer);</span>
<a href="#l7.175"></a><span id="l7.175" class="difflineplus">+    MsgGetMessagesForAllServers(defaultServer);</span>
<a href="#l7.176"></a><span id="l7.176"> </span>
<a href="#l7.177"></a><span id="l7.177">     if (MailOfflineMgr.isOnline()) {</span>
<a href="#l7.178"></a><span id="l7.178">       // Check if we shut down offline, and restarted online, in which case</span>
<a href="#l7.179"></a><span id="l7.179">       // we may have offline events to playback. Since this is not a pref</span>
<a href="#l7.180"></a><span id="l7.180">       // the user should set, it's not in mailnews.js, so we need a try catch.</span>
<a href="#l7.181"></a><span id="l7.181">       let playbackOfflineEvents = false;</span>
<a href="#l7.182"></a><span id="l7.182">       try {</span>
<a href="#l7.183"></a><span id="l7.183">         playbackOfflineEvents = gPrefBranch.getBoolPref(&quot;mailnews.playback_offline&quot;);</span>
<a href="#l7.184"></a><span id="l7.184" class="difflineat">@@ -766,17 +827,18 @@ function GetTotalCountElement()</span>
<a href="#l7.185"></a><span id="l7.185"> {</span>
<a href="#l7.186"></a><span id="l7.186">   if (!gTotalCount)</span>
<a href="#l7.187"></a><span id="l7.187">     gTotalCount = document.getElementById('totalMessageCount');</span>
<a href="#l7.188"></a><span id="l7.188">   return gTotalCount;</span>
<a href="#l7.189"></a><span id="l7.189"> }</span>
<a href="#l7.190"></a><span id="l7.190"> </span>
<a href="#l7.191"></a><span id="l7.191"> function IsMessagePaneCollapsed()</span>
<a href="#l7.192"></a><span id="l7.192"> {</span>
<a href="#l7.193"></a><span id="l7.193" class="difflineminus">-  return GetMessagePane().collapsed;</span>
<a href="#l7.194"></a><span id="l7.194" class="difflineplus">+  return document.getElementById(&quot;threadpane-splitter&quot;)</span>
<a href="#l7.195"></a><span id="l7.195" class="difflineplus">+                 .getAttribute(&quot;state&quot;) == &quot;collapsed&quot;;</span>
<a href="#l7.196"></a><span id="l7.196"> }</span>
<a href="#l7.197"></a><span id="l7.197"> </span>
<a href="#l7.198"></a><span id="l7.198"> function ClearThreadPaneSelection()</span>
<a href="#l7.199"></a><span id="l7.199"> {</span>
<a href="#l7.200"></a><span id="l7.200">   gFolderDisplay.clearSelection();</span>
<a href="#l7.201"></a><span id="l7.201"> }</span>
<a href="#l7.202"></a><span id="l7.202"> </span>
<a href="#l7.203"></a><span id="l7.203"> function ClearMessagePane()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mail/base/content/tabmail.xml</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mail/base/content/tabmail.xml</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -173,16 +173,35 @@</span>
<a href="#l8.4"></a><span id="l8.4">     -     currently displayed.  You are responsible for properly cleaning up</span>
<a href="#l8.5"></a><span id="l8.5">     -     any state you preserved in aTab.</span>
<a href="#l8.6"></a><span id="l8.6">     - * saveTabState(aTab): Called when aTab is being switched away from so that</span>
<a href="#l8.7"></a><span id="l8.7">     -     you can preserve its state on aTab.  This is primarily for single</span>
<a href="#l8.8"></a><span id="l8.8">     -     tab panel implementations; you may not have much state to save if your</span>
<a href="#l8.9"></a><span id="l8.9">     -     tab has its own tab panel.</span>
<a href="#l8.10"></a><span id="l8.10">     - * showTab(aTab): Called when aTab is being displayed and you should</span>
<a href="#l8.11"></a><span id="l8.11">     -     restore its state (if required).</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineplus">+    - * persistTab(aTab): Called when we want to persist the tab because we are</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineplus">+    -     saving the session state.  You should return an object suitable for</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+    -     JSON serialization.  The object will be provided to your restoreTab</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+    -     method when we attempt to restore the session.  If your code is</span>
<a href="#l8.16"></a><span id="l8.16" class="difflineplus">+    -     unable or unwilling to persist the tab (some of the time), you should</span>
<a href="#l8.17"></a><span id="l8.17" class="difflineplus">+    -     return null in that case.  If your code never wants to persist the tab</span>
<a href="#l8.18"></a><span id="l8.18" class="difflineplus">+    -     you should not implement this method.  You must implement restoreTab</span>
<a href="#l8.19"></a><span id="l8.19" class="difflineplus">+    -     if you implement this method.</span>
<a href="#l8.20"></a><span id="l8.20" class="difflineplus">+    - * restoreTab(aTabmail, aPersistedState): Called when we are restoring a</span>
<a href="#l8.21"></a><span id="l8.21" class="difflineplus">+    -     tab session and a tab with your mode was previously persisted via a</span>
<a href="#l8.22"></a><span id="l8.22" class="difflineplus">+    -     call to your persistTab implementation.  You are provided with a</span>
<a href="#l8.23"></a><span id="l8.23" class="difflineplus">+    -     reference to this tabmail instance and the (deserialized) state object</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineplus">+    -     you returned from your persistTab implementation.  It is your</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+    -     function's job to determine if you can restore the tab, and if so,</span>
<a href="#l8.26"></a><span id="l8.26" class="difflineplus">+    -     you should invoke aTabmail.openTab to actually cause your tab to be</span>
<a href="#l8.27"></a><span id="l8.27" class="difflineplus">+    -     opened.  This may seem odd, but it should help keep your code simple</span>
<a href="#l8.28"></a><span id="l8.28" class="difflineplus">+    -     while letting you do whatever you want.  Since openTab is synchronous</span>
<a href="#l8.29"></a><span id="l8.29" class="difflineplus">+    -     and returns the tabInfo structure built for the tab, you can perform</span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+    -     any additional work you need after the call to openTab.</span>
<a href="#l8.31"></a><span id="l8.31">     - * onTitleChanged(aTab): Called when someone calls tabmail.setTabTitle() to</span>
<a href="#l8.32"></a><span id="l8.32">     -     hint that the tab's title needs to be updated.  This function should</span>
<a href="#l8.33"></a><span id="l8.33">     -     update aTab.title if it can.</span>
<a href="#l8.34"></a><span id="l8.34">     - Mode definition functions to do with menu/toolbar commands:</span>
<a href="#l8.35"></a><span id="l8.35">     - * supportsCommand(aTab, aCommand): Called when a menu or toolbar needs to</span>
<a href="#l8.36"></a><span id="l8.36">     -     be updated. Return true if you support that command in</span>
<a href="#l8.37"></a><span id="l8.37">     -     isCommandEnabled and doCommand, return false otherwise.</span>
<a href="#l8.38"></a><span id="l8.38">     - * isCommandEnabled(aTab, aCommand): Called when a menu or toolbar needs</span>
<a href="#l8.39"></a><span id="l8.39" class="difflineat">@@ -330,19 +349,19 @@</span>
<a href="#l8.40"></a><span id="l8.40">            true, the current tab will be returned.  Otherwise, an</span>
<a href="#l8.41"></a><span id="l8.41">            exception will be thrown.</span>
<a href="#l8.42"></a><span id="l8.42">         --&gt;</span>
<a href="#l8.43"></a><span id="l8.43">       &lt;method name=&quot;_getTabContextForTabbyThing&quot;&gt;</span>
<a href="#l8.44"></a><span id="l8.44">         &lt;parameter name=&quot;aTabIndexNodeOrInfo&quot;/&gt;</span>
<a href="#l8.45"></a><span id="l8.45">         &lt;parameter name=&quot;aDefaultToCurrent&quot;/&gt;</span>
<a href="#l8.46"></a><span id="l8.46">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.47"></a><span id="l8.47">           let iTab, tab, tabNode;</span>
<a href="#l8.48"></a><span id="l8.48" class="difflineminus">-          if (!aTabIndexNodeOrInfo) {</span>
<a href="#l8.49"></a><span id="l8.49" class="difflineplus">+          if (aTabIndexNodeOrInfo == null) {</span>
<a href="#l8.50"></a><span id="l8.50">             if (!aDefaultToCurrent)</span>
<a href="#l8.51"></a><span id="l8.51" class="difflineminus">-              throw Exception(&quot;You need to specify a tab!&quot;);</span>
<a href="#l8.52"></a><span id="l8.52" class="difflineplus">+              throw Error(&quot;You need to specify a tab!&quot;);</span>
<a href="#l8.53"></a><span id="l8.53">             iTab = this.tabContainer.selectedIndex;</span>
<a href="#l8.54"></a><span id="l8.54">             return [iTab, this.tabInfo[iTab],</span>
<a href="#l8.55"></a><span id="l8.55">                     this.tabContainer.childNodes[iTab]];</span>
<a href="#l8.56"></a><span id="l8.56">           }</span>
<a href="#l8.57"></a><span id="l8.57"> </span>
<a href="#l8.58"></a><span id="l8.58">           if (typeof(aTabIndexNodeOrInfo) == &quot;number&quot;) {</span>
<a href="#l8.59"></a><span id="l8.59">             iTab = aTabIndexNodeOrInfo;</span>
<a href="#l8.60"></a><span id="l8.60">             tabNode = this.tabContainer.childNodes[iTab];</span>
<a href="#l8.61"></a><span id="l8.61" class="difflineat">@@ -418,16 +437,17 @@</span>
<a href="#l8.62"></a><span id="l8.62">           this.saveCurrentTabState();</span>
<a href="#l8.63"></a><span id="l8.63"> </span>
<a href="#l8.64"></a><span id="l8.64">           let tab = {mode: tabMode, busy: false, canClose: true};</span>
<a href="#l8.65"></a><span id="l8.65">           tabMode.tabs.push(tab);</span>
<a href="#l8.66"></a><span id="l8.66"> </span>
<a href="#l8.67"></a><span id="l8.67">           var t = document.createElementNS(</span>
<a href="#l8.68"></a><span id="l8.68">             &quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;,</span>
<a href="#l8.69"></a><span id="l8.69">             &quot;tab&quot;);</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineplus">+          tab.tabNode = t;</span>
<a href="#l8.71"></a><span id="l8.71">           t.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l8.72"></a><span id="l8.72">           t.maxWidth = this.tabContainer.mTabMaxWidth;</span>
<a href="#l8.73"></a><span id="l8.73">           t.minWidth = this.tabContainer.mTabMinWidth;</span>
<a href="#l8.74"></a><span id="l8.74">           t.width = 0;</span>
<a href="#l8.75"></a><span id="l8.75">           t.setAttribute(&quot;flex&quot;, &quot;100&quot;);</span>
<a href="#l8.76"></a><span id="l8.76">           t.setAttribute(&quot;validate&quot;, &quot;never&quot;);</span>
<a href="#l8.77"></a><span id="l8.77">           t.className = &quot;tabmail-tab&quot;;</span>
<a href="#l8.78"></a><span id="l8.78">           this.tabContainer.appendChild(t);</span>
<a href="#l8.79"></a><span id="l8.79" class="difflineat">@@ -484,16 +504,18 @@</span>
<a href="#l8.80"></a><span id="l8.80">           document.title = docTitle;</span>
<a href="#l8.81"></a><span id="l8.81">           </span>
<a href="#l8.82"></a><span id="l8.82">           // for styling purposes, apply the type to the tab...</span>
<a href="#l8.83"></a><span id="l8.83">           t.setAttribute('type', tab.mode.type);</span>
<a href="#l8.84"></a><span id="l8.84"> </span>
<a href="#l8.85"></a><span id="l8.85">           // Update the toolbar status - we don't need to do menus as they</span>
<a href="#l8.86"></a><span id="l8.86">           // do themselves when we open them.</span>
<a href="#l8.87"></a><span id="l8.87">           UpdateMailToolbar(&quot;tabmail&quot;);</span>
<a href="#l8.88"></a><span id="l8.88" class="difflineplus">+</span>
<a href="#l8.89"></a><span id="l8.89" class="difflineplus">+          return tab;</span>
<a href="#l8.90"></a><span id="l8.90">         ]]&gt;&lt;/body&gt;</span>
<a href="#l8.91"></a><span id="l8.91">       &lt;/method&gt;</span>
<a href="#l8.92"></a><span id="l8.92">       &lt;method name=&quot;selectTabByMode&quot;&gt;</span>
<a href="#l8.93"></a><span id="l8.93">         &lt;parameter name=&quot;aTabModeName&quot;/&gt;</span>
<a href="#l8.94"></a><span id="l8.94">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.95"></a><span id="l8.95">           let tabMode = this.tabModes[aTabModeName];</span>
<a href="#l8.96"></a><span id="l8.96">           if (tabMode.tabs.length) {</span>
<a href="#l8.97"></a><span id="l8.97">             let desiredTab = tabMode.tabs[0];</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineat">@@ -596,16 +618,95 @@</span>
<a href="#l8.99"></a><span id="l8.99">       &lt;method name=&quot;removeTabByNode&quot;&gt;</span>
<a href="#l8.100"></a><span id="l8.100">         &lt;parameter name=&quot;aTabNode&quot;/&gt;</span>
<a href="#l8.101"></a><span id="l8.101">         &lt;body&gt;</span>
<a href="#l8.102"></a><span id="l8.102">           &lt;![CDATA[</span>
<a href="#l8.103"></a><span id="l8.103">             this.closeTab(aTabNode);</span>
<a href="#l8.104"></a><span id="l8.104">           ]]&gt;</span>
<a href="#l8.105"></a><span id="l8.105">         &lt;/body&gt;</span>
<a href="#l8.106"></a><span id="l8.106">       &lt;/method&gt;</span>
<a href="#l8.107"></a><span id="l8.107" class="difflineplus">+      &lt;method name=&quot;persistTabs&quot;&gt;</span>
<a href="#l8.108"></a><span id="l8.108" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.109"></a><span id="l8.109" class="difflineplus">+          /**</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineplus">+           * Persist the state of all tab modes implementing persistTab methods</span>
<a href="#l8.111"></a><span id="l8.111" class="difflineplus">+           *  to a JSON-serializable object representation and return it.  Call</span>
<a href="#l8.112"></a><span id="l8.112" class="difflineplus">+           *  restoreTabs with the result to restore the tab state.</span>
<a href="#l8.113"></a><span id="l8.113" class="difflineplus">+           * Calling this method should have no side effects; tabs will not be</span>
<a href="#l8.114"></a><span id="l8.114" class="difflineplus">+           *  closed, displays will not change, etc.  This means the method is</span>
<a href="#l8.115"></a><span id="l8.115" class="difflineplus">+           *  safe to use in an auto-save style so that if we crash we can</span>
<a href="#l8.116"></a><span id="l8.116" class="difflineplus">+           *  restore the (approximate) state at the time of the crash.</span>
<a href="#l8.117"></a><span id="l8.117" class="difflineplus">+           *</span>
<a href="#l8.118"></a><span id="l8.118" class="difflineplus">+           * @return {Object} The persisted tab states.</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineplus">+           */</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+          let state = {</span>
<a href="#l8.121"></a><span id="l8.121" class="difflineplus">+            // Explicitly specify a revision so we don't wish we had later.</span>
<a href="#l8.122"></a><span id="l8.122" class="difflineplus">+            rev: 0,</span>
<a href="#l8.123"></a><span id="l8.123" class="difflineplus">+            // If our currently selected tab gets persisted, we will update this</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineplus">+            selectedIndex: null,</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineplus">+          };</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineplus">+          let tabs = state.tabs = [];</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineplus">+</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineplus">+          for each (let [iTab, tab] in Iterator(this.tabInfo)) {</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineplus">+            let persistFunc = tab.mode.persistTab ||</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+                              tab.mode.tabType.persistTab;</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+            if (!persistFunc)</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+              continue;</span>
<a href="#l8.133"></a><span id="l8.133" class="difflineplus">+            let tabState = persistFunc.call(tab.mode.tabType, tab);</span>
<a href="#l8.134"></a><span id="l8.134" class="difflineplus">+            // If there is a non-null tab-state, then persisting succeeded and</span>
<a href="#l8.135"></a><span id="l8.135" class="difflineplus">+            //  we should store it.  We store the tab's persisted state in its</span>
<a href="#l8.136"></a><span id="l8.136" class="difflineplus">+            //  own distinct object rather than mixing things up in a dictionary</span>
<a href="#l8.137"></a><span id="l8.137" class="difflineplus">+            //  to avoid bugs and because we may eventually let extensions store</span>
<a href="#l8.138"></a><span id="l8.138" class="difflineplus">+            //  per-tab information in the persisted state.</span>
<a href="#l8.139"></a><span id="l8.139" class="difflineplus">+            if (tabState != null) {</span>
<a href="#l8.140"></a><span id="l8.140" class="difflineplus">+              tabs.push({</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineplus">+                mode: tab.mode.name,</span>
<a href="#l8.142"></a><span id="l8.142" class="difflineplus">+                state: tabState</span>
<a href="#l8.143"></a><span id="l8.143" class="difflineplus">+              });</span>
<a href="#l8.144"></a><span id="l8.144" class="difflineplus">+              // Mark this persisted tab as selected</span>
<a href="#l8.145"></a><span id="l8.145" class="difflineplus">+              if (iTab == this.tabContainer.selectedIndex)</span>
<a href="#l8.146"></a><span id="l8.146" class="difflineplus">+                state.selectedIndex = tabs.length - 1;</span>
<a href="#l8.147"></a><span id="l8.147" class="difflineplus">+            }</span>
<a href="#l8.148"></a><span id="l8.148" class="difflineplus">+          }</span>
<a href="#l8.149"></a><span id="l8.149" class="difflineplus">+</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineplus">+          return state;</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l8.152"></a><span id="l8.152" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l8.153"></a><span id="l8.153" class="difflineplus">+      &lt;method name=&quot;restoreTabs&quot;&gt;</span>
<a href="#l8.154"></a><span id="l8.154" class="difflineplus">+        &lt;parameter name=&quot;aPersistedState&quot;/&gt;</span>
<a href="#l8.155"></a><span id="l8.155" class="difflineplus">+        &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineplus">+          /**</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+           * Attempts to restore tabs persisted from a prior call to</span>
<a href="#l8.158"></a><span id="l8.158" class="difflineplus">+           *  |persistTabs|.  This is currently a synchronous operation, but in</span>
<a href="#l8.159"></a><span id="l8.159" class="difflineplus">+           *  the future this may kick off an asynchronous mechanism to restore</span>
<a href="#l8.160"></a><span id="l8.160" class="difflineplus">+           *  the tabs one-by-one.</span>
<a href="#l8.161"></a><span id="l8.161" class="difflineplus">+           */</span>
<a href="#l8.162"></a><span id="l8.162" class="difflineplus">+          let tabs = aPersistedState.tabs;</span>
<a href="#l8.163"></a><span id="l8.163" class="difflineplus">+          let indexToSelect = null;</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineplus">+          for each (let [iTab, tabState] in Iterator(tabs)) {</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+            // if we no longer know about the mode, we can't restore the tab</span>
<a href="#l8.166"></a><span id="l8.166" class="difflineplus">+            if (!(tabState.mode in this.tabModes))</span>
<a href="#l8.167"></a><span id="l8.167" class="difflineplus">+              continue;</span>
<a href="#l8.168"></a><span id="l8.168" class="difflineplus">+</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineplus">+            let mode = this.tabModes[tabState.mode];</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+            let restoreFunc = mode.restoreTab || mode.tabType.restoreTab;</span>
<a href="#l8.171"></a><span id="l8.171" class="difflineplus">+            if (!restoreFunc)</span>
<a href="#l8.172"></a><span id="l8.172" class="difflineplus">+              continue;</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+</span>
<a href="#l8.174"></a><span id="l8.174" class="difflineplus">+            restoreFunc.call(mode.tabType, this, tabState.state);</span>
<a href="#l8.175"></a><span id="l8.175" class="difflineplus">+</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineplus">+            // If this persisted tab was the selected one, then mark the newest</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+            //  tab as the guy to select.</span>
<a href="#l8.178"></a><span id="l8.178" class="difflineplus">+            if (iTab == aPersistedState.selectedIndex)</span>
<a href="#l8.179"></a><span id="l8.179" class="difflineplus">+              indexToSelect = this.tabInfo.length - 1;</span>
<a href="#l8.180"></a><span id="l8.180" class="difflineplus">+          }</span>
<a href="#l8.181"></a><span id="l8.181" class="difflineplus">+          if (indexToSelect != null)</span>
<a href="#l8.182"></a><span id="l8.182" class="difflineplus">+            this.tabContainer.selectedIndex = indexToSelect;</span>
<a href="#l8.183"></a><span id="l8.183" class="difflineplus">+        ]]&gt;&lt;/body&gt;</span>
<a href="#l8.184"></a><span id="l8.184" class="difflineplus">+      &lt;/method&gt;</span>
<a href="#l8.185"></a><span id="l8.185" class="difflineplus">+</span>
<a href="#l8.186"></a><span id="l8.186">       &lt;!-- getBrowserForSelectedTab is required as some toolkit functions</span>
<a href="#l8.187"></a><span id="l8.187">            require a getBrowser() function. --&gt;</span>
<a href="#l8.188"></a><span id="l8.188">       &lt;method name=&quot;getBrowserForSelectedTab&quot;&gt;</span>
<a href="#l8.189"></a><span id="l8.189">         &lt;body&gt;&lt;![CDATA[</span>
<a href="#l8.190"></a><span id="l8.190">           if (!this.currentTabInfo)</span>
<a href="#l8.191"></a><span id="l8.191">             this.currentTabInfo = this.tabInfo[0];</span>
<a href="#l8.192"></a><span id="l8.192"> </span>
<a href="#l8.193"></a><span id="l8.193">           let tab = this.currentTabInfo;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mail/base/content/widgetglue.js</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mail/base/content/widgetglue.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -1,72 +1,71 @@</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineminus">-# -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-# ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">-# Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">-#</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">-# The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-# 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">-# the License. You may obtain a copy of the License at</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-# http://www.mozilla.org/MPL/</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-#</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-# Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-# WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-# for the specific language governing rights and limitations under the</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-# License.</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-#</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-# The Original Code is Mozilla Communicator client code, released</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-# March 31, 1998.</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-#</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-# The Initial Developer of the Original Code is</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-# Netscape Communications Corporation.</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-# Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-# the Initial Developer. All Rights Reserved.</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-#</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-# Contributor(s):</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-#   Jan Varga (varga@nixcorp.com)</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-#   Hkan Waara (hwaara@chello.se)</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-#</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-# Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-# either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-# the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-# in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-# of those above. If you wish to allow use of your version of this file only</span>
<a href="#l9.35"></a><span id="l9.35" class="difflineminus">-# under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l9.36"></a><span id="l9.36" class="difflineminus">-# use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.37"></a><span id="l9.37" class="difflineminus">-# decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineminus">-# and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineminus">-# the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineminus">-# the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineminus">-#</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineminus">-# ***** END LICENSE BLOCK *****</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+/*  -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*-</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+ *  ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+ *  Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+ * </span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+ *  The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+ *  1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+ *  the License. You may obtain a copy of the License at</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+ *  http://www.mozilla.org/MPL/</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+ * </span>
<a href="#l9.52"></a><span id="l9.52" class="difflineplus">+ *  Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l9.53"></a><span id="l9.53" class="difflineplus">+ *  WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l9.54"></a><span id="l9.54" class="difflineplus">+ *  for the specific language governing rights and limitations under the</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineplus">+ *  License.</span>
<a href="#l9.56"></a><span id="l9.56" class="difflineplus">+ * </span>
<a href="#l9.57"></a><span id="l9.57" class="difflineplus">+ *  The Original Code is Mozilla Communicator client code, released</span>
<a href="#l9.58"></a><span id="l9.58" class="difflineplus">+ *  March 31, 1998.</span>
<a href="#l9.59"></a><span id="l9.59" class="difflineplus">+ * </span>
<a href="#l9.60"></a><span id="l9.60" class="difflineplus">+ *  The Initial Developer of the Original Code is</span>
<a href="#l9.61"></a><span id="l9.61" class="difflineplus">+ *  Netscape Communications Corporation.</span>
<a href="#l9.62"></a><span id="l9.62" class="difflineplus">+ *  Portions created by the Initial Developer are Copyright (C) 1998-1999</span>
<a href="#l9.63"></a><span id="l9.63" class="difflineplus">+ *  the Initial Developer. All Rights Reserved.</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineplus">+ * </span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+ *  Contributor(s):</span>
<a href="#l9.66"></a><span id="l9.66" class="difflineplus">+ *    Jan Varga (varga@nixcorp.com)</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineplus">+ *    Hkan Waara (hwaara@chello.se)</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+ * </span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+ *  Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+ *  either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+ *  the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+ *  in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+ *  of those above. If you wish to allow use of your version of this file only</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+ *  under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+ *  use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+ *  decision by deleting the provisions above and replace them with the notice</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+ *  and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+ *  the provisions above, a recipient may use your version of this file under</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+ *  the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+ * </span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+ *  ***** END LICENSE BLOCK ***** */</span>
<a href="#l9.82"></a><span id="l9.82"> </span>
<a href="#l9.83"></a><span id="l9.83"> /*</span>
<a href="#l9.84"></a><span id="l9.84">  * widget-specific wrapper glue. There should be one function for every</span>
<a href="#l9.85"></a><span id="l9.85">  * widget/menu item, which gets some context (like the current selection)</span>
<a href="#l9.86"></a><span id="l9.86">  * and then calls a function/command in commandglue</span>
<a href="#l9.87"></a><span id="l9.87">  */</span>
<a href="#l9.88"></a><span id="l9.88"> </span>
<a href="#l9.89"></a><span id="l9.89"> //The eventual goal is for this file to go away and its contents to be brought into</span>
<a href="#l9.90"></a><span id="l9.90"> //mailWindowOverlay.js.  This is currently being done.</span>
<a href="#l9.91"></a><span id="l9.91"> </span>
<a href="#l9.92"></a><span id="l9.92"> function MsgToggleMessagePane()</span>
<a href="#l9.93"></a><span id="l9.93"> {</span>
<a href="#l9.94"></a><span id="l9.94">   // Bail without doing anything if we are not a folder tab.</span>
<a href="#l9.95"></a><span id="l9.95">   let currentTabInfo = document.getElementById(&quot;tabmail&quot;).currentTabInfo;</span>
<a href="#l9.96"></a><span id="l9.96">   if (currentTabInfo.mode.name != &quot;folder&quot;)</span>
<a href="#l9.97"></a><span id="l9.97">     return;</span>
<a href="#l9.98"></a><span id="l9.98" class="difflineminus">-</span>
<a href="#l9.99"></a><span id="l9.99">   var splitter = document.getElementById(&quot;threadpane-splitter&quot;);</span>
<a href="#l9.100"></a><span id="l9.100">   var state = splitter.getAttribute(&quot;state&quot;);</span>
<a href="#l9.101"></a><span id="l9.101">   if (state == &quot;collapsed&quot;)</span>
<a href="#l9.102"></a><span id="l9.102" class="difflineminus">-    splitter.setAttribute(&quot;state&quot;, null);</span>
<a href="#l9.103"></a><span id="l9.103" class="difflineplus">+    splitter.setAttribute(&quot;state&quot;, &quot;open&quot;);</span>
<a href="#l9.104"></a><span id="l9.104">   else</span>
<a href="#l9.105"></a><span id="l9.105">     splitter.setAttribute(&quot;state&quot;, &quot;collapsed&quot;)</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineminus">-</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineminus">-   ChangeMessagePaneVisibility(IsMessagePaneCollapsed());</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+  ChangeMessagePaneVisibility(IsMessagePaneCollapsed());</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+  SetFocusThreadPaneIfNotOnMessagePane();</span>
<a href="#l9.110"></a><span id="l9.110"> }</span>
<a href="#l9.111"></a><span id="l9.111"> </span>
<a href="#l9.112"></a><span id="l9.112"> // Given a URI we would like to return corresponding message folder here.</span>
<a href="#l9.113"></a><span id="l9.113"> // An additonal input param which specifies whether or not to check folder</span>
<a href="#l9.114"></a><span id="l9.114"> // attributes (like if there exists a parent or is it a server) is also passed</span>
<a href="#l9.115"></a><span id="l9.115"> // to this routine. Qualifying against those checks would return an existing</span>
<a href="#l9.116"></a><span id="l9.116"> // folder. Callers who don't want to check those attributes will specify the</span>
<a href="#l9.117"></a><span id="l9.117"> // same and then this routine will simply return a msgfolder. This scenario</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mail/base/jar.mn</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mail/base/jar.mn</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -33,17 +33,17 @@ messenger.jar:</span>
<a href="#l10.4"></a><span id="l10.4">     content/messenger/mailWidgets.xml               (content/mailWidgets.xml)</span>
<a href="#l10.5"></a><span id="l10.5">     content/messenger/editContactOverlay.js         (content/editContactOverlay.js)</span>
<a href="#l10.6"></a><span id="l10.6"> *   content/messenger/editContactOverlay.xul        (content/editContactOverlay.xul)</span>
<a href="#l10.7"></a><span id="l10.7">     content/messenger/msgMail3PaneWindow.js         (content/msgMail3PaneWindow.js)</span>
<a href="#l10.8"></a><span id="l10.8">     content/messenger/mail3PaneWindowCommands.js    (content/mail3PaneWindowCommands.js)</span>
<a href="#l10.9"></a><span id="l10.9"> *   content/messenger/mailCommands.js               (content/mailCommands.js)</span>
<a href="#l10.10"></a><span id="l10.10"> *   content/messenger/mailCore.js                   (content/mailCore.js)</span>
<a href="#l10.11"></a><span id="l10.11">     content/messenger/commandglue.js                (content/commandglue.js)</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-*   content/messenger/widgetglue.js                 (content/widgetglue.js)</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    content/messenger/widgetglue.js                 (content/widgetglue.js)</span>
<a href="#l10.14"></a><span id="l10.14"> *   content/messenger/SearchDialog.xul              (content/SearchDialog.xul)</span>
<a href="#l10.15"></a><span id="l10.15">     content/messenger/SearchDialog.js               (content/SearchDialog.js)</span>
<a href="#l10.16"></a><span id="l10.16"> *   content/messenger/ABSearchDialog.xul            (content/ABSearchDialog.xul)</span>
<a href="#l10.17"></a><span id="l10.17"> *   content/messenger/ABSearchDialog.js             (content/ABSearchDialog.js)</span>
<a href="#l10.18"></a><span id="l10.18"> *   content/messenger/FilterListDialog.xul          (content/FilterListDialog.xul)</span>
<a href="#l10.19"></a><span id="l10.19"> *   content/messenger/FilterListDialog.js           (content/FilterListDialog.js)</span>
<a href="#l10.20"></a><span id="l10.20">     content/messenger/specialTabs.js                (content/specialTabs.js)</span>
<a href="#l10.21"></a><span id="l10.21"> *   content/messenger/subscribe.xul                 (content/subscribe.xul)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">new file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- /dev/null</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-message-pane-visibility.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -0,0 +1,329 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineplus">+ *   Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineplus">+ *</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+ *</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineplus">+ * License.</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineplus">+ *</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineplus">+ * The Original Code is Thunderbird Mail Client.</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineplus">+ *</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+ * Mozilla Messaging, Inc.</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2009</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineplus">+ *</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineplus">+ * Contributor(s):</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineplus">+ *   Andrew Sutherland &lt;asutherland@asutherland.org&gt;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineplus">+ *</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineplus">+ * either the GNU General Public License Version 2 or later (the &quot;GPL&quot;), or</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineplus">+ * the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+ *</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineplus">+/*</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+ * Test that the message pane collapses properly, stays collapsed amongst tab</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineplus">+ *  changes, and that persistence works (to a first approximation).</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineplus">+ */</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineplus">+</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineplus">+var MODULE_NAME = 'test-message-pane-visibility';</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineplus">+</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineplus">+var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineplus">+var MODULE_REQUIRES = ['folder-display-helpers', 'window-helpers'];</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineplus">+</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineplus">+var folder;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineplus">+</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineplus">+function setupModule(module) {</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineplus">+  let fdh = collector.getModule('folder-display-helpers');</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineplus">+  fdh.installInto(module);</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineplus">+  let wh = collector.getModule('window-helpers');</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineplus">+  wh.installInto(module);</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineplus">+</span>
<a href="#l11.60"></a><span id="l11.60" class="difflineplus">+  folder = create_folder(&quot;MessagePaneVisibility&quot;);</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineplus">+  make_new_sets_in_folder(folder, [{count: 3}]);</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+}</span>
<a href="#l11.63"></a><span id="l11.63" class="difflineplus">+</span>
<a href="#l11.64"></a><span id="l11.64" class="difflineplus">+/**</span>
<a href="#l11.65"></a><span id="l11.65" class="difflineplus">+ * When displaying a folder, assert that the message pane is visible and all the</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineplus">+ *  menus, splitters, etc. are set up right.</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+ */</span>
<a href="#l11.68"></a><span id="l11.68" class="difflineplus">+function assert_message_pane_visible(aThreadPaneIllegal) {</span>
<a href="#l11.69"></a><span id="l11.69" class="difflineplus">+  if (!mc.messageDisplay.visible)</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+    throw new Error(&quot;The message display does not think it is visible, but &quot; +</span>
<a href="#l11.71"></a><span id="l11.71" class="difflineplus">+                    &quot;it should!&quot;);</span>
<a href="#l11.72"></a><span id="l11.72" class="difflineplus">+</span>
<a href="#l11.73"></a><span id="l11.73" class="difflineplus">+  // - message pane should be visible</span>
<a href="#l11.74"></a><span id="l11.74" class="difflineplus">+  if (mc.e(&quot;messagepanebox&quot;).getAttribute(&quot;collapsed&quot;))</span>
<a href="#l11.75"></a><span id="l11.75" class="difflineplus">+    throw new Error(&quot;messagepanebox should not be collapsed!&quot;);</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineplus">+</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineplus">+  // if the thread pane is illegal, then the splitter should not be visible</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+  if (aThreadPaneIllegal) {</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+    if (mc.e(&quot;threadpane-splitter&quot;).getAttribute(&quot;collapsed&quot;) != &quot;true&quot;)</span>
<a href="#l11.80"></a><span id="l11.80" class="difflineplus">+      throw new Error(&quot;threadpane-splitter should be collapsed because the &quot; +</span>
<a href="#l11.81"></a><span id="l11.81" class="difflineplus">+                      &quot;thread pane is illegal&quot;);</span>
<a href="#l11.82"></a><span id="l11.82" class="difflineplus">+  }</span>
<a href="#l11.83"></a><span id="l11.83" class="difflineplus">+  else {</span>
<a href="#l11.84"></a><span id="l11.84" class="difflineplus">+    if (mc.e(&quot;threadpane-splitter&quot;).getAttribute(&quot;collapsed&quot;) == &quot;true&quot;)</span>
<a href="#l11.85"></a><span id="l11.85" class="difflineplus">+      throw new Error(&quot;threadpane-splitter should not be collapsed&quot;);</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineplus">+  }</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+</span>
<a href="#l11.88"></a><span id="l11.88" class="difflineplus">+  // - the menu item should be checked</span>
<a href="#l11.89"></a><span id="l11.89" class="difflineplus">+  // force the view menu to update.</span>
<a href="#l11.90"></a><span id="l11.90" class="difflineplus">+  mc.window.view_init();</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineplus">+  let paneMenuItem = mc.e(&quot;menu_showMessage&quot;);</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+  if (paneMenuItem.getAttribute(&quot;checked&quot;) != &quot;true&quot;)</span>
<a href="#l11.93"></a><span id="l11.93" class="difflineplus">+    throw new Error(&quot;The Message Pane menu item should be checked.&quot;);</span>
<a href="#l11.94"></a><span id="l11.94" class="difflineplus">+}</span>
<a href="#l11.95"></a><span id="l11.95" class="difflineplus">+</span>
<a href="#l11.96"></a><span id="l11.96" class="difflineplus">+/**</span>
<a href="#l11.97"></a><span id="l11.97" class="difflineplus">+ * When displaying a folder, assert that the message pane is hidden and all the</span>
<a href="#l11.98"></a><span id="l11.98" class="difflineplus">+ *  menus, splitters, etc. are set up right.</span>
<a href="#l11.99"></a><span id="l11.99" class="difflineplus">+ *</span>
<a href="#l11.100"></a><span id="l11.100" class="difflineplus">+ * @param aMessagePaneIllegal Is the pane illegal to display at this time?  This</span>
<a href="#l11.101"></a><span id="l11.101" class="difflineplus">+ *     impacts whether the splitter should be visible, menu items should be</span>
<a href="#l11.102"></a><span id="l11.102" class="difflineplus">+ *     visible, etc.</span>
<a href="#l11.103"></a><span id="l11.103" class="difflineplus">+ */</span>
<a href="#l11.104"></a><span id="l11.104" class="difflineplus">+function assert_message_pane_hidden(aMessagePaneIllegal) {</span>
<a href="#l11.105"></a><span id="l11.105" class="difflineplus">+  // check messageDisplay.visible if we are not showing account central</span>
<a href="#l11.106"></a><span id="l11.106" class="difflineplus">+  if (!mc.folderDisplay.isAccountCentralDisplayed &amp;&amp; mc.messageDisplay.visible)</span>
<a href="#l11.107"></a><span id="l11.107" class="difflineplus">+    throw new Error(&quot;The message display thinks it is visible, but it should &quot; +</span>
<a href="#l11.108"></a><span id="l11.108" class="difflineplus">+                    &quot;not!&quot;);</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineplus">+</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+  if (mc.e(&quot;messagepanebox&quot;).getAttribute(&quot;collapsed&quot;) != &quot;true&quot;)</span>
<a href="#l11.111"></a><span id="l11.111" class="difflineplus">+    throw new Error(&quot;messagepanebox should be collapsed!&quot;);</span>
<a href="#l11.112"></a><span id="l11.112" class="difflineplus">+</span>
<a href="#l11.113"></a><span id="l11.113" class="difflineplus">+  // force the view menu to update.</span>
<a href="#l11.114"></a><span id="l11.114" class="difflineplus">+  mc.window.view_init();</span>
<a href="#l11.115"></a><span id="l11.115" class="difflineplus">+  let paneMenuItem = mc.e(&quot;menu_showMessage&quot;);</span>
<a href="#l11.116"></a><span id="l11.116" class="difflineplus">+  if (aMessagePaneIllegal) {</span>
<a href="#l11.117"></a><span id="l11.117" class="difflineplus">+    if (mc.e(&quot;threadpane-splitter&quot;).getAttribute(&quot;collapsed&quot;) != &quot;true&quot;)</span>
<a href="#l11.118"></a><span id="l11.118" class="difflineplus">+      throw new Error(&quot;threadpane-splitter should be collapsed because the &quot; +</span>
<a href="#l11.119"></a><span id="l11.119" class="difflineplus">+                      &quot;message pane is illegal.&quot;);</span>
<a href="#l11.120"></a><span id="l11.120" class="difflineplus">+    if (paneMenuItem.getAttribute(&quot;disabled&quot;) != &quot;true&quot;)</span>
<a href="#l11.121"></a><span id="l11.121" class="difflineplus">+      throw new Error(&quot;The Message Pane menu item should be disabled.&quot;);</span>
<a href="#l11.122"></a><span id="l11.122" class="difflineplus">+  }</span>
<a href="#l11.123"></a><span id="l11.123" class="difflineplus">+  else {</span>
<a href="#l11.124"></a><span id="l11.124" class="difflineplus">+    if (mc.e(&quot;threadpane-splitter&quot;).getAttribute(&quot;collapsed&quot;))</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineplus">+      throw new Error(&quot;threadpane-splitter should not be collapsed; the &quot; +</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+                      &quot;message pane is legal.&quot;);</span>
<a href="#l11.127"></a><span id="l11.127" class="difflineplus">+    if (paneMenuItem.getAttribute(&quot;checked&quot;) == &quot;true&quot;)</span>
<a href="#l11.128"></a><span id="l11.128" class="difflineplus">+      throw new Error(&quot;The Message Pane menu item should not be checked.&quot;);</span>
<a href="#l11.129"></a><span id="l11.129" class="difflineplus">+  }</span>
<a href="#l11.130"></a><span id="l11.130" class="difflineplus">+}</span>
<a href="#l11.131"></a><span id="l11.131" class="difflineplus">+</span>
<a href="#l11.132"></a><span id="l11.132" class="difflineplus">+function toggle_message_pane() {</span>
<a href="#l11.133"></a><span id="l11.133" class="difflineplus">+  mc.keypress(null, &quot;VK_F8&quot;, {});</span>
<a href="#l11.134"></a><span id="l11.134" class="difflineplus">+  wait_for_message_display_completion();</span>
<a href="#l11.135"></a><span id="l11.135" class="difflineplus">+}</span>
<a href="#l11.136"></a><span id="l11.136" class="difflineplus">+</span>
<a href="#l11.137"></a><span id="l11.137" class="difflineplus">+/**</span>
<a href="#l11.138"></a><span id="l11.138" class="difflineplus">+ * By default, the message pane should be visible.  Make sure that this state of</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+ *  affairs is correct in terms of menu options, splitters, etc.</span>
<a href="#l11.140"></a><span id="l11.140" class="difflineplus">+ */</span>
<a href="#l11.141"></a><span id="l11.141" class="difflineplus">+function test_message_pane_visible_state_is_right() {</span>
<a href="#l11.142"></a><span id="l11.142" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l11.143"></a><span id="l11.143" class="difflineplus">+  assert_message_pane_visible();</span>
<a href="#l11.144"></a><span id="l11.144" class="difflineplus">+}</span>
<a href="#l11.145"></a><span id="l11.145" class="difflineplus">+</span>
<a href="#l11.146"></a><span id="l11.146" class="difflineplus">+/**</span>
<a href="#l11.147"></a><span id="l11.147" class="difflineplus">+ * Make sure the account central page does not have the mesage pane splitter</span>
<a href="#l11.148"></a><span id="l11.148" class="difflineplus">+ *  visible.  This should go elsewhere once we have more tests involving</span>
<a href="#l11.149"></a><span id="l11.149" class="difflineplus">+ *  account central.  (Layout tests?)</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineplus">+ */</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+function test_account_central_has_no_splitter() {</span>
<a href="#l11.152"></a><span id="l11.152" class="difflineplus">+  be_in_folder(folder.rootFolder);</span>
<a href="#l11.153"></a><span id="l11.153" class="difflineplus">+  assert_message_pane_hidden(true);</span>
<a href="#l11.154"></a><span id="l11.154" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l11.155"></a><span id="l11.155" class="difflineplus">+}</span>
<a href="#l11.156"></a><span id="l11.156" class="difflineplus">+</span>
<a href="#l11.157"></a><span id="l11.157" class="difflineplus">+/**</span>
<a href="#l11.158"></a><span id="l11.158" class="difflineplus">+ * Toggle the message off.</span>
<a href="#l11.159"></a><span id="l11.159" class="difflineplus">+ */</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineplus">+function test_toggle_message_pane_off() {</span>
<a href="#l11.161"></a><span id="l11.161" class="difflineplus">+  toggle_message_pane();</span>
<a href="#l11.162"></a><span id="l11.162" class="difflineplus">+  assert_message_pane_hidden();</span>
<a href="#l11.163"></a><span id="l11.163" class="difflineplus">+}</span>
<a href="#l11.164"></a><span id="l11.164" class="difflineplus">+</span>
<a href="#l11.165"></a><span id="l11.165" class="difflineplus">+/**</span>
<a href="#l11.166"></a><span id="l11.166" class="difflineplus">+ * Toggle the message pane on.</span>
<a href="#l11.167"></a><span id="l11.167" class="difflineplus">+ */</span>
<a href="#l11.168"></a><span id="l11.168" class="difflineplus">+function test_toggle_message_pane_on() {</span>
<a href="#l11.169"></a><span id="l11.169" class="difflineplus">+  toggle_message_pane();</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+  assert_message_pane_visible();</span>
<a href="#l11.171"></a><span id="l11.171" class="difflineplus">+}</span>
<a href="#l11.172"></a><span id="l11.172" class="difflineplus">+</span>
<a href="#l11.173"></a><span id="l11.173" class="difflineplus">+/**</span>
<a href="#l11.174"></a><span id="l11.174" class="difflineplus">+ * Make sure that the message tab isn't broken by being invoked from a folder tab</span>
<a href="#l11.175"></a><span id="l11.175" class="difflineplus">+ *  with a collapsed message pane.</span>
<a href="#l11.176"></a><span id="l11.176" class="difflineplus">+ */</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineplus">+function test_collapsed_message_pane_does_not_break_message_tab() {</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+</span>
<a href="#l11.179"></a><span id="l11.179" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l11.180"></a><span id="l11.180" class="difflineplus">+</span>
<a href="#l11.181"></a><span id="l11.181" class="difflineplus">+  // - toggle message pane off</span>
<a href="#l11.182"></a><span id="l11.182" class="difflineplus">+  toggle_message_pane();</span>
<a href="#l11.183"></a><span id="l11.183" class="difflineplus">+  assert_message_pane_hidden();</span>
<a href="#l11.184"></a><span id="l11.184" class="difflineplus">+</span>
<a href="#l11.185"></a><span id="l11.185" class="difflineplus">+  // - open message tab, make sure the message pane is visible</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineplus">+  select_click_row(0);</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+  let tabMessage = open_selected_message_in_new_tab();</span>
<a href="#l11.188"></a><span id="l11.188" class="difflineplus">+  assert_message_pane_visible(true);</span>
<a href="#l11.189"></a><span id="l11.189" class="difflineplus">+</span>
<a href="#l11.190"></a><span id="l11.190" class="difflineplus">+  // - close the tab, sanity check the transition was okay</span>
<a href="#l11.191"></a><span id="l11.191" class="difflineplus">+  close_tab(tabMessage);</span>
<a href="#l11.192"></a><span id="l11.192" class="difflineplus">+  assert_message_pane_hidden();</span>
<a href="#l11.193"></a><span id="l11.193" class="difflineplus">+</span>
<a href="#l11.194"></a><span id="l11.194" class="difflineplus">+  // - restore the state...</span>
<a href="#l11.195"></a><span id="l11.195" class="difflineplus">+  toggle_message_pane();</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineplus">+}</span>
<a href="#l11.197"></a><span id="l11.197" class="difflineplus">+</span>
<a href="#l11.198"></a><span id="l11.198" class="difflineplus">+/**</span>
<a href="#l11.199"></a><span id="l11.199" class="difflineplus">+ * Make sure that switching to message tabs or folder pane tabs with a different</span>
<a href="#l11.200"></a><span id="l11.200" class="difflineplus">+ *  message pane state does not break.  This test should cover all transition</span>
<a href="#l11.201"></a><span id="l11.201" class="difflineplus">+ *  states.</span>
<a href="#l11.202"></a><span id="l11.202" class="difflineplus">+ */</span>
<a href="#l11.203"></a><span id="l11.203" class="difflineplus">+function test_message_pane_is_sticky() {</span>
<a href="#l11.204"></a><span id="l11.204" class="difflineplus">+  let tabFolderA = be_in_folder(folder);</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineplus">+  assert_message_pane_visible();</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+</span>
<a href="#l11.207"></a><span id="l11.207" class="difflineplus">+  // [folder+ =&gt; (new) message]</span>
<a href="#l11.208"></a><span id="l11.208" class="difflineplus">+  select_click_row(0);</span>
<a href="#l11.209"></a><span id="l11.209" class="difflineplus">+  let tabMessage = open_selected_message_in_new_tab();</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineplus">+  assert_message_pane_visible(true);</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+</span>
<a href="#l11.212"></a><span id="l11.212" class="difflineplus">+  // [message =&gt; folder+]</span>
<a href="#l11.213"></a><span id="l11.213" class="difflineplus">+  switch_tab(tabFolderA);</span>
<a href="#l11.214"></a><span id="l11.214" class="difflineplus">+  assert_message_pane_visible();</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineplus">+</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+  // [folder+ =&gt; (new) folder+]</span>
<a href="#l11.217"></a><span id="l11.217" class="difflineplus">+  let tabFolderB = open_folder_in_new_tab(folder);</span>
<a href="#l11.218"></a><span id="l11.218" class="difflineplus">+  assert_message_pane_visible();</span>
<a href="#l11.219"></a><span id="l11.219" class="difflineplus">+</span>
<a href="#l11.220"></a><span id="l11.220" class="difflineplus">+  // [folder pane toggle + =&gt; -]</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineplus">+  toggle_message_pane();</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineplus">+  assert_message_pane_hidden();</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+  // [folder- =&gt; folder+]</span>
<a href="#l11.225"></a><span id="l11.225" class="difflineplus">+  switch_tab(tabFolderA);</span>
<a href="#l11.226"></a><span id="l11.226" class="difflineplus">+  assert_message_pane_visible();</span>
<a href="#l11.227"></a><span id="l11.227" class="difflineplus">+</span>
<a href="#l11.228"></a><span id="l11.228" class="difflineplus">+  // (redundant) [ folder pane toggle + =&gt; -]</span>
<a href="#l11.229"></a><span id="l11.229" class="difflineplus">+  toggle_message_pane();</span>
<a href="#l11.230"></a><span id="l11.230" class="difflineplus">+  assert_message_pane_hidden();</span>
<a href="#l11.231"></a><span id="l11.231" class="difflineplus">+</span>
<a href="#l11.232"></a><span id="l11.232" class="difflineplus">+  // [folder- =&gt; message]</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineplus">+  switch_tab(tabMessage);</span>
<a href="#l11.234"></a><span id="l11.234" class="difflineplus">+  assert_message_pane_visible(true);</span>
<a href="#l11.235"></a><span id="l11.235" class="difflineplus">+</span>
<a href="#l11.236"></a><span id="l11.236" class="difflineplus">+  // [message =&gt; folder-]</span>
<a href="#l11.237"></a><span id="l11.237" class="difflineplus">+  close_tab(tabMessage);</span>
<a href="#l11.238"></a><span id="l11.238" class="difflineplus">+  assert_message_pane_hidden();</span>
<a href="#l11.239"></a><span id="l11.239" class="difflineplus">+</span>
<a href="#l11.240"></a><span id="l11.240" class="difflineplus">+  // [folder- =&gt; (new) folder-]</span>
<a href="#l11.241"></a><span id="l11.241" class="difflineplus">+  // (we are testing inheritance here)</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineplus">+  let tabFolderC = open_folder_in_new_tab(folder);</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+  assert_message_pane_hidden();</span>
<a href="#l11.244"></a><span id="l11.244" class="difflineplus">+</span>
<a href="#l11.245"></a><span id="l11.245" class="difflineplus">+  // [folder- =&gt; folder-]</span>
<a href="#l11.246"></a><span id="l11.246" class="difflineplus">+  close_tab(tabFolderC);</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineplus">+  // the tab we are on now doesn't matter, so we don't care</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+  assert_message_pane_hidden();</span>
<a href="#l11.249"></a><span id="l11.249" class="difflineplus">+  switch_tab(tabFolderB);</span>
<a href="#l11.250"></a><span id="l11.250" class="difflineplus">+</span>
<a href="#l11.251"></a><span id="l11.251" class="difflineplus">+  // [ folder pane toggle - =&gt; + ]</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineplus">+  toggle_message_pane();</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+  assert_message_pane_visible();</span>
<a href="#l11.254"></a><span id="l11.254" class="difflineplus">+</span>
<a href="#l11.255"></a><span id="l11.255" class="difflineplus">+  // [folder+ =&gt; folder-]</span>
<a href="#l11.256"></a><span id="l11.256" class="difflineplus">+  close_tab(tabFolderB);</span>
<a href="#l11.257"></a><span id="l11.257" class="difflineplus">+  assert_message_pane_hidden();</span>
<a href="#l11.258"></a><span id="l11.258" class="difflineplus">+</span>
<a href="#l11.259"></a><span id="l11.259" class="difflineplus">+  // (redundant) [ folder pane toggle - =&gt; + ]</span>
<a href="#l11.260"></a><span id="l11.260" class="difflineplus">+  toggle_message_pane();</span>
<a href="#l11.261"></a><span id="l11.261" class="difflineplus">+  assert_message_pane_visible();</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineplus">+}</span>
<a href="#l11.263"></a><span id="l11.263" class="difflineplus">+</span>
<a href="#l11.264"></a><span id="l11.264" class="difflineplus">+/**</span>
<a href="#l11.265"></a><span id="l11.265" class="difflineplus">+ * Test that if we serialize and restore the tabs that the message pane is in</span>
<a href="#l11.266"></a><span id="l11.266" class="difflineplus">+ *  the expected collapsed/non-collapsed state.  Because of the special &quot;first</span>
<a href="#l11.267"></a><span id="l11.267" class="difflineplus">+ *  tab&quot; situation, we need to do this twice to test each case for the first</span>
<a href="#l11.268"></a><span id="l11.268" class="difflineplus">+ *  tab.  For additional thoroughness we also flip the state we have the other</span>
<a href="#l11.269"></a><span id="l11.269" class="difflineplus">+ *  tabs be in.</span>
<a href="#l11.270"></a><span id="l11.270" class="difflineplus">+ */</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineplus">+function test_message_pane_persistence_generally_works() {</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineplus">+  be_in_folder(folder);</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineplus">+  // helper to open tabs with the message pane in the desired states (1 for</span>
<a href="#l11.275"></a><span id="l11.275" class="difflineplus">+  //  visible, 0 for hidden)</span>
<a href="#l11.276"></a><span id="l11.276" class="difflineplus">+  function openTabs(aConfig) {</span>
<a href="#l11.277"></a><span id="l11.277" class="difflineplus">+    let curState;</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineplus">+    for (let [iTab, messagePaneVisible] in Iterator(aConfig)) {</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineplus">+      if (iTab == 0) {</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineplus">+        curState = messagePaneVisible;</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineplus">+      }</span>
<a href="#l11.282"></a><span id="l11.282" class="difflineplus">+      else {</span>
<a href="#l11.283"></a><span id="l11.283" class="difflineplus">+        open_folder_in_new_tab(folder);</span>
<a href="#l11.284"></a><span id="l11.284" class="difflineplus">+        if (curState != messagePaneVisible) {</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineplus">+          toggle_message_pane();</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineplus">+          curState = messagePaneVisible;</span>
<a href="#l11.287"></a><span id="l11.287" class="difflineplus">+        }</span>
<a href="#l11.288"></a><span id="l11.288" class="difflineplus">+      }</span>
<a href="#l11.289"></a><span id="l11.289" class="difflineplus">+    }</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineplus">+  }</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineplus">+</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineplus">+  // close everything but the first tab.</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineplus">+  function closeTabs() {</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineplus">+    while (mc.tabmail.tabInfo.length &gt; 1)</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineplus">+      mc.tabmail.closeTab(1);</span>
<a href="#l11.296"></a><span id="l11.296" class="difflineplus">+  }</span>
<a href="#l11.297"></a><span id="l11.297" class="difflineplus">+</span>
<a href="#l11.298"></a><span id="l11.298" class="difflineplus">+  function verifyTabs(aConfig) {</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineplus">+    for (let [iTab, messagePaneVisible] in Iterator(aConfig)) {</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineplus">+      switch_tab(iTab);</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineplus">+      dump(&quot; checking tab: &quot; + iTab + &quot;\n&quot;);</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineplus">+      if (messagePaneVisible)</span>
<a href="#l11.303"></a><span id="l11.303" class="difflineplus">+        assert_message_pane_visible();</span>
<a href="#l11.304"></a><span id="l11.304" class="difflineplus">+      else</span>
<a href="#l11.305"></a><span id="l11.305" class="difflineplus">+        assert_message_pane_hidden();</span>
<a href="#l11.306"></a><span id="l11.306" class="difflineplus">+    }</span>
<a href="#l11.307"></a><span id="l11.307" class="difflineplus">+  }</span>
<a href="#l11.308"></a><span id="l11.308" class="difflineplus">+</span>
<a href="#l11.309"></a><span id="l11.309" class="difflineplus">+  let configs = [</span>
<a href="#l11.310"></a><span id="l11.310" class="difflineplus">+    // 1st time: [+ - - + +]</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineplus">+    [1, 0, 0, 1, 1],</span>
<a href="#l11.312"></a><span id="l11.312" class="difflineplus">+    // 2nd time: [- + + - -]</span>
<a href="#l11.313"></a><span id="l11.313" class="difflineplus">+    [0, 1, 1, 0, 0]</span>
<a href="#l11.314"></a><span id="l11.314" class="difflineplus">+  ];</span>
<a href="#l11.315"></a><span id="l11.315" class="difflineplus">+  for each (let [, config] in Iterator(configs)) {</span>
<a href="#l11.316"></a><span id="l11.316" class="difflineplus">+    openTabs(config);</span>
<a href="#l11.317"></a><span id="l11.317" class="difflineplus">+    verifyTabs(config); // make sure openTabs did its job right</span>
<a href="#l11.318"></a><span id="l11.318" class="difflineplus">+    let state = mc.tabmail.persistTabs();</span>
<a href="#l11.319"></a><span id="l11.319" class="difflineplus">+    closeTabs();</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineplus">+    // toggle the state for the current tab so we can be sure that it knows how</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineplus">+    //  to change things.</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineplus">+    toggle_message_pane();</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineplus">+    mc.tabmail.restoreTabs(state);</span>
<a href="#l11.324"></a><span id="l11.324" class="difflineplus">+    verifyTabs(config);</span>
<a href="#l11.325"></a><span id="l11.325" class="difflineplus">+    closeTabs();</span>
<a href="#l11.326"></a><span id="l11.326" class="difflineplus">+</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineplus">+    // toggle the first tab again.  This sets - properly for the second pass and</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineplus">+    //  restores it to + for when we are done.</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineplus">+    toggle_message_pane();</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineplus">+  }</span>
<a href="#l11.331"></a><span id="l11.331" class="difflineplus">+</span>
<a href="#l11.332"></a><span id="l11.332" class="difflineplus">+}</span>
<a href="#l11.333"></a><span id="l11.333" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-folder-display-helpers.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineat">@@ -360,33 +360,33 @@ function _normalize_view_index(aViewInde</span>
<a href="#l12.4"></a><span id="l12.4">  *</span>
<a href="#l12.5"></a><span id="l12.5">  * @return The message header selected.</span>
<a href="#l12.6"></a><span id="l12.6">  */</span>
<a href="#l12.7"></a><span id="l12.7"> function select_click_row(aViewIndex) {</span>
<a href="#l12.8"></a><span id="l12.8">   wait_for_message_display_completion();</span>
<a href="#l12.9"></a><span id="l12.9">   aViewIndex = _normalize_view_index(aViewIndex);</span>
<a href="#l12.10"></a><span id="l12.10">   // this should set the current index as well as setting the selection.</span>
<a href="#l12.11"></a><span id="l12.11">   mc.dbView.selection.select(aViewIndex);</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  wait_for_message_display_completion(mc, true);</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+  wait_for_message_display_completion(mc, mc.messageDisplay.visible);</span>
<a href="#l12.14"></a><span id="l12.14">   return mc.dbView.getMsgHdrAt(aViewIndex);</span>
<a href="#l12.15"></a><span id="l12.15"> }</span>
<a href="#l12.16"></a><span id="l12.16"> </span>
<a href="#l12.17"></a><span id="l12.17"> /**</span>
<a href="#l12.18"></a><span id="l12.18">  * Pretend we are toggling the thread specified by a row.</span>
<a href="#l12.19"></a><span id="l12.19">  *</span>
<a href="#l12.20"></a><span id="l12.20">  * @param aViewIndex If &gt;= 0, the view index provided, if &lt; 0, a reference to</span>
<a href="#l12.21"></a><span id="l12.21">  *     a view index counting from the last row in the tree.  -1 indicates the</span>
<a href="#l12.22"></a><span id="l12.22">  *     last message in the tree, -2 the second to last, etc.</span>
<a href="#l12.23"></a><span id="l12.23">  *</span>
<a href="#l12.24"></a><span id="l12.24">  */</span>
<a href="#l12.25"></a><span id="l12.25"> function toggle_thread_row(aViewIndex) {</span>
<a href="#l12.26"></a><span id="l12.26">   wait_for_message_display_completion();</span>
<a href="#l12.27"></a><span id="l12.27">   aViewIndex = _normalize_view_index(aViewIndex);</span>
<a href="#l12.28"></a><span id="l12.28">   mc.dbView.toggleOpenState(aViewIndex);</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineminus">-  wait_for_message_display_completion(mc, true);</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+  wait_for_message_display_completion(mc, mc.messageDisplay.visible);</span>
<a href="#l12.31"></a><span id="l12.31"> }</span>
<a href="#l12.32"></a><span id="l12.32"> </span>
<a href="#l12.33"></a><span id="l12.33"> </span>
<a href="#l12.34"></a><span id="l12.34"> /**</span>
<a href="#l12.35"></a><span id="l12.35">  * Pretend we are clicking on a row with our mouse with the control key pressed,</span>
<a href="#l12.36"></a><span id="l12.36">  *  resulting in the addition/removal of just that row to/from the selection.</span>
<a href="#l12.37"></a><span id="l12.37">  *</span>
<a href="#l12.38"></a><span id="l12.38">  * @param aViewIndex If &gt;= 0, the view index provided, if &lt; 0, a reference to</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

