<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 28309:825c14a55e122cec28b5e1f7d3ce83007d89f32c</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 825c14a55e122cec28b5e1f7d3ce83007d89f32c" />
<meta property="og:url" content="/comm-central/rev/825c14a55e122cec28b5e1f7d3ce83007d89f32c" />
<meta property="og:description" content="Bug 1599991 - Copy mozmill tests to mochitest; r=mkmelin" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 825c14a55e122cec28b5e1f7d3ce83007d89f32c 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/825c14a55e122cec28b5e1f7d3ce83007d89f32c">shortlog</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/825c14a55e122cec28b5e1f7d3ce83007d89f32c">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c">files</a> |
changeset |
<a href="/comm-central/raw-rev/825c14a55e122cec28b5e1f7d3ce83007d89f32c">raw</a>  | <a href="/comm-central/archive/825c14a55e122cec28b5e1f7d3ce83007d89f32c.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1599991">Bug 1599991</a> - Copy mozmill tests to mochitest; r=mkmelin
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 19 Nov 2019 11:52:39 +1300</td></tr>

<tr>
 <td>changeset 28309</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/825c14a55e122cec28b5e1f7d3ce83007d89f32c">825c14a55e122cec28b5e1f7d3ce83007d89f32c</a></td>
</tr>



<tr>
<td>parent 28308</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/c272f21f60cef07fc06efcbcabc5880014c90bce">c272f21f60cef07fc06efcbcabc5880014c90bce</a>
</td>
</tr>

<tr>
<td>child 28310</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9a2171cc93933aa39ee042e7379548c8eacbd9e2">9a2171cc93933aa39ee042e7379548c8eacbd9e2</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=825c14a55e122cec28b5e1f7d3ce83007d89f32c">16761</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Wed, 04 Dec 2019 08:16:39 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@825c14a55e12 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=825c14a55e122cec28b5e1f7d3ce83007d89f32c">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=825c14a55e122cec28b5e1f7d3ce83007d89f32c&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=825c14a55e122cec28b5e1f7d3ce83007d89f32c&newProject=comm-central&newRevision=825c14a55e122cec28b5e1f7d3ce83007d89f32c&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=825c14a55e122cec28b5e1f7d3ce83007d89f32c&newProject=comm-central&newRevision=825c14a55e122cec28b5e1f7d3ce83007d89f32c&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=825c14a55e122cec28b5e1f7d3ce83007d89f32c&newProject=comm-central&newRevision=825c14a55e122cec28b5e1f7d3ce83007d89f32c&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28mkmelin%29&revcount=50">mkmelin</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1599991">1599991</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1599991">Bug 1599991</a> - Copy mozmill tests to mochitest; r=mkmelin</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/base/content/gloda-autocomplete-input.js">mail/base/content/gloda-autocomplete-input.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/base/content/gloda-autocomplete-input.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/base/content/gloda-autocomplete-input.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/base/content/gloda-autocomplete-input.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/base/content/gloda-autocomplete-input.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/base/content/gloda-autocomplete-input.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/moz.build">mail/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/moz.build">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/moz.build">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/moz.build">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/moz.build">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser.ini">mail/test/browser/account/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_abWhitelist.js">mail/test/browser/account/browser_abWhitelist.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_abWhitelist.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_abWhitelist.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_abWhitelist.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_abWhitelist.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_abWhitelist.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_actions.js">mail/test/browser/account/browser_actions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_actions.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_actions.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_actions.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_actions.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_actions.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_archiveOptions.js">mail/test/browser/account/browser_archiveOptions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_archiveOptions.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_archiveOptions.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_archiveOptions.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_archiveOptions.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_archiveOptions.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_deletion.js">mail/test/browser/account/browser_deletion.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_deletion.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_deletion.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_deletion.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_deletion.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_deletion.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_mailAccountSetupWizard.js">mail/test/browser/account/browser_mailAccountSetupWizard.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_mailAccountSetupWizard.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_mailAccountSetupWizard.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_mailAccountSetupWizard.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_mailAccountSetupWizard.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_mailAccountSetupWizard.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_portSetting.js">mail/test/browser/account/browser_portSetting.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_portSetting.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_portSetting.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_portSetting.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_portSetting.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_portSetting.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_retestConfig.js">mail/test/browser/account/browser_retestConfig.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_retestConfig.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_retestConfig.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_retestConfig.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_retestConfig.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_retestConfig.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_settingsInfrastructure.js">mail/test/browser/account/browser_settingsInfrastructure.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_settingsInfrastructure.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_settingsInfrastructure.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_settingsInfrastructure.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_settingsInfrastructure.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_settingsInfrastructure.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_tree.js">mail/test/browser/account/browser_tree.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_tree.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_tree.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_tree.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_tree.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_tree.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_values.js">mail/test/browser/account/browser_values.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_values.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_values.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_values.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_values.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/browser_values.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/example.com">mail/test/browser/account/xml/example.com</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/example.com">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/example.com">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/example.com">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/example.com">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/example.com">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/example.com%5Eheaders%5E">mail/test/browser/account/xml/example.com^headers^</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/example.com%5Eheaders%5E">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/example.com%5Eheaders%5E">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/example.com%5Eheaders%5E">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/example.com%5Eheaders%5E">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/example.com%5Eheaders%5E">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/momo.invalid">mail/test/browser/account/xml/momo.invalid</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/momo.invalid">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/momo.invalid">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/momo.invalid">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/momo.invalid">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/momo.invalid">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/momo.invalid%5Eheaders%5E">mail/test/browser/account/xml/momo.invalid^headers^</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/momo.invalid%5Eheaders%5E">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/momo.invalid%5Eheaders%5E">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/momo.invalid%5Eheaders%5E">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/momo.invalid%5Eheaders%5E">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/account/xml/momo.invalid%5Eheaders%5E">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser.ini">mail/test/browser/addrbook/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_addressBook.js">mail/test/browser/addrbook/browser_addressBook.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_addressBook.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_addressBook.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_addressBook.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_addressBook.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_addressBook.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_addressBookPanes.js">mail/test/browser/addrbook/browser_addressBookPanes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_addressBookPanes.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_addressBookPanes.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_addressBookPanes.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_addressBookPanes.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_addressBookPanes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_updateMailingList.js">mail/test/browser/addrbook/browser_updateMailingList.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_updateMailingList.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_updateMailingList.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_updateMailingList.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_updateMailingList.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/addrbook/browser_updateMailingList.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser.ini">mail/test/browser/attachment/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachment.js">mail/test/browser/attachment/browser_attachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachment.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachment.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachment.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachment.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachment.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentEvents.js">mail/test/browser/attachment/browser_attachmentEvents.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentEvents.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentEvents.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentEvents.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentEvents.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentEvents.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentInPlainMsg.js">mail/test/browser/attachment/browser_attachmentInPlainMsg.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentInPlainMsg.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentInPlainMsg.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentInPlainMsg.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentInPlainMsg.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentInPlainMsg.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentMenus.js">mail/test/browser/attachment/browser_attachmentMenus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentMenus.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentMenus.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentMenus.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentMenus.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentMenus.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentSize.js">mail/test/browser/attachment/browser_attachmentSize.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentSize.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentSize.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentSize.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentSize.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/browser_attachmentSize.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/data/attachment.txt">mail/test/browser/attachment/data/attachment.txt</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/data/attachment.txt">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/data/attachment.txt">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/data/attachment.txt">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/data/attachment.txt">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/data/attachment.txt">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/data/bug1358565.eml">mail/test/browser/attachment/data/bug1358565.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/data/bug1358565.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/data/bug1358565.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/data/bug1358565.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/data/bug1358565.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/attachment/data/bug1358565.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser.ini">mail/test/browser/cloudfile/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_attachmentItem.js">mail/test/browser/cloudfile/browser_attachmentItem.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_attachmentItem.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_attachmentItem.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_attachmentItem.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_attachmentItem.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_attachmentItem.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_attachmentUrls.js">mail/test/browser/cloudfile/browser_attachmentUrls.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_attachmentUrls.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_attachmentUrls.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_attachmentUrls.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_attachmentUrls.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_attachmentUrls.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_manager.js">mail/test/browser/cloudfile/browser_manager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_manager.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_manager.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_manager.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_manager.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_manager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_notifications.js">mail/test/browser/cloudfile/browser_notifications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_notifications.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_notifications.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_notifications.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_notifications.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/browser_notifications.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile1">mail/test/browser/cloudfile/data/testFile1</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile1">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile1">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile1">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile1">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile1">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile2">mail/test/browser/cloudfile/data/testFile2</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile2">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile2">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile2">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile2">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile2">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile3">mail/test/browser/cloudfile/data/testFile3</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile3">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile3">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile3">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile3">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile3">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile4">mail/test/browser/cloudfile/data/testFile4</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile4">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile4">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile4">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile4">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/data/testFile4">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/head.js">mail/test/browser/cloudfile/head.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/head.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/head.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/head.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/head.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/head.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/html/settings-with-link.xhtml">mail/test/browser/cloudfile/html/settings-with-link.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/html/settings-with-link.xhtml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/html/settings-with-link.xhtml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/html/settings-with-link.xhtml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/html/settings-with-link.xhtml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cloudfile/html/settings-with-link.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser.ini">mail/test/browser/composition/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_addressWidgets.js">mail/test/browser/composition/browser_addressWidgets.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_addressWidgets.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_addressWidgets.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_addressWidgets.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_addressWidgets.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_addressWidgets.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_attachment.js">mail/test/browser/composition/browser_attachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_attachment.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_attachment.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_attachment.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_attachment.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_attachment.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_attachmentReminder.js">mail/test/browser/composition/browser_attachmentReminder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_attachmentReminder.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_attachmentReminder.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_attachmentReminder.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_attachmentReminder.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_attachmentReminder.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_base64Display.js">mail/test/browser/composition/browser_base64Display.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_base64Display.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_base64Display.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_base64Display.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_base64Display.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_base64Display.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_blockedContent.js">mail/test/browser/composition/browser_blockedContent.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_blockedContent.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_blockedContent.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_blockedContent.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_blockedContent.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_blockedContent.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_charsetEdit.js">mail/test/browser/composition/browser_charsetEdit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_charsetEdit.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_charsetEdit.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_charsetEdit.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_charsetEdit.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_charsetEdit.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_charsetUpgrade.js">mail/test/browser/composition/browser_charsetUpgrade.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_charsetUpgrade.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_charsetUpgrade.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_charsetUpgrade.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_charsetUpgrade.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_charsetUpgrade.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_cp932Display.js">mail/test/browser/composition/browser_cp932Display.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_cp932Display.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_cp932Display.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_cp932Display.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_cp932Display.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_cp932Display.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_draftIdentity.js">mail/test/browser/composition/browser_draftIdentity.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_draftIdentity.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_draftIdentity.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_draftIdentity.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_draftIdentity.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_draftIdentity.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_drafts.js">mail/test/browser/composition/browser_drafts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_drafts.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_drafts.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_drafts.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_drafts.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_drafts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_emlActions.js">mail/test/browser/composition/browser_emlActions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_emlActions.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_emlActions.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_emlActions.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_emlActions.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_emlActions.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_focus.js">mail/test/browser/composition/browser_focus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_focus.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_focus.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_focus.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_focus.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_focus.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardHeaders.js">mail/test/browser/composition/browser_forwardHeaders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardHeaders.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardHeaders.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardHeaders.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardHeaders.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardHeaders.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardRFC822Attach.js">mail/test/browser/composition/browser_forwardRFC822Attach.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardRFC822Attach.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardRFC822Attach.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardRFC822Attach.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardRFC822Attach.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardRFC822Attach.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardUTF8.js">mail/test/browser/composition/browser_forwardUTF8.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardUTF8.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardUTF8.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardUTF8.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardUTF8.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardUTF8.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardedContent.js">mail/test/browser/composition/browser_forwardedContent.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardedContent.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardedContent.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardedContent.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardedContent.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardedContent.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardedEmlActions.js">mail/test/browser/composition/browser_forwardedEmlActions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardedEmlActions.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardedEmlActions.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardedEmlActions.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardedEmlActions.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_forwardedEmlActions.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_imageDisplay.js">mail/test/browser/composition/browser_imageDisplay.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_imageDisplay.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_imageDisplay.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_imageDisplay.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_imageDisplay.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_imageDisplay.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_imageInsertionDialog.js">mail/test/browser/composition/browser_imageInsertionDialog.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_imageInsertionDialog.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_imageInsertionDialog.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_imageInsertionDialog.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_imageInsertionDialog.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_imageInsertionDialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_multipartRelated.js">mail/test/browser/composition/browser_multipartRelated.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_multipartRelated.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_multipartRelated.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_multipartRelated.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_multipartRelated.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_multipartRelated.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_newmsgComposeIdentity.js">mail/test/browser/composition/browser_newmsgComposeIdentity.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_newmsgComposeIdentity.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_newmsgComposeIdentity.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_newmsgComposeIdentity.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_newmsgComposeIdentity.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_newmsgComposeIdentity.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyAddresses.js">mail/test/browser/composition/browser_replyAddresses.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyAddresses.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyAddresses.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyAddresses.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyAddresses.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyAddresses.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyFormatFlowed.js">mail/test/browser/composition/browser_replyFormatFlowed.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyFormatFlowed.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyFormatFlowed.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyFormatFlowed.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyFormatFlowed.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyFormatFlowed.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyMultipartCharset.js">mail/test/browser/composition/browser_replyMultipartCharset.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyMultipartCharset.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyMultipartCharset.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyMultipartCharset.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyMultipartCharset.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replyMultipartCharset.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replySignature.js">mail/test/browser/composition/browser_replySignature.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replySignature.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replySignature.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replySignature.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replySignature.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_replySignature.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_saveChangesOnQuit.js">mail/test/browser/composition/browser_saveChangesOnQuit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_saveChangesOnQuit.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_saveChangesOnQuit.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_saveChangesOnQuit.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_saveChangesOnQuit.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_saveChangesOnQuit.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_sendButton.js">mail/test/browser/composition/browser_sendButton.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_sendButton.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_sendButton.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_sendButton.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_sendButton.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_sendButton.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_sendFormat.js">mail/test/browser/composition/browser_sendFormat.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_sendFormat.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_sendFormat.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_sendFormat.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_sendFormat.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_sendFormat.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_signatureInit.js">mail/test/browser/composition/browser_signatureInit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_signatureInit.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_signatureInit.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_signatureInit.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_signatureInit.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_signatureInit.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_signatureUpdating.js">mail/test/browser/composition/browser_signatureUpdating.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_signatureUpdating.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_signatureUpdating.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_signatureUpdating.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_signatureUpdating.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/browser_signatureUpdating.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/attachment.txt">mail/test/browser/composition/data/attachment.txt</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/attachment.txt">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/attachment.txt">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/attachment.txt">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/attachment.txt">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/attachment.txt">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/base64-encoded-msg.eml">mail/test/browser/composition/data/base64-encoded-msg.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/base64-encoded-msg.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/base64-encoded-msg.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/base64-encoded-msg.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/base64-encoded-msg.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/base64-encoded-msg.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/base64-with-whitespace.eml">mail/test/browser/composition/data/base64-with-whitespace.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/base64-with-whitespace.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/base64-with-whitespace.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/base64-with-whitespace.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/base64-with-whitespace.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/base64-with-whitespace.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/body-greek.eml">mail/test/browser/composition/data/body-greek.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/body-greek.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/body-greek.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/body-greek.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/body-greek.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/body-greek.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/body-utf16.eml">mail/test/browser/composition/data/body-utf16.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/body-utf16.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/body-utf16.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/body-utf16.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/body-utf16.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/body-utf16.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/charset-cp932.eml">mail/test/browser/composition/data/charset-cp932.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/charset-cp932.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/charset-cp932.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/charset-cp932.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/charset-cp932.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/charset-cp932.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-alt-rel.eml">mail/test/browser/composition/data/content-utf8-alt-rel.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-alt-rel.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-alt-rel.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-alt-rel.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-alt-rel.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-alt-rel.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-alt-rel2.eml">mail/test/browser/composition/data/content-utf8-alt-rel2.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-alt-rel2.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-alt-rel2.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-alt-rel2.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-alt-rel2.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-alt-rel2.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-rel-alt.eml">mail/test/browser/composition/data/content-utf8-rel-alt.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-rel-alt.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-rel-alt.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-rel-alt.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-rel-alt.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-rel-alt.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-rel-only.eml">mail/test/browser/composition/data/content-utf8-rel-only.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-rel-only.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-rel-only.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-rel-only.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-rel-only.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/content-utf8-rel-only.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/feed-message.eml">mail/test/browser/composition/data/feed-message.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/feed-message.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/feed-message.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/feed-message.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/feed-message.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/feed-message.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format-flowed.eml">mail/test/browser/composition/data/format-flowed.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format-flowed.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format-flowed.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format-flowed.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format-flowed.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format-flowed.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format1-altering.eml">mail/test/browser/composition/data/format1-altering.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format1-altering.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format1-altering.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format1-altering.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format1-altering.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format1-altering.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format1-plain.eml">mail/test/browser/composition/data/format1-plain.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format1-plain.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format1-plain.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format1-plain.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format1-plain.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format1-plain.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format2-style-attr.eml">mail/test/browser/composition/data/format2-style-attr.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format2-style-attr.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format2-style-attr.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format2-style-attr.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format2-style-attr.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format2-style-attr.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format3-style-tag.eml">mail/test/browser/composition/data/format3-style-tag.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format3-style-tag.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format3-style-tag.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format3-style-tag.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format3-style-tag.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/format3-style-tag.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/long-html-line.eml">mail/test/browser/composition/data/long-html-line.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/long-html-line.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/long-html-line.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/long-html-line.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/long-html-line.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/long-html-line.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/mime-encoded-subject.eml">mail/test/browser/composition/data/mime-encoded-subject.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/mime-encoded-subject.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/mime-encoded-subject.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/mime-encoded-subject.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/mime-encoded-subject.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/mime-encoded-subject.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/multipart-charset.eml">mail/test/browser/composition/data/multipart-charset.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/multipart-charset.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/multipart-charset.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/multipart-charset.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/multipart-charset.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/multipart-charset.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/tb-logo.png">mail/test/browser/composition/data/tb-logo.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/tb-logo.png">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/tb-logo.png">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/tb-logo.png">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/tb-logo.png">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/tb-logo.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/testmsg.eml">mail/test/browser/composition/data/testmsg.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/testmsg.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/testmsg.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/testmsg.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/testmsg.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/composition/data/testmsg.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser.ini">mail/test/browser/content-policy/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_composeMailto.js">mail/test/browser/content-policy/browser_composeMailto.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_composeMailto.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_composeMailto.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_composeMailto.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_composeMailto.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_composeMailto.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_dnsPrefetch.js">mail/test/browser/content-policy/browser_dnsPrefetch.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_dnsPrefetch.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_dnsPrefetch.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_dnsPrefetch.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_dnsPrefetch.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_dnsPrefetch.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_exposedInContentTabs.js">mail/test/browser/content-policy/browser_exposedInContentTabs.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_exposedInContentTabs.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_exposedInContentTabs.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_exposedInContentTabs.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_exposedInContentTabs.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_exposedInContentTabs.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_generalContentPolicy.js">mail/test/browser/content-policy/browser_generalContentPolicy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_generalContentPolicy.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_generalContentPolicy.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_generalContentPolicy.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_generalContentPolicy.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_generalContentPolicy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_jsContentPolicy.js">mail/test/browser/content-policy/browser_jsContentPolicy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_jsContentPolicy.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_jsContentPolicy.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_jsContentPolicy.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_jsContentPolicy.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_jsContentPolicy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_pluginsPolicy.js">mail/test/browser/content-policy/browser_pluginsPolicy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_pluginsPolicy.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_pluginsPolicy.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_pluginsPolicy.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_pluginsPolicy.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_pluginsPolicy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_viewSource.js">mail/test/browser/content-policy/browser_viewSource.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_viewSource.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_viewSource.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_viewSource.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_viewSource.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/browser_viewSource.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/mailtolink.html">mail/test/browser/content-policy/html/mailtolink.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/mailtolink.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/mailtolink.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/mailtolink.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/mailtolink.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/mailtolink.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/pass.png">mail/test/browser/content-policy/html/pass.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/pass.png">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/pass.png">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/pass.png">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/pass.png">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/pass.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/plugin.html">mail/test/browser/content-policy/html/plugin.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/plugin.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/plugin.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/plugin.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/plugin.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/plugin.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remote-noscript.html">mail/test/browser/content-policy/html/remote-noscript.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remote-noscript.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remote-noscript.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remote-noscript.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remote-noscript.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remote-noscript.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remoteimage.html">mail/test/browser/content-policy/html/remoteimage.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remoteimage.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remoteimage.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remoteimage.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remoteimage.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remoteimage.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remoteimagedata.html">mail/test/browser/content-policy/html/remoteimagedata.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remoteimagedata.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remoteimagedata.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remoteimagedata.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remoteimagedata.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remoteimagedata.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remotevideo.html">mail/test/browser/content-policy/html/remotevideo.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remotevideo.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remotevideo.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remotevideo.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remotevideo.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/remotevideo.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/video.ogv">mail/test/browser/content-policy/html/video.ogv</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/video.ogv">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/video.ogv">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/video.ogv">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/video.ogv">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-policy/html/video.ogv">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser.ini">mail/test/browser/content-tabs/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_aboutSupport.js">mail/test/browser/content-tabs/browser_aboutSupport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_aboutSupport.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_aboutSupport.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_aboutSupport.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_aboutSupport.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_aboutSupport.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_addonsMgr.js">mail/test/browser/content-tabs/browser_addonsMgr.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_addonsMgr.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_addonsMgr.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_addonsMgr.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_addonsMgr.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_addonsMgr.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_contentTab.js">mail/test/browser/content-tabs/browser_contentTab.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_contentTab.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_contentTab.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_contentTab.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_contentTab.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_contentTab.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_installXpi.js">mail/test/browser/content-tabs/browser_installXpi.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_installXpi.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_installXpi.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_installXpi.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_installXpi.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/browser_installXpi.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklist.xml">mail/test/browser/content-tabs/html/blocklist.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklist.xml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklist.xml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklist.xml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklist.xml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklist.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklistHard.xml">mail/test/browser/content-tabs/html/blocklistHard.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklistHard.xml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklistHard.xml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklistHard.xml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklistHard.xml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklistHard.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklist_details.html">mail/test/browser/content-tabs/html/blocklist_details.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklist_details.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklist_details.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklist_details.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklist_details.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/blocklist_details.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/corrupt.xpi">mail/test/browser/content-tabs/html/corrupt.xpi</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/corrupt.xpi">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/corrupt.xpi">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/corrupt.xpi">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/corrupt.xpi">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/corrupt.xpi">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/dummy.xml">mail/test/browser/content-tabs/html/dummy.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/dummy.xml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/dummy.xml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/dummy.xml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/dummy.xml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/dummy.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/favicon.ico">mail/test/browser/content-tabs/html/favicon.ico</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/favicon.ico">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/favicon.ico">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/favicon.ico">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/favicon.ico">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/favicon.ico">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/installxpi.html">mail/test/browser/content-tabs/html/installxpi.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/installxpi.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/installxpi.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/installxpi.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/installxpi.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/installxpi.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/installxpi.xpi">mail/test/browser/content-tabs/html/installxpi.xpi</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/installxpi.xpi">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/installxpi.xpi">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/installxpi.xpi">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/installxpi.xpi">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/installxpi.xpi">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin.html">mail/test/browser/content-tabs/html/plugin.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin_crashed_help.html">mail/test/browser/content-tabs/html/plugin_crashed_help.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin_crashed_help.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin_crashed_help.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin_crashed_help.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin_crashed_help.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin_crashed_help.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin_update.html">mail/test/browser/content-tabs/html/plugin_update.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin_update.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin_update.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin_update.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin_update.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/plugin_update.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/test-lwthemes.html">mail/test/browser/content-tabs/html/test-lwthemes.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/test-lwthemes.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/test-lwthemes.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/test-lwthemes.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/test-lwthemes.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/test-lwthemes.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/test.png">mail/test/browser/content-tabs/html/test.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/test.png">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/test.png">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/test.png">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/test.png">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/test.png">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/webextension.xpi">mail/test/browser/content-tabs/html/webextension.xpi</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/webextension.xpi">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/webextension.xpi">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/webextension.xpi">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/webextension.xpi">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/webextension.xpi">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew.html">mail/test/browser/content-tabs/html/whatsnew.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew.png">mail/test/browser/content-tabs/html/whatsnew.png</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew.png">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew.png">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew.png">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew.png">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew.png">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew1.html">mail/test/browser/content-tabs/html/whatsnew1.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew1.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew1.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew1.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew1.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/content-tabs/html/whatsnew1.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/browser.ini">mail/test/browser/cookies/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/browser_cookies.js">mail/test/browser/cookies/browser_cookies.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/browser_cookies.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/browser_cookies.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/browser_cookies.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/browser_cookies.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/browser_cookies.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/html/cookietest1.html">mail/test/browser/cookies/html/cookietest1.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/html/cookietest1.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/html/cookietest1.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/html/cookietest1.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/html/cookietest1.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/html/cookietest1.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/html/cookietest2.html">mail/test/browser/cookies/html/cookietest2.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/html/cookietest2.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/html/cookietest2.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/html/cookietest2.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/html/cookietest2.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/cookies/html/cookietest2.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/downloads/browser.ini">mail/test/browser/downloads/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/downloads/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/downloads/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/downloads/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/downloads/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/downloads/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/downloads/browser_aboutDownloads.js">mail/test/browser/downloads/browser_aboutDownloads.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/downloads/browser_aboutDownloads.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/downloads/browser_aboutDownloads.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/downloads/browser_aboutDownloads.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/downloads/browser_aboutDownloads.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/downloads/browser_aboutDownloads.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser.ini">mail/test/browser/folder-display/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_archiveMessages.js">mail/test/browser/folder-display/browser_archiveMessages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_archiveMessages.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_archiveMessages.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_archiveMessages.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_archiveMessages.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_archiveMessages.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_closeWindowOnDelete.js">mail/test/browser/folder-display/browser_closeWindowOnDelete.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_closeWindowOnDelete.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_closeWindowOnDelete.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_closeWindowOnDelete.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_closeWindowOnDelete.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_closeWindowOnDelete.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_columns.js">mail/test/browser/folder-display/browser_columns.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_columns.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_columns.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_columns.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_columns.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_columns.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_deletionFromVirtualFolders.js">mail/test/browser/folder-display/browser_deletionFromVirtualFolders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_deletionFromVirtualFolders.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_deletionFromVirtualFolders.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_deletionFromVirtualFolders.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_deletionFromVirtualFolders.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_deletionFromVirtualFolders.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_deletionWithMultipleDisplays.js">mail/test/browser/folder-display/browser_deletionWithMultipleDisplays.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_deletionWithMultipleDisplays.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_deletionWithMultipleDisplays.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_deletionWithMultipleDisplays.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_deletionWithMultipleDisplays.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_deletionWithMultipleDisplays.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_displayName.js">mail/test/browser/folder-display/browser_displayName.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_displayName.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_displayName.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_displayName.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_displayName.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_displayName.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_folderPaneVisibility.js">mail/test/browser/folder-display/browser_folderPaneVisibility.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_folderPaneVisibility.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_folderPaneVisibility.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_folderPaneVisibility.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_folderPaneVisibility.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_folderPaneVisibility.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_folderToolbar.js">mail/test/browser/folder-display/browser_folderToolbar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_folderToolbar.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_folderToolbar.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_folderToolbar.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_folderToolbar.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_folderToolbar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_invalidDbFolderLoad.js">mail/test/browser/folder-display/browser_invalidDbFolderLoad.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_invalidDbFolderLoad.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_invalidDbFolderLoad.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_invalidDbFolderLoad.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_invalidDbFolderLoad.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_invalidDbFolderLoad.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_mailViews.js">mail/test/browser/folder-display/browser_mailViews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_mailViews.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_mailViews.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_mailViews.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_mailViews.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_mailViews.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageCommands.js">mail/test/browser/folder-display/browser_messageCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageCommands.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageCommands.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageCommands.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageCommands.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js">mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messagePaneVisibility.js">mail/test/browser/folder-display/browser_messagePaneVisibility.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messagePaneVisibility.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messagePaneVisibility.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messagePaneVisibility.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messagePaneVisibility.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messagePaneVisibility.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageReloads.js">mail/test/browser/folder-display/browser_messageReloads.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageReloads.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageReloads.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageReloads.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageReloads.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageReloads.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageSize.js">mail/test/browser/folder-display/browser_messageSize.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageSize.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageSize.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageSize.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageSize.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageSize.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageWindow.js">mail/test/browser/folder-display/browser_messageWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageWindow.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageWindow.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageWindow.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageWindow.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_messageWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_openingMessages.js">mail/test/browser/folder-display/browser_openingMessages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_openingMessages.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_openingMessages.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_openingMessages.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_openingMessages.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_openingMessages.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_openingMessagesWithoutABackingView.js">mail/test/browser/folder-display/browser_openingMessagesWithoutABackingView.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_openingMessagesWithoutABackingView.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_openingMessagesWithoutABackingView.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_openingMessagesWithoutABackingView.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_openingMessagesWithoutABackingView.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_openingMessagesWithoutABackingView.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_paneFocus.js">mail/test/browser/folder-display/browser_paneFocus.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_paneFocus.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_paneFocus.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_paneFocus.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_paneFocus.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_paneFocus.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_recentMenu.js">mail/test/browser/folder-display/browser_recentMenu.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_recentMenu.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_recentMenu.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_recentMenu.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_recentMenu.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_recentMenu.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_rightClickMiddleClickFolders.js">mail/test/browser/folder-display/browser_rightClickMiddleClickFolders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_rightClickMiddleClickFolders.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_rightClickMiddleClickFolders.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_rightClickMiddleClickFolders.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_rightClickMiddleClickFolders.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_rightClickMiddleClickFolders.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_rightClickMiddleClickMessages.js">mail/test/browser/folder-display/browser_rightClickMiddleClickMessages.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_rightClickMiddleClickMessages.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_rightClickMiddleClickMessages.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_rightClickMiddleClickMessages.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_rightClickMiddleClickMessages.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_rightClickMiddleClickMessages.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_savedsearchReloadAfterCompact.js">mail/test/browser/folder-display/browser_savedsearchReloadAfterCompact.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_savedsearchReloadAfterCompact.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_savedsearchReloadAfterCompact.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_savedsearchReloadAfterCompact.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_savedsearchReloadAfterCompact.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_savedsearchReloadAfterCompact.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_selection.js">mail/test/browser/folder-display/browser_selection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_selection.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_selection.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_selection.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_selection.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_selection.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_summarization.js">mail/test/browser/folder-display/browser_summarization.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_summarization.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_summarization.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_summarization.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_summarization.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_summarization.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_tabsSimple.js">mail/test/browser/folder-display/browser_tabsSimple.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_tabsSimple.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_tabsSimple.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_tabsSimple.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_tabsSimple.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_tabsSimple.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_virtualFolderCommands.js">mail/test/browser/folder-display/browser_virtualFolderCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_virtualFolderCommands.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_virtualFolderCommands.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_virtualFolderCommands.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_virtualFolderCommands.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_virtualFolderCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_watchIgnoreThread.js">mail/test/browser/folder-display/browser_watchIgnoreThread.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_watchIgnoreThread.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_watchIgnoreThread.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_watchIgnoreThread.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_watchIgnoreThread.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-display/browser_watchIgnoreThread.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser.ini">mail/test/browser/folder-pane/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_displayMessageWithFolderModes.js">mail/test/browser/folder-pane/browser_displayMessageWithFolderModes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_displayMessageWithFolderModes.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_displayMessageWithFolderModes.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_displayMessageWithFolderModes.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_displayMessageWithFolderModes.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_displayMessageWithFolderModes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderNamesInRecentMode.js">mail/test/browser/folder-pane/browser_folderNamesInRecentMode.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderNamesInRecentMode.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderNamesInRecentMode.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderNamesInRecentMode.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderNamesInRecentMode.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderNamesInRecentMode.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderPane.js">mail/test/browser/folder-pane/browser_folderPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderPane.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderPane.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderPane.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderPane.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderPane.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderPaneConsumers.js">mail/test/browser/folder-pane/browser_folderPaneConsumers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderPaneConsumers.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderPaneConsumers.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderPaneConsumers.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderPaneConsumers.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-pane/browser_folderPaneConsumers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser.ini">mail/test/browser/folder-tree-modes/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_customFolderTreeMode.js">mail/test/browser/folder-tree-modes/browser_customFolderTreeMode.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_customFolderTreeMode.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_customFolderTreeMode.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_customFolderTreeMode.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_customFolderTreeMode.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_customFolderTreeMode.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_customSmartFolder.js">mail/test/browser/folder-tree-modes/browser_customSmartFolder.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_customSmartFolder.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_customSmartFolder.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_customSmartFolder.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_customSmartFolder.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_customSmartFolder.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_modeSwitching.js">mail/test/browser/folder-tree-modes/browser_modeSwitching.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_modeSwitching.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_modeSwitching.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_modeSwitching.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_modeSwitching.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_modeSwitching.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_smartFolders.js">mail/test/browser/folder-tree-modes/browser_smartFolders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_smartFolders.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_smartFolders.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_smartFolders.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_smartFolders.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_smartFolders.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_unreadFolders.js">mail/test/browser/folder-tree-modes/browser_unreadFolders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_unreadFolders.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_unreadFolders.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_unreadFolders.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_unreadFolders.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/browser_unreadFolders.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/bootstrap.js">mail/test/browser/folder-tree-modes/test-extension/bootstrap.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/bootstrap.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/bootstrap.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/bootstrap.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/bootstrap.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/bootstrap.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/chrome.manifest">mail/test/browser/folder-tree-modes/test-extension/chrome.manifest</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/chrome.manifest">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/chrome.manifest">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/chrome.manifest">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/chrome.manifest">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/chrome.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/manifest.json">mail/test/browser/folder-tree-modes/test-extension/manifest.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/manifest.json">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/manifest.json">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/manifest.json">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/manifest.json">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-tree-modes/test-extension/manifest.json">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-widget/browser.ini">mail/test/browser/folder-widget/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-widget/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-widget/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-widget/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-widget/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-widget/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-widget/browser_messageFilters.js">mail/test/browser/folder-widget/browser_messageFilters.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-widget/browser_messageFilters.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-widget/browser_messageFilters.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-widget/browser_messageFilters.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-widget/browser_messageFilters.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/folder-widget/browser_messageFilters.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser.ini">mail/test/browser/im/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser_chatTabRestore.js">mail/test/browser/im/browser_chatTabRestore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser_chatTabRestore.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser_chatTabRestore.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser_chatTabRestore.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser_chatTabRestore.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser_chatTabRestore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser_toolbarButtons.js">mail/test/browser/im/browser_toolbarButtons.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser_toolbarButtons.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser_toolbarButtons.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser_toolbarButtons.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser_toolbarButtons.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/im/browser_toolbarButtons.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/instrumentation/browser.ini">mail/test/browser/instrumentation/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/instrumentation/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/instrumentation/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/instrumentation/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/instrumentation/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/instrumentation/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/instrumentation/browser_instrumentSetup.js">mail/test/browser/instrumentation/browser_instrumentSetup.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/instrumentation/browser_instrumentSetup.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/instrumentation/browser_instrumentSetup.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/instrumentation/browser_instrumentSetup.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/instrumentation/browser_instrumentSetup.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/instrumentation/browser_instrumentSetup.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/junk-commands/browser.ini">mail/test/browser/junk-commands/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/junk-commands/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/junk-commands/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/junk-commands/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/junk-commands/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/junk-commands/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/junk-commands/browser_junkCommands.js">mail/test/browser/junk-commands/browser_junkCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/junk-commands/browser_junkCommands.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/junk-commands/browser_junkCommands.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/junk-commands/browser_junkCommands.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/junk-commands/browser_junkCommands.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/junk-commands/browser_junkCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/keyboard/browser.ini">mail/test/browser/keyboard/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/keyboard/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/keyboard/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/keyboard/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/keyboard/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/keyboard/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/keyboard/browser_spacehit.js">mail/test/browser/keyboard/browser_spacehit.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/keyboard/browser_spacehit.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/keyboard/browser_spacehit.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/keyboard/browser_spacehit.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/keyboard/browser_spacehit.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/keyboard/browser_spacehit.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser.ini">mail/test/browser/message-header/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_messageHeader.js">mail/test/browser/message-header/browser_messageHeader.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_messageHeader.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_messageHeader.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_messageHeader.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_messageHeader.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_messageHeader.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_phishingBar.js">mail/test/browser/message-header/browser_phishingBar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_phishingBar.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_phishingBar.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_phishingBar.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_phishingBar.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_phishingBar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_replyIdentity.js">mail/test/browser/message-header/browser_replyIdentity.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_replyIdentity.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_replyIdentity.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_replyIdentity.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_replyIdentity.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_replyIdentity.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_replyToListFromAddressSelection.js">mail/test/browser/message-header/browser_replyToListFromAddressSelection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_replyToListFromAddressSelection.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_replyToListFromAddressSelection.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_replyToListFromAddressSelection.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_replyToListFromAddressSelection.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_replyToListFromAddressSelection.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_returnReceipt.js">mail/test/browser/message-header/browser_returnReceipt.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_returnReceipt.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_returnReceipt.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_returnReceipt.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_returnReceipt.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/browser_returnReceipt.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/data/evil-attached.eml">mail/test/browser/message-header/data/evil-attached.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/data/evil-attached.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/data/evil-attached.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/data/evil-attached.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/data/evil-attached.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/data/evil-attached.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/data/evil.eml">mail/test/browser/message-header/data/evil.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/data/evil.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/data/evil.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/data/evil.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/data/evil.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-header/data/evil.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/browser.ini">mail/test/browser/message-reader/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/browser_bug594646.js">mail/test/browser/message-reader/browser_bug594646.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/browser_bug594646.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/browser_bug594646.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/browser_bug594646.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/browser_bug594646.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/browser_bug594646.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_8bit.eml">mail/test/browser/message-reader/data/bug594646_newline_charset_8bit.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_8bit.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_8bit.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_8bit.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_8bit.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_8bit.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_b64.eml">mail/test/browser/message-reader/data/bug594646_newline_charset_b64.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_b64.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_b64.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_b64.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_b64.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_b64.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_qp.eml">mail/test/browser/message-reader/data/bug594646_newline_charset_qp.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_qp.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_qp.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_qp.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_qp.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_charset_qp.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_8bit.eml">mail/test/browser/message-reader/data/bug594646_newline_httpequiv_8bit.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_8bit.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_8bit.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_8bit.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_8bit.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_8bit.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_b64.eml">mail/test/browser/message-reader/data/bug594646_newline_httpequiv_b64.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_b64.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_b64.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_b64.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_b64.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_b64.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_qp.eml">mail/test/browser/message-reader/data/bug594646_newline_httpequiv_qp.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_qp.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_qp.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_qp.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_qp.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_newline_httpequiv_qp.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reference.eml">mail/test/browser/message-reader/data/bug594646_reference.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reference.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reference.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reference.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reference.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reference.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_8bit.eml">mail/test/browser/message-reader/data/bug594646_reversed_order_8bit.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_8bit.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_8bit.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_8bit.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_8bit.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_8bit.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_b64.eml">mail/test/browser/message-reader/data/bug594646_reversed_order_b64.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_b64.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_b64.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_b64.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_b64.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_b64.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_qp.eml">mail/test/browser/message-reader/data/bug594646_reversed_order_qp.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_qp.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_qp.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_qp.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_qp.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-reader/data/bug594646_reversed_order_qp.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser.ini">mail/test/browser/message-window/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_autohideMenubar.js">mail/test/browser/message-window/browser_autohideMenubar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_autohideMenubar.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_autohideMenubar.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_autohideMenubar.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_autohideMenubar.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_autohideMenubar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_commands.js">mail/test/browser/message-window/browser_commands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_commands.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_commands.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_commands.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_commands.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_commands.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_emlSubject.js">mail/test/browser/message-window/browser_emlSubject.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_emlSubject.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_emlSubject.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_emlSubject.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_emlSubject.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_emlSubject.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_messageSidebar.js">mail/test/browser/message-window/browser_messageSidebar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_messageSidebar.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_messageSidebar.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_messageSidebar.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_messageSidebar.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_messageSidebar.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_vcardActions.js">mail/test/browser/message-window/browser_vcardActions.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_vcardActions.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_vcardActions.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_vcardActions.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_vcardActions.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_vcardActions.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_viewPlaintext.js">mail/test/browser/message-window/browser_viewPlaintext.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_viewPlaintext.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_viewPlaintext.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_viewPlaintext.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_viewPlaintext.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/browser_viewPlaintext.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/emptySubject.eml">mail/test/browser/message-window/data/emptySubject.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/emptySubject.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/emptySubject.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/emptySubject.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/emptySubject.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/emptySubject.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/evil.eml">mail/test/browser/message-window/data/evil.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/evil.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/evil.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/evil.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/evil.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/evil.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-HTML-missing.eml">mail/test/browser/message-window/data/test-alt-HTML-missing.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-HTML-missing.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-HTML-missing.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-HTML-missing.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-HTML-missing.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-HTML-missing.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-plain-HTML-reversed.eml">mail/test/browser/message-window/data/test-alt-plain-HTML-reversed.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-plain-HTML-reversed.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-plain-HTML-reversed.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-plain-HTML-reversed.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-plain-HTML-reversed.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-plain-HTML-reversed.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-plain-missing.eml">mail/test/browser/message-window/data/test-alt-plain-missing.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-plain-missing.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-plain-missing.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-plain-missing.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-plain-missing.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-plain-missing.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel-text.eml">mail/test/browser/message-window/data/test-alt-rel-text.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel-text.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel-text.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel-text.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel-text.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel-text.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel-with-attach.eml">mail/test/browser/message-window/data/test-alt-rel-with-attach.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel-with-attach.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel-with-attach.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel-with-attach.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel-with-attach.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel-with-attach.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel.eml">mail/test/browser/message-window/data/test-alt-rel.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rel.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rogue.eml">mail/test/browser/message-window/data/test-alt-rogue.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rogue.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rogue.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rogue.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rogue.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rogue.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rogue2.eml">mail/test/browser/message-window/data/test-alt-rogue2.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rogue2.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rogue2.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rogue2.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rogue2.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt-rogue2.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt.eml">mail/test/browser/message-window/data/test-alt.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-alt.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-rel-alt.eml">mail/test/browser/message-window/data/test-rel-alt.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-rel-alt.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-rel-alt.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-rel-alt.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-rel-alt.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-rel-alt.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-triple-alt.eml">mail/test/browser/message-window/data/test-triple-alt.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-triple-alt.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-triple-alt.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-triple-alt.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-triple-alt.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-triple-alt.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-vcard-icon.eml">mail/test/browser/message-window/data/test-vcard-icon.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-vcard-icon.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-vcard-icon.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-vcard-icon.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-vcard-icon.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/message-window/data/test-vcard-icon.eml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/moz.build">mail/test/browser/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/moz.build">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/moz.build">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/moz.build">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/moz.build">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/moz.build">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/browser.ini">mail/test/browser/multiple-identities/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/browser_displayNames.js">mail/test/browser/multiple-identities/browser_displayNames.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/browser_displayNames.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/browser_displayNames.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/browser_displayNames.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/browser_displayNames.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/browser_displayNames.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/readme.txt">mail/test/browser/multiple-identities/readme.txt</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/readme.txt">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/readme.txt">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/readme.txt">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/readme.txt">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/multiple-identities/readme.txt">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/browser.ini">mail/test/browser/newmailaccount/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/browser_newmailaccount.js">mail/test/browser/newmailaccount/browser_newmailaccount.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/browser_newmailaccount.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/browser_newmailaccount.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/browser_newmailaccount.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/browser_newmailaccount.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/browser_newmailaccount.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/badSuggestFromName">mail/test/browser/newmailaccount/html/badSuggestFromName</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/badSuggestFromName">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/badSuggestFromName">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/badSuggestFromName">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/badSuggestFromName">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/badSuggestFromName">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/config.xml">mail/test/browser/newmailaccount/html/config.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/config.xml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/config.xml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/config.xml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/config.xml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/config.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/configCorrupt.xml">mail/test/browser/newmailaccount/html/configCorrupt.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/configCorrupt.xml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/configCorrupt.xml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/configCorrupt.xml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/configCorrupt.xml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/configCorrupt.xml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/configError.xml">mail/test/browser/newmailaccount/html/configError.xml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/configError.xml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/configError.xml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/configError.xml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/configError.xml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/configError.xml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/emptySuggestFromName">mail/test/browser/newmailaccount/html/emptySuggestFromName</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/emptySuggestFromName">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/emptySuggestFromName">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/emptySuggestFromName">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/emptySuggestFromName">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/emptySuggestFromName">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerList">mail/test/browser/newmailaccount/html/providerList</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerList">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerList">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerList">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerList">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerList">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListBad">mail/test/browser/newmailaccount/html/providerListBad</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListBad">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListBad">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListBad">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListBad">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListBad">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListIncomplete">mail/test/browser/newmailaccount/html/providerListIncomplete</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListIncomplete">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListIncomplete">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListIncomplete">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListIncomplete">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListIncomplete">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListNoOtherLangs">mail/test/browser/newmailaccount/html/providerListNoOtherLangs</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListNoOtherLangs">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListNoOtherLangs">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListNoOtherLangs">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListNoOtherLangs">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListNoOtherLangs">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListWildcard">mail/test/browser/newmailaccount/html/providerListWildcard</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListWildcard">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListWildcard">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListWildcard">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListWildcard">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/providerListWildcard">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registration.html">mail/test/browser/newmailaccount/html/registration.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registration.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registration.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registration.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registration.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registration.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registrationCorrupt.html">mail/test/browser/newmailaccount/html/registrationCorrupt.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registrationCorrupt.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registrationCorrupt.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registrationCorrupt.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registrationCorrupt.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registrationCorrupt.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registrationError.html">mail/test/browser/newmailaccount/html/registrationError.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registrationError.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registrationError.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registrationError.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registrationError.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/registrationError.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/suggestFromName">mail/test/browser/newmailaccount/html/suggestFromName</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/suggestFromName">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/suggestFromName">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/suggestFromName">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/suggestFromName">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/suggestFromName">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/target.html">mail/test/browser/newmailaccount/html/target.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/target.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/target.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/target.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/target.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/newmailaccount/html/target.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/notification/browser.ini">mail/test/browser/notification/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/notification/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/notification/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/notification/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/notification/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/notification/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/notification/browser_notification.js">mail/test/browser/notification/browser_notification.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/notification/browser_notification.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/notification/browser_notification.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/notification/browser_notification.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/notification/browser_notification.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/notification/browser_notification.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/override-main-menu-collapse/browser.ini">mail/test/browser/override-main-menu-collapse/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/override-main-menu-collapse/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/override-main-menu-collapse/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/override-main-menu-collapse/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/override-main-menu-collapse/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/override-main-menu-collapse/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/override-main-menu-collapse/browser_overrideMainmenuCollapse.js">mail/test/browser/override-main-menu-collapse/browser_overrideMainmenuCollapse.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/override-main-menu-collapse/browser_overrideMainmenuCollapse.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/override-main-menu-collapse/browser_overrideMainmenuCollapse.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/override-main-menu-collapse/browser_overrideMainmenuCollapse.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/override-main-menu-collapse/browser_overrideMainmenuCollapse.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/override-main-menu-collapse/browser_overrideMainmenuCollapse.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/pref-window/browser.ini">mail/test/browser/pref-window/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/pref-window/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/pref-window/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/pref-window/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/pref-window/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/pref-window/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/pref-window/browser_fontChooser.js">mail/test/browser/pref-window/browser_fontChooser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/pref-window/browser_fontChooser.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/pref-window/browser_fontChooser.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/pref-window/browser_fontChooser.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/pref-window/browser_fontChooser.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/pref-window/browser_fontChooser.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser.ini">mail/test/browser/quick-filter-bar/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_displayIssues.js">mail/test/browser/quick-filter-bar/browser_displayIssues.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_displayIssues.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_displayIssues.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_displayIssues.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_displayIssues.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_displayIssues.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_filterLogic.js">mail/test/browser/quick-filter-bar/browser_filterLogic.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_filterLogic.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_filterLogic.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_filterLogic.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_filterLogic.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_filterLogic.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_keyboardInterface.js">mail/test/browser/quick-filter-bar/browser_keyboardInterface.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_keyboardInterface.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_keyboardInterface.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_keyboardInterface.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_keyboardInterface.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_keyboardInterface.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_stickyFilterLogic.js">mail/test/browser/quick-filter-bar/browser_stickyFilterLogic.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_stickyFilterLogic.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_stickyFilterLogic.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_stickyFilterLogic.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_stickyFilterLogic.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_stickyFilterLogic.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_toggleBar.js">mail/test/browser/quick-filter-bar/browser_toggleBar.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_toggleBar.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_toggleBar.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_toggleBar.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_toggleBar.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/quick-filter-bar/browser_toggleBar.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser.ini">mail/test/browser/search-window/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_multipleSearchWindows.js">mail/test/browser/search-window/browser_multipleSearchWindows.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_multipleSearchWindows.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_multipleSearchWindows.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_multipleSearchWindows.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_multipleSearchWindows.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_multipleSearchWindows.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_rightClickToOpenSearchWindow.js">mail/test/browser/search-window/browser_rightClickToOpenSearchWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_rightClickToOpenSearchWindow.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_rightClickToOpenSearchWindow.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_rightClickToOpenSearchWindow.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_rightClickToOpenSearchWindow.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_rightClickToOpenSearchWindow.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_searchWindow.js">mail/test/browser/search-window/browser_searchWindow.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_searchWindow.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_searchWindow.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_searchWindow.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_searchWindow.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/search-window/browser_searchWindow.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/session-store/browser.ini">mail/test/browser/session-store/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/session-store/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/session-store/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/session-store/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/session-store/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/session-store/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/session-store/browser_sessionStore.js">mail/test/browser/session-store/browser_sessionStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/session-store/browser_sessionStore.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/session-store/browser_sessionStore.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/session-store/browser_sessionStore.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/session-store/browser_sessionStore.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/session-store/browser_sessionStore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/browser.ini">mail/test/browser/smime/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/browser_multipartAlternative.js">mail/test/browser/smime/browser_multipartAlternative.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/browser_multipartAlternative.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/browser_multipartAlternative.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/browser_multipartAlternative.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/browser_multipartAlternative.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/browser_multipartAlternative.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/Bob.p12">mail/test/browser/smime/data/Bob.p12</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/Bob.p12">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/Bob.p12">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/Bob.p12">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/Bob.p12">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/Bob.p12">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/README.md">mail/test/browser/smime/data/README.md</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/README.md">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/README.md">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/README.md">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/README.md">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/README.md">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/TestCA.pem">mail/test/browser/smime/data/TestCA.pem</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/TestCA.pem">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/TestCA.pem">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/TestCA.pem">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/TestCA.pem">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/TestCA.pem">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/multipart-alternative.eml">mail/test/browser/smime/data/multipart-alternative.eml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/multipart-alternative.eml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/multipart-alternative.eml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/multipart-alternative.eml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/multipart-alternative.eml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/smime/data/multipart-alternative.eml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/startup-firstrun/browser.ini">mail/test/browser/startup-firstrun/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/startup-firstrun/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/startup-firstrun/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/startup-firstrun/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/startup-firstrun/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/startup-firstrun/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/startup-firstrun/browser_menubarCollapsed.js">mail/test/browser/startup-firstrun/browser_menubarCollapsed.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/startup-firstrun/browser_menubarCollapsed.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/startup-firstrun/browser_menubarCollapsed.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/startup-firstrun/browser_menubarCollapsed.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/startup-firstrun/browser_menubarCollapsed.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/startup-firstrun/browser_menubarCollapsed.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/subscribe/browser.ini">mail/test/browser/subscribe/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/subscribe/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/subscribe/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/subscribe/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/subscribe/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/subscribe/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/subscribe/browser_newsFilter.js">mail/test/browser/subscribe/browser_newsFilter.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/subscribe/browser_newsFilter.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/subscribe/browser_newsFilter.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/subscribe/browser_newsFilter.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/subscribe/browser_newsFilter.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/subscribe/browser_newsFilter.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser.ini">mail/test/browser/tabmail/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_closing.js">mail/test/browser/tabmail/browser_closing.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_closing.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_closing.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_closing.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_closing.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_closing.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_customize.js">mail/test/browser/tabmail/browser_customize.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_customize.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_customize.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_customize.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_customize.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_customize.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_dragndrop.js">mail/test/browser/tabmail/browser_dragndrop.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_dragndrop.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_dragndrop.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_dragndrop.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_dragndrop.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/tabmail/browser_dragndrop.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser.ini">mail/test/browser/utils/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser.ini">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser.ini">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser.ini">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser.ini">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser_extensionSupport.js">mail/test/browser/utils/browser_extensionSupport.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser_extensionSupport.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser_extensionSupport.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser_extensionSupport.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser_extensionSupport.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser_extensionSupport.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser_iteratorUtils.js">mail/test/browser/utils/browser_iteratorUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser_iteratorUtils.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser_iteratorUtils.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser_iteratorUtils.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser_iteratorUtils.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/browser_iteratorUtils.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/html/collections.html">mail/test/browser/utils/html/collections.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/html/collections.html">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/html/collections.html">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/html/collections.html">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/html/collections.html">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/browser/utils/html/collections.html">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">mail/test/mozmill/cloudfile/test-cloudfile-manager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/shared-modules/CloudfileHelpers.jsm">mail/test/mozmill/shared-modules/CloudfileHelpers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/shared-modules/CloudfileHelpers.jsm">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/shared-modules/CloudfileHelpers.jsm">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/shared-modules/CloudfileHelpers.jsm">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/shared-modules/CloudfileHelpers.jsm">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/shared-modules/CloudfileHelpers.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/shared-modules/PrefTabHelpers.jsm">mail/test/mozmill/shared-modules/PrefTabHelpers.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/shared-modules/PrefTabHelpers.jsm">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/shared-modules/PrefTabHelpers.jsm">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/shared-modules/PrefTabHelpers.jsm">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/shared-modules/PrefTabHelpers.jsm">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mail/test/mozmill/shared-modules/PrefTabHelpers.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mozharness/unittests/thunderbird_extra.py">mozharness/unittests/thunderbird_extra.py</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mozharness/unittests/thunderbird_extra.py">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mozharness/unittests/thunderbird_extra.py">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mozharness/unittests/thunderbird_extra.py">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mozharness/unittests/thunderbird_extra.py">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/mozharness/unittests/thunderbird_extra.py">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/taskcluster/ci/test/tests.yml">taskcluster/ci/test/tests.yml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/825c14a55e122cec28b5e1f7d3ce83007d89f32c/taskcluster/ci/test/tests.yml">file</a> |
<a href="/comm-central/annotate/825c14a55e122cec28b5e1f7d3ce83007d89f32c/taskcluster/ci/test/tests.yml">annotate</a> |
<a href="/comm-central/diff/825c14a55e122cec28b5e1f7d3ce83007d89f32c/taskcluster/ci/test/tests.yml">diff</a> |
<a href="/comm-central/comparison/825c14a55e122cec28b5e1f7d3ce83007d89f32c/taskcluster/ci/test/tests.yml">comparison</a> |
<a href="/comm-central/log/825c14a55e122cec28b5e1f7d3ce83007d89f32c/taskcluster/ci/test/tests.yml">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/gloda-autocomplete-input.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/gloda-autocomplete-input.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -217,16 +217,17 @@ customElements.whenDefined(&quot;autocomplete</span>
<a href="#l1.4"></a><span id="l1.4">       this.value = &quot;&quot;;</span>
<a href="#l1.5"></a><span id="l1.5">     }</span>
<a href="#l1.6"></a><span id="l1.6"> </span>
<a href="#l1.7"></a><span id="l1.7">     disconnectedCallback() {</span>
<a href="#l1.8"></a><span id="l1.8">       Services.obs.removeObserver(</span>
<a href="#l1.9"></a><span id="l1.9">         this.textObserver,</span>
<a href="#l1.10"></a><span id="l1.10">         &quot;autocomplete-did-enter-text&quot;</span>
<a href="#l1.11"></a><span id="l1.11">       );</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+      this.hasConnected = false;</span>
<a href="#l1.13"></a><span id="l1.13">     }</span>
<a href="#l1.14"></a><span id="l1.14">   }</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">   MozXULElement.implementCustomInterface(MozGlodaAutocompleteInput, [</span>
<a href="#l1.17"></a><span id="l1.17">     Ci.nsIObserver,</span>
<a href="#l1.18"></a><span id="l1.18">   ]);</span>
<a href="#l1.19"></a><span id="l1.19">   customElements.define(&quot;gloda-autocomplete-input&quot;, MozGlodaAutocompleteInput, {</span>
<a href="#l1.20"></a><span id="l1.20">     extends: &quot;input&quot;,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/moz.build</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/moz.build</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -16,11 +16,15 @@ DIRS += [</span>
<a href="#l2.4"></a><span id="l2.4"> ]</span>
<a href="#l2.5"></a><span id="l2.5"> </span>
<a href="#l2.6"></a><span id="l2.6"> if CONFIG['MAKENSISU']:</span>
<a href="#l2.7"></a><span id="l2.7">     DIRS += ['installer/windows']</span>
<a href="#l2.8"></a><span id="l2.8"> </span>
<a href="#l2.9"></a><span id="l2.9"> if CONFIG['MOZ_BUNDLED_FONTS']:</span>
<a href="#l2.10"></a><span id="l2.10">     DIRS += ['/%s/browser/fonts' % CONFIG['mozreltopsrcdir']]</span>
<a href="#l2.11"></a><span id="l2.11"> </span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-TEST_DIRS += ['test/mozmill', 'test/marionette']</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+TEST_DIRS += [</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+    'test/browser',</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+    'test/marionette',</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+    'test/mozmill',</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+]</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> FINAL_TARGET_FILES.defaults += ['app/permissions']</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">new file mode 100644</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineminus">--- /dev/null</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineplus">+++ b/mail/test/browser/account/browser.ini</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineat">@@ -0,0 +1,59 @@</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l3.6"></a><span id="l3.6" class="difflineplus">+prefs =</span>
<a href="#l3.7"></a><span id="l3.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l3.8"></a><span id="l3.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l3.9"></a><span id="l3.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l3.10"></a><span id="l3.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l3.11"></a><span id="l3.11" class="difflineplus">+  mail.account.account1.server=server1</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineplus">+  mail.account.account2.identities=id1,id2</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  mail.account.account2.server=server2</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+  mail.accountmanager.accounts=account1,account2</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineplus">+  mail.accountmanager.defaultaccount=account2</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+  mail.accountmanager.localfoldersserver=server1</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  mail.identity.id1.fullName=Tinderbox</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+  mail.identity.id1.htmlSigFormat=false</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+  mail.identity.id1.smtpServer=smtp1</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+  mail.identity.id1.useremail=tinderbox@foo.invalid</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  mail.identity.id1.valid=true</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+  mail.identity.id2.fullName=Tinderboxpushlog</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+  mail.identity.id2.htmlSigFormat=true</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+  mail.identity.id2.smtpServer=smtp1</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+  mail.identity.id2.useremail=tinderboxpushlog@foo.invalid</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  mail.identity.id2.valid=true</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+  mail.server.server1.type=none</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  mail.server.server1.userName=nobody</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+  mail.server.server2.check_new_mail=false</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+  mail.server.server2.directory-rel=[ProfD]Mail/tinderbox</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+  mail.server.server2.download_on_biff=true</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  mail.server.server2.hostname=tinderbox123</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  mail.server.server2.login_at_startup=false</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  mail.server.server2.name=tinderbox@foo.invalid</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+  mail.server.server2.type=pop3</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  mail.server.server2.userName=tinderbox</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+  mail.server.server2.whiteListAbURI=</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+  mail.shell.checkDefaultClient=false</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+  mail.smtp.defaultserver=smtp1</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+  mail.smtpserver.smtp1.hostname=tinderbox123</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+  mail.smtpserver.smtp1.username=tinderbox</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+  mail.smtpservers=smtp1</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+  mailnews.auto_config.addons_url=about:blank</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+  mailnews.auto_config_url=about:blank</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+support-files = xml/**</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+[browser_abWhitelist.js]</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+[browser_actions.js]</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+[browser_archiveOptions.js]</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+[browser_deletion.js]</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+[browser_mailAccountSetupWizard.js]</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+[browser_portSetting.js]</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+skip-if = os == &quot;win&quot;</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+[browser_retestConfig.js]</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+[browser_settingsInfrastructure.js]</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+[browser_tree.js]</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+[browser_values.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">copy from mail/test/mozmill/account/test-ab-whitelist.js</span>
<a href="#l4.2"></a><span id="l4.2">copy to mail/test/browser/account/browser_abWhitelist.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineminus">--- a/mail/test/mozmill/account/test-ab-whitelist.js</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineplus">+++ b/mail/test/browser/account/browser_abWhitelist.js</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineat">@@ -1,84 +1,79 @@</span>
<a href="#l4.6"></a><span id="l4.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l4.7"></a><span id="l4.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l4.8"></a><span id="l4.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10"> &quot;use strict&quot;;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12"> var mozmill = ChromeUtils.import(</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineminus">-  &quot;chrome://mozmill/content/modules/mozmill.jsm&quot;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  &quot;resource://testing-common/mozmill/mozmill.jsm&quot;</span>
<a href="#l4.15"></a><span id="l4.15"> );</span>
<a href="#l4.16"></a><span id="l4.16"> var controller = ChromeUtils.import(</span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-  &quot;chrome://mozmill/content/modules/controller.jsm&quot;</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  &quot;resource://testing-common/mozmill/controller.jsm&quot;</span>
<a href="#l4.19"></a><span id="l4.19"> );</span>
<a href="#l4.20"></a><span id="l4.20"> var elib = ChromeUtils.import(</span>
<a href="#l4.21"></a><span id="l4.21" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l4.22"></a><span id="l4.22" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l4.23"></a><span id="l4.23"> );</span>
<a href="#l4.24"></a><span id="l4.24"> </span>
<a href="#l4.25"></a><span id="l4.25"> var {</span>
<a href="#l4.26"></a><span id="l4.26">   click_account_tree_row,</span>
<a href="#l4.27"></a><span id="l4.27">   get_account_tree_row,</span>
<a href="#l4.28"></a><span id="l4.28">   open_advanced_settings,</span>
<a href="#l4.29"></a><span id="l4.29"> } = ChromeUtils.import(</span>
<a href="#l4.30"></a><span id="l4.30">   &quot;resource://testing-common/mozmill/AccountManagerHelpers.jsm&quot;</span>
<a href="#l4.31"></a><span id="l4.31"> );</span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-var {</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineminus">-  assert_equals,</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineminus">-  assert_false,</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineminus">-  assert_true,</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineminus">-  FAKE_SERVER_HOSTNAME,</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineminus">-} = ChromeUtils.import(</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+var { FAKE_SERVER_HOSTNAME } = ChromeUtils.import(</span>
<a href="#l4.39"></a><span id="l4.39">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l4.40"></a><span id="l4.40"> );</span>
<a href="#l4.41"></a><span id="l4.41"> </span>
<a href="#l4.42"></a><span id="l4.42"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l4.43"></a><span id="l4.43">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l4.44"></a><span id="l4.44"> );</span>
<a href="#l4.45"></a><span id="l4.45"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l4.46"></a><span id="l4.46"> </span>
<a href="#l4.47"></a><span id="l4.47"> var gOldWhiteList = null;</span>
<a href="#l4.48"></a><span id="l4.48"> var gKeyString = null;</span>
<a href="#l4.49"></a><span id="l4.49"> </span>
<a href="#l4.50"></a><span id="l4.50"> var gAccount = null;</span>
<a href="#l4.51"></a><span id="l4.51"> </span>
<a href="#l4.52"></a><span id="l4.52" class="difflineminus">-function setupModule(module) {</span>
<a href="#l4.53"></a><span id="l4.53" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l4.54"></a><span id="l4.54">   let server = MailServices.accounts.FindServer(</span>
<a href="#l4.55"></a><span id="l4.55">     &quot;tinderbox&quot;,</span>
<a href="#l4.56"></a><span id="l4.56">     FAKE_SERVER_HOSTNAME,</span>
<a href="#l4.57"></a><span id="l4.57">     &quot;pop3&quot;</span>
<a href="#l4.58"></a><span id="l4.58">   );</span>
<a href="#l4.59"></a><span id="l4.59">   gAccount = MailServices.accounts.FindAccountForServer(server);</span>
<a href="#l4.60"></a><span id="l4.60">   let serverKey = server.key;</span>
<a href="#l4.61"></a><span id="l4.61"> </span>
<a href="#l4.62"></a><span id="l4.62">   gKeyString = &quot;mail.server.&quot; + serverKey + &quot;.whiteListAbURI&quot;;</span>
<a href="#l4.63"></a><span id="l4.63">   gOldWhiteList = Services.prefs.getCharPref(gKeyString);</span>
<a href="#l4.64"></a><span id="l4.64">   Services.prefs.setCharPref(gKeyString, &quot;&quot;);</span>
<a href="#l4.65"></a><span id="l4.65" class="difflineminus">-}</span>
<a href="#l4.66"></a><span id="l4.66" class="difflineplus">+});</span>
<a href="#l4.67"></a><span id="l4.67"> </span>
<a href="#l4.68"></a><span id="l4.68" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l4.69"></a><span id="l4.69" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l4.70"></a><span id="l4.70">   Services.prefs.setCharPref(gKeyString, gOldWhiteList);</span>
<a href="#l4.71"></a><span id="l4.71" class="difflineminus">-}</span>
<a href="#l4.72"></a><span id="l4.72" class="difflineplus">+});</span>
<a href="#l4.73"></a><span id="l4.73"> </span>
<a href="#l4.74"></a><span id="l4.74"> /* First, test that when we initially load the account manager, that</span>
<a href="#l4.75"></a><span id="l4.75">  * we're not whitelisting any address books.  Then, we'll check all</span>
<a href="#l4.76"></a><span id="l4.76">  * address books and save.</span>
<a href="#l4.77"></a><span id="l4.77">  */</span>
<a href="#l4.78"></a><span id="l4.78"> function subtest_check_whitelist_init_and_save(amc) {</span>
<a href="#l4.79"></a><span id="l4.79">   // Ok, the advanced settings window is open.  Let's choose</span>
<a href="#l4.80"></a><span id="l4.80">   // the junkmail settings.</span>
<a href="#l4.81"></a><span id="l4.81">   let accountRow = get_account_tree_row(gAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l4.82"></a><span id="l4.82">   click_account_tree_row(amc, accountRow);</span>
<a href="#l4.83"></a><span id="l4.83"> </span>
<a href="#l4.84"></a><span id="l4.84">   let doc = amc.window.document.getElementById(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l4.85"></a><span id="l4.85"> </span>
<a href="#l4.86"></a><span id="l4.86">   // At this point, we shouldn't have anything checked, but we should have</span>
<a href="#l4.87"></a><span id="l4.87">   // the two default address books (Personal and Collected) displayed</span>
<a href="#l4.88"></a><span id="l4.88">   let list = doc.getElementById(&quot;whiteListAbURI&quot;);</span>
<a href="#l4.89"></a><span id="l4.89" class="difflineminus">-  assert_equals(</span>
<a href="#l4.90"></a><span id="l4.90" class="difflineplus">+  Assert.equal(</span>
<a href="#l4.91"></a><span id="l4.91">     2,</span>
<a href="#l4.92"></a><span id="l4.92">     list.getRowCount(),</span>
<a href="#l4.93"></a><span id="l4.93">     &quot;There was an unexpected number of address books&quot;</span>
<a href="#l4.94"></a><span id="l4.94">   );</span>
<a href="#l4.95"></a><span id="l4.95"> </span>
<a href="#l4.96"></a><span id="l4.96">   // Now we'll check both address books</span>
<a href="#l4.97"></a><span id="l4.97">   for (let i = 0; i &lt; list.getRowCount(); i++) {</span>
<a href="#l4.98"></a><span id="l4.98">     let abNode = list.getItemAtIndex(i);</span>
<a href="#l4.99"></a><span id="l4.99" class="difflineat">@@ -98,24 +93,24 @@ function subtest_check_whitelist_load_an</span>
<a href="#l4.100"></a><span id="l4.100">   click_account_tree_row(amc, accountRow);</span>
<a href="#l4.101"></a><span id="l4.101"> </span>
<a href="#l4.102"></a><span id="l4.102">   let doc = amc.window.document.getElementById(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l4.103"></a><span id="l4.103">   let list = doc.getElementById(&quot;whiteListAbURI&quot;);</span>
<a href="#l4.104"></a><span id="l4.104">   let whiteListURIs = Services.prefs.getCharPref(gKeyString).split(&quot; &quot;);</span>
<a href="#l4.105"></a><span id="l4.105"> </span>
<a href="#l4.106"></a><span id="l4.106">   for (let i = 0; i &lt; list.getRowCount(); i++) {</span>
<a href="#l4.107"></a><span id="l4.107">     let abNode = list.getItemAtIndex(i);</span>
<a href="#l4.108"></a><span id="l4.108" class="difflineminus">-    assert_equals(</span>
<a href="#l4.109"></a><span id="l4.109" class="difflineplus">+    Assert.equal(</span>
<a href="#l4.110"></a><span id="l4.110">       &quot;true&quot;,</span>
<a href="#l4.111"></a><span id="l4.111">       abNode.firstElementChild.getAttribute(&quot;checked&quot;),</span>
<a href="#l4.112"></a><span id="l4.112">       &quot;Should have been checked&quot;</span>
<a href="#l4.113"></a><span id="l4.113">     );</span>
<a href="#l4.114"></a><span id="l4.114">     // Also ensure that the address book URI was properly saved in the</span>
<a href="#l4.115"></a><span id="l4.115">     // prefs</span>
<a href="#l4.116"></a><span id="l4.116" class="difflineminus">-    assert_true(whiteListURIs.includes(abNode.getAttribute(&quot;value&quot;)));</span>
<a href="#l4.117"></a><span id="l4.117" class="difflineplus">+    Assert.ok(whiteListURIs.includes(abNode.getAttribute(&quot;value&quot;)));</span>
<a href="#l4.118"></a><span id="l4.118">     // Now un-check that address book</span>
<a href="#l4.119"></a><span id="l4.119">     amc.click(new elib.Elem(abNode.firstElementChild));</span>
<a href="#l4.120"></a><span id="l4.120">   }</span>
<a href="#l4.121"></a><span id="l4.121"> </span>
<a href="#l4.122"></a><span id="l4.122">   // And close the dialog</span>
<a href="#l4.123"></a><span id="l4.123">   amc.window.document.getElementById(&quot;accountManager&quot;).acceptDialog();</span>
<a href="#l4.124"></a><span id="l4.124"> }</span>
<a href="#l4.125"></a><span id="l4.125"> </span>
<a href="#l4.126"></a><span id="l4.126" class="difflineat">@@ -136,27 +131,27 @@ function subtest_check_whitelist_load_cl</span>
<a href="#l4.127"></a><span id="l4.127">     // out.</span>
<a href="#l4.128"></a><span id="l4.128">     throw Error(</span>
<a href="#l4.129"></a><span id="l4.129">       &quot;The whitelist preference for this server wasn't properly cleared.&quot;</span>
<a href="#l4.130"></a><span id="l4.130">     );</span>
<a href="#l4.131"></a><span id="l4.131">   } catch (e) {}</span>
<a href="#l4.132"></a><span id="l4.132"> </span>
<a href="#l4.133"></a><span id="l4.133">   for (let i = 0; i &lt; list.getRowCount(); i++) {</span>
<a href="#l4.134"></a><span id="l4.134">     let abNode = list.getItemAtIndex(i);</span>
<a href="#l4.135"></a><span id="l4.135" class="difflineminus">-    assert_equals(</span>
<a href="#l4.136"></a><span id="l4.136" class="difflineplus">+    Assert.equal(</span>
<a href="#l4.137"></a><span id="l4.137">       &quot;false&quot;,</span>
<a href="#l4.138"></a><span id="l4.138">       abNode.firstElementChild.getAttribute(&quot;checked&quot;),</span>
<a href="#l4.139"></a><span id="l4.139">       &quot;Should not have been checked&quot;</span>
<a href="#l4.140"></a><span id="l4.140">     );</span>
<a href="#l4.141"></a><span id="l4.141">     // Also ensure that the address book URI was properly cleared in the</span>
<a href="#l4.142"></a><span id="l4.142">     // prefs</span>
<a href="#l4.143"></a><span id="l4.143" class="difflineminus">-    assert_false(whiteListURIs.includes(abNode.getAttribute(&quot;value&quot;)));</span>
<a href="#l4.144"></a><span id="l4.144" class="difflineplus">+    Assert.ok(!whiteListURIs.includes(abNode.getAttribute(&quot;value&quot;)));</span>
<a href="#l4.145"></a><span id="l4.145">   }</span>
<a href="#l4.146"></a><span id="l4.146"> </span>
<a href="#l4.147"></a><span id="l4.147">   // And close the dialog</span>
<a href="#l4.148"></a><span id="l4.148">   amc.window.document.getElementById(&quot;accountManager&quot;).acceptDialog();</span>
<a href="#l4.149"></a><span id="l4.149"> }</span>
<a href="#l4.150"></a><span id="l4.150"> </span>
<a href="#l4.151"></a><span id="l4.151" class="difflineminus">-function test_address_book_whitelist() {</span>
<a href="#l4.152"></a><span id="l4.152" class="difflineplus">+add_task(function test_address_book_whitelist() {</span>
<a href="#l4.153"></a><span id="l4.153">   open_advanced_settings(subtest_check_whitelist_init_and_save);</span>
<a href="#l4.154"></a><span id="l4.154">   open_advanced_settings(subtest_check_whitelist_load_and_clear);</span>
<a href="#l4.155"></a><span id="l4.155">   open_advanced_settings(subtest_check_whitelist_load_cleared);</span>
<a href="#l4.156"></a><span id="l4.156" class="difflineminus">-}</span>
<a href="#l4.157"></a><span id="l4.157" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">copy from mail/test/mozmill/account/test-account-actions.js</span>
<a href="#l5.2"></a><span id="l5.2">copy to mail/test/browser/account/browser_actions.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineminus">--- a/mail/test/mozmill/account/test-account-actions.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineplus">+++ b/mail/test/browser/account/browser_actions.js</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineat">@@ -6,39 +6,33 @@</span>
<a href="#l5.6"></a><span id="l5.6"> </span>
<a href="#l5.7"></a><span id="l5.7"> var {</span>
<a href="#l5.8"></a><span id="l5.8">   click_account_tree_row,</span>
<a href="#l5.9"></a><span id="l5.9">   get_account_tree_row,</span>
<a href="#l5.10"></a><span id="l5.10">   open_advanced_settings,</span>
<a href="#l5.11"></a><span id="l5.11"> } = ChromeUtils.import(</span>
<a href="#l5.12"></a><span id="l5.12">   &quot;resource://testing-common/mozmill/AccountManagerHelpers.jsm&quot;</span>
<a href="#l5.13"></a><span id="l5.13"> );</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineminus">-var {</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineminus">-  assert_equals,</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineminus">-  assert_not_equals,</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineminus">-  assert_true,</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineminus">-  close_popup,</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineminus">-  wait_for_popup_to_open,</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineminus">-} = ChromeUtils.import(</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+var { close_popup, wait_for_popup_to_open } = ChromeUtils.import(</span>
<a href="#l5.22"></a><span id="l5.22">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l5.23"></a><span id="l5.23"> );</span>
<a href="#l5.24"></a><span id="l5.24"> </span>
<a href="#l5.25"></a><span id="l5.25"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l5.26"></a><span id="l5.26">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l5.27"></a><span id="l5.27"> );</span>
<a href="#l5.28"></a><span id="l5.28"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.29"></a><span id="l5.29"> </span>
<a href="#l5.30"></a><span id="l5.30"> var imapAccount, nntpAccount, originalAccountCount;</span>
<a href="#l5.31"></a><span id="l5.31"> </span>
<a href="#l5.32"></a><span id="l5.32" class="difflineminus">-function setupModule(module) {</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l5.34"></a><span id="l5.34">   // There may be pre-existing accounts from other tests.</span>
<a href="#l5.35"></a><span id="l5.35">   originalAccountCount = MailServices.accounts.allServers.length;</span>
<a href="#l5.36"></a><span id="l5.36">   // There already should be a Local Folders account created.</span>
<a href="#l5.37"></a><span id="l5.37">   // It is needed for this test.</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineminus">-  assert_true(MailServices.accounts.localFoldersServer);</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  Assert.ok(MailServices.accounts.localFoldersServer);</span>
<a href="#l5.40"></a><span id="l5.40"> </span>
<a href="#l5.41"></a><span id="l5.41">   // Create an IMAP server</span>
<a href="#l5.42"></a><span id="l5.42">   let imapServer = MailServices.accounts</span>
<a href="#l5.43"></a><span id="l5.43">     .createIncomingServer(&quot;nobody&quot;, &quot;example.com&quot;, &quot;imap&quot;)</span>
<a href="#l5.44"></a><span id="l5.44">     .QueryInterface(Ci.nsIImapIncomingServer);</span>
<a href="#l5.45"></a><span id="l5.45"> </span>
<a href="#l5.46"></a><span id="l5.46">   let identity = MailServices.accounts.createIdentity();</span>
<a href="#l5.47"></a><span id="l5.47">   identity.email = &quot;tinderbox@example.com&quot;;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineat">@@ -54,29 +48,29 @@ function setupModule(module) {</span>
<a href="#l5.49"></a><span id="l5.49"> </span>
<a href="#l5.50"></a><span id="l5.50">   identity = MailServices.accounts.createIdentity();</span>
<a href="#l5.51"></a><span id="l5.51">   identity.email = &quot;tinderbox2@example.com&quot;;</span>
<a href="#l5.52"></a><span id="l5.52"> </span>
<a href="#l5.53"></a><span id="l5.53">   nntpAccount = MailServices.accounts.createAccount();</span>
<a href="#l5.54"></a><span id="l5.54">   nntpAccount.incomingServer = nntpServer;</span>
<a href="#l5.55"></a><span id="l5.55">   nntpAccount.addIdentity(identity);</span>
<a href="#l5.56"></a><span id="l5.56">   // Now there should be 2 more accounts.</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineminus">-  assert_equals(</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+  Assert.equal(</span>
<a href="#l5.59"></a><span id="l5.59">     MailServices.accounts.allServers.length,</span>
<a href="#l5.60"></a><span id="l5.60">     originalAccountCount + 2</span>
<a href="#l5.61"></a><span id="l5.61">   );</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-}</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+});</span>
<a href="#l5.64"></a><span id="l5.64"> </span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l5.67"></a><span id="l5.67">   // Remove our test accounts to leave the profile clean.</span>
<a href="#l5.68"></a><span id="l5.68">   MailServices.accounts.removeAccount(nntpAccount);</span>
<a href="#l5.69"></a><span id="l5.69">   MailServices.accounts.removeAccount(imapAccount);</span>
<a href="#l5.70"></a><span id="l5.70">   // There should be only the original accounts left.</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-  assert_equals(MailServices.accounts.allServers.length, originalAccountCount);</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-}</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineplus">+  Assert.equal(MailServices.accounts.allServers.length, originalAccountCount);</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineplus">+});</span>
<a href="#l5.75"></a><span id="l5.75"> </span>
<a href="#l5.76"></a><span id="l5.76"> /**</span>
<a href="#l5.77"></a><span id="l5.77">  * Check that the account actions for the account are enabled or disabled appropriately.</span>
<a href="#l5.78"></a><span id="l5.78">  *</span>
<a href="#l5.79"></a><span id="l5.79">  * @param amc          the account options controller</span>
<a href="#l5.80"></a><span id="l5.80">  * @param aAccountKey  the key of the account to select</span>
<a href="#l5.81"></a><span id="l5.81">  * @param aIsSetAsDefaultEnabled  true if the menuitem should be enabled, false otherwise</span>
<a href="#l5.82"></a><span id="l5.82">  * @param aIsRemoveEnabled        true if the menuitem should be enabled, false otherwise</span>
<a href="#l5.83"></a><span id="l5.83" class="difflineat">@@ -93,44 +87,44 @@ function subtest_check_account_actions(</span>
<a href="#l5.84"></a><span id="l5.84">   let accountRow = get_account_tree_row(aAccountKey, null, amc);</span>
<a href="#l5.85"></a><span id="l5.85">   click_account_tree_row(amc, accountRow);</span>
<a href="#l5.86"></a><span id="l5.86"> </span>
<a href="#l5.87"></a><span id="l5.87">   // click the Actions Button to bring up the popup with menuitems to test</span>
<a href="#l5.88"></a><span id="l5.88">   amc.click(amc.eid(&quot;accountActionsButton&quot;), 5, 5);</span>
<a href="#l5.89"></a><span id="l5.89">   wait_for_popup_to_open(amc.e(&quot;accountActionsDropdown&quot;));</span>
<a href="#l5.90"></a><span id="l5.90"> </span>
<a href="#l5.91"></a><span id="l5.91">   let actionAddMailAccount = amc.e(&quot;accountActionsAddMailAccount&quot;);</span>
<a href="#l5.92"></a><span id="l5.92" class="difflineminus">-  assert_not_equals(actionAddMailAccount, undefined);</span>
<a href="#l5.93"></a><span id="l5.93" class="difflineminus">-  assert_equals(</span>
<a href="#l5.94"></a><span id="l5.94" class="difflineplus">+  Assert.notEqual(actionAddMailAccount, undefined);</span>
<a href="#l5.95"></a><span id="l5.95" class="difflineplus">+  Assert.equal(</span>
<a href="#l5.96"></a><span id="l5.96">     !actionAddMailAccount.getAttribute(&quot;disabled&quot;),</span>
<a href="#l5.97"></a><span id="l5.97">     aIsAddAccountEnabled</span>
<a href="#l5.98"></a><span id="l5.98">   );</span>
<a href="#l5.99"></a><span id="l5.99"> </span>
<a href="#l5.100"></a><span id="l5.100">   let actionAddOtherAccount = amc.e(&quot;accountActionsAddOtherAccount&quot;);</span>
<a href="#l5.101"></a><span id="l5.101" class="difflineminus">-  assert_not_equals(actionAddOtherAccount, undefined);</span>
<a href="#l5.102"></a><span id="l5.102" class="difflineminus">-  assert_equals(</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineplus">+  Assert.notEqual(actionAddOtherAccount, undefined);</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineplus">+  Assert.equal(</span>
<a href="#l5.105"></a><span id="l5.105">     !actionAddOtherAccount.getAttribute(&quot;disabled&quot;),</span>
<a href="#l5.106"></a><span id="l5.106">     aIsAddAccountEnabled</span>
<a href="#l5.107"></a><span id="l5.107">   );</span>
<a href="#l5.108"></a><span id="l5.108"> </span>
<a href="#l5.109"></a><span id="l5.109">   let actionSetDefault = amc.e(&quot;accountActionsDropdownSetDefault&quot;);</span>
<a href="#l5.110"></a><span id="l5.110" class="difflineminus">-  assert_not_equals(actionSetDefault, undefined);</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-  assert_equals(</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineplus">+  Assert.notEqual(actionSetDefault, undefined);</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineplus">+  Assert.equal(</span>
<a href="#l5.114"></a><span id="l5.114">     !actionSetDefault.getAttribute(&quot;disabled&quot;),</span>
<a href="#l5.115"></a><span id="l5.115">     aIsSetAsDefaultEnabled</span>
<a href="#l5.116"></a><span id="l5.116">   );</span>
<a href="#l5.117"></a><span id="l5.117"> </span>
<a href="#l5.118"></a><span id="l5.118">   let actionRemove = amc.e(&quot;accountActionsDropdownRemove&quot;);</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineminus">-  assert_not_equals(actionRemove, undefined);</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineminus">-  assert_equals(!actionRemove.getAttribute(&quot;disabled&quot;), aIsRemoveEnabled);</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+  Assert.notEqual(actionRemove, undefined);</span>
<a href="#l5.122"></a><span id="l5.122" class="difflineplus">+  Assert.equal(!actionRemove.getAttribute(&quot;disabled&quot;), aIsRemoveEnabled);</span>
<a href="#l5.123"></a><span id="l5.123"> </span>
<a href="#l5.124"></a><span id="l5.124">   close_popup(amc, amc.eid(&quot;accountActionsDropdown&quot;));</span>
<a href="#l5.125"></a><span id="l5.125"> }</span>
<a href="#l5.126"></a><span id="l5.126"> </span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-function test_account_actions() {</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineplus">+add_task(function test_account_actions() {</span>
<a href="#l5.129"></a><span id="l5.129">   // IMAP account: can be default, can be removed.</span>
<a href="#l5.130"></a><span id="l5.130">   open_advanced_settings(function(amc) {</span>
<a href="#l5.131"></a><span id="l5.131">     subtest_check_account_actions(amc, imapAccount.key, true, true, true);</span>
<a href="#l5.132"></a><span id="l5.132">   });</span>
<a href="#l5.133"></a><span id="l5.133"> </span>
<a href="#l5.134"></a><span id="l5.134">   // NNTP (News) account: can't be default, can be removed.</span>
<a href="#l5.135"></a><span id="l5.135">   open_advanced_settings(function(amc) {</span>
<a href="#l5.136"></a><span id="l5.136">     subtest_check_account_actions(amc, nntpAccount.key, false, true, true);</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineat">@@ -188,9 +182,9 @@ function test_account_actions() {</span>
<a href="#l5.138"></a><span id="l5.138">   Services.prefs.lockPref(disableItemPref);</span>
<a href="#l5.139"></a><span id="l5.139"> </span>
<a href="#l5.140"></a><span id="l5.140">   open_advanced_settings(function(amc) {</span>
<a href="#l5.141"></a><span id="l5.141">     subtest_check_account_actions(amc, imapAccount.key, true, true, false);</span>
<a href="#l5.142"></a><span id="l5.142">   });</span>
<a href="#l5.143"></a><span id="l5.143"> </span>
<a href="#l5.144"></a><span id="l5.144">   Services.prefs.unlockPref(disableItemPref);</span>
<a href="#l5.145"></a><span id="l5.145">   Services.prefs.getDefaultBranch(&quot;&quot;).deleteBranch(disableItemPref);</span>
<a href="#l5.146"></a><span id="l5.146" class="difflineminus">-}</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">copy from mail/test/mozmill/account/test-archive-options.js</span>
<a href="#l6.2"></a><span id="l6.2">copy to mail/test/browser/account/browser_archiveOptions.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineminus">--- a/mail/test/mozmill/account/test-archive-options.js</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineplus">+++ b/mail/test/browser/account/browser_archiveOptions.js</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineat">@@ -1,70 +1,70 @@</span>
<a href="#l6.6"></a><span id="l6.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l6.7"></a><span id="l6.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l6.8"></a><span id="l6.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l6.9"></a><span id="l6.9"> </span>
<a href="#l6.10"></a><span id="l6.10"> &quot;use strict&quot;;</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12"> var mozmill = ChromeUtils.import(</span>
<a href="#l6.13"></a><span id="l6.13" class="difflineminus">-  &quot;chrome://mozmill/content/modules/mozmill.jsm&quot;</span>
<a href="#l6.14"></a><span id="l6.14" class="difflineplus">+  &quot;resource://testing-common/mozmill/mozmill.jsm&quot;</span>
<a href="#l6.15"></a><span id="l6.15"> );</span>
<a href="#l6.16"></a><span id="l6.16"> var controller = ChromeUtils.import(</span>
<a href="#l6.17"></a><span id="l6.17" class="difflineminus">-  &quot;chrome://mozmill/content/modules/controller.jsm&quot;</span>
<a href="#l6.18"></a><span id="l6.18" class="difflineplus">+  &quot;resource://testing-common/mozmill/controller.jsm&quot;</span>
<a href="#l6.19"></a><span id="l6.19"> );</span>
<a href="#l6.20"></a><span id="l6.20"> var elib = ChromeUtils.import(</span>
<a href="#l6.21"></a><span id="l6.21" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l6.22"></a><span id="l6.22" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l6.23"></a><span id="l6.23"> );</span>
<a href="#l6.24"></a><span id="l6.24" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l6.25"></a><span id="l6.25" class="difflineplus">+var utils = ChromeUtils.import(&quot;resource://testing-common/mozmill/utils.jsm&quot;);</span>
<a href="#l6.26"></a><span id="l6.26"> </span>
<a href="#l6.27"></a><span id="l6.27"> var {</span>
<a href="#l6.28"></a><span id="l6.28">   click_account_tree_row,</span>
<a href="#l6.29"></a><span id="l6.29">   get_account_tree_row,</span>
<a href="#l6.30"></a><span id="l6.30">   open_advanced_settings,</span>
<a href="#l6.31"></a><span id="l6.31"> } = ChromeUtils.import(</span>
<a href="#l6.32"></a><span id="l6.32">   &quot;resource://testing-common/mozmill/AccountManagerHelpers.jsm&quot;</span>
<a href="#l6.33"></a><span id="l6.33"> );</span>
<a href="#l6.34"></a><span id="l6.34" class="difflineminus">-var { assert_equals, assert_false, assert_true, mc } = ChromeUtils.import(</span>
<a href="#l6.35"></a><span id="l6.35" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l6.36"></a><span id="l6.36">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l6.37"></a><span id="l6.37"> );</span>
<a href="#l6.38"></a><span id="l6.38"> var {</span>
<a href="#l6.39"></a><span id="l6.39">   plan_for_modal_dialog,</span>
<a href="#l6.40"></a><span id="l6.40">   plan_for_window_close,</span>
<a href="#l6.41"></a><span id="l6.41">   wait_for_modal_dialog,</span>
<a href="#l6.42"></a><span id="l6.42">   wait_for_window_close,</span>
<a href="#l6.43"></a><span id="l6.43"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;);</span>
<a href="#l6.44"></a><span id="l6.44"> </span>
<a href="#l6.45"></a><span id="l6.45"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l6.46"></a><span id="l6.46">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l6.47"></a><span id="l6.47"> );</span>
<a href="#l6.48"></a><span id="l6.48"> </span>
<a href="#l6.49"></a><span id="l6.49"> var defaultIdentity;</span>
<a href="#l6.50"></a><span id="l6.50"> </span>
<a href="#l6.51"></a><span id="l6.51" class="difflineminus">-function setupModule(module) {</span>
<a href="#l6.52"></a><span id="l6.52" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l6.53"></a><span id="l6.53">   defaultIdentity = MailServices.accounts.defaultAccount.defaultIdentity;</span>
<a href="#l6.54"></a><span id="l6.54" class="difflineminus">-}</span>
<a href="#l6.55"></a><span id="l6.55" class="difflineplus">+});</span>
<a href="#l6.56"></a><span id="l6.56"> </span>
<a href="#l6.57"></a><span id="l6.57"> /**</span>
<a href="#l6.58"></a><span id="l6.58">  * Check that the archive options button is enabled or disabled appropriately.</span>
<a href="#l6.59"></a><span id="l6.59">  *</span>
<a href="#l6.60"></a><span id="l6.60">  * @param amc          the account options controller</span>
<a href="#l6.61"></a><span id="l6.61">  * @param aAccountKey  key of the account the check</span>
<a href="#l6.62"></a><span id="l6.62">  * @param isEnabled    true if the button should be enabled, false otherwise</span>
<a href="#l6.63"></a><span id="l6.63">  */</span>
<a href="#l6.64"></a><span id="l6.64"> function subtest_check_archive_options_enabled(amc, aAccountKey, isEnabled) {</span>
<a href="#l6.65"></a><span id="l6.65">   let accountRow = get_account_tree_row(aAccountKey, &quot;am-copies.xul&quot;, amc);</span>
<a href="#l6.66"></a><span id="l6.66">   click_account_tree_row(amc, accountRow);</span>
<a href="#l6.67"></a><span id="l6.67"> </span>
<a href="#l6.68"></a><span id="l6.68">   let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l6.69"></a><span id="l6.69">   let button = iframe.contentDocument.getElementById(&quot;archiveHierarchyButton&quot;);</span>
<a href="#l6.70"></a><span id="l6.70"> </span>
<a href="#l6.71"></a><span id="l6.71" class="difflineminus">-  assert_equals(button.disabled, !isEnabled);</span>
<a href="#l6.72"></a><span id="l6.72" class="difflineplus">+  Assert.equal(button.disabled, !isEnabled);</span>
<a href="#l6.73"></a><span id="l6.73"> }</span>
<a href="#l6.74"></a><span id="l6.74"> </span>
<a href="#l6.75"></a><span id="l6.75" class="difflineminus">-function test_archive_options_enabled() {</span>
<a href="#l6.76"></a><span id="l6.76" class="difflineplus">+add_task(function test_archive_options_enabled() {</span>
<a href="#l6.77"></a><span id="l6.77">   let defaultAccount = MailServices.accounts.defaultAccount;</span>
<a href="#l6.78"></a><span id="l6.78">   // First, create an IMAP server</span>
<a href="#l6.79"></a><span id="l6.79">   let imapServer = MailServices.accounts</span>
<a href="#l6.80"></a><span id="l6.80">     .createIncomingServer(&quot;nobody&quot;, &quot;example.com&quot;, &quot;imap&quot;)</span>
<a href="#l6.81"></a><span id="l6.81">     .QueryInterface(Ci.nsIImapIncomingServer);</span>
<a href="#l6.82"></a><span id="l6.82"> </span>
<a href="#l6.83"></a><span id="l6.83">   let identity = MailServices.accounts.createIdentity();</span>
<a href="#l6.84"></a><span id="l6.84">   identity.email = &quot;tinderbox@example.com&quot;;</span>
<a href="#l6.85"></a><span id="l6.85" class="difflineat">@@ -93,116 +93,113 @@ function test_archive_options_enabled() </span>
<a href="#l6.86"></a><span id="l6.86">   open_advanced_settings(function(amc) {</span>
<a href="#l6.87"></a><span id="l6.87">     subtest_check_archive_options_enabled(amc, account.key, false);</span>
<a href="#l6.88"></a><span id="l6.88">   });</span>
<a href="#l6.89"></a><span id="l6.89">   open_advanced_settings(function(amc) {</span>
<a href="#l6.90"></a><span id="l6.90">     subtest_check_archive_options_enabled(amc, defaultAccount.key, false);</span>
<a href="#l6.91"></a><span id="l6.91">   });</span>
<a href="#l6.92"></a><span id="l6.92"> </span>
<a href="#l6.93"></a><span id="l6.93">   MailServices.accounts.removeAccount(account);</span>
<a href="#l6.94"></a><span id="l6.94" class="difflineminus">-}</span>
<a href="#l6.95"></a><span id="l6.95" class="difflineplus">+});</span>
<a href="#l6.96"></a><span id="l6.96"> </span>
<a href="#l6.97"></a><span id="l6.97"> function subtest_initial_state(identity) {</span>
<a href="#l6.98"></a><span id="l6.98">   plan_for_modal_dialog(&quot;archive-options&quot;, function(ac) {</span>
<a href="#l6.99"></a><span id="l6.99" class="difflineminus">-    assert_equals(</span>
<a href="#l6.100"></a><span id="l6.100" class="difflineplus">+    Assert.equal(</span>
<a href="#l6.101"></a><span id="l6.101">       ac.e(&quot;archiveGranularity&quot;).selectedIndex,</span>
<a href="#l6.102"></a><span id="l6.102">       identity.archiveGranularity</span>
<a href="#l6.103"></a><span id="l6.103">     );</span>
<a href="#l6.104"></a><span id="l6.104" class="difflineminus">-    assert_equals(</span>
<a href="#l6.105"></a><span id="l6.105" class="difflineplus">+    Assert.equal(</span>
<a href="#l6.106"></a><span id="l6.106">       ac.e(&quot;archiveKeepFolderStructure&quot;).checked,</span>
<a href="#l6.107"></a><span id="l6.107">       identity.archiveKeepFolderStructure</span>
<a href="#l6.108"></a><span id="l6.108">     );</span>
<a href="#l6.109"></a><span id="l6.109">   });</span>
<a href="#l6.110"></a><span id="l6.110">   mc.window.openDialog(</span>
<a href="#l6.111"></a><span id="l6.111">     &quot;chrome://messenger/content/am-archiveoptions.xul&quot;,</span>
<a href="#l6.112"></a><span id="l6.112">     &quot;&quot;,</span>
<a href="#l6.113"></a><span id="l6.113">     &quot;centerscreen,chrome,modal,titlebar,resizable=yes&quot;,</span>
<a href="#l6.114"></a><span id="l6.114">     identity</span>
<a href="#l6.115"></a><span id="l6.115">   );</span>
<a href="#l6.116"></a><span id="l6.116">   wait_for_modal_dialog(&quot;archive-options&quot;);</span>
<a href="#l6.117"></a><span id="l6.117"> }</span>
<a href="#l6.118"></a><span id="l6.118"> </span>
<a href="#l6.119"></a><span id="l6.119" class="difflineminus">-function test_open_archive_options() {</span>
<a href="#l6.120"></a><span id="l6.120" class="difflineplus">+add_task(function test_open_archive_options() {</span>
<a href="#l6.121"></a><span id="l6.121">   for (let granularity = 0; granularity &lt; 3; granularity++) {</span>
<a href="#l6.122"></a><span id="l6.122">     defaultIdentity.archiveGranularity = granularity;</span>
<a href="#l6.123"></a><span id="l6.123">     for (let kfs = 0; kfs &lt; 2; kfs++) {</span>
<a href="#l6.124"></a><span id="l6.124">       defaultIdentity.archiveKeepFolderStructure = kfs;</span>
<a href="#l6.125"></a><span id="l6.125">       subtest_initial_state(defaultIdentity);</span>
<a href="#l6.126"></a><span id="l6.126">     }</span>
<a href="#l6.127"></a><span id="l6.127">   }</span>
<a href="#l6.128"></a><span id="l6.128" class="difflineminus">-}</span>
<a href="#l6.129"></a><span id="l6.129" class="difflineplus">+});</span>
<a href="#l6.130"></a><span id="l6.130"> </span>
<a href="#l6.131"></a><span id="l6.131"> function subtest_save_state(identity, granularity, kfs) {</span>
<a href="#l6.132"></a><span id="l6.132">   plan_for_modal_dialog(&quot;archive-options&quot;, function(ac) {</span>
<a href="#l6.133"></a><span id="l6.133">     ac.e(&quot;archiveGranularity&quot;).selectedIndex = granularity;</span>
<a href="#l6.134"></a><span id="l6.134">     ac.e(&quot;archiveKeepFolderStructure&quot;).checked = kfs;</span>
<a href="#l6.135"></a><span id="l6.135">     ac.keypress(null, &quot;VK_RETURN&quot;, {});</span>
<a href="#l6.136"></a><span id="l6.136">   });</span>
<a href="#l6.137"></a><span id="l6.137">   mc.window.openDialog(</span>
<a href="#l6.138"></a><span id="l6.138">     &quot;chrome://messenger/content/am-archiveoptions.xul&quot;,</span>
<a href="#l6.139"></a><span id="l6.139">     &quot;&quot;,</span>
<a href="#l6.140"></a><span id="l6.140">     &quot;centerscreen,chrome,modal,titlebar,resizable=yes&quot;,</span>
<a href="#l6.141"></a><span id="l6.141">     identity</span>
<a href="#l6.142"></a><span id="l6.142">   );</span>
<a href="#l6.143"></a><span id="l6.143">   wait_for_modal_dialog(&quot;archive-options&quot;);</span>
<a href="#l6.144"></a><span id="l6.144"> }</span>
<a href="#l6.145"></a><span id="l6.145"> </span>
<a href="#l6.146"></a><span id="l6.146" class="difflineminus">-function test_save_archive_options() {</span>
<a href="#l6.147"></a><span id="l6.147" class="difflineplus">+add_task(function test_save_archive_options() {</span>
<a href="#l6.148"></a><span id="l6.148">   defaultIdentity.archiveGranularity = 0;</span>
<a href="#l6.149"></a><span id="l6.149">   defaultIdentity.archiveKeepFolderStructure = false;</span>
<a href="#l6.150"></a><span id="l6.150">   subtest_save_state(defaultIdentity, 1, true);</span>
<a href="#l6.151"></a><span id="l6.151"> </span>
<a href="#l6.152"></a><span id="l6.152" class="difflineminus">-  assert_equals(defaultIdentity.archiveGranularity, 1);</span>
<a href="#l6.153"></a><span id="l6.153" class="difflineminus">-  assert_equals(defaultIdentity.archiveKeepFolderStructure, true);</span>
<a href="#l6.154"></a><span id="l6.154" class="difflineminus">-}</span>
<a href="#l6.155"></a><span id="l6.155" class="difflineplus">+  Assert.equal(defaultIdentity.archiveGranularity, 1);</span>
<a href="#l6.156"></a><span id="l6.156" class="difflineplus">+  Assert.equal(defaultIdentity.archiveKeepFolderStructure, true);</span>
<a href="#l6.157"></a><span id="l6.157" class="difflineplus">+});</span>
<a href="#l6.158"></a><span id="l6.158"> </span>
<a href="#l6.159"></a><span id="l6.159"> function subtest_check_archive_enabled(amc, archiveEnabled) {</span>
<a href="#l6.160"></a><span id="l6.160">   defaultIdentity.archiveEnabled = archiveEnabled;</span>
<a href="#l6.161"></a><span id="l6.161"> </span>
<a href="#l6.162"></a><span id="l6.162">   click_account_tree_row(amc, 2);</span>
<a href="#l6.163"></a><span id="l6.163"> </span>
<a href="#l6.164"></a><span id="l6.164">   let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l6.165"></a><span id="l6.165">   let checkbox = iframe.contentDocument.getElementById(</span>
<a href="#l6.166"></a><span id="l6.166">     &quot;identity.archiveEnabled&quot;</span>
<a href="#l6.167"></a><span id="l6.167">   );</span>
<a href="#l6.168"></a><span id="l6.168"> </span>
<a href="#l6.169"></a><span id="l6.169" class="difflineminus">-  assert_equals(checkbox.checked, archiveEnabled);</span>
<a href="#l6.170"></a><span id="l6.170" class="difflineplus">+  Assert.equal(checkbox.checked, archiveEnabled);</span>
<a href="#l6.171"></a><span id="l6.171"> }</span>
<a href="#l6.172"></a><span id="l6.172"> </span>
<a href="#l6.173"></a><span id="l6.173" class="difflineminus">-function test_archive_enabled() {</span>
<a href="#l6.174"></a><span id="l6.174" class="difflineplus">+add_task(function test_archive_enabled() {</span>
<a href="#l6.175"></a><span id="l6.175">   open_advanced_settings(function(amc) {</span>
<a href="#l6.176"></a><span id="l6.176">     subtest_check_archive_enabled(amc, true);</span>
<a href="#l6.177"></a><span id="l6.177">   });</span>
<a href="#l6.178"></a><span id="l6.178"> </span>
<a href="#l6.179"></a><span id="l6.179">   open_advanced_settings(function(amc) {</span>
<a href="#l6.180"></a><span id="l6.180">     subtest_check_archive_enabled(amc, false);</span>
<a href="#l6.181"></a><span id="l6.181">   });</span>
<a href="#l6.182"></a><span id="l6.182" class="difflineminus">-}</span>
<a href="#l6.183"></a><span id="l6.183" class="difflineplus">+});</span>
<a href="#l6.184"></a><span id="l6.184"> </span>
<a href="#l6.185"></a><span id="l6.185"> function subtest_disable_archive(amc) {</span>
<a href="#l6.186"></a><span id="l6.186">   defaultIdentity.archiveEnabled = true;</span>
<a href="#l6.187"></a><span id="l6.187">   click_account_tree_row(amc, 2);</span>
<a href="#l6.188"></a><span id="l6.188"> </span>
<a href="#l6.189"></a><span id="l6.189">   let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l6.190"></a><span id="l6.190">   let checkbox = iframe.contentDocument.getElementById(</span>
<a href="#l6.191"></a><span id="l6.191">     &quot;identity.archiveEnabled&quot;</span>
<a href="#l6.192"></a><span id="l6.192">   );</span>
<a href="#l6.193"></a><span id="l6.193"> </span>
<a href="#l6.194"></a><span id="l6.194" class="difflineminus">-  assert_true(checkbox.checked);</span>
<a href="#l6.195"></a><span id="l6.195" class="difflineminus">-  assert_false(checkbox.disabled);</span>
<a href="#l6.196"></a><span id="l6.196" class="difflineplus">+  Assert.ok(checkbox.checked);</span>
<a href="#l6.197"></a><span id="l6.197" class="difflineplus">+  Assert.ok(!checkbox.disabled);</span>
<a href="#l6.198"></a><span id="l6.198">   amc.click(new elib.Elem(checkbox));</span>
<a href="#l6.199"></a><span id="l6.199">   utils.waitFor(</span>
<a href="#l6.200"></a><span id="l6.200">     () =&gt; !checkbox.checked,</span>
<a href="#l6.201"></a><span id="l6.201">     &quot;Archive checkbox didn't toggle to unchecked&quot;</span>
<a href="#l6.202"></a><span id="l6.202">   );</span>
<a href="#l6.203"></a><span id="l6.203">   plan_for_window_close(amc);</span>
<a href="#l6.204"></a><span id="l6.204">   amc.window.document.getElementById(&quot;accountManager&quot;).acceptDialog();</span>
<a href="#l6.205"></a><span id="l6.205">   wait_for_window_close();</span>
<a href="#l6.206"></a><span id="l6.206"> </span>
<a href="#l6.207"></a><span id="l6.207" class="difflineminus">-  assert_false(defaultIdentity.archiveEnabled);</span>
<a href="#l6.208"></a><span id="l6.208" class="difflineplus">+  Assert.ok(!defaultIdentity.archiveEnabled);</span>
<a href="#l6.209"></a><span id="l6.209"> }</span>
<a href="#l6.210"></a><span id="l6.210"> </span>
<a href="#l6.211"></a><span id="l6.211" class="difflineminus">-function test_disable_archive() {</span>
<a href="#l6.212"></a><span id="l6.212" class="difflineplus">+add_task(function test_disable_archive() {</span>
<a href="#l6.213"></a><span id="l6.213">   open_advanced_settings(subtest_disable_archive);</span>
<a href="#l6.214"></a><span id="l6.214" class="difflineminus">-}</span>
<a href="#l6.215"></a><span id="l6.215" class="difflineminus">-// Disable test on Windows since for some yet unknown reason clicking the checkbox</span>
<a href="#l6.216"></a><span id="l6.216" class="difflineminus">-// doesn't have the desired result. See bug 1461173 for details.</span>
<a href="#l6.217"></a><span id="l6.217" class="difflineminus">-test_disable_archive.EXCLUDED_PLATFORMS = [&quot;winnt&quot;];</span>
<a href="#l6.218"></a><span id="l6.218" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">copy from mail/test/mozmill/account/test-account-deletion.js</span>
<a href="#l7.2"></a><span id="l7.2">copy to mail/test/browser/account/browser_deletion.js</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineminus">--- a/mail/test/mozmill/account/test-account-deletion.js</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineplus">+++ b/mail/test/browser/account/browser_deletion.js</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineat">@@ -6,27 +6,24 @@</span>
<a href="#l7.6"></a><span id="l7.6">  * This test checks proper deletion of an account from the Account manager.</span>
<a href="#l7.7"></a><span id="l7.7">  */</span>
<a href="#l7.8"></a><span id="l7.8"> </span>
<a href="#l7.9"></a><span id="l7.9"> &quot;use strict&quot;;</span>
<a href="#l7.10"></a><span id="l7.10"> </span>
<a href="#l7.11"></a><span id="l7.11"> var { open_advanced_settings, remove_account } = ChromeUtils.import(</span>
<a href="#l7.12"></a><span id="l7.12">   &quot;resource://testing-common/mozmill/AccountManagerHelpers.jsm&quot;</span>
<a href="#l7.13"></a><span id="l7.13"> );</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-var { assert_equals, assert_false, assert_true } = ChromeUtils.import(</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-  &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-);</span>
<a href="#l7.17"></a><span id="l7.17"> </span>
<a href="#l7.18"></a><span id="l7.18"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l7.19"></a><span id="l7.19">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l7.20"></a><span id="l7.20"> );</span>
<a href="#l7.21"></a><span id="l7.21"> </span>
<a href="#l7.22"></a><span id="l7.22"> var gPopAccount, gImapAccount, gOriginalAccountCount;</span>
<a href="#l7.23"></a><span id="l7.23"> </span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-function setupModule(module) {</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l7.26"></a><span id="l7.26">   // There may be pre-existing accounts from other tests.</span>
<a href="#l7.27"></a><span id="l7.27">   gOriginalAccountCount = MailServices.accounts.allServers.length;</span>
<a href="#l7.28"></a><span id="l7.28"> </span>
<a href="#l7.29"></a><span id="l7.29">   // Create a POP server</span>
<a href="#l7.30"></a><span id="l7.30">   let popServer = MailServices.accounts</span>
<a href="#l7.31"></a><span id="l7.31">     .createIncomingServer(&quot;nobody&quot;, &quot;pop.foo.invalid&quot;, &quot;pop3&quot;)</span>
<a href="#l7.32"></a><span id="l7.32">     .QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l7.33"></a><span id="l7.33"> </span>
<a href="#l7.34"></a><span id="l7.34" class="difflineat">@@ -44,68 +41,68 @@ function setupModule(module) {</span>
<a href="#l7.35"></a><span id="l7.35"> </span>
<a href="#l7.36"></a><span id="l7.36">   identity = MailServices.accounts.createIdentity();</span>
<a href="#l7.37"></a><span id="l7.37">   identity.email = &quot;tinderbox@imap.foo.invalid&quot;;</span>
<a href="#l7.38"></a><span id="l7.38"> </span>
<a href="#l7.39"></a><span id="l7.39">   gImapAccount = MailServices.accounts.createAccount();</span>
<a href="#l7.40"></a><span id="l7.40">   gImapAccount.incomingServer = imapServer;</span>
<a href="#l7.41"></a><span id="l7.41">   gImapAccount.addIdentity(identity);</span>
<a href="#l7.42"></a><span id="l7.42"> </span>
<a href="#l7.43"></a><span id="l7.43" class="difflineminus">-  assert_equals(</span>
<a href="#l7.44"></a><span id="l7.44" class="difflineplus">+  Assert.equal(</span>
<a href="#l7.45"></a><span id="l7.45">     MailServices.accounts.allServers.length,</span>
<a href="#l7.46"></a><span id="l7.46">     gOriginalAccountCount + 2</span>
<a href="#l7.47"></a><span id="l7.47">   );</span>
<a href="#l7.48"></a><span id="l7.48" class="difflineminus">-}</span>
<a href="#l7.49"></a><span id="l7.49" class="difflineplus">+});</span>
<a href="#l7.50"></a><span id="l7.50"> </span>
<a href="#l7.51"></a><span id="l7.51" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l7.52"></a><span id="l7.52" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l7.53"></a><span id="l7.53">   // There should be only the original accounts left.</span>
<a href="#l7.54"></a><span id="l7.54" class="difflineminus">-  assert_equals(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l7.55"></a><span id="l7.55" class="difflineminus">-}</span>
<a href="#l7.56"></a><span id="l7.56" class="difflineplus">+  Assert.equal(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l7.57"></a><span id="l7.57" class="difflineplus">+});</span>
<a href="#l7.58"></a><span id="l7.58"> </span>
<a href="#l7.59"></a><span id="l7.59" class="difflineminus">-function test_account_data_deletion() {</span>
<a href="#l7.60"></a><span id="l7.60" class="difflineplus">+add_task(function test_account_data_deletion() {</span>
<a href="#l7.61"></a><span id="l7.61">   open_advanced_settings(function(amc) {</span>
<a href="#l7.62"></a><span id="l7.62">     subtest_account_data_deletion1(amc);</span>
<a href="#l7.63"></a><span id="l7.63">   });</span>
<a href="#l7.64"></a><span id="l7.64"> </span>
<a href="#l7.65"></a><span id="l7.65">   open_advanced_settings(function(amc) {</span>
<a href="#l7.66"></a><span id="l7.66">     subtest_account_data_deletion2(amc);</span>
<a href="#l7.67"></a><span id="l7.67">   });</span>
<a href="#l7.68"></a><span id="l7.68" class="difflineminus">-}</span>
<a href="#l7.69"></a><span id="l7.69" class="difflineplus">+});</span>
<a href="#l7.70"></a><span id="l7.70"> </span>
<a href="#l7.71"></a><span id="l7.71"> /**</span>
<a href="#l7.72"></a><span id="l7.72">  * Bug 274452</span>
<a href="#l7.73"></a><span id="l7.73">  * Check if files of an account are preserved.</span>
<a href="#l7.74"></a><span id="l7.74">  *</span>
<a href="#l7.75"></a><span id="l7.75">  * @param amc  The account options controller.</span>
<a href="#l7.76"></a><span id="l7.76">  */</span>
<a href="#l7.77"></a><span id="l7.77"> function subtest_account_data_deletion1(amc) {</span>
<a href="#l7.78"></a><span id="l7.78">   let accountDir = gPopAccount.incomingServer.localPath;</span>
<a href="#l7.79"></a><span id="l7.79" class="difflineminus">-  assert_true(accountDir.isDirectory());</span>
<a href="#l7.80"></a><span id="l7.80" class="difflineplus">+  Assert.ok(accountDir.isDirectory());</span>
<a href="#l7.81"></a><span id="l7.81"> </span>
<a href="#l7.82"></a><span id="l7.82">   // Get some existing file in the POP3 account data dir.</span>
<a href="#l7.83"></a><span id="l7.83">   let inboxFile = accountDir.clone();</span>
<a href="#l7.84"></a><span id="l7.84">   inboxFile.append(&quot;Inbox.msf&quot;);</span>
<a href="#l7.85"></a><span id="l7.85" class="difflineminus">-  assert_true(inboxFile.isFile());</span>
<a href="#l7.86"></a><span id="l7.86" class="difflineplus">+  Assert.ok(inboxFile.isFile());</span>
<a href="#l7.87"></a><span id="l7.87"> </span>
<a href="#l7.88"></a><span id="l7.88">   remove_account(gPopAccount, amc, true, false);</span>
<a href="#l7.89"></a><span id="l7.89">   gPopAccount = null;</span>
<a href="#l7.90"></a><span id="l7.90" class="difflineminus">-  assert_true(accountDir.exists());</span>
<a href="#l7.91"></a><span id="l7.91" class="difflineplus">+  Assert.ok(accountDir.exists());</span>
<a href="#l7.92"></a><span id="l7.92"> }</span>
<a href="#l7.93"></a><span id="l7.93"> </span>
<a href="#l7.94"></a><span id="l7.94"> /**</span>
<a href="#l7.95"></a><span id="l7.95">  * Bug 274452</span>
<a href="#l7.96"></a><span id="l7.96">  * Check if files of an account can be deleted.</span>
<a href="#l7.97"></a><span id="l7.97">  *</span>
<a href="#l7.98"></a><span id="l7.98">  * @param amc  The account options controller.</span>
<a href="#l7.99"></a><span id="l7.99">  */</span>
<a href="#l7.100"></a><span id="l7.100"> function subtest_account_data_deletion2(amc) {</span>
<a href="#l7.101"></a><span id="l7.101">   let accountDir = gImapAccount.incomingServer.localPath;</span>
<a href="#l7.102"></a><span id="l7.102" class="difflineminus">-  assert_true(accountDir.isDirectory());</span>
<a href="#l7.103"></a><span id="l7.103" class="difflineplus">+  Assert.ok(accountDir.isDirectory());</span>
<a href="#l7.104"></a><span id="l7.104"> </span>
<a href="#l7.105"></a><span id="l7.105">   // Get some file in the IMAP account data dir.</span>
<a href="#l7.106"></a><span id="l7.106">   let inboxFile = accountDir.clone();</span>
<a href="#l7.107"></a><span id="l7.107">   inboxFile.append(&quot;INBOX.msf&quot;);</span>
<a href="#l7.108"></a><span id="l7.108" class="difflineminus">-  assert_true(inboxFile.isFile());</span>
<a href="#l7.109"></a><span id="l7.109" class="difflineplus">+  Assert.ok(inboxFile.isFile());</span>
<a href="#l7.110"></a><span id="l7.110"> </span>
<a href="#l7.111"></a><span id="l7.111">   remove_account(gImapAccount, amc, true, true);</span>
<a href="#l7.112"></a><span id="l7.112">   gImapAccount = null;</span>
<a href="#l7.113"></a><span id="l7.113" class="difflineminus">-  assert_false(accountDir.exists());</span>
<a href="#l7.114"></a><span id="l7.114" class="difflineplus">+  Assert.ok(!accountDir.exists());</span>
<a href="#l7.115"></a><span id="l7.115"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">copy from mail/test/mozmill/account/test-mail-account-setup-wizard.js</span>
<a href="#l8.2"></a><span id="l8.2">copy to mail/test/browser/account/browser_mailAccountSetupWizard.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineminus">--- a/mail/test/mozmill/account/test-mail-account-setup-wizard.js</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineplus">+++ b/mail/test/browser/account/browser_mailAccountSetupWizard.js</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineat">@@ -1,25 +1,25 @@</span>
<a href="#l8.6"></a><span id="l8.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.7"></a><span id="l8.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l8.8"></a><span id="l8.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.9"></a><span id="l8.9"> </span>
<a href="#l8.10"></a><span id="l8.10"> &quot;use strict&quot;;</span>
<a href="#l8.11"></a><span id="l8.11"> </span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-var elib = ChromeUtils.import(</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineplus">+var elementslib = ChromeUtils.import(</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l8.16"></a><span id="l8.16"> );</span>
<a href="#l8.17"></a><span id="l8.17"> </span>
<a href="#l8.18"></a><span id="l8.18"> var {</span>
<a href="#l8.19"></a><span id="l8.19">   open_advanced_settings_from_account_wizard,</span>
<a href="#l8.20"></a><span id="l8.20">   open_mail_account_setup_wizard,</span>
<a href="#l8.21"></a><span id="l8.21"> } = ChromeUtils.import(</span>
<a href="#l8.22"></a><span id="l8.22">   &quot;resource://testing-common/mozmill/AccountManagerHelpers.jsm&quot;</span>
<a href="#l8.23"></a><span id="l8.23"> );</span>
<a href="#l8.24"></a><span id="l8.24" class="difflineminus">-var { assert_equals, mc } = ChromeUtils.import(</span>
<a href="#l8.25"></a><span id="l8.25" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l8.26"></a><span id="l8.26">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l8.27"></a><span id="l8.27"> );</span>
<a href="#l8.28"></a><span id="l8.28"> var { input_value, delete_all_existing } = ChromeUtils.import(</span>
<a href="#l8.29"></a><span id="l8.29">   &quot;resource://testing-common/mozmill/KeyboardHelpers.jsm&quot;</span>
<a href="#l8.30"></a><span id="l8.30"> );</span>
<a href="#l8.31"></a><span id="l8.31"> var { gMockPromptService } = ChromeUtils.import(</span>
<a href="#l8.32"></a><span id="l8.32">   &quot;resource://testing-common/mozmill/PromptHelpers.jsm&quot;</span>
<a href="#l8.33"></a><span id="l8.33"> );</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineat">@@ -32,16 +32,19 @@ var { MailServices } = ChromeUtils.impor</span>
<a href="#l8.35"></a><span id="l8.35"> var user = {</span>
<a href="#l8.36"></a><span id="l8.36">   name: &quot;Yamato Nadeshiko&quot;,</span>
<a href="#l8.37"></a><span id="l8.37">   email: &quot;yamato.nadeshiko@example.com&quot;,</span>
<a href="#l8.38"></a><span id="l8.38">   password: &quot;abc12345&quot;,</span>
<a href="#l8.39"></a><span id="l8.39">   incomingHost: &quot;testin.example.com&quot;,</span>
<a href="#l8.40"></a><span id="l8.40">   outgoingHost: &quot;testout.example.com&quot;,</span>
<a href="#l8.41"></a><span id="l8.41"> };</span>
<a href="#l8.42"></a><span id="l8.42"> </span>
<a href="#l8.43"></a><span id="l8.43" class="difflineplus">+const PREF_NAME = &quot;mailnews.auto_config_url&quot;;</span>
<a href="#l8.44"></a><span id="l8.44" class="difflineplus">+const PREF_VALUE = Services.prefs.getCharPref(PREF_NAME);</span>
<a href="#l8.45"></a><span id="l8.45" class="difflineplus">+</span>
<a href="#l8.46"></a><span id="l8.46"> // Remove an account in the Account Manager, but not via the UI.</span>
<a href="#l8.47"></a><span id="l8.47"> function remove_account_internal(amc, aAccount, aOutgoing) {</span>
<a href="#l8.48"></a><span id="l8.48">   let win = amc.window;</span>
<a href="#l8.49"></a><span id="l8.49"> </span>
<a href="#l8.50"></a><span id="l8.50">   try {</span>
<a href="#l8.51"></a><span id="l8.51">     // Remove the account and incoming server</span>
<a href="#l8.52"></a><span id="l8.52">     let serverId = aAccount.incomingServer.serverURI;</span>
<a href="#l8.53"></a><span id="l8.53">     MailServices.accounts.removeAccount(aAccount);</span>
<a href="#l8.54"></a><span id="l8.54" class="difflineat">@@ -55,24 +58,21 @@ function remove_account_internal(amc, aA</span>
<a href="#l8.55"></a><span id="l8.55">     let smtpKey = aOutgoing.key;</span>
<a href="#l8.56"></a><span id="l8.56">     MailServices.smtp.deleteServer(aOutgoing);</span>
<a href="#l8.57"></a><span id="l8.57">     win.replaceWithDefaultSmtpServer(smtpKey);</span>
<a href="#l8.58"></a><span id="l8.58">   } catch (ex) {</span>
<a href="#l8.59"></a><span id="l8.59">     throw new Error(&quot;failure to remove account: &quot; + ex + &quot;\n&quot;);</span>
<a href="#l8.60"></a><span id="l8.60">   }</span>
<a href="#l8.61"></a><span id="l8.61"> }</span>
<a href="#l8.62"></a><span id="l8.62"> </span>
<a href="#l8.63"></a><span id="l8.63" class="difflineminus">-function test_mail_account_setup() {</span>
<a href="#l8.64"></a><span id="l8.64" class="difflineplus">+add_task(function test_mail_account_setup() {</span>
<a href="#l8.65"></a><span id="l8.65">   // Set the pref to load a local autoconfig file.</span>
<a href="#l8.66"></a><span id="l8.66" class="difflineminus">-  let pref_name = &quot;mailnews.auto_config_url&quot;;</span>
<a href="#l8.67"></a><span id="l8.67" class="difflineminus">-  let url = collector.addHttpResource(&quot;../account/xml&quot;, &quot;autoconfig&quot;);</span>
<a href="#l8.68"></a><span id="l8.68" class="difflineminus">-  Services.prefs.setCharPref(pref_name, url);</span>
<a href="#l8.69"></a><span id="l8.69" class="difflineminus">-</span>
<a href="#l8.70"></a><span id="l8.70" class="difflineminus">-  // Force .com MIME-Type to text/xml</span>
<a href="#l8.71"></a><span id="l8.71" class="difflineminus">-  collector.httpd.registerContentType(&quot;com&quot;, &quot;text/xml&quot;);</span>
<a href="#l8.72"></a><span id="l8.72" class="difflineplus">+  let url =</span>
<a href="#l8.73"></a><span id="l8.73" class="difflineplus">+    &quot;http://mochi.test:8888/browser/comm/mail/test/browser/account/xml/&quot;;</span>
<a href="#l8.74"></a><span id="l8.74" class="difflineplus">+  Services.prefs.setCharPref(PREF_NAME, url);</span>
<a href="#l8.75"></a><span id="l8.75"> </span>
<a href="#l8.76"></a><span id="l8.76">   open_mail_account_setup_wizard(function(awc) {</span>
<a href="#l8.77"></a><span id="l8.77">     // Input user's account information</span>
<a href="#l8.78"></a><span id="l8.78">     awc.click(awc.eid(&quot;realname&quot;));</span>
<a href="#l8.79"></a><span id="l8.79">     if (awc.e(&quot;realname&quot;).value) {</span>
<a href="#l8.80"></a><span id="l8.80">       // If any realname is already filled, clear it out, we have our own.</span>
<a href="#l8.81"></a><span id="l8.81">       delete_all_existing(awc, awc.eid(&quot;realname&quot;));</span>
<a href="#l8.82"></a><span id="l8.82">     }</span>
<a href="#l8.83"></a><span id="l8.83" class="difflineat">@@ -98,23 +98,23 @@ function test_mail_account_setup() {</span>
<a href="#l8.84"></a><span id="l8.84">     gMockPromptService.returnValue = true;</span>
<a href="#l8.85"></a><span id="l8.85"> </span>
<a href="#l8.86"></a><span id="l8.86">     // Open the advanced settings (Account Manager) to create the account</span>
<a href="#l8.87"></a><span id="l8.87">     // immediately.  We use an invalid email/password so the setup will fail</span>
<a href="#l8.88"></a><span id="l8.88">     // anyway.</span>
<a href="#l8.89"></a><span id="l8.89">     open_advanced_settings_from_account_wizard(subtest_verify_account, awc);</span>
<a href="#l8.90"></a><span id="l8.90"> </span>
<a href="#l8.91"></a><span id="l8.91">     let promptState = gMockPromptService.promptState;</span>
<a href="#l8.92"></a><span id="l8.92" class="difflineminus">-    assert_equals(&quot;confirm&quot;, promptState.method);</span>
<a href="#l8.93"></a><span id="l8.93" class="difflineplus">+    Assert.equal(&quot;confirm&quot;, promptState.method);</span>
<a href="#l8.94"></a><span id="l8.94"> </span>
<a href="#l8.95"></a><span id="l8.95">     // Clean up</span>
<a href="#l8.96"></a><span id="l8.96">     gMockPromptService.unregister();</span>
<a href="#l8.97"></a><span id="l8.97" class="difflineminus">-    Services.prefs.clearUserPref(pref_name);</span>
<a href="#l8.98"></a><span id="l8.98" class="difflineplus">+    Services.prefs.setCharPref(PREF_NAME, PREF_VALUE);</span>
<a href="#l8.99"></a><span id="l8.99">   });</span>
<a href="#l8.100"></a><span id="l8.100" class="difflineminus">-}</span>
<a href="#l8.101"></a><span id="l8.101" class="difflineplus">+});</span>
<a href="#l8.102"></a><span id="l8.102"> </span>
<a href="#l8.103"></a><span id="l8.103"> function subtest_verify_account(amc) {</span>
<a href="#l8.104"></a><span id="l8.104">   amc.waitFor(</span>
<a href="#l8.105"></a><span id="l8.105">     () =&gt; amc.window.currentAccount != null,</span>
<a href="#l8.106"></a><span id="l8.106">     &quot;Timeout waiting for currentAccount to become non-null&quot;</span>
<a href="#l8.107"></a><span id="l8.107">   );</span>
<a href="#l8.108"></a><span id="l8.108">   let account = amc.window.currentAccount;</span>
<a href="#l8.109"></a><span id="l8.109">   let identity = account.defaultIdentity;</span>
<a href="#l8.110"></a><span id="l8.110" class="difflineat">@@ -162,26 +162,23 @@ function subtest_verify_account(amc) {</span>
<a href="#l8.111"></a><span id="l8.111">     remove_account_internal(amc, account, outgoing);</span>
<a href="#l8.112"></a><span id="l8.112">   }</span>
<a href="#l8.113"></a><span id="l8.113"> }</span>
<a href="#l8.114"></a><span id="l8.114"> </span>
<a href="#l8.115"></a><span id="l8.115"> /**</span>
<a href="#l8.116"></a><span id="l8.116">  * Make sure that we don't re-set the information we get from the config</span>
<a href="#l8.117"></a><span id="l8.117">  * file if the password is incorrect.</span>
<a href="#l8.118"></a><span id="l8.118">  */</span>
<a href="#l8.119"></a><span id="l8.119" class="difflineminus">-function test_bad_password_uses_old_settings() {</span>
<a href="#l8.120"></a><span id="l8.120" class="difflineplus">+add_task(function test_bad_password_uses_old_settings() {</span>
<a href="#l8.121"></a><span id="l8.121">   // Set the pref to load a local autoconfig file, that will fetch the</span>
<a href="#l8.122"></a><span id="l8.122">   // ../account/xml/example.com which contains the settings for the</span>
<a href="#l8.123"></a><span id="l8.123">   // @example.com email account (see the 'user' object).</span>
<a href="#l8.124"></a><span id="l8.124" class="difflineminus">-  let pref_name = &quot;mailnews.auto_config_url&quot;;</span>
<a href="#l8.125"></a><span id="l8.125" class="difflineminus">-  let url = collector.addHttpResource(&quot;../account/xml&quot;, &quot;autoconfig&quot;);</span>
<a href="#l8.126"></a><span id="l8.126" class="difflineminus">-  Services.prefs.setCharPref(pref_name, url);</span>
<a href="#l8.127"></a><span id="l8.127" class="difflineminus">-</span>
<a href="#l8.128"></a><span id="l8.128" class="difflineminus">-  // Force .com MIME-Type to text/xml</span>
<a href="#l8.129"></a><span id="l8.129" class="difflineminus">-  collector.httpd.registerContentType(&quot;com&quot;, &quot;text/xml&quot;);</span>
<a href="#l8.130"></a><span id="l8.130" class="difflineplus">+  let url =</span>
<a href="#l8.131"></a><span id="l8.131" class="difflineplus">+    &quot;http://mochi.test:8888/browser/comm/mail/test/browser/account/xml/&quot;;</span>
<a href="#l8.132"></a><span id="l8.132" class="difflineplus">+  Services.prefs.setCharPref(PREF_NAME, url);</span>
<a href="#l8.133"></a><span id="l8.133"> </span>
<a href="#l8.134"></a><span id="l8.134">   mc.sleep(0);</span>
<a href="#l8.135"></a><span id="l8.135">   open_mail_account_setup_wizard(function(awc) {</span>
<a href="#l8.136"></a><span id="l8.136">     try {</span>
<a href="#l8.137"></a><span id="l8.137">       // Input user's account information</span>
<a href="#l8.138"></a><span id="l8.138">       awc.click(awc.eid(&quot;realname&quot;));</span>
<a href="#l8.139"></a><span id="l8.139">       if (awc.e(&quot;realname&quot;).value) {</span>
<a href="#l8.140"></a><span id="l8.140">         // If any realname is already filled, clear it out, we have our own.</span>
<a href="#l8.141"></a><span id="l8.141" class="difflineat">@@ -216,38 +213,38 @@ function test_bad_password_uses_old_sett</span>
<a href="#l8.142"></a><span id="l8.142">         600,</span>
<a href="#l8.143"></a><span id="l8.143">         awc.e(&quot;create_button&quot;)</span>
<a href="#l8.144"></a><span id="l8.144">       );</span>
<a href="#l8.145"></a><span id="l8.145">       awc.e(&quot;create_button&quot;).click();</span>
<a href="#l8.146"></a><span id="l8.146">       awc.e(&quot;manual-edit_button&quot;).click();</span>
<a href="#l8.147"></a><span id="l8.147"> </span>
<a href="#l8.148"></a><span id="l8.148">       // Make sure all the values are the same as in the user object.</span>
<a href="#l8.149"></a><span id="l8.149">       awc.sleep(1000);</span>
<a href="#l8.150"></a><span id="l8.150" class="difflineminus">-      assert_equals(</span>
<a href="#l8.151"></a><span id="l8.151" class="difflineplus">+      Assert.equal(</span>
<a href="#l8.152"></a><span id="l8.152">         awc.e(&quot;outgoing_hostname&quot;).value,</span>
<a href="#l8.153"></a><span id="l8.153">         user.outgoingHost,</span>
<a href="#l8.154"></a><span id="l8.154">         &quot;Outgoing server changed!&quot;</span>
<a href="#l8.155"></a><span id="l8.155">       );</span>
<a href="#l8.156"></a><span id="l8.156" class="difflineminus">-      assert_equals(</span>
<a href="#l8.157"></a><span id="l8.157" class="difflineplus">+      Assert.equal(</span>
<a href="#l8.158"></a><span id="l8.158">         awc.e(&quot;incoming_hostname&quot;).value,</span>
<a href="#l8.159"></a><span id="l8.159">         user.incomingHost,</span>
<a href="#l8.160"></a><span id="l8.160">         &quot;incoming server changed!&quot;</span>
<a href="#l8.161"></a><span id="l8.161">       );</span>
<a href="#l8.162"></a><span id="l8.162">     } finally {</span>
<a href="#l8.163"></a><span id="l8.163">       // Clean up</span>
<a href="#l8.164"></a><span id="l8.164" class="difflineminus">-      Services.prefs.clearUserPref(pref_name);</span>
<a href="#l8.165"></a><span id="l8.165" class="difflineplus">+      Services.prefs.setCharPref(PREF_NAME, PREF_VALUE);</span>
<a href="#l8.166"></a><span id="l8.166">       awc.e(&quot;cancel_button&quot;).click();</span>
<a href="#l8.167"></a><span id="l8.167">     }</span>
<a href="#l8.168"></a><span id="l8.168">   });</span>
<a href="#l8.169"></a><span id="l8.169" class="difflineminus">-}</span>
<a href="#l8.170"></a><span id="l8.170" class="difflineplus">+});</span>
<a href="#l8.171"></a><span id="l8.171"> </span>
<a href="#l8.172"></a><span id="l8.172" class="difflineminus">-function test_remember_password() {</span>
<a href="#l8.173"></a><span id="l8.173" class="difflineplus">+add_task(function test_remember_password() {</span>
<a href="#l8.174"></a><span id="l8.174">   remember_password_test(true);</span>
<a href="#l8.175"></a><span id="l8.175">   remember_password_test(false);</span>
<a href="#l8.176"></a><span id="l8.176" class="difflineminus">-}</span>
<a href="#l8.177"></a><span id="l8.177" class="difflineplus">+});</span>
<a href="#l8.178"></a><span id="l8.178"> </span>
<a href="#l8.179"></a><span id="l8.179"> /**</span>
<a href="#l8.180"></a><span id="l8.180">  * Test remember_password checkbox behavior with</span>
<a href="#l8.181"></a><span id="l8.181">  * signon.rememberSignons set to &quot;aPrefValue&quot;</span>
<a href="#l8.182"></a><span id="l8.182">  */</span>
<a href="#l8.183"></a><span id="l8.183"> function remember_password_test(aPrefValue) {</span>
<a href="#l8.184"></a><span id="l8.184">   // save the pref for backup purpose</span>
<a href="#l8.185"></a><span id="l8.185">   let rememberSignons_pref_save = Services.prefs.getBoolPref(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">copy from mail/test/mozmill/account/test-account-port-setting.js</span>
<a href="#l9.2"></a><span id="l9.2">copy to mail/test/browser/account/browser_portSetting.js</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineminus">--- a/mail/test/mozmill/account/test-account-port-setting.js</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineplus">+++ b/mail/test/browser/account/browser_portSetting.js</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l9.6"></a><span id="l9.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.7"></a><span id="l9.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l9.8"></a><span id="l9.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l9.9"></a><span id="l9.9"> </span>
<a href="#l9.10"></a><span id="l9.10"> &quot;use strict&quot;;</span>
<a href="#l9.11"></a><span id="l9.11"> </span>
<a href="#l9.12"></a><span id="l9.12"> var elib = ChromeUtils.import(</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l9.15"></a><span id="l9.15"> );</span>
<a href="#l9.16"></a><span id="l9.16"> </span>
<a href="#l9.17"></a><span id="l9.17"> var {</span>
<a href="#l9.18"></a><span id="l9.18">   click_account_tree_row,</span>
<a href="#l9.19"></a><span id="l9.19">   get_account_tree_row,</span>
<a href="#l9.20"></a><span id="l9.20">   open_advanced_settings,</span>
<a href="#l9.21"></a><span id="l9.21"> } = ChromeUtils.import(</span>
<a href="#l9.22"></a><span id="l9.22">   &quot;resource://testing-common/mozmill/AccountManagerHelpers.jsm&quot;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineat">@@ -74,19 +74,26 @@ function subtest_check_set_port_number(a</span>
<a href="#l9.24"></a><span id="l9.24">     )</span>
<a href="#l9.25"></a><span id="l9.25">   );</span>
<a href="#l9.26"></a><span id="l9.26"> }</span>
<a href="#l9.27"></a><span id="l9.27"> </span>
<a href="#l9.28"></a><span id="l9.28"> function subtest_check_port_number(amc) {</span>
<a href="#l9.29"></a><span id="l9.29">   subtest_check_set_port_number(amc, true);</span>
<a href="#l9.30"></a><span id="l9.30"> }</span>
<a href="#l9.31"></a><span id="l9.31"> </span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-function test_account_port_setting() {</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineplus">+add_task(function test_account_port_setting() {</span>
<a href="#l9.34"></a><span id="l9.34">   for (</span>
<a href="#l9.35"></a><span id="l9.35">     gTestNumber = 1;</span>
<a href="#l9.36"></a><span id="l9.36">     gTestNumber &lt; PORT_NUMBERS_TO_TEST.length;</span>
<a href="#l9.37"></a><span id="l9.37">     ++gTestNumber</span>
<a href="#l9.38"></a><span id="l9.38">   ) {</span>
<a href="#l9.39"></a><span id="l9.39">     open_advanced_settings(subtest_check_set_port_number);</span>
<a href="#l9.40"></a><span id="l9.40">   }</span>
<a href="#l9.41"></a><span id="l9.41"> </span>
<a href="#l9.42"></a><span id="l9.42">   open_advanced_settings(subtest_check_port_number);</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineminus">-}</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+  Assert.report(</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+    false,</span>
<a href="#l9.47"></a><span id="l9.47" class="difflineplus">+    undefined,</span>
<a href="#l9.48"></a><span id="l9.48" class="difflineplus">+    undefined,</span>
<a href="#l9.49"></a><span id="l9.49" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l9.50"></a><span id="l9.50" class="difflineplus">+  );</span>
<a href="#l9.51"></a><span id="l9.51" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">copy from mail/test/mozmill/account/test-retest-config.js</span>
<a href="#l10.2"></a><span id="l10.2">copy to mail/test/browser/account/browser_retestConfig.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineminus">--- a/mail/test/mozmill/account/test-retest-config.js</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineplus">+++ b/mail/test/browser/account/browser_retestConfig.js</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineat">@@ -1,22 +1,22 @@</span>
<a href="#l10.6"></a><span id="l10.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.7"></a><span id="l10.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l10.8"></a><span id="l10.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.9"></a><span id="l10.9"> </span>
<a href="#l10.10"></a><span id="l10.10"> &quot;use strict&quot;;</span>
<a href="#l10.11"></a><span id="l10.11"> </span>
<a href="#l10.12"></a><span id="l10.12"> var elib = ChromeUtils.import(</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l10.15"></a><span id="l10.15"> );</span>
<a href="#l10.16"></a><span id="l10.16"> </span>
<a href="#l10.17"></a><span id="l10.17"> var { open_mail_account_setup_wizard } = ChromeUtils.import(</span>
<a href="#l10.18"></a><span id="l10.18">   &quot;resource://testing-common/mozmill/AccountManagerHelpers.jsm&quot;</span>
<a href="#l10.19"></a><span id="l10.19"> );</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-var { assert_true, mc } = ChromeUtils.import(</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l10.22"></a><span id="l10.22">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l10.23"></a><span id="l10.23"> );</span>
<a href="#l10.24"></a><span id="l10.24"> var { input_value, delete_all_existing } = ChromeUtils.import(</span>
<a href="#l10.25"></a><span id="l10.25">   &quot;resource://testing-common/mozmill/KeyboardHelpers.jsm&quot;</span>
<a href="#l10.26"></a><span id="l10.26"> );</span>
<a href="#l10.27"></a><span id="l10.27"> var { close_window } = ChromeUtils.import(</span>
<a href="#l10.28"></a><span id="l10.28">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l10.29"></a><span id="l10.29"> );</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineat">@@ -24,30 +24,33 @@ var { close_window } = ChromeUtils.impor</span>
<a href="#l10.31"></a><span id="l10.31"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.32"></a><span id="l10.32"> </span>
<a href="#l10.33"></a><span id="l10.33"> var user = {</span>
<a href="#l10.34"></a><span id="l10.34">   name: &quot;test&quot;,</span>
<a href="#l10.35"></a><span id="l10.35">   email: &quot;test@momo.invalid&quot;,</span>
<a href="#l10.36"></a><span id="l10.36">   altEmail: &quot;test2@momo.invalid&quot;,</span>
<a href="#l10.37"></a><span id="l10.37"> };</span>
<a href="#l10.38"></a><span id="l10.38"> </span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-function setupModule(module) {</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineplus">+const PREF_NAME = &quot;mailnews.auto_config_url&quot;;</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineplus">+const PREF_VALUE = Services.prefs.getCharPref(PREF_NAME);</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineplus">+</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l10.44"></a><span id="l10.44">   Services.prefs.setCharPref(&quot;mail.wizard.logging.dump&quot;, &quot;All&quot;);</span>
<a href="#l10.45"></a><span id="l10.45"> </span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-  let url = collector.addHttpResource(&quot;../account/xml&quot;, &quot;accountconfig&quot;);</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-  Services.prefs.setCharPref(&quot;mailnews.auto_config_url&quot;, url);</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-  collector.httpd.registerContentType(&quot;invalid&quot;, &quot;text/xml&quot;);</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-}</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineplus">+  let url =</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineplus">+    &quot;http://mochi.test:8888/browser/comm/mail/test/browser/account/xml/&quot;;</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineplus">+  Services.prefs.setCharPref(PREF_NAME, url);</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineplus">+});</span>
<a href="#l10.54"></a><span id="l10.54"> </span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-function tearDownModule(module) {</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-  Services.prefs.clearUserPref(&quot;mailnews.auto_config_url&quot;);</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineplus">+  Services.prefs.setCharPref(PREF_NAME, PREF_VALUE);</span>
<a href="#l10.59"></a><span id="l10.59">   Services.prefs.clearUserPref(&quot;mail.wizard.logging.dump&quot;);</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-}</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineplus">+});</span>
<a href="#l10.62"></a><span id="l10.62"> </span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-function test_re_test_config() {</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineplus">+add_task(function test_re_test_config() {</span>
<a href="#l10.65"></a><span id="l10.65">   // Opening multiple windows in the same run seems to require letting the stack</span>
<a href="#l10.66"></a><span id="l10.66">   // unwind before opening the next one, so do that here.</span>
<a href="#l10.67"></a><span id="l10.67">   mc.sleep(0);</span>
<a href="#l10.68"></a><span id="l10.68">   open_mail_account_setup_wizard(function(awc) {</span>
<a href="#l10.69"></a><span id="l10.69">     // Input user's account information</span>
<a href="#l10.70"></a><span id="l10.70">     awc.click(awc.eid(&quot;realname&quot;));</span>
<a href="#l10.71"></a><span id="l10.71">     if (awc.e(&quot;realname&quot;).value) {</span>
<a href="#l10.72"></a><span id="l10.72">       // If any realname is already filled, clear it out, we have our own.</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineat">@@ -106,16 +109,16 @@ function test_re_test_config() {</span>
<a href="#l10.74"></a><span id="l10.74">       awc.e(&quot;next_button&quot;)</span>
<a href="#l10.75"></a><span id="l10.75">     );</span>
<a href="#l10.76"></a><span id="l10.76"> </span>
<a href="#l10.77"></a><span id="l10.77">     awc.e(&quot;next_button&quot;).click();</span>
<a href="#l10.78"></a><span id="l10.78"> </span>
<a href="#l10.79"></a><span id="l10.79">     // Previously, we'd switched to the manual editing state. Now we've started</span>
<a href="#l10.80"></a><span id="l10.80">     // over, we should make sure the information is presented back in its original</span>
<a href="#l10.81"></a><span id="l10.81">     // &quot;automatic&quot; mode.</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-    assert_true(</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineplus">+    Assert.ok(</span>
<a href="#l10.84"></a><span id="l10.84">       awc.e(&quot;manual-edit_area&quot;).hidden,</span>
<a href="#l10.85"></a><span id="l10.85">       &quot;We're not back to the original state!&quot;</span>
<a href="#l10.86"></a><span id="l10.86">     );</span>
<a href="#l10.87"></a><span id="l10.87"> </span>
<a href="#l10.88"></a><span id="l10.88">     close_window(awc);</span>
<a href="#l10.89"></a><span id="l10.89">   });</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-}</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">copy from mail/test/mozmill/account/test-account-settings-infrastructure.js</span>
<a href="#l11.2"></a><span id="l11.2">copy to mail/test/browser/account/browser_settingsInfrastructure.js</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineminus">--- a/mail/test/mozmill/account/test-account-settings-infrastructure.js</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineplus">+++ b/mail/test/browser/account/browser_settingsInfrastructure.js</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineat">@@ -8,43 +8,38 @@</span>
<a href="#l11.6"></a><span id="l11.6">  * panes are switched.</span>
<a href="#l11.7"></a><span id="l11.7">  *</span>
<a href="#l11.8"></a><span id="l11.8">  * New checks can be added to it as needed.</span>
<a href="#l11.9"></a><span id="l11.9">  */</span>
<a href="#l11.10"></a><span id="l11.10"> </span>
<a href="#l11.11"></a><span id="l11.11"> &quot;use strict&quot;;</span>
<a href="#l11.12"></a><span id="l11.12"> </span>
<a href="#l11.13"></a><span id="l11.13"> var elib = ChromeUtils.import(</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l11.16"></a><span id="l11.16"> );</span>
<a href="#l11.17"></a><span id="l11.17"> </span>
<a href="#l11.18"></a><span id="l11.18"> var {</span>
<a href="#l11.19"></a><span id="l11.19">   click_account_tree_row,</span>
<a href="#l11.20"></a><span id="l11.20">   get_account_tree_row,</span>
<a href="#l11.21"></a><span id="l11.21">   open_advanced_settings,</span>
<a href="#l11.22"></a><span id="l11.22"> } = ChromeUtils.import(</span>
<a href="#l11.23"></a><span id="l11.23">   &quot;resource://testing-common/mozmill/AccountManagerHelpers.jsm&quot;</span>
<a href="#l11.24"></a><span id="l11.24"> );</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-var {</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-  assert_equals,</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-  assert_false,</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-  assert_true,</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-  FAKE_SERVER_HOSTNAME,</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-} = ChromeUtils.import(</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineplus">+var { FAKE_SERVER_HOSTNAME } = ChromeUtils.import(</span>
<a href="#l11.32"></a><span id="l11.32">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l11.33"></a><span id="l11.33"> );</span>
<a href="#l11.34"></a><span id="l11.34"> </span>
<a href="#l11.35"></a><span id="l11.35"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l11.36"></a><span id="l11.36">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l11.37"></a><span id="l11.37"> );</span>
<a href="#l11.38"></a><span id="l11.38"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l11.39"></a><span id="l11.39"> </span>
<a href="#l11.40"></a><span id="l11.40"> var gPopAccount, gImapAccount, gOriginalAccountCount;</span>
<a href="#l11.41"></a><span id="l11.41"> </span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-function setupModule(module) {</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l11.44"></a><span id="l11.44">   // There may be pre-existing accounts from other tests.</span>
<a href="#l11.45"></a><span id="l11.45">   gOriginalAccountCount = MailServices.accounts.allServers.length;</span>
<a href="#l11.46"></a><span id="l11.46"> </span>
<a href="#l11.47"></a><span id="l11.47">   // Create a POP server</span>
<a href="#l11.48"></a><span id="l11.48">   let popServer = MailServices.accounts</span>
<a href="#l11.49"></a><span id="l11.49">     .createIncomingServer(&quot;nobody&quot;, &quot;pop.invalid&quot;, &quot;pop3&quot;)</span>
<a href="#l11.50"></a><span id="l11.50">     .QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l11.51"></a><span id="l11.51"> </span>
<a href="#l11.52"></a><span id="l11.52" class="difflineat">@@ -63,96 +58,96 @@ function setupModule(module) {</span>
<a href="#l11.53"></a><span id="l11.53">   identity = MailServices.accounts.createIdentity();</span>
<a href="#l11.54"></a><span id="l11.54">   identity.email = &quot;tinderbox@imap.invalid&quot;;</span>
<a href="#l11.55"></a><span id="l11.55"> </span>
<a href="#l11.56"></a><span id="l11.56">   gImapAccount = MailServices.accounts.createAccount();</span>
<a href="#l11.57"></a><span id="l11.57">   gImapAccount.incomingServer = imapServer;</span>
<a href="#l11.58"></a><span id="l11.58">   gImapAccount.addIdentity(identity);</span>
<a href="#l11.59"></a><span id="l11.59"> </span>
<a href="#l11.60"></a><span id="l11.60">   // Now there should be one more account.</span>
<a href="#l11.61"></a><span id="l11.61" class="difflineminus">-  assert_equals(</span>
<a href="#l11.62"></a><span id="l11.62" class="difflineplus">+  Assert.equal(</span>
<a href="#l11.63"></a><span id="l11.63">     MailServices.accounts.allServers.length,</span>
<a href="#l11.64"></a><span id="l11.64">     gOriginalAccountCount + 2</span>
<a href="#l11.65"></a><span id="l11.65">   );</span>
<a href="#l11.66"></a><span id="l11.66" class="difflineminus">-}</span>
<a href="#l11.67"></a><span id="l11.67" class="difflineplus">+});</span>
<a href="#l11.68"></a><span id="l11.68"> </span>
<a href="#l11.69"></a><span id="l11.69" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l11.70"></a><span id="l11.70" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l11.71"></a><span id="l11.71">   // Remove our test accounts to leave the profile clean.</span>
<a href="#l11.72"></a><span id="l11.72">   MailServices.accounts.removeAccount(gPopAccount);</span>
<a href="#l11.73"></a><span id="l11.73">   MailServices.accounts.removeAccount(gImapAccount);</span>
<a href="#l11.74"></a><span id="l11.74"> </span>
<a href="#l11.75"></a><span id="l11.75">   // There should be only the original accounts left.</span>
<a href="#l11.76"></a><span id="l11.76" class="difflineminus">-  assert_equals(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l11.77"></a><span id="l11.77" class="difflineminus">-}</span>
<a href="#l11.78"></a><span id="l11.78" class="difflineplus">+  Assert.equal(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l11.79"></a><span id="l11.79" class="difflineplus">+});</span>
<a href="#l11.80"></a><span id="l11.80"> </span>
<a href="#l11.81"></a><span id="l11.81"> /**</span>
<a href="#l11.82"></a><span id="l11.82">  * Bug 525024.</span>
<a href="#l11.83"></a><span id="l11.83">  * Check that the options in the server pane are properly preserved across</span>
<a href="#l11.84"></a><span id="l11.84">  * pane switches.</span>
<a href="#l11.85"></a><span id="l11.85">  */</span>
<a href="#l11.86"></a><span id="l11.86" class="difflineminus">-function test_account_dot_IDs() {</span>
<a href="#l11.87"></a><span id="l11.87" class="difflineplus">+add_task(function test_account_dot_IDs() {</span>
<a href="#l11.88"></a><span id="l11.88">   open_advanced_settings(function(amc) {</span>
<a href="#l11.89"></a><span id="l11.89">     subtest_check_account_dot_IDs(amc);</span>
<a href="#l11.90"></a><span id="l11.90">   });</span>
<a href="#l11.91"></a><span id="l11.91" class="difflineminus">-}</span>
<a href="#l11.92"></a><span id="l11.92" class="difflineplus">+});</span>
<a href="#l11.93"></a><span id="l11.93"> </span>
<a href="#l11.94"></a><span id="l11.94"> /**</span>
<a href="#l11.95"></a><span id="l11.95">  * Check that the options in the server pane are stored even if the id</span>
<a href="#l11.96"></a><span id="l11.96">  * of the element contains multiple dots (not used in standard TB yet</span>
<a href="#l11.97"></a><span id="l11.97">  * but extensions may want it).</span>
<a href="#l11.98"></a><span id="l11.98">  *</span>
<a href="#l11.99"></a><span id="l11.99">  * @param amc  the account options controller</span>
<a href="#l11.100"></a><span id="l11.100">  */</span>
<a href="#l11.101"></a><span id="l11.101"> function subtest_check_account_dot_IDs(amc) {</span>
<a href="#l11.102"></a><span id="l11.102">   let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l11.103"></a><span id="l11.103">   click_account_tree_row(amc, accountRow);</span>
<a href="#l11.104"></a><span id="l11.104"> </span>
<a href="#l11.105"></a><span id="l11.105">   let iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l11.106"></a><span id="l11.106">   // Check whether a standard element with &quot;server.loginAtStartUp&quot; stores its</span>
<a href="#l11.107"></a><span id="l11.107">   // value properly.</span>
<a href="#l11.108"></a><span id="l11.108">   let loginCheck = iframe.getElementById(&quot;server.loginAtStartUp&quot;);</span>
<a href="#l11.109"></a><span id="l11.109" class="difflineminus">-  assert_false(loginCheck.checked);</span>
<a href="#l11.110"></a><span id="l11.110" class="difflineplus">+  Assert.ok(!loginCheck.checked);</span>
<a href="#l11.111"></a><span id="l11.111">   amc.check(new elib.Elem(loginCheck), true);</span>
<a href="#l11.112"></a><span id="l11.112"> </span>
<a href="#l11.113"></a><span id="l11.113">   accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l11.114"></a><span id="l11.114">   click_account_tree_row(amc, accountRow);</span>
<a href="#l11.115"></a><span id="l11.115"> </span>
<a href="#l11.116"></a><span id="l11.116">   accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l11.117"></a><span id="l11.117">   click_account_tree_row(amc, accountRow);</span>
<a href="#l11.118"></a><span id="l11.118"> </span>
<a href="#l11.119"></a><span id="l11.119">   // Re-assign iframe.contentDocument because it was lost when changing panes</span>
<a href="#l11.120"></a><span id="l11.120">   // (uses loadURI to load a new document).</span>
<a href="#l11.121"></a><span id="l11.121">   iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l11.122"></a><span id="l11.122"> </span>
<a href="#l11.123"></a><span id="l11.123">   // Check by element properties.</span>
<a href="#l11.124"></a><span id="l11.124">   loginCheck = iframe.getElementById(&quot;server.loginAtStartUp&quot;);</span>
<a href="#l11.125"></a><span id="l11.125" class="difflineminus">-  assert_true(loginCheck.checked);</span>
<a href="#l11.126"></a><span id="l11.126" class="difflineplus">+  Assert.ok(loginCheck.checked);</span>
<a href="#l11.127"></a><span id="l11.127"> </span>
<a href="#l11.128"></a><span id="l11.128">   // Check for correct value in the accountValues array, that will be saved into prefs.</span>
<a href="#l11.129"></a><span id="l11.129">   let rawCheckValue = amc.window.getAccountValue(</span>
<a href="#l11.130"></a><span id="l11.130">     gPopAccount,</span>
<a href="#l11.131"></a><span id="l11.131">     amc.window.getValueArrayFor(gPopAccount),</span>
<a href="#l11.132"></a><span id="l11.132">     &quot;server&quot;,</span>
<a href="#l11.133"></a><span id="l11.133">     &quot;loginAtStartUp&quot;,</span>
<a href="#l11.134"></a><span id="l11.134">     null,</span>
<a href="#l11.135"></a><span id="l11.135">     false</span>
<a href="#l11.136"></a><span id="l11.136">   );</span>
<a href="#l11.137"></a><span id="l11.137"> </span>
<a href="#l11.138"></a><span id="l11.138" class="difflineminus">-  assert_true(rawCheckValue);</span>
<a href="#l11.139"></a><span id="l11.139" class="difflineplus">+  Assert.ok(rawCheckValue);</span>
<a href="#l11.140"></a><span id="l11.140"> </span>
<a href="#l11.141"></a><span id="l11.141">   // The &quot;server.login.At.StartUp&quot; value does not exist yet, so the value should be 'null'.</span>
<a href="#l11.142"></a><span id="l11.142">   rawCheckValue = amc.window.getAccountValue(</span>
<a href="#l11.143"></a><span id="l11.143">     gPopAccount,</span>
<a href="#l11.144"></a><span id="l11.144">     amc.window.getValueArrayFor(gPopAccount),</span>
<a href="#l11.145"></a><span id="l11.145">     &quot;server&quot;,</span>
<a href="#l11.146"></a><span id="l11.146">     &quot;login.At.StartUp&quot;,</span>
<a href="#l11.147"></a><span id="l11.147">     null,</span>
<a href="#l11.148"></a><span id="l11.148">     false</span>
<a href="#l11.149"></a><span id="l11.149">   );</span>
<a href="#l11.150"></a><span id="l11.150" class="difflineminus">-  assert_equals(rawCheckValue, null);</span>
<a href="#l11.151"></a><span id="l11.151" class="difflineplus">+  Assert.equal(rawCheckValue, null);</span>
<a href="#l11.152"></a><span id="l11.152"> </span>
<a href="#l11.153"></a><span id="l11.153">   // Change the ID so that &quot;server.login.At.StartUp&quot; exists now.</span>
<a href="#l11.154"></a><span id="l11.154">   loginCheck.id = &quot;server.login.At.StartUp&quot;;</span>
<a href="#l11.155"></a><span id="l11.155"> </span>
<a href="#l11.156"></a><span id="l11.156">   accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l11.157"></a><span id="l11.157">   click_account_tree_row(amc, accountRow);</span>
<a href="#l11.158"></a><span id="l11.158"> </span>
<a href="#l11.159"></a><span id="l11.159">   accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l11.160"></a><span id="l11.160" class="difflineat">@@ -165,32 +160,32 @@ function subtest_check_account_dot_IDs(a</span>
<a href="#l11.161"></a><span id="l11.161">     gPopAccount,</span>
<a href="#l11.162"></a><span id="l11.162">     amc.window.getValueArrayFor(gPopAccount),</span>
<a href="#l11.163"></a><span id="l11.163">     &quot;server&quot;,</span>
<a href="#l11.164"></a><span id="l11.164">     &quot;login.At.StartUp&quot;,</span>
<a href="#l11.165"></a><span id="l11.165">     null,</span>
<a href="#l11.166"></a><span id="l11.166">     false</span>
<a href="#l11.167"></a><span id="l11.167">   );</span>
<a href="#l11.168"></a><span id="l11.168"> </span>
<a href="#l11.169"></a><span id="l11.169" class="difflineminus">-  assert_true(rawCheckValue);</span>
<a href="#l11.170"></a><span id="l11.170" class="difflineplus">+  Assert.ok(rawCheckValue);</span>
<a href="#l11.171"></a><span id="l11.171"> }</span>
<a href="#l11.172"></a><span id="l11.172"> </span>
<a href="#l11.173"></a><span id="l11.173"> /**</span>
<a href="#l11.174"></a><span id="l11.174">  * Test for bug 807101.</span>
<a href="#l11.175"></a><span id="l11.175">  * Check if form controls are properly disabled when their attached prefs are locked.</span>
<a href="#l11.176"></a><span id="l11.176">  */</span>
<a href="#l11.177"></a><span id="l11.177" class="difflineminus">-function test_account_locked_prefs() {</span>
<a href="#l11.178"></a><span id="l11.178" class="difflineplus">+add_task(function test_account_locked_prefs() {</span>
<a href="#l11.179"></a><span id="l11.179">   open_advanced_settings(function(amc) {</span>
<a href="#l11.180"></a><span id="l11.180">     subtest_check_locked_prefs_addressing(amc);</span>
<a href="#l11.181"></a><span id="l11.181">   });</span>
<a href="#l11.182"></a><span id="l11.182"> </span>
<a href="#l11.183"></a><span id="l11.183">   open_advanced_settings(function(amc) {</span>
<a href="#l11.184"></a><span id="l11.184">     subtest_check_locked_prefs_server(amc);</span>
<a href="#l11.185"></a><span id="l11.185">   });</span>
<a href="#l11.186"></a><span id="l11.186" class="difflineminus">-}</span>
<a href="#l11.187"></a><span id="l11.187" class="difflineplus">+});</span>
<a href="#l11.188"></a><span id="l11.188"> </span>
<a href="#l11.189"></a><span id="l11.189"> /**</span>
<a href="#l11.190"></a><span id="l11.190">  * Check that the LDAP server selection elements (radio group) are properly</span>
<a href="#l11.191"></a><span id="l11.191">  * disabled when their attached pref (prefstring attribute) is locked.</span>
<a href="#l11.192"></a><span id="l11.192">  *</span>
<a href="#l11.193"></a><span id="l11.193">  * @param amc  the account options controller</span>
<a href="#l11.194"></a><span id="l11.194">  */</span>
<a href="#l11.195"></a><span id="l11.195"> function subtest_check_locked_prefs_addressing(amc) {</span>
<a href="#l11.196"></a><span id="l11.196" class="difflineat">@@ -201,31 +196,31 @@ function subtest_check_locked_prefs_addr</span>
<a href="#l11.197"></a><span id="l11.197">   );</span>
<a href="#l11.198"></a><span id="l11.198">   click_account_tree_row(amc, accountRow);</span>
<a href="#l11.199"></a><span id="l11.199"> </span>
<a href="#l11.200"></a><span id="l11.200">   let iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l11.201"></a><span id="l11.201"> </span>
<a href="#l11.202"></a><span id="l11.202">   // By default, 'use global LDAP server preferences' is set, not the</span>
<a href="#l11.203"></a><span id="l11.203">   // 'different LDAP server'.</span>
<a href="#l11.204"></a><span id="l11.204">   let useLDAPdirectory = iframe.getElementById(&quot;directories&quot;);</span>
<a href="#l11.205"></a><span id="l11.205" class="difflineminus">-  assert_false(useLDAPdirectory.selected);</span>
<a href="#l11.206"></a><span id="l11.206" class="difflineplus">+  Assert.ok(!useLDAPdirectory.selected);</span>
<a href="#l11.207"></a><span id="l11.207"> </span>
<a href="#l11.208"></a><span id="l11.208">   // So the server selector is disabled.</span>
<a href="#l11.209"></a><span id="l11.209">   let LDAPdirectory = iframe.getElementById(&quot;identity.directoryServer&quot;);</span>
<a href="#l11.210"></a><span id="l11.210" class="difflineminus">-  assert_true(LDAPdirectory.disabled);</span>
<a href="#l11.211"></a><span id="l11.211" class="difflineplus">+  Assert.ok(LDAPdirectory.disabled);</span>
<a href="#l11.212"></a><span id="l11.212"> </span>
<a href="#l11.213"></a><span id="l11.213">   // And the Edit button too.</span>
<a href="#l11.214"></a><span id="l11.214">   let LDAPeditButton = iframe.getElementById(&quot;editButton&quot;);</span>
<a href="#l11.215"></a><span id="l11.215" class="difflineminus">-  assert_true(LDAPeditButton.disabled);</span>
<a href="#l11.216"></a><span id="l11.216" class="difflineplus">+  Assert.ok(LDAPeditButton.disabled);</span>
<a href="#l11.217"></a><span id="l11.217"> </span>
<a href="#l11.218"></a><span id="l11.218">   // Now toggle the 'different LDAP server' on. The server selector</span>
<a href="#l11.219"></a><span id="l11.219">   // and edit button should enable.</span>
<a href="#l11.220"></a><span id="l11.220">   amc.radio(new elib.Elem(useLDAPdirectory));</span>
<a href="#l11.221"></a><span id="l11.221" class="difflineminus">-  assert_false(LDAPdirectory.disabled);</span>
<a href="#l11.222"></a><span id="l11.222" class="difflineminus">-  assert_false(LDAPeditButton.disabled);</span>
<a href="#l11.223"></a><span id="l11.223" class="difflineplus">+  Assert.ok(!LDAPdirectory.disabled);</span>
<a href="#l11.224"></a><span id="l11.224" class="difflineplus">+  Assert.ok(!LDAPeditButton.disabled);</span>
<a href="#l11.225"></a><span id="l11.225"> </span>
<a href="#l11.226"></a><span id="l11.226">   // Lock the pref for the server selector.</span>
<a href="#l11.227"></a><span id="l11.227">   let prefstring = LDAPdirectory.getAttribute(&quot;prefstring&quot;);</span>
<a href="#l11.228"></a><span id="l11.228">   let controlPref = prefstring.replace(</span>
<a href="#l11.229"></a><span id="l11.229">     &quot;%identitykey%&quot;,</span>
<a href="#l11.230"></a><span id="l11.230">     gPopAccount.defaultIdentity.key</span>
<a href="#l11.231"></a><span id="l11.231">   );</span>
<a href="#l11.232"></a><span id="l11.232">   Services.prefs.getDefaultBranch(&quot;&quot;).setBoolPref(controlPref, &quot;xxx&quot;);</span>
<a href="#l11.233"></a><span id="l11.233" class="difflineat">@@ -240,25 +235,25 @@ function subtest_check_locked_prefs_addr</span>
<a href="#l11.234"></a><span id="l11.234"> </span>
<a href="#l11.235"></a><span id="l11.235">   // Re-assign iframe.contentDocument because it was lost when changing panes</span>
<a href="#l11.236"></a><span id="l11.236">   // (uses loadURI to load a new document).</span>
<a href="#l11.237"></a><span id="l11.237">   iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l11.238"></a><span id="l11.238"> </span>
<a href="#l11.239"></a><span id="l11.239">   // We are now back and the 'different LDAP server' should still be selected</span>
<a href="#l11.240"></a><span id="l11.240">   // (the setting was saved).</span>
<a href="#l11.241"></a><span id="l11.241">   useLDAPdirectory = iframe.getElementById(&quot;directories&quot;);</span>
<a href="#l11.242"></a><span id="l11.242" class="difflineminus">-  assert_true(useLDAPdirectory.selected);</span>
<a href="#l11.243"></a><span id="l11.243" class="difflineplus">+  Assert.ok(useLDAPdirectory.selected);</span>
<a href="#l11.244"></a><span id="l11.244"> </span>
<a href="#l11.245"></a><span id="l11.245">   // But now the server selector should be disabled due to locked pref.</span>
<a href="#l11.246"></a><span id="l11.246">   LDAPdirectory = iframe.getElementById(&quot;identity.directoryServer&quot;);</span>
<a href="#l11.247"></a><span id="l11.247" class="difflineminus">-  assert_true(LDAPdirectory.disabled);</span>
<a href="#l11.248"></a><span id="l11.248" class="difflineplus">+  Assert.ok(LDAPdirectory.disabled);</span>
<a href="#l11.249"></a><span id="l11.249"> </span>
<a href="#l11.250"></a><span id="l11.250">   // The edit button still enabled (does not depend on the same pref lock)</span>
<a href="#l11.251"></a><span id="l11.251">   LDAPeditButton = iframe.getElementById(&quot;editButton&quot;);</span>
<a href="#l11.252"></a><span id="l11.252" class="difflineminus">-  assert_false(LDAPeditButton.disabled);</span>
<a href="#l11.253"></a><span id="l11.253" class="difflineplus">+  Assert.ok(!LDAPeditButton.disabled);</span>
<a href="#l11.254"></a><span id="l11.254"> </span>
<a href="#l11.255"></a><span id="l11.255">   // Unlock the pref to clean up.</span>
<a href="#l11.256"></a><span id="l11.256">   Services.prefs.unlockPref(controlPref);</span>
<a href="#l11.257"></a><span id="l11.257">   Services.prefs.getDefaultBranch(&quot;&quot;).deleteBranch(controlPref);</span>
<a href="#l11.258"></a><span id="l11.258"> }</span>
<a href="#l11.259"></a><span id="l11.259"> </span>
<a href="#l11.260"></a><span id="l11.260"> /**</span>
<a href="#l11.261"></a><span id="l11.261">  * Check that the POP3 'keep on server' settings elements (2-level</span>
<a href="#l11.262"></a><span id="l11.262" class="difflineat">@@ -270,38 +265,38 @@ function subtest_check_locked_prefs_addr</span>
<a href="#l11.263"></a><span id="l11.263"> function subtest_check_locked_prefs_server(amc) {</span>
<a href="#l11.264"></a><span id="l11.264">   let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l11.265"></a><span id="l11.265">   click_account_tree_row(amc, accountRow);</span>
<a href="#l11.266"></a><span id="l11.266"> </span>
<a href="#l11.267"></a><span id="l11.267">   let iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l11.268"></a><span id="l11.268"> </span>
<a href="#l11.269"></a><span id="l11.269">   // Top level leaveOnServer checkbox, disabled by default.</span>
<a href="#l11.270"></a><span id="l11.270">   let leaveOnServer = iframe.getElementById(&quot;pop3.leaveMessagesOnServer&quot;);</span>
<a href="#l11.271"></a><span id="l11.271" class="difflineminus">-  assert_false(leaveOnServer.disabled);</span>
<a href="#l11.272"></a><span id="l11.272" class="difflineminus">-  assert_false(leaveOnServer.checked);</span>
<a href="#l11.273"></a><span id="l11.273" class="difflineplus">+  Assert.ok(!leaveOnServer.disabled);</span>
<a href="#l11.274"></a><span id="l11.274" class="difflineplus">+  Assert.ok(!leaveOnServer.checked);</span>
<a href="#l11.275"></a><span id="l11.275"> </span>
<a href="#l11.276"></a><span id="l11.276">   // Second level deleteByAge checkbox, disabled by default.</span>
<a href="#l11.277"></a><span id="l11.277">   let deleteByAge = iframe.getElementById(&quot;pop3.deleteByAgeFromServer&quot;);</span>
<a href="#l11.278"></a><span id="l11.278" class="difflineminus">-  assert_true(deleteByAge.disabled);</span>
<a href="#l11.279"></a><span id="l11.279" class="difflineminus">-  assert_false(deleteByAge.checked);</span>
<a href="#l11.280"></a><span id="l11.280" class="difflineplus">+  Assert.ok(deleteByAge.disabled);</span>
<a href="#l11.281"></a><span id="l11.281" class="difflineplus">+  Assert.ok(!deleteByAge.checked);</span>
<a href="#l11.282"></a><span id="l11.282"> </span>
<a href="#l11.283"></a><span id="l11.283">   // Third level daysToLeave textbox, disabled by default.</span>
<a href="#l11.284"></a><span id="l11.284">   let daysToLeave = iframe.getElementById(&quot;pop3.numDaysToLeaveOnServer&quot;);</span>
<a href="#l11.285"></a><span id="l11.285" class="difflineminus">-  assert_true(daysToLeave.disabled);</span>
<a href="#l11.286"></a><span id="l11.286" class="difflineplus">+  Assert.ok(daysToLeave.disabled);</span>
<a href="#l11.287"></a><span id="l11.287"> </span>
<a href="#l11.288"></a><span id="l11.288">   // When leaveOnServer is checked, only deleteByAge will get enabled.</span>
<a href="#l11.289"></a><span id="l11.289">   amc.check(new elib.Elem(leaveOnServer), true);</span>
<a href="#l11.290"></a><span id="l11.290" class="difflineminus">-  assert_true(leaveOnServer.checked);</span>
<a href="#l11.291"></a><span id="l11.291" class="difflineminus">-  assert_false(deleteByAge.disabled);</span>
<a href="#l11.292"></a><span id="l11.292" class="difflineminus">-  assert_true(daysToLeave.disabled);</span>
<a href="#l11.293"></a><span id="l11.293" class="difflineplus">+  Assert.ok(leaveOnServer.checked);</span>
<a href="#l11.294"></a><span id="l11.294" class="difflineplus">+  Assert.ok(!deleteByAge.disabled);</span>
<a href="#l11.295"></a><span id="l11.295" class="difflineplus">+  Assert.ok(daysToLeave.disabled);</span>
<a href="#l11.296"></a><span id="l11.296"> </span>
<a href="#l11.297"></a><span id="l11.297">   // When deleteByAge is checked, daysToLeave will get enabled.</span>
<a href="#l11.298"></a><span id="l11.298">   amc.check(new elib.Elem(deleteByAge), true);</span>
<a href="#l11.299"></a><span id="l11.299" class="difflineminus">-  assert_true(deleteByAge.checked);</span>
<a href="#l11.300"></a><span id="l11.300" class="difflineminus">-  assert_false(daysToLeave.disabled);</span>
<a href="#l11.301"></a><span id="l11.301" class="difflineplus">+  Assert.ok(deleteByAge.checked);</span>
<a href="#l11.302"></a><span id="l11.302" class="difflineplus">+  Assert.ok(!daysToLeave.disabled);</span>
<a href="#l11.303"></a><span id="l11.303"> </span>
<a href="#l11.304"></a><span id="l11.304">   // Lock the pref deleteByAge checkbox (middle of the element hierarchy).</span>
<a href="#l11.305"></a><span id="l11.305">   let prefstring = deleteByAge.getAttribute(&quot;prefstring&quot;);</span>
<a href="#l11.306"></a><span id="l11.306">   let controlPref = prefstring.replace(</span>
<a href="#l11.307"></a><span id="l11.307">     &quot;%serverkey%&quot;,</span>
<a href="#l11.308"></a><span id="l11.308">     gPopAccount.incomingServer.key</span>
<a href="#l11.309"></a><span id="l11.309">   );</span>
<a href="#l11.310"></a><span id="l11.310">   Services.prefs.getDefaultBranch(&quot;&quot;).setBoolPref(controlPref, true);</span>
<a href="#l11.311"></a><span id="l11.311" class="difflineat">@@ -315,67 +310,67 @@ function subtest_check_locked_prefs_serv</span>
<a href="#l11.312"></a><span id="l11.312">   click_account_tree_row(amc, accountRow);</span>
<a href="#l11.313"></a><span id="l11.313"> </span>
<a href="#l11.314"></a><span id="l11.314">   // Re-assign iframe.contentDocument because it was lost when changing panes</span>
<a href="#l11.315"></a><span id="l11.315">   // (uses loadURI to load a new document).</span>
<a href="#l11.316"></a><span id="l11.316">   iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l11.317"></a><span id="l11.317"> </span>
<a href="#l11.318"></a><span id="l11.318">   // Now leaveOnServer was preserved as checked.</span>
<a href="#l11.319"></a><span id="l11.319">   leaveOnServer = iframe.getElementById(&quot;pop3.leaveMessagesOnServer&quot;);</span>
<a href="#l11.320"></a><span id="l11.320" class="difflineminus">-  assert_false(leaveOnServer.disabled);</span>
<a href="#l11.321"></a><span id="l11.321" class="difflineminus">-  assert_true(leaveOnServer.checked);</span>
<a href="#l11.322"></a><span id="l11.322" class="difflineplus">+  Assert.ok(!leaveOnServer.disabled);</span>
<a href="#l11.323"></a><span id="l11.323" class="difflineplus">+  Assert.ok(leaveOnServer.checked);</span>
<a href="#l11.324"></a><span id="l11.324"> </span>
<a href="#l11.325"></a><span id="l11.325">   // Now deleteByAge was preserved as checked but is locked/disabled.</span>
<a href="#l11.326"></a><span id="l11.326">   deleteByAge = iframe.getElementById(&quot;pop3.deleteByAgeFromServer&quot;);</span>
<a href="#l11.327"></a><span id="l11.327" class="difflineminus">-  assert_true(deleteByAge.disabled);</span>
<a href="#l11.328"></a><span id="l11.328" class="difflineminus">-  assert_true(deleteByAge.checked);</span>
<a href="#l11.329"></a><span id="l11.329" class="difflineplus">+  Assert.ok(deleteByAge.disabled);</span>
<a href="#l11.330"></a><span id="l11.330" class="difflineplus">+  Assert.ok(deleteByAge.checked);</span>
<a href="#l11.331"></a><span id="l11.331"> </span>
<a href="#l11.332"></a><span id="l11.332">   // Because deleteByAge is checked, daysToLeave should be enabled.</span>
<a href="#l11.333"></a><span id="l11.333">   daysToLeave = iframe.getElementById(&quot;pop3.numDaysToLeaveOnServer&quot;);</span>
<a href="#l11.334"></a><span id="l11.334" class="difflineminus">-  assert_false(daysToLeave.disabled);</span>
<a href="#l11.335"></a><span id="l11.335" class="difflineplus">+  Assert.ok(!daysToLeave.disabled);</span>
<a href="#l11.336"></a><span id="l11.336"> </span>
<a href="#l11.337"></a><span id="l11.337">   // When leaveOnserver is unchecked, both of deleteByAge and daysToLeave</span>
<a href="#l11.338"></a><span id="l11.338">   // should get disabled.</span>
<a href="#l11.339"></a><span id="l11.339">   amc.check(new elib.Elem(leaveOnServer), false);</span>
<a href="#l11.340"></a><span id="l11.340" class="difflineminus">-  assert_false(leaveOnServer.disabled);</span>
<a href="#l11.341"></a><span id="l11.341" class="difflineminus">-  assert_false(leaveOnServer.checked);</span>
<a href="#l11.342"></a><span id="l11.342" class="difflineplus">+  Assert.ok(!leaveOnServer.disabled);</span>
<a href="#l11.343"></a><span id="l11.343" class="difflineplus">+  Assert.ok(!leaveOnServer.checked);</span>
<a href="#l11.344"></a><span id="l11.344"> </span>
<a href="#l11.345"></a><span id="l11.345" class="difflineminus">-  assert_true(deleteByAge.disabled);</span>
<a href="#l11.346"></a><span id="l11.346" class="difflineminus">-  assert_true(deleteByAge.checked);</span>
<a href="#l11.347"></a><span id="l11.347" class="difflineminus">-  assert_true(daysToLeave.disabled);</span>
<a href="#l11.348"></a><span id="l11.348" class="difflineplus">+  Assert.ok(deleteByAge.disabled);</span>
<a href="#l11.349"></a><span id="l11.349" class="difflineplus">+  Assert.ok(deleteByAge.checked);</span>
<a href="#l11.350"></a><span id="l11.350" class="difflineplus">+  Assert.ok(daysToLeave.disabled);</span>
<a href="#l11.351"></a><span id="l11.351"> </span>
<a href="#l11.352"></a><span id="l11.352">   // Unlock the pref to clean up.</span>
<a href="#l11.353"></a><span id="l11.353">   Services.prefs.unlockPref(controlPref);</span>
<a href="#l11.354"></a><span id="l11.354">   Services.prefs.getDefaultBranch(&quot;&quot;).deleteBranch(controlPref);</span>
<a href="#l11.355"></a><span id="l11.355"> }</span>
<a href="#l11.356"></a><span id="l11.356"> </span>
<a href="#l11.357"></a><span id="l11.357"> /**</span>
<a href="#l11.358"></a><span id="l11.358">  * Bug 530142.</span>
<a href="#l11.359"></a><span id="l11.359">  * Check that that if one field is set to a value, switching directly to another</span>
<a href="#l11.360"></a><span id="l11.360">  * account pane showing the same field really loads the value from the new account,</span>
<a href="#l11.361"></a><span id="l11.361">  * even when empty. This is tested on the Reply-To field.</span>
<a href="#l11.362"></a><span id="l11.362">  */</span>
<a href="#l11.363"></a><span id="l11.363" class="difflineminus">-function test_replyTo_leak() {</span>
<a href="#l11.364"></a><span id="l11.364" class="difflineplus">+add_task(function test_replyTo_leak() {</span>
<a href="#l11.365"></a><span id="l11.365">   open_advanced_settings(function(amc) {</span>
<a href="#l11.366"></a><span id="l11.366">     subtest_check_replyTo_leak(amc);</span>
<a href="#l11.367"></a><span id="l11.367">   });</span>
<a href="#l11.368"></a><span id="l11.368" class="difflineminus">-}</span>
<a href="#l11.369"></a><span id="l11.369" class="difflineplus">+});</span>
<a href="#l11.370"></a><span id="l11.370"> </span>
<a href="#l11.371"></a><span id="l11.371"> /**</span>
<a href="#l11.372"></a><span id="l11.372">  * @param amc  the account options controller</span>
<a href="#l11.373"></a><span id="l11.373">  */</span>
<a href="#l11.374"></a><span id="l11.374"> function subtest_check_replyTo_leak(amc) {</span>
<a href="#l11.375"></a><span id="l11.375">   let accountRow = get_account_tree_row(gPopAccount.key, null, amc);</span>
<a href="#l11.376"></a><span id="l11.376">   click_account_tree_row(amc, accountRow);</span>
<a href="#l11.377"></a><span id="l11.377"> </span>
<a href="#l11.378"></a><span id="l11.378">   let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l11.379"></a><span id="l11.379"> </span>
<a href="#l11.380"></a><span id="l11.380">   // The Reply-To field should be empty.</span>
<a href="#l11.381"></a><span id="l11.381">   let replyAddress = iframe.contentDocument.getElementById(&quot;identity.replyTo&quot;);</span>
<a href="#l11.382"></a><span id="l11.382" class="difflineminus">-  assert_equals(replyAddress.value, &quot;&quot;);</span>
<a href="#l11.383"></a><span id="l11.383" class="difflineplus">+  Assert.equal(replyAddress.value, &quot;&quot;);</span>
<a href="#l11.384"></a><span id="l11.384"> </span>
<a href="#l11.385"></a><span id="l11.385">   // Now we set a value into it and switch to another account, the main pane.</span>
<a href="#l11.386"></a><span id="l11.386">   replyAddress.value = &quot;somewhere@else.com&quot;;</span>
<a href="#l11.387"></a><span id="l11.387"> </span>
<a href="#l11.388"></a><span id="l11.388">   // This test expects the following POP account to exist by default</span>
<a href="#l11.389"></a><span id="l11.389">   // in the test profile with port number 110 and no security.</span>
<a href="#l11.390"></a><span id="l11.390">   let firstServer = MailServices.accounts.FindServer(</span>
<a href="#l11.391"></a><span id="l11.391">     &quot;tinderbox&quot;,</span>
<a href="#l11.392"></a><span id="l11.392" class="difflineat">@@ -384,28 +379,28 @@ function subtest_check_replyTo_leak(amc)</span>
<a href="#l11.393"></a><span id="l11.393">   );</span>
<a href="#l11.394"></a><span id="l11.394">   let firstAccount = MailServices.accounts.FindAccountForServer(firstServer);</span>
<a href="#l11.395"></a><span id="l11.395"> </span>
<a href="#l11.396"></a><span id="l11.396">   accountRow = get_account_tree_row(firstAccount.key, null, amc);</span>
<a href="#l11.397"></a><span id="l11.397">   click_account_tree_row(amc, accountRow);</span>
<a href="#l11.398"></a><span id="l11.398"> </span>
<a href="#l11.399"></a><span id="l11.399">   // the Reply-To field should be empty as this account does not have it set.</span>
<a href="#l11.400"></a><span id="l11.400">   replyAddress = iframe.contentDocument.getElementById(&quot;identity.replyTo&quot;);</span>
<a href="#l11.401"></a><span id="l11.401" class="difflineminus">-  assert_equals(replyAddress.value, &quot;&quot;);</span>
<a href="#l11.402"></a><span id="l11.402" class="difflineplus">+  Assert.equal(replyAddress.value, &quot;&quot;);</span>
<a href="#l11.403"></a><span id="l11.403"> }</span>
<a href="#l11.404"></a><span id="l11.404"> </span>
<a href="#l11.405"></a><span id="l11.405"> /**</span>
<a href="#l11.406"></a><span id="l11.406">  * Test for bug 804091.</span>
<a href="#l11.407"></a><span id="l11.407">  * Check if onchange handlers are properly executed when panes are switched.</span>
<a href="#l11.408"></a><span id="l11.408">  */</span>
<a href="#l11.409"></a><span id="l11.409" class="difflineminus">-function test_account_onchange_handler() {</span>
<a href="#l11.410"></a><span id="l11.410" class="difflineplus">+add_task(function test_account_onchange_handler() {</span>
<a href="#l11.411"></a><span id="l11.411">   open_advanced_settings(function(amc) {</span>
<a href="#l11.412"></a><span id="l11.412">     subtest_check_onchange_handler(amc);</span>
<a href="#l11.413"></a><span id="l11.413">   });</span>
<a href="#l11.414"></a><span id="l11.414" class="difflineminus">-}</span>
<a href="#l11.415"></a><span id="l11.415" class="difflineplus">+});</span>
<a href="#l11.416"></a><span id="l11.416"> </span>
<a href="#l11.417"></a><span id="l11.417"> /**</span>
<a href="#l11.418"></a><span id="l11.418">  * Check if onchange handlers are properly executed when panes are switched.</span>
<a href="#l11.419"></a><span id="l11.419">  *</span>
<a href="#l11.420"></a><span id="l11.420">  * @param amc  the account options controller</span>
<a href="#l11.421"></a><span id="l11.421">  */</span>
<a href="#l11.422"></a><span id="l11.422"> function subtest_check_onchange_handler(amc) {</span>
<a href="#l11.423"></a><span id="l11.423">   let accountRow = get_account_tree_row(</span>
<a href="#l11.424"></a><span id="l11.424" class="difflineat">@@ -414,21 +409,21 @@ function subtest_check_onchange_handler(</span>
<a href="#l11.425"></a><span id="l11.425">     amc</span>
<a href="#l11.426"></a><span id="l11.426">   );</span>
<a href="#l11.427"></a><span id="l11.427">   click_account_tree_row(amc, accountRow);</span>
<a href="#l11.428"></a><span id="l11.428"> </span>
<a href="#l11.429"></a><span id="l11.429">   let iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l11.430"></a><span id="l11.430"> </span>
<a href="#l11.431"></a><span id="l11.431">   let autoSync = iframe.getElementById(&quot;autosyncValue&quot;);</span>
<a href="#l11.432"></a><span id="l11.432">   // 30 is the default value so check if we are in clean state.</span>
<a href="#l11.433"></a><span id="l11.433" class="difflineminus">-  assert_equals(autoSync.value, 30);</span>
<a href="#l11.434"></a><span id="l11.434" class="difflineplus">+  Assert.equal(autoSync.value, 30);</span>
<a href="#l11.435"></a><span id="l11.435"> </span>
<a href="#l11.436"></a><span id="l11.436">   let autoSyncInterval = iframe.getElementById(&quot;autosyncInterval&quot;);</span>
<a href="#l11.437"></a><span id="l11.437">   // 1 is the default value and means the 30 is in days.</span>
<a href="#l11.438"></a><span id="l11.438" class="difflineminus">-  assert_equals(autoSyncInterval.value, 1);</span>
<a href="#l11.439"></a><span id="l11.439" class="difflineplus">+  Assert.equal(autoSyncInterval.value, 1);</span>
<a href="#l11.440"></a><span id="l11.440"> </span>
<a href="#l11.441"></a><span id="l11.441">   // Now type in 35 (days).</span>
<a href="#l11.442"></a><span id="l11.442">   amc.radio(new elib.ID(iframe, &quot;useAutosync.ByAge&quot;));</span>
<a href="#l11.443"></a><span id="l11.443">   autoSync.select();</span>
<a href="#l11.444"></a><span id="l11.444">   amc.type(new elib.Elem(autoSync), &quot;35&quot;);</span>
<a href="#l11.445"></a><span id="l11.445"> </span>
<a href="#l11.446"></a><span id="l11.446">   // Immediately switch to another pane and back.</span>
<a href="#l11.447"></a><span id="l11.447">   accountRow = get_account_tree_row(gImapAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l11.448"></a><span id="l11.448" class="difflineat">@@ -436,14 +431,14 @@ function subtest_check_onchange_handler(</span>
<a href="#l11.449"></a><span id="l11.449"> </span>
<a href="#l11.450"></a><span id="l11.450">   accountRow = get_account_tree_row(gImapAccount.key, &quot;am-offline.xul&quot;, amc);</span>
<a href="#l11.451"></a><span id="l11.451">   click_account_tree_row(amc, accountRow);</span>
<a href="#l11.452"></a><span id="l11.452"> </span>
<a href="#l11.453"></a><span id="l11.453">   iframe = amc.e(&quot;contentFrame&quot;).contentDocument;</span>
<a href="#l11.454"></a><span id="l11.454"> </span>
<a href="#l11.455"></a><span id="l11.455">   // The pane optimized the entered value a bit. So now we should find 5.</span>
<a href="#l11.456"></a><span id="l11.456">   autoSync = iframe.getElementById(&quot;autosyncValue&quot;);</span>
<a href="#l11.457"></a><span id="l11.457" class="difflineminus">-  assert_equals(autoSync.value, 5);</span>
<a href="#l11.458"></a><span id="l11.458" class="difflineplus">+  Assert.equal(autoSync.value, 5);</span>
<a href="#l11.459"></a><span id="l11.459"> </span>
<a href="#l11.460"></a><span id="l11.460">   // And the unit is 7 days = week.</span>
<a href="#l11.461"></a><span id="l11.461">   autoSyncInterval = iframe.getElementById(&quot;autosyncInterval&quot;);</span>
<a href="#l11.462"></a><span id="l11.462" class="difflineminus">-  assert_equals(autoSyncInterval.value, 7);</span>
<a href="#l11.463"></a><span id="l11.463" class="difflineplus">+  Assert.equal(autoSyncInterval.value, 7);</span>
<a href="#l11.464"></a><span id="l11.464"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">copy from mail/test/mozmill/account/test-account-tree.js</span>
<a href="#l12.2"></a><span id="l12.2">copy to mail/test/browser/account/browser_tree.js</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineminus">--- a/mail/test/mozmill/account/test-account-tree.js</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineplus">+++ b/mail/test/browser/account/browser_tree.js</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineat">@@ -11,164 +11,161 @@</span>
<a href="#l12.6"></a><span id="l12.6"> var {</span>
<a href="#l12.7"></a><span id="l12.7">   click_account_tree_row,</span>
<a href="#l12.8"></a><span id="l12.8">   get_account_tree_row,</span>
<a href="#l12.9"></a><span id="l12.9">   open_advanced_settings,</span>
<a href="#l12.10"></a><span id="l12.10">   remove_account,</span>
<a href="#l12.11"></a><span id="l12.11"> } = ChromeUtils.import(</span>
<a href="#l12.12"></a><span id="l12.12">   &quot;resource://testing-common/mozmill/AccountManagerHelpers.jsm&quot;</span>
<a href="#l12.13"></a><span id="l12.13"> );</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-var { assert_equals, assert_false, assert_true } = ChromeUtils.import(</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-  &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-);</span>
<a href="#l12.17"></a><span id="l12.17"> </span>
<a href="#l12.18"></a><span id="l12.18"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l12.19"></a><span id="l12.19">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l12.20"></a><span id="l12.20"> );</span>
<a href="#l12.21"></a><span id="l12.21"> </span>
<a href="#l12.22"></a><span id="l12.22"> var gPopAccount, gOriginalAccountCount;</span>
<a href="#l12.23"></a><span id="l12.23"> </span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-function setupModule(module) {</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l12.26"></a><span id="l12.26">   // There may be pre-existing accounts from other tests.</span>
<a href="#l12.27"></a><span id="l12.27">   gOriginalAccountCount = MailServices.accounts.allServers.length;</span>
<a href="#l12.28"></a><span id="l12.28"> </span>
<a href="#l12.29"></a><span id="l12.29">   // Create a POP server</span>
<a href="#l12.30"></a><span id="l12.30">   let popServer = MailServices.accounts</span>
<a href="#l12.31"></a><span id="l12.31">     .createIncomingServer(&quot;nobody&quot;, &quot;foo.invalid&quot;, &quot;pop3&quot;)</span>
<a href="#l12.32"></a><span id="l12.32">     .QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l12.33"></a><span id="l12.33"> </span>
<a href="#l12.34"></a><span id="l12.34">   let identity = MailServices.accounts.createIdentity();</span>
<a href="#l12.35"></a><span id="l12.35">   identity.email = &quot;tinderbox@foo.invalid&quot;;</span>
<a href="#l12.36"></a><span id="l12.36"> </span>
<a href="#l12.37"></a><span id="l12.37">   gPopAccount = MailServices.accounts.createAccount();</span>
<a href="#l12.38"></a><span id="l12.38">   gPopAccount.incomingServer = popServer;</span>
<a href="#l12.39"></a><span id="l12.39">   gPopAccount.addIdentity(identity);</span>
<a href="#l12.40"></a><span id="l12.40"> </span>
<a href="#l12.41"></a><span id="l12.41">   // Now there should be one more account.</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineminus">-  assert_equals(</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+  Assert.equal(</span>
<a href="#l12.44"></a><span id="l12.44">     MailServices.accounts.allServers.length,</span>
<a href="#l12.45"></a><span id="l12.45">     gOriginalAccountCount + 1</span>
<a href="#l12.46"></a><span id="l12.46">   );</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineminus">-}</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+});</span>
<a href="#l12.49"></a><span id="l12.49"> </span>
<a href="#l12.50"></a><span id="l12.50" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l12.52"></a><span id="l12.52">   if (gPopAccount) {</span>
<a href="#l12.53"></a><span id="l12.53">     // Remove our test account to leave the profile clean.</span>
<a href="#l12.54"></a><span id="l12.54">     MailServices.accounts.removeAccount(gPopAccount);</span>
<a href="#l12.55"></a><span id="l12.55">     gPopAccount = null;</span>
<a href="#l12.56"></a><span id="l12.56">   }</span>
<a href="#l12.57"></a><span id="l12.57">   // There should be only the original accounts left.</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineminus">-  assert_equals(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineminus">-}</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+  Assert.equal(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+});</span>
<a href="#l12.62"></a><span id="l12.62"> </span>
<a href="#l12.63"></a><span id="l12.63"> /**</span>
<a href="#l12.64"></a><span id="l12.64">  * Test for bug 536248.</span>
<a href="#l12.65"></a><span id="l12.65">  * Check if the account manager dialog remembers the open state of accounts.</span>
<a href="#l12.66"></a><span id="l12.66">  */</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineminus">-function test_account_open_state() {</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+add_task(function test_account_open_state() {</span>
<a href="#l12.69"></a><span id="l12.69">   open_advanced_settings(function(amc) {</span>
<a href="#l12.70"></a><span id="l12.70">     subtest_check_account_open_state(amc, true);</span>
<a href="#l12.71"></a><span id="l12.71">   });</span>
<a href="#l12.72"></a><span id="l12.72">   open_advanced_settings(function(amc) {</span>
<a href="#l12.73"></a><span id="l12.73">     subtest_check_account_open_state(amc, false);</span>
<a href="#l12.74"></a><span id="l12.74">   });</span>
<a href="#l12.75"></a><span id="l12.75">   // After this test all the accounts must be &quot;open&quot;.</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineminus">-}</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+});</span>
<a href="#l12.78"></a><span id="l12.78"> </span>
<a href="#l12.79"></a><span id="l12.79"> /**</span>
<a href="#l12.80"></a><span id="l12.80">  * Check if the open state of accounts is in the wished state.</span>
<a href="#l12.81"></a><span id="l12.81">  *</span>
<a href="#l12.82"></a><span id="l12.82">  * @param amc           The account options controller.</span>
<a href="#l12.83"></a><span id="l12.83">  * @param aWishedState  The open state in which the account row should be found (bool).</span>
<a href="#l12.84"></a><span id="l12.84">  */</span>
<a href="#l12.85"></a><span id="l12.85"> function subtest_check_account_open_state(amc, aWishedState) {</span>
<a href="#l12.86"></a><span id="l12.86">   let accountRow = get_account_tree_row(gPopAccount.key, null, amc);</span>
<a href="#l12.87"></a><span id="l12.87">   click_account_tree_row(amc, accountRow);</span>
<a href="#l12.88"></a><span id="l12.88"> </span>
<a href="#l12.89"></a><span id="l12.89">   // See if the account row is in the wished open state.</span>
<a href="#l12.90"></a><span id="l12.90">   let accountTree = amc.e(&quot;accounttree&quot;);</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineminus">-  assert_equals(accountRow, accountTree.view.selection.currentIndex);</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineminus">-  assert_equals(accountTree.view.isContainerOpen(accountRow), aWishedState);</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+  Assert.equal(accountRow, accountTree.view.selection.currentIndex);</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+  Assert.equal(accountTree.view.isContainerOpen(accountRow), aWishedState);</span>
<a href="#l12.95"></a><span id="l12.95"> </span>
<a href="#l12.96"></a><span id="l12.96">   accountTree.view.toggleOpenState(accountRow);</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineminus">-  assert_equals(accountTree.view.isContainerOpen(accountRow), !aWishedState);</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+  Assert.equal(accountTree.view.isContainerOpen(accountRow), !aWishedState);</span>
<a href="#l12.99"></a><span id="l12.99"> </span>
<a href="#l12.100"></a><span id="l12.100">   // Whatever the open state of the account was, selecting one of its subpanes</span>
<a href="#l12.101"></a><span id="l12.101">   // must open it.</span>
<a href="#l12.102"></a><span id="l12.102">   amc.window.selectServer(gPopAccount.incomingServer, &quot;am-junk.xul&quot;);</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineminus">-  assert_true(accountTree.view.isContainerOpen(accountRow));</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+  Assert.ok(accountTree.view.isContainerOpen(accountRow));</span>
<a href="#l12.105"></a><span id="l12.105"> </span>
<a href="#l12.106"></a><span id="l12.106">   // Set the proper state again for continuation of the test.</span>
<a href="#l12.107"></a><span id="l12.107">   accountTree.view</span>
<a href="#l12.108"></a><span id="l12.108">     .getItemAtIndex(accountRow)</span>
<a href="#l12.109"></a><span id="l12.109">     .setAttribute(&quot;open&quot;, !aWishedState);</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineminus">-  assert_equals(accountTree.view.isContainerOpen(accountRow), !aWishedState);</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+  Assert.equal(accountTree.view.isContainerOpen(accountRow), !aWishedState);</span>
<a href="#l12.112"></a><span id="l12.112"> }</span>
<a href="#l12.113"></a><span id="l12.113"> </span>
<a href="#l12.114"></a><span id="l12.114"> /**</span>
<a href="#l12.115"></a><span id="l12.115">  * Bug 740617.</span>
<a href="#l12.116"></a><span id="l12.116">  * Check if the default account is styled in bold.</span>
<a href="#l12.117"></a><span id="l12.117">  *</span>
<a href="#l12.118"></a><span id="l12.118">  */</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineminus">-function test_default_account_highlight() {</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+add_task(function test_default_account_highlight() {</span>
<a href="#l12.121"></a><span id="l12.121">   open_advanced_settings(function(amc) {</span>
<a href="#l12.122"></a><span id="l12.122">     subtest_check_default_account_highlight(amc);</span>
<a href="#l12.123"></a><span id="l12.123">   });</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineminus">-}</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+});</span>
<a href="#l12.126"></a><span id="l12.126"> </span>
<a href="#l12.127"></a><span id="l12.127"> /**</span>
<a href="#l12.128"></a><span id="l12.128">  * Check if the default account is styled in bold and another account is not.</span>
<a href="#l12.129"></a><span id="l12.129">  *</span>
<a href="#l12.130"></a><span id="l12.130">  * @param amc           The account options controller.</span>
<a href="#l12.131"></a><span id="l12.131">  */</span>
<a href="#l12.132"></a><span id="l12.132"> function subtest_check_default_account_highlight(amc) {</span>
<a href="#l12.133"></a><span id="l12.133">   // Select the default account.</span>
<a href="#l12.134"></a><span id="l12.134">   let accountRow = get_account_tree_row(</span>
<a href="#l12.135"></a><span id="l12.135">     MailServices.accounts.defaultAccount.key,</span>
<a href="#l12.136"></a><span id="l12.136">     null,</span>
<a href="#l12.137"></a><span id="l12.137">     amc</span>
<a href="#l12.138"></a><span id="l12.138">   );</span>
<a href="#l12.139"></a><span id="l12.139">   click_account_tree_row(amc, accountRow);</span>
<a href="#l12.140"></a><span id="l12.140"> </span>
<a href="#l12.141"></a><span id="l12.141">   let accountTree = amc.e(&quot;accounttree&quot;);</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineminus">-  assert_equals(accountRow, accountTree.view.selection.currentIndex);</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+  Assert.equal(accountRow, accountTree.view.selection.currentIndex);</span>
<a href="#l12.144"></a><span id="l12.144">   let cell = accountTree.view.getItemAtIndex(accountRow).firstElementChild</span>
<a href="#l12.145"></a><span id="l12.145">     .firstElementChild;</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineminus">-  assert_equals(cell.tagName, &quot;treecell&quot;);</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+  Assert.equal(cell.tagName, &quot;treecell&quot;);</span>
<a href="#l12.148"></a><span id="l12.148"> </span>
<a href="#l12.149"></a><span id="l12.149">   // We can't read the computed style of the tree cell directly, so at least see</span>
<a href="#l12.150"></a><span id="l12.150">   // if the isDefaultServer-true property is set on it. Hopefully the proper style</span>
<a href="#l12.151"></a><span id="l12.151">   // is attached to this property.</span>
<a href="#l12.152"></a><span id="l12.152">   let propArray = accountTree.view</span>
<a href="#l12.153"></a><span id="l12.153">     .getCellProperties(accountRow, accountTree.columns.getColumnAt(0))</span>
<a href="#l12.154"></a><span id="l12.154">     .split(&quot; &quot;);</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineminus">-  assert_true(propArray.includes(&quot;isDefaultServer-true&quot;));</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+  Assert.ok(propArray.includes(&quot;isDefaultServer-true&quot;));</span>
<a href="#l12.157"></a><span id="l12.157"> </span>
<a href="#l12.158"></a><span id="l12.158">   // Now select another account that is not default.</span>
<a href="#l12.159"></a><span id="l12.159">   accountRow = get_account_tree_row(gPopAccount.key, null, amc);</span>
<a href="#l12.160"></a><span id="l12.160">   click_account_tree_row(amc, accountRow);</span>
<a href="#l12.161"></a><span id="l12.161"> </span>
<a href="#l12.162"></a><span id="l12.162">   // There should isDefaultServer-true on its tree cell.</span>
<a href="#l12.163"></a><span id="l12.163">   propArray = accountTree.view</span>
<a href="#l12.164"></a><span id="l12.164">     .getCellProperties(accountRow, accountTree.columns.getColumnAt(0))</span>
<a href="#l12.165"></a><span id="l12.165">     .split(&quot; &quot;);</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineminus">-  assert_false(propArray.includes(&quot;isDefaultServer-true&quot;));</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+  Assert.ok(!propArray.includes(&quot;isDefaultServer-true&quot;));</span>
<a href="#l12.168"></a><span id="l12.168"> }</span>
<a href="#l12.169"></a><span id="l12.169"> /**</span>
<a href="#l12.170"></a><span id="l12.170">  * Bug 58713.</span>
<a href="#l12.171"></a><span id="l12.171">  * Check if after deleting an account the next one is selected.</span>
<a href="#l12.172"></a><span id="l12.172">  *</span>
<a href="#l12.173"></a><span id="l12.173">  * This test should always be the last one as it removes our specially</span>
<a href="#l12.174"></a><span id="l12.174">  * created gPopAccount.</span>
<a href="#l12.175"></a><span id="l12.175">  */</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineminus">-function test_selection_after_account_deletion() {</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+add_task(function test_selection_after_account_deletion() {</span>
<a href="#l12.178"></a><span id="l12.178">   open_advanced_settings(function(amc) {</span>
<a href="#l12.179"></a><span id="l12.179">     subtest_check_selection_after_account_deletion(amc);</span>
<a href="#l12.180"></a><span id="l12.180">   });</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineminus">-}</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+});</span>
<a href="#l12.183"></a><span id="l12.183"> </span>
<a href="#l12.184"></a><span id="l12.184"> /**</span>
<a href="#l12.185"></a><span id="l12.185">  * Check if after deleting an account the next one is selected.</span>
<a href="#l12.186"></a><span id="l12.186">  *</span>
<a href="#l12.187"></a><span id="l12.187">  * @param amc           The account options controller.</span>
<a href="#l12.188"></a><span id="l12.188">  */</span>
<a href="#l12.189"></a><span id="l12.189"> function subtest_check_selection_after_account_deletion(amc) {</span>
<a href="#l12.190"></a><span id="l12.190">   let accountList = [];</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineat">@@ -185,18 +182,18 @@ function subtest_check_selection_after_a</span>
<a href="#l12.192"></a><span id="l12.192"> </span>
<a href="#l12.193"></a><span id="l12.193">   // Get position of the current account in the account list.</span>
<a href="#l12.194"></a><span id="l12.194">   let accountIndex = accountList.indexOf(gPopAccount);</span>
<a href="#l12.195"></a><span id="l12.195"> </span>
<a href="#l12.196"></a><span id="l12.196">   // Remove our account.</span>
<a href="#l12.197"></a><span id="l12.197">   remove_account(gPopAccount, amc);</span>
<a href="#l12.198"></a><span id="l12.198">   gPopAccount = null;</span>
<a href="#l12.199"></a><span id="l12.199">   // Now there should be only the original accounts left.</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineminus">-  assert_equals(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+  Assert.equal(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l12.202"></a><span id="l12.202"> </span>
<a href="#l12.203"></a><span id="l12.203">   // See if the currently selected account is the one next in the account list.</span>
<a href="#l12.204"></a><span id="l12.204">   let accountTree = amc.e(&quot;accounttree&quot;);</span>
<a href="#l12.205"></a><span id="l12.205">   let accountRow = accountTree.view.selection.currentIndex;</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineminus">-  assert_equals(</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+  Assert.equal(</span>
<a href="#l12.208"></a><span id="l12.208">     accountTree.view.getItemAtIndex(accountRow)._account,</span>
<a href="#l12.209"></a><span id="l12.209">     accountList[accountIndex + 1]</span>
<a href="#l12.210"></a><span id="l12.210">   );</span>
<a href="#l12.211"></a><span id="l12.211"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">copy from mail/test/mozmill/account/test-account-values.js</span>
<a href="#l13.2"></a><span id="l13.2">copy to mail/test/browser/account/browser_values.js</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineminus">--- a/mail/test/mozmill/account/test-account-values.js</span>
<a href="#l13.4"></a><span id="l13.4" class="difflineplus">+++ b/mail/test/browser/account/browser_values.js</span>
<a href="#l13.5"></a><span id="l13.5" class="difflineat">@@ -5,83 +5,80 @@</span>
<a href="#l13.6"></a><span id="l13.6"> /**</span>
<a href="#l13.7"></a><span id="l13.7">  * This test checks proper operation of the account settings panes</span>
<a href="#l13.8"></a><span id="l13.8">  * when certain special or invalid values are entered into the fields.</span>
<a href="#l13.9"></a><span id="l13.9">  */</span>
<a href="#l13.10"></a><span id="l13.10"> </span>
<a href="#l13.11"></a><span id="l13.11"> &quot;use strict&quot;;</span>
<a href="#l13.12"></a><span id="l13.12"> </span>
<a href="#l13.13"></a><span id="l13.13"> var elib = ChromeUtils.import(</span>
<a href="#l13.14"></a><span id="l13.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l13.15"></a><span id="l13.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l13.16"></a><span id="l13.16"> );</span>
<a href="#l13.17"></a><span id="l13.17"> </span>
<a href="#l13.18"></a><span id="l13.18"> var {</span>
<a href="#l13.19"></a><span id="l13.19">   click_account_tree_row,</span>
<a href="#l13.20"></a><span id="l13.20">   get_account_tree_row,</span>
<a href="#l13.21"></a><span id="l13.21">   open_advanced_settings,</span>
<a href="#l13.22"></a><span id="l13.22"> } = ChromeUtils.import(</span>
<a href="#l13.23"></a><span id="l13.23">   &quot;resource://testing-common/mozmill/AccountManagerHelpers.jsm&quot;</span>
<a href="#l13.24"></a><span id="l13.24"> );</span>
<a href="#l13.25"></a><span id="l13.25" class="difflineminus">-var { assert_equals, assert_false } = ChromeUtils.import(</span>
<a href="#l13.26"></a><span id="l13.26" class="difflineminus">-  &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l13.27"></a><span id="l13.27" class="difflineminus">-);</span>
<a href="#l13.28"></a><span id="l13.28"> var { input_value, delete_all_existing } = ChromeUtils.import(</span>
<a href="#l13.29"></a><span id="l13.29">   &quot;resource://testing-common/mozmill/KeyboardHelpers.jsm&quot;</span>
<a href="#l13.30"></a><span id="l13.30"> );</span>
<a href="#l13.31"></a><span id="l13.31"> var { plan_for_modal_dialog, wait_for_modal_dialog } = ChromeUtils.import(</span>
<a href="#l13.32"></a><span id="l13.32">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l13.33"></a><span id="l13.33"> );</span>
<a href="#l13.34"></a><span id="l13.34"> </span>
<a href="#l13.35"></a><span id="l13.35"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l13.36"></a><span id="l13.36">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l13.37"></a><span id="l13.37"> );</span>
<a href="#l13.38"></a><span id="l13.38"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l13.39"></a><span id="l13.39"> </span>
<a href="#l13.40"></a><span id="l13.40"> var gPopAccount, gOriginalAccountCount;</span>
<a href="#l13.41"></a><span id="l13.41"> </span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-function setupModule(module) {</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l13.44"></a><span id="l13.44">   // There may be pre-existing accounts from other tests.</span>
<a href="#l13.45"></a><span id="l13.45">   gOriginalAccountCount = MailServices.accounts.allServers.length;</span>
<a href="#l13.46"></a><span id="l13.46"> </span>
<a href="#l13.47"></a><span id="l13.47">   // Create a POP server</span>
<a href="#l13.48"></a><span id="l13.48">   let popServer = MailServices.accounts</span>
<a href="#l13.49"></a><span id="l13.49">     .createIncomingServer(&quot;nobody&quot;, &quot;example.invalid&quot;, &quot;pop3&quot;)</span>
<a href="#l13.50"></a><span id="l13.50">     .QueryInterface(Ci.nsIPop3IncomingServer);</span>
<a href="#l13.51"></a><span id="l13.51"> </span>
<a href="#l13.52"></a><span id="l13.52">   let identity = MailServices.accounts.createIdentity();</span>
<a href="#l13.53"></a><span id="l13.53">   identity.email = &quot;tinderbox@example.invalid&quot;;</span>
<a href="#l13.54"></a><span id="l13.54"> </span>
<a href="#l13.55"></a><span id="l13.55">   gPopAccount = MailServices.accounts.createAccount();</span>
<a href="#l13.56"></a><span id="l13.56">   gPopAccount.incomingServer = popServer;</span>
<a href="#l13.57"></a><span id="l13.57">   gPopAccount.addIdentity(identity);</span>
<a href="#l13.58"></a><span id="l13.58"> </span>
<a href="#l13.59"></a><span id="l13.59">   // Now there should be one more account.</span>
<a href="#l13.60"></a><span id="l13.60" class="difflineminus">-  assert_equals(</span>
<a href="#l13.61"></a><span id="l13.61" class="difflineplus">+  Assert.equal(</span>
<a href="#l13.62"></a><span id="l13.62">     MailServices.accounts.allServers.length,</span>
<a href="#l13.63"></a><span id="l13.63">     gOriginalAccountCount + 1</span>
<a href="#l13.64"></a><span id="l13.64">   );</span>
<a href="#l13.65"></a><span id="l13.65" class="difflineminus">-}</span>
<a href="#l13.66"></a><span id="l13.66" class="difflineplus">+});</span>
<a href="#l13.67"></a><span id="l13.67"> </span>
<a href="#l13.68"></a><span id="l13.68" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l13.69"></a><span id="l13.69" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l13.70"></a><span id="l13.70">   // Remove our test account to leave the profile clean.</span>
<a href="#l13.71"></a><span id="l13.71">   MailServices.accounts.removeAccount(gPopAccount);</span>
<a href="#l13.72"></a><span id="l13.72">   // There should be only the original accounts left.</span>
<a href="#l13.73"></a><span id="l13.73" class="difflineminus">-  assert_equals(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l13.74"></a><span id="l13.74" class="difflineminus">-}</span>
<a href="#l13.75"></a><span id="l13.75" class="difflineplus">+  Assert.equal(MailServices.accounts.allServers.length, gOriginalAccountCount);</span>
<a href="#l13.76"></a><span id="l13.76" class="difflineplus">+});</span>
<a href="#l13.77"></a><span id="l13.77"> </span>
<a href="#l13.78"></a><span id="l13.78"> /**</span>
<a href="#l13.79"></a><span id="l13.79">  * Bug 208628.</span>
<a href="#l13.80"></a><span id="l13.80">  * Check that if the CC field is empty, enabling CC will automatically</span>
<a href="#l13.81"></a><span id="l13.81">  * prefill the currently default email address.</span>
<a href="#l13.82"></a><span id="l13.82">  */</span>
<a href="#l13.83"></a><span id="l13.83" class="difflineminus">-function test_default_CC_address() {</span>
<a href="#l13.84"></a><span id="l13.84" class="difflineplus">+add_task(function test_default_CC_address() {</span>
<a href="#l13.85"></a><span id="l13.85">   open_advanced_settings(function(amc) {</span>
<a href="#l13.86"></a><span id="l13.86">     subtest_check_default_CC_address(amc);</span>
<a href="#l13.87"></a><span id="l13.87">   });</span>
<a href="#l13.88"></a><span id="l13.88" class="difflineminus">-}</span>
<a href="#l13.89"></a><span id="l13.89" class="difflineplus">+});</span>
<a href="#l13.90"></a><span id="l13.90"> </span>
<a href="#l13.91"></a><span id="l13.91"> /**</span>
<a href="#l13.92"></a><span id="l13.92">  * Check that if the CC field is empty, enabling CC will automatically</span>
<a href="#l13.93"></a><span id="l13.93">  * prefill the currently default email address.</span>
<a href="#l13.94"></a><span id="l13.94">  *</span>
<a href="#l13.95"></a><span id="l13.95">  * @param amc  the account options controller</span>
<a href="#l13.96"></a><span id="l13.96">  */</span>
<a href="#l13.97"></a><span id="l13.97"> function subtest_check_default_CC_address(amc) {</span>
<a href="#l13.98"></a><span id="l13.98" class="difflineat">@@ -90,119 +87,119 @@ function subtest_check_default_CC_addres</span>
<a href="#l13.99"></a><span id="l13.99"> </span>
<a href="#l13.100"></a><span id="l13.100">   let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l13.101"></a><span id="l13.101"> </span>
<a href="#l13.102"></a><span id="l13.102">   let defaultAddress = iframe.contentDocument.getElementById(&quot;identity.email&quot;)</span>
<a href="#l13.103"></a><span id="l13.103">     .value;</span>
<a href="#l13.104"></a><span id="l13.104">   let ccCheck = iframe.contentDocument.getElementById(&quot;identity.doCc&quot;);</span>
<a href="#l13.105"></a><span id="l13.105">   let ccAddress = iframe.contentDocument.getElementById(&quot;identity.doCcList&quot;);</span>
<a href="#l13.106"></a><span id="l13.106">   // The CC checkbox is not enabled and the address value is empty.</span>
<a href="#l13.107"></a><span id="l13.107" class="difflineminus">-  assert_false(ccCheck.checked);</span>
<a href="#l13.108"></a><span id="l13.108" class="difflineminus">-  assert_equals(ccAddress.value, &quot;&quot;);</span>
<a href="#l13.109"></a><span id="l13.109" class="difflineplus">+  Assert.ok(!ccCheck.checked);</span>
<a href="#l13.110"></a><span id="l13.110" class="difflineplus">+  Assert.equal(ccAddress.value, &quot;&quot;);</span>
<a href="#l13.111"></a><span id="l13.111">   // After ticking the CC checkbox the default address should be prefilled.</span>
<a href="#l13.112"></a><span id="l13.112">   amc.check(new elib.Elem(ccCheck), true);</span>
<a href="#l13.113"></a><span id="l13.113" class="difflineminus">-  assert_equals(ccAddress.value, defaultAddress);</span>
<a href="#l13.114"></a><span id="l13.114" class="difflineplus">+  Assert.equal(ccAddress.value, defaultAddress);</span>
<a href="#l13.115"></a><span id="l13.115"> </span>
<a href="#l13.116"></a><span id="l13.116">   let bccCheck = iframe.contentDocument.getElementById(&quot;identity.doBcc&quot;);</span>
<a href="#l13.117"></a><span id="l13.117">   let bccAddress = iframe.contentDocument.getElementById(&quot;identity.doBccList&quot;);</span>
<a href="#l13.118"></a><span id="l13.118">   // The BCC checkbox is not enabled but we set the address value to something.</span>
<a href="#l13.119"></a><span id="l13.119" class="difflineminus">-  assert_false(bccCheck.checked);</span>
<a href="#l13.120"></a><span id="l13.120" class="difflineminus">-  assert_equals(bccAddress.value, &quot;&quot;);</span>
<a href="#l13.121"></a><span id="l13.121" class="difflineplus">+  Assert.ok(!bccCheck.checked);</span>
<a href="#l13.122"></a><span id="l13.122" class="difflineplus">+  Assert.equal(bccAddress.value, &quot;&quot;);</span>
<a href="#l13.123"></a><span id="l13.123">   let bccUserAddress = &quot;somebody@else.invalid&quot;;</span>
<a href="#l13.124"></a><span id="l13.124">   bccAddress.value = bccUserAddress;</span>
<a href="#l13.125"></a><span id="l13.125">   // After ticking the BCC checkbox the current value of the address should not change.</span>
<a href="#l13.126"></a><span id="l13.126">   amc.check(new elib.Elem(bccCheck), true);</span>
<a href="#l13.127"></a><span id="l13.127" class="difflineminus">-  assert_equals(bccAddress.value, bccUserAddress);</span>
<a href="#l13.128"></a><span id="l13.128" class="difflineplus">+  Assert.equal(bccAddress.value, bccUserAddress);</span>
<a href="#l13.129"></a><span id="l13.129"> }</span>
<a href="#l13.130"></a><span id="l13.130"> </span>
<a href="#l13.131"></a><span id="l13.131"> /**</span>
<a href="#l13.132"></a><span id="l13.132">  * Bug 720199.</span>
<a href="#l13.133"></a><span id="l13.133">  * Check if the account name automatically changes when the user changes</span>
<a href="#l13.134"></a><span id="l13.134">  * the username or hostname.</span>
<a href="#l13.135"></a><span id="l13.135">  */</span>
<a href="#l13.136"></a><span id="l13.136" class="difflineminus">-function test_account_name() {</span>
<a href="#l13.137"></a><span id="l13.137" class="difflineplus">+add_task(function test_account_name() {</span>
<a href="#l13.138"></a><span id="l13.138">   // We already have a POP account ready.</span>
<a href="#l13.139"></a><span id="l13.139">   // Create also a NNTP server.</span>
<a href="#l13.140"></a><span id="l13.140">   let nntpServer = MailServices.accounts</span>
<a href="#l13.141"></a><span id="l13.141">     .createIncomingServer(null, &quot;example.nntp.invalid&quot;, &quot;nntp&quot;)</span>
<a href="#l13.142"></a><span id="l13.142">     .QueryInterface(Ci.nsINntpIncomingServer);</span>
<a href="#l13.143"></a><span id="l13.143"> </span>
<a href="#l13.144"></a><span id="l13.144">   let identity = MailServices.accounts.createIdentity();</span>
<a href="#l13.145"></a><span id="l13.145">   identity.email = &quot;tinderbox2@example.invalid&quot;;</span>
<a href="#l13.146"></a><span id="l13.146"> </span>
<a href="#l13.147"></a><span id="l13.147">   let nntpAccount = MailServices.accounts.createAccount();</span>
<a href="#l13.148"></a><span id="l13.148">   nntpAccount.incomingServer = nntpServer;</span>
<a href="#l13.149"></a><span id="l13.149">   nntpAccount.addIdentity(identity);</span>
<a href="#l13.150"></a><span id="l13.150"> </span>
<a href="#l13.151"></a><span id="l13.151" class="difflineminus">-  assert_equals(</span>
<a href="#l13.152"></a><span id="l13.152" class="difflineplus">+  Assert.equal(</span>
<a href="#l13.153"></a><span id="l13.153">     gPopAccount.incomingServer.prettyName,</span>
<a href="#l13.154"></a><span id="l13.154">     &quot;nobody on example.invalid&quot;</span>
<a href="#l13.155"></a><span id="l13.155">   );</span>
<a href="#l13.156"></a><span id="l13.156" class="difflineminus">-  assert_equals(nntpAccount.incomingServer.prettyName, &quot;example.nntp.invalid&quot;);</span>
<a href="#l13.157"></a><span id="l13.157" class="difflineplus">+  Assert.equal(nntpAccount.incomingServer.prettyName, &quot;example.nntp.invalid&quot;);</span>
<a href="#l13.158"></a><span id="l13.158"> </span>
<a href="#l13.159"></a><span id="l13.159">   // The automatic account name update works only if the name is</span>
<a href="#l13.160"></a><span id="l13.160">   // in the form of user@host.</span>
<a href="#l13.161"></a><span id="l13.161">   gPopAccount.incomingServer.prettyName = &quot;nobody@example.invalid&quot;;</span>
<a href="#l13.162"></a><span id="l13.162"> </span>
<a href="#l13.163"></a><span id="l13.163">   let newHost = &quot;some.host.invalid&quot;;</span>
<a href="#l13.164"></a><span id="l13.164">   let newUser = &quot;somebody&quot;;</span>
<a href="#l13.165"></a><span id="l13.165"> </span>
<a href="#l13.166"></a><span id="l13.166">   // On NNTP there is no user name so just set new hostname.</span>
<a href="#l13.167"></a><span id="l13.167">   open_advanced_settings(function(amc) {</span>
<a href="#l13.168"></a><span id="l13.168">     subtest_check_account_name(nntpAccount, newHost, null, amc);</span>
<a href="#l13.169"></a><span id="l13.169">   });</span>
<a href="#l13.170"></a><span id="l13.170"> </span>
<a href="#l13.171"></a><span id="l13.171">   // And see if the account name is updated to it.</span>
<a href="#l13.172"></a><span id="l13.172" class="difflineminus">-  assert_equals(nntpAccount.incomingServer.prettyName, newHost);</span>
<a href="#l13.173"></a><span id="l13.173" class="difflineplus">+  Assert.equal(nntpAccount.incomingServer.prettyName, newHost);</span>
<a href="#l13.174"></a><span id="l13.174"> </span>
<a href="#l13.175"></a><span id="l13.175">   // On POP3 there is both user name and host name.</span>
<a href="#l13.176"></a><span id="l13.176">   // Set new host name first.</span>
<a href="#l13.177"></a><span id="l13.177">   open_advanced_settings(function(amc) {</span>
<a href="#l13.178"></a><span id="l13.178">     subtest_check_account_name(gPopAccount, newHost, null, amc);</span>
<a href="#l13.179"></a><span id="l13.179">   });</span>
<a href="#l13.180"></a><span id="l13.180"> </span>
<a href="#l13.181"></a><span id="l13.181">   // And see if in the account name the host part is updated to it.</span>
<a href="#l13.182"></a><span id="l13.182" class="difflineminus">-  assert_equals(gPopAccount.incomingServer.prettyName, &quot;nobody@&quot; + newHost);</span>
<a href="#l13.183"></a><span id="l13.183" class="difflineplus">+  Assert.equal(gPopAccount.incomingServer.prettyName, &quot;nobody@&quot; + newHost);</span>
<a href="#l13.184"></a><span id="l13.184"> </span>
<a href="#l13.185"></a><span id="l13.185">   // Set new host name first.</span>
<a href="#l13.186"></a><span id="l13.186">   open_advanced_settings(function(amc) {</span>
<a href="#l13.187"></a><span id="l13.187">     subtest_check_account_name(gPopAccount, null, newUser, amc);</span>
<a href="#l13.188"></a><span id="l13.188">   });</span>
<a href="#l13.189"></a><span id="l13.189"> </span>
<a href="#l13.190"></a><span id="l13.190">   // And see if in the account name the user part is updated.</span>
<a href="#l13.191"></a><span id="l13.191" class="difflineminus">-  assert_equals(gPopAccount.incomingServer.prettyName, newUser + &quot;@&quot; + newHost);</span>
<a href="#l13.192"></a><span id="l13.192" class="difflineplus">+  Assert.equal(gPopAccount.incomingServer.prettyName, newUser + &quot;@&quot; + newHost);</span>
<a href="#l13.193"></a><span id="l13.193"> </span>
<a href="#l13.194"></a><span id="l13.194">   newHost = &quot;another.host.invalid&quot;;</span>
<a href="#l13.195"></a><span id="l13.195">   newUser = &quot;anotherbody&quot;;</span>
<a href="#l13.196"></a><span id="l13.196"> </span>
<a href="#l13.197"></a><span id="l13.197">   // Set user name and host name at once.</span>
<a href="#l13.198"></a><span id="l13.198">   open_advanced_settings(function(amc) {</span>
<a href="#l13.199"></a><span id="l13.199">     subtest_check_account_name(gPopAccount, newHost, newUser, amc);</span>
<a href="#l13.200"></a><span id="l13.200">   });</span>
<a href="#l13.201"></a><span id="l13.201"> </span>
<a href="#l13.202"></a><span id="l13.202">   // And see if in the account name the host part is updated to it.</span>
<a href="#l13.203"></a><span id="l13.203" class="difflineminus">-  assert_equals(gPopAccount.incomingServer.prettyName, newUser + &quot;@&quot; + newHost);</span>
<a href="#l13.204"></a><span id="l13.204" class="difflineplus">+  Assert.equal(gPopAccount.incomingServer.prettyName, newUser + &quot;@&quot; + newHost);</span>
<a href="#l13.205"></a><span id="l13.205"> </span>
<a href="#l13.206"></a><span id="l13.206">   // Now have an account name where the name does not match the hostname.</span>
<a href="#l13.207"></a><span id="l13.207">   gPopAccount.incomingServer.prettyName = newUser + &quot;@example.invalid&quot;;</span>
<a href="#l13.208"></a><span id="l13.208"> </span>
<a href="#l13.209"></a><span id="l13.209">   newHost = &quot;third.host.invalid&quot;;</span>
<a href="#l13.210"></a><span id="l13.210">   // Set the host name again.</span>
<a href="#l13.211"></a><span id="l13.211">   open_advanced_settings(function(amc) {</span>
<a href="#l13.212"></a><span id="l13.212">     subtest_check_account_name(gPopAccount, newHost, null, amc);</span>
<a href="#l13.213"></a><span id="l13.213">   });</span>
<a href="#l13.214"></a><span id="l13.214"> </span>
<a href="#l13.215"></a><span id="l13.215">   // And the account name should not be touched.</span>
<a href="#l13.216"></a><span id="l13.216" class="difflineminus">-  assert_equals(</span>
<a href="#l13.217"></a><span id="l13.217" class="difflineplus">+  Assert.equal(</span>
<a href="#l13.218"></a><span id="l13.218">     gPopAccount.incomingServer.prettyName,</span>
<a href="#l13.219"></a><span id="l13.219">     newUser + &quot;@example.invalid&quot;</span>
<a href="#l13.220"></a><span id="l13.220">   );</span>
<a href="#l13.221"></a><span id="l13.221"> </span>
<a href="#l13.222"></a><span id="l13.222">   MailServices.accounts.removeAccount(nntpAccount);</span>
<a href="#l13.223"></a><span id="l13.223" class="difflineminus">-}</span>
<a href="#l13.224"></a><span id="l13.224" class="difflineplus">+});</span>
<a href="#l13.225"></a><span id="l13.225"> </span>
<a href="#l13.226"></a><span id="l13.226"> /**</span>
<a href="#l13.227"></a><span id="l13.227">  * Changes the user name and hostname to the supplied values.</span>
<a href="#l13.228"></a><span id="l13.228">  *</span>
<a href="#l13.229"></a><span id="l13.229">  * @param aAccount      the account to change</span>
<a href="#l13.230"></a><span id="l13.230">  * @param aNewHostname  the hostname value to set</span>
<a href="#l13.231"></a><span id="l13.231">  * @param aNewUsername  the username value to set</span>
<a href="#l13.232"></a><span id="l13.232">  * @param amc           the account options controller</span>
<a href="#l13.233"></a><span id="l13.233" class="difflineat">@@ -210,25 +207,25 @@ function test_account_name() {</span>
<a href="#l13.234"></a><span id="l13.234"> function subtest_check_account_name(aAccount, aNewHostname, aNewUsername, amc) {</span>
<a href="#l13.235"></a><span id="l13.235">   let accountRow = get_account_tree_row(aAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l13.236"></a><span id="l13.236">   click_account_tree_row(amc, accountRow);</span>
<a href="#l13.237"></a><span id="l13.237"> </span>
<a href="#l13.238"></a><span id="l13.238">   let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l13.239"></a><span id="l13.239"> </span>
<a href="#l13.240"></a><span id="l13.240">   if (aNewHostname) {</span>
<a href="#l13.241"></a><span id="l13.241">     let hostname = iframe.contentDocument.getElementById(&quot;server.realHostName&quot;);</span>
<a href="#l13.242"></a><span id="l13.242" class="difflineminus">-    assert_equals(hostname.value, aAccount.incomingServer.realHostName);</span>
<a href="#l13.243"></a><span id="l13.243" class="difflineplus">+    Assert.equal(hostname.value, aAccount.incomingServer.realHostName);</span>
<a href="#l13.244"></a><span id="l13.244"> </span>
<a href="#l13.245"></a><span id="l13.245">     // Now change the server host name.</span>
<a href="#l13.246"></a><span id="l13.246">     hostname.value = aNewHostname;</span>
<a href="#l13.247"></a><span id="l13.247">   }</span>
<a href="#l13.248"></a><span id="l13.248"> </span>
<a href="#l13.249"></a><span id="l13.249">   if (aNewUsername) {</span>
<a href="#l13.250"></a><span id="l13.250">     let username = iframe.contentDocument.getElementById(&quot;server.realUsername&quot;);</span>
<a href="#l13.251"></a><span id="l13.251" class="difflineminus">-    assert_equals(username.value, aAccount.incomingServer.realUsername);</span>
<a href="#l13.252"></a><span id="l13.252" class="difflineplus">+    Assert.equal(username.value, aAccount.incomingServer.realUsername);</span>
<a href="#l13.253"></a><span id="l13.253"> </span>
<a href="#l13.254"></a><span id="l13.254">     // Now change the server user name.</span>
<a href="#l13.255"></a><span id="l13.255">     username.value = aNewUsername;</span>
<a href="#l13.256"></a><span id="l13.256">   }</span>
<a href="#l13.257"></a><span id="l13.257"> </span>
<a href="#l13.258"></a><span id="l13.258">   if (aNewUsername) {</span>
<a href="#l13.259"></a><span id="l13.259">     // If username has changed, we get a confirmation dialog.</span>
<a href="#l13.260"></a><span id="l13.260">     plan_for_modal_dialog(&quot;commonDialog&quot;, function(cdc) {</span>
<a href="#l13.261"></a><span id="l13.261" class="difflineat">@@ -242,38 +239,38 @@ function subtest_check_account_name(aAcc</span>
<a href="#l13.262"></a><span id="l13.262">     wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l13.263"></a><span id="l13.263">   }</span>
<a href="#l13.264"></a><span id="l13.264"> }</span>
<a href="#l13.265"></a><span id="l13.265"> </span>
<a href="#l13.266"></a><span id="l13.266"> /**</span>
<a href="#l13.267"></a><span id="l13.267">  * Bug 536768.</span>
<a href="#l13.268"></a><span id="l13.268">  * Check if invalid junk target settings (folders) are fixed to sane values.</span>
<a href="#l13.269"></a><span id="l13.269">  */</span>
<a href="#l13.270"></a><span id="l13.270" class="difflineminus">-function test_invalid_junk_target() {</span>
<a href="#l13.271"></a><span id="l13.271" class="difflineplus">+add_task(function test_invalid_junk_target() {</span>
<a href="#l13.272"></a><span id="l13.272">   // Set the junk target prefs to invalid values.</span>
<a href="#l13.273"></a><span id="l13.273">   let branch = Services.prefs.getBranch(</span>
<a href="#l13.274"></a><span id="l13.274">     &quot;mail.server.&quot; + gPopAccount.incomingServer.key + &quot;.&quot;</span>
<a href="#l13.275"></a><span id="l13.275">   );</span>
<a href="#l13.276"></a><span id="l13.276">   branch.setCharPref(&quot;spamActionTargetAccount&quot;, &quot;some random non-existent URI&quot;);</span>
<a href="#l13.277"></a><span id="l13.277">   branch.setCharPref(&quot;spamActionTargetFolder&quot;, &quot;some random non-existent URI&quot;);</span>
<a href="#l13.278"></a><span id="l13.278">   let moveOnSpam = true;</span>
<a href="#l13.279"></a><span id="l13.279">   branch.setBoolPref(&quot;moveOnSpam&quot;, moveOnSpam);</span>
<a href="#l13.280"></a><span id="l13.280">   open_advanced_settings(function(amc) {</span>
<a href="#l13.281"></a><span id="l13.281">     subtest_check_invalid_junk_target(amc);</span>
<a href="#l13.282"></a><span id="l13.282">   });</span>
<a href="#l13.283"></a><span id="l13.283"> </span>
<a href="#l13.284"></a><span id="l13.284">   // The pref has no default so its non-existence means it was cleared.</span>
<a href="#l13.285"></a><span id="l13.285">   moveOnSpam = branch.getBoolPref(&quot;moveOnSpam&quot;, false);</span>
<a href="#l13.286"></a><span id="l13.286" class="difflineminus">-  assert_false(moveOnSpam);</span>
<a href="#l13.287"></a><span id="l13.287" class="difflineplus">+  Assert.ok(!moveOnSpam);</span>
<a href="#l13.288"></a><span id="l13.288">   // The targets should point to the same pop account now.</span>
<a href="#l13.289"></a><span id="l13.289">   let targetAccount = branch.getCharPref(&quot;spamActionTargetAccount&quot;);</span>
<a href="#l13.290"></a><span id="l13.290" class="difflineminus">-  assert_equals(targetAccount, gPopAccount.incomingServer.serverURI);</span>
<a href="#l13.291"></a><span id="l13.291" class="difflineplus">+  Assert.equal(targetAccount, gPopAccount.incomingServer.serverURI);</span>
<a href="#l13.292"></a><span id="l13.292">   let targetFolder = branch.getCharPref(&quot;spamActionTargetFolder&quot;);</span>
<a href="#l13.293"></a><span id="l13.293" class="difflineminus">-  assert_equals(targetFolder, gPopAccount.incomingServer.serverURI + &quot;/Junk&quot;);</span>
<a href="#l13.294"></a><span id="l13.294" class="difflineminus">-}</span>
<a href="#l13.295"></a><span id="l13.295" class="difflineplus">+  Assert.equal(targetFolder, gPopAccount.incomingServer.serverURI + &quot;/Junk&quot;);</span>
<a href="#l13.296"></a><span id="l13.296" class="difflineplus">+});</span>
<a href="#l13.297"></a><span id="l13.297"> </span>
<a href="#l13.298"></a><span id="l13.298"> /**</span>
<a href="#l13.299"></a><span id="l13.299">  * Just show the Junk settings pane and let it fix the values.</span>
<a href="#l13.300"></a><span id="l13.300">  *</span>
<a href="#l13.301"></a><span id="l13.301">  * @param amc  the account options controller</span>
<a href="#l13.302"></a><span id="l13.302">  */</span>
<a href="#l13.303"></a><span id="l13.303"> function subtest_check_invalid_junk_target(amc) {</span>
<a href="#l13.304"></a><span id="l13.304">   let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l13.305"></a><span id="l13.305" class="difflineat">@@ -282,63 +279,63 @@ function subtest_check_invalid_junk_targ</span>
<a href="#l13.306"></a><span id="l13.306">   // We need to save the new fixed values so click OK on the Account settings.</span>
<a href="#l13.307"></a><span id="l13.307">   amc.window.document.documentElement.acceptDialog();</span>
<a href="#l13.308"></a><span id="l13.308"> }</span>
<a href="#l13.309"></a><span id="l13.309"> </span>
<a href="#l13.310"></a><span id="l13.310"> /**</span>
<a href="#l13.311"></a><span id="l13.311">  * Bug 327812.</span>
<a href="#l13.312"></a><span id="l13.312">  * Checks if invalid server hostnames are not accepted.</span>
<a href="#l13.313"></a><span id="l13.313">  */</span>
<a href="#l13.314"></a><span id="l13.314" class="difflineminus">-function test_invalid_hostname() {</span>
<a href="#l13.315"></a><span id="l13.315" class="difflineplus">+add_task(function test_invalid_hostname() {</span>
<a href="#l13.316"></a><span id="l13.316">   let branch = Services.prefs.getBranch(</span>
<a href="#l13.317"></a><span id="l13.317">     &quot;mail.server.&quot; + gPopAccount.incomingServer.key + &quot;.&quot;</span>
<a href="#l13.318"></a><span id="l13.318">   );</span>
<a href="#l13.319"></a><span id="l13.319">   let origHostname = branch.getCharPref(&quot;realhostname&quot;);</span>
<a href="#l13.320"></a><span id="l13.320"> </span>
<a href="#l13.321"></a><span id="l13.321">   open_advanced_settings(function(amc) {</span>
<a href="#l13.322"></a><span id="l13.322">     subtest_check_invalid_hostname(amc, false, origHostname);</span>
<a href="#l13.323"></a><span id="l13.323">   });</span>
<a href="#l13.324"></a><span id="l13.324">   open_advanced_settings(function(amc) {</span>
<a href="#l13.325"></a><span id="l13.325">     subtest_check_invalid_hostname(amc, true, origHostname);</span>
<a href="#l13.326"></a><span id="l13.326">   });</span>
<a href="#l13.327"></a><span id="l13.327"> </span>
<a href="#l13.328"></a><span id="l13.328">   // The new bad hostname should not have been saved.</span>
<a href="#l13.329"></a><span id="l13.329">   let newHostname = branch.getCharPref(&quot;realhostname&quot;);</span>
<a href="#l13.330"></a><span id="l13.330" class="difflineminus">-  assert_equals(origHostname, newHostname);</span>
<a href="#l13.331"></a><span id="l13.331" class="difflineminus">-}</span>
<a href="#l13.332"></a><span id="l13.332" class="difflineplus">+  Assert.equal(origHostname, newHostname);</span>
<a href="#l13.333"></a><span id="l13.333" class="difflineplus">+});</span>
<a href="#l13.334"></a><span id="l13.334"> </span>
<a href="#l13.335"></a><span id="l13.335"> /**</span>
<a href="#l13.336"></a><span id="l13.336">  * Set the hostname to an invalid value and check if it gets fixed.</span>
<a href="#l13.337"></a><span id="l13.337">  *</span>
<a href="#l13.338"></a><span id="l13.338">  * @param amc                the account options controller</span>
<a href="#l13.339"></a><span id="l13.339">  * @param aExitSettings      Attempt to close the Account settings dialog.</span>
<a href="#l13.340"></a><span id="l13.340">  * @param aOriginalHostname  Original hostname of this server.</span>
<a href="#l13.341"></a><span id="l13.341">  */</span>
<a href="#l13.342"></a><span id="l13.342"> function subtest_check_invalid_hostname(amc, aExitSettings, aOriginalHostname) {</span>
<a href="#l13.343"></a><span id="l13.343">   let accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l13.344"></a><span id="l13.344">   click_account_tree_row(amc, accountRow);</span>
<a href="#l13.345"></a><span id="l13.345"> </span>
<a href="#l13.346"></a><span id="l13.346">   let iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l13.347"></a><span id="l13.347">   let hostname = iframe.contentDocument.getElementById(&quot;server.realHostName&quot;);</span>
<a href="#l13.348"></a><span id="l13.348" class="difflineminus">-  assert_equals(hostname.value, aOriginalHostname);</span>
<a href="#l13.349"></a><span id="l13.349" class="difflineplus">+  Assert.equal(hostname.value, aOriginalHostname);</span>
<a href="#l13.350"></a><span id="l13.350"> </span>
<a href="#l13.351"></a><span id="l13.351">   hostname.value = &quot;some_invalid+host&amp;domain*in&gt;invalid&quot;;</span>
<a href="#l13.352"></a><span id="l13.352"> </span>
<a href="#l13.353"></a><span id="l13.353">   if (!aExitSettings) {</span>
<a href="#l13.354"></a><span id="l13.354">     accountRow = get_account_tree_row(gPopAccount.key, &quot;am-junk.xul&quot;, amc);</span>
<a href="#l13.355"></a><span id="l13.355">     click_account_tree_row(amc, accountRow);</span>
<a href="#l13.356"></a><span id="l13.356"> </span>
<a href="#l13.357"></a><span id="l13.357">     // The invalid hostname should be set back to previous value at this point...</span>
<a href="#l13.358"></a><span id="l13.358">     accountRow = get_account_tree_row(gPopAccount.key, &quot;am-server.xul&quot;, amc);</span>
<a href="#l13.359"></a><span id="l13.359">     click_account_tree_row(amc, accountRow);</span>
<a href="#l13.360"></a><span id="l13.360"> </span>
<a href="#l13.361"></a><span id="l13.361">     // ...let's check that:</span>
<a href="#l13.362"></a><span id="l13.362">     iframe = amc.window.document.getElementById(&quot;contentFrame&quot;);</span>
<a href="#l13.363"></a><span id="l13.363">     hostname = iframe.contentDocument.getElementById(&quot;server.realHostName&quot;);</span>
<a href="#l13.364"></a><span id="l13.364" class="difflineminus">-    assert_equals(hostname.value, aOriginalHostname);</span>
<a href="#l13.365"></a><span id="l13.365" class="difflineplus">+    Assert.equal(hostname.value, aOriginalHostname);</span>
<a href="#l13.366"></a><span id="l13.366">   } else {</span>
<a href="#l13.367"></a><span id="l13.367">     // If the hostname is bad, we should get a warning dialog.</span>
<a href="#l13.368"></a><span id="l13.368">     plan_for_modal_dialog(&quot;commonDialog&quot;, function(cdc) {</span>
<a href="#l13.369"></a><span id="l13.369">       // Just dismiss it.</span>
<a href="#l13.370"></a><span id="l13.370">       cdc.window.document.documentElement.acceptDialog();</span>
<a href="#l13.371"></a><span id="l13.371">     });</span>
<a href="#l13.372"></a><span id="l13.372"> </span>
<a href="#l13.373"></a><span id="l13.373">     // Click OK on the Account settings.</span>
<a href="#l13.374"></a><span id="l13.374" class="difflineat">@@ -350,23 +347,23 @@ function subtest_check_invalid_hostname(</span>
<a href="#l13.375"></a><span id="l13.375"> </span>
<a href="#l13.376"></a><span id="l13.376"> /**</span>
<a href="#l13.377"></a><span id="l13.377">  * Bug 1426328.</span>
<a href="#l13.378"></a><span id="l13.378">  * Check that the AM will trim user added spaces around text values.</span>
<a href="#l13.379"></a><span id="l13.379">  */</span>
<a href="#l13.380"></a><span id="l13.380"> const badName = &quot;trailing  space &quot;;</span>
<a href="#l13.381"></a><span id="l13.381"> const badEmail = &quot; leading_space@example.com&quot;;</span>
<a href="#l13.382"></a><span id="l13.382"> </span>
<a href="#l13.383"></a><span id="l13.383" class="difflineminus">-function test_trailing_spaces() {</span>
<a href="#l13.384"></a><span id="l13.384" class="difflineplus">+add_task(function test_trailing_spaces() {</span>
<a href="#l13.385"></a><span id="l13.385">   open_advanced_settings(function(amc) {</span>
<a href="#l13.386"></a><span id="l13.386">     subtest_check_trailing_spaces(amc);</span>
<a href="#l13.387"></a><span id="l13.387">   });</span>
<a href="#l13.388"></a><span id="l13.388" class="difflineminus">-  assert_equals(gPopAccount.incomingServer.prettyName, badName.trim());</span>
<a href="#l13.389"></a><span id="l13.389" class="difflineminus">-  assert_equals(gPopAccount.defaultIdentity.email, badEmail.trim());</span>
<a href="#l13.390"></a><span id="l13.390" class="difflineminus">-}</span>
<a href="#l13.391"></a><span id="l13.391" class="difflineplus">+  Assert.equal(gPopAccount.incomingServer.prettyName, badName.trim());</span>
<a href="#l13.392"></a><span id="l13.392" class="difflineplus">+  Assert.equal(gPopAccount.defaultIdentity.email, badEmail.trim());</span>
<a href="#l13.393"></a><span id="l13.393" class="difflineplus">+});</span>
<a href="#l13.394"></a><span id="l13.394"> </span>
<a href="#l13.395"></a><span id="l13.395"> /**</span>
<a href="#l13.396"></a><span id="l13.396">  * Check that the AM will trim user added spaces around text values</span>
<a href="#l13.397"></a><span id="l13.397">  * when storing them into the account.</span>
<a href="#l13.398"></a><span id="l13.398">  *</span>
<a href="#l13.399"></a><span id="l13.399">  * @param amc  the account options controller</span>
<a href="#l13.400"></a><span id="l13.400">  */</span>
<a href="#l13.401"></a><span id="l13.401"> function subtest_check_trailing_spaces(amc) {</span>
<a href="#l13.402"></a><span id="l13.402" class="difflineat">@@ -377,14 +374,14 @@ function subtest_check_trailing_spaces(a</span>
<a href="#l13.403"></a><span id="l13.403"> </span>
<a href="#l13.404"></a><span id="l13.404">   let accountName = iframe.contentDocument.getElementById(&quot;server.prettyName&quot;);</span>
<a href="#l13.405"></a><span id="l13.405">   let defaultAddress = iframe.contentDocument.getElementById(&quot;identity.email&quot;);</span>
<a href="#l13.406"></a><span id="l13.406">   delete_all_existing(amc, new elib.Elem(accountName));</span>
<a href="#l13.407"></a><span id="l13.407">   delete_all_existing(amc, new elib.Elem(defaultAddress));</span>
<a href="#l13.408"></a><span id="l13.408">   input_value(amc, badName, new elib.Elem(accountName));</span>
<a href="#l13.409"></a><span id="l13.409">   input_value(amc, badEmail, new elib.Elem(defaultAddress));</span>
<a href="#l13.410"></a><span id="l13.410"> </span>
<a href="#l13.411"></a><span id="l13.411" class="difflineminus">-  assert_equals(accountName.value, badName);</span>
<a href="#l13.412"></a><span id="l13.412" class="difflineminus">-  assert_equals(defaultAddress.value, badEmail);</span>
<a href="#l13.413"></a><span id="l13.413" class="difflineplus">+  Assert.equal(accountName.value, badName);</span>
<a href="#l13.414"></a><span id="l13.414" class="difflineplus">+  Assert.equal(defaultAddress.value, badEmail);</span>
<a href="#l13.415"></a><span id="l13.415"> </span>
<a href="#l13.416"></a><span id="l13.416">   // We really need to save the new values so click OK on the Account settings.</span>
<a href="#l13.417"></a><span id="l13.417">   amc.window.document.documentElement.acceptDialog();</span>
<a href="#l13.418"></a><span id="l13.418"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">copy from mail/test/mozmill/account/xml/example.com</span>
<a href="#l14.2"></a><span id="l14.2">copy to mail/test/browser/account/xml/example.com</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">new file mode 100644</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineminus">--- /dev/null</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineplus">+++ b/mail/test/browser/account/xml/example.com^headers^</span>
<a href="#l15.4"></a><span id="l15.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l15.5"></a><span id="l15.5" class="difflineplus">+Content-Type: text/xml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">copy from mail/test/mozmill/account/xml/momo.invalid</span>
<a href="#l16.2"></a><span id="l16.2">copy to mail/test/browser/account/xml/momo.invalid</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">new file mode 100644</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineminus">--- /dev/null</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineplus">+++ b/mail/test/browser/account/xml/momo.invalid^headers^</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineat">@@ -0,0 +1,1 @@</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineplus">+Content-Type: text/xml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">new file mode 100644</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineminus">--- /dev/null</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineplus">+++ b/mail/test/browser/addrbook/browser.ini</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l18.6"></a><span id="l18.6" class="difflineplus">+prefs =</span>
<a href="#l18.7"></a><span id="l18.7" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l18.8"></a><span id="l18.8" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l18.9"></a><span id="l18.9" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l18.10"></a><span id="l18.10" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l18.11"></a><span id="l18.11" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l18.13"></a><span id="l18.13" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+[browser_addressBook.js]</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+[browser_addressBookPanes.js]</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+[browser_updateMailingList.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">copy from mail/test/mozmill/addrbook/test-address-book.js</span>
<a href="#l19.2"></a><span id="l19.2">copy to mail/test/browser/addrbook/browser_addressBook.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineminus">--- a/mail/test/mozmill/addrbook/test-address-book.js</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineplus">+++ b/mail/test/browser/addrbook/browser_addressBook.js</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineat">@@ -21,27 +21,19 @@ var {</span>
<a href="#l19.6"></a><span id="l19.6">   open_address_book_window,</span>
<a href="#l19.7"></a><span id="l19.7">   select_address_book,</span>
<a href="#l19.8"></a><span id="l19.8">   select_contacts,</span>
<a href="#l19.9"></a><span id="l19.9">   set_address_books_collapsed,</span>
<a href="#l19.10"></a><span id="l19.10">   set_address_books_expanded,</span>
<a href="#l19.11"></a><span id="l19.11"> } = ChromeUtils.import(</span>
<a href="#l19.12"></a><span id="l19.12">   &quot;resource://testing-common/mozmill/AddressBookHelpers.jsm&quot;</span>
<a href="#l19.13"></a><span id="l19.13"> );</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-var { wait_for_compose_window } = ChromeUtils.import(</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+var { close_compose_window, wait_for_compose_window } = ChromeUtils.import(</span>
<a href="#l19.16"></a><span id="l19.16">   &quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;</span>
<a href="#l19.17"></a><span id="l19.17"> );</span>
<a href="#l19.18"></a><span id="l19.18" class="difflineminus">-var {</span>
<a href="#l19.19"></a><span id="l19.19" class="difflineminus">-  assert_equals,</span>
<a href="#l19.20"></a><span id="l19.20" class="difflineminus">-  assert_false,</span>
<a href="#l19.21"></a><span id="l19.21" class="difflineminus">-  assert_not_equals,</span>
<a href="#l19.22"></a><span id="l19.22" class="difflineminus">-  assert_true,</span>
<a href="#l19.23"></a><span id="l19.23" class="difflineminus">-} = ChromeUtils.import(</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineminus">-  &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l19.25"></a><span id="l19.25" class="difflineminus">-);</span>
<a href="#l19.26"></a><span id="l19.26"> var { gMockPromptService } = ChromeUtils.import(</span>
<a href="#l19.27"></a><span id="l19.27">   &quot;resource://testing-common/mozmill/PromptHelpers.jsm&quot;</span>
<a href="#l19.28"></a><span id="l19.28"> );</span>
<a href="#l19.29"></a><span id="l19.29"> var { plan_for_new_window } = ChromeUtils.import(</span>
<a href="#l19.30"></a><span id="l19.30">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l19.31"></a><span id="l19.31"> );</span>
<a href="#l19.32"></a><span id="l19.32"> </span>
<a href="#l19.33"></a><span id="l19.33"> var { XPCOMUtils } = ChromeUtils.import(</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineat">@@ -51,17 +43,17 @@ var { Services } = ChromeUtils.import(&quot;r</span>
<a href="#l19.35"></a><span id="l19.35"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l19.36"></a><span id="l19.36">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l19.37"></a><span id="l19.37"> );</span>
<a href="#l19.38"></a><span id="l19.38"> </span>
<a href="#l19.39"></a><span id="l19.39"> var abController = null;</span>
<a href="#l19.40"></a><span id="l19.40"> var addrBook1, addrBook2, addrBook3, addrBook4, ldapBook;</span>
<a href="#l19.41"></a><span id="l19.41"> var mListA, mListB, mListC, mListD, mListE;</span>
<a href="#l19.42"></a><span id="l19.42"> </span>
<a href="#l19.43"></a><span id="l19.43" class="difflineminus">-function setupModule(module) {</span>
<a href="#l19.44"></a><span id="l19.44" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l19.45"></a><span id="l19.45">   // Open the address book main window</span>
<a href="#l19.46"></a><span id="l19.46">   abController = open_address_book_window();</span>
<a href="#l19.47"></a><span id="l19.47"> </span>
<a href="#l19.48"></a><span id="l19.48">   // Let's add some new address books.  I'll add them</span>
<a href="#l19.49"></a><span id="l19.49">   // out of order to properly test the alphabetical</span>
<a href="#l19.50"></a><span id="l19.50">   // ordering of the address books.</span>
<a href="#l19.51"></a><span id="l19.51">   ldapBook = create_ldap_address_book(&quot;LDAP Book&quot;);</span>
<a href="#l19.52"></a><span id="l19.52">   addrBook3 = create_address_book(&quot;AB 3&quot;);</span>
<a href="#l19.53"></a><span id="l19.53" class="difflineat">@@ -85,21 +77,21 @@ function setupModule(module) {</span>
<a href="#l19.54"></a><span id="l19.54">   // and Collected Address Book.  So let's ensure that those address books</span>
<a href="#l19.55"></a><span id="l19.55">   // exist in the tree view before executing our tests.</span>
<a href="#l19.56"></a><span id="l19.56">   abController.waitFor(</span>
<a href="#l19.57"></a><span id="l19.57">     () =&gt; abController.window.gDirectoryTreeView.rowCount == 8,</span>
<a href="#l19.58"></a><span id="l19.58">     &quot;Timeout waiting for all 8 rows in address books list to show up in the tree view&quot;,</span>
<a href="#l19.59"></a><span id="l19.59">     1000,</span>
<a href="#l19.60"></a><span id="l19.60">     10</span>
<a href="#l19.61"></a><span id="l19.61">   );</span>
<a href="#l19.62"></a><span id="l19.62" class="difflineminus">-}</span>
<a href="#l19.63"></a><span id="l19.63" class="difflineplus">+});</span>
<a href="#l19.64"></a><span id="l19.64"> </span>
<a href="#l19.65"></a><span id="l19.65" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l19.66"></a><span id="l19.66" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l19.67"></a><span id="l19.67">   close_address_book_window(abController);</span>
<a href="#l19.68"></a><span id="l19.68" class="difflineminus">-}</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+});</span>
<a href="#l19.70"></a><span id="l19.70"> </span>
<a href="#l19.71"></a><span id="l19.71"> /* Test that the address book manager automatically sorts</span>
<a href="#l19.72"></a><span id="l19.72">  * address books.</span>
<a href="#l19.73"></a><span id="l19.73">  *</span>
<a href="#l19.74"></a><span id="l19.74">  * Currently, we sort address books as follows:</span>
<a href="#l19.75"></a><span id="l19.75">  * 1. All Address Books</span>
<a href="#l19.76"></a><span id="l19.76">  * 2. Personal Address Book</span>
<a href="#l19.77"></a><span id="l19.77">  * 3. Mork Address Books</span>
<a href="#l19.78"></a><span id="l19.78" class="difflineat">@@ -117,75 +109,75 @@ function teardownModule(module) {</span>
<a href="#l19.79"></a><span id="l19.79">  *    ML B</span>
<a href="#l19.80"></a><span id="l19.80">  * AB 3</span>
<a href="#l19.81"></a><span id="l19.81">  *    ML C</span>
<a href="#l19.82"></a><span id="l19.82">  *    ML D</span>
<a href="#l19.83"></a><span id="l19.83">  * AB 4</span>
<a href="#l19.84"></a><span id="l19.84">  * LDAP Book</span>
<a href="#l19.85"></a><span id="l19.85">  * Collected Address Book</span>
<a href="#l19.86"></a><span id="l19.86">  **/</span>
<a href="#l19.87"></a><span id="l19.87" class="difflineminus">-function test_order_of_address_books() {</span>
<a href="#l19.88"></a><span id="l19.88" class="difflineplus">+add_task(function test_order_of_address_books() {</span>
<a href="#l19.89"></a><span id="l19.89">   const EXPECTED_AB_ORDER = [</span>
<a href="#l19.90"></a><span id="l19.90">     &quot;All Address Books&quot;,</span>
<a href="#l19.91"></a><span id="l19.91">     &quot;Personal Address Book&quot;,</span>
<a href="#l19.92"></a><span id="l19.92">     &quot;AB 1&quot;,</span>
<a href="#l19.93"></a><span id="l19.93">     &quot;AB 2&quot;,</span>
<a href="#l19.94"></a><span id="l19.94">     &quot;AB 3&quot;,</span>
<a href="#l19.95"></a><span id="l19.95">     &quot;AB 4&quot;,</span>
<a href="#l19.96"></a><span id="l19.96">     &quot;LDAP Book&quot;,</span>
<a href="#l19.97"></a><span id="l19.97">     &quot;Collected Addresses&quot;,</span>
<a href="#l19.98"></a><span id="l19.98">   ];</span>
<a href="#l19.99"></a><span id="l19.99"> </span>
<a href="#l19.100"></a><span id="l19.100">   for (let i = 0; i &lt; EXPECTED_AB_ORDER.length; i++) {</span>
<a href="#l19.101"></a><span id="l19.101">     let abName = get_name_of_address_book_element_at(i);</span>
<a href="#l19.102"></a><span id="l19.102" class="difflineminus">-    assert_equals(</span>
<a href="#l19.103"></a><span id="l19.103" class="difflineplus">+    Assert.equal(</span>
<a href="#l19.104"></a><span id="l19.104">       abName,</span>
<a href="#l19.105"></a><span id="l19.105">       EXPECTED_AB_ORDER[i],</span>
<a href="#l19.106"></a><span id="l19.106">       &quot;The address books are out of order.&quot;</span>
<a href="#l19.107"></a><span id="l19.107">     );</span>
<a href="#l19.108"></a><span id="l19.108">   }</span>
<a href="#l19.109"></a><span id="l19.109" class="difflineminus">-}</span>
<a href="#l19.110"></a><span id="l19.110" class="difflineplus">+});</span>
<a href="#l19.111"></a><span id="l19.111"> </span>
<a href="#l19.112"></a><span id="l19.112"> /* Test that the expanded and collapsed states of address books</span>
<a href="#l19.113"></a><span id="l19.113">  * in the tree persist state when closing and re-opening the</span>
<a href="#l19.114"></a><span id="l19.114">  * address book manager</span>
<a href="#l19.115"></a><span id="l19.115">  */</span>
<a href="#l19.116"></a><span id="l19.116" class="difflineminus">-function test_persist_collapsed_and_expanded_states() {</span>
<a href="#l19.117"></a><span id="l19.117" class="difflineplus">+add_task(function test_persist_collapsed_and_expanded_states() {</span>
<a href="#l19.118"></a><span id="l19.118">   // Set the state of address books 1 and 3 to expanded</span>
<a href="#l19.119"></a><span id="l19.119">   set_address_books_expanded([addrBook1, addrBook3]);</span>
<a href="#l19.120"></a><span id="l19.120"> </span>
<a href="#l19.121"></a><span id="l19.121">   // Set address book 2 to be collapsed</span>
<a href="#l19.122"></a><span id="l19.122">   set_address_books_collapsed(addrBook2);</span>
<a href="#l19.123"></a><span id="l19.123"> </span>
<a href="#l19.124"></a><span id="l19.124">   // Now close and re-open the address book</span>
<a href="#l19.125"></a><span id="l19.125">   close_address_book_window(abController);</span>
<a href="#l19.126"></a><span id="l19.126">   abController = open_address_book_window();</span>
<a href="#l19.127"></a><span id="l19.127"> </span>
<a href="#l19.128"></a><span id="l19.128" class="difflineminus">-  assert_true(is_address_book_collapsed(addrBook2));</span>
<a href="#l19.129"></a><span id="l19.129" class="difflineminus">-  assert_true(!is_address_book_collapsed(addrBook1));</span>
<a href="#l19.130"></a><span id="l19.130" class="difflineminus">-  assert_true(!is_address_book_collapsed(addrBook3));</span>
<a href="#l19.131"></a><span id="l19.131" class="difflineplus">+  Assert.ok(is_address_book_collapsed(addrBook2));</span>
<a href="#l19.132"></a><span id="l19.132" class="difflineplus">+  Assert.ok(!is_address_book_collapsed(addrBook1));</span>
<a href="#l19.133"></a><span id="l19.133" class="difflineplus">+  Assert.ok(!is_address_book_collapsed(addrBook3));</span>
<a href="#l19.134"></a><span id="l19.134"> </span>
<a href="#l19.135"></a><span id="l19.135">   // Now set the state of address books 1 and 3 to collapsed</span>
<a href="#l19.136"></a><span id="l19.136">   // and make sure 2 is expanded</span>
<a href="#l19.137"></a><span id="l19.137">   set_address_books_collapsed([addrBook1, addrBook3]);</span>
<a href="#l19.138"></a><span id="l19.138">   set_address_books_expanded(addrBook2);</span>
<a href="#l19.139"></a><span id="l19.139"> </span>
<a href="#l19.140"></a><span id="l19.140">   // Now close and re-open the address book</span>
<a href="#l19.141"></a><span id="l19.141">   close_address_book_window(abController);</span>
<a href="#l19.142"></a><span id="l19.142">   abController = open_address_book_window();</span>
<a href="#l19.143"></a><span id="l19.143"> </span>
<a href="#l19.144"></a><span id="l19.144" class="difflineminus">-  assert_true(!is_address_book_collapsed(addrBook2));</span>
<a href="#l19.145"></a><span id="l19.145" class="difflineminus">-  assert_true(is_address_book_collapsed(addrBook1));</span>
<a href="#l19.146"></a><span id="l19.146" class="difflineminus">-  assert_true(is_address_book_collapsed(addrBook3));</span>
<a href="#l19.147"></a><span id="l19.147" class="difflineminus">-}</span>
<a href="#l19.148"></a><span id="l19.148" class="difflineplus">+  Assert.ok(!is_address_book_collapsed(addrBook2));</span>
<a href="#l19.149"></a><span id="l19.149" class="difflineplus">+  Assert.ok(is_address_book_collapsed(addrBook1));</span>
<a href="#l19.150"></a><span id="l19.150" class="difflineplus">+  Assert.ok(is_address_book_collapsed(addrBook3));</span>
<a href="#l19.151"></a><span id="l19.151" class="difflineplus">+});</span>
<a href="#l19.152"></a><span id="l19.152"> </span>
<a href="#l19.153"></a><span id="l19.153"> /* Test that if we try to delete a contact, that we are given</span>
<a href="#l19.154"></a><span id="l19.154">  * a confirm prompt.</span>
<a href="#l19.155"></a><span id="l19.155">  */</span>
<a href="#l19.156"></a><span id="l19.156" class="difflineminus">-function test_deleting_contact_causes_confirm_prompt() {</span>
<a href="#l19.157"></a><span id="l19.157" class="difflineplus">+add_task(function test_deleting_contact_causes_confirm_prompt() {</span>
<a href="#l19.158"></a><span id="l19.158">   // Register the Mock Prompt Service</span>
<a href="#l19.159"></a><span id="l19.159">   gMockPromptService.register();</span>
<a href="#l19.160"></a><span id="l19.160"> </span>
<a href="#l19.161"></a><span id="l19.161">   // Create a contact that we'll try to delete</span>
<a href="#l19.162"></a><span id="l19.162">   let contact1 = create_contact(&quot;test@example.com&quot;, &quot;Sammy Jenkis&quot;, true);</span>
<a href="#l19.163"></a><span id="l19.163">   let toDelete = [contact1];</span>
<a href="#l19.164"></a><span id="l19.164"> </span>
<a href="#l19.165"></a><span id="l19.165">   let bundle = Services.strings.createBundle(</span>
<a href="#l19.166"></a><span id="l19.166" class="difflineat">@@ -204,51 +196,51 @@ function test_deleting_contact_causes_co</span>
<a href="#l19.167"></a><span id="l19.167">   // contact should not be deleted.</span>
<a href="#l19.168"></a><span id="l19.168">   gMockPromptService.returnValue = false;</span>
<a href="#l19.169"></a><span id="l19.169"> </span>
<a href="#l19.170"></a><span id="l19.170">   // Now attempt to delete the contact</span>
<a href="#l19.171"></a><span id="l19.171">   select_contacts(toDelete);</span>
<a href="#l19.172"></a><span id="l19.172">   abController.keypress(null, &quot;VK_DELETE&quot;, {});</span>
<a href="#l19.173"></a><span id="l19.173"> </span>
<a href="#l19.174"></a><span id="l19.174">   let promptState = gMockPromptService.promptState;</span>
<a href="#l19.175"></a><span id="l19.175" class="difflineminus">-  assert_not_equals(null, promptState, &quot;Expected a prompt state&quot;);</span>
<a href="#l19.176"></a><span id="l19.176" class="difflineplus">+  Assert.notEqual(null, promptState, &quot;Expected a prompt state&quot;);</span>
<a href="#l19.177"></a><span id="l19.177">   // Was a confirm displayed?</span>
<a href="#l19.178"></a><span id="l19.178" class="difflineminus">-  assert_equals(&quot;confirm&quot;, promptState.method);</span>
<a href="#l19.179"></a><span id="l19.179" class="difflineplus">+  Assert.equal(&quot;confirm&quot;, promptState.method);</span>
<a href="#l19.180"></a><span id="l19.180">   // Was the right message displayed?</span>
<a href="#l19.181"></a><span id="l19.181" class="difflineminus">-  assert_equals(confirmSingle, promptState.text);</span>
<a href="#l19.182"></a><span id="l19.182" class="difflineplus">+  Assert.equal(confirmSingle, promptState.text);</span>
<a href="#l19.183"></a><span id="l19.183">   // The contact should not have been deleted.</span>
<a href="#l19.184"></a><span id="l19.184" class="difflineminus">-  assert_equals(abController.window.gAbView.rowCount, totalEntries);</span>
<a href="#l19.185"></a><span id="l19.185" class="difflineplus">+  Assert.equal(abController.window.gAbView.rowCount, totalEntries);</span>
<a href="#l19.186"></a><span id="l19.186"> </span>
<a href="#l19.187"></a><span id="l19.187">   gMockPromptService.reset();</span>
<a href="#l19.188"></a><span id="l19.188"> </span>
<a href="#l19.189"></a><span id="l19.189">   // Now we'll return true on confirm so that</span>
<a href="#l19.190"></a><span id="l19.190">   // the contact is deleted.</span>
<a href="#l19.191"></a><span id="l19.191">   gMockPromptService.returnValue = true;</span>
<a href="#l19.192"></a><span id="l19.192">   select_contacts(toDelete);</span>
<a href="#l19.193"></a><span id="l19.193">   abController.keypress(null, &quot;VK_DELETE&quot;, {});</span>
<a href="#l19.194"></a><span id="l19.194"> </span>
<a href="#l19.195"></a><span id="l19.195">   promptState = gMockPromptService.promptState;</span>
<a href="#l19.196"></a><span id="l19.196" class="difflineminus">-  assert_not_equals(null, promptState, &quot;Expected a prompt state&quot;);</span>
<a href="#l19.197"></a><span id="l19.197" class="difflineplus">+  Assert.notEqual(null, promptState, &quot;Expected a prompt state&quot;);</span>
<a href="#l19.198"></a><span id="l19.198">   // Was a confirm displayed?</span>
<a href="#l19.199"></a><span id="l19.199" class="difflineminus">-  assert_equals(&quot;confirm&quot;, promptState.method);</span>
<a href="#l19.200"></a><span id="l19.200" class="difflineplus">+  Assert.equal(&quot;confirm&quot;, promptState.method);</span>
<a href="#l19.201"></a><span id="l19.201">   // Was the right message displayed?</span>
<a href="#l19.202"></a><span id="l19.202" class="difflineminus">-  assert_equals(confirmSingle, promptState.text);</span>
<a href="#l19.203"></a><span id="l19.203" class="difflineplus">+  Assert.equal(confirmSingle, promptState.text);</span>
<a href="#l19.204"></a><span id="l19.204">   // The contact should have been deleted.</span>
<a href="#l19.205"></a><span id="l19.205" class="difflineminus">-  assert_equals(</span>
<a href="#l19.206"></a><span id="l19.206" class="difflineplus">+  Assert.equal(</span>
<a href="#l19.207"></a><span id="l19.207">     abController.window.gAbView.rowCount,</span>
<a href="#l19.208"></a><span id="l19.208">     totalEntries - toDelete.length</span>
<a href="#l19.209"></a><span id="l19.209">   );</span>
<a href="#l19.210"></a><span id="l19.210"> </span>
<a href="#l19.211"></a><span id="l19.211">   gMockPromptService.unregister();</span>
<a href="#l19.212"></a><span id="l19.212" class="difflineminus">-}</span>
<a href="#l19.213"></a><span id="l19.213" class="difflineplus">+});</span>
<a href="#l19.214"></a><span id="l19.214"> </span>
<a href="#l19.215"></a><span id="l19.215"> /* Test that if we try to delete multiple contacts, that we are give</span>
<a href="#l19.216"></a><span id="l19.216">  * a confirm prompt.</span>
<a href="#l19.217"></a><span id="l19.217">  */</span>
<a href="#l19.218"></a><span id="l19.218" class="difflineminus">-function test_deleting_contacts_causes_confirm_prompt() {</span>
<a href="#l19.219"></a><span id="l19.219" class="difflineplus">+add_task(function test_deleting_contacts_causes_confirm_prompt() {</span>
<a href="#l19.220"></a><span id="l19.220">   // Register the Mock Prompt Service</span>
<a href="#l19.221"></a><span id="l19.221">   gMockPromptService.register();</span>
<a href="#l19.222"></a><span id="l19.222"> </span>
<a href="#l19.223"></a><span id="l19.223">   // Create some contacts that we'll try to delete.</span>
<a href="#l19.224"></a><span id="l19.224">   let contact2 = create_contact(&quot;test2@example.com&quot;, &quot;Leonard Shelby&quot;, true);</span>
<a href="#l19.225"></a><span id="l19.225">   let contact3 = create_contact(</span>
<a href="#l19.226"></a><span id="l19.226">     &quot;test3@example.com&quot;,</span>
<a href="#l19.227"></a><span id="l19.227">     &quot;John Edward Gammell&quot;,</span>
<a href="#l19.228"></a><span id="l19.228" class="difflineat">@@ -276,99 +268,99 @@ function test_deleting_contacts_causes_c</span>
<a href="#l19.229"></a><span id="l19.229">   // contact should not be deleted.</span>
<a href="#l19.230"></a><span id="l19.230">   gMockPromptService.returnValue = false;</span>
<a href="#l19.231"></a><span id="l19.231"> </span>
<a href="#l19.232"></a><span id="l19.232">   // Now attempt to delete the contact</span>
<a href="#l19.233"></a><span id="l19.233">   select_contacts(toDelete);</span>
<a href="#l19.234"></a><span id="l19.234">   abController.keypress(null, &quot;VK_DELETE&quot;, {});</span>
<a href="#l19.235"></a><span id="l19.235"> </span>
<a href="#l19.236"></a><span id="l19.236">   let promptState = gMockPromptService.promptState;</span>
<a href="#l19.237"></a><span id="l19.237" class="difflineminus">-  assert_not_equals(null, promptState, &quot;Expected a prompt state&quot;);</span>
<a href="#l19.238"></a><span id="l19.238" class="difflineplus">+  Assert.notEqual(null, promptState, &quot;Expected a prompt state&quot;);</span>
<a href="#l19.239"></a><span id="l19.239">   // Was a confirm displayed?</span>
<a href="#l19.240"></a><span id="l19.240" class="difflineminus">-  assert_equals(&quot;confirm&quot;, promptState.method);</span>
<a href="#l19.241"></a><span id="l19.241" class="difflineplus">+  Assert.equal(&quot;confirm&quot;, promptState.method);</span>
<a href="#l19.242"></a><span id="l19.242">   // Was the right message displayed?</span>
<a href="#l19.243"></a><span id="l19.243" class="difflineminus">-  assert_equals(confirmMultiple, promptState.text);</span>
<a href="#l19.244"></a><span id="l19.244" class="difflineplus">+  Assert.equal(confirmMultiple, promptState.text);</span>
<a href="#l19.245"></a><span id="l19.245">   // The contact should not have been deleted.</span>
<a href="#l19.246"></a><span id="l19.246" class="difflineminus">-  assert_equals(abController.window.gAbView.rowCount, totalEntries);</span>
<a href="#l19.247"></a><span id="l19.247" class="difflineplus">+  Assert.equal(abController.window.gAbView.rowCount, totalEntries);</span>
<a href="#l19.248"></a><span id="l19.248"> </span>
<a href="#l19.249"></a><span id="l19.249">   gMockPromptService.reset();</span>
<a href="#l19.250"></a><span id="l19.250"> </span>
<a href="#l19.251"></a><span id="l19.251">   // Now we'll return true on confirm so that</span>
<a href="#l19.252"></a><span id="l19.252">   // the contact is deleted.</span>
<a href="#l19.253"></a><span id="l19.253">   gMockPromptService.returnValue = true;</span>
<a href="#l19.254"></a><span id="l19.254">   select_contacts(toDelete);</span>
<a href="#l19.255"></a><span id="l19.255">   abController.keypress(null, &quot;VK_DELETE&quot;, {});</span>
<a href="#l19.256"></a><span id="l19.256"> </span>
<a href="#l19.257"></a><span id="l19.257">   promptState = gMockPromptService.promptState;</span>
<a href="#l19.258"></a><span id="l19.258" class="difflineminus">-  assert_not_equals(null, promptState, &quot;Expected a prompt state&quot;);</span>
<a href="#l19.259"></a><span id="l19.259" class="difflineplus">+  Assert.notEqual(null, promptState, &quot;Expected a prompt state&quot;);</span>
<a href="#l19.260"></a><span id="l19.260">   // Was a confirm displayed?</span>
<a href="#l19.261"></a><span id="l19.261" class="difflineminus">-  assert_equals(&quot;confirm&quot;, promptState.method);</span>
<a href="#l19.262"></a><span id="l19.262" class="difflineplus">+  Assert.equal(&quot;confirm&quot;, promptState.method);</span>
<a href="#l19.263"></a><span id="l19.263">   // Was the right message displayed?</span>
<a href="#l19.264"></a><span id="l19.264" class="difflineminus">-  assert_equals(confirmMultiple, promptState.text);</span>
<a href="#l19.265"></a><span id="l19.265" class="difflineplus">+  Assert.equal(confirmMultiple, promptState.text);</span>
<a href="#l19.266"></a><span id="l19.266">   // The contact should have been deleted.</span>
<a href="#l19.267"></a><span id="l19.267" class="difflineminus">-  assert_equals(</span>
<a href="#l19.268"></a><span id="l19.268" class="difflineplus">+  Assert.equal(</span>
<a href="#l19.269"></a><span id="l19.269">     abController.window.gAbView.rowCount,</span>
<a href="#l19.270"></a><span id="l19.270">     totalEntries - toDelete.length</span>
<a href="#l19.271"></a><span id="l19.271">   );</span>
<a href="#l19.272"></a><span id="l19.272"> </span>
<a href="#l19.273"></a><span id="l19.273">   gMockPromptService.unregister();</span>
<a href="#l19.274"></a><span id="l19.274" class="difflineminus">-}</span>
<a href="#l19.275"></a><span id="l19.275" class="difflineplus">+});</span>
<a href="#l19.276"></a><span id="l19.276"> </span>
<a href="#l19.277"></a><span id="l19.277"> /* Tests that attempting to delete a mailing list causes a</span>
<a href="#l19.278"></a><span id="l19.278">  * confirmation dialog to be brought up, and that deletion</span>
<a href="#l19.279"></a><span id="l19.279">  * actually works if the user clicks &quot;OK&quot;.</span>
<a href="#l19.280"></a><span id="l19.280">  */</span>
<a href="#l19.281"></a><span id="l19.281" class="difflineminus">-function test_deleting_mailing_lists() {</span>
<a href="#l19.282"></a><span id="l19.282" class="difflineplus">+add_task(function test_deleting_mailing_lists() {</span>
<a href="#l19.283"></a><span id="l19.283">   // Register our Mock Prompt Service</span>
<a href="#l19.284"></a><span id="l19.284">   gMockPromptService.register();</span>
<a href="#l19.285"></a><span id="l19.285"> </span>
<a href="#l19.286"></a><span id="l19.286">   // Create a new mailing list, and add it to one of our</span>
<a href="#l19.287"></a><span id="l19.287">   // address books</span>
<a href="#l19.288"></a><span id="l19.288">   let newList = create_mailing_list(&quot;Delete Me!&quot;);</span>
<a href="#l19.289"></a><span id="l19.289">   let addedList = addrBook1.addMailList(newList);</span>
<a href="#l19.290"></a><span id="l19.290"> </span>
<a href="#l19.291"></a><span id="l19.291">   // Make sure it got added.</span>
<a href="#l19.292"></a><span id="l19.292" class="difflineminus">-  assert_true(addrBook1.hasDirectory(addedList));</span>
<a href="#l19.293"></a><span id="l19.293" class="difflineplus">+  Assert.ok(addrBook1.hasDirectory(addedList));</span>
<a href="#l19.294"></a><span id="l19.294"> </span>
<a href="#l19.295"></a><span id="l19.295">   // Let's click &quot;cancel&quot; on the confirm dialog box</span>
<a href="#l19.296"></a><span id="l19.296">   // first.</span>
<a href="#l19.297"></a><span id="l19.297">   gMockPromptService.returnValue = false;</span>
<a href="#l19.298"></a><span id="l19.298"> </span>
<a href="#l19.299"></a><span id="l19.299">   abController.window.AbDeleteDirectory(addedList.URI);</span>
<a href="#l19.300"></a><span id="l19.300"> </span>
<a href="#l19.301"></a><span id="l19.301">   let promptState = gMockPromptService.promptState;</span>
<a href="#l19.302"></a><span id="l19.302" class="difflineminus">-  assert_not_equals(null, promptState, &quot;Expected a prompt state&quot;);</span>
<a href="#l19.303"></a><span id="l19.303" class="difflineplus">+  Assert.notEqual(null, promptState, &quot;Expected a prompt state&quot;);</span>
<a href="#l19.304"></a><span id="l19.304"> </span>
<a href="#l19.305"></a><span id="l19.305">   // Test that the confirmation dialog was brought up.</span>
<a href="#l19.306"></a><span id="l19.306" class="difflineminus">-  assert_equals(&quot;confirm&quot;, promptState.method);</span>
<a href="#l19.307"></a><span id="l19.307" class="difflineplus">+  Assert.equal(&quot;confirm&quot;, promptState.method);</span>
<a href="#l19.308"></a><span id="l19.308"> </span>
<a href="#l19.309"></a><span id="l19.309">   // Ensure that the mailing list was not removed.</span>
<a href="#l19.310"></a><span id="l19.310" class="difflineminus">-  assert_true(addrBook1.hasDirectory(addedList));</span>
<a href="#l19.311"></a><span id="l19.311" class="difflineplus">+  Assert.ok(addrBook1.hasDirectory(addedList));</span>
<a href="#l19.312"></a><span id="l19.312"> </span>
<a href="#l19.313"></a><span id="l19.313">   // This time, let's click &quot;OK&quot; on the confirm dialog box</span>
<a href="#l19.314"></a><span id="l19.314">   gMockPromptService.reset();</span>
<a href="#l19.315"></a><span id="l19.315">   gMockPromptService.returnValue = true;</span>
<a href="#l19.316"></a><span id="l19.316"> </span>
<a href="#l19.317"></a><span id="l19.317">   abController.window.AbDeleteDirectory(addedList.URI);</span>
<a href="#l19.318"></a><span id="l19.318"> </span>
<a href="#l19.319"></a><span id="l19.319">   // Test that the confirmation dialog was brought up.</span>
<a href="#l19.320"></a><span id="l19.320">   promptState = gMockPromptService.promptState;</span>
<a href="#l19.321"></a><span id="l19.321" class="difflineminus">-  assert_not_equals(null, promptState, &quot;Expected a prompt state&quot;);</span>
<a href="#l19.322"></a><span id="l19.322" class="difflineminus">-  assert_equals(&quot;confirm&quot;, promptState.method);</span>
<a href="#l19.323"></a><span id="l19.323" class="difflineplus">+  Assert.notEqual(null, promptState, &quot;Expected a prompt state&quot;);</span>
<a href="#l19.324"></a><span id="l19.324" class="difflineplus">+  Assert.equal(&quot;confirm&quot;, promptState.method);</span>
<a href="#l19.325"></a><span id="l19.325"> </span>
<a href="#l19.326"></a><span id="l19.326">   // Ensure that the mailing list was removed.</span>
<a href="#l19.327"></a><span id="l19.327" class="difflineminus">-  assert_false(addrBook1.hasDirectory(addedList));</span>
<a href="#l19.328"></a><span id="l19.328" class="difflineplus">+  Assert.ok(!addrBook1.hasDirectory(addedList));</span>
<a href="#l19.329"></a><span id="l19.329"> </span>
<a href="#l19.330"></a><span id="l19.330">   gMockPromptService.unregister();</span>
<a href="#l19.331"></a><span id="l19.331" class="difflineminus">-}</span>
<a href="#l19.332"></a><span id="l19.332" class="difflineplus">+});</span>
<a href="#l19.333"></a><span id="l19.333"> </span>
<a href="#l19.334"></a><span id="l19.334"> /* Tests that we can send mail to a mailing list by selecting the</span>
<a href="#l19.335"></a><span id="l19.335">  * mailing list in the tree, and clicking &quot;Write&quot;</span>
<a href="#l19.336"></a><span id="l19.336">  */</span>
<a href="#l19.337"></a><span id="l19.337" class="difflineminus">-function test_writing_to_mailing_list() {</span>
<a href="#l19.338"></a><span id="l19.338" class="difflineplus">+add_task(function test_writing_to_mailing_list() {</span>
<a href="#l19.339"></a><span id="l19.339">   // Create a new mailing list, and add it to one of our</span>
<a href="#l19.340"></a><span id="l19.340">   // address books</span>
<a href="#l19.341"></a><span id="l19.341">   let newList = create_mailing_list(&quot;Some Mailing List&quot;);</span>
<a href="#l19.342"></a><span id="l19.342">   let addedList = addrBook1.addMailList(newList);</span>
<a href="#l19.343"></a><span id="l19.343"> </span>
<a href="#l19.344"></a><span id="l19.344">   // Create some contacts that we'll try to contact</span>
<a href="#l19.345"></a><span id="l19.345">   let contacts = [</span>
<a href="#l19.346"></a><span id="l19.346">     create_contact(&quot;test2@example.com&quot;, &quot;Leonard Shelby&quot;, true),</span>
<a href="#l19.347"></a><span id="l19.347" class="difflineat">@@ -392,12 +384,14 @@ function test_writing_to_mailing_list() </span>
<a href="#l19.348"></a><span id="l19.348">   plan_for_new_window(&quot;msgcompose&quot;);</span>
<a href="#l19.349"></a><span id="l19.349">   // ... and click the &quot;Write&quot; button</span>
<a href="#l19.350"></a><span id="l19.350">   abController.click(abController.eid(&quot;button-newmessage&quot;));</span>
<a href="#l19.351"></a><span id="l19.351">   let composeWin = wait_for_compose_window(abController);</span>
<a href="#l19.352"></a><span id="l19.352">   let to = composeWin.window.gMsgCompose.compFields.to;</span>
<a href="#l19.353"></a><span id="l19.353"> </span>
<a href="#l19.354"></a><span id="l19.354">   // Make sure we're writing to all contacts in the mailing list.</span>
<a href="#l19.355"></a><span id="l19.355">   for (let contact of contacts) {</span>
<a href="#l19.356"></a><span id="l19.356" class="difflineminus">-    assert_true(to.includes(contact.primaryEmail));</span>
<a href="#l19.357"></a><span id="l19.357" class="difflineminus">-    assert_true(to.includes(contact.displayName));</span>
<a href="#l19.358"></a><span id="l19.358" class="difflineplus">+    Assert.ok(to.includes(contact.primaryEmail));</span>
<a href="#l19.359"></a><span id="l19.359" class="difflineplus">+    Assert.ok(to.includes(contact.displayName));</span>
<a href="#l19.360"></a><span id="l19.360">   }</span>
<a href="#l19.361"></a><span id="l19.361" class="difflineminus">-}</span>
<a href="#l19.362"></a><span id="l19.362" class="difflineplus">+</span>
<a href="#l19.363"></a><span id="l19.363" class="difflineplus">+  close_compose_window(composeWin);</span>
<a href="#l19.364"></a><span id="l19.364" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1">copy from mail/test/mozmill/addrbook/test-address-book-panes.js</span>
<a href="#l20.2"></a><span id="l20.2">copy to mail/test/browser/addrbook/browser_addressBookPanes.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineminus">--- a/mail/test/mozmill/addrbook/test-address-book-panes.js</span>
<a href="#l20.4"></a><span id="l20.4" class="difflineplus">+++ b/mail/test/browser/addrbook/browser_addressBookPanes.js</span>
<a href="#l20.5"></a><span id="l20.5" class="difflineat">@@ -12,32 +12,39 @@ var {</span>
<a href="#l20.6"></a><span id="l20.6">   close_address_book_window,</span>
<a href="#l20.7"></a><span id="l20.7">   open_address_book_window,</span>
<a href="#l20.8"></a><span id="l20.8"> } = ChromeUtils.import(</span>
<a href="#l20.9"></a><span id="l20.9">   &quot;resource://testing-common/mozmill/AddressBookHelpers.jsm&quot;</span>
<a href="#l20.10"></a><span id="l20.10"> );</span>
<a href="#l20.11"></a><span id="l20.11"> </span>
<a href="#l20.12"></a><span id="l20.12"> var abController;</span>
<a href="#l20.13"></a><span id="l20.13"> </span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l20.16"></a><span id="l20.16">   // Open the address book main window</span>
<a href="#l20.17"></a><span id="l20.17">   abController = open_address_book_window();</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-}</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineplus">+});</span>
<a href="#l20.20"></a><span id="l20.20"> </span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l20.23"></a><span id="l20.23">   // Make sure the panes are all visible now that we're</span>
<a href="#l20.24"></a><span id="l20.24">   // done these tests.</span>
<a href="#l20.25"></a><span id="l20.25">   toggle_directory_pane();</span>
<a href="#l20.26"></a><span id="l20.26">   toggle_contact_pane();</span>
<a href="#l20.27"></a><span id="l20.27"> </span>
<a href="#l20.28"></a><span id="l20.28">   assert_directory_pane_visibility(true);</span>
<a href="#l20.29"></a><span id="l20.29">   assert_contact_pane_visibility(true);</span>
<a href="#l20.30"></a><span id="l20.30"> </span>
<a href="#l20.31"></a><span id="l20.31">   close_address_book_window(abController);</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineminus">-}</span>
<a href="#l20.33"></a><span id="l20.33" class="difflineplus">+</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+  Assert.report(</span>
<a href="#l20.35"></a><span id="l20.35" class="difflineplus">+    false,</span>
<a href="#l20.36"></a><span id="l20.36" class="difflineplus">+    undefined,</span>
<a href="#l20.37"></a><span id="l20.37" class="difflineplus">+    undefined,</span>
<a href="#l20.38"></a><span id="l20.38" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l20.39"></a><span id="l20.39" class="difflineplus">+  );</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+});</span>
<a href="#l20.41"></a><span id="l20.41"> </span>
<a href="#l20.42"></a><span id="l20.42"> /**</span>
<a href="#l20.43"></a><span id="l20.43">  * Helper function to toggle a pane.</span>
<a href="#l20.44"></a><span id="l20.44">  *</span>
<a href="#l20.45"></a><span id="l20.45">  * @param splitterId the id of the splitter to toggle</span>
<a href="#l20.46"></a><span id="l20.46">  */</span>
<a href="#l20.47"></a><span id="l20.47"> function _help_toggle_pane(splitterId) {</span>
<a href="#l20.48"></a><span id="l20.48">   abController.window.togglePaneSplitter(splitterId);</span>
<a href="#l20.49"></a><span id="l20.49" class="difflineat">@@ -99,38 +106,38 @@ function assert_directory_pane_visibilit</span>
<a href="#l20.50"></a><span id="l20.50"> function assert_contact_pane_visibility(visible) {</span>
<a href="#l20.51"></a><span id="l20.51">   _help_assert_pane_visibility(</span>
<a href="#l20.52"></a><span id="l20.52">     &quot;CardViewOuterBox&quot;,</span>
<a href="#l20.53"></a><span id="l20.53">     &quot;menu_showCardPane&quot;,</span>
<a href="#l20.54"></a><span id="l20.54">     visible</span>
<a href="#l20.55"></a><span id="l20.55">   );</span>
<a href="#l20.56"></a><span id="l20.56"> }</span>
<a href="#l20.57"></a><span id="l20.57"> </span>
<a href="#l20.58"></a><span id="l20.58" class="difflineminus">-function test_hide_directory_pane() {</span>
<a href="#l20.59"></a><span id="l20.59" class="difflineplus">+add_task(function test_hide_directory_pane() {</span>
<a href="#l20.60"></a><span id="l20.60">   toggle_directory_pane();</span>
<a href="#l20.61"></a><span id="l20.61">   assert_directory_pane_visibility(false);</span>
<a href="#l20.62"></a><span id="l20.62" class="difflineminus">-}</span>
<a href="#l20.63"></a><span id="l20.63" class="difflineplus">+});</span>
<a href="#l20.64"></a><span id="l20.64"> </span>
<a href="#l20.65"></a><span id="l20.65" class="difflineminus">-function test_show_directory_pane() {</span>
<a href="#l20.66"></a><span id="l20.66" class="difflineplus">+add_task(function test_show_directory_pane() {</span>
<a href="#l20.67"></a><span id="l20.67">   toggle_directory_pane();</span>
<a href="#l20.68"></a><span id="l20.68">   assert_directory_pane_visibility(true);</span>
<a href="#l20.69"></a><span id="l20.69" class="difflineminus">-}</span>
<a href="#l20.70"></a><span id="l20.70" class="difflineplus">+});</span>
<a href="#l20.71"></a><span id="l20.71"> </span>
<a href="#l20.72"></a><span id="l20.72" class="difflineminus">-function test_hide_contact_pane() {</span>
<a href="#l20.73"></a><span id="l20.73" class="difflineplus">+add_task(function test_hide_contact_pane() {</span>
<a href="#l20.74"></a><span id="l20.74">   toggle_contact_pane();</span>
<a href="#l20.75"></a><span id="l20.75">   assert_contact_pane_visibility(false);</span>
<a href="#l20.76"></a><span id="l20.76" class="difflineminus">-}</span>
<a href="#l20.77"></a><span id="l20.77" class="difflineplus">+});</span>
<a href="#l20.78"></a><span id="l20.78"> </span>
<a href="#l20.79"></a><span id="l20.79" class="difflineminus">-function test_show_contact_pane() {</span>
<a href="#l20.80"></a><span id="l20.80" class="difflineplus">+add_task(function test_show_contact_pane() {</span>
<a href="#l20.81"></a><span id="l20.81">   toggle_contact_pane();</span>
<a href="#l20.82"></a><span id="l20.82">   assert_contact_pane_visibility(true);</span>
<a href="#l20.83"></a><span id="l20.83" class="difflineminus">-}</span>
<a href="#l20.84"></a><span id="l20.84" class="difflineplus">+});</span>
<a href="#l20.85"></a><span id="l20.85"> </span>
<a href="#l20.86"></a><span id="l20.86" class="difflineminus">-function test_persist_panes() {</span>
<a href="#l20.87"></a><span id="l20.87" class="difflineplus">+add_task(function test_persist_panes() {</span>
<a href="#l20.88"></a><span id="l20.88">   toggle_directory_pane();</span>
<a href="#l20.89"></a><span id="l20.89">   toggle_contact_pane();</span>
<a href="#l20.90"></a><span id="l20.90"> </span>
<a href="#l20.91"></a><span id="l20.91">   close_address_book_window(abController);</span>
<a href="#l20.92"></a><span id="l20.92">   abController = open_address_book_window();</span>
<a href="#l20.93"></a><span id="l20.93"> </span>
<a href="#l20.94"></a><span id="l20.94">   assert_directory_pane_visibility(false);</span>
<a href="#l20.95"></a><span id="l20.95">   assert_contact_pane_visibility(false);</span>
<a href="#l20.96"></a><span id="l20.96" class="difflineminus">-}</span>
<a href="#l20.97"></a><span id="l20.97" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1">copy from mail/test/mozmill/addrbook/test-update-mailing-list.js</span>
<a href="#l21.2"></a><span id="l21.2">copy to mail/test/browser/addrbook/browser_updateMailingList.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineminus">--- a/mail/test/mozmill/addrbook/test-update-mailing-list.js</span>
<a href="#l21.4"></a><span id="l21.4" class="difflineplus">+++ b/mail/test/browser/addrbook/browser_updateMailingList.js</span>
<a href="#l21.5"></a><span id="l21.5" class="difflineat">@@ -18,25 +18,25 @@ var {</span>
<a href="#l21.6"></a><span id="l21.6">   delete_address_book,</span>
<a href="#l21.7"></a><span id="l21.7">   edit_selected_contact,</span>
<a href="#l21.8"></a><span id="l21.8">   open_address_book_window,</span>
<a href="#l21.9"></a><span id="l21.9">   select_address_book,</span>
<a href="#l21.10"></a><span id="l21.10">   select_contacts,</span>
<a href="#l21.11"></a><span id="l21.11"> } = ChromeUtils.import(</span>
<a href="#l21.12"></a><span id="l21.12">   &quot;resource://testing-common/mozmill/AddressBookHelpers.jsm&quot;</span>
<a href="#l21.13"></a><span id="l21.13"> );</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-var { assert_equals, mc } = ChromeUtils.import(</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l21.16"></a><span id="l21.16">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l21.17"></a><span id="l21.17"> );</span>
<a href="#l21.18"></a><span id="l21.18"> </span>
<a href="#l21.19"></a><span id="l21.19"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l21.20"></a><span id="l21.20">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l21.21"></a><span id="l21.21"> );</span>
<a href="#l21.22"></a><span id="l21.22"> </span>
<a href="#l21.23"></a><span id="l21.23" class="difflineminus">-function test_contact_in_mailing_list_updated() {</span>
<a href="#l21.24"></a><span id="l21.24" class="difflineplus">+add_task(function test_contact_in_mailing_list_updated() {</span>
<a href="#l21.25"></a><span id="l21.25">   const kOldAddress = &quot;before@example.com&quot;;</span>
<a href="#l21.26"></a><span id="l21.26">   const kNewAddress = &quot;after@example.com&quot;;</span>
<a href="#l21.27"></a><span id="l21.27"> </span>
<a href="#l21.28"></a><span id="l21.28">   // Create some address book to work with...</span>
<a href="#l21.29"></a><span id="l21.29">   let ab = create_address_book(&quot;Some Address Book&quot;);</span>
<a href="#l21.30"></a><span id="l21.30">   // And a contact...</span>
<a href="#l21.31"></a><span id="l21.31">   let contact = create_contact(kOldAddress, &quot;Some Contact&quot;, true);</span>
<a href="#l21.32"></a><span id="l21.32">   // And our mailing list.</span>
<a href="#l21.33"></a><span id="l21.33" class="difflineat">@@ -60,21 +60,21 @@ function test_contact_in_mailing_list_up</span>
<a href="#l21.34"></a><span id="l21.34"> </span>
<a href="#l21.35"></a><span id="l21.35">   // Because the current address book is kind of lame, in order</span>
<a href="#l21.36"></a><span id="l21.36">   // to see whether or not the mailing list contact was updated,</span>
<a href="#l21.37"></a><span id="l21.37">   // we have to get a fresh copy of the address book...</span>
<a href="#l21.38"></a><span id="l21.38">   ab = MailServices.ab.getDirectory(ab.URI);</span>
<a href="#l21.39"></a><span id="l21.39"> </span>
<a href="#l21.40"></a><span id="l21.40">   // Ensure that the primary email address for the contact changed</span>
<a href="#l21.41"></a><span id="l21.41">   // in the mailing list as well.</span>
<a href="#l21.42"></a><span id="l21.42" class="difflineminus">-  assert_equals(</span>
<a href="#l21.43"></a><span id="l21.43" class="difflineplus">+  Assert.equal(</span>
<a href="#l21.44"></a><span id="l21.44">     1,</span>
<a href="#l21.45"></a><span id="l21.45">     ml.addressLists.length,</span>
<a href="#l21.46"></a><span id="l21.46">     &quot;There should only be one contact in the mailing list&quot;</span>
<a href="#l21.47"></a><span id="l21.47">   );</span>
<a href="#l21.48"></a><span id="l21.48">   let mlContact = ml.addressLists.queryElementAt(0, Ci.nsIAbCard);</span>
<a href="#l21.49"></a><span id="l21.49" class="difflineminus">-  assert_equals(kNewAddress, mlContact.primaryEmail);</span>
<a href="#l21.50"></a><span id="l21.50" class="difflineplus">+  Assert.equal(kNewAddress, mlContact.primaryEmail);</span>
<a href="#l21.51"></a><span id="l21.51"> </span>
<a href="#l21.52"></a><span id="l21.52">   // Destroy the address book that we created.</span>
<a href="#l21.53"></a><span id="l21.53">   delete_address_book(ab);</span>
<a href="#l21.54"></a><span id="l21.54"> </span>
<a href="#l21.55"></a><span id="l21.55">   close_address_book_window(abw);</span>
<a href="#l21.56"></a><span id="l21.56" class="difflineminus">-}</span>
<a href="#l21.57"></a><span id="l21.57" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">new file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- /dev/null</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ b/mail/test/browser/attachment/browser.ini</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -0,0 +1,19 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineplus">+prefs =</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineplus">+support-files = data/**</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineplus">+</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineplus">+[browser_attachment.js]</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineplus">+[browser_attachmentEvents.js]</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineplus">+[browser_attachmentInPlainMsg.js]</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineplus">+[browser_attachmentMenus.js]</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineplus">+[browser_attachmentSize.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">copy from mail/test/mozmill/attachment/test-attachment.js</span>
<a href="#l23.2"></a><span id="l23.2">copy to mail/test/browser/attachment/browser_attachment.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment.js</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineplus">+++ b/mail/test/browser/attachment/browser_attachment.js</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineat">@@ -4,32 +4,30 @@</span>
<a href="#l23.6"></a><span id="l23.6"> </span>
<a href="#l23.7"></a><span id="l23.7"> /**</span>
<a href="#l23.8"></a><span id="l23.8">  * Checks various attachments display correctly</span>
<a href="#l23.9"></a><span id="l23.9">  */</span>
<a href="#l23.10"></a><span id="l23.10"> </span>
<a href="#l23.11"></a><span id="l23.11"> &quot;use strict&quot;;</span>
<a href="#l23.12"></a><span id="l23.12"> </span>
<a href="#l23.13"></a><span id="l23.13"> var elib = ChromeUtils.import(</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l23.16"></a><span id="l23.16"> );</span>
<a href="#l23.17"></a><span id="l23.17"> var EventUtils = ChromeUtils.import(</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-  &quot;chrome://mozmill/content/stdlib/EventUtils.jsm&quot;</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineplus">+  &quot;resource://testing-common/mozmill/EventUtils.jsm&quot;</span>
<a href="#l23.20"></a><span id="l23.20"> );</span>
<a href="#l23.21"></a><span id="l23.21"> </span>
<a href="#l23.22"></a><span id="l23.22"> var { close_compose_window, open_compose_with_forward } = ChromeUtils.import(</span>
<a href="#l23.23"></a><span id="l23.23">   &quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;</span>
<a href="#l23.24"></a><span id="l23.24"> );</span>
<a href="#l23.25"></a><span id="l23.25"> var {</span>
<a href="#l23.26"></a><span id="l23.26">   add_message_to_folder,</span>
<a href="#l23.27"></a><span id="l23.27">   assert_attachment_list_focused,</span>
<a href="#l23.28"></a><span id="l23.28" class="difflineminus">-  assert_equals,</span>
<a href="#l23.29"></a><span id="l23.29">   assert_message_pane_focused,</span>
<a href="#l23.30"></a><span id="l23.30">   assert_selected_and_displayed,</span>
<a href="#l23.31"></a><span id="l23.31" class="difflineminus">-  assert_true,</span>
<a href="#l23.32"></a><span id="l23.32">   be_in_folder,</span>
<a href="#l23.33"></a><span id="l23.33">   close_popup,</span>
<a href="#l23.34"></a><span id="l23.34">   create_folder,</span>
<a href="#l23.35"></a><span id="l23.35">   create_message,</span>
<a href="#l23.36"></a><span id="l23.36">   mc,</span>
<a href="#l23.37"></a><span id="l23.37">   msgGen,</span>
<a href="#l23.38"></a><span id="l23.38">   plan_to_wait_for_folder_events,</span>
<a href="#l23.39"></a><span id="l23.39">   select_click_row,</span>
<a href="#l23.40"></a><span id="l23.40" class="difflineat">@@ -61,17 +59,17 @@ var textAttachment =</span>
<a href="#l23.41"></a><span id="l23.41">   &quot;of human values and compassion and simple warmth will return, and when &quot; +</span>
<a href="#l23.42"></a><span id="l23.42">   &quot;that happens someone like myself who has gone through an ordeal and who &quot; +</span>
<a href="#l23.43"></a><span id="l23.43">   &quot;genuinely needs hot coffee to pick him up and keep him functioning when &quot; +</span>
<a href="#l23.44"></a><span id="l23.44">   &quot;he has to function will get the hot coffee whether he happens to have a &quot; +</span>
<a href="#l23.45"></a><span id="l23.45">   &quot;poscred readily available or not.&quot;;</span>
<a href="#l23.46"></a><span id="l23.46"> </span>
<a href="#l23.47"></a><span id="l23.47"> var binaryAttachment = textAttachment;</span>
<a href="#l23.48"></a><span id="l23.48"> </span>
<a href="#l23.49"></a><span id="l23.49" class="difflineminus">-function setupModule(module) {</span>
<a href="#l23.50"></a><span id="l23.50" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l23.51"></a><span id="l23.51">   folder = create_folder(&quot;AttachmentA&quot;);</span>
<a href="#l23.52"></a><span id="l23.52"> </span>
<a href="#l23.53"></a><span id="l23.53">   var attachedMessage = msgGen.makeMessage({</span>
<a href="#l23.54"></a><span id="l23.54">     body: { body: &quot;I'm an attached email!&quot; },</span>
<a href="#l23.55"></a><span id="l23.55">     attachments: [</span>
<a href="#l23.56"></a><span id="l23.56">       { body: textAttachment, filename: &quot;inner attachment.txt&quot;, format: &quot;&quot; },</span>
<a href="#l23.57"></a><span id="l23.57">     ],</span>
<a href="#l23.58"></a><span id="l23.58">   });</span>
<a href="#l23.59"></a><span id="l23.59" class="difflineat">@@ -178,169 +176,169 @@ function setupModule(module) {</span>
<a href="#l23.60"></a><span id="l23.60">         },</span>
<a href="#l23.61"></a><span id="l23.61">       ],</span>
<a href="#l23.62"></a><span id="l23.62">     });</span>
<a href="#l23.63"></a><span id="l23.63">   }</span>
<a href="#l23.64"></a><span id="l23.64"> </span>
<a href="#l23.65"></a><span id="l23.65">   for (let i = 0; i &lt; messages.length; i++) {</span>
<a href="#l23.66"></a><span id="l23.66">     add_message_to_folder(folder, create_message(messages[i]));</span>
<a href="#l23.67"></a><span id="l23.67">   }</span>
<a href="#l23.68"></a><span id="l23.68" class="difflineminus">-}</span>
<a href="#l23.69"></a><span id="l23.69" class="difflineplus">+});</span>
<a href="#l23.70"></a><span id="l23.70"> </span>
<a href="#l23.71"></a><span id="l23.71"> /**</span>
<a href="#l23.72"></a><span id="l23.72">  * Set the pref to ensure that the attachments pane starts out (un)expanded</span>
<a href="#l23.73"></a><span id="l23.73">  *</span>
<a href="#l23.74"></a><span id="l23.74">  * @param expand true if the attachment pane should start out expanded,</span>
<a href="#l23.75"></a><span id="l23.75">  *        false otherwise</span>
<a href="#l23.76"></a><span id="l23.76">  */</span>
<a href="#l23.77"></a><span id="l23.77"> function ensure_starts_expanded(expand) {</span>
<a href="#l23.78"></a><span id="l23.78">   Services.prefs.setBoolPref(</span>
<a href="#l23.79"></a><span id="l23.79">     &quot;mailnews.attachments.display.start_expanded&quot;,</span>
<a href="#l23.80"></a><span id="l23.80">     expand</span>
<a href="#l23.81"></a><span id="l23.81">   );</span>
<a href="#l23.82"></a><span id="l23.82"> }</span>
<a href="#l23.83"></a><span id="l23.83"> </span>
<a href="#l23.84"></a><span id="l23.84" class="difflineminus">-function test_attachment_view_collapsed() {</span>
<a href="#l23.85"></a><span id="l23.85" class="difflineplus">+add_task(function test_attachment_view_collapsed() {</span>
<a href="#l23.86"></a><span id="l23.86">   be_in_folder(folder);</span>
<a href="#l23.87"></a><span id="l23.87"> </span>
<a href="#l23.88"></a><span id="l23.88">   select_click_row(0);</span>
<a href="#l23.89"></a><span id="l23.89">   assert_selected_and_displayed(0);</span>
<a href="#l23.90"></a><span id="l23.90"> </span>
<a href="#l23.91"></a><span id="l23.91">   if (!mc.e(&quot;attachmentView&quot;).collapsed) {</span>
<a href="#l23.92"></a><span id="l23.92">     throw new Error(&quot;Attachment pane expanded when it shouldn't be!&quot;);</span>
<a href="#l23.93"></a><span id="l23.93">   }</span>
<a href="#l23.94"></a><span id="l23.94" class="difflineminus">-}</span>
<a href="#l23.95"></a><span id="l23.95" class="difflineplus">+});</span>
<a href="#l23.96"></a><span id="l23.96"> </span>
<a href="#l23.97"></a><span id="l23.97" class="difflineminus">-function test_attachment_view_expanded() {</span>
<a href="#l23.98"></a><span id="l23.98" class="difflineplus">+add_task(function test_attachment_view_expanded() {</span>
<a href="#l23.99"></a><span id="l23.99">   be_in_folder(folder);</span>
<a href="#l23.100"></a><span id="l23.100"> </span>
<a href="#l23.101"></a><span id="l23.101">   for (let i = 1; i &lt; messages.length; i++) {</span>
<a href="#l23.102"></a><span id="l23.102">     select_click_row(i);</span>
<a href="#l23.103"></a><span id="l23.103">     assert_selected_and_displayed(i);</span>
<a href="#l23.104"></a><span id="l23.104"> </span>
<a href="#l23.105"></a><span id="l23.105">     if (mc.e(&quot;attachmentView&quot;).collapsed) {</span>
<a href="#l23.106"></a><span id="l23.106">       throw new Error(</span>
<a href="#l23.107"></a><span id="l23.107">         &quot;Attachment pane collapsed (on message #&quot; + i + &quot; when it shouldn't be!&quot;</span>
<a href="#l23.108"></a><span id="l23.108">       );</span>
<a href="#l23.109"></a><span id="l23.109">     }</span>
<a href="#l23.110"></a><span id="l23.110">   }</span>
<a href="#l23.111"></a><span id="l23.111" class="difflineminus">-}</span>
<a href="#l23.112"></a><span id="l23.112" class="difflineplus">+});</span>
<a href="#l23.113"></a><span id="l23.113"> </span>
<a href="#l23.114"></a><span id="l23.114" class="difflineminus">-function test_attachment_name_sanitization() {</span>
<a href="#l23.115"></a><span id="l23.115" class="difflineplus">+add_task(function test_attachment_name_sanitization() {</span>
<a href="#l23.116"></a><span id="l23.116">   be_in_folder(folder);</span>
<a href="#l23.117"></a><span id="l23.117"> </span>
<a href="#l23.118"></a><span id="l23.118">   let attachmentList = mc.e(&quot;attachmentList&quot;);</span>
<a href="#l23.119"></a><span id="l23.119"> </span>
<a href="#l23.120"></a><span id="l23.120">   for (let i = 0; i &lt; messages.length; i++) {</span>
<a href="#l23.121"></a><span id="l23.121">     if (&quot;attachments&quot; in messages[i]) {</span>
<a href="#l23.122"></a><span id="l23.122">       select_click_row(i);</span>
<a href="#l23.123"></a><span id="l23.123">       assert_selected_and_displayed(i);</span>
<a href="#l23.124"></a><span id="l23.124"> </span>
<a href="#l23.125"></a><span id="l23.125">       let attachments = messages[i].attachments;</span>
<a href="#l23.126"></a><span id="l23.126">       if (messages[i].attachments.length == 1) {</span>
<a href="#l23.127"></a><span id="l23.127" class="difflineminus">-        assert_equals(</span>
<a href="#l23.128"></a><span id="l23.128" class="difflineplus">+        Assert.equal(</span>
<a href="#l23.129"></a><span id="l23.129">           mc.e(&quot;attachmentName&quot;).value,</span>
<a href="#l23.130"></a><span id="l23.130">           attachments[0].sanitizedFilename || attachments[0].filename</span>
<a href="#l23.131"></a><span id="l23.131">         );</span>
<a href="#l23.132"></a><span id="l23.132">       }</span>
<a href="#l23.133"></a><span id="l23.133"> </span>
<a href="#l23.134"></a><span id="l23.134">       for (let j = 0; j &lt; attachments.length; j++) {</span>
<a href="#l23.135"></a><span id="l23.135" class="difflineminus">-        assert_equals(</span>
<a href="#l23.136"></a><span id="l23.136" class="difflineplus">+        Assert.equal(</span>
<a href="#l23.137"></a><span id="l23.137">           attachmentList.getItemAtIndex(j).getAttribute(&quot;name&quot;),</span>
<a href="#l23.138"></a><span id="l23.138">           attachments[j].sanitizedFilename || attachments[j].filename</span>
<a href="#l23.139"></a><span id="l23.139">         );</span>
<a href="#l23.140"></a><span id="l23.140">       }</span>
<a href="#l23.141"></a><span id="l23.141">     }</span>
<a href="#l23.142"></a><span id="l23.142">   }</span>
<a href="#l23.143"></a><span id="l23.143" class="difflineminus">-}</span>
<a href="#l23.144"></a><span id="l23.144" class="difflineplus">+});</span>
<a href="#l23.145"></a><span id="l23.145"> </span>
<a href="#l23.146"></a><span id="l23.146" class="difflineminus">-function test_long_attachment_name() {</span>
<a href="#l23.147"></a><span id="l23.147" class="difflineplus">+add_task(function test_long_attachment_name() {</span>
<a href="#l23.148"></a><span id="l23.148">   be_in_folder(folder);</span>
<a href="#l23.149"></a><span id="l23.149"> </span>
<a href="#l23.150"></a><span id="l23.150">   select_click_row(4);</span>
<a href="#l23.151"></a><span id="l23.151">   assert_selected_and_displayed(4);</span>
<a href="#l23.152"></a><span id="l23.152"> </span>
<a href="#l23.153"></a><span id="l23.153">   let messagepaneBox = mc.e(&quot;messagepanebox&quot;);</span>
<a href="#l23.154"></a><span id="l23.154">   let attachmentBar = mc.e(&quot;attachmentBar&quot;);</span>
<a href="#l23.155"></a><span id="l23.155"> </span>
<a href="#l23.156"></a><span id="l23.156" class="difflineminus">-  assert_true(</span>
<a href="#l23.157"></a><span id="l23.157" class="difflineplus">+  Assert.ok(</span>
<a href="#l23.158"></a><span id="l23.158">     messagepaneBox.getBoundingClientRect().width &gt;=</span>
<a href="#l23.159"></a><span id="l23.159">       attachmentBar.getBoundingClientRect().width,</span>
<a href="#l23.160"></a><span id="l23.160">     &quot;Attachment bar has expanded off the edge of the window!&quot;</span>
<a href="#l23.161"></a><span id="l23.161">   );</span>
<a href="#l23.162"></a><span id="l23.162" class="difflineminus">-}</span>
<a href="#l23.163"></a><span id="l23.163" class="difflineplus">+});</span>
<a href="#l23.164"></a><span id="l23.164"> </span>
<a href="#l23.165"></a><span id="l23.165"> /**</span>
<a href="#l23.166"></a><span id="l23.166">  * Make sure that, when opening attached messages, we only show the attachments</span>
<a href="#l23.167"></a><span id="l23.167">  * &quot;beneath&quot; the attached message (as opposed to all attachments for the root</span>
<a href="#l23.168"></a><span id="l23.168">  * message).</span>
<a href="#l23.169"></a><span id="l23.169">  */</span>
<a href="#l23.170"></a><span id="l23.170" class="difflineminus">-function test_attached_message_attachments() {</span>
<a href="#l23.171"></a><span id="l23.171" class="difflineplus">+add_task(function test_attached_message_attachments() {</span>
<a href="#l23.172"></a><span id="l23.172">   be_in_folder(folder);</span>
<a href="#l23.173"></a><span id="l23.173"> </span>
<a href="#l23.174"></a><span id="l23.174">   select_click_row(5);</span>
<a href="#l23.175"></a><span id="l23.175">   assert_selected_and_displayed(5);</span>
<a href="#l23.176"></a><span id="l23.176"> </span>
<a href="#l23.177"></a><span id="l23.177">   // Make sure we have the expected number of attachments in the root message:</span>
<a href="#l23.178"></a><span id="l23.178">   // an outer text attachment, an attached email, and an inner text attachment.</span>
<a href="#l23.179"></a><span id="l23.179" class="difflineminus">-  assert_equals(mc.e(&quot;attachmentList&quot;).itemCount, 3);</span>
<a href="#l23.180"></a><span id="l23.180" class="difflineplus">+  Assert.equal(mc.e(&quot;attachmentList&quot;).itemCount, 3);</span>
<a href="#l23.181"></a><span id="l23.181"> </span>
<a href="#l23.182"></a><span id="l23.182">   // Open the attached email.</span>
<a href="#l23.183"></a><span id="l23.183">   plan_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l23.184"></a><span id="l23.184">   mc.e(&quot;attachmentList&quot;)</span>
<a href="#l23.185"></a><span id="l23.185">     .getItemAtIndex(1)</span>
<a href="#l23.186"></a><span id="l23.186">     .attachment.open();</span>
<a href="#l23.187"></a><span id="l23.187">   let msgc = wait_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l23.188"></a><span id="l23.188">   wait_for_message_display_completion(msgc, true);</span>
<a href="#l23.189"></a><span id="l23.189"> </span>
<a href="#l23.190"></a><span id="l23.190">   // Make sure we have the expected number of attachments in the attached</span>
<a href="#l23.191"></a><span id="l23.191">   // message: just an inner text attachment.</span>
<a href="#l23.192"></a><span id="l23.192" class="difflineminus">-  assert_equals(msgc.e(&quot;attachmentList&quot;).itemCount, 1);</span>
<a href="#l23.193"></a><span id="l23.193" class="difflineplus">+  Assert.equal(msgc.e(&quot;attachmentList&quot;).itemCount, 1);</span>
<a href="#l23.194"></a><span id="l23.194"> </span>
<a href="#l23.195"></a><span id="l23.195">   close_window(msgc);</span>
<a href="#l23.196"></a><span id="l23.196" class="difflineminus">-}</span>
<a href="#l23.197"></a><span id="l23.197" class="difflineplus">+});</span>
<a href="#l23.198"></a><span id="l23.198"> </span>
<a href="#l23.199"></a><span id="l23.199" class="difflineminus">-function test_attachment_name_click() {</span>
<a href="#l23.200"></a><span id="l23.200" class="difflineplus">+add_task(function test_attachment_name_click() {</span>
<a href="#l23.201"></a><span id="l23.201">   be_in_folder(folder);</span>
<a href="#l23.202"></a><span id="l23.202"> </span>
<a href="#l23.203"></a><span id="l23.203">   select_click_row(1);</span>
<a href="#l23.204"></a><span id="l23.204">   assert_selected_and_displayed(1);</span>
<a href="#l23.205"></a><span id="l23.205"> </span>
<a href="#l23.206"></a><span id="l23.206">   let attachmentList = mc.e(&quot;attachmentList&quot;);</span>
<a href="#l23.207"></a><span id="l23.207"> </span>
<a href="#l23.208"></a><span id="l23.208" class="difflineminus">-  assert_true(</span>
<a href="#l23.209"></a><span id="l23.209" class="difflineplus">+  Assert.ok(</span>
<a href="#l23.210"></a><span id="l23.210">     attachmentList.collapsed,</span>
<a href="#l23.211"></a><span id="l23.211">     &quot;Attachment list should start out collapsed!&quot;</span>
<a href="#l23.212"></a><span id="l23.212">   );</span>
<a href="#l23.213"></a><span id="l23.213"> </span>
<a href="#l23.214"></a><span id="l23.214">   // Ensure the open dialog appears when clicking on the attachment name and</span>
<a href="#l23.215"></a><span id="l23.215">   // that the attachment list doesn't expand.</span>
<a href="#l23.216"></a><span id="l23.216">   plan_for_modal_dialog(&quot;unknownContentType&quot;, function() {});</span>
<a href="#l23.217"></a><span id="l23.217">   mc.click(mc.eid(&quot;attachmentName&quot;));</span>
<a href="#l23.218"></a><span id="l23.218">   wait_for_modal_dialog(&quot;unknownContentType&quot;);</span>
<a href="#l23.219"></a><span id="l23.219" class="difflineminus">-  assert_true(</span>
<a href="#l23.220"></a><span id="l23.220" class="difflineplus">+  Assert.ok(</span>
<a href="#l23.221"></a><span id="l23.221">     attachmentList.collapsed,</span>
<a href="#l23.222"></a><span id="l23.222">     &quot;Attachment list should not expand when clicking on attachmentName!&quot;</span>
<a href="#l23.223"></a><span id="l23.223">   );</span>
<a href="#l23.224"></a><span id="l23.224" class="difflineminus">-}</span>
<a href="#l23.225"></a><span id="l23.225" class="difflineplus">+});</span>
<a href="#l23.226"></a><span id="l23.226"> </span>
<a href="#l23.227"></a><span id="l23.227"> /**</span>
<a href="#l23.228"></a><span id="l23.228">  * Test that right-clicking on a particular element opens the expected context</span>
<a href="#l23.229"></a><span id="l23.229">  * menu.</span>
<a href="#l23.230"></a><span id="l23.230">  *</span>
<a href="#l23.231"></a><span id="l23.231">  * @param elementId the id of the element to right click on</span>
<a href="#l23.232"></a><span id="l23.232">  * @param contextMenuId the id of the context menu that should appear</span>
<a href="#l23.233"></a><span id="l23.233">  */</span>
<a href="#l23.234"></a><span id="l23.234"> function subtest_attachment_right_click(elementId, contextMenuId) {</span>
<a href="#l23.235"></a><span id="l23.235">   mc.rightClick(mc.eid(elementId));</span>
<a href="#l23.236"></a><span id="l23.236">   wait_for_popup_to_open(mc.e(contextMenuId));</span>
<a href="#l23.237"></a><span id="l23.237">   close_popup(mc, mc.eid(contextMenuId));</span>
<a href="#l23.238"></a><span id="l23.238"> }</span>
<a href="#l23.239"></a><span id="l23.239"> </span>
<a href="#l23.240"></a><span id="l23.240" class="difflineminus">-function test_attachment_right_click_single() {</span>
<a href="#l23.241"></a><span id="l23.241" class="difflineplus">+add_task(function test_attachment_right_click_single() {</span>
<a href="#l23.242"></a><span id="l23.242">   be_in_folder(folder);</span>
<a href="#l23.243"></a><span id="l23.243"> </span>
<a href="#l23.244"></a><span id="l23.244">   select_click_row(1);</span>
<a href="#l23.245"></a><span id="l23.245">   assert_selected_and_displayed(1);</span>
<a href="#l23.246"></a><span id="l23.246"> </span>
<a href="#l23.247"></a><span id="l23.247">   subtest_attachment_right_click(&quot;attachmentIcon&quot;, &quot;attachmentItemContext&quot;);</span>
<a href="#l23.248"></a><span id="l23.248">   subtest_attachment_right_click(&quot;attachmentCount&quot;, &quot;attachmentItemContext&quot;);</span>
<a href="#l23.249"></a><span id="l23.249">   subtest_attachment_right_click(&quot;attachmentName&quot;, &quot;attachmentItemContext&quot;);</span>
<a href="#l23.250"></a><span id="l23.250" class="difflineat">@@ -353,19 +351,19 @@ function test_attachment_right_click_sin</span>
<a href="#l23.251"></a><span id="l23.251">   subtest_attachment_right_click(</span>
<a href="#l23.252"></a><span id="l23.252">     &quot;attachmentSaveAllSingle&quot;,</span>
<a href="#l23.253"></a><span id="l23.253">     &quot;attachment-toolbar-context-menu&quot;</span>
<a href="#l23.254"></a><span id="l23.254">   );</span>
<a href="#l23.255"></a><span id="l23.255">   subtest_attachment_right_click(</span>
<a href="#l23.256"></a><span id="l23.256">     &quot;attachmentBar&quot;,</span>
<a href="#l23.257"></a><span id="l23.257">     &quot;attachment-toolbar-context-menu&quot;</span>
<a href="#l23.258"></a><span id="l23.258">   );</span>
<a href="#l23.259"></a><span id="l23.259" class="difflineminus">-}</span>
<a href="#l23.260"></a><span id="l23.260" class="difflineplus">+});</span>
<a href="#l23.261"></a><span id="l23.261"> </span>
<a href="#l23.262"></a><span id="l23.262" class="difflineminus">-function test_attachment_right_click_multiple() {</span>
<a href="#l23.263"></a><span id="l23.263" class="difflineplus">+add_task(function test_attachment_right_click_multiple() {</span>
<a href="#l23.264"></a><span id="l23.264">   be_in_folder(folder);</span>
<a href="#l23.265"></a><span id="l23.265"> </span>
<a href="#l23.266"></a><span id="l23.266">   select_click_row(3);</span>
<a href="#l23.267"></a><span id="l23.267">   assert_selected_and_displayed(3);</span>
<a href="#l23.268"></a><span id="l23.268"> </span>
<a href="#l23.269"></a><span id="l23.269">   subtest_attachment_right_click(&quot;attachmentIcon&quot;, &quot;attachmentListContext&quot;);</span>
<a href="#l23.270"></a><span id="l23.270">   subtest_attachment_right_click(&quot;attachmentCount&quot;, &quot;attachmentListContext&quot;);</span>
<a href="#l23.271"></a><span id="l23.271">   subtest_attachment_right_click(&quot;attachmentSize&quot;, &quot;attachmentListContext&quot;);</span>
<a href="#l23.272"></a><span id="l23.272" class="difflineat">@@ -377,156 +375,156 @@ function test_attachment_right_click_mul</span>
<a href="#l23.273"></a><span id="l23.273">   subtest_attachment_right_click(</span>
<a href="#l23.274"></a><span id="l23.274">     &quot;attachmentSaveAllMultiple&quot;,</span>
<a href="#l23.275"></a><span id="l23.275">     &quot;attachment-toolbar-context-menu&quot;</span>
<a href="#l23.276"></a><span id="l23.276">   );</span>
<a href="#l23.277"></a><span id="l23.277">   subtest_attachment_right_click(</span>
<a href="#l23.278"></a><span id="l23.278">     &quot;attachmentBar&quot;,</span>
<a href="#l23.279"></a><span id="l23.279">     &quot;attachment-toolbar-context-menu&quot;</span>
<a href="#l23.280"></a><span id="l23.280">   );</span>
<a href="#l23.281"></a><span id="l23.281" class="difflineminus">-}</span>
<a href="#l23.282"></a><span id="l23.282" class="difflineplus">+});</span>
<a href="#l23.283"></a><span id="l23.283"> </span>
<a href="#l23.284"></a><span id="l23.284"> /**</span>
<a href="#l23.285"></a><span id="l23.285">  * Test that clicking on various elements in the attachment bar toggles the</span>
<a href="#l23.286"></a><span id="l23.286">  * attachment list.</span>
<a href="#l23.287"></a><span id="l23.287">  *</span>
<a href="#l23.288"></a><span id="l23.288">  * @param elementId the id of the element to click</span>
<a href="#l23.289"></a><span id="l23.289">  */</span>
<a href="#l23.290"></a><span id="l23.290"> function subtest_attachment_list_toggle(elementId) {</span>
<a href="#l23.291"></a><span id="l23.291">   let attachmentList = mc.e(&quot;attachmentList&quot;);</span>
<a href="#l23.292"></a><span id="l23.292">   let element = mc.eid(elementId);</span>
<a href="#l23.293"></a><span id="l23.293"> </span>
<a href="#l23.294"></a><span id="l23.294">   mc.click(element);</span>
<a href="#l23.295"></a><span id="l23.295" class="difflineminus">-  assert_true(</span>
<a href="#l23.296"></a><span id="l23.296" class="difflineplus">+  Assert.ok(</span>
<a href="#l23.297"></a><span id="l23.297">     !attachmentList.collapsed,</span>
<a href="#l23.298"></a><span id="l23.298">     `Attachment list should be expanded after clicking ${elementId}!`</span>
<a href="#l23.299"></a><span id="l23.299">   );</span>
<a href="#l23.300"></a><span id="l23.300">   assert_attachment_list_focused();</span>
<a href="#l23.301"></a><span id="l23.301"> </span>
<a href="#l23.302"></a><span id="l23.302">   mc.click(element);</span>
<a href="#l23.303"></a><span id="l23.303" class="difflineminus">-  assert_true(</span>
<a href="#l23.304"></a><span id="l23.304" class="difflineplus">+  Assert.ok(</span>
<a href="#l23.305"></a><span id="l23.305">     attachmentList.collapsed,</span>
<a href="#l23.306"></a><span id="l23.306">     `Attachment list should be collapsed after clicking ${elementId} again!`</span>
<a href="#l23.307"></a><span id="l23.307">   );</span>
<a href="#l23.308"></a><span id="l23.308">   assert_message_pane_focused();</span>
<a href="#l23.309"></a><span id="l23.309"> }</span>
<a href="#l23.310"></a><span id="l23.310"> </span>
<a href="#l23.311"></a><span id="l23.311" class="difflineminus">-function test_attachment_list_expansion() {</span>
<a href="#l23.312"></a><span id="l23.312" class="difflineplus">+add_task(function test_attachment_list_expansion() {</span>
<a href="#l23.313"></a><span id="l23.313">   be_in_folder(folder);</span>
<a href="#l23.314"></a><span id="l23.314"> </span>
<a href="#l23.315"></a><span id="l23.315">   select_click_row(1);</span>
<a href="#l23.316"></a><span id="l23.316">   assert_selected_and_displayed(1);</span>
<a href="#l23.317"></a><span id="l23.317"> </span>
<a href="#l23.318"></a><span id="l23.318" class="difflineminus">-  assert_true(</span>
<a href="#l23.319"></a><span id="l23.319" class="difflineplus">+  Assert.ok(</span>
<a href="#l23.320"></a><span id="l23.320">     mc.e(&quot;attachmentList&quot;).collapsed,</span>
<a href="#l23.321"></a><span id="l23.321">     &quot;Attachment list should start out collapsed!&quot;</span>
<a href="#l23.322"></a><span id="l23.322">   );</span>
<a href="#l23.323"></a><span id="l23.323"> </span>
<a href="#l23.324"></a><span id="l23.324">   subtest_attachment_list_toggle(&quot;attachmentToggle&quot;);</span>
<a href="#l23.325"></a><span id="l23.325">   subtest_attachment_list_toggle(&quot;attachmentIcon&quot;);</span>
<a href="#l23.326"></a><span id="l23.326">   subtest_attachment_list_toggle(&quot;attachmentCount&quot;);</span>
<a href="#l23.327"></a><span id="l23.327">   subtest_attachment_list_toggle(&quot;attachmentSize&quot;);</span>
<a href="#l23.328"></a><span id="l23.328">   subtest_attachment_list_toggle(&quot;attachmentBar&quot;);</span>
<a href="#l23.329"></a><span id="l23.329"> </span>
<a href="#l23.330"></a><span id="l23.330">   // Ensure that clicking the &quot;Save All&quot; button doesn't expand the attachment</span>
<a href="#l23.331"></a><span id="l23.331">   // list.</span>
<a href="#l23.332"></a><span id="l23.332">   mc.click(</span>
<a href="#l23.333"></a><span id="l23.333" class="difflineminus">-    new elementslib.Elem(</span>
<a href="#l23.334"></a><span id="l23.334" class="difflineplus">+    new elib.Elem(</span>
<a href="#l23.335"></a><span id="l23.335">       mc</span>
<a href="#l23.336"></a><span id="l23.336">         .e(&quot;attachmentSaveAllSingle&quot;)</span>
<a href="#l23.337"></a><span id="l23.337">         .querySelector(&quot;.toolbarbutton-menubutton-dropmarker&quot;)</span>
<a href="#l23.338"></a><span id="l23.338">     )</span>
<a href="#l23.339"></a><span id="l23.339">   );</span>
<a href="#l23.340"></a><span id="l23.340" class="difflineminus">-  assert_true(</span>
<a href="#l23.341"></a><span id="l23.341" class="difflineplus">+  Assert.ok(</span>
<a href="#l23.342"></a><span id="l23.342">     mc.e(&quot;attachmentList&quot;).collapsed,</span>
<a href="#l23.343"></a><span id="l23.343">     &quot;Attachment list should be collapsed after clicking save button!&quot;</span>
<a href="#l23.344"></a><span id="l23.344">   );</span>
<a href="#l23.345"></a><span id="l23.345" class="difflineminus">-}</span>
<a href="#l23.346"></a><span id="l23.346" class="difflineplus">+});</span>
<a href="#l23.347"></a><span id="l23.347"> </span>
<a href="#l23.348"></a><span id="l23.348" class="difflineminus">-function test_attachment_list_starts_expanded() {</span>
<a href="#l23.349"></a><span id="l23.349" class="difflineplus">+add_task(function test_attachment_list_starts_expanded() {</span>
<a href="#l23.350"></a><span id="l23.350">   ensure_starts_expanded(true);</span>
<a href="#l23.351"></a><span id="l23.351">   be_in_folder(folder);</span>
<a href="#l23.352"></a><span id="l23.352"> </span>
<a href="#l23.353"></a><span id="l23.353">   select_click_row(2);</span>
<a href="#l23.354"></a><span id="l23.354">   assert_selected_and_displayed(2);</span>
<a href="#l23.355"></a><span id="l23.355"> </span>
<a href="#l23.356"></a><span id="l23.356" class="difflineminus">-  assert_true(</span>
<a href="#l23.357"></a><span id="l23.357" class="difflineplus">+  Assert.ok(</span>
<a href="#l23.358"></a><span id="l23.358">     !mc.e(&quot;attachmentList&quot;).collapsed,</span>
<a href="#l23.359"></a><span id="l23.359">     &quot;Attachment list should start out expanded!&quot;</span>
<a href="#l23.360"></a><span id="l23.360">   );</span>
<a href="#l23.361"></a><span id="l23.361" class="difflineminus">-}</span>
<a href="#l23.362"></a><span id="l23.362" class="difflineplus">+});</span>
<a href="#l23.363"></a><span id="l23.363"> </span>
<a href="#l23.364"></a><span id="l23.364" class="difflineminus">-function test_selected_attachments_are_cleared() {</span>
<a href="#l23.365"></a><span id="l23.365" class="difflineplus">+add_task(function test_selected_attachments_are_cleared() {</span>
<a href="#l23.366"></a><span id="l23.366">   ensure_starts_expanded(false);</span>
<a href="#l23.367"></a><span id="l23.367">   be_in_folder(folder);</span>
<a href="#l23.368"></a><span id="l23.368">   // First, select the message with two attachments.</span>
<a href="#l23.369"></a><span id="l23.369">   select_click_row(3);</span>
<a href="#l23.370"></a><span id="l23.370"> </span>
<a href="#l23.371"></a><span id="l23.371">   // Expand the attachment list.</span>
<a href="#l23.372"></a><span id="l23.372">   mc.click(mc.eid(&quot;attachmentToggle&quot;));</span>
<a href="#l23.373"></a><span id="l23.373"> </span>
<a href="#l23.374"></a><span id="l23.374">   // Select both the attachments.</span>
<a href="#l23.375"></a><span id="l23.375">   let attachmentList = mc.e(&quot;attachmentList&quot;);</span>
<a href="#l23.376"></a><span id="l23.376" class="difflineminus">-  assert_equals(</span>
<a href="#l23.377"></a><span id="l23.377" class="difflineplus">+  Assert.equal(</span>
<a href="#l23.378"></a><span id="l23.378">     attachmentList.selectedItems.length,</span>
<a href="#l23.379"></a><span id="l23.379">     1,</span>
<a href="#l23.380"></a><span id="l23.380">     &quot;On first load the first item should be selected&quot;</span>
<a href="#l23.381"></a><span id="l23.381">   );</span>
<a href="#l23.382"></a><span id="l23.382"> </span>
<a href="#l23.383"></a><span id="l23.383">   // We can just click on the first element, but the second one needs a</span>
<a href="#l23.384"></a><span id="l23.384">   // ctrl-click (or cmd-click for those Mac-heads among us).</span>
<a href="#l23.385"></a><span id="l23.385">   mc.click(new elib.Elem(attachmentList.children[0]), 5, 5);</span>
<a href="#l23.386"></a><span id="l23.386">   EventUtils.synthesizeMouse(</span>
<a href="#l23.387"></a><span id="l23.387">     attachmentList.children[1],</span>
<a href="#l23.388"></a><span id="l23.388">     5,</span>
<a href="#l23.389"></a><span id="l23.389">     5,</span>
<a href="#l23.390"></a><span id="l23.390">     { accelKey: true },</span>
<a href="#l23.391"></a><span id="l23.391">     mc.window</span>
<a href="#l23.392"></a><span id="l23.392">   );</span>
<a href="#l23.393"></a><span id="l23.393"> </span>
<a href="#l23.394"></a><span id="l23.394" class="difflineminus">-  assert_equals(</span>
<a href="#l23.395"></a><span id="l23.395" class="difflineplus">+  Assert.equal(</span>
<a href="#l23.396"></a><span id="l23.396">     attachmentList.selectedItems.length,</span>
<a href="#l23.397"></a><span id="l23.397">     2,</span>
<a href="#l23.398"></a><span id="l23.398">     &quot;We had the wrong number of selected items after selecting some!&quot;</span>
<a href="#l23.399"></a><span id="l23.399">   );</span>
<a href="#l23.400"></a><span id="l23.400"> </span>
<a href="#l23.401"></a><span id="l23.401">   // Switch to the message with one attachment, and make sure there are no</span>
<a href="#l23.402"></a><span id="l23.402">   // selected attachments.</span>
<a href="#l23.403"></a><span id="l23.403">   select_click_row(2);</span>
<a href="#l23.404"></a><span id="l23.404"> </span>
<a href="#l23.405"></a><span id="l23.405">   // Expand the attachment list again.</span>
<a href="#l23.406"></a><span id="l23.406">   mc.click(mc.eid(&quot;attachmentToggle&quot;));</span>
<a href="#l23.407"></a><span id="l23.407"> </span>
<a href="#l23.408"></a><span id="l23.408" class="difflineminus">-  assert_equals(</span>
<a href="#l23.409"></a><span id="l23.409" class="difflineplus">+  Assert.equal(</span>
<a href="#l23.410"></a><span id="l23.410">     attachmentList.selectedItems.length,</span>
<a href="#l23.411"></a><span id="l23.411">     1,</span>
<a href="#l23.412"></a><span id="l23.412">     &quot;After loading a new message the first item should be selected&quot;</span>
<a href="#l23.413"></a><span id="l23.413">   );</span>
<a href="#l23.414"></a><span id="l23.414" class="difflineminus">-}</span>
<a href="#l23.415"></a><span id="l23.415" class="difflineplus">+});</span>
<a href="#l23.416"></a><span id="l23.416"> </span>
<a href="#l23.417"></a><span id="l23.417" class="difflineminus">-function test_select_all_attachments_key() {</span>
<a href="#l23.418"></a><span id="l23.418" class="difflineplus">+add_task(function test_select_all_attachments_key() {</span>
<a href="#l23.419"></a><span id="l23.419">   be_in_folder(folder);</span>
<a href="#l23.420"></a><span id="l23.420"> </span>
<a href="#l23.421"></a><span id="l23.421">   // First, select the message with two attachments.</span>
<a href="#l23.422"></a><span id="l23.422">   select_none();</span>
<a href="#l23.423"></a><span id="l23.423">   select_click_row(3);</span>
<a href="#l23.424"></a><span id="l23.424"> </span>
<a href="#l23.425"></a><span id="l23.425">   // Expand the attachment list.</span>
<a href="#l23.426"></a><span id="l23.426">   mc.click(mc.eid(&quot;attachmentToggle&quot;));</span>
<a href="#l23.427"></a><span id="l23.427"> </span>
<a href="#l23.428"></a><span id="l23.428">   let attachmentList = mc.e(&quot;attachmentList&quot;);</span>
<a href="#l23.429"></a><span id="l23.429">   mc.keypress(new elib.Elem(attachmentList), &quot;a&quot;, { accelKey: true });</span>
<a href="#l23.430"></a><span id="l23.430" class="difflineminus">-  assert_equals(</span>
<a href="#l23.431"></a><span id="l23.431" class="difflineplus">+  Assert.equal(</span>
<a href="#l23.432"></a><span id="l23.432">     attachmentList.selectedItems.length,</span>
<a href="#l23.433"></a><span id="l23.433">     2,</span>
<a href="#l23.434"></a><span id="l23.434">     &quot;Should have selected all attachments!&quot;</span>
<a href="#l23.435"></a><span id="l23.435">   );</span>
<a href="#l23.436"></a><span id="l23.436" class="difflineminus">-}</span>
<a href="#l23.437"></a><span id="l23.437" class="difflineplus">+});</span>
<a href="#l23.438"></a><span id="l23.438"> </span>
<a href="#l23.439"></a><span id="l23.439" class="difflineminus">-function test_delete_attachment_key() {</span>
<a href="#l23.440"></a><span id="l23.440" class="difflineplus">+add_task(function test_delete_attachment_key() {</span>
<a href="#l23.441"></a><span id="l23.441">   be_in_folder(folder);</span>
<a href="#l23.442"></a><span id="l23.442"> </span>
<a href="#l23.443"></a><span id="l23.443">   // First, select the message with two attachments.</span>
<a href="#l23.444"></a><span id="l23.444">   select_none();</span>
<a href="#l23.445"></a><span id="l23.445">   select_click_row(3);</span>
<a href="#l23.446"></a><span id="l23.446"> </span>
<a href="#l23.447"></a><span id="l23.447">   // Expand the attachment list.</span>
<a href="#l23.448"></a><span id="l23.448">   mc.click(mc.eid(&quot;attachmentToggle&quot;));</span>
<a href="#l23.449"></a><span id="l23.449" class="difflineat">@@ -542,19 +540,19 @@ function test_delete_attachment_key() {</span>
<a href="#l23.450"></a><span id="l23.450">   wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l23.451"></a><span id="l23.451"> </span>
<a href="#l23.452"></a><span id="l23.452">   // Try deleting with the shift-delete key combo.</span>
<a href="#l23.453"></a><span id="l23.453">   plan_for_modal_dialog(&quot;commonDialog&quot;, function(cdc) {</span>
<a href="#l23.454"></a><span id="l23.454">     cdc.window.document.documentElement.cancelDialog();</span>
<a href="#l23.455"></a><span id="l23.455">   });</span>
<a href="#l23.456"></a><span id="l23.456">   mc.keypress(firstAttachment, &quot;VK_DELETE&quot;, { shiftKey: true });</span>
<a href="#l23.457"></a><span id="l23.457">   wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l23.458"></a><span id="l23.458" class="difflineminus">-}</span>
<a href="#l23.459"></a><span id="l23.459" class="difflineplus">+});</span>
<a href="#l23.460"></a><span id="l23.460"> </span>
<a href="#l23.461"></a><span id="l23.461" class="difflineminus">-function test_attachments_compose_menu() {</span>
<a href="#l23.462"></a><span id="l23.462" class="difflineplus">+add_task(function test_attachments_compose_menu() {</span>
<a href="#l23.463"></a><span id="l23.463">   be_in_folder(folder);</span>
<a href="#l23.464"></a><span id="l23.464"> </span>
<a href="#l23.465"></a><span id="l23.465">   // First, select the message with two attachments.</span>
<a href="#l23.466"></a><span id="l23.466">   select_none();</span>
<a href="#l23.467"></a><span id="l23.467">   select_click_row(3);</span>
<a href="#l23.468"></a><span id="l23.468"> </span>
<a href="#l23.469"></a><span id="l23.469">   let cwc = open_compose_with_forward();</span>
<a href="#l23.470"></a><span id="l23.470">   let attachment = cwc.e(&quot;attachmentBucket&quot;);</span>
<a href="#l23.471"></a><span id="l23.471" class="difflineat">@@ -584,61 +582,61 @@ function test_attachments_compose_menu()</span>
<a href="#l23.472"></a><span id="l23.472">         element = element.parentNode;</span>
<a href="#l23.473"></a><span id="l23.473">       }</span>
<a href="#l23.474"></a><span id="l23.474">     }</span>
<a href="#l23.475"></a><span id="l23.475">   }</span>
<a href="#l23.476"></a><span id="l23.476"> </span>
<a href="#l23.477"></a><span id="l23.477">   // Click on a portion of the attachmentBucket that will focus it, but not</span>
<a href="#l23.478"></a><span id="l23.478">   // bring up the file picker</span>
<a href="#l23.479"></a><span id="l23.479">   force_focus(&quot;attachmentBucket&quot;);</span>
<a href="#l23.480"></a><span id="l23.480" class="difflineminus">-  assert_equals(</span>
<a href="#l23.481"></a><span id="l23.481" class="difflineplus">+  Assert.equal(</span>
<a href="#l23.482"></a><span id="l23.482">     &quot;Remove Attachments&quot;,</span>
<a href="#l23.483"></a><span id="l23.483">     cwc.e(&quot;cmd_delete&quot;).getAttribute(&quot;label&quot;),</span>
<a href="#l23.484"></a><span id="l23.484">     &quot;attachmentBucket is focused!&quot;</span>
<a href="#l23.485"></a><span id="l23.485">   );</span>
<a href="#l23.486"></a><span id="l23.486"> </span>
<a href="#l23.487"></a><span id="l23.487">   // Select 1 attachment, and</span>
<a href="#l23.488"></a><span id="l23.488">   // focus the subject to see the label change and to execute isCommandEnabled</span>
<a href="#l23.489"></a><span id="l23.489">   attachment.selectedIndex = 0;</span>
<a href="#l23.490"></a><span id="l23.490">   force_focus(&quot;msgSubject&quot;);</span>
<a href="#l23.491"></a><span id="l23.491" class="difflineminus">-  assert_equals(</span>
<a href="#l23.492"></a><span id="l23.492" class="difflineplus">+  Assert.equal(</span>
<a href="#l23.493"></a><span id="l23.493">     &quot;Delete&quot;,</span>
<a href="#l23.494"></a><span id="l23.494">     cwc.e(&quot;cmd_delete&quot;).getAttribute(&quot;label&quot;),</span>
<a href="#l23.495"></a><span id="l23.495">     &quot;attachmentBucket is not focused!&quot;</span>
<a href="#l23.496"></a><span id="l23.496">   );</span>
<a href="#l23.497"></a><span id="l23.497"> </span>
<a href="#l23.498"></a><span id="l23.498">   // Focus back to the attachmentBucket</span>
<a href="#l23.499"></a><span id="l23.499">   force_focus(&quot;attachmentBucket&quot;);</span>
<a href="#l23.500"></a><span id="l23.500" class="difflineminus">-  assert_equals(</span>
<a href="#l23.501"></a><span id="l23.501" class="difflineplus">+  Assert.equal(</span>
<a href="#l23.502"></a><span id="l23.502">     &quot;Remove Attachment&quot;,</span>
<a href="#l23.503"></a><span id="l23.503">     cwc.e(&quot;cmd_delete&quot;).getAttribute(&quot;label&quot;),</span>
<a href="#l23.504"></a><span id="l23.504">     &quot;Only 1 attachment is selected!&quot;</span>
<a href="#l23.505"></a><span id="l23.505">   );</span>
<a href="#l23.506"></a><span id="l23.506"> </span>
<a href="#l23.507"></a><span id="l23.507">   // Select multiple attachments, and focus the identity for the same purpose</span>
<a href="#l23.508"></a><span id="l23.508">   attachment.selectAll();</span>
<a href="#l23.509"></a><span id="l23.509">   force_focus(&quot;msgIdentity&quot;);</span>
<a href="#l23.510"></a><span id="l23.510" class="difflineminus">-  assert_equals(</span>
<a href="#l23.511"></a><span id="l23.511" class="difflineplus">+  Assert.equal(</span>
<a href="#l23.512"></a><span id="l23.512">     &quot;Delete&quot;,</span>
<a href="#l23.513"></a><span id="l23.513">     cwc.e(&quot;cmd_delete&quot;).getAttribute(&quot;label&quot;),</span>
<a href="#l23.514"></a><span id="l23.514">     &quot;attachmentBucket is not focused!&quot;</span>
<a href="#l23.515"></a><span id="l23.515">   );</span>
<a href="#l23.516"></a><span id="l23.516"> </span>
<a href="#l23.517"></a><span id="l23.517">   // Focus back to the attachmentBucket</span>
<a href="#l23.518"></a><span id="l23.518">   force_focus(&quot;attachmentBucket&quot;);</span>
<a href="#l23.519"></a><span id="l23.519" class="difflineminus">-  assert_equals(</span>
<a href="#l23.520"></a><span id="l23.520" class="difflineplus">+  Assert.equal(</span>
<a href="#l23.521"></a><span id="l23.521">     &quot;Remove Attachments&quot;,</span>
<a href="#l23.522"></a><span id="l23.522">     cwc.e(&quot;cmd_delete&quot;).getAttribute(&quot;label&quot;),</span>
<a href="#l23.523"></a><span id="l23.523">     &quot;Multiple attachments are selected!&quot;</span>
<a href="#l23.524"></a><span id="l23.524">   );</span>
<a href="#l23.525"></a><span id="l23.525"> </span>
<a href="#l23.526"></a><span id="l23.526">   close_compose_window(cwc);</span>
<a href="#l23.527"></a><span id="l23.527" class="difflineminus">-}</span>
<a href="#l23.528"></a><span id="l23.528" class="difflineplus">+});</span>
<a href="#l23.529"></a><span id="l23.529"> </span>
<a href="#l23.530"></a><span id="l23.530" class="difflineminus">-function test_delete_from_toolbar() {</span>
<a href="#l23.531"></a><span id="l23.531" class="difflineplus">+add_task(function test_delete_from_toolbar() {</span>
<a href="#l23.532"></a><span id="l23.532">   be_in_folder(folder);</span>
<a href="#l23.533"></a><span id="l23.533"> </span>
<a href="#l23.534"></a><span id="l23.534">   // First, select the message with two attachments.</span>
<a href="#l23.535"></a><span id="l23.535">   select_none();</span>
<a href="#l23.536"></a><span id="l23.536">   select_click_row(3);</span>
<a href="#l23.537"></a><span id="l23.537"> </span>
<a href="#l23.538"></a><span id="l23.538">   // Expand the attachment list.</span>
<a href="#l23.539"></a><span id="l23.539">   mc.click(mc.eid(&quot;attachmentToggle&quot;));</span>
<a href="#l23.540"></a><span id="l23.540" class="difflineat">@@ -646,9 +644,9 @@ function test_delete_from_toolbar() {</span>
<a href="#l23.541"></a><span id="l23.541">   let firstAttachment = new elib.Elem(mc.e(&quot;attachmentList&quot;).firstElementChild);</span>
<a href="#l23.542"></a><span id="l23.542">   mc.click(firstAttachment, 5, 5);</span>
<a href="#l23.543"></a><span id="l23.543"> </span>
<a href="#l23.544"></a><span id="l23.544">   // Make sure clicking the &quot;Delete&quot; toolbar button with an attachment focused</span>
<a href="#l23.545"></a><span id="l23.545">   // deletes the *message*.</span>
<a href="#l23.546"></a><span id="l23.546">   plan_to_wait_for_folder_events(&quot;DeleteOrMoveMsgCompleted&quot;);</span>
<a href="#l23.547"></a><span id="l23.547">   mc.click(mc.eid(&quot;hdrTrashButton&quot;));</span>
<a href="#l23.548"></a><span id="l23.548">   wait_for_folder_events();</span>
<a href="#l23.549"></a><span id="l23.549" class="difflineminus">-}</span>
<a href="#l23.550"></a><span id="l23.550" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">copy from mail/test/mozmill/attachment/test-attachment-events.js</span>
<a href="#l24.2"></a><span id="l24.2">copy to mail/test/browser/attachment/browser_attachmentEvents.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment-events.js</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineplus">+++ b/mail/test/browser/attachment/browser_attachmentEvents.js</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineat">@@ -1,24 +1,26 @@</span>
<a href="#l24.6"></a><span id="l24.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l24.7"></a><span id="l24.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l24.8"></a><span id="l24.8">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l24.9"></a><span id="l24.9"> </span>
<a href="#l24.10"></a><span id="l24.10"> /**</span>
<a href="#l24.11"></a><span id="l24.11">  * Ensures that attachment events are fired properly</span>
<a href="#l24.12"></a><span id="l24.12">  */</span>
<a href="#l24.13"></a><span id="l24.13"> </span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+/* globals gFolderTreeView */</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+</span>
<a href="#l24.16"></a><span id="l24.16"> &quot;use strict&quot;;</span>
<a href="#l24.17"></a><span id="l24.17"> </span>
<a href="#l24.18"></a><span id="l24.18" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l24.19"></a><span id="l24.19" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l24.20"></a><span id="l24.20"> </span>
<a href="#l24.21"></a><span id="l24.21"> var { select_attachments } = ChromeUtils.import(</span>
<a href="#l24.22"></a><span id="l24.22">   &quot;resource://testing-common/mozmill/AttachmentHelpers.jsm&quot;</span>
<a href="#l24.23"></a><span id="l24.23"> );</span>
<a href="#l24.24"></a><span id="l24.24" class="difflineminus">-var { assert_equals, assert_true, mc } = ChromeUtils.import(</span>
<a href="#l24.25"></a><span id="l24.25" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l24.26"></a><span id="l24.26">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l24.27"></a><span id="l24.27"> );</span>
<a href="#l24.28"></a><span id="l24.28"> var {</span>
<a href="#l24.29"></a><span id="l24.29">   add_attachments,</span>
<a href="#l24.30"></a><span id="l24.30">   close_compose_window,</span>
<a href="#l24.31"></a><span id="l24.31">   open_compose_new_mail,</span>
<a href="#l24.32"></a><span id="l24.32"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l24.33"></a><span id="l24.33"> var { gMockPromptService } = ChromeUtils.import(</span>
<a href="#l24.34"></a><span id="l24.34" class="difflineat">@@ -29,78 +31,74 @@ var { Services } = ChromeUtils.import(&quot;r</span>
<a href="#l24.35"></a><span id="l24.35"> var { fixIterator } = ChromeUtils.import(</span>
<a href="#l24.36"></a><span id="l24.36">   &quot;resource:///modules/iteratorUtils.jsm&quot;</span>
<a href="#l24.37"></a><span id="l24.37"> );</span>
<a href="#l24.38"></a><span id="l24.38"> </span>
<a href="#l24.39"></a><span id="l24.39"> var kAttachmentsAdded = &quot;attachments-added&quot;;</span>
<a href="#l24.40"></a><span id="l24.40"> var kAttachmentsRemoved = &quot;attachments-removed&quot;;</span>
<a href="#l24.41"></a><span id="l24.41"> var kAttachmentRenamed = &quot;attachment-renamed&quot;;</span>
<a href="#l24.42"></a><span id="l24.42"> </span>
<a href="#l24.43"></a><span id="l24.43" class="difflineminus">-var gPath;</span>
<a href="#l24.44"></a><span id="l24.44" class="difflineminus">-</span>
<a href="#l24.45"></a><span id="l24.45" class="difflineminus">-function setupModule(module) {</span>
<a href="#l24.46"></a><span id="l24.46" class="difflineminus">-  gPath = os.getFileForPath(__file__);</span>
<a href="#l24.47"></a><span id="l24.47" class="difflineminus">-}</span>
<a href="#l24.48"></a><span id="l24.48" class="difflineminus">-</span>
<a href="#l24.49"></a><span id="l24.49"> /**</span>
<a href="#l24.50"></a><span id="l24.50">  * Test that the attachments-added event is fired when we add a single</span>
<a href="#l24.51"></a><span id="l24.51">  * attachment.</span>
<a href="#l24.52"></a><span id="l24.52">  */</span>
<a href="#l24.53"></a><span id="l24.53" class="difflineminus">-function test_attachments_added_on_single() {</span>
<a href="#l24.54"></a><span id="l24.54" class="difflineplus">+add_task(function test_attachments_added_on_single() {</span>
<a href="#l24.55"></a><span id="l24.55" class="difflineplus">+  gFolderTreeView.selectFolder(gFolderTreeView._enumerateFolders[1]);</span>
<a href="#l24.56"></a><span id="l24.56" class="difflineplus">+</span>
<a href="#l24.57"></a><span id="l24.57">   // Prepare to listen for attachments-added</span>
<a href="#l24.58"></a><span id="l24.58">   let eventCount = 0;</span>
<a href="#l24.59"></a><span id="l24.59">   let lastEvent;</span>
<a href="#l24.60"></a><span id="l24.60">   let listener = function(event) {</span>
<a href="#l24.61"></a><span id="l24.61">     eventCount++;</span>
<a href="#l24.62"></a><span id="l24.62">     lastEvent = event;</span>
<a href="#l24.63"></a><span id="l24.63">   };</span>
<a href="#l24.64"></a><span id="l24.64"> </span>
<a href="#l24.65"></a><span id="l24.65">   // Open up the compose window</span>
<a href="#l24.66"></a><span id="l24.66">   let cw = open_compose_new_mail(mc);</span>
<a href="#l24.67"></a><span id="l24.67">   cw.e(&quot;attachmentBucket&quot;).addEventListener(kAttachmentsAdded, listener);</span>
<a href="#l24.68"></a><span id="l24.68"> </span>
<a href="#l24.69"></a><span id="l24.69">   // Attach a single file</span>
<a href="#l24.70"></a><span id="l24.70">   add_attachments(cw, &quot;http://www.example.com/1&quot;, 0, false);</span>
<a href="#l24.71"></a><span id="l24.71"> </span>
<a href="#l24.72"></a><span id="l24.72">   // Make sure we only saw the event once</span>
<a href="#l24.73"></a><span id="l24.73" class="difflineminus">-  assert_equals(1, eventCount);</span>
<a href="#l24.74"></a><span id="l24.74" class="difflineplus">+  Assert.equal(1, eventCount);</span>
<a href="#l24.75"></a><span id="l24.75"> </span>
<a href="#l24.76"></a><span id="l24.76">   // Make sure that we were passed the right subject</span>
<a href="#l24.77"></a><span id="l24.77">   let subjects = lastEvent.detail;</span>
<a href="#l24.78"></a><span id="l24.78" class="difflineminus">-  assert_true(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l24.79"></a><span id="l24.79" class="difflineminus">-  assert_equals(</span>
<a href="#l24.80"></a><span id="l24.80" class="difflineplus">+  Assert.ok(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l24.81"></a><span id="l24.81" class="difflineplus">+  Assert.equal(</span>
<a href="#l24.82"></a><span id="l24.82">     &quot;http://www.example.com/1&quot;,</span>
<a href="#l24.83"></a><span id="l24.83">     subjects.queryElementAt(0, Ci.nsIMsgAttachment).url</span>
<a href="#l24.84"></a><span id="l24.84">   );</span>
<a href="#l24.85"></a><span id="l24.85"> </span>
<a href="#l24.86"></a><span id="l24.86">   // Make sure that we can get that event again if we</span>
<a href="#l24.87"></a><span id="l24.87">   // attach more files.</span>
<a href="#l24.88"></a><span id="l24.88">   add_attachments(cw, &quot;http://www.example.com/2&quot;, 0, false);</span>
<a href="#l24.89"></a><span id="l24.89" class="difflineminus">-  assert_equals(2, eventCount);</span>
<a href="#l24.90"></a><span id="l24.90" class="difflineplus">+  Assert.equal(2, eventCount);</span>
<a href="#l24.91"></a><span id="l24.91">   subjects = lastEvent.detail;</span>
<a href="#l24.92"></a><span id="l24.92" class="difflineminus">-  assert_true(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l24.93"></a><span id="l24.93" class="difflineminus">-  assert_equals(</span>
<a href="#l24.94"></a><span id="l24.94" class="difflineplus">+  Assert.ok(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l24.95"></a><span id="l24.95" class="difflineplus">+  Assert.equal(</span>
<a href="#l24.96"></a><span id="l24.96">     &quot;http://www.example.com/2&quot;,</span>
<a href="#l24.97"></a><span id="l24.97">     subjects.queryElementAt(0, Ci.nsIMsgAttachment).url</span>
<a href="#l24.98"></a><span id="l24.98">   );</span>
<a href="#l24.99"></a><span id="l24.99"> </span>
<a href="#l24.100"></a><span id="l24.100">   // And check that we don't receive the event if we try to attach a file</span>
<a href="#l24.101"></a><span id="l24.101">   // that's already attached.</span>
<a href="#l24.102"></a><span id="l24.102">   add_attachments(cw, &quot;http://www.example.com/2&quot;, null, false);</span>
<a href="#l24.103"></a><span id="l24.103" class="difflineminus">-  assert_equals(2, eventCount);</span>
<a href="#l24.104"></a><span id="l24.104" class="difflineplus">+  Assert.equal(2, eventCount);</span>
<a href="#l24.105"></a><span id="l24.105"> </span>
<a href="#l24.106"></a><span id="l24.106">   cw.e(&quot;attachmentBucket&quot;).removeEventListener(kAttachmentsAdded, listener);</span>
<a href="#l24.107"></a><span id="l24.107">   close_compose_window(cw);</span>
<a href="#l24.108"></a><span id="l24.108" class="difflineminus">-}</span>
<a href="#l24.109"></a><span id="l24.109" class="difflineplus">+});</span>
<a href="#l24.110"></a><span id="l24.110"> </span>
<a href="#l24.111"></a><span id="l24.111"> /**</span>
<a href="#l24.112"></a><span id="l24.112">  * Test that the attachments-added event is fired when we add a series</span>
<a href="#l24.113"></a><span id="l24.113">  * of files all at once.</span>
<a href="#l24.114"></a><span id="l24.114">  */</span>
<a href="#l24.115"></a><span id="l24.115" class="difflineminus">-function test_attachments_added_on_multiple() {</span>
<a href="#l24.116"></a><span id="l24.116" class="difflineplus">+add_task(function test_attachments_added_on_multiple() {</span>
<a href="#l24.117"></a><span id="l24.117">   // Prepare to listen for attachments-added</span>
<a href="#l24.118"></a><span id="l24.118">   let eventCount = 0;</span>
<a href="#l24.119"></a><span id="l24.119">   let lastEvent;</span>
<a href="#l24.120"></a><span id="l24.120">   let listener = function(event) {</span>
<a href="#l24.121"></a><span id="l24.121">     eventCount++;</span>
<a href="#l24.122"></a><span id="l24.122">     lastEvent = event;</span>
<a href="#l24.123"></a><span id="l24.123">   };</span>
<a href="#l24.124"></a><span id="l24.124"> </span>
<a href="#l24.125"></a><span id="l24.125" class="difflineat">@@ -111,25 +109,25 @@ function test_attachments_added_on_multi</span>
<a href="#l24.126"></a><span id="l24.126">   // Open the compose window and add the attachments</span>
<a href="#l24.127"></a><span id="l24.127">   let cw = open_compose_new_mail(mc);</span>
<a href="#l24.128"></a><span id="l24.128">   cw.e(&quot;attachmentBucket&quot;).addEventListener(kAttachmentsAdded, listener);</span>
<a href="#l24.129"></a><span id="l24.129"> </span>
<a href="#l24.130"></a><span id="l24.130">   add_attachments(cw, attachmentUrls, null, false);</span>
<a href="#l24.131"></a><span id="l24.131"> </span>
<a href="#l24.132"></a><span id="l24.132">   // Make sure we only saw a single attachments-added for this group</span>
<a href="#l24.133"></a><span id="l24.133">   // of files.</span>
<a href="#l24.134"></a><span id="l24.134" class="difflineminus">-  assert_equals(1, eventCount);</span>
<a href="#l24.135"></a><span id="l24.135" class="difflineplus">+  Assert.equal(1, eventCount);</span>
<a href="#l24.136"></a><span id="l24.136"> </span>
<a href="#l24.137"></a><span id="l24.137">   // Now make sure we got passed the right subjects for the event</span>
<a href="#l24.138"></a><span id="l24.138">   let subjects = lastEvent.detail;</span>
<a href="#l24.139"></a><span id="l24.139" class="difflineminus">-  assert_true(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l24.140"></a><span id="l24.140" class="difflineminus">-  assert_equals(2, subjects.length);</span>
<a href="#l24.141"></a><span id="l24.141" class="difflineplus">+  Assert.ok(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l24.142"></a><span id="l24.142" class="difflineplus">+  Assert.equal(2, subjects.length);</span>
<a href="#l24.143"></a><span id="l24.143"> </span>
<a href="#l24.144"></a><span id="l24.144">   for (let attachment of fixIterator(subjects, Ci.nsIMsgAttachment)) {</span>
<a href="#l24.145"></a><span id="l24.145" class="difflineminus">-    assert_true(attachmentUrls.includes(attachment.url));</span>
<a href="#l24.146"></a><span id="l24.146" class="difflineplus">+    Assert.ok(attachmentUrls.includes(attachment.url));</span>
<a href="#l24.147"></a><span id="l24.147">   }</span>
<a href="#l24.148"></a><span id="l24.148"> </span>
<a href="#l24.149"></a><span id="l24.149">   // Close the compose window - let's try again with 3 attachments.</span>
<a href="#l24.150"></a><span id="l24.150">   cw.e(&quot;attachmentBucket&quot;).removeEventListener(kAttachmentsAdded, listener);</span>
<a href="#l24.151"></a><span id="l24.151">   close_compose_window(cw);</span>
<a href="#l24.152"></a><span id="l24.152"> </span>
<a href="#l24.153"></a><span id="l24.153">   attachmentUrls = [</span>
<a href="#l24.154"></a><span id="l24.154">     &quot;http://www.example.com/1&quot;,</span>
<a href="#l24.155"></a><span id="l24.155" class="difflineat">@@ -138,41 +136,41 @@ function test_attachments_added_on_multi</span>
<a href="#l24.156"></a><span id="l24.156">   ];</span>
<a href="#l24.157"></a><span id="l24.157"> </span>
<a href="#l24.158"></a><span id="l24.158">   // Open the compose window and attach the files, and ensure that we saw</span>
<a href="#l24.159"></a><span id="l24.159">   // the attachments-added event</span>
<a href="#l24.160"></a><span id="l24.160">   cw = open_compose_new_mail(mc);</span>
<a href="#l24.161"></a><span id="l24.161">   cw.e(&quot;attachmentBucket&quot;).addEventListener(kAttachmentsAdded, listener);</span>
<a href="#l24.162"></a><span id="l24.162"> </span>
<a href="#l24.163"></a><span id="l24.163">   add_attachments(cw, attachmentUrls, null, false);</span>
<a href="#l24.164"></a><span id="l24.164" class="difflineminus">-  assert_equals(2, eventCount);</span>
<a href="#l24.165"></a><span id="l24.165" class="difflineplus">+  Assert.equal(2, eventCount);</span>
<a href="#l24.166"></a><span id="l24.166"> </span>
<a href="#l24.167"></a><span id="l24.167">   // Make sure that we got the right subjects back</span>
<a href="#l24.168"></a><span id="l24.168">   subjects = lastEvent.detail;</span>
<a href="#l24.169"></a><span id="l24.169" class="difflineminus">-  assert_true(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l24.170"></a><span id="l24.170" class="difflineminus">-  assert_equals(3, subjects.length);</span>
<a href="#l24.171"></a><span id="l24.171" class="difflineplus">+  Assert.ok(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l24.172"></a><span id="l24.172" class="difflineplus">+  Assert.equal(3, subjects.length);</span>
<a href="#l24.173"></a><span id="l24.173"> </span>
<a href="#l24.174"></a><span id="l24.174">   for (let attachment of fixIterator(subjects, Ci.nsIMsgAttachment)) {</span>
<a href="#l24.175"></a><span id="l24.175" class="difflineminus">-    assert_true(attachmentUrls.includes(attachment.url));</span>
<a href="#l24.176"></a><span id="l24.176" class="difflineplus">+    Assert.ok(attachmentUrls.includes(attachment.url));</span>
<a href="#l24.177"></a><span id="l24.177">   }</span>
<a href="#l24.178"></a><span id="l24.178"> </span>
<a href="#l24.179"></a><span id="l24.179">   // Make sure we don't fire the event again if we try to attach the same</span>
<a href="#l24.180"></a><span id="l24.180">   // files.</span>
<a href="#l24.181"></a><span id="l24.181">   add_attachments(cw, attachmentUrls, null, false);</span>
<a href="#l24.182"></a><span id="l24.182" class="difflineminus">-  assert_equals(2, eventCount);</span>
<a href="#l24.183"></a><span id="l24.183" class="difflineplus">+  Assert.equal(2, eventCount);</span>
<a href="#l24.184"></a><span id="l24.184"> </span>
<a href="#l24.185"></a><span id="l24.185">   cw.e(&quot;attachmentBucket&quot;).removeEventListener(kAttachmentsAdded, listener);</span>
<a href="#l24.186"></a><span id="l24.186">   close_compose_window(cw);</span>
<a href="#l24.187"></a><span id="l24.187" class="difflineminus">-}</span>
<a href="#l24.188"></a><span id="l24.188" class="difflineplus">+});</span>
<a href="#l24.189"></a><span id="l24.189"> </span>
<a href="#l24.190"></a><span id="l24.190"> /**</span>
<a href="#l24.191"></a><span id="l24.191">  * Test that the attachments-removed event is fired when removing a</span>
<a href="#l24.192"></a><span id="l24.192">  * single file.</span>
<a href="#l24.193"></a><span id="l24.193">  */</span>
<a href="#l24.194"></a><span id="l24.194" class="difflineminus">-function test_attachments_removed_on_single() {</span>
<a href="#l24.195"></a><span id="l24.195" class="difflineplus">+add_task(function test_attachments_removed_on_single() {</span>
<a href="#l24.196"></a><span id="l24.196">   // Prepare to listen for attachments-removed</span>
<a href="#l24.197"></a><span id="l24.197">   let eventCount = 0;</span>
<a href="#l24.198"></a><span id="l24.198">   let lastEvent;</span>
<a href="#l24.199"></a><span id="l24.199">   let listener = function(event) {</span>
<a href="#l24.200"></a><span id="l24.200">     eventCount++;</span>
<a href="#l24.201"></a><span id="l24.201">     lastEvent = event;</span>
<a href="#l24.202"></a><span id="l24.202">   };</span>
<a href="#l24.203"></a><span id="l24.203"> </span>
<a href="#l24.204"></a><span id="l24.204" class="difflineat">@@ -183,51 +181,51 @@ function test_attachments_removed_on_sin</span>
<a href="#l24.205"></a><span id="l24.205">   add_attachments(cw, &quot;http://www.example.com/1&quot;);</span>
<a href="#l24.206"></a><span id="l24.206"> </span>
<a href="#l24.207"></a><span id="l24.207">   // Now select that attachment and delete it</span>
<a href="#l24.208"></a><span id="l24.208">   select_attachments(cw, 0);</span>
<a href="#l24.209"></a><span id="l24.209">   // We need to hold a reference to removedAttachment here because</span>
<a href="#l24.210"></a><span id="l24.210">   // the delete routine nulls it out from the attachmentitem.</span>
<a href="#l24.211"></a><span id="l24.211">   cw.window.goDoCommand(&quot;cmd_delete&quot;);</span>
<a href="#l24.212"></a><span id="l24.212">   // Make sure we saw the event</span>
<a href="#l24.213"></a><span id="l24.213" class="difflineminus">-  assert_equals(1, eventCount);</span>
<a href="#l24.214"></a><span id="l24.214" class="difflineplus">+  Assert.equal(1, eventCount);</span>
<a href="#l24.215"></a><span id="l24.215">   // And make sure we were passed the right attachment item as the</span>
<a href="#l24.216"></a><span id="l24.216">   // subject.</span>
<a href="#l24.217"></a><span id="l24.217">   let subjects = lastEvent.detail;</span>
<a href="#l24.218"></a><span id="l24.218" class="difflineminus">-  assert_true(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l24.219"></a><span id="l24.219" class="difflineminus">-  assert_equals(1, subjects.length);</span>
<a href="#l24.220"></a><span id="l24.220" class="difflineminus">-  assert_equals(</span>
<a href="#l24.221"></a><span id="l24.221" class="difflineplus">+  Assert.ok(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l24.222"></a><span id="l24.222" class="difflineplus">+  Assert.equal(1, subjects.length);</span>
<a href="#l24.223"></a><span id="l24.223" class="difflineplus">+  Assert.equal(</span>
<a href="#l24.224"></a><span id="l24.224">     subjects.queryElementAt(0, Ci.nsIMsgAttachment).url,</span>
<a href="#l24.225"></a><span id="l24.225">     &quot;http://www.example.com/1&quot;</span>
<a href="#l24.226"></a><span id="l24.226">   );</span>
<a href="#l24.227"></a><span id="l24.227"> </span>
<a href="#l24.228"></a><span id="l24.228">   // Ok, let's attach it again, and remove it again to ensure that</span>
<a href="#l24.229"></a><span id="l24.229">   // we still see the event.</span>
<a href="#l24.230"></a><span id="l24.230">   add_attachments(cw, &quot;http://www.example.com/2&quot;);</span>
<a href="#l24.231"></a><span id="l24.231">   select_attachments(cw, 0);</span>
<a href="#l24.232"></a><span id="l24.232">   cw.window.goDoCommand(&quot;cmd_delete&quot;);</span>
<a href="#l24.233"></a><span id="l24.233"> </span>
<a href="#l24.234"></a><span id="l24.234" class="difflineminus">-  assert_equals(2, eventCount);</span>
<a href="#l24.235"></a><span id="l24.235" class="difflineplus">+  Assert.equal(2, eventCount);</span>
<a href="#l24.236"></a><span id="l24.236">   subjects = lastEvent.detail;</span>
<a href="#l24.237"></a><span id="l24.237" class="difflineminus">-  assert_true(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l24.238"></a><span id="l24.238" class="difflineminus">-  assert_equals(1, subjects.length);</span>
<a href="#l24.239"></a><span id="l24.239" class="difflineminus">-  assert_equals(</span>
<a href="#l24.240"></a><span id="l24.240" class="difflineplus">+  Assert.ok(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l24.241"></a><span id="l24.241" class="difflineplus">+  Assert.equal(1, subjects.length);</span>
<a href="#l24.242"></a><span id="l24.242" class="difflineplus">+  Assert.equal(</span>
<a href="#l24.243"></a><span id="l24.243">     subjects.queryElementAt(0, Ci.nsIMsgAttachment).url,</span>
<a href="#l24.244"></a><span id="l24.244">     &quot;http://www.example.com/2&quot;</span>
<a href="#l24.245"></a><span id="l24.245">   );</span>
<a href="#l24.246"></a><span id="l24.246"> </span>
<a href="#l24.247"></a><span id="l24.247">   cw.e(&quot;attachmentBucket&quot;).removeEventListener(kAttachmentsRemoved, listener);</span>
<a href="#l24.248"></a><span id="l24.248">   close_compose_window(cw);</span>
<a href="#l24.249"></a><span id="l24.249" class="difflineminus">-}</span>
<a href="#l24.250"></a><span id="l24.250" class="difflineplus">+});</span>
<a href="#l24.251"></a><span id="l24.251"> </span>
<a href="#l24.252"></a><span id="l24.252"> /**</span>
<a href="#l24.253"></a><span id="l24.253">  * Test that the attachments-removed event is fired when removing multiple</span>
<a href="#l24.254"></a><span id="l24.254">  * files all at once.</span>
<a href="#l24.255"></a><span id="l24.255">  */</span>
<a href="#l24.256"></a><span id="l24.256" class="difflineminus">-function test_attachments_removed_on_multiple() {</span>
<a href="#l24.257"></a><span id="l24.257" class="difflineplus">+add_task(function test_attachments_removed_on_multiple() {</span>
<a href="#l24.258"></a><span id="l24.258">   // Prepare to listen for attachments-removed</span>
<a href="#l24.259"></a><span id="l24.259">   let eventCount = 0;</span>
<a href="#l24.260"></a><span id="l24.260">   let lastEvent;</span>
<a href="#l24.261"></a><span id="l24.261">   let listener = function(event) {</span>
<a href="#l24.262"></a><span id="l24.262">     eventCount++;</span>
<a href="#l24.263"></a><span id="l24.263">     lastEvent = event;</span>
<a href="#l24.264"></a><span id="l24.264">   };</span>
<a href="#l24.265"></a><span id="l24.265"> </span>
<a href="#l24.266"></a><span id="l24.266" class="difflineat">@@ -246,44 +244,44 @@ function test_attachments_removed_on_mul</span>
<a href="#l24.267"></a><span id="l24.267"> </span>
<a href="#l24.268"></a><span id="l24.268">   let removedAttachmentUrls = removedAttachmentItems.map(</span>
<a href="#l24.269"></a><span id="l24.269">     aAttachment =&gt; aAttachment.attachment.url</span>
<a href="#l24.270"></a><span id="l24.270">   );</span>
<a href="#l24.271"></a><span id="l24.271"> </span>
<a href="#l24.272"></a><span id="l24.272">   cw.window.goDoCommand(&quot;cmd_delete&quot;);</span>
<a href="#l24.273"></a><span id="l24.273"> </span>
<a href="#l24.274"></a><span id="l24.274">   // We should have seen the attachments-removed event exactly once.</span>
<a href="#l24.275"></a><span id="l24.275" class="difflineminus">-  assert_equals(1, eventCount);</span>
<a href="#l24.276"></a><span id="l24.276" class="difflineplus">+  Assert.equal(1, eventCount);</span>
<a href="#l24.277"></a><span id="l24.277"> </span>
<a href="#l24.278"></a><span id="l24.278">   // Now let's make sure we got passed back the right attachment items</span>
<a href="#l24.279"></a><span id="l24.279">   // as the event subject</span>
<a href="#l24.280"></a><span id="l24.280">   let subjects = lastEvent.detail;</span>
<a href="#l24.281"></a><span id="l24.281" class="difflineminus">-  assert_true(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l24.282"></a><span id="l24.282" class="difflineminus">-  assert_equals(3, subjects.length);</span>
<a href="#l24.283"></a><span id="l24.283" class="difflineplus">+  Assert.ok(subjects instanceof Ci.nsIMutableArray);</span>
<a href="#l24.284"></a><span id="l24.284" class="difflineplus">+  Assert.equal(3, subjects.length);</span>
<a href="#l24.285"></a><span id="l24.285"> </span>
<a href="#l24.286"></a><span id="l24.286">   for (let attachment of fixIterator(subjects, Ci.nsIMsgAttachment)) {</span>
<a href="#l24.287"></a><span id="l24.287" class="difflineminus">-    assert_true(removedAttachmentUrls.includes(attachment.url));</span>
<a href="#l24.288"></a><span id="l24.288" class="difflineplus">+    Assert.ok(removedAttachmentUrls.includes(attachment.url));</span>
<a href="#l24.289"></a><span id="l24.289">   }</span>
<a href="#l24.290"></a><span id="l24.290"> </span>
<a href="#l24.291"></a><span id="l24.291">   // Ok, let's attach and remove some again to ensure that we still see the event.</span>
<a href="#l24.292"></a><span id="l24.292">   add_attachments(cw, [&quot;http://www.example.com/1&quot;, &quot;http://www.example.com/2&quot;]);</span>
<a href="#l24.293"></a><span id="l24.293"> </span>
<a href="#l24.294"></a><span id="l24.294">   select_attachments(cw, 0, 1);</span>
<a href="#l24.295"></a><span id="l24.295">   cw.window.goDoCommand(&quot;cmd_delete&quot;);</span>
<a href="#l24.296"></a><span id="l24.296" class="difflineminus">-  assert_equals(2, eventCount);</span>
<a href="#l24.297"></a><span id="l24.297" class="difflineplus">+  Assert.equal(2, eventCount);</span>
<a href="#l24.298"></a><span id="l24.298"> </span>
<a href="#l24.299"></a><span id="l24.299">   cw.e(&quot;attachmentBucket&quot;).removeEventListener(kAttachmentsRemoved, listener);</span>
<a href="#l24.300"></a><span id="l24.300">   close_compose_window(cw);</span>
<a href="#l24.301"></a><span id="l24.301" class="difflineminus">-}</span>
<a href="#l24.302"></a><span id="l24.302" class="difflineplus">+});</span>
<a href="#l24.303"></a><span id="l24.303"> </span>
<a href="#l24.304"></a><span id="l24.304"> /**</span>
<a href="#l24.305"></a><span id="l24.305">  * Test that we don't see the attachments-removed event if no attachments</span>
<a href="#l24.306"></a><span id="l24.306">  * are selected when hitting &quot;Delete&quot;</span>
<a href="#l24.307"></a><span id="l24.307">  */</span>
<a href="#l24.308"></a><span id="l24.308" class="difflineminus">-function test_no_attachments_removed_on_none() {</span>
<a href="#l24.309"></a><span id="l24.309" class="difflineplus">+add_task(function test_no_attachments_removed_on_none() {</span>
<a href="#l24.310"></a><span id="l24.310">   // Prepare to listen for attachments-removed</span>
<a href="#l24.311"></a><span id="l24.311">   let eventCount = 0;</span>
<a href="#l24.312"></a><span id="l24.312">   let listener = function(event) {</span>
<a href="#l24.313"></a><span id="l24.313">     eventCount++;</span>
<a href="#l24.314"></a><span id="l24.314">   };</span>
<a href="#l24.315"></a><span id="l24.315"> </span>
<a href="#l24.316"></a><span id="l24.316">   // Open the compose window and add some attachments.</span>
<a href="#l24.317"></a><span id="l24.317">   let cw = open_compose_new_mail(mc);</span>
<a href="#l24.318"></a><span id="l24.318" class="difflineat">@@ -295,27 +293,27 @@ function test_no_attachments_removed_on_</span>
<a href="#l24.319"></a><span id="l24.319">     &quot;http://www.example.com/3&quot;,</span>
<a href="#l24.320"></a><span id="l24.320">   ]);</span>
<a href="#l24.321"></a><span id="l24.321"> </span>
<a href="#l24.322"></a><span id="l24.322">   // Choose no attachments</span>
<a href="#l24.323"></a><span id="l24.323">   cw.e(&quot;attachmentBucket&quot;).clearSelection();</span>
<a href="#l24.324"></a><span id="l24.324">   // Run the delete command</span>
<a href="#l24.325"></a><span id="l24.325">   cw.window.goDoCommand(&quot;cmd_delete&quot;);</span>
<a href="#l24.326"></a><span id="l24.326">   // Make sure we didn't see the attachments_removed event.</span>
<a href="#l24.327"></a><span id="l24.327" class="difflineminus">-  assert_equals(0, eventCount);</span>
<a href="#l24.328"></a><span id="l24.328" class="difflineplus">+  Assert.equal(0, eventCount);</span>
<a href="#l24.329"></a><span id="l24.329">   cw.e(&quot;attachmentBucket&quot;).removeEventListener(kAttachmentsRemoved, listener);</span>
<a href="#l24.330"></a><span id="l24.330"> </span>
<a href="#l24.331"></a><span id="l24.331">   close_compose_window(cw);</span>
<a href="#l24.332"></a><span id="l24.332" class="difflineminus">-}</span>
<a href="#l24.333"></a><span id="l24.333" class="difflineplus">+});</span>
<a href="#l24.334"></a><span id="l24.334"> </span>
<a href="#l24.335"></a><span id="l24.335"> /**</span>
<a href="#l24.336"></a><span id="l24.336">  * Test that we see the attachment-renamed event when an attachments</span>
<a href="#l24.337"></a><span id="l24.337">  * name is changed.</span>
<a href="#l24.338"></a><span id="l24.338">  */</span>
<a href="#l24.339"></a><span id="l24.339" class="difflineminus">-function test_attachment_renamed() {</span>
<a href="#l24.340"></a><span id="l24.340" class="difflineplus">+add_task(function test_attachment_renamed() {</span>
<a href="#l24.341"></a><span id="l24.341">   // Here's what we'll rename some files to.</span>
<a href="#l24.342"></a><span id="l24.342">   const kRenameTo1 = &quot;Renamed-1&quot;;</span>
<a href="#l24.343"></a><span id="l24.343">   const kRenameTo2 = &quot;Renamed-2&quot;;</span>
<a href="#l24.344"></a><span id="l24.344">   const kRenameTo3 = &quot;Renamed-3&quot;;</span>
<a href="#l24.345"></a><span id="l24.345"> </span>
<a href="#l24.346"></a><span id="l24.346">   // Prepare to listen for attachment-renamed</span>
<a href="#l24.347"></a><span id="l24.347">   let eventCount = 0;</span>
<a href="#l24.348"></a><span id="l24.348">   let lastEvent;</span>
<a href="#l24.349"></a><span id="l24.349" class="difflineat">@@ -341,72 +339,72 @@ function test_attachment_renamed() {</span>
<a href="#l24.350"></a><span id="l24.350">     &quot;http://www.example.com/2&quot;,</span>
<a href="#l24.351"></a><span id="l24.351">     &quot;http://www.example.com/3&quot;,</span>
<a href="#l24.352"></a><span id="l24.352">   ]);</span>
<a href="#l24.353"></a><span id="l24.353"> </span>
<a href="#l24.354"></a><span id="l24.354">   select_attachments(cw, 0);</span>
<a href="#l24.355"></a><span id="l24.355">   cw.window.goDoCommand(&quot;cmd_renameAttachment&quot;);</span>
<a href="#l24.356"></a><span id="l24.356"> </span>
<a href="#l24.357"></a><span id="l24.357">   // Ensure that we saw the attachment-renamed event</span>
<a href="#l24.358"></a><span id="l24.358" class="difflineminus">-  assert_equals(1, eventCount);</span>
<a href="#l24.359"></a><span id="l24.359" class="difflineplus">+  Assert.equal(1, eventCount);</span>
<a href="#l24.360"></a><span id="l24.360">   // Ensure that the event mentions the right attachment</span>
<a href="#l24.361"></a><span id="l24.361">   let renamedAttachment1 = lastEvent.target.attachment;</span>
<a href="#l24.362"></a><span id="l24.362">   let originalName1 = lastEvent.detail;</span>
<a href="#l24.363"></a><span id="l24.363" class="difflineminus">-  assert_true(renamedAttachment1 instanceof Ci.nsIMsgAttachment);</span>
<a href="#l24.364"></a><span id="l24.364" class="difflineminus">-  assert_equals(kRenameTo1, renamedAttachment1.name);</span>
<a href="#l24.365"></a><span id="l24.365" class="difflineminus">-  assert_true(renamedAttachment1.url.includes(&quot;http://www.example.com/1&quot;));</span>
<a href="#l24.366"></a><span id="l24.366" class="difflineminus">-  assert_equals(&quot;www.example.com/1&quot;, originalName1);</span>
<a href="#l24.367"></a><span id="l24.367" class="difflineplus">+  Assert.ok(renamedAttachment1 instanceof Ci.nsIMsgAttachment);</span>
<a href="#l24.368"></a><span id="l24.368" class="difflineplus">+  Assert.equal(kRenameTo1, renamedAttachment1.name);</span>
<a href="#l24.369"></a><span id="l24.369" class="difflineplus">+  Assert.ok(renamedAttachment1.url.includes(&quot;http://www.example.com/1&quot;));</span>
<a href="#l24.370"></a><span id="l24.370" class="difflineplus">+  Assert.equal(&quot;www.example.com/1&quot;, originalName1);</span>
<a href="#l24.371"></a><span id="l24.371"> </span>
<a href="#l24.372"></a><span id="l24.372">   // Ok, let's try renaming the same attachment.</span>
<a href="#l24.373"></a><span id="l24.373">   gMockPromptService.reset();</span>
<a href="#l24.374"></a><span id="l24.374">   gMockPromptService.inoutValue = kRenameTo2;</span>
<a href="#l24.375"></a><span id="l24.375">   gMockPromptService.returnValue = true;</span>
<a href="#l24.376"></a><span id="l24.376"> </span>
<a href="#l24.377"></a><span id="l24.377">   select_attachments(cw, 0);</span>
<a href="#l24.378"></a><span id="l24.378">   cw.window.goDoCommand(&quot;cmd_renameAttachment&quot;);</span>
<a href="#l24.379"></a><span id="l24.379"> </span>
<a href="#l24.380"></a><span id="l24.380" class="difflineminus">-  assert_equals(2, eventCount);</span>
<a href="#l24.381"></a><span id="l24.381" class="difflineplus">+  Assert.equal(2, eventCount);</span>
<a href="#l24.382"></a><span id="l24.382">   let renamedAttachment2 = lastEvent.target.attachment;</span>
<a href="#l24.383"></a><span id="l24.383">   let originalName2 = lastEvent.detail;</span>
<a href="#l24.384"></a><span id="l24.384" class="difflineminus">-  assert_true(renamedAttachment2 instanceof Ci.nsIMsgAttachment);</span>
<a href="#l24.385"></a><span id="l24.385" class="difflineminus">-  assert_equals(kRenameTo2, renamedAttachment2.name);</span>
<a href="#l24.386"></a><span id="l24.386" class="difflineminus">-  assert_true(renamedAttachment2.url.includes(&quot;http://www.example.com/1&quot;));</span>
<a href="#l24.387"></a><span id="l24.387" class="difflineminus">-  assert_equals(kRenameTo1, originalName2);</span>
<a href="#l24.388"></a><span id="l24.388" class="difflineplus">+  Assert.ok(renamedAttachment2 instanceof Ci.nsIMsgAttachment);</span>
<a href="#l24.389"></a><span id="l24.389" class="difflineplus">+  Assert.equal(kRenameTo2, renamedAttachment2.name);</span>
<a href="#l24.390"></a><span id="l24.390" class="difflineplus">+  Assert.ok(renamedAttachment2.url.includes(&quot;http://www.example.com/1&quot;));</span>
<a href="#l24.391"></a><span id="l24.391" class="difflineplus">+  Assert.equal(kRenameTo1, originalName2);</span>
<a href="#l24.392"></a><span id="l24.392"> </span>
<a href="#l24.393"></a><span id="l24.393">   // Ok, let's rename another attachment</span>
<a href="#l24.394"></a><span id="l24.394">   gMockPromptService.reset();</span>
<a href="#l24.395"></a><span id="l24.395">   gMockPromptService.inoutValue = kRenameTo3;</span>
<a href="#l24.396"></a><span id="l24.396">   gMockPromptService.returnValue = true;</span>
<a href="#l24.397"></a><span id="l24.397"> </span>
<a href="#l24.398"></a><span id="l24.398">   // We'll select the second attachment this time.</span>
<a href="#l24.399"></a><span id="l24.399">   select_attachments(cw, 1);</span>
<a href="#l24.400"></a><span id="l24.400">   cw.window.goDoCommand(&quot;cmd_renameAttachment&quot;);</span>
<a href="#l24.401"></a><span id="l24.401"> </span>
<a href="#l24.402"></a><span id="l24.402">   // Ensure we saw the attachment-renamed event</span>
<a href="#l24.403"></a><span id="l24.403" class="difflineminus">-  assert_equals(3, eventCount);</span>
<a href="#l24.404"></a><span id="l24.404" class="difflineplus">+  Assert.equal(3, eventCount);</span>
<a href="#l24.405"></a><span id="l24.405">   // Ensure that the event mentions the right attachment</span>
<a href="#l24.406"></a><span id="l24.406">   let renamedAttachment3 = lastEvent.target.attachment;</span>
<a href="#l24.407"></a><span id="l24.407">   let originalName3 = lastEvent.detail;</span>
<a href="#l24.408"></a><span id="l24.408" class="difflineminus">-  assert_true(renamedAttachment3 instanceof Ci.nsIMsgAttachment);</span>
<a href="#l24.409"></a><span id="l24.409" class="difflineminus">-  assert_equals(kRenameTo3, renamedAttachment3.name);</span>
<a href="#l24.410"></a><span id="l24.410" class="difflineminus">-  assert_true(renamedAttachment3.url.includes(&quot;http://www.example.com/2&quot;));</span>
<a href="#l24.411"></a><span id="l24.411" class="difflineminus">-  assert_equals(&quot;www.example.com/2&quot;, originalName3);</span>
<a href="#l24.412"></a><span id="l24.412" class="difflineplus">+  Assert.ok(renamedAttachment3 instanceof Ci.nsIMsgAttachment);</span>
<a href="#l24.413"></a><span id="l24.413" class="difflineplus">+  Assert.equal(kRenameTo3, renamedAttachment3.name);</span>
<a href="#l24.414"></a><span id="l24.414" class="difflineplus">+  Assert.ok(renamedAttachment3.url.includes(&quot;http://www.example.com/2&quot;));</span>
<a href="#l24.415"></a><span id="l24.415" class="difflineplus">+  Assert.equal(&quot;www.example.com/2&quot;, originalName3);</span>
<a href="#l24.416"></a><span id="l24.416"> </span>
<a href="#l24.417"></a><span id="l24.417">   // Unregister the Mock Prompt service, and remove our observer.</span>
<a href="#l24.418"></a><span id="l24.418">   cw.e(&quot;attachmentBucket&quot;).removeEventListener(kAttachmentRenamed, listener);</span>
<a href="#l24.419"></a><span id="l24.419"> </span>
<a href="#l24.420"></a><span id="l24.420">   close_compose_window(cw);</span>
<a href="#l24.421"></a><span id="l24.421">   gMockPromptService.unregister();</span>
<a href="#l24.422"></a><span id="l24.422" class="difflineminus">-}</span>
<a href="#l24.423"></a><span id="l24.423" class="difflineplus">+});</span>
<a href="#l24.424"></a><span id="l24.424"> </span>
<a href="#l24.425"></a><span id="l24.425"> /**</span>
<a href="#l24.426"></a><span id="l24.426">  * Test that the attachment-renamed event is not fired if we set the</span>
<a href="#l24.427"></a><span id="l24.427">  * filename to be blank.</span>
<a href="#l24.428"></a><span id="l24.428">  */</span>
<a href="#l24.429"></a><span id="l24.429" class="difflineminus">-function test_no_attachment_renamed_on_blank() {</span>
<a href="#l24.430"></a><span id="l24.430" class="difflineplus">+add_task(function test_no_attachment_renamed_on_blank() {</span>
<a href="#l24.431"></a><span id="l24.431">   // Prepare to listen for attachment-renamed</span>
<a href="#l24.432"></a><span id="l24.432">   let eventCount = 0;</span>
<a href="#l24.433"></a><span id="l24.433">   let listener = function(event) {</span>
<a href="#l24.434"></a><span id="l24.434">     eventCount++;</span>
<a href="#l24.435"></a><span id="l24.435">   };</span>
<a href="#l24.436"></a><span id="l24.436"> </span>
<a href="#l24.437"></a><span id="l24.437">   // Register the Mock Prompt Service to return the empty string when</span>
<a href="#l24.438"></a><span id="l24.438">   // prompted.</span>
<a href="#l24.439"></a><span id="l24.439" class="difflineat">@@ -425,13 +423,13 @@ function test_no_attachment_renamed_on_b</span>
<a href="#l24.440"></a><span id="l24.440">     &quot;http://www.example.com/2&quot;,</span>
<a href="#l24.441"></a><span id="l24.441">     &quot;http://www.example.com/3&quot;,</span>
<a href="#l24.442"></a><span id="l24.442">   ]);</span>
<a href="#l24.443"></a><span id="l24.443"> </span>
<a href="#l24.444"></a><span id="l24.444">   select_attachments(cw, 0);</span>
<a href="#l24.445"></a><span id="l24.445">   cw.window.goDoCommand(&quot;cmd_renameAttachment&quot;);</span>
<a href="#l24.446"></a><span id="l24.446"> </span>
<a href="#l24.447"></a><span id="l24.447">   // Ensure that we didn't see the attachment-renamed event.</span>
<a href="#l24.448"></a><span id="l24.448" class="difflineminus">-  assert_equals(0, eventCount);</span>
<a href="#l24.449"></a><span id="l24.449" class="difflineplus">+  Assert.equal(0, eventCount);</span>
<a href="#l24.450"></a><span id="l24.450">   cw.e(&quot;attachmentBucket&quot;).removeEventListener(kAttachmentRenamed, listener);</span>
<a href="#l24.451"></a><span id="l24.451">   close_compose_window(cw);</span>
<a href="#l24.452"></a><span id="l24.452">   gMockPromptService.unregister();</span>
<a href="#l24.453"></a><span id="l24.453" class="difflineminus">-}</span>
<a href="#l24.454"></a><span id="l24.454" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">copy from mail/test/mozmill/attachment/test-attachment-in-plain-msg.js</span>
<a href="#l25.2"></a><span id="l25.2">copy to mail/test/browser/attachment/browser_attachmentInPlainMsg.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment-in-plain-msg.js</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineplus">+++ b/mail/test/browser/attachment/browser_attachmentInPlainMsg.js</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineat">@@ -1,57 +1,51 @@</span>
<a href="#l25.6"></a><span id="l25.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.7"></a><span id="l25.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.8"></a><span id="l25.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.9"></a><span id="l25.9"> </span>
<a href="#l25.10"></a><span id="l25.10"> &quot;use strict&quot;;</span>
<a href="#l25.11"></a><span id="l25.11"> </span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l25.14"></a><span id="l25.14"> </span>
<a href="#l25.15"></a><span id="l25.15"> var { wait_for_element_visible } = ChromeUtils.import(</span>
<a href="#l25.16"></a><span id="l25.16">   &quot;resource://testing-common/mozmill/DOMHelpers.jsm&quot;</span>
<a href="#l25.17"></a><span id="l25.17"> );</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineminus">-var {</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineminus">-  assert_equals,</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineminus">-  assert_false,</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineminus">-  assert_true,</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineminus">-  open_message_from_file,</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineminus">-} = ChromeUtils.import(</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+var { open_message_from_file } = ChromeUtils.import(</span>
<a href="#l25.25"></a><span id="l25.25">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l25.26"></a><span id="l25.26"> );</span>
<a href="#l25.27"></a><span id="l25.27"> var { close_window } = ChromeUtils.import(</span>
<a href="#l25.28"></a><span id="l25.28">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l25.29"></a><span id="l25.29"> );</span>
<a href="#l25.30"></a><span id="l25.30"> </span>
<a href="#l25.31"></a><span id="l25.31"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l25.32"></a><span id="l25.32"> </span>
<a href="#l25.33"></a><span id="l25.33"> /**</span>
<a href="#l25.34"></a><span id="l25.34">  * Bug 1358565</span>
<a href="#l25.35"></a><span id="l25.35">  * Check that a non-empty image is shown as attachment and is detected as non-empty</span>
<a href="#l25.36"></a><span id="l25.36">  * when message is viewed as plain text.</span>
<a href="#l25.37"></a><span id="l25.37">  */</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineminus">-async function test_attachment_not_empty() {</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineplus">+add_task(async function test_attachment_not_empty() {</span>
<a href="#l25.40"></a><span id="l25.40">   Services.prefs.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, true);</span>
<a href="#l25.41"></a><span id="l25.41"> </span>
<a href="#l25.42"></a><span id="l25.42" class="difflineminus">-  let thisFilePath = os.getFileForPath(__file__);</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineminus">-  let file = os.getFileForPath(os.abspath(&quot;./bug1358565.eml&quot;, thisFilePath));</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(&quot;data/bug1358565.eml&quot;));</span>
<a href="#l25.45"></a><span id="l25.45"> </span>
<a href="#l25.46"></a><span id="l25.46">   let msgc = open_message_from_file(file);</span>
<a href="#l25.47"></a><span id="l25.47"> </span>
<a href="#l25.48"></a><span id="l25.48">   wait_for_element_visible(msgc, &quot;attachmentToggle&quot;);</span>
<a href="#l25.49"></a><span id="l25.49">   msgc.click(msgc.eid(&quot;attachmentToggle&quot;));</span>
<a href="#l25.50"></a><span id="l25.50"> </span>
<a href="#l25.51"></a><span id="l25.51">   wait_for_element_visible(msgc, &quot;attachmentList&quot;);</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineminus">-  assert_equals(msgc.e(&quot;attachmentList&quot;).itemCount, 1);</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+  Assert.equal(msgc.e(&quot;attachmentList&quot;).itemCount, 1);</span>
<a href="#l25.54"></a><span id="l25.54"> </span>
<a href="#l25.55"></a><span id="l25.55">   let attachmentElem = msgc.e(&quot;attachmentList&quot;).getItemAtIndex(0);</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineminus">-  assert_equals(attachmentElem.attachment.contentType, &quot;image/jpeg&quot;);</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineminus">-  assert_equals(attachmentElem.attachment.name, &quot;bug.png&quot;);</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineminus">-  assert_true(attachmentElem.attachment.hasFile);</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineminus">-  assert_false(</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineminus">-    await attachmentElem.attachment.isEmpty(),</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineplus">+  Assert.equal(attachmentElem.attachment.contentType, &quot;image/jpeg&quot;);</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineplus">+  Assert.equal(attachmentElem.attachment.name, &quot;bug.png&quot;);</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+  Assert.ok(attachmentElem.attachment.hasFile);</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineplus">+  Assert.ok(</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineplus">+    !(await attachmentElem.attachment.isEmpty()),</span>
<a href="#l25.66"></a><span id="l25.66">     &quot;Attachment incorrectly determined empty&quot;</span>
<a href="#l25.67"></a><span id="l25.67">   );</span>
<a href="#l25.68"></a><span id="l25.68"> </span>
<a href="#l25.69"></a><span id="l25.69">   close_window(msgc);</span>
<a href="#l25.70"></a><span id="l25.70"> </span>
<a href="#l25.71"></a><span id="l25.71">   Services.prefs.clearUserPref(&quot;mailnews.display.prefer_plaintext&quot;);</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineminus">-}</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">copy from mail/test/mozmill/attachment/test-attachment-menus.js</span>
<a href="#l26.2"></a><span id="l26.2">copy to mail/test/browser/attachment/browser_attachmentMenus.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment-menus.js</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineplus">+++ b/mail/test/browser/attachment/browser_attachmentMenus.js</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineat">@@ -4,21 +4,21 @@</span>
<a href="#l26.6"></a><span id="l26.6"> </span>
<a href="#l26.7"></a><span id="l26.7"> &quot;use strict&quot;;</span>
<a href="#l26.8"></a><span id="l26.8"> </span>
<a href="#l26.9"></a><span id="l26.9"> var folder;</span>
<a href="#l26.10"></a><span id="l26.10"> var messenger;</span>
<a href="#l26.11"></a><span id="l26.11"> var epsilon;</span>
<a href="#l26.12"></a><span id="l26.12"> </span>
<a href="#l26.13"></a><span id="l26.13"> var elib = ChromeUtils.import(</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l26.15"></a><span id="l26.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l26.16"></a><span id="l26.16"> );</span>
<a href="#l26.17"></a><span id="l26.17" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l26.18"></a><span id="l26.18" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l26.19"></a><span id="l26.19"> var controller = ChromeUtils.import(</span>
<a href="#l26.20"></a><span id="l26.20" class="difflineminus">-  &quot;chrome://mozmill/content/modules/controller.jsm&quot;</span>
<a href="#l26.21"></a><span id="l26.21" class="difflineplus">+  &quot;resource://testing-common/mozmill/controller.jsm&quot;</span>
<a href="#l26.22"></a><span id="l26.22"> );</span>
<a href="#l26.23"></a><span id="l26.23"> </span>
<a href="#l26.24"></a><span id="l26.24"> var {</span>
<a href="#l26.25"></a><span id="l26.25">   create_body_part,</span>
<a href="#l26.26"></a><span id="l26.26">   create_deleted_attachment,</span>
<a href="#l26.27"></a><span id="l26.27">   create_detached_attachment,</span>
<a href="#l26.28"></a><span id="l26.28">   create_enclosure_attachment,</span>
<a href="#l26.29"></a><span id="l26.29"> } = ChromeUtils.import(</span>
<a href="#l26.30"></a><span id="l26.30" class="difflineat">@@ -178,41 +178,41 @@ var messages = [</span>
<a href="#l26.31"></a><span id="l26.31">     menuStates: [</span>
<a href="#l26.32"></a><span id="l26.32">       { open: false, save: false, detach: false, delete_: false },</span>
<a href="#l26.33"></a><span id="l26.33">       { open: false, save: false, detach: false, delete_: false },</span>
<a href="#l26.34"></a><span id="l26.34">     ],</span>
<a href="#l26.35"></a><span id="l26.35">     allMenuStates: { open: false, save: false, detach: false, delete_: false },</span>
<a href="#l26.36"></a><span id="l26.36">   },</span>
<a href="#l26.37"></a><span id="l26.37"> ];</span>
<a href="#l26.38"></a><span id="l26.38"> </span>
<a href="#l26.39"></a><span id="l26.39" class="difflineminus">-function setupModule(module) {</span>
<a href="#l26.40"></a><span id="l26.40" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l26.41"></a><span id="l26.41">   messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l26.42"></a><span id="l26.42"> </span>
<a href="#l26.43"></a><span id="l26.43">   /* Today's gory details (thanks to Jonathan Protzenko): libmime somehow</span>
<a href="#l26.44"></a><span id="l26.44">    * counts the trailing newline for an attachment MIME part. Most of the time,</span>
<a href="#l26.45"></a><span id="l26.45">    * assuming attachment has N bytes (no matter what's inside, newlines or</span>
<a href="#l26.46"></a><span id="l26.46">    * not), libmime will return N + 1 bytes. On Linux and Mac, this always</span>
<a href="#l26.47"></a><span id="l26.47">    * holds. However, on Windows, if the attachment is not encoded (that is, is</span>
<a href="#l26.48"></a><span id="l26.48">    * inline text), libmime will return N + 2 bytes.</span>
<a href="#l26.49"></a><span id="l26.49">    */</span>
<a href="#l26.50"></a><span id="l26.50">   epsilon = &quot;@mozilla.org/windows-registry-key;1&quot; in Cc ? 2 : 1;</span>
<a href="#l26.51"></a><span id="l26.51"> </span>
<a href="#l26.52"></a><span id="l26.52">   // set up our detached/deleted attachments</span>
<a href="#l26.53"></a><span id="l26.53" class="difflineminus">-  var thisFilePath = os.getFileForPath(__file__);</span>
<a href="#l26.54"></a><span id="l26.54" class="difflineminus">-</span>
<a href="#l26.55"></a><span id="l26.55" class="difflineminus">-  var detachedFile = os.getFileForPath(os.abspath(detachedName, thisFilePath));</span>
<a href="#l26.56"></a><span id="l26.56" class="difflineplus">+  var detachedFile = new FileUtils.File(</span>
<a href="#l26.57"></a><span id="l26.57" class="difflineplus">+    getTestFilePath(`data/${detachedName}`)</span>
<a href="#l26.58"></a><span id="l26.58" class="difflineplus">+  );</span>
<a href="#l26.59"></a><span id="l26.59">   var detached = create_body_part(&quot;Here is a file&quot;, [</span>
<a href="#l26.60"></a><span id="l26.60">     create_detached_attachment(detachedFile, &quot;text/plain&quot;),</span>
<a href="#l26.61"></a><span id="l26.61">   ]);</span>
<a href="#l26.62"></a><span id="l26.62">   var multiple_detached = create_body_part(&quot;Here are some files&quot;, [</span>
<a href="#l26.63"></a><span id="l26.63">     create_detached_attachment(detachedFile, &quot;text/plain&quot;),</span>
<a href="#l26.64"></a><span id="l26.64">     create_detached_attachment(detachedFile, &quot;text/plain&quot;),</span>
<a href="#l26.65"></a><span id="l26.65">   ]);</span>
<a href="#l26.66"></a><span id="l26.66"> </span>
<a href="#l26.67"></a><span id="l26.67" class="difflineminus">-  var missingFile = os.getFileForPath(os.abspath(missingName, thisFilePath));</span>
<a href="#l26.68"></a><span id="l26.68" class="difflineplus">+  var missingFile = new FileUtils.File(getTestFilePath(`data/${missingName}`));</span>
<a href="#l26.69"></a><span id="l26.69">   var missing = create_body_part(</span>
<a href="#l26.70"></a><span id="l26.70">     &quot;Here is a file (but you deleted the external file, you silly oaf!)&quot;,</span>
<a href="#l26.71"></a><span id="l26.71">     [create_detached_attachment(missingFile, &quot;text/plain&quot;)]</span>
<a href="#l26.72"></a><span id="l26.72">   );</span>
<a href="#l26.73"></a><span id="l26.73">   var multiple_missing = create_body_part(</span>
<a href="#l26.74"></a><span id="l26.74">     &quot;Here are some files (but you deleted the external files, you silly oaf!)&quot;,</span>
<a href="#l26.75"></a><span id="l26.75">     [</span>
<a href="#l26.76"></a><span id="l26.76">       create_detached_attachment(missingFile, &quot;text/plain&quot;),</span>
<a href="#l26.77"></a><span id="l26.77" class="difflineat">@@ -337,17 +337,17 @@ function setupModule(module) {</span>
<a href="#l26.78"></a><span id="l26.78">         break;</span>
<a href="#l26.79"></a><span id="l26.79">       case &quot;link_multiple_enclosures_all_invalid&quot;:</span>
<a href="#l26.80"></a><span id="l26.80">         messages[i].bodyPart = multiple_enclosures_all_links_invalid;</span>
<a href="#l26.81"></a><span id="l26.81">         break;</span>
<a href="#l26.82"></a><span id="l26.82">     }</span>
<a href="#l26.83"></a><span id="l26.83"> </span>
<a href="#l26.84"></a><span id="l26.84">     add_message_to_folder(folder, create_message(messages[i]));</span>
<a href="#l26.85"></a><span id="l26.85">   }</span>
<a href="#l26.86"></a><span id="l26.86" class="difflineminus">-}</span>
<a href="#l26.87"></a><span id="l26.87" class="difflineplus">+});</span>
<a href="#l26.88"></a><span id="l26.88"> </span>
<a href="#l26.89"></a><span id="l26.89"> /**</span>
<a href="#l26.90"></a><span id="l26.90">  * Ensure that the specified element is visible/hidden</span>
<a href="#l26.91"></a><span id="l26.91">  *</span>
<a href="#l26.92"></a><span id="l26.92">  * @param id the id of the element to check</span>
<a href="#l26.93"></a><span id="l26.93">  * @param visible true if the element should be visible, false otherwise</span>
<a href="#l26.94"></a><span id="l26.94">  */</span>
<a href="#l26.95"></a><span id="l26.95"> function assert_shown(id, visible) {</span>
<a href="#l26.96"></a><span id="l26.96" class="difflineat">@@ -381,17 +381,17 @@ function check_toolbar_menu_states_singl</span>
<a href="#l26.97"></a><span id="l26.97">   assert_shown(&quot;attachmentSaveAllSingle&quot;, true);</span>
<a href="#l26.98"></a><span id="l26.98">   assert_shown(&quot;attachmentSaveAllMultiple&quot;, false);</span>
<a href="#l26.99"></a><span id="l26.99"> </span>
<a href="#l26.100"></a><span id="l26.100">   if (expected.save === false) {</span>
<a href="#l26.101"></a><span id="l26.101">     assert_enabled(&quot;attachmentSaveAllSingle&quot;, false);</span>
<a href="#l26.102"></a><span id="l26.102">   } else {</span>
<a href="#l26.103"></a><span id="l26.103">     assert_enabled(&quot;attachmentSaveAllSingle&quot;, true);</span>
<a href="#l26.104"></a><span id="l26.104">     mc.click(</span>
<a href="#l26.105"></a><span id="l26.105" class="difflineminus">-      new elementslib.Elem(</span>
<a href="#l26.106"></a><span id="l26.106" class="difflineplus">+      new elib.Elem(</span>
<a href="#l26.107"></a><span id="l26.107">         mc</span>
<a href="#l26.108"></a><span id="l26.108">           .e(&quot;attachmentSaveAllSingle&quot;)</span>
<a href="#l26.109"></a><span id="l26.109">           .querySelector(&quot;.toolbarbutton-menubutton-dropmarker&quot;)</span>
<a href="#l26.110"></a><span id="l26.110">       )</span>
<a href="#l26.111"></a><span id="l26.111">     );</span>
<a href="#l26.112"></a><span id="l26.112">     wait_for_popup_to_open(mc.e(&quot;attachmentSaveAllSingleMenu&quot;));</span>
<a href="#l26.113"></a><span id="l26.113"> </span>
<a href="#l26.114"></a><span id="l26.114">     try {</span>
<a href="#l26.115"></a><span id="l26.115" class="difflineat">@@ -414,17 +414,17 @@ function check_toolbar_menu_states_multi</span>
<a href="#l26.116"></a><span id="l26.116">   assert_shown(&quot;attachmentSaveAllSingle&quot;, false);</span>
<a href="#l26.117"></a><span id="l26.117">   assert_shown(&quot;attachmentSaveAllMultiple&quot;, true);</span>
<a href="#l26.118"></a><span id="l26.118"> </span>
<a href="#l26.119"></a><span id="l26.119">   if (expected.save === false) {</span>
<a href="#l26.120"></a><span id="l26.120">     assert_enabled(&quot;attachmentSaveAllMultiple&quot;, false);</span>
<a href="#l26.121"></a><span id="l26.121">   } else {</span>
<a href="#l26.122"></a><span id="l26.122">     assert_enabled(&quot;attachmentSaveAllMultiple&quot;, true);</span>
<a href="#l26.123"></a><span id="l26.123">     mc.click(</span>
<a href="#l26.124"></a><span id="l26.124" class="difflineminus">-      new elementslib.Elem(</span>
<a href="#l26.125"></a><span id="l26.125" class="difflineplus">+      new elib.Elem(</span>
<a href="#l26.126"></a><span id="l26.126">         mc</span>
<a href="#l26.127"></a><span id="l26.127">           .e(&quot;attachmentSaveAllMultiple&quot;)</span>
<a href="#l26.128"></a><span id="l26.128">           .querySelector(&quot;.toolbarbutton-menubutton-dropmarker&quot;)</span>
<a href="#l26.129"></a><span id="l26.129">       )</span>
<a href="#l26.130"></a><span id="l26.130">     );</span>
<a href="#l26.131"></a><span id="l26.131">     wait_for_popup_to_open(mc.e(&quot;attachmentSaveAllMultipleMenu&quot;));</span>
<a href="#l26.132"></a><span id="l26.132"> </span>
<a href="#l26.133"></a><span id="l26.133">     try {</span>
<a href="#l26.134"></a><span id="l26.134" class="difflineat">@@ -522,14 +522,22 @@ function help_test_attachment_menus(inde</span>
<a href="#l26.135"></a><span id="l26.135"> </span>
<a href="#l26.136"></a><span id="l26.136">   check_menu_states_all(messages[index].allMenuStates);</span>
<a href="#l26.137"></a><span id="l26.137">   for (let i = 0; i &lt; expectedStates.length; i++) {</span>
<a href="#l26.138"></a><span id="l26.138">     check_menu_states_single(i, expectedStates[i]);</span>
<a href="#l26.139"></a><span id="l26.139">   }</span>
<a href="#l26.140"></a><span id="l26.140"> }</span>
<a href="#l26.141"></a><span id="l26.141"> </span>
<a href="#l26.142"></a><span id="l26.142"> // Generate a test for each message in |messages|.</span>
<a href="#l26.143"></a><span id="l26.143" class="difflineminus">-for (let [i, message] of messages.entries()) {</span>
<a href="#l26.144"></a><span id="l26.144" class="difflineminus">-  let index = i; // make a copy to avoid passing a reference to i</span>
<a href="#l26.145"></a><span id="l26.145" class="difflineminus">-  this[&quot;test_&quot; + message.name] = function() {</span>
<a href="#l26.146"></a><span id="l26.146" class="difflineminus">-    help_test_attachment_menus(index);</span>
<a href="#l26.147"></a><span id="l26.147" class="difflineminus">-  };</span>
<a href="#l26.148"></a><span id="l26.148" class="difflineplus">+for (let i = 0; i &lt; messages.length; i++) {</span>
<a href="#l26.149"></a><span id="l26.149" class="difflineplus">+  add_task(function() {</span>
<a href="#l26.150"></a><span id="l26.150" class="difflineplus">+    help_test_attachment_menus(i);</span>
<a href="#l26.151"></a><span id="l26.151" class="difflineplus">+  });</span>
<a href="#l26.152"></a><span id="l26.152"> }</span>
<a href="#l26.153"></a><span id="l26.153" class="difflineplus">+</span>
<a href="#l26.154"></a><span id="l26.154" class="difflineplus">+add_task(() =&gt; {</span>
<a href="#l26.155"></a><span id="l26.155" class="difflineplus">+  Assert.report(</span>
<a href="#l26.156"></a><span id="l26.156" class="difflineplus">+    false,</span>
<a href="#l26.157"></a><span id="l26.157" class="difflineplus">+    undefined,</span>
<a href="#l26.158"></a><span id="l26.158" class="difflineplus">+    undefined,</span>
<a href="#l26.159"></a><span id="l26.159" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l26.160"></a><span id="l26.160" class="difflineplus">+  );</span>
<a href="#l26.161"></a><span id="l26.161" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">copy from mail/test/mozmill/attachment/test-attachment-size.js</span>
<a href="#l27.2"></a><span id="l27.2">copy to mail/test/browser/attachment/browser_attachmentSize.js</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineminus">--- a/mail/test/mozmill/attachment/test-attachment-size.js</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineplus">+++ b/mail/test/browser/attachment/browser_attachmentSize.js</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineat">@@ -3,19 +3,19 @@</span>
<a href="#l27.6"></a><span id="l27.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l27.7"></a><span id="l27.7"> </span>
<a href="#l27.8"></a><span id="l27.8"> &quot;use strict&quot;;</span>
<a href="#l27.9"></a><span id="l27.9"> </span>
<a href="#l27.10"></a><span id="l27.10"> var folder;</span>
<a href="#l27.11"></a><span id="l27.11"> var messenger;</span>
<a href="#l27.12"></a><span id="l27.12"> var epsilon;</span>
<a href="#l27.13"></a><span id="l27.13"> </span>
<a href="#l27.14"></a><span id="l27.14" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l27.15"></a><span id="l27.15" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l27.16"></a><span id="l27.16"> var controller = ChromeUtils.import(</span>
<a href="#l27.17"></a><span id="l27.17" class="difflineminus">-  &quot;chrome://mozmill/content/modules/controller.jsm&quot;</span>
<a href="#l27.18"></a><span id="l27.18" class="difflineplus">+  &quot;resource://testing-common/mozmill/controller.jsm&quot;</span>
<a href="#l27.19"></a><span id="l27.19"> );</span>
<a href="#l27.20"></a><span id="l27.20"> </span>
<a href="#l27.21"></a><span id="l27.21"> var {</span>
<a href="#l27.22"></a><span id="l27.22">   create_body_part,</span>
<a href="#l27.23"></a><span id="l27.23">   create_deleted_attachment,</span>
<a href="#l27.24"></a><span id="l27.24">   create_detached_attachment,</span>
<a href="#l27.25"></a><span id="l27.25"> } = ChromeUtils.import(</span>
<a href="#l27.26"></a><span id="l27.26">   &quot;resource://testing-common/mozmill/AttachmentHelpers.jsm&quot;</span>
<a href="#l27.27"></a><span id="l27.27" class="difflineat">@@ -170,37 +170,37 @@ var messages = [</span>
<a href="#l27.28"></a><span id="l27.28">   {</span>
<a href="#l27.29"></a><span id="l27.29">     name: &quot;attached_message_with_attachment&quot;,</span>
<a href="#l27.30"></a><span id="l27.30">     bodyPart: null,</span>
<a href="#l27.31"></a><span id="l27.31">     attachmentSizes: [-1, textAttachment.length],</span>
<a href="#l27.32"></a><span id="l27.32">     attachmentTotalSize: { size: 0, exact: true },</span>
<a href="#l27.33"></a><span id="l27.33">   },</span>
<a href="#l27.34"></a><span id="l27.34"> ];</span>
<a href="#l27.35"></a><span id="l27.35"> </span>
<a href="#l27.36"></a><span id="l27.36" class="difflineminus">-function setupModule(module) {</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l27.38"></a><span id="l27.38">   messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l27.39"></a><span id="l27.39"> </span>
<a href="#l27.40"></a><span id="l27.40">   /* Today's gory details (thanks to Jonathan Protzenko): libmime somehow</span>
<a href="#l27.41"></a><span id="l27.41">    * counts the trailing newline for an attachment MIME part. Most of the time,</span>
<a href="#l27.42"></a><span id="l27.42">    * assuming attachment has N bytes (no matter what's inside, newlines or</span>
<a href="#l27.43"></a><span id="l27.43">    * not), libmime will return N + 1 bytes. On Linux and Mac, this always</span>
<a href="#l27.44"></a><span id="l27.44">    * holds. However, on Windows, if the attachment is not encoded (that is, is</span>
<a href="#l27.45"></a><span id="l27.45">    * inline text), libmime will return N + 2 bytes.</span>
<a href="#l27.46"></a><span id="l27.46">    */</span>
<a href="#l27.47"></a><span id="l27.47">   epsilon = &quot;@mozilla.org/windows-registry-key;1&quot; in Cc ? 4 : 2;</span>
<a href="#l27.48"></a><span id="l27.48"> </span>
<a href="#l27.49"></a><span id="l27.49">   // set up our detached/deleted attachments</span>
<a href="#l27.50"></a><span id="l27.50" class="difflineminus">-  var thisFilePath = os.getFileForPath(__file__);</span>
<a href="#l27.51"></a><span id="l27.51" class="difflineminus">-</span>
<a href="#l27.52"></a><span id="l27.52" class="difflineminus">-  var detachedFile = os.getFileForPath(os.abspath(detachedName, thisFilePath));</span>
<a href="#l27.53"></a><span id="l27.53" class="difflineplus">+  var detachedFile = new FileUtils.File(</span>
<a href="#l27.54"></a><span id="l27.54" class="difflineplus">+    getTestFilePath(`data/${detachedName}`)</span>
<a href="#l27.55"></a><span id="l27.55" class="difflineplus">+  );</span>
<a href="#l27.56"></a><span id="l27.56">   var detached = create_body_part(&quot;Here is a file&quot;, [</span>
<a href="#l27.57"></a><span id="l27.57">     create_detached_attachment(detachedFile, &quot;text/plain&quot;),</span>
<a href="#l27.58"></a><span id="l27.58">   ]);</span>
<a href="#l27.59"></a><span id="l27.59"> </span>
<a href="#l27.60"></a><span id="l27.60" class="difflineminus">-  var missingFile = os.getFileForPath(os.abspath(missingName, thisFilePath));</span>
<a href="#l27.61"></a><span id="l27.61" class="difflineplus">+  var missingFile = new FileUtils.File(getTestFilePath(`data/${missingName}`));</span>
<a href="#l27.62"></a><span id="l27.62">   var missing = create_body_part(</span>
<a href="#l27.63"></a><span id="l27.63">     &quot;Here is a file (but you deleted the external file, you silly oaf!)&quot;,</span>
<a href="#l27.64"></a><span id="l27.64">     [create_detached_attachment(missingFile, &quot;text/plain&quot;)]</span>
<a href="#l27.65"></a><span id="l27.65">   );</span>
<a href="#l27.66"></a><span id="l27.66"> </span>
<a href="#l27.67"></a><span id="l27.67">   var deleted = create_body_part(&quot;Here is a file that you deleted&quot;, [</span>
<a href="#l27.68"></a><span id="l27.68">     create_deleted_attachment(deletedName, &quot;text/plain&quot;),</span>
<a href="#l27.69"></a><span id="l27.69">   ]);</span>
<a href="#l27.70"></a><span id="l27.70" class="difflineat">@@ -250,17 +250,17 @@ function setupModule(module) {</span>
<a href="#l27.71"></a><span id="l27.71">         ]);</span>
<a href="#l27.72"></a><span id="l27.72">         messages[i].attachmentSizes[0] = attachedMessageLength;</span>
<a href="#l27.73"></a><span id="l27.73">         messages[i].attachmentTotalSize.size += attachedMessageLength;</span>
<a href="#l27.74"></a><span id="l27.74">         break;</span>
<a href="#l27.75"></a><span id="l27.75">     }</span>
<a href="#l27.76"></a><span id="l27.76"> </span>
<a href="#l27.77"></a><span id="l27.77">     add_message_to_folder(folder, create_message(messages[i]));</span>
<a href="#l27.78"></a><span id="l27.78">   }</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineminus">-}</span>
<a href="#l27.80"></a><span id="l27.80" class="difflineplus">+});</span>
<a href="#l27.81"></a><span id="l27.81"> </span>
<a href="#l27.82"></a><span id="l27.82"> /**</span>
<a href="#l27.83"></a><span id="l27.83">  * Make sure that the attachment's size is what we expect</span>
<a href="#l27.84"></a><span id="l27.84">  * @param index the attachment's index, starting at 0</span>
<a href="#l27.85"></a><span id="l27.85">  * @param expectedSize the expected size of the attachment, in bytes</span>
<a href="#l27.86"></a><span id="l27.86">  */</span>
<a href="#l27.87"></a><span id="l27.87"> function check_attachment_size(index, expectedSize) {</span>
<a href="#l27.88"></a><span id="l27.88">   let list = mc.e(&quot;attachmentList&quot;);</span>
<a href="#l27.89"></a><span id="l27.89" class="difflineat">@@ -417,14 +417,22 @@ function help_test_attachment_size(index</span>
<a href="#l27.90"></a><span id="l27.90">   check_total_attachment_size(</span>
<a href="#l27.91"></a><span id="l27.91">     expectedSizes.length,</span>
<a href="#l27.92"></a><span id="l27.92">     totalSize.size,</span>
<a href="#l27.93"></a><span id="l27.93">     totalSize.exact</span>
<a href="#l27.94"></a><span id="l27.94">   );</span>
<a href="#l27.95"></a><span id="l27.95"> }</span>
<a href="#l27.96"></a><span id="l27.96"> </span>
<a href="#l27.97"></a><span id="l27.97"> // Generate a test for each message in |messages|.</span>
<a href="#l27.98"></a><span id="l27.98" class="difflineminus">-for (let [i, message] of messages.entries()) {</span>
<a href="#l27.99"></a><span id="l27.99" class="difflineminus">-  let index = i; // make a copy to avoid passing a reference to i</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineminus">-  this[&quot;test_&quot; + message.name] = function() {</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineminus">-    help_test_attachment_size(index);</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineminus">-  };</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineplus">+for (let i = 0; i &lt; messages.length; i++) {</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineplus">+  add_task(function() {</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineplus">+    help_test_attachment_size(i);</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineplus">+  });</span>
<a href="#l27.107"></a><span id="l27.107"> }</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineplus">+</span>
<a href="#l27.109"></a><span id="l27.109" class="difflineplus">+add_task(() =&gt; {</span>
<a href="#l27.110"></a><span id="l27.110" class="difflineplus">+  Assert.report(</span>
<a href="#l27.111"></a><span id="l27.111" class="difflineplus">+    false,</span>
<a href="#l27.112"></a><span id="l27.112" class="difflineplus">+    undefined,</span>
<a href="#l27.113"></a><span id="l27.113" class="difflineplus">+    undefined,</span>
<a href="#l27.114"></a><span id="l27.114" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l27.115"></a><span id="l27.115" class="difflineplus">+  );</span>
<a href="#l27.116"></a><span id="l27.116" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1">copy from mail/test/mozmill/attachment/attachment.txt</span>
<a href="#l28.2"></a><span id="l28.2">copy to mail/test/browser/attachment/data/attachment.txt</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1">copy from mail/test/mozmill/attachment/bug1358565.eml</span>
<a href="#l29.2"></a><span id="l29.2">copy to mail/test/browser/attachment/data/bug1358565.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1">new file mode 100644</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineminus">--- /dev/null</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineplus">+++ b/mail/test/browser/cloudfile/browser.ini</span>
<a href="#l30.4"></a><span id="l30.4" class="difflineat">@@ -0,0 +1,53 @@</span>
<a href="#l30.5"></a><span id="l30.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l30.6"></a><span id="l30.6" class="difflineplus">+head = head.js</span>
<a href="#l30.7"></a><span id="l30.7" class="difflineplus">+prefs =</span>
<a href="#l30.8"></a><span id="l30.8" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l30.9"></a><span id="l30.9" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l30.10"></a><span id="l30.10" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l30.11"></a><span id="l30.11" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+  mail.account.account1.server=server1</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+  mail.account.account2.identities=id1,id2</span>
<a href="#l30.14"></a><span id="l30.14" class="difflineplus">+  mail.account.account2.server=server2</span>
<a href="#l30.15"></a><span id="l30.15" class="difflineplus">+  mail.accountmanager.accounts=account1,account2</span>
<a href="#l30.16"></a><span id="l30.16" class="difflineplus">+  mail.accountmanager.defaultaccount=account2</span>
<a href="#l30.17"></a><span id="l30.17" class="difflineplus">+  mail.accountmanager.localfoldersserver=server1</span>
<a href="#l30.18"></a><span id="l30.18" class="difflineplus">+  mail.identity.id1.fullName=Tinderbox</span>
<a href="#l30.19"></a><span id="l30.19" class="difflineplus">+  mail.identity.id1.htmlSigFormat=false</span>
<a href="#l30.20"></a><span id="l30.20" class="difflineplus">+  mail.identity.id1.smtpServer=smtp1</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineplus">+  mail.identity.id1.useremail=tinderbox@foo.invalid</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineplus">+  mail.identity.id1.valid=true</span>
<a href="#l30.23"></a><span id="l30.23" class="difflineplus">+  mail.identity.id2.fullName=Tinderboxpushlog</span>
<a href="#l30.24"></a><span id="l30.24" class="difflineplus">+  mail.identity.id2.htmlSigFormat=true</span>
<a href="#l30.25"></a><span id="l30.25" class="difflineplus">+  mail.identity.id2.smtpServer=smtp1</span>
<a href="#l30.26"></a><span id="l30.26" class="difflineplus">+  mail.identity.id2.useremail=tinderboxpushlog@foo.invalid</span>
<a href="#l30.27"></a><span id="l30.27" class="difflineplus">+  mail.identity.id2.valid=true</span>
<a href="#l30.28"></a><span id="l30.28" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l30.29"></a><span id="l30.29" class="difflineplus">+  mail.server.server1.type=none</span>
<a href="#l30.30"></a><span id="l30.30" class="difflineplus">+  mail.server.server1.userName=nobody</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+  mail.server.server2.check_new_mail=false</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+  mail.server.server2.directory-rel=[ProfD]Mail/tinderbox</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+  mail.server.server2.download_on_biff=true</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+  mail.server.server2.hostname=tinderbox123</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+  mail.server.server2.login_at_startup=false</span>
<a href="#l30.36"></a><span id="l30.36" class="difflineplus">+  mail.server.server2.name=tinderbox@foo.invalid</span>
<a href="#l30.37"></a><span id="l30.37" class="difflineplus">+  mail.server.server2.type=pop3</span>
<a href="#l30.38"></a><span id="l30.38" class="difflineplus">+  mail.server.server2.userName=tinderbox</span>
<a href="#l30.39"></a><span id="l30.39" class="difflineplus">+  mail.server.server2.whiteListAbURI=</span>
<a href="#l30.40"></a><span id="l30.40" class="difflineplus">+  mail.shell.checkDefaultClient=false</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineplus">+  mail.smtp.defaultserver=smtp1</span>
<a href="#l30.42"></a><span id="l30.42" class="difflineplus">+  mail.smtpserver.smtp1.hostname=tinderbox123</span>
<a href="#l30.43"></a><span id="l30.43" class="difflineplus">+  mail.smtpserver.smtp1.username=tinderbox</span>
<a href="#l30.44"></a><span id="l30.44" class="difflineplus">+  mail.smtpservers=smtp1</span>
<a href="#l30.45"></a><span id="l30.45" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l30.46"></a><span id="l30.46" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l30.47"></a><span id="l30.47" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l30.48"></a><span id="l30.48" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l30.49"></a><span id="l30.49" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l30.50"></a><span id="l30.50" class="difflineplus">+support-files =</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+  data/**</span>
<a href="#l30.52"></a><span id="l30.52" class="difflineplus">+  html/**</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineplus">+</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineplus">+[browser_attachmentItem.js]</span>
<a href="#l30.55"></a><span id="l30.55" class="difflineplus">+[browser_attachmentUrls.js]</span>
<a href="#l30.56"></a><span id="l30.56" class="difflineplus">+[browser_manager.js]</span>
<a href="#l30.57"></a><span id="l30.57" class="difflineplus">+[browser_notifications.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1">copy from mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js</span>
<a href="#l31.2"></a><span id="l31.2">copy to mail/test/browser/cloudfile/browser_attachmentItem.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js</span>
<a href="#l31.4"></a><span id="l31.4" class="difflineplus">+++ b/mail/test/browser/cloudfile/browser_attachmentItem.js</span>
<a href="#l31.5"></a><span id="l31.5" class="difflineat">@@ -3,71 +3,75 @@</span>
<a href="#l31.6"></a><span id="l31.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l31.7"></a><span id="l31.7"> </span>
<a href="#l31.8"></a><span id="l31.8"> /**</span>
<a href="#l31.9"></a><span id="l31.9">  * Tests Filelink attachment item behaviour.</span>
<a href="#l31.10"></a><span id="l31.10">  */</span>
<a href="#l31.11"></a><span id="l31.11"> </span>
<a href="#l31.12"></a><span id="l31.12"> &quot;use strict&quot;;</span>
<a href="#l31.13"></a><span id="l31.13"> </span>
<a href="#l31.14"></a><span id="l31.14" class="difflineplus">+var mozmill = ChromeUtils.import(</span>
<a href="#l31.15"></a><span id="l31.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/mozmill.jsm&quot;</span>
<a href="#l31.16"></a><span id="l31.16" class="difflineplus">+);</span>
<a href="#l31.17"></a><span id="l31.17" class="difflineplus">+</span>
<a href="#l31.18"></a><span id="l31.18"> var {</span>
<a href="#l31.19"></a><span id="l31.19">   gMockFilePicker,</span>
<a href="#l31.20"></a><span id="l31.20">   gMockFilePickReg,</span>
<a href="#l31.21"></a><span id="l31.21">   select_attachments,</span>
<a href="#l31.22"></a><span id="l31.22"> } = ChromeUtils.import(</span>
<a href="#l31.23"></a><span id="l31.23">   &quot;resource://testing-common/mozmill/AttachmentHelpers.jsm&quot;</span>
<a href="#l31.24"></a><span id="l31.24"> );</span>
<a href="#l31.25"></a><span id="l31.25"> var {</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineminus">-  collectFiles,</span>
<a href="#l31.27"></a><span id="l31.27">   getFile,</span>
<a href="#l31.28"></a><span id="l31.28">   gMockCloudfileManager,</span>
<a href="#l31.29"></a><span id="l31.29">   MockCloudfileAccount,</span>
<a href="#l31.30"></a><span id="l31.30"> } = ChromeUtils.import(</span>
<a href="#l31.31"></a><span id="l31.31">   &quot;resource://testing-common/mozmill/CloudfileHelpers.jsm&quot;</span>
<a href="#l31.32"></a><span id="l31.32"> );</span>
<a href="#l31.33"></a><span id="l31.33"> var {</span>
<a href="#l31.34"></a><span id="l31.34">   add_cloud_attachments,</span>
<a href="#l31.35"></a><span id="l31.35">   close_compose_window,</span>
<a href="#l31.36"></a><span id="l31.36">   open_compose_new_mail,</span>
<a href="#l31.37"></a><span id="l31.37"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l31.38"></a><span id="l31.38" class="difflineminus">-var { assert_false, close_popup } = ChromeUtils.import(</span>
<a href="#l31.39"></a><span id="l31.39" class="difflineplus">+var { close_popup } = ChromeUtils.import(</span>
<a href="#l31.40"></a><span id="l31.40">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l31.41"></a><span id="l31.41"> );</span>
<a href="#l31.42"></a><span id="l31.42"> </span>
<a href="#l31.43"></a><span id="l31.43" class="difflineminus">-var kAttachmentItemContextID = &quot;msgComposeAttachmentItemContext&quot;;</span>
<a href="#l31.44"></a><span id="l31.44" class="difflineminus">-</span>
<a href="#l31.45"></a><span id="l31.45"> var { cloudFileAccounts } = ChromeUtils.import(</span>
<a href="#l31.46"></a><span id="l31.46">   &quot;resource:///modules/cloudFileAccounts.jsm&quot;</span>
<a href="#l31.47"></a><span id="l31.47"> );</span>
<a href="#l31.48"></a><span id="l31.48"> </span>
<a href="#l31.49"></a><span id="l31.49" class="difflineminus">-function setupModule(module) {</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineplus">+var controller = mozmill.getMail3PaneController();</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+var kAttachmentItemContextID = &quot;msgComposeAttachmentItemContext&quot;;</span>
<a href="#l31.52"></a><span id="l31.52" class="difflineplus">+</span>
<a href="#l31.53"></a><span id="l31.53" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l31.54"></a><span id="l31.54">   gMockFilePickReg.register();</span>
<a href="#l31.55"></a><span id="l31.55">   gMockCloudfileManager.register();</span>
<a href="#l31.56"></a><span id="l31.56" class="difflineminus">-}</span>
<a href="#l31.57"></a><span id="l31.57" class="difflineplus">+});</span>
<a href="#l31.58"></a><span id="l31.58"> </span>
<a href="#l31.59"></a><span id="l31.59" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l31.61"></a><span id="l31.61">   gMockCloudfileManager.unregister();</span>
<a href="#l31.62"></a><span id="l31.62">   gMockFilePickReg.unregister();</span>
<a href="#l31.63"></a><span id="l31.63" class="difflineminus">-}</span>
<a href="#l31.64"></a><span id="l31.64" class="difflineplus">+});</span>
<a href="#l31.65"></a><span id="l31.65"> </span>
<a href="#l31.66"></a><span id="l31.66"> /**</span>
<a href="#l31.67"></a><span id="l31.67">  * Test that when an upload has been started, we can cancel and restart</span>
<a href="#l31.68"></a><span id="l31.68">  * the upload, and then cancel again.  For this test, we repeat this</span>
<a href="#l31.69"></a><span id="l31.69">  * 3 times.</span>
<a href="#l31.70"></a><span id="l31.70">  */</span>
<a href="#l31.71"></a><span id="l31.71" class="difflineminus">-function test_upload_cancel_repeat() {</span>
<a href="#l31.72"></a><span id="l31.72" class="difflineplus">+add_task(function test_upload_cancel_repeat() {</span>
<a href="#l31.73"></a><span id="l31.73">   const kFile = &quot;./data/testFile1&quot;;</span>
<a href="#l31.74"></a><span id="l31.74"> </span>
<a href="#l31.75"></a><span id="l31.75">   // Prepare the mock file picker to return our test file.</span>
<a href="#l31.76"></a><span id="l31.76" class="difflineminus">-  let file = getFile(kFile, __file__);</span>
<a href="#l31.77"></a><span id="l31.77" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(kFile));</span>
<a href="#l31.78"></a><span id="l31.78">   gMockFilePicker.returnFiles = [file];</span>
<a href="#l31.79"></a><span id="l31.79"> </span>
<a href="#l31.80"></a><span id="l31.80">   let provider = new MockCloudfileAccount();</span>
<a href="#l31.81"></a><span id="l31.81">   provider.init(&quot;someKey&quot;);</span>
<a href="#l31.82"></a><span id="l31.82" class="difflineminus">-  let cw = open_compose_new_mail();</span>
<a href="#l31.83"></a><span id="l31.83" class="difflineplus">+  let cw = open_compose_new_mail(controller);</span>
<a href="#l31.84"></a><span id="l31.84"> </span>
<a href="#l31.85"></a><span id="l31.85">   // We've got a compose window open, and our mock Filelink provider</span>
<a href="#l31.86"></a><span id="l31.86">   // ready.  Let's attach a file...</span>
<a href="#l31.87"></a><span id="l31.87">   cw.window.AttachFile();</span>
<a href="#l31.88"></a><span id="l31.88"> </span>
<a href="#l31.89"></a><span id="l31.89">   // Now we override the uploadFile function of the MockCloudfileAccount</span>
<a href="#l31.90"></a><span id="l31.90">   // so that we're perpetually uploading...</span>
<a href="#l31.91"></a><span id="l31.91">   let promise;</span>
<a href="#l31.92"></a><span id="l31.92" class="difflineat">@@ -85,29 +89,30 @@ function test_upload_cancel_repeat() {</span>
<a href="#l31.93"></a><span id="l31.93">     started = false;</span>
<a href="#l31.94"></a><span id="l31.94"> </span>
<a href="#l31.95"></a><span id="l31.95">     // Select the attachment, and choose to convert it to a Filelink</span>
<a href="#l31.96"></a><span id="l31.96">     select_attachments(cw, 0)[0];</span>
<a href="#l31.97"></a><span id="l31.97">     cw.window.convertSelectedToCloudAttachment(provider);</span>
<a href="#l31.98"></a><span id="l31.98">     cw.waitFor(() =&gt; started);</span>
<a href="#l31.99"></a><span id="l31.99"> </span>
<a href="#l31.100"></a><span id="l31.100">     assert_can_cancel_upload(cw, provider, promise, file);</span>
<a href="#l31.101"></a><span id="l31.101" class="difflineplus">+    cw.sleep();</span>
<a href="#l31.102"></a><span id="l31.102">   }</span>
<a href="#l31.103"></a><span id="l31.103"> </span>
<a href="#l31.104"></a><span id="l31.104">   close_compose_window(cw);</span>
<a href="#l31.105"></a><span id="l31.105" class="difflineminus">-}</span>
<a href="#l31.106"></a><span id="l31.106" class="difflineplus">+});</span>
<a href="#l31.107"></a><span id="l31.107"> </span>
<a href="#l31.108"></a><span id="l31.108"> /**</span>
<a href="#l31.109"></a><span id="l31.109">  * Test that we can cancel a whole series of files being uploaded at once.</span>
<a href="#l31.110"></a><span id="l31.110">  */</span>
<a href="#l31.111"></a><span id="l31.111" class="difflineminus">-function test_upload_multiple_and_cancel() {</span>
<a href="#l31.112"></a><span id="l31.112" class="difflineplus">+add_task(function test_upload_multiple_and_cancel() {</span>
<a href="#l31.113"></a><span id="l31.113">   const kFiles = [&quot;./data/testFile1&quot;, &quot;./data/testFile2&quot;, &quot;./data/testFile3&quot;];</span>
<a href="#l31.114"></a><span id="l31.114"> </span>
<a href="#l31.115"></a><span id="l31.115">   // Prepare the mock file picker to return our test file.</span>
<a href="#l31.116"></a><span id="l31.116" class="difflineminus">-  let files = collectFiles(kFiles, __file__);</span>
<a href="#l31.117"></a><span id="l31.117" class="difflineplus">+  let files = collectFiles(kFiles);</span>
<a href="#l31.118"></a><span id="l31.118">   gMockFilePicker.returnFiles = files;</span>
<a href="#l31.119"></a><span id="l31.119"> </span>
<a href="#l31.120"></a><span id="l31.120">   let provider = new MockCloudfileAccount();</span>
<a href="#l31.121"></a><span id="l31.121">   provider.init(&quot;someKey&quot;);</span>
<a href="#l31.122"></a><span id="l31.122">   let cw = open_compose_new_mail();</span>
<a href="#l31.123"></a><span id="l31.123"> </span>
<a href="#l31.124"></a><span id="l31.124">   let promise;</span>
<a href="#l31.125"></a><span id="l31.125">   provider.uploadFile = function(aFile) {</span>
<a href="#l31.126"></a><span id="l31.126" class="difflineat">@@ -118,17 +123,17 @@ function test_upload_multiple_and_cancel</span>
<a href="#l31.127"></a><span id="l31.127"> </span>
<a href="#l31.128"></a><span id="l31.128">   add_cloud_attachments(cw, provider, false);</span>
<a href="#l31.129"></a><span id="l31.129"> </span>
<a href="#l31.130"></a><span id="l31.130">   for (let i = files.length - 1; i &gt;= 0; --i) {</span>
<a href="#l31.131"></a><span id="l31.131">     assert_can_cancel_upload(cw, provider, promise, files[i]);</span>
<a href="#l31.132"></a><span id="l31.132">   }</span>
<a href="#l31.133"></a><span id="l31.133"> </span>
<a href="#l31.134"></a><span id="l31.134">   close_compose_window(cw);</span>
<a href="#l31.135"></a><span id="l31.135" class="difflineminus">-}</span>
<a href="#l31.136"></a><span id="l31.136" class="difflineplus">+});</span>
<a href="#l31.137"></a><span id="l31.137"> </span>
<a href="#l31.138"></a><span id="l31.138"> /**</span>
<a href="#l31.139"></a><span id="l31.139">  * Helper function that takes an upload in progress, and cancels it,</span>
<a href="#l31.140"></a><span id="l31.140">  * ensuring that the nsIMsgCloduFileProvider.uploadCanceled status message</span>
<a href="#l31.141"></a><span id="l31.141">  * is returned to the passed in listener.</span>
<a href="#l31.142"></a><span id="l31.142">  *</span>
<a href="#l31.143"></a><span id="l31.143">  * @param aController the compose window controller to use.</span>
<a href="#l31.144"></a><span id="l31.144">  * @param aProvider a MockCloudfileAccount for which the uploads have already</span>
<a href="#l31.145"></a><span id="l31.145" class="difflineat">@@ -159,18 +164,18 @@ function assert_can_cancel_upload(</span>
<a href="#l31.146"></a><span id="l31.146"> </span>
<a href="#l31.147"></a><span id="l31.147">   // Select that attachmentitem in the bucket</span>
<a href="#l31.148"></a><span id="l31.148">   select_attachments(aController, index)[0];</span>
<a href="#l31.149"></a><span id="l31.149"> </span>
<a href="#l31.150"></a><span id="l31.150">   // Bring up the context menu, and click cancel.</span>
<a href="#l31.151"></a><span id="l31.151">   let cmd = aController.e(&quot;cmd_cancelUpload&quot;);</span>
<a href="#l31.152"></a><span id="l31.152">   aController.window.updateAttachmentItems();</span>
<a href="#l31.153"></a><span id="l31.153"> </span>
<a href="#l31.154"></a><span id="l31.154" class="difflineminus">-  assert_false(cmd.hidden);</span>
<a href="#l31.155"></a><span id="l31.155" class="difflineminus">-  assert_false(cmd.disabled);</span>
<a href="#l31.156"></a><span id="l31.156" class="difflineplus">+  Assert.ok(!cmd.hidden);</span>
<a href="#l31.157"></a><span id="l31.157" class="difflineplus">+  Assert.ok(!cmd.disabled);</span>
<a href="#l31.158"></a><span id="l31.158">   let cancelItem = aController.eid(&quot;composeAttachmentContext_cancelUploadItem&quot;);</span>
<a href="#l31.159"></a><span id="l31.159">   aController.click(cancelItem);</span>
<a href="#l31.160"></a><span id="l31.160"> </span>
<a href="#l31.161"></a><span id="l31.161">   // Close the popup, and wait for the cancellation to be complete.</span>
<a href="#l31.162"></a><span id="l31.162">   close_popup(aController, aController.eid(kAttachmentItemContextID));</span>
<a href="#l31.163"></a><span id="l31.163">   aController.waitFor(() =&gt; cancelled);</span>
<a href="#l31.164"></a><span id="l31.164"> }</span>
<a href="#l31.165"></a><span id="l31.165"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1">copy from mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js</span>
<a href="#l32.2"></a><span id="l32.2">copy to mail/test/browser/cloudfile/browser_attachmentUrls.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js</span>
<a href="#l32.4"></a><span id="l32.4" class="difflineplus">+++ b/mail/test/browser/cloudfile/browser_attachmentUrls.js</span>
<a href="#l32.5"></a><span id="l32.5" class="difflineat">@@ -10,21 +10,17 @@</span>
<a href="#l32.6"></a><span id="l32.6"> </span>
<a href="#l32.7"></a><span id="l32.7"> var {</span>
<a href="#l32.8"></a><span id="l32.8">   gMockFilePicker,</span>
<a href="#l32.9"></a><span id="l32.9">   gMockFilePickReg,</span>
<a href="#l32.10"></a><span id="l32.10">   select_attachments,</span>
<a href="#l32.11"></a><span id="l32.11"> } = ChromeUtils.import(</span>
<a href="#l32.12"></a><span id="l32.12">   &quot;resource://testing-common/mozmill/AttachmentHelpers.jsm&quot;</span>
<a href="#l32.13"></a><span id="l32.13"> );</span>
<a href="#l32.14"></a><span id="l32.14" class="difflineminus">-var {</span>
<a href="#l32.15"></a><span id="l32.15" class="difflineminus">-  collectFiles,</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineminus">-  gMockCloudfileManager,</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineminus">-  MockCloudfileAccount,</span>
<a href="#l32.18"></a><span id="l32.18" class="difflineminus">-} = ChromeUtils.import(</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineplus">+var { gMockCloudfileManager, MockCloudfileAccount } = ChromeUtils.import(</span>
<a href="#l32.20"></a><span id="l32.20">   &quot;resource://testing-common/mozmill/CloudfileHelpers.jsm&quot;</span>
<a href="#l32.21"></a><span id="l32.21"> );</span>
<a href="#l32.22"></a><span id="l32.22"> var {</span>
<a href="#l32.23"></a><span id="l32.23">   add_cloud_attachments,</span>
<a href="#l32.24"></a><span id="l32.24">   assert_previous_text,</span>
<a href="#l32.25"></a><span id="l32.25">   get_compose_body,</span>
<a href="#l32.26"></a><span id="l32.26">   open_compose_new_mail,</span>
<a href="#l32.27"></a><span id="l32.27">   open_compose_with_forward,</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineat">@@ -33,88 +29,95 @@ var {</span>
<a href="#l32.29"></a><span id="l32.29"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l32.30"></a><span id="l32.30"> var {</span>
<a href="#l32.31"></a><span id="l32.31">   assert_next_nodes,</span>
<a href="#l32.32"></a><span id="l32.32">   assert_previous_nodes,</span>
<a href="#l32.33"></a><span id="l32.33">   wait_for_element,</span>
<a href="#l32.34"></a><span id="l32.34"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/DOMHelpers.jsm&quot;);</span>
<a href="#l32.35"></a><span id="l32.35"> var {</span>
<a href="#l32.36"></a><span id="l32.36">   add_message_to_folder,</span>
<a href="#l32.37"></a><span id="l32.37" class="difflineminus">-  assert_equals,</span>
<a href="#l32.38"></a><span id="l32.38" class="difflineminus">-  assert_not_equals,</span>
<a href="#l32.39"></a><span id="l32.39">   assert_selected_and_displayed,</span>
<a href="#l32.40"></a><span id="l32.40" class="difflineminus">-  assert_true,</span>
<a href="#l32.41"></a><span id="l32.41">   be_in_folder,</span>
<a href="#l32.42"></a><span id="l32.42">   create_message,</span>
<a href="#l32.43"></a><span id="l32.43">   FAKE_SERVER_HOSTNAME,</span>
<a href="#l32.44"></a><span id="l32.44">   get_special_folder,</span>
<a href="#l32.45"></a><span id="l32.45">   mc,</span>
<a href="#l32.46"></a><span id="l32.46">   select_click_row,</span>
<a href="#l32.47"></a><span id="l32.47"> } = ChromeUtils.import(</span>
<a href="#l32.48"></a><span id="l32.48">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l32.49"></a><span id="l32.49"> );</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+var mozmill = ChromeUtils.import(</span>
<a href="#l32.51"></a><span id="l32.51" class="difflineplus">+  &quot;resource://testing-common/mozmill/mozmill.jsm&quot;</span>
<a href="#l32.52"></a><span id="l32.52" class="difflineplus">+);</span>
<a href="#l32.53"></a><span id="l32.53"> var { close_window } = ChromeUtils.import(</span>
<a href="#l32.54"></a><span id="l32.54">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l32.55"></a><span id="l32.55"> );</span>
<a href="#l32.56"></a><span id="l32.56"> </span>
<a href="#l32.57"></a><span id="l32.57"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l32.58"></a><span id="l32.58"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l32.59"></a><span id="l32.59">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l32.60"></a><span id="l32.60"> );</span>
<a href="#l32.61"></a><span id="l32.61"> </span>
<a href="#l32.62"></a><span id="l32.62" class="difflineplus">+var controller = mozmill.getMail3PaneController();</span>
<a href="#l32.63"></a><span id="l32.63"> var kUploadedFile = &quot;attachment-uploaded&quot;;</span>
<a href="#l32.64"></a><span id="l32.64"> var kHtmlPrefKey = &quot;mail.identity.default.compose_html&quot;;</span>
<a href="#l32.65"></a><span id="l32.65"> var kReplyOnTopKey = &quot;mail.identity.default.reply_on_top&quot;;</span>
<a href="#l32.66"></a><span id="l32.66"> var kReplyOnTop = 1;</span>
<a href="#l32.67"></a><span id="l32.67"> var kReplyOnBottom = 0;</span>
<a href="#l32.68"></a><span id="l32.68"> var kTextNodeType = 3;</span>
<a href="#l32.69"></a><span id="l32.69"> var kSigPrefKey = &quot;mail.identity.id1.htmlSigText&quot;;</span>
<a href="#l32.70"></a><span id="l32.70"> var kSigOnReplyKey = &quot;mail.identity.default.sig_on_reply&quot;;</span>
<a href="#l32.71"></a><span id="l32.71"> var kSigOnForwardKey = &quot;mail.identity.default.sig_on_fwd&quot;;</span>
<a href="#l32.72"></a><span id="l32.72"> var kDefaultSigKey = &quot;mail.identity.id1.htmlSigText&quot;;</span>
<a href="#l32.73"></a><span id="l32.73"> var kDefaultSig = &quot;This is my signature.\n\nCheck out my website sometime!&quot;;</span>
<a href="#l32.74"></a><span id="l32.74"> var kFiles = [&quot;./data/testFile1&quot;, &quot;./data/testFile2&quot;];</span>
<a href="#l32.75"></a><span id="l32.75"> var kLines = [&quot;This is a line of text&quot;, &quot;and here's another!&quot;];</span>
<a href="#l32.76"></a><span id="l32.76"> </span>
<a href="#l32.77"></a><span id="l32.77" class="difflineminus">-var gInbox, gOldHtmlPref, gOldSigPref;</span>
<a href="#l32.78"></a><span id="l32.78" class="difflineplus">+var gInbox;</span>
<a href="#l32.79"></a><span id="l32.79" class="difflineplus">+</span>
<a href="#l32.80"></a><span id="l32.80" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l32.81"></a><span id="l32.81" class="difflineplus">+  requestLongerTimeout(2);</span>
<a href="#l32.82"></a><span id="l32.82"> </span>
<a href="#l32.83"></a><span id="l32.83" class="difflineminus">-function setupModule(module) {</span>
<a href="#l32.84"></a><span id="l32.84" class="difflineplus">+  // These prefs can't be set in the manifest as they contain white-space.</span>
<a href="#l32.85"></a><span id="l32.85" class="difflineplus">+  Services.prefs.setStringPref(</span>
<a href="#l32.86"></a><span id="l32.86" class="difflineplus">+    &quot;mail.identity.id1.htmlSigText&quot;,</span>
<a href="#l32.87"></a><span id="l32.87" class="difflineplus">+    &quot;Tinderbox is soo 90ies&quot;</span>
<a href="#l32.88"></a><span id="l32.88" class="difflineplus">+  );</span>
<a href="#l32.89"></a><span id="l32.89" class="difflineplus">+  Services.prefs.setStringPref(</span>
<a href="#l32.90"></a><span id="l32.90" class="difflineplus">+    &quot;mail.identity.id2.htmlSigText&quot;,</span>
<a href="#l32.91"></a><span id="l32.91" class="difflineplus">+    &quot;Tinderboxpushlog is the new &lt;b&gt;hotness!&lt;/b&gt;&quot;</span>
<a href="#l32.92"></a><span id="l32.92" class="difflineplus">+  );</span>
<a href="#l32.93"></a><span id="l32.93" class="difflineplus">+</span>
<a href="#l32.94"></a><span id="l32.94">   // For replies and forwards, we'll work off a message in the Inbox folder</span>
<a href="#l32.95"></a><span id="l32.95">   // of the fake &quot;tinderbox&quot; account.</span>
<a href="#l32.96"></a><span id="l32.96">   let server = MailServices.accounts.FindServer(</span>
<a href="#l32.97"></a><span id="l32.97">     &quot;tinderbox&quot;,</span>
<a href="#l32.98"></a><span id="l32.98">     FAKE_SERVER_HOSTNAME,</span>
<a href="#l32.99"></a><span id="l32.99">     &quot;pop3&quot;</span>
<a href="#l32.100"></a><span id="l32.100">   );</span>
<a href="#l32.101"></a><span id="l32.101">   gInbox = get_special_folder(Ci.nsMsgFolderFlags.Inbox, false, server);</span>
<a href="#l32.102"></a><span id="l32.102">   add_message_to_folder(gInbox, create_message());</span>
<a href="#l32.103"></a><span id="l32.103"> </span>
<a href="#l32.104"></a><span id="l32.104">   gMockFilePickReg.register();</span>
<a href="#l32.105"></a><span id="l32.105">   gMockCloudfileManager.register();</span>
<a href="#l32.106"></a><span id="l32.106"> </span>
<a href="#l32.107"></a><span id="l32.107" class="difflineminus">-  // These tests assume that we default to writing mail in HTML.  We'll</span>
<a href="#l32.108"></a><span id="l32.108" class="difflineminus">-  // save the current preference, force defaulting to HTML, and restore the</span>
<a href="#l32.109"></a><span id="l32.109" class="difflineminus">-  // pref in teardownModule.</span>
<a href="#l32.110"></a><span id="l32.110" class="difflineminus">-  gOldHtmlPref = Services.prefs.getBoolPref(kHtmlPrefKey);</span>
<a href="#l32.111"></a><span id="l32.111">   Services.prefs.setBoolPref(kHtmlPrefKey, true);</span>
<a href="#l32.112"></a><span id="l32.112" class="difflineminus">-  // Same goes for the default signature.</span>
<a href="#l32.113"></a><span id="l32.113" class="difflineminus">-  gOldSigPref = Services.prefs.getCharPref(kDefaultSigKey);</span>
<a href="#l32.114"></a><span id="l32.114"> </span>
<a href="#l32.115"></a><span id="l32.115">   // Don't create paragraphs in the test.</span>
<a href="#l32.116"></a><span id="l32.116">   // The test fails if it encounters paragraphs &lt;p&gt; instead of breaks &lt;br&gt;.</span>
<a href="#l32.117"></a><span id="l32.117">   Services.prefs.setBoolPref(&quot;mail.compose.default_to_paragraph&quot;, false);</span>
<a href="#l32.118"></a><span id="l32.118" class="difflineminus">-}</span>
<a href="#l32.119"></a><span id="l32.119" class="difflineplus">+});</span>
<a href="#l32.120"></a><span id="l32.120"> </span>
<a href="#l32.121"></a><span id="l32.121" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l32.122"></a><span id="l32.122" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l32.123"></a><span id="l32.123">   gMockCloudfileManager.unregister();</span>
<a href="#l32.124"></a><span id="l32.124">   gMockFilePickReg.unregister();</span>
<a href="#l32.125"></a><span id="l32.125" class="difflineminus">-  Services.prefs.setCharPref(kDefaultSigKey, gOldSigPref);</span>
<a href="#l32.126"></a><span id="l32.126" class="difflineminus">-  Services.prefs.setBoolPref(kHtmlPrefKey, gOldHtmlPref);</span>
<a href="#l32.127"></a><span id="l32.127" class="difflineplus">+  Services.prefs.clearUserPref(kDefaultSigKey);</span>
<a href="#l32.128"></a><span id="l32.128" class="difflineplus">+  Services.prefs.clearUserPref(kHtmlPrefKey);</span>
<a href="#l32.129"></a><span id="l32.129">   Services.prefs.clearUserPref(&quot;mail.compose.default_to_paragraph&quot;);</span>
<a href="#l32.130"></a><span id="l32.130" class="difflineminus">-}</span>
<a href="#l32.131"></a><span id="l32.131" class="difflineplus">+});</span>
<a href="#l32.132"></a><span id="l32.132"> </span>
<a href="#l32.133"></a><span id="l32.133"> function setupTest() {</span>
<a href="#l32.134"></a><span id="l32.134">   // If our signature got accidentally wiped out, let's just put it back.</span>
<a href="#l32.135"></a><span id="l32.135">   Services.prefs.setCharPref(kDefaultSigKey, kDefaultSig);</span>
<a href="#l32.136"></a><span id="l32.136"> }</span>
<a href="#l32.137"></a><span id="l32.137"> </span>
<a href="#l32.138"></a><span id="l32.138"> /**</span>
<a href="#l32.139"></a><span id="l32.139">  * Given some compose window controller, wait for some Filelink URLs to be</span>
<a href="#l32.140"></a><span id="l32.140" class="difflineat">@@ -159,17 +162,17 @@ function wait_for_attachment_urls(aContr</span>
<a href="#l32.141"></a><span id="l32.141">  * @param aText an array of strings to type into the compose window. Each</span>
<a href="#l32.142"></a><span id="l32.142">  *              string is followed by pressing the RETURN key, except for</span>
<a href="#l32.143"></a><span id="l32.143">  *              the final string.  Pass an empty array if you don't want</span>
<a href="#l32.144"></a><span id="l32.144">  *              anything typed.</span>
<a href="#l32.145"></a><span id="l32.145">  * @param aFiles an array of filename strings for files located beneath</span>
<a href="#l32.146"></a><span id="l32.146">  *               the test directory.</span>
<a href="#l32.147"></a><span id="l32.147">  */</span>
<a href="#l32.148"></a><span id="l32.148"> function prepare_some_attachments_and_reply(aText, aFiles) {</span>
<a href="#l32.149"></a><span id="l32.149" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(aFiles, __file__);</span>
<a href="#l32.150"></a><span id="l32.150" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles(aFiles);</span>
<a href="#l32.151"></a><span id="l32.151"> </span>
<a href="#l32.152"></a><span id="l32.152">   let provider = new MockCloudfileAccount();</span>
<a href="#l32.153"></a><span id="l32.153">   provider.init(&quot;someKey&quot;);</span>
<a href="#l32.154"></a><span id="l32.154"> </span>
<a href="#l32.155"></a><span id="l32.155">   be_in_folder(gInbox);</span>
<a href="#l32.156"></a><span id="l32.156">   let msg = select_click_row(0);</span>
<a href="#l32.157"></a><span id="l32.157">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l32.158"></a><span id="l32.158"> </span>
<a href="#l32.159"></a><span id="l32.159" class="difflineat">@@ -190,17 +193,17 @@ function prepare_some_attachments_and_re</span>
<a href="#l32.160"></a><span id="l32.160">  * @param aText an array of strings to type into the compose window. Each</span>
<a href="#l32.161"></a><span id="l32.161">  *              string is followed by pressing the RETURN key, except for</span>
<a href="#l32.162"></a><span id="l32.162">  *              the final string.  Pass an empty array if you don't want</span>
<a href="#l32.163"></a><span id="l32.163">  *              anything typed.</span>
<a href="#l32.164"></a><span id="l32.164">  * @param aFiles an array of filename strings for files located beneath</span>
<a href="#l32.165"></a><span id="l32.165">  *               the test directory.</span>
<a href="#l32.166"></a><span id="l32.166">  */</span>
<a href="#l32.167"></a><span id="l32.167"> function prepare_some_attachments_and_forward(aText, aFiles) {</span>
<a href="#l32.168"></a><span id="l32.168" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(aFiles, __file__);</span>
<a href="#l32.169"></a><span id="l32.169" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles(aFiles);</span>
<a href="#l32.170"></a><span id="l32.170"> </span>
<a href="#l32.171"></a><span id="l32.171">   let provider = new MockCloudfileAccount();</span>
<a href="#l32.172"></a><span id="l32.172">   provider.init(&quot;someKey&quot;);</span>
<a href="#l32.173"></a><span id="l32.173"> </span>
<a href="#l32.174"></a><span id="l32.174">   be_in_folder(gInbox);</span>
<a href="#l32.175"></a><span id="l32.175">   let msg = select_click_row(0);</span>
<a href="#l32.176"></a><span id="l32.176">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l32.177"></a><span id="l32.177"> </span>
<a href="#l32.178"></a><span id="l32.178" class="difflineat">@@ -268,139 +271,139 @@ function try_with_plaintext_and_html_mai</span>
<a href="#l32.179"></a><span id="l32.179"> }</span>
<a href="#l32.180"></a><span id="l32.180"> </span>
<a href="#l32.181"></a><span id="l32.181"> /**</span>
<a href="#l32.182"></a><span id="l32.182">  * Test that if we open up a composer and immediately attach a Filelink,</span>
<a href="#l32.183"></a><span id="l32.183">  * a linebreak is inserted before the containment node in order to allow</span>
<a href="#l32.184"></a><span id="l32.184">  * the user to write before the attachment URLs.  This assumes the user</span>
<a href="#l32.185"></a><span id="l32.185">  * does not have a signature already inserted into the message body.</span>
<a href="#l32.186"></a><span id="l32.186">  */</span>
<a href="#l32.187"></a><span id="l32.187" class="difflineminus">-function test_inserts_linebreak_on_empty_compose() {</span>
<a href="#l32.188"></a><span id="l32.188" class="difflineplus">+add_task(function test_inserts_linebreak_on_empty_compose() {</span>
<a href="#l32.189"></a><span id="l32.189">   try_without_signature(subtest_inserts_linebreak_on_empty_compose);</span>
<a href="#l32.190"></a><span id="l32.190" class="difflineminus">-}</span>
<a href="#l32.191"></a><span id="l32.191" class="difflineplus">+});</span>
<a href="#l32.192"></a><span id="l32.192"> </span>
<a href="#l32.193"></a><span id="l32.193"> /**</span>
<a href="#l32.194"></a><span id="l32.194">  * Subtest for test_inserts_linebreak_on_empty_compose - can be executed</span>
<a href="#l32.195"></a><span id="l32.195">  * on both plaintext and HTML compose windows.</span>
<a href="#l32.196"></a><span id="l32.196">  */</span>
<a href="#l32.197"></a><span id="l32.197"> function subtest_inserts_linebreak_on_empty_compose() {</span>
<a href="#l32.198"></a><span id="l32.198" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(kFiles, __file__);</span>
<a href="#l32.199"></a><span id="l32.199" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles(kFiles);</span>
<a href="#l32.200"></a><span id="l32.200">   let provider = new MockCloudfileAccount();</span>
<a href="#l32.201"></a><span id="l32.201">   provider.init(&quot;someKey&quot;);</span>
<a href="#l32.202"></a><span id="l32.202">   let cw = open_compose_new_mail();</span>
<a href="#l32.203"></a><span id="l32.203">   add_cloud_attachments(cw, provider);</span>
<a href="#l32.204"></a><span id="l32.204"> </span>
<a href="#l32.205"></a><span id="l32.205">   let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l32.206"></a><span id="l32.206"> </span>
<a href="#l32.207"></a><span id="l32.207">   let br = root.previousSibling;</span>
<a href="#l32.208"></a><span id="l32.208" class="difflineminus">-  assert_equals(</span>
<a href="#l32.209"></a><span id="l32.209" class="difflineplus">+  Assert.equal(</span>
<a href="#l32.210"></a><span id="l32.210">     br.localName,</span>
<a href="#l32.211"></a><span id="l32.211">     &quot;br&quot;,</span>
<a href="#l32.212"></a><span id="l32.212">     &quot;The attachment URL containment node should be preceded by a linebreak&quot;</span>
<a href="#l32.213"></a><span id="l32.213">   );</span>
<a href="#l32.214"></a><span id="l32.214"> </span>
<a href="#l32.215"></a><span id="l32.215">   let mailBody = get_compose_body(cw);</span>
<a href="#l32.216"></a><span id="l32.216"> </span>
<a href="#l32.217"></a><span id="l32.217" class="difflineminus">-  assert_equals(</span>
<a href="#l32.218"></a><span id="l32.218" class="difflineplus">+  Assert.equal(</span>
<a href="#l32.219"></a><span id="l32.219">     mailBody.firstChild,</span>
<a href="#l32.220"></a><span id="l32.220">     br,</span>
<a href="#l32.221"></a><span id="l32.221">     &quot;The linebreak should be the first child of the compose body&quot;</span>
<a href="#l32.222"></a><span id="l32.222">   );</span>
<a href="#l32.223"></a><span id="l32.223"> </span>
<a href="#l32.224"></a><span id="l32.224">   close_window(cw);</span>
<a href="#l32.225"></a><span id="l32.225"> }</span>
<a href="#l32.226"></a><span id="l32.226"> </span>
<a href="#l32.227"></a><span id="l32.227"> /**</span>
<a href="#l32.228"></a><span id="l32.228">  * Test that if we open up a composer and immediately attach a Filelink,</span>
<a href="#l32.229"></a><span id="l32.229">  * a linebreak is inserted before the containment node. This test also</span>
<a href="#l32.230"></a><span id="l32.230">  * ensures that, with a signature already in the compose window, we don't</span>
<a href="#l32.231"></a><span id="l32.231">  * accidentally insert the attachment URL containment within the signature</span>
<a href="#l32.232"></a><span id="l32.232">  * node.</span>
<a href="#l32.233"></a><span id="l32.233">  */</span>
<a href="#l32.234"></a><span id="l32.234" class="difflineminus">-function test_inserts_linebreak_on_empty_compose_with_signature() {</span>
<a href="#l32.235"></a><span id="l32.235" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(kFiles, __file__);</span>
<a href="#l32.236"></a><span id="l32.236" class="difflineplus">+add_task(function test_inserts_linebreak_on_empty_compose_with_signature() {</span>
<a href="#l32.237"></a><span id="l32.237" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles(kFiles);</span>
<a href="#l32.238"></a><span id="l32.238">   let provider = new MockCloudfileAccount();</span>
<a href="#l32.239"></a><span id="l32.239">   provider.init(&quot;someKey&quot;);</span>
<a href="#l32.240"></a><span id="l32.240">   let cw = open_compose_new_mail();</span>
<a href="#l32.241"></a><span id="l32.241">   add_cloud_attachments(cw, provider);</span>
<a href="#l32.242"></a><span id="l32.242">   // wait_for_attachment_urls ensures that the attachment URL containment</span>
<a href="#l32.243"></a><span id="l32.243">   // node is an immediate child of the body of the message, so if this</span>
<a href="#l32.244"></a><span id="l32.244">   // succeeds, then we were not in the signature node.</span>
<a href="#l32.245"></a><span id="l32.245">   let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l32.246"></a><span id="l32.246"> </span>
<a href="#l32.247"></a><span id="l32.247">   let br = assert_previous_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l32.248"></a><span id="l32.248"> </span>
<a href="#l32.249"></a><span id="l32.249">   let mailBody = get_compose_body(cw);</span>
<a href="#l32.250"></a><span id="l32.250" class="difflineminus">-  assert_equals(</span>
<a href="#l32.251"></a><span id="l32.251" class="difflineplus">+  Assert.equal(</span>
<a href="#l32.252"></a><span id="l32.252">     mailBody.firstChild,</span>
<a href="#l32.253"></a><span id="l32.253">     br,</span>
<a href="#l32.254"></a><span id="l32.254">     &quot;The linebreak should be the first child of the compose body&quot;</span>
<a href="#l32.255"></a><span id="l32.255">   );</span>
<a href="#l32.256"></a><span id="l32.256"> </span>
<a href="#l32.257"></a><span id="l32.257">   // Now ensure that the node after the attachments is a br, and following</span>
<a href="#l32.258"></a><span id="l32.258">   // that is the signature.</span>
<a href="#l32.259"></a><span id="l32.259">   br = assert_next_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l32.260"></a><span id="l32.260"> </span>
<a href="#l32.261"></a><span id="l32.261">   let pre = br.nextSibling;</span>
<a href="#l32.262"></a><span id="l32.262" class="difflineminus">-  assert_equals(</span>
<a href="#l32.263"></a><span id="l32.263" class="difflineplus">+  Assert.equal(</span>
<a href="#l32.264"></a><span id="l32.264">     pre.localName,</span>
<a href="#l32.265"></a><span id="l32.265">     &quot;pre&quot;,</span>
<a href="#l32.266"></a><span id="l32.266">     &quot;The linebreak should be followed by the signature pre&quot;</span>
<a href="#l32.267"></a><span id="l32.267">   );</span>
<a href="#l32.268"></a><span id="l32.268" class="difflineminus">-  assert_true(</span>
<a href="#l32.269"></a><span id="l32.269" class="difflineplus">+  Assert.ok(</span>
<a href="#l32.270"></a><span id="l32.270">     pre.classList.contains(&quot;moz-signature&quot;),</span>
<a href="#l32.271"></a><span id="l32.271">     &quot;The pre should have the moz-signature class&quot;</span>
<a href="#l32.272"></a><span id="l32.272">   );</span>
<a href="#l32.273"></a><span id="l32.273"> </span>
<a href="#l32.274"></a><span id="l32.274">   close_window(cw);</span>
<a href="#l32.275"></a><span id="l32.275"> </span>
<a href="#l32.276"></a><span id="l32.276">   Services.prefs.setBoolPref(kHtmlPrefKey, false);</span>
<a href="#l32.277"></a><span id="l32.277"> </span>
<a href="#l32.278"></a><span id="l32.278">   // Now let's try with plaintext mail.</span>
<a href="#l32.279"></a><span id="l32.279">   cw = open_compose_new_mail();</span>
<a href="#l32.280"></a><span id="l32.280">   add_cloud_attachments(cw, provider);</span>
<a href="#l32.281"></a><span id="l32.281">   [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l32.282"></a><span id="l32.282"> </span>
<a href="#l32.283"></a><span id="l32.283">   br = assert_previous_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l32.284"></a><span id="l32.284"> </span>
<a href="#l32.285"></a><span id="l32.285">   mailBody = get_compose_body(cw);</span>
<a href="#l32.286"></a><span id="l32.286" class="difflineminus">-  assert_equals(</span>
<a href="#l32.287"></a><span id="l32.287" class="difflineplus">+  Assert.equal(</span>
<a href="#l32.288"></a><span id="l32.288">     mailBody.firstChild,</span>
<a href="#l32.289"></a><span id="l32.289">     br,</span>
<a href="#l32.290"></a><span id="l32.290">     &quot;The linebreak should be the first child of the compose body&quot;</span>
<a href="#l32.291"></a><span id="l32.291">   );</span>
<a href="#l32.292"></a><span id="l32.292"> </span>
<a href="#l32.293"></a><span id="l32.293">   // Now ensure that the node after the attachments is a br, and following</span>
<a href="#l32.294"></a><span id="l32.294">   // that is the signature.</span>
<a href="#l32.295"></a><span id="l32.295">   br = assert_next_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l32.296"></a><span id="l32.296"> </span>
<a href="#l32.297"></a><span id="l32.297">   let div = br.nextSibling;</span>
<a href="#l32.298"></a><span id="l32.298" class="difflineminus">-  assert_equals(</span>
<a href="#l32.299"></a><span id="l32.299" class="difflineplus">+  Assert.equal(</span>
<a href="#l32.300"></a><span id="l32.300">     div.localName,</span>
<a href="#l32.301"></a><span id="l32.301">     &quot;div&quot;,</span>
<a href="#l32.302"></a><span id="l32.302">     &quot;The linebreak should be followed by the signature div&quot;</span>
<a href="#l32.303"></a><span id="l32.303">   );</span>
<a href="#l32.304"></a><span id="l32.304" class="difflineminus">-  assert_true(</span>
<a href="#l32.305"></a><span id="l32.305" class="difflineplus">+  Assert.ok(</span>
<a href="#l32.306"></a><span id="l32.306">     div.classList.contains(&quot;moz-signature&quot;),</span>
<a href="#l32.307"></a><span id="l32.307">     &quot;The div should have the moz-signature class&quot;</span>
<a href="#l32.308"></a><span id="l32.308">   );</span>
<a href="#l32.309"></a><span id="l32.309"> </span>
<a href="#l32.310"></a><span id="l32.310">   close_window(cw);</span>
<a href="#l32.311"></a><span id="l32.311"> </span>
<a href="#l32.312"></a><span id="l32.312">   Services.prefs.setBoolPref(kHtmlPrefKey, true);</span>
<a href="#l32.313"></a><span id="l32.313" class="difflineminus">-}</span>
<a href="#l32.314"></a><span id="l32.314" class="difflineplus">+});</span>
<a href="#l32.315"></a><span id="l32.315"> </span>
<a href="#l32.316"></a><span id="l32.316"> /**</span>
<a href="#l32.317"></a><span id="l32.317">  * Tests that removing all Filelinks causes the root node to be removed.</span>
<a href="#l32.318"></a><span id="l32.318">  */</span>
<a href="#l32.319"></a><span id="l32.319" class="difflineminus">-function test_removing_filelinks_removes_root_node() {</span>
<a href="#l32.320"></a><span id="l32.320" class="difflineplus">+add_task(function test_removing_filelinks_removes_root_node() {</span>
<a href="#l32.321"></a><span id="l32.321">   try_with_plaintext_and_html_mail(</span>
<a href="#l32.322"></a><span id="l32.322">     subtest_removing_filelinks_removes_root_node</span>
<a href="#l32.323"></a><span id="l32.323">   );</span>
<a href="#l32.324"></a><span id="l32.324" class="difflineminus">-}</span>
<a href="#l32.325"></a><span id="l32.325" class="difflineplus">+});</span>
<a href="#l32.326"></a><span id="l32.326"> </span>
<a href="#l32.327"></a><span id="l32.327"> /**</span>
<a href="#l32.328"></a><span id="l32.328">  * Test for test_removing_filelinks_removes_root_node - can be executed</span>
<a href="#l32.329"></a><span id="l32.329">  * on both plaintext and HTML compose windows.</span>
<a href="#l32.330"></a><span id="l32.330">  */</span>
<a href="#l32.331"></a><span id="l32.331"> function subtest_removing_filelinks_removes_root_node() {</span>
<a href="#l32.332"></a><span id="l32.332">   let cw = prepare_some_attachments_and_reply([], kFiles);</span>
<a href="#l32.333"></a><span id="l32.333">   let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l32.334"></a><span id="l32.334" class="difflineat">@@ -420,90 +423,90 @@ function subtest_removing_filelinks_remo</span>
<a href="#l32.335"></a><span id="l32.335"> }</span>
<a href="#l32.336"></a><span id="l32.336"> </span>
<a href="#l32.337"></a><span id="l32.337"> /**</span>
<a href="#l32.338"></a><span id="l32.338">  * Test that if we write some text in an empty message (no signature),</span>
<a href="#l32.339"></a><span id="l32.339">  * and the selection is at the end of a line of text, attaching some Filelinks</span>
<a href="#l32.340"></a><span id="l32.340">  * causes the attachment URL container to be separated from the text by</span>
<a href="#l32.341"></a><span id="l32.341">  * two br tags.</span>
<a href="#l32.342"></a><span id="l32.342">  */</span>
<a href="#l32.343"></a><span id="l32.343" class="difflineminus">-function test_adding_filelinks_to_written_message() {</span>
<a href="#l32.344"></a><span id="l32.344" class="difflineplus">+add_task(function test_adding_filelinks_to_written_message() {</span>
<a href="#l32.345"></a><span id="l32.345">   try_without_signature(subtest_adding_filelinks_to_written_message);</span>
<a href="#l32.346"></a><span id="l32.346" class="difflineminus">-}</span>
<a href="#l32.347"></a><span id="l32.347" class="difflineplus">+});</span>
<a href="#l32.348"></a><span id="l32.348"> </span>
<a href="#l32.349"></a><span id="l32.349"> /**</span>
<a href="#l32.350"></a><span id="l32.350">  * Subtest for test_adding_filelinks_to_written_message - generalized for both</span>
<a href="#l32.351"></a><span id="l32.351">  * HTML and plaintext mail.</span>
<a href="#l32.352"></a><span id="l32.352">  */</span>
<a href="#l32.353"></a><span id="l32.353"> function subtest_adding_filelinks_to_written_message() {</span>
<a href="#l32.354"></a><span id="l32.354" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(kFiles, __file__);</span>
<a href="#l32.355"></a><span id="l32.355" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles(kFiles);</span>
<a href="#l32.356"></a><span id="l32.356">   let provider = new MockCloudfileAccount();</span>
<a href="#l32.357"></a><span id="l32.357">   provider.init(&quot;someKey&quot;);</span>
<a href="#l32.358"></a><span id="l32.358">   let cw = open_compose_new_mail();</span>
<a href="#l32.359"></a><span id="l32.359"> </span>
<a href="#l32.360"></a><span id="l32.360">   type_in_composer(cw, kLines);</span>
<a href="#l32.361"></a><span id="l32.361">   add_cloud_attachments(cw, provider);</span>
<a href="#l32.362"></a><span id="l32.362"> </span>
<a href="#l32.363"></a><span id="l32.363">   let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l32.364"></a><span id="l32.364"> </span>
<a href="#l32.365"></a><span id="l32.365">   let br = root.previousSibling;</span>
<a href="#l32.366"></a><span id="l32.366" class="difflineminus">-  assert_equals(</span>
<a href="#l32.367"></a><span id="l32.367" class="difflineplus">+  Assert.equal(</span>
<a href="#l32.368"></a><span id="l32.368">     br.localName,</span>
<a href="#l32.369"></a><span id="l32.369">     &quot;br&quot;,</span>
<a href="#l32.370"></a><span id="l32.370">     &quot;The attachment URL containment node should be preceded by a linebreak&quot;</span>
<a href="#l32.371"></a><span id="l32.371">   );</span>
<a href="#l32.372"></a><span id="l32.372">   br = br.previousSibling;</span>
<a href="#l32.373"></a><span id="l32.373" class="difflineminus">-  assert_equals(</span>
<a href="#l32.374"></a><span id="l32.374" class="difflineplus">+  Assert.equal(</span>
<a href="#l32.375"></a><span id="l32.375">     br.localName,</span>
<a href="#l32.376"></a><span id="l32.376">     &quot;br&quot;,</span>
<a href="#l32.377"></a><span id="l32.377">     &quot;The attachment URL containment node should be preceded by &quot; +</span>
<a href="#l32.378"></a><span id="l32.378">       &quot;two linebreaks&quot;</span>
<a href="#l32.379"></a><span id="l32.379">   );</span>
<a href="#l32.380"></a><span id="l32.380">   close_window(cw);</span>
<a href="#l32.381"></a><span id="l32.381"> }</span>
<a href="#l32.382"></a><span id="l32.382"> </span>
<a href="#l32.383"></a><span id="l32.383"> /**</span>
<a href="#l32.384"></a><span id="l32.384">  * Tests for inserting Filelinks into a reply, when we're configured to</span>
<a href="#l32.385"></a><span id="l32.385">  * reply above the quote.</span>
<a href="#l32.386"></a><span id="l32.386">  */</span>
<a href="#l32.387"></a><span id="l32.387" class="difflineminus">-function test_adding_filelinks_to_empty_reply_above() {</span>
<a href="#l32.388"></a><span id="l32.388" class="difflineplus">+add_task(function test_adding_filelinks_to_empty_reply_above() {</span>
<a href="#l32.389"></a><span id="l32.389">   let oldReplyOnTop = Services.prefs.getIntPref(kReplyOnTopKey);</span>
<a href="#l32.390"></a><span id="l32.390">   Services.prefs.setIntPref(kReplyOnTopKey, kReplyOnTop);</span>
<a href="#l32.391"></a><span id="l32.391"> </span>
<a href="#l32.392"></a><span id="l32.392">   try_with_and_without_signature_in_reply_or_fwd(</span>
<a href="#l32.393"></a><span id="l32.393">     subtest_adding_filelinks_to_reply_above,</span>
<a href="#l32.394"></a><span id="l32.394">     []</span>
<a href="#l32.395"></a><span id="l32.395">   );</span>
<a href="#l32.396"></a><span id="l32.396">   // Now with HTML mail...</span>
<a href="#l32.397"></a><span id="l32.397">   Services.prefs.setBoolPref(kHtmlPrefKey, false);</span>
<a href="#l32.398"></a><span id="l32.398">   try_with_and_without_signature_in_reply_or_fwd(</span>
<a href="#l32.399"></a><span id="l32.399">     subtest_adding_filelinks_to_reply_above_plaintext,</span>
<a href="#l32.400"></a><span id="l32.400">     []</span>
<a href="#l32.401"></a><span id="l32.401">   );</span>
<a href="#l32.402"></a><span id="l32.402"> </span>
<a href="#l32.403"></a><span id="l32.403">   Services.prefs.setBoolPref(kHtmlPrefKey, true);</span>
<a href="#l32.404"></a><span id="l32.404">   Services.prefs.setIntPref(kReplyOnTopKey, oldReplyOnTop);</span>
<a href="#l32.405"></a><span id="l32.405" class="difflineminus">-}</span>
<a href="#l32.406"></a><span id="l32.406" class="difflineplus">+});</span>
<a href="#l32.407"></a><span id="l32.407"> </span>
<a href="#l32.408"></a><span id="l32.408"> /**</span>
<a href="#l32.409"></a><span id="l32.409">  * Tests for inserting Filelinks into a reply, when we're configured to</span>
<a href="#l32.410"></a><span id="l32.410">  * reply above the quote, after entering some text.</span>
<a href="#l32.411"></a><span id="l32.411">  */</span>
<a href="#l32.412"></a><span id="l32.412" class="difflineminus">-function test_adding_filelinks_to_nonempty_reply_above() {</span>
<a href="#l32.413"></a><span id="l32.413" class="difflineplus">+add_task(function test_adding_filelinks_to_nonempty_reply_above() {</span>
<a href="#l32.414"></a><span id="l32.414">   let oldReplyOnTop = Services.prefs.getIntPref(kReplyOnTopKey);</span>
<a href="#l32.415"></a><span id="l32.415">   Services.prefs.setIntPref(kReplyOnTopKey, kReplyOnTop);</span>
<a href="#l32.416"></a><span id="l32.416"> </span>
<a href="#l32.417"></a><span id="l32.417">   subtest_adding_filelinks_to_reply_above(kLines);</span>
<a href="#l32.418"></a><span id="l32.418"> </span>
<a href="#l32.419"></a><span id="l32.419">   Services.prefs.setBoolPref(kHtmlPrefKey, false);</span>
<a href="#l32.420"></a><span id="l32.420">   subtest_adding_filelinks_to_reply_above_plaintext(kLines);</span>
<a href="#l32.421"></a><span id="l32.421">   Services.prefs.setBoolPref(kHtmlPrefKey, true);</span>
<a href="#l32.422"></a><span id="l32.422"> </span>
<a href="#l32.423"></a><span id="l32.423">   Services.prefs.setIntPref(kReplyOnTopKey, oldReplyOnTop);</span>
<a href="#l32.424"></a><span id="l32.424" class="difflineminus">-}</span>
<a href="#l32.425"></a><span id="l32.425" class="difflineplus">+});</span>
<a href="#l32.426"></a><span id="l32.426"> </span>
<a href="#l32.427"></a><span id="l32.427"> /**</span>
<a href="#l32.428"></a><span id="l32.428">  * Subtest for test_adding_filelinks_to_reply_above for the plaintext composer.</span>
<a href="#l32.429"></a><span id="l32.429">  * Does some special casing for the weird br insertions that happens in</span>
<a href="#l32.430"></a><span id="l32.430">  * various cases.</span>
<a href="#l32.431"></a><span id="l32.431">  */</span>
<a href="#l32.432"></a><span id="l32.432"> function subtest_adding_filelinks_to_reply_above_plaintext(aText, aWithSig) {</span>
<a href="#l32.433"></a><span id="l32.433">   let cw = prepare_some_attachments_and_reply(aText, kFiles);</span>
<a href="#l32.434"></a><span id="l32.434" class="difflineat">@@ -512,45 +515,45 @@ function subtest_adding_filelinks_to_rep</span>
<a href="#l32.435"></a><span id="l32.435">   let br;</span>
<a href="#l32.436"></a><span id="l32.436">   if (aText.length) {</span>
<a href="#l32.437"></a><span id="l32.437">     br = assert_next_nodes(&quot;br&quot;, root, 2);</span>
<a href="#l32.438"></a><span id="l32.438">   } else {</span>
<a href="#l32.439"></a><span id="l32.439">     br = assert_next_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l32.440"></a><span id="l32.440">   }</span>
<a href="#l32.441"></a><span id="l32.441"> </span>
<a href="#l32.442"></a><span id="l32.442">   let div = br.nextSibling;</span>
<a href="#l32.443"></a><span id="l32.443" class="difflineminus">-  assert_equals(</span>
<a href="#l32.444"></a><span id="l32.444" class="difflineplus">+  Assert.equal(</span>
<a href="#l32.445"></a><span id="l32.445">     div.localName,</span>
<a href="#l32.446"></a><span id="l32.446">     &quot;div&quot;,</span>
<a href="#l32.447"></a><span id="l32.447">     &quot;The linebreak should be followed by a div&quot;</span>
<a href="#l32.448"></a><span id="l32.448">   );</span>
<a href="#l32.449"></a><span id="l32.449"> </span>
<a href="#l32.450"></a><span id="l32.450" class="difflineminus">-  assert_true(div.classList.contains(&quot;moz-cite-prefix&quot;));</span>
<a href="#l32.451"></a><span id="l32.451" class="difflineplus">+  Assert.ok(div.classList.contains(&quot;moz-cite-prefix&quot;));</span>
<a href="#l32.452"></a><span id="l32.452"> </span>
<a href="#l32.453"></a><span id="l32.453">   if (aText.length) {</span>
<a href="#l32.454"></a><span id="l32.454">     br = assert_previous_nodes(&quot;br&quot;, root, 2);</span>
<a href="#l32.455"></a><span id="l32.455">   } else {</span>
<a href="#l32.456"></a><span id="l32.456">     br = assert_previous_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l32.457"></a><span id="l32.457">   }</span>
<a href="#l32.458"></a><span id="l32.458"> </span>
<a href="#l32.459"></a><span id="l32.459">   if (aText.length == 0) {</span>
<a href="#l32.460"></a><span id="l32.460">     // If we didn't type anything, that br should be the first element of the</span>
<a href="#l32.461"></a><span id="l32.461">     // message body.</span>
<a href="#l32.462"></a><span id="l32.462">     let msgBody = get_compose_body(cw);</span>
<a href="#l32.463"></a><span id="l32.463" class="difflineminus">-    assert_equals(</span>
<a href="#l32.464"></a><span id="l32.464" class="difflineplus">+    Assert.equal(</span>
<a href="#l32.465"></a><span id="l32.465">       msgBody.firstChild,</span>
<a href="#l32.466"></a><span id="l32.466">       br,</span>
<a href="#l32.467"></a><span id="l32.467">       &quot;The linebreak should have been the first element in the &quot; +</span>
<a href="#l32.468"></a><span id="l32.468">         &quot;message body&quot;</span>
<a href="#l32.469"></a><span id="l32.469">     );</span>
<a href="#l32.470"></a><span id="l32.470">   } else {</span>
<a href="#l32.471"></a><span id="l32.471">     let targetText = aText[aText.length - 1];</span>
<a href="#l32.472"></a><span id="l32.472">     let textNode = br.previousSibling;</span>
<a href="#l32.473"></a><span id="l32.473" class="difflineminus">-    assert_equals(textNode.nodeType, kTextNodeType);</span>
<a href="#l32.474"></a><span id="l32.474" class="difflineminus">-    assert_equals(textNode.nodeValue, targetText);</span>
<a href="#l32.475"></a><span id="l32.475" class="difflineplus">+    Assert.equal(textNode.nodeType, kTextNodeType);</span>
<a href="#l32.476"></a><span id="l32.476" class="difflineplus">+    Assert.equal(textNode.nodeValue, targetText);</span>
<a href="#l32.477"></a><span id="l32.477">   }</span>
<a href="#l32.478"></a><span id="l32.478"> </span>
<a href="#l32.479"></a><span id="l32.479">   close_window(cw);</span>
<a href="#l32.480"></a><span id="l32.480"> }</span>
<a href="#l32.481"></a><span id="l32.481"> </span>
<a href="#l32.482"></a><span id="l32.482"> /**</span>
<a href="#l32.483"></a><span id="l32.483">  * Subtest for test_adding_filelinks_to_reply_above for the HTML composer.</span>
<a href="#l32.484"></a><span id="l32.484">  */</span>
<a href="#l32.485"></a><span id="l32.485" class="difflineat">@@ -562,81 +565,81 @@ function subtest_adding_filelinks_to_rep</span>
<a href="#l32.486"></a><span id="l32.486">   // end of the text and the reply. Otherwise, there are two breaks.</span>
<a href="#l32.487"></a><span id="l32.487">   let br =</span>
<a href="#l32.488"></a><span id="l32.488">     aText.length &gt; 1</span>
<a href="#l32.489"></a><span id="l32.489">       ? assert_next_nodes(&quot;br&quot;, root, 2)</span>
<a href="#l32.490"></a><span id="l32.490">       : assert_next_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l32.491"></a><span id="l32.491"> </span>
<a href="#l32.492"></a><span id="l32.492">   // ... which is followed by a div with a class of &quot;moz-cite-prefix&quot;.</span>
<a href="#l32.493"></a><span id="l32.493">   let div = br.nextSibling;</span>
<a href="#l32.494"></a><span id="l32.494" class="difflineminus">-  assert_equals(</span>
<a href="#l32.495"></a><span id="l32.495" class="difflineplus">+  Assert.equal(</span>
<a href="#l32.496"></a><span id="l32.496">     div.localName,</span>
<a href="#l32.497"></a><span id="l32.497">     &quot;div&quot;,</span>
<a href="#l32.498"></a><span id="l32.498">     &quot;The linebreak should be followed by a div&quot;</span>
<a href="#l32.499"></a><span id="l32.499">   );</span>
<a href="#l32.500"></a><span id="l32.500"> </span>
<a href="#l32.501"></a><span id="l32.501" class="difflineminus">-  assert_true(div.classList.contains(&quot;moz-cite-prefix&quot;));</span>
<a href="#l32.502"></a><span id="l32.502" class="difflineplus">+  Assert.ok(div.classList.contains(&quot;moz-cite-prefix&quot;));</span>
<a href="#l32.503"></a><span id="l32.503"> </span>
<a href="#l32.504"></a><span id="l32.504">   close_window(cw);</span>
<a href="#l32.505"></a><span id="l32.505"> }</span>
<a href="#l32.506"></a><span id="l32.506"> </span>
<a href="#l32.507"></a><span id="l32.507"> /**</span>
<a href="#l32.508"></a><span id="l32.508">  * Tests for inserting Filelinks into a reply, when we're configured to</span>
<a href="#l32.509"></a><span id="l32.509">  * reply below the quote.</span>
<a href="#l32.510"></a><span id="l32.510">  */</span>
<a href="#l32.511"></a><span id="l32.511" class="difflineminus">-function test_adding_filelinks_to_empty_reply_below() {</span>
<a href="#l32.512"></a><span id="l32.512" class="difflineplus">+add_task(function test_adding_filelinks_to_empty_reply_below() {</span>
<a href="#l32.513"></a><span id="l32.513">   let oldReplyOnTop = Services.prefs.getIntPref(kReplyOnTopKey);</span>
<a href="#l32.514"></a><span id="l32.514">   Services.prefs.setIntPref(kReplyOnTopKey, kReplyOnBottom);</span>
<a href="#l32.515"></a><span id="l32.515"> </span>
<a href="#l32.516"></a><span id="l32.516">   try_with_and_without_signature_in_reply_or_fwd(</span>
<a href="#l32.517"></a><span id="l32.517">     subtest_adding_filelinks_to_reply_below,</span>
<a href="#l32.518"></a><span id="l32.518">     []</span>
<a href="#l32.519"></a><span id="l32.519">   );</span>
<a href="#l32.520"></a><span id="l32.520">   Services.prefs.setBoolPref(kHtmlPrefKey, false);</span>
<a href="#l32.521"></a><span id="l32.521">   try_with_and_without_signature_in_reply_or_fwd(</span>
<a href="#l32.522"></a><span id="l32.522">     subtest_adding_filelinks_to_plaintext_reply_below,</span>
<a href="#l32.523"></a><span id="l32.523">     []</span>
<a href="#l32.524"></a><span id="l32.524">   );</span>
<a href="#l32.525"></a><span id="l32.525">   Services.prefs.setBoolPref(kHtmlPrefKey, true);</span>
<a href="#l32.526"></a><span id="l32.526"> </span>
<a href="#l32.527"></a><span id="l32.527">   Services.prefs.setIntPref(kReplyOnTopKey, oldReplyOnTop);</span>
<a href="#l32.528"></a><span id="l32.528" class="difflineminus">-}</span>
<a href="#l32.529"></a><span id="l32.529" class="difflineplus">+});</span>
<a href="#l32.530"></a><span id="l32.530"> </span>
<a href="#l32.531"></a><span id="l32.531"> /**</span>
<a href="#l32.532"></a><span id="l32.532">  * Tests for inserting Filelinks into a reply, when we're configured to</span>
<a href="#l32.533"></a><span id="l32.533">  * reply below the quote, after entering some text.</span>
<a href="#l32.534"></a><span id="l32.534">  */</span>
<a href="#l32.535"></a><span id="l32.535" class="difflineminus">-function test_adding_filelinks_to_nonempty_reply_below() {</span>
<a href="#l32.536"></a><span id="l32.536" class="difflineplus">+add_task(function test_adding_filelinks_to_nonempty_reply_below() {</span>
<a href="#l32.537"></a><span id="l32.537">   let oldReplyOnTop = Services.prefs.getIntPref(kReplyOnTopKey);</span>
<a href="#l32.538"></a><span id="l32.538">   Services.prefs.setIntPref(kReplyOnTopKey, kReplyOnBottom);</span>
<a href="#l32.539"></a><span id="l32.539"> </span>
<a href="#l32.540"></a><span id="l32.540">   try_with_and_without_signature_in_reply_or_fwd(</span>
<a href="#l32.541"></a><span id="l32.541">     subtest_adding_filelinks_to_reply_below,</span>
<a href="#l32.542"></a><span id="l32.542">     kLines</span>
<a href="#l32.543"></a><span id="l32.543">   );</span>
<a href="#l32.544"></a><span id="l32.544"> </span>
<a href="#l32.545"></a><span id="l32.545">   Services.prefs.setBoolPref(kHtmlPrefKey, false);</span>
<a href="#l32.546"></a><span id="l32.546">   try_with_and_without_signature_in_reply_or_fwd(</span>
<a href="#l32.547"></a><span id="l32.547">     subtest_adding_filelinks_to_plaintext_reply_below,</span>
<a href="#l32.548"></a><span id="l32.548">     kLines</span>
<a href="#l32.549"></a><span id="l32.549">   );</span>
<a href="#l32.550"></a><span id="l32.550">   Services.prefs.setBoolPref(kHtmlPrefKey, true);</span>
<a href="#l32.551"></a><span id="l32.551"> </span>
<a href="#l32.552"></a><span id="l32.552">   Services.prefs.setIntPref(kReplyOnTopKey, oldReplyOnTop);</span>
<a href="#l32.553"></a><span id="l32.553" class="difflineminus">-}</span>
<a href="#l32.554"></a><span id="l32.554" class="difflineplus">+});</span>
<a href="#l32.555"></a><span id="l32.555"> </span>
<a href="#l32.556"></a><span id="l32.556"> /**</span>
<a href="#l32.557"></a><span id="l32.557">  * Subtest for test_adding_filelinks_to_reply_below for the HTML composer.</span>
<a href="#l32.558"></a><span id="l32.558">  */</span>
<a href="#l32.559"></a><span id="l32.559"> function subtest_adding_filelinks_to_reply_below(aText, aWithSig) {</span>
<a href="#l32.560"></a><span id="l32.560">   let cw = prepare_some_attachments_and_reply(aText, kFiles);</span>
<a href="#l32.561"></a><span id="l32.561">   let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l32.562"></a><span id="l32.562">   // So, we should have the root, followed by a br</span>
<a href="#l32.563"></a><span id="l32.563">   let br = root.nextSibling;</span>
<a href="#l32.564"></a><span id="l32.564" class="difflineminus">-  assert_equals(</span>
<a href="#l32.565"></a><span id="l32.565" class="difflineplus">+  Assert.equal(</span>
<a href="#l32.566"></a><span id="l32.566">     br.localName,</span>
<a href="#l32.567"></a><span id="l32.567">     &quot;br&quot;,</span>
<a href="#l32.568"></a><span id="l32.568">     &quot;The attachment URL containment node should be followed by a br&quot;</span>
<a href="#l32.569"></a><span id="l32.569">   );</span>
<a href="#l32.570"></a><span id="l32.570"> </span>
<a href="#l32.571"></a><span id="l32.571">   let blockquote;</span>
<a href="#l32.572"></a><span id="l32.572">   if (aText.length) {</span>
<a href="#l32.573"></a><span id="l32.573">     // If there was any text inserted, check for 2 previous br nodes, and then</span>
<a href="#l32.574"></a><span id="l32.574" class="difflineat">@@ -646,29 +649,29 @@ function subtest_adding_filelinks_to_rep</span>
<a href="#l32.575"></a><span id="l32.575">     blockquote = textNode.previousSibling;</span>
<a href="#l32.576"></a><span id="l32.576">   } else {</span>
<a href="#l32.577"></a><span id="l32.577">     // If no text was inserted, check for 1 previous br node, and then the</span>
<a href="#l32.578"></a><span id="l32.578">     // blockquote.</span>
<a href="#l32.579"></a><span id="l32.579">     br = assert_previous_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l32.580"></a><span id="l32.580">     blockquote = br.previousSibling;</span>
<a href="#l32.581"></a><span id="l32.581">   }</span>
<a href="#l32.582"></a><span id="l32.582"> </span>
<a href="#l32.583"></a><span id="l32.583" class="difflineminus">-  assert_equals(</span>
<a href="#l32.584"></a><span id="l32.584" class="difflineplus">+  Assert.equal(</span>
<a href="#l32.585"></a><span id="l32.585">     blockquote.localName,</span>
<a href="#l32.586"></a><span id="l32.586">     &quot;blockquote&quot;,</span>
<a href="#l32.587"></a><span id="l32.587">     &quot;The linebreak should be preceded by a blockquote.&quot;</span>
<a href="#l32.588"></a><span id="l32.588">   );</span>
<a href="#l32.589"></a><span id="l32.589"> </span>
<a href="#l32.590"></a><span id="l32.590">   let prefix = blockquote.previousSibling;</span>
<a href="#l32.591"></a><span id="l32.591" class="difflineminus">-  assert_equals(</span>
<a href="#l32.592"></a><span id="l32.592" class="difflineplus">+  Assert.equal(</span>
<a href="#l32.593"></a><span id="l32.593">     prefix.localName,</span>
<a href="#l32.594"></a><span id="l32.594">     &quot;div&quot;,</span>
<a href="#l32.595"></a><span id="l32.595">     &quot;The blockquote should be preceded by the prefix div&quot;</span>
<a href="#l32.596"></a><span id="l32.596">   );</span>
<a href="#l32.597"></a><span id="l32.597" class="difflineminus">-  assert_true(</span>
<a href="#l32.598"></a><span id="l32.598" class="difflineplus">+  Assert.ok(</span>
<a href="#l32.599"></a><span id="l32.599">     prefix.classList.contains(&quot;moz-cite-prefix&quot;),</span>
<a href="#l32.600"></a><span id="l32.600">     &quot;The prefix should have the moz-cite-prefix class&quot;</span>
<a href="#l32.601"></a><span id="l32.601">   );</span>
<a href="#l32.602"></a><span id="l32.602"> </span>
<a href="#l32.603"></a><span id="l32.603">   close_window(cw);</span>
<a href="#l32.604"></a><span id="l32.604"> }</span>
<a href="#l32.605"></a><span id="l32.605"> </span>
<a href="#l32.606"></a><span id="l32.606"> /**</span>
<a href="#l32.607"></a><span id="l32.607" class="difflineat">@@ -694,118 +697,118 @@ function subtest_adding_filelinks_to_pla</span>
<a href="#l32.608"></a><span id="l32.608">     // will be the span.</span>
<a href="#l32.609"></a><span id="l32.609">     span = br.previousSibling;</span>
<a href="#l32.610"></a><span id="l32.610">     // Sometimes we need to skip one more linebreak.</span>
<a href="#l32.611"></a><span id="l32.611">     if (span.localName != &quot;span&quot;) {</span>
<a href="#l32.612"></a><span id="l32.612">       span = span.previousSibling;</span>
<a href="#l32.613"></a><span id="l32.613">     }</span>
<a href="#l32.614"></a><span id="l32.614">   }</span>
<a href="#l32.615"></a><span id="l32.615"> </span>
<a href="#l32.616"></a><span id="l32.616" class="difflineminus">-  assert_equals(</span>
<a href="#l32.617"></a><span id="l32.617" class="difflineplus">+  Assert.equal(</span>
<a href="#l32.618"></a><span id="l32.618">     span.localName,</span>
<a href="#l32.619"></a><span id="l32.619">     &quot;span&quot;,</span>
<a href="#l32.620"></a><span id="l32.620">     &quot;The linebreak should be preceded by a span.&quot;</span>
<a href="#l32.621"></a><span id="l32.621">   );</span>
<a href="#l32.622"></a><span id="l32.622"> </span>
<a href="#l32.623"></a><span id="l32.623">   let prefix = span.previousSibling;</span>
<a href="#l32.624"></a><span id="l32.624" class="difflineminus">-  assert_equals(</span>
<a href="#l32.625"></a><span id="l32.625" class="difflineplus">+  Assert.equal(</span>
<a href="#l32.626"></a><span id="l32.626">     prefix.localName,</span>
<a href="#l32.627"></a><span id="l32.627">     &quot;div&quot;,</span>
<a href="#l32.628"></a><span id="l32.628">     &quot;The blockquote should be preceded by the prefix div&quot;</span>
<a href="#l32.629"></a><span id="l32.629">   );</span>
<a href="#l32.630"></a><span id="l32.630" class="difflineminus">-  assert_true(</span>
<a href="#l32.631"></a><span id="l32.631" class="difflineplus">+  Assert.ok(</span>
<a href="#l32.632"></a><span id="l32.632">     prefix.classList.contains(&quot;moz-cite-prefix&quot;),</span>
<a href="#l32.633"></a><span id="l32.633">     &quot;The prefix should have the moz-cite-prefix class&quot;</span>
<a href="#l32.634"></a><span id="l32.634">   );</span>
<a href="#l32.635"></a><span id="l32.635"> </span>
<a href="#l32.636"></a><span id="l32.636">   close_window(cw);</span>
<a href="#l32.637"></a><span id="l32.637"> }</span>
<a href="#l32.638"></a><span id="l32.638"> </span>
<a href="#l32.639"></a><span id="l32.639"> /**</span>
<a href="#l32.640"></a><span id="l32.640">  * Tests Filelink insertion on an inline-forward compose window with nothing</span>
<a href="#l32.641"></a><span id="l32.641">  * typed into it.</span>
<a href="#l32.642"></a><span id="l32.642">  */</span>
<a href="#l32.643"></a><span id="l32.643" class="difflineminus">-function test_adding_filelinks_to_empty_forward() {</span>
<a href="#l32.644"></a><span id="l32.644" class="difflineplus">+add_task(function test_adding_filelinks_to_empty_forward() {</span>
<a href="#l32.645"></a><span id="l32.645">   Services.prefs.setIntPref(kReplyOnTopKey, kReplyOnTop);</span>
<a href="#l32.646"></a><span id="l32.646">   try_with_and_without_signature_in_reply_or_fwd(</span>
<a href="#l32.647"></a><span id="l32.647">     subtest_adding_filelinks_to_forward,</span>
<a href="#l32.648"></a><span id="l32.648">     []</span>
<a href="#l32.649"></a><span id="l32.649">   );</span>
<a href="#l32.650"></a><span id="l32.650">   Services.prefs.setBoolPref(kHtmlPrefKey, false);</span>
<a href="#l32.651"></a><span id="l32.651">   try_with_and_without_signature_in_reply_or_fwd(</span>
<a href="#l32.652"></a><span id="l32.652">     subtest_adding_filelinks_to_forward,</span>
<a href="#l32.653"></a><span id="l32.653">     []</span>
<a href="#l32.654"></a><span id="l32.654">   );</span>
<a href="#l32.655"></a><span id="l32.655">   Services.prefs.setBoolPref(kHtmlPrefKey, true);</span>
<a href="#l32.656"></a><span id="l32.656" class="difflineminus">-}</span>
<a href="#l32.657"></a><span id="l32.657" class="difflineplus">+});</span>
<a href="#l32.658"></a><span id="l32.658"> </span>
<a href="#l32.659"></a><span id="l32.659"> /**</span>
<a href="#l32.660"></a><span id="l32.660">  * Tests Filelink insertion on an inline-forward compose window with some</span>
<a href="#l32.661"></a><span id="l32.661">  * text typed into it.</span>
<a href="#l32.662"></a><span id="l32.662">  */</span>
<a href="#l32.663"></a><span id="l32.663" class="difflineminus">-function test_adding_filelinks_to_forward() {</span>
<a href="#l32.664"></a><span id="l32.664" class="difflineplus">+add_task(function test_adding_filelinks_to_forward() {</span>
<a href="#l32.665"></a><span id="l32.665">   try_with_and_without_signature_in_reply_or_fwd(</span>
<a href="#l32.666"></a><span id="l32.666">     subtest_adding_filelinks_to_forward,</span>
<a href="#l32.667"></a><span id="l32.667">     kLines</span>
<a href="#l32.668"></a><span id="l32.668">   );</span>
<a href="#l32.669"></a><span id="l32.669">   Services.prefs.setBoolPref(kHtmlPrefKey, false);</span>
<a href="#l32.670"></a><span id="l32.670">   try_with_and_without_signature_in_reply_or_fwd(</span>
<a href="#l32.671"></a><span id="l32.671">     subtest_adding_filelinks_to_forward,</span>
<a href="#l32.672"></a><span id="l32.672">     kLines</span>
<a href="#l32.673"></a><span id="l32.673">   );</span>
<a href="#l32.674"></a><span id="l32.674">   Services.prefs.setBoolPref(kHtmlPrefKey, true);</span>
<a href="#l32.675"></a><span id="l32.675" class="difflineminus">-}</span>
<a href="#l32.676"></a><span id="l32.676" class="difflineplus">+});</span>
<a href="#l32.677"></a><span id="l32.677"> </span>
<a href="#l32.678"></a><span id="l32.678"> /**</span>
<a href="#l32.679"></a><span id="l32.679">  * Subtest for both test_adding_filelinks_to_empty_forward and</span>
<a href="#l32.680"></a><span id="l32.680">  * test_adding_filelinks_to_forward - ensures that the inserted Filelinks</span>
<a href="#l32.681"></a><span id="l32.681">  * are positioned correctly.</span>
<a href="#l32.682"></a><span id="l32.682">  */</span>
<a href="#l32.683"></a><span id="l32.683"> function subtest_adding_filelinks_to_forward(aText, aWithSig) {</span>
<a href="#l32.684"></a><span id="l32.684">   let cw = prepare_some_attachments_and_forward(aText, kFiles);</span>
<a href="#l32.685"></a><span id="l32.685">   let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l32.686"></a><span id="l32.686"> </span>
<a href="#l32.687"></a><span id="l32.687">   let br = assert_next_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l32.688"></a><span id="l32.688">   let forwardDiv = br.nextSibling;</span>
<a href="#l32.689"></a><span id="l32.689" class="difflineminus">-  assert_equals(forwardDiv.localName, &quot;div&quot;);</span>
<a href="#l32.690"></a><span id="l32.690" class="difflineminus">-  assert_true(forwardDiv.classList.contains(&quot;moz-forward-container&quot;));</span>
<a href="#l32.691"></a><span id="l32.691" class="difflineplus">+  Assert.equal(forwardDiv.localName, &quot;div&quot;);</span>
<a href="#l32.692"></a><span id="l32.692" class="difflineplus">+  Assert.ok(forwardDiv.classList.contains(&quot;moz-forward-container&quot;));</span>
<a href="#l32.693"></a><span id="l32.693"> </span>
<a href="#l32.694"></a><span id="l32.694">   if (aText.length) {</span>
<a href="#l32.695"></a><span id="l32.695">     // If there was text typed in, it should be separated from the root by two</span>
<a href="#l32.696"></a><span id="l32.696">     // br's</span>
<a href="#l32.697"></a><span id="l32.697">     let br = assert_previous_nodes(&quot;br&quot;, root, 2);</span>
<a href="#l32.698"></a><span id="l32.698">     assert_previous_text(br.previousSibling, aText);</span>
<a href="#l32.699"></a><span id="l32.699">   } else {</span>
<a href="#l32.700"></a><span id="l32.700">     // Otherwise, there's only 1 br, and that br should be the first element</span>
<a href="#l32.701"></a><span id="l32.701">     // of the message body.</span>
<a href="#l32.702"></a><span id="l32.702">     let br = assert_previous_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l32.703"></a><span id="l32.703">     let mailBody = get_compose_body(cw);</span>
<a href="#l32.704"></a><span id="l32.704" class="difflineminus">-    assert_equals(br, mailBody.firstChild);</span>
<a href="#l32.705"></a><span id="l32.705" class="difflineplus">+    Assert.equal(br, mailBody.firstChild);</span>
<a href="#l32.706"></a><span id="l32.706">   }</span>
<a href="#l32.707"></a><span id="l32.707"> </span>
<a href="#l32.708"></a><span id="l32.708">   close_window(cw);</span>
<a href="#l32.709"></a><span id="l32.709"> }</span>
<a href="#l32.710"></a><span id="l32.710"> </span>
<a href="#l32.711"></a><span id="l32.711"> /**</span>
<a href="#l32.712"></a><span id="l32.712">  * Test that if we convert a Filelink from one provider to another, that the</span>
<a href="#l32.713"></a><span id="l32.713">  * old Filelink is removed, and a new Filelink is added for the new provider.</span>
<a href="#l32.714"></a><span id="l32.714">  * We test this on both HTML and plaintext mail.</span>
<a href="#l32.715"></a><span id="l32.715">  */</span>
<a href="#l32.716"></a><span id="l32.716" class="difflineminus">-function test_converting_filelink_updates_urls() {</span>
<a href="#l32.717"></a><span id="l32.717" class="difflineplus">+add_task(function test_converting_filelink_updates_urls() {</span>
<a href="#l32.718"></a><span id="l32.718">   try_with_plaintext_and_html_mail(subtest_converting_filelink_updates_urls);</span>
<a href="#l32.719"></a><span id="l32.719" class="difflineminus">-}</span>
<a href="#l32.720"></a><span id="l32.720" class="difflineplus">+});</span>
<a href="#l32.721"></a><span id="l32.721"> </span>
<a href="#l32.722"></a><span id="l32.722"> /**</span>
<a href="#l32.723"></a><span id="l32.723">  * Subtest for test_converting_filelink_updates_urls that creates two</span>
<a href="#l32.724"></a><span id="l32.724">  * storage provider accounts, uploads files to one, converts them to the</span>
<a href="#l32.725"></a><span id="l32.725">  * other, and ensures that the attachment links in the message body get</span>
<a href="#l32.726"></a><span id="l32.726">  * get updated.</span>
<a href="#l32.727"></a><span id="l32.727">  */</span>
<a href="#l32.728"></a><span id="l32.728"> function subtest_converting_filelink_updates_urls() {</span>
<a href="#l32.729"></a><span id="l32.729" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(kFiles, __file__);</span>
<a href="#l32.730"></a><span id="l32.730" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles(kFiles);</span>
<a href="#l32.731"></a><span id="l32.731">   let providerA = new MockCloudfileAccount();</span>
<a href="#l32.732"></a><span id="l32.732">   let providerB = new MockCloudfileAccount();</span>
<a href="#l32.733"></a><span id="l32.733">   providerA.init(&quot;providerA&quot;);</span>
<a href="#l32.734"></a><span id="l32.734">   providerB.init(&quot;providerB&quot;);</span>
<a href="#l32.735"></a><span id="l32.735"> </span>
<a href="#l32.736"></a><span id="l32.736">   let cw = open_compose_new_mail();</span>
<a href="#l32.737"></a><span id="l32.737">   add_cloud_attachments(cw, providerA);</span>
<a href="#l32.738"></a><span id="l32.738"> </span>
<a href="#l32.739"></a><span id="l32.739" class="difflineat">@@ -815,58 +818,54 @@ function subtest_converting_filelink_upd</span>
<a href="#l32.740"></a><span id="l32.740">   for (let i = 0; i &lt; kFiles.length; ++i) {</span>
<a href="#l32.741"></a><span id="l32.741">     let url = urls[i];</span>
<a href="#l32.742"></a><span id="l32.742">     select_attachments(cw, i);</span>
<a href="#l32.743"></a><span id="l32.743">     cw.window.convertSelectedToCloudAttachment(providerB);</span>
<a href="#l32.744"></a><span id="l32.744">     [, , urls] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l32.745"></a><span id="l32.745"> </span>
<a href="#l32.746"></a><span id="l32.746">     let newUrl = urls[i];</span>
<a href="#l32.747"></a><span id="l32.747"> </span>
<a href="#l32.748"></a><span id="l32.748" class="difflineminus">-    assert_not_equals(</span>
<a href="#l32.749"></a><span id="l32.749" class="difflineminus">-      url,</span>
<a href="#l32.750"></a><span id="l32.750" class="difflineminus">-      newUrl,</span>
<a href="#l32.751"></a><span id="l32.751" class="difflineminus">-      &quot;The original URL should have been replaced&quot;</span>
<a href="#l32.752"></a><span id="l32.752" class="difflineminus">-    );</span>
<a href="#l32.753"></a><span id="l32.753" class="difflineplus">+    Assert.notEqual(url, newUrl, &quot;The original URL should have been replaced&quot;);</span>
<a href="#l32.754"></a><span id="l32.754">   }</span>
<a href="#l32.755"></a><span id="l32.755"> </span>
<a href="#l32.756"></a><span id="l32.756">   close_window(cw);</span>
<a href="#l32.757"></a><span id="l32.757"> }</span>
<a href="#l32.758"></a><span id="l32.758"> </span>
<a href="#l32.759"></a><span id="l32.759"> /**</span>
<a href="#l32.760"></a><span id="l32.760">  * Test that if we convert a Filelink to a normal attachment that the</span>
<a href="#l32.761"></a><span id="l32.761">  * Filelink is removed from the message body.</span>
<a href="#l32.762"></a><span id="l32.762">  */</span>
<a href="#l32.763"></a><span id="l32.763" class="difflineminus">-function test_converting_filelink_to_normal_removes_url() {</span>
<a href="#l32.764"></a><span id="l32.764" class="difflineplus">+add_task(function test_converting_filelink_to_normal_removes_url() {</span>
<a href="#l32.765"></a><span id="l32.765">   try_with_plaintext_and_html_mail(</span>
<a href="#l32.766"></a><span id="l32.766">     subtest_converting_filelink_to_normal_removes_url</span>
<a href="#l32.767"></a><span id="l32.767">   );</span>
<a href="#l32.768"></a><span id="l32.768" class="difflineminus">-}</span>
<a href="#l32.769"></a><span id="l32.769" class="difflineplus">+});</span>
<a href="#l32.770"></a><span id="l32.770"> </span>
<a href="#l32.771"></a><span id="l32.771"> /**</span>
<a href="#l32.772"></a><span id="l32.772">  * Subtest for test_converting_filelink_to_normal_removes_url that adds</span>
<a href="#l32.773"></a><span id="l32.773">  * some Filelinks to an email, and then converts those Filelinks back into</span>
<a href="#l32.774"></a><span id="l32.774">  * normal attachments, checking to ensure that the links are removed from</span>
<a href="#l32.775"></a><span id="l32.775">  * the body of the email.</span>
<a href="#l32.776"></a><span id="l32.776">  */</span>
<a href="#l32.777"></a><span id="l32.777"> function subtest_converting_filelink_to_normal_removes_url() {</span>
<a href="#l32.778"></a><span id="l32.778" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(kFiles, __file__);</span>
<a href="#l32.779"></a><span id="l32.779" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles(kFiles);</span>
<a href="#l32.780"></a><span id="l32.780">   let provider = new MockCloudfileAccount();</span>
<a href="#l32.781"></a><span id="l32.781">   provider.init(&quot;someKey&quot;);</span>
<a href="#l32.782"></a><span id="l32.782"> </span>
<a href="#l32.783"></a><span id="l32.783">   let cw = open_compose_new_mail();</span>
<a href="#l32.784"></a><span id="l32.784">   add_cloud_attachments(cw, provider);</span>
<a href="#l32.785"></a><span id="l32.785"> </span>
<a href="#l32.786"></a><span id="l32.786">   let [root, list] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l32.787"></a><span id="l32.787"> </span>
<a href="#l32.788"></a><span id="l32.788">   for (let i = 0; i &lt; kFiles.length; ++i) {</span>
<a href="#l32.789"></a><span id="l32.789">     select_attachments(cw, i);</span>
<a href="#l32.790"></a><span id="l32.790">     cw.window.convertSelectedToRegularAttachment();</span>
<a href="#l32.791"></a><span id="l32.791"> </span>
<a href="#l32.792"></a><span id="l32.792">     let urls = list.querySelectorAll(&quot;.cloudAttachmentItem&quot;);</span>
<a href="#l32.793"></a><span id="l32.793" class="difflineminus">-    assert_equals(urls.length, kFiles.length - (i + 1));</span>
<a href="#l32.794"></a><span id="l32.794" class="difflineplus">+    Assert.equal(urls.length, kFiles.length - (i + 1));</span>
<a href="#l32.795"></a><span id="l32.795">   }</span>
<a href="#l32.796"></a><span id="l32.796"> </span>
<a href="#l32.797"></a><span id="l32.797">   // At this point, the root should also have been removed.</span>
<a href="#l32.798"></a><span id="l32.798">   let mailBody = get_compose_body(cw);</span>
<a href="#l32.799"></a><span id="l32.799">   root = mailBody.querySelector(&quot;#cloudAttachmentListRoot&quot;);</span>
<a href="#l32.800"></a><span id="l32.800">   if (root) {</span>
<a href="#l32.801"></a><span id="l32.801">     throw new Error(&quot;Should not have found the cloudAttachmentListRoot&quot;);</span>
<a href="#l32.802"></a><span id="l32.802">   }</span>
<a href="#l32.803"></a><span id="l32.803" class="difflineat">@@ -874,62 +873,62 @@ function subtest_converting_filelink_to_</span>
<a href="#l32.804"></a><span id="l32.804">   close_window(cw);</span>
<a href="#l32.805"></a><span id="l32.805"> }</span>
<a href="#l32.806"></a><span id="l32.806"> </span>
<a href="#l32.807"></a><span id="l32.807"> /**</span>
<a href="#l32.808"></a><span id="l32.808">  * Tests that if the user manually removes the Filelinks from the message body</span>
<a href="#l32.809"></a><span id="l32.809">  * that it doesn't break future Filelink insertions. Tests both HTML and</span>
<a href="#l32.810"></a><span id="l32.810">  * plaintext composers.</span>
<a href="#l32.811"></a><span id="l32.811">  */</span>
<a href="#l32.812"></a><span id="l32.812" class="difflineminus">-function test_filelinks_work_after_manual_removal() {</span>
<a href="#l32.813"></a><span id="l32.813" class="difflineplus">+add_task(function test_filelinks_work_after_manual_removal() {</span>
<a href="#l32.814"></a><span id="l32.814">   try_with_plaintext_and_html_mail(subtest_filelinks_work_after_manual_removal);</span>
<a href="#l32.815"></a><span id="l32.815" class="difflineminus">-}</span>
<a href="#l32.816"></a><span id="l32.816" class="difflineplus">+});</span>
<a href="#l32.817"></a><span id="l32.817"> </span>
<a href="#l32.818"></a><span id="l32.818"> /**</span>
<a href="#l32.819"></a><span id="l32.819">  * Subtest that first adds some Filelinks to the message body, removes them,</span>
<a href="#l32.820"></a><span id="l32.820">  * and then adds another Filelink ensuring that the new URL is successfully</span>
<a href="#l32.821"></a><span id="l32.821">  * inserted.</span>
<a href="#l32.822"></a><span id="l32.822">  */</span>
<a href="#l32.823"></a><span id="l32.823"> function subtest_filelinks_work_after_manual_removal() {</span>
<a href="#l32.824"></a><span id="l32.824">   // Insert some Filelinks...</span>
<a href="#l32.825"></a><span id="l32.825" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(kFiles, __file__);</span>
<a href="#l32.826"></a><span id="l32.826" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles(kFiles);</span>
<a href="#l32.827"></a><span id="l32.827">   let provider = new MockCloudfileAccount();</span>
<a href="#l32.828"></a><span id="l32.828">   provider.init(&quot;someKey&quot;);</span>
<a href="#l32.829"></a><span id="l32.829">   let cw = open_compose_new_mail();</span>
<a href="#l32.830"></a><span id="l32.830">   add_cloud_attachments(cw, provider);</span>
<a href="#l32.831"></a><span id="l32.831"> </span>
<a href="#l32.832"></a><span id="l32.832">   let [root] = wait_for_attachment_urls(cw, kFiles.length);</span>
<a href="#l32.833"></a><span id="l32.833"> </span>
<a href="#l32.834"></a><span id="l32.834">   // Now remove the root node from the document body</span>
<a href="#l32.835"></a><span id="l32.835">   root.remove();</span>
<a href="#l32.836"></a><span id="l32.836"> </span>
<a href="#l32.837"></a><span id="l32.837" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile3&quot;], __file__);</span>
<a href="#l32.838"></a><span id="l32.838" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile3&quot;]);</span>
<a href="#l32.839"></a><span id="l32.839">   add_cloud_attachments(cw, provider);</span>
<a href="#l32.840"></a><span id="l32.840">   [root] = wait_for_attachment_urls(cw, 1);</span>
<a href="#l32.841"></a><span id="l32.841"> </span>
<a href="#l32.842"></a><span id="l32.842">   close_window(cw);</span>
<a href="#l32.843"></a><span id="l32.843"> }</span>
<a href="#l32.844"></a><span id="l32.844"> </span>
<a href="#l32.845"></a><span id="l32.845"> /**</span>
<a href="#l32.846"></a><span id="l32.846">  * Test that if the users selection caret is on a newline when the URL</span>
<a href="#l32.847"></a><span id="l32.847">  * insertion occurs, that the caret does not move when the insertion is</span>
<a href="#l32.848"></a><span id="l32.848">  * complete. Tests both HTML and plaintext composers.</span>
<a href="#l32.849"></a><span id="l32.849">  */</span>
<a href="#l32.850"></a><span id="l32.850" class="difflineminus">-function test_insertion_restores_caret_point() {</span>
<a href="#l32.851"></a><span id="l32.851" class="difflineplus">+add_task(function test_insertion_restores_caret_point() {</span>
<a href="#l32.852"></a><span id="l32.852">   try_with_plaintext_and_html_mail(subtest_insertion_restores_caret_point);</span>
<a href="#l32.853"></a><span id="l32.853" class="difflineminus">-}</span>
<a href="#l32.854"></a><span id="l32.854" class="difflineplus">+});</span>
<a href="#l32.855"></a><span id="l32.855"> </span>
<a href="#l32.856"></a><span id="l32.856"> /**</span>
<a href="#l32.857"></a><span id="l32.857">  * Subtest that types some things into the composer, finishes on two</span>
<a href="#l32.858"></a><span id="l32.858">  * linebreaks, inserts some Filelink URLs, and then types some more,</span>
<a href="#l32.859"></a><span id="l32.859">  * ensuring that the selection is where we expect it to be.</span>
<a href="#l32.860"></a><span id="l32.860">  */</span>
<a href="#l32.861"></a><span id="l32.861"> function subtest_insertion_restores_caret_point() {</span>
<a href="#l32.862"></a><span id="l32.862">   // Insert some Filelinks...</span>
<a href="#l32.863"></a><span id="l32.863" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(kFiles, __file__);</span>
<a href="#l32.864"></a><span id="l32.864" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles(kFiles);</span>
<a href="#l32.865"></a><span id="l32.865">   let provider = new MockCloudfileAccount();</span>
<a href="#l32.866"></a><span id="l32.866">   provider.init(&quot;someKey&quot;);</span>
<a href="#l32.867"></a><span id="l32.867"> </span>
<a href="#l32.868"></a><span id="l32.868">   let cw = open_compose_new_mail();</span>
<a href="#l32.869"></a><span id="l32.869"> </span>
<a href="#l32.870"></a><span id="l32.870">   // Put the selection at the beginning of the document...</span>
<a href="#l32.871"></a><span id="l32.871">   let editor = cw.window.GetCurrentEditor();</span>
<a href="#l32.872"></a><span id="l32.872">   editor.beginningOfDocument();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1">copy from mail/test/mozmill/cloudfile/test-cloudfile-manager.js</span>
<a href="#l33.2"></a><span id="l33.2">copy to mail/test/browser/cloudfile/browser_manager.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-manager.js</span>
<a href="#l33.4"></a><span id="l33.4" class="difflineplus">+++ b/mail/test/browser/cloudfile/browser_manager.js</span>
<a href="#l33.5"></a><span id="l33.5" class="difflineat">@@ -4,56 +4,74 @@</span>
<a href="#l33.6"></a><span id="l33.6"> </span>
<a href="#l33.7"></a><span id="l33.7"> /**</span>
<a href="#l33.8"></a><span id="l33.8">  * Tests the richlistbox in the manager for attachment storage</span>
<a href="#l33.9"></a><span id="l33.9">  * services</span>
<a href="#l33.10"></a><span id="l33.10">  */</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12"> &quot;use strict&quot;;</span>
<a href="#l33.13"></a><span id="l33.13"> </span>
<a href="#l33.14"></a><span id="l33.14" class="difflineplus">+var elementslib = ChromeUtils.import(</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+);</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+var mozmill = ChromeUtils.import(</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+  &quot;resource://testing-common/mozmill/mozmill.jsm&quot;</span>
<a href="#l33.19"></a><span id="l33.19" class="difflineplus">+);</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineplus">+</span>
<a href="#l33.21"></a><span id="l33.21"> var { gMockCloudfileManager } = ChromeUtils.import(</span>
<a href="#l33.22"></a><span id="l33.22">   &quot;resource://testing-common/mozmill/CloudfileHelpers.jsm&quot;</span>
<a href="#l33.23"></a><span id="l33.23"> );</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineminus">-var { content_tab_e, gMockExtProtSvc, gMockExtProtSvcReg } = ChromeUtils.import(</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+var {</span>
<a href="#l33.26"></a><span id="l33.26" class="difflineplus">+  content_tab_e,</span>
<a href="#l33.27"></a><span id="l33.27" class="difflineplus">+  content_tab_eid,</span>
<a href="#l33.28"></a><span id="l33.28" class="difflineplus">+  gMockExtProtSvc,</span>
<a href="#l33.29"></a><span id="l33.29" class="difflineplus">+  gMockExtProtSvcReg,</span>
<a href="#l33.30"></a><span id="l33.30" class="difflineplus">+} = ChromeUtils.import(</span>
<a href="#l33.31"></a><span id="l33.31">   &quot;resource://testing-common/mozmill/ContentTabHelpers.jsm&quot;</span>
<a href="#l33.32"></a><span id="l33.32"> );</span>
<a href="#l33.33"></a><span id="l33.33" class="difflineminus">-var { assert_equals, mc } = ChromeUtils.import(</span>
<a href="#l33.34"></a><span id="l33.34" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l33.35"></a><span id="l33.35">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l33.36"></a><span id="l33.36"> );</span>
<a href="#l33.37"></a><span id="l33.37"> var { close_pref_tab, open_pref_tab } = ChromeUtils.import(</span>
<a href="#l33.38"></a><span id="l33.38">   &quot;resource://testing-common/mozmill/PrefTabHelpers.jsm&quot;</span>
<a href="#l33.39"></a><span id="l33.39"> );</span>
<a href="#l33.40"></a><span id="l33.40"> var { wait_for_frame_load } = ChromeUtils.import(</span>
<a href="#l33.41"></a><span id="l33.41">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l33.42"></a><span id="l33.42"> );</span>
<a href="#l33.43"></a><span id="l33.43"> </span>
<a href="#l33.44"></a><span id="l33.44"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l33.45"></a><span id="l33.45"> </span>
<a href="#l33.46"></a><span id="l33.46" class="difflineplus">+var controller = mozmill.getMail3PaneController();</span>
<a href="#l33.47"></a><span id="l33.47"> var kTestAccountType = &quot;mock&quot;;</span>
<a href="#l33.48"></a><span id="l33.48" class="difflineminus">-var kRootURL = collector.addHttpResource(&quot;../cloudfile/html&quot;, &quot;&quot;);</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineminus">-var kSettingsWithLink = kRootURL + &quot;settings-with-link.xhtml&quot;;</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+var kSettingsWithLink =</span>
<a href="#l33.51"></a><span id="l33.51" class="difflineplus">+  &quot;chrome://mochitests/content/browser/comm/mail/test/browser/cloudfile/html/settings-with-link.xhtml&quot;;</span>
<a href="#l33.52"></a><span id="l33.52"> </span>
<a href="#l33.53"></a><span id="l33.53" class="difflineminus">-function setupModule(module) {</span>
<a href="#l33.54"></a><span id="l33.54" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l33.55"></a><span id="l33.55">   gMockCloudfileManager.register(kTestAccountType, {</span>
<a href="#l33.56"></a><span id="l33.56">     managementURL: kSettingsWithLink,</span>
<a href="#l33.57"></a><span id="l33.57">   });</span>
<a href="#l33.58"></a><span id="l33.58"> </span>
<a href="#l33.59"></a><span id="l33.59">   // Let's set up a few dummy accounts;</span>
<a href="#l33.60"></a><span id="l33.60">   create_dummy_account(&quot;someKey1&quot;, kTestAccountType, &quot;carl's Account&quot;);</span>
<a href="#l33.61"></a><span id="l33.61">   create_dummy_account(&quot;someKey2&quot;, kTestAccountType, &quot;Amber's Account&quot;);</span>
<a href="#l33.62"></a><span id="l33.62">   create_dummy_account(&quot;someKey3&quot;, kTestAccountType, &quot;alice's Account&quot;);</span>
<a href="#l33.63"></a><span id="l33.63">   create_dummy_account(&quot;someKey4&quot;, kTestAccountType, &quot;Bob's Account&quot;);</span>
<a href="#l33.64"></a><span id="l33.64" class="difflineminus">-}</span>
<a href="#l33.65"></a><span id="l33.65" class="difflineplus">+});</span>
<a href="#l33.66"></a><span id="l33.66"> </span>
<a href="#l33.67"></a><span id="l33.67" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l33.69"></a><span id="l33.69">   Services.prefs</span>
<a href="#l33.70"></a><span id="l33.70">     .QueryInterface(Ci.nsIPrefBranch)</span>
<a href="#l33.71"></a><span id="l33.71">     .deleteBranch(&quot;mail.cloud_files.accounts&quot;);</span>
<a href="#l33.72"></a><span id="l33.72">   gMockCloudfileManager.unregister(kTestAccountType);</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineminus">-}</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineplus">+  let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineplus">+  if (tabmail.tabModes.preferencesTab.tabs.length == 1) {</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+    tabmail.closeTab(tabmail.tabModes.preferencesTab.tabs[0]);</span>
<a href="#l33.78"></a><span id="l33.78" class="difflineplus">+  }</span>
<a href="#l33.79"></a><span id="l33.79" class="difflineplus">+});</span>
<a href="#l33.80"></a><span id="l33.80"> </span>
<a href="#l33.81"></a><span id="l33.81"> function create_dummy_account(aKey, aType, aDisplayName) {</span>
<a href="#l33.82"></a><span id="l33.82">   Services.prefs.setCharPref(</span>
<a href="#l33.83"></a><span id="l33.83">     &quot;mail.cloud_files.accounts.&quot; + aKey + &quot;.type&quot;,</span>
<a href="#l33.84"></a><span id="l33.84">     aType</span>
<a href="#l33.85"></a><span id="l33.85">   );</span>
<a href="#l33.86"></a><span id="l33.86"> </span>
<a href="#l33.87"></a><span id="l33.87">   Services.prefs.setCharPref(</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineat">@@ -66,54 +84,60 @@ function destroy_account(aKey) {</span>
<a href="#l33.89"></a><span id="l33.89">   Services.prefs.clearUserPref(&quot;mail.cloud_files.accounts.&quot; + aKey);</span>
<a href="#l33.90"></a><span id="l33.90"> }</span>
<a href="#l33.91"></a><span id="l33.91"> </span>
<a href="#l33.92"></a><span id="l33.92"> /**</span>
<a href="#l33.93"></a><span id="l33.93">  * Tests that we load the accounts and display them in the</span>
<a href="#l33.94"></a><span id="l33.94">  * account richlistbox in the correct order (by displayName,</span>
<a href="#l33.95"></a><span id="l33.95">  * case-insensitive)</span>
<a href="#l33.96"></a><span id="l33.96">  */</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineminus">-function test_load_accounts_and_properly_order() {</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineminus">-  let prefTab = open_pref_tab(&quot;paneCompose&quot;);</span>
<a href="#l33.99"></a><span id="l33.99" class="difflineplus">+add_task(function test_load_accounts_and_properly_order() {</span>
<a href="#l33.100"></a><span id="l33.100" class="difflineplus">+  let prefTab = open_pref_tab(&quot;paneCompose&quot;, &quot;compositionAttachmentsCategory&quot;);</span>
<a href="#l33.101"></a><span id="l33.101" class="difflineplus">+  mc.sleep();</span>
<a href="#l33.102"></a><span id="l33.102"> </span>
<a href="#l33.103"></a><span id="l33.103">   let richList = content_tab_e(prefTab, &quot;cloudFileView&quot;);</span>
<a href="#l33.104"></a><span id="l33.104" class="difflineminus">-  assert_equals(4, richList.itemCount, &quot;Should be displaying 4 accounts&quot;);</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineplus">+  Assert.equal(4, richList.itemCount, &quot;Should be displaying 4 accounts&quot;);</span>
<a href="#l33.106"></a><span id="l33.106"> </span>
<a href="#l33.107"></a><span id="l33.107">   // Since we're sorting alphabetically by the displayName,</span>
<a href="#l33.108"></a><span id="l33.108">   // case-insensitive, the items should be ordered with the</span>
<a href="#l33.109"></a><span id="l33.109">   // following accountKeys:</span>
<a href="#l33.110"></a><span id="l33.110">   //</span>
<a href="#l33.111"></a><span id="l33.111">   // someKey3, someKey2, someKey4, someKey1</span>
<a href="#l33.112"></a><span id="l33.112">   const kExpected = [&quot;someKey3&quot;, &quot;someKey2&quot;, &quot;someKey4&quot;, &quot;someKey1&quot;];</span>
<a href="#l33.113"></a><span id="l33.113"> </span>
<a href="#l33.114"></a><span id="l33.114">   for (let [index, expectedKey] of kExpected.entries()) {</span>
<a href="#l33.115"></a><span id="l33.115">     let item = richList.getItemAtIndex(index);</span>
<a href="#l33.116"></a><span id="l33.116" class="difflineminus">-    assert_equals(expectedKey, item.value, &quot;The account list is out of order&quot;);</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineplus">+    Assert.equal(expectedKey, item.value, &quot;The account list is out of order&quot;);</span>
<a href="#l33.118"></a><span id="l33.118">   }</span>
<a href="#l33.119"></a><span id="l33.119"> </span>
<a href="#l33.120"></a><span id="l33.120">   close_pref_tab(prefTab);</span>
<a href="#l33.121"></a><span id="l33.121" class="difflineminus">-}</span>
<a href="#l33.122"></a><span id="l33.122" class="difflineplus">+});</span>
<a href="#l33.123"></a><span id="l33.123"> </span>
<a href="#l33.124"></a><span id="l33.124"> /**</span>
<a href="#l33.125"></a><span id="l33.125">  * Tests that a link in the management pane is loaded in</span>
<a href="#l33.126"></a><span id="l33.126">  * a browser and not in the management pane.</span>
<a href="#l33.127"></a><span id="l33.127">  */</span>
<a href="#l33.128"></a><span id="l33.128" class="difflineminus">-test_external_link.__force_skip__ = true;</span>
<a href="#l33.129"></a><span id="l33.129" class="difflineminus">-function test_external_link() {</span>
<a href="#l33.130"></a><span id="l33.130" class="difflineplus">+add_task(function test_external_link() {</span>
<a href="#l33.131"></a><span id="l33.131">   gMockExtProtSvcReg.register();</span>
<a href="#l33.132"></a><span id="l33.132"> </span>
<a href="#l33.133"></a><span id="l33.133" class="difflineminus">-  let prefTab = open_pref_tab(&quot;paneCompose&quot;);</span>
<a href="#l33.134"></a><span id="l33.134" class="difflineminus">-  content_tab_e(prefTab, &quot;cloudFileView&quot;).selectedIndex = 0;</span>
<a href="#l33.135"></a><span id="l33.135" class="difflineplus">+  let prefTab = open_pref_tab(&quot;paneCompose&quot;, &quot;compositionAttachmentsCategory&quot;);</span>
<a href="#l33.136"></a><span id="l33.136" class="difflineplus">+  mc.sleep();</span>
<a href="#l33.137"></a><span id="l33.137" class="difflineplus">+  mc.click(content_tab_eid(prefTab, &quot;cloudFileView&quot;));</span>
<a href="#l33.138"></a><span id="l33.138" class="difflineplus">+  mc.click(content_tab_eid(prefTab, &quot;cloudFileView&quot;), 5, 5);</span>
<a href="#l33.139"></a><span id="l33.139"> </span>
<a href="#l33.140"></a><span id="l33.140" class="difflineminus">-  let iframe = content_tab_e(prefTab, &quot;cloudFileSettingsWrapper&quot;)</span>
<a href="#l33.141"></a><span id="l33.141" class="difflineminus">-    .firstElementChild;</span>
<a href="#l33.142"></a><span id="l33.142" class="difflineplus">+  let iframe;</span>
<a href="#l33.143"></a><span id="l33.143" class="difflineplus">+  mc.waitFor(() =&gt; {</span>
<a href="#l33.144"></a><span id="l33.144" class="difflineplus">+    iframe = content_tab_e(prefTab, &quot;cloudFileSettingsWrapper&quot;)</span>
<a href="#l33.145"></a><span id="l33.145" class="difflineplus">+      .firstElementChild;</span>
<a href="#l33.146"></a><span id="l33.146" class="difflineplus">+    return !!iframe;</span>
<a href="#l33.147"></a><span id="l33.147" class="difflineplus">+  });</span>
<a href="#l33.148"></a><span id="l33.148">   wait_for_frame_load(iframe, kSettingsWithLink + &quot;?accountId=someKey3&quot;);</span>
<a href="#l33.149"></a><span id="l33.149">   mc.click(new elementslib.ID(iframe.contentDocument, &quot;a&quot;));</span>
<a href="#l33.150"></a><span id="l33.150"> </span>
<a href="#l33.151"></a><span id="l33.151">   let targetHref = &quot;https://www.example.com/&quot;;</span>
<a href="#l33.152"></a><span id="l33.152">   mc.waitFor(</span>
<a href="#l33.153"></a><span id="l33.153">     () =&gt; gMockExtProtSvc.urlLoaded(targetHref),</span>
<a href="#l33.154"></a><span id="l33.154">     `Timed out waiting for the link ${targetHref} to be opened in the default browser.`</span>
<a href="#l33.155"></a><span id="l33.155">   );</span>
<a href="#l33.156"></a><span id="l33.156">   close_pref_tab(prefTab);</span>
<a href="#l33.157"></a><span id="l33.157"> </span>
<a href="#l33.158"></a><span id="l33.158">   gMockExtProtSvcReg.unregister();</span>
<a href="#l33.159"></a><span id="l33.159" class="difflineminus">-}</span>
<a href="#l33.160"></a><span id="l33.160" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1">copy from mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</span>
<a href="#l34.2"></a><span id="l34.2">copy to mail/test/browser/cloudfile/browser_notifications.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</span>
<a href="#l34.4"></a><span id="l34.4" class="difflineplus">+++ b/mail/test/browser/cloudfile/browser_notifications.js</span>
<a href="#l34.5"></a><span id="l34.5" class="difflineat">@@ -10,75 +10,77 @@</span>
<a href="#l34.6"></a><span id="l34.6"> </span>
<a href="#l34.7"></a><span id="l34.7"> var {</span>
<a href="#l34.8"></a><span id="l34.8">   gMockFilePicker,</span>
<a href="#l34.9"></a><span id="l34.9">   gMockFilePickReg,</span>
<a href="#l34.10"></a><span id="l34.10">   select_attachments,</span>
<a href="#l34.11"></a><span id="l34.11"> } = ChromeUtils.import(</span>
<a href="#l34.12"></a><span id="l34.12">   &quot;resource://testing-common/mozmill/AttachmentHelpers.jsm&quot;</span>
<a href="#l34.13"></a><span id="l34.13"> );</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineminus">-var {</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineminus">-  collectFiles,</span>
<a href="#l34.16"></a><span id="l34.16" class="difflineminus">-  gMockCloudfileManager,</span>
<a href="#l34.17"></a><span id="l34.17" class="difflineminus">-  MockCloudfileAccount,</span>
<a href="#l34.18"></a><span id="l34.18" class="difflineminus">-} = ChromeUtils.import(</span>
<a href="#l34.19"></a><span id="l34.19" class="difflineplus">+var { gMockCloudfileManager, MockCloudfileAccount } = ChromeUtils.import(</span>
<a href="#l34.20"></a><span id="l34.20">   &quot;resource://testing-common/mozmill/CloudfileHelpers.jsm&quot;</span>
<a href="#l34.21"></a><span id="l34.21"> );</span>
<a href="#l34.22"></a><span id="l34.22"> var {</span>
<a href="#l34.23"></a><span id="l34.23">   add_attachments,</span>
<a href="#l34.24"></a><span id="l34.24">   add_cloud_attachments,</span>
<a href="#l34.25"></a><span id="l34.25">   close_compose_window,</span>
<a href="#l34.26"></a><span id="l34.26">   open_compose_new_mail,</span>
<a href="#l34.27"></a><span id="l34.27"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l34.28"></a><span id="l34.28"> var { mc } = ChromeUtils.import(</span>
<a href="#l34.29"></a><span id="l34.29">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l34.30"></a><span id="l34.30"> );</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+var mozmill = ChromeUtils.import(</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+  &quot;resource://testing-common/mozmill/mozmill.jsm&quot;</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineplus">+);</span>
<a href="#l34.34"></a><span id="l34.34"> var {</span>
<a href="#l34.35"></a><span id="l34.35">   assert_notification_displayed,</span>
<a href="#l34.36"></a><span id="l34.36">   close_notification,</span>
<a href="#l34.37"></a><span id="l34.37">   wait_for_notification_to_stop,</span>
<a href="#l34.38"></a><span id="l34.38"> } = ChromeUtils.import(</span>
<a href="#l34.39"></a><span id="l34.39">   &quot;resource://testing-common/mozmill/NotificationBoxHelpers.jsm&quot;</span>
<a href="#l34.40"></a><span id="l34.40"> );</span>
<a href="#l34.41"></a><span id="l34.41"> var { gMockPromptService } = ChromeUtils.import(</span>
<a href="#l34.42"></a><span id="l34.42">   &quot;resource://testing-common/mozmill/PromptHelpers.jsm&quot;</span>
<a href="#l34.43"></a><span id="l34.43"> );</span>
<a href="#l34.44"></a><span id="l34.44"> </span>
<a href="#l34.45"></a><span id="l34.45"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l34.46"></a><span id="l34.46"> var { cloudFileAccounts } = ChromeUtils.import(</span>
<a href="#l34.47"></a><span id="l34.47">   &quot;resource:///modules/cloudFileAccounts.jsm&quot;</span>
<a href="#l34.48"></a><span id="l34.48"> );</span>
<a href="#l34.49"></a><span id="l34.49"> </span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+var controller = mozmill.getMail3PaneController();</span>
<a href="#l34.51"></a><span id="l34.51"> var maxSize, oldInsertNotificationPref;</span>
<a href="#l34.52"></a><span id="l34.52"> </span>
<a href="#l34.53"></a><span id="l34.53"> var kOfferThreshold = &quot;mail.compose.big_attachments.threshold_kb&quot;;</span>
<a href="#l34.54"></a><span id="l34.54"> var kInsertNotificationPref =</span>
<a href="#l34.55"></a><span id="l34.55">   &quot;mail.compose.big_attachments.insert_notification&quot;;</span>
<a href="#l34.56"></a><span id="l34.56"> </span>
<a href="#l34.57"></a><span id="l34.57"> var kBoxId = &quot;compose-notification-bottom&quot;;</span>
<a href="#l34.58"></a><span id="l34.58"> </span>
<a href="#l34.59"></a><span id="l34.59" class="difflineminus">-function setupModule(module) {</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l34.61"></a><span id="l34.61" class="difflineplus">+  requestLongerTimeout(2);</span>
<a href="#l34.62"></a><span id="l34.62" class="difflineplus">+</span>
<a href="#l34.63"></a><span id="l34.63">   gMockCloudfileManager.register();</span>
<a href="#l34.64"></a><span id="l34.64">   gMockFilePickReg.register();</span>
<a href="#l34.65"></a><span id="l34.65"> </span>
<a href="#l34.66"></a><span id="l34.66">   maxSize = Services.prefs.getIntPref(kOfferThreshold, 0) * 1024;</span>
<a href="#l34.67"></a><span id="l34.67">   oldInsertNotificationPref = Services.prefs.getBoolPref(</span>
<a href="#l34.68"></a><span id="l34.68">     kInsertNotificationPref</span>
<a href="#l34.69"></a><span id="l34.69">   );</span>
<a href="#l34.70"></a><span id="l34.70">   Services.prefs.setBoolPref(kInsertNotificationPref, true);</span>
<a href="#l34.71"></a><span id="l34.71" class="difflineminus">-}</span>
<a href="#l34.72"></a><span id="l34.72" class="difflineplus">+});</span>
<a href="#l34.73"></a><span id="l34.73"> </span>
<a href="#l34.74"></a><span id="l34.74" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l34.76"></a><span id="l34.76">   gMockCloudfileManager.unregister();</span>
<a href="#l34.77"></a><span id="l34.77">   gMockFilePickReg.unregister();</span>
<a href="#l34.78"></a><span id="l34.78">   Services.prefs.setBoolPref(</span>
<a href="#l34.79"></a><span id="l34.79">     kInsertNotificationPref,</span>
<a href="#l34.80"></a><span id="l34.80">     oldInsertNotificationPref</span>
<a href="#l34.81"></a><span id="l34.81">   );</span>
<a href="#l34.82"></a><span id="l34.82" class="difflineminus">-}</span>
<a href="#l34.83"></a><span id="l34.83" class="difflineplus">+});</span>
<a href="#l34.84"></a><span id="l34.84"> </span>
<a href="#l34.85"></a><span id="l34.85"> /**</span>
<a href="#l34.86"></a><span id="l34.86">  * A helper function to assert that the Filelink offer notification is</span>
<a href="#l34.87"></a><span id="l34.87">  * either displayed or not displayed.</span>
<a href="#l34.88"></a><span id="l34.88">  *</span>
<a href="#l34.89"></a><span id="l34.89">  * @param aController the controller of the compose window to check.</span>
<a href="#l34.90"></a><span id="l34.90">  * @param aDisplayed true if the notification should be displayed, false</span>
<a href="#l34.91"></a><span id="l34.91">  *                   otherwise.</span>
<a href="#l34.92"></a><span id="l34.92" class="difflineat">@@ -138,65 +140,65 @@ function close_upload_notification(aCont</span>
<a href="#l34.93"></a><span id="l34.93"> </span>
<a href="#l34.94"></a><span id="l34.94"> /**</span>
<a href="#l34.95"></a><span id="l34.95">  * A helper function to close the Filelink privacy warning notification.</span>
<a href="#l34.96"></a><span id="l34.96">  */</span>
<a href="#l34.97"></a><span id="l34.97"> function close_privacy_warning_notification(aController) {</span>
<a href="#l34.98"></a><span id="l34.98">   close_notification(aController, kBoxId, &quot;bigAttachmentPrivacyWarning&quot;);</span>
<a href="#l34.99"></a><span id="l34.99"> }</span>
<a href="#l34.100"></a><span id="l34.100"> </span>
<a href="#l34.101"></a><span id="l34.101" class="difflineminus">-function test_no_notification_for_small_file() {</span>
<a href="#l34.102"></a><span id="l34.102" class="difflineplus">+add_task(function test_no_notification_for_small_file() {</span>
<a href="#l34.103"></a><span id="l34.103">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l34.104"></a><span id="l34.104">   add_attachments(cwc, &quot;http://www.example.com/1&quot;, 0);</span>
<a href="#l34.105"></a><span id="l34.105">   assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l34.106"></a><span id="l34.106"> </span>
<a href="#l34.107"></a><span id="l34.107">   add_attachments(cwc, &quot;http://www.example.com/2&quot;, 1);</span>
<a href="#l34.108"></a><span id="l34.108">   assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l34.109"></a><span id="l34.109"> </span>
<a href="#l34.110"></a><span id="l34.110">   add_attachments(cwc, &quot;http://www.example.com/3&quot;, 100);</span>
<a href="#l34.111"></a><span id="l34.111">   assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l34.112"></a><span id="l34.112"> </span>
<a href="#l34.113"></a><span id="l34.113">   add_attachments(cwc, &quot;http://www.example.com/4&quot;, 500);</span>
<a href="#l34.114"></a><span id="l34.114">   assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l34.115"></a><span id="l34.115"> </span>
<a href="#l34.116"></a><span id="l34.116">   close_compose_window(cwc);</span>
<a href="#l34.117"></a><span id="l34.117" class="difflineminus">-}</span>
<a href="#l34.118"></a><span id="l34.118" class="difflineplus">+});</span>
<a href="#l34.119"></a><span id="l34.119"> </span>
<a href="#l34.120"></a><span id="l34.120" class="difflineminus">-function test_notification_for_big_files() {</span>
<a href="#l34.121"></a><span id="l34.121" class="difflineplus">+add_task(function test_notification_for_big_files() {</span>
<a href="#l34.122"></a><span id="l34.122">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l34.123"></a><span id="l34.123">   add_attachments(cwc, &quot;http://www.example.com/1&quot;, maxSize);</span>
<a href="#l34.124"></a><span id="l34.124">   assert_cloudfile_notification_displayed(cwc, true);</span>
<a href="#l34.125"></a><span id="l34.125"> </span>
<a href="#l34.126"></a><span id="l34.126">   add_attachments(cwc, &quot;http://www.example.com/2&quot;, maxSize + 1000);</span>
<a href="#l34.127"></a><span id="l34.127">   assert_cloudfile_notification_displayed(cwc, true);</span>
<a href="#l34.128"></a><span id="l34.128"> </span>
<a href="#l34.129"></a><span id="l34.129">   add_attachments(cwc, &quot;http://www.example.com/3&quot;, maxSize + 10000);</span>
<a href="#l34.130"></a><span id="l34.130">   assert_cloudfile_notification_displayed(cwc, true);</span>
<a href="#l34.131"></a><span id="l34.131"> </span>
<a href="#l34.132"></a><span id="l34.132">   add_attachments(cwc, &quot;http://www.example.com/4&quot;, maxSize + 100000);</span>
<a href="#l34.133"></a><span id="l34.133">   assert_cloudfile_notification_displayed(cwc, true);</span>
<a href="#l34.134"></a><span id="l34.134"> </span>
<a href="#l34.135"></a><span id="l34.135">   close_compose_window(cwc);</span>
<a href="#l34.136"></a><span id="l34.136" class="difflineminus">-}</span>
<a href="#l34.137"></a><span id="l34.137" class="difflineplus">+});</span>
<a href="#l34.138"></a><span id="l34.138"> </span>
<a href="#l34.139"></a><span id="l34.139" class="difflineminus">-function test_graduate_to_notification() {</span>
<a href="#l34.140"></a><span id="l34.140" class="difflineplus">+add_task(function test_graduate_to_notification() {</span>
<a href="#l34.141"></a><span id="l34.141">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l34.142"></a><span id="l34.142">   add_attachments(cwc, &quot;http://www.example.com/1&quot;, maxSize - 100);</span>
<a href="#l34.143"></a><span id="l34.143">   assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l34.144"></a><span id="l34.144"> </span>
<a href="#l34.145"></a><span id="l34.145">   add_attachments(cwc, &quot;http://www.example.com/2&quot;, maxSize - 25);</span>
<a href="#l34.146"></a><span id="l34.146">   assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l34.147"></a><span id="l34.147"> </span>
<a href="#l34.148"></a><span id="l34.148">   add_attachments(cwc, &quot;http://www.example.com/3&quot;, maxSize);</span>
<a href="#l34.149"></a><span id="l34.149">   assert_cloudfile_notification_displayed(cwc, true);</span>
<a href="#l34.150"></a><span id="l34.150"> </span>
<a href="#l34.151"></a><span id="l34.151">   close_compose_window(cwc);</span>
<a href="#l34.152"></a><span id="l34.152" class="difflineminus">-}</span>
<a href="#l34.153"></a><span id="l34.153" class="difflineplus">+});</span>
<a href="#l34.154"></a><span id="l34.154"> </span>
<a href="#l34.155"></a><span id="l34.155" class="difflineminus">-function test_no_notification_if_disabled() {</span>
<a href="#l34.156"></a><span id="l34.156" class="difflineplus">+add_task(function test_no_notification_if_disabled() {</span>
<a href="#l34.157"></a><span id="l34.157">   Services.prefs.setBoolPref(&quot;mail.cloud_files.enabled&quot;, false);</span>
<a href="#l34.158"></a><span id="l34.158">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l34.159"></a><span id="l34.159"> </span>
<a href="#l34.160"></a><span id="l34.160">   add_attachments(cwc, &quot;http://www.example.com/1&quot;, maxSize);</span>
<a href="#l34.161"></a><span id="l34.161">   assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l34.162"></a><span id="l34.162"> </span>
<a href="#l34.163"></a><span id="l34.163">   add_attachments(cwc, &quot;http://www.example.com/2&quot;, maxSize + 1000);</span>
<a href="#l34.164"></a><span id="l34.164">   assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l34.165"></a><span id="l34.165" class="difflineat">@@ -204,85 +206,85 @@ function test_no_notification_if_disable</span>
<a href="#l34.166"></a><span id="l34.166">   add_attachments(cwc, &quot;http://www.example.com/3&quot;, maxSize + 10000);</span>
<a href="#l34.167"></a><span id="l34.167">   assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l34.168"></a><span id="l34.168"> </span>
<a href="#l34.169"></a><span id="l34.169">   add_attachments(cwc, &quot;http://www.example.com/4&quot;, maxSize + 100000);</span>
<a href="#l34.170"></a><span id="l34.170">   assert_cloudfile_notification_displayed(cwc, false);</span>
<a href="#l34.171"></a><span id="l34.171"> </span>
<a href="#l34.172"></a><span id="l34.172">   close_compose_window(cwc);</span>
<a href="#l34.173"></a><span id="l34.173">   Services.prefs.setBoolPref(&quot;mail.cloud_files.enabled&quot;, true);</span>
<a href="#l34.174"></a><span id="l34.174" class="difflineminus">-}</span>
<a href="#l34.175"></a><span id="l34.175" class="difflineplus">+});</span>
<a href="#l34.176"></a><span id="l34.176"> </span>
<a href="#l34.177"></a><span id="l34.177"> /**</span>
<a href="#l34.178"></a><span id="l34.178">  * Tests that if we upload a single file, we get the link insertion</span>
<a href="#l34.179"></a><span id="l34.179">  * notification bar displayed (unless preffed off).</span>
<a href="#l34.180"></a><span id="l34.180">  */</span>
<a href="#l34.181"></a><span id="l34.181" class="difflineminus">-function test_link_insertion_notification_single() {</span>
<a href="#l34.182"></a><span id="l34.182" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile1&quot;], __file__);</span>
<a href="#l34.183"></a><span id="l34.183" class="difflineplus">+add_task(function test_link_insertion_notification_single() {</span>
<a href="#l34.184"></a><span id="l34.184" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile1&quot;]);</span>
<a href="#l34.185"></a><span id="l34.185">   let provider = new MockCloudfileAccount();</span>
<a href="#l34.186"></a><span id="l34.186">   provider.init(&quot;aKey&quot;);</span>
<a href="#l34.187"></a><span id="l34.187"> </span>
<a href="#l34.188"></a><span id="l34.188">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l34.189"></a><span id="l34.189">   add_cloud_attachments(cwc, provider);</span>
<a href="#l34.190"></a><span id="l34.190"> </span>
<a href="#l34.191"></a><span id="l34.191">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l34.192"></a><span id="l34.192">   close_upload_notification(cwc);</span>
<a href="#l34.193"></a><span id="l34.193"> </span>
<a href="#l34.194"></a><span id="l34.194">   Services.prefs.setBoolPref(kInsertNotificationPref, false);</span>
<a href="#l34.195"></a><span id="l34.195" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile2&quot;], __file__);</span>
<a href="#l34.196"></a><span id="l34.196" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile2&quot;]);</span>
<a href="#l34.197"></a><span id="l34.197">   add_cloud_attachments(cwc, provider);</span>
<a href="#l34.198"></a><span id="l34.198"> </span>
<a href="#l34.199"></a><span id="l34.199">   assert_upload_notification_displayed(cwc, false);</span>
<a href="#l34.200"></a><span id="l34.200">   Services.prefs.setBoolPref(kInsertNotificationPref, true);</span>
<a href="#l34.201"></a><span id="l34.201"> </span>
<a href="#l34.202"></a><span id="l34.202">   close_compose_window(cwc);</span>
<a href="#l34.203"></a><span id="l34.203" class="difflineminus">-}</span>
<a href="#l34.204"></a><span id="l34.204" class="difflineplus">+});</span>
<a href="#l34.205"></a><span id="l34.205"> </span>
<a href="#l34.206"></a><span id="l34.206"> /**</span>
<a href="#l34.207"></a><span id="l34.207">  * Tests that if we upload multiple files, we get the link insertion</span>
<a href="#l34.208"></a><span id="l34.208">  * notification bar displayed (unless preffed off).</span>
<a href="#l34.209"></a><span id="l34.209">  */</span>
<a href="#l34.210"></a><span id="l34.210" class="difflineminus">-function test_link_insertion_notification_multiple() {</span>
<a href="#l34.211"></a><span id="l34.211" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(</span>
<a href="#l34.212"></a><span id="l34.212" class="difflineminus">-    [&quot;./data/testFile1&quot;, &quot;./data/testFile2&quot;],</span>
<a href="#l34.213"></a><span id="l34.213" class="difflineminus">-    __file__</span>
<a href="#l34.214"></a><span id="l34.214" class="difflineminus">-  );</span>
<a href="#l34.215"></a><span id="l34.215" class="difflineplus">+add_task(function test_link_insertion_notification_multiple() {</span>
<a href="#l34.216"></a><span id="l34.216" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([</span>
<a href="#l34.217"></a><span id="l34.217" class="difflineplus">+    &quot;./data/testFile1&quot;,</span>
<a href="#l34.218"></a><span id="l34.218" class="difflineplus">+    &quot;./data/testFile2&quot;,</span>
<a href="#l34.219"></a><span id="l34.219" class="difflineplus">+  ]);</span>
<a href="#l34.220"></a><span id="l34.220">   let provider = new MockCloudfileAccount();</span>
<a href="#l34.221"></a><span id="l34.221">   provider.init(&quot;aKey&quot;);</span>
<a href="#l34.222"></a><span id="l34.222"> </span>
<a href="#l34.223"></a><span id="l34.223">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l34.224"></a><span id="l34.224">   add_cloud_attachments(cwc, provider);</span>
<a href="#l34.225"></a><span id="l34.225"> </span>
<a href="#l34.226"></a><span id="l34.226">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l34.227"></a><span id="l34.227">   close_upload_notification(cwc);</span>
<a href="#l34.228"></a><span id="l34.228"> </span>
<a href="#l34.229"></a><span id="l34.229">   Services.prefs.setBoolPref(kInsertNotificationPref, false);</span>
<a href="#l34.230"></a><span id="l34.230" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(</span>
<a href="#l34.231"></a><span id="l34.231" class="difflineminus">-    [&quot;./data/testFile3&quot;, &quot;./data/testFile4&quot;],</span>
<a href="#l34.232"></a><span id="l34.232" class="difflineminus">-    __file__</span>
<a href="#l34.233"></a><span id="l34.233" class="difflineminus">-  );</span>
<a href="#l34.234"></a><span id="l34.234" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([</span>
<a href="#l34.235"></a><span id="l34.235" class="difflineplus">+    &quot;./data/testFile3&quot;,</span>
<a href="#l34.236"></a><span id="l34.236" class="difflineplus">+    &quot;./data/testFile4&quot;,</span>
<a href="#l34.237"></a><span id="l34.237" class="difflineplus">+  ]);</span>
<a href="#l34.238"></a><span id="l34.238">   add_cloud_attachments(cwc, provider);</span>
<a href="#l34.239"></a><span id="l34.239"> </span>
<a href="#l34.240"></a><span id="l34.240">   assert_upload_notification_displayed(cwc, false);</span>
<a href="#l34.241"></a><span id="l34.241">   Services.prefs.setBoolPref(kInsertNotificationPref, true);</span>
<a href="#l34.242"></a><span id="l34.242"> </span>
<a href="#l34.243"></a><span id="l34.243">   close_compose_window(cwc);</span>
<a href="#l34.244"></a><span id="l34.244" class="difflineminus">-}</span>
<a href="#l34.245"></a><span id="l34.245" class="difflineplus">+});</span>
<a href="#l34.246"></a><span id="l34.246"> </span>
<a href="#l34.247"></a><span id="l34.247"> /**</span>
<a href="#l34.248"></a><span id="l34.248">  * Tests that the link insertion notification bar goes away even</span>
<a href="#l34.249"></a><span id="l34.249">  * if we hit an uploading error.</span>
<a href="#l34.250"></a><span id="l34.250">  */</span>
<a href="#l34.251"></a><span id="l34.251" class="difflineminus">-function test_link_insertion_goes_away_on_error() {</span>
<a href="#l34.252"></a><span id="l34.252" class="difflineplus">+add_task(function test_link_insertion_goes_away_on_error() {</span>
<a href="#l34.253"></a><span id="l34.253">   gMockPromptService.register();</span>
<a href="#l34.254"></a><span id="l34.254">   gMockPromptService.returnValue = false;</span>
<a href="#l34.255"></a><span id="l34.255" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(</span>
<a href="#l34.256"></a><span id="l34.256" class="difflineminus">-    [&quot;./data/testFile1&quot;, &quot;./data/testFile2&quot;],</span>
<a href="#l34.257"></a><span id="l34.257" class="difflineminus">-    __file__</span>
<a href="#l34.258"></a><span id="l34.258" class="difflineminus">-  );</span>
<a href="#l34.259"></a><span id="l34.259" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([</span>
<a href="#l34.260"></a><span id="l34.260" class="difflineplus">+    &quot;./data/testFile1&quot;,</span>
<a href="#l34.261"></a><span id="l34.261" class="difflineplus">+    &quot;./data/testFile2&quot;,</span>
<a href="#l34.262"></a><span id="l34.262" class="difflineplus">+  ]);</span>
<a href="#l34.263"></a><span id="l34.263">   let provider = new MockCloudfileAccount();</span>
<a href="#l34.264"></a><span id="l34.264">   provider.init(&quot;aKey&quot;);</span>
<a href="#l34.265"></a><span id="l34.265"> </span>
<a href="#l34.266"></a><span id="l34.266">   provider.uploadFile = function(aFile) {</span>
<a href="#l34.267"></a><span id="l34.267">     return new Promise((resolve, reject) =&gt; {</span>
<a href="#l34.268"></a><span id="l34.268">       cwc.window.setTimeout(() =&gt;</span>
<a href="#l34.269"></a><span id="l34.269">         reject(cloudFileAccounts.constants.uploadErr)</span>
<a href="#l34.270"></a><span id="l34.270">       );</span>
<a href="#l34.271"></a><span id="l34.271" class="difflineat">@@ -292,29 +294,29 @@ function test_link_insertion_goes_away_o</span>
<a href="#l34.272"></a><span id="l34.272">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l34.273"></a><span id="l34.273">   add_cloud_attachments(cwc, provider, false);</span>
<a href="#l34.274"></a><span id="l34.274"> </span>
<a href="#l34.275"></a><span id="l34.275">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l34.276"></a><span id="l34.276">   wait_for_notification_to_stop(cwc, kBoxId, &quot;bigAttachmentUploading&quot;);</span>
<a href="#l34.277"></a><span id="l34.277"> </span>
<a href="#l34.278"></a><span id="l34.278">   close_compose_window(cwc);</span>
<a href="#l34.279"></a><span id="l34.279">   gMockPromptService.unregister();</span>
<a href="#l34.280"></a><span id="l34.280" class="difflineminus">-}</span>
<a href="#l34.281"></a><span id="l34.281" class="difflineplus">+});</span>
<a href="#l34.282"></a><span id="l34.282"> </span>
<a href="#l34.283"></a><span id="l34.283"> /**</span>
<a href="#l34.284"></a><span id="l34.284">  * Test that we do not show the Filelink offer notification if we convert</span>
<a href="#l34.285"></a><span id="l34.285">  * a Filelink back into a normal attachment.</span>
<a href="#l34.286"></a><span id="l34.286">  */</span>
<a href="#l34.287"></a><span id="l34.287" class="difflineminus">-function test_no_offer_on_conversion() {</span>
<a href="#l34.288"></a><span id="l34.288" class="difflineplus">+add_task(function test_no_offer_on_conversion() {</span>
<a href="#l34.289"></a><span id="l34.289">   const kFiles = [&quot;./data/testFile1&quot;, &quot;./data/testFile2&quot;];</span>
<a href="#l34.290"></a><span id="l34.290">   // Set the notification threshold to 0 to ensure that we get it.</span>
<a href="#l34.291"></a><span id="l34.291">   Services.prefs.setIntPref(kOfferThreshold, 0);</span>
<a href="#l34.292"></a><span id="l34.292"> </span>
<a href="#l34.293"></a><span id="l34.293">   // Insert some Filelinks...</span>
<a href="#l34.294"></a><span id="l34.294" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(kFiles, __file__);</span>
<a href="#l34.295"></a><span id="l34.295" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles(kFiles);</span>
<a href="#l34.296"></a><span id="l34.296">   let provider = new MockCloudfileAccount();</span>
<a href="#l34.297"></a><span id="l34.297">   provider.init(&quot;someKey&quot;);</span>
<a href="#l34.298"></a><span id="l34.298"> </span>
<a href="#l34.299"></a><span id="l34.299">   // Override uploadFile to succeed instantaneously so that we don't have</span>
<a href="#l34.300"></a><span id="l34.300">   // to worry about waiting for the onStopRequest method being called</span>
<a href="#l34.301"></a><span id="l34.301">   // asynchronously.</span>
<a href="#l34.302"></a><span id="l34.302">   provider.uploadFile = function(aFile) {</span>
<a href="#l34.303"></a><span id="l34.303">     return Promise.resolve({</span>
<a href="#l34.304"></a><span id="l34.304" class="difflineat">@@ -331,31 +333,31 @@ function test_no_offer_on_conversion() {</span>
<a href="#l34.305"></a><span id="l34.305">   cw.window.convertSelectedToRegularAttachment();</span>
<a href="#l34.306"></a><span id="l34.306"> </span>
<a href="#l34.307"></a><span id="l34.307">   assert_cloudfile_notification_displayed(cw, false);</span>
<a href="#l34.308"></a><span id="l34.308"> </span>
<a href="#l34.309"></a><span id="l34.309">   close_compose_window(cw);</span>
<a href="#l34.310"></a><span id="l34.310"> </span>
<a href="#l34.311"></a><span id="l34.311">   // Now put the old threshold back.</span>
<a href="#l34.312"></a><span id="l34.312">   Services.prefs.setIntPref(kOfferThreshold, maxSize);</span>
<a href="#l34.313"></a><span id="l34.313" class="difflineminus">-}</span>
<a href="#l34.314"></a><span id="l34.314" class="difflineplus">+});</span>
<a href="#l34.315"></a><span id="l34.315"> </span>
<a href="#l34.316"></a><span id="l34.316"> /**</span>
<a href="#l34.317"></a><span id="l34.317">  * Test that when we kick off an upload via the offer notification, then</span>
<a href="#l34.318"></a><span id="l34.318">  * the upload notification is shown.</span>
<a href="#l34.319"></a><span id="l34.319">  */</span>
<a href="#l34.320"></a><span id="l34.320" class="difflineminus">-function test_offer_then_upload_notifications() {</span>
<a href="#l34.321"></a><span id="l34.321" class="difflineplus">+add_task(function test_offer_then_upload_notifications() {</span>
<a href="#l34.322"></a><span id="l34.322">   const kFiles = [&quot;./data/testFile1&quot;, &quot;./data/testFile2&quot;];</span>
<a href="#l34.323"></a><span id="l34.323">   // Set the notification threshold to 0 to ensure that we get it.</span>
<a href="#l34.324"></a><span id="l34.324">   Services.prefs.setIntPref(kOfferThreshold, 0);</span>
<a href="#l34.325"></a><span id="l34.325"> </span>
<a href="#l34.326"></a><span id="l34.326">   // We're going to add attachments to the attachmentbucket, and we'll</span>
<a href="#l34.327"></a><span id="l34.327">   // use the add_attachments helper function to do it.  First, retrieve</span>
<a href="#l34.328"></a><span id="l34.328">   // some file URIs...</span>
<a href="#l34.329"></a><span id="l34.329" class="difflineminus">-  let fileURIs = collectFiles(kFiles, __file__).map(</span>
<a href="#l34.330"></a><span id="l34.330" class="difflineplus">+  let fileURIs = collectFiles(kFiles).map(</span>
<a href="#l34.331"></a><span id="l34.331">     file =&gt; Services.io.newFileURI(file).spec</span>
<a href="#l34.332"></a><span id="l34.332">   );</span>
<a href="#l34.333"></a><span id="l34.333"> </span>
<a href="#l34.334"></a><span id="l34.334">   // Create our mock provider</span>
<a href="#l34.335"></a><span id="l34.335">   let provider = new MockCloudfileAccount();</span>
<a href="#l34.336"></a><span id="l34.336">   provider.init(&quot;someKey&quot;);</span>
<a href="#l34.337"></a><span id="l34.337"> </span>
<a href="#l34.338"></a><span id="l34.338">   // Override uploadFile to succeed instantaneously so that we don't have</span>
<a href="#l34.339"></a><span id="l34.339" class="difflineat">@@ -384,29 +386,29 @@ function test_offer_then_upload_notifica</span>
<a href="#l34.340"></a><span id="l34.340">   assert_cloudfile_notification_displayed(cw, false);</span>
<a href="#l34.341"></a><span id="l34.341">   // And the upload notification should be displayed.</span>
<a href="#l34.342"></a><span id="l34.342">   assert_upload_notification_displayed(cw, true);</span>
<a href="#l34.343"></a><span id="l34.343"> </span>
<a href="#l34.344"></a><span id="l34.344">   close_compose_window(cw);</span>
<a href="#l34.345"></a><span id="l34.345"> </span>
<a href="#l34.346"></a><span id="l34.346">   // Now put the old threshold back.</span>
<a href="#l34.347"></a><span id="l34.347">   Services.prefs.setIntPref(kOfferThreshold, maxSize);</span>
<a href="#l34.348"></a><span id="l34.348" class="difflineminus">-}</span>
<a href="#l34.349"></a><span id="l34.349" class="difflineplus">+});</span>
<a href="#l34.350"></a><span id="l34.350"> </span>
<a href="#l34.351"></a><span id="l34.351"> /**</span>
<a href="#l34.352"></a><span id="l34.352">  * Test that when we first upload some files, we get the privacy warning</span>
<a href="#l34.353"></a><span id="l34.353">  * message. We should only get this the first time.</span>
<a href="#l34.354"></a><span id="l34.354">  */</span>
<a href="#l34.355"></a><span id="l34.355" class="difflineminus">-function test_privacy_warning_notification() {</span>
<a href="#l34.356"></a><span id="l34.356" class="difflineplus">+add_task(function test_privacy_warning_notification() {</span>
<a href="#l34.357"></a><span id="l34.357">   gMockPromptService.register();</span>
<a href="#l34.358"></a><span id="l34.358">   gMockPromptService.returnValue = false;</span>
<a href="#l34.359"></a><span id="l34.359" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(</span>
<a href="#l34.360"></a><span id="l34.360" class="difflineminus">-    [&quot;./data/testFile1&quot;, &quot;./data/testFile2&quot;],</span>
<a href="#l34.361"></a><span id="l34.361" class="difflineminus">-    __file__</span>
<a href="#l34.362"></a><span id="l34.362" class="difflineminus">-  );</span>
<a href="#l34.363"></a><span id="l34.363" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([</span>
<a href="#l34.364"></a><span id="l34.364" class="difflineplus">+    &quot;./data/testFile1&quot;,</span>
<a href="#l34.365"></a><span id="l34.365" class="difflineplus">+    &quot;./data/testFile2&quot;,</span>
<a href="#l34.366"></a><span id="l34.366" class="difflineplus">+  ]);</span>
<a href="#l34.367"></a><span id="l34.367">   let provider = new MockCloudfileAccount();</span>
<a href="#l34.368"></a><span id="l34.368">   provider.init(&quot;aKey&quot;);</span>
<a href="#l34.369"></a><span id="l34.369"> </span>
<a href="#l34.370"></a><span id="l34.370">   provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l34.371"></a><span id="l34.371">     return new Promise(resolve =&gt;</span>
<a href="#l34.372"></a><span id="l34.372">       cwc.window.setTimeout(() =&gt; {</span>
<a href="#l34.373"></a><span id="l34.373">         resolve({</span>
<a href="#l34.374"></a><span id="l34.374">           id: 1,</span>
<a href="#l34.375"></a><span id="l34.375" class="difflineat">@@ -422,38 +424,38 @@ function test_privacy_warning_notificati</span>
<a href="#l34.376"></a><span id="l34.376"> </span>
<a href="#l34.377"></a><span id="l34.377">   // Assert that the warning is displayed.</span>
<a href="#l34.378"></a><span id="l34.378">   assert_privacy_warning_notification_displayed(cwc, true);</span>
<a href="#l34.379"></a><span id="l34.379"> </span>
<a href="#l34.380"></a><span id="l34.380">   // Close the privacy warning notification...</span>
<a href="#l34.381"></a><span id="l34.381">   close_privacy_warning_notification(cwc);</span>
<a href="#l34.382"></a><span id="l34.382"> </span>
<a href="#l34.383"></a><span id="l34.383">   // And now upload some more files. We shouldn't get the warning again.</span>
<a href="#l34.384"></a><span id="l34.384" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(</span>
<a href="#l34.385"></a><span id="l34.385" class="difflineminus">-    [&quot;./data/testFile3&quot;, &quot;./data/testFile4&quot;],</span>
<a href="#l34.386"></a><span id="l34.386" class="difflineminus">-    __file__</span>
<a href="#l34.387"></a><span id="l34.387" class="difflineminus">-  );</span>
<a href="#l34.388"></a><span id="l34.388" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([</span>
<a href="#l34.389"></a><span id="l34.389" class="difflineplus">+    &quot;./data/testFile3&quot;,</span>
<a href="#l34.390"></a><span id="l34.390" class="difflineplus">+    &quot;./data/testFile4&quot;,</span>
<a href="#l34.391"></a><span id="l34.391" class="difflineplus">+  ]);</span>
<a href="#l34.392"></a><span id="l34.392">   add_cloud_attachments(cwc, provider, false);</span>
<a href="#l34.393"></a><span id="l34.393">   assert_privacy_warning_notification_displayed(cwc, false);</span>
<a href="#l34.394"></a><span id="l34.394"> </span>
<a href="#l34.395"></a><span id="l34.395">   close_compose_window(cwc);</span>
<a href="#l34.396"></a><span id="l34.396">   gMockPromptService.unregister();</span>
<a href="#l34.397"></a><span id="l34.397" class="difflineminus">-}</span>
<a href="#l34.398"></a><span id="l34.398" class="difflineplus">+});</span>
<a href="#l34.399"></a><span id="l34.399"> </span>
<a href="#l34.400"></a><span id="l34.400"> /**</span>
<a href="#l34.401"></a><span id="l34.401">  * Test that the privacy warning notification does not persist when closing</span>
<a href="#l34.402"></a><span id="l34.402">  * and re-opening a compose window.</span>
<a href="#l34.403"></a><span id="l34.403">  */</span>
<a href="#l34.404"></a><span id="l34.404" class="difflineminus">-function test_privacy_warning_notification_no_persist() {</span>
<a href="#l34.405"></a><span id="l34.405" class="difflineplus">+add_task(function test_privacy_warning_notification_no_persist() {</span>
<a href="#l34.406"></a><span id="l34.406">   gMockPromptService.register();</span>
<a href="#l34.407"></a><span id="l34.407">   gMockPromptService.returnValue = false;</span>
<a href="#l34.408"></a><span id="l34.408" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(</span>
<a href="#l34.409"></a><span id="l34.409" class="difflineminus">-    [&quot;./data/testFile1&quot;, &quot;./data/testFile2&quot;],</span>
<a href="#l34.410"></a><span id="l34.410" class="difflineminus">-    __file__</span>
<a href="#l34.411"></a><span id="l34.411" class="difflineminus">-  );</span>
<a href="#l34.412"></a><span id="l34.412" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([</span>
<a href="#l34.413"></a><span id="l34.413" class="difflineplus">+    &quot;./data/testFile1&quot;,</span>
<a href="#l34.414"></a><span id="l34.414" class="difflineplus">+    &quot;./data/testFile2&quot;,</span>
<a href="#l34.415"></a><span id="l34.415" class="difflineplus">+  ]);</span>
<a href="#l34.416"></a><span id="l34.416">   let provider = new MockCloudfileAccount();</span>
<a href="#l34.417"></a><span id="l34.417">   provider.init(&quot;aKey&quot;);</span>
<a href="#l34.418"></a><span id="l34.418"> </span>
<a href="#l34.419"></a><span id="l34.419">   provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l34.420"></a><span id="l34.420">     return new Promise(resolve =&gt;</span>
<a href="#l34.421"></a><span id="l34.421">       cwc.window.setTimeout(() =&gt; {</span>
<a href="#l34.422"></a><span id="l34.422">         resolve({</span>
<a href="#l34.423"></a><span id="l34.423">           id: 1,</span>
<a href="#l34.424"></a><span id="l34.424" class="difflineat">@@ -476,29 +478,29 @@ function test_privacy_warning_notificati</span>
<a href="#l34.425"></a><span id="l34.425">   // Open a new compose window</span>
<a href="#l34.426"></a><span id="l34.426">   cwc = open_compose_new_mail(mc);</span>
<a href="#l34.427"></a><span id="l34.427"> </span>
<a href="#l34.428"></a><span id="l34.428">   // We shouldn't be displaying the privacy warning.</span>
<a href="#l34.429"></a><span id="l34.429">   assert_privacy_warning_notification_displayed(cwc, false);</span>
<a href="#l34.430"></a><span id="l34.430"> </span>
<a href="#l34.431"></a><span id="l34.431">   close_compose_window(cwc);</span>
<a href="#l34.432"></a><span id="l34.432">   gMockPromptService.unregister();</span>
<a href="#l34.433"></a><span id="l34.433" class="difflineminus">-}</span>
<a href="#l34.434"></a><span id="l34.434" class="difflineplus">+});</span>
<a href="#l34.435"></a><span id="l34.435"> </span>
<a href="#l34.436"></a><span id="l34.436"> /**</span>
<a href="#l34.437"></a><span id="l34.437">  * Test that if we close the privacy warning in a composer, it will still</span>
<a href="#l34.438"></a><span id="l34.438">  * spawn in a new one.</span>
<a href="#l34.439"></a><span id="l34.439">  */</span>
<a href="#l34.440"></a><span id="l34.440" class="difflineminus">-function test_privacy_warning_notification_open_after_close() {</span>
<a href="#l34.441"></a><span id="l34.441" class="difflineplus">+add_task(function test_privacy_warning_notification_open_after_close() {</span>
<a href="#l34.442"></a><span id="l34.442">   gMockPromptService.register();</span>
<a href="#l34.443"></a><span id="l34.443">   gMockPromptService.returnValue = false;</span>
<a href="#l34.444"></a><span id="l34.444" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(</span>
<a href="#l34.445"></a><span id="l34.445" class="difflineminus">-    [&quot;./data/testFile1&quot;, &quot;./data/testFile2&quot;],</span>
<a href="#l34.446"></a><span id="l34.446" class="difflineminus">-    __file__</span>
<a href="#l34.447"></a><span id="l34.447" class="difflineminus">-  );</span>
<a href="#l34.448"></a><span id="l34.448" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([</span>
<a href="#l34.449"></a><span id="l34.449" class="difflineplus">+    &quot;./data/testFile1&quot;,</span>
<a href="#l34.450"></a><span id="l34.450" class="difflineplus">+    &quot;./data/testFile2&quot;,</span>
<a href="#l34.451"></a><span id="l34.451" class="difflineplus">+  ]);</span>
<a href="#l34.452"></a><span id="l34.452">   let provider = new MockCloudfileAccount();</span>
<a href="#l34.453"></a><span id="l34.453">   provider.init(&quot;aKey&quot;);</span>
<a href="#l34.454"></a><span id="l34.454"> </span>
<a href="#l34.455"></a><span id="l34.455">   provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l34.456"></a><span id="l34.456">     return new Promise(resolve =&gt;</span>
<a href="#l34.457"></a><span id="l34.457">       cwc.window.setTimeout(() =&gt; {</span>
<a href="#l34.458"></a><span id="l34.458">         resolve({</span>
<a href="#l34.459"></a><span id="l34.459">           id: 1,</span>
<a href="#l34.460"></a><span id="l34.460" class="difflineat">@@ -518,23 +520,30 @@ function test_privacy_warning_notificati</span>
<a href="#l34.461"></a><span id="l34.461">   // Close the privacy warning notification...</span>
<a href="#l34.462"></a><span id="l34.462">   close_privacy_warning_notification(cwc);</span>
<a href="#l34.463"></a><span id="l34.463"> </span>
<a href="#l34.464"></a><span id="l34.464">   close_compose_window(cwc);</span>
<a href="#l34.465"></a><span id="l34.465"> </span>
<a href="#l34.466"></a><span id="l34.466">   // Open a new compose window</span>
<a href="#l34.467"></a><span id="l34.467">   cwc = open_compose_new_mail(mc);</span>
<a href="#l34.468"></a><span id="l34.468"> </span>
<a href="#l34.469"></a><span id="l34.469" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(</span>
<a href="#l34.470"></a><span id="l34.470" class="difflineminus">-    [&quot;./data/testFile3&quot;, &quot;./data/testFile4&quot;],</span>
<a href="#l34.471"></a><span id="l34.471" class="difflineminus">-    __file__</span>
<a href="#l34.472"></a><span id="l34.472" class="difflineminus">-  );</span>
<a href="#l34.473"></a><span id="l34.473" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([</span>
<a href="#l34.474"></a><span id="l34.474" class="difflineplus">+    &quot;./data/testFile3&quot;,</span>
<a href="#l34.475"></a><span id="l34.475" class="difflineplus">+    &quot;./data/testFile4&quot;,</span>
<a href="#l34.476"></a><span id="l34.476" class="difflineplus">+  ]);</span>
<a href="#l34.477"></a><span id="l34.477">   add_cloud_attachments(cwc, provider);</span>
<a href="#l34.478"></a><span id="l34.478"> </span>
<a href="#l34.479"></a><span id="l34.479">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l34.480"></a><span id="l34.480">   wait_for_notification_to_stop(cwc, kBoxId, &quot;bigAttachmentUploading&quot;);</span>
<a href="#l34.481"></a><span id="l34.481"> </span>
<a href="#l34.482"></a><span id="l34.482">   // Assert that the privacy warning notification is displayed again.</span>
<a href="#l34.483"></a><span id="l34.483">   assert_privacy_warning_notification_displayed(cwc, true);</span>
<a href="#l34.484"></a><span id="l34.484"> </span>
<a href="#l34.485"></a><span id="l34.485">   close_compose_window(cwc);</span>
<a href="#l34.486"></a><span id="l34.486">   gMockPromptService.unregister();</span>
<a href="#l34.487"></a><span id="l34.487" class="difflineminus">-}</span>
<a href="#l34.488"></a><span id="l34.488" class="difflineplus">+</span>
<a href="#l34.489"></a><span id="l34.489" class="difflineplus">+  Assert.report(</span>
<a href="#l34.490"></a><span id="l34.490" class="difflineplus">+    false,</span>
<a href="#l34.491"></a><span id="l34.491" class="difflineplus">+    undefined,</span>
<a href="#l34.492"></a><span id="l34.492" class="difflineplus">+    undefined,</span>
<a href="#l34.493"></a><span id="l34.493" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l34.494"></a><span id="l34.494" class="difflineplus">+  );</span>
<a href="#l34.495"></a><span id="l34.495" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1">copy from mail/test/mozmill/cloudfile/data/testFile1</span>
<a href="#l35.2"></a><span id="l35.2">copy to mail/test/browser/cloudfile/data/testFile1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1">copy from mail/test/mozmill/cloudfile/data/testFile2</span>
<a href="#l36.2"></a><span id="l36.2">copy to mail/test/browser/cloudfile/data/testFile2</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1">copy from mail/test/mozmill/cloudfile/data/testFile3</span>
<a href="#l37.2"></a><span id="l37.2">copy to mail/test/browser/cloudfile/data/testFile3</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">copy from mail/test/mozmill/cloudfile/data/testFile4</span>
<a href="#l38.2"></a><span id="l38.2">copy to mail/test/browser/cloudfile/data/testFile4</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1">new file mode 100644</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineminus">--- /dev/null</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineplus">+++ b/mail/test/browser/cloudfile/head.js</span>
<a href="#l39.4"></a><span id="l39.4" class="difflineat">@@ -0,0 +1,7 @@</span>
<a href="#l39.5"></a><span id="l39.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l39.6"></a><span id="l39.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l39.7"></a><span id="l39.7" class="difflineplus">+ * file, you can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l39.8"></a><span id="l39.8" class="difflineplus">+</span>
<a href="#l39.9"></a><span id="l39.9" class="difflineplus">+function collectFiles(files) {</span>
<a href="#l39.10"></a><span id="l39.10" class="difflineplus">+  return files.map(filename =&gt; new FileUtils.File(getTestFilePath(filename)));</span>
<a href="#l39.11"></a><span id="l39.11" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1">copy from mail/test/mozmill/cloudfile/html/settings-with-link.xhtml</span>
<a href="#l40.2"></a><span id="l40.2">copy to mail/test/browser/cloudfile/html/settings-with-link.xhtml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1">new file mode 100644</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineminus">--- /dev/null</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineplus">+++ b/mail/test/browser/composition/browser.ini</span>
<a href="#l41.4"></a><span id="l41.4" class="difflineat">@@ -0,0 +1,78 @@</span>
<a href="#l41.5"></a><span id="l41.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l41.6"></a><span id="l41.6" class="difflineplus">+prefs =</span>
<a href="#l41.7"></a><span id="l41.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l41.8"></a><span id="l41.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l41.9"></a><span id="l41.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l41.10"></a><span id="l41.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l41.11"></a><span id="l41.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineplus">+  mail.shell.checkDefaultClient=false</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l41.14"></a><span id="l41.14" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l41.15"></a><span id="l41.15" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l41.16"></a><span id="l41.16" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l41.17"></a><span id="l41.17" class="difflineplus">+  mail.account.account1.server=server1</span>
<a href="#l41.18"></a><span id="l41.18" class="difflineplus">+  mail.account.account2.identities=id1,id2</span>
<a href="#l41.19"></a><span id="l41.19" class="difflineplus">+  mail.account.account2.server=server2</span>
<a href="#l41.20"></a><span id="l41.20" class="difflineplus">+  mail.accountmanager.accounts=account1,account2</span>
<a href="#l41.21"></a><span id="l41.21" class="difflineplus">+  mail.accountmanager.defaultaccount=account2</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineplus">+  mail.accountmanager.localfoldersserver=server1</span>
<a href="#l41.23"></a><span id="l41.23" class="difflineplus">+  mail.identity.id1.fullName=Tinderbox</span>
<a href="#l41.24"></a><span id="l41.24" class="difflineplus">+  mail.identity.id1.htmlSigFormat=false</span>
<a href="#l41.25"></a><span id="l41.25" class="difflineplus">+  mail.identity.id1.smtpServer=smtp1</span>
<a href="#l41.26"></a><span id="l41.26" class="difflineplus">+  mail.identity.id1.useremail=tinderbox@foo.invalid</span>
<a href="#l41.27"></a><span id="l41.27" class="difflineplus">+  mail.identity.id1.valid=true</span>
<a href="#l41.28"></a><span id="l41.28" class="difflineplus">+  mail.identity.id2.fullName=Tinderboxpushlog</span>
<a href="#l41.29"></a><span id="l41.29" class="difflineplus">+  mail.identity.id2.htmlSigFormat=true</span>
<a href="#l41.30"></a><span id="l41.30" class="difflineplus">+  mail.identity.id2.smtpServer=smtp1</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineplus">+  mail.identity.id2.useremail=tinderboxpushlog@foo.invalid</span>
<a href="#l41.32"></a><span id="l41.32" class="difflineplus">+  mail.identity.id2.valid=true</span>
<a href="#l41.33"></a><span id="l41.33" class="difflineplus">+  mail.server.server1.type=none</span>
<a href="#l41.34"></a><span id="l41.34" class="difflineplus">+  mail.server.server1.userName=nobody</span>
<a href="#l41.35"></a><span id="l41.35" class="difflineplus">+  mail.server.server2.check_new_mail=false</span>
<a href="#l41.36"></a><span id="l41.36" class="difflineplus">+  mail.server.server2.directory-rel=[ProfD]Mail/tinderbox</span>
<a href="#l41.37"></a><span id="l41.37" class="difflineplus">+  mail.server.server2.download_on_biff=true</span>
<a href="#l41.38"></a><span id="l41.38" class="difflineplus">+  mail.server.server2.hostname=tinderbox123</span>
<a href="#l41.39"></a><span id="l41.39" class="difflineplus">+  mail.server.server2.login_at_startup=false</span>
<a href="#l41.40"></a><span id="l41.40" class="difflineplus">+  mail.server.server2.name=tinderbox@foo.invalid</span>
<a href="#l41.41"></a><span id="l41.41" class="difflineplus">+  mail.server.server2.type=pop3</span>
<a href="#l41.42"></a><span id="l41.42" class="difflineplus">+  mail.server.server2.userName=tinderbox</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineplus">+  mail.server.server2.whiteListAbURI=</span>
<a href="#l41.44"></a><span id="l41.44" class="difflineplus">+  mail.smtp.defaultserver=smtp1</span>
<a href="#l41.45"></a><span id="l41.45" class="difflineplus">+  mail.smtpserver.smtp1.hostname=tinderbox123</span>
<a href="#l41.46"></a><span id="l41.46" class="difflineplus">+  mail.smtpserver.smtp1.username=tinderbox</span>
<a href="#l41.47"></a><span id="l41.47" class="difflineplus">+  mail.smtpservers=smtp1</span>
<a href="#l41.48"></a><span id="l41.48" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l41.49"></a><span id="l41.49" class="difflineplus">+support-files = data/**</span>
<a href="#l41.50"></a><span id="l41.50" class="difflineplus">+</span>
<a href="#l41.51"></a><span id="l41.51" class="difflineplus">+[browser_addressWidgets.js]</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineplus">+[browser_attachment.js]</span>
<a href="#l41.53"></a><span id="l41.53" class="difflineplus">+[browser_attachmentReminder.js]</span>
<a href="#l41.54"></a><span id="l41.54" class="difflineplus">+[browser_base64Display.js]</span>
<a href="#l41.55"></a><span id="l41.55" class="difflineplus">+[browser_blockedContent.js]</span>
<a href="#l41.56"></a><span id="l41.56" class="difflineplus">+[browser_charsetEdit.js]</span>
<a href="#l41.57"></a><span id="l41.57" class="difflineplus">+[browser_charsetUpgrade.js]</span>
<a href="#l41.58"></a><span id="l41.58" class="difflineplus">+[browser_cp932Display.js]</span>
<a href="#l41.59"></a><span id="l41.59" class="difflineplus">+[browser_draftIdentity.js]</span>
<a href="#l41.60"></a><span id="l41.60" class="difflineplus">+skip-if = os == &quot;mac&quot;</span>
<a href="#l41.61"></a><span id="l41.61" class="difflineplus">+reason = See bug 1413851.</span>
<a href="#l41.62"></a><span id="l41.62" class="difflineplus">+[browser_drafts.js]</span>
<a href="#l41.63"></a><span id="l41.63" class="difflineplus">+[browser_emlActions.js]</span>
<a href="#l41.64"></a><span id="l41.64" class="difflineplus">+[browser_focus.js]</span>
<a href="#l41.65"></a><span id="l41.65" class="difflineplus">+[browser_forwardHeaders.js]</span>
<a href="#l41.66"></a><span id="l41.66" class="difflineplus">+[browser_forwardRFC822Attach.js]</span>
<a href="#l41.67"></a><span id="l41.67" class="difflineplus">+[browser_forwardUTF8.js]</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineplus">+[browser_forwardedContent.js]</span>
<a href="#l41.69"></a><span id="l41.69" class="difflineplus">+[browser_forwardedEmlActions.js]</span>
<a href="#l41.70"></a><span id="l41.70" class="difflineplus">+[browser_imageDisplay.js]</span>
<a href="#l41.71"></a><span id="l41.71" class="difflineplus">+[browser_imageInsertionDialog.js]</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineplus">+[browser_multipartRelated.js]</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineplus">+[browser_newmsgComposeIdentity.js]</span>
<a href="#l41.74"></a><span id="l41.74" class="difflineplus">+[browser_replyAddresses.js]</span>
<a href="#l41.75"></a><span id="l41.75" class="difflineplus">+[browser_replyFormatFlowed.js]</span>
<a href="#l41.76"></a><span id="l41.76" class="difflineplus">+[browser_replyMultipartCharset.js]</span>
<a href="#l41.77"></a><span id="l41.77" class="difflineplus">+[browser_replySignature.js]</span>
<a href="#l41.78"></a><span id="l41.78" class="difflineplus">+[browser_saveChangesOnQuit.js]</span>
<a href="#l41.79"></a><span id="l41.79" class="difflineplus">+[browser_sendButton.js]</span>
<a href="#l41.80"></a><span id="l41.80" class="difflineplus">+[browser_sendFormat.js]</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineplus">+[browser_signatureInit.js]</span>
<a href="#l41.82"></a><span id="l41.82" class="difflineplus">+[browser_signatureUpdating.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1">copy from mail/test/mozmill/composition/test-address-widgets.js</span>
<a href="#l42.2"></a><span id="l42.2">copy to mail/test/browser/composition/browser_addressWidgets.js</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-address-widgets.js</span>
<a href="#l42.4"></a><span id="l42.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_addressWidgets.js</span>
<a href="#l42.5"></a><span id="l42.5" class="difflineat">@@ -1,81 +1,76 @@</span>
<a href="#l42.6"></a><span id="l42.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l42.7"></a><span id="l42.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l42.8"></a><span id="l42.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l42.9"></a><span id="l42.9"> </span>
<a href="#l42.10"></a><span id="l42.10"> /**</span>
<a href="#l42.11"></a><span id="l42.11">  * Tests proper enabling of addressing widgets.</span>
<a href="#l42.12"></a><span id="l42.12">  */</span>
<a href="#l42.13"></a><span id="l42.13"> </span>
<a href="#l42.14"></a><span id="l42.14" class="difflineplus">+/* globals gFolderTreeView */</span>
<a href="#l42.15"></a><span id="l42.15" class="difflineplus">+</span>
<a href="#l42.16"></a><span id="l42.16"> &quot;use strict&quot;;</span>
<a href="#l42.17"></a><span id="l42.17"> </span>
<a href="#l42.18"></a><span id="l42.18"> var { close_compose_window, open_compose_new_mail } = ChromeUtils.import(</span>
<a href="#l42.19"></a><span id="l42.19">   &quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;</span>
<a href="#l42.20"></a><span id="l42.20"> );</span>
<a href="#l42.21"></a><span id="l42.21" class="difflineminus">-var {</span>
<a href="#l42.22"></a><span id="l42.22" class="difflineminus">-  assert_equals,</span>
<a href="#l42.23"></a><span id="l42.23" class="difflineminus">-  assert_false,</span>
<a href="#l42.24"></a><span id="l42.24" class="difflineminus">-  assert_not_equals,</span>
<a href="#l42.25"></a><span id="l42.25" class="difflineminus">-  assert_true,</span>
<a href="#l42.26"></a><span id="l42.26" class="difflineminus">-  be_in_folder,</span>
<a href="#l42.27"></a><span id="l42.27" class="difflineminus">-  FAKE_SERVER_HOSTNAME,</span>
<a href="#l42.28"></a><span id="l42.28" class="difflineminus">-} = ChromeUtils.import(</span>
<a href="#l42.29"></a><span id="l42.29" class="difflineplus">+var { be_in_folder, FAKE_SERVER_HOSTNAME } = ChromeUtils.import(</span>
<a href="#l42.30"></a><span id="l42.30">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l42.31"></a><span id="l42.31"> );</span>
<a href="#l42.32"></a><span id="l42.32"> </span>
<a href="#l42.33"></a><span id="l42.33"> var { fixIterator } = ChromeUtils.import(</span>
<a href="#l42.34"></a><span id="l42.34">   &quot;resource:///modules/iteratorUtils.jsm&quot;</span>
<a href="#l42.35"></a><span id="l42.35"> );</span>
<a href="#l42.36"></a><span id="l42.36"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l42.37"></a><span id="l42.37">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l42.38"></a><span id="l42.38"> );</span>
<a href="#l42.39"></a><span id="l42.39"> </span>
<a href="#l42.40"></a><span id="l42.40"> var cwc = null; // compose window controller</span>
<a href="#l42.41"></a><span id="l42.41"> var accountPOP3 = null;</span>
<a href="#l42.42"></a><span id="l42.42"> var accountNNTP = null;</span>
<a href="#l42.43"></a><span id="l42.43"> var originalAccountCount;</span>
<a href="#l42.44"></a><span id="l42.44"> </span>
<a href="#l42.45"></a><span id="l42.45" class="difflineminus">-function setupModule(module) {</span>
<a href="#l42.46"></a><span id="l42.46" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l42.47"></a><span id="l42.47" class="difflineplus">+  gFolderTreeView._tree.focus();</span>
<a href="#l42.48"></a><span id="l42.48" class="difflineplus">+</span>
<a href="#l42.49"></a><span id="l42.49">   // Ensure we're in the tinderbox account as that has the right identities set</span>
<a href="#l42.50"></a><span id="l42.50">   // up for this test.</span>
<a href="#l42.51"></a><span id="l42.51">   let server = MailServices.accounts.FindServer(</span>
<a href="#l42.52"></a><span id="l42.52">     &quot;tinderbox&quot;,</span>
<a href="#l42.53"></a><span id="l42.53">     FAKE_SERVER_HOSTNAME,</span>
<a href="#l42.54"></a><span id="l42.54">     &quot;pop3&quot;</span>
<a href="#l42.55"></a><span id="l42.55">   );</span>
<a href="#l42.56"></a><span id="l42.56">   accountPOP3 = MailServices.accounts.FindAccountForServer(server);</span>
<a href="#l42.57"></a><span id="l42.57"> </span>
<a href="#l42.58"></a><span id="l42.58">   // There may be pre-existing accounts from other tests.</span>
<a href="#l42.59"></a><span id="l42.59">   originalAccountCount = MailServices.accounts.allServers.length;</span>
<a href="#l42.60"></a><span id="l42.60" class="difflineminus">-}</span>
<a href="#l42.61"></a><span id="l42.61" class="difflineminus">-</span>
<a href="#l42.62"></a><span id="l42.62" class="difflineminus">-function teardownModule(module) {}</span>
<a href="#l42.63"></a><span id="l42.63" class="difflineplus">+});</span>
<a href="#l42.64"></a><span id="l42.64"> </span>
<a href="#l42.65"></a><span id="l42.65"> /**</span>
<a href="#l42.66"></a><span id="l42.66">  * Check if the address type items are in the wished state.</span>
<a href="#l42.67"></a><span id="l42.67">  *</span>
<a href="#l42.68"></a><span id="l42.68">  * @param aItemsEnabled  List of item values that should be enabled (uncollapsed).</span>
<a href="#l42.69"></a><span id="l42.69">  */</span>
<a href="#l42.70"></a><span id="l42.70"> function check_address_types_state(aItemsEnabled) {</span>
<a href="#l42.71"></a><span id="l42.71">   let addr_types = cwc</span>
<a href="#l42.72"></a><span id="l42.72">     .e(&quot;addressingWidget&quot;)</span>
<a href="#l42.73"></a><span id="l42.73">     .querySelectorAll(&quot;menuitem[value]&quot;);</span>
<a href="#l42.74"></a><span id="l42.74">   for (let item of addr_types) {</span>
<a href="#l42.75"></a><span id="l42.75" class="difflineminus">-    assert_true(</span>
<a href="#l42.76"></a><span id="l42.76" class="difflineplus">+    Assert.ok(</span>
<a href="#l42.77"></a><span id="l42.77">       item.collapsed != aItemsEnabled.includes(item.getAttribute(&quot;value&quot;))</span>
<a href="#l42.78"></a><span id="l42.78">     );</span>
<a href="#l42.79"></a><span id="l42.79">   }</span>
<a href="#l42.80"></a><span id="l42.80"> </span>
<a href="#l42.81"></a><span id="l42.81">   // Even if the currently selected type is collaped,</span>
<a href="#l42.82"></a><span id="l42.82">   // the containing menulist should never be collapsed.</span>
<a href="#l42.83"></a><span id="l42.83">   let addr_lists = cwc.e(&quot;addressingWidget&quot;).querySelectorAll(&quot;menulist&quot;);</span>
<a href="#l42.84"></a><span id="l42.84">   for (let list in addr_lists) {</span>
<a href="#l42.85"></a><span id="l42.85" class="difflineminus">-    assert_false(list.collapsed);</span>
<a href="#l42.86"></a><span id="l42.86" class="difflineminus">-    assert_false(list.disabled);</span>
<a href="#l42.87"></a><span id="l42.87" class="difflineplus">+    Assert.ok(!list.collapsed);</span>
<a href="#l42.88"></a><span id="l42.88" class="difflineplus">+    Assert.ok(!list.disabled);</span>
<a href="#l42.89"></a><span id="l42.89">   }</span>
<a href="#l42.90"></a><span id="l42.90"> }</span>
<a href="#l42.91"></a><span id="l42.91"> </span>
<a href="#l42.92"></a><span id="l42.92"> /**</span>
<a href="#l42.93"></a><span id="l42.93">  * With only a POP3 account, no News related address types should be enabled.</span>
<a href="#l42.94"></a><span id="l42.94">  */</span>
<a href="#l42.95"></a><span id="l42.95"> function check_mail_address_types() {</span>
<a href="#l42.96"></a><span id="l42.96">   check_address_types_state([&quot;addr_to&quot;, &quot;addr_cc&quot;, &quot;addr_reply&quot;, &quot;addr_bcc&quot;]);</span>
<a href="#l42.97"></a><span id="l42.97" class="difflineat">@@ -103,41 +98,41 @@ function add_NNTP_account() {</span>
<a href="#l42.98"></a><span id="l42.98"> </span>
<a href="#l42.99"></a><span id="l42.99">   let identity = MailServices.accounts.createIdentity();</span>
<a href="#l42.100"></a><span id="l42.100">   identity.email = &quot;tinderbox2@example.invalid&quot;;</span>
<a href="#l42.101"></a><span id="l42.101"> </span>
<a href="#l42.102"></a><span id="l42.102">   accountNNTP = MailServices.accounts.createAccount();</span>
<a href="#l42.103"></a><span id="l42.103">   accountNNTP.incomingServer = nntpServer;</span>
<a href="#l42.104"></a><span id="l42.104">   accountNNTP.addIdentity(identity);</span>
<a href="#l42.105"></a><span id="l42.105">   // Now there should be 1 more account.</span>
<a href="#l42.106"></a><span id="l42.106" class="difflineminus">-  assert_equals(</span>
<a href="#l42.107"></a><span id="l42.107" class="difflineplus">+  Assert.equal(</span>
<a href="#l42.108"></a><span id="l42.108">     MailServices.accounts.allServers.length,</span>
<a href="#l42.109"></a><span id="l42.109">     originalAccountCount + 1</span>
<a href="#l42.110"></a><span id="l42.110">   );</span>
<a href="#l42.111"></a><span id="l42.111"> }</span>
<a href="#l42.112"></a><span id="l42.112"> </span>
<a href="#l42.113"></a><span id="l42.113"> function remove_NNTP_account() {</span>
<a href="#l42.114"></a><span id="l42.114">   // Remove our NNTP account to leave the profile clean.</span>
<a href="#l42.115"></a><span id="l42.115">   MailServices.accounts.removeAccount(accountNNTP);</span>
<a href="#l42.116"></a><span id="l42.116">   // There should be only the original accounts left.</span>
<a href="#l42.117"></a><span id="l42.117" class="difflineminus">-  assert_equals(MailServices.accounts.allServers.length, originalAccountCount);</span>
<a href="#l42.118"></a><span id="l42.118" class="difflineplus">+  Assert.equal(MailServices.accounts.allServers.length, originalAccountCount);</span>
<a href="#l42.119"></a><span id="l42.119"> }</span>
<a href="#l42.120"></a><span id="l42.120"> </span>
<a href="#l42.121"></a><span id="l42.121"> /**</span>
<a href="#l42.122"></a><span id="l42.122">  * Bug 399446 &amp; bug 922614</span>
<a href="#l42.123"></a><span id="l42.123">  * Test that the allowed address types depend on the account type</span>
<a href="#l42.124"></a><span id="l42.124">  * we are sending from.</span>
<a href="#l42.125"></a><span id="l42.125">  */</span>
<a href="#l42.126"></a><span id="l42.126" class="difflineminus">-function test_address_types() {</span>
<a href="#l42.127"></a><span id="l42.127" class="difflineplus">+add_task(function test_address_types() {</span>
<a href="#l42.128"></a><span id="l42.128">   // Be sure there is no NNTP account yet.</span>
<a href="#l42.129"></a><span id="l42.129">   for (let account of fixIterator(</span>
<a href="#l42.130"></a><span id="l42.130">     MailServices.accounts.accounts,</span>
<a href="#l42.131"></a><span id="l42.131">     Ci.nsIMsgAccount</span>
<a href="#l42.132"></a><span id="l42.132">   )) {</span>
<a href="#l42.133"></a><span id="l42.133" class="difflineminus">-    assert_not_equals(</span>
<a href="#l42.134"></a><span id="l42.134" class="difflineplus">+    Assert.notEqual(</span>
<a href="#l42.135"></a><span id="l42.135">       account.incomingServer.type,</span>
<a href="#l42.136"></a><span id="l42.136">       &quot;nntp&quot;,</span>
<a href="#l42.137"></a><span id="l42.137">       &quot;There is a NNTP account existing unexpectedly&quot;</span>
<a href="#l42.138"></a><span id="l42.138">     );</span>
<a href="#l42.139"></a><span id="l42.139">   }</span>
<a href="#l42.140"></a><span id="l42.140"> </span>
<a href="#l42.141"></a><span id="l42.141">   // Open compose window on the existing POP3 account.</span>
<a href="#l42.142"></a><span id="l42.142">   be_in_folder(accountPOP3.incomingServer.rootFolder);</span>
<a href="#l42.143"></a><span id="l42.143" class="difflineat">@@ -186,9 +181,9 @@ function test_address_types() {</span>
<a href="#l42.144"></a><span id="l42.144"> </span>
<a href="#l42.145"></a><span id="l42.145">   remove_NNTP_account();</span>
<a href="#l42.146"></a><span id="l42.146"> </span>
<a href="#l42.147"></a><span id="l42.147">   // Now the NNTP account is lost, so we should be back to mail only addressees.</span>
<a href="#l42.148"></a><span id="l42.148">   be_in_folder(accountPOP3.incomingServer.rootFolder);</span>
<a href="#l42.149"></a><span id="l42.149">   cwc = open_compose_new_mail();</span>
<a href="#l42.150"></a><span id="l42.150">   check_mail_address_types();</span>
<a href="#l42.151"></a><span id="l42.151">   close_compose_window(cwc);</span>
<a href="#l42.152"></a><span id="l42.152" class="difflineminus">-}</span>
<a href="#l42.153"></a><span id="l42.153" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1">copy from mail/test/mozmill/composition/test-attachment.js</span>
<a href="#l43.2"></a><span id="l43.2">copy to mail/test/browser/composition/browser_attachment.js</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-attachment.js</span>
<a href="#l43.4"></a><span id="l43.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_attachment.js</span>
<a href="#l43.5"></a><span id="l43.5" class="difflineat">@@ -4,31 +4,30 @@</span>
<a href="#l43.6"></a><span id="l43.6"> </span>
<a href="#l43.7"></a><span id="l43.7"> /**</span>
<a href="#l43.8"></a><span id="l43.8">  * Tests attachment handling functionality of the message compose window.</span>
<a href="#l43.9"></a><span id="l43.9">  */</span>
<a href="#l43.10"></a><span id="l43.10"> </span>
<a href="#l43.11"></a><span id="l43.11"> &quot;use strict&quot;;</span>
<a href="#l43.12"></a><span id="l43.12"> </span>
<a href="#l43.13"></a><span id="l43.13"> var elib = ChromeUtils.import(</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l43.16"></a><span id="l43.16"> );</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l43.18"></a><span id="l43.18" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l43.19"></a><span id="l43.19"> </span>
<a href="#l43.20"></a><span id="l43.20"> var {</span>
<a href="#l43.21"></a><span id="l43.21">   add_attachments,</span>
<a href="#l43.22"></a><span id="l43.22">   close_compose_window,</span>
<a href="#l43.23"></a><span id="l43.23">   delete_attachment,</span>
<a href="#l43.24"></a><span id="l43.24">   open_compose_new_mail,</span>
<a href="#l43.25"></a><span id="l43.25">   open_compose_with_forward,</span>
<a href="#l43.26"></a><span id="l43.26">   open_compose_with_forward_as_attachments,</span>
<a href="#l43.27"></a><span id="l43.27"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l43.28"></a><span id="l43.28"> var {</span>
<a href="#l43.29"></a><span id="l43.29">   add_message_to_folder,</span>
<a href="#l43.30"></a><span id="l43.30" class="difflineminus">-  assert_equals,</span>
<a href="#l43.31"></a><span id="l43.31">   be_in_folder,</span>
<a href="#l43.32"></a><span id="l43.32">   create_folder,</span>
<a href="#l43.33"></a><span id="l43.33">   create_message,</span>
<a href="#l43.34"></a><span id="l43.34">   select_click_row,</span>
<a href="#l43.35"></a><span id="l43.35"> </span>
<a href="#l43.36"></a><span id="l43.36">   wait_for_popup_to_open,</span>
<a href="#l43.37"></a><span id="l43.37"> } = ChromeUtils.import(</span>
<a href="#l43.38"></a><span id="l43.38">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l43.39"></a><span id="l43.39" class="difflineat">@@ -56,17 +55,17 @@ var rawAttachment =</span>
<a href="#l43.40"></a><span id="l43.40"> </span>
<a href="#l43.41"></a><span id="l43.41"> var b64Attachment =</span>
<a href="#l43.42"></a><span id="l43.42">   &quot;iVBORw0KGgoAAAANSUhEUgAAAAwAAAAMCAYAAABWdVznAAAABHNCSVQICAgIfAhkiAAAAAlwS&quot; +</span>
<a href="#l43.43"></a><span id="l43.43">   &quot;FlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAA&quot; +</span>
<a href="#l43.44"></a><span id="l43.44">   &quot;A5SURBVCiRY/z//z8DKYCJJNXkaGBgYGD4D8NQ5zUgiTVAxeBqSLaBkVRPM0KtIhrQ3km0jwe&quot; +</span>
<a href="#l43.45"></a><span id="l43.45">   &quot;SNQAAlmAY+71EgFoAAAAASUVORK5CYII=&quot;;</span>
<a href="#l43.46"></a><span id="l43.46"> var b64Size = 188;</span>
<a href="#l43.47"></a><span id="l43.47"> </span>
<a href="#l43.48"></a><span id="l43.48" class="difflineminus">-function setupModule(module) {</span>
<a href="#l43.49"></a><span id="l43.49" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l43.50"></a><span id="l43.50">   folder = create_folder(&quot;ComposeAttachmentA&quot;);</span>
<a href="#l43.51"></a><span id="l43.51"> </span>
<a href="#l43.52"></a><span id="l43.52">   messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l43.53"></a><span id="l43.53"> </span>
<a href="#l43.54"></a><span id="l43.54">   isWindows = &quot;@mozilla.org/windows-registry-key;1&quot; in Cc;</span>
<a href="#l43.55"></a><span id="l43.55"> </span>
<a href="#l43.56"></a><span id="l43.56">   /* Today's gory details (thanks to Jonathan Protzenko): libmime somehow</span>
<a href="#l43.57"></a><span id="l43.57">    * counts the trailing newline for an attachment MIME part. Most of the time,</span>
<a href="#l43.58"></a><span id="l43.58" class="difflineat">@@ -99,17 +98,17 @@ function setupModule(module) {</span>
<a href="#l43.59"></a><span id="l43.59">         },</span>
<a href="#l43.60"></a><span id="l43.60">       ],</span>
<a href="#l43.61"></a><span id="l43.61">     },</span>
<a href="#l43.62"></a><span id="l43.62">   ];</span>
<a href="#l43.63"></a><span id="l43.63"> </span>
<a href="#l43.64"></a><span id="l43.64">   for (let i = 0; i &lt; messages.length; i++) {</span>
<a href="#l43.65"></a><span id="l43.65">     add_message_to_folder(folder, create_message(messages[i]));</span>
<a href="#l43.66"></a><span id="l43.66">   }</span>
<a href="#l43.67"></a><span id="l43.67" class="difflineminus">-}</span>
<a href="#l43.68"></a><span id="l43.68" class="difflineplus">+});</span>
<a href="#l43.69"></a><span id="l43.69"> </span>
<a href="#l43.70"></a><span id="l43.70"> /**</span>
<a href="#l43.71"></a><span id="l43.71">  * Make sure that the attachment's size is what we expect</span>
<a href="#l43.72"></a><span id="l43.72">  * @param controller the controller for the compose window</span>
<a href="#l43.73"></a><span id="l43.73">  * @param index the attachment to examine, as an index into the listbox</span>
<a href="#l43.74"></a><span id="l43.74">  * @param expectedSize the expected size of the attachment, in bytes</span>
<a href="#l43.75"></a><span id="l43.75">  */</span>
<a href="#l43.76"></a><span id="l43.76"> function check_attachment_size(controller, index, expectedSize) {</span>
<a href="#l43.77"></a><span id="l43.77" class="difflineat">@@ -197,187 +196,186 @@ function check_total_attachment_size(con</span>
<a href="#l43.78"></a><span id="l43.78">         &quot;) does not &quot; +</span>
<a href="#l43.79"></a><span id="l43.79">         &quot;match expected value (&quot; +</span>
<a href="#l43.80"></a><span id="l43.80">         expectedFormattedSize +</span>
<a href="#l43.81"></a><span id="l43.81">         &quot;)&quot;</span>
<a href="#l43.82"></a><span id="l43.82">     );</span>
<a href="#l43.83"></a><span id="l43.83">   }</span>
<a href="#l43.84"></a><span id="l43.84"> }</span>
<a href="#l43.85"></a><span id="l43.85"> </span>
<a href="#l43.86"></a><span id="l43.86" class="difflineminus">-function test_file_attachment() {</span>
<a href="#l43.87"></a><span id="l43.87" class="difflineplus">+add_task(function test_file_attachment() {</span>
<a href="#l43.88"></a><span id="l43.88">   let cwc = open_compose_new_mail();</span>
<a href="#l43.89"></a><span id="l43.89"> </span>
<a href="#l43.90"></a><span id="l43.90">   let url = filePrefix + &quot;some/file/here.txt&quot;;</span>
<a href="#l43.91"></a><span id="l43.91">   let size = 1234;</span>
<a href="#l43.92"></a><span id="l43.92"> </span>
<a href="#l43.93"></a><span id="l43.93">   add_attachments(cwc, url, size);</span>
<a href="#l43.94"></a><span id="l43.94">   check_attachment_size(cwc, 0, size);</span>
<a href="#l43.95"></a><span id="l43.95">   check_total_attachment_size(cwc, 1);</span>
<a href="#l43.96"></a><span id="l43.96"> </span>
<a href="#l43.97"></a><span id="l43.97">   close_compose_window(cwc);</span>
<a href="#l43.98"></a><span id="l43.98" class="difflineminus">-}</span>
<a href="#l43.99"></a><span id="l43.99" class="difflineplus">+});</span>
<a href="#l43.100"></a><span id="l43.100"> </span>
<a href="#l43.101"></a><span id="l43.101" class="difflineminus">-function test_webpage_attachment() {</span>
<a href="#l43.102"></a><span id="l43.102" class="difflineplus">+add_task(function test_webpage_attachment() {</span>
<a href="#l43.103"></a><span id="l43.103">   let cwc = open_compose_new_mail();</span>
<a href="#l43.104"></a><span id="l43.104"> </span>
<a href="#l43.105"></a><span id="l43.105">   add_attachments(cwc, &quot;http://www.mozilla.org/&quot;);</span>
<a href="#l43.106"></a><span id="l43.106">   check_no_attachment_size(cwc, 0);</span>
<a href="#l43.107"></a><span id="l43.107">   check_total_attachment_size(cwc, 1);</span>
<a href="#l43.108"></a><span id="l43.108"> </span>
<a href="#l43.109"></a><span id="l43.109">   close_compose_window(cwc);</span>
<a href="#l43.110"></a><span id="l43.110" class="difflineminus">-}</span>
<a href="#l43.111"></a><span id="l43.111" class="difflineplus">+});</span>
<a href="#l43.112"></a><span id="l43.112"> </span>
<a href="#l43.113"></a><span id="l43.113" class="difflineminus">-function test_multiple_attachments() {</span>
<a href="#l43.114"></a><span id="l43.114" class="difflineplus">+add_task(function test_multiple_attachments() {</span>
<a href="#l43.115"></a><span id="l43.115">   let cwc = open_compose_new_mail();</span>
<a href="#l43.116"></a><span id="l43.116"> </span>
<a href="#l43.117"></a><span id="l43.117">   let files = [</span>
<a href="#l43.118"></a><span id="l43.118">     { name: &quot;foo.txt&quot;, size: 1234 },</span>
<a href="#l43.119"></a><span id="l43.119">     { name: &quot;bar.txt&quot;, size: 5678 },</span>
<a href="#l43.120"></a><span id="l43.120">     { name: &quot;baz.txt&quot;, size: 9012 },</span>
<a href="#l43.121"></a><span id="l43.121">   ];</span>
<a href="#l43.122"></a><span id="l43.122">   for (let i = 0; i &lt; files.length; i++) {</span>
<a href="#l43.123"></a><span id="l43.123">     add_attachments(cwc, filePrefix + files[i].name, files[i].size);</span>
<a href="#l43.124"></a><span id="l43.124">     check_attachment_size(cwc, i, files[i].size);</span>
<a href="#l43.125"></a><span id="l43.125">   }</span>
<a href="#l43.126"></a><span id="l43.126"> </span>
<a href="#l43.127"></a><span id="l43.127">   check_total_attachment_size(cwc, files.length);</span>
<a href="#l43.128"></a><span id="l43.128">   close_compose_window(cwc);</span>
<a href="#l43.129"></a><span id="l43.129" class="difflineminus">-}</span>
<a href="#l43.130"></a><span id="l43.130" class="difflineplus">+});</span>
<a href="#l43.131"></a><span id="l43.131"> </span>
<a href="#l43.132"></a><span id="l43.132" class="difflineminus">-function test_delete_attachments() {</span>
<a href="#l43.133"></a><span id="l43.133" class="difflineplus">+add_task(function test_delete_attachments() {</span>
<a href="#l43.134"></a><span id="l43.134">   let cwc = open_compose_new_mail();</span>
<a href="#l43.135"></a><span id="l43.135"> </span>
<a href="#l43.136"></a><span id="l43.136">   let files = [</span>
<a href="#l43.137"></a><span id="l43.137">     { name: &quot;foo.txt&quot;, size: 1234 },</span>
<a href="#l43.138"></a><span id="l43.138">     { name: &quot;bar.txt&quot;, size: 5678 },</span>
<a href="#l43.139"></a><span id="l43.139">     { name: &quot;baz.txt&quot;, size: 9012 },</span>
<a href="#l43.140"></a><span id="l43.140">   ];</span>
<a href="#l43.141"></a><span id="l43.141">   for (let i = 0; i &lt; files.length; i++) {</span>
<a href="#l43.142"></a><span id="l43.142">     add_attachments(cwc, filePrefix + files[i].name, files[i].size);</span>
<a href="#l43.143"></a><span id="l43.143">     check_attachment_size(cwc, i, files[i].size);</span>
<a href="#l43.144"></a><span id="l43.144">   }</span>
<a href="#l43.145"></a><span id="l43.145"> </span>
<a href="#l43.146"></a><span id="l43.146">   delete_attachment(cwc, 0);</span>
<a href="#l43.147"></a><span id="l43.147">   check_total_attachment_size(cwc, files.length - 1);</span>
<a href="#l43.148"></a><span id="l43.148"> </span>
<a href="#l43.149"></a><span id="l43.149">   close_compose_window(cwc);</span>
<a href="#l43.150"></a><span id="l43.150" class="difflineminus">-}</span>
<a href="#l43.151"></a><span id="l43.151" class="difflineplus">+});</span>
<a href="#l43.152"></a><span id="l43.152"> </span>
<a href="#l43.153"></a><span id="l43.153"> function subtest_rename_attachment(cwc) {</span>
<a href="#l43.154"></a><span id="l43.154">   cwc.e(&quot;loginTextbox&quot;).value = &quot;renamed.txt&quot;;</span>
<a href="#l43.155"></a><span id="l43.155">   cwc.window.document.documentElement.getButton(&quot;accept&quot;).doCommand();</span>
<a href="#l43.156"></a><span id="l43.156"> }</span>
<a href="#l43.157"></a><span id="l43.157"> </span>
<a href="#l43.158"></a><span id="l43.158" class="difflineminus">-function test_rename_attachment() {</span>
<a href="#l43.159"></a><span id="l43.159" class="difflineplus">+add_task(function test_rename_attachment() {</span>
<a href="#l43.160"></a><span id="l43.160">   let cwc = open_compose_new_mail();</span>
<a href="#l43.161"></a><span id="l43.161"> </span>
<a href="#l43.162"></a><span id="l43.162">   let url = filePrefix + &quot;some/file/here.txt&quot;;</span>
<a href="#l43.163"></a><span id="l43.163">   let size = 1234;</span>
<a href="#l43.164"></a><span id="l43.164"> </span>
<a href="#l43.165"></a><span id="l43.165">   add_attachments(cwc, url, size);</span>
<a href="#l43.166"></a><span id="l43.166"> </span>
<a href="#l43.167"></a><span id="l43.167">   // Now, rename the attachment.</span>
<a href="#l43.168"></a><span id="l43.168">   let bucket = cwc.e(&quot;attachmentBucket&quot;);</span>
<a href="#l43.169"></a><span id="l43.169">   let node = bucket.querySelector(&quot;richlistitem.attachmentItem&quot;);</span>
<a href="#l43.170"></a><span id="l43.170">   cwc.click(new elib.Elem(node));</span>
<a href="#l43.171"></a><span id="l43.171">   plan_for_modal_dialog(&quot;commonDialog&quot;, subtest_rename_attachment);</span>
<a href="#l43.172"></a><span id="l43.172">   cwc.window.RenameSelectedAttachment();</span>
<a href="#l43.173"></a><span id="l43.173">   wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l43.174"></a><span id="l43.174"> </span>
<a href="#l43.175"></a><span id="l43.175" class="difflineminus">-  assert_equals(node.getAttribute(&quot;name&quot;), &quot;renamed.txt&quot;);</span>
<a href="#l43.176"></a><span id="l43.176" class="difflineplus">+  Assert.equal(node.getAttribute(&quot;name&quot;), &quot;renamed.txt&quot;);</span>
<a href="#l43.177"></a><span id="l43.177"> </span>
<a href="#l43.178"></a><span id="l43.178">   check_attachment_size(cwc, 0, size);</span>
<a href="#l43.179"></a><span id="l43.179">   check_total_attachment_size(cwc, 1);</span>
<a href="#l43.180"></a><span id="l43.180"> </span>
<a href="#l43.181"></a><span id="l43.181">   close_compose_window(cwc);</span>
<a href="#l43.182"></a><span id="l43.182" class="difflineminus">-}</span>
<a href="#l43.183"></a><span id="l43.183" class="difflineplus">+});</span>
<a href="#l43.184"></a><span id="l43.184"> </span>
<a href="#l43.185"></a><span id="l43.185"> function subtest_open_attachment(cwc) {</span>
<a href="#l43.186"></a><span id="l43.186">   cwc.window.document.documentElement.getButton(&quot;cancel&quot;).doCommand();</span>
<a href="#l43.187"></a><span id="l43.187"> }</span>
<a href="#l43.188"></a><span id="l43.188"> </span>
<a href="#l43.189"></a><span id="l43.189" class="difflineminus">-function test_open_attachment() {</span>
<a href="#l43.190"></a><span id="l43.190" class="difflineplus">+add_task(function test_open_attachment() {</span>
<a href="#l43.191"></a><span id="l43.191">   let cwc = open_compose_new_mail();</span>
<a href="#l43.192"></a><span id="l43.192"> </span>
<a href="#l43.193"></a><span id="l43.193">   // set up our external file for attaching</span>
<a href="#l43.194"></a><span id="l43.194" class="difflineminus">-  let thisFilePath = os.getFileForPath(__file__);</span>
<a href="#l43.195"></a><span id="l43.195" class="difflineminus">-  let file = os.getFileForPath(os.abspath(&quot;./attachment.txt&quot;, thisFilePath));</span>
<a href="#l43.196"></a><span id="l43.196" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(&quot;data/attachment.txt&quot;));</span>
<a href="#l43.197"></a><span id="l43.197">   let fileHandler = Services.io</span>
<a href="#l43.198"></a><span id="l43.198">     .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l43.199"></a><span id="l43.199">     .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l43.200"></a><span id="l43.200">   let url = fileHandler.getURLSpecFromFile(file);</span>
<a href="#l43.201"></a><span id="l43.201">   let size = file.fileSize;</span>
<a href="#l43.202"></a><span id="l43.202"> </span>
<a href="#l43.203"></a><span id="l43.203">   add_attachments(cwc, url, size);</span>
<a href="#l43.204"></a><span id="l43.204"> </span>
<a href="#l43.205"></a><span id="l43.205">   // Now, open the attachment.</span>
<a href="#l43.206"></a><span id="l43.206">   let bucket = cwc.e(&quot;attachmentBucket&quot;);</span>
<a href="#l43.207"></a><span id="l43.207">   let node = bucket.querySelector(&quot;richlistitem.attachmentItem&quot;);</span>
<a href="#l43.208"></a><span id="l43.208">   plan_for_modal_dialog(&quot;unknownContentType&quot;, subtest_open_attachment);</span>
<a href="#l43.209"></a><span id="l43.209">   cwc.doubleClick(new elib.Elem(node));</span>
<a href="#l43.210"></a><span id="l43.210">   wait_for_modal_dialog(&quot;unknownContentType&quot;);</span>
<a href="#l43.211"></a><span id="l43.211"> </span>
<a href="#l43.212"></a><span id="l43.212">   close_compose_window(cwc);</span>
<a href="#l43.213"></a><span id="l43.213" class="difflineminus">-}</span>
<a href="#l43.214"></a><span id="l43.214" class="difflineplus">+});</span>
<a href="#l43.215"></a><span id="l43.215"> </span>
<a href="#l43.216"></a><span id="l43.216" class="difflineminus">-function test_forward_raw_attachment() {</span>
<a href="#l43.217"></a><span id="l43.217" class="difflineplus">+add_task(function test_forward_raw_attachment() {</span>
<a href="#l43.218"></a><span id="l43.218">   be_in_folder(folder);</span>
<a href="#l43.219"></a><span id="l43.219">   select_click_row(1);</span>
<a href="#l43.220"></a><span id="l43.220"> </span>
<a href="#l43.221"></a><span id="l43.221">   let cwc = open_compose_with_forward();</span>
<a href="#l43.222"></a><span id="l43.222">   check_attachment_size(cwc, 0, rawAttachment.length);</span>
<a href="#l43.223"></a><span id="l43.223">   check_total_attachment_size(cwc, 1);</span>
<a href="#l43.224"></a><span id="l43.224"> </span>
<a href="#l43.225"></a><span id="l43.225">   close_compose_window(cwc);</span>
<a href="#l43.226"></a><span id="l43.226" class="difflineminus">-}</span>
<a href="#l43.227"></a><span id="l43.227" class="difflineplus">+});</span>
<a href="#l43.228"></a><span id="l43.228"> </span>
<a href="#l43.229"></a><span id="l43.229" class="difflineminus">-function test_forward_b64_attachment() {</span>
<a href="#l43.230"></a><span id="l43.230" class="difflineplus">+add_task(function test_forward_b64_attachment() {</span>
<a href="#l43.231"></a><span id="l43.231">   be_in_folder(folder);</span>
<a href="#l43.232"></a><span id="l43.232">   select_click_row(2);</span>
<a href="#l43.233"></a><span id="l43.233"> </span>
<a href="#l43.234"></a><span id="l43.234">   let cwc = open_compose_with_forward();</span>
<a href="#l43.235"></a><span id="l43.235">   check_attachment_size(cwc, 0, b64Size);</span>
<a href="#l43.236"></a><span id="l43.236">   check_total_attachment_size(cwc, 1);</span>
<a href="#l43.237"></a><span id="l43.237"> </span>
<a href="#l43.238"></a><span id="l43.238">   close_compose_window(cwc);</span>
<a href="#l43.239"></a><span id="l43.239" class="difflineminus">-}</span>
<a href="#l43.240"></a><span id="l43.240" class="difflineplus">+});</span>
<a href="#l43.241"></a><span id="l43.241"> </span>
<a href="#l43.242"></a><span id="l43.242" class="difflineminus">-function test_forward_message_as_attachment() {</span>
<a href="#l43.243"></a><span id="l43.243" class="difflineplus">+add_task(function test_forward_message_as_attachment() {</span>
<a href="#l43.244"></a><span id="l43.244">   be_in_folder(folder);</span>
<a href="#l43.245"></a><span id="l43.245">   let curMessage = select_click_row(0);</span>
<a href="#l43.246"></a><span id="l43.246"> </span>
<a href="#l43.247"></a><span id="l43.247">   let cwc = open_compose_with_forward_as_attachments();</span>
<a href="#l43.248"></a><span id="l43.248">   check_attachment_size(cwc, 0, curMessage.messageSize);</span>
<a href="#l43.249"></a><span id="l43.249">   check_total_attachment_size(cwc, 1);</span>
<a href="#l43.250"></a><span id="l43.250"> </span>
<a href="#l43.251"></a><span id="l43.251">   close_compose_window(cwc);</span>
<a href="#l43.252"></a><span id="l43.252" class="difflineminus">-}</span>
<a href="#l43.253"></a><span id="l43.253" class="difflineplus">+});</span>
<a href="#l43.254"></a><span id="l43.254"> </span>
<a href="#l43.255"></a><span id="l43.255" class="difflineminus">-function test_forward_message_with_attachments_as_attachment() {</span>
<a href="#l43.256"></a><span id="l43.256" class="difflineplus">+add_task(function test_forward_message_with_attachments_as_attachment() {</span>
<a href="#l43.257"></a><span id="l43.257">   be_in_folder(folder);</span>
<a href="#l43.258"></a><span id="l43.258">   let curMessage = select_click_row(1);</span>
<a href="#l43.259"></a><span id="l43.259"> </span>
<a href="#l43.260"></a><span id="l43.260">   let cwc = open_compose_with_forward_as_attachments();</span>
<a href="#l43.261"></a><span id="l43.261">   check_attachment_size(cwc, 0, curMessage.messageSize);</span>
<a href="#l43.262"></a><span id="l43.262">   check_total_attachment_size(cwc, 1);</span>
<a href="#l43.263"></a><span id="l43.263"> </span>
<a href="#l43.264"></a><span id="l43.264">   close_compose_window(cwc);</span>
<a href="#l43.265"></a><span id="l43.265" class="difflineminus">-}</span>
<a href="#l43.266"></a><span id="l43.266" class="difflineplus">+});</span>
<a href="#l43.267"></a><span id="l43.267"> </span>
<a href="#l43.268"></a><span id="l43.268"> /**</span>
<a href="#l43.269"></a><span id="l43.269">  * Check that the compose window has the attachments we expect.</span>
<a href="#l43.270"></a><span id="l43.270">  *</span>
<a href="#l43.271"></a><span id="l43.271">  * @param aController  The controller for the compose window</span>
<a href="#l43.272"></a><span id="l43.272">  * @param aNames       An array of attachment names that are expected</span>
<a href="#l43.273"></a><span id="l43.273">  */</span>
<a href="#l43.274"></a><span id="l43.274"> function check_attachment_names(aController, aNames) {</span>
<a href="#l43.275"></a><span id="l43.275">   let bucket = aController.e(&quot;attachmentBucket&quot;);</span>
<a href="#l43.276"></a><span id="l43.276" class="difflineminus">-  assert_equals(aNames.length, bucket.itemCount);</span>
<a href="#l43.277"></a><span id="l43.277" class="difflineplus">+  Assert.equal(aNames.length, bucket.itemCount);</span>
<a href="#l43.278"></a><span id="l43.278">   for (let i = 0; i &lt; aNames.length; i++) {</span>
<a href="#l43.279"></a><span id="l43.279" class="difflineminus">-    assert_equals(bucket.getItemAtIndex(i).getAttribute(&quot;name&quot;), aNames[i]);</span>
<a href="#l43.280"></a><span id="l43.280" class="difflineplus">+    Assert.equal(bucket.getItemAtIndex(i).getAttribute(&quot;name&quot;), aNames[i]);</span>
<a href="#l43.281"></a><span id="l43.281">   }</span>
<a href="#l43.282"></a><span id="l43.282"> }</span>
<a href="#l43.283"></a><span id="l43.283"> </span>
<a href="#l43.284"></a><span id="l43.284"> /**</span>
<a href="#l43.285"></a><span id="l43.285">  * Execute a test of opening and closing reorderAttachmentsPanel via keyboard.</span>
<a href="#l43.286"></a><span id="l43.286">  *</span>
<a href="#l43.287"></a><span id="l43.287">  * @param aCwc        The controller for the compose window</span>
<a href="#l43.288"></a><span id="l43.288">  * @param aActions    An array of objects specifying an action of opening the</span>
<a href="#l43.289"></a><span id="l43.289" class="difflineat">@@ -437,17 +435,17 @@ function subtest_reordering(</span>
<a href="#l43.290"></a><span id="l43.290">   let panel;</span>
<a href="#l43.291"></a><span id="l43.291"> </span>
<a href="#l43.292"></a><span id="l43.292">   // Create a set of attachments for the test.</span>
<a href="#l43.293"></a><span id="l43.293">   const size = 1234;</span>
<a href="#l43.294"></a><span id="l43.294">   for (let name of aInitialAttachmentNames) {</span>
<a href="#l43.295"></a><span id="l43.295">     add_attachments(aCwc, filePrefix + name, size);</span>
<a href="#l43.296"></a><span id="l43.296">   }</span>
<a href="#l43.297"></a><span id="l43.297">   aCwc.sleep(0);</span>
<a href="#l43.298"></a><span id="l43.298" class="difflineminus">-  assert_equals(aCwc.window.attachmentsCount(), aInitialAttachmentNames.length);</span>
<a href="#l43.299"></a><span id="l43.299" class="difflineplus">+  Assert.equal(aCwc.window.attachmentsCount(), aInitialAttachmentNames.length);</span>
<a href="#l43.300"></a><span id="l43.300">   check_attachment_names(aCwc, aInitialAttachmentNames);</span>
<a href="#l43.301"></a><span id="l43.301"> </span>
<a href="#l43.302"></a><span id="l43.302">   if (aOpenPanel) {</span>
<a href="#l43.303"></a><span id="l43.303">     // Bring up the reordering panel.</span>
<a href="#l43.304"></a><span id="l43.304">     aCwc.window.showReorderAttachmentsPanel();</span>
<a href="#l43.305"></a><span id="l43.305">     aCwc.sleep(0);</span>
<a href="#l43.306"></a><span id="l43.306">     panel = aCwc.e(&quot;reorderAttachmentsPanel&quot;);</span>
<a href="#l43.307"></a><span id="l43.307">     wait_for_popup_to_open(panel);</span>
<a href="#l43.308"></a><span id="l43.308" class="difflineat">@@ -483,17 +481,17 @@ function subtest_reordering(</span>
<a href="#l43.309"></a><span id="l43.309">   aCwc.window.RemoveAllAttachments();</span>
<a href="#l43.310"></a><span id="l43.310"> }</span>
<a href="#l43.311"></a><span id="l43.311"> </span>
<a href="#l43.312"></a><span id="l43.312"> /**</span>
<a href="#l43.313"></a><span id="l43.313">  * Bug 663695, Bug 1417856, Bug 1426344, Bug 1425891, Bug 1427037.</span>
<a href="#l43.314"></a><span id="l43.314">  * Check basic and advanced attachment reordering operations.</span>
<a href="#l43.315"></a><span id="l43.315">  * This is the main function of this test.</span>
<a href="#l43.316"></a><span id="l43.316">  */</span>
<a href="#l43.317"></a><span id="l43.317" class="difflineminus">-function test_attachment_reordering() {</span>
<a href="#l43.318"></a><span id="l43.318" class="difflineplus">+add_task(function test_attachment_reordering() {</span>
<a href="#l43.319"></a><span id="l43.319">   let cwc = open_compose_new_mail();</span>
<a href="#l43.320"></a><span id="l43.320">   let editorEl = cwc.window.GetCurrentEditorElement();</span>
<a href="#l43.321"></a><span id="l43.321">   let bucket = cwc.e(&quot;attachmentBucket&quot;);</span>
<a href="#l43.322"></a><span id="l43.322">   let panel = cwc.e(&quot;reorderAttachmentsPanel&quot;);</span>
<a href="#l43.323"></a><span id="l43.323">   // const openReorderPanelModifiers =</span>
<a href="#l43.324"></a><span id="l43.324">   //   (AppConstants.platform == &quot;macosx&quot;) ? { controlKey: true }</span>
<a href="#l43.325"></a><span id="l43.325">   //                                       : { altKey: true };</span>
<a href="#l43.326"></a><span id="l43.326"> </span>
<a href="#l43.327"></a><span id="l43.327" class="difflineat">@@ -502,17 +500,17 @@ function test_attachment_reordering() {</span>
<a href="#l43.328"></a><span id="l43.328"> </span>
<a href="#l43.329"></a><span id="l43.329">   // Create two attachments as otherwise the reordering panel won't open.</span>
<a href="#l43.330"></a><span id="l43.330">   const size = 1234;</span>
<a href="#l43.331"></a><span id="l43.331">   const initialAttachmentNames_0 = [&quot;A1&quot;, &quot;A2&quot;];</span>
<a href="#l43.332"></a><span id="l43.332">   for (let name of initialAttachmentNames_0) {</span>
<a href="#l43.333"></a><span id="l43.333">     add_attachments(cwc, filePrefix + name, size);</span>
<a href="#l43.334"></a><span id="l43.334">     cwc.sleep(0);</span>
<a href="#l43.335"></a><span id="l43.335">   }</span>
<a href="#l43.336"></a><span id="l43.336" class="difflineminus">-  assert_equals(cwc.window.attachmentsCount(), initialAttachmentNames_0.length);</span>
<a href="#l43.337"></a><span id="l43.337" class="difflineplus">+  Assert.equal(cwc.window.attachmentsCount(), initialAttachmentNames_0.length);</span>
<a href="#l43.338"></a><span id="l43.338">   check_attachment_names(cwc, initialAttachmentNames_0);</span>
<a href="#l43.339"></a><span id="l43.339"> </span>
<a href="#l43.340"></a><span id="l43.340">   // Show 'Reorder Attachments' panel via mouse clicks.</span>
<a href="#l43.341"></a><span id="l43.341">   cwc.rightClick(new elib.Elem(bucket.getItemAtIndex(1)));</span>
<a href="#l43.342"></a><span id="l43.342">   cwc.click_menus_in_sequence(cwc.e(&quot;msgComposeAttachmentItemContext&quot;), [</span>
<a href="#l43.343"></a><span id="l43.343">     { id: &quot;composeAttachmentContext_reorderItem&quot; },</span>
<a href="#l43.344"></a><span id="l43.344">   ]);</span>
<a href="#l43.345"></a><span id="l43.345">   wait_for_popup_to_open(panel);</span>
<a href="#l43.346"></a><span id="l43.346" class="difflineat">@@ -966,12 +964,12 @@ function test_attachment_reordering() {</span>
<a href="#l43.347"></a><span id="l43.347">   // Check 4 (Alt+Y keyboard shortcut for sorting) without panel.</span>
<a href="#l43.348"></a><span id="l43.348">   subtest_reordering(cwc, initialAttachmentNames_4, reorderActions_4, false);</span>
<a href="#l43.349"></a><span id="l43.349">   // Check 4 (Alt+Y keyboard shortcut for sorting) with panel open.</span>
<a href="#l43.350"></a><span id="l43.350">   subtest_reordering(cwc, initialAttachmentNames_4, reorderActions_4);</span>
<a href="#l43.351"></a><span id="l43.351">   // XXX When the root problem of bug 1425891 has been found and fixed, we should</span>
<a href="#l43.352"></a><span id="l43.352">   // test here if the panel stays open as it should, esp. on Windows.</span>
<a href="#l43.353"></a><span id="l43.353"> </span>
<a href="#l43.354"></a><span id="l43.354">   close_compose_window(cwc);</span>
<a href="#l43.355"></a><span id="l43.355" class="difflineminus">-}</span>
<a href="#l43.356"></a><span id="l43.356" class="difflineplus">+});</span>
<a href="#l43.357"></a><span id="l43.357"> </span>
<a href="#l43.358"></a><span id="l43.358"> // XXX: Test attached emails dragged onto composer and files pulled from other</span>
<a href="#l43.359"></a><span id="l43.359"> // emails (this probably requires better drag-and-drop support from Mozmill)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1">copy from mail/test/mozmill/composition/test-attachment-reminder.js</span>
<a href="#l44.2"></a><span id="l44.2">copy to mail/test/browser/composition/browser_attachmentReminder.js</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-attachment-reminder.js</span>
<a href="#l44.4"></a><span id="l44.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_attachmentReminder.js</span>
<a href="#l44.5"></a><span id="l44.5" class="difflineat">@@ -3,26 +3,28 @@</span>
<a href="#l44.6"></a><span id="l44.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l44.7"></a><span id="l44.7"> </span>
<a href="#l44.8"></a><span id="l44.8"> /**</span>
<a href="#l44.9"></a><span id="l44.9">  * Tests that the attachment reminder works properly.</span>
<a href="#l44.10"></a><span id="l44.10">  */</span>
<a href="#l44.11"></a><span id="l44.11"> </span>
<a href="#l44.12"></a><span id="l44.12"> &quot;use strict&quot;;</span>
<a href="#l44.13"></a><span id="l44.13"> </span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+var elementslib = ChromeUtils.import(</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+);</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+</span>
<a href="#l44.18"></a><span id="l44.18"> var {</span>
<a href="#l44.19"></a><span id="l44.19">   add_attachments,</span>
<a href="#l44.20"></a><span id="l44.20">   close_compose_window,</span>
<a href="#l44.21"></a><span id="l44.21">   open_compose_new_mail,</span>
<a href="#l44.22"></a><span id="l44.22">   setup_msg_contents,</span>
<a href="#l44.23"></a><span id="l44.23">   wait_for_compose_window,</span>
<a href="#l44.24"></a><span id="l44.24"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l44.25"></a><span id="l44.25"> var {</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineminus">-  assert_equals,</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineminus">-  assert_true,</span>
<a href="#l44.28"></a><span id="l44.28">   be_in_folder,</span>
<a href="#l44.29"></a><span id="l44.29">   get_special_folder,</span>
<a href="#l44.30"></a><span id="l44.30">   mc,</span>
<a href="#l44.31"></a><span id="l44.31">   press_delete,</span>
<a href="#l44.32"></a><span id="l44.32">   select_click_row,</span>
<a href="#l44.33"></a><span id="l44.33"> } = ChromeUtils.import(</span>
<a href="#l44.34"></a><span id="l44.34">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l44.35"></a><span id="l44.35"> );</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineat">@@ -54,22 +56,24 @@ var { MailServices } = ChromeUtils.impor</span>
<a href="#l44.37"></a><span id="l44.37"> );</span>
<a href="#l44.38"></a><span id="l44.38"> </span>
<a href="#l44.39"></a><span id="l44.39"> var kBoxId = &quot;compose-notification-bottom&quot;;</span>
<a href="#l44.40"></a><span id="l44.40"> var kNotificationId = &quot;attachmentReminder&quot;;</span>
<a href="#l44.41"></a><span id="l44.41"> var kReminderPref = &quot;mail.compose.attachment_reminder&quot;;</span>
<a href="#l44.42"></a><span id="l44.42"> var gDrafts;</span>
<a href="#l44.43"></a><span id="l44.43"> var gOutbox;</span>
<a href="#l44.44"></a><span id="l44.44"> </span>
<a href="#l44.45"></a><span id="l44.45" class="difflineminus">-function setupModule(module) {</span>
<a href="#l44.46"></a><span id="l44.46" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l44.47"></a><span id="l44.47" class="difflineplus">+  requestLongerTimeout(4);</span>
<a href="#l44.48"></a><span id="l44.48" class="difflineplus">+</span>
<a href="#l44.49"></a><span id="l44.49">   gDrafts = get_special_folder(Ci.nsMsgFolderFlags.Drafts, true);</span>
<a href="#l44.50"></a><span id="l44.50">   gOutbox = get_special_folder(Ci.nsMsgFolderFlags.Queue);</span>
<a href="#l44.51"></a><span id="l44.51"> </span>
<a href="#l44.52"></a><span id="l44.52" class="difflineminus">-  assert_true(Services.prefs.getBoolPref(kReminderPref));</span>
<a href="#l44.53"></a><span id="l44.53" class="difflineminus">-}</span>
<a href="#l44.54"></a><span id="l44.54" class="difflineplus">+  Assert.ok(Services.prefs.getBoolPref(kReminderPref));</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineplus">+});</span>
<a href="#l44.56"></a><span id="l44.56"> </span>
<a href="#l44.57"></a><span id="l44.57"> /**</span>
<a href="#l44.58"></a><span id="l44.58">  * Check if the attachment reminder bar is in the wished state.</span>
<a href="#l44.59"></a><span id="l44.59">  *</span>
<a href="#l44.60"></a><span id="l44.60">  * @param aCwc    A compose window controller.</span>
<a href="#l44.61"></a><span id="l44.61">  * @param aShown  True for expecting the bar to be shown, false otherwise.</span>
<a href="#l44.62"></a><span id="l44.62">  *</span>
<a href="#l44.63"></a><span id="l44.63">  * @return        If the bar is shown, return the notification object.</span>
<a href="#l44.64"></a><span id="l44.64" class="difflineat">@@ -110,23 +114,23 @@ function wait_for_reminder_state(aCwc, a</span>
<a href="#l44.65"></a><span id="l44.65"> /**</span>
<a href="#l44.66"></a><span id="l44.66">  * Check whether the manual reminder is in the proper state.</span>
<a href="#l44.67"></a><span id="l44.67">  *</span>
<a href="#l44.68"></a><span id="l44.68">  * @param aCwc      A compose window controller.</span>
<a href="#l44.69"></a><span id="l44.69">  * @param aChecked  Whether the reminder should be enabled.</span>
<a href="#l44.70"></a><span id="l44.70">  */</span>
<a href="#l44.71"></a><span id="l44.71"> function assert_manual_reminder_state(aCwc, aChecked) {</span>
<a href="#l44.72"></a><span id="l44.72">   const remindCommand = &quot;cmd_remindLater&quot;;</span>
<a href="#l44.73"></a><span id="l44.73" class="difflineminus">-  assert_equals(</span>
<a href="#l44.74"></a><span id="l44.74" class="difflineplus">+  Assert.equal(</span>
<a href="#l44.75"></a><span id="l44.75">     aCwc.e(&quot;button-attachPopup_remindLaterItem&quot;).getAttribute(&quot;command&quot;),</span>
<a href="#l44.76"></a><span id="l44.76">     remindCommand</span>
<a href="#l44.77"></a><span id="l44.77">   );</span>
<a href="#l44.78"></a><span id="l44.78"> </span>
<a href="#l44.79"></a><span id="l44.79">   let checkedValue = aChecked ? &quot;true&quot; : &quot;false&quot;;</span>
<a href="#l44.80"></a><span id="l44.80" class="difflineminus">-  assert_equals(aCwc.e(remindCommand).getAttribute(&quot;checked&quot;), checkedValue);</span>
<a href="#l44.81"></a><span id="l44.81" class="difflineplus">+  Assert.equal(aCwc.e(remindCommand).getAttribute(&quot;checked&quot;), checkedValue);</span>
<a href="#l44.82"></a><span id="l44.82"> }</span>
<a href="#l44.83"></a><span id="l44.83"> </span>
<a href="#l44.84"></a><span id="l44.84"> /**</span>
<a href="#l44.85"></a><span id="l44.85">  * Returns the keywords string currently shown in the notification message.</span>
<a href="#l44.86"></a><span id="l44.86">  *</span>
<a href="#l44.87"></a><span id="l44.87">  * @param aCwc A compose window controller.</span>
<a href="#l44.88"></a><span id="l44.88">  */</span>
<a href="#l44.89"></a><span id="l44.89"> function get_reminder_keywords(aCwc) {</span>
<a href="#l44.90"></a><span id="l44.90" class="difflineat">@@ -137,17 +141,17 @@ function get_reminder_keywords(aCwc) {</span>
<a href="#l44.91"></a><span id="l44.91">   return notification</span>
<a href="#l44.92"></a><span id="l44.92">     .querySelector(&quot;#attachmentKeywords&quot;)</span>
<a href="#l44.93"></a><span id="l44.93">     .getAttribute(&quot;value&quot;);</span>
<a href="#l44.94"></a><span id="l44.94"> }</span>
<a href="#l44.95"></a><span id="l44.95"> </span>
<a href="#l44.96"></a><span id="l44.96"> /**</span>
<a href="#l44.97"></a><span id="l44.97">  * Test that the attachment reminder works, in general.</span>
<a href="#l44.98"></a><span id="l44.98">  */</span>
<a href="#l44.99"></a><span id="l44.99" class="difflineminus">-function test_attachment_reminder_appears_properly() {</span>
<a href="#l44.100"></a><span id="l44.100" class="difflineplus">+add_task(function test_attachment_reminder_appears_properly() {</span>
<a href="#l44.101"></a><span id="l44.101">   let cwc = open_compose_new_mail();</span>
<a href="#l44.102"></a><span id="l44.102"> </span>
<a href="#l44.103"></a><span id="l44.103">   // There should be no notification yet.</span>
<a href="#l44.104"></a><span id="l44.104">   assert_automatic_reminder_state(cwc, false);</span>
<a href="#l44.105"></a><span id="l44.105"> </span>
<a href="#l44.106"></a><span id="l44.106">   setup_msg_contents(</span>
<a href="#l44.107"></a><span id="l44.107">     cwc,</span>
<a href="#l44.108"></a><span id="l44.108">     &quot;test@example.org&quot;,</span>
<a href="#l44.109"></a><span id="l44.109" class="difflineat">@@ -181,23 +185,23 @@ function test_attachment_reminder_appear</span>
<a href="#l44.110"></a><span id="l44.110">   plan_for_modal_dialog(&quot;commonDialog&quot;, click_oh_i_did);</span>
<a href="#l44.111"></a><span id="l44.111">   cwc.click(cwc.eid(&quot;button-send&quot;));</span>
<a href="#l44.112"></a><span id="l44.112">   wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l44.113"></a><span id="l44.113"> </span>
<a href="#l44.114"></a><span id="l44.114">   // After confirming the reminder the menuitem should get disabled.</span>
<a href="#l44.115"></a><span id="l44.115">   assert_manual_reminder_state(cwc, false);</span>
<a href="#l44.116"></a><span id="l44.116"> </span>
<a href="#l44.117"></a><span id="l44.117">   close_compose_window(cwc);</span>
<a href="#l44.118"></a><span id="l44.118" class="difflineminus">-}</span>
<a href="#l44.119"></a><span id="l44.119" class="difflineplus">+});</span>
<a href="#l44.120"></a><span id="l44.120"> </span>
<a href="#l44.121"></a><span id="l44.121"> /**</span>
<a href="#l44.122"></a><span id="l44.122">  * Test that the alert appears normally, but not after closing the</span>
<a href="#l44.123"></a><span id="l44.123">  * notification.</span>
<a href="#l44.124"></a><span id="l44.124">  */</span>
<a href="#l44.125"></a><span id="l44.125" class="difflineminus">-function test_attachment_reminder_dismissal() {</span>
<a href="#l44.126"></a><span id="l44.126" class="difflineplus">+add_task(function test_attachment_reminder_dismissal() {</span>
<a href="#l44.127"></a><span id="l44.127">   let cwc = open_compose_new_mail();</span>
<a href="#l44.128"></a><span id="l44.128"> </span>
<a href="#l44.129"></a><span id="l44.129">   // There should be no notification yet.</span>
<a href="#l44.130"></a><span id="l44.130">   assert_automatic_reminder_state(cwc, false);</span>
<a href="#l44.131"></a><span id="l44.131"> </span>
<a href="#l44.132"></a><span id="l44.132">   setup_msg_contents(</span>
<a href="#l44.133"></a><span id="l44.133">     cwc,</span>
<a href="#l44.134"></a><span id="l44.134">     &quot;test@example.org&quot;,</span>
<a href="#l44.135"></a><span id="l44.135" class="difflineat">@@ -205,39 +209,39 @@ function test_attachment_reminder_dismis</span>
<a href="#l44.136"></a><span id="l44.136">     &quot;Hi there, remember the attachment! &quot; +</span>
<a href="#l44.137"></a><span id="l44.137">       &quot;Yes, there is a file test.doc attached! &quot; +</span>
<a href="#l44.138"></a><span id="l44.138">       &quot;Do check it, test.doc is a nice attachment.&quot;</span>
<a href="#l44.139"></a><span id="l44.139">   );</span>
<a href="#l44.140"></a><span id="l44.140"> </span>
<a href="#l44.141"></a><span id="l44.141">   // Give the notification time to appear.</span>
<a href="#l44.142"></a><span id="l44.142">   wait_for_reminder_state(cwc, true);</span>
<a href="#l44.143"></a><span id="l44.143"> </span>
<a href="#l44.144"></a><span id="l44.144" class="difflineminus">-  assert_equals(get_reminder_keywords(cwc), &quot;test.doc, attachment, attached&quot;);</span>
<a href="#l44.145"></a><span id="l44.145" class="difflineplus">+  Assert.equal(get_reminder_keywords(cwc), &quot;test.doc, attachment, attached&quot;);</span>
<a href="#l44.146"></a><span id="l44.146"> </span>
<a href="#l44.147"></a><span id="l44.147">   // We didn't click the &quot;Remind Me Later&quot; - the alert should pop up</span>
<a href="#l44.148"></a><span id="l44.148">   // on send anyway.</span>
<a href="#l44.149"></a><span id="l44.149">   plan_for_modal_dialog(&quot;commonDialog&quot;, click_oh_i_did);</span>
<a href="#l44.150"></a><span id="l44.150">   cwc.click(cwc.eid(&quot;button-send&quot;));</span>
<a href="#l44.151"></a><span id="l44.151">   wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l44.152"></a><span id="l44.152"> </span>
<a href="#l44.153"></a><span id="l44.153">   let notification = assert_automatic_reminder_state(cwc, true);</span>
<a href="#l44.154"></a><span id="l44.154"> </span>
<a href="#l44.155"></a><span id="l44.155">   notification.close();</span>
<a href="#l44.156"></a><span id="l44.156">   assert_automatic_reminder_state(cwc, false);</span>
<a href="#l44.157"></a><span id="l44.157"> </span>
<a href="#l44.158"></a><span id="l44.158">   click_send_and_handle_send_error(cwc);</span>
<a href="#l44.159"></a><span id="l44.159"> </span>
<a href="#l44.160"></a><span id="l44.160">   close_compose_window(cwc);</span>
<a href="#l44.161"></a><span id="l44.161" class="difflineminus">-}</span>
<a href="#l44.162"></a><span id="l44.162" class="difflineplus">+});</span>
<a href="#l44.163"></a><span id="l44.163"> </span>
<a href="#l44.164"></a><span id="l44.164"> /**</span>
<a href="#l44.165"></a><span id="l44.165">  * Bug 938829</span>
<a href="#l44.166"></a><span id="l44.166">  * Check that adding an attachment actually hides the notification.</span>
<a href="#l44.167"></a><span id="l44.167">  */</span>
<a href="#l44.168"></a><span id="l44.168" class="difflineminus">-function test_attachment_reminder_with_attachment() {</span>
<a href="#l44.169"></a><span id="l44.169" class="difflineplus">+add_task(function test_attachment_reminder_with_attachment() {</span>
<a href="#l44.170"></a><span id="l44.170">   let cwc = open_compose_new_mail();</span>
<a href="#l44.171"></a><span id="l44.171"> </span>
<a href="#l44.172"></a><span id="l44.172">   // There should be no notification yet.</span>
<a href="#l44.173"></a><span id="l44.173">   assert_automatic_reminder_state(cwc, false);</span>
<a href="#l44.174"></a><span id="l44.174"> </span>
<a href="#l44.175"></a><span id="l44.175">   setup_msg_contents(</span>
<a href="#l44.176"></a><span id="l44.176">     cwc,</span>
<a href="#l44.177"></a><span id="l44.177">     &quot;test@example.org&quot;,</span>
<a href="#l44.178"></a><span id="l44.178" class="difflineat">@@ -246,17 +250,17 @@ function test_attachment_reminder_with_a</span>
<a href="#l44.179"></a><span id="l44.179">   );</span>
<a href="#l44.180"></a><span id="l44.180"> </span>
<a href="#l44.181"></a><span id="l44.181">   // Give the notification time to appear. It should.</span>
<a href="#l44.182"></a><span id="l44.182">   wait_for_reminder_state(cwc, true);</span>
<a href="#l44.183"></a><span id="l44.183"> </span>
<a href="#l44.184"></a><span id="l44.184">   // Add an attachment.</span>
<a href="#l44.185"></a><span id="l44.185">   let file = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l44.186"></a><span id="l44.186">   file.append(&quot;panacea.dat&quot;);</span>
<a href="#l44.187"></a><span id="l44.187" class="difflineminus">-  assert_true(</span>
<a href="#l44.188"></a><span id="l44.188" class="difflineplus">+  Assert.ok(</span>
<a href="#l44.189"></a><span id="l44.189">     file.exists(),</span>
<a href="#l44.190"></a><span id="l44.190">     &quot;The required file panacea.dat was not found in the profile.&quot;</span>
<a href="#l44.191"></a><span id="l44.191">   );</span>
<a href="#l44.192"></a><span id="l44.192">   let attachment = [cwc.window.FileToAttachment(file)];</span>
<a href="#l44.193"></a><span id="l44.193">   cwc.window.AddAttachments(attachment);</span>
<a href="#l44.194"></a><span id="l44.194"> </span>
<a href="#l44.195"></a><span id="l44.195">   // The notification should hide.</span>
<a href="#l44.196"></a><span id="l44.196">   wait_for_reminder_state(cwc, false);</span>
<a href="#l44.197"></a><span id="l44.197" class="difflineat">@@ -267,25 +271,25 @@ function test_attachment_reminder_with_a</span>
<a href="#l44.198"></a><span id="l44.198">   // Give the notification time to appear. It shouldn't.</span>
<a href="#l44.199"></a><span id="l44.199">   wait_for_reminder_state(cwc, false);</span>
<a href="#l44.200"></a><span id="l44.200"> </span>
<a href="#l44.201"></a><span id="l44.201">   cwc.window.RemoveAllAttachments();</span>
<a href="#l44.202"></a><span id="l44.202"> </span>
<a href="#l44.203"></a><span id="l44.203">   // After removing the attachment, notification should come back</span>
<a href="#l44.204"></a><span id="l44.204">   // with all the keywords, even those input while having an attachment.</span>
<a href="#l44.205"></a><span id="l44.205">   wait_for_reminder_state(cwc, true);</span>
<a href="#l44.206"></a><span id="l44.206" class="difflineminus">-  assert_equals(get_reminder_keywords(cwc), &quot;attachment, attached&quot;);</span>
<a href="#l44.207"></a><span id="l44.207" class="difflineplus">+  Assert.equal(get_reminder_keywords(cwc), &quot;attachment, attached&quot;);</span>
<a href="#l44.208"></a><span id="l44.208"> </span>
<a href="#l44.209"></a><span id="l44.209">   close_compose_window(cwc);</span>
<a href="#l44.210"></a><span id="l44.210" class="difflineminus">-}</span>
<a href="#l44.211"></a><span id="l44.211" class="difflineplus">+});</span>
<a href="#l44.212"></a><span id="l44.212"> </span>
<a href="#l44.213"></a><span id="l44.213"> /**</span>
<a href="#l44.214"></a><span id="l44.214">  * Test that the mail.compose.attachment_reminder_aggressive pref works.</span>
<a href="#l44.215"></a><span id="l44.215">  */</span>
<a href="#l44.216"></a><span id="l44.216" class="difflineminus">-function test_attachment_reminder_aggressive_pref() {</span>
<a href="#l44.217"></a><span id="l44.217" class="difflineplus">+add_task(function test_attachment_reminder_aggressive_pref() {</span>
<a href="#l44.218"></a><span id="l44.218">   const kPref = &quot;mail.compose.attachment_reminder_aggressive&quot;;</span>
<a href="#l44.219"></a><span id="l44.219">   Services.prefs.setBoolPref(kPref, false);</span>
<a href="#l44.220"></a><span id="l44.220"> </span>
<a href="#l44.221"></a><span id="l44.221">   let cwc = open_compose_new_mail();</span>
<a href="#l44.222"></a><span id="l44.222"> </span>
<a href="#l44.223"></a><span id="l44.223">   // There should be no notification yet.</span>
<a href="#l44.224"></a><span id="l44.224">   assert_automatic_reminder_state(cwc, false);</span>
<a href="#l44.225"></a><span id="l44.225"> </span>
<a href="#l44.226"></a><span id="l44.226" class="difflineat">@@ -300,23 +304,23 @@ function test_attachment_reminder_aggres</span>
<a href="#l44.227"></a><span id="l44.227">   click_send_and_handle_send_error(cwc);</span>
<a href="#l44.228"></a><span id="l44.228"> </span>
<a href="#l44.229"></a><span id="l44.229">   close_compose_window(cwc);</span>
<a href="#l44.230"></a><span id="l44.230"> </span>
<a href="#l44.231"></a><span id="l44.231">   // Now reset the pref back to original value.</span>
<a href="#l44.232"></a><span id="l44.232">   if (Services.prefs.prefHasUserValue(kPref)) {</span>
<a href="#l44.233"></a><span id="l44.233">     Services.prefs.clearUserPref(kPref);</span>
<a href="#l44.234"></a><span id="l44.234">   }</span>
<a href="#l44.235"></a><span id="l44.235" class="difflineminus">-}</span>
<a href="#l44.236"></a><span id="l44.236" class="difflineplus">+});</span>
<a href="#l44.237"></a><span id="l44.237"> </span>
<a href="#l44.238"></a><span id="l44.238"> /**</span>
<a href="#l44.239"></a><span id="l44.239">  * Test that clicking &quot;No, Send Now&quot; in the attachment reminder alert</span>
<a href="#l44.240"></a><span id="l44.240">  * works.</span>
<a href="#l44.241"></a><span id="l44.241">  */</span>
<a href="#l44.242"></a><span id="l44.242" class="difflineminus">-function test_no_send_now_sends() {</span>
<a href="#l44.243"></a><span id="l44.243" class="difflineplus">+add_task(function test_no_send_now_sends() {</span>
<a href="#l44.244"></a><span id="l44.244">   let cwc = open_compose_new_mail();</span>
<a href="#l44.245"></a><span id="l44.245"> </span>
<a href="#l44.246"></a><span id="l44.246">   setup_msg_contents(</span>
<a href="#l44.247"></a><span id="l44.247">     cwc,</span>
<a href="#l44.248"></a><span id="l44.248">     &quot;test@example.org&quot;,</span>
<a href="#l44.249"></a><span id="l44.249">     &quot;will the 'No, Send Now' button work?&quot;,</span>
<a href="#l44.250"></a><span id="l44.250">     &quot;Hello, I got your attachment!&quot;</span>
<a href="#l44.251"></a><span id="l44.251">   );</span>
<a href="#l44.252"></a><span id="l44.252" class="difflineat">@@ -328,17 +332,17 @@ function test_no_send_now_sends() {</span>
<a href="#l44.253"></a><span id="l44.253">   cwc.click(cwc.eid(&quot;button-send&quot;));</span>
<a href="#l44.254"></a><span id="l44.254">   wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l44.255"></a><span id="l44.255"> </span>
<a href="#l44.256"></a><span id="l44.256">   // After clicking &quot;Send Now&quot; sending is proceeding, just handle the error.</span>
<a href="#l44.257"></a><span id="l44.257">   click_send_and_handle_send_error(cwc, true);</span>
<a href="#l44.258"></a><span id="l44.258"> </span>
<a href="#l44.259"></a><span id="l44.259">   // We're now back in the compose window, let's close it then.</span>
<a href="#l44.260"></a><span id="l44.260">   close_compose_window(cwc);</span>
<a href="#l44.261"></a><span id="l44.261" class="difflineminus">-}</span>
<a href="#l44.262"></a><span id="l44.262" class="difflineplus">+});</span>
<a href="#l44.263"></a><span id="l44.263"> </span>
<a href="#l44.264"></a><span id="l44.264"> /**</span>
<a href="#l44.265"></a><span id="l44.265">  * Click the manual reminder in the menu.</span>
<a href="#l44.266"></a><span id="l44.266">  *</span>
<a href="#l44.267"></a><span id="l44.267">  * @param aCwc            A compose window controller.</span>
<a href="#l44.268"></a><span id="l44.268">  * @param aExpectedState  A boolean specifying what is the expected state</span>
<a href="#l44.269"></a><span id="l44.269">  *                        of the reminder menuitem after the click.</span>
<a href="#l44.270"></a><span id="l44.270">  */</span>
<a href="#l44.271"></a><span id="l44.271" class="difflineat">@@ -357,17 +361,17 @@ function click_manual_reminder(aCwc, aEx</span>
<a href="#l44.272"></a><span id="l44.272">   wait_for_window_focused(aCwc.window);</span>
<a href="#l44.273"></a><span id="l44.273">   assert_manual_reminder_state(aCwc, aExpectedState);</span>
<a href="#l44.274"></a><span id="l44.274"> }</span>
<a href="#l44.275"></a><span id="l44.275"> </span>
<a href="#l44.276"></a><span id="l44.276"> /**</span>
<a href="#l44.277"></a><span id="l44.277">  * Bug 521128</span>
<a href="#l44.278"></a><span id="l44.278">  * Test proper behaviour of the manual reminder.</span>
<a href="#l44.279"></a><span id="l44.279">  */</span>
<a href="#l44.280"></a><span id="l44.280" class="difflineminus">-function test_manual_attachment_reminder() {</span>
<a href="#l44.281"></a><span id="l44.281" class="difflineplus">+add_task(function test_manual_attachment_reminder() {</span>
<a href="#l44.282"></a><span id="l44.282">   // Open a sample message with no attachment keywords.</span>
<a href="#l44.283"></a><span id="l44.283">   let cwc = open_compose_new_mail();</span>
<a href="#l44.284"></a><span id="l44.284">   setup_msg_contents(</span>
<a href="#l44.285"></a><span id="l44.285">     cwc,</span>
<a href="#l44.286"></a><span id="l44.286">     &quot;test@example.invalid&quot;,</span>
<a href="#l44.287"></a><span id="l44.287">     &quot;Testing manual reminder!&quot;,</span>
<a href="#l44.288"></a><span id="l44.288">     &quot;Some body...&quot;</span>
<a href="#l44.289"></a><span id="l44.289">   );</span>
<a href="#l44.290"></a><span id="l44.290" class="difflineat">@@ -425,24 +429,23 @@ function test_manual_attachment_reminder</span>
<a href="#l44.291"></a><span id="l44.291"> </span>
<a href="#l44.292"></a><span id="l44.292">   // Now try to send again, there should be no more alert.</span>
<a href="#l44.293"></a><span id="l44.293">   click_send_and_handle_send_error(cwc);</span>
<a href="#l44.294"></a><span id="l44.294"> </span>
<a href="#l44.295"></a><span id="l44.295">   close_compose_window(cwc);</span>
<a href="#l44.296"></a><span id="l44.296"> </span>
<a href="#l44.297"></a><span id="l44.297">   // Delete the leftover draft message.</span>
<a href="#l44.298"></a><span id="l44.298">   press_delete();</span>
<a href="#l44.299"></a><span id="l44.299" class="difflineminus">-}</span>
<a href="#l44.300"></a><span id="l44.300" class="difflineminus">-test_manual_attachment_reminder.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;linux&quot;]; // See bug 1535292.</span>
<a href="#l44.301"></a><span id="l44.301" class="difflineplus">+}).__skipMe = AppConstants.platform == &quot;linux&quot;; // See bug 1535292.</span>
<a href="#l44.302"></a><span id="l44.302"> </span>
<a href="#l44.303"></a><span id="l44.303"> /**</span>
<a href="#l44.304"></a><span id="l44.304">  * Bug 938759</span>
<a href="#l44.305"></a><span id="l44.305">  * Test hiding of the automatic notification if the manual reminder is set.</span>
<a href="#l44.306"></a><span id="l44.306">  */</span>
<a href="#l44.307"></a><span id="l44.307" class="difflineminus">-function test_manual_automatic_attachment_reminder_interaction() {</span>
<a href="#l44.308"></a><span id="l44.308" class="difflineplus">+add_task(function test_manual_automatic_attachment_reminder_interaction() {</span>
<a href="#l44.309"></a><span id="l44.309">   // Open a blank message compose</span>
<a href="#l44.310"></a><span id="l44.310">   let cwc = open_compose_new_mail();</span>
<a href="#l44.311"></a><span id="l44.311">   // This one should have the reminder disabled.</span>
<a href="#l44.312"></a><span id="l44.312">   assert_manual_reminder_state(cwc, false);</span>
<a href="#l44.313"></a><span id="l44.313">   // There should be no attachment notification.</span>
<a href="#l44.314"></a><span id="l44.314">   assert_automatic_reminder_state(cwc, false);</span>
<a href="#l44.315"></a><span id="l44.315"> </span>
<a href="#l44.316"></a><span id="l44.316">   // Add some attachment keywords.</span>
<a href="#l44.317"></a><span id="l44.317" class="difflineat">@@ -476,20 +479,20 @@ function test_manual_automatic_attachmen</span>
<a href="#l44.318"></a><span id="l44.318">   setup_msg_contents(cwc, &quot;&quot;, &quot;&quot;, &quot; No keywords here.&quot;);</span>
<a href="#l44.319"></a><span id="l44.319">   // Give the notification time to appear. It shouldn't.</span>
<a href="#l44.320"></a><span id="l44.320">   wait_for_reminder_state(cwc, false);</span>
<a href="#l44.321"></a><span id="l44.321"> </span>
<a href="#l44.322"></a><span id="l44.322">   // Add some more text with a new keyword.</span>
<a href="#l44.323"></a><span id="l44.323">   setup_msg_contents(cwc, &quot;&quot;, &quot;&quot;, &quot; Do you find it attached?&quot;);</span>
<a href="#l44.324"></a><span id="l44.324">   // Give the notification time to appear. It should now.</span>
<a href="#l44.325"></a><span id="l44.325">   wait_for_reminder_state(cwc, true);</span>
<a href="#l44.326"></a><span id="l44.326" class="difflineminus">-  assert_equals(get_reminder_keywords(cwc), &quot;attachment, attached&quot;);</span>
<a href="#l44.327"></a><span id="l44.327" class="difflineplus">+  Assert.equal(get_reminder_keywords(cwc), &quot;attachment, attached&quot;);</span>
<a href="#l44.328"></a><span id="l44.328"> </span>
<a href="#l44.329"></a><span id="l44.329">   close_compose_window(cwc);</span>
<a href="#l44.330"></a><span id="l44.330" class="difflineminus">-}</span>
<a href="#l44.331"></a><span id="l44.331" class="difflineplus">+});</span>
<a href="#l44.332"></a><span id="l44.332"> </span>
<a href="#l44.333"></a><span id="l44.333"> /**</span>
<a href="#l44.334"></a><span id="l44.334">  * Assert if there is any notification in the compose window.</span>
<a href="#l44.335"></a><span id="l44.335">  *</span>
<a href="#l44.336"></a><span id="l44.336">  * @param aCwc         Compose Window Controller</span>
<a href="#l44.337"></a><span id="l44.337">  * @param aValue       True if notification should exist.</span>
<a href="#l44.338"></a><span id="l44.338">  *                     False otherwise.</span>
<a href="#l44.339"></a><span id="l44.339">  */</span>
<a href="#l44.340"></a><span id="l44.340" class="difflineat">@@ -499,17 +502,17 @@ function assert_any_notification(aCwc, a</span>
<a href="#l44.341"></a><span id="l44.341">     throw new Error(&quot;Notification in wrong state&quot;);</span>
<a href="#l44.342"></a><span id="l44.342">   }</span>
<a href="#l44.343"></a><span id="l44.343"> }</span>
<a href="#l44.344"></a><span id="l44.344"> </span>
<a href="#l44.345"></a><span id="l44.345"> /**</span>
<a href="#l44.346"></a><span id="l44.346">  * Bug 989653</span>
<a href="#l44.347"></a><span id="l44.347">  * Send filelink attachment should not trigger the attachment reminder.</span>
<a href="#l44.348"></a><span id="l44.348">  */</span>
<a href="#l44.349"></a><span id="l44.349" class="difflineminus">-function test_attachment_vs_filelink_reminder() {</span>
<a href="#l44.350"></a><span id="l44.350" class="difflineplus">+add_task(function test_attachment_vs_filelink_reminder() {</span>
<a href="#l44.351"></a><span id="l44.351">   // Open a blank message compose</span>
<a href="#l44.352"></a><span id="l44.352">   let cwc = open_compose_new_mail();</span>
<a href="#l44.353"></a><span id="l44.353">   setup_msg_contents(</span>
<a href="#l44.354"></a><span id="l44.354">     cwc,</span>
<a href="#l44.355"></a><span id="l44.355">     &quot;test@example.invalid&quot;,</span>
<a href="#l44.356"></a><span id="l44.356">     &quot;Testing Filelink notification&quot;,</span>
<a href="#l44.357"></a><span id="l44.357">     &quot;There is no body. I hope you don't mind!&quot;</span>
<a href="#l44.358"></a><span id="l44.358">   );</span>
<a href="#l44.359"></a><span id="l44.359" class="difflineat">@@ -526,23 +529,23 @@ function test_attachment_vs_filelink_rem</span>
<a href="#l44.360"></a><span id="l44.360"> </span>
<a href="#l44.361"></a><span id="l44.361">   // The filelink attachment proposal should be up but not the attachment</span>
<a href="#l44.362"></a><span id="l44.362">   // reminder and it should also not interfere with the sending of the message.</span>
<a href="#l44.363"></a><span id="l44.363">   wait_for_notification_to_show(cwc, kBoxId, &quot;bigAttachment&quot;);</span>
<a href="#l44.364"></a><span id="l44.364">   assert_automatic_reminder_state(cwc, false);</span>
<a href="#l44.365"></a><span id="l44.365"> </span>
<a href="#l44.366"></a><span id="l44.366">   click_send_and_handle_send_error(cwc);</span>
<a href="#l44.367"></a><span id="l44.367">   close_window(cwc);</span>
<a href="#l44.368"></a><span id="l44.368" class="difflineminus">-}</span>
<a href="#l44.369"></a><span id="l44.369" class="difflineplus">+});</span>
<a href="#l44.370"></a><span id="l44.370"> </span>
<a href="#l44.371"></a><span id="l44.371"> /**</span>
<a href="#l44.372"></a><span id="l44.372">  * Bug 944643</span>
<a href="#l44.373"></a><span id="l44.373">  * Test the attachment reminder coming up when keyword is in subject line.</span>
<a href="#l44.374"></a><span id="l44.374">  */</span>
<a href="#l44.375"></a><span id="l44.375" class="difflineminus">-function test_attachment_reminder_in_subject() {</span>
<a href="#l44.376"></a><span id="l44.376" class="difflineplus">+add_task(function test_attachment_reminder_in_subject() {</span>
<a href="#l44.377"></a><span id="l44.377">   // Open a blank message compose</span>
<a href="#l44.378"></a><span id="l44.378">   let cwc = open_compose_new_mail();</span>
<a href="#l44.379"></a><span id="l44.379">   // This one should have the reminder disabled.</span>
<a href="#l44.380"></a><span id="l44.380">   assert_manual_reminder_state(cwc, false);</span>
<a href="#l44.381"></a><span id="l44.381">   // There should be no attachment notification.</span>
<a href="#l44.382"></a><span id="l44.382">   assert_automatic_reminder_state(cwc, false);</span>
<a href="#l44.383"></a><span id="l44.383"> </span>
<a href="#l44.384"></a><span id="l44.384">   // Add some attachment keyword in subject.</span>
<a href="#l44.385"></a><span id="l44.385" class="difflineat">@@ -550,33 +553,33 @@ function test_attachment_reminder_in_sub</span>
<a href="#l44.386"></a><span id="l44.386">     cwc,</span>
<a href="#l44.387"></a><span id="l44.387">     &quot;test@example.invalid&quot;,</span>
<a href="#l44.388"></a><span id="l44.388">     &quot;Testing attachment reminder!&quot;,</span>
<a href="#l44.389"></a><span id="l44.389">     &quot;There is no keyword in this body...&quot;</span>
<a href="#l44.390"></a><span id="l44.390">   );</span>
<a href="#l44.391"></a><span id="l44.391"> </span>
<a href="#l44.392"></a><span id="l44.392">   // The automatic attachment notification should pop up.</span>
<a href="#l44.393"></a><span id="l44.393">   wait_for_reminder_state(cwc, true);</span>
<a href="#l44.394"></a><span id="l44.394" class="difflineminus">-  assert_equals(get_reminder_keywords(cwc), &quot;attachment&quot;);</span>
<a href="#l44.395"></a><span id="l44.395" class="difflineplus">+  Assert.equal(get_reminder_keywords(cwc), &quot;attachment&quot;);</span>
<a href="#l44.396"></a><span id="l44.396"> </span>
<a href="#l44.397"></a><span id="l44.397">   // Now clear the subject</span>
<a href="#l44.398"></a><span id="l44.398">   delete_all_existing(cwc, cwc.eid(&quot;msgSubject&quot;));</span>
<a href="#l44.399"></a><span id="l44.399"> </span>
<a href="#l44.400"></a><span id="l44.400">   // Give the notification time to disappear.</span>
<a href="#l44.401"></a><span id="l44.401">   wait_for_reminder_state(cwc, false);</span>
<a href="#l44.402"></a><span id="l44.402"> </span>
<a href="#l44.403"></a><span id="l44.403">   close_compose_window(cwc);</span>
<a href="#l44.404"></a><span id="l44.404" class="difflineminus">-}</span>
<a href="#l44.405"></a><span id="l44.405" class="difflineplus">+});</span>
<a href="#l44.406"></a><span id="l44.406"> </span>
<a href="#l44.407"></a><span id="l44.407"> /**</span>
<a href="#l44.408"></a><span id="l44.408">  * Bug 944643</span>
<a href="#l44.409"></a><span id="l44.409">  * Test the attachment reminder coming up when keyword is in subject line</span>
<a href="#l44.410"></a><span id="l44.410">  * and also body.</span>
<a href="#l44.411"></a><span id="l44.411">  */</span>
<a href="#l44.412"></a><span id="l44.412" class="difflineminus">-function test_attachment_reminder_in_subject_and_body() {</span>
<a href="#l44.413"></a><span id="l44.413" class="difflineplus">+add_task(function test_attachment_reminder_in_subject_and_body() {</span>
<a href="#l44.414"></a><span id="l44.414">   // Open a blank message compose</span>
<a href="#l44.415"></a><span id="l44.415">   let cwc = open_compose_new_mail();</span>
<a href="#l44.416"></a><span id="l44.416">   // This one should have the reminder disabled.</span>
<a href="#l44.417"></a><span id="l44.417">   assert_manual_reminder_state(cwc, false);</span>
<a href="#l44.418"></a><span id="l44.418">   // There should be no attachment notification.</span>
<a href="#l44.419"></a><span id="l44.419">   assert_automatic_reminder_state(cwc, false);</span>
<a href="#l44.420"></a><span id="l44.420"> </span>
<a href="#l44.421"></a><span id="l44.421">   // Add some attachment keyword in subject.</span>
<a href="#l44.422"></a><span id="l44.422" class="difflineat">@@ -584,35 +587,35 @@ function test_attachment_reminder_in_sub</span>
<a href="#l44.423"></a><span id="l44.423">     cwc,</span>
<a href="#l44.424"></a><span id="l44.424">     &quot;test@example.invalid&quot;,</span>
<a href="#l44.425"></a><span id="l44.425">     &quot;Testing attachment reminder!&quot;,</span>
<a href="#l44.426"></a><span id="l44.426">     &quot;There should be an attached file in this body...&quot;</span>
<a href="#l44.427"></a><span id="l44.427">   );</span>
<a href="#l44.428"></a><span id="l44.428"> </span>
<a href="#l44.429"></a><span id="l44.429">   // The automatic attachment notification should pop up.</span>
<a href="#l44.430"></a><span id="l44.430">   wait_for_reminder_state(cwc, true);</span>
<a href="#l44.431"></a><span id="l44.431" class="difflineminus">-  assert_equals(get_reminder_keywords(cwc), &quot;attachment, attached&quot;);</span>
<a href="#l44.432"></a><span id="l44.432" class="difflineplus">+  Assert.equal(get_reminder_keywords(cwc), &quot;attachment, attached&quot;);</span>
<a href="#l44.433"></a><span id="l44.433"> </span>
<a href="#l44.434"></a><span id="l44.434">   // Now clear only the subject</span>
<a href="#l44.435"></a><span id="l44.435">   delete_all_existing(cwc, cwc.eid(&quot;msgSubject&quot;));</span>
<a href="#l44.436"></a><span id="l44.436"> </span>
<a href="#l44.437"></a><span id="l44.437">   // Give the notification some time. It should not disappear,</span>
<a href="#l44.438"></a><span id="l44.438">   // just reduce the keywords list.</span>
<a href="#l44.439"></a><span id="l44.439">   wait_for_reminder_state(cwc, true, true);</span>
<a href="#l44.440"></a><span id="l44.440" class="difflineminus">-  assert_equals(get_reminder_keywords(cwc), &quot;attached&quot;);</span>
<a href="#l44.441"></a><span id="l44.441" class="difflineplus">+  Assert.equal(get_reminder_keywords(cwc), &quot;attached&quot;);</span>
<a href="#l44.442"></a><span id="l44.442"> </span>
<a href="#l44.443"></a><span id="l44.443">   close_compose_window(cwc);</span>
<a href="#l44.444"></a><span id="l44.444" class="difflineminus">-}</span>
<a href="#l44.445"></a><span id="l44.445" class="difflineplus">+});</span>
<a href="#l44.446"></a><span id="l44.446"> </span>
<a href="#l44.447"></a><span id="l44.447"> /**</span>
<a href="#l44.448"></a><span id="l44.448">  * Bug 1099866</span>
<a href="#l44.449"></a><span id="l44.449">  * Test proper behaviour of attachment reminder when keyword reminding</span>
<a href="#l44.450"></a><span id="l44.450">  * is turned off.</span>
<a href="#l44.451"></a><span id="l44.451">  */</span>
<a href="#l44.452"></a><span id="l44.452" class="difflineminus">-function test_disabled_attachment_reminder() {</span>
<a href="#l44.453"></a><span id="l44.453" class="difflineplus">+add_task(function test_disabled_attachment_reminder() {</span>
<a href="#l44.454"></a><span id="l44.454">   Services.prefs.setBoolPref(kReminderPref, false);</span>
<a href="#l44.455"></a><span id="l44.455"> </span>
<a href="#l44.456"></a><span id="l44.456">   // Open a sample message with no attachment keywords.</span>
<a href="#l44.457"></a><span id="l44.457">   let cwc = open_compose_new_mail();</span>
<a href="#l44.458"></a><span id="l44.458">   setup_msg_contents(</span>
<a href="#l44.459"></a><span id="l44.459">     cwc,</span>
<a href="#l44.460"></a><span id="l44.460">     &quot;test@example.invalid&quot;,</span>
<a href="#l44.461"></a><span id="l44.461">     &quot;Testing disabled keyword reminder!&quot;,</span>
<a href="#l44.462"></a><span id="l44.462" class="difflineat">@@ -640,23 +643,23 @@ function test_disabled_attachment_remind</span>
<a href="#l44.463"></a><span id="l44.463">   assert_automatic_reminder_state(cwc, false);</span>
<a href="#l44.464"></a><span id="l44.464"> </span>
<a href="#l44.465"></a><span id="l44.465">   // There should be no attachment message upon send.</span>
<a href="#l44.466"></a><span id="l44.466">   click_send_and_handle_send_error(cwc);</span>
<a href="#l44.467"></a><span id="l44.467"> </span>
<a href="#l44.468"></a><span id="l44.468">   close_compose_window(cwc);</span>
<a href="#l44.469"></a><span id="l44.469"> </span>
<a href="#l44.470"></a><span id="l44.470">   Services.prefs.setBoolPref(kReminderPref, true);</span>
<a href="#l44.471"></a><span id="l44.471" class="difflineminus">-}</span>
<a href="#l44.472"></a><span id="l44.472" class="difflineplus">+});</span>
<a href="#l44.473"></a><span id="l44.473"> </span>
<a href="#l44.474"></a><span id="l44.474"> /**</span>
<a href="#l44.475"></a><span id="l44.475">  * Bug 833909</span>
<a href="#l44.476"></a><span id="l44.476">  * Test reminder comes up when a draft with keywords is opened.</span>
<a href="#l44.477"></a><span id="l44.477">  */</span>
<a href="#l44.478"></a><span id="l44.478" class="difflineminus">-function test_reminder_in_draft() {</span>
<a href="#l44.479"></a><span id="l44.479" class="difflineplus">+add_task(function test_reminder_in_draft() {</span>
<a href="#l44.480"></a><span id="l44.480">   // Open a sample message with no attachment keywords.</span>
<a href="#l44.481"></a><span id="l44.481">   let cwc = open_compose_new_mail();</span>
<a href="#l44.482"></a><span id="l44.482">   setup_msg_contents(</span>
<a href="#l44.483"></a><span id="l44.483">     cwc,</span>
<a href="#l44.484"></a><span id="l44.484">     &quot;test@example.invalid&quot;,</span>
<a href="#l44.485"></a><span id="l44.485">     &quot;Testing draft reminder!&quot;,</span>
<a href="#l44.486"></a><span id="l44.486">     &quot;Some body...&quot;</span>
<a href="#l44.487"></a><span id="l44.487">   );</span>
<a href="#l44.488"></a><span id="l44.488" class="difflineat">@@ -694,23 +697,23 @@ function test_reminder_in_draft() {</span>
<a href="#l44.489"></a><span id="l44.489"> </span>
<a href="#l44.490"></a><span id="l44.490">   // Give the notification time to appear.</span>
<a href="#l44.491"></a><span id="l44.491">   wait_for_reminder_state(cwc, true);</span>
<a href="#l44.492"></a><span id="l44.492"> </span>
<a href="#l44.493"></a><span id="l44.493">   close_compose_window(cwc);</span>
<a href="#l44.494"></a><span id="l44.494"> </span>
<a href="#l44.495"></a><span id="l44.495">   // Delete the leftover draft message.</span>
<a href="#l44.496"></a><span id="l44.496">   press_delete();</span>
<a href="#l44.497"></a><span id="l44.497" class="difflineminus">-}</span>
<a href="#l44.498"></a><span id="l44.498" class="difflineplus">+});</span>
<a href="#l44.499"></a><span id="l44.499"> </span>
<a href="#l44.500"></a><span id="l44.500"> /**</span>
<a href="#l44.501"></a><span id="l44.501">  * Bug 942436</span>
<a href="#l44.502"></a><span id="l44.502">  * Test that the reminder can be turned off for the current message.</span>
<a href="#l44.503"></a><span id="l44.503">  */</span>
<a href="#l44.504"></a><span id="l44.504" class="difflineminus">-function test_disabling_attachment_reminder() {</span>
<a href="#l44.505"></a><span id="l44.505" class="difflineplus">+add_task(function test_disabling_attachment_reminder() {</span>
<a href="#l44.506"></a><span id="l44.506">   // Open a sample message with attachment keywords.</span>
<a href="#l44.507"></a><span id="l44.507">   let cwc = open_compose_new_mail();</span>
<a href="#l44.508"></a><span id="l44.508">   setup_msg_contents(</span>
<a href="#l44.509"></a><span id="l44.509">     cwc,</span>
<a href="#l44.510"></a><span id="l44.510">     &quot;test@example.invalid&quot;,</span>
<a href="#l44.511"></a><span id="l44.511">     &quot;Testing turning off the reminder&quot;,</span>
<a href="#l44.512"></a><span id="l44.512">     &quot;Some attachment keywords here...&quot;</span>
<a href="#l44.513"></a><span id="l44.513">   );</span>
<a href="#l44.514"></a><span id="l44.514" class="difflineat">@@ -772,17 +775,17 @@ function test_disabling_attachment_remin</span>
<a href="#l44.515"></a><span id="l44.515"> </span>
<a href="#l44.516"></a><span id="l44.516">   select_click_row(0);</span>
<a href="#l44.517"></a><span id="l44.517">   // Delete the leftover outgoing message.</span>
<a href="#l44.518"></a><span id="l44.518">   press_delete();</span>
<a href="#l44.519"></a><span id="l44.519"> </span>
<a href="#l44.520"></a><span id="l44.520">   // Get back to the mail account for other tests.</span>
<a href="#l44.521"></a><span id="l44.521">   let mail = MailServices.accounts.defaultAccount.incomingServer.rootFolder;</span>
<a href="#l44.522"></a><span id="l44.522">   be_in_folder(mail);</span>
<a href="#l44.523"></a><span id="l44.523" class="difflineminus">-}</span>
<a href="#l44.524"></a><span id="l44.524" class="difflineplus">+});</span>
<a href="#l44.525"></a><span id="l44.525"> </span>
<a href="#l44.526"></a><span id="l44.526"> /**</span>
<a href="#l44.527"></a><span id="l44.527">  * Click the send button and handle the send error dialog popping up.</span>
<a href="#l44.528"></a><span id="l44.528">  * It will return us back to the compose window.</span>
<a href="#l44.529"></a><span id="l44.529">  *</span>
<a href="#l44.530"></a><span id="l44.530">  * @param aController</span>
<a href="#l44.531"></a><span id="l44.531">  * @param aAlreadySending  Set this to true if sending was already triggered</span>
<a href="#l44.532"></a><span id="l44.532">  *                         by other means.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1">copy from mail/test/mozmill/composition/test-base64-display.js</span>
<a href="#l45.2"></a><span id="l45.2">copy to mail/test/browser/composition/browser_base64Display.js</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-base64-display.js</span>
<a href="#l45.4"></a><span id="l45.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_base64Display.js</span>
<a href="#l45.5"></a><span id="l45.5" class="difflineat">@@ -3,31 +3,31 @@</span>
<a href="#l45.6"></a><span id="l45.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l45.7"></a><span id="l45.7"> </span>
<a href="#l45.8"></a><span id="l45.8"> /**</span>
<a href="#l45.9"></a><span id="l45.9">  * Tests that messages with &quot;broken&quot; base64 are correctly displayed.</span>
<a href="#l45.10"></a><span id="l45.10">  */</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12"> &quot;use strict&quot;;</span>
<a href="#l45.13"></a><span id="l45.13"> </span>
<a href="#l45.14"></a><span id="l45.14" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l45.16"></a><span id="l45.16"> </span>
<a href="#l45.17"></a><span id="l45.17" class="difflineminus">-var { assert_true, open_message_from_file } = ChromeUtils.import(</span>
<a href="#l45.18"></a><span id="l45.18" class="difflineplus">+var { open_message_from_file } = ChromeUtils.import(</span>
<a href="#l45.19"></a><span id="l45.19">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l45.20"></a><span id="l45.20"> );</span>
<a href="#l45.21"></a><span id="l45.21"> var { close_window } = ChromeUtils.import(</span>
<a href="#l45.22"></a><span id="l45.22">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l45.23"></a><span id="l45.23"> );</span>
<a href="#l45.24"></a><span id="l45.24"> </span>
<a href="#l45.25"></a><span id="l45.25" class="difflineminus">-function test_base64_display() {</span>
<a href="#l45.26"></a><span id="l45.26" class="difflineminus">-  let file = os.getFileForPath(</span>
<a href="#l45.27"></a><span id="l45.27" class="difflineminus">-    os.abspath(&quot;./base64-with-whitespace.eml&quot;, os.getFileForPath(__file__))</span>
<a href="#l45.28"></a><span id="l45.28" class="difflineplus">+add_task(function test_base64_display() {</span>
<a href="#l45.29"></a><span id="l45.29" class="difflineplus">+  let file = new FileUtils.File(</span>
<a href="#l45.30"></a><span id="l45.30" class="difflineplus">+    getTestFilePath(&quot;data/base64-with-whitespace.eml&quot;)</span>
<a href="#l45.31"></a><span id="l45.31">   );</span>
<a href="#l45.32"></a><span id="l45.32">   let msgc = open_message_from_file(file);</span>
<a href="#l45.33"></a><span id="l45.33">   let bodyText = msgc.e(&quot;messagepane&quot;).contentDocument.querySelector(&quot;body&quot;)</span>
<a href="#l45.34"></a><span id="l45.34">     .textContent;</span>
<a href="#l45.35"></a><span id="l45.35">   close_window(msgc);</span>
<a href="#l45.36"></a><span id="l45.36"> </span>
<a href="#l45.37"></a><span id="l45.37" class="difflineminus">-  assert_true(</span>
<a href="#l45.38"></a><span id="l45.38" class="difflineplus">+  Assert.ok(</span>
<a href="#l45.39"></a><span id="l45.39">     bodyText.includes(&quot;abcdefghijklmnopqrstuvwxyz&quot;),</span>
<a href="#l45.40"></a><span id="l45.40">     &quot;Decoded base64 text not found in message.&quot;</span>
<a href="#l45.41"></a><span id="l45.41">   );</span>
<a href="#l45.42"></a><span id="l45.42" class="difflineminus">-}</span>
<a href="#l45.43"></a><span id="l45.43" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1">copy from mail/test/mozmill/composition/test-blocked-content.js</span>
<a href="#l46.2"></a><span id="l46.2">copy to mail/test/browser/composition/browser_blockedContent.js</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-blocked-content.js</span>
<a href="#l46.4"></a><span id="l46.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_blockedContent.js</span>
<a href="#l46.5"></a><span id="l46.5" class="difflineat">@@ -3,26 +3,24 @@</span>
<a href="#l46.6"></a><span id="l46.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l46.7"></a><span id="l46.7"> </span>
<a href="#l46.8"></a><span id="l46.8"> /**</span>
<a href="#l46.9"></a><span id="l46.9">  * Tests that we do the right thing wrt. blocked resources during composition.</span>
<a href="#l46.10"></a><span id="l46.10">  */</span>
<a href="#l46.11"></a><span id="l46.11"> </span>
<a href="#l46.12"></a><span id="l46.12"> &quot;use strict&quot;;</span>
<a href="#l46.13"></a><span id="l46.13"> </span>
<a href="#l46.14"></a><span id="l46.14" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l46.16"></a><span id="l46.16"> </span>
<a href="#l46.17"></a><span id="l46.17"> var {</span>
<a href="#l46.18"></a><span id="l46.18">   get_msg_source,</span>
<a href="#l46.19"></a><span id="l46.19">   open_compose_new_mail,</span>
<a href="#l46.20"></a><span id="l46.20">   setup_msg_contents,</span>
<a href="#l46.21"></a><span id="l46.21"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l46.22"></a><span id="l46.22"> var {</span>
<a href="#l46.23"></a><span id="l46.23" class="difflineminus">-  assert_false,</span>
<a href="#l46.24"></a><span id="l46.24" class="difflineminus">-  assert_true,</span>
<a href="#l46.25"></a><span id="l46.25">   be_in_folder,</span>
<a href="#l46.26"></a><span id="l46.26">   get_special_folder,</span>
<a href="#l46.27"></a><span id="l46.27">   press_delete,</span>
<a href="#l46.28"></a><span id="l46.28">   select_click_row,</span>
<a href="#l46.29"></a><span id="l46.29"> } = ChromeUtils.import(</span>
<a href="#l46.30"></a><span id="l46.30">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l46.31"></a><span id="l46.31"> );</span>
<a href="#l46.32"></a><span id="l46.32"> var { wait_for_notification_to_show } = ChromeUtils.import(</span>
<a href="#l46.33"></a><span id="l46.33" class="difflineat">@@ -38,19 +36,19 @@ var { MailServices } = ChromeUtils.impor</span>
<a href="#l46.34"></a><span id="l46.34"> );</span>
<a href="#l46.35"></a><span id="l46.35"> var { OS } = ChromeUtils.import(&quot;resource://gre/modules/osfile.jsm&quot;);</span>
<a href="#l46.36"></a><span id="l46.36"> </span>
<a href="#l46.37"></a><span id="l46.37"> var gOutboxFolder;</span>
<a href="#l46.38"></a><span id="l46.38"> </span>
<a href="#l46.39"></a><span id="l46.39"> var kBoxId = &quot;compose-notification-bottom&quot;;</span>
<a href="#l46.40"></a><span id="l46.40"> var kNotificationId = &quot;blockedContent&quot;;</span>
<a href="#l46.41"></a><span id="l46.41"> </span>
<a href="#l46.42"></a><span id="l46.42" class="difflineminus">-function setupModule(module) {</span>
<a href="#l46.43"></a><span id="l46.43" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l46.44"></a><span id="l46.44">   gOutboxFolder = get_special_folder(Ci.nsMsgFolderFlags.Queue);</span>
<a href="#l46.45"></a><span id="l46.45" class="difflineminus">-}</span>
<a href="#l46.46"></a><span id="l46.46" class="difflineplus">+});</span>
<a href="#l46.47"></a><span id="l46.47"> </span>
<a href="#l46.48"></a><span id="l46.48"> function putHTMLOnClipboard(html) {</span>
<a href="#l46.49"></a><span id="l46.49">   let trans = Cc[&quot;@mozilla.org/widget/transferable;1&quot;].createInstance(</span>
<a href="#l46.50"></a><span id="l46.50">     Ci.nsITransferable</span>
<a href="#l46.51"></a><span id="l46.51">   );</span>
<a href="#l46.52"></a><span id="l46.52"> </span>
<a href="#l46.53"></a><span id="l46.53">   // Register supported data flavors</span>
<a href="#l46.54"></a><span id="l46.54">   trans.init(null);</span>
<a href="#l46.55"></a><span id="l46.55" class="difflineat">@@ -64,44 +62,44 @@ function putHTMLOnClipboard(html) {</span>
<a href="#l46.56"></a><span id="l46.56"> </span>
<a href="#l46.57"></a><span id="l46.57">   Services.clipboard.setData(trans, null, Ci.nsIClipboard.kGlobalClipboard);</span>
<a href="#l46.58"></a><span id="l46.58"> }</span>
<a href="#l46.59"></a><span id="l46.59"> </span>
<a href="#l46.60"></a><span id="l46.60"> /**</span>
<a href="#l46.61"></a><span id="l46.61">  * Test that accessing file: URLs will block when appropriate, and load</span>
<a href="#l46.62"></a><span id="l46.62">  * the content when appropriate.</span>
<a href="#l46.63"></a><span id="l46.63">  */</span>
<a href="#l46.64"></a><span id="l46.64" class="difflineminus">-function test_paste_file_urls() {</span>
<a href="#l46.65"></a><span id="l46.65" class="difflineplus">+add_task(function test_paste_file_urls() {</span>
<a href="#l46.66"></a><span id="l46.66">   let cwc = open_compose_new_mail();</span>
<a href="#l46.67"></a><span id="l46.67">   setup_msg_contents(</span>
<a href="#l46.68"></a><span id="l46.68">     cwc,</span>
<a href="#l46.69"></a><span id="l46.69">     &quot;someone@example.com&quot;,</span>
<a href="#l46.70"></a><span id="l46.70">     &quot;testing html paste&quot;,</span>
<a href="#l46.71"></a><span id="l46.71">     &quot;See these images- one broken one not\n&quot;</span>
<a href="#l46.72"></a><span id="l46.72">   );</span>
<a href="#l46.73"></a><span id="l46.73"> </span>
<a href="#l46.74"></a><span id="l46.74" class="difflineminus">-  const fname = &quot;./tb-logo.png&quot;;</span>
<a href="#l46.75"></a><span id="l46.75" class="difflineminus">-  let file = os.getFileForPath(os.abspath(fname, os.getFileForPath(__file__)));</span>
<a href="#l46.76"></a><span id="l46.76" class="difflineplus">+  const fname = &quot;data/tb-logo.png&quot;;</span>
<a href="#l46.77"></a><span id="l46.77" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(fname));</span>
<a href="#l46.78"></a><span id="l46.78">   let fileHandler = Services.io</span>
<a href="#l46.79"></a><span id="l46.79">     .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l46.80"></a><span id="l46.80">     .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l46.81"></a><span id="l46.81"> </span>
<a href="#l46.82"></a><span id="l46.82">   let dest = OS.Path.join(OS.Constants.Path.tmpDir, file.leafName);</span>
<a href="#l46.83"></a><span id="l46.83">   let tmpFile;</span>
<a href="#l46.84"></a><span id="l46.84">   let tmpFileURL;</span>
<a href="#l46.85"></a><span id="l46.85">   OS.File.remove(dest, { ignoreAbsent: true })</span>
<a href="#l46.86"></a><span id="l46.86">     .then(function() {</span>
<a href="#l46.87"></a><span id="l46.87">       return OS.File.copy(file.path, dest);</span>
<a href="#l46.88"></a><span id="l46.88">     })</span>
<a href="#l46.89"></a><span id="l46.89">     .then(function() {</span>
<a href="#l46.90"></a><span id="l46.90">       return OS.File.setDates(dest, null, null);</span>
<a href="#l46.91"></a><span id="l46.91">     })</span>
<a href="#l46.92"></a><span id="l46.92">     .then(function() {</span>
<a href="#l46.93"></a><span id="l46.93">       tmpFile = os.getFileForPath(dest);</span>
<a href="#l46.94"></a><span id="l46.94" class="difflineminus">-      assert_true(tmpFile.exists(), &quot;tmpFile's not there at &quot; + dest);</span>
<a href="#l46.95"></a><span id="l46.95" class="difflineplus">+      Assert.ok(tmpFile.exists(), &quot;tmpFile's not there at &quot; + dest);</span>
<a href="#l46.96"></a><span id="l46.96"> </span>
<a href="#l46.97"></a><span id="l46.97">       tmpFileURL = fileHandler.getURLSpecFromFile(tmpFile);</span>
<a href="#l46.98"></a><span id="l46.98">       putHTMLOnClipboard(</span>
<a href="#l46.99"></a><span id="l46.99">         &quot;&lt;img id='bad-img' src='file://foo/non-existant' alt='bad' /&gt; and &quot; +</span>
<a href="#l46.100"></a><span id="l46.100">           &quot;&lt;img id='tmp-img' src='&quot; +</span>
<a href="#l46.101"></a><span id="l46.101">           tmpFileURL +</span>
<a href="#l46.102"></a><span id="l46.102">           &quot;' alt='tmp' /&gt;&quot;</span>
<a href="#l46.103"></a><span id="l46.103">       );</span>
<a href="#l46.104"></a><span id="l46.104" class="difflineat">@@ -127,27 +125,25 @@ function test_paste_file_urls() {</span>
<a href="#l46.105"></a><span id="l46.105">   plan_for_window_close(cwc);</span>
<a href="#l46.106"></a><span id="l46.106">   cwc.window.goDoCommand(&quot;cmd_sendLater&quot;);</span>
<a href="#l46.107"></a><span id="l46.107">   wait_for_window_close();</span>
<a href="#l46.108"></a><span id="l46.108"> </span>
<a href="#l46.109"></a><span id="l46.109">   be_in_folder(gOutboxFolder);</span>
<a href="#l46.110"></a><span id="l46.110">   let outMsg = select_click_row(0);</span>
<a href="#l46.111"></a><span id="l46.111">   let outMsgContent = get_msg_source(outMsg);</span>
<a href="#l46.112"></a><span id="l46.112"> </span>
<a href="#l46.113"></a><span id="l46.113" class="difflineminus">-  assert_true(</span>
<a href="#l46.114"></a><span id="l46.114" class="difflineplus">+  Assert.ok(</span>
<a href="#l46.115"></a><span id="l46.115">     outMsgContent.includes(&quot;file://foo/non-existant&quot;),</span>
<a href="#l46.116"></a><span id="l46.116">     &quot;non-existant file not in content=&quot; + outMsgContent</span>
<a href="#l46.117"></a><span id="l46.117">   );</span>
<a href="#l46.118"></a><span id="l46.118"> </span>
<a href="#l46.119"></a><span id="l46.119" class="difflineminus">-  assert_false(</span>
<a href="#l46.120"></a><span id="l46.120" class="difflineminus">-    outMsgContent.includes(tmpFileURL),</span>
<a href="#l46.121"></a><span id="l46.121" class="difflineplus">+  Assert.ok(</span>
<a href="#l46.122"></a><span id="l46.122" class="difflineplus">+    !outMsgContent.includes(tmpFileURL),</span>
<a href="#l46.123"></a><span id="l46.123">     &quot;tmp file url still in content=&quot; + outMsgContent</span>
<a href="#l46.124"></a><span id="l46.124">   );</span>
<a href="#l46.125"></a><span id="l46.125"> </span>
<a href="#l46.126"></a><span id="l46.126" class="difflineminus">-  assert_true(</span>
<a href="#l46.127"></a><span id="l46.127" class="difflineplus">+  Assert.ok(</span>
<a href="#l46.128"></a><span id="l46.128">     outMsgContent.includes('id=&quot;tmp-img&quot; src=&quot;cid:'),</span>
<a href="#l46.129"></a><span id="l46.129">     &quot;tmp-img should be cid after send; content=&quot; + outMsgContent</span>
<a href="#l46.130"></a><span id="l46.130">   );</span>
<a href="#l46.131"></a><span id="l46.131"> </span>
<a href="#l46.132"></a><span id="l46.132">   press_delete(); // Delete the msg from Outbox.</span>
<a href="#l46.133"></a><span id="l46.133" class="difflineminus">-}</span>
<a href="#l46.134"></a><span id="l46.134" class="difflineminus">-</span>
<a href="#l46.135"></a><span id="l46.135" class="difflineminus">-function teardownModule(module) {}</span>
<a href="#l46.136"></a><span id="l46.136" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1">copy from mail/test/mozmill/composition/test-charset-edit.js</span>
<a href="#l47.2"></a><span id="l47.2">copy to mail/test/browser/composition/browser_charsetEdit.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-charset-edit.js</span>
<a href="#l47.4"></a><span id="l47.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_charsetEdit.js</span>
<a href="#l47.5"></a><span id="l47.5" class="difflineat">@@ -5,29 +5,28 @@</span>
<a href="#l47.6"></a><span id="l47.6"> /**</span>
<a href="#l47.7"></a><span id="l47.7">  * Tests that we do the right thing wrt. message encoding when editing or</span>
<a href="#l47.8"></a><span id="l47.8">  * replying to messages.</span>
<a href="#l47.9"></a><span id="l47.9">  */</span>
<a href="#l47.10"></a><span id="l47.10"> </span>
<a href="#l47.11"></a><span id="l47.11"> &quot;use strict&quot;;</span>
<a href="#l47.12"></a><span id="l47.12"> </span>
<a href="#l47.13"></a><span id="l47.13"> var elib = ChromeUtils.import(</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l47.16"></a><span id="l47.16"> );</span>
<a href="#l47.17"></a><span id="l47.17" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l47.18"></a><span id="l47.18" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l47.19"></a><span id="l47.19" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l47.20"></a><span id="l47.20" class="difflineplus">+var utils = ChromeUtils.import(&quot;resource://testing-common/mozmill/utils.jsm&quot;);</span>
<a href="#l47.21"></a><span id="l47.21"> </span>
<a href="#l47.22"></a><span id="l47.22"> var {</span>
<a href="#l47.23"></a><span id="l47.23">   close_compose_window,</span>
<a href="#l47.24"></a><span id="l47.24">   open_compose_with_reply,</span>
<a href="#l47.25"></a><span id="l47.25">   wait_for_compose_window,</span>
<a href="#l47.26"></a><span id="l47.26"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l47.27"></a><span id="l47.27"> var {</span>
<a href="#l47.28"></a><span id="l47.28">   add_message_to_folder,</span>
<a href="#l47.29"></a><span id="l47.29" class="difflineminus">-  assert_equals,</span>
<a href="#l47.30"></a><span id="l47.30">   assert_selected_and_displayed,</span>
<a href="#l47.31"></a><span id="l47.31">   be_in_folder,</span>
<a href="#l47.32"></a><span id="l47.32">   create_message,</span>
<a href="#l47.33"></a><span id="l47.33">   get_special_folder,</span>
<a href="#l47.34"></a><span id="l47.34">   mc,</span>
<a href="#l47.35"></a><span id="l47.35">   press_delete,</span>
<a href="#l47.36"></a><span id="l47.36">   select_click_row,</span>
<a href="#l47.37"></a><span id="l47.37">   SyntheticPartLeaf,</span>
<a href="#l47.38"></a><span id="l47.38" class="difflineat">@@ -44,31 +43,31 @@ var { plan_for_new_window } = ChromeUtil</span>
<a href="#l47.39"></a><span id="l47.39"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l47.40"></a><span id="l47.40"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l47.41"></a><span id="l47.41">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l47.42"></a><span id="l47.42"> );</span>
<a href="#l47.43"></a><span id="l47.43"> var { MimeParser } = ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l47.44"></a><span id="l47.44"> </span>
<a href="#l47.45"></a><span id="l47.45"> var gDrafts;</span>
<a href="#l47.46"></a><span id="l47.46"> </span>
<a href="#l47.47"></a><span id="l47.47" class="difflineminus">-function setupModule(module) {</span>
<a href="#l47.48"></a><span id="l47.48" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l47.49"></a><span id="l47.49">   gDrafts = get_special_folder(Ci.nsMsgFolderFlags.Drafts, true);</span>
<a href="#l47.50"></a><span id="l47.50"> </span>
<a href="#l47.51"></a><span id="l47.51">   // Ensure reply charset isn't UTF-8, otherwise there's no need to upgrade,</span>
<a href="#l47.52"></a><span id="l47.52">   // which is what this test tests.</span>
<a href="#l47.53"></a><span id="l47.53">   let str = Cc[&quot;@mozilla.org/pref-localizedstring;1&quot;].createInstance(</span>
<a href="#l47.54"></a><span id="l47.54">     Ci.nsIPrefLocalizedString</span>
<a href="#l47.55"></a><span id="l47.55">   );</span>
<a href="#l47.56"></a><span id="l47.56">   str.data = &quot;windows-1252&quot;;</span>
<a href="#l47.57"></a><span id="l47.57">   Services.prefs.setComplexValue(</span>
<a href="#l47.58"></a><span id="l47.58">     &quot;mailnews.send_default_charset&quot;,</span>
<a href="#l47.59"></a><span id="l47.59">     Ci.nsIPrefLocalizedString,</span>
<a href="#l47.60"></a><span id="l47.60">     str</span>
<a href="#l47.61"></a><span id="l47.61">   );</span>
<a href="#l47.62"></a><span id="l47.62" class="difflineminus">-}</span>
<a href="#l47.63"></a><span id="l47.63" class="difflineplus">+});</span>
<a href="#l47.64"></a><span id="l47.64"> </span>
<a href="#l47.65"></a><span id="l47.65"> /**</span>
<a href="#l47.66"></a><span id="l47.66">  * Helper to get the full message content.</span>
<a href="#l47.67"></a><span id="l47.67">  *</span>
<a href="#l47.68"></a><span id="l47.68">  * @param aMsgHdr: nsIMsgDBHdr object whose text body will be read</span>
<a href="#l47.69"></a><span id="l47.69">  * @param aGetText: if true, return header objects. if false, return body data.</span>
<a href="#l47.70"></a><span id="l47.70">  * @return Map(partnum -&gt; message headers)</span>
<a href="#l47.71"></a><span id="l47.71">  */</span>
<a href="#l47.72"></a><span id="l47.72" class="difflineat">@@ -104,85 +103,85 @@ function getMsgHeaders(aMsgHdr, aGetText</span>
<a href="#l47.73"></a><span id="l47.73">   return aGetText ? handler._text : handler._data;</span>
<a href="#l47.74"></a><span id="l47.74"> }</span>
<a href="#l47.75"></a><span id="l47.75"> </span>
<a href="#l47.76"></a><span id="l47.76"> /**</span>
<a href="#l47.77"></a><span id="l47.77">  * Test that if we reply to a message in an invalid charset, we don't try to compose</span>
<a href="#l47.78"></a><span id="l47.78">  * in that charset. Instead, we should be using the default charset (set to</span>
<a href="#l47.79"></a><span id="l47.79">  * not be UTF-8 in this test).</span>
<a href="#l47.80"></a><span id="l47.80">  */</span>
<a href="#l47.81"></a><span id="l47.81" class="difflineminus">-function test_wrong_reply_charset() {</span>
<a href="#l47.82"></a><span id="l47.82" class="difflineplus">+add_task(function test_wrong_reply_charset() {</span>
<a href="#l47.83"></a><span id="l47.83">   let folder = gDrafts;</span>
<a href="#l47.84"></a><span id="l47.84">   let msg0 = create_message({</span>
<a href="#l47.85"></a><span id="l47.85">     bodyPart: new SyntheticPartLeaf(&quot;Some text&quot;, {</span>
<a href="#l47.86"></a><span id="l47.86">       charset: &quot;invalid-charset&quot;,</span>
<a href="#l47.87"></a><span id="l47.87">     }),</span>
<a href="#l47.88"></a><span id="l47.88">   });</span>
<a href="#l47.89"></a><span id="l47.89">   add_message_to_folder(folder, msg0);</span>
<a href="#l47.90"></a><span id="l47.90">   be_in_folder(folder);</span>
<a href="#l47.91"></a><span id="l47.91">   let msg = select_click_row(0);</span>
<a href="#l47.92"></a><span id="l47.92">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l47.93"></a><span id="l47.93" class="difflineminus">-  assert_equals(getMsgHeaders(msg).get(&quot;&quot;).charset, &quot;invalid-charset&quot;);</span>
<a href="#l47.94"></a><span id="l47.94" class="difflineplus">+  Assert.equal(getMsgHeaders(msg).get(&quot;&quot;).charset, &quot;invalid-charset&quot;);</span>
<a href="#l47.95"></a><span id="l47.95"> </span>
<a href="#l47.96"></a><span id="l47.96">   let rwc = open_compose_with_reply();</span>
<a href="#l47.97"></a><span id="l47.97">   // Ctrl+S = save as draft.</span>
<a href="#l47.98"></a><span id="l47.98">   rwc.keypress(null, &quot;s&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l47.99"></a><span id="l47.99">   close_compose_window(rwc);</span>
<a href="#l47.100"></a><span id="l47.100"> </span>
<a href="#l47.101"></a><span id="l47.101">   let draftMsg = select_click_row(1);</span>
<a href="#l47.102"></a><span id="l47.102" class="difflineminus">-  assert_equals(getMsgHeaders(draftMsg).get(&quot;&quot;).charset, &quot;windows-1252&quot;);</span>
<a href="#l47.103"></a><span id="l47.103" class="difflineplus">+  Assert.equal(getMsgHeaders(draftMsg).get(&quot;&quot;).charset, &quot;windows-1252&quot;);</span>
<a href="#l47.104"></a><span id="l47.104">   press_delete(mc); // Delete message</span>
<a href="#l47.105"></a><span id="l47.105"> </span>
<a href="#l47.106"></a><span id="l47.106">   // Edit the original message. Charset should be windows-1252 now.</span>
<a href="#l47.107"></a><span id="l47.107">   msg = select_click_row(0);</span>
<a href="#l47.108"></a><span id="l47.108"> </span>
<a href="#l47.109"></a><span id="l47.109">   // Wait for the notification with the Edit button.</span>
<a href="#l47.110"></a><span id="l47.110">   wait_for_notification_to_show(mc, &quot;mail-notification-top&quot;, &quot;draftMsgContent&quot;);</span>
<a href="#l47.111"></a><span id="l47.111"> </span>
<a href="#l47.112"></a><span id="l47.112">   plan_for_new_window(&quot;msgcompose&quot;);</span>
<a href="#l47.113"></a><span id="l47.113">   mc.click(</span>
<a href="#l47.114"></a><span id="l47.114">     mc.eid(&quot;mail-notification-top&quot;, { tagName: &quot;button&quot;, label: &quot;Edit&quot; })</span>
<a href="#l47.115"></a><span id="l47.115">   );</span>
<a href="#l47.116"></a><span id="l47.116">   rwc = wait_for_compose_window();</span>
<a href="#l47.117"></a><span id="l47.117">   rwc.keypress(null, &quot;s&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l47.118"></a><span id="l47.118">   close_compose_window(rwc);</span>
<a href="#l47.119"></a><span id="l47.119">   msg = select_click_row(0);</span>
<a href="#l47.120"></a><span id="l47.120" class="difflineminus">-  assert_equals(getMsgHeaders(msg).get(&quot;&quot;).charset, &quot;windows-1252&quot;);</span>
<a href="#l47.121"></a><span id="l47.121" class="difflineplus">+  Assert.equal(getMsgHeaders(msg).get(&quot;&quot;).charset, &quot;windows-1252&quot;);</span>
<a href="#l47.122"></a><span id="l47.122">   press_delete(mc); // Delete message</span>
<a href="#l47.123"></a><span id="l47.123" class="difflineminus">-}</span>
<a href="#l47.124"></a><span id="l47.124" class="difflineplus">+});</span>
<a href="#l47.125"></a><span id="l47.125"> </span>
<a href="#l47.126"></a><span id="l47.126"> /**</span>
<a href="#l47.127"></a><span id="l47.127">  * Test that replying to bad charsets don't screw up the existing text.</span>
<a href="#l47.128"></a><span id="l47.128">  */</span>
<a href="#l47.129"></a><span id="l47.129" class="difflineminus">-function test_no_mojibake() {</span>
<a href="#l47.130"></a><span id="l47.130" class="difflineplus">+add_task(function test_no_mojibake() {</span>
<a href="#l47.131"></a><span id="l47.131">   let folder = gDrafts;</span>
<a href="#l47.132"></a><span id="l47.132">   let nonASCII = &quot;&quot;;</span>
<a href="#l47.133"></a><span id="l47.133">   let UTF7 = &quot;+MLEwxDChMOswszCiMMgw6w-&quot;;</span>
<a href="#l47.134"></a><span id="l47.134">   let msg0 = create_message({</span>
<a href="#l47.135"></a><span id="l47.135">     bodyPart: new SyntheticPartLeaf(UTF7, { charset: &quot;utf-7&quot; }),</span>
<a href="#l47.136"></a><span id="l47.136">   });</span>
<a href="#l47.137"></a><span id="l47.137">   add_message_to_folder(folder, msg0);</span>
<a href="#l47.138"></a><span id="l47.138">   be_in_folder(folder);</span>
<a href="#l47.139"></a><span id="l47.139">   let msg = select_click_row(0);</span>
<a href="#l47.140"></a><span id="l47.140">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l47.141"></a><span id="l47.141" class="difflineminus">-  assert_equals(getMsgHeaders(msg).get(&quot;&quot;).charset, &quot;utf-7&quot;);</span>
<a href="#l47.142"></a><span id="l47.142" class="difflineminus">-  assert_equals(</span>
<a href="#l47.143"></a><span id="l47.143" class="difflineplus">+  Assert.equal(getMsgHeaders(msg).get(&quot;&quot;).charset, &quot;utf-7&quot;);</span>
<a href="#l47.144"></a><span id="l47.144" class="difflineplus">+  Assert.equal(</span>
<a href="#l47.145"></a><span id="l47.145">     getMsgHeaders(msg, true)</span>
<a href="#l47.146"></a><span id="l47.146">       .get(&quot;&quot;)</span>
<a href="#l47.147"></a><span id="l47.147">       .trim(),</span>
<a href="#l47.148"></a><span id="l47.148">     nonASCII</span>
<a href="#l47.149"></a><span id="l47.149">   );</span>
<a href="#l47.150"></a><span id="l47.150"> </span>
<a href="#l47.151"></a><span id="l47.151">   let rwc = open_compose_with_reply();</span>
<a href="#l47.152"></a><span id="l47.152">   // Ctrl+S = save as draft.</span>
<a href="#l47.153"></a><span id="l47.153">   rwc.keypress(null, &quot;s&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l47.154"></a><span id="l47.154">   close_compose_window(rwc);</span>
<a href="#l47.155"></a><span id="l47.155"> </span>
<a href="#l47.156"></a><span id="l47.156">   let draftMsg = select_click_row(1);</span>
<a href="#l47.157"></a><span id="l47.157" class="difflineminus">-  assert_equals(</span>
<a href="#l47.158"></a><span id="l47.158" class="difflineplus">+  Assert.equal(</span>
<a href="#l47.159"></a><span id="l47.159">     getMsgHeaders(draftMsg)</span>
<a href="#l47.160"></a><span id="l47.160">       .get(&quot;&quot;)</span>
<a href="#l47.161"></a><span id="l47.161">       .charset.toUpperCase(),</span>
<a href="#l47.162"></a><span id="l47.162">     &quot;UTF-8&quot;</span>
<a href="#l47.163"></a><span id="l47.163">   );</span>
<a href="#l47.164"></a><span id="l47.164">   let text = getMsgHeaders(draftMsg, true).get(&quot;&quot;);</span>
<a href="#l47.165"></a><span id="l47.165">   // Delete message first before throwing so subsequent tests are not affected.</span>
<a href="#l47.166"></a><span id="l47.166">   press_delete(mc);</span>
<a href="#l47.167"></a><span id="l47.167" class="difflineat">@@ -199,26 +198,26 @@ function test_no_mojibake() {</span>
<a href="#l47.168"></a><span id="l47.168">   plan_for_new_window(&quot;msgcompose&quot;);</span>
<a href="#l47.169"></a><span id="l47.169">   mc.click(</span>
<a href="#l47.170"></a><span id="l47.170">     mc.eid(&quot;mail-notification-top&quot;, { tagName: &quot;button&quot;, label: &quot;Edit&quot; })</span>
<a href="#l47.171"></a><span id="l47.171">   );</span>
<a href="#l47.172"></a><span id="l47.172">   rwc = wait_for_compose_window();</span>
<a href="#l47.173"></a><span id="l47.173">   rwc.keypress(null, &quot;s&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l47.174"></a><span id="l47.174">   close_compose_window(rwc);</span>
<a href="#l47.175"></a><span id="l47.175">   msg = select_click_row(0);</span>
<a href="#l47.176"></a><span id="l47.176" class="difflineminus">-  assert_equals(</span>
<a href="#l47.177"></a><span id="l47.177" class="difflineplus">+  Assert.equal(</span>
<a href="#l47.178"></a><span id="l47.178">     getMsgHeaders(msg)</span>
<a href="#l47.179"></a><span id="l47.179">       .get(&quot;&quot;)</span>
<a href="#l47.180"></a><span id="l47.180">       .charset.toUpperCase(),</span>
<a href="#l47.181"></a><span id="l47.181">     &quot;UTF-8&quot;</span>
<a href="#l47.182"></a><span id="l47.182">   );</span>
<a href="#l47.183"></a><span id="l47.183" class="difflineminus">-  assert_equals(</span>
<a href="#l47.184"></a><span id="l47.184" class="difflineplus">+  Assert.equal(</span>
<a href="#l47.185"></a><span id="l47.185">     getMsgHeaders(msg, true)</span>
<a href="#l47.186"></a><span id="l47.186">       .get(&quot;&quot;)</span>
<a href="#l47.187"></a><span id="l47.187">       .trim(),</span>
<a href="#l47.188"></a><span id="l47.188">     nonASCII</span>
<a href="#l47.189"></a><span id="l47.189">   );</span>
<a href="#l47.190"></a><span id="l47.190">   press_delete(mc); // Delete message</span>
<a href="#l47.191"></a><span id="l47.191" class="difflineminus">-}</span>
<a href="#l47.192"></a><span id="l47.192" class="difflineplus">+});</span>
<a href="#l47.193"></a><span id="l47.193"> </span>
<a href="#l47.194"></a><span id="l47.194" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l47.195"></a><span id="l47.195" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l47.196"></a><span id="l47.196">   Services.prefs.clearUserPref(&quot;mailnews.send_default_charset&quot;);</span>
<a href="#l47.197"></a><span id="l47.197" class="difflineminus">-}</span>
<a href="#l47.198"></a><span id="l47.198" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1">copy from mail/test/mozmill/composition/test-charset-upgrade.js</span>
<a href="#l48.2"></a><span id="l48.2">copy to mail/test/browser/composition/browser_charsetUpgrade.js</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-charset-upgrade.js</span>
<a href="#l48.4"></a><span id="l48.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_charsetUpgrade.js</span>
<a href="#l48.5"></a><span id="l48.5" class="difflineat">@@ -11,18 +11,16 @@</span>
<a href="#l48.6"></a><span id="l48.6"> </span>
<a href="#l48.7"></a><span id="l48.7"> var {</span>
<a href="#l48.8"></a><span id="l48.8">   get_msg_source,</span>
<a href="#l48.9"></a><span id="l48.9">   open_compose_new_mail,</span>
<a href="#l48.10"></a><span id="l48.10">   setup_msg_contents,</span>
<a href="#l48.11"></a><span id="l48.11">   type_in_composer,</span>
<a href="#l48.12"></a><span id="l48.12"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l48.13"></a><span id="l48.13"> var {</span>
<a href="#l48.14"></a><span id="l48.14" class="difflineminus">-  assert_equals,</span>
<a href="#l48.15"></a><span id="l48.15" class="difflineminus">-  assert_true,</span>
<a href="#l48.16"></a><span id="l48.16">   be_in_folder,</span>
<a href="#l48.17"></a><span id="l48.17">   get_special_folder,</span>
<a href="#l48.18"></a><span id="l48.18">   press_delete,</span>
<a href="#l48.19"></a><span id="l48.19">   select_click_row,</span>
<a href="#l48.20"></a><span id="l48.20"> } = ChromeUtils.import(</span>
<a href="#l48.21"></a><span id="l48.21">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l48.22"></a><span id="l48.22"> );</span>
<a href="#l48.23"></a><span id="l48.23"> var { plan_for_window_close, wait_for_window_close } = ChromeUtils.import(</span>
<a href="#l48.24"></a><span id="l48.24" class="difflineat">@@ -32,17 +30,17 @@ var { plan_for_window_close, wait_for_wi</span>
<a href="#l48.25"></a><span id="l48.25"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l48.26"></a><span id="l48.26"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l48.27"></a><span id="l48.27">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l48.28"></a><span id="l48.28"> );</span>
<a href="#l48.29"></a><span id="l48.29"> </span>
<a href="#l48.30"></a><span id="l48.30"> var gDrafts;</span>
<a href="#l48.31"></a><span id="l48.31"> var gOutbox;</span>
<a href="#l48.32"></a><span id="l48.32"> </span>
<a href="#l48.33"></a><span id="l48.33" class="difflineminus">-function setupModule(module) {</span>
<a href="#l48.34"></a><span id="l48.34" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l48.35"></a><span id="l48.35">   gDrafts = get_special_folder(Ci.nsMsgFolderFlags.Drafts, true);</span>
<a href="#l48.36"></a><span id="l48.36">   gOutbox = get_special_folder(Ci.nsMsgFolderFlags.Queue);</span>
<a href="#l48.37"></a><span id="l48.37"> </span>
<a href="#l48.38"></a><span id="l48.38">   // Ensure reply charset isn't UTF-8, otherwise there's no need to upgrade,</span>
<a href="#l48.39"></a><span id="l48.39">   //  which is what this test tests.</span>
<a href="#l48.40"></a><span id="l48.40">   let str = Cc[&quot;@mozilla.org/pref-localizedstring;1&quot;].createInstance(</span>
<a href="#l48.41"></a><span id="l48.41">     Ci.nsIPrefLocalizedString</span>
<a href="#l48.42"></a><span id="l48.42">   );</span>
<a href="#l48.43"></a><span id="l48.43" class="difflineat">@@ -53,23 +51,23 @@ function setupModule(module) {</span>
<a href="#l48.44"></a><span id="l48.44">     str</span>
<a href="#l48.45"></a><span id="l48.45">   );</span>
<a href="#l48.46"></a><span id="l48.46"> </span>
<a href="#l48.47"></a><span id="l48.47">   // Don't create paragraphs in the test.</span>
<a href="#l48.48"></a><span id="l48.48">   // When creating a paragraph, the test fails to retrieve the</span>
<a href="#l48.49"></a><span id="l48.49">   // original character set windows-1252. Until we understand why,</span>
<a href="#l48.50"></a><span id="l48.50">   // we run without paragraphs.</span>
<a href="#l48.51"></a><span id="l48.51">   Services.prefs.setBoolPref(&quot;mail.compose.default_to_paragraph&quot;, false);</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineminus">-}</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineplus">+});</span>
<a href="#l48.54"></a><span id="l48.54"> </span>
<a href="#l48.55"></a><span id="l48.55"> /**</span>
<a href="#l48.56"></a><span id="l48.56">  * Test that if all characters don't fit the current charset selection,</span>
<a href="#l48.57"></a><span id="l48.57">  * we upgrade properly to UTF-8. In HTML composition.</span>
<a href="#l48.58"></a><span id="l48.58">  */</span>
<a href="#l48.59"></a><span id="l48.59" class="difflineminus">-function test_encoding_upgrade_html_compose() {</span>
<a href="#l48.60"></a><span id="l48.60" class="difflineplus">+add_task(function test_encoding_upgrade_html_compose() {</span>
<a href="#l48.61"></a><span id="l48.61">   Services.prefs.setBoolPref(&quot;mail.identity.default.compose_html&quot;, true);</span>
<a href="#l48.62"></a><span id="l48.62">   let compWin = open_compose_new_mail();</span>
<a href="#l48.63"></a><span id="l48.63"> </span>
<a href="#l48.64"></a><span id="l48.64">   setup_msg_contents(</span>
<a href="#l48.65"></a><span id="l48.65">     compWin,</span>
<a href="#l48.66"></a><span id="l48.66">     &quot;someone@example.com&quot;,</span>
<a href="#l48.67"></a><span id="l48.67">     &quot;encoding upgrade test - html mode&quot;,</span>
<a href="#l48.68"></a><span id="l48.68">     &quot;so far, this is latin1\n&quot;</span>
<a href="#l48.69"></a><span id="l48.69" class="difflineat">@@ -77,17 +75,17 @@ function test_encoding_upgrade_html_comp</span>
<a href="#l48.70"></a><span id="l48.70"> </span>
<a href="#l48.71"></a><span id="l48.71">   // Ctrl+S = save as draft.</span>
<a href="#l48.72"></a><span id="l48.72">   compWin.keypress(null, &quot;s&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l48.73"></a><span id="l48.73"> </span>
<a href="#l48.74"></a><span id="l48.74">   be_in_folder(gDrafts);</span>
<a href="#l48.75"></a><span id="l48.75">   let draftMsg = select_click_row(0);</span>
<a href="#l48.76"></a><span id="l48.76"> </span>
<a href="#l48.77"></a><span id="l48.77">   // Charset should still be the default.</span>
<a href="#l48.78"></a><span id="l48.78" class="difflineminus">-  assert_equals(draftMsg.Charset, &quot;windows-1252&quot;);</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineplus">+  Assert.equal(draftMsg.Charset, &quot;windows-1252&quot;);</span>
<a href="#l48.80"></a><span id="l48.80"> </span>
<a href="#l48.81"></a><span id="l48.81">   // We could pass &quot;windows-1252&quot;, but the message is ASCII.</span>
<a href="#l48.82"></a><span id="l48.82">   let draftMsgContent = get_msg_source(draftMsg);</span>
<a href="#l48.83"></a><span id="l48.83">   if (!draftMsgContent.includes('content=&quot;text/html; charset=windows-1252&quot;')) {</span>
<a href="#l48.84"></a><span id="l48.84">     throw new Error(</span>
<a href="#l48.85"></a><span id="l48.85">       &quot;Expected content type not in msg; draftMsgContent=&quot; + draftMsgContent</span>
<a href="#l48.86"></a><span id="l48.86">     );</span>
<a href="#l48.87"></a><span id="l48.87">   }</span>
<a href="#l48.88"></a><span id="l48.88" class="difflineat">@@ -104,17 +102,17 @@ function test_encoding_upgrade_html_comp</span>
<a href="#l48.89"></a><span id="l48.89">   type_in_composer(compWin, [&quot;content need to be upgraded to utf-8 now.&quot;]);</span>
<a href="#l48.90"></a><span id="l48.90"> </span>
<a href="#l48.91"></a><span id="l48.91">   // Ctrl+S = save as draft.</span>
<a href="#l48.92"></a><span id="l48.92">   compWin.keypress(null, &quot;s&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l48.93"></a><span id="l48.93"> </span>
<a href="#l48.94"></a><span id="l48.94">   be_in_folder(gDrafts);</span>
<a href="#l48.95"></a><span id="l48.95">   let draftMsg2 = select_click_row(0);</span>
<a href="#l48.96"></a><span id="l48.96">   // Charset should have be upgraded to UTF-8.</span>
<a href="#l48.97"></a><span id="l48.97" class="difflineminus">-  assert_equals(draftMsg2.Charset, &quot;UTF-8&quot;);</span>
<a href="#l48.98"></a><span id="l48.98" class="difflineplus">+  Assert.equal(draftMsg2.Charset, &quot;UTF-8&quot;);</span>
<a href="#l48.99"></a><span id="l48.99"> </span>
<a href="#l48.100"></a><span id="l48.100">   let draftMsg2Content = get_msg_source(draftMsg2, &quot;UTF-8&quot;);</span>
<a href="#l48.101"></a><span id="l48.101">   if (!draftMsg2Content.includes('content=&quot;text/html; charset=UTF-8&quot;')) {</span>
<a href="#l48.102"></a><span id="l48.102">     throw new Error(</span>
<a href="#l48.103"></a><span id="l48.103">       &quot;Expected content type not in msg; draftMsg2Content=&quot; + draftMsg2Content</span>
<a href="#l48.104"></a><span id="l48.104">     );</span>
<a href="#l48.105"></a><span id="l48.105">   }</span>
<a href="#l48.106"></a><span id="l48.106"> </span>
<a href="#l48.107"></a><span id="l48.107" class="difflineat">@@ -136,42 +134,42 @@ function test_encoding_upgrade_html_comp</span>
<a href="#l48.108"></a><span id="l48.108">   let outMsgContent = get_msg_source(outMsg, &quot;UTF-8&quot;);</span>
<a href="#l48.109"></a><span id="l48.109"> </span>
<a href="#l48.110"></a><span id="l48.110">   // This message should be multipart/alternative.</span>
<a href="#l48.111"></a><span id="l48.111">   if (!outMsgContent.includes(&quot;Content-Type: multipart/alternative&quot;)) {</span>
<a href="#l48.112"></a><span id="l48.112">     throw new Error(&quot;Expected multipart/alternative; content=&quot; + outMsgContent);</span>
<a href="#l48.113"></a><span id="l48.113">   }</span>
<a href="#l48.114"></a><span id="l48.114"> </span>
<a href="#l48.115"></a><span id="l48.115">   let chinesePlainIdx = outMsgContent.indexOf(CHINESE);</span>
<a href="#l48.116"></a><span id="l48.116" class="difflineminus">-  assert_true(</span>
<a href="#l48.117"></a><span id="l48.117" class="difflineplus">+  Assert.ok(</span>
<a href="#l48.118"></a><span id="l48.118">     chinesePlainIdx &gt; 0,</span>
<a href="#l48.119"></a><span id="l48.119">     &quot;chinesePlainIdx=&quot; + chinesePlainIdx + &quot;, outMsgContent=&quot; + outMsgContent</span>
<a href="#l48.120"></a><span id="l48.120">   );</span>
<a href="#l48.121"></a><span id="l48.121"> </span>
<a href="#l48.122"></a><span id="l48.122">   let chineseHTMLIdx = outMsgContent.indexOf(CHINESE, chinesePlainIdx);</span>
<a href="#l48.123"></a><span id="l48.123" class="difflineminus">-  assert_true(</span>
<a href="#l48.124"></a><span id="l48.124" class="difflineplus">+  Assert.ok(</span>
<a href="#l48.125"></a><span id="l48.125">     chineseHTMLIdx &gt; 0,</span>
<a href="#l48.126"></a><span id="l48.126">     &quot;chineseHTMLIdx=&quot; + chineseHTMLIdx + &quot;, outMsgContent=&quot; + outMsgContent</span>
<a href="#l48.127"></a><span id="l48.127">   );</span>
<a href="#l48.128"></a><span id="l48.128"> </span>
<a href="#l48.129"></a><span id="l48.129">   // Make sure the actual html also got the content type set correctly.</span>
<a href="#l48.130"></a><span id="l48.130">   if (!outMsgContent.includes('content=&quot;text/html; charset=UTF-8&quot;')) {</span>
<a href="#l48.131"></a><span id="l48.131">     throw new Error(</span>
<a href="#l48.132"></a><span id="l48.132">       &quot;Expected content type not in html; outMsgContent=&quot; + outMsgContent</span>
<a href="#l48.133"></a><span id="l48.133">     );</span>
<a href="#l48.134"></a><span id="l48.134">   }</span>
<a href="#l48.135"></a><span id="l48.135"> </span>
<a href="#l48.136"></a><span id="l48.136">   press_delete(); // Delete the msg from Outbox.</span>
<a href="#l48.137"></a><span id="l48.137" class="difflineminus">-}</span>
<a href="#l48.138"></a><span id="l48.138" class="difflineplus">+});</span>
<a href="#l48.139"></a><span id="l48.139"> </span>
<a href="#l48.140"></a><span id="l48.140"> /**</span>
<a href="#l48.141"></a><span id="l48.141">  * Test that if all characters don't fit the current charset selection,</span>
<a href="#l48.142"></a><span id="l48.142">  * we upgrade properly to UTF-8. In plaintext composition.</span>
<a href="#l48.143"></a><span id="l48.143">  */</span>
<a href="#l48.144"></a><span id="l48.144" class="difflineminus">-function test_encoding_upgrade_plaintext_compose() {</span>
<a href="#l48.145"></a><span id="l48.145" class="difflineplus">+add_task(function test_encoding_upgrade_plaintext_compose() {</span>
<a href="#l48.146"></a><span id="l48.146">   Services.prefs.setBoolPref(&quot;mail.identity.default.compose_html&quot;, false);</span>
<a href="#l48.147"></a><span id="l48.147">   let compWin = open_compose_new_mail();</span>
<a href="#l48.148"></a><span id="l48.148">   Services.prefs.setBoolPref(&quot;mail.identity.default.compose_html&quot;, true);</span>
<a href="#l48.149"></a><span id="l48.149"> </span>
<a href="#l48.150"></a><span id="l48.150">   setup_msg_contents(</span>
<a href="#l48.151"></a><span id="l48.151">     compWin,</span>
<a href="#l48.152"></a><span id="l48.152">     &quot;someone-else@example.com&quot;,</span>
<a href="#l48.153"></a><span id="l48.153">     &quot;encoding upgrade test - plaintext&quot;,</span>
<a href="#l48.154"></a><span id="l48.154" class="difflineat">@@ -180,31 +178,31 @@ function test_encoding_upgrade_plaintext</span>
<a href="#l48.155"></a><span id="l48.155"> </span>
<a href="#l48.156"></a><span id="l48.156">   // Ctrl+S = Save as Draft.</span>
<a href="#l48.157"></a><span id="l48.157">   compWin.keypress(null, &quot;s&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l48.158"></a><span id="l48.158"> </span>
<a href="#l48.159"></a><span id="l48.159">   be_in_folder(gDrafts);</span>
<a href="#l48.160"></a><span id="l48.160">   let draftMsg = select_click_row(0);</span>
<a href="#l48.161"></a><span id="l48.161"> </span>
<a href="#l48.162"></a><span id="l48.162">   // Charset should still be the default.</span>
<a href="#l48.163"></a><span id="l48.163" class="difflineminus">-  assert_equals(draftMsg.Charset, &quot;windows-1252&quot;);</span>
<a href="#l48.164"></a><span id="l48.164" class="difflineplus">+  Assert.equal(draftMsg.Charset, &quot;windows-1252&quot;);</span>
<a href="#l48.165"></a><span id="l48.165"> </span>
<a href="#l48.166"></a><span id="l48.166">   const CHINESE = &quot;&quot;;</span>
<a href="#l48.167"></a><span id="l48.167">   type_in_composer(compWin, [</span>
<a href="#l48.168"></a><span id="l48.168">     &quot;enter some plain text chinese: &quot; + CHINESE,</span>
<a href="#l48.169"></a><span id="l48.169">     &quot;content need to be upgraded to utf-8 now.&quot;,</span>
<a href="#l48.170"></a><span id="l48.170">   ]);</span>
<a href="#l48.171"></a><span id="l48.171"> </span>
<a href="#l48.172"></a><span id="l48.172">   // Ctrl+S = Save as Draft.</span>
<a href="#l48.173"></a><span id="l48.173">   compWin.keypress(null, &quot;s&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l48.174"></a><span id="l48.174"> </span>
<a href="#l48.175"></a><span id="l48.175">   be_in_folder(gDrafts);</span>
<a href="#l48.176"></a><span id="l48.176">   let draftMsg2 = select_click_row(0);</span>
<a href="#l48.177"></a><span id="l48.177">   // Charset should have be upgraded to UTF-8.</span>
<a href="#l48.178"></a><span id="l48.178" class="difflineminus">-  assert_equals(draftMsg2.Charset, &quot;UTF-8&quot;);</span>
<a href="#l48.179"></a><span id="l48.179" class="difflineplus">+  Assert.equal(draftMsg2.Charset, &quot;UTF-8&quot;);</span>
<a href="#l48.180"></a><span id="l48.180"> </span>
<a href="#l48.181"></a><span id="l48.181">   let draftMsg2Content = get_msg_source(draftMsg2, &quot;UTF-8&quot;);</span>
<a href="#l48.182"></a><span id="l48.182">   if (draftMsg2Content.includes(&quot;&lt;html&gt;&quot;)) {</span>
<a href="#l48.183"></a><span id="l48.183">     throw new Error(</span>
<a href="#l48.184"></a><span id="l48.184">       &quot;Plaintext draft contained &lt;html&gt;; &quot; +</span>
<a href="#l48.185"></a><span id="l48.185">         &quot;draftMsg2Content=&quot; +</span>
<a href="#l48.186"></a><span id="l48.186">         draftMsg2Content</span>
<a href="#l48.187"></a><span id="l48.187">     );</span>
<a href="#l48.188"></a><span id="l48.188" class="difflineat">@@ -237,15 +235,15 @@ function test_encoding_upgrade_plaintext</span>
<a href="#l48.189"></a><span id="l48.189">       &quot;Chinese text not in msg; CHINESE=&quot; +</span>
<a href="#l48.190"></a><span id="l48.190">         CHINESE +</span>
<a href="#l48.191"></a><span id="l48.191">         &quot;, outMsgContent=&quot; +</span>
<a href="#l48.192"></a><span id="l48.192">         outMsgContent</span>
<a href="#l48.193"></a><span id="l48.193">     );</span>
<a href="#l48.194"></a><span id="l48.194">   }</span>
<a href="#l48.195"></a><span id="l48.195"> </span>
<a href="#l48.196"></a><span id="l48.196">   press_delete(); // Delete the msg from Outbox.</span>
<a href="#l48.197"></a><span id="l48.197" class="difflineminus">-}</span>
<a href="#l48.198"></a><span id="l48.198" class="difflineplus">+});</span>
<a href="#l48.199"></a><span id="l48.199"> </span>
<a href="#l48.200"></a><span id="l48.200" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l48.201"></a><span id="l48.201" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l48.202"></a><span id="l48.202">   Services.prefs.clearUserPref(&quot;mailnews.send_default_charset&quot;);</span>
<a href="#l48.203"></a><span id="l48.203">   Services.prefs.clearUserPref(&quot;mail.compose.default_to_paragraph&quot;);</span>
<a href="#l48.204"></a><span id="l48.204">   Services.prefs.clearUserPref(&quot;mail.identity.default.compose_html&quot;);</span>
<a href="#l48.205"></a><span id="l48.205" class="difflineminus">-}</span>
<a href="#l48.206"></a><span id="l48.206" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1">copy from mail/test/mozmill/composition/test-cp932-display.js</span>
<a href="#l49.2"></a><span id="l49.2">copy to mail/test/browser/composition/browser_cp932Display.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-cp932-display.js</span>
<a href="#l49.4"></a><span id="l49.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_cp932Display.js</span>
<a href="#l49.5"></a><span id="l49.5" class="difflineat">@@ -3,36 +3,34 @@</span>
<a href="#l49.6"></a><span id="l49.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l49.7"></a><span id="l49.7"> </span>
<a href="#l49.8"></a><span id="l49.8"> /**</span>
<a href="#l49.9"></a><span id="l49.9">  * Tests that messages in cp932, Thunderbirds alias for Shift_JIS, are correctly displayed.</span>
<a href="#l49.10"></a><span id="l49.10">  */</span>
<a href="#l49.11"></a><span id="l49.11"> </span>
<a href="#l49.12"></a><span id="l49.12"> &quot;use strict&quot;;</span>
<a href="#l49.13"></a><span id="l49.13"> </span>
<a href="#l49.14"></a><span id="l49.14" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l49.16"></a><span id="l49.16"> </span>
<a href="#l49.17"></a><span id="l49.17" class="difflineminus">-var { assert_true, open_message_from_file } = ChromeUtils.import(</span>
<a href="#l49.18"></a><span id="l49.18" class="difflineplus">+var { open_message_from_file } = ChromeUtils.import(</span>
<a href="#l49.19"></a><span id="l49.19">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l49.20"></a><span id="l49.20"> );</span>
<a href="#l49.21"></a><span id="l49.21"> var { close_window } = ChromeUtils.import(</span>
<a href="#l49.22"></a><span id="l49.22">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l49.23"></a><span id="l49.23"> );</span>
<a href="#l49.24"></a><span id="l49.24"> </span>
<a href="#l49.25"></a><span id="l49.25" class="difflineminus">-function test_cp932_display() {</span>
<a href="#l49.26"></a><span id="l49.26" class="difflineminus">-  let file = os.getFileForPath(</span>
<a href="#l49.27"></a><span id="l49.27" class="difflineminus">-    os.abspath(&quot;./charset-cp932.eml&quot;, os.getFileForPath(__file__))</span>
<a href="#l49.28"></a><span id="l49.28" class="difflineminus">-  );</span>
<a href="#l49.29"></a><span id="l49.29" class="difflineplus">+add_task(function test_cp932_display() {</span>
<a href="#l49.30"></a><span id="l49.30" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(&quot;data/charset-cp932.eml&quot;));</span>
<a href="#l49.31"></a><span id="l49.31">   let msgc = open_message_from_file(file);</span>
<a href="#l49.32"></a><span id="l49.32">   let subjectText = msgc.e(&quot;expandedsubjectBox&quot;).textContent;</span>
<a href="#l49.33"></a><span id="l49.33">   let bodyText = msgc.e(&quot;messagepane&quot;).contentDocument.querySelector(&quot;body&quot;)</span>
<a href="#l49.34"></a><span id="l49.34">     .textContent;</span>
<a href="#l49.35"></a><span id="l49.35">   close_window(msgc);</span>
<a href="#l49.36"></a><span id="l49.36"> </span>
<a href="#l49.37"></a><span id="l49.37" class="difflineminus">-  assert_true(</span>
<a href="#l49.38"></a><span id="l49.38" class="difflineplus">+  Assert.ok(</span>
<a href="#l49.39"></a><span id="l49.39">     subjectText.includes(&quot;&quot;),</span>
<a href="#l49.40"></a><span id="l49.40">     &quot;Decoded cp932 text not found in message subject.&quot;</span>
<a href="#l49.41"></a><span id="l49.41">   );</span>
<a href="#l49.42"></a><span id="l49.42" class="difflineminus">-  assert_true(</span>
<a href="#l49.43"></a><span id="l49.43" class="difflineplus">+  Assert.ok(</span>
<a href="#l49.44"></a><span id="l49.44">     bodyText.includes(&quot;&quot;),</span>
<a href="#l49.45"></a><span id="l49.45">     &quot;Decoded cp932 text not found in message body.&quot;</span>
<a href="#l49.46"></a><span id="l49.46">   );</span>
<a href="#l49.47"></a><span id="l49.47" class="difflineminus">-}</span>
<a href="#l49.48"></a><span id="l49.48" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1">copy from mail/test/mozmill/composition/test-draft-identity.js</span>
<a href="#l50.2"></a><span id="l50.2">copy to mail/test/browser/composition/browser_draftIdentity.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-draft-identity.js</span>
<a href="#l50.4"></a><span id="l50.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_draftIdentity.js</span>
<a href="#l50.5"></a><span id="l50.5" class="difflineat">@@ -8,17 +8,16 @@</span>
<a href="#l50.6"></a><span id="l50.6">  */</span>
<a href="#l50.7"></a><span id="l50.7"> </span>
<a href="#l50.8"></a><span id="l50.8"> &quot;use strict&quot;;</span>
<a href="#l50.9"></a><span id="l50.9"> </span>
<a href="#l50.10"></a><span id="l50.10"> var { close_compose_window, open_compose_from_draft } = ChromeUtils.import(</span>
<a href="#l50.11"></a><span id="l50.11">   &quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;</span>
<a href="#l50.12"></a><span id="l50.12"> );</span>
<a href="#l50.13"></a><span id="l50.13"> var {</span>
<a href="#l50.14"></a><span id="l50.14" class="difflineminus">-  assert_equals,</span>
<a href="#l50.15"></a><span id="l50.15">   be_in_folder,</span>
<a href="#l50.16"></a><span id="l50.16">   get_special_folder,</span>
<a href="#l50.17"></a><span id="l50.17">   mc,</span>
<a href="#l50.18"></a><span id="l50.18">   press_delete,</span>
<a href="#l50.19"></a><span id="l50.19">   select_click_row,</span>
<a href="#l50.20"></a><span id="l50.20"> } = ChromeUtils.import(</span>
<a href="#l50.21"></a><span id="l50.21">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l50.22"></a><span id="l50.22"> );</span>
<a href="#l50.23"></a><span id="l50.23" class="difflineat">@@ -41,17 +40,17 @@ var gIdentities = [</span>
<a href="#l50.24"></a><span id="l50.24">   { email: &quot;x@example.invalid&quot; },</span>
<a href="#l50.25"></a><span id="l50.25">   { email: &quot;y@example.invalid&quot;, fullname: &quot;User Y&quot; },</span>
<a href="#l50.26"></a><span id="l50.26">   { email: &quot;y@example.invalid&quot;, fullname: &quot;User YY&quot;, label: &quot;YY&quot; },</span>
<a href="#l50.27"></a><span id="l50.27">   { email: &quot;y+y@example.invalid&quot;, fullname: &quot;User Y&quot; },</span>
<a href="#l50.28"></a><span id="l50.28">   { email: &quot;z@example.invalid&quot;, fullname: &quot;User Z&quot;, label: &quot;Label Z&quot; },</span>
<a href="#l50.29"></a><span id="l50.29">   { email: &quot;a+b@example.invalid&quot;, fullname: &quot;User A&quot; },</span>
<a href="#l50.30"></a><span id="l50.30"> ];</span>
<a href="#l50.31"></a><span id="l50.31"> </span>
<a href="#l50.32"></a><span id="l50.32" class="difflineminus">-function setupModule(module) {</span>
<a href="#l50.33"></a><span id="l50.33" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l50.34"></a><span id="l50.34">   // Now set up an account with some identities.</span>
<a href="#l50.35"></a><span id="l50.35">   let acctMgr = MailServices.accounts;</span>
<a href="#l50.36"></a><span id="l50.36">   gAccount = acctMgr.createAccount();</span>
<a href="#l50.37"></a><span id="l50.37">   gAccount.incomingServer = acctMgr.createIncomingServer(</span>
<a href="#l50.38"></a><span id="l50.38">     &quot;nobody&quot;,</span>
<a href="#l50.39"></a><span id="l50.39">     &quot;Draft Identity Testing&quot;,</span>
<a href="#l50.40"></a><span id="l50.40">     &quot;pop3&quot;</span>
<a href="#l50.41"></a><span id="l50.41">   );</span>
<a href="#l50.42"></a><span id="l50.42" class="difflineat">@@ -70,17 +69,17 @@ function setupModule(module) {</span>
<a href="#l50.43"></a><span id="l50.43">     gAccount.addIdentity(identity);</span>
<a href="#l50.44"></a><span id="l50.44">     id.key = identity.key;</span>
<a href="#l50.45"></a><span id="l50.45">     id.name = identity.identityName;</span>
<a href="#l50.46"></a><span id="l50.46">   }</span>
<a href="#l50.47"></a><span id="l50.47"> </span>
<a href="#l50.48"></a><span id="l50.48">   acctMgr.defaultAccount = gAccount;</span>
<a href="#l50.49"></a><span id="l50.49"> </span>
<a href="#l50.50"></a><span id="l50.50">   gDrafts = get_special_folder(Ci.nsMsgFolderFlags.Drafts, true);</span>
<a href="#l50.51"></a><span id="l50.51" class="difflineminus">-}</span>
<a href="#l50.52"></a><span id="l50.52" class="difflineplus">+});</span>
<a href="#l50.53"></a><span id="l50.53"> </span>
<a href="#l50.54"></a><span id="l50.54"> /**</span>
<a href="#l50.55"></a><span id="l50.55">  * Create a new templated draft message in the drafts folder.</span>
<a href="#l50.56"></a><span id="l50.56">  *</span>
<a href="#l50.57"></a><span id="l50.57">  * @return {integer}  The index (position) of the created message in the drafts folder.</span>
<a href="#l50.58"></a><span id="l50.58">  */</span>
<a href="#l50.59"></a><span id="l50.59"> function create_draft(aFrom, aIdKey) {</span>
<a href="#l50.60"></a><span id="l50.60">   let msgCount = gDrafts.getTotalMessages(false);</span>
<a href="#l50.61"></a><span id="l50.61" class="difflineat">@@ -106,52 +105,52 @@ function create_draft(aFrom, aIdKey) {</span>
<a href="#l50.62"></a><span id="l50.62">     &quot;Content-Type: text/plain; charset=utf-8\n&quot; +</span>
<a href="#l50.63"></a><span id="l50.63">     &quot;Content-Transfer-Encoding: 8bit\n&quot; +</span>
<a href="#l50.64"></a><span id="l50.64">     &quot;\n&quot; +</span>
<a href="#l50.65"></a><span id="l50.65">     &quot;Testing draft identity.\n&quot;;</span>
<a href="#l50.66"></a><span id="l50.66"> </span>
<a href="#l50.67"></a><span id="l50.67">   gDrafts.QueryInterface(Ci.nsIMsgLocalMailFolder).addMessage(source);</span>
<a href="#l50.68"></a><span id="l50.68">   let msgCountNew = gDrafts.getTotalMessages(false);</span>
<a href="#l50.69"></a><span id="l50.69"> </span>
<a href="#l50.70"></a><span id="l50.70" class="difflineminus">-  assert_equals(msgCountNew, msgCount + 1);</span>
<a href="#l50.71"></a><span id="l50.71" class="difflineplus">+  Assert.equal(msgCountNew, msgCount + 1);</span>
<a href="#l50.72"></a><span id="l50.72">   return msgCountNew - 1;</span>
<a href="#l50.73"></a><span id="l50.73"> }</span>
<a href="#l50.74"></a><span id="l50.74"> </span>
<a href="#l50.75"></a><span id="l50.75"> /**</span>
<a href="#l50.76"></a><span id="l50.76">  * Helper to check that a suitable From identity was set up in the given</span>
<a href="#l50.77"></a><span id="l50.77">  * composer window.</span>
<a href="#l50.78"></a><span id="l50.78">  *</span>
<a href="#l50.79"></a><span id="l50.79">  * @param cwc             Compose window controller.</span>
<a href="#l50.80"></a><span id="l50.80">  * @param aIdentityKey    The key of the expected identity.</span>
<a href="#l50.81"></a><span id="l50.81">  * @param aFrom           The expected displayed From address.</span>
<a href="#l50.82"></a><span id="l50.82">  */</span>
<a href="#l50.83"></a><span id="l50.83"> function checkCompIdentity(cwc, aIdentityKey, aFrom) {</span>
<a href="#l50.84"></a><span id="l50.84" class="difflineminus">-  assert_equals(</span>
<a href="#l50.85"></a><span id="l50.85" class="difflineplus">+  Assert.equal(</span>
<a href="#l50.86"></a><span id="l50.86">     cwc.window.getCurrentAccountKey(),</span>
<a href="#l50.87"></a><span id="l50.87">     gAccount.key,</span>
<a href="#l50.88"></a><span id="l50.88">     &quot;The From account is not correctly selected&quot;</span>
<a href="#l50.89"></a><span id="l50.89">   );</span>
<a href="#l50.90"></a><span id="l50.90" class="difflineminus">-  assert_equals(</span>
<a href="#l50.91"></a><span id="l50.91" class="difflineplus">+  Assert.equal(</span>
<a href="#l50.92"></a><span id="l50.92">     cwc.window.getCurrentIdentityKey(),</span>
<a href="#l50.93"></a><span id="l50.93">     aIdentityKey,</span>
<a href="#l50.94"></a><span id="l50.94">     &quot;The From identity is not correctly selected&quot;</span>
<a href="#l50.95"></a><span id="l50.95">   );</span>
<a href="#l50.96"></a><span id="l50.96" class="difflineminus">-  assert_equals(</span>
<a href="#l50.97"></a><span id="l50.97" class="difflineplus">+  Assert.equal(</span>
<a href="#l50.98"></a><span id="l50.98">     cwc.window.GetMsgIdentityElement().value,</span>
<a href="#l50.99"></a><span id="l50.99">     aFrom,</span>
<a href="#l50.100"></a><span id="l50.100">     &quot;The From value was initialized to an unexpected value&quot;</span>
<a href="#l50.101"></a><span id="l50.101">   );</span>
<a href="#l50.102"></a><span id="l50.102"> }</span>
<a href="#l50.103"></a><span id="l50.103"> </span>
<a href="#l50.104"></a><span id="l50.104"> /**</span>
<a href="#l50.105"></a><span id="l50.105">  * Bug 394216</span>
<a href="#l50.106"></a><span id="l50.106">  * Test that starting a new message from a draft with various combinations</span>
<a href="#l50.107"></a><span id="l50.107">  * of From and X-Identity-Key gets the expected initial identity selected.</span>
<a href="#l50.108"></a><span id="l50.108">  */</span>
<a href="#l50.109"></a><span id="l50.109" class="difflineminus">-function test_draft_identity_selection() {</span>
<a href="#l50.110"></a><span id="l50.110" class="difflineplus">+add_task(function test_draft_identity_selection() {</span>
<a href="#l50.111"></a><span id="l50.111">   let tests = [</span>
<a href="#l50.112"></a><span id="l50.112">     // X-Identity-Key header exists:</span>
<a href="#l50.113"></a><span id="l50.113">     // 1. From header matches X-Identity-Key identity exactly</span>
<a href="#l50.114"></a><span id="l50.114">     {</span>
<a href="#l50.115"></a><span id="l50.115">       idIndex: 1,</span>
<a href="#l50.116"></a><span id="l50.116">       warning: false,</span>
<a href="#l50.117"></a><span id="l50.117">       draftIdKey: gIdentities[1].key,</span>
<a href="#l50.118"></a><span id="l50.118">       draftFrom: gIdentities[1].name,</span>
<a href="#l50.119"></a><span id="l50.119" class="difflineat">@@ -271,20 +270,19 @@ function test_draft_identity_selection()</span>
<a href="#l50.120"></a><span id="l50.120">   cwc.click(cwc.eid(&quot;msgIdentity&quot;));</span>
<a href="#l50.121"></a><span id="l50.121">   cwc.click_menus_in_sequence(cwc.e(&quot;msgIdentityPopup&quot;),</span>
<a href="#l50.122"></a><span id="l50.122">                               [ { identitykey: gIdentities[0].key } ]);</span>
<a href="#l50.123"></a><span id="l50.123"> </span>
<a href="#l50.124"></a><span id="l50.124">   wait_for_notification_to_stop(cwc, &quot;compose-notification-bottom&quot;,</span>
<a href="#l50.125"></a><span id="l50.125">                                 &quot;identityWarning&quot;);</span>
<a href="#l50.126"></a><span id="l50.126">   close_compose_window(cwc, false);</span>
<a href="#l50.127"></a><span id="l50.127"> */</span>
<a href="#l50.128"></a><span id="l50.128" class="difflineminus">-}</span>
<a href="#l50.129"></a><span id="l50.129" class="difflineminus">-test_draft_identity_selection.EXCLUDED_PLATFORMS = [&quot;darwin&quot;]; // See bug 1413851.</span>
<a href="#l50.130"></a><span id="l50.130" class="difflineplus">+});</span>
<a href="#l50.131"></a><span id="l50.131"> </span>
<a href="#l50.132"></a><span id="l50.132" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l50.133"></a><span id="l50.133" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l50.134"></a><span id="l50.134">   for (let id = 1; id &lt; gIdentities.length; id++) {</span>
<a href="#l50.135"></a><span id="l50.135">     gAccount.removeIdentity(</span>
<a href="#l50.136"></a><span id="l50.136">       MailServices.accounts.getIdentity(gIdentities[id].key)</span>
<a href="#l50.137"></a><span id="l50.137">     );</span>
<a href="#l50.138"></a><span id="l50.138">   }</span>
<a href="#l50.139"></a><span id="l50.139"> </span>
<a href="#l50.140"></a><span id="l50.140">   // The last identity of an account can't be removed so clear all its prefs</span>
<a href="#l50.141"></a><span id="l50.141">   // which effectively destroys it.</span>
<a href="#l50.142"></a><span id="l50.142" class="difflineat">@@ -294,9 +292,9 @@ function teardownModule(module) {</span>
<a href="#l50.143"></a><span id="l50.143"> </span>
<a href="#l50.144"></a><span id="l50.144">   // Clear our drafts.</span>
<a href="#l50.145"></a><span id="l50.145">   be_in_folder(gDrafts);</span>
<a href="#l50.146"></a><span id="l50.146">   let draftCount;</span>
<a href="#l50.147"></a><span id="l50.147">   while ((draftCount = gDrafts.getTotalMessages(false)) &gt; 0) {</span>
<a href="#l50.148"></a><span id="l50.148">     press_delete();</span>
<a href="#l50.149"></a><span id="l50.149">     mc.waitFor(() =&gt; gDrafts.getTotalMessages(false) &lt; draftCount);</span>
<a href="#l50.150"></a><span id="l50.150">   }</span>
<a href="#l50.151"></a><span id="l50.151" class="difflineminus">-}</span>
<a href="#l50.152"></a><span id="l50.152" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1">copy from mail/test/mozmill/composition/test-drafts.js</span>
<a href="#l51.2"></a><span id="l51.2">copy to mail/test/browser/composition/browser_drafts.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-drafts.js</span>
<a href="#l51.4"></a><span id="l51.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_drafts.js</span>
<a href="#l51.5"></a><span id="l51.5" class="difflineat">@@ -4,29 +4,27 @@</span>
<a href="#l51.6"></a><span id="l51.6"> </span>
<a href="#l51.7"></a><span id="l51.7"> /**</span>
<a href="#l51.8"></a><span id="l51.8">  * Tests draft related functionality:</span>
<a href="#l51.9"></a><span id="l51.9">  * - that we don't allow opening multiple copies of a draft.</span>
<a href="#l51.10"></a><span id="l51.10">  */</span>
<a href="#l51.11"></a><span id="l51.11"> </span>
<a href="#l51.12"></a><span id="l51.12"> &quot;use strict&quot;;</span>
<a href="#l51.13"></a><span id="l51.13"> </span>
<a href="#l51.14"></a><span id="l51.14" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l51.15"></a><span id="l51.15" class="difflineplus">+var utils = ChromeUtils.import(&quot;resource://testing-common/mozmill/utils.jsm&quot;);</span>
<a href="#l51.16"></a><span id="l51.16"> </span>
<a href="#l51.17"></a><span id="l51.17"> var {</span>
<a href="#l51.18"></a><span id="l51.18">   close_compose_window,</span>
<a href="#l51.19"></a><span id="l51.19">   get_compose_body,</span>
<a href="#l51.20"></a><span id="l51.20">   get_msg_source,</span>
<a href="#l51.21"></a><span id="l51.21">   open_compose_new_mail,</span>
<a href="#l51.22"></a><span id="l51.22">   setup_msg_contents,</span>
<a href="#l51.23"></a><span id="l51.23">   wait_for_compose_window,</span>
<a href="#l51.24"></a><span id="l51.24"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l51.25"></a><span id="l51.25"> var {</span>
<a href="#l51.26"></a><span id="l51.26" class="difflineminus">-  assert_equals,</span>
<a href="#l51.27"></a><span id="l51.27" class="difflineminus">-  assert_true,</span>
<a href="#l51.28"></a><span id="l51.28">   be_in_folder,</span>
<a href="#l51.29"></a><span id="l51.29">   get_special_folder,</span>
<a href="#l51.30"></a><span id="l51.30">   make_new_sets_in_folder,</span>
<a href="#l51.31"></a><span id="l51.31">   mc,</span>
<a href="#l51.32"></a><span id="l51.32">   press_delete,</span>
<a href="#l51.33"></a><span id="l51.33">   select_click_row,</span>
<a href="#l51.34"></a><span id="l51.34"> } = ChromeUtils.import(</span>
<a href="#l51.35"></a><span id="l51.35">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l51.36"></a><span id="l51.36" class="difflineat">@@ -41,25 +39,25 @@ var { plan_for_new_window, wait_for_wind</span>
<a href="#l51.37"></a><span id="l51.37"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l51.38"></a><span id="l51.38"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l51.39"></a><span id="l51.39">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l51.40"></a><span id="l51.40"> );</span>
<a href="#l51.41"></a><span id="l51.41"> </span>
<a href="#l51.42"></a><span id="l51.42"> var kBoxId = &quot;mail-notification-top&quot;;</span>
<a href="#l51.43"></a><span id="l51.43"> var draftsFolder;</span>
<a href="#l51.44"></a><span id="l51.44"> </span>
<a href="#l51.45"></a><span id="l51.45" class="difflineminus">-function setupModule(module) {</span>
<a href="#l51.46"></a><span id="l51.46" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l51.47"></a><span id="l51.47">   draftsFolder = get_special_folder(Ci.nsMsgFolderFlags.Drafts, true);</span>
<a href="#l51.48"></a><span id="l51.48" class="difflineminus">-}</span>
<a href="#l51.49"></a><span id="l51.49" class="difflineplus">+});</span>
<a href="#l51.50"></a><span id="l51.50"> </span>
<a href="#l51.51"></a><span id="l51.51"> /**</span>
<a href="#l51.52"></a><span id="l51.52">  * Bug 349547.</span>
<a href="#l51.53"></a><span id="l51.53">  * Tests that we only open one compose window for one instance of a draft.</span>
<a href="#l51.54"></a><span id="l51.54">  */</span>
<a href="#l51.55"></a><span id="l51.55" class="difflineminus">-function test_open_draft_again() {</span>
<a href="#l51.56"></a><span id="l51.56" class="difflineplus">+add_task(function test_open_draft_again() {</span>
<a href="#l51.57"></a><span id="l51.57">   make_new_sets_in_folder(draftsFolder, [{ count: 1 }]);</span>
<a href="#l51.58"></a><span id="l51.58">   be_in_folder(draftsFolder);</span>
<a href="#l51.59"></a><span id="l51.59">   select_click_row(0);</span>
<a href="#l51.60"></a><span id="l51.60"> </span>
<a href="#l51.61"></a><span id="l51.61">   // Wait for the notification with the Edit button.</span>
<a href="#l51.62"></a><span id="l51.62">   wait_for_notification_to_show(mc, kBoxId, &quot;draftMsgContent&quot;);</span>
<a href="#l51.63"></a><span id="l51.63"> </span>
<a href="#l51.64"></a><span id="l51.64">   plan_for_new_window(&quot;msgcompose&quot;);</span>
<a href="#l51.65"></a><span id="l51.65" class="difflineat">@@ -73,39 +71,39 @@ function test_open_draft_again() {</span>
<a href="#l51.66"></a><span id="l51.66">     cwins++;</span>
<a href="#l51.67"></a><span id="l51.67">   }</span>
<a href="#l51.68"></a><span id="l51.68"> </span>
<a href="#l51.69"></a><span id="l51.69">   // click edit in main win again</span>
<a href="#l51.70"></a><span id="l51.70">   mc.click(mc.eid(kBoxId, { tagName: &quot;button&quot;, label: &quot;Edit&quot; }));</span>
<a href="#l51.71"></a><span id="l51.71"> </span>
<a href="#l51.72"></a><span id="l51.72">   mc.sleep(1000); // wait a sec to see if it caused a new window</span>
<a href="#l51.73"></a><span id="l51.73"> </span>
<a href="#l51.74"></a><span id="l51.74" class="difflineminus">-  assert_true(</span>
<a href="#l51.75"></a><span id="l51.75" class="difflineplus">+  Assert.ok(</span>
<a href="#l51.76"></a><span id="l51.76">     Services.ww.activeWindow == cwc.window,</span>
<a href="#l51.77"></a><span id="l51.77">     &quot;the original draft composition window should have got focus (again)&quot;</span>
<a href="#l51.78"></a><span id="l51.78">   );</span>
<a href="#l51.79"></a><span id="l51.79"> </span>
<a href="#l51.80"></a><span id="l51.80">   let cwins2 = 0;</span>
<a href="#l51.81"></a><span id="l51.81">   let e2 = Services.wm.getEnumerator(&quot;msgcompose&quot;);</span>
<a href="#l51.82"></a><span id="l51.82">   while (e2.hasMoreElements()) {</span>
<a href="#l51.83"></a><span id="l51.83">     e2.getNext();</span>
<a href="#l51.84"></a><span id="l51.84">     cwins2++;</span>
<a href="#l51.85"></a><span id="l51.85">   }</span>
<a href="#l51.86"></a><span id="l51.86"> </span>
<a href="#l51.87"></a><span id="l51.87" class="difflineminus">-  assert_true(cwins2 &gt; 0, &quot;No compose window open!&quot;);</span>
<a href="#l51.88"></a><span id="l51.88" class="difflineminus">-  assert_equals(cwins, cwins2, &quot;The number of compose windows changed!&quot;);</span>
<a href="#l51.89"></a><span id="l51.89" class="difflineplus">+  Assert.ok(cwins2 &gt; 0, &quot;No compose window open!&quot;);</span>
<a href="#l51.90"></a><span id="l51.90" class="difflineplus">+  Assert.equal(cwins, cwins2, &quot;The number of compose windows changed!&quot;);</span>
<a href="#l51.91"></a><span id="l51.91"> </span>
<a href="#l51.92"></a><span id="l51.92">   // Type something and save, then check that we only have one draft.</span>
<a href="#l51.93"></a><span id="l51.93">   cwc.type(cwc.eid(&quot;content-frame&quot;), &quot;Hello!&quot;);</span>
<a href="#l51.94"></a><span id="l51.94">   cwc.keypress(null, &quot;s&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l51.95"></a><span id="l51.95">   close_compose_window(cwc);</span>
<a href="#l51.96"></a><span id="l51.96" class="difflineminus">-  assert_equals(draftsFolder.getTotalMessages(false), 1);</span>
<a href="#l51.97"></a><span id="l51.97" class="difflineplus">+  Assert.equal(draftsFolder.getTotalMessages(false), 1);</span>
<a href="#l51.98"></a><span id="l51.98"> </span>
<a href="#l51.99"></a><span id="l51.99">   press_delete(mc); // clean up after ourselves</span>
<a href="#l51.100"></a><span id="l51.100" class="difflineminus">-}</span>
<a href="#l51.101"></a><span id="l51.101" class="difflineplus">+});</span>
<a href="#l51.102"></a><span id="l51.102"> </span>
<a href="#l51.103"></a><span id="l51.103"> /**</span>
<a href="#l51.104"></a><span id="l51.104">  * Bug 1202165</span>
<a href="#l51.105"></a><span id="l51.105">  * Test that the user set delivery format is preserved in a draft message.</span>
<a href="#l51.106"></a><span id="l51.106">  */</span>
<a href="#l51.107"></a><span id="l51.107"> function internal_check_delivery_format(editDraft) {</span>
<a href="#l51.108"></a><span id="l51.108">   let cwc = open_compose_new_mail();</span>
<a href="#l51.109"></a><span id="l51.109"> </span>
<a href="#l51.110"></a><span id="l51.110" class="difflineat">@@ -120,17 +118,17 @@ function internal_check_delivery_format(</span>
<a href="#l51.111"></a><span id="l51.111">   if (!mc.mozmillModule.isMac) {</span>
<a href="#l51.112"></a><span id="l51.112">     cwc.click(cwc.eid(&quot;optionsMenu&quot;));</span>
<a href="#l51.113"></a><span id="l51.113">     cwc.click_menus_in_sequence(cwc.e(&quot;optionsMenuPopup&quot;), [</span>
<a href="#l51.114"></a><span id="l51.114">       { id: &quot;outputFormatMenu&quot; },</span>
<a href="#l51.115"></a><span id="l51.115">       { id: &quot;format_both&quot; },</span>
<a href="#l51.116"></a><span id="l51.116">     ]);</span>
<a href="#l51.117"></a><span id="l51.117">   } else {</span>
<a href="#l51.118"></a><span id="l51.118">     // On OS X the main menu seems not accessible for clicking from mozmill.</span>
<a href="#l51.119"></a><span id="l51.119" class="difflineminus">-    assert_true(</span>
<a href="#l51.120"></a><span id="l51.120" class="difflineplus">+    Assert.ok(</span>
<a href="#l51.121"></a><span id="l51.121">       cwc</span>
<a href="#l51.122"></a><span id="l51.122">         .e(&quot;outputFormatMenu&quot;)</span>
<a href="#l51.123"></a><span id="l51.123">         .getAttribute(&quot;oncommand&quot;)</span>
<a href="#l51.124"></a><span id="l51.124">         .startsWith(&quot;OutputFormatMenuSelect(&quot;)</span>
<a href="#l51.125"></a><span id="l51.125">     );</span>
<a href="#l51.126"></a><span id="l51.126">     cwc.window.OutputFormatMenuSelect(cwc.e(&quot;format_both&quot;));</span>
<a href="#l51.127"></a><span id="l51.127">   }</span>
<a href="#l51.128"></a><span id="l51.128"> </span>
<a href="#l51.129"></a><span id="l51.129" class="difflineat">@@ -146,20 +144,20 @@ function internal_check_delivery_format(</span>
<a href="#l51.130"></a><span id="l51.130">       let formatMenu = cwc.click_menus_in_sequence(</span>
<a href="#l51.131"></a><span id="l51.131">         cwc.e(&quot;optionsMenuPopup&quot;),</span>
<a href="#l51.132"></a><span id="l51.132">         [{ id: &quot;outputFormatMenu&quot; }],</span>
<a href="#l51.133"></a><span id="l51.133">         true</span>
<a href="#l51.134"></a><span id="l51.134">       );</span>
<a href="#l51.135"></a><span id="l51.135">       let formatItem = cwc</span>
<a href="#l51.136"></a><span id="l51.136">         .e(&quot;outputFormatMenuPopup&quot;)</span>
<a href="#l51.137"></a><span id="l51.137">         .querySelector(&quot;[name=output_format][checked=true]&quot;);</span>
<a href="#l51.138"></a><span id="l51.138" class="difflineminus">-      assert_equals(formatItem.id, aMenuItemId);</span>
<a href="#l51.139"></a><span id="l51.139" class="difflineplus">+      Assert.equal(formatItem.id, aMenuItemId);</span>
<a href="#l51.140"></a><span id="l51.140">       cwc.close_popup_sequence(formatMenu);</span>
<a href="#l51.141"></a><span id="l51.141">     } else {</span>
<a href="#l51.142"></a><span id="l51.142" class="difflineminus">-      assert_equals(cwc.window.gSendFormat, aValue);</span>
<a href="#l51.143"></a><span id="l51.143" class="difflineplus">+      Assert.equal(cwc.window.gSendFormat, aValue);</span>
<a href="#l51.144"></a><span id="l51.144">     }</span>
<a href="#l51.145"></a><span id="l51.145">   }</span>
<a href="#l51.146"></a><span id="l51.146"> </span>
<a href="#l51.147"></a><span id="l51.147">   cwc.window.SaveAsDraft();</span>
<a href="#l51.148"></a><span id="l51.148">   utils.waitFor(</span>
<a href="#l51.149"></a><span id="l51.149">     () =&gt; !cwc.window.gSaveOperationInProgress &amp;&amp; !cwc.window.gWindowLock,</span>
<a href="#l51.150"></a><span id="l51.150">     &quot;Saving of draft did not finish&quot;</span>
<a href="#l51.151"></a><span id="l51.151">   );</span>
<a href="#l51.152"></a><span id="l51.152" class="difflineat">@@ -194,58 +192,58 @@ function internal_check_delivery_format(</span>
<a href="#l51.153"></a><span id="l51.153">   // Check if format value was restored.</span>
<a href="#l51.154"></a><span id="l51.154">   assert_format_value(&quot;format_both&quot;, Ci.nsIMsgCompSendFormat.Both);</span>
<a href="#l51.155"></a><span id="l51.155"> </span>
<a href="#l51.156"></a><span id="l51.156">   close_compose_window(cwc);</span>
<a href="#l51.157"></a><span id="l51.157"> </span>
<a href="#l51.158"></a><span id="l51.158">   press_delete(mc); // clean up the created draft</span>
<a href="#l51.159"></a><span id="l51.159"> }</span>
<a href="#l51.160"></a><span id="l51.160"> </span>
<a href="#l51.161"></a><span id="l51.161" class="difflineminus">-function test_save_delivery_format_with_edit_draft() {</span>
<a href="#l51.162"></a><span id="l51.162" class="difflineplus">+add_task(function test_save_delivery_format_with_edit_draft() {</span>
<a href="#l51.163"></a><span id="l51.163">   internal_check_delivery_format(true);</span>
<a href="#l51.164"></a><span id="l51.164" class="difflineminus">-}</span>
<a href="#l51.165"></a><span id="l51.165" class="difflineplus">+});</span>
<a href="#l51.166"></a><span id="l51.166"> </span>
<a href="#l51.167"></a><span id="l51.167" class="difflineminus">-function test_save_delivery_format_with_edit_template() {</span>
<a href="#l51.168"></a><span id="l51.168" class="difflineplus">+add_task(function test_save_delivery_format_with_edit_template() {</span>
<a href="#l51.169"></a><span id="l51.169">   internal_check_delivery_format(false);</span>
<a href="#l51.170"></a><span id="l51.170" class="difflineminus">-}</span>
<a href="#l51.171"></a><span id="l51.171" class="difflineplus">+});</span>
<a href="#l51.172"></a><span id="l51.172"> </span>
<a href="#l51.173"></a><span id="l51.173"> /**</span>
<a href="#l51.174"></a><span id="l51.174">  * Tests that 'Edit as New' leaves the original message in drafts folder.</span>
<a href="#l51.175"></a><span id="l51.175">  */</span>
<a href="#l51.176"></a><span id="l51.176" class="difflineminus">-function test_edit_as_new_in_draft() {</span>
<a href="#l51.177"></a><span id="l51.177" class="difflineplus">+add_task(function test_edit_as_new_in_draft() {</span>
<a href="#l51.178"></a><span id="l51.178">   make_new_sets_in_folder(draftsFolder, [{ count: 1 }]);</span>
<a href="#l51.179"></a><span id="l51.179">   be_in_folder(draftsFolder);</span>
<a href="#l51.180"></a><span id="l51.180"> </span>
<a href="#l51.181"></a><span id="l51.181" class="difflineminus">-  assert_equals(draftsFolder.getTotalMessages(false), 1);</span>
<a href="#l51.182"></a><span id="l51.182" class="difflineplus">+  Assert.equal(draftsFolder.getTotalMessages(false), 1);</span>
<a href="#l51.183"></a><span id="l51.183"> </span>
<a href="#l51.184"></a><span id="l51.184">   select_click_row(0);</span>
<a href="#l51.185"></a><span id="l51.185"> </span>
<a href="#l51.186"></a><span id="l51.186">   // Wait for the notification with the Edit button.</span>
<a href="#l51.187"></a><span id="l51.187">   wait_for_notification_to_show(mc, kBoxId, &quot;draftMsgContent&quot;);</span>
<a href="#l51.188"></a><span id="l51.188"> </span>
<a href="#l51.189"></a><span id="l51.189">   plan_for_new_window(&quot;msgcompose&quot;);</span>
<a href="#l51.190"></a><span id="l51.190">   mc.keypress(null, &quot;e&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l51.191"></a><span id="l51.191">   let cwc = wait_for_compose_window();</span>
<a href="#l51.192"></a><span id="l51.192"> </span>
<a href="#l51.193"></a><span id="l51.193">   cwc.type(cwc.eid(&quot;content-frame&quot;), &quot;Hello!&quot;);</span>
<a href="#l51.194"></a><span id="l51.194">   cwc.keypress(null, &quot;s&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l51.195"></a><span id="l51.195"> </span>
<a href="#l51.196"></a><span id="l51.196">   close_compose_window(cwc);</span>
<a href="#l51.197"></a><span id="l51.197" class="difflineminus">-  assert_equals(draftsFolder.getTotalMessages(false), 2);</span>
<a href="#l51.198"></a><span id="l51.198" class="difflineplus">+  Assert.equal(draftsFolder.getTotalMessages(false), 2);</span>
<a href="#l51.199"></a><span id="l51.199"> </span>
<a href="#l51.200"></a><span id="l51.200">   // Clean up the created drafts and count again.</span>
<a href="#l51.201"></a><span id="l51.201">   press_delete(mc);</span>
<a href="#l51.202"></a><span id="l51.202">   press_delete(mc);</span>
<a href="#l51.203"></a><span id="l51.203" class="difflineminus">-  assert_equals(draftsFolder.getTotalMessages(false), 0);</span>
<a href="#l51.204"></a><span id="l51.204" class="difflineminus">-}</span>
<a href="#l51.205"></a><span id="l51.205" class="difflineplus">+  Assert.equal(draftsFolder.getTotalMessages(false), 0);</span>
<a href="#l51.206"></a><span id="l51.206" class="difflineplus">+});</span>
<a href="#l51.207"></a><span id="l51.207"> </span>
<a href="#l51.208"></a><span id="l51.208"> /**</span>
<a href="#l51.209"></a><span id="l51.209">  * Tests Content-Language header.</span>
<a href="#l51.210"></a><span id="l51.210">  */</span>
<a href="#l51.211"></a><span id="l51.211" class="difflineminus">-function test_content_language_header() {</span>
<a href="#l51.212"></a><span id="l51.212" class="difflineplus">+add_task(function test_content_language_header() {</span>
<a href="#l51.213"></a><span id="l51.213">   let cwc = open_compose_new_mail();</span>
<a href="#l51.214"></a><span id="l51.214"> </span>
<a href="#l51.215"></a><span id="l51.215">   setup_msg_contents(</span>
<a href="#l51.216"></a><span id="l51.216">     cwc,</span>
<a href="#l51.217"></a><span id="l51.217">     &quot;test@example.invalid&quot;,</span>
<a href="#l51.218"></a><span id="l51.218">     &quot;Testing Content-Language header&quot;,</span>
<a href="#l51.219"></a><span id="l51.219">     &quot;Hello, we speak en-US&quot;</span>
<a href="#l51.220"></a><span id="l51.220">   );</span>
<a href="#l51.221"></a><span id="l51.221" class="difflineat">@@ -263,27 +261,27 @@ function test_content_language_header() </span>
<a href="#l51.222"></a><span id="l51.222">   let draftMsgContent = get_msg_source(draftMsg);</span>
<a href="#l51.223"></a><span id="l51.223"> </span>
<a href="#l51.224"></a><span id="l51.224">   // Check for a single line that contains our header.</span>
<a href="#l51.225"></a><span id="l51.225">   if (</span>
<a href="#l51.226"></a><span id="l51.226">     !draftMsgContent</span>
<a href="#l51.227"></a><span id="l51.227">       .split(&quot;\n&quot;)</span>
<a href="#l51.228"></a><span id="l51.228">       .some(line =&gt; line.trim() == &quot;Content-Language: en-US&quot;)</span>
<a href="#l51.229"></a><span id="l51.229">   ) {</span>
<a href="#l51.230"></a><span id="l51.230" class="difflineminus">-    assert_true(false, &quot;Failed to find Content-Language: en-US&quot;);</span>
<a href="#l51.231"></a><span id="l51.231" class="difflineplus">+    Assert.ok(false, &quot;Failed to find Content-Language: en-US&quot;);</span>
<a href="#l51.232"></a><span id="l51.232">   }</span>
<a href="#l51.233"></a><span id="l51.233"> </span>
<a href="#l51.234"></a><span id="l51.234">   // Clean up the created draft.</span>
<a href="#l51.235"></a><span id="l51.235">   press_delete(mc);</span>
<a href="#l51.236"></a><span id="l51.236" class="difflineminus">-}</span>
<a href="#l51.237"></a><span id="l51.237" class="difflineplus">+});</span>
<a href="#l51.238"></a><span id="l51.238"> </span>
<a href="#l51.239"></a><span id="l51.239"> /**</span>
<a href="#l51.240"></a><span id="l51.240">  * Tests space stuffing of plaintext message.</span>
<a href="#l51.241"></a><span id="l51.241">  */</span>
<a href="#l51.242"></a><span id="l51.242" class="difflineminus">-function test_remove_space_stuffing_format_flowed() {</span>
<a href="#l51.243"></a><span id="l51.243" class="difflineplus">+add_task(function test_remove_space_stuffing_format_flowed() {</span>
<a href="#l51.244"></a><span id="l51.244">   // Prepare for plaintext email.</span>
<a href="#l51.245"></a><span id="l51.245">   let oldHtmlPref = Services.prefs.getBoolPref(</span>
<a href="#l51.246"></a><span id="l51.246">     &quot;mail.identity.default.compose_html&quot;</span>
<a href="#l51.247"></a><span id="l51.247">   );</span>
<a href="#l51.248"></a><span id="l51.248">   Services.prefs.setBoolPref(&quot;mail.identity.default.compose_html&quot;, false);</span>
<a href="#l51.249"></a><span id="l51.249"> </span>
<a href="#l51.250"></a><span id="l51.250">   let cwc = open_compose_new_mail();</span>
<a href="#l51.251"></a><span id="l51.251"> </span>
<a href="#l51.252"></a><span id="l51.252" class="difflineat">@@ -311,18 +309,17 @@ function test_remove_space_stuffing_form</span>
<a href="#l51.253"></a><span id="l51.253">   wait_for_notification_to_show(mc, kBoxId, &quot;draftMsgContent&quot;);</span>
<a href="#l51.254"></a><span id="l51.254"> </span>
<a href="#l51.255"></a><span id="l51.255">   plan_for_new_window(&quot;msgcompose&quot;);</span>
<a href="#l51.256"></a><span id="l51.256">   mc.click(mc.eid(kBoxId, { tagName: &quot;button&quot;, label: &quot;Edit&quot; }));</span>
<a href="#l51.257"></a><span id="l51.257">   cwc = wait_for_compose_window();</span>
<a href="#l51.258"></a><span id="l51.258"> </span>
<a href="#l51.259"></a><span id="l51.259">   let bodyText = get_compose_body(cwc).innerHTML;</span>
<a href="#l51.260"></a><span id="l51.260">   if (!bodyText.includes(&quot;NoSpace&lt;br&gt; OneSpace&lt;br&gt;  TwoSpaces&quot;)) {</span>
<a href="#l51.261"></a><span id="l51.261" class="difflineminus">-    assert_true(false, &quot;Something went wrong with space stuffing&quot;);</span>
<a href="#l51.262"></a><span id="l51.262" class="difflineplus">+    Assert.ok(false, &quot;Something went wrong with space stuffing&quot;);</span>
<a href="#l51.263"></a><span id="l51.263">   }</span>
<a href="#l51.264"></a><span id="l51.264" class="difflineplus">+  close_compose_window(cwc);</span>
<a href="#l51.265"></a><span id="l51.265"> </span>
<a href="#l51.266"></a><span id="l51.266">   // Clean up the created draft.</span>
<a href="#l51.267"></a><span id="l51.267">   press_delete(mc);</span>
<a href="#l51.268"></a><span id="l51.268"> </span>
<a href="#l51.269"></a><span id="l51.269">   Services.prefs.setBoolPref(&quot;mail.identity.default.compose_html&quot;, oldHtmlPref);</span>
<a href="#l51.270"></a><span id="l51.270" class="difflineminus">-}</span>
<a href="#l51.271"></a><span id="l51.271" class="difflineminus">-</span>
<a href="#l51.272"></a><span id="l51.272" class="difflineminus">-function teardownModule() {}</span>
<a href="#l51.273"></a><span id="l51.273" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1">copy from mail/test/mozmill/composition/test-eml-actions.js</span>
<a href="#l52.2"></a><span id="l52.2">copy to mail/test/browser/composition/browser_emlActions.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-eml-actions.js</span>
<a href="#l52.4"></a><span id="l52.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_emlActions.js</span>
<a href="#l52.5"></a><span id="l52.5" class="difflineat">@@ -4,28 +4,27 @@</span>
<a href="#l52.6"></a><span id="l52.6"> </span>
<a href="#l52.7"></a><span id="l52.7"> /**</span>
<a href="#l52.8"></a><span id="l52.8">  * Tests that actions such as replying to an .eml works properly.</span>
<a href="#l52.9"></a><span id="l52.9">  */</span>
<a href="#l52.10"></a><span id="l52.10"> </span>
<a href="#l52.11"></a><span id="l52.11"> &quot;use strict&quot;;</span>
<a href="#l52.12"></a><span id="l52.12"> </span>
<a href="#l52.13"></a><span id="l52.13"> var elib = ChromeUtils.import(</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l52.15"></a><span id="l52.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l52.16"></a><span id="l52.16"> );</span>
<a href="#l52.17"></a><span id="l52.17" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l52.19"></a><span id="l52.19"> </span>
<a href="#l52.20"></a><span id="l52.20"> var {</span>
<a href="#l52.21"></a><span id="l52.21">   close_compose_window,</span>
<a href="#l52.22"></a><span id="l52.22">   get_compose_body,</span>
<a href="#l52.23"></a><span id="l52.23">   open_compose_with_forward,</span>
<a href="#l52.24"></a><span id="l52.24">   open_compose_with_reply,</span>
<a href="#l52.25"></a><span id="l52.25"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l52.26"></a><span id="l52.26"> var {</span>
<a href="#l52.27"></a><span id="l52.27" class="difflineminus">-  assert_equals,</span>
<a href="#l52.28"></a><span id="l52.28">   be_in_folder,</span>
<a href="#l52.29"></a><span id="l52.29">   get_special_folder,</span>
<a href="#l52.30"></a><span id="l52.30">   open_message_from_file,</span>
<a href="#l52.31"></a><span id="l52.31">   press_delete,</span>
<a href="#l52.32"></a><span id="l52.32">   select_click_row,</span>
<a href="#l52.33"></a><span id="l52.33"> } = ChromeUtils.import(</span>
<a href="#l52.34"></a><span id="l52.34">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l52.35"></a><span id="l52.35"> );</span>
<a href="#l52.36"></a><span id="l52.36" class="difflineat">@@ -34,29 +33,27 @@ var { close_window } = ChromeUtils.impor</span>
<a href="#l52.37"></a><span id="l52.37"> );</span>
<a href="#l52.38"></a><span id="l52.38"> </span>
<a href="#l52.39"></a><span id="l52.39"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l52.40"></a><span id="l52.40">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l52.41"></a><span id="l52.41"> );</span>
<a href="#l52.42"></a><span id="l52.42"> </span>
<a href="#l52.43"></a><span id="l52.43"> var gDrafts;</span>
<a href="#l52.44"></a><span id="l52.44"> </span>
<a href="#l52.45"></a><span id="l52.45" class="difflineminus">-function setupModule(module) {</span>
<a href="#l52.46"></a><span id="l52.46" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l52.47"></a><span id="l52.47">   gDrafts = get_special_folder(Ci.nsMsgFolderFlags.Drafts, true);</span>
<a href="#l52.48"></a><span id="l52.48" class="difflineminus">-}</span>
<a href="#l52.49"></a><span id="l52.49" class="difflineplus">+});</span>
<a href="#l52.50"></a><span id="l52.50"> </span>
<a href="#l52.51"></a><span id="l52.51"> /**</span>
<a href="#l52.52"></a><span id="l52.52">  * Test that replying to an opened .eml message works, and that the reply can</span>
<a href="#l52.53"></a><span id="l52.53">  * be saved as a draft.</span>
<a href="#l52.54"></a><span id="l52.54">  */</span>
<a href="#l52.55"></a><span id="l52.55" class="difflineminus">-function test_reply_to_eml_save_as_draft() {</span>
<a href="#l52.56"></a><span id="l52.56" class="difflineplus">+add_task(function test_reply_to_eml_save_as_draft() {</span>
<a href="#l52.57"></a><span id="l52.57">   // Open an .eml file.</span>
<a href="#l52.58"></a><span id="l52.58" class="difflineminus">-  let file = os.getFileForPath(</span>
<a href="#l52.59"></a><span id="l52.59" class="difflineminus">-    os.abspath(&quot;./testmsg.eml&quot;, os.getFileForPath(__file__))</span>
<a href="#l52.60"></a><span id="l52.60" class="difflineminus">-  );</span>
<a href="#l52.61"></a><span id="l52.61" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(&quot;data/testmsg.eml&quot;));</span>
<a href="#l52.62"></a><span id="l52.62">   let msgc = open_message_from_file(file);</span>
<a href="#l52.63"></a><span id="l52.63"> </span>
<a href="#l52.64"></a><span id="l52.64">   let replyWin = open_compose_with_reply(msgc);</span>
<a href="#l52.65"></a><span id="l52.65"> </span>
<a href="#l52.66"></a><span id="l52.66">   // Ctrl+S saves as draft.</span>
<a href="#l52.67"></a><span id="l52.67">   replyWin.keypress(null, &quot;s&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l52.68"></a><span id="l52.68"> </span>
<a href="#l52.69"></a><span id="l52.69">   // Drafts folder should exist now.</span>
<a href="#l52.70"></a><span id="l52.70" class="difflineat">@@ -64,27 +61,25 @@ function test_reply_to_eml_save_as_draft</span>
<a href="#l52.71"></a><span id="l52.71">   let draftMsg = select_click_row(0);</span>
<a href="#l52.72"></a><span id="l52.72">   if (!draftMsg) {</span>
<a href="#l52.73"></a><span id="l52.73">     throw new Error(&quot;No draft saved!&quot;);</span>
<a href="#l52.74"></a><span id="l52.74">   }</span>
<a href="#l52.75"></a><span id="l52.75">   press_delete(); // Delete the draft.</span>
<a href="#l52.76"></a><span id="l52.76"> </span>
<a href="#l52.77"></a><span id="l52.77">   close_compose_window(replyWin); // close compose window</span>
<a href="#l52.78"></a><span id="l52.78">   close_window(msgc); // close base .eml message</span>
<a href="#l52.79"></a><span id="l52.79" class="difflineminus">-}</span>
<a href="#l52.80"></a><span id="l52.80" class="difflineplus">+});</span>
<a href="#l52.81"></a><span id="l52.81"> </span>
<a href="#l52.82"></a><span id="l52.82"> /**</span>
<a href="#l52.83"></a><span id="l52.83">  * Test that forwarding an opened .eml message works, and that the forward can</span>
<a href="#l52.84"></a><span id="l52.84">  * be saved as a draft.</span>
<a href="#l52.85"></a><span id="l52.85">  */</span>
<a href="#l52.86"></a><span id="l52.86" class="difflineminus">-function test_forward_eml_save_as_draft() {</span>
<a href="#l52.87"></a><span id="l52.87" class="difflineplus">+add_task(function test_forward_eml_save_as_draft() {</span>
<a href="#l52.88"></a><span id="l52.88">   // Open an .eml file.</span>
<a href="#l52.89"></a><span id="l52.89" class="difflineminus">-  let file = os.getFileForPath(</span>
<a href="#l52.90"></a><span id="l52.90" class="difflineminus">-    os.abspath(&quot;./testmsg.eml&quot;, os.getFileForPath(__file__))</span>
<a href="#l52.91"></a><span id="l52.91" class="difflineminus">-  );</span>
<a href="#l52.92"></a><span id="l52.92" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(&quot;data/testmsg.eml&quot;));</span>
<a href="#l52.93"></a><span id="l52.93">   let msgc = open_message_from_file(file);</span>
<a href="#l52.94"></a><span id="l52.94"> </span>
<a href="#l52.95"></a><span id="l52.95">   let replyWin = open_compose_with_forward(msgc);</span>
<a href="#l52.96"></a><span id="l52.96"> </span>
<a href="#l52.97"></a><span id="l52.97">   // Ctrl+S saves as draft.</span>
<a href="#l52.98"></a><span id="l52.98">   replyWin.keypress(null, &quot;s&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l52.99"></a><span id="l52.99"> </span>
<a href="#l52.100"></a><span id="l52.100">   // Drafts folder should exist now.</span>
<a href="#l52.101"></a><span id="l52.101" class="difflineat">@@ -92,43 +87,41 @@ function test_forward_eml_save_as_draft(</span>
<a href="#l52.102"></a><span id="l52.102">   let draftMsg = select_click_row(0);</span>
<a href="#l52.103"></a><span id="l52.103">   if (!draftMsg) {</span>
<a href="#l52.104"></a><span id="l52.104">     throw new Error(&quot;No draft saved!&quot;);</span>
<a href="#l52.105"></a><span id="l52.105">   }</span>
<a href="#l52.106"></a><span id="l52.106">   press_delete(); // Delete the draft.</span>
<a href="#l52.107"></a><span id="l52.107"> </span>
<a href="#l52.108"></a><span id="l52.108">   close_compose_window(replyWin); // close compose window</span>
<a href="#l52.109"></a><span id="l52.109">   close_window(msgc); // close base .eml message</span>
<a href="#l52.110"></a><span id="l52.110" class="difflineminus">-}</span>
<a href="#l52.111"></a><span id="l52.111" class="difflineplus">+});</span>
<a href="#l52.112"></a><span id="l52.112"> </span>
<a href="#l52.113"></a><span id="l52.113"> /**</span>
<a href="#l52.114"></a><span id="l52.114">  * Test that MIME encoded subject is decoded when replying to an opened .eml.</span>
<a href="#l52.115"></a><span id="l52.115">  */</span>
<a href="#l52.116"></a><span id="l52.116" class="difflineminus">-function test_reply_eml_subject() {</span>
<a href="#l52.117"></a><span id="l52.117" class="difflineplus">+add_task(function test_reply_eml_subject() {</span>
<a href="#l52.118"></a><span id="l52.118">   // Open an .eml file whose subject is encoded.</span>
<a href="#l52.119"></a><span id="l52.119" class="difflineminus">-  let file = os.getFileForPath(</span>
<a href="#l52.120"></a><span id="l52.120" class="difflineminus">-    os.abspath(&quot;./mime-encoded-subject.eml&quot;, os.getFileForPath(__file__))</span>
<a href="#l52.121"></a><span id="l52.121" class="difflineplus">+  let file = new FileUtils.File(</span>
<a href="#l52.122"></a><span id="l52.122" class="difflineplus">+    getTestFilePath(&quot;data/mime-encoded-subject.eml&quot;)</span>
<a href="#l52.123"></a><span id="l52.123">   );</span>
<a href="#l52.124"></a><span id="l52.124">   let msgc = open_message_from_file(file);</span>
<a href="#l52.125"></a><span id="l52.125"> </span>
<a href="#l52.126"></a><span id="l52.126">   let replyWin = open_compose_with_reply(msgc);</span>
<a href="#l52.127"></a><span id="l52.127"> </span>
<a href="#l52.128"></a><span id="l52.128" class="difflineminus">-  assert_equals(replyWin.e(&quot;msgSubject&quot;).value, &quot;Re: \u2200a\u220aA&quot;);</span>
<a href="#l52.129"></a><span id="l52.129" class="difflineplus">+  Assert.equal(replyWin.e(&quot;msgSubject&quot;).value, &quot;Re: \u2200a\u220aA&quot;);</span>
<a href="#l52.130"></a><span id="l52.130">   close_compose_window(replyWin); // close compose window</span>
<a href="#l52.131"></a><span id="l52.131">   close_window(msgc); // close base .eml message</span>
<a href="#l52.132"></a><span id="l52.132" class="difflineminus">-}</span>
<a href="#l52.133"></a><span id="l52.133" class="difflineplus">+});</span>
<a href="#l52.134"></a><span id="l52.134"> </span>
<a href="#l52.135"></a><span id="l52.135"> /**</span>
<a href="#l52.136"></a><span id="l52.136">  * Test that replying to a base64 encoded .eml works.</span>
<a href="#l52.137"></a><span id="l52.137">  */</span>
<a href="#l52.138"></a><span id="l52.138" class="difflineminus">-function test_reply_to_base64_eml() {</span>
<a href="#l52.139"></a><span id="l52.139" class="difflineplus">+add_task(function test_reply_to_base64_eml() {</span>
<a href="#l52.140"></a><span id="l52.140">   // Open an .eml file.</span>
<a href="#l52.141"></a><span id="l52.141" class="difflineminus">-  let file = os.getFileForPath(</span>
<a href="#l52.142"></a><span id="l52.142" class="difflineminus">-    os.abspath(&quot;./base64-encoded-msg.eml&quot;, os.getFileForPath(__file__))</span>
<a href="#l52.143"></a><span id="l52.143" class="difflineminus">-  );</span>
<a href="#l52.144"></a><span id="l52.144" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(&quot;data/base64-encoded-msg.eml&quot;));</span>
<a href="#l52.145"></a><span id="l52.145">   let msgc = open_message_from_file(file);</span>
<a href="#l52.146"></a><span id="l52.146"> </span>
<a href="#l52.147"></a><span id="l52.147">   let compWin = open_compose_with_reply(msgc);</span>
<a href="#l52.148"></a><span id="l52.148"> </span>
<a href="#l52.149"></a><span id="l52.149">   let bodyText = get_compose_body(compWin).textContent;</span>
<a href="#l52.150"></a><span id="l52.150">   const message = &quot;You have decoded this text from base64.&quot;;</span>
<a href="#l52.151"></a><span id="l52.151">   if (!bodyText.includes(message)) {</span>
<a href="#l52.152"></a><span id="l52.152">     throw new Error(</span>
<a href="#l52.153"></a><span id="l52.153" class="difflineat">@@ -136,26 +129,24 @@ function test_reply_to_base64_eml() {</span>
<a href="#l52.154"></a><span id="l52.154">         message +</span>
<a href="#l52.155"></a><span id="l52.155">         &quot;, bodyText=&quot; +</span>
<a href="#l52.156"></a><span id="l52.156">         bodyText</span>
<a href="#l52.157"></a><span id="l52.157">     );</span>
<a href="#l52.158"></a><span id="l52.158">   }</span>
<a href="#l52.159"></a><span id="l52.159"> </span>
<a href="#l52.160"></a><span id="l52.160">   close_compose_window(compWin);</span>
<a href="#l52.161"></a><span id="l52.161">   close_window(msgc);</span>
<a href="#l52.162"></a><span id="l52.162" class="difflineminus">-}</span>
<a href="#l52.163"></a><span id="l52.163" class="difflineplus">+});</span>
<a href="#l52.164"></a><span id="l52.164"> </span>
<a href="#l52.165"></a><span id="l52.165"> /**</span>
<a href="#l52.166"></a><span id="l52.166">  * Test that forwarding a base64 encoded .eml works.</span>
<a href="#l52.167"></a><span id="l52.167">  */</span>
<a href="#l52.168"></a><span id="l52.168" class="difflineminus">-function test_forward_base64_eml() {</span>
<a href="#l52.169"></a><span id="l52.169" class="difflineplus">+add_task(function test_forward_base64_eml() {</span>
<a href="#l52.170"></a><span id="l52.170">   // Open an .eml file.</span>
<a href="#l52.171"></a><span id="l52.171" class="difflineminus">-  let file = os.getFileForPath(</span>
<a href="#l52.172"></a><span id="l52.172" class="difflineminus">-    os.abspath(&quot;./base64-encoded-msg.eml&quot;, os.getFileForPath(__file__))</span>
<a href="#l52.173"></a><span id="l52.173" class="difflineminus">-  );</span>
<a href="#l52.174"></a><span id="l52.174" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(&quot;data/base64-encoded-msg.eml&quot;));</span>
<a href="#l52.175"></a><span id="l52.175">   let msgc = open_message_from_file(file);</span>
<a href="#l52.176"></a><span id="l52.176"> </span>
<a href="#l52.177"></a><span id="l52.177">   let compWin = open_compose_with_forward(msgc);</span>
<a href="#l52.178"></a><span id="l52.178"> </span>
<a href="#l52.179"></a><span id="l52.179">   let bodyText = get_compose_body(compWin).textContent;</span>
<a href="#l52.180"></a><span id="l52.180">   const message = &quot;You have decoded this text from base64.&quot;;</span>
<a href="#l52.181"></a><span id="l52.181">   if (!bodyText.includes(message)) {</span>
<a href="#l52.182"></a><span id="l52.182">     throw new Error(</span>
<a href="#l52.183"></a><span id="l52.183" class="difflineat">@@ -163,9 +154,9 @@ function test_forward_base64_eml() {</span>
<a href="#l52.184"></a><span id="l52.184">         message +</span>
<a href="#l52.185"></a><span id="l52.185">         &quot;, bodyText=&quot; +</span>
<a href="#l52.186"></a><span id="l52.186">         bodyText</span>
<a href="#l52.187"></a><span id="l52.187">     );</span>
<a href="#l52.188"></a><span id="l52.188">   }</span>
<a href="#l52.189"></a><span id="l52.189"> </span>
<a href="#l52.190"></a><span id="l52.190">   close_compose_window(compWin);</span>
<a href="#l52.191"></a><span id="l52.191">   close_window(msgc);</span>
<a href="#l52.192"></a><span id="l52.192" class="difflineminus">-}</span>
<a href="#l52.193"></a><span id="l52.193" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1">copy from mail/test/mozmill/composition/test-focus.js</span>
<a href="#l53.2"></a><span id="l53.2">copy to mail/test/browser/composition/browser_focus.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-focus.js</span>
<a href="#l53.4"></a><span id="l53.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_focus.js</span>
<a href="#l53.5"></a><span id="l53.5" class="difflineat">@@ -8,17 +8,17 @@</span>
<a href="#l53.6"></a><span id="l53.6"> </span>
<a href="#l53.7"></a><span id="l53.7"> &quot;use strict&quot;;</span>
<a href="#l53.8"></a><span id="l53.8"> </span>
<a href="#l53.9"></a><span id="l53.9"> var {</span>
<a href="#l53.10"></a><span id="l53.10">   add_attachments,</span>
<a href="#l53.11"></a><span id="l53.11">   close_compose_window,</span>
<a href="#l53.12"></a><span id="l53.12">   open_compose_new_mail,</span>
<a href="#l53.13"></a><span id="l53.13"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l53.14"></a><span id="l53.14" class="difflineminus">-var { assert_equals, mc } = ChromeUtils.import(</span>
<a href="#l53.15"></a><span id="l53.15" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l53.16"></a><span id="l53.16">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l53.17"></a><span id="l53.17"> );</span>
<a href="#l53.18"></a><span id="l53.18"> </span>
<a href="#l53.19"></a><span id="l53.19"> /**</span>
<a href="#l53.20"></a><span id="l53.20">  * Check that it's possible to cycle through the compose window's important</span>
<a href="#l53.21"></a><span id="l53.21">  * elements forward and backward.</span>
<a href="#l53.22"></a><span id="l53.22">  *</span>
<a href="#l53.23"></a><span id="l53.23">  * @param controller the compose window controller</span>
<a href="#l53.24"></a><span id="l53.24" class="difflineat">@@ -33,61 +33,61 @@ function check_element_cycling(controlle</span>
<a href="#l53.25"></a><span id="l53.25">   let contentElement = controller.window.content;</span>
<a href="#l53.26"></a><span id="l53.26">   let identityElement = controller.e(&quot;msgIdentity&quot;);</span>
<a href="#l53.27"></a><span id="l53.27"> </span>
<a href="#l53.28"></a><span id="l53.28">   let key = ctrlTab ? &quot;VK_TAB&quot; : &quot;VK_F6&quot;;</span>
<a href="#l53.29"></a><span id="l53.29"> </span>
<a href="#l53.30"></a><span id="l53.30">   // We start on the addressing widget and go from there.</span>
<a href="#l53.31"></a><span id="l53.31"> </span>
<a href="#l53.32"></a><span id="l53.32">   controller.keypress(null, key, { ctrlKey: ctrlTab });</span>
<a href="#l53.33"></a><span id="l53.33" class="difflineminus">-  assert_equals(subjectElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.34"></a><span id="l53.34" class="difflineplus">+  Assert.equal(subjectElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.35"></a><span id="l53.35">   if (attachmentsExpanded) {</span>
<a href="#l53.36"></a><span id="l53.36">     controller.keypress(null, key, { ctrlKey: ctrlTab });</span>
<a href="#l53.37"></a><span id="l53.37" class="difflineminus">-    assert_equals(attachmentElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.38"></a><span id="l53.38" class="difflineplus">+    Assert.equal(attachmentElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.39"></a><span id="l53.39">   }</span>
<a href="#l53.40"></a><span id="l53.40">   controller.keypress(null, key, { ctrlKey: ctrlTab });</span>
<a href="#l53.41"></a><span id="l53.41" class="difflineminus">-  assert_equals(contentElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.42"></a><span id="l53.42" class="difflineplus">+  Assert.equal(contentElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.43"></a><span id="l53.43">   controller.keypress(null, key, { ctrlKey: ctrlTab });</span>
<a href="#l53.44"></a><span id="l53.44" class="difflineminus">-  assert_equals(identityElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.45"></a><span id="l53.45" class="difflineplus">+  Assert.equal(identityElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.46"></a><span id="l53.46">   controller.keypress(null, key, { ctrlKey: ctrlTab });</span>
<a href="#l53.47"></a><span id="l53.47">   mc.sleep(0); // Focusing the addressing element happens in a timeout...</span>
<a href="#l53.48"></a><span id="l53.48" class="difflineminus">-  assert_equals(addressingElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.49"></a><span id="l53.49" class="difflineplus">+  Assert.equal(addressingElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.50"></a><span id="l53.50"> </span>
<a href="#l53.51"></a><span id="l53.51">   controller.keypress(null, key, { ctrlKey: ctrlTab, shiftKey: true });</span>
<a href="#l53.52"></a><span id="l53.52" class="difflineminus">-  assert_equals(identityElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.53"></a><span id="l53.53" class="difflineplus">+  Assert.equal(identityElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.54"></a><span id="l53.54">   controller.keypress(null, key, { ctrlKey: ctrlTab, shiftKey: true });</span>
<a href="#l53.55"></a><span id="l53.55" class="difflineminus">-  assert_equals(contentElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.56"></a><span id="l53.56" class="difflineplus">+  Assert.equal(contentElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.57"></a><span id="l53.57">   if (attachmentsExpanded) {</span>
<a href="#l53.58"></a><span id="l53.58">     controller.keypress(null, key, { ctrlKey: ctrlTab, shiftKey: true });</span>
<a href="#l53.59"></a><span id="l53.59" class="difflineminus">-    assert_equals(attachmentElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.60"></a><span id="l53.60" class="difflineplus">+    Assert.equal(attachmentElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.61"></a><span id="l53.61">   }</span>
<a href="#l53.62"></a><span id="l53.62">   controller.keypress(null, key, { ctrlKey: ctrlTab, shiftKey: true });</span>
<a href="#l53.63"></a><span id="l53.63" class="difflineminus">-  assert_equals(subjectElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.64"></a><span id="l53.64" class="difflineplus">+  Assert.equal(subjectElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.65"></a><span id="l53.65">   controller.keypress(null, key, { ctrlKey: ctrlTab, shiftKey: true });</span>
<a href="#l53.66"></a><span id="l53.66">   mc.sleep(0); // Focusing the addressing element happens in a timeout...</span>
<a href="#l53.67"></a><span id="l53.67" class="difflineminus">-  assert_equals(addressingElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.68"></a><span id="l53.68" class="difflineplus">+  Assert.equal(addressingElement, controller.window.WhichElementHasFocus());</span>
<a href="#l53.69"></a><span id="l53.69"> }</span>
<a href="#l53.70"></a><span id="l53.70"> </span>
<a href="#l53.71"></a><span id="l53.71" class="difflineminus">-function test_f6_no_attachment() {</span>
<a href="#l53.72"></a><span id="l53.72" class="difflineplus">+add_task(function test_f6_no_attachment() {</span>
<a href="#l53.73"></a><span id="l53.73">   let cwc = open_compose_new_mail();</span>
<a href="#l53.74"></a><span id="l53.74">   check_element_cycling(cwc, false, false);</span>
<a href="#l53.75"></a><span id="l53.75">   close_compose_window(cwc);</span>
<a href="#l53.76"></a><span id="l53.76" class="difflineminus">-}</span>
<a href="#l53.77"></a><span id="l53.77" class="difflineplus">+});</span>
<a href="#l53.78"></a><span id="l53.78"> </span>
<a href="#l53.79"></a><span id="l53.79" class="difflineminus">-function test_f6_attachment() {</span>
<a href="#l53.80"></a><span id="l53.80" class="difflineplus">+add_task(function test_f6_attachment() {</span>
<a href="#l53.81"></a><span id="l53.81">   let cwc = open_compose_new_mail();</span>
<a href="#l53.82"></a><span id="l53.82">   add_attachments(cwc, &quot;http://www.mozilla.org/&quot;);</span>
<a href="#l53.83"></a><span id="l53.83">   check_element_cycling(cwc, true, false);</span>
<a href="#l53.84"></a><span id="l53.84">   close_compose_window(cwc);</span>
<a href="#l53.85"></a><span id="l53.85" class="difflineminus">-}</span>
<a href="#l53.86"></a><span id="l53.86" class="difflineplus">+});</span>
<a href="#l53.87"></a><span id="l53.87"> </span>
<a href="#l53.88"></a><span id="l53.88" class="difflineminus">-function test_ctrl_tab_no_attachment() {</span>
<a href="#l53.89"></a><span id="l53.89" class="difflineplus">+add_task(function test_ctrl_tab_no_attachment() {</span>
<a href="#l53.90"></a><span id="l53.90">   let cwc = open_compose_new_mail();</span>
<a href="#l53.91"></a><span id="l53.91">   check_element_cycling(cwc, false, true);</span>
<a href="#l53.92"></a><span id="l53.92">   close_compose_window(cwc);</span>
<a href="#l53.93"></a><span id="l53.93" class="difflineminus">-}</span>
<a href="#l53.94"></a><span id="l53.94" class="difflineplus">+});</span>
<a href="#l53.95"></a><span id="l53.95"> </span>
<a href="#l53.96"></a><span id="l53.96" class="difflineminus">-function test_ctrl_tab_attachment() {</span>
<a href="#l53.97"></a><span id="l53.97" class="difflineplus">+add_task(function test_ctrl_tab_attachment() {</span>
<a href="#l53.98"></a><span id="l53.98">   let cwc = open_compose_new_mail();</span>
<a href="#l53.99"></a><span id="l53.99">   add_attachments(cwc, &quot;http://www.mozilla.org/&quot;);</span>
<a href="#l53.100"></a><span id="l53.100">   check_element_cycling(cwc, true, true);</span>
<a href="#l53.101"></a><span id="l53.101">   close_compose_window(cwc);</span>
<a href="#l53.102"></a><span id="l53.102" class="difflineminus">-}</span>
<a href="#l53.103"></a><span id="l53.103" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1">copy from mail/test/mozmill/composition/test-forward-headers.js</span>
<a href="#l54.2"></a><span id="l54.2">copy to mail/test/browser/composition/browser_forwardHeaders.js</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-forward-headers.js</span>
<a href="#l54.4"></a><span id="l54.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_forwardHeaders.js</span>
<a href="#l54.5"></a><span id="l54.5" class="difflineat">@@ -12,18 +12,16 @@</span>
<a href="#l54.6"></a><span id="l54.6"> var {</span>
<a href="#l54.7"></a><span id="l54.7">   assert_previous_text,</span>
<a href="#l54.8"></a><span id="l54.8">   get_compose_body,</span>
<a href="#l54.9"></a><span id="l54.9">   open_compose_with_forward,</span>
<a href="#l54.10"></a><span id="l54.10">   open_compose_with_forward_as_attachments,</span>
<a href="#l54.11"></a><span id="l54.11"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l54.12"></a><span id="l54.12"> var {</span>
<a href="#l54.13"></a><span id="l54.13">   add_sets_to_folders,</span>
<a href="#l54.14"></a><span id="l54.14" class="difflineminus">-  assert_equals,</span>
<a href="#l54.15"></a><span id="l54.15" class="difflineminus">-  assert_true,</span>
<a href="#l54.16"></a><span id="l54.16">   be_in_folder,</span>
<a href="#l54.17"></a><span id="l54.17">   create_folder,</span>
<a href="#l54.18"></a><span id="l54.18">   create_thread,</span>
<a href="#l54.19"></a><span id="l54.19">   get_special_folder,</span>
<a href="#l54.20"></a><span id="l54.20">   mc,</span>
<a href="#l54.21"></a><span id="l54.21">   press_delete,</span>
<a href="#l54.22"></a><span id="l54.22">   select_click_row,</span>
<a href="#l54.23"></a><span id="l54.23">   select_shift_click_row,</span>
<a href="#l54.24"></a><span id="l54.24" class="difflineat">@@ -41,32 +39,32 @@ var {</span>
<a href="#l54.25"></a><span id="l54.25"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;);</span>
<a href="#l54.26"></a><span id="l54.26"> </span>
<a href="#l54.27"></a><span id="l54.27"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l54.28"></a><span id="l54.28"> </span>
<a href="#l54.29"></a><span id="l54.29"> var cwc = null; // compose window controller</span>
<a href="#l54.30"></a><span id="l54.30"> var folder;</span>
<a href="#l54.31"></a><span id="l54.31"> var gDrafts;</span>
<a href="#l54.32"></a><span id="l54.32"> </span>
<a href="#l54.33"></a><span id="l54.33" class="difflineminus">-function setupModule(module) {</span>
<a href="#l54.34"></a><span id="l54.34" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l54.35"></a><span id="l54.35">   folder = create_folder(&quot;Test&quot;);</span>
<a href="#l54.36"></a><span id="l54.36">   let thread1 = create_thread(10);</span>
<a href="#l54.37"></a><span id="l54.37">   add_sets_to_folders([folder], [thread1]);</span>
<a href="#l54.38"></a><span id="l54.38"> </span>
<a href="#l54.39"></a><span id="l54.39">   gDrafts = get_special_folder(Ci.nsMsgFolderFlags.Drafts, true);</span>
<a href="#l54.40"></a><span id="l54.40"> </span>
<a href="#l54.41"></a><span id="l54.41">   // Don't create paragraphs in the test.</span>
<a href="#l54.42"></a><span id="l54.42">   // The test checks for the first DOM node and expects a text and not</span>
<a href="#l54.43"></a><span id="l54.43">   // a paragraph.</span>
<a href="#l54.44"></a><span id="l54.44">   Services.prefs.setBoolPref(&quot;mail.compose.default_to_paragraph&quot;, false);</span>
<a href="#l54.45"></a><span id="l54.45" class="difflineminus">-}</span>
<a href="#l54.46"></a><span id="l54.46" class="difflineplus">+});</span>
<a href="#l54.47"></a><span id="l54.47"> </span>
<a href="#l54.48"></a><span id="l54.48" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l54.49"></a><span id="l54.49" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l54.50"></a><span id="l54.50">   Services.prefs.clearUserPref(&quot;mail.compose.default_to_paragraph&quot;);</span>
<a href="#l54.51"></a><span id="l54.51" class="difflineminus">-}</span>
<a href="#l54.52"></a><span id="l54.52" class="difflineplus">+});</span>
<a href="#l54.53"></a><span id="l54.53"> </span>
<a href="#l54.54"></a><span id="l54.54"> function forward_selected_messages_and_go_to_drafts_folder(f) {</span>
<a href="#l54.55"></a><span id="l54.55">   const kText = &quot;Hey check out this megalol link&quot;;</span>
<a href="#l54.56"></a><span id="l54.56">   // opening a new compose window</span>
<a href="#l54.57"></a><span id="l54.57">   cwc = f(mc);</span>
<a href="#l54.58"></a><span id="l54.58">   cwc.type(cwc.eid(&quot;content-frame&quot;), kText);</span>
<a href="#l54.59"></a><span id="l54.59"> </span>
<a href="#l54.60"></a><span id="l54.60">   let mailBody = get_compose_body(cwc);</span>
<a href="#l54.61"></a><span id="l54.61" class="difflineat">@@ -85,88 +83,88 @@ function forward_selected_messages_and_g</span>
<a href="#l54.62"></a><span id="l54.62">   wait_for_modal_dialog();</span>
<a href="#l54.63"></a><span id="l54.63">   // Actually quit the window.</span>
<a href="#l54.64"></a><span id="l54.64">   wait_for_window_close();</span>
<a href="#l54.65"></a><span id="l54.65"> </span>
<a href="#l54.66"></a><span id="l54.66">   // Visit the existing Drafts folder.</span>
<a href="#l54.67"></a><span id="l54.67">   be_in_folder(gDrafts);</span>
<a href="#l54.68"></a><span id="l54.68"> }</span>
<a href="#l54.69"></a><span id="l54.69"> </span>
<a href="#l54.70"></a><span id="l54.70" class="difflineminus">-function test_forward_inline() {</span>
<a href="#l54.71"></a><span id="l54.71" class="difflineplus">+add_task(function test_forward_inline() {</span>
<a href="#l54.72"></a><span id="l54.72">   be_in_folder(folder);</span>
<a href="#l54.73"></a><span id="l54.73">   // original message header</span>
<a href="#l54.74"></a><span id="l54.74">   let oMsgHdr = select_click_row(0);</span>
<a href="#l54.75"></a><span id="l54.75"> </span>
<a href="#l54.76"></a><span id="l54.76">   forward_selected_messages_and_go_to_drafts_folder(open_compose_with_forward);</span>
<a href="#l54.77"></a><span id="l54.77"> </span>
<a href="#l54.78"></a><span id="l54.78">   // forwarded message header</span>
<a href="#l54.79"></a><span id="l54.79">   let fMsgHdr = select_click_row(0);</span>
<a href="#l54.80"></a><span id="l54.80"> </span>
<a href="#l54.81"></a><span id="l54.81" class="difflineminus">-  assert_true(</span>
<a href="#l54.82"></a><span id="l54.82" class="difflineplus">+  Assert.ok(</span>
<a href="#l54.83"></a><span id="l54.83">     fMsgHdr.numReferences &gt; 0,</span>
<a href="#l54.84"></a><span id="l54.84">     &quot;No References Header in forwarded msg.&quot;</span>
<a href="#l54.85"></a><span id="l54.85">   );</span>
<a href="#l54.86"></a><span id="l54.86" class="difflineminus">-  assert_equals(</span>
<a href="#l54.87"></a><span id="l54.87" class="difflineplus">+  Assert.equal(</span>
<a href="#l54.88"></a><span id="l54.88">     fMsgHdr.getStringReference(0),</span>
<a href="#l54.89"></a><span id="l54.89">     oMsgHdr.messageId,</span>
<a href="#l54.90"></a><span id="l54.90">     &quot;The forwarded message should have References: = Message-Id: of the original msg&quot;</span>
<a href="#l54.91"></a><span id="l54.91">   );</span>
<a href="#l54.92"></a><span id="l54.92"> </span>
<a href="#l54.93"></a><span id="l54.93">   // test for x-forwarded-message id and exercise the js mime representation as</span>
<a href="#l54.94"></a><span id="l54.94">   // well</span>
<a href="#l54.95"></a><span id="l54.95">   to_mime_message(fMsgHdr, null, function(aMsgHdr, aMimeMsg) {</span>
<a href="#l54.96"></a><span id="l54.96" class="difflineminus">-    assert_equals(</span>
<a href="#l54.97"></a><span id="l54.97" class="difflineplus">+    Assert.equal(</span>
<a href="#l54.98"></a><span id="l54.98">       aMimeMsg.headers[&quot;x-forwarded-message-id&quot;],</span>
<a href="#l54.99"></a><span id="l54.99">       &quot;&lt;&quot; + oMsgHdr.messageId + &quot;&gt;&quot;</span>
<a href="#l54.100"></a><span id="l54.100">     );</span>
<a href="#l54.101"></a><span id="l54.101" class="difflineminus">-    assert_equals(aMimeMsg.headers.references, &quot;&lt;&quot; + oMsgHdr.messageId + &quot;&gt;&quot;);</span>
<a href="#l54.102"></a><span id="l54.102" class="difflineplus">+    Assert.equal(aMimeMsg.headers.references, &quot;&lt;&quot; + oMsgHdr.messageId + &quot;&gt;&quot;);</span>
<a href="#l54.103"></a><span id="l54.103">   });</span>
<a href="#l54.104"></a><span id="l54.104">   press_delete(mc);</span>
<a href="#l54.105"></a><span id="l54.105" class="difflineminus">-}</span>
<a href="#l54.106"></a><span id="l54.106" class="difflineplus">+});</span>
<a href="#l54.107"></a><span id="l54.107"> </span>
<a href="#l54.108"></a><span id="l54.108" class="difflineminus">-function test_forward_as_attachments() {</span>
<a href="#l54.109"></a><span id="l54.109" class="difflineplus">+add_task(function test_forward_as_attachments() {</span>
<a href="#l54.110"></a><span id="l54.110">   be_in_folder(folder);</span>
<a href="#l54.111"></a><span id="l54.111">   // original message header</span>
<a href="#l54.112"></a><span id="l54.112">   let oMsgHdr0 = select_click_row(0);</span>
<a href="#l54.113"></a><span id="l54.113">   let oMsgHdr1 = select_click_row(1);</span>
<a href="#l54.114"></a><span id="l54.114">   select_shift_click_row(0);</span>
<a href="#l54.115"></a><span id="l54.115"> </span>
<a href="#l54.116"></a><span id="l54.116">   forward_selected_messages_and_go_to_drafts_folder(</span>
<a href="#l54.117"></a><span id="l54.117">     open_compose_with_forward_as_attachments</span>
<a href="#l54.118"></a><span id="l54.118">   );</span>
<a href="#l54.119"></a><span id="l54.119"> </span>
<a href="#l54.120"></a><span id="l54.120">   // forwarded message header</span>
<a href="#l54.121"></a><span id="l54.121">   let fMsgHdr = select_click_row(0);</span>
<a href="#l54.122"></a><span id="l54.122"> </span>
<a href="#l54.123"></a><span id="l54.123" class="difflineminus">-  assert_true(</span>
<a href="#l54.124"></a><span id="l54.124" class="difflineplus">+  Assert.ok(</span>
<a href="#l54.125"></a><span id="l54.125">     fMsgHdr.numReferences &gt; 0,</span>
<a href="#l54.126"></a><span id="l54.126">     &quot;No References Header in forwarded msg.&quot;</span>
<a href="#l54.127"></a><span id="l54.127">   );</span>
<a href="#l54.128"></a><span id="l54.128" class="difflineminus">-  assert_true(</span>
<a href="#l54.129"></a><span id="l54.129" class="difflineplus">+  Assert.ok(</span>
<a href="#l54.130"></a><span id="l54.130">     fMsgHdr.numReferences &gt; 1,</span>
<a href="#l54.131"></a><span id="l54.131">     &quot;Only one References Header in forwarded msg.&quot;</span>
<a href="#l54.132"></a><span id="l54.132">   );</span>
<a href="#l54.133"></a><span id="l54.133" class="difflineminus">-  assert_equals(</span>
<a href="#l54.134"></a><span id="l54.134" class="difflineplus">+  Assert.equal(</span>
<a href="#l54.135"></a><span id="l54.135">     fMsgHdr.getStringReference(1),</span>
<a href="#l54.136"></a><span id="l54.136">     oMsgHdr1.messageId,</span>
<a href="#l54.137"></a><span id="l54.137">     &quot;The forwarded message should have References: = Message-Id: of the original msg#1&quot;</span>
<a href="#l54.138"></a><span id="l54.138">   );</span>
<a href="#l54.139"></a><span id="l54.139" class="difflineminus">-  assert_equals(</span>
<a href="#l54.140"></a><span id="l54.140" class="difflineplus">+  Assert.equal(</span>
<a href="#l54.141"></a><span id="l54.141">     fMsgHdr.getStringReference(0),</span>
<a href="#l54.142"></a><span id="l54.142">     oMsgHdr0.messageId,</span>
<a href="#l54.143"></a><span id="l54.143">     &quot;The forwarded message should have References: = Message-Id: of the original msg#0&quot;</span>
<a href="#l54.144"></a><span id="l54.144">   );</span>
<a href="#l54.145"></a><span id="l54.145"> </span>
<a href="#l54.146"></a><span id="l54.146">   // test for x-forwarded-message id and exercise the js mime representation as</span>
<a href="#l54.147"></a><span id="l54.147">   // well</span>
<a href="#l54.148"></a><span id="l54.148">   to_mime_message(fMsgHdr, null, function(aMsgHdr, aMimeMsg) {</span>
<a href="#l54.149"></a><span id="l54.149" class="difflineminus">-    assert_equals(</span>
<a href="#l54.150"></a><span id="l54.150" class="difflineplus">+    Assert.equal(</span>
<a href="#l54.151"></a><span id="l54.151">       aMimeMsg.headers[&quot;x-forwarded-message-id&quot;],</span>
<a href="#l54.152"></a><span id="l54.152">       &quot;&lt;&quot; + oMsgHdr0.messageId + &quot;&gt; &lt;&quot; + oMsgHdr1.messageId + &quot;&gt;&quot;</span>
<a href="#l54.153"></a><span id="l54.153">     );</span>
<a href="#l54.154"></a><span id="l54.154" class="difflineminus">-    assert_equals(</span>
<a href="#l54.155"></a><span id="l54.155" class="difflineplus">+    Assert.equal(</span>
<a href="#l54.156"></a><span id="l54.156">       aMimeMsg.headers.references,</span>
<a href="#l54.157"></a><span id="l54.157">       &quot;&lt;&quot; + oMsgHdr0.messageId + &quot;&gt; &lt;&quot; + oMsgHdr1.messageId + &quot;&gt;&quot;</span>
<a href="#l54.158"></a><span id="l54.158">     );</span>
<a href="#l54.159"></a><span id="l54.159">   });</span>
<a href="#l54.160"></a><span id="l54.160"> </span>
<a href="#l54.161"></a><span id="l54.161">   press_delete(mc);</span>
<a href="#l54.162"></a><span id="l54.162" class="difflineminus">-}</span>
<a href="#l54.163"></a><span id="l54.163" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1">copy from mail/test/mozmill/composition/test-forward-rfc822-attach.js</span>
<a href="#l55.2"></a><span id="l55.2">copy to mail/test/browser/composition/browser_forwardRFC822Attach.js</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-forward-rfc822-attach.js</span>
<a href="#l55.4"></a><span id="l55.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_forwardRFC822Attach.js</span>
<a href="#l55.5"></a><span id="l55.5" class="difflineat">@@ -4,25 +4,24 @@</span>
<a href="#l55.6"></a><span id="l55.6"> </span>
<a href="#l55.7"></a><span id="l55.7"> /**</span>
<a href="#l55.8"></a><span id="l55.8">  * Tests that attached messages (message/rfc822) are correctly sent.</span>
<a href="#l55.9"></a><span id="l55.9">  * It's easiest to test the forward case.</span>
<a href="#l55.10"></a><span id="l55.10">  */</span>
<a href="#l55.11"></a><span id="l55.11"> </span>
<a href="#l55.12"></a><span id="l55.12"> &quot;use strict&quot;;</span>
<a href="#l55.13"></a><span id="l55.13"> </span>
<a href="#l55.14"></a><span id="l55.14" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l55.15"></a><span id="l55.15" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l55.16"></a><span id="l55.16"> </span>
<a href="#l55.17"></a><span id="l55.17"> var {</span>
<a href="#l55.18"></a><span id="l55.18">   close_compose_window,</span>
<a href="#l55.19"></a><span id="l55.19">   get_msg_source,</span>
<a href="#l55.20"></a><span id="l55.20">   open_compose_with_forward_as_attachments,</span>
<a href="#l55.21"></a><span id="l55.21"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l55.22"></a><span id="l55.22"> var {</span>
<a href="#l55.23"></a><span id="l55.23" class="difflineminus">-  assert_true,</span>
<a href="#l55.24"></a><span id="l55.24">   be_in_folder,</span>
<a href="#l55.25"></a><span id="l55.25">   get_special_folder,</span>
<a href="#l55.26"></a><span id="l55.26">   mc,</span>
<a href="#l55.27"></a><span id="l55.27">   open_message_from_file,</span>
<a href="#l55.28"></a><span id="l55.28">   press_delete,</span>
<a href="#l55.29"></a><span id="l55.29">   select_click_row,</span>
<a href="#l55.30"></a><span id="l55.30"> } = ChromeUtils.import(</span>
<a href="#l55.31"></a><span id="l55.31">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l55.32"></a><span id="l55.32" class="difflineat">@@ -33,45 +32,44 @@ var { close_window } = ChromeUtils.impor</span>
<a href="#l55.33"></a><span id="l55.33"> </span>
<a href="#l55.34"></a><span id="l55.34"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l55.35"></a><span id="l55.35"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l55.36"></a><span id="l55.36">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l55.37"></a><span id="l55.37"> );</span>
<a href="#l55.38"></a><span id="l55.38"> </span>
<a href="#l55.39"></a><span id="l55.39"> var gDrafts;</span>
<a href="#l55.40"></a><span id="l55.40"> </span>
<a href="#l55.41"></a><span id="l55.41" class="difflineminus">-function setupModule(module) {</span>
<a href="#l55.42"></a><span id="l55.42" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l55.43"></a><span id="l55.43">   gDrafts = get_special_folder(Ci.nsMsgFolderFlags.Drafts, true);</span>
<a href="#l55.44"></a><span id="l55.44" class="difflineminus">-}</span>
<a href="#l55.45"></a><span id="l55.45" class="difflineplus">+});</span>
<a href="#l55.46"></a><span id="l55.46"> </span>
<a href="#l55.47"></a><span id="l55.47"> function forwardDirect(aFilePath, aExpectedText) {</span>
<a href="#l55.48"></a><span id="l55.48" class="difflineminus">-  let file = os.getFileForPath(</span>
<a href="#l55.49"></a><span id="l55.49" class="difflineminus">-    os.abspath(aFilePath, os.getFileForPath(__file__))</span>
<a href="#l55.50"></a><span id="l55.50" class="difflineminus">-  );</span>
<a href="#l55.51"></a><span id="l55.51" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(`data/${aFilePath}`));</span>
<a href="#l55.52"></a><span id="l55.52">   let msgc = open_message_from_file(file);</span>
<a href="#l55.53"></a><span id="l55.53"> </span>
<a href="#l55.54"></a><span id="l55.54">   let cwc = open_compose_with_forward_as_attachments(msgc);</span>
<a href="#l55.55"></a><span id="l55.55"> </span>
<a href="#l55.56"></a><span id="l55.56">   // Ctrl+S saves as draft.</span>
<a href="#l55.57"></a><span id="l55.57">   cwc.keypress(null, &quot;s&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l55.58"></a><span id="l55.58"> </span>
<a href="#l55.59"></a><span id="l55.59">   close_compose_window(cwc);</span>
<a href="#l55.60"></a><span id="l55.60">   close_window(msgc);</span>
<a href="#l55.61"></a><span id="l55.61"> </span>
<a href="#l55.62"></a><span id="l55.62">   be_in_folder(gDrafts);</span>
<a href="#l55.63"></a><span id="l55.63">   let draftMsg = select_click_row(0);</span>
<a href="#l55.64"></a><span id="l55.64"> </span>
<a href="#l55.65"></a><span id="l55.65">   let draftMsgContent = get_msg_source(draftMsg);</span>
<a href="#l55.66"></a><span id="l55.66"> </span>
<a href="#l55.67"></a><span id="l55.67" class="difflineminus">-  if (!draftMsgContent.includes(aExpectedText)) {</span>
<a href="#l55.68"></a><span id="l55.68" class="difflineminus">-    assert_true(false, &quot;Failed to find expected text&quot;);</span>
<a href="#l55.69"></a><span id="l55.69" class="difflineminus">-  }</span>
<a href="#l55.70"></a><span id="l55.70" class="difflineplus">+  Assert.ok(</span>
<a href="#l55.71"></a><span id="l55.71" class="difflineplus">+    draftMsgContent.includes(aExpectedText),</span>
<a href="#l55.72"></a><span id="l55.72" class="difflineplus">+    &quot;Failed to find expected text&quot;</span>
<a href="#l55.73"></a><span id="l55.73" class="difflineplus">+  );</span>
<a href="#l55.74"></a><span id="l55.74"> </span>
<a href="#l55.75"></a><span id="l55.75">   press_delete(mc); // clean up the created draft</span>
<a href="#l55.76"></a><span id="l55.76"> }</span>
<a href="#l55.77"></a><span id="l55.77"> </span>
<a href="#l55.78"></a><span id="l55.78" class="difflineminus">-function test_forwarding_long_html_line_as_attachment() {</span>
<a href="#l55.79"></a><span id="l55.79" class="difflineplus">+add_task(function test_forwarding_long_html_line_as_attachment() {</span>
<a href="#l55.80"></a><span id="l55.80">   forwardDirect(&quot;./long-html-line.eml&quot;, &quot;We like writing long lines.&quot;);</span>
<a href="#l55.81"></a><span id="l55.81" class="difflineminus">-}</span>
<a href="#l55.82"></a><span id="l55.82" class="difflineplus">+});</span>
<a href="#l55.83"></a><span id="l55.83"> </span>
<a href="#l55.84"></a><span id="l55.84" class="difflineminus">-function test_forwarding_feed_message_as_attachment() {</span>
<a href="#l55.85"></a><span id="l55.85" class="difflineplus">+add_task(function test_forwarding_feed_message_as_attachment() {</span>
<a href="#l55.86"></a><span id="l55.86">   forwardDirect(&quot;./feed-message.eml&quot;, &quot;We like using linefeeds only.&quot;);</span>
<a href="#l55.87"></a><span id="l55.87" class="difflineminus">-}</span>
<a href="#l55.88"></a><span id="l55.88" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1">copy from mail/test/mozmill/composition/test-forward-utf8.js</span>
<a href="#l56.2"></a><span id="l56.2">copy to mail/test/browser/composition/browser_forwardUTF8.js</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-forward-utf8.js</span>
<a href="#l56.4"></a><span id="l56.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_forwardUTF8.js</span>
<a href="#l56.5"></a><span id="l56.5" class="difflineat">@@ -4,28 +4,27 @@</span>
<a href="#l56.6"></a><span id="l56.6"> </span>
<a href="#l56.7"></a><span id="l56.7"> /**</span>
<a href="#l56.8"></a><span id="l56.8">  * Tests that UTF-8 messages are correctly forwarded.</span>
<a href="#l56.9"></a><span id="l56.9">  */</span>
<a href="#l56.10"></a><span id="l56.10"> </span>
<a href="#l56.11"></a><span id="l56.11"> &quot;use strict&quot;;</span>
<a href="#l56.12"></a><span id="l56.12"> </span>
<a href="#l56.13"></a><span id="l56.13"> var elib = ChromeUtils.import(</span>
<a href="#l56.14"></a><span id="l56.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l56.15"></a><span id="l56.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l56.16"></a><span id="l56.16"> );</span>
<a href="#l56.17"></a><span id="l56.17" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l56.18"></a><span id="l56.18" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l56.19"></a><span id="l56.19"> </span>
<a href="#l56.20"></a><span id="l56.20"> var {</span>
<a href="#l56.21"></a><span id="l56.21">   close_compose_window,</span>
<a href="#l56.22"></a><span id="l56.22">   get_compose_body,</span>
<a href="#l56.23"></a><span id="l56.23">   open_compose_with_forward,</span>
<a href="#l56.24"></a><span id="l56.24"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l56.25"></a><span id="l56.25"> var {</span>
<a href="#l56.26"></a><span id="l56.26">   assert_selected_and_displayed,</span>
<a href="#l56.27"></a><span id="l56.27" class="difflineminus">-  assert_true,</span>
<a href="#l56.28"></a><span id="l56.28">   be_in_folder,</span>
<a href="#l56.29"></a><span id="l56.29">   create_folder,</span>
<a href="#l56.30"></a><span id="l56.30">   mc,</span>
<a href="#l56.31"></a><span id="l56.31">   open_message_from_file,</span>
<a href="#l56.32"></a><span id="l56.32">   press_delete,</span>
<a href="#l56.33"></a><span id="l56.33">   select_click_row,</span>
<a href="#l56.34"></a><span id="l56.34"> } = ChromeUtils.import(</span>
<a href="#l56.35"></a><span id="l56.35">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l56.36"></a><span id="l56.36" class="difflineat">@@ -36,19 +35,19 @@ var { close_window } = ChromeUtils.impor</span>
<a href="#l56.37"></a><span id="l56.37"> </span>
<a href="#l56.38"></a><span id="l56.38"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l56.39"></a><span id="l56.39"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l56.40"></a><span id="l56.40">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l56.41"></a><span id="l56.41"> );</span>
<a href="#l56.42"></a><span id="l56.42"> </span>
<a href="#l56.43"></a><span id="l56.43"> var folderToSendFrom;</span>
<a href="#l56.44"></a><span id="l56.44"> </span>
<a href="#l56.45"></a><span id="l56.45" class="difflineminus">-function setupModule(module) {</span>
<a href="#l56.46"></a><span id="l56.46" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l56.47"></a><span id="l56.47">   folderToSendFrom = create_folder(&quot;FolderWithUTF8&quot;);</span>
<a href="#l56.48"></a><span id="l56.48" class="difflineminus">-}</span>
<a href="#l56.49"></a><span id="l56.49" class="difflineplus">+});</span>
<a href="#l56.50"></a><span id="l56.50"> </span>
<a href="#l56.51"></a><span id="l56.51"> function check_content(window) {</span>
<a href="#l56.52"></a><span id="l56.52">   let mailBody = get_compose_body(window);</span>
<a href="#l56.53"></a><span id="l56.53"> </span>
<a href="#l56.54"></a><span id="l56.54">   let node = mailBody.firstChild;</span>
<a href="#l56.55"></a><span id="l56.55">   while (node) {</span>
<a href="#l56.56"></a><span id="l56.56">     if (node.classList.contains(&quot;moz-forward-container&quot;)) {</span>
<a href="#l56.57"></a><span id="l56.57">       // We found the forward container. Let's look for our text.</span>
<a href="#l56.58"></a><span id="l56.58" class="difflineat">@@ -56,45 +55,41 @@ function check_content(window) {</span>
<a href="#l56.59"></a><span id="l56.59">       while (node) {</span>
<a href="#l56.60"></a><span id="l56.60">         // We won't find the exact text in the DOM but we'll find our string.</span>
<a href="#l56.61"></a><span id="l56.61">         if (node.nodeName == &quot;#text&quot; &amp;&amp; node.nodeValue.includes(&quot;&quot;)) {</span>
<a href="#l56.62"></a><span id="l56.62">           return;</span>
<a href="#l56.63"></a><span id="l56.63">         }</span>
<a href="#l56.64"></a><span id="l56.64">         node = node.nextSibling;</span>
<a href="#l56.65"></a><span id="l56.65">       }</span>
<a href="#l56.66"></a><span id="l56.66">       // Text not found in the forward container.</span>
<a href="#l56.67"></a><span id="l56.67" class="difflineminus">-      assert_true(false, &quot;Failed to find forwarded text&quot;);</span>
<a href="#l56.68"></a><span id="l56.68" class="difflineplus">+      Assert.ok(false, &quot;Failed to find forwarded text&quot;);</span>
<a href="#l56.69"></a><span id="l56.69">       return;</span>
<a href="#l56.70"></a><span id="l56.70">     }</span>
<a href="#l56.71"></a><span id="l56.71">     node = node.nextSibling;</span>
<a href="#l56.72"></a><span id="l56.72">   }</span>
<a href="#l56.73"></a><span id="l56.73"> </span>
<a href="#l56.74"></a><span id="l56.74" class="difflineminus">-  assert_true(false, &quot;Failed to find forward container&quot;);</span>
<a href="#l56.75"></a><span id="l56.75" class="difflineplus">+  Assert.ok(false, &quot;Failed to find forward container&quot;);</span>
<a href="#l56.76"></a><span id="l56.76"> }</span>
<a href="#l56.77"></a><span id="l56.77"> </span>
<a href="#l56.78"></a><span id="l56.78"> function forwardDirect(aFilePath) {</span>
<a href="#l56.79"></a><span id="l56.79" class="difflineminus">-  let file = os.getFileForPath(</span>
<a href="#l56.80"></a><span id="l56.80" class="difflineminus">-    os.abspath(aFilePath, os.getFileForPath(__file__))</span>
<a href="#l56.81"></a><span id="l56.81" class="difflineminus">-  );</span>
<a href="#l56.82"></a><span id="l56.82" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(`data/${aFilePath}`));</span>
<a href="#l56.83"></a><span id="l56.83">   let msgc = open_message_from_file(file);</span>
<a href="#l56.84"></a><span id="l56.84"> </span>
<a href="#l56.85"></a><span id="l56.85">   let cwc = open_compose_with_forward(msgc);</span>
<a href="#l56.86"></a><span id="l56.86"> </span>
<a href="#l56.87"></a><span id="l56.87">   check_content(cwc);</span>
<a href="#l56.88"></a><span id="l56.88"> </span>
<a href="#l56.89"></a><span id="l56.89">   close_compose_window(cwc);</span>
<a href="#l56.90"></a><span id="l56.90">   close_window(msgc);</span>
<a href="#l56.91"></a><span id="l56.91"> }</span>
<a href="#l56.92"></a><span id="l56.92"> </span>
<a href="#l56.93"></a><span id="l56.93"> function forwardViaFolder(aFilePath) {</span>
<a href="#l56.94"></a><span id="l56.94">   be_in_folder(folderToSendFrom);</span>
<a href="#l56.95"></a><span id="l56.95"> </span>
<a href="#l56.96"></a><span id="l56.96" class="difflineminus">-  let file = os.getFileForPath(</span>
<a href="#l56.97"></a><span id="l56.97" class="difflineminus">-    os.abspath(aFilePath, os.getFileForPath(__file__))</span>
<a href="#l56.98"></a><span id="l56.98" class="difflineminus">-  );</span>
<a href="#l56.99"></a><span id="l56.99" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(`data/${aFilePath}`));</span>
<a href="#l56.100"></a><span id="l56.100">   let msgc = open_message_from_file(file);</span>
<a href="#l56.101"></a><span id="l56.101"> </span>
<a href="#l56.102"></a><span id="l56.102">   // Copy the message to a folder.</span>
<a href="#l56.103"></a><span id="l56.103">   let documentChild = msgc.e(&quot;messagepane&quot;).contentDocument.firstChild;</span>
<a href="#l56.104"></a><span id="l56.104">   msgc.rightClick(new elib.Elem(documentChild));</span>
<a href="#l56.105"></a><span id="l56.105">   msgc.click_menus_in_sequence(msgc.e(&quot;mailContext&quot;), [</span>
<a href="#l56.106"></a><span id="l56.106">     { id: &quot;mailContext-copyMenu&quot; },</span>
<a href="#l56.107"></a><span id="l56.107">     { label: &quot;Local Folders&quot; },</span>
<a href="#l56.108"></a><span id="l56.108" class="difflineat">@@ -109,30 +104,44 @@ function forwardViaFolder(aFilePath) {</span>
<a href="#l56.109"></a><span id="l56.109"> </span>
<a href="#l56.110"></a><span id="l56.110">   check_content(fwdWin);</span>
<a href="#l56.111"></a><span id="l56.111"> </span>
<a href="#l56.112"></a><span id="l56.112">   close_compose_window(fwdWin);</span>
<a href="#l56.113"></a><span id="l56.113"> </span>
<a href="#l56.114"></a><span id="l56.114">   press_delete(mc);</span>
<a href="#l56.115"></a><span id="l56.115"> }</span>
<a href="#l56.116"></a><span id="l56.116"> </span>
<a href="#l56.117"></a><span id="l56.117" class="difflineminus">-function test_utf8_forwarding_from_opened_file() {</span>
<a href="#l56.118"></a><span id="l56.118" class="difflineplus">+add_task(function test_utf8_forwarding_from_opened_file() {</span>
<a href="#l56.119"></a><span id="l56.119">   forwardDirect(&quot;./content-utf8-rel-only.eml&quot;);</span>
<a href="#l56.120"></a><span id="l56.120">   forwardDirect(&quot;./content-utf8-rel-alt.eml&quot;);</span>
<a href="#l56.121"></a><span id="l56.121">   forwardDirect(&quot;./content-utf8-alt-rel.eml&quot;);</span>
<a href="#l56.122"></a><span id="l56.122" class="difflineminus">-}</span>
<a href="#l56.123"></a><span id="l56.123"> </span>
<a href="#l56.124"></a><span id="l56.124" class="difflineminus">-function test_utf8_forwarding_from_via_folder() {</span>
<a href="#l56.125"></a><span id="l56.125" class="difflineplus">+  Assert.report(</span>
<a href="#l56.126"></a><span id="l56.126" class="difflineplus">+    false,</span>
<a href="#l56.127"></a><span id="l56.127" class="difflineplus">+    undefined,</span>
<a href="#l56.128"></a><span id="l56.128" class="difflineplus">+    undefined,</span>
<a href="#l56.129"></a><span id="l56.129" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l56.130"></a><span id="l56.130" class="difflineplus">+  );</span>
<a href="#l56.131"></a><span id="l56.131" class="difflineplus">+});</span>
<a href="#l56.132"></a><span id="l56.132" class="difflineplus">+</span>
<a href="#l56.133"></a><span id="l56.133" class="difflineplus">+add_task(function test_utf8_forwarding_from_via_folder() {</span>
<a href="#l56.134"></a><span id="l56.134">   forwardViaFolder(&quot;./content-utf8-rel-only.eml&quot;);</span>
<a href="#l56.135"></a><span id="l56.135">   forwardViaFolder(&quot;./content-utf8-rel-alt.eml&quot;); // Also tests HTML part without &lt;html&gt; tag.</span>
<a href="#l56.136"></a><span id="l56.136">   forwardViaFolder(&quot;./content-utf8-alt-rel.eml&quot;); // Also tests &lt;html attr&gt;.</span>
<a href="#l56.137"></a><span id="l56.137">   forwardViaFolder(&quot;./content-utf8-alt-rel2.eml&quot;); // Also tests content before &lt;html&gt;.</span>
<a href="#l56.138"></a><span id="l56.138"> </span>
<a href="#l56.139"></a><span id="l56.139">   // Repeat the last three in simple HTML view.</span>
<a href="#l56.140"></a><span id="l56.140">   Services.prefs.setIntPref(&quot;mailnews.display.html_as&quot;, 3);</span>
<a href="#l56.141"></a><span id="l56.141">   forwardViaFolder(&quot;./content-utf8-rel-alt.eml&quot;); // Also tests HTML part without &lt;html&gt; tag.</span>
<a href="#l56.142"></a><span id="l56.142">   forwardViaFolder(&quot;./content-utf8-alt-rel.eml&quot;); // Also tests &lt;html attr&gt;.</span>
<a href="#l56.143"></a><span id="l56.143">   forwardViaFolder(&quot;./content-utf8-alt-rel2.eml&quot;); // Also tests content before &lt;html&gt;.</span>
<a href="#l56.144"></a><span id="l56.144" class="difflineminus">-}</span>
<a href="#l56.145"></a><span id="l56.145"> </span>
<a href="#l56.146"></a><span id="l56.146" class="difflineminus">-function teardownModule() {</span>
<a href="#l56.147"></a><span id="l56.147" class="difflineplus">+  Assert.report(</span>
<a href="#l56.148"></a><span id="l56.148" class="difflineplus">+    false,</span>
<a href="#l56.149"></a><span id="l56.149" class="difflineplus">+    undefined,</span>
<a href="#l56.150"></a><span id="l56.150" class="difflineplus">+    undefined,</span>
<a href="#l56.151"></a><span id="l56.151" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l56.152"></a><span id="l56.152" class="difflineplus">+  );</span>
<a href="#l56.153"></a><span id="l56.153" class="difflineplus">+});</span>
<a href="#l56.154"></a><span id="l56.154" class="difflineplus">+</span>
<a href="#l56.155"></a><span id="l56.155" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l56.156"></a><span id="l56.156">   Services.prefs.clearUserPref(&quot;mailnews.display.html_as&quot;);</span>
<a href="#l56.157"></a><span id="l56.157" class="difflineminus">-}</span>
<a href="#l56.158"></a><span id="l56.158" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1">copy from mail/test/mozmill/composition/test-forwarded-content.js</span>
<a href="#l57.2"></a><span id="l57.2">copy to mail/test/browser/composition/browser_forwardedContent.js</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-forwarded-content.js</span>
<a href="#l57.4"></a><span id="l57.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_forwardedContent.js</span>
<a href="#l57.5"></a><span id="l57.5" class="difflineat">@@ -20,32 +20,32 @@ var {</span>
<a href="#l57.6"></a><span id="l57.6">   mc,</span>
<a href="#l57.7"></a><span id="l57.7">   select_click_row,</span>
<a href="#l57.8"></a><span id="l57.8"> } = ChromeUtils.import(</span>
<a href="#l57.9"></a><span id="l57.9">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l57.10"></a><span id="l57.10"> );</span>
<a href="#l57.11"></a><span id="l57.11"> </span>
<a href="#l57.12"></a><span id="l57.12"> var folder = null;</span>
<a href="#l57.13"></a><span id="l57.13"> </span>
<a href="#l57.14"></a><span id="l57.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l57.15"></a><span id="l57.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l57.16"></a><span id="l57.16">   folder = create_folder(&quot;Forward Content Testing&quot;);</span>
<a href="#l57.17"></a><span id="l57.17">   add_message_to_folder(</span>
<a href="#l57.18"></a><span id="l57.18">     folder,</span>
<a href="#l57.19"></a><span id="l57.19">     create_message({</span>
<a href="#l57.20"></a><span id="l57.20">       subject: &quot;something like &lt;foo@example&gt;&quot;,</span>
<a href="#l57.21"></a><span id="l57.21">       body: { body: &quot;Testing bug 397021!&quot; },</span>
<a href="#l57.22"></a><span id="l57.22">     })</span>
<a href="#l57.23"></a><span id="l57.23">   );</span>
<a href="#l57.24"></a><span id="l57.24" class="difflineminus">-}</span>
<a href="#l57.25"></a><span id="l57.25" class="difflineplus">+});</span>
<a href="#l57.26"></a><span id="l57.26"> </span>
<a href="#l57.27"></a><span id="l57.27"> /**</span>
<a href="#l57.28"></a><span id="l57.28">  * Test that the subject is set properly in the forwarded message content</span>
<a href="#l57.29"></a><span id="l57.29">  * when you hit forward.</span>
<a href="#l57.30"></a><span id="l57.30">  */</span>
<a href="#l57.31"></a><span id="l57.31" class="difflineminus">-function test_forwarded_subj() {</span>
<a href="#l57.32"></a><span id="l57.32" class="difflineplus">+add_task(function test_forwarded_subj() {</span>
<a href="#l57.33"></a><span id="l57.33">   be_in_folder(folder);</span>
<a href="#l57.34"></a><span id="l57.34"> </span>
<a href="#l57.35"></a><span id="l57.35">   let msg = select_click_row(0);</span>
<a href="#l57.36"></a><span id="l57.36">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l57.37"></a><span id="l57.37"> </span>
<a href="#l57.38"></a><span id="l57.38">   let fwdWin = open_compose_with_forward();</span>
<a href="#l57.39"></a><span id="l57.39"> </span>
<a href="#l57.40"></a><span id="l57.40">   let headerTableText = fwdWin</span>
<a href="#l57.41"></a><span id="l57.41" class="difflineat">@@ -55,9 +55,16 @@ function test_forwarded_subj() {</span>
<a href="#l57.42"></a><span id="l57.42">     throw new Error(</span>
<a href="#l57.43"></a><span id="l57.43">       &quot;Subject not set correctly in header table: subject=&quot; +</span>
<a href="#l57.44"></a><span id="l57.44">         msg.mime2DecodedSubject +</span>
<a href="#l57.45"></a><span id="l57.45">         &quot;, header table text=&quot; +</span>
<a href="#l57.46"></a><span id="l57.46">         headerTableText</span>
<a href="#l57.47"></a><span id="l57.47">     );</span>
<a href="#l57.48"></a><span id="l57.48">   }</span>
<a href="#l57.49"></a><span id="l57.49">   close_compose_window(fwdWin);</span>
<a href="#l57.50"></a><span id="l57.50" class="difflineminus">-}</span>
<a href="#l57.51"></a><span id="l57.51" class="difflineplus">+</span>
<a href="#l57.52"></a><span id="l57.52" class="difflineplus">+  Assert.report(</span>
<a href="#l57.53"></a><span id="l57.53" class="difflineplus">+    false,</span>
<a href="#l57.54"></a><span id="l57.54" class="difflineplus">+    undefined,</span>
<a href="#l57.55"></a><span id="l57.55" class="difflineplus">+    undefined,</span>
<a href="#l57.56"></a><span id="l57.56" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l57.57"></a><span id="l57.57" class="difflineplus">+  );</span>
<a href="#l57.58"></a><span id="l57.58" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1">copy from mail/test/mozmill/composition/test-forwarded-eml-actions.js</span>
<a href="#l58.2"></a><span id="l58.2">copy to mail/test/browser/composition/browser_forwardedEmlActions.js</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-forwarded-eml-actions.js</span>
<a href="#l58.4"></a><span id="l58.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_forwardedEmlActions.js</span>
<a href="#l58.5"></a><span id="l58.5" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l58.6"></a><span id="l58.6"> /**</span>
<a href="#l58.7"></a><span id="l58.7">  * Tests that actions such as replying and forwarding works correctly from</span>
<a href="#l58.8"></a><span id="l58.8">  * an .eml message that's attached to another mail.</span>
<a href="#l58.9"></a><span id="l58.9">  */</span>
<a href="#l58.10"></a><span id="l58.10"> </span>
<a href="#l58.11"></a><span id="l58.11"> &quot;use strict&quot;;</span>
<a href="#l58.12"></a><span id="l58.12"> </span>
<a href="#l58.13"></a><span id="l58.13"> var elib = ChromeUtils.import(</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l58.15"></a><span id="l58.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l58.16"></a><span id="l58.16"> );</span>
<a href="#l58.17"></a><span id="l58.17"> </span>
<a href="#l58.18"></a><span id="l58.18"> var {</span>
<a href="#l58.19"></a><span id="l58.19">   close_compose_window,</span>
<a href="#l58.20"></a><span id="l58.20">   get_compose_body,</span>
<a href="#l58.21"></a><span id="l58.21">   wait_for_compose_window,</span>
<a href="#l58.22"></a><span id="l58.22"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l58.23"></a><span id="l58.23"> var {</span>
<a href="#l58.24"></a><span id="l58.24" class="difflineat">@@ -39,17 +39,17 @@ var { MailServices } = ChromeUtils.impor</span>
<a href="#l58.25"></a><span id="l58.25"> );</span>
<a href="#l58.26"></a><span id="l58.26"> </span>
<a href="#l58.27"></a><span id="l58.27"> var folder;</span>
<a href="#l58.28"></a><span id="l58.28"> </span>
<a href="#l58.29"></a><span id="l58.29"> var msgsubject = &quot;mail client suggestions&quot;;</span>
<a href="#l58.30"></a><span id="l58.30"> var msgbodyA = &quot;know of a good email client?&quot;;</span>
<a href="#l58.31"></a><span id="l58.31"> var msgbodyB = &quot;hi, i think you may know of an email client to recommend?&quot;;</span>
<a href="#l58.32"></a><span id="l58.32"> </span>
<a href="#l58.33"></a><span id="l58.33" class="difflineminus">-var setupModule = function(module) {</span>
<a href="#l58.34"></a><span id="l58.34" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l58.35"></a><span id="l58.35">   folder = create_folder(&quot;FwdedEmlTest&quot;);</span>
<a href="#l58.36"></a><span id="l58.36"> </span>
<a href="#l58.37"></a><span id="l58.37">   let source =</span>
<a href="#l58.38"></a><span id="l58.38">     &quot;From - Mon Apr  16 22:55:33 2012\n&quot; +</span>
<a href="#l58.39"></a><span id="l58.39">     &quot;Date: Mon, 16 Apr 2012 22:55:33 +0300\n&quot; +</span>
<a href="#l58.40"></a><span id="l58.40">     &quot;From: Mr Example &lt;example@invalid&gt;\n&quot; +</span>
<a href="#l58.41"></a><span id="l58.41">     &quot;User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:14.0) Gecko/20120331 Thunderbird/14.0a1\n&quot; +</span>
<a href="#l58.42"></a><span id="l58.42">     &quot;MIME-Version: 1.0\n&quot; +</span>
<a href="#l58.43"></a><span id="l58.43" class="difflineat">@@ -94,17 +94,17 @@ var setupModule = function(module) {</span>
<a href="#l58.44"></a><span id="l58.44">     &quot;\n&quot; +</span>
<a href="#l58.45"></a><span id="l58.45">     msgbodyA +</span>
<a href="#l58.46"></a><span id="l58.46">     &quot;\n&quot; +</span>
<a href="#l58.47"></a><span id="l58.47">     &quot;\n&quot; +</span>
<a href="#l58.48"></a><span id="l58.48">     &quot;--------------080806020206040800000503--\n&quot;;</span>
<a href="#l58.49"></a><span id="l58.49"> </span>
<a href="#l58.50"></a><span id="l58.50">   folder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l58.51"></a><span id="l58.51">   folder.addMessage(source);</span>
<a href="#l58.52"></a><span id="l58.52" class="difflineminus">-};</span>
<a href="#l58.53"></a><span id="l58.53" class="difflineplus">+});</span>
<a href="#l58.54"></a><span id="l58.54"> </span>
<a href="#l58.55"></a><span id="l58.55"> /**</span>
<a href="#l58.56"></a><span id="l58.56">  * Helper to open an attached .eml file, invoke the hotkey and check some</span>
<a href="#l58.57"></a><span id="l58.57">  * properties of the composition content we get.</span>
<a href="#l58.58"></a><span id="l58.58">  */</span>
<a href="#l58.59"></a><span id="l58.59"> function setupWindowAndTest(hotkeyToHit, hotkeyModifiers) {</span>
<a href="#l58.60"></a><span id="l58.60">   be_in_folder(folder);</span>
<a href="#l58.61"></a><span id="l58.61"> </span>
<a href="#l58.62"></a><span id="l58.62" class="difflineat">@@ -147,18 +147,25 @@ function setupWindowAndTest(hotkeyToHit,</span>
<a href="#l58.63"></a><span id="l58.63"> </span>
<a href="#l58.64"></a><span id="l58.64">   close_compose_window(compWin, false);</span>
<a href="#l58.65"></a><span id="l58.65">   close_window(msgWin);</span>
<a href="#l58.66"></a><span id="l58.66"> }</span>
<a href="#l58.67"></a><span id="l58.67"> </span>
<a href="#l58.68"></a><span id="l58.68"> /**</span>
<a href="#l58.69"></a><span id="l58.69">  * Test that replying to an attached .eml contains the expected texts.</span>
<a href="#l58.70"></a><span id="l58.70">  */</span>
<a href="#l58.71"></a><span id="l58.71" class="difflineminus">-function test_reply_to_attached_eml() {</span>
<a href="#l58.72"></a><span id="l58.72" class="difflineplus">+add_task(function test_reply_to_attached_eml() {</span>
<a href="#l58.73"></a><span id="l58.73">   setupWindowAndTest(&quot;R&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l58.74"></a><span id="l58.74" class="difflineminus">-}</span>
<a href="#l58.75"></a><span id="l58.75" class="difflineplus">+});</span>
<a href="#l58.76"></a><span id="l58.76"> </span>
<a href="#l58.77"></a><span id="l58.77"> /**</span>
<a href="#l58.78"></a><span id="l58.78">  * Test that forwarding an attached .eml contains the expected texts.</span>
<a href="#l58.79"></a><span id="l58.79">  */</span>
<a href="#l58.80"></a><span id="l58.80" class="difflineminus">-function test_forward_attached_eml() {</span>
<a href="#l58.81"></a><span id="l58.81" class="difflineplus">+add_task(function test_forward_attached_eml() {</span>
<a href="#l58.82"></a><span id="l58.82">   setupWindowAndTest(&quot;L&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l58.83"></a><span id="l58.83" class="difflineminus">-}</span>
<a href="#l58.84"></a><span id="l58.84" class="difflineplus">+</span>
<a href="#l58.85"></a><span id="l58.85" class="difflineplus">+  Assert.report(</span>
<a href="#l58.86"></a><span id="l58.86" class="difflineplus">+    false,</span>
<a href="#l58.87"></a><span id="l58.87" class="difflineplus">+    undefined,</span>
<a href="#l58.88"></a><span id="l58.88" class="difflineplus">+    undefined,</span>
<a href="#l58.89"></a><span id="l58.89" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l58.90"></a><span id="l58.90" class="difflineplus">+  );</span>
<a href="#l58.91"></a><span id="l58.91" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1">copy from mail/test/mozmill/composition/test-image-display.js</span>
<a href="#l59.2"></a><span id="l59.2">copy to mail/test/browser/composition/browser_imageDisplay.js</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-image-display.js</span>
<a href="#l59.4"></a><span id="l59.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_imageDisplay.js</span>
<a href="#l59.5"></a><span id="l59.5" class="difflineat">@@ -3,106 +3,100 @@</span>
<a href="#l59.6"></a><span id="l59.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l59.7"></a><span id="l59.7"> </span>
<a href="#l59.8"></a><span id="l59.8"> /**</span>
<a href="#l59.9"></a><span id="l59.9">  * Tests that we load and display embedded images in messages.</span>
<a href="#l59.10"></a><span id="l59.10">  */</span>
<a href="#l59.11"></a><span id="l59.11"> </span>
<a href="#l59.12"></a><span id="l59.12"> &quot;use strict&quot;;</span>
<a href="#l59.13"></a><span id="l59.13"> </span>
<a href="#l59.14"></a><span id="l59.14" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l59.16"></a><span id="l59.16"> var elib = ChromeUtils.import(</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l59.19"></a><span id="l59.19"> );</span>
<a href="#l59.20"></a><span id="l59.20"> </span>
<a href="#l59.21"></a><span id="l59.21"> var {</span>
<a href="#l59.22"></a><span id="l59.22">   close_compose_window,</span>
<a href="#l59.23"></a><span id="l59.23">   open_compose_with_forward,</span>
<a href="#l59.24"></a><span id="l59.24">   open_compose_with_reply,</span>
<a href="#l59.25"></a><span id="l59.25"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l59.26"></a><span id="l59.26"> var {</span>
<a href="#l59.27"></a><span id="l59.27" class="difflineminus">-  assert_false,</span>
<a href="#l59.28"></a><span id="l59.28" class="difflineminus">-  assert_not_equals,</span>
<a href="#l59.29"></a><span id="l59.29">   assert_selected_and_displayed,</span>
<a href="#l59.30"></a><span id="l59.30" class="difflineminus">-  assert_true,</span>
<a href="#l59.31"></a><span id="l59.31">   be_in_folder,</span>
<a href="#l59.32"></a><span id="l59.32">   create_folder,</span>
<a href="#l59.33"></a><span id="l59.33">   mc,</span>
<a href="#l59.34"></a><span id="l59.34">   open_message_from_file,</span>
<a href="#l59.35"></a><span id="l59.35">   select_click_row,</span>
<a href="#l59.36"></a><span id="l59.36"> } = ChromeUtils.import(</span>
<a href="#l59.37"></a><span id="l59.37">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l59.38"></a><span id="l59.38"> );</span>
<a href="#l59.39"></a><span id="l59.39"> var { close_window } = ChromeUtils.import(</span>
<a href="#l59.40"></a><span id="l59.40">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l59.41"></a><span id="l59.41"> );</span>
<a href="#l59.42"></a><span id="l59.42"> </span>
<a href="#l59.43"></a><span id="l59.43"> var { IOUtils } = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l59.44"></a><span id="l59.44"> </span>
<a href="#l59.45"></a><span id="l59.45"> var gImageFolder;</span>
<a href="#l59.46"></a><span id="l59.46"> </span>
<a href="#l59.47"></a><span id="l59.47" class="difflineminus">-function setupModule(module) {</span>
<a href="#l59.48"></a><span id="l59.48" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l59.49"></a><span id="l59.49">   gImageFolder = create_folder(&quot;ImageFolder&quot;);</span>
<a href="#l59.50"></a><span id="l59.50" class="difflineminus">-}</span>
<a href="#l59.51"></a><span id="l59.51" class="difflineplus">+});</span>
<a href="#l59.52"></a><span id="l59.52"> </span>
<a href="#l59.53"></a><span id="l59.53"> /**</span>
<a href="#l59.54"></a><span id="l59.54">  * Check dimensions of the embedded image and whether it could be loaded.</span>
<a href="#l59.55"></a><span id="l59.55">  */</span>
<a href="#l59.56"></a><span id="l59.56"> function check_image_size(aController, aImage, aSrcStart) {</span>
<a href="#l59.57"></a><span id="l59.57" class="difflineminus">-  assert_not_equals(null, aImage);</span>
<a href="#l59.58"></a><span id="l59.58" class="difflineplus">+  Assert.notEqual(null, aImage);</span>
<a href="#l59.59"></a><span id="l59.59">   aController.waitFor(() =&gt; aImage.complete);</span>
<a href="#l59.60"></a><span id="l59.60">   // There should not be a cid: URL now.</span>
<a href="#l59.61"></a><span id="l59.61" class="difflineminus">-  assert_false(aImage.src.startsWith(&quot;cid:&quot;));</span>
<a href="#l59.62"></a><span id="l59.62" class="difflineplus">+  Assert.ok(!aImage.src.startsWith(&quot;cid:&quot;));</span>
<a href="#l59.63"></a><span id="l59.63">   if (aSrcStart) {</span>
<a href="#l59.64"></a><span id="l59.64" class="difflineminus">-    assert_true(aImage.src.startsWith(aSrcStart));</span>
<a href="#l59.65"></a><span id="l59.65" class="difflineplus">+    Assert.ok(aImage.src.startsWith(aSrcStart));</span>
<a href="#l59.66"></a><span id="l59.66">   }</span>
<a href="#l59.67"></a><span id="l59.67"> </span>
<a href="#l59.68"></a><span id="l59.68">   // Check if there are height and width attributes forcing the image to a size.</span>
<a href="#l59.69"></a><span id="l59.69">   let id = aImage.id;</span>
<a href="#l59.70"></a><span id="l59.70" class="difflineminus">-  assert_true(</span>
<a href="#l59.71"></a><span id="l59.71" class="difflineplus">+  Assert.ok(</span>
<a href="#l59.72"></a><span id="l59.72">     aImage.hasAttribute(&quot;height&quot;),</span>
<a href="#l59.73"></a><span id="l59.73">     &quot;Image &quot; + id + &quot; is missing a required attribute&quot;</span>
<a href="#l59.74"></a><span id="l59.74">   );</span>
<a href="#l59.75"></a><span id="l59.75" class="difflineminus">-  assert_true(</span>
<a href="#l59.76"></a><span id="l59.76" class="difflineplus">+  Assert.ok(</span>
<a href="#l59.77"></a><span id="l59.77">     aImage.hasAttribute(&quot;width&quot;),</span>
<a href="#l59.78"></a><span id="l59.78">     &quot;Image &quot; + id + &quot; is missing a required attribute&quot;</span>
<a href="#l59.79"></a><span id="l59.79">   );</span>
<a href="#l59.80"></a><span id="l59.80"> </span>
<a href="#l59.81"></a><span id="l59.81" class="difflineminus">-  assert_true(</span>
<a href="#l59.82"></a><span id="l59.82" class="difflineplus">+  Assert.ok(</span>
<a href="#l59.83"></a><span id="l59.83">     aImage.height &gt; 0,</span>
<a href="#l59.84"></a><span id="l59.84">     &quot;Image &quot; + id + &quot; is missing a required attribute&quot;</span>
<a href="#l59.85"></a><span id="l59.85">   );</span>
<a href="#l59.86"></a><span id="l59.86" class="difflineminus">-  assert_true(</span>
<a href="#l59.87"></a><span id="l59.87" class="difflineplus">+  Assert.ok(</span>
<a href="#l59.88"></a><span id="l59.88">     aImage.width &gt; 0,</span>
<a href="#l59.89"></a><span id="l59.89">     &quot;Image &quot; + id + &quot; is missing a required attribute&quot;</span>
<a href="#l59.90"></a><span id="l59.90">   );</span>
<a href="#l59.91"></a><span id="l59.91"> </span>
<a href="#l59.92"></a><span id="l59.92">   // If the image couldn't be loaded, the naturalWidth and Height are zero.</span>
<a href="#l59.93"></a><span id="l59.93" class="difflineminus">-  assert_true(</span>
<a href="#l59.94"></a><span id="l59.94" class="difflineplus">+  Assert.ok(</span>
<a href="#l59.95"></a><span id="l59.95">     aImage.naturalHeight &gt; 0,</span>
<a href="#l59.96"></a><span id="l59.96">     &quot;Loaded image &quot; + id + &quot; is of zero size&quot;</span>
<a href="#l59.97"></a><span id="l59.97">   );</span>
<a href="#l59.98"></a><span id="l59.98" class="difflineminus">-  assert_true(</span>
<a href="#l59.99"></a><span id="l59.99" class="difflineminus">-    aImage.naturalWidth &gt; 0,</span>
<a href="#l59.100"></a><span id="l59.100" class="difflineminus">-    &quot;Loaded image &quot; + id + &quot; is of zero size&quot;</span>
<a href="#l59.101"></a><span id="l59.101" class="difflineminus">-  );</span>
<a href="#l59.102"></a><span id="l59.102" class="difflineplus">+  Assert.ok(aImage.naturalWidth &gt; 0, &quot;Loaded image &quot; + id + &quot; is of zero size&quot;);</span>
<a href="#l59.103"></a><span id="l59.103"> }</span>
<a href="#l59.104"></a><span id="l59.104"> </span>
<a href="#l59.105"></a><span id="l59.105"> /**</span>
<a href="#l59.106"></a><span id="l59.106">  * Bug 1352701 and bug 1360443</span>
<a href="#l59.107"></a><span id="l59.107">  * Test that showing an image with cid: URL in a HTML message from file will work.</span>
<a href="#l59.108"></a><span id="l59.108">  */</span>
<a href="#l59.109"></a><span id="l59.109" class="difflineminus">-function test_cid_image_load() {</span>
<a href="#l59.110"></a><span id="l59.110" class="difflineminus">-  let file = os.getFileForPath(</span>
<a href="#l59.111"></a><span id="l59.111" class="difflineminus">-    os.abspath(&quot;./content-utf8-rel-only.eml&quot;, os.getFileForPath(__file__))</span>
<a href="#l59.112"></a><span id="l59.112" class="difflineplus">+add_task(function test_cid_image_load() {</span>
<a href="#l59.113"></a><span id="l59.113" class="difflineplus">+  let file = new FileUtils.File(</span>
<a href="#l59.114"></a><span id="l59.114" class="difflineplus">+    getTestFilePath(&quot;data/content-utf8-rel-only.eml&quot;)</span>
<a href="#l59.115"></a><span id="l59.115">   );</span>
<a href="#l59.116"></a><span id="l59.116"> </span>
<a href="#l59.117"></a><span id="l59.117">   // Make sure there is a cid: referenced image in the message.</span>
<a href="#l59.118"></a><span id="l59.118">   let msgSource = IOUtils.loadFileToString(file);</span>
<a href="#l59.119"></a><span id="l59.119" class="difflineminus">-  assert_true(msgSource.includes('&lt;img src=&quot;cid:'));</span>
<a href="#l59.120"></a><span id="l59.120" class="difflineplus">+  Assert.ok(msgSource.includes('&lt;img src=&quot;cid:'));</span>
<a href="#l59.121"></a><span id="l59.121"> </span>
<a href="#l59.122"></a><span id="l59.122">   // Our image should be in the loaded eml document.</span>
<a href="#l59.123"></a><span id="l59.123">   let msgc = open_message_from_file(file);</span>
<a href="#l59.124"></a><span id="l59.124">   let messageDoc = msgc.e(&quot;messagepane&quot;).contentDocument;</span>
<a href="#l59.125"></a><span id="l59.125">   let image = messageDoc.getElementById(&quot;cidImage&quot;);</span>
<a href="#l59.126"></a><span id="l59.126">   check_image_size(msgc, image, &quot;mailbox://&quot;);</span>
<a href="#l59.127"></a><span id="l59.127">   image = messageDoc.getElementById(&quot;cidImageOrigin&quot;);</span>
<a href="#l59.128"></a><span id="l59.128">   check_image_size(msgc, image, &quot;mailbox://&quot;);</span>
<a href="#l59.129"></a><span id="l59.129" class="difflineat">@@ -111,51 +105,51 @@ function test_cid_image_load() {</span>
<a href="#l59.130"></a><span id="l59.130">   let documentChild = messageDoc.firstElementChild;</span>
<a href="#l59.131"></a><span id="l59.131">   msgc.rightClick(new elib.Elem(documentChild));</span>
<a href="#l59.132"></a><span id="l59.132">   msgc.click_menus_in_sequence(msgc.e(&quot;mailContext&quot;), [</span>
<a href="#l59.133"></a><span id="l59.133">     { id: &quot;mailContext-copyMenu&quot; },</span>
<a href="#l59.134"></a><span id="l59.134">     { label: &quot;Local Folders&quot; },</span>
<a href="#l59.135"></a><span id="l59.135">     { label: gImageFolder.prettyName },</span>
<a href="#l59.136"></a><span id="l59.136">   ]);</span>
<a href="#l59.137"></a><span id="l59.137">   close_window(msgc);</span>
<a href="#l59.138"></a><span id="l59.138" class="difflineminus">-}</span>
<a href="#l59.139"></a><span id="l59.139" class="difflineplus">+});</span>
<a href="#l59.140"></a><span id="l59.140"> </span>
<a href="#l59.141"></a><span id="l59.141"> /**</span>
<a href="#l59.142"></a><span id="l59.142">  * Bug 1352701 and bug 1360443</span>
<a href="#l59.143"></a><span id="l59.143">  * Test that showing an image with cid: URL in a HTML message in a folder with work.</span>
<a href="#l59.144"></a><span id="l59.144">  */</span>
<a href="#l59.145"></a><span id="l59.145" class="difflineminus">-function test_cid_image_view() {</span>
<a href="#l59.146"></a><span id="l59.146" class="difflineplus">+add_task(function test_cid_image_view() {</span>
<a href="#l59.147"></a><span id="l59.147">   // Preview the message in the folder.</span>
<a href="#l59.148"></a><span id="l59.148">   be_in_folder(gImageFolder);</span>
<a href="#l59.149"></a><span id="l59.149">   let msg = select_click_row(0);</span>
<a href="#l59.150"></a><span id="l59.150">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l59.151"></a><span id="l59.151"> </span>
<a href="#l59.152"></a><span id="l59.152">   // Check image in the preview.</span>
<a href="#l59.153"></a><span id="l59.153">   let messageDoc = mc.e(&quot;messagepane&quot;).contentDocument;</span>
<a href="#l59.154"></a><span id="l59.154">   let image = messageDoc.getElementById(&quot;cidImage&quot;);</span>
<a href="#l59.155"></a><span id="l59.155">   check_image_size(mc, image, gImageFolder.server.localStoreType + &quot;://&quot;);</span>
<a href="#l59.156"></a><span id="l59.156">   image = messageDoc.getElementById(&quot;cidImageOrigin&quot;);</span>
<a href="#l59.157"></a><span id="l59.157">   check_image_size(mc, image, gImageFolder.server.localStoreType + &quot;://&quot;);</span>
<a href="#l59.158"></a><span id="l59.158" class="difflineminus">-}</span>
<a href="#l59.159"></a><span id="l59.159" class="difflineplus">+});</span>
<a href="#l59.160"></a><span id="l59.160"> </span>
<a href="#l59.161"></a><span id="l59.161"> /**</span>
<a href="#l59.162"></a><span id="l59.162">  * Bug 1352701 and bug 1360443</span>
<a href="#l59.163"></a><span id="l59.163">  * Test that showing an image with cid: URL in a HTML message will work</span>
<a href="#l59.164"></a><span id="l59.164">  * in a composition.</span>
<a href="#l59.165"></a><span id="l59.165">  */</span>
<a href="#l59.166"></a><span id="l59.166" class="difflineminus">-function test_cid_image_compose() {</span>
<a href="#l59.167"></a><span id="l59.167" class="difflineplus">+add_task(function test_cid_image_compose() {</span>
<a href="#l59.168"></a><span id="l59.168">   // Our image should also be in composition when the message is forwarded/replied.</span>
<a href="#l59.169"></a><span id="l59.169">   for (let msgOperation of [</span>
<a href="#l59.170"></a><span id="l59.170">     open_compose_with_forward,</span>
<a href="#l59.171"></a><span id="l59.171">     open_compose_with_reply,</span>
<a href="#l59.172"></a><span id="l59.172">   ]) {</span>
<a href="#l59.173"></a><span id="l59.173">     let cwc = msgOperation();</span>
<a href="#l59.174"></a><span id="l59.174">     let image = cwc</span>
<a href="#l59.175"></a><span id="l59.175">       .e(&quot;content-frame&quot;)</span>
<a href="#l59.176"></a><span id="l59.176">       .contentDocument.getElementById(&quot;cidImage&quot;);</span>
<a href="#l59.177"></a><span id="l59.177">     check_image_size(cwc, image, &quot;data:&quot;);</span>
<a href="#l59.178"></a><span id="l59.178">     image = cwc</span>
<a href="#l59.179"></a><span id="l59.179">       .e(&quot;content-frame&quot;)</span>
<a href="#l59.180"></a><span id="l59.180">       .contentDocument.getElementById(&quot;cidImageOrigin&quot;);</span>
<a href="#l59.181"></a><span id="l59.181">     check_image_size(cwc, image, &quot;data:&quot;);</span>
<a href="#l59.182"></a><span id="l59.182">     close_compose_window(cwc);</span>
<a href="#l59.183"></a><span id="l59.183">   }</span>
<a href="#l59.184"></a><span id="l59.184" class="difflineminus">-}</span>
<a href="#l59.185"></a><span id="l59.185" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1">copy from mail/test/mozmill/composition/test-image-insertion-dialog.js</span>
<a href="#l60.2"></a><span id="l60.2">copy to mail/test/browser/composition/browser_imageInsertionDialog.js</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-image-insertion-dialog.js</span>
<a href="#l60.4"></a><span id="l60.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_imageInsertionDialog.js</span>
<a href="#l60.5"></a><span id="l60.5" class="difflineat">@@ -4,33 +4,30 @@</span>
<a href="#l60.6"></a><span id="l60.6"> </span>
<a href="#l60.7"></a><span id="l60.7"> /**</span>
<a href="#l60.8"></a><span id="l60.8">  * Tests the image insertion dialog functionality.</span>
<a href="#l60.9"></a><span id="l60.9">  */</span>
<a href="#l60.10"></a><span id="l60.10"> </span>
<a href="#l60.11"></a><span id="l60.11"> &quot;use strict&quot;;</span>
<a href="#l60.12"></a><span id="l60.12"> </span>
<a href="#l60.13"></a><span id="l60.13"> var elib = ChromeUtils.import(</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l60.15"></a><span id="l60.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l60.16"></a><span id="l60.16"> );</span>
<a href="#l60.17"></a><span id="l60.17"> </span>
<a href="#l60.18"></a><span id="l60.18"> var { close_compose_window, open_compose_new_mail } = ChromeUtils.import(</span>
<a href="#l60.19"></a><span id="l60.19">   &quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;</span>
<a href="#l60.20"></a><span id="l60.20"> );</span>
<a href="#l60.21"></a><span id="l60.21" class="difflineminus">-var { assert_true } = ChromeUtils.import(</span>
<a href="#l60.22"></a><span id="l60.22" class="difflineminus">-  &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l60.23"></a><span id="l60.23" class="difflineminus">-);</span>
<a href="#l60.24"></a><span id="l60.24"> var { input_value } = ChromeUtils.import(</span>
<a href="#l60.25"></a><span id="l60.25">   &quot;resource://testing-common/mozmill/KeyboardHelpers.jsm&quot;</span>
<a href="#l60.26"></a><span id="l60.26"> );</span>
<a href="#l60.27"></a><span id="l60.27"> var wh = ChromeUtils.import(</span>
<a href="#l60.28"></a><span id="l60.28">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l60.29"></a><span id="l60.29"> );</span>
<a href="#l60.30"></a><span id="l60.30"> </span>
<a href="#l60.31"></a><span id="l60.31" class="difflineminus">-function test_image_insertion_dialog_persist() {</span>
<a href="#l60.32"></a><span id="l60.32" class="difflineplus">+add_task(function test_image_insertion_dialog_persist() {</span>
<a href="#l60.33"></a><span id="l60.33">   let cwc = open_compose_new_mail();</span>
<a href="#l60.34"></a><span id="l60.34"> </span>
<a href="#l60.35"></a><span id="l60.35">   // First focus on the editor element</span>
<a href="#l60.36"></a><span id="l60.36">   cwc.e(&quot;content-frame&quot;).focus();</span>
<a href="#l60.37"></a><span id="l60.37"> </span>
<a href="#l60.38"></a><span id="l60.38">   // Now open the image window</span>
<a href="#l60.39"></a><span id="l60.39">   wh.plan_for_modal_dialog(&quot;imageDlg&quot;, function insert_image(mwc) {</span>
<a href="#l60.40"></a><span id="l60.40">     // Insert the url of the image.</span>
<a href="#l60.41"></a><span id="l60.41" class="difflineat">@@ -46,62 +43,62 @@ function test_image_insertion_dialog_per</span>
<a href="#l60.42"></a><span id="l60.42">     mwc.window.document.documentElement.acceptDialog();</span>
<a href="#l60.43"></a><span id="l60.43">   });</span>
<a href="#l60.44"></a><span id="l60.44">   cwc.click(cwc.eid(&quot;insertImage&quot;));</span>
<a href="#l60.45"></a><span id="l60.45">   wh.wait_for_modal_dialog();</span>
<a href="#l60.46"></a><span id="l60.46">   wh.wait_for_window_close();</span>
<a href="#l60.47"></a><span id="l60.47"> </span>
<a href="#l60.48"></a><span id="l60.48">   // Check that the radio option persists</span>
<a href="#l60.49"></a><span id="l60.49">   wh.plan_for_modal_dialog(&quot;imageDlg&quot;, function insert_image(mwc) {</span>
<a href="#l60.50"></a><span id="l60.50" class="difflineminus">-    assert_true(</span>
<a href="#l60.51"></a><span id="l60.51" class="difflineplus">+    Assert.ok(</span>
<a href="#l60.52"></a><span id="l60.52">       mwc.window.document.getElementById(&quot;noAltTextRadio&quot;).selected,</span>
<a href="#l60.53"></a><span id="l60.53">       &quot;We should persist the previously selected value&quot;</span>
<a href="#l60.54"></a><span id="l60.54">     );</span>
<a href="#l60.55"></a><span id="l60.55">     // We change to &quot;use alt text&quot;</span>
<a href="#l60.56"></a><span id="l60.56">     mwc.click(mwc.eid(&quot;altTextRadio&quot;));</span>
<a href="#l60.57"></a><span id="l60.57">     mwc.window.document.documentElement.cancelDialog();</span>
<a href="#l60.58"></a><span id="l60.58">   });</span>
<a href="#l60.59"></a><span id="l60.59">   cwc.click(cwc.eid(&quot;insertImage&quot;));</span>
<a href="#l60.60"></a><span id="l60.60">   wh.wait_for_modal_dialog();</span>
<a href="#l60.61"></a><span id="l60.61">   wh.wait_for_window_close();</span>
<a href="#l60.62"></a><span id="l60.62"> </span>
<a href="#l60.63"></a><span id="l60.63">   // Check that the radio option still persists (be really sure)</span>
<a href="#l60.64"></a><span id="l60.64">   wh.plan_for_modal_dialog(&quot;imageDlg&quot;, function insert_image(mwc) {</span>
<a href="#l60.65"></a><span id="l60.65" class="difflineminus">-    assert_true(</span>
<a href="#l60.66"></a><span id="l60.66" class="difflineplus">+    Assert.ok(</span>
<a href="#l60.67"></a><span id="l60.67">       mwc.window.document.getElementById(&quot;altTextRadio&quot;).selected,</span>
<a href="#l60.68"></a><span id="l60.68">       &quot;We should persist the previously selected value&quot;</span>
<a href="#l60.69"></a><span id="l60.69">     );</span>
<a href="#l60.70"></a><span id="l60.70">     // Accept the dialog</span>
<a href="#l60.71"></a><span id="l60.71">     mwc.window.document.documentElement.cancelDialog();</span>
<a href="#l60.72"></a><span id="l60.72">   });</span>
<a href="#l60.73"></a><span id="l60.73">   cwc.click(cwc.eid(&quot;insertImage&quot;));</span>
<a href="#l60.74"></a><span id="l60.74">   wh.wait_for_modal_dialog();</span>
<a href="#l60.75"></a><span id="l60.75">   wh.wait_for_window_close();</span>
<a href="#l60.76"></a><span id="l60.76">   cwc.sleep(500);</span>
<a href="#l60.77"></a><span id="l60.77"> </span>
<a href="#l60.78"></a><span id="l60.78">   // Get the inserted image, double-click it, make sure we switch to &quot;no alt</span>
<a href="#l60.79"></a><span id="l60.79">   // text&quot;, despite the persisted value being &quot;use alt text&quot;</span>
<a href="#l60.80"></a><span id="l60.80">   let img = cwc.e(&quot;content-frame&quot;).contentDocument.querySelector(&quot;img&quot;);</span>
<a href="#l60.81"></a><span id="l60.81">   wh.plan_for_modal_dialog(&quot;imageDlg&quot;, function insert_image(mwc) {</span>
<a href="#l60.82"></a><span id="l60.82" class="difflineminus">-    assert_true(</span>
<a href="#l60.83"></a><span id="l60.83" class="difflineplus">+    Assert.ok(</span>
<a href="#l60.84"></a><span id="l60.84">       mwc.window.document.getElementById(&quot;noAltTextRadio&quot;).selected,</span>
<a href="#l60.85"></a><span id="l60.85">       &quot;We shouldn't use the persisted value because the insert image has no alt text&quot;</span>
<a href="#l60.86"></a><span id="l60.86">     );</span>
<a href="#l60.87"></a><span id="l60.87">     mwc.window.document.documentElement.cancelDialog();</span>
<a href="#l60.88"></a><span id="l60.88">   });</span>
<a href="#l60.89"></a><span id="l60.89">   cwc.doubleClick(new elib.Elem(img));</span>
<a href="#l60.90"></a><span id="l60.90">   wh.wait_for_modal_dialog();</span>
<a href="#l60.91"></a><span id="l60.91">   wh.wait_for_window_close();</span>
<a href="#l60.92"></a><span id="l60.92">   // It's not clear why we have to wait here to avoid test failures,</span>
<a href="#l60.93"></a><span id="l60.93">   // see bug 1246094.</span>
<a href="#l60.94"></a><span id="l60.94">   cwc.sleep(500);</span>
<a href="#l60.95"></a><span id="l60.95"> </span>
<a href="#l60.96"></a><span id="l60.96">   // Now use some alt text for the edit image dialog</span>
<a href="#l60.97"></a><span id="l60.97">   wh.plan_for_modal_dialog(&quot;imageDlg&quot;, function insert_image(mwc) {</span>
<a href="#l60.98"></a><span id="l60.98" class="difflineminus">-    assert_true(</span>
<a href="#l60.99"></a><span id="l60.99" class="difflineplus">+    Assert.ok(</span>
<a href="#l60.100"></a><span id="l60.100">       mwc.window.document.getElementById(&quot;noAltTextRadio&quot;).selected,</span>
<a href="#l60.101"></a><span id="l60.101">       &quot;That value should persist still...&quot;</span>
<a href="#l60.102"></a><span id="l60.102">     );</span>
<a href="#l60.103"></a><span id="l60.103">     mwc.click(mwc.eid(&quot;altTextRadio&quot;));</span>
<a href="#l60.104"></a><span id="l60.104"> </span>
<a href="#l60.105"></a><span id="l60.105">     let srcloc = mwc.window.document.getElementById(&quot;altTextInput&quot;);</span>
<a href="#l60.106"></a><span id="l60.106">     srcloc.focus();</span>
<a href="#l60.107"></a><span id="l60.107">     input_value(mwc, &quot;some alt text&quot;);</span>
<a href="#l60.108"></a><span id="l60.108" class="difflineat">@@ -114,21 +111,21 @@ function test_image_insertion_dialog_per</span>
<a href="#l60.109"></a><span id="l60.109">   wh.wait_for_window_close();</span>
<a href="#l60.110"></a><span id="l60.110">   // It's not clear why we have to wait here to avoid test failures,</span>
<a href="#l60.111"></a><span id="l60.111">   // see bug 1246094.</span>
<a href="#l60.112"></a><span id="l60.112">   cwc.sleep(500);</span>
<a href="#l60.113"></a><span id="l60.113"> </span>
<a href="#l60.114"></a><span id="l60.114">   // Make sure next time we edit it, we still have &quot;use alt text&quot; selected.</span>
<a href="#l60.115"></a><span id="l60.115">   img = cwc.e(&quot;content-frame&quot;).contentDocument.querySelector(&quot;img&quot;);</span>
<a href="#l60.116"></a><span id="l60.116">   wh.plan_for_modal_dialog(&quot;imageDlg&quot;, function insert_image(mwc) {</span>
<a href="#l60.117"></a><span id="l60.117" class="difflineminus">-    assert_true(</span>
<a href="#l60.118"></a><span id="l60.118" class="difflineplus">+    Assert.ok(</span>
<a href="#l60.119"></a><span id="l60.119">       mwc.window.document.getElementById(&quot;altTextRadio&quot;).selected,</span>
<a href="#l60.120"></a><span id="l60.120">       &quot;We edited the image to make it have alt text, we should keep it selected&quot;</span>
<a href="#l60.121"></a><span id="l60.121">     );</span>
<a href="#l60.122"></a><span id="l60.122">     // Accept the dialog</span>
<a href="#l60.123"></a><span id="l60.123">     mwc.window.document.documentElement.cancelDialog();</span>
<a href="#l60.124"></a><span id="l60.124">   });</span>
<a href="#l60.125"></a><span id="l60.125">   cwc.doubleClick(new elib.Elem(img));</span>
<a href="#l60.126"></a><span id="l60.126">   wh.wait_for_modal_dialog();</span>
<a href="#l60.127"></a><span id="l60.127">   wh.wait_for_window_close();</span>
<a href="#l60.128"></a><span id="l60.128"> </span>
<a href="#l60.129"></a><span id="l60.129">   close_compose_window(cwc);</span>
<a href="#l60.130"></a><span id="l60.130" class="difflineminus">-}</span>
<a href="#l60.131"></a><span id="l60.131" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1">copy from mail/test/mozmill/composition/test-multipart-related.js</span>
<a href="#l61.2"></a><span id="l61.2">copy to mail/test/browser/composition/browser_multipartRelated.js</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-multipart-related.js</span>
<a href="#l61.4"></a><span id="l61.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_multipartRelated.js</span>
<a href="#l61.5"></a><span id="l61.5" class="difflineat">@@ -4,26 +4,25 @@</span>
<a href="#l61.6"></a><span id="l61.6"> </span>
<a href="#l61.7"></a><span id="l61.7"> /**</span>
<a href="#l61.8"></a><span id="l61.8">  * Tests that multipart/related messages are handled properly.</span>
<a href="#l61.9"></a><span id="l61.9">  */</span>
<a href="#l61.10"></a><span id="l61.10"> </span>
<a href="#l61.11"></a><span id="l61.11"> &quot;use strict&quot;;</span>
<a href="#l61.12"></a><span id="l61.12"> </span>
<a href="#l61.13"></a><span id="l61.13"> var elib = ChromeUtils.import(</span>
<a href="#l61.14"></a><span id="l61.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l61.15"></a><span id="l61.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l61.16"></a><span id="l61.16"> );</span>
<a href="#l61.17"></a><span id="l61.17" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l61.18"></a><span id="l61.18" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l61.19"></a><span id="l61.19" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l61.20"></a><span id="l61.20" class="difflineplus">+var utils = ChromeUtils.import(&quot;resource://testing-common/mozmill/utils.jsm&quot;);</span>
<a href="#l61.21"></a><span id="l61.21"> </span>
<a href="#l61.22"></a><span id="l61.22"> var { close_compose_window, open_compose_new_mail } = ChromeUtils.import(</span>
<a href="#l61.23"></a><span id="l61.23">   &quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;</span>
<a href="#l61.24"></a><span id="l61.24"> );</span>
<a href="#l61.25"></a><span id="l61.25"> var {</span>
<a href="#l61.26"></a><span id="l61.26" class="difflineminus">-  assert_equals,</span>
<a href="#l61.27"></a><span id="l61.27">   be_in_folder,</span>
<a href="#l61.28"></a><span id="l61.28">   get_special_folder,</span>
<a href="#l61.29"></a><span id="l61.29">   mc,</span>
<a href="#l61.30"></a><span id="l61.30">   press_delete,</span>
<a href="#l61.31"></a><span id="l61.31">   select_click_row,</span>
<a href="#l61.32"></a><span id="l61.32"> } = ChromeUtils.import(</span>
<a href="#l61.33"></a><span id="l61.33">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l61.34"></a><span id="l61.34"> );</span>
<a href="#l61.35"></a><span id="l61.35" class="difflineat">@@ -36,19 +35,19 @@ var {</span>
<a href="#l61.36"></a><span id="l61.36"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l61.37"></a><span id="l61.37"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l61.38"></a><span id="l61.38">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l61.39"></a><span id="l61.39"> );</span>
<a href="#l61.40"></a><span id="l61.40"> var { MimeParser } = ChromeUtils.import(&quot;resource:///modules/mimeParser.jsm&quot;);</span>
<a href="#l61.41"></a><span id="l61.41"> </span>
<a href="#l61.42"></a><span id="l61.42"> var gDrafts;</span>
<a href="#l61.43"></a><span id="l61.43"> </span>
<a href="#l61.44"></a><span id="l61.44" class="difflineminus">-function setupModule(module) {</span>
<a href="#l61.45"></a><span id="l61.45" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l61.46"></a><span id="l61.46">   gDrafts = get_special_folder(Ci.nsMsgFolderFlags.Drafts, true);</span>
<a href="#l61.47"></a><span id="l61.47" class="difflineminus">-}</span>
<a href="#l61.48"></a><span id="l61.48" class="difflineplus">+});</span>
<a href="#l61.49"></a><span id="l61.49"> </span>
<a href="#l61.50"></a><span id="l61.50"> /**</span>
<a href="#l61.51"></a><span id="l61.51">  * Helper to get the full message content.</span>
<a href="#l61.52"></a><span id="l61.52">  *</span>
<a href="#l61.53"></a><span id="l61.53">  * @param aMsgHdr: nsIMsgDBHdr object whose text body will be read</span>
<a href="#l61.54"></a><span id="l61.54">  * @return {Map(partnum -&gt; message headers), Map(partnum -&gt; message text)}</span>
<a href="#l61.55"></a><span id="l61.55">  */</span>
<a href="#l61.56"></a><span id="l61.56"> function getMsgHeaders(aMsgHdr) {</span>
<a href="#l61.57"></a><span id="l61.57" class="difflineat">@@ -80,24 +79,24 @@ function getMsgHeaders(aMsgHdr) {</span>
<a href="#l61.58"></a><span id="l61.58">     .messageServiceFromURI(msgUri)</span>
<a href="#l61.59"></a><span id="l61.59">     .streamMessage(msgUri, streamListener, null, null, false, &quot;&quot;, false);</span>
<a href="#l61.60"></a><span id="l61.60">   utils.waitFor(() =&gt; handler._done);</span>
<a href="#l61.61"></a><span id="l61.61">   return { headers: handler._data, text: handler._text };</span>
<a href="#l61.62"></a><span id="l61.62"> }</span>
<a href="#l61.63"></a><span id="l61.63"> </span>
<a href="#l61.64"></a><span id="l61.64"> /**</span>
<a href="#l61.65"></a><span id="l61.65">  */</span>
<a href="#l61.66"></a><span id="l61.66" class="difflineminus">-function test_basic_multipart_related() {</span>
<a href="#l61.67"></a><span id="l61.67" class="difflineplus">+add_task(function test_basic_multipart_related() {</span>
<a href="#l61.68"></a><span id="l61.68">   let compWin = open_compose_new_mail();</span>
<a href="#l61.69"></a><span id="l61.69">   compWin.type(null, &quot;someone@example.com&quot;);</span>
<a href="#l61.70"></a><span id="l61.70">   compWin.type(compWin.eid(&quot;msgSubject&quot;), &quot;multipart/related&quot;);</span>
<a href="#l61.71"></a><span id="l61.71">   compWin.type(compWin.eid(&quot;content-frame&quot;), &quot;Here is a prologue.\n&quot;);</span>
<a href="#l61.72"></a><span id="l61.72"> </span>
<a href="#l61.73"></a><span id="l61.73" class="difflineminus">-  const fname = &quot;./tb-logo.png&quot;;</span>
<a href="#l61.74"></a><span id="l61.74" class="difflineminus">-  let file = os.getFileForPath(os.abspath(fname, os.getFileForPath(__file__)));</span>
<a href="#l61.75"></a><span id="l61.75" class="difflineplus">+  const fname = &quot;data/tb-logo.png&quot;;</span>
<a href="#l61.76"></a><span id="l61.76" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(fname));</span>
<a href="#l61.77"></a><span id="l61.77">   let fileHandler = Services.io</span>
<a href="#l61.78"></a><span id="l61.78">     .getProtocolHandler(&quot;file&quot;)</span>
<a href="#l61.79"></a><span id="l61.79">     .QueryInterface(Ci.nsIFileProtocolHandler);</span>
<a href="#l61.80"></a><span id="l61.80">   let fileURL = fileHandler.getURLSpecFromFile(file);</span>
<a href="#l61.81"></a><span id="l61.81"> </span>
<a href="#l61.82"></a><span id="l61.82">   // Add a simple image to our dialog</span>
<a href="#l61.83"></a><span id="l61.83">   plan_for_modal_dialog(&quot;imageDlg&quot;, function(dialog) {</span>
<a href="#l61.84"></a><span id="l61.84">     // Insert the url of the image.</span>
<a href="#l61.85"></a><span id="l61.85" class="difflineat">@@ -115,25 +114,25 @@ function test_basic_multipart_related() </span>
<a href="#l61.86"></a><span id="l61.86">   // Ctrl+S = save as draft.</span>
<a href="#l61.87"></a><span id="l61.87">   compWin.keypress(null, &quot;s&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l61.88"></a><span id="l61.88">   close_compose_window(compWin);</span>
<a href="#l61.89"></a><span id="l61.89"> </span>
<a href="#l61.90"></a><span id="l61.90">   // Make sure that the headers are right on this one.</span>
<a href="#l61.91"></a><span id="l61.91">   be_in_folder(gDrafts);</span>
<a href="#l61.92"></a><span id="l61.92">   let draftMsg = select_click_row(0);</span>
<a href="#l61.93"></a><span id="l61.93">   let { headers, text } = getMsgHeaders(draftMsg, true);</span>
<a href="#l61.94"></a><span id="l61.94" class="difflineminus">-  assert_equals(headers.get(&quot;&quot;).contentType.type, &quot;multipart/related&quot;);</span>
<a href="#l61.95"></a><span id="l61.95" class="difflineminus">-  assert_equals(headers.get(&quot;1&quot;).contentType.type, &quot;text/html&quot;);</span>
<a href="#l61.96"></a><span id="l61.96" class="difflineminus">-  assert_equals(headers.get(&quot;2&quot;).contentType.type, &quot;image/png&quot;);</span>
<a href="#l61.97"></a><span id="l61.97" class="difflineminus">-  assert_equals(headers.get(&quot;2&quot;).get(&quot;Content-Transfer-Encoding&quot;), &quot;base64&quot;);</span>
<a href="#l61.98"></a><span id="l61.98" class="difflineminus">-  assert_equals(</span>
<a href="#l61.99"></a><span id="l61.99" class="difflineplus">+  Assert.equal(headers.get(&quot;&quot;).contentType.type, &quot;multipart/related&quot;);</span>
<a href="#l61.100"></a><span id="l61.100" class="difflineplus">+  Assert.equal(headers.get(&quot;1&quot;).contentType.type, &quot;text/html&quot;);</span>
<a href="#l61.101"></a><span id="l61.101" class="difflineplus">+  Assert.equal(headers.get(&quot;2&quot;).contentType.type, &quot;image/png&quot;);</span>
<a href="#l61.102"></a><span id="l61.102" class="difflineplus">+  Assert.equal(headers.get(&quot;2&quot;).get(&quot;Content-Transfer-Encoding&quot;), &quot;base64&quot;);</span>
<a href="#l61.103"></a><span id="l61.103" class="difflineplus">+  Assert.equal(</span>
<a href="#l61.104"></a><span id="l61.104">     headers.get(&quot;2&quot;).getRawHeader(&quot;Content-Disposition&quot;)[0],</span>
<a href="#l61.105"></a><span id="l61.105">     'inline; filename=&quot;tb-logo.png&quot;'</span>
<a href="#l61.106"></a><span id="l61.106">   );</span>
<a href="#l61.107"></a><span id="l61.107">   let cid = headers</span>
<a href="#l61.108"></a><span id="l61.108">     .get(&quot;2&quot;)</span>
<a href="#l61.109"></a><span id="l61.109">     .getRawHeader(&quot;Content-ID&quot;)[0]</span>
<a href="#l61.110"></a><span id="l61.110">     .slice(1, -1);</span>
<a href="#l61.111"></a><span id="l61.111">   if (!text.get(&quot;1&quot;).includes('src=&quot;cid:' + cid + '&quot;')) {</span>
<a href="#l61.112"></a><span id="l61.112">     throw new Error(&quot;Expected HTML to refer to cid &quot; + cid);</span>
<a href="#l61.113"></a><span id="l61.113">   }</span>
<a href="#l61.114"></a><span id="l61.114">   press_delete(mc); // Delete message</span>
<a href="#l61.115"></a><span id="l61.115" class="difflineminus">-}</span>
<a href="#l61.116"></a><span id="l61.116" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1">copy from mail/test/mozmill/composition/test-newmsg-compose-identity.js</span>
<a href="#l62.2"></a><span id="l62.2">copy to mail/test/browser/composition/browser_newmsgComposeIdentity.js</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-newmsg-compose-identity.js</span>
<a href="#l62.4"></a><span id="l62.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_newmsgComposeIdentity.js</span>
<a href="#l62.5"></a><span id="l62.5" class="difflineat">@@ -10,17 +10,16 @@</span>
<a href="#l62.6"></a><span id="l62.6"> &quot;use strict&quot;;</span>
<a href="#l62.7"></a><span id="l62.7"> </span>
<a href="#l62.8"></a><span id="l62.8"> var {</span>
<a href="#l62.9"></a><span id="l62.9">   close_compose_window,</span>
<a href="#l62.10"></a><span id="l62.10">   open_compose_new_mail,</span>
<a href="#l62.11"></a><span id="l62.11">   wait_for_compose_window,</span>
<a href="#l62.12"></a><span id="l62.12"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l62.13"></a><span id="l62.13"> var {</span>
<a href="#l62.14"></a><span id="l62.14" class="difflineminus">-  assert_equals,</span>
<a href="#l62.15"></a><span id="l62.15">   be_in_folder,</span>
<a href="#l62.16"></a><span id="l62.16">   get_special_folder,</span>
<a href="#l62.17"></a><span id="l62.17">   mc,</span>
<a href="#l62.18"></a><span id="l62.18">   press_delete,</span>
<a href="#l62.19"></a><span id="l62.19">   select_click_row,</span>
<a href="#l62.20"></a><span id="l62.20"> } = ChromeUtils.import(</span>
<a href="#l62.21"></a><span id="l62.21">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l62.22"></a><span id="l62.22"> );</span>
<a href="#l62.23"></a><span id="l62.23" class="difflineat">@@ -44,17 +43,17 @@ var identity2Email = &quot;y@example.invalid&quot;</span>
<a href="#l62.24"></a><span id="l62.24"> var identity2Name = &quot;User Y&quot;;</span>
<a href="#l62.25"></a><span id="l62.25"> var identity2From = identity2Name + &quot; &lt;&quot; + identity2Email + &quot;&gt;&quot;;</span>
<a href="#l62.26"></a><span id="l62.26"> var identityKey3;</span>
<a href="#l62.27"></a><span id="l62.27"> var identity3Email = &quot;z@example.invalid&quot;;</span>
<a href="#l62.28"></a><span id="l62.28"> var identity3Name = &quot;User Z&quot;;</span>
<a href="#l62.29"></a><span id="l62.29"> var identity3Label = &quot;Label Z&quot;;</span>
<a href="#l62.30"></a><span id="l62.30"> var identityKey4;</span>
<a href="#l62.31"></a><span id="l62.31"> </span>
<a href="#l62.32"></a><span id="l62.32" class="difflineminus">-function setupModule(module) {</span>
<a href="#l62.33"></a><span id="l62.33" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l62.34"></a><span id="l62.34">   // Now set up an account with some identities.</span>
<a href="#l62.35"></a><span id="l62.35">   let acctMgr = MailServices.accounts;</span>
<a href="#l62.36"></a><span id="l62.36">   account = acctMgr.createAccount();</span>
<a href="#l62.37"></a><span id="l62.37">   account.incomingServer = acctMgr.createIncomingServer(</span>
<a href="#l62.38"></a><span id="l62.38">     &quot;nobody&quot;,</span>
<a href="#l62.39"></a><span id="l62.39">     &quot;New Msg Compose Identity Testing&quot;,</span>
<a href="#l62.40"></a><span id="l62.40">     &quot;pop3&quot;</span>
<a href="#l62.41"></a><span id="l62.41">   );</span>
<a href="#l62.42"></a><span id="l62.42" class="difflineat">@@ -81,59 +80,59 @@ function setupModule(module) {</span>
<a href="#l62.43"></a><span id="l62.43">   let identity4 = acctMgr.createIdentity();</span>
<a href="#l62.44"></a><span id="l62.44">   account.addIdentity(identity4);</span>
<a href="#l62.45"></a><span id="l62.45">   identityKey4 = identity4.key;</span>
<a href="#l62.46"></a><span id="l62.46"> </span>
<a href="#l62.47"></a><span id="l62.47">   gInbox = account.incomingServer.rootFolder.getFolderWithFlags(</span>
<a href="#l62.48"></a><span id="l62.48">     Ci.nsMsgFolderFlags.Inbox</span>
<a href="#l62.49"></a><span id="l62.49">   );</span>
<a href="#l62.50"></a><span id="l62.50">   gDrafts = get_special_folder(Ci.nsMsgFolderFlags.Drafts, true);</span>
<a href="#l62.51"></a><span id="l62.51" class="difflineminus">-}</span>
<a href="#l62.52"></a><span id="l62.52" class="difflineplus">+});</span>
<a href="#l62.53"></a><span id="l62.53"> </span>
<a href="#l62.54"></a><span id="l62.54"> /**</span>
<a href="#l62.55"></a><span id="l62.55">  * Helper to check that a suitable From identity was set up in the given</span>
<a href="#l62.56"></a><span id="l62.56">  * composer window.</span>
<a href="#l62.57"></a><span id="l62.57">  *</span>
<a href="#l62.58"></a><span id="l62.58">  * @param cwc             Compose window controller.</span>
<a href="#l62.59"></a><span id="l62.59">  * @param aIdentityKey    The key of the expected identity.</span>
<a href="#l62.60"></a><span id="l62.60">  * @param aIdentityAlias  The displayed label of the expected identity.</span>
<a href="#l62.61"></a><span id="l62.61">  * @param aIdentityValue  The value of the expected identity</span>
<a href="#l62.62"></a><span id="l62.62">  *                        (the sender address to be sent out).</span>
<a href="#l62.63"></a><span id="l62.63">  */</span>
<a href="#l62.64"></a><span id="l62.64"> function checkCompIdentity(cwc, aIdentityKey, aIdentityAlias, aIdentityValue) {</span>
<a href="#l62.65"></a><span id="l62.65">   let identityList = cwc.e(&quot;msgIdentity&quot;);</span>
<a href="#l62.66"></a><span id="l62.66"> </span>
<a href="#l62.67"></a><span id="l62.67" class="difflineminus">-  assert_equals(</span>
<a href="#l62.68"></a><span id="l62.68" class="difflineplus">+  Assert.equal(</span>
<a href="#l62.69"></a><span id="l62.69">     cwc.window.getCurrentIdentityKey(),</span>
<a href="#l62.70"></a><span id="l62.70">     aIdentityKey,</span>
<a href="#l62.71"></a><span id="l62.71">     &quot;The From identity is not correctly selected&quot;</span>
<a href="#l62.72"></a><span id="l62.72">   );</span>
<a href="#l62.73"></a><span id="l62.73"> </span>
<a href="#l62.74"></a><span id="l62.74">   if (aIdentityAlias) {</span>
<a href="#l62.75"></a><span id="l62.75" class="difflineminus">-    assert_equals(</span>
<a href="#l62.76"></a><span id="l62.76" class="difflineplus">+    Assert.equal(</span>
<a href="#l62.77"></a><span id="l62.77">       identityList.label,</span>
<a href="#l62.78"></a><span id="l62.78">       aIdentityAlias,</span>
<a href="#l62.79"></a><span id="l62.79">       &quot;The From address does not have the correct label&quot;</span>
<a href="#l62.80"></a><span id="l62.80">     );</span>
<a href="#l62.81"></a><span id="l62.81">   }</span>
<a href="#l62.82"></a><span id="l62.82"> </span>
<a href="#l62.83"></a><span id="l62.83">   if (aIdentityValue) {</span>
<a href="#l62.84"></a><span id="l62.84" class="difflineminus">-    assert_equals(</span>
<a href="#l62.85"></a><span id="l62.85" class="difflineplus">+    Assert.equal(</span>
<a href="#l62.86"></a><span id="l62.86">       identityList.value,</span>
<a href="#l62.87"></a><span id="l62.87">       aIdentityValue,</span>
<a href="#l62.88"></a><span id="l62.88">       &quot;The From address does not have the correct value&quot;</span>
<a href="#l62.89"></a><span id="l62.89">     );</span>
<a href="#l62.90"></a><span id="l62.90">   }</span>
<a href="#l62.91"></a><span id="l62.91"> }</span>
<a href="#l62.92"></a><span id="l62.92"> </span>
<a href="#l62.93"></a><span id="l62.93"> /**</span>
<a href="#l62.94"></a><span id="l62.94">  * Test that starting a new message from an open compose window gets the</span>
<a href="#l62.95"></a><span id="l62.95">  * expected initial identity.</span>
<a href="#l62.96"></a><span id="l62.96">  */</span>
<a href="#l62.97"></a><span id="l62.97" class="difflineminus">-function test_compose_from_composer() {</span>
<a href="#l62.98"></a><span id="l62.98" class="difflineplus">+add_task(function test_compose_from_composer() {</span>
<a href="#l62.99"></a><span id="l62.99">   be_in_folder(gInbox);</span>
<a href="#l62.100"></a><span id="l62.100"> </span>
<a href="#l62.101"></a><span id="l62.101">   let mainCompWin = open_compose_new_mail();</span>
<a href="#l62.102"></a><span id="l62.102">   checkCompIdentity(mainCompWin, account.defaultIdentity.key);</span>
<a href="#l62.103"></a><span id="l62.103"> </span>
<a href="#l62.104"></a><span id="l62.104">   // Compose a new message from the compose window.</span>
<a href="#l62.105"></a><span id="l62.105">   plan_for_new_window(&quot;msgcompose&quot;);</span>
<a href="#l62.106"></a><span id="l62.106">   mainCompWin.keypress(null, &quot;n&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l62.107"></a><span id="l62.107" class="difflineat">@@ -153,23 +152,23 @@ function test_compose_from_composer() {</span>
<a href="#l62.108"></a><span id="l62.108">   plan_for_new_window(&quot;msgcompose&quot;);</span>
<a href="#l62.109"></a><span id="l62.109">   mainCompWin.keypress(null, &quot;n&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l62.110"></a><span id="l62.110">   let newCompWin2 = wait_for_compose_window();</span>
<a href="#l62.111"></a><span id="l62.111">   checkCompIdentity(newCompWin2, identityKey2);</span>
<a href="#l62.112"></a><span id="l62.112"> </span>
<a href="#l62.113"></a><span id="l62.113">   close_compose_window(newCompWin2);</span>
<a href="#l62.114"></a><span id="l62.114"> </span>
<a href="#l62.115"></a><span id="l62.115">   close_compose_window(mainCompWin);</span>
<a href="#l62.116"></a><span id="l62.116" class="difflineminus">-}</span>
<a href="#l62.117"></a><span id="l62.117" class="difflineplus">+});</span>
<a href="#l62.118"></a><span id="l62.118"> </span>
<a href="#l62.119"></a><span id="l62.119"> /**</span>
<a href="#l62.120"></a><span id="l62.120">  * Bug 87987</span>
<a href="#l62.121"></a><span id="l62.121">  * Test editing the identity email/name for the current composition.</span>
<a href="#l62.122"></a><span id="l62.122">  */</span>
<a href="#l62.123"></a><span id="l62.123" class="difflineminus">-function test_editing_identity() {</span>
<a href="#l62.124"></a><span id="l62.124" class="difflineplus">+add_task(function test_editing_identity() {</span>
<a href="#l62.125"></a><span id="l62.125">   Services.prefs.setBoolPref(&quot;mail.compose.warned_about_customize_from&quot;, true);</span>
<a href="#l62.126"></a><span id="l62.126">   be_in_folder(gInbox);</span>
<a href="#l62.127"></a><span id="l62.127"> </span>
<a href="#l62.128"></a><span id="l62.128">   let compWin = open_compose_new_mail();</span>
<a href="#l62.129"></a><span id="l62.129">   checkCompIdentity(compWin, account.defaultIdentity.key, identity1Email);</span>
<a href="#l62.130"></a><span id="l62.130"> </span>
<a href="#l62.131"></a><span id="l62.131">   // Input custom identity data into the From field.</span>
<a href="#l62.132"></a><span id="l62.132">   let customName = &quot;custom&quot;;</span>
<a href="#l62.133"></a><span id="l62.133" class="difflineat">@@ -202,28 +201,28 @@ function test_editing_identity() {</span>
<a href="#l62.134"></a><span id="l62.134">                                   [ { identitykey: identityKey2 } ]);</span>
<a href="#l62.135"></a><span id="l62.135">   checkCompIdentity(compWin, identityKey2, identity2From, identity2From);</span>
<a href="#l62.136"></a><span id="l62.136"> </span>
<a href="#l62.137"></a><span id="l62.137">   // This should not save the identity2 to the draft message.</span>
<a href="#l62.138"></a><span id="l62.138">   close_compose_window(compWin);</span>
<a href="#l62.139"></a><span id="l62.139"> </span>
<a href="#l62.140"></a><span id="l62.140">   be_in_folder(gDrafts);</span>
<a href="#l62.141"></a><span id="l62.141">   let curMessage = select_click_row(0);</span>
<a href="#l62.142"></a><span id="l62.142" class="difflineminus">-  assert_equals(curMessage.author, identityCustom);</span>
<a href="#l62.143"></a><span id="l62.143" class="difflineplus">+  Assert.equal(curMessage.author, identityCustom);</span>
<a href="#l62.144"></a><span id="l62.144">   // Remove the saved draft.</span>
<a href="#l62.145"></a><span id="l62.145">   press_delete(mc);</span>
<a href="#l62.146"></a><span id="l62.146">   */</span>
<a href="#l62.147"></a><span id="l62.147">   Services.prefs.setBoolPref(&quot;mail.compose.warned_about_customize_from&quot;, false);</span>
<a href="#l62.148"></a><span id="l62.148" class="difflineminus">-}</span>
<a href="#l62.149"></a><span id="l62.149" class="difflineplus">+});</span>
<a href="#l62.150"></a><span id="l62.150"> </span>
<a href="#l62.151"></a><span id="l62.151"> /**</span>
<a href="#l62.152"></a><span id="l62.152">  * Bug 318495</span>
<a href="#l62.153"></a><span id="l62.153">  * Test how an identity displays and behaves in the compose window.</span>
<a href="#l62.154"></a><span id="l62.154">  */</span>
<a href="#l62.155"></a><span id="l62.155" class="difflineminus">-function test_display_of_identities() {</span>
<a href="#l62.156"></a><span id="l62.156" class="difflineplus">+add_task(function test_display_of_identities() {</span>
<a href="#l62.157"></a><span id="l62.157">   be_in_folder(gInbox);</span>
<a href="#l62.158"></a><span id="l62.158"> </span>
<a href="#l62.159"></a><span id="l62.159">   let cwc = open_compose_new_mail();</span>
<a href="#l62.160"></a><span id="l62.160">   checkCompIdentity(cwc, account.defaultIdentity.key, identity1Email);</span>
<a href="#l62.161"></a><span id="l62.161"> </span>
<a href="#l62.162"></a><span id="l62.162">   cwc.click(cwc.eid(&quot;msgIdentity&quot;));</span>
<a href="#l62.163"></a><span id="l62.163">   cwc.click_menus_in_sequence(cwc.e(&quot;msgIdentityPopup&quot;), [</span>
<a href="#l62.164"></a><span id="l62.164">     { identitykey: identityKey2 },</span>
<a href="#l62.165"></a><span id="l62.165" class="difflineat">@@ -254,23 +253,23 @@ function test_display_of_identities() {</span>
<a href="#l62.166"></a><span id="l62.166"> </span>
<a href="#l62.167"></a><span id="l62.167">   // Bug 1152045, check that the email address from the selected identity</span>
<a href="#l62.168"></a><span id="l62.168">   // is properly used for the From field in the created message.</span>
<a href="#l62.169"></a><span id="l62.169">   cwc.window.SaveAsDraft();</span>
<a href="#l62.170"></a><span id="l62.170">   close_compose_window(cwc);</span>
<a href="#l62.171"></a><span id="l62.171"> </span>
<a href="#l62.172"></a><span id="l62.172">   be_in_folder(gDrafts);</span>
<a href="#l62.173"></a><span id="l62.173">   let curMessage = select_click_row(0);</span>
<a href="#l62.174"></a><span id="l62.174" class="difflineminus">-  assert_equals(curMessage.author, identity3From);</span>
<a href="#l62.175"></a><span id="l62.175" class="difflineplus">+  Assert.equal(curMessage.author, identity3From);</span>
<a href="#l62.176"></a><span id="l62.176">   // Remove the saved draft.</span>
<a href="#l62.177"></a><span id="l62.177">   press_delete(mc);</span>
<a href="#l62.178"></a><span id="l62.178" class="difflineminus">-}</span>
<a href="#l62.179"></a><span id="l62.179" class="difflineplus">+});</span>
<a href="#l62.180"></a><span id="l62.180"> </span>
<a href="#l62.181"></a><span id="l62.181" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l62.182"></a><span id="l62.182" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l62.183"></a><span id="l62.183">   account.removeIdentity(MailServices.accounts.getIdentity(identityKey1));</span>
<a href="#l62.184"></a><span id="l62.184">   account.removeIdentity(MailServices.accounts.getIdentity(identityKey2));</span>
<a href="#l62.185"></a><span id="l62.185">   account.removeIdentity(MailServices.accounts.getIdentity(identityKey3));</span>
<a href="#l62.186"></a><span id="l62.186"> </span>
<a href="#l62.187"></a><span id="l62.187">   // The last identity of an account can't be removed so clear all its prefs</span>
<a href="#l62.188"></a><span id="l62.188">   // which effectively destroys it.</span>
<a href="#l62.189"></a><span id="l62.189">   MailServices.accounts.getIdentity(identityKey4).clearAllValues();</span>
<a href="#l62.190"></a><span id="l62.190">   MailServices.accounts.removeAccount(account);</span>
<a href="#l62.191"></a><span id="l62.191" class="difflineminus">-}</span>
<a href="#l62.192"></a><span id="l62.192" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1">copy from mail/test/mozmill/composition/test-reply-addresses.js</span>
<a href="#l63.2"></a><span id="l63.2">copy to mail/test/browser/composition/browser_replyAddresses.js</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-reply-addresses.js</span>
<a href="#l63.4"></a><span id="l63.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_replyAddresses.js</span>
<a href="#l63.5"></a><span id="l63.5" class="difflineat">@@ -13,17 +13,16 @@</span>
<a href="#l63.6"></a><span id="l63.6"> var {</span>
<a href="#l63.7"></a><span id="l63.7">   close_compose_window,</span>
<a href="#l63.8"></a><span id="l63.8">   open_compose_with_reply,</span>
<a href="#l63.9"></a><span id="l63.9">   open_compose_with_reply_to_all,</span>
<a href="#l63.10"></a><span id="l63.10">   open_compose_with_reply_to_list,</span>
<a href="#l63.11"></a><span id="l63.11"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l63.12"></a><span id="l63.12"> var {</span>
<a href="#l63.13"></a><span id="l63.13">   add_message_to_folder,</span>
<a href="#l63.14"></a><span id="l63.14" class="difflineminus">-  assert_equals,</span>
<a href="#l63.15"></a><span id="l63.15">   assert_selected_and_displayed,</span>
<a href="#l63.16"></a><span id="l63.16">   be_in_folder,</span>
<a href="#l63.17"></a><span id="l63.17">   create_message,</span>
<a href="#l63.18"></a><span id="l63.18">   mc,</span>
<a href="#l63.19"></a><span id="l63.19">   select_click_row,</span>
<a href="#l63.20"></a><span id="l63.20"> } = ChromeUtils.import(</span>
<a href="#l63.21"></a><span id="l63.21">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l63.22"></a><span id="l63.22"> );</span>
<a href="#l63.23"></a><span id="l63.23" class="difflineat">@@ -36,17 +35,19 @@ var myEmail2 = &quot;otherme@example.com&quot;;</span>
<a href="#l63.24"></a><span id="l63.24"> </span>
<a href="#l63.25"></a><span id="l63.25"> var identity;</span>
<a href="#l63.26"></a><span id="l63.26"> var identity2;</span>
<a href="#l63.27"></a><span id="l63.27"> </span>
<a href="#l63.28"></a><span id="l63.28"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l63.29"></a><span id="l63.29">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l63.30"></a><span id="l63.30"> );</span>
<a href="#l63.31"></a><span id="l63.31"> </span>
<a href="#l63.32"></a><span id="l63.32" class="difflineminus">-function setupModule(module) {</span>
<a href="#l63.33"></a><span id="l63.33" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l63.34"></a><span id="l63.34" class="difflineplus">+  requestLongerTimeout(3);</span>
<a href="#l63.35"></a><span id="l63.35" class="difflineplus">+</span>
<a href="#l63.36"></a><span id="l63.36">   // Now set up an account with some identities.</span>
<a href="#l63.37"></a><span id="l63.37">   let acctMgr = MailServices.accounts;</span>
<a href="#l63.38"></a><span id="l63.38">   let account = acctMgr.createAccount();</span>
<a href="#l63.39"></a><span id="l63.39">   account.incomingServer = acctMgr.createIncomingServer(</span>
<a href="#l63.40"></a><span id="l63.40">     &quot;nobody&quot;,</span>
<a href="#l63.41"></a><span id="l63.41">     &quot;Reply Addresses Testing&quot;,</span>
<a href="#l63.42"></a><span id="l63.42">     &quot;pop3&quot;</span>
<a href="#l63.43"></a><span id="l63.43">   );</span>
<a href="#l63.44"></a><span id="l63.44" class="difflineat">@@ -60,17 +61,17 @@ function setupModule(module) {</span>
<a href="#l63.45"></a><span id="l63.45">   account.addIdentity(identity);</span>
<a href="#l63.46"></a><span id="l63.46"> </span>
<a href="#l63.47"></a><span id="l63.47">   identity2 = acctMgr.createIdentity();</span>
<a href="#l63.48"></a><span id="l63.48">   identity2.email = myEmail2;</span>
<a href="#l63.49"></a><span id="l63.49">   account.addIdentity(identity2);</span>
<a href="#l63.50"></a><span id="l63.50"> </span>
<a href="#l63.51"></a><span id="l63.51">   // Let's add messages to the folder later as we go, it's hard to read</span>
<a href="#l63.52"></a><span id="l63.52">   // out of context what the expected results should be.</span>
<a href="#l63.53"></a><span id="l63.53" class="difflineminus">-}</span>
<a href="#l63.54"></a><span id="l63.54" class="difflineplus">+});</span>
<a href="#l63.55"></a><span id="l63.55"> </span>
<a href="#l63.56"></a><span id="l63.56"> /**</span>
<a href="#l63.57"></a><span id="l63.57">  * Helper to open a reply, check the fields are as expected, and close the</span>
<a href="#l63.58"></a><span id="l63.58">  * reply window.</span>
<a href="#l63.59"></a><span id="l63.59">  * @param aReplyFunction which reply function to call</span>
<a href="#l63.60"></a><span id="l63.60">  * @param aExpectedFields the fields expected</span>
<a href="#l63.61"></a><span id="l63.61">  */</span>
<a href="#l63.62"></a><span id="l63.62"> function checkReply(aReplyFunction, aExpectedFields) {</span>
<a href="#l63.63"></a><span id="l63.63" class="difflineat">@@ -125,17 +126,17 @@ function checkToAddresses(replyWinContro</span>
<a href="#l63.64"></a><span id="l63.64">             &quot; is not in &quot; +</span>
<a href="#l63.65"></a><span id="l63.65">             type +</span>
<a href="#l63.66"></a><span id="l63.66">             &quot; fields; &quot; +</span>
<a href="#l63.67"></a><span id="l63.67">             &quot;obtained=&quot; +</span>
<a href="#l63.68"></a><span id="l63.68">             obtained</span>
<a href="#l63.69"></a><span id="l63.69">         );</span>
<a href="#l63.70"></a><span id="l63.70">       }</span>
<a href="#l63.71"></a><span id="l63.71">     }</span>
<a href="#l63.72"></a><span id="l63.72" class="difflineminus">-    assert_equals(</span>
<a href="#l63.73"></a><span id="l63.73" class="difflineplus">+    Assert.equal(</span>
<a href="#l63.74"></a><span id="l63.74">       obtained.length,</span>
<a href="#l63.75"></a><span id="l63.75">       expected.length,</span>
<a href="#l63.76"></a><span id="l63.76">       &quot;Unexpected number of fields obtained for type=&quot; +</span>
<a href="#l63.77"></a><span id="l63.77">         type +</span>
<a href="#l63.78"></a><span id="l63.78">         &quot;; obtained=&quot; +</span>
<a href="#l63.79"></a><span id="l63.79">         obtained +</span>
<a href="#l63.80"></a><span id="l63.80">         &quot;; expected=&quot; +</span>
<a href="#l63.81"></a><span id="l63.81">         expected</span>
<a href="#l63.82"></a><span id="l63.82" class="difflineat">@@ -201,17 +202,17 @@ function ensureNoAutoBcc(aIdentity) {</span>
<a href="#l63.83"></a><span id="l63.83"> }</span>
<a href="#l63.84"></a><span id="l63.84"> </span>
<a href="#l63.85"></a><span id="l63.85"> /**</span>
<a href="#l63.86"></a><span id="l63.86">  * Tests that for a list post with munged Reply-To:</span>
<a href="#l63.87"></a><span id="l63.87">  * - reply: goes to From</span>
<a href="#l63.88"></a><span id="l63.88">  * - reply all: includes From + the usual thing</span>
<a href="#l63.89"></a><span id="l63.89">  * - reply list: goes to the list</span>
<a href="#l63.90"></a><span id="l63.90">  */</span>
<a href="#l63.91"></a><span id="l63.91" class="difflineminus">-function testReplyToMungedReplyToList() {</span>
<a href="#l63.92"></a><span id="l63.92" class="difflineplus">+add_task(function testReplyToMungedReplyToList() {</span>
<a href="#l63.93"></a><span id="l63.93">   let msg0 = create_message({</span>
<a href="#l63.94"></a><span id="l63.94">     from: &quot;Tester &lt;test@example.com&gt;&quot;,</span>
<a href="#l63.95"></a><span id="l63.95">     to: &quot;munged.list@example.com, someone.else@example.com&quot;,</span>
<a href="#l63.96"></a><span id="l63.96">     subject: &quot;testReplyToMungedReplyToList&quot;,</span>
<a href="#l63.97"></a><span id="l63.97">     clobberHeaders: {</span>
<a href="#l63.98"></a><span id="l63.98">       &quot;Reply-To&quot;: &quot;Munged List &lt;munged.list@example.com&gt;&quot;,</span>
<a href="#l63.99"></a><span id="l63.99">       &quot;List-Post&quot;: &quot;&lt;mailto:munged.list@example.com&gt;&quot;,</span>
<a href="#l63.100"></a><span id="l63.100">     },</span>
<a href="#l63.101"></a><span id="l63.101" class="difflineat">@@ -234,22 +235,22 @@ function testReplyToMungedReplyToList() </span>
<a href="#l63.102"></a><span id="l63.102">       &quot;someone.else@example.com&quot;,</span>
<a href="#l63.103"></a><span id="l63.103">       &quot;Tester &lt;test@example.com&gt;&quot;,</span>
<a href="#l63.104"></a><span id="l63.104">     ],</span>
<a href="#l63.105"></a><span id="l63.105">   });</span>
<a href="#l63.106"></a><span id="l63.106"> </span>
<a href="#l63.107"></a><span id="l63.107">   checkReply(open_compose_with_reply_to_list, {</span>
<a href="#l63.108"></a><span id="l63.108">     addr_to: [&quot;munged.list@example.com&quot;],</span>
<a href="#l63.109"></a><span id="l63.109">   });</span>
<a href="#l63.110"></a><span id="l63.110" class="difflineminus">-}</span>
<a href="#l63.111"></a><span id="l63.111" class="difflineplus">+});</span>
<a href="#l63.112"></a><span id="l63.112"> </span>
<a href="#l63.113"></a><span id="l63.113"> /**</span>
<a href="#l63.114"></a><span id="l63.114">  * Tests that addresses get set properly when doing a normal reply.</span>
<a href="#l63.115"></a><span id="l63.115">  */</span>
<a href="#l63.116"></a><span id="l63.116" class="difflineminus">-function testToCcReply() {</span>
<a href="#l63.117"></a><span id="l63.117" class="difflineplus">+add_task(function testToCcReply() {</span>
<a href="#l63.118"></a><span id="l63.118">   let msg0 = create_message({</span>
<a href="#l63.119"></a><span id="l63.119">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l63.120"></a><span id="l63.120">     to: &quot;Mr Burns &lt;mrburns@example.com&gt;, workers@example.com, &quot; + myEmail,</span>
<a href="#l63.121"></a><span id="l63.121">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l63.122"></a><span id="l63.122">     subject: &quot;testToCcReply - normal mail with to and cc (me in To)&quot;,</span>
<a href="#l63.123"></a><span id="l63.123">   });</span>
<a href="#l63.124"></a><span id="l63.124">   add_message_to_folder(folder, msg0);</span>
<a href="#l63.125"></a><span id="l63.125"> </span>
<a href="#l63.126"></a><span id="l63.126" class="difflineat">@@ -270,22 +271,22 @@ function testToCcReply() {</span>
<a href="#l63.127"></a><span id="l63.127">     // To: From</span>
<a href="#l63.128"></a><span id="l63.128">     // Cc: identity Cc list, including self.</span>
<a href="#l63.129"></a><span id="l63.129">     {</span>
<a href="#l63.130"></a><span id="l63.130">       addr_to: [&quot;Homer &lt;homer@example.com&gt;&quot;],</span>
<a href="#l63.131"></a><span id="l63.131">       addr_cc: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l63.132"></a><span id="l63.132">     }</span>
<a href="#l63.133"></a><span id="l63.133">   );</span>
<a href="#l63.134"></a><span id="l63.134">   stopUsingAutoCc(identity);</span>
<a href="#l63.135"></a><span id="l63.135" class="difflineminus">-}</span>
<a href="#l63.136"></a><span id="l63.136" class="difflineplus">+});</span>
<a href="#l63.137"></a><span id="l63.137"> </span>
<a href="#l63.138"></a><span id="l63.138"> /**</span>
<a href="#l63.139"></a><span id="l63.139">  * Tests that addresses get set properly when doing a normal reply to all.</span>
<a href="#l63.140"></a><span id="l63.140">  */</span>
<a href="#l63.141"></a><span id="l63.141" class="difflineminus">-function testToCcReplyAll() {</span>
<a href="#l63.142"></a><span id="l63.142" class="difflineplus">+add_task(function testToCcReplyAll() {</span>
<a href="#l63.143"></a><span id="l63.143">   let msg0 = create_message({</span>
<a href="#l63.144"></a><span id="l63.144">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l63.145"></a><span id="l63.145">     to: &quot;Mr Burns &lt;mrburns@example.com&gt;, workers@example.com, &quot; + myEmail,</span>
<a href="#l63.146"></a><span id="l63.146">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l63.147"></a><span id="l63.147">     subject: &quot;testToCcReplyAll - normal mail with to and cc (me in To)&quot;,</span>
<a href="#l63.148"></a><span id="l63.148">   });</span>
<a href="#l63.149"></a><span id="l63.149">   add_message_to_folder(folder, msg0);</span>
<a href="#l63.150"></a><span id="l63.150"> </span>
<a href="#l63.151"></a><span id="l63.151" class="difflineat">@@ -318,23 +319,23 @@ function testToCcReplyAll() {</span>
<a href="#l63.152"></a><span id="l63.152">         &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l63.153"></a><span id="l63.153">         &quot;Mr Burns &lt;mrburns@example.com&gt;&quot;,</span>
<a href="#l63.154"></a><span id="l63.154">         &quot;workers@example.com&quot;,</span>
<a href="#l63.155"></a><span id="l63.155">       ],</span>
<a href="#l63.156"></a><span id="l63.156">       addr_cc: [&quot;Lisa &lt;lisa@example.com&gt;&quot;, myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l63.157"></a><span id="l63.157">     }</span>
<a href="#l63.158"></a><span id="l63.158">   );</span>
<a href="#l63.159"></a><span id="l63.159">   stopUsingAutoCc(identity);</span>
<a href="#l63.160"></a><span id="l63.160" class="difflineminus">-}</span>
<a href="#l63.161"></a><span id="l63.161" class="difflineplus">+});</span>
<a href="#l63.162"></a><span id="l63.162"> </span>
<a href="#l63.163"></a><span id="l63.163"> /**</span>
<a href="#l63.164"></a><span id="l63.164">  * Tests that that addresses get set properly when doing a normal reply to all</span>
<a href="#l63.165"></a><span id="l63.165">  * where when recipients aren't all ascii.</span>
<a href="#l63.166"></a><span id="l63.166">  */</span>
<a href="#l63.167"></a><span id="l63.167" class="difflineminus">-function testToCcReplyAllInternational() {</span>
<a href="#l63.168"></a><span id="l63.168" class="difflineplus">+add_task(function testToCcReplyAllInternational() {</span>
<a href="#l63.169"></a><span id="l63.169">   let msg0 = create_message({</span>
<a href="#l63.170"></a><span id="l63.170">     from:</span>
<a href="#l63.171"></a><span id="l63.171">       &quot;Hideaki / =?iso-2022-jp?B?GyRCNUhGIzFRTEAbKEI=?= &lt;hideaki@example.com&gt;&quot;,</span>
<a href="#l63.172"></a><span id="l63.172">     to:</span>
<a href="#l63.173"></a><span id="l63.173">       &quot;Mr Burns &lt;mrburns@example.com&gt;, =?UTF-8?B?w4VrZQ==?= &lt;ake@example.com&gt;, &quot; +</span>
<a href="#l63.174"></a><span id="l63.174">       &quot;=?KOI8-R?Q?=E9=D7=C1=CE?= &lt;ivan@example.com&gt;, &quot; +</span>
<a href="#l63.175"></a><span id="l63.175">       myEmail,</span>
<a href="#l63.176"></a><span id="l63.176">     cc: &quot;=?Big5?B?pP2oca1e?= &lt;xiuying@example.com&gt;&quot;,</span>
<a href="#l63.177"></a><span id="l63.177" class="difflineat">@@ -383,23 +384,23 @@ function testToCcReplyAllInternational()</span>
<a href="#l63.178"></a><span id="l63.178">         &quot;Mr Burns &lt;mrburns@example.com&gt;&quot;,</span>
<a href="#l63.179"></a><span id="l63.179">         &quot;ke &lt;ake@example.com&gt;&quot;,</span>
<a href="#l63.180"></a><span id="l63.180">         &quot; &lt;ivan@example.com&gt;&quot;,</span>
<a href="#l63.181"></a><span id="l63.181">       ],</span>
<a href="#l63.182"></a><span id="l63.182">       addr_cc: [&quot; &lt;xiuying@example.com&gt;&quot;, &quot;sa &lt;asa@example.com&gt;&quot;],</span>
<a href="#l63.183"></a><span id="l63.183">     }</span>
<a href="#l63.184"></a><span id="l63.184">   );</span>
<a href="#l63.185"></a><span id="l63.185">   stopUsingAutoCc(identity);</span>
<a href="#l63.186"></a><span id="l63.186" class="difflineminus">-}</span>
<a href="#l63.187"></a><span id="l63.187" class="difflineplus">+});</span>
<a href="#l63.188"></a><span id="l63.188"> </span>
<a href="#l63.189"></a><span id="l63.189"> /**</span>
<a href="#l63.190"></a><span id="l63.190">  * Tests that that addresses get set properly when doing a reply to a mail with</span>
<a href="#l63.191"></a><span id="l63.191">  * reply-to set.</span>
<a href="#l63.192"></a><span id="l63.192">  */</span>
<a href="#l63.193"></a><span id="l63.193" class="difflineminus">-function testToCcReplyWhenReplyToSet() {</span>
<a href="#l63.194"></a><span id="l63.194" class="difflineplus">+add_task(function testToCcReplyWhenReplyToSet() {</span>
<a href="#l63.195"></a><span id="l63.195">   let msg0 = create_message({</span>
<a href="#l63.196"></a><span id="l63.196">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l63.197"></a><span id="l63.197">     to: &quot;workers@example.com&quot;,</span>
<a href="#l63.198"></a><span id="l63.198">     cc: &quot;Lisa &lt;lisa@example.com&gt;, &quot; + myEmail,</span>
<a href="#l63.199"></a><span id="l63.199">     subject:</span>
<a href="#l63.200"></a><span id="l63.200">       &quot;testToCcReplyWhenReplyToSet - to/cc mail with reply-to set (me in Cc)&quot;,</span>
<a href="#l63.201"></a><span id="l63.201">     clobberHeaders: {</span>
<a href="#l63.202"></a><span id="l63.202">       &quot;Reply-To&quot;: &quot;marge@example.com&quot;,</span>
<a href="#l63.203"></a><span id="l63.203" class="difflineat">@@ -424,23 +425,23 @@ function testToCcReplyWhenReplyToSet() {</span>
<a href="#l63.204"></a><span id="l63.204">     // To: reply-to</span>
<a href="#l63.205"></a><span id="l63.205">     // Cc: auto-Ccs</span>
<a href="#l63.206"></a><span id="l63.206">     {</span>
<a href="#l63.207"></a><span id="l63.207">       addr_to: [&quot;marge@example.com&quot;],</span>
<a href="#l63.208"></a><span id="l63.208">       addr_cc: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l63.209"></a><span id="l63.209">     }</span>
<a href="#l63.210"></a><span id="l63.210">   );</span>
<a href="#l63.211"></a><span id="l63.211">   stopUsingAutoCc(identity);</span>
<a href="#l63.212"></a><span id="l63.212" class="difflineminus">-}</span>
<a href="#l63.213"></a><span id="l63.213" class="difflineplus">+});</span>
<a href="#l63.214"></a><span id="l63.214"> </span>
<a href="#l63.215"></a><span id="l63.215"> /**</span>
<a href="#l63.216"></a><span id="l63.216">  * Tests that addresses get set properly when doing a reply to all for a mail</span>
<a href="#l63.217"></a><span id="l63.217">  * w/ Reply-To.</span>
<a href="#l63.218"></a><span id="l63.218">  */</span>
<a href="#l63.219"></a><span id="l63.219" class="difflineminus">-function testToCcReplyAllWhenReplyToSet() {</span>
<a href="#l63.220"></a><span id="l63.220" class="difflineplus">+add_task(function testToCcReplyAllWhenReplyToSet() {</span>
<a href="#l63.221"></a><span id="l63.221">   let msg0 = create_message({</span>
<a href="#l63.222"></a><span id="l63.222">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l63.223"></a><span id="l63.223">     to: &quot;workers@example.com&quot;,</span>
<a href="#l63.224"></a><span id="l63.224">     cc: &quot;Lisa &lt;lisa@example.com&gt;, &quot; + myEmail,</span>
<a href="#l63.225"></a><span id="l63.225">     subject:</span>
<a href="#l63.226"></a><span id="l63.226">       &quot;testToCcReplyAllWhenReplyToSet - to/cc mail with reply-to set (me in Cc)&quot;,</span>
<a href="#l63.227"></a><span id="l63.227">     clobberHeaders: {</span>
<a href="#l63.228"></a><span id="l63.228">       &quot;Reply-To&quot;: &quot;marge@example.com&quot;,</span>
<a href="#l63.229"></a><span id="l63.229" class="difflineat">@@ -469,22 +470,22 @@ function testToCcReplyAllWhenReplyToSet(</span>
<a href="#l63.230"></a><span id="l63.230">     // To: Reply-To + Tos</span>
<a href="#l63.231"></a><span id="l63.231">     // Cc: original Ccs + auto-Ccs (which includes me!)</span>
<a href="#l63.232"></a><span id="l63.232">     {</span>
<a href="#l63.233"></a><span id="l63.233">       addr_to: [&quot;marge@example.com&quot;, &quot;workers@example.com&quot;],</span>
<a href="#l63.234"></a><span id="l63.234">       addr_cc: [&quot;Lisa &lt;lisa@example.com&gt;&quot;, myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l63.235"></a><span id="l63.235">     }</span>
<a href="#l63.236"></a><span id="l63.236">   );</span>
<a href="#l63.237"></a><span id="l63.237">   stopUsingAutoCc(identity);</span>
<a href="#l63.238"></a><span id="l63.238" class="difflineminus">-}</span>
<a href="#l63.239"></a><span id="l63.239" class="difflineplus">+});</span>
<a href="#l63.240"></a><span id="l63.240"> </span>
<a href="#l63.241"></a><span id="l63.241"> /**</span>
<a href="#l63.242"></a><span id="l63.242">  * Tests that addresses get set properly when doing a reply to list.</span>
<a href="#l63.243"></a><span id="l63.243">  */</span>
<a href="#l63.244"></a><span id="l63.244" class="difflineminus">-function testReplyToList() {</span>
<a href="#l63.245"></a><span id="l63.245" class="difflineplus">+add_task(function testReplyToList() {</span>
<a href="#l63.246"></a><span id="l63.246">   let msg0 = create_message({</span>
<a href="#l63.247"></a><span id="l63.247">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l63.248"></a><span id="l63.248">     to: &quot;workers-list@example.com&quot;,</span>
<a href="#l63.249"></a><span id="l63.249">     cc: &quot;Lisa &lt;lisa@example.com&gt;, &quot; + myEmail,</span>
<a href="#l63.250"></a><span id="l63.250">     subject: &quot;testReplyToList - mailing list message (me in Cc)&quot;,</span>
<a href="#l63.251"></a><span id="l63.251">     clobberHeaders: {</span>
<a href="#l63.252"></a><span id="l63.252">       &quot;List-Post&quot;: &quot;&lt;mailto:workers-list@example.com&gt;&quot;,</span>
<a href="#l63.253"></a><span id="l63.253">     },</span>
<a href="#l63.254"></a><span id="l63.254" class="difflineat">@@ -508,23 +509,23 @@ function testReplyToList() {</span>
<a href="#l63.255"></a><span id="l63.255">     // To: the list</span>
<a href="#l63.256"></a><span id="l63.256">     // Cc: auto-Ccs</span>
<a href="#l63.257"></a><span id="l63.257">     {</span>
<a href="#l63.258"></a><span id="l63.258">       addr_to: [&quot;workers-list@example.com&quot;],</span>
<a href="#l63.259"></a><span id="l63.259">       addr_cc: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l63.260"></a><span id="l63.260">     }</span>
<a href="#l63.261"></a><span id="l63.261">   );</span>
<a href="#l63.262"></a><span id="l63.262">   stopUsingAutoCc(identity);</span>
<a href="#l63.263"></a><span id="l63.263" class="difflineminus">-}</span>
<a href="#l63.264"></a><span id="l63.264" class="difflineplus">+});</span>
<a href="#l63.265"></a><span id="l63.265"> </span>
<a href="#l63.266"></a><span id="l63.266"> /**</span>
<a href="#l63.267"></a><span id="l63.267">  * Tests that addresses get set properly when doing a reply to sender for a</span>
<a href="#l63.268"></a><span id="l63.268">  * list post.</span>
<a href="#l63.269"></a><span id="l63.269">  */</span>
<a href="#l63.270"></a><span id="l63.270" class="difflineminus">-function testReplySenderForListPost() {</span>
<a href="#l63.271"></a><span id="l63.271" class="difflineplus">+add_task(function testReplySenderForListPost() {</span>
<a href="#l63.272"></a><span id="l63.272">   let msg0 = create_message({</span>
<a href="#l63.273"></a><span id="l63.273">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l63.274"></a><span id="l63.274">     to: &quot;workers-list@example.com&quot;,</span>
<a href="#l63.275"></a><span id="l63.275">     cc: &quot;Lisa &lt;lisa@example.com&gt;, &quot; + myEmail,</span>
<a href="#l63.276"></a><span id="l63.276">     subject: &quot;testReplySenderForListPost - mailing list message (me in Cc)&quot;,</span>
<a href="#l63.277"></a><span id="l63.277">     clobberHeaders: {</span>
<a href="#l63.278"></a><span id="l63.278">       &quot;List-Post&quot;: &quot;&lt;mailto:workers-list@example.com&gt;&quot;,</span>
<a href="#l63.279"></a><span id="l63.279">     },</span>
<a href="#l63.280"></a><span id="l63.280" class="difflineat">@@ -548,22 +549,22 @@ function testReplySenderForListPost() {</span>
<a href="#l63.281"></a><span id="l63.281">     // To: From</span>
<a href="#l63.282"></a><span id="l63.282">     // Cc: auto-Ccs</span>
<a href="#l63.283"></a><span id="l63.283">     {</span>
<a href="#l63.284"></a><span id="l63.284">       addr_to: [&quot;Homer &lt;homer@example.com&gt;&quot;],</span>
<a href="#l63.285"></a><span id="l63.285">       addr_cc: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l63.286"></a><span id="l63.286">     }</span>
<a href="#l63.287"></a><span id="l63.287">   );</span>
<a href="#l63.288"></a><span id="l63.288">   stopUsingAutoCc(identity);</span>
<a href="#l63.289"></a><span id="l63.289" class="difflineminus">-}</span>
<a href="#l63.290"></a><span id="l63.290" class="difflineplus">+});</span>
<a href="#l63.291"></a><span id="l63.291"> </span>
<a href="#l63.292"></a><span id="l63.292"> /**</span>
<a href="#l63.293"></a><span id="l63.293">  * Tests that addresses get set properly when doing a reply all to a list post.</span>
<a href="#l63.294"></a><span id="l63.294">  */</span>
<a href="#l63.295"></a><span id="l63.295" class="difflineminus">-function testReplyToAllForListPost() {</span>
<a href="#l63.296"></a><span id="l63.296" class="difflineplus">+add_task(function testReplyToAllForListPost() {</span>
<a href="#l63.297"></a><span id="l63.297">   let msg0 = create_message({</span>
<a href="#l63.298"></a><span id="l63.298">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l63.299"></a><span id="l63.299">     to: &quot;workers-list@example.com&quot;,</span>
<a href="#l63.300"></a><span id="l63.300">     cc: &quot;Lisa &lt;lisa@example.com&gt;, &quot; + myEmail,</span>
<a href="#l63.301"></a><span id="l63.301">     subject: &quot;testReplyToAllForListPost - mailing list message (me in Cc)&quot;,</span>
<a href="#l63.302"></a><span id="l63.302">     clobberHeaders: {</span>
<a href="#l63.303"></a><span id="l63.303">       &quot;List-Post&quot;: &quot;&lt;mailto:workers-list@example.com&gt;&quot;,</span>
<a href="#l63.304"></a><span id="l63.304">     },</span>
<a href="#l63.305"></a><span id="l63.305" class="difflineat">@@ -591,23 +592,23 @@ function testReplyToAllForListPost() {</span>
<a href="#l63.306"></a><span id="l63.306">     // To: From + original To</span>
<a href="#l63.307"></a><span id="l63.307">     // Cc: original CC + auto-Ccs (including me!)</span>
<a href="#l63.308"></a><span id="l63.308">     {</span>
<a href="#l63.309"></a><span id="l63.309">       addr_to: [&quot;Homer &lt;homer@example.com&gt;&quot;, &quot;workers-list@example.com&quot;],</span>
<a href="#l63.310"></a><span id="l63.310">       addr_cc: [&quot;Lisa &lt;lisa@example.com&gt;&quot;, myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l63.311"></a><span id="l63.311">     }</span>
<a href="#l63.312"></a><span id="l63.312">   );</span>
<a href="#l63.313"></a><span id="l63.313">   stopUsingAutoCc(identity);</span>
<a href="#l63.314"></a><span id="l63.314" class="difflineminus">-}</span>
<a href="#l63.315"></a><span id="l63.315" class="difflineplus">+});</span>
<a href="#l63.316"></a><span id="l63.316"> </span>
<a href="#l63.317"></a><span id="l63.317"> /**</span>
<a href="#l63.318"></a><span id="l63.318">  * Tests that addresses get set properly when doing a reply to all for a list</span>
<a href="#l63.319"></a><span id="l63.319">  * post when also reply-to is set.</span>
<a href="#l63.320"></a><span id="l63.320">  */</span>
<a href="#l63.321"></a><span id="l63.321" class="difflineminus">-function testReplyToListWhenReplyToSet() {</span>
<a href="#l63.322"></a><span id="l63.322" class="difflineplus">+add_task(function testReplyToListWhenReplyToSet() {</span>
<a href="#l63.323"></a><span id="l63.323">   let msg0 = create_message({</span>
<a href="#l63.324"></a><span id="l63.324">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l63.325"></a><span id="l63.325">     to: &quot;workers-list@example.com, &quot; + myEmail,</span>
<a href="#l63.326"></a><span id="l63.326">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l63.327"></a><span id="l63.327">     subject:</span>
<a href="#l63.328"></a><span id="l63.328">       &quot;testReplyToListWhenReplyToSet - mailing list message w/ cc, reply-to (me in To)&quot;,</span>
<a href="#l63.329"></a><span id="l63.329">     clobberHeaders: {</span>
<a href="#l63.330"></a><span id="l63.330">       &quot;Reply-To&quot;: &quot;marge@example.com&quot;,</span>
<a href="#l63.331"></a><span id="l63.331" class="difflineat">@@ -637,24 +638,24 @@ function testReplyToListWhenReplyToSet()</span>
<a href="#l63.332"></a><span id="l63.332">     // To: Reply-To, original Tos</span>
<a href="#l63.333"></a><span id="l63.333">     // Cc: original Cc + auto-Ccs</span>
<a href="#l63.334"></a><span id="l63.334">     {</span>
<a href="#l63.335"></a><span id="l63.335">       addr_to: [&quot;marge@example.com&quot;, &quot;workers-list@example.com&quot;],</span>
<a href="#l63.336"></a><span id="l63.336">       addr_cc: [&quot;Lisa &lt;lisa@example.com&gt;&quot;, myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l63.337"></a><span id="l63.337">     }</span>
<a href="#l63.338"></a><span id="l63.338">   );</span>
<a href="#l63.339"></a><span id="l63.339">   stopUsingAutoCc(identity);</span>
<a href="#l63.340"></a><span id="l63.340" class="difflineminus">-}</span>
<a href="#l63.341"></a><span id="l63.341" class="difflineplus">+});</span>
<a href="#l63.342"></a><span id="l63.342"> </span>
<a href="#l63.343"></a><span id="l63.343"> /**</span>
<a href="#l63.344"></a><span id="l63.344">  * Test that addresses get set properly for Mail-Reply-To. Mail-Reply-To should</span>
<a href="#l63.345"></a><span id="l63.345">  * be used for reply to author, if present.</span>
<a href="#l63.346"></a><span id="l63.346">  * @see http://cr.yp.to/proto/replyto.html</span>
<a href="#l63.347"></a><span id="l63.347">  */</span>
<a href="#l63.348"></a><span id="l63.348" class="difflineminus">-function testMailReplyTo() {</span>
<a href="#l63.349"></a><span id="l63.349" class="difflineplus">+add_task(function testMailReplyTo() {</span>
<a href="#l63.350"></a><span id="l63.350">   let msg0 = create_message({</span>
<a href="#l63.351"></a><span id="l63.351">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l63.352"></a><span id="l63.352">     to: &quot;workers-list@example.com&quot;,</span>
<a href="#l63.353"></a><span id="l63.353">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l63.354"></a><span id="l63.354">     subject: &quot;testMailReplyTo - mail with Mail-Reply-To header&quot;,</span>
<a href="#l63.355"></a><span id="l63.355">     clobberHeaders: {</span>
<a href="#l63.356"></a><span id="l63.356">       &quot;Reply-To&quot;: &quot;workers-list@example.com&quot;, // reply-to munging</span>
<a href="#l63.357"></a><span id="l63.357">       &quot;Mail-Reply-To&quot;: &quot;Homer S. &lt;homer@example.com&gt;&quot;,</span>
<a href="#l63.358"></a><span id="l63.358" class="difflineat">@@ -679,24 +680,24 @@ function testMailReplyTo() {</span>
<a href="#l63.359"></a><span id="l63.359">     // To: Mail-Reply-To</span>
<a href="#l63.360"></a><span id="l63.360">     // Cc: auto-Ccs</span>
<a href="#l63.361"></a><span id="l63.361">     {</span>
<a href="#l63.362"></a><span id="l63.362">       addr_to: [&quot;Homer S. &lt;homer@example.com&gt;&quot;],</span>
<a href="#l63.363"></a><span id="l63.363">       addr_cc: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l63.364"></a><span id="l63.364">     }</span>
<a href="#l63.365"></a><span id="l63.365">   );</span>
<a href="#l63.366"></a><span id="l63.366">   stopUsingAutoCc(identity);</span>
<a href="#l63.367"></a><span id="l63.367" class="difflineminus">-}</span>
<a href="#l63.368"></a><span id="l63.368" class="difflineplus">+});</span>
<a href="#l63.369"></a><span id="l63.369"> </span>
<a href="#l63.370"></a><span id="l63.370"> /**</span>
<a href="#l63.371"></a><span id="l63.371">  * Test that addresses get set properly Mail-Followup-To. Mail-Followup-To</span>
<a href="#l63.372"></a><span id="l63.372">  * should be the default recipient list for reply-all, if present.</span>
<a href="#l63.373"></a><span id="l63.373">  * @see http://cr.yp.to/proto/replyto.html</span>
<a href="#l63.374"></a><span id="l63.374">  */</span>
<a href="#l63.375"></a><span id="l63.375" class="difflineminus">-function testMailFollowupTo() {</span>
<a href="#l63.376"></a><span id="l63.376" class="difflineplus">+add_task(function testMailFollowupTo() {</span>
<a href="#l63.377"></a><span id="l63.377">   let msg0 = create_message({</span>
<a href="#l63.378"></a><span id="l63.378">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l63.379"></a><span id="l63.379">     to: &quot;workers-list@example.com, &quot; + myEmail,</span>
<a href="#l63.380"></a><span id="l63.380">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l63.381"></a><span id="l63.381">     subject: &quot;testMailFollowupTo - mail with Mail-Followup-To header&quot;,</span>
<a href="#l63.382"></a><span id="l63.382">     clobberHeaders: {</span>
<a href="#l63.383"></a><span id="l63.383">       // Homer is on the list, and don't want extra copies, so he has</span>
<a href="#l63.384"></a><span id="l63.384">       // set the Mail-Followup-To header so followups go to the list.</span>
<a href="#l63.385"></a><span id="l63.385" class="difflineat">@@ -722,22 +723,22 @@ function testMailFollowupTo() {</span>
<a href="#l63.386"></a><span id="l63.386">     // To: Mail-Followup-To</span>
<a href="#l63.387"></a><span id="l63.387">     // Cc: auto-Ccs</span>
<a href="#l63.388"></a><span id="l63.388">     {</span>
<a href="#l63.389"></a><span id="l63.389">       addr_to: [&quot;workers-list@example.com&quot;],</span>
<a href="#l63.390"></a><span id="l63.390">       addr_cc: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l63.391"></a><span id="l63.391">     }</span>
<a href="#l63.392"></a><span id="l63.392">   );</span>
<a href="#l63.393"></a><span id="l63.393">   stopUsingAutoCc(identity);</span>
<a href="#l63.394"></a><span id="l63.394" class="difflineminus">-}</span>
<a href="#l63.395"></a><span id="l63.395" class="difflineplus">+});</span>
<a href="#l63.396"></a><span id="l63.396"> </span>
<a href="#l63.397"></a><span id="l63.397"> /**</span>
<a href="#l63.398"></a><span id="l63.398">  * Tests that addresses get set properly for reply to self.</span>
<a href="#l63.399"></a><span id="l63.399">  */</span>
<a href="#l63.400"></a><span id="l63.400" class="difflineminus">-function testReplyToSelfReply() {</span>
<a href="#l63.401"></a><span id="l63.401" class="difflineplus">+add_task(function testReplyToSelfReply() {</span>
<a href="#l63.402"></a><span id="l63.402">   let msg0 = create_message({</span>
<a href="#l63.403"></a><span id="l63.403">     from: myEmail,</span>
<a href="#l63.404"></a><span id="l63.404">     to: &quot;Bart &lt;bart@example.com&gt;, Maggie &lt;maggie@example.com&gt;&quot;,</span>
<a href="#l63.405"></a><span id="l63.405">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l63.406"></a><span id="l63.406">     subject: &quot;testReplyToSelfReply - reply to self&quot;,</span>
<a href="#l63.407"></a><span id="l63.407">     clobberHeaders: {</span>
<a href="#l63.408"></a><span id="l63.408">       Bcc: &quot;Moe &lt;moe@example.com&gt;&quot;,</span>
<a href="#l63.409"></a><span id="l63.409">       &quot;Reply-To&quot;: &quot;Flanders &lt;flanders@example.com&gt;&quot;,</span>
<a href="#l63.410"></a><span id="l63.410" class="difflineat">@@ -768,23 +769,23 @@ function testReplyToSelfReply() {</span>
<a href="#l63.411"></a><span id="l63.411">     // Reply-To: original Reply-To</span>
<a href="#l63.412"></a><span id="l63.412">     {</span>
<a href="#l63.413"></a><span id="l63.413">       addr_to: [&quot;Bart &lt;bart@example.com&gt;&quot;, &quot;Maggie &lt;maggie@example.com&gt;&quot;],</span>
<a href="#l63.414"></a><span id="l63.414">       addr_cc: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l63.415"></a><span id="l63.415">       addr_reply: [&quot;Flanders &lt;flanders@example.com&gt;&quot;],</span>
<a href="#l63.416"></a><span id="l63.416">     }</span>
<a href="#l63.417"></a><span id="l63.417">   );</span>
<a href="#l63.418"></a><span id="l63.418">   stopUsingAutoCc(identity);</span>
<a href="#l63.419"></a><span id="l63.419" class="difflineminus">-}</span>
<a href="#l63.420"></a><span id="l63.420" class="difflineplus">+});</span>
<a href="#l63.421"></a><span id="l63.421"> </span>
<a href="#l63.422"></a><span id="l63.422"> /**</span>
<a href="#l63.423"></a><span id="l63.423">  * Tests that addresses get set properly for a reply all to self - this should</span>
<a href="#l63.424"></a><span id="l63.424">  * be treated as a followup.</span>
<a href="#l63.425"></a><span id="l63.425">  */</span>
<a href="#l63.426"></a><span id="l63.426" class="difflineminus">-function testReplyToSelfReplyAll() {</span>
<a href="#l63.427"></a><span id="l63.427" class="difflineplus">+add_task(function testReplyToSelfReplyAll() {</span>
<a href="#l63.428"></a><span id="l63.428">   let msg0 = create_message({</span>
<a href="#l63.429"></a><span id="l63.429">     from: myEmail,</span>
<a href="#l63.430"></a><span id="l63.430">     to: &quot;Bart &lt;bart@example.com&gt;, Maggie &lt;maggie@example.com&gt;&quot;,</span>
<a href="#l63.431"></a><span id="l63.431">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l63.432"></a><span id="l63.432">     subject: &quot;testReplyToSelfReplyAll - reply to self&quot;,</span>
<a href="#l63.433"></a><span id="l63.433">     clobberHeaders: {</span>
<a href="#l63.434"></a><span id="l63.434">       Bcc: &quot;Moe &lt;moe@example.com&gt;&quot;,</span>
<a href="#l63.435"></a><span id="l63.435">       &quot;Reply-To&quot;: &quot;Flanders &lt;flanders@example.com&gt;&quot;,</span>
<a href="#l63.436"></a><span id="l63.436" class="difflineat">@@ -823,24 +824,24 @@ function testReplyToSelfReplyAll() {</span>
<a href="#l63.437"></a><span id="l63.437">       addr_to: [&quot;Bart &lt;bart@example.com&gt;&quot;, &quot;Maggie &lt;maggie@example.com&gt;&quot;],</span>
<a href="#l63.438"></a><span id="l63.438">       addr_cc: [&quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l63.439"></a><span id="l63.439">       addr_bcc: [&quot;Moe &lt;moe@example.com&gt;&quot;],</span>
<a href="#l63.440"></a><span id="l63.440">       addr_reply: [&quot;Flanders &lt;flanders@example.com&gt;&quot;],</span>
<a href="#l63.441"></a><span id="l63.441">     }</span>
<a href="#l63.442"></a><span id="l63.442">   );</span>
<a href="#l63.443"></a><span id="l63.443">   stopUsingAutoCc(identity);</span>
<a href="#l63.444"></a><span id="l63.444">   stopUsingAutoBcc(identity);</span>
<a href="#l63.445"></a><span id="l63.445" class="difflineminus">-}</span>
<a href="#l63.446"></a><span id="l63.446" class="difflineplus">+});</span>
<a href="#l63.447"></a><span id="l63.447"> </span>
<a href="#l63.448"></a><span id="l63.448"> /**</span>
<a href="#l63.449"></a><span id="l63.449">  * Tests that addresses get set properly for a reply all to self - but for a</span>
<a href="#l63.450"></a><span id="l63.450">  * message that is not really the original sent message. Like an auto-bcc:d copy</span>
<a href="#l63.451"></a><span id="l63.451">  * or from Gmail. This should be treated as a followup.</span>
<a href="#l63.452"></a><span id="l63.452">  */</span>
<a href="#l63.453"></a><span id="l63.453" class="difflineminus">-function testReplyToSelfNotOriginalSourceMsgReplyAll() {</span>
<a href="#l63.454"></a><span id="l63.454" class="difflineplus">+add_task(function testReplyToSelfNotOriginalSourceMsgReplyAll() {</span>
<a href="#l63.455"></a><span id="l63.455">   let msg0 = create_message({</span>
<a href="#l63.456"></a><span id="l63.456">     from: myEmail2,</span>
<a href="#l63.457"></a><span id="l63.457">     to: &quot;Bart &lt;bart@example.com&gt;, Maggie &lt;maggie@example.com&gt;&quot;,</span>
<a href="#l63.458"></a><span id="l63.458">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l63.459"></a><span id="l63.459">     subject: &quot;testReplyToSelfNotOriginalSourceMsgReplyAll - reply to self&quot;,</span>
<a href="#l63.460"></a><span id="l63.460">     clobberHeaders: {</span>
<a href="#l63.461"></a><span id="l63.461">       &quot;Reply-To&quot;: &quot;Flanders &lt;flanders@example.com&gt;&quot;,</span>
<a href="#l63.462"></a><span id="l63.462">     },</span>
<a href="#l63.463"></a><span id="l63.463" class="difflineat">@@ -896,23 +897,23 @@ function testReplyToSelfNotOriginalSourc</span>
<a href="#l63.464"></a><span id="l63.464">     {</span>
<a href="#l63.465"></a><span id="l63.465">       addr_to: [&quot;Bart &lt;bart@example.com&gt;&quot;, &quot;Maggie &lt;maggie@example.com&gt;&quot;],</span>
<a href="#l63.466"></a><span id="l63.466">       addr_cc: [&quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l63.467"></a><span id="l63.467">       addr_bcc: [myEmail2, &quot;smithers@example.com&quot;],</span>
<a href="#l63.468"></a><span id="l63.468">       addr_reply: [&quot;Flanders &lt;flanders@example.com&gt;&quot;],</span>
<a href="#l63.469"></a><span id="l63.469">     }</span>
<a href="#l63.470"></a><span id="l63.470">   );</span>
<a href="#l63.471"></a><span id="l63.471">   stopUsingAutoBcc(identity2);</span>
<a href="#l63.472"></a><span id="l63.472" class="difflineminus">-}</span>
<a href="#l63.473"></a><span id="l63.473" class="difflineplus">+});</span>
<a href="#l63.474"></a><span id="l63.474"> </span>
<a href="#l63.475"></a><span id="l63.475"> /**</span>
<a href="#l63.476"></a><span id="l63.476">  * Tests that a reply to an other identity isn't treated as a reply to self</span>
<a href="#l63.477"></a><span id="l63.477">  * followup.</span>
<a href="#l63.478"></a><span id="l63.478">  */</span>
<a href="#l63.479"></a><span id="l63.479" class="difflineminus">-function testReplyToOtherIdentity() {</span>
<a href="#l63.480"></a><span id="l63.480" class="difflineplus">+add_task(function testReplyToOtherIdentity() {</span>
<a href="#l63.481"></a><span id="l63.481">   let msg0 = create_message({</span>
<a href="#l63.482"></a><span id="l63.482">     from: myEmail,</span>
<a href="#l63.483"></a><span id="l63.483">     to: myEmail2 + &quot;, barney@example.com&quot;,</span>
<a href="#l63.484"></a><span id="l63.484">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l63.485"></a><span id="l63.485">     subject: &quot;testReplyToOtherIdentity - reply to other identity&quot;,</span>
<a href="#l63.486"></a><span id="l63.486">     clobberHeaders: {</span>
<a href="#l63.487"></a><span id="l63.487">       &quot;Reply-To&quot;: &quot;secretary@example.com&quot;,</span>
<a href="#l63.488"></a><span id="l63.488">     },</span>
<a href="#l63.489"></a><span id="l63.489" class="difflineat">@@ -930,23 +931,23 @@ function testReplyToOtherIdentity() {</span>
<a href="#l63.490"></a><span id="l63.490">     // To: from + to (except me2)</span>
<a href="#l63.491"></a><span id="l63.491">     // Cc: original Cc</span>
<a href="#l63.492"></a><span id="l63.492">     //</span>
<a href="#l63.493"></a><span id="l63.493">     {</span>
<a href="#l63.494"></a><span id="l63.494">       addr_to: [&quot;secretary@example.com&quot;, &quot;barney@example.com&quot;],</span>
<a href="#l63.495"></a><span id="l63.495">       addr_cc: [&quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l63.496"></a><span id="l63.496">     }</span>
<a href="#l63.497"></a><span id="l63.497">   );</span>
<a href="#l63.498"></a><span id="l63.498" class="difflineminus">-}</span>
<a href="#l63.499"></a><span id="l63.499" class="difflineplus">+});</span>
<a href="#l63.500"></a><span id="l63.500"> </span>
<a href="#l63.501"></a><span id="l63.501"> /**</span>
<a href="#l63.502"></a><span id="l63.502">  * Tests that addresses get set properly for a reply all to self w/ bccs -</span>
<a href="#l63.503"></a><span id="l63.503">  * this should be treated as a followup.</span>
<a href="#l63.504"></a><span id="l63.504">  */</span>
<a href="#l63.505"></a><span id="l63.505" class="difflineminus">-function testReplyToSelfWithBccs() {</span>
<a href="#l63.506"></a><span id="l63.506" class="difflineplus">+add_task(function testReplyToSelfWithBccs() {</span>
<a href="#l63.507"></a><span id="l63.507">   let msg0 = create_message({</span>
<a href="#l63.508"></a><span id="l63.508">     from: myEmail,</span>
<a href="#l63.509"></a><span id="l63.509">     to: myEmail,</span>
<a href="#l63.510"></a><span id="l63.510">     cc: myEmail2 + &quot;, Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l63.511"></a><span id="l63.511">     subject: &quot;testReplyToSelfWithBccs - reply to self&quot;,</span>
<a href="#l63.512"></a><span id="l63.512">     clobberHeaders: {</span>
<a href="#l63.513"></a><span id="l63.513">       Bcc: &quot;Moe &lt;moe@example.com&gt;, Barney &lt;barney@example.com&gt;&quot;,</span>
<a href="#l63.514"></a><span id="l63.514">       &quot;Reply-To&quot;: myEmail2,</span>
<a href="#l63.515"></a><span id="l63.515" class="difflineat">@@ -967,23 +968,23 @@ function testReplyToSelfWithBccs() {</span>
<a href="#l63.516"></a><span id="l63.516">     // Reply-To: original Reply-To</span>
<a href="#l63.517"></a><span id="l63.517">     {</span>
<a href="#l63.518"></a><span id="l63.518">       addr_to: [myEmail],</span>
<a href="#l63.519"></a><span id="l63.519">       addr_cc: [myEmail2, &quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l63.520"></a><span id="l63.520">       addr_bcc: [&quot;Moe &lt;moe@example.com&gt;&quot;, &quot;Barney &lt;barney@example.com&gt;&quot;],</span>
<a href="#l63.521"></a><span id="l63.521">       addr_reply: [myEmail2],</span>
<a href="#l63.522"></a><span id="l63.522">     }</span>
<a href="#l63.523"></a><span id="l63.523">   );</span>
<a href="#l63.524"></a><span id="l63.524" class="difflineminus">-}</span>
<a href="#l63.525"></a><span id="l63.525" class="difflineplus">+});</span>
<a href="#l63.526"></a><span id="l63.526"> </span>
<a href="#l63.527"></a><span id="l63.527"> /**</span>
<a href="#l63.528"></a><span id="l63.528">  * Tests that addresses get set properly for a reply all to other identity w/ bccs -</span>
<a href="#l63.529"></a><span id="l63.529">  * this be treated as a followup.</span>
<a href="#l63.530"></a><span id="l63.530">  */</span>
<a href="#l63.531"></a><span id="l63.531" class="difflineminus">-function testReplyToOtherIdentityWithBccs() {</span>
<a href="#l63.532"></a><span id="l63.532" class="difflineplus">+add_task(function testReplyToOtherIdentityWithBccs() {</span>
<a href="#l63.533"></a><span id="l63.533">   let msg0 = create_message({</span>
<a href="#l63.534"></a><span id="l63.534">     from: myEmail,</span>
<a href="#l63.535"></a><span id="l63.535">     to: myEmail2,</span>
<a href="#l63.536"></a><span id="l63.536">     cc: &quot;Lisa &lt;lisa@example.com&gt;&quot;,</span>
<a href="#l63.537"></a><span id="l63.537">     subject: &quot;testReplyToOtherIdentityWithBccs - reply to other identity&quot;,</span>
<a href="#l63.538"></a><span id="l63.538">     clobberHeaders: {</span>
<a href="#l63.539"></a><span id="l63.539">       Bcc: &quot;Moe &lt;moe@example.com&gt;, Barney &lt;barney@example.com&gt;&quot;,</span>
<a href="#l63.540"></a><span id="l63.540">     },</span>
<a href="#l63.541"></a><span id="l63.541" class="difflineat">@@ -1001,22 +1002,22 @@ function testReplyToOtherIdentityWithBcc</span>
<a href="#l63.542"></a><span id="l63.542">     // Cc: original Cc</span>
<a href="#l63.543"></a><span id="l63.543">     // Bcc: original Bcc</span>
<a href="#l63.544"></a><span id="l63.544">     {</span>
<a href="#l63.545"></a><span id="l63.545">       addr_to: [myEmail2],</span>
<a href="#l63.546"></a><span id="l63.546">       addr_cc: [&quot;Lisa &lt;lisa@example.com&gt;&quot;],</span>
<a href="#l63.547"></a><span id="l63.547">       addr_bcc: [&quot;Moe &lt;moe@example.com&gt;&quot;, &quot;Barney &lt;barney@example.com&gt;&quot;],</span>
<a href="#l63.548"></a><span id="l63.548">     }</span>
<a href="#l63.549"></a><span id="l63.549">   );</span>
<a href="#l63.550"></a><span id="l63.550" class="difflineminus">-}</span>
<a href="#l63.551"></a><span id="l63.551" class="difflineplus">+});</span>
<a href="#l63.552"></a><span id="l63.552"> </span>
<a href="#l63.553"></a><span id="l63.553"> /**</span>
<a href="#l63.554"></a><span id="l63.554">  * Tests that addresses get set properly for a nntp reply-all.</span>
<a href="#l63.555"></a><span id="l63.555">  */</span>
<a href="#l63.556"></a><span id="l63.556" class="difflineminus">-function testNewsgroupsReplyAll() {</span>
<a href="#l63.557"></a><span id="l63.557" class="difflineplus">+add_task(function testNewsgroupsReplyAll() {</span>
<a href="#l63.558"></a><span id="l63.558">   let msg0 = create_message({</span>
<a href="#l63.559"></a><span id="l63.559">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l63.560"></a><span id="l63.560">     to: &quot;test1-list@example.org&quot;,</span>
<a href="#l63.561"></a><span id="l63.561">     subject: &quot;testNewsgroupsReplyAll - sent to two newsgroups and a list&quot;,</span>
<a href="#l63.562"></a><span id="l63.562">     clobberHeaders: {</span>
<a href="#l63.563"></a><span id="l63.563">       Newsgroups: &quot;example.test1, example.test2&quot;,</span>
<a href="#l63.564"></a><span id="l63.564">     },</span>
<a href="#l63.565"></a><span id="l63.565">   });</span>
<a href="#l63.566"></a><span id="l63.566" class="difflineat">@@ -1044,23 +1045,23 @@ function testNewsgroupsReplyAll() {</span>
<a href="#l63.567"></a><span id="l63.567">     // Newsgroups: original Ccs</span>
<a href="#l63.568"></a><span id="l63.568">     {</span>
<a href="#l63.569"></a><span id="l63.569">       addr_to: [&quot;Homer &lt;homer@example.com&gt;&quot;, &quot;test1-list@example.org&quot;],</span>
<a href="#l63.570"></a><span id="l63.570">       addr_cc: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l63.571"></a><span id="l63.571">       addr_newsgroups: [&quot;example.test1&quot;, &quot;example.test2&quot;],</span>
<a href="#l63.572"></a><span id="l63.572">     }</span>
<a href="#l63.573"></a><span id="l63.573">   );</span>
<a href="#l63.574"></a><span id="l63.574">   stopUsingAutoCc(identity);</span>
<a href="#l63.575"></a><span id="l63.575" class="difflineminus">-}</span>
<a href="#l63.576"></a><span id="l63.576" class="difflineplus">+});</span>
<a href="#l63.577"></a><span id="l63.577"> </span>
<a href="#l63.578"></a><span id="l63.578"> /**</span>
<a href="#l63.579"></a><span id="l63.579">  * Tests that addresses get set properly for an nntp followup, when Followup-To</span>
<a href="#l63.580"></a><span id="l63.580">  * is set.</span>
<a href="#l63.581"></a><span id="l63.581">  */</span>
<a href="#l63.582"></a><span id="l63.582" class="difflineminus">-function testNewsgroupsReplyAllFollowupTo() {</span>
<a href="#l63.583"></a><span id="l63.583" class="difflineplus">+add_task(function testNewsgroupsReplyAllFollowupTo() {</span>
<a href="#l63.584"></a><span id="l63.584">   let msg0 = create_message({</span>
<a href="#l63.585"></a><span id="l63.585">     from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l63.586"></a><span id="l63.586">     to: &quot;test1-list@example.org, &quot; + myEmail,</span>
<a href="#l63.587"></a><span id="l63.587">     subject: &quot;testNewsgroupsReplyAllFollowupTo - Followup-To set&quot;,</span>
<a href="#l63.588"></a><span id="l63.588">     clobberHeaders: {</span>
<a href="#l63.589"></a><span id="l63.589">       Newsgroups: &quot;example.test1, example.test2&quot;,</span>
<a href="#l63.590"></a><span id="l63.590">       &quot;Followup-To&quot;: &quot;example.test2&quot;,</span>
<a href="#l63.591"></a><span id="l63.591">     },</span>
<a href="#l63.592"></a><span id="l63.592" class="difflineat">@@ -1090,23 +1091,23 @@ function testNewsgroupsReplyAllFollowupT</span>
<a href="#l63.593"></a><span id="l63.593">     // Newsgroups: &lt;Followup-To&gt;</span>
<a href="#l63.594"></a><span id="l63.594">     {</span>
<a href="#l63.595"></a><span id="l63.595">       addr_to: [&quot;Homer &lt;homer@example.com&gt;&quot;, &quot;test1-list@example.org&quot;],</span>
<a href="#l63.596"></a><span id="l63.596">       addr_cc: [myEmail, &quot;smithers@example.com&quot;],</span>
<a href="#l63.597"></a><span id="l63.597">       addr_newsgroups: [&quot;example.test2&quot;],</span>
<a href="#l63.598"></a><span id="l63.598">     }</span>
<a href="#l63.599"></a><span id="l63.599">   );</span>
<a href="#l63.600"></a><span id="l63.600">   stopUsingAutoCc(identity);</span>
<a href="#l63.601"></a><span id="l63.601" class="difflineminus">-}</span>
<a href="#l63.602"></a><span id="l63.602" class="difflineplus">+});</span>
<a href="#l63.603"></a><span id="l63.603"> </span>
<a href="#l63.604"></a><span id="l63.604"> /**</span>
<a href="#l63.605"></a><span id="l63.605">  * Tests that addresses get set properly when doing a reply where To=From</span>
<a href="#l63.606"></a><span id="l63.606">  * and a Reply-To exists.</span>
<a href="#l63.607"></a><span id="l63.607">  */</span>
<a href="#l63.608"></a><span id="l63.608" class="difflineminus">-function testToFromWithReplyTo() {</span>
<a href="#l63.609"></a><span id="l63.609" class="difflineplus">+add_task(function testToFromWithReplyTo() {</span>
<a href="#l63.610"></a><span id="l63.610">   let msg0 = create_message({</span>
<a href="#l63.611"></a><span id="l63.611">     from: myEmail,</span>
<a href="#l63.612"></a><span id="l63.612">     to: myEmail,</span>
<a href="#l63.613"></a><span id="l63.613">     subject: &quot;testToFromWithReplyTo - To=From w/ Reply-To set&quot;,</span>
<a href="#l63.614"></a><span id="l63.614">     clobberHeaders: { &quot;Reply-To&quot;: &quot;Flanders &lt;flanders@example.com&gt;&quot; },</span>
<a href="#l63.615"></a><span id="l63.615">   });</span>
<a href="#l63.616"></a><span id="l63.616">   add_message_to_folder(folder, msg0);</span>
<a href="#l63.617"></a><span id="l63.617"> </span>
<a href="#l63.618"></a><span id="l63.618" class="difflineat">@@ -1115,9 +1116,9 @@ function testToFromWithReplyTo() {</span>
<a href="#l63.619"></a><span id="l63.619">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l63.620"></a><span id="l63.620"> </span>
<a href="#l63.621"></a><span id="l63.621">   ensureNoAutoCc(identity);</span>
<a href="#l63.622"></a><span id="l63.622">   checkReply(</span>
<a href="#l63.623"></a><span id="l63.623">     open_compose_with_reply,</span>
<a href="#l63.624"></a><span id="l63.624">     // To: Reply-To</span>
<a href="#l63.625"></a><span id="l63.625">     { addr_to: [&quot;Flanders &lt;flanders@example.com&gt;&quot;] }</span>
<a href="#l63.626"></a><span id="l63.626">   );</span>
<a href="#l63.627"></a><span id="l63.627" class="difflineminus">-}</span>
<a href="#l63.628"></a><span id="l63.628" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1">copy from mail/test/mozmill/composition/test-reply-format-flowed.js</span>
<a href="#l64.2"></a><span id="l64.2">copy to mail/test/browser/composition/browser_replyFormatFlowed.js</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-reply-format-flowed.js</span>
<a href="#l64.4"></a><span id="l64.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_replyFormatFlowed.js</span>
<a href="#l64.5"></a><span id="l64.5" class="difflineat">@@ -3,25 +3,24 @@</span>
<a href="#l64.6"></a><span id="l64.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l64.7"></a><span id="l64.7"> </span>
<a href="#l64.8"></a><span id="l64.8"> /**</span>
<a href="#l64.9"></a><span id="l64.9">  * Tests that the reply to a format=flowed message is also flowed.</span>
<a href="#l64.10"></a><span id="l64.10">  */</span>
<a href="#l64.11"></a><span id="l64.11"> </span>
<a href="#l64.12"></a><span id="l64.12"> &quot;use strict&quot;;</span>
<a href="#l64.13"></a><span id="l64.13"> </span>
<a href="#l64.14"></a><span id="l64.14" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l64.15"></a><span id="l64.15" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l64.16"></a><span id="l64.16"> </span>
<a href="#l64.17"></a><span id="l64.17"> var {</span>
<a href="#l64.18"></a><span id="l64.18">   close_compose_window,</span>
<a href="#l64.19"></a><span id="l64.19">   get_msg_source,</span>
<a href="#l64.20"></a><span id="l64.20">   open_compose_with_reply,</span>
<a href="#l64.21"></a><span id="l64.21"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l64.22"></a><span id="l64.22"> var {</span>
<a href="#l64.23"></a><span id="l64.23" class="difflineminus">-  assert_true,</span>
<a href="#l64.24"></a><span id="l64.24">   be_in_folder,</span>
<a href="#l64.25"></a><span id="l64.25">   get_special_folder,</span>
<a href="#l64.26"></a><span id="l64.26">   open_message_from_file,</span>
<a href="#l64.27"></a><span id="l64.27">   press_delete,</span>
<a href="#l64.28"></a><span id="l64.28">   select_click_row,</span>
<a href="#l64.29"></a><span id="l64.29"> } = ChromeUtils.import(</span>
<a href="#l64.30"></a><span id="l64.30">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l64.31"></a><span id="l64.31"> );</span>
<a href="#l64.32"></a><span id="l64.32" class="difflineat">@@ -31,26 +30,24 @@ var { close_window } = ChromeUtils.impor</span>
<a href="#l64.33"></a><span id="l64.33"> </span>
<a href="#l64.34"></a><span id="l64.34"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l64.35"></a><span id="l64.35"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l64.36"></a><span id="l64.36">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l64.37"></a><span id="l64.37"> );</span>
<a href="#l64.38"></a><span id="l64.38"> </span>
<a href="#l64.39"></a><span id="l64.39"> var gDrafts;</span>
<a href="#l64.40"></a><span id="l64.40"> </span>
<a href="#l64.41"></a><span id="l64.41" class="difflineminus">-function setupModule(module) {</span>
<a href="#l64.42"></a><span id="l64.42" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l64.43"></a><span id="l64.43">   gDrafts = get_special_folder(Ci.nsMsgFolderFlags.Drafts, true);</span>
<a href="#l64.44"></a><span id="l64.44"> </span>
<a href="#l64.45"></a><span id="l64.45">   Services.prefs.setBoolPref(&quot;mail.identity.id1.compose_html&quot;, false);</span>
<a href="#l64.46"></a><span id="l64.46" class="difflineminus">-}</span>
<a href="#l64.47"></a><span id="l64.47" class="difflineplus">+});</span>
<a href="#l64.48"></a><span id="l64.48"> </span>
<a href="#l64.49"></a><span id="l64.49"> function subtest_reply_format_flowed(aFlowed) {</span>
<a href="#l64.50"></a><span id="l64.50" class="difflineminus">-  let file = os.getFileForPath(</span>
<a href="#l64.51"></a><span id="l64.51" class="difflineminus">-    os.abspath(&quot;./format-flowed.eml&quot;, os.getFileForPath(__file__))</span>
<a href="#l64.52"></a><span id="l64.52" class="difflineminus">-  );</span>
<a href="#l64.53"></a><span id="l64.53" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(&quot;data/format-flowed.eml&quot;));</span>
<a href="#l64.54"></a><span id="l64.54">   let msgc = open_message_from_file(file);</span>
<a href="#l64.55"></a><span id="l64.55"> </span>
<a href="#l64.56"></a><span id="l64.56">   Services.prefs.setBoolPref(&quot;mailnews.send_plaintext_flowed&quot;, aFlowed);</span>
<a href="#l64.57"></a><span id="l64.57"> </span>
<a href="#l64.58"></a><span id="l64.58">   let cwc = open_compose_with_reply(msgc);</span>
<a href="#l64.59"></a><span id="l64.59"> </span>
<a href="#l64.60"></a><span id="l64.60">   close_window(msgc);</span>
<a href="#l64.61"></a><span id="l64.61"> </span>
<a href="#l64.62"></a><span id="l64.62" class="difflineat">@@ -60,29 +57,29 @@ function subtest_reply_format_flowed(aFl</span>
<a href="#l64.63"></a><span id="l64.63"> </span>
<a href="#l64.64"></a><span id="l64.64">   // Now check the message content in the drafts folder.</span>
<a href="#l64.65"></a><span id="l64.65">   be_in_folder(gDrafts);</span>
<a href="#l64.66"></a><span id="l64.66">   let message = select_click_row(0);</span>
<a href="#l64.67"></a><span id="l64.67">   let messageContent = get_msg_source(message);</span>
<a href="#l64.68"></a><span id="l64.68"> </span>
<a href="#l64.69"></a><span id="l64.69">   // Check for a single line that contains text and make sure there is a</span>
<a href="#l64.70"></a><span id="l64.70">   // space at the end for a flowed reply.</span>
<a href="#l64.71"></a><span id="l64.71" class="difflineminus">-  assert_true(</span>
<a href="#l64.72"></a><span id="l64.72" class="difflineplus">+  Assert.ok(</span>
<a href="#l64.73"></a><span id="l64.73">     messageContent.includes(</span>
<a href="#l64.74"></a><span id="l64.74">       &quot;\r\n&gt; text text text text text text text text text text text text text text&quot; +</span>
<a href="#l64.75"></a><span id="l64.75">         (aFlowed ? &quot; \r\n&quot; : &quot;\r\n&quot;)</span>
<a href="#l64.76"></a><span id="l64.76">     ),</span>
<a href="#l64.77"></a><span id="l64.77">     &quot;Expected line not found in message.&quot;</span>
<a href="#l64.78"></a><span id="l64.78">   );</span>
<a href="#l64.79"></a><span id="l64.79"> </span>
<a href="#l64.80"></a><span id="l64.80">   // Delete the outgoing message.</span>
<a href="#l64.81"></a><span id="l64.81">   press_delete();</span>
<a href="#l64.82"></a><span id="l64.82"> }</span>
<a href="#l64.83"></a><span id="l64.83"> </span>
<a href="#l64.84"></a><span id="l64.84" class="difflineminus">-function test_reply_format_flowed() {</span>
<a href="#l64.85"></a><span id="l64.85" class="difflineplus">+add_task(function test_reply_format_flowed() {</span>
<a href="#l64.86"></a><span id="l64.86">   subtest_reply_format_flowed(true);</span>
<a href="#l64.87"></a><span id="l64.87">   subtest_reply_format_flowed(false);</span>
<a href="#l64.88"></a><span id="l64.88" class="difflineminus">-}</span>
<a href="#l64.89"></a><span id="l64.89" class="difflineplus">+});</span>
<a href="#l64.90"></a><span id="l64.90"> </span>
<a href="#l64.91"></a><span id="l64.91" class="difflineminus">-function teardownModule() {</span>
<a href="#l64.92"></a><span id="l64.92" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l64.93"></a><span id="l64.93">   Services.prefs.clearUserPref(&quot;mail.identity.id1.compose_html&quot;);</span>
<a href="#l64.94"></a><span id="l64.94">   Services.prefs.clearUserPref(&quot;mailnews.send_plaintext_flowed&quot;);</span>
<a href="#l64.95"></a><span id="l64.95" class="difflineminus">-}</span>
<a href="#l64.96"></a><span id="l64.96" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1">copy from mail/test/mozmill/composition/test-reply-multipart-charset.js</span>
<a href="#l65.2"></a><span id="l65.2">copy to mail/test/browser/composition/browser_replyMultipartCharset.js</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-reply-multipart-charset.js</span>
<a href="#l65.4"></a><span id="l65.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_replyMultipartCharset.js</span>
<a href="#l65.5"></a><span id="l65.5" class="difflineat">@@ -18,29 +18,28 @@</span>
<a href="#l65.6"></a><span id="l65.6">  * wasn't viewed before answering/forwarding.</span>
<a href="#l65.7"></a><span id="l65.7">  * For good measure some tests are included for charset overriding</span>
<a href="#l65.8"></a><span id="l65.8">  * and enforcing the charset default.</span>
<a href="#l65.9"></a><span id="l65.9">  */</span>
<a href="#l65.10"></a><span id="l65.10"> </span>
<a href="#l65.11"></a><span id="l65.11"> &quot;use strict&quot;;</span>
<a href="#l65.12"></a><span id="l65.12"> </span>
<a href="#l65.13"></a><span id="l65.13"> var elib = ChromeUtils.import(</span>
<a href="#l65.14"></a><span id="l65.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l65.15"></a><span id="l65.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l65.16"></a><span id="l65.16"> );</span>
<a href="#l65.17"></a><span id="l65.17" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l65.18"></a><span id="l65.18" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l65.19"></a><span id="l65.19"> </span>
<a href="#l65.20"></a><span id="l65.20"> var {</span>
<a href="#l65.21"></a><span id="l65.21">   close_compose_window,</span>
<a href="#l65.22"></a><span id="l65.22">   open_compose_with_edit_as_new,</span>
<a href="#l65.23"></a><span id="l65.23">   open_compose_with_forward,</span>
<a href="#l65.24"></a><span id="l65.24">   open_compose_with_forward_as_attachments,</span>
<a href="#l65.25"></a><span id="l65.25">   open_compose_with_reply,</span>
<a href="#l65.26"></a><span id="l65.26"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l65.27"></a><span id="l65.27"> var {</span>
<a href="#l65.28"></a><span id="l65.28" class="difflineminus">-  assert_equals,</span>
<a href="#l65.29"></a><span id="l65.29">   assert_selected_and_displayed,</span>
<a href="#l65.30"></a><span id="l65.30">   be_in_folder,</span>
<a href="#l65.31"></a><span id="l65.31">   create_folder,</span>
<a href="#l65.32"></a><span id="l65.32">   mc,</span>
<a href="#l65.33"></a><span id="l65.33">   open_message_from_file,</span>
<a href="#l65.34"></a><span id="l65.34">   press_delete,</span>
<a href="#l65.35"></a><span id="l65.35">   select_click_row,</span>
<a href="#l65.36"></a><span id="l65.36"> } = ChromeUtils.import(</span>
<a href="#l65.37"></a><span id="l65.37" class="difflineat">@@ -49,30 +48,32 @@ var {</span>
<a href="#l65.38"></a><span id="l65.38"> var { close_window } = ChromeUtils.import(</span>
<a href="#l65.39"></a><span id="l65.39">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l65.40"></a><span id="l65.40"> );</span>
<a href="#l65.41"></a><span id="l65.41"> </span>
<a href="#l65.42"></a><span id="l65.42"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l65.43"></a><span id="l65.43"> </span>
<a href="#l65.44"></a><span id="l65.44"> var folderToStoreMessages;</span>
<a href="#l65.45"></a><span id="l65.45"> </span>
<a href="#l65.46"></a><span id="l65.46" class="difflineminus">-function setupModule(module) {</span>
<a href="#l65.47"></a><span id="l65.47" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l65.48"></a><span id="l65.48" class="difflineplus">+  requestLongerTimeout(4);</span>
<a href="#l65.49"></a><span id="l65.49" class="difflineplus">+</span>
<a href="#l65.50"></a><span id="l65.50">   folderToStoreMessages = create_folder(&quot;FolderWithMessages&quot;);</span>
<a href="#l65.51"></a><span id="l65.51" class="difflineminus">-}</span>
<a href="#l65.52"></a><span id="l65.52" class="difflineplus">+});</span>
<a href="#l65.53"></a><span id="l65.53"> </span>
<a href="#l65.54"></a><span id="l65.54"> function subtest_replyEditAsNewForward_charset(</span>
<a href="#l65.55"></a><span id="l65.55">   aAction,</span>
<a href="#l65.56"></a><span id="l65.56">   aFile,</span>
<a href="#l65.57"></a><span id="l65.57">   aCharset,</span>
<a href="#l65.58"></a><span id="l65.58">   aOverride = null,</span>
<a href="#l65.59"></a><span id="l65.59">   aViewed = true</span>
<a href="#l65.60"></a><span id="l65.60"> ) {</span>
<a href="#l65.61"></a><span id="l65.61">   be_in_folder(folderToStoreMessages);</span>
<a href="#l65.62"></a><span id="l65.62"> </span>
<a href="#l65.63"></a><span id="l65.63" class="difflineminus">-  let file = os.getFileForPath(os.abspath(aFile, os.getFileForPath(__file__)));</span>
<a href="#l65.64"></a><span id="l65.64" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(`data/${aFile}`));</span>
<a href="#l65.65"></a><span id="l65.65">   let msgc = open_message_from_file(file);</span>
<a href="#l65.66"></a><span id="l65.66"> </span>
<a href="#l65.67"></a><span id="l65.67">   // Copy the message to a folder. We run the message through a folder</span>
<a href="#l65.68"></a><span id="l65.68">   // since replying/editing as new/forwarding directly to the message</span>
<a href="#l65.69"></a><span id="l65.69">   // opened from a file gives different results on different platforms.</span>
<a href="#l65.70"></a><span id="l65.70">   // All platforms behave the same when using a folder-stored message.</span>
<a href="#l65.71"></a><span id="l65.71">   let documentChild = msgc.e(&quot;messagepane&quot;).contentDocument.firstChild;</span>
<a href="#l65.72"></a><span id="l65.72">   msgc.rightClick(new elib.Elem(documentChild));</span>
<a href="#l65.73"></a><span id="l65.73" class="difflineat">@@ -110,37 +111,37 @@ function subtest_replyEditAsNewForward_c</span>
<a href="#l65.74"></a><span id="l65.74">       break;</span>
<a href="#l65.75"></a><span id="l65.75">     case 4: // Forward as attachment.</span>
<a href="#l65.76"></a><span id="l65.76">       fwdWin = open_compose_with_forward_as_attachments();</span>
<a href="#l65.77"></a><span id="l65.77">       break;</span>
<a href="#l65.78"></a><span id="l65.78">   }</span>
<a href="#l65.79"></a><span id="l65.79"> </span>
<a href="#l65.80"></a><span id="l65.80">   // Check the charset in the compose window.</span>
<a href="#l65.81"></a><span id="l65.81">   let charset = fwdWin.e(&quot;content-frame&quot;).contentDocument.charset;</span>
<a href="#l65.82"></a><span id="l65.82" class="difflineminus">-  assert_equals(charset, aCharset, &quot;Compose window has the wrong charset&quot;);</span>
<a href="#l65.83"></a><span id="l65.83" class="difflineplus">+  Assert.equal(charset, aCharset, &quot;Compose window has the wrong charset&quot;);</span>
<a href="#l65.84"></a><span id="l65.84">   close_compose_window(fwdWin);</span>
<a href="#l65.85"></a><span id="l65.85"> </span>
<a href="#l65.86"></a><span id="l65.86">   press_delete(mc);</span>
<a href="#l65.87"></a><span id="l65.87"> }</span>
<a href="#l65.88"></a><span id="l65.88"> </span>
<a href="#l65.89"></a><span id="l65.89" class="difflineminus">-function test_replyEditAsNewForward_charsetFromBody() {</span>
<a href="#l65.90"></a><span id="l65.90" class="difflineplus">+add_task(function test_replyEditAsNewForward_charsetFromBody() {</span>
<a href="#l65.91"></a><span id="l65.91">   // Check that the charset is taken from the message body (bug 1026989).</span>
<a href="#l65.92"></a><span id="l65.92">   subtest_replyEditAsNewForward_charset(1, &quot;./multipart-charset.eml&quot;, &quot;EUC-KR&quot;);</span>
<a href="#l65.93"></a><span id="l65.93">   subtest_replyEditAsNewForward_charset(2, &quot;./multipart-charset.eml&quot;, &quot;EUC-KR&quot;);</span>
<a href="#l65.94"></a><span id="l65.94">   subtest_replyEditAsNewForward_charset(3, &quot;./multipart-charset.eml&quot;, &quot;EUC-KR&quot;);</span>
<a href="#l65.95"></a><span id="l65.95">   // For &quot;forward as attachment&quot; we use the default charset (which is UTF-8).</span>
<a href="#l65.96"></a><span id="l65.96">   subtest_replyEditAsNewForward_charset(4, &quot;./multipart-charset.eml&quot;, &quot;UTF-8&quot;);</span>
<a href="#l65.97"></a><span id="l65.97" class="difflineminus">-}</span>
<a href="#l65.98"></a><span id="l65.98" class="difflineplus">+});</span>
<a href="#l65.99"></a><span id="l65.99"> </span>
<a href="#l65.100"></a><span id="l65.100" class="difflineminus">-function test_reply_noUTF16() {</span>
<a href="#l65.101"></a><span id="l65.101" class="difflineplus">+add_task(function test_reply_noUTF16() {</span>
<a href="#l65.102"></a><span id="l65.102">   // Check that a UTF-16 encoded e-mail is forced to UTF-8 when replying (bug 961983).</span>
<a href="#l65.103"></a><span id="l65.103">   subtest_replyEditAsNewForward_charset(1, &quot;./body-utf16.eml&quot;, &quot;UTF-8&quot;);</span>
<a href="#l65.104"></a><span id="l65.104" class="difflineminus">-}</span>
<a href="#l65.105"></a><span id="l65.105" class="difflineplus">+});</span>
<a href="#l65.106"></a><span id="l65.106"> </span>
<a href="#l65.107"></a><span id="l65.107" class="difflineminus">-function test_replyEditAsNewForward_override() {</span>
<a href="#l65.108"></a><span id="l65.108" class="difflineplus">+add_task(function test_replyEditAsNewForward_override() {</span>
<a href="#l65.109"></a><span id="l65.109">   // Check that the override is honoured (inspired by bug 1323377).</span>
<a href="#l65.110"></a><span id="l65.110">   subtest_replyEditAsNewForward_charset(</span>
<a href="#l65.111"></a><span id="l65.111">     1,</span>
<a href="#l65.112"></a><span id="l65.112">     &quot;./multipart-charset.eml&quot;,</span>
<a href="#l65.113"></a><span id="l65.113">     &quot;UTF-8&quot;,</span>
<a href="#l65.114"></a><span id="l65.114">     &quot;Unicode&quot;</span>
<a href="#l65.115"></a><span id="l65.115">   );</span>
<a href="#l65.116"></a><span id="l65.116">   subtest_replyEditAsNewForward_charset(</span>
<a href="#l65.117"></a><span id="l65.117" class="difflineat">@@ -150,19 +151,19 @@ function test_replyEditAsNewForward_over</span>
<a href="#l65.118"></a><span id="l65.118">     &quot;Western&quot;</span>
<a href="#l65.119"></a><span id="l65.119">   );</span>
<a href="#l65.120"></a><span id="l65.120">   subtest_replyEditAsNewForward_charset(</span>
<a href="#l65.121"></a><span id="l65.121">     3,</span>
<a href="#l65.122"></a><span id="l65.122">     &quot;./multipart-charset.eml&quot;,</span>
<a href="#l65.123"></a><span id="l65.123">     &quot;ISO-8859-7&quot;,</span>
<a href="#l65.124"></a><span id="l65.124">     &quot;Greek (ISO)&quot;</span>
<a href="#l65.125"></a><span id="l65.125">   );</span>
<a href="#l65.126"></a><span id="l65.126" class="difflineminus">-}</span>
<a href="#l65.127"></a><span id="l65.127" class="difflineplus">+});</span>
<a href="#l65.128"></a><span id="l65.128"> </span>
<a href="#l65.129"></a><span id="l65.129" class="difflineminus">-function test_replyEditAsNewForward_enforceDefault() {</span>
<a href="#l65.130"></a><span id="l65.130" class="difflineplus">+add_task(function test_replyEditAsNewForward_enforceDefault() {</span>
<a href="#l65.131"></a><span id="l65.131">   // Check that the default is honoured (inspired by bug 1323377).</span>
<a href="#l65.132"></a><span id="l65.132">   Services.prefs.setBoolPref(&quot;mailnews.reply_in_default_charset&quot;, true);</span>
<a href="#l65.133"></a><span id="l65.133">   Services.prefs.setCharPref(&quot;mailnews.send_default_charset&quot;, &quot;ISO-8859-7&quot;);</span>
<a href="#l65.134"></a><span id="l65.134">   subtest_replyEditAsNewForward_charset(</span>
<a href="#l65.135"></a><span id="l65.135">     1,</span>
<a href="#l65.136"></a><span id="l65.136">     &quot;./multipart-charset.eml&quot;,</span>
<a href="#l65.137"></a><span id="l65.137">     &quot;ISO-8859-7&quot;</span>
<a href="#l65.138"></a><span id="l65.138">   );</span>
<a href="#l65.139"></a><span id="l65.139" class="difflineat">@@ -173,19 +174,19 @@ function test_replyEditAsNewForward_enfo</span>
<a href="#l65.140"></a><span id="l65.140">   );</span>
<a href="#l65.141"></a><span id="l65.141">   subtest_replyEditAsNewForward_charset(</span>
<a href="#l65.142"></a><span id="l65.142">     3,</span>
<a href="#l65.143"></a><span id="l65.143">     &quot;./multipart-charset.eml&quot;,</span>
<a href="#l65.144"></a><span id="l65.144">     &quot;ISO-8859-7&quot;</span>
<a href="#l65.145"></a><span id="l65.145">   );</span>
<a href="#l65.146"></a><span id="l65.146">   Services.prefs.clearUserPref(&quot;mailnews.reply_in_default_charset&quot;);</span>
<a href="#l65.147"></a><span id="l65.147">   Services.prefs.clearUserPref(&quot;mailnews.send_default_charset&quot;);</span>
<a href="#l65.148"></a><span id="l65.148" class="difflineminus">-}</span>
<a href="#l65.149"></a><span id="l65.149" class="difflineplus">+});</span>
<a href="#l65.150"></a><span id="l65.150"> </span>
<a href="#l65.151"></a><span id="l65.151" class="difflineminus">-function test_replyEditAsNewForward_noPreview() {</span>
<a href="#l65.152"></a><span id="l65.152" class="difflineplus">+add_task(function test_replyEditAsNewForward_noPreview() {</span>
<a href="#l65.153"></a><span id="l65.153">   // Check that it works even if the message wasn't viewed before, so</span>
<a href="#l65.154"></a><span id="l65.154">   // switch off the preview pane (bug 1323377).</span>
<a href="#l65.155"></a><span id="l65.155">   be_in_folder(folderToStoreMessages);</span>
<a href="#l65.156"></a><span id="l65.156">   mc.window.goDoCommand(&quot;cmd_toggleMessagePane&quot;);</span>
<a href="#l65.157"></a><span id="l65.157"> </span>
<a href="#l65.158"></a><span id="l65.158">   subtest_replyEditAsNewForward_charset(</span>
<a href="#l65.159"></a><span id="l65.159">     1,</span>
<a href="#l65.160"></a><span id="l65.160">     &quot;./format-flowed.eml&quot;,</span>
<a href="#l65.161"></a><span id="l65.161" class="difflineat">@@ -204,9 +205,9 @@ function test_replyEditAsNewForward_noPr</span>
<a href="#l65.162"></a><span id="l65.162">     3,</span>
<a href="#l65.163"></a><span id="l65.163">     &quot;./multipart-charset.eml&quot;,</span>
<a href="#l65.164"></a><span id="l65.164">     &quot;EUC-KR&quot;,</span>
<a href="#l65.165"></a><span id="l65.165">     null,</span>
<a href="#l65.166"></a><span id="l65.166">     false</span>
<a href="#l65.167"></a><span id="l65.167">   );</span>
<a href="#l65.168"></a><span id="l65.168"> </span>
<a href="#l65.169"></a><span id="l65.169">   mc.window.goDoCommand(&quot;cmd_toggleMessagePane&quot;);</span>
<a href="#l65.170"></a><span id="l65.170" class="difflineminus">-}</span>
<a href="#l65.171"></a><span id="l65.171" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1">copy from mail/test/mozmill/composition/test-reply-signature.js</span>
<a href="#l66.2"></a><span id="l66.2">copy to mail/test/browser/composition/browser_replySignature.js</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-reply-signature.js</span>
<a href="#l66.4"></a><span id="l66.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_replySignature.js</span>
<a href="#l66.5"></a><span id="l66.5" class="difflineat">@@ -25,17 +25,17 @@ var {</span>
<a href="#l66.6"></a><span id="l66.6">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l66.7"></a><span id="l66.7"> );</span>
<a href="#l66.8"></a><span id="l66.8"> </span>
<a href="#l66.9"></a><span id="l66.9"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l66.10"></a><span id="l66.10"> </span>
<a href="#l66.11"></a><span id="l66.11"> var sig = &quot;roses are red&quot;;</span>
<a href="#l66.12"></a><span id="l66.12"> var folder;</span>
<a href="#l66.13"></a><span id="l66.13"> </span>
<a href="#l66.14"></a><span id="l66.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l66.15"></a><span id="l66.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l66.16"></a><span id="l66.16">   folder = create_folder(&quot;SigStripTest&quot;);</span>
<a href="#l66.17"></a><span id="l66.17"> </span>
<a href="#l66.18"></a><span id="l66.18">   let msg = create_message({</span>
<a href="#l66.19"></a><span id="l66.19">     subject: &quot;msg with signature; format=flowed&quot;,</span>
<a href="#l66.20"></a><span id="l66.20">     body: {</span>
<a href="#l66.21"></a><span id="l66.21">       body:</span>
<a href="#l66.22"></a><span id="l66.22">         &quot;get with the flow! get with the flow! get with the flow! &quot; +</span>
<a href="#l66.23"></a><span id="l66.23">         &quot;get with the \n flow! get with the flow!\n-- \n&quot; +</span>
<a href="#l66.24"></a><span id="l66.24" class="difflineat">@@ -56,45 +56,45 @@ function setupModule(module) {</span>
<a href="#l66.25"></a><span id="l66.25">         sig +</span>
<a href="#l66.26"></a><span id="l66.26">         &quot;\n&quot;,</span>
<a href="#l66.27"></a><span id="l66.27">       contentType: &quot;text/plain&quot;,</span>
<a href="#l66.28"></a><span id="l66.28">       charset: &quot;UTF-8&quot;,</span>
<a href="#l66.29"></a><span id="l66.29">       format: &quot;&quot;,</span>
<a href="#l66.30"></a><span id="l66.30">     },</span>
<a href="#l66.31"></a><span id="l66.31">   });</span>
<a href="#l66.32"></a><span id="l66.32">   add_message_to_folder(folder, msg2);</span>
<a href="#l66.33"></a><span id="l66.33" class="difflineminus">-}</span>
<a href="#l66.34"></a><span id="l66.34" class="difflineplus">+});</span>
<a href="#l66.35"></a><span id="l66.35"> </span>
<a href="#l66.36"></a><span id="l66.36"> /** Test sig strip true for format flowed. */</span>
<a href="#l66.37"></a><span id="l66.37" class="difflineminus">-function test_sig_strip_true_ff() {</span>
<a href="#l66.38"></a><span id="l66.38" class="difflineplus">+add_task(function test_sig_strip_true_ff() {</span>
<a href="#l66.39"></a><span id="l66.39">   Services.prefs.setBoolPref(&quot;mail.strip_sig_on_reply&quot;, true);</span>
<a href="#l66.40"></a><span id="l66.40">   check_sig_strip_works(0, true);</span>
<a href="#l66.41"></a><span id="l66.41">   Services.prefs.clearUserPref(&quot;mail.strip_sig_on_reply&quot;);</span>
<a href="#l66.42"></a><span id="l66.42" class="difflineminus">-}</span>
<a href="#l66.43"></a><span id="l66.43" class="difflineplus">+});</span>
<a href="#l66.44"></a><span id="l66.44"> </span>
<a href="#l66.45"></a><span id="l66.45"> /** Test sig strip false for format flowed. */</span>
<a href="#l66.46"></a><span id="l66.46" class="difflineminus">-function test_sig_strip_false_ff() {</span>
<a href="#l66.47"></a><span id="l66.47" class="difflineplus">+add_task(function test_sig_strip_false_ff() {</span>
<a href="#l66.48"></a><span id="l66.48">   Services.prefs.setBoolPref(&quot;mail.strip_sig_on_reply&quot;, false);</span>
<a href="#l66.49"></a><span id="l66.49">   check_sig_strip_works(0, false);</span>
<a href="#l66.50"></a><span id="l66.50">   Services.prefs.clearUserPref(&quot;mail.strip_sig_on_reply&quot;);</span>
<a href="#l66.51"></a><span id="l66.51" class="difflineminus">-}</span>
<a href="#l66.52"></a><span id="l66.52" class="difflineplus">+});</span>
<a href="#l66.53"></a><span id="l66.53"> </span>
<a href="#l66.54"></a><span id="l66.54"> /** Test sig strip true for non-format flowed. */</span>
<a href="#l66.55"></a><span id="l66.55" class="difflineminus">-function test_sig_strip_true_nonff() {</span>
<a href="#l66.56"></a><span id="l66.56" class="difflineplus">+add_task(function test_sig_strip_true_nonff() {</span>
<a href="#l66.57"></a><span id="l66.57">   Services.prefs.setBoolPref(&quot;mail.strip_sig_on_reply&quot;, true);</span>
<a href="#l66.58"></a><span id="l66.58">   check_sig_strip_works(1, true);</span>
<a href="#l66.59"></a><span id="l66.59">   Services.prefs.clearUserPref(&quot;mail.strip_sig_on_reply&quot;);</span>
<a href="#l66.60"></a><span id="l66.60" class="difflineminus">-}</span>
<a href="#l66.61"></a><span id="l66.61" class="difflineplus">+});</span>
<a href="#l66.62"></a><span id="l66.62"> </span>
<a href="#l66.63"></a><span id="l66.63"> /** Test sig strip false for non-format flowed. */</span>
<a href="#l66.64"></a><span id="l66.64" class="difflineminus">-function test_sig_strip_false_nonff() {</span>
<a href="#l66.65"></a><span id="l66.65" class="difflineplus">+add_task(function test_sig_strip_false_nonff() {</span>
<a href="#l66.66"></a><span id="l66.66">   Services.prefs.setBoolPref(&quot;mail.strip_sig_on_reply&quot;, false);</span>
<a href="#l66.67"></a><span id="l66.67">   check_sig_strip_works(1, false);</span>
<a href="#l66.68"></a><span id="l66.68">   Services.prefs.clearUserPref(&quot;mail.strip_sig_on_reply&quot;);</span>
<a href="#l66.69"></a><span id="l66.69" class="difflineminus">-}</span>
<a href="#l66.70"></a><span id="l66.70" class="difflineplus">+});</span>
<a href="#l66.71"></a><span id="l66.71"> </span>
<a href="#l66.72"></a><span id="l66.72"> /**</span>
<a href="#l66.73"></a><span id="l66.73">  * Helper function to check signature stripping works as it should.</span>
<a href="#l66.74"></a><span id="l66.74">  * @param aRow the row index of the message to test</span>
<a href="#l66.75"></a><span id="l66.75">  * @param aShouldStrip true if the signature should be stripped</span>
<a href="#l66.76"></a><span id="l66.76">  */</span>
<a href="#l66.77"></a><span id="l66.77"> function check_sig_strip_works(aRow, aShouldStrip) {</span>
<a href="#l66.78"></a><span id="l66.78">   be_in_folder(folder);</span>
<a href="#l66.79"></a><span id="l66.79" class="difflineat">@@ -105,9 +105,16 @@ function check_sig_strip_works(aRow, aSh</span>
<a href="#l66.80"></a><span id="l66.80">   let body = get_compose_body(rwc);</span>
<a href="#l66.81"></a><span id="l66.81"> </span>
<a href="#l66.82"></a><span id="l66.82">   if (aShouldStrip &amp;&amp; body.textContent.includes(sig)) {</span>
<a href="#l66.83"></a><span id="l66.83">     throw new Error(&quot;signature was not stripped; body=&quot; + body.textContent);</span>
<a href="#l66.84"></a><span id="l66.84">   } else if (!aShouldStrip &amp;&amp; !body.textContent.includes(sig)) {</span>
<a href="#l66.85"></a><span id="l66.85">     throw new Error(&quot;signature stripped; body=&quot; + body.textContent);</span>
<a href="#l66.86"></a><span id="l66.86">   }</span>
<a href="#l66.87"></a><span id="l66.87">   close_compose_window(rwc);</span>
<a href="#l66.88"></a><span id="l66.88" class="difflineplus">+</span>
<a href="#l66.89"></a><span id="l66.89" class="difflineplus">+  Assert.report(</span>
<a href="#l66.90"></a><span id="l66.90" class="difflineplus">+    false,</span>
<a href="#l66.91"></a><span id="l66.91" class="difflineplus">+    undefined,</span>
<a href="#l66.92"></a><span id="l66.92" class="difflineplus">+    undefined,</span>
<a href="#l66.93"></a><span id="l66.93" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l66.94"></a><span id="l66.94" class="difflineplus">+  );</span>
<a href="#l66.95"></a><span id="l66.95"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1">copy from mail/test/mozmill/composition/test-save-changes-on-quit.js</span>
<a href="#l67.2"></a><span id="l67.2">copy to mail/test/browser/composition/browser_saveChangesOnQuit.js</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-save-changes-on-quit.js</span>
<a href="#l67.4"></a><span id="l67.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_saveChangesOnQuit.js</span>
<a href="#l67.5"></a><span id="l67.5" class="difflineat">@@ -13,21 +13,17 @@</span>
<a href="#l67.6"></a><span id="l67.6"> var {</span>
<a href="#l67.7"></a><span id="l67.7">   close_compose_window,</span>
<a href="#l67.8"></a><span id="l67.8">   open_compose_new_mail,</span>
<a href="#l67.9"></a><span id="l67.9">   open_compose_with_forward,</span>
<a href="#l67.10"></a><span id="l67.10">   open_compose_with_reply,</span>
<a href="#l67.11"></a><span id="l67.11"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l67.12"></a><span id="l67.12"> var {</span>
<a href="#l67.13"></a><span id="l67.13">   add_message_to_folder,</span>
<a href="#l67.14"></a><span id="l67.14" class="difflineminus">-  assert_equals,</span>
<a href="#l67.15"></a><span id="l67.15" class="difflineminus">-  assert_false,</span>
<a href="#l67.16"></a><span id="l67.16" class="difflineminus">-  assert_not_equals,</span>
<a href="#l67.17"></a><span id="l67.17">   assert_selected_and_displayed,</span>
<a href="#l67.18"></a><span id="l67.18" class="difflineminus">-  assert_true,</span>
<a href="#l67.19"></a><span id="l67.19">   be_in_folder,</span>
<a href="#l67.20"></a><span id="l67.20">   create_folder,</span>
<a href="#l67.21"></a><span id="l67.21">   create_message,</span>
<a href="#l67.22"></a><span id="l67.22">   mc,</span>
<a href="#l67.23"></a><span id="l67.23">   select_click_row,</span>
<a href="#l67.24"></a><span id="l67.24"> } = ChromeUtils.import(</span>
<a href="#l67.25"></a><span id="l67.25">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l67.26"></a><span id="l67.26"> );</span>
<a href="#l67.27"></a><span id="l67.27" class="difflineat">@@ -39,24 +35,26 @@ var { Services } = ChromeUtils.import(&quot;r</span>
<a href="#l67.28"></a><span id="l67.28"> </span>
<a href="#l67.29"></a><span id="l67.29"> var SAVE = 0;</span>
<a href="#l67.30"></a><span id="l67.30"> var CANCEL = 1;</span>
<a href="#l67.31"></a><span id="l67.31"> var DONT_SAVE = 2;</span>
<a href="#l67.32"></a><span id="l67.32"> </span>
<a href="#l67.33"></a><span id="l67.33"> var cwc = null; // compose window controller</span>
<a href="#l67.34"></a><span id="l67.34"> var folder = null;</span>
<a href="#l67.35"></a><span id="l67.35"> </span>
<a href="#l67.36"></a><span id="l67.36" class="difflineminus">-function setupModule(module) {</span>
<a href="#l67.37"></a><span id="l67.37" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l67.38"></a><span id="l67.38" class="difflineplus">+  requestLongerTimeout(2);</span>
<a href="#l67.39"></a><span id="l67.39" class="difflineplus">+</span>
<a href="#l67.40"></a><span id="l67.40">   folder = create_folder(&quot;PromptToSaveTest&quot;);</span>
<a href="#l67.41"></a><span id="l67.41"> </span>
<a href="#l67.42"></a><span id="l67.42">   add_message_to_folder(folder, create_message()); // row 0</span>
<a href="#l67.43"></a><span id="l67.43">   let localFolder = folder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l67.44"></a><span id="l67.44">   localFolder.addMessage(msgSource(&quot;content type: text&quot;, &quot;text&quot;)); // row 1</span>
<a href="#l67.45"></a><span id="l67.45">   localFolder.addMessage(msgSource(&quot;content type missing&quot;, null)); // row 2</span>
<a href="#l67.46"></a><span id="l67.46" class="difflineminus">-}</span>
<a href="#l67.47"></a><span id="l67.47" class="difflineplus">+});</span>
<a href="#l67.48"></a><span id="l67.48"> </span>
<a href="#l67.49"></a><span id="l67.49"> function msgSource(aSubject, aContentType) {</span>
<a href="#l67.50"></a><span id="l67.50">   let msgId =</span>
<a href="#l67.51"></a><span id="l67.51">     Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l67.52"></a><span id="l67.52">       .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l67.53"></a><span id="l67.53">       .generateUUID() + &quot;@invalid&quot;;</span>
<a href="#l67.54"></a><span id="l67.54"> </span>
<a href="#l67.55"></a><span id="l67.55">   return (</span>
<a href="#l67.56"></a><span id="l67.56" class="difflineat">@@ -83,17 +81,17 @@ function msgSource(aSubject, aContentTyp</span>
<a href="#l67.57"></a><span id="l67.57"> </span>
<a href="#l67.58"></a><span id="l67.58"> /**</span>
<a href="#l67.59"></a><span id="l67.59">  * Test that when a compose window is open with changes, and</span>
<a href="#l67.60"></a><span id="l67.60">  * a Quit is requested (for example, from File &gt; Quit from the</span>
<a href="#l67.61"></a><span id="l67.61">  * 3pane), that the user gets a confirmation dialog to discard</span>
<a href="#l67.62"></a><span id="l67.62">  * the changes. This also tests that the user can cancel the</span>
<a href="#l67.63"></a><span id="l67.63">  * quit request.</span>
<a href="#l67.64"></a><span id="l67.64">  */</span>
<a href="#l67.65"></a><span id="l67.65" class="difflineminus">-function test_can_cancel_quit_on_changes() {</span>
<a href="#l67.66"></a><span id="l67.66" class="difflineplus">+add_task(function test_can_cancel_quit_on_changes() {</span>
<a href="#l67.67"></a><span id="l67.67">   // Register the Mock Prompt Service</span>
<a href="#l67.68"></a><span id="l67.68">   gMockPromptService.register();</span>
<a href="#l67.69"></a><span id="l67.69"> </span>
<a href="#l67.70"></a><span id="l67.70">   // opening a new compose window</span>
<a href="#l67.71"></a><span id="l67.71">   cwc = open_compose_new_mail(mc);</span>
<a href="#l67.72"></a><span id="l67.72"> </span>
<a href="#l67.73"></a><span id="l67.73">   // Make some changes</span>
<a href="#l67.74"></a><span id="l67.74">   cwc.type(cwc.eid(&quot;content-frame&quot;), &quot;Hey check out this megalol link&quot;);</span>
<a href="#l67.75"></a><span id="l67.75" class="difflineat">@@ -105,38 +103,38 @@ function test_can_cancel_quit_on_changes</span>
<a href="#l67.76"></a><span id="l67.76">   // Set the Mock Prompt Service to return false, so that we</span>
<a href="#l67.77"></a><span id="l67.77">   // cancel the quit.</span>
<a href="#l67.78"></a><span id="l67.78">   gMockPromptService.returnValue = CANCEL;</span>
<a href="#l67.79"></a><span id="l67.79">   // Trigger the quit-application-request notification</span>
<a href="#l67.80"></a><span id="l67.80"> </span>
<a href="#l67.81"></a><span id="l67.81">   Services.obs.notifyObservers(cancelQuit, &quot;quit-application-requested&quot;);</span>
<a href="#l67.82"></a><span id="l67.82"> </span>
<a href="#l67.83"></a><span id="l67.83">   let promptState = gMockPromptService.promptState;</span>
<a href="#l67.84"></a><span id="l67.84" class="difflineminus">-  assert_not_equals(null, promptState, &quot;Expected a confirmEx prompt&quot;);</span>
<a href="#l67.85"></a><span id="l67.85" class="difflineplus">+  Assert.notEqual(null, promptState, &quot;Expected a confirmEx prompt&quot;);</span>
<a href="#l67.86"></a><span id="l67.86"> </span>
<a href="#l67.87"></a><span id="l67.87" class="difflineminus">-  assert_equals(&quot;confirmEx&quot;, promptState.method);</span>
<a href="#l67.88"></a><span id="l67.88" class="difflineplus">+  Assert.equal(&quot;confirmEx&quot;, promptState.method);</span>
<a href="#l67.89"></a><span id="l67.89">   // Since we returned false on the confirmation dialog,</span>
<a href="#l67.90"></a><span id="l67.90">   // we should be cancelling the quit - so cancelQuit.data</span>
<a href="#l67.91"></a><span id="l67.91">   // should now be true</span>
<a href="#l67.92"></a><span id="l67.92" class="difflineminus">-  assert_true(cancelQuit.data, &quot;Didn't cancel the quit&quot;);</span>
<a href="#l67.93"></a><span id="l67.93" class="difflineplus">+  Assert.ok(cancelQuit.data, &quot;Didn't cancel the quit&quot;);</span>
<a href="#l67.94"></a><span id="l67.94"> </span>
<a href="#l67.95"></a><span id="l67.95">   close_compose_window(cwc);</span>
<a href="#l67.96"></a><span id="l67.96"> </span>
<a href="#l67.97"></a><span id="l67.97">   // Unregister the Mock Prompt Service</span>
<a href="#l67.98"></a><span id="l67.98">   gMockPromptService.unregister();</span>
<a href="#l67.99"></a><span id="l67.99" class="difflineminus">-}</span>
<a href="#l67.100"></a><span id="l67.100" class="difflineplus">+});</span>
<a href="#l67.101"></a><span id="l67.101"> </span>
<a href="#l67.102"></a><span id="l67.102"> /**</span>
<a href="#l67.103"></a><span id="l67.103">  * Test that when a compose window is open with changes, and</span>
<a href="#l67.104"></a><span id="l67.104">  * a Quit is requested (for example, from File &gt; Quit from the</span>
<a href="#l67.105"></a><span id="l67.105">  * 3pane), that the user gets a confirmation dialog to discard</span>
<a href="#l67.106"></a><span id="l67.106">  * the changes. This also tests that the user can let the quit</span>
<a href="#l67.107"></a><span id="l67.107">  * occur.</span>
<a href="#l67.108"></a><span id="l67.108">  */</span>
<a href="#l67.109"></a><span id="l67.109" class="difflineminus">-function test_can_quit_on_changes() {</span>
<a href="#l67.110"></a><span id="l67.110" class="difflineplus">+add_task(function test_can_quit_on_changes() {</span>
<a href="#l67.111"></a><span id="l67.111">   // Register the Mock Prompt Service</span>
<a href="#l67.112"></a><span id="l67.112">   gMockPromptService.register();</span>
<a href="#l67.113"></a><span id="l67.113"> </span>
<a href="#l67.114"></a><span id="l67.114">   // opening a new compose window</span>
<a href="#l67.115"></a><span id="l67.115">   cwc = open_compose_new_mail(mc);</span>
<a href="#l67.116"></a><span id="l67.116"> </span>
<a href="#l67.117"></a><span id="l67.117">   // Make some changes</span>
<a href="#l67.118"></a><span id="l67.118">   cwc.type(cwc.eid(&quot;content-frame&quot;), &quot;Hey check out this megalol link&quot;);</span>
<a href="#l67.119"></a><span id="l67.119" class="difflineat">@@ -148,37 +146,37 @@ function test_can_quit_on_changes() {</span>
<a href="#l67.120"></a><span id="l67.120">   // Set the Mock Prompt Service to return true, so that we're</span>
<a href="#l67.121"></a><span id="l67.121">   // allowing the quit to occur.</span>
<a href="#l67.122"></a><span id="l67.122">   gMockPromptService.returnValue = DONT_SAVE;</span>
<a href="#l67.123"></a><span id="l67.123"> </span>
<a href="#l67.124"></a><span id="l67.124">   // Trigger the quit-application-request notification</span>
<a href="#l67.125"></a><span id="l67.125">   Services.obs.notifyObservers(cancelQuit, &quot;quit-application-requested&quot;);</span>
<a href="#l67.126"></a><span id="l67.126"> </span>
<a href="#l67.127"></a><span id="l67.127">   let promptState = gMockPromptService.promptState;</span>
<a href="#l67.128"></a><span id="l67.128" class="difflineminus">-  assert_not_equals(null, promptState, &quot;Expected a confirmEx prompt&quot;);</span>
<a href="#l67.129"></a><span id="l67.129" class="difflineplus">+  Assert.notEqual(null, promptState, &quot;Expected a confirmEx prompt&quot;);</span>
<a href="#l67.130"></a><span id="l67.130"> </span>
<a href="#l67.131"></a><span id="l67.131" class="difflineminus">-  assert_equals(&quot;confirmEx&quot;, promptState.method);</span>
<a href="#l67.132"></a><span id="l67.132" class="difflineplus">+  Assert.equal(&quot;confirmEx&quot;, promptState.method);</span>
<a href="#l67.133"></a><span id="l67.133">   // Since we returned true on the confirmation dialog,</span>
<a href="#l67.134"></a><span id="l67.134">   // we should be quitting - so cancelQuit.data should now be</span>
<a href="#l67.135"></a><span id="l67.135">   // false</span>
<a href="#l67.136"></a><span id="l67.136" class="difflineminus">-  assert_false(cancelQuit.data, &quot;The quit request was cancelled&quot;);</span>
<a href="#l67.137"></a><span id="l67.137" class="difflineplus">+  Assert.ok(!cancelQuit.data, &quot;The quit request was cancelled&quot;);</span>
<a href="#l67.138"></a><span id="l67.138"> </span>
<a href="#l67.139"></a><span id="l67.139">   close_compose_window(cwc);</span>
<a href="#l67.140"></a><span id="l67.140"> </span>
<a href="#l67.141"></a><span id="l67.141">   // Unregister the Mock Prompt Service</span>
<a href="#l67.142"></a><span id="l67.142">   gMockPromptService.unregister();</span>
<a href="#l67.143"></a><span id="l67.143" class="difflineminus">-}</span>
<a href="#l67.144"></a><span id="l67.144" class="difflineplus">+});</span>
<a href="#l67.145"></a><span id="l67.145"> </span>
<a href="#l67.146"></a><span id="l67.146"> /**</span>
<a href="#l67.147"></a><span id="l67.147">  * Bug 698077 - test that when quitting with two compose windows open, if</span>
<a href="#l67.148"></a><span id="l67.148">  * one chooses &quot;Don't Save&quot;, and the other chooses &quot;Cancel&quot;, that the first</span>
<a href="#l67.149"></a><span id="l67.149">  * window's state is such that subsequent quit requests still cause the</span>
<a href="#l67.150"></a><span id="l67.150">  * Don't Save / Cancel / Save dialog to come up.</span>
<a href="#l67.151"></a><span id="l67.151">  */</span>
<a href="#l67.152"></a><span id="l67.152" class="difflineminus">-function test_window_quit_state_reset_on_aborted_quit() {</span>
<a href="#l67.153"></a><span id="l67.153" class="difflineplus">+add_task(function test_window_quit_state_reset_on_aborted_quit() {</span>
<a href="#l67.154"></a><span id="l67.154">   // Register the Mock Prompt Service</span>
<a href="#l67.155"></a><span id="l67.155">   gMockPromptService.register();</span>
<a href="#l67.156"></a><span id="l67.156"> </span>
<a href="#l67.157"></a><span id="l67.157">   // open two new compose windows</span>
<a href="#l67.158"></a><span id="l67.158">   let cwc1 = open_compose_new_mail(mc);</span>
<a href="#l67.159"></a><span id="l67.159">   let cwc2 = open_compose_new_mail(mc);</span>
<a href="#l67.160"></a><span id="l67.160"> </span>
<a href="#l67.161"></a><span id="l67.161">   // Type something in each window.</span>
<a href="#l67.162"></a><span id="l67.162" class="difflineat">@@ -201,109 +199,109 @@ function test_window_quit_state_reset_on</span>
<a href="#l67.163"></a><span id="l67.163">   };</span>
<a href="#l67.164"></a><span id="l67.164"> </span>
<a href="#l67.165"></a><span id="l67.165">   gMockPromptService.returnValue = DONT_SAVE;</span>
<a href="#l67.166"></a><span id="l67.166"> </span>
<a href="#l67.167"></a><span id="l67.167">   // Trigger the quit-application-request notification</span>
<a href="#l67.168"></a><span id="l67.168">   Services.obs.notifyObservers(cancelQuit, &quot;quit-application-requested&quot;);</span>
<a href="#l67.169"></a><span id="l67.169"> </span>
<a href="#l67.170"></a><span id="l67.170">   // We should have cancelled the quit appropriately.</span>
<a href="#l67.171"></a><span id="l67.171" class="difflineminus">-  assert_true(cancelQuit.data);</span>
<a href="#l67.172"></a><span id="l67.172" class="difflineplus">+  Assert.ok(cancelQuit.data);</span>
<a href="#l67.173"></a><span id="l67.173"> </span>
<a href="#l67.174"></a><span id="l67.174">   // The quit behaviour is that the second window to spawn is the first</span>
<a href="#l67.175"></a><span id="l67.175">   // one that prompts for Save / Don't Save, etc.</span>
<a href="#l67.176"></a><span id="l67.176">   gMockPromptService.reset();</span>
<a href="#l67.177"></a><span id="l67.177"> </span>
<a href="#l67.178"></a><span id="l67.178">   // The first window should still prompt when attempting to close the</span>
<a href="#l67.179"></a><span id="l67.179">   // window.</span>
<a href="#l67.180"></a><span id="l67.180">   gMockPromptService.returnValue = DONT_SAVE;</span>
<a href="#l67.181"></a><span id="l67.181">   cwc2.click(cwc2.eid(&quot;menu_close&quot;));</span>
<a href="#l67.182"></a><span id="l67.182"> </span>
<a href="#l67.183"></a><span id="l67.183">   let promptState = gMockPromptService.promptState;</span>
<a href="#l67.184"></a><span id="l67.184" class="difflineminus">-  assert_not_equals(null, promptState, &quot;Expected a confirmEx prompt&quot;);</span>
<a href="#l67.185"></a><span id="l67.185" class="difflineplus">+  Assert.notEqual(null, promptState, &quot;Expected a confirmEx prompt&quot;);</span>
<a href="#l67.186"></a><span id="l67.186"> </span>
<a href="#l67.187"></a><span id="l67.187">   close_compose_window(cwc1);</span>
<a href="#l67.188"></a><span id="l67.188"> </span>
<a href="#l67.189"></a><span id="l67.189">   gMockPromptService.unregister();</span>
<a href="#l67.190"></a><span id="l67.190" class="difflineminus">-}</span>
<a href="#l67.191"></a><span id="l67.191" class="difflineplus">+});</span>
<a href="#l67.192"></a><span id="l67.192"> </span>
<a href="#l67.193"></a><span id="l67.193"> /**</span>
<a href="#l67.194"></a><span id="l67.194">  * Tests that we don't get a prompt to save if there has been no user input</span>
<a href="#l67.195"></a><span id="l67.195">  * into the message yet, when trying to close.</span>
<a href="#l67.196"></a><span id="l67.196">  */</span>
<a href="#l67.197"></a><span id="l67.197" class="difflineminus">-function test_no_prompt_on_close_for_unmodified() {</span>
<a href="#l67.198"></a><span id="l67.198" class="difflineplus">+add_task(function test_no_prompt_on_close_for_unmodified() {</span>
<a href="#l67.199"></a><span id="l67.199">   be_in_folder(folder);</span>
<a href="#l67.200"></a><span id="l67.200">   let msg = select_click_row(0);</span>
<a href="#l67.201"></a><span id="l67.201">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l67.202"></a><span id="l67.202"> </span>
<a href="#l67.203"></a><span id="l67.203">   let nwc = open_compose_new_mail();</span>
<a href="#l67.204"></a><span id="l67.204">   close_compose_window(nwc, false);</span>
<a href="#l67.205"></a><span id="l67.205"> </span>
<a href="#l67.206"></a><span id="l67.206">   let rwc = open_compose_with_reply();</span>
<a href="#l67.207"></a><span id="l67.207">   close_compose_window(rwc, false);</span>
<a href="#l67.208"></a><span id="l67.208"> </span>
<a href="#l67.209"></a><span id="l67.209">   let fwc = open_compose_with_forward();</span>
<a href="#l67.210"></a><span id="l67.210">   close_compose_window(fwc, false);</span>
<a href="#l67.211"></a><span id="l67.211" class="difflineminus">-}</span>
<a href="#l67.212"></a><span id="l67.212" class="difflineplus">+});</span>
<a href="#l67.213"></a><span id="l67.213"> </span>
<a href="#l67.214"></a><span id="l67.214"> /**</span>
<a href="#l67.215"></a><span id="l67.215">  * Tests that we get a prompt to save if the user made changes to the message</span>
<a href="#l67.216"></a><span id="l67.216">  * before trying to close it.</span>
<a href="#l67.217"></a><span id="l67.217">  */</span>
<a href="#l67.218"></a><span id="l67.218" class="difflineminus">-function test_prompt_on_close_for_modified() {</span>
<a href="#l67.219"></a><span id="l67.219" class="difflineplus">+add_task(function test_prompt_on_close_for_modified() {</span>
<a href="#l67.220"></a><span id="l67.220">   be_in_folder(folder);</span>
<a href="#l67.221"></a><span id="l67.221">   let msg = select_click_row(0);</span>
<a href="#l67.222"></a><span id="l67.222">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l67.223"></a><span id="l67.223"> </span>
<a href="#l67.224"></a><span id="l67.224">   let nwc = open_compose_new_mail();</span>
<a href="#l67.225"></a><span id="l67.225">   nwc.type(nwc.eid(&quot;content-frame&quot;), &quot;Hey hey hey!&quot;);</span>
<a href="#l67.226"></a><span id="l67.226">   close_compose_window(nwc, true);</span>
<a href="#l67.227"></a><span id="l67.227"> </span>
<a href="#l67.228"></a><span id="l67.228">   let rwc = open_compose_with_reply();</span>
<a href="#l67.229"></a><span id="l67.229">   rwc.type(rwc.eid(&quot;content-frame&quot;), &quot;Howdy!&quot;);</span>
<a href="#l67.230"></a><span id="l67.230">   close_compose_window(rwc, true);</span>
<a href="#l67.231"></a><span id="l67.231"> </span>
<a href="#l67.232"></a><span id="l67.232">   let fwc = open_compose_with_forward();</span>
<a href="#l67.233"></a><span id="l67.233">   fwc.type(fwc.eid(&quot;content-frame&quot;), &quot;Greetings!&quot;);</span>
<a href="#l67.234"></a><span id="l67.234">   close_compose_window(fwc, true);</span>
<a href="#l67.235"></a><span id="l67.235" class="difflineminus">-}</span>
<a href="#l67.236"></a><span id="l67.236" class="difflineplus">+});</span>
<a href="#l67.237"></a><span id="l67.237"> </span>
<a href="#l67.238"></a><span id="l67.238"> /**</span>
<a href="#l67.239"></a><span id="l67.239">  * Test there's no prompt on close when no changes was made in reply/forward</span>
<a href="#l67.240"></a><span id="l67.240">  * windows - for the case the original msg had content type &quot;text&quot;.</span>
<a href="#l67.241"></a><span id="l67.241">  */</span>
<a href="#l67.242"></a><span id="l67.242" class="difflineminus">-function test_no_prompt_on_close_for_unmodified_content_type_text() {</span>
<a href="#l67.243"></a><span id="l67.243" class="difflineplus">+add_task(function test_no_prompt_on_close_for_unmodified_content_type_text() {</span>
<a href="#l67.244"></a><span id="l67.244">   be_in_folder(folder);</span>
<a href="#l67.245"></a><span id="l67.245">   let msg = select_click_row(1); // row 1 is the one with content type text</span>
<a href="#l67.246"></a><span id="l67.246">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l67.247"></a><span id="l67.247"> </span>
<a href="#l67.248"></a><span id="l67.248">   let rwc = open_compose_with_reply();</span>
<a href="#l67.249"></a><span id="l67.249">   close_compose_window(rwc, false);</span>
<a href="#l67.250"></a><span id="l67.250"> </span>
<a href="#l67.251"></a><span id="l67.251">   let fwc = open_compose_with_forward();</span>
<a href="#l67.252"></a><span id="l67.252" class="difflineminus">-  assert_equals(</span>
<a href="#l67.253"></a><span id="l67.253" class="difflineplus">+  Assert.equal(</span>
<a href="#l67.254"></a><span id="l67.254">     fwc.e(&quot;attachmentBucket&quot;).getRowCount(),</span>
<a href="#l67.255"></a><span id="l67.255">     0,</span>
<a href="#l67.256"></a><span id="l67.256">     &quot;forwarding msg created attachment&quot;</span>
<a href="#l67.257"></a><span id="l67.257">   );</span>
<a href="#l67.258"></a><span id="l67.258">   close_compose_window(fwc, false);</span>
<a href="#l67.259"></a><span id="l67.259" class="difflineminus">-}</span>
<a href="#l67.260"></a><span id="l67.260" class="difflineplus">+});</span>
<a href="#l67.261"></a><span id="l67.261"> </span>
<a href="#l67.262"></a><span id="l67.262"> /**</span>
<a href="#l67.263"></a><span id="l67.263">  * Test there's no prompt on close when no changes was made in reply/forward</span>
<a href="#l67.264"></a><span id="l67.264">  * windows - for the case the original msg had no content type.</span>
<a href="#l67.265"></a><span id="l67.265">  */</span>
<a href="#l67.266"></a><span id="l67.266" class="difflineminus">-function test_no_prompt_on_close_for_unmodified_no_content_type() {</span>
<a href="#l67.267"></a><span id="l67.267" class="difflineplus">+add_task(function test_no_prompt_on_close_for_unmodified_no_content_type() {</span>
<a href="#l67.268"></a><span id="l67.268">   be_in_folder(folder);</span>
<a href="#l67.269"></a><span id="l67.269">   let msg = select_click_row(2); // row 2 is the one with no content type</span>
<a href="#l67.270"></a><span id="l67.270">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l67.271"></a><span id="l67.271"> </span>
<a href="#l67.272"></a><span id="l67.272">   let rwc = open_compose_with_reply();</span>
<a href="#l67.273"></a><span id="l67.273">   close_compose_window(rwc, false);</span>
<a href="#l67.274"></a><span id="l67.274"> </span>
<a href="#l67.275"></a><span id="l67.275">   let fwc = open_compose_with_forward();</span>
<a href="#l67.276"></a><span id="l67.276" class="difflineminus">-  assert_equals(</span>
<a href="#l67.277"></a><span id="l67.277" class="difflineplus">+  Assert.equal(</span>
<a href="#l67.278"></a><span id="l67.278">     fwc.e(&quot;attachmentBucket&quot;).getRowCount(),</span>
<a href="#l67.279"></a><span id="l67.279">     0,</span>
<a href="#l67.280"></a><span id="l67.280">     &quot;forwarding msg created attachment&quot;</span>
<a href="#l67.281"></a><span id="l67.281">   );</span>
<a href="#l67.282"></a><span id="l67.282">   close_compose_window(fwc, false);</span>
<a href="#l67.283"></a><span id="l67.283" class="difflineminus">-}</span>
<a href="#l67.284"></a><span id="l67.284" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1">copy from mail/test/mozmill/composition/test-send-button.js</span>
<a href="#l68.2"></a><span id="l68.2">copy to mail/test/browser/composition/browser_sendButton.js</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-send-button.js</span>
<a href="#l68.4"></a><span id="l68.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_sendButton.js</span>
<a href="#l68.5"></a><span id="l68.5" class="difflineat">@@ -4,31 +4,28 @@</span>
<a href="#l68.6"></a><span id="l68.6"> </span>
<a href="#l68.7"></a><span id="l68.7"> /**</span>
<a href="#l68.8"></a><span id="l68.8">  * Tests proper enabling of send buttons depending on addresses input.</span>
<a href="#l68.9"></a><span id="l68.9">  */</span>
<a href="#l68.10"></a><span id="l68.10"> </span>
<a href="#l68.11"></a><span id="l68.11"> &quot;use strict&quot;;</span>
<a href="#l68.12"></a><span id="l68.12"> </span>
<a href="#l68.13"></a><span id="l68.13"> var elib = ChromeUtils.import(</span>
<a href="#l68.14"></a><span id="l68.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l68.15"></a><span id="l68.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l68.16"></a><span id="l68.16"> );</span>
<a href="#l68.17"></a><span id="l68.17" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l68.18"></a><span id="l68.18" class="difflineplus">+var utils = ChromeUtils.import(&quot;resource://testing-common/mozmill/utils.jsm&quot;);</span>
<a href="#l68.19"></a><span id="l68.19"> </span>
<a href="#l68.20"></a><span id="l68.20"> var {</span>
<a href="#l68.21"></a><span id="l68.21">   create_contact,</span>
<a href="#l68.22"></a><span id="l68.22">   create_mailing_list,</span>
<a href="#l68.23"></a><span id="l68.23">   load_contacts_into_address_book,</span>
<a href="#l68.24"></a><span id="l68.24"> } = ChromeUtils.import(</span>
<a href="#l68.25"></a><span id="l68.25">   &quot;resource://testing-common/mozmill/AddressBookHelpers.jsm&quot;</span>
<a href="#l68.26"></a><span id="l68.26"> );</span>
<a href="#l68.27"></a><span id="l68.27"> var {</span>
<a href="#l68.28"></a><span id="l68.28" class="difflineminus">-  assert_equals,</span>
<a href="#l68.29"></a><span id="l68.29" class="difflineminus">-  assert_false,</span>
<a href="#l68.30"></a><span id="l68.30" class="difflineminus">-  assert_true,</span>
<a href="#l68.31"></a><span id="l68.31">   be_in_folder,</span>
<a href="#l68.32"></a><span id="l68.32">   click_tree_row,</span>
<a href="#l68.33"></a><span id="l68.33">   FAKE_SERVER_HOSTNAME,</span>
<a href="#l68.34"></a><span id="l68.34">   get_special_folder,</span>
<a href="#l68.35"></a><span id="l68.35"> } = ChromeUtils.import(</span>
<a href="#l68.36"></a><span id="l68.36">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l68.37"></a><span id="l68.37"> );</span>
<a href="#l68.38"></a><span id="l68.38"> var {</span>
<a href="#l68.39"></a><span id="l68.39" class="difflineat">@@ -46,63 +43,57 @@ var { AppConstants } = ChromeUtils.impor</span>
<a href="#l68.40"></a><span id="l68.40">   &quot;resource://gre/modules/AppConstants.jsm&quot;</span>
<a href="#l68.41"></a><span id="l68.41"> );</span>
<a href="#l68.42"></a><span id="l68.42"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l68.43"></a><span id="l68.43">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l68.44"></a><span id="l68.44"> );</span>
<a href="#l68.45"></a><span id="l68.45"> </span>
<a href="#l68.46"></a><span id="l68.46"> var account = null;</span>
<a href="#l68.47"></a><span id="l68.47"> </span>
<a href="#l68.48"></a><span id="l68.48" class="difflineminus">-function setupModule(module) {</span>
<a href="#l68.49"></a><span id="l68.49" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l68.50"></a><span id="l68.50">   // Ensure we're in the tinderbox account as that has the right identities set</span>
<a href="#l68.51"></a><span id="l68.51">   // up for this test.</span>
<a href="#l68.52"></a><span id="l68.52">   let server = MailServices.accounts.FindServer(</span>
<a href="#l68.53"></a><span id="l68.53">     &quot;tinderbox&quot;,</span>
<a href="#l68.54"></a><span id="l68.54">     FAKE_SERVER_HOSTNAME,</span>
<a href="#l68.55"></a><span id="l68.55">     &quot;pop3&quot;</span>
<a href="#l68.56"></a><span id="l68.56">   );</span>
<a href="#l68.57"></a><span id="l68.57">   account = MailServices.accounts.FindAccountForServer(server);</span>
<a href="#l68.58"></a><span id="l68.58">   let inbox = get_special_folder(Ci.nsMsgFolderFlags.Inbox, false, server);</span>
<a href="#l68.59"></a><span id="l68.59">   be_in_folder(inbox);</span>
<a href="#l68.60"></a><span id="l68.60" class="difflineminus">-}</span>
<a href="#l68.61"></a><span id="l68.61" class="difflineplus">+});</span>
<a href="#l68.62"></a><span id="l68.62"> </span>
<a href="#l68.63"></a><span id="l68.63"> /**</span>
<a href="#l68.64"></a><span id="l68.64">  * Check if the send commands are in the wished state.</span>
<a href="#l68.65"></a><span id="l68.65">  *</span>
<a href="#l68.66"></a><span id="l68.66">  * @param aCwc      The compose window controller.</span>
<a href="#l68.67"></a><span id="l68.67">  * @param aEnabled  The expected state of the commands.</span>
<a href="#l68.68"></a><span id="l68.68">  */</span>
<a href="#l68.69"></a><span id="l68.69"> function check_send_commands_state(aCwc, aEnabled) {</span>
<a href="#l68.70"></a><span id="l68.70" class="difflineminus">-  assert_equals(aCwc.e(&quot;cmd_sendButton&quot;).hasAttribute(&quot;disabled&quot;), !aEnabled);</span>
<a href="#l68.71"></a><span id="l68.71" class="difflineminus">-  assert_equals(aCwc.e(&quot;cmd_sendNow&quot;).hasAttribute(&quot;disabled&quot;), !aEnabled);</span>
<a href="#l68.72"></a><span id="l68.72" class="difflineminus">-  assert_equals(</span>
<a href="#l68.73"></a><span id="l68.73" class="difflineminus">-    aCwc.e(&quot;cmd_sendWithCheck&quot;).hasAttribute(&quot;disabled&quot;),</span>
<a href="#l68.74"></a><span id="l68.74" class="difflineminus">-    !aEnabled</span>
<a href="#l68.75"></a><span id="l68.75" class="difflineminus">-  );</span>
<a href="#l68.76"></a><span id="l68.76" class="difflineminus">-  assert_equals(aCwc.e(&quot;cmd_sendLater&quot;).hasAttribute(&quot;disabled&quot;), !aEnabled);</span>
<a href="#l68.77"></a><span id="l68.77" class="difflineplus">+  Assert.equal(aCwc.e(&quot;cmd_sendButton&quot;).hasAttribute(&quot;disabled&quot;), !aEnabled);</span>
<a href="#l68.78"></a><span id="l68.78" class="difflineplus">+  Assert.equal(aCwc.e(&quot;cmd_sendNow&quot;).hasAttribute(&quot;disabled&quot;), !aEnabled);</span>
<a href="#l68.79"></a><span id="l68.79" class="difflineplus">+  Assert.equal(aCwc.e(&quot;cmd_sendWithCheck&quot;).hasAttribute(&quot;disabled&quot;), !aEnabled);</span>
<a href="#l68.80"></a><span id="l68.80" class="difflineplus">+  Assert.equal(aCwc.e(&quot;cmd_sendLater&quot;).hasAttribute(&quot;disabled&quot;), !aEnabled);</span>
<a href="#l68.81"></a><span id="l68.81"> </span>
<a href="#l68.82"></a><span id="l68.82">   // The toolbar buttons and menuitems should be linked to these commands</span>
<a href="#l68.83"></a><span id="l68.83">   // thus inheriting the enabled state. Check that on the Send button</span>
<a href="#l68.84"></a><span id="l68.84">   // and Send Now menuitem.</span>
<a href="#l68.85"></a><span id="l68.85" class="difflineminus">-  assert_equals(</span>
<a href="#l68.86"></a><span id="l68.86" class="difflineminus">-    aCwc.e(&quot;button-send&quot;).getAttribute(&quot;command&quot;),</span>
<a href="#l68.87"></a><span id="l68.87" class="difflineminus">-    &quot;cmd_sendButton&quot;</span>
<a href="#l68.88"></a><span id="l68.88" class="difflineminus">-  );</span>
<a href="#l68.89"></a><span id="l68.89" class="difflineminus">-  assert_equals(</span>
<a href="#l68.90"></a><span id="l68.90" class="difflineplus">+  Assert.equal(aCwc.e(&quot;button-send&quot;).getAttribute(&quot;command&quot;), &quot;cmd_sendButton&quot;);</span>
<a href="#l68.91"></a><span id="l68.91" class="difflineplus">+  Assert.equal(</span>
<a href="#l68.92"></a><span id="l68.92">     aCwc.e(&quot;menu-item-send-now&quot;).getAttribute(&quot;command&quot;),</span>
<a href="#l68.93"></a><span id="l68.93">     &quot;cmd_sendNow&quot;</span>
<a href="#l68.94"></a><span id="l68.94">   );</span>
<a href="#l68.95"></a><span id="l68.95"> }</span>
<a href="#l68.96"></a><span id="l68.96"> </span>
<a href="#l68.97"></a><span id="l68.97"> /**</span>
<a href="#l68.98"></a><span id="l68.98">  * Bug 431217</span>
<a href="#l68.99"></a><span id="l68.99">  * Test that the Send buttons are properly enabled if an addressee is input</span>
<a href="#l68.100"></a><span id="l68.100">  * by the user.</span>
<a href="#l68.101"></a><span id="l68.101">  */</span>
<a href="#l68.102"></a><span id="l68.102" class="difflineminus">-function test_send_enabled_manual_address() {</span>
<a href="#l68.103"></a><span id="l68.103" class="difflineplus">+add_task(function test_send_enabled_manual_address() {</span>
<a href="#l68.104"></a><span id="l68.104">   let cwc = open_compose_new_mail(); // compose controller</span>
<a href="#l68.105"></a><span id="l68.105">   // On an empty window, Send must be disabled.</span>
<a href="#l68.106"></a><span id="l68.106">   check_send_commands_state(cwc, false);</span>
<a href="#l68.107"></a><span id="l68.107"> </span>
<a href="#l68.108"></a><span id="l68.108">   // On valid &quot;To:&quot; addressee input, Send must be enabled.</span>
<a href="#l68.109"></a><span id="l68.109">   toggle_recipient_type(cwc, &quot;addr_to&quot;);</span>
<a href="#l68.110"></a><span id="l68.110">   setup_msg_contents(cwc, &quot; recipient@fake.invalid &quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l68.111"></a><span id="l68.111">   check_send_commands_state(cwc, true);</span>
<a href="#l68.112"></a><span id="l68.112" class="difflineat">@@ -129,22 +120,22 @@ function test_send_enabled_manual_addres</span>
<a href="#l68.113"></a><span id="l68.113">   // On macOS the focus is automatically returned to the input box after operating</span>
<a href="#l68.114"></a><span id="l68.114">   // the type box and no focus event is fired. So the recipient is not selected</span>
<a href="#l68.115"></a><span id="l68.115">   // and the caret is after the last typed character (where we left off).</span>
<a href="#l68.116"></a><span id="l68.116">   if (AppConstants.platform == &quot;macosx&quot;) {</span>
<a href="#l68.117"></a><span id="l68.117">     // Click subject and then back to recipient input to see that it gets selected.</span>
<a href="#l68.118"></a><span id="l68.118">     cwc.click(cwc.eid(&quot;msgSubject&quot;));</span>
<a href="#l68.119"></a><span id="l68.119">     cwc.click(cwc.eid(&quot;addressCol2#1&quot;));</span>
<a href="#l68.120"></a><span id="l68.120">   }</span>
<a href="#l68.121"></a><span id="l68.121" class="difflineminus">-  assert_equals(cwc.e(&quot;addressCol2#1&quot;).selectionStart, 0);</span>
<a href="#l68.122"></a><span id="l68.122" class="difflineplus">+  Assert.equal(cwc.e(&quot;addressCol2#1&quot;).selectionStart, 0);</span>
<a href="#l68.123"></a><span id="l68.123">   // End of selection counts the length of the &quot; recipient@&quot; string from above.</span>
<a href="#l68.124"></a><span id="l68.124" class="difflineminus">-  assert_equals(cwc.e(&quot;addressCol2#1&quot;).selectionEnd, 11);</span>
<a href="#l68.125"></a><span id="l68.125" class="difflineplus">+  Assert.equal(cwc.e(&quot;addressCol2#1&quot;).selectionEnd, 11);</span>
<a href="#l68.126"></a><span id="l68.126">   // Another click after the recipient deselects it to allow typing.</span>
<a href="#l68.127"></a><span id="l68.127">   cwc.click(cwc.eid(&quot;addressCol2#1&quot;), 200, 5);</span>
<a href="#l68.128"></a><span id="l68.128" class="difflineminus">-  assert_equals(cwc.e(&quot;addressCol2#1&quot;).selectionStart, 11);</span>
<a href="#l68.129"></a><span id="l68.129" class="difflineplus">+  Assert.equal(cwc.e(&quot;addressCol2#1&quot;).selectionStart, 11);</span>
<a href="#l68.130"></a><span id="l68.130">   // This types additional characters into the recipient.</span>
<a href="#l68.131"></a><span id="l68.131">   setup_msg_contents(cwc, &quot;domain.invalid&quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l68.132"></a><span id="l68.132">   check_send_commands_state(cwc, true);</span>
<a href="#l68.133"></a><span id="l68.133"> </span>
<a href="#l68.134"></a><span id="l68.134">   clear_recipient(cwc);</span>
<a href="#l68.135"></a><span id="l68.135">   check_send_commands_state(cwc, false);</span>
<a href="#l68.136"></a><span id="l68.136"> </span>
<a href="#l68.137"></a><span id="l68.137">   // - a mailinglist in addressbook</span>
<a href="#l68.138"></a><span id="l68.138" class="difflineat">@@ -166,24 +157,24 @@ function test_send_enabled_manual_addres</span>
<a href="#l68.139"></a><span id="l68.139">   check_send_commands_state(cwc, false);</span>
<a href="#l68.140"></a><span id="l68.140"> </span>
<a href="#l68.141"></a><span id="l68.141">   // - some string as a newsgroup</span>
<a href="#l68.142"></a><span id="l68.142">   toggle_recipient_type(cwc, &quot;addr_newsgroups&quot;);</span>
<a href="#l68.143"></a><span id="l68.143">   setup_msg_contents(cwc, &quot;newsgroup &quot;, &quot;&quot;, &quot;&quot;);</span>
<a href="#l68.144"></a><span id="l68.144">   check_send_commands_state(cwc, true);</span>
<a href="#l68.145"></a><span id="l68.145"> </span>
<a href="#l68.146"></a><span id="l68.146">   close_compose_window(cwc);</span>
<a href="#l68.147"></a><span id="l68.147" class="difflineminus">-}</span>
<a href="#l68.148"></a><span id="l68.148" class="difflineplus">+});</span>
<a href="#l68.149"></a><span id="l68.149"> </span>
<a href="#l68.150"></a><span id="l68.150"> /**</span>
<a href="#l68.151"></a><span id="l68.151">  * Bug 431217</span>
<a href="#l68.152"></a><span id="l68.152">  * Test that the Send buttons are properly enabled if an addressee is prefilled</span>
<a href="#l68.153"></a><span id="l68.153">  * automatically via account prefs.</span>
<a href="#l68.154"></a><span id="l68.154">  */</span>
<a href="#l68.155"></a><span id="l68.155" class="difflineminus">-function test_send_enabled_prefilled_address() {</span>
<a href="#l68.156"></a><span id="l68.156" class="difflineplus">+add_task(function test_send_enabled_prefilled_address() {</span>
<a href="#l68.157"></a><span id="l68.157">   // Set the prefs to prefill a default CC address when Compose is opened.</span>
<a href="#l68.158"></a><span id="l68.158">   let identity = account.defaultIdentity;</span>
<a href="#l68.159"></a><span id="l68.159">   identity.doCc = true;</span>
<a href="#l68.160"></a><span id="l68.160">   identity.doCcList = &quot;Auto@recipient.invalid&quot;;</span>
<a href="#l68.161"></a><span id="l68.161"> </span>
<a href="#l68.162"></a><span id="l68.162">   // In that case the recipient is input, enabled Send.</span>
<a href="#l68.163"></a><span id="l68.163">   let cwc = open_compose_new_mail(); // compose controller</span>
<a href="#l68.164"></a><span id="l68.164">   check_send_commands_state(cwc, true);</span>
<a href="#l68.165"></a><span id="l68.165" class="difflineat">@@ -192,67 +183,67 @@ function test_send_enabled_prefilled_add</span>
<a href="#l68.166"></a><span id="l68.166">   // Send should become disabled.</span>
<a href="#l68.167"></a><span id="l68.167">   cwc.e(&quot;addressCol2#1&quot;).select();</span>
<a href="#l68.168"></a><span id="l68.168">   cwc.keypress(null, &quot;VK_BACK_SPACE&quot;, {});</span>
<a href="#l68.169"></a><span id="l68.169">   check_send_commands_state(cwc, false);</span>
<a href="#l68.170"></a><span id="l68.170"> </span>
<a href="#l68.171"></a><span id="l68.171">   close_compose_window(cwc);</span>
<a href="#l68.172"></a><span id="l68.172">   identity.doCcList = &quot;&quot;;</span>
<a href="#l68.173"></a><span id="l68.173">   identity.doCc = false;</span>
<a href="#l68.174"></a><span id="l68.174" class="difflineminus">-}</span>
<a href="#l68.175"></a><span id="l68.175" class="difflineplus">+});</span>
<a href="#l68.176"></a><span id="l68.176"> </span>
<a href="#l68.177"></a><span id="l68.177"> /**</span>
<a href="#l68.178"></a><span id="l68.178">  * Bug 933101</span>
<a href="#l68.179"></a><span id="l68.179">  * Similar to test_send_enabled_prefilled_address but switched between an identity</span>
<a href="#l68.180"></a><span id="l68.180">  * that has a CC list and one that doesn't directly in the compose window.</span>
<a href="#l68.181"></a><span id="l68.181">  */</span>
<a href="#l68.182"></a><span id="l68.182" class="difflineminus">-function test_send_enabled_prefilled_address_from_identity() {</span>
<a href="#l68.183"></a><span id="l68.183" class="difflineplus">+add_task(function test_send_enabled_prefilled_address_from_identity() {</span>
<a href="#l68.184"></a><span id="l68.184">   // The first identity will have an automatic CC enabled.</span>
<a href="#l68.185"></a><span id="l68.185">   let identityWithCC = account.defaultIdentity;</span>
<a href="#l68.186"></a><span id="l68.186">   identityWithCC.doCc = true;</span>
<a href="#l68.187"></a><span id="l68.187">   identityWithCC.doCcList = &quot;Auto@recipient.invalid&quot;;</span>
<a href="#l68.188"></a><span id="l68.188"> </span>
<a href="#l68.189"></a><span id="l68.189">   // CC is prefilled, Send enabled.</span>
<a href="#l68.190"></a><span id="l68.190">   let cwc = open_compose_new_mail();</span>
<a href="#l68.191"></a><span id="l68.191">   check_send_commands_state(cwc, true);</span>
<a href="#l68.192"></a><span id="l68.192"> </span>
<a href="#l68.193"></a><span id="l68.193">   let identityPicker = cwc.e(&quot;msgIdentity&quot;);</span>
<a href="#l68.194"></a><span id="l68.194" class="difflineminus">-  assert_equals(identityPicker.selectedIndex, 0);</span>
<a href="#l68.195"></a><span id="l68.195" class="difflineplus">+  Assert.equal(identityPicker.selectedIndex, 0);</span>
<a href="#l68.196"></a><span id="l68.196"> </span>
<a href="#l68.197"></a><span id="l68.197">   // Switch to the second identity that has no CC. Send should be disabled.</span>
<a href="#l68.198"></a><span id="l68.198" class="difflineminus">-  assert_true(account.identities.length &gt;= 2);</span>
<a href="#l68.199"></a><span id="l68.199" class="difflineplus">+  Assert.ok(account.identities.length &gt;= 2);</span>
<a href="#l68.200"></a><span id="l68.200">   let identityWithoutCC = account.identities.queryElementAt(</span>
<a href="#l68.201"></a><span id="l68.201">     1,</span>
<a href="#l68.202"></a><span id="l68.202">     Ci.nsIMsgIdentity</span>
<a href="#l68.203"></a><span id="l68.203">   );</span>
<a href="#l68.204"></a><span id="l68.204" class="difflineminus">-  assert_false(identityWithoutCC.doCc);</span>
<a href="#l68.205"></a><span id="l68.205" class="difflineplus">+  Assert.ok(!identityWithoutCC.doCc);</span>
<a href="#l68.206"></a><span id="l68.206">   cwc.click(cwc.eid(&quot;msgIdentity&quot;));</span>
<a href="#l68.207"></a><span id="l68.207">   cwc.click_menus_in_sequence(cwc.e(&quot;msgIdentityPopup&quot;), [</span>
<a href="#l68.208"></a><span id="l68.208">     { identitykey: identityWithoutCC.key },</span>
<a href="#l68.209"></a><span id="l68.209">   ]);</span>
<a href="#l68.210"></a><span id="l68.210">   check_send_commands_state(cwc, false);</span>
<a href="#l68.211"></a><span id="l68.211"> </span>
<a href="#l68.212"></a><span id="l68.212">   // Check the first identity again.</span>
<a href="#l68.213"></a><span id="l68.213">   cwc.click(cwc.eid(&quot;msgIdentity&quot;));</span>
<a href="#l68.214"></a><span id="l68.214">   cwc.click_menus_in_sequence(cwc.e(&quot;msgIdentityPopup&quot;), [</span>
<a href="#l68.215"></a><span id="l68.215">     { identitykey: identityWithCC.key },</span>
<a href="#l68.216"></a><span id="l68.216">   ]);</span>
<a href="#l68.217"></a><span id="l68.217">   check_send_commands_state(cwc, true);</span>
<a href="#l68.218"></a><span id="l68.218"> </span>
<a href="#l68.219"></a><span id="l68.219">   close_compose_window(cwc);</span>
<a href="#l68.220"></a><span id="l68.220">   identityWithCC.doCcList = &quot;&quot;;</span>
<a href="#l68.221"></a><span id="l68.221">   identityWithCC.doCc = false;</span>
<a href="#l68.222"></a><span id="l68.222" class="difflineminus">-}</span>
<a href="#l68.223"></a><span id="l68.223" class="difflineplus">+});</span>
<a href="#l68.224"></a><span id="l68.224"> </span>
<a href="#l68.225"></a><span id="l68.225"> /**</span>
<a href="#l68.226"></a><span id="l68.226">  * Bug 863231</span>
<a href="#l68.227"></a><span id="l68.227">  * Test that the Send buttons are properly enabled if an addressee is populated</span>
<a href="#l68.228"></a><span id="l68.228">  * via the Contacts sidebar.</span>
<a href="#l68.229"></a><span id="l68.229">  */</span>
<a href="#l68.230"></a><span id="l68.230" class="difflineminus">-function test_send_enabled_address_contacts_sidebar() {</span>
<a href="#l68.231"></a><span id="l68.231" class="difflineplus">+add_task(function test_send_enabled_address_contacts_sidebar() {</span>
<a href="#l68.232"></a><span id="l68.232">   // Create some contact address book card in the Personal addressbook.</span>
<a href="#l68.233"></a><span id="l68.233">   let defaultAB = MailServices.ab.getDirectory(&quot;jsaddrbook://abook.sqlite&quot;);</span>
<a href="#l68.234"></a><span id="l68.234">   let contact = create_contact(&quot;test@example.com&quot;, &quot;Sammy Jenkis&quot;, true);</span>
<a href="#l68.235"></a><span id="l68.235">   load_contacts_into_address_book(defaultAB, [contact]);</span>
<a href="#l68.236"></a><span id="l68.236"> </span>
<a href="#l68.237"></a><span id="l68.237">   let cwc = open_compose_new_mail(); // compose controller</span>
<a href="#l68.238"></a><span id="l68.238">   // On an empty window, Send must be disabled.</span>
<a href="#l68.239"></a><span id="l68.239">   check_send_commands_state(cwc, false);</span>
<a href="#l68.240"></a><span id="l68.240" class="difflineat">@@ -276,9 +267,9 @@ function test_send_enabled_address_conta</span>
<a href="#l68.241"></a><span id="l68.241"> </span>
<a href="#l68.242"></a><span id="l68.242">   sidebar.contentDocument.getElementById(&quot;ccButton&quot;).click();</span>
<a href="#l68.243"></a><span id="l68.243"> </span>
<a href="#l68.244"></a><span id="l68.244">   // The recipient is filled in, Send must be enabled.</span>
<a href="#l68.245"></a><span id="l68.245">   check_send_commands_state(cwc, true);</span>
<a href="#l68.246"></a><span id="l68.246"> </span>
<a href="#l68.247"></a><span id="l68.247">   cwc.window.toggleAddressPicker();</span>
<a href="#l68.248"></a><span id="l68.248">   close_compose_window(cwc);</span>
<a href="#l68.249"></a><span id="l68.249" class="difflineminus">-}</span>
<a href="#l68.250"></a><span id="l68.250" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1">copy from mail/test/mozmill/composition/test-send-format.js</span>
<a href="#l69.2"></a><span id="l69.2">copy to mail/test/browser/composition/browser_sendFormat.js</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-send-format.js</span>
<a href="#l69.4"></a><span id="l69.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_sendFormat.js</span>
<a href="#l69.5"></a><span id="l69.5" class="difflineat">@@ -4,50 +4,46 @@</span>
<a href="#l69.6"></a><span id="l69.6"> </span>
<a href="#l69.7"></a><span id="l69.7"> /**</span>
<a href="#l69.8"></a><span id="l69.8">  * Tests resulting send format of a message dependent on using HTML features</span>
<a href="#l69.9"></a><span id="l69.9">  * in the composition.</span>
<a href="#l69.10"></a><span id="l69.10">  */</span>
<a href="#l69.11"></a><span id="l69.11"> </span>
<a href="#l69.12"></a><span id="l69.12"> &quot;use strict&quot;;</span>
<a href="#l69.13"></a><span id="l69.13"> </span>
<a href="#l69.14"></a><span id="l69.14" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l69.15"></a><span id="l69.15" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l69.16"></a><span id="l69.16"> </span>
<a href="#l69.17"></a><span id="l69.17"> var { close_compose_window, open_compose_with_reply } = ChromeUtils.import(</span>
<a href="#l69.18"></a><span id="l69.18">   &quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;</span>
<a href="#l69.19"></a><span id="l69.19"> );</span>
<a href="#l69.20"></a><span id="l69.20" class="difflineminus">-var { assert_equals, open_message_from_file } = ChromeUtils.import(</span>
<a href="#l69.21"></a><span id="l69.21" class="difflineplus">+var { open_message_from_file } = ChromeUtils.import(</span>
<a href="#l69.22"></a><span id="l69.22">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l69.23"></a><span id="l69.23"> );</span>
<a href="#l69.24"></a><span id="l69.24"> var { close_window } = ChromeUtils.import(</span>
<a href="#l69.25"></a><span id="l69.25">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l69.26"></a><span id="l69.26"> );</span>
<a href="#l69.27"></a><span id="l69.27"> </span>
<a href="#l69.28"></a><span id="l69.28"> function checkMsgFile(aFilePath, aConvertibility) {</span>
<a href="#l69.29"></a><span id="l69.29" class="difflineminus">-  let file = os.getFileForPath(</span>
<a href="#l69.30"></a><span id="l69.30" class="difflineminus">-    os.abspath(aFilePath, os.getFileForPath(__file__))</span>
<a href="#l69.31"></a><span id="l69.31" class="difflineminus">-  );</span>
<a href="#l69.32"></a><span id="l69.32" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(`data/${aFilePath}`));</span>
<a href="#l69.33"></a><span id="l69.33">   let msgc = open_message_from_file(file);</span>
<a href="#l69.34"></a><span id="l69.34"> </span>
<a href="#l69.35"></a><span id="l69.35">   // Creating a reply should not affect convertibility.</span>
<a href="#l69.36"></a><span id="l69.36">   let cwc = open_compose_with_reply(msgc);</span>
<a href="#l69.37"></a><span id="l69.37"> </span>
<a href="#l69.38"></a><span id="l69.38" class="difflineminus">-  assert_equals(cwc.window.DetermineConvertibility(), aConvertibility);</span>
<a href="#l69.39"></a><span id="l69.39" class="difflineplus">+  Assert.equal(cwc.window.DetermineConvertibility(), aConvertibility);</span>
<a href="#l69.40"></a><span id="l69.40"> </span>
<a href="#l69.41"></a><span id="l69.41">   close_compose_window(cwc);</span>
<a href="#l69.42"></a><span id="l69.42">   close_window(msgc);</span>
<a href="#l69.43"></a><span id="l69.43"> }</span>
<a href="#l69.44"></a><span id="l69.44"> </span>
<a href="#l69.45"></a><span id="l69.45"> /**</span>
<a href="#l69.46"></a><span id="l69.46">  * Tests that we only open one compose window for one instance of a draft.</span>
<a href="#l69.47"></a><span id="l69.47">  */</span>
<a href="#l69.48"></a><span id="l69.48" class="difflineminus">-function test_msg_convertibility() {</span>
<a href="#l69.49"></a><span id="l69.49" class="difflineplus">+add_task(function test_msg_convertibility() {</span>
<a href="#l69.50"></a><span id="l69.50">   checkMsgFile(&quot;./format1-plain.eml&quot;, Ci.nsIMsgCompConvertible.Plain);</span>
<a href="#l69.51"></a><span id="l69.51"> </span>
<a href="#l69.52"></a><span id="l69.52">   // Bug 1385636</span>
<a href="#l69.53"></a><span id="l69.53">   checkMsgFile(&quot;./format1-altering.eml&quot;, Ci.nsIMsgCompConvertible.Altering);</span>
<a href="#l69.54"></a><span id="l69.54"> </span>
<a href="#l69.55"></a><span id="l69.55">   // Bug 584313</span>
<a href="#l69.56"></a><span id="l69.56">   checkMsgFile(&quot;./format2-style-attr.eml&quot;, Ci.nsIMsgCompConvertible.No);</span>
<a href="#l69.57"></a><span id="l69.57">   checkMsgFile(&quot;./format3-style-tag.eml&quot;, Ci.nsIMsgCompConvertible.No);</span>
<a href="#l69.58"></a><span id="l69.58" class="difflineminus">-}</span>
<a href="#l69.59"></a><span id="l69.59" class="difflineminus">-</span>
<a href="#l69.60"></a><span id="l69.60" class="difflineminus">-function teardownModule() {}</span>
<a href="#l69.61"></a><span id="l69.61" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1">copy from mail/test/mozmill/composition/test-signature-init.js</span>
<a href="#l70.2"></a><span id="l70.2">copy to mail/test/browser/composition/browser_signatureInit.js</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-signature-init.js</span>
<a href="#l70.4"></a><span id="l70.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_signatureInit.js</span>
<a href="#l70.5"></a><span id="l70.5" class="difflineat">@@ -4,51 +4,52 @@</span>
<a href="#l70.6"></a><span id="l70.6"> </span>
<a href="#l70.7"></a><span id="l70.7"> /**</span>
<a href="#l70.8"></a><span id="l70.8">  * Tests that the compose window initializes with the signature correctly</span>
<a href="#l70.9"></a><span id="l70.9">  * under various circumstances.</span>
<a href="#l70.10"></a><span id="l70.10">  */</span>
<a href="#l70.11"></a><span id="l70.11"> </span>
<a href="#l70.12"></a><span id="l70.12"> &quot;use strict&quot;;</span>
<a href="#l70.13"></a><span id="l70.13"> </span>
<a href="#l70.14"></a><span id="l70.14" class="difflineminus">-var { get_compose_body, open_compose_new_mail } = ChromeUtils.import(</span>
<a href="#l70.15"></a><span id="l70.15" class="difflineminus">-  &quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;</span>
<a href="#l70.16"></a><span id="l70.16" class="difflineminus">-);</span>
<a href="#l70.17"></a><span id="l70.17" class="difflineminus">-var { assert_equals } = ChromeUtils.import(</span>
<a href="#l70.18"></a><span id="l70.18" class="difflineminus">-  &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l70.19"></a><span id="l70.19" class="difflineminus">-);</span>
<a href="#l70.20"></a><span id="l70.20" class="difflineplus">+var {</span>
<a href="#l70.21"></a><span id="l70.21" class="difflineplus">+  close_compose_window,</span>
<a href="#l70.22"></a><span id="l70.22" class="difflineplus">+  get_compose_body,</span>
<a href="#l70.23"></a><span id="l70.23" class="difflineplus">+  open_compose_new_mail,</span>
<a href="#l70.24"></a><span id="l70.24" class="difflineplus">+} = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l70.25"></a><span id="l70.25"> </span>
<a href="#l70.26"></a><span id="l70.26"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l70.27"></a><span id="l70.27"> </span>
<a href="#l70.28"></a><span id="l70.28"> var kHtmlPref = &quot;mail.identity.default.compose_html&quot;;</span>
<a href="#l70.29"></a><span id="l70.29"> var kReplyOnTopPref = &quot;mail.identity.default.reply_on_top&quot;;</span>
<a href="#l70.30"></a><span id="l70.30"> var kReplyOnTop = 1;</span>
<a href="#l70.31"></a><span id="l70.31"> var kSigBottomPref = &quot;mail.identity.default.sig_bottom&quot;;</span>
<a href="#l70.32"></a><span id="l70.32"> </span>
<a href="#l70.33"></a><span id="l70.33"> /**</span>
<a href="#l70.34"></a><span id="l70.34">  * Regression test for bug 762413 - tests that when we're set to reply above,</span>
<a href="#l70.35"></a><span id="l70.35">  * with the signature below the reply, we initialize the compose window such</span>
<a href="#l70.36"></a><span id="l70.36">  * that there is a &lt;br&gt; node above the signature. This allows the user to</span>
<a href="#l70.37"></a><span id="l70.37">  * insert text before the signature.</span>
<a href="#l70.38"></a><span id="l70.38">  */</span>
<a href="#l70.39"></a><span id="l70.39" class="difflineminus">-function test_on_reply_above_signature_below_reply() {</span>
<a href="#l70.40"></a><span id="l70.40" class="difflineplus">+add_task(function test_on_reply_above_signature_below_reply() {</span>
<a href="#l70.41"></a><span id="l70.41">   let origHtml = Services.prefs.getBoolPref(kHtmlPref);</span>
<a href="#l70.42"></a><span id="l70.42">   let origReplyOnTop = Services.prefs.getIntPref(kReplyOnTopPref);</span>
<a href="#l70.43"></a><span id="l70.43">   let origSigBottom = Services.prefs.getBoolPref(kSigBottomPref);</span>
<a href="#l70.44"></a><span id="l70.44"> </span>
<a href="#l70.45"></a><span id="l70.45">   Services.prefs.setBoolPref(kHtmlPref, false);</span>
<a href="#l70.46"></a><span id="l70.46">   Services.prefs.setIntPref(kReplyOnTopPref, kReplyOnTop);</span>
<a href="#l70.47"></a><span id="l70.47">   Services.prefs.setBoolPref(kSigBottomPref, false);</span>
<a href="#l70.48"></a><span id="l70.48"> </span>
<a href="#l70.49"></a><span id="l70.49">   let cw = open_compose_new_mail();</span>
<a href="#l70.50"></a><span id="l70.50">   let mailBody = get_compose_body(cw);</span>
<a href="#l70.51"></a><span id="l70.51"> </span>
<a href="#l70.52"></a><span id="l70.52">   let node = mailBody.firstChild;</span>
<a href="#l70.53"></a><span id="l70.53" class="difflineminus">-  assert_equals(</span>
<a href="#l70.54"></a><span id="l70.54" class="difflineplus">+  Assert.equal(</span>
<a href="#l70.55"></a><span id="l70.55">     node.localName,</span>
<a href="#l70.56"></a><span id="l70.56">     &quot;br&quot;,</span>
<a href="#l70.57"></a><span id="l70.57">     &quot;Expected a BR node to start the compose body.&quot;</span>
<a href="#l70.58"></a><span id="l70.58">   );</span>
<a href="#l70.59"></a><span id="l70.59"> </span>
<a href="#l70.60"></a><span id="l70.60">   Services.prefs.setBoolPref(kHtmlPref, origHtml);</span>
<a href="#l70.61"></a><span id="l70.61">   Services.prefs.setIntPref(kReplyOnTopPref, origReplyOnTop);</span>
<a href="#l70.62"></a><span id="l70.62">   Services.prefs.setBoolPref(kSigBottomPref, origSigBottom);</span>
<a href="#l70.63"></a><span id="l70.63" class="difflineminus">-}</span>
<a href="#l70.64"></a><span id="l70.64" class="difflineplus">+</span>
<a href="#l70.65"></a><span id="l70.65" class="difflineplus">+  close_compose_window(cw);</span>
<a href="#l70.66"></a><span id="l70.66" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1">copy from mail/test/mozmill/composition/test-signature-updating.js</span>
<a href="#l71.2"></a><span id="l71.2">copy to mail/test/browser/composition/browser_signatureUpdating.js</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineminus">--- a/mail/test/mozmill/composition/test-signature-updating.js</span>
<a href="#l71.4"></a><span id="l71.4" class="difflineplus">+++ b/mail/test/browser/composition/browser_signatureUpdating.js</span>
<a href="#l71.5"></a><span id="l71.5" class="difflineat">@@ -15,53 +15,62 @@</span>
<a href="#l71.6"></a><span id="l71.6"> &quot;use strict&quot;;</span>
<a href="#l71.7"></a><span id="l71.7"> </span>
<a href="#l71.8"></a><span id="l71.8"> var {</span>
<a href="#l71.9"></a><span id="l71.9">   close_compose_window,</span>
<a href="#l71.10"></a><span id="l71.10">   open_compose_new_mail,</span>
<a href="#l71.11"></a><span id="l71.11">   setup_msg_contents,</span>
<a href="#l71.12"></a><span id="l71.12"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l71.13"></a><span id="l71.13"> var {</span>
<a href="#l71.14"></a><span id="l71.14" class="difflineminus">-  assert_equals,</span>
<a href="#l71.15"></a><span id="l71.15">   be_in_folder,</span>
<a href="#l71.16"></a><span id="l71.16">   FAKE_SERVER_HOSTNAME,</span>
<a href="#l71.17"></a><span id="l71.17">   get_special_folder,</span>
<a href="#l71.18"></a><span id="l71.18"> } = ChromeUtils.import(</span>
<a href="#l71.19"></a><span id="l71.19">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l71.20"></a><span id="l71.20"> );</span>
<a href="#l71.21"></a><span id="l71.21"> </span>
<a href="#l71.22"></a><span id="l71.22"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l71.23"></a><span id="l71.23">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l71.24"></a><span id="l71.24"> );</span>
<a href="#l71.25"></a><span id="l71.25"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l71.26"></a><span id="l71.26"> </span>
<a href="#l71.27"></a><span id="l71.27"> var cwc = null; // compose window controller</span>
<a href="#l71.28"></a><span id="l71.28"> </span>
<a href="#l71.29"></a><span id="l71.29" class="difflineminus">-function setupModule(module) {</span>
<a href="#l71.30"></a><span id="l71.30" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l71.31"></a><span id="l71.31" class="difflineplus">+  // These prefs can't be set in the manifest as they contain white-space.</span>
<a href="#l71.32"></a><span id="l71.32" class="difflineplus">+  Services.prefs.setStringPref(</span>
<a href="#l71.33"></a><span id="l71.33" class="difflineplus">+    &quot;mail.identity.id1.htmlSigText&quot;,</span>
<a href="#l71.34"></a><span id="l71.34" class="difflineplus">+    &quot;Tinderbox is soo 90ies&quot;</span>
<a href="#l71.35"></a><span id="l71.35" class="difflineplus">+  );</span>
<a href="#l71.36"></a><span id="l71.36" class="difflineplus">+  Services.prefs.setStringPref(</span>
<a href="#l71.37"></a><span id="l71.37" class="difflineplus">+    &quot;mail.identity.id2.htmlSigText&quot;,</span>
<a href="#l71.38"></a><span id="l71.38" class="difflineplus">+    &quot;Tinderboxpushlog is the new &lt;b&gt;hotness!&lt;/b&gt;&quot;</span>
<a href="#l71.39"></a><span id="l71.39" class="difflineplus">+  );</span>
<a href="#l71.40"></a><span id="l71.40" class="difflineplus">+</span>
<a href="#l71.41"></a><span id="l71.41">   // Ensure we're in the tinderbox account as that has the right identities set</span>
<a href="#l71.42"></a><span id="l71.42">   // up for this test.</span>
<a href="#l71.43"></a><span id="l71.43">   let server = MailServices.accounts.FindServer(</span>
<a href="#l71.44"></a><span id="l71.44">     &quot;tinderbox&quot;,</span>
<a href="#l71.45"></a><span id="l71.45">     FAKE_SERVER_HOSTNAME,</span>
<a href="#l71.46"></a><span id="l71.46">     &quot;pop3&quot;</span>
<a href="#l71.47"></a><span id="l71.47">   );</span>
<a href="#l71.48"></a><span id="l71.48">   let inbox = get_special_folder(Ci.nsMsgFolderFlags.Inbox, false, server);</span>
<a href="#l71.49"></a><span id="l71.49">   be_in_folder(inbox);</span>
<a href="#l71.50"></a><span id="l71.50" class="difflineminus">-}</span>
<a href="#l71.51"></a><span id="l71.51" class="difflineplus">+});</span>
<a href="#l71.52"></a><span id="l71.52"> </span>
<a href="#l71.53"></a><span id="l71.53" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l71.54"></a><span id="l71.54" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l71.55"></a><span id="l71.55">   Services.prefs.clearUserPref(&quot;mail.compose.default_to_paragraph&quot;);</span>
<a href="#l71.56"></a><span id="l71.56">   Services.prefs.clearUserPref(&quot;mail.identity.id1.compose_html&quot;);</span>
<a href="#l71.57"></a><span id="l71.57">   Services.prefs.clearUserPref(</span>
<a href="#l71.58"></a><span id="l71.58">     &quot;mail.identity.id1.suppress_signature_separator&quot;</span>
<a href="#l71.59"></a><span id="l71.59">   );</span>
<a href="#l71.60"></a><span id="l71.60">   Services.prefs.clearUserPref(</span>
<a href="#l71.61"></a><span id="l71.61">     &quot;mail.identity.id2.suppress_signature_separator&quot;</span>
<a href="#l71.62"></a><span id="l71.62">   );</span>
<a href="#l71.63"></a><span id="l71.63" class="difflineminus">-}</span>
<a href="#l71.64"></a><span id="l71.64" class="difflineplus">+});</span>
<a href="#l71.65"></a><span id="l71.65"> </span>
<a href="#l71.66"></a><span id="l71.66"> /**</span>
<a href="#l71.67"></a><span id="l71.67">  * Test that the plaintext compose window has a signature initially,</span>
<a href="#l71.68"></a><span id="l71.68">  * and has the correct signature after switching to another identity.</span>
<a href="#l71.69"></a><span id="l71.69">  */</span>
<a href="#l71.70"></a><span id="l71.70"> function plaintextComposeWindowSwitchSignatures(suppressSigSep) {</span>
<a href="#l71.71"></a><span id="l71.71">   Services.prefs.setBoolPref(&quot;mail.identity.id1.compose_html&quot;, false);</span>
<a href="#l71.72"></a><span id="l71.72">   Services.prefs.setBoolPref(</span>
<a href="#l71.73"></a><span id="l71.73" class="difflineat">@@ -74,100 +83,102 @@ function plaintextComposeWindowSwitchSig</span>
<a href="#l71.74"></a><span id="l71.74">   );</span>
<a href="#l71.75"></a><span id="l71.75">   cwc = open_compose_new_mail();</span>
<a href="#l71.76"></a><span id="l71.76"> </span>
<a href="#l71.77"></a><span id="l71.77">   let contentFrame = cwc.e(&quot;content-frame&quot;);</span>
<a href="#l71.78"></a><span id="l71.78">   let mailBody = contentFrame.contentDocument.body;</span>
<a href="#l71.79"></a><span id="l71.79"> </span>
<a href="#l71.80"></a><span id="l71.80">   // The first node in the body should be a BR node, which allows the user</span>
<a href="#l71.81"></a><span id="l71.81">   // to insert text before / outside of the signature.</span>
<a href="#l71.82"></a><span id="l71.82" class="difflineminus">-  assert_equals(mailBody.firstChild.localName, &quot;br&quot;);</span>
<a href="#l71.83"></a><span id="l71.83" class="difflineplus">+  Assert.equal(mailBody.firstChild.localName, &quot;br&quot;);</span>
<a href="#l71.84"></a><span id="l71.84"> </span>
<a href="#l71.85"></a><span id="l71.85">   setup_msg_contents(cwc, &quot;&quot;, &quot;Plaintext compose window&quot;, &quot;Body, first line.&quot;);</span>
<a href="#l71.86"></a><span id="l71.86"> </span>
<a href="#l71.87"></a><span id="l71.87">   let node = mailBody.lastChild;</span>
<a href="#l71.88"></a><span id="l71.88"> </span>
<a href="#l71.89"></a><span id="l71.89">   // The last node is a BR - this allows users to put text after the</span>
<a href="#l71.90"></a><span id="l71.90">   // signature without it being styled like the signature.</span>
<a href="#l71.91"></a><span id="l71.91" class="difflineminus">-  assert_equals(node.localName, &quot;br&quot;);</span>
<a href="#l71.92"></a><span id="l71.92" class="difflineplus">+  Assert.equal(node.localName, &quot;br&quot;);</span>
<a href="#l71.93"></a><span id="l71.93">   node = node.previousSibling;</span>
<a href="#l71.94"></a><span id="l71.94"> </span>
<a href="#l71.95"></a><span id="l71.95">   // Now we should have the DIV node that contains the signature, with</span>
<a href="#l71.96"></a><span id="l71.96">   // the class moz-signature.</span>
<a href="#l71.97"></a><span id="l71.97" class="difflineminus">-  assert_equals(node.localName, &quot;div&quot;);</span>
<a href="#l71.98"></a><span id="l71.98" class="difflineplus">+  Assert.equal(node.localName, &quot;div&quot;);</span>
<a href="#l71.99"></a><span id="l71.99"> </span>
<a href="#l71.100"></a><span id="l71.100">   const kSeparator = &quot;-- &quot;;</span>
<a href="#l71.101"></a><span id="l71.101">   const kSigClass = &quot;moz-signature&quot;;</span>
<a href="#l71.102"></a><span id="l71.102" class="difflineminus">-  assert_equals(node.className, kSigClass);</span>
<a href="#l71.103"></a><span id="l71.103" class="difflineplus">+  Assert.equal(node.className, kSigClass);</span>
<a href="#l71.104"></a><span id="l71.104"> </span>
<a href="#l71.105"></a><span id="l71.105">   let sigNode = node.firstChild;</span>
<a href="#l71.106"></a><span id="l71.106"> </span>
<a href="#l71.107"></a><span id="l71.107">   if (!suppressSigSep) {</span>
<a href="#l71.108"></a><span id="l71.108" class="difflineminus">-    assert_equals(sigNode.textContent, kSeparator);</span>
<a href="#l71.109"></a><span id="l71.109" class="difflineplus">+    Assert.equal(sigNode.textContent, kSeparator);</span>
<a href="#l71.110"></a><span id="l71.110">     let brNode = sigNode.nextSibling;</span>
<a href="#l71.111"></a><span id="l71.111" class="difflineminus">-    assert_equals(brNode.localName, &quot;br&quot;);</span>
<a href="#l71.112"></a><span id="l71.112" class="difflineplus">+    Assert.equal(brNode.localName, &quot;br&quot;);</span>
<a href="#l71.113"></a><span id="l71.113">     sigNode = brNode.nextSibling;</span>
<a href="#l71.114"></a><span id="l71.114">   }</span>
<a href="#l71.115"></a><span id="l71.115"> </span>
<a href="#l71.116"></a><span id="l71.116">   let expectedText = &quot;Tinderbox is soo 90ies&quot;;</span>
<a href="#l71.117"></a><span id="l71.117" class="difflineminus">-  assert_equals(sigNode.textContent, expectedText);</span>
<a href="#l71.118"></a><span id="l71.118" class="difflineplus">+  Assert.equal(sigNode.textContent, expectedText);</span>
<a href="#l71.119"></a><span id="l71.119"> </span>
<a href="#l71.120"></a><span id="l71.120">   // Now switch identities!</span>
<a href="#l71.121"></a><span id="l71.121">   cwc.click(cwc.eid(&quot;msgIdentity&quot;));</span>
<a href="#l71.122"></a><span id="l71.122">   cwc.click_menus_in_sequence(cwc.e(&quot;msgIdentityPopup&quot;), [</span>
<a href="#l71.123"></a><span id="l71.123">     { identitykey: &quot;id2&quot; },</span>
<a href="#l71.124"></a><span id="l71.124">   ]);</span>
<a href="#l71.125"></a><span id="l71.125"> </span>
<a href="#l71.126"></a><span id="l71.126">   node = contentFrame.contentDocument.body.lastChild;</span>
<a href="#l71.127"></a><span id="l71.127"> </span>
<a href="#l71.128"></a><span id="l71.128">   // The last node is a BR - this allows users to put text after the</span>
<a href="#l71.129"></a><span id="l71.129">   // signature without it being styled like the signature.</span>
<a href="#l71.130"></a><span id="l71.130" class="difflineminus">-  assert_equals(node.localName, &quot;br&quot;);</span>
<a href="#l71.131"></a><span id="l71.131" class="difflineplus">+  Assert.equal(node.localName, &quot;br&quot;);</span>
<a href="#l71.132"></a><span id="l71.132">   node = node.previousSibling;</span>
<a href="#l71.133"></a><span id="l71.133"> </span>
<a href="#l71.134"></a><span id="l71.134" class="difflineminus">-  assert_equals(node.localName, &quot;div&quot;);</span>
<a href="#l71.135"></a><span id="l71.135" class="difflineminus">-  assert_equals(node.className, kSigClass);</span>
<a href="#l71.136"></a><span id="l71.136" class="difflineplus">+  Assert.equal(node.localName, &quot;div&quot;);</span>
<a href="#l71.137"></a><span id="l71.137" class="difflineplus">+  Assert.equal(node.className, kSigClass);</span>
<a href="#l71.138"></a><span id="l71.138"> </span>
<a href="#l71.139"></a><span id="l71.139">   sigNode = node.firstChild;</span>
<a href="#l71.140"></a><span id="l71.140"> </span>
<a href="#l71.141"></a><span id="l71.141">   if (!suppressSigSep) {</span>
<a href="#l71.142"></a><span id="l71.142">     expectedText = &quot;-- &quot;;</span>
<a href="#l71.143"></a><span id="l71.143" class="difflineminus">-    assert_equals(sigNode.textContent, kSeparator);</span>
<a href="#l71.144"></a><span id="l71.144" class="difflineplus">+    Assert.equal(sigNode.textContent, kSeparator);</span>
<a href="#l71.145"></a><span id="l71.145">     let brNode = sigNode.nextSibling;</span>
<a href="#l71.146"></a><span id="l71.146" class="difflineminus">-    assert_equals(brNode.localName, &quot;br&quot;);</span>
<a href="#l71.147"></a><span id="l71.147" class="difflineplus">+    Assert.equal(brNode.localName, &quot;br&quot;);</span>
<a href="#l71.148"></a><span id="l71.148">     sigNode = brNode.nextSibling;</span>
<a href="#l71.149"></a><span id="l71.149">   }</span>
<a href="#l71.150"></a><span id="l71.150"> </span>
<a href="#l71.151"></a><span id="l71.151">   expectedText = &quot;Tinderboxpushlog is the new *hotness!*&quot;;</span>
<a href="#l71.152"></a><span id="l71.152" class="difflineminus">-  assert_equals(sigNode.textContent, expectedText);</span>
<a href="#l71.153"></a><span id="l71.153" class="difflineplus">+  Assert.equal(sigNode.textContent, expectedText);</span>
<a href="#l71.154"></a><span id="l71.154"> </span>
<a href="#l71.155"></a><span id="l71.155">   // Now check that the original signature has been removed by ensuring</span>
<a href="#l71.156"></a><span id="l71.156">   // that there's only one node with class moz-signature.</span>
<a href="#l71.157"></a><span id="l71.157">   let sigs = contentFrame.contentDocument.querySelectorAll(&quot;.&quot; + kSigClass);</span>
<a href="#l71.158"></a><span id="l71.158" class="difflineminus">-  assert_equals(sigs.length, 1);</span>
<a href="#l71.159"></a><span id="l71.159" class="difflineplus">+  Assert.equal(sigs.length, 1);</span>
<a href="#l71.160"></a><span id="l71.160"> </span>
<a href="#l71.161"></a><span id="l71.161">   // And ensure that the text we wrote wasn't altered</span>
<a href="#l71.162"></a><span id="l71.162">   let bodyFirstChild = contentFrame.contentDocument.body.firstChild;</span>
<a href="#l71.163"></a><span id="l71.163"> </span>
<a href="#l71.164"></a><span id="l71.164">   while (node != bodyFirstChild) {</span>
<a href="#l71.165"></a><span id="l71.165">     node = node.previousSibling;</span>
<a href="#l71.166"></a><span id="l71.166">   }</span>
<a href="#l71.167"></a><span id="l71.167"> </span>
<a href="#l71.168"></a><span id="l71.168" class="difflineminus">-  assert_equals(node.nodeValue, &quot;Body, first line.&quot;);</span>
<a href="#l71.169"></a><span id="l71.169" class="difflineplus">+  Assert.equal(node.nodeValue, &quot;Body, first line.&quot;);</span>
<a href="#l71.170"></a><span id="l71.170"> </span>
<a href="#l71.171"></a><span id="l71.171">   close_compose_window(cwc);</span>
<a href="#l71.172"></a><span id="l71.172"> }</span>
<a href="#l71.173"></a><span id="l71.173"> </span>
<a href="#l71.174"></a><span id="l71.174" class="difflineminus">-function testPlaintextComposeWindowSwitchSignatures() {</span>
<a href="#l71.175"></a><span id="l71.175" class="difflineplus">+add_task(function testPlaintextComposeWindowSwitchSignatures() {</span>
<a href="#l71.176"></a><span id="l71.176">   plaintextComposeWindowSwitchSignatures(false);</span>
<a href="#l71.177"></a><span id="l71.177" class="difflineminus">-}</span>
<a href="#l71.178"></a><span id="l71.178" class="difflineplus">+});</span>
<a href="#l71.179"></a><span id="l71.179"> </span>
<a href="#l71.180"></a><span id="l71.180" class="difflineminus">-function testPlaintextComposeWindowSwitchSignaturesWithSuppressedSeparator() {</span>
<a href="#l71.181"></a><span id="l71.181" class="difflineminus">-  plaintextComposeWindowSwitchSignatures(true);</span>
<a href="#l71.182"></a><span id="l71.182" class="difflineminus">-}</span>
<a href="#l71.183"></a><span id="l71.183" class="difflineplus">+add_task(</span>
<a href="#l71.184"></a><span id="l71.184" class="difflineplus">+  function testPlaintextComposeWindowSwitchSignaturesWithSuppressedSeparator() {</span>
<a href="#l71.185"></a><span id="l71.185" class="difflineplus">+    plaintextComposeWindowSwitchSignatures(true);</span>
<a href="#l71.186"></a><span id="l71.186" class="difflineplus">+  }</span>
<a href="#l71.187"></a><span id="l71.187" class="difflineplus">+);</span>
<a href="#l71.188"></a><span id="l71.188"> </span>
<a href="#l71.189"></a><span id="l71.189"> /**</span>
<a href="#l71.190"></a><span id="l71.190">  * Same test, but with an HTML compose window</span>
<a href="#l71.191"></a><span id="l71.191">  */</span>
<a href="#l71.192"></a><span id="l71.192"> function HTMLComposeWindowSwitchSignatures(suppressSigSep, paragraphFormat) {</span>
<a href="#l71.193"></a><span id="l71.193">   Services.prefs.setBoolPref(</span>
<a href="#l71.194"></a><span id="l71.194">     &quot;mail.compose.default_to_paragraph&quot;,</span>
<a href="#l71.195"></a><span id="l71.195">     paragraphFormat</span>
<a href="#l71.196"></a><span id="l71.196" class="difflineat">@@ -186,78 +197,82 @@ function HTMLComposeWindowSwitchSignatur</span>
<a href="#l71.197"></a><span id="l71.197"> </span>
<a href="#l71.198"></a><span id="l71.198">   setup_msg_contents(cwc, &quot;&quot;, &quot;HTML compose window&quot;, &quot;Body, first line.&quot;);</span>
<a href="#l71.199"></a><span id="l71.199"> </span>
<a href="#l71.200"></a><span id="l71.200">   let contentFrame = cwc.e(&quot;content-frame&quot;);</span>
<a href="#l71.201"></a><span id="l71.201">   let node = contentFrame.contentDocument.body.lastChild;</span>
<a href="#l71.202"></a><span id="l71.202"> </span>
<a href="#l71.203"></a><span id="l71.203">   // In html compose, the signature is inside the last node, which has a</span>
<a href="#l71.204"></a><span id="l71.204">   // class=&quot;moz-signature&quot;.</span>
<a href="#l71.205"></a><span id="l71.205" class="difflineminus">-  assert_equals(node.className, &quot;moz-signature&quot;);</span>
<a href="#l71.206"></a><span id="l71.206" class="difflineplus">+  Assert.equal(node.className, &quot;moz-signature&quot;);</span>
<a href="#l71.207"></a><span id="l71.207">   node = node.firstChild; // text node containing the signature divider</span>
<a href="#l71.208"></a><span id="l71.208">   if (suppressSigSep) {</span>
<a href="#l71.209"></a><span id="l71.209" class="difflineminus">-    assert_equals(node.nodeValue, &quot;Tinderbox is soo 90ies&quot;);</span>
<a href="#l71.210"></a><span id="l71.210" class="difflineplus">+    Assert.equal(node.nodeValue, &quot;Tinderbox is soo 90ies&quot;);</span>
<a href="#l71.211"></a><span id="l71.211">   } else {</span>
<a href="#l71.212"></a><span id="l71.212" class="difflineminus">-    assert_equals(node.nodeValue, &quot;-- \nTinderbox is soo 90ies&quot;);</span>
<a href="#l71.213"></a><span id="l71.213" class="difflineplus">+    Assert.equal(node.nodeValue, &quot;-- \nTinderbox is soo 90ies&quot;);</span>
<a href="#l71.214"></a><span id="l71.214">   }</span>
<a href="#l71.215"></a><span id="l71.215"> </span>
<a href="#l71.216"></a><span id="l71.216">   // Now switch identities!</span>
<a href="#l71.217"></a><span id="l71.217">   cwc.click(cwc.eid(&quot;msgIdentity&quot;));</span>
<a href="#l71.218"></a><span id="l71.218">   cwc.click_menus_in_sequence(cwc.e(&quot;msgIdentityPopup&quot;), [</span>
<a href="#l71.219"></a><span id="l71.219">     { identitykey: &quot;id2&quot; },</span>
<a href="#l71.220"></a><span id="l71.220">   ]);</span>
<a href="#l71.221"></a><span id="l71.221"> </span>
<a href="#l71.222"></a><span id="l71.222">   node = contentFrame.contentDocument.body.lastChild;</span>
<a href="#l71.223"></a><span id="l71.223"> </span>
<a href="#l71.224"></a><span id="l71.224">   // In html compose, the signature is inside the last node</span>
<a href="#l71.225"></a><span id="l71.225">   // with class=&quot;moz-signature&quot;.</span>
<a href="#l71.226"></a><span id="l71.226" class="difflineminus">-  assert_equals(node.className, &quot;moz-signature&quot;);</span>
<a href="#l71.227"></a><span id="l71.227" class="difflineplus">+  Assert.equal(node.className, &quot;moz-signature&quot;);</span>
<a href="#l71.228"></a><span id="l71.228">   node = node.firstChild; // text node containing the signature divider</span>
<a href="#l71.229"></a><span id="l71.229">   if (!suppressSigSep) {</span>
<a href="#l71.230"></a><span id="l71.230" class="difflineminus">-    assert_equals(node.nodeValue, &quot;-- &quot;);</span>
<a href="#l71.231"></a><span id="l71.231" class="difflineplus">+    Assert.equal(node.nodeValue, &quot;-- &quot;);</span>
<a href="#l71.232"></a><span id="l71.232">     node = node.nextSibling;</span>
<a href="#l71.233"></a><span id="l71.233" class="difflineminus">-    assert_equals(node.localName, &quot;br&quot;);</span>
<a href="#l71.234"></a><span id="l71.234" class="difflineplus">+    Assert.equal(node.localName, &quot;br&quot;);</span>
<a href="#l71.235"></a><span id="l71.235">     node = node.nextSibling;</span>
<a href="#l71.236"></a><span id="l71.236">   }</span>
<a href="#l71.237"></a><span id="l71.237" class="difflineminus">-  assert_equals(node.nodeValue, &quot;Tinderboxpushlog is the new &quot;);</span>
<a href="#l71.238"></a><span id="l71.238" class="difflineplus">+  Assert.equal(node.nodeValue, &quot;Tinderboxpushlog is the new &quot;);</span>
<a href="#l71.239"></a><span id="l71.239">   node = node.nextSibling;</span>
<a href="#l71.240"></a><span id="l71.240" class="difflineminus">-  assert_equals(node.localName, &quot;b&quot;);</span>
<a href="#l71.241"></a><span id="l71.241" class="difflineplus">+  Assert.equal(node.localName, &quot;b&quot;);</span>
<a href="#l71.242"></a><span id="l71.242">   node = node.firstChild;</span>
<a href="#l71.243"></a><span id="l71.243" class="difflineminus">-  assert_equals(node.nodeValue, &quot;hotness!&quot;);</span>
<a href="#l71.244"></a><span id="l71.244" class="difflineplus">+  Assert.equal(node.nodeValue, &quot;hotness!&quot;);</span>
<a href="#l71.245"></a><span id="l71.245"> </span>
<a href="#l71.246"></a><span id="l71.246">   // Now check that the original signature has been removed,</span>
<a href="#l71.247"></a><span id="l71.247">   // and no blank lines got added!</span>
<a href="#l71.248"></a><span id="l71.248">   node = contentFrame.contentDocument.body.firstChild;</span>
<a href="#l71.249"></a><span id="l71.249">   let textNode;</span>
<a href="#l71.250"></a><span id="l71.250">   if (paragraphFormat) {</span>
<a href="#l71.251"></a><span id="l71.251">     textNode = node.firstChild;</span>
<a href="#l71.252"></a><span id="l71.252">   } else {</span>
<a href="#l71.253"></a><span id="l71.253">     textNode = node;</span>
<a href="#l71.254"></a><span id="l71.254">   }</span>
<a href="#l71.255"></a><span id="l71.255" class="difflineminus">-  assert_equals(textNode.nodeValue, &quot;Body, first line.&quot;);</span>
<a href="#l71.256"></a><span id="l71.256" class="difflineplus">+  Assert.equal(textNode.nodeValue, &quot;Body, first line.&quot;);</span>
<a href="#l71.257"></a><span id="l71.257">   if (!paragraphFormat) {</span>
<a href="#l71.258"></a><span id="l71.258">     node = node.nextSibling;</span>
<a href="#l71.259"></a><span id="l71.259" class="difflineminus">-    assert_equals(node.localName, &quot;br&quot;);</span>
<a href="#l71.260"></a><span id="l71.260" class="difflineplus">+    Assert.equal(node.localName, &quot;br&quot;);</span>
<a href="#l71.261"></a><span id="l71.261">   }</span>
<a href="#l71.262"></a><span id="l71.262">   node = node.nextSibling;</span>
<a href="#l71.263"></a><span id="l71.263">   // check that the signature is immediately after the message text.</span>
<a href="#l71.264"></a><span id="l71.264" class="difflineminus">-  assert_equals(node.className, &quot;moz-signature&quot;);</span>
<a href="#l71.265"></a><span id="l71.265" class="difflineplus">+  Assert.equal(node.className, &quot;moz-signature&quot;);</span>
<a href="#l71.266"></a><span id="l71.266">   // check that that the signature is the last node.</span>
<a href="#l71.267"></a><span id="l71.267" class="difflineminus">-  assert_equals(node, contentFrame.contentDocument.body.lastChild);</span>
<a href="#l71.268"></a><span id="l71.268" class="difflineplus">+  Assert.equal(node, contentFrame.contentDocument.body.lastChild);</span>
<a href="#l71.269"></a><span id="l71.269"> </span>
<a href="#l71.270"></a><span id="l71.270">   close_compose_window(cwc);</span>
<a href="#l71.271"></a><span id="l71.271"> }</span>
<a href="#l71.272"></a><span id="l71.272"> </span>
<a href="#l71.273"></a><span id="l71.273" class="difflineminus">-function testHTMLComposeWindowSwitchSignatures() {</span>
<a href="#l71.274"></a><span id="l71.274" class="difflineplus">+add_task(function testHTMLComposeWindowSwitchSignatures() {</span>
<a href="#l71.275"></a><span id="l71.275">   HTMLComposeWindowSwitchSignatures(false, false);</span>
<a href="#l71.276"></a><span id="l71.276" class="difflineminus">-}</span>
<a href="#l71.277"></a><span id="l71.277" class="difflineplus">+});</span>
<a href="#l71.278"></a><span id="l71.278"> </span>
<a href="#l71.279"></a><span id="l71.279" class="difflineminus">-function testHTMLComposeWindowSwitchSignaturesWithSuppressedSeparator() {</span>
<a href="#l71.280"></a><span id="l71.280" class="difflineminus">-  HTMLComposeWindowSwitchSignatures(true, false);</span>
<a href="#l71.281"></a><span id="l71.281" class="difflineminus">-}</span>
<a href="#l71.282"></a><span id="l71.282" class="difflineplus">+add_task(</span>
<a href="#l71.283"></a><span id="l71.283" class="difflineplus">+  function testHTMLComposeWindowSwitchSignaturesWithSuppressedSeparator() {</span>
<a href="#l71.284"></a><span id="l71.284" class="difflineplus">+    HTMLComposeWindowSwitchSignatures(true, false);</span>
<a href="#l71.285"></a><span id="l71.285" class="difflineplus">+  }</span>
<a href="#l71.286"></a><span id="l71.286" class="difflineplus">+);</span>
<a href="#l71.287"></a><span id="l71.287"> </span>
<a href="#l71.288"></a><span id="l71.288" class="difflineminus">-function testHTMLComposeWindowSwitchSignaturesParagraphFormat() {</span>
<a href="#l71.289"></a><span id="l71.289" class="difflineplus">+add_task(function testHTMLComposeWindowSwitchSignaturesParagraphFormat() {</span>
<a href="#l71.290"></a><span id="l71.290">   HTMLComposeWindowSwitchSignatures(false, true);</span>
<a href="#l71.291"></a><span id="l71.291" class="difflineminus">-}</span>
<a href="#l71.292"></a><span id="l71.292" class="difflineplus">+});</span>
<a href="#l71.293"></a><span id="l71.293"> </span>
<a href="#l71.294"></a><span id="l71.294" class="difflineminus">-function testHTMLComposeWindowSwitchSignaturesWithSuppressedSeparatorParagraphFormat() {</span>
<a href="#l71.295"></a><span id="l71.295" class="difflineminus">-  HTMLComposeWindowSwitchSignatures(true, true);</span>
<a href="#l71.296"></a><span id="l71.296" class="difflineminus">-}</span>
<a href="#l71.297"></a><span id="l71.297" class="difflineplus">+add_task(</span>
<a href="#l71.298"></a><span id="l71.298" class="difflineplus">+  function testHTMLComposeWindowSwitchSignaturesWithSuppressedSeparatorParagraphFormat() {</span>
<a href="#l71.299"></a><span id="l71.299" class="difflineplus">+    HTMLComposeWindowSwitchSignatures(true, true);</span>
<a href="#l71.300"></a><span id="l71.300" class="difflineplus">+  }</span>
<a href="#l71.301"></a><span id="l71.301" class="difflineplus">+);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1">copy from mail/test/mozmill/composition/attachment.txt</span>
<a href="#l72.2"></a><span id="l72.2">copy to mail/test/browser/composition/data/attachment.txt</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1">copy from mail/test/mozmill/composition/base64-encoded-msg.eml</span>
<a href="#l73.2"></a><span id="l73.2">copy to mail/test/browser/composition/data/base64-encoded-msg.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1">copy from mail/test/mozmill/composition/base64-with-whitespace.eml</span>
<a href="#l74.2"></a><span id="l74.2">copy to mail/test/browser/composition/data/base64-with-whitespace.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1">copy from mail/test/mozmill/composition/body-greek.eml</span>
<a href="#l75.2"></a><span id="l75.2">copy to mail/test/browser/composition/data/body-greek.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1">copy from mail/test/mozmill/composition/body-utf16.eml</span>
<a href="#l76.2"></a><span id="l76.2">copy to mail/test/browser/composition/data/body-utf16.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1">copy from mail/test/mozmill/composition/charset-cp932.eml</span>
<a href="#l77.2"></a><span id="l77.2">copy to mail/test/browser/composition/data/charset-cp932.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1">copy from mail/test/mozmill/composition/content-utf8-alt-rel.eml</span>
<a href="#l78.2"></a><span id="l78.2">copy to mail/test/browser/composition/data/content-utf8-alt-rel.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1">copy from mail/test/mozmill/composition/content-utf8-alt-rel2.eml</span>
<a href="#l79.2"></a><span id="l79.2">copy to mail/test/browser/composition/data/content-utf8-alt-rel2.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1">copy from mail/test/mozmill/composition/content-utf8-rel-alt.eml</span>
<a href="#l80.2"></a><span id="l80.2">copy to mail/test/browser/composition/data/content-utf8-rel-alt.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1">copy from mail/test/mozmill/composition/content-utf8-rel-only.eml</span>
<a href="#l81.2"></a><span id="l81.2">copy to mail/test/browser/composition/data/content-utf8-rel-only.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1">copy from mail/test/mozmill/composition/feed-message.eml</span>
<a href="#l82.2"></a><span id="l82.2">copy to mail/test/browser/composition/data/feed-message.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1">copy from mail/test/mozmill/composition/format-flowed.eml</span>
<a href="#l83.2"></a><span id="l83.2">copy to mail/test/browser/composition/data/format-flowed.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1">copy from mail/test/mozmill/composition/format1-altering.eml</span>
<a href="#l84.2"></a><span id="l84.2">copy to mail/test/browser/composition/data/format1-altering.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1">copy from mail/test/mozmill/composition/format1-plain.eml</span>
<a href="#l85.2"></a><span id="l85.2">copy to mail/test/browser/composition/data/format1-plain.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1">copy from mail/test/mozmill/composition/format2-style-attr.eml</span>
<a href="#l86.2"></a><span id="l86.2">copy to mail/test/browser/composition/data/format2-style-attr.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1">copy from mail/test/mozmill/composition/format3-style-tag.eml</span>
<a href="#l87.2"></a><span id="l87.2">copy to mail/test/browser/composition/data/format3-style-tag.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1">copy from mail/test/mozmill/composition/long-html-line.eml</span>
<a href="#l88.2"></a><span id="l88.2">copy to mail/test/browser/composition/data/long-html-line.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1">copy from mail/test/mozmill/composition/mime-encoded-subject.eml</span>
<a href="#l89.2"></a><span id="l89.2">copy to mail/test/browser/composition/data/mime-encoded-subject.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1">copy from mail/test/mozmill/composition/multipart-charset.eml</span>
<a href="#l90.2"></a><span id="l90.2">copy to mail/test/browser/composition/data/multipart-charset.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1">copy from mail/test/mozmill/composition/tb-logo.png</span>
<a href="#l91.2"></a><span id="l91.2">copy to mail/test/browser/composition/data/tb-logo.png</span>
<a href="#l91.3"></a><span id="l91.3"></span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l92.1"></a><span id="l92.1">copy from mail/test/mozmill/composition/testmsg.eml</span>
<a href="#l92.2"></a><span id="l92.2">copy to mail/test/browser/composition/data/testmsg.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l93.1"></a><span id="l93.1">new file mode 100644</span>
<a href="#l93.2"></a><span id="l93.2" class="difflineminus">--- /dev/null</span>
<a href="#l93.3"></a><span id="l93.3" class="difflineplus">+++ b/mail/test/browser/content-policy/browser.ini</span>
<a href="#l93.4"></a><span id="l93.4" class="difflineat">@@ -0,0 +1,23 @@</span>
<a href="#l93.5"></a><span id="l93.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l93.6"></a><span id="l93.6" class="difflineplus">+prefs =</span>
<a href="#l93.7"></a><span id="l93.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l93.8"></a><span id="l93.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l93.9"></a><span id="l93.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l93.10"></a><span id="l93.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l93.11"></a><span id="l93.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l93.12"></a><span id="l93.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l93.13"></a><span id="l93.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l93.14"></a><span id="l93.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l93.15"></a><span id="l93.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l93.16"></a><span id="l93.16" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l93.17"></a><span id="l93.17" class="difflineplus">+support-files = html/**</span>
<a href="#l93.18"></a><span id="l93.18" class="difflineplus">+</span>
<a href="#l93.19"></a><span id="l93.19" class="difflineplus">+[browser_composeMailto.js]</span>
<a href="#l93.20"></a><span id="l93.20" class="difflineplus">+[browser_dnsPrefetch.js]</span>
<a href="#l93.21"></a><span id="l93.21" class="difflineplus">+[browser_exposedInContentTabs.js]</span>
<a href="#l93.22"></a><span id="l93.22" class="difflineplus">+[browser_generalContentPolicy.js]</span>
<a href="#l93.23"></a><span id="l93.23" class="difflineplus">+[browser_jsContentPolicy.js]</span>
<a href="#l93.24"></a><span id="l93.24" class="difflineplus">+[browser_pluginsPolicy.js]</span>
<a href="#l93.25"></a><span id="l93.25" class="difflineplus">+[browser_viewSource.js]</span>
<a href="#l93.26"></a><span id="l93.26" class="difflineplus">+skip-if = os == &quot;mac&quot;</span>
<a href="#l93.27"></a><span id="l93.27" class="difflineplus">+reason = We can't click the (native) menus to make it work.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l94.1"></a><span id="l94.1">copy from mail/test/mozmill/content-policy/test-compose-mailto.js</span>
<a href="#l94.2"></a><span id="l94.2">copy to mail/test/browser/content-policy/browser_composeMailto.js</span>
<a href="#l94.3"></a><span id="l94.3" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-compose-mailto.js</span>
<a href="#l94.4"></a><span id="l94.4" class="difflineplus">+++ b/mail/test/browser/content-policy/browser_composeMailto.js</span>
<a href="#l94.5"></a><span id="l94.5" class="difflineat">@@ -23,32 +23,31 @@ var {</span>
<a href="#l94.6"></a><span id="l94.6"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;);</span>
<a href="#l94.7"></a><span id="l94.7"> </span>
<a href="#l94.8"></a><span id="l94.8"> var folder = null;</span>
<a href="#l94.9"></a><span id="l94.9"> var gMsgNo = 0;</span>
<a href="#l94.10"></a><span id="l94.10"> var gComposeWin;</span>
<a href="#l94.11"></a><span id="l94.11"> var gNewTab;</span>
<a href="#l94.12"></a><span id="l94.12"> var gPreCount;</span>
<a href="#l94.13"></a><span id="l94.13"> </span>
<a href="#l94.14"></a><span id="l94.14" class="difflineminus">-// RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l94.15"></a><span id="l94.15" class="difflineminus">-// so we get the right path for the resources.</span>
<a href="#l94.16"></a><span id="l94.16" class="difflineminus">-var url = collector.addHttpResource(&quot;../content-policy/html&quot;, &quot;content&quot;);</span>
<a href="#l94.17"></a><span id="l94.17" class="difflineplus">+var url =</span>
<a href="#l94.18"></a><span id="l94.18" class="difflineplus">+  &quot;http://mochi.test:8888/browser/comm/mail/test/browser/content-policy/html/&quot;;</span>
<a href="#l94.19"></a><span id="l94.19"> </span>
<a href="#l94.20"></a><span id="l94.20" class="difflineminus">-function test_openComposeFromMailToLink() {</span>
<a href="#l94.21"></a><span id="l94.21" class="difflineplus">+add_task(function test_openComposeFromMailToLink() {</span>
<a href="#l94.22"></a><span id="l94.22">   // Open a content tab with the mailto link in it.</span>
<a href="#l94.23"></a><span id="l94.23">   // To open a tab we're going to have to cheat and use tabmail so we can load</span>
<a href="#l94.24"></a><span id="l94.24">   // in the data of what we want.</span>
<a href="#l94.25"></a><span id="l94.25">   gPreCount = mc.tabmail.tabContainer.allTabs.length;</span>
<a href="#l94.26"></a><span id="l94.26">   gNewTab = open_content_tab_with_url(url + &quot;mailtolink.html&quot;);</span>
<a href="#l94.27"></a><span id="l94.27">   gComposeWin = composeHelper.open_compose_with_element_click(</span>
<a href="#l94.28"></a><span id="l94.28">     content_tab_eid(gNewTab, &quot;mailtolink&quot;)</span>
<a href="#l94.29"></a><span id="l94.29">   );</span>
<a href="#l94.30"></a><span id="l94.30" class="difflineminus">-}</span>
<a href="#l94.31"></a><span id="l94.31" class="difflineplus">+});</span>
<a href="#l94.32"></a><span id="l94.32"> </span>
<a href="#l94.33"></a><span id="l94.33" class="difflineminus">-function test_checkInsertImage() {</span>
<a href="#l94.34"></a><span id="l94.34" class="difflineplus">+add_task(function test_checkInsertImage() {</span>
<a href="#l94.35"></a><span id="l94.35">   // First focus on the editor element</span>
<a href="#l94.36"></a><span id="l94.36">   gComposeWin.e(&quot;content-frame&quot;).focus();</span>
<a href="#l94.37"></a><span id="l94.37"> </span>
<a href="#l94.38"></a><span id="l94.38">   // Now open the image window</span>
<a href="#l94.39"></a><span id="l94.39">   plan_for_modal_dialog(&quot;imageDlg&quot;, function insert_image(mwc) {</span>
<a href="#l94.40"></a><span id="l94.40">     // Insert the url of the image.</span>
<a href="#l94.41"></a><span id="l94.41">     let srcloc = mwc.window.document.getElementById(&quot;srcInput&quot;);</span>
<a href="#l94.42"></a><span id="l94.42">     srcloc.focus();</span>
<a href="#l94.43"></a><span id="l94.43" class="difflineat">@@ -81,19 +80,26 @@ function test_checkInsertImage() {</span>
<a href="#l94.44"></a><span id="l94.44">   }</span>
<a href="#l94.45"></a><span id="l94.45"> </span>
<a href="#l94.46"></a><span id="l94.46">   // Should be the only image, so just check the first.</span>
<a href="#l94.47"></a><span id="l94.47">   if (childImages[0].imageBlockingStatus != Ci.nsIContentPolicy.ACCEPT) {</span>
<a href="#l94.48"></a><span id="l94.48">     throw new Error(</span>
<a href="#l94.49"></a><span id="l94.49">       &quot;Loading of image has been unexpectedly blocked in a mailto compose window&quot;</span>
<a href="#l94.50"></a><span id="l94.50">     );</span>
<a href="#l94.51"></a><span id="l94.51">   }</span>
<a href="#l94.52"></a><span id="l94.52" class="difflineminus">-}</span>
<a href="#l94.53"></a><span id="l94.53" class="difflineplus">+});</span>
<a href="#l94.54"></a><span id="l94.54"> </span>
<a href="#l94.55"></a><span id="l94.55" class="difflineminus">-function test_closeComposeWindowAndTab() {</span>
<a href="#l94.56"></a><span id="l94.56" class="difflineplus">+add_task(function test_closeComposeWindowAndTab() {</span>
<a href="#l94.57"></a><span id="l94.57">   composeHelper.close_compose_window(gComposeWin);</span>
<a href="#l94.58"></a><span id="l94.58"> </span>
<a href="#l94.59"></a><span id="l94.59">   mc.tabmail.closeTab(gNewTab);</span>
<a href="#l94.60"></a><span id="l94.60"> </span>
<a href="#l94.61"></a><span id="l94.61">   if (mc.tabmail.tabContainer.allTabs.length != gPreCount) {</span>
<a href="#l94.62"></a><span id="l94.62">     throw new Error(&quot;The content tab didn't close&quot;);</span>
<a href="#l94.63"></a><span id="l94.63">   }</span>
<a href="#l94.64"></a><span id="l94.64" class="difflineminus">-}</span>
<a href="#l94.65"></a><span id="l94.65" class="difflineplus">+</span>
<a href="#l94.66"></a><span id="l94.66" class="difflineplus">+  Assert.report(</span>
<a href="#l94.67"></a><span id="l94.67" class="difflineplus">+    false,</span>
<a href="#l94.68"></a><span id="l94.68" class="difflineplus">+    undefined,</span>
<a href="#l94.69"></a><span id="l94.69" class="difflineplus">+    undefined,</span>
<a href="#l94.70"></a><span id="l94.70" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l94.71"></a><span id="l94.71" class="difflineplus">+  );</span>
<a href="#l94.72"></a><span id="l94.72" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l95.1"></a><span id="l95.1">copy from mail/test/mozmill/content-policy/test-dns-prefetch.js</span>
<a href="#l95.2"></a><span id="l95.2">copy to mail/test/browser/content-policy/browser_dnsPrefetch.js</span>
<a href="#l95.3"></a><span id="l95.3" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-dns-prefetch.js</span>
<a href="#l95.4"></a><span id="l95.4" class="difflineplus">+++ b/mail/test/browser/content-policy/browser_dnsPrefetch.js</span>
<a href="#l95.5"></a><span id="l95.5" class="difflineat">@@ -41,19 +41,19 @@ var msgBody =</span>
<a href="#l95.6"></a><span id="l95.6">   &quot;&lt;head&gt;\n&quot; +</span>
<a href="#l95.7"></a><span id="l95.7">   &quot;\n&quot; +</span>
<a href="#l95.8"></a><span id="l95.8">   '&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=ISO-8859-1&quot;&gt;\n' +</span>
<a href="#l95.9"></a><span id="l95.9">   &quot;&lt;/head&gt;\n&quot; +</span>
<a href="#l95.10"></a><span id="l95.10">   '&lt;body bgcolor=&quot;#ffffff&quot; text=&quot;#000000&quot;&gt;\n' +</span>
<a href="#l95.11"></a><span id="l95.11">   &quot;dns prefetch test message\n&quot; +</span>
<a href="#l95.12"></a><span id="l95.12">   &quot;&lt;/body&gt;\n&lt;/html&gt;\n&quot;;</span>
<a href="#l95.13"></a><span id="l95.13"> </span>
<a href="#l95.14"></a><span id="l95.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l95.15"></a><span id="l95.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l95.16"></a><span id="l95.16">   folder = create_folder(&quot;dnsPrefetch&quot;);</span>
<a href="#l95.17"></a><span id="l95.17" class="difflineminus">-}</span>
<a href="#l95.18"></a><span id="l95.18" class="difflineplus">+});</span>
<a href="#l95.19"></a><span id="l95.19"> </span>
<a href="#l95.20"></a><span id="l95.20"> function addToFolder(aSubject, aBody, aFolder) {</span>
<a href="#l95.21"></a><span id="l95.21">   let msgId =</span>
<a href="#l95.22"></a><span id="l95.22">     Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l95.23"></a><span id="l95.23">       .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l95.24"></a><span id="l95.24">       .generateUUID() + &quot;@mozillamessaging.invalid&quot;;</span>
<a href="#l95.25"></a><span id="l95.25"> </span>
<a href="#l95.26"></a><span id="l95.26">   let source =</span>
<a href="#l95.27"></a><span id="l95.27" class="difflineat">@@ -134,17 +134,17 @@ function checkComposeWindow(replyType) {</span>
<a href="#l95.28"></a><span id="l95.28">     throw new Error(</span>
<a href="#l95.29"></a><span id="l95.29">       &quot;DNS Prefetch on compose window is not disabled (&quot; + errMsg + &quot;)&quot;</span>
<a href="#l95.30"></a><span id="l95.30">     );</span>
<a href="#l95.31"></a><span id="l95.31">   }</span>
<a href="#l95.32"></a><span id="l95.32"> </span>
<a href="#l95.33"></a><span id="l95.33">   composeHelper.close_compose_window(replyWindow);</span>
<a href="#l95.34"></a><span id="l95.34"> }</span>
<a href="#l95.35"></a><span id="l95.35"> </span>
<a href="#l95.36"></a><span id="l95.36" class="difflineminus">-function test_dnsPrefetch_message() {</span>
<a href="#l95.37"></a><span id="l95.37" class="difflineplus">+add_task(function test_dnsPrefetch_message() {</span>
<a href="#l95.38"></a><span id="l95.38">   // Now we have started up, simply check that DNS prefetch is disabled</span>
<a href="#l95.39"></a><span id="l95.39">   if (mc.e(&quot;messagepane&quot;).docShell.allowDNSPrefetch) {</span>
<a href="#l95.40"></a><span id="l95.40">     throw new Error(&quot;DNS Prefetch on messagepane is not disabled at startup&quot;);</span>
<a href="#l95.41"></a><span id="l95.41">   }</span>
<a href="#l95.42"></a><span id="l95.42"> </span>
<a href="#l95.43"></a><span id="l95.43">   be_in_folder(folder);</span>
<a href="#l95.44"></a><span id="l95.44"> </span>
<a href="#l95.45"></a><span id="l95.45">   assert_nothing_selected();</span>
<a href="#l95.46"></a><span id="l95.46" class="difflineat">@@ -152,39 +152,39 @@ function test_dnsPrefetch_message() {</span>
<a href="#l95.47"></a><span id="l95.47">   addMsgToFolder(folder);</span>
<a href="#l95.48"></a><span id="l95.48"> </span>
<a href="#l95.49"></a><span id="l95.49">   // Now we've got a message selected, check again.</span>
<a href="#l95.50"></a><span id="l95.50">   if (mc.e(&quot;messagepane&quot;).docShell.allowDNSPrefetch) {</span>
<a href="#l95.51"></a><span id="l95.51">     throw new Error(</span>
<a href="#l95.52"></a><span id="l95.52">       &quot;DNS Prefetch on messagepane is not disabled after selecting message&quot;</span>
<a href="#l95.53"></a><span id="l95.53">     );</span>
<a href="#l95.54"></a><span id="l95.54">   }</span>
<a href="#l95.55"></a><span id="l95.55" class="difflineminus">-}</span>
<a href="#l95.56"></a><span id="l95.56" class="difflineplus">+});</span>
<a href="#l95.57"></a><span id="l95.57"> </span>
<a href="#l95.58"></a><span id="l95.58" class="difflineminus">-function test_dnsPrefetch_standaloneMessage() {</span>
<a href="#l95.59"></a><span id="l95.59" class="difflineplus">+add_task(function test_dnsPrefetch_standaloneMessage() {</span>
<a href="#l95.60"></a><span id="l95.60">   let msgc = open_selected_message_in_new_window();</span>
<a href="#l95.61"></a><span id="l95.61">   assert_selected_and_displayed(msgc, gMsgHdr);</span>
<a href="#l95.62"></a><span id="l95.62"> </span>
<a href="#l95.63"></a><span id="l95.63">   // Check the docshell.</span>
<a href="#l95.64"></a><span id="l95.64">   if (mc.e(&quot;messagepane&quot;).docShell.allowDNSPrefetch) {</span>
<a href="#l95.65"></a><span id="l95.65">     throw new Error(</span>
<a href="#l95.66"></a><span id="l95.66">       &quot;DNS Prefetch on messagepane is not disabled in standalone message window.&quot;</span>
<a href="#l95.67"></a><span id="l95.67">     );</span>
<a href="#l95.68"></a><span id="l95.68">   }</span>
<a href="#l95.69"></a><span id="l95.69"> </span>
<a href="#l95.70"></a><span id="l95.70">   close_message_window(msgc);</span>
<a href="#l95.71"></a><span id="l95.71" class="difflineminus">-}</span>
<a href="#l95.72"></a><span id="l95.72" class="difflineplus">+});</span>
<a href="#l95.73"></a><span id="l95.73"> </span>
<a href="#l95.74"></a><span id="l95.74" class="difflineminus">-function test_dnsPrefetch_compose() {</span>
<a href="#l95.75"></a><span id="l95.75" class="difflineplus">+add_task(function test_dnsPrefetch_compose() {</span>
<a href="#l95.76"></a><span id="l95.76">   checkComposeWindow(0);</span>
<a href="#l95.77"></a><span id="l95.77">   checkComposeWindow(1);</span>
<a href="#l95.78"></a><span id="l95.78">   checkComposeWindow(2);</span>
<a href="#l95.79"></a><span id="l95.79" class="difflineminus">-}</span>
<a href="#l95.80"></a><span id="l95.80" class="difflineplus">+});</span>
<a href="#l95.81"></a><span id="l95.81"> </span>
<a href="#l95.82"></a><span id="l95.82" class="difflineminus">-function test_dnsPrefetch_contentTab() {</span>
<a href="#l95.83"></a><span id="l95.83" class="difflineplus">+add_task(function test_dnsPrefetch_contentTab() {</span>
<a href="#l95.84"></a><span id="l95.84">   // To open a tab we're going to have to cheat and use tabmail so we can load</span>
<a href="#l95.85"></a><span id="l95.85">   // in the data of what we want.</span>
<a href="#l95.86"></a><span id="l95.86">   let preCount = mc.tabmail.tabContainer.allTabs.length;</span>
<a href="#l95.87"></a><span id="l95.87"> </span>
<a href="#l95.88"></a><span id="l95.88">   let dataurl =</span>
<a href="#l95.89"></a><span id="l95.89">     &quot;data:text/html,&lt;html&gt;&lt;head&gt;&lt;title&gt;test dns prefetch&lt;/title&gt;&quot; +</span>
<a href="#l95.90"></a><span id="l95.90">     &quot;&lt;/head&gt;&lt;body&gt;test dns prefetch&lt;/body&gt;&lt;/html&gt;&quot;;</span>
<a href="#l95.91"></a><span id="l95.91"> </span>
<a href="#l95.92"></a><span id="l95.92" class="difflineat">@@ -194,9 +194,16 @@ function test_dnsPrefetch_contentTab() {</span>
<a href="#l95.93"></a><span id="l95.93">     throw new Error(&quot;DNS prefetch unexpectedly disabled in content tabs&quot;);</span>
<a href="#l95.94"></a><span id="l95.94">   }</span>
<a href="#l95.95"></a><span id="l95.95"> </span>
<a href="#l95.96"></a><span id="l95.96">   mc.tabmail.closeTab(newTab);</span>
<a href="#l95.97"></a><span id="l95.97"> </span>
<a href="#l95.98"></a><span id="l95.98">   if (mc.tabmail.tabContainer.allTabs.length != preCount) {</span>
<a href="#l95.99"></a><span id="l95.99">     throw new Error(&quot;The content tab didn't close&quot;);</span>
<a href="#l95.100"></a><span id="l95.100">   }</span>
<a href="#l95.101"></a><span id="l95.101" class="difflineminus">-}</span>
<a href="#l95.102"></a><span id="l95.102" class="difflineplus">+</span>
<a href="#l95.103"></a><span id="l95.103" class="difflineplus">+  Assert.report(</span>
<a href="#l95.104"></a><span id="l95.104" class="difflineplus">+    false,</span>
<a href="#l95.105"></a><span id="l95.105" class="difflineplus">+    undefined,</span>
<a href="#l95.106"></a><span id="l95.106" class="difflineplus">+    undefined,</span>
<a href="#l95.107"></a><span id="l95.107" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l95.108"></a><span id="l95.108" class="difflineplus">+  );</span>
<a href="#l95.109"></a><span id="l95.109" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l96.1"></a><span id="l96.1">copy from mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js</span>
<a href="#l96.2"></a><span id="l96.2">copy to mail/test/browser/content-policy/browser_exposedInContentTabs.js</span>
<a href="#l96.3"></a><span id="l96.3" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-exposed-in-content-tabs.js</span>
<a href="#l96.4"></a><span id="l96.4" class="difflineplus">+++ b/mail/test/browser/content-policy/browser_exposedInContentTabs.js</span>
<a href="#l96.5"></a><span id="l96.5" class="difflineat">@@ -24,37 +24,36 @@ var {</span>
<a href="#l96.6"></a><span id="l96.6">   select_click_row,</span>
<a href="#l96.7"></a><span id="l96.7"> } = ChromeUtils.import(</span>
<a href="#l96.8"></a><span id="l96.8">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l96.9"></a><span id="l96.9"> );</span>
<a href="#l96.10"></a><span id="l96.10"> </span>
<a href="#l96.11"></a><span id="l96.11"> var folder = null;</span>
<a href="#l96.12"></a><span id="l96.12"> var gMsgNo = 0;</span>
<a href="#l96.13"></a><span id="l96.13"> </span>
<a href="#l96.14"></a><span id="l96.14" class="difflineminus">-// RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l96.15"></a><span id="l96.15" class="difflineminus">-// so we get the right path for the resources.</span>
<a href="#l96.16"></a><span id="l96.16" class="difflineminus">-var url = collector.addHttpResource(&quot;../content-policy/html&quot;, &quot;content&quot;);</span>
<a href="#l96.17"></a><span id="l96.17" class="difflineplus">+var url =</span>
<a href="#l96.18"></a><span id="l96.18" class="difflineplus">+  &quot;http://mochi.test:8888/browser/comm/mail/test/browser/content-policy/html/&quot;;</span>
<a href="#l96.19"></a><span id="l96.19"> </span>
<a href="#l96.20"></a><span id="l96.20"> // These two constants are used to build the message body.</span>
<a href="#l96.21"></a><span id="l96.21"> var msgBody =</span>
<a href="#l96.22"></a><span id="l96.22">   '&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;\n' +</span>
<a href="#l96.23"></a><span id="l96.23">   &quot;&lt;html&gt;\n&quot; +</span>
<a href="#l96.24"></a><span id="l96.24">   &quot;&lt;head&gt;\n&quot; +</span>
<a href="#l96.25"></a><span id="l96.25">   &quot;\n&quot; +</span>
<a href="#l96.26"></a><span id="l96.26">   '&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=ISO-8859-1&quot;&gt;\n' +</span>
<a href="#l96.27"></a><span id="l96.27">   &quot;&lt;/head&gt;\n&quot; +</span>
<a href="#l96.28"></a><span id="l96.28">   '&lt;body bgcolor=&quot;#ffffff&quot; text=&quot;#000000&quot;&gt;\n' +</span>
<a href="#l96.29"></a><span id="l96.29">   '&lt;img id=&quot;testelement&quot; src=&quot;' +</span>
<a href="#l96.30"></a><span id="l96.30">   url +</span>
<a href="#l96.31"></a><span id="l96.31">   'pass.png&quot;/&gt;\n' +</span>
<a href="#l96.32"></a><span id="l96.32">   &quot;&lt;/body&gt;\n&lt;/html&gt;\n&quot;;</span>
<a href="#l96.33"></a><span id="l96.33"> </span>
<a href="#l96.34"></a><span id="l96.34" class="difflineminus">-function setupModule(module) {</span>
<a href="#l96.35"></a><span id="l96.35" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l96.36"></a><span id="l96.36">   folder = create_folder(&quot;exposedInContent&quot;);</span>
<a href="#l96.37"></a><span id="l96.37" class="difflineminus">-}</span>
<a href="#l96.38"></a><span id="l96.38" class="difflineplus">+});</span>
<a href="#l96.39"></a><span id="l96.39"> </span>
<a href="#l96.40"></a><span id="l96.40"> function addToFolder(aSubject, aBody, aFolder) {</span>
<a href="#l96.41"></a><span id="l96.41">   let msgId =</span>
<a href="#l96.42"></a><span id="l96.42">     Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l96.43"></a><span id="l96.43">       .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l96.44"></a><span id="l96.44">       .generateUUID() + &quot;@mozillamessaging.invalid&quot;;</span>
<a href="#l96.45"></a><span id="l96.45"> </span>
<a href="#l96.46"></a><span id="l96.46">   let source =</span>
<a href="#l96.47"></a><span id="l96.47" class="difflineat">@@ -142,19 +141,26 @@ function checkContentTab(msgURL) {</span>
<a href="#l96.48"></a><span id="l96.48"> </span>
<a href="#l96.49"></a><span id="l96.49">   mc.tabmail.closeTab(newTab);</span>
<a href="#l96.50"></a><span id="l96.50"> </span>
<a href="#l96.51"></a><span id="l96.51">   if (mc.tabmail.tabContainer.allTabs.length != preCount) {</span>
<a href="#l96.52"></a><span id="l96.52">     throw new Error(&quot;The content tab didn't close&quot;);</span>
<a href="#l96.53"></a><span id="l96.53">   }</span>
<a href="#l96.54"></a><span id="l96.54"> }</span>
<a href="#l96.55"></a><span id="l96.55"> </span>
<a href="#l96.56"></a><span id="l96.56" class="difflineminus">-function test_exposedInContentTabs() {</span>
<a href="#l96.57"></a><span id="l96.57" class="difflineplus">+add_task(function test_exposedInContentTabs() {</span>
<a href="#l96.58"></a><span id="l96.58">   be_in_folder(folder);</span>
<a href="#l96.59"></a><span id="l96.59"> </span>
<a href="#l96.60"></a><span id="l96.60">   assert_nothing_selected();</span>
<a href="#l96.61"></a><span id="l96.61"> </span>
<a href="#l96.62"></a><span id="l96.62">   // Check for denied in mail</span>
<a href="#l96.63"></a><span id="l96.63">   let msgURL = addMsgToFolder(folder);</span>
<a href="#l96.64"></a><span id="l96.64"> </span>
<a href="#l96.65"></a><span id="l96.65">   // Check allowed in content tab</span>
<a href="#l96.66"></a><span id="l96.66">   checkContentTab(msgURL);</span>
<a href="#l96.67"></a><span id="l96.67" class="difflineminus">-}</span>
<a href="#l96.68"></a><span id="l96.68" class="difflineplus">+</span>
<a href="#l96.69"></a><span id="l96.69" class="difflineplus">+  Assert.report(</span>
<a href="#l96.70"></a><span id="l96.70" class="difflineplus">+    false,</span>
<a href="#l96.71"></a><span id="l96.71" class="difflineplus">+    undefined,</span>
<a href="#l96.72"></a><span id="l96.72" class="difflineplus">+    undefined,</span>
<a href="#l96.73"></a><span id="l96.73" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l96.74"></a><span id="l96.74" class="difflineplus">+  );</span>
<a href="#l96.75"></a><span id="l96.75" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l97.1"></a><span id="l97.1">copy from mail/test/mozmill/content-policy/test-general-content-policy.js</span>
<a href="#l97.2"></a><span id="l97.2">copy to mail/test/browser/content-policy/browser_generalContentPolicy.js</span>
<a href="#l97.3"></a><span id="l97.3" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-general-content-policy.js</span>
<a href="#l97.4"></a><span id="l97.4" class="difflineplus">+++ b/mail/test/browser/content-policy/browser_generalContentPolicy.js</span>
<a href="#l97.5"></a><span id="l97.5" class="difflineat">@@ -15,30 +15,32 @@</span>
<a href="#l97.6"></a><span id="l97.6">  * - Forward email compose window</span>
<a href="#l97.7"></a><span id="l97.7">  * - Content tab</span>
<a href="#l97.8"></a><span id="l97.8">  * - Feed message</span>
<a href="#l97.9"></a><span id="l97.9">  */</span>
<a href="#l97.10"></a><span id="l97.10"> </span>
<a href="#l97.11"></a><span id="l97.11"> &quot;use strict&quot;;</span>
<a href="#l97.12"></a><span id="l97.12"> </span>
<a href="#l97.13"></a><span id="l97.13"> var elib = ChromeUtils.import(</span>
<a href="#l97.14"></a><span id="l97.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l97.15"></a><span id="l97.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l97.16"></a><span id="l97.16"> );</span>
<a href="#l97.17"></a><span id="l97.17" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l97.18"></a><span id="l97.18" class="difflineplus">+var mozmill = ChromeUtils.import(</span>
<a href="#l97.19"></a><span id="l97.19" class="difflineplus">+  &quot;resource://testing-common/mozmill/mozmill.jsm&quot;</span>
<a href="#l97.20"></a><span id="l97.20" class="difflineplus">+);</span>
<a href="#l97.21"></a><span id="l97.21" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l97.22"></a><span id="l97.22"> </span>
<a href="#l97.23"></a><span id="l97.23"> var {</span>
<a href="#l97.24"></a><span id="l97.24">   close_compose_window,</span>
<a href="#l97.25"></a><span id="l97.25">   open_compose_with_forward,</span>
<a href="#l97.26"></a><span id="l97.26">   open_compose_with_reply,</span>
<a href="#l97.27"></a><span id="l97.27"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l97.28"></a><span id="l97.28"> var { open_content_tab_with_url } = ChromeUtils.import(</span>
<a href="#l97.29"></a><span id="l97.29">   &quot;resource://testing-common/mozmill/ContentTabHelpers.jsm&quot;</span>
<a href="#l97.30"></a><span id="l97.30"> );</span>
<a href="#l97.31"></a><span id="l97.31"> var {</span>
<a href="#l97.32"></a><span id="l97.32" class="difflineminus">-  assert_equals,</span>
<a href="#l97.33"></a><span id="l97.33">   assert_nothing_selected,</span>
<a href="#l97.34"></a><span id="l97.34">   assert_selected_and_displayed,</span>
<a href="#l97.35"></a><span id="l97.35">   be_in_folder,</span>
<a href="#l97.36"></a><span id="l97.36">   close_message_window,</span>
<a href="#l97.37"></a><span id="l97.37">   create_folder,</span>
<a href="#l97.38"></a><span id="l97.38">   mc,</span>
<a href="#l97.39"></a><span id="l97.39">   open_message_from_file,</span>
<a href="#l97.40"></a><span id="l97.40">   open_selected_message,</span>
<a href="#l97.41"></a><span id="l97.41" class="difflineat">@@ -70,19 +72,18 @@ var {</span>
<a href="#l97.42"></a><span id="l97.42"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l97.43"></a><span id="l97.43"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l97.44"></a><span id="l97.44">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l97.45"></a><span id="l97.45"> );</span>
<a href="#l97.46"></a><span id="l97.46"> </span>
<a href="#l97.47"></a><span id="l97.47"> var folder = null;</span>
<a href="#l97.48"></a><span id="l97.48"> var gMsgNo = 0;</span>
<a href="#l97.49"></a><span id="l97.49"> </span>
<a href="#l97.50"></a><span id="l97.50" class="difflineminus">-// RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l97.51"></a><span id="l97.51" class="difflineminus">-// so we get the right path for the resources.</span>
<a href="#l97.52"></a><span id="l97.52" class="difflineminus">-var url = collector.addHttpResource(&quot;../content-policy/html&quot;, &quot;content&quot;);</span>
<a href="#l97.53"></a><span id="l97.53" class="difflineplus">+var url =</span>
<a href="#l97.54"></a><span id="l97.54" class="difflineplus">+  &quot;http://mochi.test:8888/browser/comm/mail/test/browser/content-policy/html/&quot;;</span>
<a href="#l97.55"></a><span id="l97.55"> </span>
<a href="#l97.56"></a><span id="l97.56"> /**</span>
<a href="#l97.57"></a><span id="l97.57">  * The TESTS array is constructed from objects containing the following:</span>
<a href="#l97.58"></a><span id="l97.58">  *</span>
<a href="#l97.59"></a><span id="l97.59">  * type:            The type of the test being run.</span>
<a href="#l97.60"></a><span id="l97.60">  * body:            The html to be inserted into the body of the message under</span>
<a href="#l97.61"></a><span id="l97.61">  *                  test. Note: the element under test for content</span>
<a href="#l97.62"></a><span id="l97.62">  *                  allowed/disallowed should have id 'testelement'.</span>
<a href="#l97.63"></a><span id="l97.63" class="difflineat">@@ -131,19 +132,19 @@ var msgBodyStart =</span>
<a href="#l97.64"></a><span id="l97.64">   &quot;&lt;head&gt;\n&quot; +</span>
<a href="#l97.65"></a><span id="l97.65">   &quot;\n&quot; +</span>
<a href="#l97.66"></a><span id="l97.66">   '&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=ISO-8859-1&quot;&gt;\n' +</span>
<a href="#l97.67"></a><span id="l97.67">   &quot;&lt;/head&gt;\n&quot; +</span>
<a href="#l97.68"></a><span id="l97.68">   '&lt;body bgcolor=&quot;#ffffff&quot; text=&quot;#000000&quot;&gt;\n';</span>
<a href="#l97.69"></a><span id="l97.69"> </span>
<a href="#l97.70"></a><span id="l97.70"> var msgBodyEnd = &quot;&lt;/body&gt;\n&lt;/html&gt;\n&quot;;</span>
<a href="#l97.71"></a><span id="l97.71"> </span>
<a href="#l97.72"></a><span id="l97.72" class="difflineminus">-function setupModule(module) {</span>
<a href="#l97.73"></a><span id="l97.73" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l97.74"></a><span id="l97.74">   folder = create_folder(&quot;generalContentPolicy&quot;);</span>
<a href="#l97.75"></a><span id="l97.75" class="difflineminus">-}</span>
<a href="#l97.76"></a><span id="l97.76" class="difflineplus">+});</span>
<a href="#l97.77"></a><span id="l97.77"> </span>
<a href="#l97.78"></a><span id="l97.78"> // We can't call it test since that it would be run as subtest.</span>
<a href="#l97.79"></a><span id="l97.79"> function checkPermission(aURI) {</span>
<a href="#l97.80"></a><span id="l97.80">   let principal = Services.scriptSecurityManager.createContentPrincipal(</span>
<a href="#l97.81"></a><span id="l97.81">     aURI,</span>
<a href="#l97.82"></a><span id="l97.82">     {}</span>
<a href="#l97.83"></a><span id="l97.83">   );</span>
<a href="#l97.84"></a><span id="l97.84">   return Services.perms.testPermissionFromPrincipal(principal, &quot;image&quot;);</span>
<a href="#l97.85"></a><span id="l97.85" class="difflineat">@@ -405,17 +406,17 @@ function checkAllowFeedMsg(test) {</span>
<a href="#l97.86"></a><span id="l97.86">     msgBodyStart + test.body + msgBodyEnd,</span>
<a href="#l97.87"></a><span id="l97.87">     folder</span>
<a href="#l97.88"></a><span id="l97.88">   );</span>
<a href="#l97.89"></a><span id="l97.89">   msgDbHdr.OrFlags(Ci.nsMsgMessageFlags.FeedMsg);</span>
<a href="#l97.90"></a><span id="l97.90"> </span>
<a href="#l97.91"></a><span id="l97.91">   // select the newly created message</span>
<a href="#l97.92"></a><span id="l97.92">   let msgHdr = select_click_row(gMsgNo);</span>
<a href="#l97.93"></a><span id="l97.93"> </span>
<a href="#l97.94"></a><span id="l97.94" class="difflineminus">-  assert_equals(msgDbHdr, msgHdr);</span>
<a href="#l97.95"></a><span id="l97.95" class="difflineplus">+  Assert.equal(msgDbHdr, msgHdr);</span>
<a href="#l97.96"></a><span id="l97.96">   assert_selected_and_displayed(gMsgNo);</span>
<a href="#l97.97"></a><span id="l97.97"> </span>
<a href="#l97.98"></a><span id="l97.98">   // Now check that the content hasn't been blocked</span>
<a href="#l97.99"></a><span id="l97.99">   if (</span>
<a href="#l97.100"></a><span id="l97.100">     !test.checkForAllowed(</span>
<a href="#l97.101"></a><span id="l97.101">       mc.window.content.document.getElementById(&quot;testelement&quot;)</span>
<a href="#l97.102"></a><span id="l97.102">     )</span>
<a href="#l97.103"></a><span id="l97.103">   ) {</span>
<a href="#l97.104"></a><span id="l97.104" class="difflineat">@@ -439,22 +440,22 @@ function checkAllowForSenderWithPerms(te</span>
<a href="#l97.105"></a><span id="l97.105"> </span>
<a href="#l97.106"></a><span id="l97.106">   let addresses = MailServices.headerParser.parseEncodedHeader(msgDbHdr.author);</span>
<a href="#l97.107"></a><span id="l97.107">   let authorEmailAddress = addresses[0].email;</span>
<a href="#l97.108"></a><span id="l97.108"> </span>
<a href="#l97.109"></a><span id="l97.109">   let uri = Services.io.newURI(</span>
<a href="#l97.110"></a><span id="l97.110">     &quot;chrome://messenger/content/email=&quot; + authorEmailAddress</span>
<a href="#l97.111"></a><span id="l97.111">   );</span>
<a href="#l97.112"></a><span id="l97.112">   addPermission(uri, Services.perms.ALLOW_ACTION);</span>
<a href="#l97.113"></a><span id="l97.113" class="difflineminus">-  assert_equals(checkPermission(uri), Services.perms.ALLOW_ACTION);</span>
<a href="#l97.114"></a><span id="l97.114" class="difflineplus">+  Assert.equal(checkPermission(uri), Services.perms.ALLOW_ACTION);</span>
<a href="#l97.115"></a><span id="l97.115"> </span>
<a href="#l97.116"></a><span id="l97.116">   // select the newly created message</span>
<a href="#l97.117"></a><span id="l97.117">   let msgHdr = select_click_row(gMsgNo);</span>
<a href="#l97.118"></a><span id="l97.118"> </span>
<a href="#l97.119"></a><span id="l97.119" class="difflineminus">-  assert_equals(msgDbHdr, msgHdr);</span>
<a href="#l97.120"></a><span id="l97.120" class="difflineplus">+  Assert.equal(msgDbHdr, msgHdr);</span>
<a href="#l97.121"></a><span id="l97.121">   assert_selected_and_displayed(gMsgNo);</span>
<a href="#l97.122"></a><span id="l97.122"> </span>
<a href="#l97.123"></a><span id="l97.123">   // Now check that the content hasn't been blocked</span>
<a href="#l97.124"></a><span id="l97.124">   if (</span>
<a href="#l97.125"></a><span id="l97.125">     !test.checkForAllowed(</span>
<a href="#l97.126"></a><span id="l97.126">       mc.window.content.document.getElementById(&quot;testelement&quot;)</span>
<a href="#l97.127"></a><span id="l97.127">     )</span>
<a href="#l97.128"></a><span id="l97.128">   ) {</span>
<a href="#l97.129"></a><span id="l97.129" class="difflineat">@@ -462,52 +463,52 @@ function checkAllowForSenderWithPerms(te</span>
<a href="#l97.130"></a><span id="l97.130">       `${</span>
<a href="#l97.131"></a><span id="l97.131">         test.type</span>
<a href="#l97.132"></a><span id="l97.132">       } has been unexpectedly blocked for sender=${authorEmailAddress}`</span>
<a href="#l97.133"></a><span id="l97.133">     );</span>
<a href="#l97.134"></a><span id="l97.134">   }</span>
<a href="#l97.135"></a><span id="l97.135"> </span>
<a href="#l97.136"></a><span id="l97.136">   // Clean up after ourselves, and make sure that worked as expected.</span>
<a href="#l97.137"></a><span id="l97.137">   removePermission(uri);</span>
<a href="#l97.138"></a><span id="l97.138" class="difflineminus">-  assert_equals(checkPermission(uri), Services.perms.UNKNOWN_ACTION);</span>
<a href="#l97.139"></a><span id="l97.139" class="difflineplus">+  Assert.equal(checkPermission(uri), Services.perms.UNKNOWN_ACTION);</span>
<a href="#l97.140"></a><span id="l97.140"> </span>
<a href="#l97.141"></a><span id="l97.141">   ++gMsgNo;</span>
<a href="#l97.142"></a><span id="l97.142"> }</span>
<a href="#l97.143"></a><span id="l97.143"> </span>
<a href="#l97.144"></a><span id="l97.144"> /**</span>
<a href="#l97.145"></a><span id="l97.145">  * Check remote content is not blocked for a hosts with permissions.</span>
<a href="#l97.146"></a><span id="l97.146">  */</span>
<a href="#l97.147"></a><span id="l97.147"> function checkAllowForHostsWithPerms(test) {</span>
<a href="#l97.148"></a><span id="l97.148">   let msgDbHdr = addToFolder(</span>
<a href="#l97.149"></a><span id="l97.149">     test.type + &quot; priv host test message &quot; + gMsgNo,</span>
<a href="#l97.150"></a><span id="l97.150">     msgBodyStart + test.body + msgBodyEnd,</span>
<a href="#l97.151"></a><span id="l97.151">     folder</span>
<a href="#l97.152"></a><span id="l97.152">   );</span>
<a href="#l97.153"></a><span id="l97.153"> </span>
<a href="#l97.154"></a><span id="l97.154">   // Select the newly created message.</span>
<a href="#l97.155"></a><span id="l97.155">   let msgHdr = select_click_row(gMsgNo);</span>
<a href="#l97.156"></a><span id="l97.156" class="difflineminus">-  assert_equals(msgDbHdr, msgHdr);</span>
<a href="#l97.157"></a><span id="l97.157" class="difflineplus">+  Assert.equal(msgDbHdr, msgHdr);</span>
<a href="#l97.158"></a><span id="l97.158">   assert_selected_and_displayed(gMsgNo);</span>
<a href="#l97.159"></a><span id="l97.159"> </span>
<a href="#l97.160"></a><span id="l97.160">   let src = mc.window.content.document.getElementById(&quot;testelement&quot;).src;</span>
<a href="#l97.161"></a><span id="l97.161"> </span>
<a href="#l97.162"></a><span id="l97.162">   if (!src.startsWith(&quot;http&quot;)) {</span>
<a href="#l97.163"></a><span id="l97.163">     // Just test http in this test.</span>
<a href="#l97.164"></a><span id="l97.164">     return;</span>
<a href="#l97.165"></a><span id="l97.165">   }</span>
<a href="#l97.166"></a><span id="l97.166"> </span>
<a href="#l97.167"></a><span id="l97.167">   let uri = Services.io.newURI(src);</span>
<a href="#l97.168"></a><span id="l97.168">   addPermission(uri, Services.perms.ALLOW_ACTION);</span>
<a href="#l97.169"></a><span id="l97.169" class="difflineminus">-  assert_equals(checkPermission(uri), Services.perms.ALLOW_ACTION);</span>
<a href="#l97.170"></a><span id="l97.170" class="difflineplus">+  Assert.equal(checkPermission(uri), Services.perms.ALLOW_ACTION);</span>
<a href="#l97.171"></a><span id="l97.171"> </span>
<a href="#l97.172"></a><span id="l97.172">   // Click back one msg, then the original again, which should now allow loading.</span>
<a href="#l97.173"></a><span id="l97.173">   select_click_row(gMsgNo - 1);</span>
<a href="#l97.174"></a><span id="l97.174">   // Select the newly created message.</span>
<a href="#l97.175"></a><span id="l97.175">   msgHdr = select_click_row(gMsgNo);</span>
<a href="#l97.176"></a><span id="l97.176" class="difflineminus">-  assert_equals(msgDbHdr, msgHdr);</span>
<a href="#l97.177"></a><span id="l97.177" class="difflineplus">+  Assert.equal(msgDbHdr, msgHdr);</span>
<a href="#l97.178"></a><span id="l97.178">   assert_selected_and_displayed(gMsgNo);</span>
<a href="#l97.179"></a><span id="l97.179"> </span>
<a href="#l97.180"></a><span id="l97.180">   // Now check that the content hasn't been blocked.</span>
<a href="#l97.181"></a><span id="l97.181">   if (</span>
<a href="#l97.182"></a><span id="l97.182">     !test.checkForAllowed(</span>
<a href="#l97.183"></a><span id="l97.183">       mozmill</span>
<a href="#l97.184"></a><span id="l97.184">         .getMail3PaneController()</span>
<a href="#l97.185"></a><span id="l97.185">         .window.content.document.getElementById(&quot;testelement&quot;)</span>
<a href="#l97.186"></a><span id="l97.186" class="difflineat">@@ -515,22 +516,22 @@ function checkAllowForHostsWithPerms(tes</span>
<a href="#l97.187"></a><span id="l97.187">   ) {</span>
<a href="#l97.188"></a><span id="l97.188">     throw new Error(</span>
<a href="#l97.189"></a><span id="l97.189">       test.type + &quot; has been unexpectedly blocked for url=&quot; + uri.spec</span>
<a href="#l97.190"></a><span id="l97.190">     );</span>
<a href="#l97.191"></a><span id="l97.191">   }</span>
<a href="#l97.192"></a><span id="l97.192"> </span>
<a href="#l97.193"></a><span id="l97.193">   // Clean up after ourselves, and make sure that worked as expected.</span>
<a href="#l97.194"></a><span id="l97.194">   removePermission(uri);</span>
<a href="#l97.195"></a><span id="l97.195" class="difflineminus">-  assert_equals(checkPermission(uri), Services.perms.UNKNOWN_ACTION);</span>
<a href="#l97.196"></a><span id="l97.196" class="difflineplus">+  Assert.equal(checkPermission(uri), Services.perms.UNKNOWN_ACTION);</span>
<a href="#l97.197"></a><span id="l97.197"> </span>
<a href="#l97.198"></a><span id="l97.198">   ++gMsgNo;</span>
<a href="#l97.199"></a><span id="l97.199"> }</span>
<a href="#l97.200"></a><span id="l97.200"> </span>
<a href="#l97.201"></a><span id="l97.201" class="difflineminus">-function test_generalContentPolicy() {</span>
<a href="#l97.202"></a><span id="l97.202" class="difflineplus">+add_task(function test_generalContentPolicy() {</span>
<a href="#l97.203"></a><span id="l97.203">   be_in_folder(folder);</span>
<a href="#l97.204"></a><span id="l97.204"> </span>
<a href="#l97.205"></a><span id="l97.205">   assert_nothing_selected();</span>
<a href="#l97.206"></a><span id="l97.206"> </span>
<a href="#l97.207"></a><span id="l97.207">   for (let i = 0; i &lt; TESTS.length; ++i) {</span>
<a href="#l97.208"></a><span id="l97.208">     // Check for denied in mail</span>
<a href="#l97.209"></a><span id="l97.209">     addMsgToFolderAndCheckContent(folder, TESTS[i]);</span>
<a href="#l97.210"></a><span id="l97.210"> </span>
<a href="#l97.211"></a><span id="l97.211" class="difflineat">@@ -545,27 +546,27 @@ function test_generalContentPolicy() {</span>
<a href="#l97.212"></a><span id="l97.212">         // Now check that image is visible after site is whitelisted.</span>
<a href="#l97.213"></a><span id="l97.213">         // We do the first test which is the one with the image.</span>
<a href="#l97.214"></a><span id="l97.214"> </span>
<a href="#l97.215"></a><span id="l97.215">         // Add the site to the whitelist.</span>
<a href="#l97.216"></a><span id="l97.216">         let src = mc.window.content.document.getElementById(&quot;testelement&quot;).src;</span>
<a href="#l97.217"></a><span id="l97.217"> </span>
<a href="#l97.218"></a><span id="l97.218">         let uri = Services.io.newURI(src);</span>
<a href="#l97.219"></a><span id="l97.219">         addPermission(uri, Services.perms.ALLOW_ACTION);</span>
<a href="#l97.220"></a><span id="l97.220" class="difflineminus">-        assert_equals(checkPermission(uri), Services.perms.ALLOW_ACTION);</span>
<a href="#l97.221"></a><span id="l97.221" class="difflineplus">+        Assert.equal(checkPermission(uri), Services.perms.ALLOW_ACTION);</span>
<a href="#l97.222"></a><span id="l97.222"> </span>
<a href="#l97.223"></a><span id="l97.223">         // Check allowed in reply window</span>
<a href="#l97.224"></a><span id="l97.224">         checkComposeWindow(TESTS[i], true, true);</span>
<a href="#l97.225"></a><span id="l97.225"> </span>
<a href="#l97.226"></a><span id="l97.226">         // Check allowed in forward window</span>
<a href="#l97.227"></a><span id="l97.227">         checkComposeWindow(TESTS[i], false, true);</span>
<a href="#l97.228"></a><span id="l97.228"> </span>
<a href="#l97.229"></a><span id="l97.229">         // Clean up after ourselves, and make sure that worked as expected.</span>
<a href="#l97.230"></a><span id="l97.230">         removePermission(uri);</span>
<a href="#l97.231"></a><span id="l97.231" class="difflineminus">-        assert_equals(checkPermission(uri), Services.perms.UNKNOWN_ACTION);</span>
<a href="#l97.232"></a><span id="l97.232" class="difflineplus">+        Assert.equal(checkPermission(uri), Services.perms.UNKNOWN_ACTION);</span>
<a href="#l97.233"></a><span id="l97.233">       }</span>
<a href="#l97.234"></a><span id="l97.234"> </span>
<a href="#l97.235"></a><span id="l97.235">       // Check denied in standalone message window</span>
<a href="#l97.236"></a><span id="l97.236">       checkStandaloneMessageWindow(TESTS[i], false);</span>
<a href="#l97.237"></a><span id="l97.237"> </span>
<a href="#l97.238"></a><span id="l97.238">       // Now allow the remote content and check result</span>
<a href="#l97.239"></a><span id="l97.239">       allowRemoteContentAndCheck(TESTS[i]);</span>
<a href="#l97.240"></a><span id="l97.240">     }</span>
<a href="#l97.241"></a><span id="l97.241" class="difflineat">@@ -593,17 +594,17 @@ function test_generalContentPolicy() {</span>
<a href="#l97.242"></a><span id="l97.242"> </span>
<a href="#l97.243"></a><span id="l97.243">     // Only want to do this for the first test case, which is a remote image.</span>
<a href="#l97.244"></a><span id="l97.244">     if (i == 0) {</span>
<a href="#l97.245"></a><span id="l97.245">       let emlFile = saveAsEMLFile(i);</span>
<a href="#l97.246"></a><span id="l97.246">       checkEMLMessageWindow(TESTS[i], emlFile);</span>
<a href="#l97.247"></a><span id="l97.247">       emlFile.remove(false);</span>
<a href="#l97.248"></a><span id="l97.248">     }</span>
<a href="#l97.249"></a><span id="l97.249">   }</span>
<a href="#l97.250"></a><span id="l97.250" class="difflineminus">-}</span>
<a href="#l97.251"></a><span id="l97.251" class="difflineplus">+});</span>
<a href="#l97.252"></a><span id="l97.252"> </span>
<a href="#l97.253"></a><span id="l97.253"> // Copied from test-blocked-content.js.</span>
<a href="#l97.254"></a><span id="l97.254"> function putHTMLOnClipboard(html) {</span>
<a href="#l97.255"></a><span id="l97.255">   let trans = Cc[&quot;@mozilla.org/widget/transferable;1&quot;].createInstance(</span>
<a href="#l97.256"></a><span id="l97.256">     Ci.nsITransferable</span>
<a href="#l97.257"></a><span id="l97.257">   );</span>
<a href="#l97.258"></a><span id="l97.258"> </span>
<a href="#l97.259"></a><span id="l97.259">   // Register supported data flavors</span>
<a href="#l97.260"></a><span id="l97.260" class="difflineat">@@ -700,15 +701,15 @@ function subtest_insertImageIntoReplyFor</span>
<a href="#l97.261"></a><span id="l97.261">   }</span>
<a href="#l97.262"></a><span id="l97.262">   if (childImages[1].imageBlockingStatus != Ci.nsIContentPolicy.ACCEPT) {</span>
<a href="#l97.263"></a><span id="l97.263">     throw new Error(&quot;Loading of image has been unexpectedly blocked (2)&quot;);</span>
<a href="#l97.264"></a><span id="l97.264">   }</span>
<a href="#l97.265"></a><span id="l97.265"> </span>
<a href="#l97.266"></a><span id="l97.266">   close_compose_window(replyWindow);</span>
<a href="#l97.267"></a><span id="l97.267"> }</span>
<a href="#l97.268"></a><span id="l97.268"> </span>
<a href="#l97.269"></a><span id="l97.269" class="difflineminus">-function test_insertImageIntoReply() {</span>
<a href="#l97.270"></a><span id="l97.270" class="difflineplus">+add_task(function test_insertImageIntoReply() {</span>
<a href="#l97.271"></a><span id="l97.271">   subtest_insertImageIntoReplyForward(true);</span>
<a href="#l97.272"></a><span id="l97.272" class="difflineminus">-}</span>
<a href="#l97.273"></a><span id="l97.273" class="difflineplus">+});</span>
<a href="#l97.274"></a><span id="l97.274"> </span>
<a href="#l97.275"></a><span id="l97.275" class="difflineminus">-function test_insertImageIntoForward() {</span>
<a href="#l97.276"></a><span id="l97.276" class="difflineplus">+add_task(function test_insertImageIntoForward() {</span>
<a href="#l97.277"></a><span id="l97.277">   subtest_insertImageIntoReplyForward(false);</span>
<a href="#l97.278"></a><span id="l97.278" class="difflineminus">-}</span>
<a href="#l97.279"></a><span id="l97.279" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l98.1"></a><span id="l98.1">copy from mail/test/mozmill/content-policy/test-js-content-policy.js</span>
<a href="#l98.2"></a><span id="l98.2">copy to mail/test/browser/content-policy/browser_jsContentPolicy.js</span>
<a href="#l98.3"></a><span id="l98.3" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-js-content-policy.js</span>
<a href="#l98.4"></a><span id="l98.4" class="difflineplus">+++ b/mail/test/browser/content-policy/browser_jsContentPolicy.js</span>
<a href="#l98.5"></a><span id="l98.5" class="difflineat">@@ -6,18 +6,21 @@</span>
<a href="#l98.6"></a><span id="l98.6">  * Tests whether JavaScript in a local/remote message works.</span>
<a href="#l98.7"></a><span id="l98.7">  *</span>
<a href="#l98.8"></a><span id="l98.8">  * @note This assumes an existing local account, and will cause the Trash</span>
<a href="#l98.9"></a><span id="l98.9">  * folder of that account to be emptied multiple times.</span>
<a href="#l98.10"></a><span id="l98.10">  */</span>
<a href="#l98.11"></a><span id="l98.11"> </span>
<a href="#l98.12"></a><span id="l98.12"> &quot;use strict&quot;;</span>
<a href="#l98.13"></a><span id="l98.13"> </span>
<a href="#l98.14"></a><span id="l98.14" class="difflineplus">+var mozmill = ChromeUtils.import(</span>
<a href="#l98.15"></a><span id="l98.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/mozmill.jsm&quot;</span>
<a href="#l98.16"></a><span id="l98.16" class="difflineplus">+);</span>
<a href="#l98.17"></a><span id="l98.17" class="difflineplus">+</span>
<a href="#l98.18"></a><span id="l98.18"> var {</span>
<a href="#l98.19"></a><span id="l98.19" class="difflineminus">-  assert_equals,</span>
<a href="#l98.20"></a><span id="l98.20">   assert_nothing_selected,</span>
<a href="#l98.21"></a><span id="l98.21">   assert_selected_and_displayed,</span>
<a href="#l98.22"></a><span id="l98.22">   be_in_folder,</span>
<a href="#l98.23"></a><span id="l98.23">   close_tab,</span>
<a href="#l98.24"></a><span id="l98.24">   create_folder,</span>
<a href="#l98.25"></a><span id="l98.25">   mc,</span>
<a href="#l98.26"></a><span id="l98.26">   open_selected_message_in_new_tab,</span>
<a href="#l98.27"></a><span id="l98.27">   select_click_row,</span>
<a href="#l98.28"></a><span id="l98.28" class="difflineat">@@ -26,28 +29,27 @@ var {</span>
<a href="#l98.29"></a><span id="l98.29"> } = ChromeUtils.import(</span>
<a href="#l98.30"></a><span id="l98.30">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l98.31"></a><span id="l98.31"> );</span>
<a href="#l98.32"></a><span id="l98.32"> </span>
<a href="#l98.33"></a><span id="l98.33"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l98.34"></a><span id="l98.34"> </span>
<a href="#l98.35"></a><span id="l98.35"> var folder = null;</span>
<a href="#l98.36"></a><span id="l98.36"> </span>
<a href="#l98.37"></a><span id="l98.37" class="difflineminus">-// RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l98.38"></a><span id="l98.38" class="difflineminus">-// so we get the right path for the resources.</span>
<a href="#l98.39"></a><span id="l98.39" class="difflineminus">-var url = collector.addHttpResource(&quot;../content-policy/html&quot;, &quot;content&quot;);</span>
<a href="#l98.40"></a><span id="l98.40" class="difflineplus">+var url =</span>
<a href="#l98.41"></a><span id="l98.41" class="difflineplus">+  &quot;http://mochi.test:8888/browser/comm/mail/test/browser/content-policy/html/&quot;;</span>
<a href="#l98.42"></a><span id="l98.42"> </span>
<a href="#l98.43"></a><span id="l98.43" class="difflineminus">-function setupModule(module) {</span>
<a href="#l98.44"></a><span id="l98.44" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l98.45"></a><span id="l98.45">   folder = create_folder(&quot;jsContentPolicy&quot;);</span>
<a href="#l98.46"></a><span id="l98.46">   Services.prefs.setBoolPref(&quot;javascript.enabled&quot;, true);</span>
<a href="#l98.47"></a><span id="l98.47" class="difflineminus">-}</span>
<a href="#l98.48"></a><span id="l98.48" class="difflineplus">+});</span>
<a href="#l98.49"></a><span id="l98.49"> </span>
<a href="#l98.50"></a><span id="l98.50" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l98.51"></a><span id="l98.51" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l98.52"></a><span id="l98.52">   Services.prefs.clearUserPref(&quot;javascript.enabled&quot;);</span>
<a href="#l98.53"></a><span id="l98.53" class="difflineminus">-}</span>
<a href="#l98.54"></a><span id="l98.54" class="difflineplus">+});</span>
<a href="#l98.55"></a><span id="l98.55"> </span>
<a href="#l98.56"></a><span id="l98.56"> function addToFolder(aSubject, aBody, aFolder) {</span>
<a href="#l98.57"></a><span id="l98.57">   let msgId =</span>
<a href="#l98.58"></a><span id="l98.58">     Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l98.59"></a><span id="l98.59">       .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l98.60"></a><span id="l98.60">       .generateUUID() + &quot;@mozillamessaging.invalid&quot;;</span>
<a href="#l98.61"></a><span id="l98.61"> </span>
<a href="#l98.62"></a><span id="l98.62">   let source =</span>
<a href="#l98.63"></a><span id="l98.63" class="difflineat">@@ -178,17 +180,17 @@ function checkJsInFeedContent() {</span>
<a href="#l98.64"></a><span id="l98.64">   );</span>
<a href="#l98.65"></a><span id="l98.65">   msgDbHdr.OrFlags(Ci.nsMsgMessageFlags.FeedMsg);</span>
<a href="#l98.66"></a><span id="l98.66"> </span>
<a href="#l98.67"></a><span id="l98.67">   // Set to &quot;View as Web Page&quot; so we get the Content-Base page shown.</span>
<a href="#l98.68"></a><span id="l98.68">   Services.prefs.setIntPref(&quot;rss.show.summary&quot;, 0);</span>
<a href="#l98.69"></a><span id="l98.69"> </span>
<a href="#l98.70"></a><span id="l98.70">   // select the newly created message</span>
<a href="#l98.71"></a><span id="l98.71">   let msgHdr = select_click_row(gMsgNo);</span>
<a href="#l98.72"></a><span id="l98.72" class="difflineminus">-  assert_equals(</span>
<a href="#l98.73"></a><span id="l98.73" class="difflineplus">+  Assert.equal(</span>
<a href="#l98.74"></a><span id="l98.74">     msgDbHdr,</span>
<a href="#l98.75"></a><span id="l98.75">     msgHdr,</span>
<a href="#l98.76"></a><span id="l98.76">     &quot;Selected Message Header is not the same as generated header&quot;</span>
<a href="#l98.77"></a><span id="l98.77">   );</span>
<a href="#l98.78"></a><span id="l98.78"> </span>
<a href="#l98.79"></a><span id="l98.79">   wait_for_message_display_completion();</span>
<a href="#l98.80"></a><span id="l98.80"> </span>
<a href="#l98.81"></a><span id="l98.81">   // The above just ensures local &quot;inline&quot; content have loaded. We need to wait</span>
<a href="#l98.82"></a><span id="l98.82" class="difflineat">@@ -238,17 +240,17 @@ function checkJsInFeedTab() {</span>
<a href="#l98.83"></a><span id="l98.83">   );</span>
<a href="#l98.84"></a><span id="l98.84">   msgDbHdr.OrFlags(Ci.nsMsgMessageFlags.FeedMsg);</span>
<a href="#l98.85"></a><span id="l98.85"> </span>
<a href="#l98.86"></a><span id="l98.86">   // Set to &quot;View as Web Page&quot; so we get the Content-Base page shown.</span>
<a href="#l98.87"></a><span id="l98.87">   Services.prefs.setIntPref(&quot;rss.show.summary&quot;, 0);</span>
<a href="#l98.88"></a><span id="l98.88"> </span>
<a href="#l98.89"></a><span id="l98.89">   // Select the newly created message.</span>
<a href="#l98.90"></a><span id="l98.90">   let msgHdr = select_click_row(gMsgNo);</span>
<a href="#l98.91"></a><span id="l98.91" class="difflineminus">-  assert_equals(</span>
<a href="#l98.92"></a><span id="l98.92" class="difflineplus">+  Assert.equal(</span>
<a href="#l98.93"></a><span id="l98.93">     msgDbHdr,</span>
<a href="#l98.94"></a><span id="l98.94">     msgHdr,</span>
<a href="#l98.95"></a><span id="l98.95">     &quot;Selected Message Header is not the same as generated header&quot;</span>
<a href="#l98.96"></a><span id="l98.96">   );</span>
<a href="#l98.97"></a><span id="l98.97"> </span>
<a href="#l98.98"></a><span id="l98.98">   wait_for_message_display_completion();</span>
<a href="#l98.99"></a><span id="l98.99"> </span>
<a href="#l98.100"></a><span id="l98.100">   let feedUrl = url + &quot;remote-noscript.html&quot;;</span>
<a href="#l98.101"></a><span id="l98.101" class="difflineat">@@ -311,26 +313,26 @@ function checkJsInRemoteContent() {</span>
<a href="#l98.102"></a><span id="l98.102">   let display = mc.window</span>
<a href="#l98.103"></a><span id="l98.103">     .getComputedStyle(noscript)</span>
<a href="#l98.104"></a><span id="l98.104">     .getPropertyValue(&quot;display&quot;);</span>
<a href="#l98.105"></a><span id="l98.105">   if (display != &quot;none&quot;) {</span>
<a href="#l98.106"></a><span id="l98.106">     throw new Error(&quot;noscript display should be 'none'; display=&quot; + display);</span>
<a href="#l98.107"></a><span id="l98.107">   }</span>
<a href="#l98.108"></a><span id="l98.108"> }</span>
<a href="#l98.109"></a><span id="l98.109"> </span>
<a href="#l98.110"></a><span id="l98.110" class="difflineminus">-function test_jsContentPolicy() {</span>
<a href="#l98.111"></a><span id="l98.111" class="difflineplus">+add_task(function test_jsContentPolicy() {</span>
<a href="#l98.112"></a><span id="l98.112">   be_in_folder(folder);</span>
<a href="#l98.113"></a><span id="l98.113"> </span>
<a href="#l98.114"></a><span id="l98.114">   assert_nothing_selected();</span>
<a href="#l98.115"></a><span id="l98.115"> </span>
<a href="#l98.116"></a><span id="l98.116">   // run each test twice to ensure that there aren't any weird side effects,</span>
<a href="#l98.117"></a><span id="l98.117">   // given that these loads all happen in the same docshell</span>
<a href="#l98.118"></a><span id="l98.118"> </span>
<a href="#l98.119"></a><span id="l98.119">   checkJsInMail();</span>
<a href="#l98.120"></a><span id="l98.120">   checkJsInNonMessageContent();</span>
<a href="#l98.121"></a><span id="l98.121"> </span>
<a href="#l98.122"></a><span id="l98.122">   checkJsInMail();</span>
<a href="#l98.123"></a><span id="l98.123">   checkJsInNonMessageContent();</span>
<a href="#l98.124"></a><span id="l98.124"> </span>
<a href="#l98.125"></a><span id="l98.125">   checkJsInFeedContent();</span>
<a href="#l98.126"></a><span id="l98.126">   checkJsInRemoteContent();</span>
<a href="#l98.127"></a><span id="l98.127">   checkJsInFeedTab();</span>
<a href="#l98.128"></a><span id="l98.128" class="difflineminus">-}</span>
<a href="#l98.129"></a><span id="l98.129" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l99.1"></a><span id="l99.1">copy from mail/test/mozmill/content-policy/test-plugins-policy.js</span>
<a href="#l99.2"></a><span id="l99.2">copy to mail/test/browser/content-policy/browser_pluginsPolicy.js</span>
<a href="#l99.3"></a><span id="l99.3" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-plugins-policy.js</span>
<a href="#l99.4"></a><span id="l99.4" class="difflineplus">+++ b/mail/test/browser/content-policy/browser_pluginsPolicy.js</span>
<a href="#l99.5"></a><span id="l99.5" class="difflineat">@@ -4,16 +4,20 @@</span>
<a href="#l99.6"></a><span id="l99.6"> </span>
<a href="#l99.7"></a><span id="l99.7"> /**</span>
<a href="#l99.8"></a><span id="l99.8">  * Checks if plugins are enabled in messages correctly or not.</span>
<a href="#l99.9"></a><span id="l99.9">  * As of bug 1508942, plugins are no longer enabled in any context.</span>
<a href="#l99.10"></a><span id="l99.10">  */</span>
<a href="#l99.11"></a><span id="l99.11"> </span>
<a href="#l99.12"></a><span id="l99.12"> &quot;use strict&quot;;</span>
<a href="#l99.13"></a><span id="l99.13"> </span>
<a href="#l99.14"></a><span id="l99.14" class="difflineplus">+var mozmill = ChromeUtils.import(</span>
<a href="#l99.15"></a><span id="l99.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/mozmill.jsm&quot;</span>
<a href="#l99.16"></a><span id="l99.16" class="difflineplus">+);</span>
<a href="#l99.17"></a><span id="l99.17" class="difflineplus">+</span>
<a href="#l99.18"></a><span id="l99.18"> var composeHelper = ChromeUtils.import(</span>
<a href="#l99.19"></a><span id="l99.19">   &quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;</span>
<a href="#l99.20"></a><span id="l99.20"> );</span>
<a href="#l99.21"></a><span id="l99.21"> var { open_content_tab_with_url } = ChromeUtils.import(</span>
<a href="#l99.22"></a><span id="l99.22">   &quot;resource://testing-common/mozmill/ContentTabHelpers.jsm&quot;</span>
<a href="#l99.23"></a><span id="l99.23"> );</span>
<a href="#l99.24"></a><span id="l99.24"> </span>
<a href="#l99.25"></a><span id="l99.25"> var {</span>
<a href="#l99.26"></a><span id="l99.26" class="difflineat">@@ -35,35 +39,34 @@ var { plan_for_new_window, wait_for_new_</span>
<a href="#l99.27"></a><span id="l99.27">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l99.28"></a><span id="l99.28"> );</span>
<a href="#l99.29"></a><span id="l99.29"> </span>
<a href="#l99.30"></a><span id="l99.30"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l99.31"></a><span id="l99.31"> </span>
<a href="#l99.32"></a><span id="l99.32"> var folder = null;</span>
<a href="#l99.33"></a><span id="l99.33"> var gMsgNo = 0;</span>
<a href="#l99.34"></a><span id="l99.34"> </span>
<a href="#l99.35"></a><span id="l99.35" class="difflineminus">-// RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l99.36"></a><span id="l99.36" class="difflineminus">-// so we get the right path for the resources.</span>
<a href="#l99.37"></a><span id="l99.37" class="difflineminus">-var url = collector.addHttpResource(&quot;../content-policy/html&quot;, &quot;content&quot;);</span>
<a href="#l99.38"></a><span id="l99.38" class="difflineplus">+var url =</span>
<a href="#l99.39"></a><span id="l99.39" class="difflineplus">+  &quot;http://mochi.test:8888/browser/comm/mail/test/browser/content-policy/html/&quot;;</span>
<a href="#l99.40"></a><span id="l99.40"> </span>
<a href="#l99.41"></a><span id="l99.41"> // These two constants are used to build the message body.</span>
<a href="#l99.42"></a><span id="l99.42"> var msgBody =</span>
<a href="#l99.43"></a><span id="l99.43">   '&lt;!DOCTYPE HTML PUBLIC &quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;&gt;\n' +</span>
<a href="#l99.44"></a><span id="l99.44">   &quot;&lt;html&gt;\n&quot; +</span>
<a href="#l99.45"></a><span id="l99.45">   &quot;&lt;head&gt;\n&quot; +</span>
<a href="#l99.46"></a><span id="l99.46">   &quot;\n&quot; +</span>
<a href="#l99.47"></a><span id="l99.47">   '&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=ISO-8859-1&quot;&gt;\n' +</span>
<a href="#l99.48"></a><span id="l99.48">   &quot;&lt;/head&gt;\n&quot; +</span>
<a href="#l99.49"></a><span id="l99.49">   '&lt;body bgcolor=&quot;#ffffff&quot; text=&quot;#000000&quot;&gt;\n' +</span>
<a href="#l99.50"></a><span id="l99.50">   '&lt;embed id=&quot;testelement&quot; type=&quot;application/x-test&quot; width=&quot;400&quot; height=&quot;400&quot; border=&quot;1&quot;&gt;&lt;/embed&gt;\n' +</span>
<a href="#l99.51"></a><span id="l99.51">   &quot;&lt;/body&gt;\n&lt;/html&gt;\n&quot;;</span>
<a href="#l99.52"></a><span id="l99.52"> </span>
<a href="#l99.53"></a><span id="l99.53" class="difflineminus">-function setupModule(module) {</span>
<a href="#l99.54"></a><span id="l99.54" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l99.55"></a><span id="l99.55">   folder = create_folder(&quot;pluginPolicy&quot;);</span>
<a href="#l99.56"></a><span id="l99.56" class="difflineminus">-}</span>
<a href="#l99.57"></a><span id="l99.57" class="difflineplus">+});</span>
<a href="#l99.58"></a><span id="l99.58"> </span>
<a href="#l99.59"></a><span id="l99.59"> function addToFolder(aSubject, aBody, aFolder) {</span>
<a href="#l99.60"></a><span id="l99.60">   let msgId =</span>
<a href="#l99.61"></a><span id="l99.61">     Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l99.62"></a><span id="l99.62">       .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l99.63"></a><span id="l99.63">       .generateUUID() + &quot;@mozillamessaging.invalid&quot;;</span>
<a href="#l99.64"></a><span id="l99.64"> </span>
<a href="#l99.65"></a><span id="l99.65">   let source =</span>
<a href="#l99.66"></a><span id="l99.66" class="difflineat">@@ -164,69 +167,76 @@ function checkStandaloneMessageWindow(lo</span>
<a href="#l99.67"></a><span id="l99.67">         : &quot;Plugin has not been blocked in standalone window as expected&quot;</span>
<a href="#l99.68"></a><span id="l99.68">     );</span>
<a href="#l99.69"></a><span id="l99.69">   }</span>
<a href="#l99.70"></a><span id="l99.70"> </span>
<a href="#l99.71"></a><span id="l99.71">   // Clean up, close the window</span>
<a href="#l99.72"></a><span id="l99.72">   close_message_window(msgc);</span>
<a href="#l99.73"></a><span id="l99.73"> }</span>
<a href="#l99.74"></a><span id="l99.74"> </span>
<a href="#l99.75"></a><span id="l99.75" class="difflineminus">-function test_3paneWindowDenied() {</span>
<a href="#l99.76"></a><span id="l99.76" class="difflineplus">+add_task(function test_3paneWindowDenied() {</span>
<a href="#l99.77"></a><span id="l99.77">   be_in_folder(folder);</span>
<a href="#l99.78"></a><span id="l99.78"> </span>
<a href="#l99.79"></a><span id="l99.79">   assert_nothing_selected();</span>
<a href="#l99.80"></a><span id="l99.80"> </span>
<a href="#l99.81"></a><span id="l99.81">   addMsgToFolderAndCheckContent(false);</span>
<a href="#l99.82"></a><span id="l99.82" class="difflineminus">-}</span>
<a href="#l99.83"></a><span id="l99.83" class="difflineplus">+});</span>
<a href="#l99.84"></a><span id="l99.84"> </span>
<a href="#l99.85"></a><span id="l99.85" class="difflineminus">-function test_checkPluginsInNonMessageContent() {</span>
<a href="#l99.86"></a><span id="l99.86" class="difflineplus">+add_task(function test_checkPluginsInNonMessageContent() {</span>
<a href="#l99.87"></a><span id="l99.87">   // Deselect everything so we can load our content</span>
<a href="#l99.88"></a><span id="l99.88">   select_none();</span>
<a href="#l99.89"></a><span id="l99.89"> </span>
<a href="#l99.90"></a><span id="l99.90">   // load something non-message-like in the message pane</span>
<a href="#l99.91"></a><span id="l99.91">   mozmill.getMail3PaneController().window.GetMessagePaneFrame().location.href =</span>
<a href="#l99.92"></a><span id="l99.92">     url + &quot;plugin.html&quot;;</span>
<a href="#l99.93"></a><span id="l99.93"> </span>
<a href="#l99.94"></a><span id="l99.94">   wait_for_message_display_completion();</span>
<a href="#l99.95"></a><span id="l99.95"> </span>
<a href="#l99.96"></a><span id="l99.96">   if (</span>
<a href="#l99.97"></a><span id="l99.97">     isPluginLoaded(mozmill.getMail3PaneController().window.content.document)</span>
<a href="#l99.98"></a><span id="l99.98">   ) {</span>
<a href="#l99.99"></a><span id="l99.99">     throw new Error(</span>
<a href="#l99.100"></a><span id="l99.100">       &quot;Plugin is turned on in content in message pane - it should not be.&quot;</span>
<a href="#l99.101"></a><span id="l99.101">     );</span>
<a href="#l99.102"></a><span id="l99.102">   }</span>
<a href="#l99.103"></a><span id="l99.103" class="difflineminus">-}</span>
<a href="#l99.104"></a><span id="l99.104" class="difflineplus">+});</span>
<a href="#l99.105"></a><span id="l99.105"> </span>
<a href="#l99.106"></a><span id="l99.106" class="difflineminus">-function test_3paneWindowDeniedAgain() {</span>
<a href="#l99.107"></a><span id="l99.107" class="difflineplus">+add_task(function test_3paneWindowDeniedAgain() {</span>
<a href="#l99.108"></a><span id="l99.108">   select_click_row(0);</span>
<a href="#l99.109"></a><span id="l99.109"> </span>
<a href="#l99.110"></a><span id="l99.110">   assert_selected_and_displayed(0);</span>
<a href="#l99.111"></a><span id="l99.111"> </span>
<a href="#l99.112"></a><span id="l99.112">   // Now check that the content hasn't been loaded</span>
<a href="#l99.113"></a><span id="l99.113">   if (</span>
<a href="#l99.114"></a><span id="l99.114">     isPluginLoaded(mozmill.getMail3PaneController().window.content.document)</span>
<a href="#l99.115"></a><span id="l99.115">   ) {</span>
<a href="#l99.116"></a><span id="l99.116">     throw new Error(&quot;Plugin has not been blocked in message as expected&quot;);</span>
<a href="#l99.117"></a><span id="l99.117">   }</span>
<a href="#l99.118"></a><span id="l99.118" class="difflineminus">-}</span>
<a href="#l99.119"></a><span id="l99.119" class="difflineplus">+});</span>
<a href="#l99.120"></a><span id="l99.120"> </span>
<a href="#l99.121"></a><span id="l99.121" class="difflineminus">-function test_checkStandaloneMessageWindowDenied() {</span>
<a href="#l99.122"></a><span id="l99.122" class="difflineplus">+add_task(function test_checkStandaloneMessageWindowDenied() {</span>
<a href="#l99.123"></a><span id="l99.123">   checkStandaloneMessageWindow(false);</span>
<a href="#l99.124"></a><span id="l99.124" class="difflineminus">-}</span>
<a href="#l99.125"></a><span id="l99.125" class="difflineplus">+});</span>
<a href="#l99.126"></a><span id="l99.126"> </span>
<a href="#l99.127"></a><span id="l99.127" class="difflineminus">-function test_checkContentTab() {</span>
<a href="#l99.128"></a><span id="l99.128" class="difflineplus">+add_task(function test_checkContentTab() {</span>
<a href="#l99.129"></a><span id="l99.129">   // To open a tab we're going to have to cheat and use tabmail so we can load</span>
<a href="#l99.130"></a><span id="l99.130">   // in the data of what we want.</span>
<a href="#l99.131"></a><span id="l99.131">   let preCount = mc.tabmail.tabContainer.allTabs.length;</span>
<a href="#l99.132"></a><span id="l99.132"> </span>
<a href="#l99.133"></a><span id="l99.133">   let newTab = open_content_tab_with_url(url + &quot;plugin.html&quot;);</span>
<a href="#l99.134"></a><span id="l99.134"> </span>
<a href="#l99.135"></a><span id="l99.135">   if (isPluginLoaded(mc.tabmail.getBrowserForSelectedTab().contentDocument)) {</span>
<a href="#l99.136"></a><span id="l99.136">     throw new Error(&quot;Plugin has been unexpectedly not blocked in content tab&quot;);</span>
<a href="#l99.137"></a><span id="l99.137">   }</span>
<a href="#l99.138"></a><span id="l99.138"> </span>
<a href="#l99.139"></a><span id="l99.139">   mc.tabmail.closeTab(newTab);</span>
<a href="#l99.140"></a><span id="l99.140"> </span>
<a href="#l99.141"></a><span id="l99.141">   if (mc.tabmail.tabContainer.allTabs.length != preCount) {</span>
<a href="#l99.142"></a><span id="l99.142">     throw new Error(&quot;The content tab didn't close&quot;);</span>
<a href="#l99.143"></a><span id="l99.143">   }</span>
<a href="#l99.144"></a><span id="l99.144" class="difflineminus">-}</span>
<a href="#l99.145"></a><span id="l99.145" class="difflineplus">+</span>
<a href="#l99.146"></a><span id="l99.146" class="difflineplus">+  Assert.report(</span>
<a href="#l99.147"></a><span id="l99.147" class="difflineplus">+    false,</span>
<a href="#l99.148"></a><span id="l99.148" class="difflineplus">+    undefined,</span>
<a href="#l99.149"></a><span id="l99.149" class="difflineplus">+    undefined,</span>
<a href="#l99.150"></a><span id="l99.150" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l99.151"></a><span id="l99.151" class="difflineplus">+  );</span>
<a href="#l99.152"></a><span id="l99.152" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l100.1"></a><span id="l100.1">copy from mail/test/mozmill/content-policy/test-view-source.js</span>
<a href="#l100.2"></a><span id="l100.2">copy to mail/test/browser/content-policy/browser_viewSource.js</span>
<a href="#l100.3"></a><span id="l100.3" class="difflineminus">--- a/mail/test/mozmill/content-policy/test-view-source.js</span>
<a href="#l100.4"></a><span id="l100.4" class="difflineplus">+++ b/mail/test/browser/content-policy/browser_viewSource.js</span>
<a href="#l100.5"></a><span id="l100.5" class="difflineat">@@ -4,41 +4,35 @@</span>
<a href="#l100.6"></a><span id="l100.6"> </span>
<a href="#l100.7"></a><span id="l100.7"> /**</span>
<a href="#l100.8"></a><span id="l100.8">  * Test that view-source content can be reloaded to change encoding.</span>
<a href="#l100.9"></a><span id="l100.9">  */</span>
<a href="#l100.10"></a><span id="l100.10"> </span>
<a href="#l100.11"></a><span id="l100.11"> &quot;use strict&quot;;</span>
<a href="#l100.12"></a><span id="l100.12"> </span>
<a href="#l100.13"></a><span id="l100.13"> var elib = ChromeUtils.import(</span>
<a href="#l100.14"></a><span id="l100.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l100.15"></a><span id="l100.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l100.16"></a><span id="l100.16"> );</span>
<a href="#l100.17"></a><span id="l100.17"> </span>
<a href="#l100.18"></a><span id="l100.18" class="difflineminus">-var {</span>
<a href="#l100.19"></a><span id="l100.19" class="difflineminus">-  assert_true,</span>
<a href="#l100.20"></a><span id="l100.20" class="difflineminus">-  be_in_folder,</span>
<a href="#l100.21"></a><span id="l100.21" class="difflineminus">-  create_folder,</span>
<a href="#l100.22"></a><span id="l100.22" class="difflineminus">-  mc,</span>
<a href="#l100.23"></a><span id="l100.23" class="difflineminus">-  select_click_row,</span>
<a href="#l100.24"></a><span id="l100.24" class="difflineminus">-} = ChromeUtils.import(</span>
<a href="#l100.25"></a><span id="l100.25" class="difflineplus">+var { be_in_folder, create_folder, mc, select_click_row } = ChromeUtils.import(</span>
<a href="#l100.26"></a><span id="l100.26">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l100.27"></a><span id="l100.27"> );</span>
<a href="#l100.28"></a><span id="l100.28"> var {</span>
<a href="#l100.29"></a><span id="l100.29">   close_window,</span>
<a href="#l100.30"></a><span id="l100.30">   plan_for_new_window,</span>
<a href="#l100.31"></a><span id="l100.31">   wait_for_new_window,</span>
<a href="#l100.32"></a><span id="l100.32"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;);</span>
<a href="#l100.33"></a><span id="l100.33"> </span>
<a href="#l100.34"></a><span id="l100.34"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l100.35"></a><span id="l100.35"> </span>
<a href="#l100.36"></a><span id="l100.36"> var folder = null;</span>
<a href="#l100.37"></a><span id="l100.37"> </span>
<a href="#l100.38"></a><span id="l100.38" class="difflineminus">-function setupModule(module) {</span>
<a href="#l100.39"></a><span id="l100.39" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l100.40"></a><span id="l100.40">   folder = create_folder(&quot;viewsource&quot;);</span>
<a href="#l100.41"></a><span id="l100.41" class="difflineminus">-}</span>
<a href="#l100.42"></a><span id="l100.42" class="difflineplus">+});</span>
<a href="#l100.43"></a><span id="l100.43"> </span>
<a href="#l100.44"></a><span id="l100.44"> function addToFolder(aSubject, aBody, aFolder) {</span>
<a href="#l100.45"></a><span id="l100.45">   let msgId =</span>
<a href="#l100.46"></a><span id="l100.46">     Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l100.47"></a><span id="l100.47">       .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l100.48"></a><span id="l100.48">       .generateUUID() + &quot;@invalid&quot;;</span>
<a href="#l100.49"></a><span id="l100.49"> </span>
<a href="#l100.50"></a><span id="l100.50">   let source =</span>
<a href="#l100.51"></a><span id="l100.51" class="difflineat">@@ -66,28 +60,25 @@ function addToFolder(aSubject, aBody, aF</span>
<a href="#l100.52"></a><span id="l100.52"> </span>
<a href="#l100.53"></a><span id="l100.53">   return aFolder.msgDatabase.getMsgHdrForMessageID(msgId);</span>
<a href="#l100.54"></a><span id="l100.54"> }</span>
<a href="#l100.55"></a><span id="l100.55"> </span>
<a href="#l100.56"></a><span id="l100.56"> /**</span>
<a href="#l100.57"></a><span id="l100.57">  * Test that the view source character encoding can be changed,</span>
<a href="#l100.58"></a><span id="l100.58">  * which requires content policy is correct for view-source:.</span>
<a href="#l100.59"></a><span id="l100.59">  */</span>
<a href="#l100.60"></a><span id="l100.60" class="difflineminus">-function test_view_source_reload() {</span>
<a href="#l100.61"></a><span id="l100.61" class="difflineplus">+add_task(function test_view_source_reload() {</span>
<a href="#l100.62"></a><span id="l100.62">   be_in_folder(folder);</span>
<a href="#l100.63"></a><span id="l100.63"> </span>
<a href="#l100.64"></a><span id="l100.64">   let contentLatin1 = &quot;Testar, ett tv tre.&quot;;</span>
<a href="#l100.65"></a><span id="l100.65">   let contentUTF8 = &quot;Testar, ett tv tre&quot;;</span>
<a href="#l100.66"></a><span id="l100.66">   let msg = addToFolder(&quot;view-source reload test123?&quot;, contentLatin1, folder);</span>
<a href="#l100.67"></a><span id="l100.67"> </span>
<a href="#l100.68"></a><span id="l100.68">   let selMsg = select_click_row(0);</span>
<a href="#l100.69"></a><span id="l100.69" class="difflineminus">-  assert_true(</span>
<a href="#l100.70"></a><span id="l100.70" class="difflineminus">-    msg == selMsg,</span>
<a href="#l100.71"></a><span id="l100.71" class="difflineminus">-    &quot;Selected msg isn't the same as the generated one.&quot;</span>
<a href="#l100.72"></a><span id="l100.72" class="difflineminus">-  );</span>
<a href="#l100.73"></a><span id="l100.73" class="difflineplus">+  Assert.ok(msg == selMsg, &quot;Selected msg isn't the same as the generated one.&quot;);</span>
<a href="#l100.74"></a><span id="l100.74"> </span>
<a href="#l100.75"></a><span id="l100.75">   plan_for_new_window(&quot;navigator:view-source&quot;);</span>
<a href="#l100.76"></a><span id="l100.76">   mc.keypress(null, &quot;U&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l100.77"></a><span id="l100.77">   let vsc = wait_for_new_window(&quot;navigator:view-source&quot;);</span>
<a href="#l100.78"></a><span id="l100.78"> </span>
<a href="#l100.79"></a><span id="l100.79">   vsc.waitFor(</span>
<a href="#l100.80"></a><span id="l100.80">     () =&gt; vsc.e(&quot;content&quot;).contentDocument.querySelector(&quot;pre&quot;) != null,</span>
<a href="#l100.81"></a><span id="l100.81">     &quot;Timeout waiting for the latin1 view-source document to load.&quot;</span>
<a href="#l100.82"></a><span id="l100.82" class="difflineat">@@ -128,11 +119,9 @@ function test_view_source_reload() {</span>
<a href="#l100.83"></a><span id="l100.83">       &quot;View source didn't contain the utf-8 text;\n&quot; +</span>
<a href="#l100.84"></a><span id="l100.84">         contentUTF8 +</span>
<a href="#l100.85"></a><span id="l100.85">         &quot;\n&quot; +</span>
<a href="#l100.86"></a><span id="l100.86">         source</span>
<a href="#l100.87"></a><span id="l100.87">     );</span>
<a href="#l100.88"></a><span id="l100.88">   }</span>
<a href="#l100.89"></a><span id="l100.89"> </span>
<a href="#l100.90"></a><span id="l100.90">   close_window(vsc);</span>
<a href="#l100.91"></a><span id="l100.91" class="difflineminus">-}</span>
<a href="#l100.92"></a><span id="l100.92" class="difflineminus">-// Skip on Mac, as we can't click the (native) menus to make it work.</span>
<a href="#l100.93"></a><span id="l100.93" class="difflineminus">-test_view_source_reload.EXCLUDED_PLATFORMS = [&quot;darwin&quot;];</span>
<a href="#l100.94"></a><span id="l100.94" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l101.1"></a><span id="l101.1">copy from mail/test/mozmill/content-policy/html/mailtolink.html</span>
<a href="#l101.2"></a><span id="l101.2">copy to mail/test/browser/content-policy/html/mailtolink.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l102.1"></a><span id="l102.1">copy from mail/test/mozmill/content-policy/html/pass.png</span>
<a href="#l102.2"></a><span id="l102.2">copy to mail/test/browser/content-policy/html/pass.png</span>
<a href="#l102.3"></a><span id="l102.3"></span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l103.1"></a><span id="l103.1">copy from mail/test/mozmill/content-policy/html/plugin.html</span>
<a href="#l103.2"></a><span id="l103.2">copy to mail/test/browser/content-policy/html/plugin.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l104.1"></a><span id="l104.1">copy from mail/test/mozmill/content-policy/html/remote-noscript.html</span>
<a href="#l104.2"></a><span id="l104.2">copy to mail/test/browser/content-policy/html/remote-noscript.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l105.1"></a><span id="l105.1">copy from mail/test/mozmill/content-policy/html/remoteimage.html</span>
<a href="#l105.2"></a><span id="l105.2">copy to mail/test/browser/content-policy/html/remoteimage.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l106.1"></a><span id="l106.1">copy from mail/test/mozmill/content-policy/html/remoteimagedata.html</span>
<a href="#l106.2"></a><span id="l106.2">copy to mail/test/browser/content-policy/html/remoteimagedata.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l107.1"></a><span id="l107.1">copy from mail/test/mozmill/content-policy/html/remotevideo.html</span>
<a href="#l107.2"></a><span id="l107.2">copy to mail/test/browser/content-policy/html/remotevideo.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l108.1"></a><span id="l108.1">copy from mail/test/mozmill/content-policy/html/video.ogv</span>
<a href="#l108.2"></a><span id="l108.2">copy to mail/test/browser/content-policy/html/video.ogv</span>
<a href="#l108.3"></a><span id="l108.3"></span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l109.1"></a><span id="l109.1">new file mode 100644</span>
<a href="#l109.2"></a><span id="l109.2" class="difflineminus">--- /dev/null</span>
<a href="#l109.3"></a><span id="l109.3" class="difflineplus">+++ b/mail/test/browser/content-tabs/browser.ini</span>
<a href="#l109.4"></a><span id="l109.4" class="difflineat">@@ -0,0 +1,52 @@</span>
<a href="#l109.5"></a><span id="l109.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l109.6"></a><span id="l109.6" class="difflineplus">+prefs =</span>
<a href="#l109.7"></a><span id="l109.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l109.8"></a><span id="l109.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l109.9"></a><span id="l109.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l109.10"></a><span id="l109.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l109.11"></a><span id="l109.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l109.12"></a><span id="l109.12" class="difflineplus">+  mail.shell.checkDefaultClient=false</span>
<a href="#l109.13"></a><span id="l109.13" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l109.14"></a><span id="l109.14" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l109.15"></a><span id="l109.15" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l109.16"></a><span id="l109.16" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l109.17"></a><span id="l109.17" class="difflineplus">+  mail.account.account1.server=server1</span>
<a href="#l109.18"></a><span id="l109.18" class="difflineplus">+  mail.account.account2.identities=id1,id2</span>
<a href="#l109.19"></a><span id="l109.19" class="difflineplus">+  mail.account.account2.server=server2</span>
<a href="#l109.20"></a><span id="l109.20" class="difflineplus">+  mail.accountmanager.accounts=account1,account2</span>
<a href="#l109.21"></a><span id="l109.21" class="difflineplus">+  mail.accountmanager.defaultaccount=account2</span>
<a href="#l109.22"></a><span id="l109.22" class="difflineplus">+  mail.accountmanager.localfoldersserver=server1</span>
<a href="#l109.23"></a><span id="l109.23" class="difflineplus">+  mail.identity.id1.fullName=Tinderbox</span>
<a href="#l109.24"></a><span id="l109.24" class="difflineplus">+  mail.identity.id1.htmlSigFormat=false</span>
<a href="#l109.25"></a><span id="l109.25" class="difflineplus">+  mail.identity.id1.smtpServer=smtp1</span>
<a href="#l109.26"></a><span id="l109.26" class="difflineplus">+  mail.identity.id1.useremail=tinderbox@foo.invalid</span>
<a href="#l109.27"></a><span id="l109.27" class="difflineplus">+  mail.identity.id1.valid=true</span>
<a href="#l109.28"></a><span id="l109.28" class="difflineplus">+  mail.identity.id2.fullName=Tinderboxpushlog</span>
<a href="#l109.29"></a><span id="l109.29" class="difflineplus">+  mail.identity.id2.htmlSigFormat=true</span>
<a href="#l109.30"></a><span id="l109.30" class="difflineplus">+  mail.identity.id2.smtpServer=smtp1</span>
<a href="#l109.31"></a><span id="l109.31" class="difflineplus">+  mail.identity.id2.useremail=tinderboxpushlog@foo.invalid</span>
<a href="#l109.32"></a><span id="l109.32" class="difflineplus">+  mail.identity.id2.valid=true</span>
<a href="#l109.33"></a><span id="l109.33" class="difflineplus">+  mail.server.server1.hostname=Local_Folders</span>
<a href="#l109.34"></a><span id="l109.34" class="difflineplus">+  mail.server.server1.type=none</span>
<a href="#l109.35"></a><span id="l109.35" class="difflineplus">+  mail.server.server1.userName=nobody</span>
<a href="#l109.36"></a><span id="l109.36" class="difflineplus">+  mail.server.server2.check_new_mail=false</span>
<a href="#l109.37"></a><span id="l109.37" class="difflineplus">+  mail.server.server2.directory-rel=[ProfD]Mail/tinderbox</span>
<a href="#l109.38"></a><span id="l109.38" class="difflineplus">+  mail.server.server2.download_on_biff=true</span>
<a href="#l109.39"></a><span id="l109.39" class="difflineplus">+  mail.server.server2.hostname=tinderbox123</span>
<a href="#l109.40"></a><span id="l109.40" class="difflineplus">+  mail.server.server2.login_at_startup=false</span>
<a href="#l109.41"></a><span id="l109.41" class="difflineplus">+  mail.server.server2.name=tinderbox@foo.invalid</span>
<a href="#l109.42"></a><span id="l109.42" class="difflineplus">+  mail.server.server2.type=pop3</span>
<a href="#l109.43"></a><span id="l109.43" class="difflineplus">+  mail.server.server2.userName=tinderbox</span>
<a href="#l109.44"></a><span id="l109.44" class="difflineplus">+  mail.server.server2.whiteListAbURI=</span>
<a href="#l109.45"></a><span id="l109.45" class="difflineplus">+  mail.smtp.defaultserver=smtp1</span>
<a href="#l109.46"></a><span id="l109.46" class="difflineplus">+  mail.smtpserver.smtp1.hostname=tinderbox123</span>
<a href="#l109.47"></a><span id="l109.47" class="difflineplus">+  mail.smtpserver.smtp1.username=tinderbox</span>
<a href="#l109.48"></a><span id="l109.48" class="difflineplus">+  mail.smtpservers=smtp1</span>
<a href="#l109.49"></a><span id="l109.49" class="difflineplus">+  extensions.blocklist.url=http://mochi.test:8888/browser/comm/mail/test/browser/content-tabs/html/dummy.xml</span>
<a href="#l109.50"></a><span id="l109.50" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l109.51"></a><span id="l109.51" class="difflineplus">+support-files = html/**</span>
<a href="#l109.52"></a><span id="l109.52" class="difflineplus">+</span>
<a href="#l109.53"></a><span id="l109.53" class="difflineplus">+[browser_aboutSupport.js]</span>
<a href="#l109.54"></a><span id="l109.54" class="difflineplus">+[browser_addonsMgr.js]</span>
<a href="#l109.55"></a><span id="l109.55" class="difflineplus">+[browser_contentTab.js]</span>
<a href="#l109.56"></a><span id="l109.56" class="difflineplus">+[browser_installXpi.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l110.1"></a><span id="l110.1">copy from mail/test/mozmill/content-tabs/test-about-support.js</span>
<a href="#l110.2"></a><span id="l110.2">copy to mail/test/browser/content-tabs/browser_aboutSupport.js</span>
<a href="#l110.3"></a><span id="l110.3" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-about-support.js</span>
<a href="#l110.4"></a><span id="l110.4" class="difflineplus">+++ b/mail/test/browser/content-tabs/browser_aboutSupport.js</span>
<a href="#l110.5"></a><span id="l110.5" class="difflineat">@@ -17,51 +17,43 @@ var {</span>
<a href="#l110.6"></a><span id="l110.6">   get_content_tab_element_display,</span>
<a href="#l110.7"></a><span id="l110.7">   get_element_by_text,</span>
<a href="#l110.8"></a><span id="l110.8">   open_content_tab_with_click,</span>
<a href="#l110.9"></a><span id="l110.9">   wait_for_content_tab_element_display,</span>
<a href="#l110.10"></a><span id="l110.10"> } = ChromeUtils.import(</span>
<a href="#l110.11"></a><span id="l110.11">   &quot;resource://testing-common/mozmill/ContentTabHelpers.jsm&quot;</span>
<a href="#l110.12"></a><span id="l110.12"> );</span>
<a href="#l110.13"></a><span id="l110.13"> </span>
<a href="#l110.14"></a><span id="l110.14" class="difflineminus">-var {</span>
<a href="#l110.15"></a><span id="l110.15" class="difflineminus">-  assert_equals,</span>
<a href="#l110.16"></a><span id="l110.16" class="difflineminus">-  assert_true,</span>
<a href="#l110.17"></a><span id="l110.17" class="difflineminus">-  close_tab,</span>
<a href="#l110.18"></a><span id="l110.18" class="difflineminus">-  mark_failure,</span>
<a href="#l110.19"></a><span id="l110.19" class="difflineminus">-  mc,</span>
<a href="#l110.20"></a><span id="l110.20" class="difflineminus">-} = ChromeUtils.import(</span>
<a href="#l110.21"></a><span id="l110.21" class="difflineplus">+var { close_tab, mc } = ChromeUtils.import(</span>
<a href="#l110.22"></a><span id="l110.22">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l110.23"></a><span id="l110.23"> );</span>
<a href="#l110.24"></a><span id="l110.24"> var { plan_for_new_window } = ChromeUtils.import(</span>
<a href="#l110.25"></a><span id="l110.25">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l110.26"></a><span id="l110.26"> );</span>
<a href="#l110.27"></a><span id="l110.27"> </span>
<a href="#l110.28"></a><span id="l110.28"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l110.29"></a><span id="l110.29" class="difflineminus">-// eslint-disable-next-line mozilla/reject-importGlobalProperties</span>
<a href="#l110.30"></a><span id="l110.30" class="difflineminus">-Cu.importGlobalProperties([&quot;DOMParser&quot;]);</span>
<a href="#l110.31"></a><span id="l110.31"> </span>
<a href="#l110.32"></a><span id="l110.32"> var warningText = new Map();</span>
<a href="#l110.33"></a><span id="l110.33"> </span>
<a href="#l110.34"></a><span id="l110.34" class="difflineminus">-function setupModule(module) {</span>
<a href="#l110.35"></a><span id="l110.35" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l110.36"></a><span id="l110.36">   // The wording of the warning message when private data is being exported</span>
<a href="#l110.37"></a><span id="l110.37">   // from the about:support page.</span>
<a href="#l110.38"></a><span id="l110.38">   let bundle = Services.strings.createBundle(</span>
<a href="#l110.39"></a><span id="l110.39">     &quot;chrome://messenger/locale/aboutSupportMail.properties&quot;</span>
<a href="#l110.40"></a><span id="l110.40">   );</span>
<a href="#l110.41"></a><span id="l110.41">   // In HTML the warning label and text comprise the textContent of a single element.</span>
<a href="#l110.42"></a><span id="l110.42">   warningText.set(</span>
<a href="#l110.43"></a><span id="l110.43">     &quot;text/html&quot;,</span>
<a href="#l110.44"></a><span id="l110.44">     bundle.GetStringFromName(&quot;warningLabel&quot;) +</span>
<a href="#l110.45"></a><span id="l110.45">       &quot; &quot; +</span>
<a href="#l110.46"></a><span id="l110.46">       bundle.GetStringFromName(&quot;warningText&quot;)</span>
<a href="#l110.47"></a><span id="l110.47">   );</span>
<a href="#l110.48"></a><span id="l110.48">   // In plain text the warning label may end up on a separate line so do not match it.</span>
<a href="#l110.49"></a><span id="l110.49">   warningText.set(&quot;text/unicode&quot;, bundle.GetStringFromName(&quot;warningText&quot;));</span>
<a href="#l110.50"></a><span id="l110.50" class="difflineminus">-}</span>
<a href="#l110.51"></a><span id="l110.51" class="difflineplus">+});</span>
<a href="#l110.52"></a><span id="l110.52"> </span>
<a href="#l110.53"></a><span id="l110.53"> // After every test we want to close the about:support tab so that failures</span>
<a href="#l110.54"></a><span id="l110.54"> // don't cascade.</span>
<a href="#l110.55"></a><span id="l110.55"> function teardownTest(module) {</span>
<a href="#l110.56"></a><span id="l110.56">   mc.tabmail.closeOtherTabs(mc.tabmail.tabInfo[0]);</span>
<a href="#l110.57"></a><span id="l110.57"> }</span>
<a href="#l110.58"></a><span id="l110.58"> </span>
<a href="#l110.59"></a><span id="l110.59"> /**</span>
<a href="#l110.60"></a><span id="l110.60" class="difflineat">@@ -151,32 +143,32 @@ function open_send_via_email(aTab) {</span>
<a href="#l110.61"></a><span id="l110.61">  */</span>
<a href="#l110.62"></a><span id="l110.62"> function find_private_element(aTab) {</span>
<a href="#l110.63"></a><span id="l110.63">   // We use the identity name as an example of a private-only element.</span>
<a href="#l110.64"></a><span id="l110.64">   // It is currently the second td element with class=&quot;data-private&quot; in the table.</span>
<a href="#l110.65"></a><span id="l110.65">   // The content string must be something unique that is not found anywhere else.</span>
<a href="#l110.66"></a><span id="l110.66">   let elem = aTab.browser.contentDocument.querySelector(</span>
<a href="#l110.67"></a><span id="l110.67">     &quot;#accounts-table td.data-private~td.data-private&quot;</span>
<a href="#l110.68"></a><span id="l110.68">   );</span>
<a href="#l110.69"></a><span id="l110.69" class="difflineminus">-  assert_true(elem != null);</span>
<a href="#l110.70"></a><span id="l110.70" class="difflineminus">-  assert_true(elem.textContent.length &gt; 0);</span>
<a href="#l110.71"></a><span id="l110.71" class="difflineminus">-  assert_equals(get_content_tab_element_display(aTab, elem), &quot;none&quot;);</span>
<a href="#l110.72"></a><span id="l110.72" class="difflineplus">+  Assert.ok(elem != null);</span>
<a href="#l110.73"></a><span id="l110.73" class="difflineplus">+  Assert.ok(elem.textContent.length &gt; 0);</span>
<a href="#l110.74"></a><span id="l110.74" class="difflineplus">+  Assert.equal(get_content_tab_element_display(aTab, elem), &quot;none&quot;);</span>
<a href="#l110.75"></a><span id="l110.75">   return elem;</span>
<a href="#l110.76"></a><span id="l110.76"> }</span>
<a href="#l110.77"></a><span id="l110.77"> </span>
<a href="#l110.78"></a><span id="l110.78"> /*</span>
<a href="#l110.79"></a><span id="l110.79">  * Tests</span>
<a href="#l110.80"></a><span id="l110.80">  */</span>
<a href="#l110.81"></a><span id="l110.81"> </span>
<a href="#l110.82"></a><span id="l110.82"> /**</span>
<a href="#l110.83"></a><span id="l110.83">  * Test displaying the about:support page. Also perform a couple of basic tests</span>
<a href="#l110.84"></a><span id="l110.84">  * to check that no major errors have occurred. The basic tests are by no means</span>
<a href="#l110.85"></a><span id="l110.85">  * comprehensive.</span>
<a href="#l110.86"></a><span id="l110.86">  */</span>
<a href="#l110.87"></a><span id="l110.87" class="difflineminus">-function test_display_about_support() {</span>
<a href="#l110.88"></a><span id="l110.88" class="difflineplus">+add_task(function test_display_about_support() {</span>
<a href="#l110.89"></a><span id="l110.89">   let tab = open_about_support();</span>
<a href="#l110.90"></a><span id="l110.90">   // Check that the document has a few strings that indicate that we've loaded</span>
<a href="#l110.91"></a><span id="l110.91">   // the right page.</span>
<a href="#l110.92"></a><span id="l110.92">   for (let str of ABOUT_SUPPORT_STRINGS) {</span>
<a href="#l110.93"></a><span id="l110.93">     assert_content_tab_text_present(tab, str);</span>
<a href="#l110.94"></a><span id="l110.94">   }</span>
<a href="#l110.95"></a><span id="l110.95"> </span>
<a href="#l110.96"></a><span id="l110.96">   // Check that error strings aren't present anywhere</span>
<a href="#l110.97"></a><span id="l110.97" class="difflineat">@@ -194,128 +186,133 @@ function test_display_about_support() {</span>
<a href="#l110.98"></a><span id="l110.98">     &quot;graphics-tbody&quot;,</span>
<a href="#l110.99"></a><span id="l110.99">     &quot;locked-prefs-tbody&quot;,</span>
<a href="#l110.100"></a><span id="l110.100">     &quot;sandbox-syscalls-tbody&quot;,</span>
<a href="#l110.101"></a><span id="l110.101">     &quot;crashes-tbody&quot;,</span>
<a href="#l110.102"></a><span id="l110.102">     &quot;processes-tbody&quot;,</span>
<a href="#l110.103"></a><span id="l110.103">   ]; // some tables may be empty</span>
<a href="#l110.104"></a><span id="l110.104">   for (let table of tables) {</span>
<a href="#l110.105"></a><span id="l110.105">     if (!emptyTables.includes(table.id)) {</span>
<a href="#l110.106"></a><span id="l110.106" class="difflineminus">-      assert_true(</span>
<a href="#l110.107"></a><span id="l110.107" class="difflineplus">+      Assert.ok(</span>
<a href="#l110.108"></a><span id="l110.108">         table.querySelectorAll(&quot;tr&quot;).length &gt; 0,</span>
<a href="#l110.109"></a><span id="l110.109">         &quot;Troubleshooting table '&quot; + table.id + &quot;' is empty!&quot;</span>
<a href="#l110.110"></a><span id="l110.110">       );</span>
<a href="#l110.111"></a><span id="l110.111">     }</span>
<a href="#l110.112"></a><span id="l110.112">   }</span>
<a href="#l110.113"></a><span id="l110.113"> </span>
<a href="#l110.114"></a><span id="l110.114">   // Mozmill uses a user.js file in the profile, so the warning about the file</span>
<a href="#l110.115"></a><span id="l110.115">   // should be visible here.</span>
<a href="#l110.116"></a><span id="l110.116">   let userjsElem = tab.browser.contentDocument.getElementById(</span>
<a href="#l110.117"></a><span id="l110.117">     &quot;prefs-user-js-section&quot;</span>
<a href="#l110.118"></a><span id="l110.118">   );</span>
<a href="#l110.119"></a><span id="l110.119" class="difflineminus">-  assert_true(userjsElem.hasChildNodes);</span>
<a href="#l110.120"></a><span id="l110.120" class="difflineminus">-  assert_true(</span>
<a href="#l110.121"></a><span id="l110.121" class="difflineplus">+  Assert.ok(userjsElem.hasChildNodes);</span>
<a href="#l110.122"></a><span id="l110.122" class="difflineplus">+  Assert.ok(</span>
<a href="#l110.123"></a><span id="l110.123">     tab.browser.contentDocument.defaultView.getComputedStyle(userjsElem)</span>
<a href="#l110.124"></a><span id="l110.124">       .display == &quot;block&quot;</span>
<a href="#l110.125"></a><span id="l110.125">   );</span>
<a href="#l110.126"></a><span id="l110.126" class="difflineminus">-  assert_true(</span>
<a href="#l110.127"></a><span id="l110.127" class="difflineplus">+  Assert.ok(</span>
<a href="#l110.128"></a><span id="l110.128">     tab.browser.contentDocument.defaultView.getComputedStyle(userjsElem)</span>
<a href="#l110.129"></a><span id="l110.129">       .visibility == &quot;visible&quot;</span>
<a href="#l110.130"></a><span id="l110.130">   );</span>
<a href="#l110.131"></a><span id="l110.131"> </span>
<a href="#l110.132"></a><span id="l110.132">   close_tab(tab);</span>
<a href="#l110.133"></a><span id="l110.133" class="difflineminus">-}</span>
<a href="#l110.134"></a><span id="l110.134" class="difflineplus">+});</span>
<a href="#l110.135"></a><span id="l110.135"> </span>
<a href="#l110.136"></a><span id="l110.136"> /**</span>
<a href="#l110.137"></a><span id="l110.137">  * Test that our accounts are displayed in order.</span>
<a href="#l110.138"></a><span id="l110.138">  */</span>
<a href="#l110.139"></a><span id="l110.139" class="difflineminus">-function test_accounts_in_order() {</span>
<a href="#l110.140"></a><span id="l110.140" class="difflineplus">+add_task(function test_accounts_in_order() {</span>
<a href="#l110.141"></a><span id="l110.141">   let tab = open_about_support();</span>
<a href="#l110.142"></a><span id="l110.142">   // This is a really simple test and by no means comprehensive -- test that</span>
<a href="#l110.143"></a><span id="l110.143">   // &quot;account1&quot; appears before &quot;account2&quot; in the HTML content.</span>
<a href="#l110.144"></a><span id="l110.144">   assert_content_tab_text_present(tab, &quot;account1&quot;);</span>
<a href="#l110.145"></a><span id="l110.145">   assert_content_tab_text_present(tab, &quot;account2&quot;);</span>
<a href="#l110.146"></a><span id="l110.146">   let html = tab.browser.contentDocument.documentElement.innerHTML;</span>
<a href="#l110.147"></a><span id="l110.147">   if (html.indexOf(&quot;account1&quot;) &gt; html.indexOf(&quot;account2&quot;)) {</span>
<a href="#l110.148"></a><span id="l110.148" class="difflineminus">-    mark_failure([&quot;account1 found after account2 in the HTML page&quot;]);</span>
<a href="#l110.149"></a><span id="l110.149" class="difflineplus">+    Assert.report(</span>
<a href="#l110.150"></a><span id="l110.150" class="difflineplus">+      true,</span>
<a href="#l110.151"></a><span id="l110.151" class="difflineplus">+      undefined,</span>
<a href="#l110.152"></a><span id="l110.152" class="difflineplus">+      undefined,</span>
<a href="#l110.153"></a><span id="l110.153" class="difflineplus">+      &quot;account1 found after account2 in the HTML page&quot;</span>
<a href="#l110.154"></a><span id="l110.154" class="difflineplus">+    );</span>
<a href="#l110.155"></a><span id="l110.155">   }</span>
<a href="#l110.156"></a><span id="l110.156">   close_tab(tab);</span>
<a href="#l110.157"></a><span id="l110.157" class="difflineminus">-}</span>
<a href="#l110.158"></a><span id="l110.158" class="difflineplus">+});</span>
<a href="#l110.159"></a><span id="l110.159"> </span>
<a href="#l110.160"></a><span id="l110.160"> var UNIQUE_ID = &quot;3a9e1694-7115-4237-8b1e-1cabe6e35073&quot;;</span>
<a href="#l110.161"></a><span id="l110.161"> </span>
<a href="#l110.162"></a><span id="l110.162"> /**</span>
<a href="#l110.163"></a><span id="l110.163">  * Test that a modified preference on the whitelist but not on the blacklist</span>
<a href="#l110.164"></a><span id="l110.164">  * shows up.</span>
<a href="#l110.165"></a><span id="l110.165">  */</span>
<a href="#l110.166"></a><span id="l110.166" class="difflineminus">-function test_modified_pref_on_whitelist() {</span>
<a href="#l110.167"></a><span id="l110.167" class="difflineplus">+add_task(function test_modified_pref_on_whitelist() {</span>
<a href="#l110.168"></a><span id="l110.168">   const PREFIX = &quot;accessibility.&quot;;</span>
<a href="#l110.169"></a><span id="l110.169">   let prefName = PREFIX + UNIQUE_ID;</span>
<a href="#l110.170"></a><span id="l110.170">   Services.prefs.setBoolPref(prefName, true);</span>
<a href="#l110.171"></a><span id="l110.171">   let tab = open_about_support();</span>
<a href="#l110.172"></a><span id="l110.172"> </span>
<a href="#l110.173"></a><span id="l110.173">   assert_content_tab_text_present(tab, prefName);</span>
<a href="#l110.174"></a><span id="l110.174">   close_tab(tab);</span>
<a href="#l110.175"></a><span id="l110.175">   Services.prefs.clearUserPref(prefName);</span>
<a href="#l110.176"></a><span id="l110.176" class="difflineminus">-}</span>
<a href="#l110.177"></a><span id="l110.177" class="difflineplus">+});</span>
<a href="#l110.178"></a><span id="l110.178"> </span>
<a href="#l110.179"></a><span id="l110.179"> /**</span>
<a href="#l110.180"></a><span id="l110.180">  * Test that a modified preference not on the whitelist doesn't show up.</span>
<a href="#l110.181"></a><span id="l110.181">  */</span>
<a href="#l110.182"></a><span id="l110.182" class="difflineminus">-function test_modified_pref_not_on_whitelist() {</span>
<a href="#l110.183"></a><span id="l110.183" class="difflineplus">+add_task(function test_modified_pref_not_on_whitelist() {</span>
<a href="#l110.184"></a><span id="l110.184">   Services.prefs.setBoolPref(UNIQUE_ID, true);</span>
<a href="#l110.185"></a><span id="l110.185">   let tab = open_about_support();</span>
<a href="#l110.186"></a><span id="l110.186">   assert_content_tab_text_absent(tab, UNIQUE_ID);</span>
<a href="#l110.187"></a><span id="l110.187">   close_tab(tab);</span>
<a href="#l110.188"></a><span id="l110.188">   Services.prefs.clearUserPref(UNIQUE_ID);</span>
<a href="#l110.189"></a><span id="l110.189" class="difflineminus">-}</span>
<a href="#l110.190"></a><span id="l110.190" class="difflineplus">+});</span>
<a href="#l110.191"></a><span id="l110.191"> </span>
<a href="#l110.192"></a><span id="l110.192"> /**</span>
<a href="#l110.193"></a><span id="l110.193">  * Test that a modified preference on the blacklist doesn't show up.</span>
<a href="#l110.194"></a><span id="l110.194">  */</span>
<a href="#l110.195"></a><span id="l110.195" class="difflineminus">-function test_modified_pref_on_blacklist() {</span>
<a href="#l110.196"></a><span id="l110.196" class="difflineplus">+add_task(function test_modified_pref_on_blacklist() {</span>
<a href="#l110.197"></a><span id="l110.197">   const PREFIX = &quot;network.proxy.&quot;;</span>
<a href="#l110.198"></a><span id="l110.198">   let prefName = PREFIX + UNIQUE_ID;</span>
<a href="#l110.199"></a><span id="l110.199">   Services.prefs.setBoolPref(prefName, true);</span>
<a href="#l110.200"></a><span id="l110.200">   let tab = open_about_support();</span>
<a href="#l110.201"></a><span id="l110.201"> </span>
<a href="#l110.202"></a><span id="l110.202">   assert_content_tab_text_absent(tab, prefName);</span>
<a href="#l110.203"></a><span id="l110.203">   close_tab(tab);</span>
<a href="#l110.204"></a><span id="l110.204">   Services.prefs.clearUserPref(prefName);</span>
<a href="#l110.205"></a><span id="l110.205" class="difflineminus">-}</span>
<a href="#l110.206"></a><span id="l110.206" class="difflineplus">+});</span>
<a href="#l110.207"></a><span id="l110.207"> </span>
<a href="#l110.208"></a><span id="l110.208"> /**</span>
<a href="#l110.209"></a><span id="l110.209">  * Test that private data isn't displayed by default, and that when it is</span>
<a href="#l110.210"></a><span id="l110.210">  * displayed, it actually shows up.</span>
<a href="#l110.211"></a><span id="l110.211">  */</span>
<a href="#l110.212"></a><span id="l110.212" class="difflineminus">-function test_private_data() {</span>
<a href="#l110.213"></a><span id="l110.213" class="difflineplus">+add_task(function test_private_data() {</span>
<a href="#l110.214"></a><span id="l110.214">   let tab = open_about_support();</span>
<a href="#l110.215"></a><span id="l110.215">   let checkbox = content_tab_eid(tab, &quot;check-show-private-data&quot;);</span>
<a href="#l110.216"></a><span id="l110.216"> </span>
<a href="#l110.217"></a><span id="l110.217">   // We use the profile path and some other element as an example</span>
<a href="#l110.218"></a><span id="l110.218">   // of a private-only element.</span>
<a href="#l110.219"></a><span id="l110.219">   let privateElem1 = find_private_element(tab);</span>
<a href="#l110.220"></a><span id="l110.220">   let privateElem2 = content_tab_e(tab, &quot;profile-dir-box&quot;);</span>
<a href="#l110.221"></a><span id="l110.221">   // We use the profile button as an example of a public element.</span>
<a href="#l110.222"></a><span id="l110.222">   let publicElem = content_tab_e(tab, &quot;profile-dir-button&quot;);</span>
<a href="#l110.223"></a><span id="l110.223"> </span>
<a href="#l110.224"></a><span id="l110.224" class="difflineminus">-  assert_true(</span>
<a href="#l110.225"></a><span id="l110.225" class="difflineplus">+  Assert.ok(</span>
<a href="#l110.226"></a><span id="l110.226">     !checkbox.checked,</span>
<a href="#l110.227"></a><span id="l110.227">     &quot;Private data checkbox shouldn't be checked by default&quot;</span>
<a href="#l110.228"></a><span id="l110.228">   );</span>
<a href="#l110.229"></a><span id="l110.229">   assert_content_tab_element_visible(tab, publicElem);</span>
<a href="#l110.230"></a><span id="l110.230">   assert_content_tab_element_hidden(tab, privateElem1);</span>
<a href="#l110.231"></a><span id="l110.231">   assert_content_tab_element_hidden(tab, privateElem2);</span>
<a href="#l110.232"></a><span id="l110.232"> </span>
<a href="#l110.233"></a><span id="l110.233">   // Now check the checkbox and see what happens.</span>
<a href="#l110.234"></a><span id="l110.234">   mc.click(checkbox);</span>
<a href="#l110.235"></a><span id="l110.235">   wait_for_content_tab_element_display(tab, privateElem1);</span>
<a href="#l110.236"></a><span id="l110.236">   wait_for_content_tab_element_display(tab, privateElem2);</span>
<a href="#l110.237"></a><span id="l110.237">   close_tab(tab);</span>
<a href="#l110.238"></a><span id="l110.238" class="difflineminus">-}</span>
<a href="#l110.239"></a><span id="l110.239" class="difflineplus">+});</span>
<a href="#l110.240"></a><span id="l110.240"> </span>
<a href="#l110.241"></a><span id="l110.241"> /**</span>
<a href="#l110.242"></a><span id="l110.242">  * Checks if text fragment exists in the document.</span>
<a href="#l110.243"></a><span id="l110.243">  * If it is a node tree, find the element whole contents is the searched text.</span>
<a href="#l110.244"></a><span id="l110.244">  * If it is plain text string, just check in text is anywhere in it.</span>
<a href="#l110.245"></a><span id="l110.245">  *</span>
<a href="#l110.246"></a><span id="l110.246">  * @param aDocument  A node tree or a string of plain text data.</span>
<a href="#l110.247"></a><span id="l110.247">  * @param aText      The text to find in the document.</span>
<a href="#l110.248"></a><span id="l110.248" class="difflineat">@@ -325,17 +322,17 @@ function check_text_in_body(aDocument, a</span>
<a href="#l110.249"></a><span id="l110.249">     return get_element_by_text(aDocument, aText) != null;</span>
<a href="#l110.250"></a><span id="l110.250">   }</span>
<a href="#l110.251"></a><span id="l110.251">   return aDocument.includes(aText);</span>
<a href="#l110.252"></a><span id="l110.252"> }</span>
<a href="#l110.253"></a><span id="l110.253"> </span>
<a href="#l110.254"></a><span id="l110.254"> /**</span>
<a href="#l110.255"></a><span id="l110.255">  * Test (well, sort of) the copy to clipboard function with public data.</span>
<a href="#l110.256"></a><span id="l110.256">  */</span>
<a href="#l110.257"></a><span id="l110.257" class="difflineminus">-function test_copy_to_clipboard_public() {</span>
<a href="#l110.258"></a><span id="l110.258" class="difflineplus">+add_task(function test_copy_to_clipboard_public() {</span>
<a href="#l110.259"></a><span id="l110.259">   let tab = open_about_support();</span>
<a href="#l110.260"></a><span id="l110.260">   let privateElem = find_private_element(tab);</span>
<a href="#l110.261"></a><span id="l110.261">   // To avoid destroying the current contents of the clipboard, instead of</span>
<a href="#l110.262"></a><span id="l110.262">   // actually copying to it, we just retrieve what would have been copied to it</span>
<a href="#l110.263"></a><span id="l110.263">   let transferable = tab.browser.contentWindow.getClipboardTransferable();</span>
<a href="#l110.264"></a><span id="l110.264">   for (let flavor of [&quot;text/html&quot;, &quot;text/unicode&quot;]) {</span>
<a href="#l110.265"></a><span id="l110.265">     let data = {};</span>
<a href="#l110.266"></a><span id="l110.266">     transferable.getTransferData(flavor, data, {});</span>
<a href="#l110.267"></a><span id="l110.267" class="difflineat">@@ -345,40 +342,53 @@ function test_copy_to_clipboard_public()</span>
<a href="#l110.268"></a><span id="l110.268">       let parser = new DOMParser();</span>
<a href="#l110.269"></a><span id="l110.269">       contentBody = parser.parseFromString(text, &quot;text/html&quot;).body;</span>
<a href="#l110.270"></a><span id="l110.270">     } else {</span>
<a href="#l110.271"></a><span id="l110.271">       contentBody = text;</span>
<a href="#l110.272"></a><span id="l110.272">     }</span>
<a href="#l110.273"></a><span id="l110.273"> </span>
<a href="#l110.274"></a><span id="l110.274">     for (let str of ABOUT_SUPPORT_STRINGS) {</span>
<a href="#l110.275"></a><span id="l110.275">       if (!check_text_in_body(contentBody, str)) {</span>
<a href="#l110.276"></a><span id="l110.276" class="difflineminus">-        mark_failure([</span>
<a href="#l110.277"></a><span id="l110.277" class="difflineminus">-          'Unable to find &quot;' + str + '&quot; in flavor &quot;' + flavor + '&quot;',</span>
<a href="#l110.278"></a><span id="l110.278" class="difflineminus">-        ]);</span>
<a href="#l110.279"></a><span id="l110.279" class="difflineplus">+        Assert.report(</span>
<a href="#l110.280"></a><span id="l110.280" class="difflineplus">+          true,</span>
<a href="#l110.281"></a><span id="l110.281" class="difflineplus">+          undefined,</span>
<a href="#l110.282"></a><span id="l110.282" class="difflineplus">+          undefined,</span>
<a href="#l110.283"></a><span id="l110.283" class="difflineplus">+          `Unable to find &quot;${str}&quot; in flavor &quot;${flavor}&quot;`</span>
<a href="#l110.284"></a><span id="l110.284" class="difflineplus">+        );</span>
<a href="#l110.285"></a><span id="l110.285">       }</span>
<a href="#l110.286"></a><span id="l110.286">     }</span>
<a href="#l110.287"></a><span id="l110.287"> </span>
<a href="#l110.288"></a><span id="l110.288">     for (let str of ABOUT_SUPPORT_ERROR_STRINGS.get(flavor)) {</span>
<a href="#l110.289"></a><span id="l110.289">       if (check_text_in_body(contentBody, str)) {</span>
<a href="#l110.290"></a><span id="l110.290" class="difflineminus">-        mark_failure(['Found &quot;' + str + '&quot; in flavor &quot;' + flavor + '&quot;']);</span>
<a href="#l110.291"></a><span id="l110.291" class="difflineplus">+        Assert.report(</span>
<a href="#l110.292"></a><span id="l110.292" class="difflineplus">+          true,</span>
<a href="#l110.293"></a><span id="l110.293" class="difflineplus">+          undefined,</span>
<a href="#l110.294"></a><span id="l110.294" class="difflineplus">+          undefined,</span>
<a href="#l110.295"></a><span id="l110.295" class="difflineplus">+          `Found &quot;${str}&quot; in flavor &quot;${flavor}&quot;`</span>
<a href="#l110.296"></a><span id="l110.296" class="difflineplus">+        );</span>
<a href="#l110.297"></a><span id="l110.297">       }</span>
<a href="#l110.298"></a><span id="l110.298">     }</span>
<a href="#l110.299"></a><span id="l110.299"> </span>
<a href="#l110.300"></a><span id="l110.300">     // Check that private data isn't in the output.</span>
<a href="#l110.301"></a><span id="l110.301">     if (check_text_in_body(contentBody, privateElem.textContent)) {</span>
<a href="#l110.302"></a><span id="l110.302" class="difflineminus">-      mark_failure(['Found private data in flavor &quot;' + flavor + '&quot;']);</span>
<a href="#l110.303"></a><span id="l110.303" class="difflineplus">+      Assert.report(</span>
<a href="#l110.304"></a><span id="l110.304" class="difflineplus">+        true,</span>
<a href="#l110.305"></a><span id="l110.305" class="difflineplus">+        undefined,</span>
<a href="#l110.306"></a><span id="l110.306" class="difflineplus">+        undefined,</span>
<a href="#l110.307"></a><span id="l110.307" class="difflineplus">+        `Found private data in flavor &quot;${flavor}&quot;`</span>
<a href="#l110.308"></a><span id="l110.308" class="difflineplus">+      );</span>
<a href="#l110.309"></a><span id="l110.309">     }</span>
<a href="#l110.310"></a><span id="l110.310">   }</span>
<a href="#l110.311"></a><span id="l110.311">   close_tab(tab);</span>
<a href="#l110.312"></a><span id="l110.312" class="difflineminus">-}</span>
<a href="#l110.313"></a><span id="l110.313" class="difflineplus">+});</span>
<a href="#l110.314"></a><span id="l110.314"> </span>
<a href="#l110.315"></a><span id="l110.315"> /**</span>
<a href="#l110.316"></a><span id="l110.316">  * Test (well, sort of) the copy to clipboard function with private data.</span>
<a href="#l110.317"></a><span id="l110.317">  */</span>
<a href="#l110.318"></a><span id="l110.318" class="difflineminus">-function test_copy_to_clipboard_private() {</span>
<a href="#l110.319"></a><span id="l110.319" class="difflineplus">+add_task(function test_copy_to_clipboard_private() {</span>
<a href="#l110.320"></a><span id="l110.320">   let tab = open_about_support();</span>
<a href="#l110.321"></a><span id="l110.321"> </span>
<a href="#l110.322"></a><span id="l110.322">   // Display private data.</span>
<a href="#l110.323"></a><span id="l110.323">   let privateElem = find_private_element(tab);</span>
<a href="#l110.324"></a><span id="l110.324">   mc.click(content_tab_eid(tab, &quot;check-show-private-data&quot;));</span>
<a href="#l110.325"></a><span id="l110.325">   wait_for_content_tab_element_display(tab, privateElem);</span>
<a href="#l110.326"></a><span id="l110.326"> </span>
<a href="#l110.327"></a><span id="l110.327">   // To avoid destroying the current contents of the clipboard, instead of</span>
<a href="#l110.328"></a><span id="l110.328" class="difflineat">@@ -393,105 +403,158 @@ function test_copy_to_clipboard_private(</span>
<a href="#l110.329"></a><span id="l110.329">       let parser = new DOMParser();</span>
<a href="#l110.330"></a><span id="l110.330">       contentBody = parser.parseFromString(text, &quot;text/html&quot;).body;</span>
<a href="#l110.331"></a><span id="l110.331">     } else {</span>
<a href="#l110.332"></a><span id="l110.332">       contentBody = text;</span>
<a href="#l110.333"></a><span id="l110.333">     }</span>
<a href="#l110.334"></a><span id="l110.334"> </span>
<a href="#l110.335"></a><span id="l110.335">     for (let str of ABOUT_SUPPORT_STRINGS) {</span>
<a href="#l110.336"></a><span id="l110.336">       if (!check_text_in_body(contentBody, str)) {</span>
<a href="#l110.337"></a><span id="l110.337" class="difflineminus">-        mark_failure([</span>
<a href="#l110.338"></a><span id="l110.338" class="difflineminus">-          'Unable to find &quot;' + str + '&quot; in flavor &quot;' + flavor + '&quot;',</span>
<a href="#l110.339"></a><span id="l110.339" class="difflineminus">-        ]);</span>
<a href="#l110.340"></a><span id="l110.340" class="difflineplus">+        Assert.report(</span>
<a href="#l110.341"></a><span id="l110.341" class="difflineplus">+          true,</span>
<a href="#l110.342"></a><span id="l110.342" class="difflineplus">+          undefined,</span>
<a href="#l110.343"></a><span id="l110.343" class="difflineplus">+          undefined,</span>
<a href="#l110.344"></a><span id="l110.344" class="difflineplus">+          `Unable to find &quot;${str}&quot; in flavor &quot;${flavor}&quot;`</span>
<a href="#l110.345"></a><span id="l110.345" class="difflineplus">+        );</span>
<a href="#l110.346"></a><span id="l110.346">       }</span>
<a href="#l110.347"></a><span id="l110.347">     }</span>
<a href="#l110.348"></a><span id="l110.348"> </span>
<a href="#l110.349"></a><span id="l110.349">     for (let str of ABOUT_SUPPORT_ERROR_STRINGS.get(flavor)) {</span>
<a href="#l110.350"></a><span id="l110.350">       if (check_text_in_body(contentBody, str)) {</span>
<a href="#l110.351"></a><span id="l110.351" class="difflineminus">-        mark_failure(['Found &quot;' + str + '&quot; in flavor &quot;' + flavor + '&quot;']);</span>
<a href="#l110.352"></a><span id="l110.352" class="difflineplus">+        Assert.report(</span>
<a href="#l110.353"></a><span id="l110.353" class="difflineplus">+          true,</span>
<a href="#l110.354"></a><span id="l110.354" class="difflineplus">+          undefined,</span>
<a href="#l110.355"></a><span id="l110.355" class="difflineplus">+          undefined,</span>
<a href="#l110.356"></a><span id="l110.356" class="difflineplus">+          `Found &quot;${str}&quot; in flavor &quot;${flavor}&quot;`</span>
<a href="#l110.357"></a><span id="l110.357" class="difflineplus">+        );</span>
<a href="#l110.358"></a><span id="l110.358">       }</span>
<a href="#l110.359"></a><span id="l110.359">     }</span>
<a href="#l110.360"></a><span id="l110.360"> </span>
<a href="#l110.361"></a><span id="l110.361">     // Check that private data is in the output.</span>
<a href="#l110.362"></a><span id="l110.362">     if (!check_text_in_body(contentBody, privateElem.textContent)) {</span>
<a href="#l110.363"></a><span id="l110.363" class="difflineminus">-      mark_failure(['Unable to find private data in flavor &quot;' + flavor + '&quot;']);</span>
<a href="#l110.364"></a><span id="l110.364" class="difflineplus">+      Assert.report(</span>
<a href="#l110.365"></a><span id="l110.365" class="difflineplus">+        true,</span>
<a href="#l110.366"></a><span id="l110.366" class="difflineplus">+        undefined,</span>
<a href="#l110.367"></a><span id="l110.367" class="difflineplus">+        undefined,</span>
<a href="#l110.368"></a><span id="l110.368" class="difflineplus">+        `Unable to find private data in flavor &quot;${flavor}&quot;`</span>
<a href="#l110.369"></a><span id="l110.369" class="difflineplus">+      );</span>
<a href="#l110.370"></a><span id="l110.370">     }</span>
<a href="#l110.371"></a><span id="l110.371"> </span>
<a href="#l110.372"></a><span id="l110.372">     // Check that the warning text is in the output.</span>
<a href="#l110.373"></a><span id="l110.373">     if (!check_text_in_body(contentBody, warningText.get(flavor))) {</span>
<a href="#l110.374"></a><span id="l110.374" class="difflineminus">-      mark_failure(['Unable to find warning text in flavor &quot;' + flavor + '&quot;']);</span>
<a href="#l110.375"></a><span id="l110.375" class="difflineplus">+      Assert.report(</span>
<a href="#l110.376"></a><span id="l110.376" class="difflineplus">+        true,</span>
<a href="#l110.377"></a><span id="l110.377" class="difflineplus">+        undefined,</span>
<a href="#l110.378"></a><span id="l110.378" class="difflineplus">+        undefined,</span>
<a href="#l110.379"></a><span id="l110.379" class="difflineplus">+        `Unable to find warning text in flavor &quot;${flavor}&quot;`</span>
<a href="#l110.380"></a><span id="l110.380" class="difflineplus">+      );</span>
<a href="#l110.381"></a><span id="l110.381">     }</span>
<a href="#l110.382"></a><span id="l110.382">   }</span>
<a href="#l110.383"></a><span id="l110.383">   close_tab(tab);</span>
<a href="#l110.384"></a><span id="l110.384" class="difflineminus">-}</span>
<a href="#l110.385"></a><span id="l110.385" class="difflineplus">+});</span>
<a href="#l110.386"></a><span id="l110.386"> </span>
<a href="#l110.387"></a><span id="l110.387"> /**</span>
<a href="#l110.388"></a><span id="l110.388">  * Test opening the compose window with public data.</span>
<a href="#l110.389"></a><span id="l110.389">  */</span>
<a href="#l110.390"></a><span id="l110.390" class="difflineminus">-function test_send_via_email_public() {</span>
<a href="#l110.391"></a><span id="l110.391" class="difflineplus">+add_task(function test_send_via_email_public() {</span>
<a href="#l110.392"></a><span id="l110.392">   let tab = open_about_support();</span>
<a href="#l110.393"></a><span id="l110.393">   let privateElem = find_private_element(tab);</span>
<a href="#l110.394"></a><span id="l110.394"> </span>
<a href="#l110.395"></a><span id="l110.395">   let cwc = open_send_via_email(tab);</span>
<a href="#l110.396"></a><span id="l110.396"> </span>
<a href="#l110.397"></a><span id="l110.397">   let contentBody = cwc.e(&quot;content-frame&quot;).contentDocument.body;</span>
<a href="#l110.398"></a><span id="l110.398"> </span>
<a href="#l110.399"></a><span id="l110.399">   for (let str of ABOUT_SUPPORT_STRINGS) {</span>
<a href="#l110.400"></a><span id="l110.400">     if (!check_text_in_body(contentBody, str)) {</span>
<a href="#l110.401"></a><span id="l110.401" class="difflineminus">-      mark_failure(['Unable to find &quot;' + str + '&quot; in compose window']);</span>
<a href="#l110.402"></a><span id="l110.402" class="difflineplus">+      Assert.report(</span>
<a href="#l110.403"></a><span id="l110.403" class="difflineplus">+        true,</span>
<a href="#l110.404"></a><span id="l110.404" class="difflineplus">+        undefined,</span>
<a href="#l110.405"></a><span id="l110.405" class="difflineplus">+        undefined,</span>
<a href="#l110.406"></a><span id="l110.406" class="difflineplus">+        `Unable to find &quot;${str}&quot; in compose window`</span>
<a href="#l110.407"></a><span id="l110.407" class="difflineplus">+      );</span>
<a href="#l110.408"></a><span id="l110.408">     }</span>
<a href="#l110.409"></a><span id="l110.409">   }</span>
<a href="#l110.410"></a><span id="l110.410"> </span>
<a href="#l110.411"></a><span id="l110.411">   for (let str of ABOUT_SUPPORT_ERROR_STRINGS.get(&quot;text/html&quot;)) {</span>
<a href="#l110.412"></a><span id="l110.412">     if (check_text_in_body(contentBody, str)) {</span>
<a href="#l110.413"></a><span id="l110.413" class="difflineminus">-      mark_failure(['Found &quot;' + str + '&quot; in compose window']);</span>
<a href="#l110.414"></a><span id="l110.414" class="difflineplus">+      Assert.report(</span>
<a href="#l110.415"></a><span id="l110.415" class="difflineplus">+        true,</span>
<a href="#l110.416"></a><span id="l110.416" class="difflineplus">+        undefined,</span>
<a href="#l110.417"></a><span id="l110.417" class="difflineplus">+        undefined,</span>
<a href="#l110.418"></a><span id="l110.418" class="difflineplus">+        `Found &quot;${str}&quot; in compose window`</span>
<a href="#l110.419"></a><span id="l110.419" class="difflineplus">+      );</span>
<a href="#l110.420"></a><span id="l110.420">     }</span>
<a href="#l110.421"></a><span id="l110.421">   }</span>
<a href="#l110.422"></a><span id="l110.422"> </span>
<a href="#l110.423"></a><span id="l110.423">   // Check that private data isn't in the output.</span>
<a href="#l110.424"></a><span id="l110.424">   if (check_text_in_body(contentBody, privateElem.textContent)) {</span>
<a href="#l110.425"></a><span id="l110.425" class="difflineminus">-    mark_failure([&quot;Found private data in compose window&quot;]);</span>
<a href="#l110.426"></a><span id="l110.426" class="difflineplus">+    Assert.report(</span>
<a href="#l110.427"></a><span id="l110.427" class="difflineplus">+      true,</span>
<a href="#l110.428"></a><span id="l110.428" class="difflineplus">+      undefined,</span>
<a href="#l110.429"></a><span id="l110.429" class="difflineplus">+      undefined,</span>
<a href="#l110.430"></a><span id="l110.430" class="difflineplus">+      `Found private data in compose window`</span>
<a href="#l110.431"></a><span id="l110.431" class="difflineplus">+    );</span>
<a href="#l110.432"></a><span id="l110.432">   }</span>
<a href="#l110.433"></a><span id="l110.433"> </span>
<a href="#l110.434"></a><span id="l110.434">   close_compose_window(cwc);</span>
<a href="#l110.435"></a><span id="l110.435">   close_tab(tab);</span>
<a href="#l110.436"></a><span id="l110.436" class="difflineminus">-}</span>
<a href="#l110.437"></a><span id="l110.437" class="difflineplus">+});</span>
<a href="#l110.438"></a><span id="l110.438"> </span>
<a href="#l110.439"></a><span id="l110.439"> /**</span>
<a href="#l110.440"></a><span id="l110.440">  * Test opening the compose window with private data.</span>
<a href="#l110.441"></a><span id="l110.441">  */</span>
<a href="#l110.442"></a><span id="l110.442" class="difflineminus">-function test_send_via_email_private() {</span>
<a href="#l110.443"></a><span id="l110.443" class="difflineplus">+add_task(function test_send_via_email_private() {</span>
<a href="#l110.444"></a><span id="l110.444">   let tab = open_about_support();</span>
<a href="#l110.445"></a><span id="l110.445"> </span>
<a href="#l110.446"></a><span id="l110.446">   // Display private data.</span>
<a href="#l110.447"></a><span id="l110.447">   let privateElem = find_private_element(tab);</span>
<a href="#l110.448"></a><span id="l110.448">   mc.click(content_tab_eid(tab, &quot;check-show-private-data&quot;));</span>
<a href="#l110.449"></a><span id="l110.449">   wait_for_content_tab_element_display(tab, privateElem);</span>
<a href="#l110.450"></a><span id="l110.450"> </span>
<a href="#l110.451"></a><span id="l110.451">   let cwc = open_send_via_email(tab);</span>
<a href="#l110.452"></a><span id="l110.452"> </span>
<a href="#l110.453"></a><span id="l110.453">   let contentBody = cwc.e(&quot;content-frame&quot;).contentDocument.body;</span>
<a href="#l110.454"></a><span id="l110.454"> </span>
<a href="#l110.455"></a><span id="l110.455">   for (let str of ABOUT_SUPPORT_STRINGS) {</span>
<a href="#l110.456"></a><span id="l110.456">     if (!check_text_in_body(contentBody, str)) {</span>
<a href="#l110.457"></a><span id="l110.457" class="difflineminus">-      mark_failure(['Unable to find &quot;' + str + '&quot; in compose window']);</span>
<a href="#l110.458"></a><span id="l110.458" class="difflineplus">+      Assert.report(</span>
<a href="#l110.459"></a><span id="l110.459" class="difflineplus">+        true,</span>
<a href="#l110.460"></a><span id="l110.460" class="difflineplus">+        undefined,</span>
<a href="#l110.461"></a><span id="l110.461" class="difflineplus">+        undefined,</span>
<a href="#l110.462"></a><span id="l110.462" class="difflineplus">+        `Unable to find &quot;${str}&quot; in compose window`</span>
<a href="#l110.463"></a><span id="l110.463" class="difflineplus">+      );</span>
<a href="#l110.464"></a><span id="l110.464">     }</span>
<a href="#l110.465"></a><span id="l110.465">   }</span>
<a href="#l110.466"></a><span id="l110.466"> </span>
<a href="#l110.467"></a><span id="l110.467">   for (let str of ABOUT_SUPPORT_ERROR_STRINGS.get(&quot;text/html&quot;)) {</span>
<a href="#l110.468"></a><span id="l110.468">     if (check_text_in_body(contentBody, str)) {</span>
<a href="#l110.469"></a><span id="l110.469" class="difflineminus">-      mark_failure(['Found &quot;' + str + '&quot; in compose window']);</span>
<a href="#l110.470"></a><span id="l110.470" class="difflineplus">+      Assert.report(</span>
<a href="#l110.471"></a><span id="l110.471" class="difflineplus">+        true,</span>
<a href="#l110.472"></a><span id="l110.472" class="difflineplus">+        undefined,</span>
<a href="#l110.473"></a><span id="l110.473" class="difflineplus">+        undefined,</span>
<a href="#l110.474"></a><span id="l110.474" class="difflineplus">+        `Found &quot;${str}&quot; in compose window`</span>
<a href="#l110.475"></a><span id="l110.475" class="difflineplus">+      );</span>
<a href="#l110.476"></a><span id="l110.476">     }</span>
<a href="#l110.477"></a><span id="l110.477">   }</span>
<a href="#l110.478"></a><span id="l110.478"> </span>
<a href="#l110.479"></a><span id="l110.479">   // Check that private data is in the output.</span>
<a href="#l110.480"></a><span id="l110.480">   if (!check_text_in_body(contentBody, privateElem.textContent)) {</span>
<a href="#l110.481"></a><span id="l110.481" class="difflineminus">-    mark_failure([&quot;Unable to find private data in compose window&quot;]);</span>
<a href="#l110.482"></a><span id="l110.482" class="difflineplus">+    Assert.report(</span>
<a href="#l110.483"></a><span id="l110.483" class="difflineplus">+      true,</span>
<a href="#l110.484"></a><span id="l110.484" class="difflineplus">+      undefined,</span>
<a href="#l110.485"></a><span id="l110.485" class="difflineplus">+      undefined,</span>
<a href="#l110.486"></a><span id="l110.486" class="difflineplus">+      &quot;Unable to find private data in compose window&quot;</span>
<a href="#l110.487"></a><span id="l110.487" class="difflineplus">+    );</span>
<a href="#l110.488"></a><span id="l110.488">   }</span>
<a href="#l110.489"></a><span id="l110.489"> </span>
<a href="#l110.490"></a><span id="l110.490">   // Check that the warning text is in the output.</span>
<a href="#l110.491"></a><span id="l110.491">   if (!check_text_in_body(contentBody, warningText.get(&quot;text/html&quot;))) {</span>
<a href="#l110.492"></a><span id="l110.492" class="difflineminus">-    mark_failure([&quot;Unable to find warning text in compose window&quot;]);</span>
<a href="#l110.493"></a><span id="l110.493" class="difflineplus">+    Assert.report(</span>
<a href="#l110.494"></a><span id="l110.494" class="difflineplus">+      true,</span>
<a href="#l110.495"></a><span id="l110.495" class="difflineplus">+      undefined,</span>
<a href="#l110.496"></a><span id="l110.496" class="difflineplus">+      undefined,</span>
<a href="#l110.497"></a><span id="l110.497" class="difflineplus">+      &quot;Unable to find warning text in compose window&quot;</span>
<a href="#l110.498"></a><span id="l110.498" class="difflineplus">+    );</span>
<a href="#l110.499"></a><span id="l110.499">   }</span>
<a href="#l110.500"></a><span id="l110.500"> </span>
<a href="#l110.501"></a><span id="l110.501">   close_compose_window(cwc);</span>
<a href="#l110.502"></a><span id="l110.502">   close_tab(tab);</span>
<a href="#l110.503"></a><span id="l110.503" class="difflineminus">-}</span>
<a href="#l110.504"></a><span id="l110.504" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l111.1"></a><span id="l111.1">copy from mail/test/mozmill/content-tabs/test-addons-mgr.js</span>
<a href="#l111.2"></a><span id="l111.2">copy to mail/test/browser/content-tabs/browser_addonsMgr.js</span>
<a href="#l111.3"></a><span id="l111.3" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-addons-mgr.js</span>
<a href="#l111.4"></a><span id="l111.4" class="difflineplus">+++ b/mail/test/browser/content-tabs/browser_addonsMgr.js</span>
<a href="#l111.5"></a><span id="l111.5" class="difflineat">@@ -1,52 +1,52 @@</span>
<a href="#l111.6"></a><span id="l111.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l111.7"></a><span id="l111.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l111.8"></a><span id="l111.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l111.9"></a><span id="l111.9"> </span>
<a href="#l111.10"></a><span id="l111.10"> &quot;use strict&quot;;</span>
<a href="#l111.11"></a><span id="l111.11"> </span>
<a href="#l111.12"></a><span id="l111.12"> var elib = ChromeUtils.import(</span>
<a href="#l111.13"></a><span id="l111.13" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l111.14"></a><span id="l111.14" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l111.15"></a><span id="l111.15"> );</span>
<a href="#l111.16"></a><span id="l111.16"> </span>
<a href="#l111.17"></a><span id="l111.17"> var { content_tab_e, wait_for_content_tab_load } = ChromeUtils.import(</span>
<a href="#l111.18"></a><span id="l111.18">   &quot;resource://testing-common/mozmill/ContentTabHelpers.jsm&quot;</span>
<a href="#l111.19"></a><span id="l111.19"> );</span>
<a href="#l111.20"></a><span id="l111.20" class="difflineminus">-var { assert_true, mc } = ChromeUtils.import(</span>
<a href="#l111.21"></a><span id="l111.21" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l111.22"></a><span id="l111.22">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l111.23"></a><span id="l111.23"> );</span>
<a href="#l111.24"></a><span id="l111.24"> var {</span>
<a href="#l111.25"></a><span id="l111.25">   plan_for_modal_dialog,</span>
<a href="#l111.26"></a><span id="l111.26">   wait_for_modal_dialog,</span>
<a href="#l111.27"></a><span id="l111.27">   wait_for_window_close,</span>
<a href="#l111.28"></a><span id="l111.28"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;);</span>
<a href="#l111.29"></a><span id="l111.29"> </span>
<a href="#l111.30"></a><span id="l111.30" class="difflineminus">-function test_open_addons_with_url() {</span>
<a href="#l111.31"></a><span id="l111.31" class="difflineplus">+add_task(function test_open_addons_with_url() {</span>
<a href="#l111.32"></a><span id="l111.32">   mc.window.openAddonsMgr(&quot;addons://list/theme&quot;);</span>
<a href="#l111.33"></a><span id="l111.33">   mc.sleep(0);</span>
<a href="#l111.34"></a><span id="l111.34"> </span>
<a href="#l111.35"></a><span id="l111.35">   let tab = mc.tabmail.currentTabInfo;</span>
<a href="#l111.36"></a><span id="l111.36">   wait_for_content_tab_load(tab, &quot;about:addons&quot;, 10000);</span>
<a href="#l111.37"></a><span id="l111.37" class="difflineminus">-  assert_true(</span>
<a href="#l111.38"></a><span id="l111.38" class="difflineplus">+  Assert.ok(</span>
<a href="#l111.39"></a><span id="l111.39">     content_tab_e(tab, &quot;category-theme&quot;).selected,</span>
<a href="#l111.40"></a><span id="l111.40">     &quot;Themes category should be selected!&quot;</span>
<a href="#l111.41"></a><span id="l111.41">   );</span>
<a href="#l111.42"></a><span id="l111.42"> </span>
<a href="#l111.43"></a><span id="l111.43">   mc.tabmail.switchToTab(0); // switch to 3pane</span>
<a href="#l111.44"></a><span id="l111.44">   mc.tabmail.closeTab(tab);</span>
<a href="#l111.45"></a><span id="l111.45" class="difflineminus">-}</span>
<a href="#l111.46"></a><span id="l111.46" class="difflineplus">+});</span>
<a href="#l111.47"></a><span id="l111.47"> </span>
<a href="#l111.48"></a><span id="l111.48"> /**</span>
<a href="#l111.49"></a><span id="l111.49">  * Bug 1462923</span>
<a href="#l111.50"></a><span id="l111.50">  * Check if the &quot;Tools-&gt;Add-on Options&quot; menu item works and shows our add-on.</span>
<a href="#l111.51"></a><span id="l111.51">  * This relies on the MozMill extension having optionsURL defined in install.rdf,</span>
<a href="#l111.52"></a><span id="l111.52">  * however simplistic the preferences XUL document may be.</span>
<a href="#l111.53"></a><span id="l111.53">  */</span>
<a href="#l111.54"></a><span id="l111.54" class="difflineminus">-function test_addon_prefs() {</span>
<a href="#l111.55"></a><span id="l111.55" class="difflineplus">+add_task(function test_addon_prefs() {</span>
<a href="#l111.56"></a><span id="l111.56">   // Open Add-on Options.</span>
<a href="#l111.57"></a><span id="l111.57">   const subview = mc.click_through_appmenu([{ id: &quot;appmenu_addons&quot; }]);</span>
<a href="#l111.58"></a><span id="l111.58"> </span>
<a href="#l111.59"></a><span id="l111.59">   plan_for_modal_dialog(&quot;mozmill-prefs&quot;, function(controller) {</span>
<a href="#l111.60"></a><span id="l111.60">     // Add |mc.sleep(1000);| here to see the popup dialog.</span>
<a href="#l111.61"></a><span id="l111.61">     controller.window.close();</span>
<a href="#l111.62"></a><span id="l111.62">   });</span>
<a href="#l111.63"></a><span id="l111.63"> </span>
<a href="#l111.64"></a><span id="l111.64" class="difflineat">@@ -58,14 +58,14 @@ function test_addon_prefs() {</span>
<a href="#l111.65"></a><span id="l111.65">       item.getAttribute(&quot;collapsed&quot;) != &quot;true&quot; &amp;&amp;</span>
<a href="#l111.66"></a><span id="l111.66">       item.label == &quot;MozMill&quot;</span>
<a href="#l111.67"></a><span id="l111.67">     ) {</span>
<a href="#l111.68"></a><span id="l111.68">       foundAddon = true;</span>
<a href="#l111.69"></a><span id="l111.69">       mc.click(new elib.Elem(item));</span>
<a href="#l111.70"></a><span id="l111.70">       break;</span>
<a href="#l111.71"></a><span id="l111.71">     }</span>
<a href="#l111.72"></a><span id="l111.72">   }</span>
<a href="#l111.73"></a><span id="l111.73" class="difflineminus">-  assert_true(foundAddon);</span>
<a href="#l111.74"></a><span id="l111.74" class="difflineplus">+  Assert.ok(foundAddon);</span>
<a href="#l111.75"></a><span id="l111.75"> </span>
<a href="#l111.76"></a><span id="l111.76">   // Wait for the options dialog to open and close.</span>
<a href="#l111.77"></a><span id="l111.77">   wait_for_modal_dialog();</span>
<a href="#l111.78"></a><span id="l111.78">   wait_for_window_close();</span>
<a href="#l111.79"></a><span id="l111.79" class="difflineminus">-}</span>
<a href="#l111.80"></a><span id="l111.80" class="difflineplus">+}).skip();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l112.1"></a><span id="l112.1">copy from mail/test/mozmill/content-tabs/test-content-tab.js</span>
<a href="#l112.2"></a><span id="l112.2">copy to mail/test/browser/content-tabs/browser_contentTab.js</span>
<a href="#l112.3"></a><span id="l112.3" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-content-tab.js</span>
<a href="#l112.4"></a><span id="l112.4" class="difflineplus">+++ b/mail/test/browser/content-tabs/browser_contentTab.js</span>
<a href="#l112.5"></a><span id="l112.5" class="difflineat">@@ -1,83 +1,77 @@</span>
<a href="#l112.6"></a><span id="l112.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l112.7"></a><span id="l112.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l112.8"></a><span id="l112.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l112.9"></a><span id="l112.9"> </span>
<a href="#l112.10"></a><span id="l112.10"> &quot;use strict&quot;;</span>
<a href="#l112.11"></a><span id="l112.11"> </span>
<a href="#l112.12"></a><span id="l112.12"> var controller = ChromeUtils.import(</span>
<a href="#l112.13"></a><span id="l112.13" class="difflineminus">-  &quot;chrome://mozmill/content/modules/controller.jsm&quot;</span>
<a href="#l112.14"></a><span id="l112.14" class="difflineplus">+  &quot;resource://testing-common/mozmill/controller.jsm&quot;</span>
<a href="#l112.15"></a><span id="l112.15"> );</span>
<a href="#l112.16"></a><span id="l112.16"> var elementslib = ChromeUtils.import(</span>
<a href="#l112.17"></a><span id="l112.17" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l112.18"></a><span id="l112.18" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l112.19"></a><span id="l112.19"> );</span>
<a href="#l112.20"></a><span id="l112.20"> var EventUtils = ChromeUtils.import(</span>
<a href="#l112.21"></a><span id="l112.21" class="difflineminus">-  &quot;chrome://mozmill/content/stdlib/EventUtils.jsm&quot;</span>
<a href="#l112.22"></a><span id="l112.22" class="difflineplus">+  &quot;resource://testing-common/mozmill/EventUtils.jsm&quot;</span>
<a href="#l112.23"></a><span id="l112.23"> );</span>
<a href="#l112.24"></a><span id="l112.24"> var mozmill = ChromeUtils.import(</span>
<a href="#l112.25"></a><span id="l112.25" class="difflineminus">-  &quot;chrome://mozmill/content/modules/mozmill.jsm&quot;</span>
<a href="#l112.26"></a><span id="l112.26" class="difflineplus">+  &quot;resource://testing-common/mozmill/mozmill.jsm&quot;</span>
<a href="#l112.27"></a><span id="l112.27"> );</span>
<a href="#l112.28"></a><span id="l112.28"> </span>
<a href="#l112.29"></a><span id="l112.29"> var {</span>
<a href="#l112.30"></a><span id="l112.30">   assert_content_tab_has_favicon,</span>
<a href="#l112.31"></a><span id="l112.31">   open_content_tab_with_url,</span>
<a href="#l112.32"></a><span id="l112.32"> } = ChromeUtils.import(</span>
<a href="#l112.33"></a><span id="l112.33">   &quot;resource://testing-common/mozmill/ContentTabHelpers.jsm&quot;</span>
<a href="#l112.34"></a><span id="l112.34"> );</span>
<a href="#l112.35"></a><span id="l112.35"> var { assert_element_visible, assert_element_not_visible } = ChromeUtils.import(</span>
<a href="#l112.36"></a><span id="l112.36">   &quot;resource://testing-common/mozmill/DOMHelpers.jsm&quot;</span>
<a href="#l112.37"></a><span id="l112.37"> );</span>
<a href="#l112.38"></a><span id="l112.38"> </span>
<a href="#l112.39"></a><span id="l112.39"> var {</span>
<a href="#l112.40"></a><span id="l112.40" class="difflineminus">-  assert_equals,</span>
<a href="#l112.41"></a><span id="l112.41" class="difflineminus">-  assert_not_equals,</span>
<a href="#l112.42"></a><span id="l112.42">   assert_tab_has_title,</span>
<a href="#l112.43"></a><span id="l112.43" class="difflineminus">-  assert_true,</span>
<a href="#l112.44"></a><span id="l112.44">   close_popup,</span>
<a href="#l112.45"></a><span id="l112.45">   mc,</span>
<a href="#l112.46"></a><span id="l112.46">   wait_for_popup_to_open,</span>
<a href="#l112.47"></a><span id="l112.47"> } = ChromeUtils.import(</span>
<a href="#l112.48"></a><span id="l112.48">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l112.49"></a><span id="l112.49"> );</span>
<a href="#l112.50"></a><span id="l112.50"> var { plan_for_modal_dialog, wait_for_modal_dialog } = ChromeUtils.import(</span>
<a href="#l112.51"></a><span id="l112.51">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l112.52"></a><span id="l112.52"> );</span>
<a href="#l112.53"></a><span id="l112.53"> </span>
<a href="#l112.54"></a><span id="l112.54"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l112.55"></a><span id="l112.55"> </span>
<a href="#l112.56"></a><span id="l112.56" class="difflineminus">-// RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l112.57"></a><span id="l112.57" class="difflineminus">-// so we get the right path for the resources.</span>
<a href="#l112.58"></a><span id="l112.58" class="difflineminus">-// Note: this one adds to '' as we need to make sure that favicon.ico is in the</span>
<a href="#l112.59"></a><span id="l112.59" class="difflineminus">-// root directory.</span>
<a href="#l112.60"></a><span id="l112.60" class="difflineminus">-var url = collector.addHttpResource(&quot;../content-tabs/html&quot;, &quot;&quot;);</span>
<a href="#l112.61"></a><span id="l112.61" class="difflineplus">+var url =</span>
<a href="#l112.62"></a><span id="l112.62" class="difflineplus">+  &quot;http://mochi.test:8888/browser/comm/mail/test/browser/content-tabs/html/&quot;;</span>
<a href="#l112.63"></a><span id="l112.63"> var whatsUrl = url + &quot;whatsnew.html&quot;;</span>
<a href="#l112.64"></a><span id="l112.64"> </span>
<a href="#l112.65"></a><span id="l112.65" class="difflineminus">-function test_content_tab_open() {</span>
<a href="#l112.66"></a><span id="l112.66" class="difflineplus">+add_task(function test_content_tab_open() {</span>
<a href="#l112.67"></a><span id="l112.67">   let tab = open_content_tab_with_url(whatsUrl);</span>
<a href="#l112.68"></a><span id="l112.68"> </span>
<a href="#l112.69"></a><span id="l112.69">   assert_tab_has_title(tab, &quot;What's New Content Test&quot;);</span>
<a href="#l112.70"></a><span id="l112.70">   // Check the location of the what's new image, this is via the link element</span>
<a href="#l112.71"></a><span id="l112.71">   // and therefore should be set and not favicon.png.</span>
<a href="#l112.72"></a><span id="l112.72">   assert_content_tab_has_favicon(tab, url + &quot;whatsnew.png&quot;);</span>
<a href="#l112.73"></a><span id="l112.73"> </span>
<a href="#l112.74"></a><span id="l112.74">   // Check that window.content is set up correctly wrt content-primary and</span>
<a href="#l112.75"></a><span id="l112.75">   // content-targetable.</span>
<a href="#l112.76"></a><span id="l112.76">   if (mc.window.content.location != whatsUrl) {</span>
<a href="#l112.77"></a><span id="l112.77">     throw new Error(</span>
<a href="#l112.78"></a><span id="l112.78">       'window.content is not set to the url loaded, incorrect type=&quot;...&quot;?'</span>
<a href="#l112.79"></a><span id="l112.79">     );</span>
<a href="#l112.80"></a><span id="l112.80">   }</span>
<a href="#l112.81"></a><span id="l112.81" class="difflineminus">-}</span>
<a href="#l112.82"></a><span id="l112.82" class="difflineplus">+});</span>
<a href="#l112.83"></a><span id="l112.83"> </span>
<a href="#l112.84"></a><span id="l112.84"> /**</span>
<a href="#l112.85"></a><span id="l112.85">  * Just make sure that the context menu does what we expect in content tabs wrt.</span>
<a href="#l112.86"></a><span id="l112.86">  * spell checking options.</span>
<a href="#l112.87"></a><span id="l112.87">  */</span>
<a href="#l112.88"></a><span id="l112.88" class="difflineminus">-function test_spellcheck_in_content_tabs() {</span>
<a href="#l112.89"></a><span id="l112.89" class="difflineplus">+add_task(function test_spellcheck_in_content_tabs() {</span>
<a href="#l112.90"></a><span id="l112.90">   let tabmail = mc.tabmail;</span>
<a href="#l112.91"></a><span id="l112.91">   let w = tabmail.selectedTab.browser.contentWindow;</span>
<a href="#l112.92"></a><span id="l112.92">   let textarea = w.document.querySelector(&quot;textarea&quot;);</span>
<a href="#l112.93"></a><span id="l112.93">   let eidMailContext = mc.eid(&quot;mailContext&quot;);</span>
<a href="#l112.94"></a><span id="l112.94"> </span>
<a href="#l112.95"></a><span id="l112.95">   // Test a few random items</span>
<a href="#l112.96"></a><span id="l112.96">   mc.click(new elementslib.Elem(textarea));</span>
<a href="#l112.97"></a><span id="l112.97">   // Bug 364914 causes textareas to not be spell checked until they have been</span>
<a href="#l112.98"></a><span id="l112.98" class="difflineat">@@ -106,119 +100,116 @@ function test_spellcheck_in_content_tabs</span>
<a href="#l112.99"></a><span id="l112.99">     5,</span>
<a href="#l112.100"></a><span id="l112.100">     { type: &quot;contextmenu&quot;, button: 2 },</span>
<a href="#l112.101"></a><span id="l112.101">     w</span>
<a href="#l112.102"></a><span id="l112.102">   );</span>
<a href="#l112.103"></a><span id="l112.103">   wait_for_popup_to_open(eidMailContext.getNode());</span>
<a href="#l112.104"></a><span id="l112.104">   let suggestions = mc.window.document.getElementsByClassName(</span>
<a href="#l112.105"></a><span id="l112.105">     &quot;spell-suggestion&quot;</span>
<a href="#l112.106"></a><span id="l112.106">   );</span>
<a href="#l112.107"></a><span id="l112.107" class="difflineminus">-  assert_true(</span>
<a href="#l112.108"></a><span id="l112.108" class="difflineminus">-    suggestions.length &gt; 0,</span>
<a href="#l112.109"></a><span id="l112.109" class="difflineminus">-    &quot;What, is zombocom a registered word now?&quot;</span>
<a href="#l112.110"></a><span id="l112.110" class="difflineminus">-  );</span>
<a href="#l112.111"></a><span id="l112.111" class="difflineplus">+  Assert.ok(suggestions.length &gt; 0, &quot;What, is zombocom a registered word now?&quot;);</span>
<a href="#l112.112"></a><span id="l112.112">   mc.click(mc.eid(&quot;mailContext-spell-add-to-dictionary&quot;));</span>
<a href="#l112.113"></a><span id="l112.113">   close_popup(mc, eidMailContext);</span>
<a href="#l112.114"></a><span id="l112.114"> </span>
<a href="#l112.115"></a><span id="l112.115">   // Now check we don't have any suggestionss</span>
<a href="#l112.116"></a><span id="l112.116">   EventUtils.synthesizeMouse(</span>
<a href="#l112.117"></a><span id="l112.117">     textarea,</span>
<a href="#l112.118"></a><span id="l112.118">     5,</span>
<a href="#l112.119"></a><span id="l112.119">     5,</span>
<a href="#l112.120"></a><span id="l112.120">     { type: &quot;contextmenu&quot;, button: 2 },</span>
<a href="#l112.121"></a><span id="l112.121">     w</span>
<a href="#l112.122"></a><span id="l112.122">   );</span>
<a href="#l112.123"></a><span id="l112.123">   wait_for_popup_to_open(eidMailContext.getNode());</span>
<a href="#l112.124"></a><span id="l112.124">   suggestions = mc.window.document.getElementsByClassName(&quot;spell-suggestion&quot;);</span>
<a href="#l112.125"></a><span id="l112.125" class="difflineminus">-  assert_true(suggestions.length == 0, &quot;But I just taught you this word!&quot;);</span>
<a href="#l112.126"></a><span id="l112.126" class="difflineplus">+  Assert.ok(suggestions.length == 0, &quot;But I just taught you this word!&quot;);</span>
<a href="#l112.127"></a><span id="l112.127">   close_popup(mc, eidMailContext);</span>
<a href="#l112.128"></a><span id="l112.128" class="difflineminus">-}</span>
<a href="#l112.129"></a><span id="l112.129" class="difflineplus">+});</span>
<a href="#l112.130"></a><span id="l112.130"> </span>
<a href="#l112.131"></a><span id="l112.131" class="difflineminus">-function test_content_tab_context_menu() {</span>
<a href="#l112.132"></a><span id="l112.132" class="difflineplus">+add_task(function test_content_tab_context_menu() {</span>
<a href="#l112.133"></a><span id="l112.133">   let tabmail = mc.tabmail;</span>
<a href="#l112.134"></a><span id="l112.134">   let w = tabmail.selectedTab.browser.contentWindow;</span>
<a href="#l112.135"></a><span id="l112.135">   let heading = w.document.querySelector(&quot;h1&quot;);</span>
<a href="#l112.136"></a><span id="l112.136">   let mailContext = mc.e(&quot;mailContext&quot;);</span>
<a href="#l112.137"></a><span id="l112.137"> </span>
<a href="#l112.138"></a><span id="l112.138">   // Make sure the page's menu items are added on right-click.</span>
<a href="#l112.139"></a><span id="l112.139">   EventUtils.synthesizeMouse(</span>
<a href="#l112.140"></a><span id="l112.140">     heading,</span>
<a href="#l112.141"></a><span id="l112.141">     5,</span>
<a href="#l112.142"></a><span id="l112.142">     5,</span>
<a href="#l112.143"></a><span id="l112.143">     { type: &quot;contextmenu&quot;, button: 2 },</span>
<a href="#l112.144"></a><span id="l112.144">     w</span>
<a href="#l112.145"></a><span id="l112.145">   );</span>
<a href="#l112.146"></a><span id="l112.146">   wait_for_popup_to_open(mailContext);</span>
<a href="#l112.147"></a><span id="l112.147" class="difflineminus">-  assert_equals(mailContext.firstElementChild.label, &quot;Click me!&quot;);</span>
<a href="#l112.148"></a><span id="l112.148" class="difflineplus">+  Assert.equal(mailContext.firstElementChild.label, &quot;Click me!&quot;);</span>
<a href="#l112.149"></a><span id="l112.149">   assert_element_visible(&quot;page-menu-separator&quot;);</span>
<a href="#l112.150"></a><span id="l112.150">   close_popup(mc, new elementslib.Elem(mailContext));</span>
<a href="#l112.151"></a><span id="l112.151"> </span>
<a href="#l112.152"></a><span id="l112.152">   // Make sure the page's menu items are *not* added on shift-right-click.</span>
<a href="#l112.153"></a><span id="l112.153">   EventUtils.synthesizeMouse(</span>
<a href="#l112.154"></a><span id="l112.154">     heading,</span>
<a href="#l112.155"></a><span id="l112.155">     5,</span>
<a href="#l112.156"></a><span id="l112.156">     5,</span>
<a href="#l112.157"></a><span id="l112.157">     { type: &quot;contextmenu&quot;, button: 2, shiftKey: true },</span>
<a href="#l112.158"></a><span id="l112.158">     w</span>
<a href="#l112.159"></a><span id="l112.159">   );</span>
<a href="#l112.160"></a><span id="l112.160">   wait_for_popup_to_open(mailContext);</span>
<a href="#l112.161"></a><span id="l112.161" class="difflineminus">-  assert_not_equals(mailContext.firstElementChild.label, &quot;Click me!&quot;);</span>
<a href="#l112.162"></a><span id="l112.162" class="difflineplus">+  Assert.notEqual(mailContext.firstElementChild.label, &quot;Click me!&quot;);</span>
<a href="#l112.163"></a><span id="l112.163">   assert_element_not_visible(&quot;page-menu-separator&quot;);</span>
<a href="#l112.164"></a><span id="l112.164">   close_popup(mc, new elementslib.Elem(mailContext));</span>
<a href="#l112.165"></a><span id="l112.165" class="difflineminus">-}</span>
<a href="#l112.166"></a><span id="l112.166" class="difflineplus">+});</span>
<a href="#l112.167"></a><span id="l112.167"> </span>
<a href="#l112.168"></a><span id="l112.168"> /*</span>
<a href="#l112.169"></a><span id="l112.169">  // We don't have an UI to test opening content tabs twice anymore.</span>
<a href="#l112.170"></a><span id="l112.170" class="difflineminus">-function test_content_tab_open_same() {</span>
<a href="#l112.171"></a><span id="l112.171" class="difflineplus">+add_task(function test_content_tab_open_same() {</span>
<a href="#l112.172"></a><span id="l112.172">   let preCount = mc.tabmail.tabContainer.allTabs.length;</span>
<a href="#l112.173"></a><span id="l112.173"> </span>
<a href="#l112.174"></a><span id="l112.174">   mc.click(new elementslib.Elem(mc.menus.helpMenu.whatsNew));</span>
<a href="#l112.175"></a><span id="l112.175"> </span>
<a href="#l112.176"></a><span id="l112.176">   controller.sleep(0);</span>
<a href="#l112.177"></a><span id="l112.177"> </span>
<a href="#l112.178"></a><span id="l112.178">   if (mc.tabmail.tabContainer.allTabs.length != preCount)</span>
<a href="#l112.179"></a><span id="l112.179">     throw new Error(&quot;A new content tab was opened when it shouldn't have been&quot;);</span>
<a href="#l112.180"></a><span id="l112.180"> </span>
<a href="#l112.181"></a><span id="l112.181">   // Double-check browser is still the same.</span>
<a href="#l112.182"></a><span id="l112.182">   if (mc.window.content.location != whatsUrl)</span>
<a href="#l112.183"></a><span id="l112.183">     throw new Error(&quot;window.content is not set to the url loaded, incorrect type=\&quot;...\&quot;?&quot;);</span>
<a href="#l112.184"></a><span id="l112.184" class="difflineminus">-}</span>
<a href="#l112.185"></a><span id="l112.185" class="difflineplus">+});</span>
<a href="#l112.186"></a><span id="l112.186"> */</span>
<a href="#l112.187"></a><span id="l112.187"> </span>
<a href="#l112.188"></a><span id="l112.188" class="difflineminus">-function test_content_tab_default_favicon() {</span>
<a href="#l112.189"></a><span id="l112.189" class="difflineplus">+add_task(function test_content_tab_default_favicon() {</span>
<a href="#l112.190"></a><span id="l112.190">   const whatsUrl2 = url + &quot;whatsnew1.html&quot;;</span>
<a href="#l112.191"></a><span id="l112.191">   let tab = open_content_tab_with_url(whatsUrl2);</span>
<a href="#l112.192"></a><span id="l112.192"> </span>
<a href="#l112.193"></a><span id="l112.193">   assert_tab_has_title(tab, &quot;What's New Content Test 1&quot;);</span>
<a href="#l112.194"></a><span id="l112.194">   // Check the location of the favicon, this should be the site favicon in this</span>
<a href="#l112.195"></a><span id="l112.195">   // test.</span>
<a href="#l112.196"></a><span id="l112.196" class="difflineminus">-  assert_content_tab_has_favicon(tab, url + &quot;favicon.ico&quot;);</span>
<a href="#l112.197"></a><span id="l112.197" class="difflineminus">-}</span>
<a href="#l112.198"></a><span id="l112.198" class="difflineplus">+  assert_content_tab_has_favicon(tab, &quot;http://mochi.test:8888/favicon.ico&quot;);</span>
<a href="#l112.199"></a><span id="l112.199" class="difflineplus">+});</span>
<a href="#l112.200"></a><span id="l112.200"> </span>
<a href="#l112.201"></a><span id="l112.201" class="difflineminus">-function test_content_tab_onbeforeunload() {</span>
<a href="#l112.202"></a><span id="l112.202" class="difflineplus">+add_task(function test_content_tab_onbeforeunload() {</span>
<a href="#l112.203"></a><span id="l112.203">   let count = mc.tabmail.tabContainer.allTabs.length;</span>
<a href="#l112.204"></a><span id="l112.204">   let tab = mc.tabmail.tabInfo[count - 1];</span>
<a href="#l112.205"></a><span id="l112.205">   tab.browser.contentWindow.addEventListener(&quot;beforeunload&quot;, function(event) {</span>
<a href="#l112.206"></a><span id="l112.206">     event.returnValue = &quot;Green llama in your car&quot;;</span>
<a href="#l112.207"></a><span id="l112.207">   });</span>
<a href="#l112.208"></a><span id="l112.208"> </span>
<a href="#l112.209"></a><span id="l112.209">   const interactionPref = &quot;dom.require_user_interaction_for_beforeunload&quot;;</span>
<a href="#l112.210"></a><span id="l112.210">   Services.prefs.setBoolPref(interactionPref, false);</span>
<a href="#l112.211"></a><span id="l112.211"> </span>
<a href="#l112.212"></a><span id="l112.212">   plan_for_modal_dialog(&quot;commonDialog&quot;, function(controller) {</span>
<a href="#l112.213"></a><span id="l112.213">     controller.window.document.documentElement.getButton(&quot;accept&quot;).doCommand();</span>
<a href="#l112.214"></a><span id="l112.214">   });</span>
<a href="#l112.215"></a><span id="l112.215">   mc.tabmail.closeTab(tab);</span>
<a href="#l112.216"></a><span id="l112.216">   wait_for_modal_dialog();</span>
<a href="#l112.217"></a><span id="l112.217"> </span>
<a href="#l112.218"></a><span id="l112.218">   Services.prefs.clearUserPref(interactionPref);</span>
<a href="#l112.219"></a><span id="l112.219" class="difflineminus">-}</span>
<a href="#l112.220"></a><span id="l112.220" class="difflineplus">+});</span>
<a href="#l112.221"></a><span id="l112.221"> </span>
<a href="#l112.222"></a><span id="l112.222"> // XXX todo</span>
<a href="#l112.223"></a><span id="l112.223"> // - test find bar</span>
<a href="#l112.224"></a><span id="l112.224"> // - window.close within tab</span>
<a href="#l112.225"></a><span id="l112.225"> // - zoom?</span>
<a href="#l112.226"></a><span id="l112.226"> </span>
<a href="#l112.227"></a><span id="l112.227" class="difflineminus">-function teardownModule() {</span>
<a href="#l112.228"></a><span id="l112.228" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l112.229"></a><span id="l112.229">   while (mc.tabmail.tabInfo.length &gt; 1) {</span>
<a href="#l112.230"></a><span id="l112.230">     mc.tabmail.closeTab(1);</span>
<a href="#l112.231"></a><span id="l112.231">   }</span>
<a href="#l112.232"></a><span id="l112.232" class="difflineminus">-}</span>
<a href="#l112.233"></a><span id="l112.233" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l113.1"></a><span id="l113.1">copy from mail/test/mozmill/content-tabs/test-install-xpi.js</span>
<a href="#l113.2"></a><span id="l113.2">copy to mail/test/browser/content-tabs/browser_installXpi.js</span>
<a href="#l113.3"></a><span id="l113.3" class="difflineminus">--- a/mail/test/mozmill/content-tabs/test-install-xpi.js</span>
<a href="#l113.4"></a><span id="l113.4" class="difflineplus">+++ b/mail/test/browser/content-tabs/browser_installXpi.js</span>
<a href="#l113.5"></a><span id="l113.5" class="difflineat">@@ -1,47 +1,46 @@</span>
<a href="#l113.6"></a><span id="l113.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l113.7"></a><span id="l113.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l113.8"></a><span id="l113.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l113.9"></a><span id="l113.9"> </span>
<a href="#l113.10"></a><span id="l113.10"> &quot;use strict&quot;;</span>
<a href="#l113.11"></a><span id="l113.11"> </span>
<a href="#l113.12"></a><span id="l113.12"> var controller = ChromeUtils.import(</span>
<a href="#l113.13"></a><span id="l113.13" class="difflineminus">-  &quot;chrome://mozmill/content/modules/controller.jsm&quot;</span>
<a href="#l113.14"></a><span id="l113.14" class="difflineplus">+  &quot;resource://testing-common/mozmill/controller.jsm&quot;</span>
<a href="#l113.15"></a><span id="l113.15"> );</span>
<a href="#l113.16"></a><span id="l113.16"> var elib = ChromeUtils.import(</span>
<a href="#l113.17"></a><span id="l113.17" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l113.18"></a><span id="l113.18" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l113.19"></a><span id="l113.19"> );</span>
<a href="#l113.20"></a><span id="l113.20"> var mozmill = ChromeUtils.import(</span>
<a href="#l113.21"></a><span id="l113.21" class="difflineminus">-  &quot;chrome://mozmill/content/modules/mozmill.jsm&quot;</span>
<a href="#l113.22"></a><span id="l113.22" class="difflineplus">+  &quot;resource://testing-common/mozmill/mozmill.jsm&quot;</span>
<a href="#l113.23"></a><span id="l113.23"> );</span>
<a href="#l113.24"></a><span id="l113.24"> </span>
<a href="#l113.25"></a><span id="l113.25"> var { content_tab_eid, open_content_tab_with_url } = ChromeUtils.import(</span>
<a href="#l113.26"></a><span id="l113.26">   &quot;resource://testing-common/mozmill/ContentTabHelpers.jsm&quot;</span>
<a href="#l113.27"></a><span id="l113.27"> );</span>
<a href="#l113.28"></a><span id="l113.28"> var { mc } = ChromeUtils.import(</span>
<a href="#l113.29"></a><span id="l113.29">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l113.30"></a><span id="l113.30"> );</span>
<a href="#l113.31"></a><span id="l113.31"> </span>
<a href="#l113.32"></a><span id="l113.32"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l113.33"></a><span id="l113.33"> </span>
<a href="#l113.34"></a><span id="l113.34" class="difflineminus">-// RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l113.35"></a><span id="l113.35" class="difflineminus">-// so we get the right path for the resources.</span>
<a href="#l113.36"></a><span id="l113.36" class="difflineminus">-var url = collector.addHttpResource(&quot;../content-tabs/html&quot;, &quot;content-tabs&quot;);</span>
<a href="#l113.37"></a><span id="l113.37" class="difflineplus">+var url =</span>
<a href="#l113.38"></a><span id="l113.38" class="difflineplus">+  &quot;http://mochi.test:8888/browser/comm/mail/test/browser/content-tabs/html/&quot;;</span>
<a href="#l113.39"></a><span id="l113.39"> </span>
<a href="#l113.40"></a><span id="l113.40"> var gDocument;</span>
<a href="#l113.41"></a><span id="l113.41"> var gNewTab;</span>
<a href="#l113.42"></a><span id="l113.42"> </span>
<a href="#l113.43"></a><span id="l113.43" class="difflineminus">-function setupModule(module) {</span>
<a href="#l113.44"></a><span id="l113.44" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l113.45"></a><span id="l113.45">   gDocument = mc.window.document;</span>
<a href="#l113.46"></a><span id="l113.46">   gNewTab = open_content_tab_with_url(</span>
<a href="#l113.47"></a><span id="l113.47">     url + &quot;installxpi.html&quot;,</span>
<a href="#l113.48"></a><span id="l113.48">     &quot;specialTabs.siteClickHandler(event, new RegExp('^&quot; + url + &quot;'));&quot;</span>
<a href="#l113.49"></a><span id="l113.49">   );</span>
<a href="#l113.50"></a><span id="l113.50" class="difflineminus">-}</span>
<a href="#l113.51"></a><span id="l113.51" class="difflineplus">+});</span>
<a href="#l113.52"></a><span id="l113.52"> </span>
<a href="#l113.53"></a><span id="l113.53"> var teardownModule = function(module) {</span>
<a href="#l113.54"></a><span id="l113.54">   mc.tabmail.closeTab(gNewTab);</span>
<a href="#l113.55"></a><span id="l113.55"> };</span>
<a href="#l113.56"></a><span id="l113.56"> </span>
<a href="#l113.57"></a><span id="l113.57"> function waitForNotification(id, buttonToClickSelector, callback) {</span>
<a href="#l113.58"></a><span id="l113.58">   let path = `</span>
<a href="#l113.59"></a><span id="l113.59">     /id(&quot;messengerWindow&quot;)/id(&quot;mainPopupSet&quot;)/id(&quot;notification-popup&quot;)/id(&quot;${id}-notification&quot;)</span>
<a href="#l113.60"></a><span id="l113.60" class="difflineat">@@ -56,67 +55,67 @@ function waitForNotification(id, buttonT</span>
<a href="#l113.61"></a><span id="l113.61">   }</span>
<a href="#l113.62"></a><span id="l113.62">   let button = gDocument.querySelector(</span>
<a href="#l113.63"></a><span id="l113.63">     `#${id}-notification ${buttonToClickSelector}`</span>
<a href="#l113.64"></a><span id="l113.64">   );</span>
<a href="#l113.65"></a><span id="l113.65">   mc.click(new elib.Elem(button));</span>
<a href="#l113.66"></a><span id="l113.66">   mc.waitForElementNotPresent(notification);</span>
<a href="#l113.67"></a><span id="l113.67"> }</span>
<a href="#l113.68"></a><span id="l113.68"> </span>
<a href="#l113.69"></a><span id="l113.69" class="difflineminus">-function test_install_corrupt_xpi() {</span>
<a href="#l113.70"></a><span id="l113.70" class="difflineplus">+add_task(function test_install_corrupt_xpi() {</span>
<a href="#l113.71"></a><span id="l113.71">   // This install with give us a corrupt xpi warning.</span>
<a href="#l113.72"></a><span id="l113.72">   mc.click(content_tab_eid(gNewTab, &quot;corruptlink&quot;));</span>
<a href="#l113.73"></a><span id="l113.73">   waitForNotification(</span>
<a href="#l113.74"></a><span id="l113.74">     &quot;addon-install-blocked&quot;,</span>
<a href="#l113.75"></a><span id="l113.75">     &quot;.popup-notification-primary-button&quot;</span>
<a href="#l113.76"></a><span id="l113.76">   );</span>
<a href="#l113.77"></a><span id="l113.77">   waitForNotification(</span>
<a href="#l113.78"></a><span id="l113.78">     &quot;addon-install-failed&quot;,</span>
<a href="#l113.79"></a><span id="l113.79">     &quot;.popup-notification-primary-button&quot;</span>
<a href="#l113.80"></a><span id="l113.80">   );</span>
<a href="#l113.81"></a><span id="l113.81" class="difflineminus">-}</span>
<a href="#l113.82"></a><span id="l113.82" class="difflineplus">+});</span>
<a href="#l113.83"></a><span id="l113.83"> </span>
<a href="#l113.84"></a><span id="l113.84" class="difflineminus">-function test_install_xpi_offer() {</span>
<a href="#l113.85"></a><span id="l113.85" class="difflineplus">+add_task(function test_install_xpi_offer() {</span>
<a href="#l113.86"></a><span id="l113.86">   mc.click(content_tab_eid(gNewTab, &quot;installlink&quot;));</span>
<a href="#l113.87"></a><span id="l113.87">   waitForNotification(</span>
<a href="#l113.88"></a><span id="l113.88">     &quot;addon-install-blocked&quot;,</span>
<a href="#l113.89"></a><span id="l113.89">     &quot;.popup-notification-primary-button&quot;</span>
<a href="#l113.90"></a><span id="l113.90">   );</span>
<a href="#l113.91"></a><span id="l113.91">   waitForNotification(</span>
<a href="#l113.92"></a><span id="l113.92">     &quot;addon-install-failed&quot;,</span>
<a href="#l113.93"></a><span id="l113.93">     &quot;.popup-notification-primary-button&quot;</span>
<a href="#l113.94"></a><span id="l113.94">   );</span>
<a href="#l113.95"></a><span id="l113.95" class="difflineminus">-}</span>
<a href="#l113.96"></a><span id="l113.96" class="difflineplus">+});</span>
<a href="#l113.97"></a><span id="l113.97"> </span>
<a href="#l113.98"></a><span id="l113.98" class="difflineminus">-function test_xpinstall_disabled() {</span>
<a href="#l113.99"></a><span id="l113.99" class="difflineplus">+add_task(function test_xpinstall_disabled() {</span>
<a href="#l113.100"></a><span id="l113.100">   Services.prefs.setBoolPref(&quot;xpinstall.enabled&quot;, false);</span>
<a href="#l113.101"></a><span id="l113.101"> </span>
<a href="#l113.102"></a><span id="l113.102">   // Try installation again - this time we'll get an install has been disabled message.</span>
<a href="#l113.103"></a><span id="l113.103">   mc.click(content_tab_eid(gNewTab, &quot;installlink&quot;));</span>
<a href="#l113.104"></a><span id="l113.104">   waitForNotification(</span>
<a href="#l113.105"></a><span id="l113.105">     &quot;xpinstall-disabled&quot;,</span>
<a href="#l113.106"></a><span id="l113.106">     &quot;.popup-notification-secondary-button&quot;</span>
<a href="#l113.107"></a><span id="l113.107">   );</span>
<a href="#l113.108"></a><span id="l113.108"> </span>
<a href="#l113.109"></a><span id="l113.109">   Services.prefs.clearUserPref(&quot;xpinstall.enabled&quot;);</span>
<a href="#l113.110"></a><span id="l113.110" class="difflineminus">-}</span>
<a href="#l113.111"></a><span id="l113.111" class="difflineplus">+});</span>
<a href="#l113.112"></a><span id="l113.112"> </span>
<a href="#l113.113"></a><span id="l113.113" class="difflineminus">-function test_xpinstall_actually_install() {</span>
<a href="#l113.114"></a><span id="l113.114" class="difflineplus">+add_task(function test_xpinstall_actually_install() {</span>
<a href="#l113.115"></a><span id="l113.115">   mc.click(content_tab_eid(gNewTab, &quot;installlink&quot;));</span>
<a href="#l113.116"></a><span id="l113.116">   waitForNotification(</span>
<a href="#l113.117"></a><span id="l113.117">     &quot;addon-install-blocked&quot;,</span>
<a href="#l113.118"></a><span id="l113.118">     &quot;.popup-notification-primary-button&quot;</span>
<a href="#l113.119"></a><span id="l113.119">   );</span>
<a href="#l113.120"></a><span id="l113.120">   waitForNotification(</span>
<a href="#l113.121"></a><span id="l113.121">     &quot;addon-install-failed&quot;,</span>
<a href="#l113.122"></a><span id="l113.122">     &quot;.popup-notification-primary-button&quot;</span>
<a href="#l113.123"></a><span id="l113.123">   );</span>
<a href="#l113.124"></a><span id="l113.124" class="difflineminus">-}</span>
<a href="#l113.125"></a><span id="l113.125" class="difflineplus">+});</span>
<a href="#l113.126"></a><span id="l113.126"> </span>
<a href="#l113.127"></a><span id="l113.127" class="difflineminus">-function test_xpinstall_webext_actually_install() {</span>
<a href="#l113.128"></a><span id="l113.128" class="difflineplus">+add_task(function test_xpinstall_webext_actually_install() {</span>
<a href="#l113.129"></a><span id="l113.129">   mc.click(content_tab_eid(gNewTab, &quot;installwebextlink&quot;));</span>
<a href="#l113.130"></a><span id="l113.130">   waitForNotification(</span>
<a href="#l113.131"></a><span id="l113.131">     &quot;addon-install-blocked&quot;,</span>
<a href="#l113.132"></a><span id="l113.132">     &quot;.popup-notification-primary-button&quot;</span>
<a href="#l113.133"></a><span id="l113.133">   );</span>
<a href="#l113.134"></a><span id="l113.134">   waitForNotification(</span>
<a href="#l113.135"></a><span id="l113.135">     &quot;addon-webext-permissions&quot;,</span>
<a href="#l113.136"></a><span id="l113.136">     &quot;.popup-notification-primary-button&quot;,</span>
<a href="#l113.137"></a><span id="l113.137" class="difflineat">@@ -124,9 +123,16 @@ function test_xpinstall_webext_actually_</span>
<a href="#l113.138"></a><span id="l113.138">       let intro = new elib.ID(gDocument, &quot;addon-webext-perm-intro&quot;);</span>
<a href="#l113.139"></a><span id="l113.139">       mc.assertNotDOMProperty(intro, &quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l113.140"></a><span id="l113.140">       let permissionList = new elib.ID(gDocument, &quot;addon-webext-perm-list&quot;);</span>
<a href="#l113.141"></a><span id="l113.141">       mc.assertNotDOMProperty(permissionList, &quot;hidden&quot;, &quot;true&quot;);</span>
<a href="#l113.142"></a><span id="l113.142">       mc.assert(() =&gt; permissionList.getNode().childElementCount == 1);</span>
<a href="#l113.143"></a><span id="l113.143">     }</span>
<a href="#l113.144"></a><span id="l113.144">   );</span>
<a href="#l113.145"></a><span id="l113.145">   waitForNotification(&quot;addon-installed&quot;, &quot;.popup-notification-primary-button&quot;);</span>
<a href="#l113.146"></a><span id="l113.146" class="difflineminus">-}</span>
<a href="#l113.147"></a><span id="l113.147" class="difflineplus">+</span>
<a href="#l113.148"></a><span id="l113.148" class="difflineplus">+  Assert.report(</span>
<a href="#l113.149"></a><span id="l113.149" class="difflineplus">+    false,</span>
<a href="#l113.150"></a><span id="l113.150" class="difflineplus">+    undefined,</span>
<a href="#l113.151"></a><span id="l113.151" class="difflineplus">+    undefined,</span>
<a href="#l113.152"></a><span id="l113.152" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l113.153"></a><span id="l113.153" class="difflineplus">+  );</span>
<a href="#l113.154"></a><span id="l113.154" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l114.1"></a><span id="l114.1">copy from mail/test/mozmill/content-tabs/html/blocklist.xml</span>
<a href="#l114.2"></a><span id="l114.2">copy to mail/test/browser/content-tabs/html/blocklist.xml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l115.1"></a><span id="l115.1">copy from mail/test/mozmill/content-tabs/html/blocklistHard.xml</span>
<a href="#l115.2"></a><span id="l115.2">copy to mail/test/browser/content-tabs/html/blocklistHard.xml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l116.1"></a><span id="l116.1">copy from mail/test/mozmill/content-tabs/html/blocklist_details.html</span>
<a href="#l116.2"></a><span id="l116.2">copy to mail/test/browser/content-tabs/html/blocklist_details.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l117.1"></a><span id="l117.1">copy from mail/test/mozmill/content-tabs/html/corrupt.xpi</span>
<a href="#l117.2"></a><span id="l117.2">copy to mail/test/browser/content-tabs/html/corrupt.xpi</span>
<a href="#l117.3"></a><span id="l117.3"></span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l118.1"></a><span id="l118.1">copy from mail/test/mozmill/content-tabs/html/dummy.xml</span>
<a href="#l118.2"></a><span id="l118.2">copy to mail/test/browser/content-tabs/html/dummy.xml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l119.1"></a><span id="l119.1">copy from mail/test/mozmill/content-tabs/html/favicon.ico</span>
<a href="#l119.2"></a><span id="l119.2">copy to mail/test/browser/content-tabs/html/favicon.ico</span>
<a href="#l119.3"></a><span id="l119.3"></span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l120.1"></a><span id="l120.1">copy from mail/test/mozmill/content-tabs/html/installxpi.html</span>
<a href="#l120.2"></a><span id="l120.2">copy to mail/test/browser/content-tabs/html/installxpi.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l121.1"></a><span id="l121.1">copy from mail/test/mozmill/content-tabs/html/installxpi.xpi</span>
<a href="#l121.2"></a><span id="l121.2">copy to mail/test/browser/content-tabs/html/installxpi.xpi</span>
<a href="#l121.3"></a><span id="l121.3"></span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l122.1"></a><span id="l122.1">copy from mail/test/mozmill/content-tabs/html/plugin.html</span>
<a href="#l122.2"></a><span id="l122.2">copy to mail/test/browser/content-tabs/html/plugin.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l123.1"></a><span id="l123.1">copy from mail/test/mozmill/content-tabs/html/plugin_crashed_help.html</span>
<a href="#l123.2"></a><span id="l123.2">copy to mail/test/browser/content-tabs/html/plugin_crashed_help.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l124.1"></a><span id="l124.1">copy from mail/test/mozmill/content-tabs/html/plugin_update.html</span>
<a href="#l124.2"></a><span id="l124.2">copy to mail/test/browser/content-tabs/html/plugin_update.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l125.1"></a><span id="l125.1">copy from mail/test/mozmill/content-tabs/html/test-lwthemes.html</span>
<a href="#l125.2"></a><span id="l125.2">copy to mail/test/browser/content-tabs/html/test-lwthemes.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l126.1"></a><span id="l126.1">copy from mail/test/mozmill/content-tabs/html/test.png</span>
<a href="#l126.2"></a><span id="l126.2">copy to mail/test/browser/content-tabs/html/test.png</span>
<a href="#l126.3"></a><span id="l126.3"></span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l127.1"></a><span id="l127.1">copy from mail/test/mozmill/content-tabs/html/webextension.xpi</span>
<a href="#l127.2"></a><span id="l127.2">copy to mail/test/browser/content-tabs/html/webextension.xpi</span>
<a href="#l127.3"></a><span id="l127.3"></span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l128.1"></a><span id="l128.1">copy from mail/test/mozmill/content-tabs/html/whatsnew.html</span>
<a href="#l128.2"></a><span id="l128.2">copy to mail/test/browser/content-tabs/html/whatsnew.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l129.1"></a><span id="l129.1">copy from mail/test/mozmill/content-tabs/html/whatsnew.png</span>
<a href="#l129.2"></a><span id="l129.2">copy to mail/test/browser/content-tabs/html/whatsnew.png</span>
<a href="#l129.3"></a><span id="l129.3"></span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l130.1"></a><span id="l130.1">copy from mail/test/mozmill/content-tabs/html/whatsnew1.html</span>
<a href="#l130.2"></a><span id="l130.2">copy to mail/test/browser/content-tabs/html/whatsnew1.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l131.1"></a><span id="l131.1">new file mode 100644</span>
<a href="#l131.2"></a><span id="l131.2" class="difflineminus">--- /dev/null</span>
<a href="#l131.3"></a><span id="l131.3" class="difflineplus">+++ b/mail/test/browser/cookies/browser.ini</span>
<a href="#l131.4"></a><span id="l131.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l131.5"></a><span id="l131.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l131.6"></a><span id="l131.6" class="difflineplus">+prefs =</span>
<a href="#l131.7"></a><span id="l131.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l131.8"></a><span id="l131.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l131.9"></a><span id="l131.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l131.10"></a><span id="l131.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l131.11"></a><span id="l131.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l131.12"></a><span id="l131.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l131.13"></a><span id="l131.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l131.14"></a><span id="l131.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l131.15"></a><span id="l131.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l131.16"></a><span id="l131.16" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l131.17"></a><span id="l131.17" class="difflineplus">+support-files = html/**</span>
<a href="#l131.18"></a><span id="l131.18" class="difflineplus">+</span>
<a href="#l131.19"></a><span id="l131.19" class="difflineplus">+[browser_cookies.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l132.1"></a><span id="l132.1">copy from mail/test/mozmill/cookies/test-cookies.js</span>
<a href="#l132.2"></a><span id="l132.2">copy to mail/test/browser/cookies/browser_cookies.js</span>
<a href="#l132.3"></a><span id="l132.3" class="difflineminus">--- a/mail/test/mozmill/cookies/test-cookies.js</span>
<a href="#l132.4"></a><span id="l132.4" class="difflineplus">+++ b/mail/test/browser/cookies/browser_cookies.js</span>
<a href="#l132.5"></a><span id="l132.5" class="difflineat">@@ -14,26 +14,23 @@ var { open_content_tab_with_url } = Chro</span>
<a href="#l132.6"></a><span id="l132.6">   &quot;resource://testing-common/mozmill/ContentTabHelpers.jsm&quot;</span>
<a href="#l132.7"></a><span id="l132.7"> );</span>
<a href="#l132.8"></a><span id="l132.8"> var { mc } = ChromeUtils.import(</span>
<a href="#l132.9"></a><span id="l132.9">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l132.10"></a><span id="l132.10"> );</span>
<a href="#l132.11"></a><span id="l132.11"> </span>
<a href="#l132.12"></a><span id="l132.12"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l132.13"></a><span id="l132.13"> // so we get the right path for the resources.</span>
<a href="#l132.14"></a><span id="l132.14" class="difflineminus">-var url = collector.addHttpResource(&quot;../cookies/html&quot;, &quot;cookies&quot;);</span>
<a href="#l132.15"></a><span id="l132.15" class="difflineplus">+var url = &quot;http://mochi.test:8888/browser/comm/mail/test/browser/cookies/html/&quot;;</span>
<a href="#l132.16"></a><span id="l132.16"> </span>
<a href="#l132.17"></a><span id="l132.17"> /**</span>
<a href="#l132.18"></a><span id="l132.18">  * Test deleting junk messages with no messages marked as junk.</span>
<a href="#l132.19"></a><span id="l132.19">  */</span>
<a href="#l132.20"></a><span id="l132.20" class="difflineminus">-function test_load_cookie_page() {</span>
<a href="#l132.21"></a><span id="l132.21" class="difflineplus">+add_task(function test_load_cookie_page() {</span>
<a href="#l132.22"></a><span id="l132.22">   open_content_tab_with_url(url + &quot;cookietest1.html&quot;);</span>
<a href="#l132.23"></a><span id="l132.23" class="difflineminus">-}</span>
<a href="#l132.24"></a><span id="l132.24" class="difflineminus">-</span>
<a href="#l132.25"></a><span id="l132.25" class="difflineminus">-function test_load_cookie_result_page() {</span>
<a href="#l132.26"></a><span id="l132.26">   open_content_tab_with_url(url + &quot;cookietest2.html&quot;);</span>
<a href="#l132.27"></a><span id="l132.27"> </span>
<a href="#l132.28"></a><span id="l132.28">   if (mc.window.content.document.title != &quot;Cookie Test 2&quot;) {</span>
<a href="#l132.29"></a><span id="l132.29">     throw new Error(</span>
<a href="#l132.30"></a><span id="l132.30">       &quot;The cookie test 2 page is not the selected tab or not content-primary&quot;</span>
<a href="#l132.31"></a><span id="l132.31">     );</span>
<a href="#l132.32"></a><span id="l132.32">   }</span>
<a href="#l132.33"></a><span id="l132.33"> </span>
<a href="#l132.34"></a><span id="l132.34" class="difflineat">@@ -45,9 +42,16 @@ function test_load_cookie_result_page() </span>
<a href="#l132.35"></a><span id="l132.35">     throw new Error(&quot;Document has no cookie :-(&quot;);</span>
<a href="#l132.36"></a><span id="l132.36">   }</span>
<a href="#l132.37"></a><span id="l132.37"> </span>
<a href="#l132.38"></a><span id="l132.38">   if (cookie != &quot;name=CookieTest&quot;) {</span>
<a href="#l132.39"></a><span id="l132.39">     throw new Error(</span>
<a href="#l132.40"></a><span id="l132.40">       &quot;Cookie set incorrectly, expected: name=CookieTest, got: &quot; + cookie + &quot;\n&quot;</span>
<a href="#l132.41"></a><span id="l132.41">     );</span>
<a href="#l132.42"></a><span id="l132.42">   }</span>
<a href="#l132.43"></a><span id="l132.43" class="difflineminus">-}</span>
<a href="#l132.44"></a><span id="l132.44" class="difflineplus">+</span>
<a href="#l132.45"></a><span id="l132.45" class="difflineplus">+  Assert.report(</span>
<a href="#l132.46"></a><span id="l132.46" class="difflineplus">+    false,</span>
<a href="#l132.47"></a><span id="l132.47" class="difflineplus">+    undefined,</span>
<a href="#l132.48"></a><span id="l132.48" class="difflineplus">+    undefined,</span>
<a href="#l132.49"></a><span id="l132.49" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l132.50"></a><span id="l132.50" class="difflineplus">+  );</span>
<a href="#l132.51"></a><span id="l132.51" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l133.1"></a><span id="l133.1">copy from mail/test/mozmill/cookies/html/cookietest1.html</span>
<a href="#l133.2"></a><span id="l133.2">copy to mail/test/browser/cookies/html/cookietest1.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l134.1"></a><span id="l134.1">copy from mail/test/mozmill/cookies/html/cookietest2.html</span>
<a href="#l134.2"></a><span id="l134.2">copy to mail/test/browser/cookies/html/cookietest2.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l135.1"></a><span id="l135.1">new file mode 100644</span>
<a href="#l135.2"></a><span id="l135.2" class="difflineminus">--- /dev/null</span>
<a href="#l135.3"></a><span id="l135.3" class="difflineplus">+++ b/mail/test/browser/downloads/browser.ini</span>
<a href="#l135.4"></a><span id="l135.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l135.5"></a><span id="l135.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l135.6"></a><span id="l135.6" class="difflineplus">+prefs =</span>
<a href="#l135.7"></a><span id="l135.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l135.8"></a><span id="l135.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l135.9"></a><span id="l135.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l135.10"></a><span id="l135.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l135.11"></a><span id="l135.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l135.12"></a><span id="l135.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l135.13"></a><span id="l135.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l135.14"></a><span id="l135.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l135.15"></a><span id="l135.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l135.16"></a><span id="l135.16" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l135.17"></a><span id="l135.17" class="difflineplus">+</span>
<a href="#l135.18"></a><span id="l135.18" class="difflineplus">+[browser_aboutDownloads.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l136.1"></a><span id="l136.1">copy from mail/test/mozmill/downloads/test-about-downloads.js</span>
<a href="#l136.2"></a><span id="l136.2">copy to mail/test/browser/downloads/browser_aboutDownloads.js</span>
<a href="#l136.3"></a><span id="l136.3" class="difflineminus">--- a/mail/test/mozmill/downloads/test-about-downloads.js</span>
<a href="#l136.4"></a><span id="l136.4" class="difflineplus">+++ b/mail/test/browser/downloads/browser_aboutDownloads.js</span>
<a href="#l136.5"></a><span id="l136.5" class="difflineat">@@ -4,29 +4,26 @@</span>
<a href="#l136.6"></a><span id="l136.6"> </span>
<a href="#l136.7"></a><span id="l136.7"> /**</span>
<a href="#l136.8"></a><span id="l136.8">  * Test about:downloads.</span>
<a href="#l136.9"></a><span id="l136.9">  */</span>
<a href="#l136.10"></a><span id="l136.10"> </span>
<a href="#l136.11"></a><span id="l136.11"> &quot;use strict&quot;;</span>
<a href="#l136.12"></a><span id="l136.12"> </span>
<a href="#l136.13"></a><span id="l136.13"> var elementslib = ChromeUtils.import(</span>
<a href="#l136.14"></a><span id="l136.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l136.15"></a><span id="l136.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l136.16"></a><span id="l136.16"> );</span>
<a href="#l136.17"></a><span id="l136.17"> </span>
<a href="#l136.18"></a><span id="l136.18"> var { gMockFilePicker, gMockFilePickReg } = ChromeUtils.import(</span>
<a href="#l136.19"></a><span id="l136.19">   &quot;resource://testing-common/mozmill/AttachmentHelpers.jsm&quot;</span>
<a href="#l136.20"></a><span id="l136.20"> );</span>
<a href="#l136.21"></a><span id="l136.21"> var { content_tab_e, content_tab_eid } = ChromeUtils.import(</span>
<a href="#l136.22"></a><span id="l136.22">   &quot;resource://testing-common/mozmill/ContentTabHelpers.jsm&quot;</span>
<a href="#l136.23"></a><span id="l136.23"> );</span>
<a href="#l136.24"></a><span id="l136.24"> var {</span>
<a href="#l136.25"></a><span id="l136.25" class="difflineminus">-  assert_equals,</span>
<a href="#l136.26"></a><span id="l136.26" class="difflineminus">-  assert_false,</span>
<a href="#l136.27"></a><span id="l136.27" class="difflineminus">-  assert_not_equals,</span>
<a href="#l136.28"></a><span id="l136.28">   be_in_folder,</span>
<a href="#l136.29"></a><span id="l136.29">   close_tab,</span>
<a href="#l136.30"></a><span id="l136.30">   create_folder,</span>
<a href="#l136.31"></a><span id="l136.31">   make_new_sets_in_folder,</span>
<a href="#l136.32"></a><span id="l136.32">   mc,</span>
<a href="#l136.33"></a><span id="l136.33">   select_click_row,</span>
<a href="#l136.34"></a><span id="l136.34">   switch_tab,</span>
<a href="#l136.35"></a><span id="l136.35">   wait_for_popup_to_open,</span>
<a href="#l136.36"></a><span id="l136.36" class="difflineat">@@ -121,24 +118,24 @@ function prepare_messages() {</span>
<a href="#l136.37"></a><span id="l136.37"> function prepare_downloads_view() {</span>
<a href="#l136.38"></a><span id="l136.38">   let success = false;</span>
<a href="#l136.39"></a><span id="l136.39">   downloads.Downloads.getList(downloads.Downloads.ALL)</span>
<a href="#l136.40"></a><span id="l136.40">     .then(list =&gt; list.addView(downloadsView))</span>
<a href="#l136.41"></a><span id="l136.41">     .then(() =&gt; (success = true), Cu.reportError);</span>
<a href="#l136.42"></a><span id="l136.42">   mc.waitFor(() =&gt; success, &quot;Timeout waiting for attaching our download view.&quot;);</span>
<a href="#l136.43"></a><span id="l136.43"> }</span>
<a href="#l136.44"></a><span id="l136.44"> </span>
<a href="#l136.45"></a><span id="l136.45" class="difflineminus">-function setupModule(module) {</span>
<a href="#l136.46"></a><span id="l136.46" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l136.47"></a><span id="l136.47">   gMockFilePickReg.register();</span>
<a href="#l136.48"></a><span id="l136.48"> </span>
<a href="#l136.49"></a><span id="l136.49">   prepare_messages();</span>
<a href="#l136.50"></a><span id="l136.50">   prepare_downloads_view();</span>
<a href="#l136.51"></a><span id="l136.51"> </span>
<a href="#l136.52"></a><span id="l136.52">   downloadsTab = open_about_downloads();</span>
<a href="#l136.53"></a><span id="l136.53" class="difflineminus">-}</span>
<a href="#l136.54"></a><span id="l136.54" class="difflineplus">+});</span>
<a href="#l136.55"></a><span id="l136.55"> </span>
<a href="#l136.56"></a><span id="l136.56"> function setupTest(test) {</span>
<a href="#l136.57"></a><span id="l136.57">   downloadsView.init();</span>
<a href="#l136.58"></a><span id="l136.58"> }</span>
<a href="#l136.59"></a><span id="l136.59"> </span>
<a href="#l136.60"></a><span id="l136.60"> function open_about_downloads() {</span>
<a href="#l136.61"></a><span id="l136.61">   let preCount = mc.tabmail.tabContainer.allTabs.length;</span>
<a href="#l136.62"></a><span id="l136.62">   let newTab = mc.tabmail.openTab(&quot;chromeTab&quot;, {</span>
<a href="#l136.63"></a><span id="l136.63" class="difflineat">@@ -154,22 +151,24 @@ function open_about_downloads() {</span>
<a href="#l136.64"></a><span id="l136.64">   // We append new tabs at the end, so check the last one.</span>
<a href="#l136.65"></a><span id="l136.65">   let expectedNewTab = mc.tabmail.tabInfo[preCount];</span>
<a href="#l136.66"></a><span id="l136.66">   return expectedNewTab;</span>
<a href="#l136.67"></a><span id="l136.67"> }</span>
<a href="#l136.68"></a><span id="l136.68"> </span>
<a href="#l136.69"></a><span id="l136.69"> /**</span>
<a href="#l136.70"></a><span id="l136.70">  * Test that there is no file in the list at first.</span>
<a href="#l136.71"></a><span id="l136.71">  */</span>
<a href="#l136.72"></a><span id="l136.72" class="difflineminus">-function test_empty_list() {</span>
<a href="#l136.73"></a><span id="l136.73" class="difflineplus">+add_task(function test_empty_list() {</span>
<a href="#l136.74"></a><span id="l136.74" class="difflineplus">+  setupTest();</span>
<a href="#l136.75"></a><span id="l136.75">   switch_tab(downloadsTab);</span>
<a href="#l136.76"></a><span id="l136.76"> </span>
<a href="#l136.77"></a><span id="l136.77">   let empty = content_tab_e(downloadsTab, &quot;msgDownloadsListEmptyDescription&quot;);</span>
<a href="#l136.78"></a><span id="l136.78" class="difflineminus">-  assert_false(empty.hidden, &quot;msgDownloadsListEmptyDescription is not visible&quot;);</span>
<a href="#l136.79"></a><span id="l136.79" class="difflineminus">-}</span>
<a href="#l136.80"></a><span id="l136.80" class="difflineplus">+  Assert.ok(!empty.hidden, &quot;msgDownloadsListEmptyDescription is not visible&quot;);</span>
<a href="#l136.81"></a><span id="l136.81" class="difflineplus">+  teardownTest();</span>
<a href="#l136.82"></a><span id="l136.82" class="difflineplus">+});</span>
<a href="#l136.83"></a><span id="l136.83"> </span>
<a href="#l136.84"></a><span id="l136.84"> function save_attachment_files() {</span>
<a href="#l136.85"></a><span id="l136.85">   switch_tab(0);</span>
<a href="#l136.86"></a><span id="l136.86"> </span>
<a href="#l136.87"></a><span id="l136.87">   let profileDir = Services.dirsvc.get(&quot;ProfD&quot;, Ci.nsIFile);</span>
<a href="#l136.88"></a><span id="l136.88"> </span>
<a href="#l136.89"></a><span id="l136.89">   let length = attachmentFileNames.length;</span>
<a href="#l136.90"></a><span id="l136.90">   for (let i = 0; i &lt; length; i++) {</span>
<a href="#l136.91"></a><span id="l136.91" class="difflineat">@@ -183,54 +182,60 @@ function save_attachment_files() {</span>
<a href="#l136.92"></a><span id="l136.92">       })</span>
<a href="#l136.93"></a><span id="l136.93">     );</span>
<a href="#l136.94"></a><span id="l136.94">   }</span>
<a href="#l136.95"></a><span id="l136.95"> }</span>
<a href="#l136.96"></a><span id="l136.96"> </span>
<a href="#l136.97"></a><span id="l136.97"> /**</span>
<a href="#l136.98"></a><span id="l136.98">  * Test that all downloaded files are showed up in the list.</span>
<a href="#l136.99"></a><span id="l136.99">  */</span>
<a href="#l136.100"></a><span id="l136.100" class="difflineminus">-function test_save_attachment_files_in_list() {</span>
<a href="#l136.101"></a><span id="l136.101" class="difflineplus">+function subtest_save_attachment_files_in_list() {</span>
<a href="#l136.102"></a><span id="l136.102">   save_attachment_files();</span>
<a href="#l136.103"></a><span id="l136.103"> </span>
<a href="#l136.104"></a><span id="l136.104">   mc.tabmail.switchToTab(downloadsTab);</span>
<a href="#l136.105"></a><span id="l136.105">   let list = content_tab_e(downloadsTab, &quot;msgDownloadsRichListBox&quot;);</span>
<a href="#l136.106"></a><span id="l136.106"> </span>
<a href="#l136.107"></a><span id="l136.107">   let length = attachmentFileNames.length;</span>
<a href="#l136.108"></a><span id="l136.108">   mc.waitFor(</span>
<a href="#l136.109"></a><span id="l136.109">     () =&gt; downloadsView.count == length,</span>
<a href="#l136.110"></a><span id="l136.110">     () =&gt;</span>
<a href="#l136.111"></a><span id="l136.111">       &quot;Timeout waiting for saving three attachment files; &quot; +</span>
<a href="#l136.112"></a><span id="l136.112">       &quot;downloadsView.count=&quot; +</span>
<a href="#l136.113"></a><span id="l136.113">       downloadsView.count</span>
<a href="#l136.114"></a><span id="l136.114">   );</span>
<a href="#l136.115"></a><span id="l136.115"> </span>
<a href="#l136.116"></a><span id="l136.116" class="difflineminus">-  assert_equals(length, list.children.length);</span>
<a href="#l136.117"></a><span id="l136.117" class="difflineminus">-  assert_equals(downloadsView.count, list.children.length);</span>
<a href="#l136.118"></a><span id="l136.118" class="difflineplus">+  Assert.equal(length, list.children.length);</span>
<a href="#l136.119"></a><span id="l136.119" class="difflineplus">+  Assert.equal(downloadsView.count, list.children.length);</span>
<a href="#l136.120"></a><span id="l136.120"> </span>
<a href="#l136.121"></a><span id="l136.121">   let actualNames = [];</span>
<a href="#l136.122"></a><span id="l136.122">   let child = list.firstElementChild;</span>
<a href="#l136.123"></a><span id="l136.123">   dump(child.querySelector(&quot;.fileName&quot;).getAttribute(&quot;value&quot;));</span>
<a href="#l136.124"></a><span id="l136.124">   while (child) {</span>
<a href="#l136.125"></a><span id="l136.125">     actualNames.push(child.querySelector(&quot;.fileName&quot;).getAttribute(&quot;value&quot;));</span>
<a href="#l136.126"></a><span id="l136.126">     child = child.nextElementSibling;</span>
<a href="#l136.127"></a><span id="l136.127">   }</span>
<a href="#l136.128"></a><span id="l136.128">   actualNames.sort();</span>
<a href="#l136.129"></a><span id="l136.129"> </span>
<a href="#l136.130"></a><span id="l136.130">   for (let i = 0; i &lt; length; i++) {</span>
<a href="#l136.131"></a><span id="l136.131" class="difflineminus">-    assert_equals(attachmentFileNames[i], actualNames[i]);</span>
<a href="#l136.132"></a><span id="l136.132" class="difflineplus">+    Assert.equal(attachmentFileNames[i], actualNames[i]);</span>
<a href="#l136.133"></a><span id="l136.133">   }</span>
<a href="#l136.134"></a><span id="l136.134"> }</span>
<a href="#l136.135"></a><span id="l136.135" class="difflineplus">+add_task(function test_save_attachment_files_in_list() {</span>
<a href="#l136.136"></a><span id="l136.136" class="difflineplus">+  setupTest();</span>
<a href="#l136.137"></a><span id="l136.137" class="difflineplus">+  subtest_save_attachment_files_in_list();</span>
<a href="#l136.138"></a><span id="l136.138" class="difflineplus">+  teardownTest();</span>
<a href="#l136.139"></a><span id="l136.139" class="difflineplus">+});</span>
<a href="#l136.140"></a><span id="l136.140"> </span>
<a href="#l136.141"></a><span id="l136.141"> /**</span>
<a href="#l136.142"></a><span id="l136.142">  * Test that 'remove' in context menu removes surely the target file from</span>
<a href="#l136.143"></a><span id="l136.143">  * the list.</span>
<a href="#l136.144"></a><span id="l136.144">  */</span>
<a href="#l136.145"></a><span id="l136.145" class="difflineminus">-function test_remove_file() {</span>
<a href="#l136.146"></a><span id="l136.146" class="difflineminus">-  test_save_attachment_files_in_list();</span>
<a href="#l136.147"></a><span id="l136.147" class="difflineplus">+add_task(function test_remove_file() {</span>
<a href="#l136.148"></a><span id="l136.148" class="difflineplus">+  setupTest();</span>
<a href="#l136.149"></a><span id="l136.149" class="difflineplus">+  subtest_save_attachment_files_in_list();</span>
<a href="#l136.150"></a><span id="l136.150"> </span>
<a href="#l136.151"></a><span id="l136.151">   let list = content_tab_e(downloadsTab, &quot;msgDownloadsRichListBox&quot;);</span>
<a href="#l136.152"></a><span id="l136.152">   let firstElement = list.firstElementChild;</span>
<a href="#l136.153"></a><span id="l136.153">   let removingFileName = firstElement</span>
<a href="#l136.154"></a><span id="l136.154">     .querySelector(&quot;.fileName&quot;)</span>
<a href="#l136.155"></a><span id="l136.155">     .getAttribute(&quot;value&quot;);</span>
<a href="#l136.156"></a><span id="l136.156"> </span>
<a href="#l136.157"></a><span id="l136.157">   // select first element</span>
<a href="#l136.158"></a><span id="l136.158" class="difflineat">@@ -244,29 +249,31 @@ function test_remove_file() {</span>
<a href="#l136.159"></a><span id="l136.159">   ]);</span>
<a href="#l136.160"></a><span id="l136.160">   mc.waitFor(</span>
<a href="#l136.161"></a><span id="l136.161">     () =&gt; downloadsView.count == 2,</span>
<a href="#l136.162"></a><span id="l136.162">     &quot;Timeout waiting for removing a saved attachment file.&quot;</span>
<a href="#l136.163"></a><span id="l136.163">   );</span>
<a href="#l136.164"></a><span id="l136.164"> </span>
<a href="#l136.165"></a><span id="l136.165">   let child = list.firstElementChild;</span>
<a href="#l136.166"></a><span id="l136.166">   while (child) {</span>
<a href="#l136.167"></a><span id="l136.167" class="difflineminus">-    assert_not_equals(</span>
<a href="#l136.168"></a><span id="l136.168" class="difflineplus">+    Assert.notEqual(</span>
<a href="#l136.169"></a><span id="l136.169">       removingFileName,</span>
<a href="#l136.170"></a><span id="l136.170">       child.querySelector(&quot;.fileName&quot;).getAttribute(&quot;value&quot;)</span>
<a href="#l136.171"></a><span id="l136.171">     );</span>
<a href="#l136.172"></a><span id="l136.172">     child = child.nextElementSibling;</span>
<a href="#l136.173"></a><span id="l136.173">   }</span>
<a href="#l136.174"></a><span id="l136.174" class="difflineminus">-}</span>
<a href="#l136.175"></a><span id="l136.175" class="difflineplus">+  teardownTest();</span>
<a href="#l136.176"></a><span id="l136.176" class="difflineplus">+});</span>
<a href="#l136.177"></a><span id="l136.177"> </span>
<a href="#l136.178"></a><span id="l136.178"> /**</span>
<a href="#l136.179"></a><span id="l136.179">  * Test that removing multiple files surely removes the files.</span>
<a href="#l136.180"></a><span id="l136.180">  */</span>
<a href="#l136.181"></a><span id="l136.181" class="difflineminus">-function test_remove_multiple_files() {</span>
<a href="#l136.182"></a><span id="l136.182" class="difflineminus">-  test_save_attachment_files_in_list();</span>
<a href="#l136.183"></a><span id="l136.183" class="difflineplus">+add_task(function test_remove_multiple_files() {</span>
<a href="#l136.184"></a><span id="l136.184" class="difflineplus">+  setupTest();</span>
<a href="#l136.185"></a><span id="l136.185" class="difflineplus">+  subtest_save_attachment_files_in_list();</span>
<a href="#l136.186"></a><span id="l136.186"> </span>
<a href="#l136.187"></a><span id="l136.187">   let list = content_tab_e(downloadsTab, &quot;msgDownloadsRichListBox&quot;);</span>
<a href="#l136.188"></a><span id="l136.188">   let firstElement = list.firstElementChild.nextElementSibling;</span>
<a href="#l136.189"></a><span id="l136.189">   let secondElement = firstElement.nextElementSibling;</span>
<a href="#l136.190"></a><span id="l136.190">   let removingFileNames = [];</span>
<a href="#l136.191"></a><span id="l136.191"> </span>
<a href="#l136.192"></a><span id="l136.192">   removingFileNames.push(</span>
<a href="#l136.193"></a><span id="l136.193">     firstElement.querySelector(&quot;.fileName&quot;).getAttribute(&quot;value&quot;)</span>
<a href="#l136.194"></a><span id="l136.194" class="difflineat">@@ -288,48 +295,51 @@ function test_remove_multiple_files() {</span>
<a href="#l136.195"></a><span id="l136.195">   mc.waitFor(</span>
<a href="#l136.196"></a><span id="l136.196">     () =&gt; downloadsView.count == 1,</span>
<a href="#l136.197"></a><span id="l136.197">     &quot;Timeout waiting for removing two saved attachment files.&quot;</span>
<a href="#l136.198"></a><span id="l136.198">   );</span>
<a href="#l136.199"></a><span id="l136.199"> </span>
<a href="#l136.200"></a><span id="l136.200">   let child = list.firstElementChild;</span>
<a href="#l136.201"></a><span id="l136.201">   while (child) {</span>
<a href="#l136.202"></a><span id="l136.202">     for (let name of removingFileNames) {</span>
<a href="#l136.203"></a><span id="l136.203" class="difflineminus">-      assert_not_equals(</span>
<a href="#l136.204"></a><span id="l136.204" class="difflineplus">+      Assert.notEqual(</span>
<a href="#l136.205"></a><span id="l136.205">         name,</span>
<a href="#l136.206"></a><span id="l136.206">         child.querySelector(&quot;.fileName&quot;).getAttribute(&quot;value&quot;)</span>
<a href="#l136.207"></a><span id="l136.207">       );</span>
<a href="#l136.208"></a><span id="l136.208">     }</span>
<a href="#l136.209"></a><span id="l136.209">     child = child.nextElementSibling;</span>
<a href="#l136.210"></a><span id="l136.210">   }</span>
<a href="#l136.211"></a><span id="l136.211" class="difflineminus">-}</span>
<a href="#l136.212"></a><span id="l136.212" class="difflineplus">+  teardownTest();</span>
<a href="#l136.213"></a><span id="l136.213" class="difflineplus">+});</span>
<a href="#l136.214"></a><span id="l136.214"> </span>
<a href="#l136.215"></a><span id="l136.215"> /**</span>
<a href="#l136.216"></a><span id="l136.216">  * Test that 'clearDownloads&quot; in context menu purges all files in the list.</span>
<a href="#l136.217"></a><span id="l136.217">  */</span>
<a href="#l136.218"></a><span id="l136.218" class="difflineminus">-function test_clear_all_files() {</span>
<a href="#l136.219"></a><span id="l136.219" class="difflineminus">-  test_save_attachment_files_in_list();</span>
<a href="#l136.220"></a><span id="l136.220" class="difflineplus">+add_task(function test_clear_all_files() {</span>
<a href="#l136.221"></a><span id="l136.221" class="difflineplus">+  setupTest();</span>
<a href="#l136.222"></a><span id="l136.222" class="difflineplus">+  subtest_save_attachment_files_in_list();</span>
<a href="#l136.223"></a><span id="l136.223">   downloadsView.waitForFinish();</span>
<a href="#l136.224"></a><span id="l136.224"> </span>
<a href="#l136.225"></a><span id="l136.225">   mc.click(content_tab_eid(downloadsTab, &quot;msgDownloadsRichListBox&quot;));</span>
<a href="#l136.226"></a><span id="l136.226">   mc.rightClick(content_tab_eid(downloadsTab, &quot;msgDownloadsRichListBox&quot;));</span>
<a href="#l136.227"></a><span id="l136.227"> </span>
<a href="#l136.228"></a><span id="l136.228">   let contextMenu = content_tab_e(downloadsTab, &quot;msgDownloadsContextMenu&quot;);</span>
<a href="#l136.229"></a><span id="l136.229">   wait_for_popup_to_open(contextMenu);</span>
<a href="#l136.230"></a><span id="l136.230">   mc.click_menus_in_sequence(contextMenu, [</span>
<a href="#l136.231"></a><span id="l136.231">     { command: &quot;msgDownloadsCmd_clearDownloads&quot; },</span>
<a href="#l136.232"></a><span id="l136.232">   ]);</span>
<a href="#l136.233"></a><span id="l136.233">   mc.waitFor(</span>
<a href="#l136.234"></a><span id="l136.234">     () =&gt; downloadsView.count == 0,</span>
<a href="#l136.235"></a><span id="l136.235">     &quot;Timeout waiting for clearing all saved attachment files.&quot;</span>
<a href="#l136.236"></a><span id="l136.236">   );</span>
<a href="#l136.237"></a><span id="l136.237"> </span>
<a href="#l136.238"></a><span id="l136.238">   let empty = content_tab_e(downloadsTab, &quot;msgDownloadsListEmptyDescription&quot;);</span>
<a href="#l136.239"></a><span id="l136.239" class="difflineminus">-  assert_false(empty.hidden, &quot;msgDownloadsListEmptyDescription is not visible&quot;);</span>
<a href="#l136.240"></a><span id="l136.240" class="difflineminus">-}</span>
<a href="#l136.241"></a><span id="l136.241" class="difflineplus">+  Assert.ok(!empty.hidden, &quot;msgDownloadsListEmptyDescription is not visible&quot;);</span>
<a href="#l136.242"></a><span id="l136.242" class="difflineplus">+  teardownTest();</span>
<a href="#l136.243"></a><span id="l136.243" class="difflineplus">+});</span>
<a href="#l136.244"></a><span id="l136.244"> </span>
<a href="#l136.245"></a><span id="l136.245"> function teardownTest() {</span>
<a href="#l136.246"></a><span id="l136.246">   downloads.Downloads.getList(downloads.Downloads.ALL)</span>
<a href="#l136.247"></a><span id="l136.247">     .then(function(list) {</span>
<a href="#l136.248"></a><span id="l136.248">       for (let download of downloadsView.items.keys()) {</span>
<a href="#l136.249"></a><span id="l136.249">         list.remove(download);</span>
<a href="#l136.250"></a><span id="l136.250">       }</span>
<a href="#l136.251"></a><span id="l136.251">     })</span>
<a href="#l136.252"></a><span id="l136.252" class="difflineat">@@ -340,12 +350,12 @@ function teardownTest() {</span>
<a href="#l136.253"></a><span id="l136.253">   );</span>
<a href="#l136.254"></a><span id="l136.254">   let empty = content_tab_e(downloadsTab, &quot;msgDownloadsListEmptyDescription&quot;);</span>
<a href="#l136.255"></a><span id="l136.255">   mc.waitFor(</span>
<a href="#l136.256"></a><span id="l136.256">     () =&gt; empty.hidden === false,</span>
<a href="#l136.257"></a><span id="l136.257">     &quot;Timeout waiting for msgDownloadsListEmptyDescription is visible.&quot;</span>
<a href="#l136.258"></a><span id="l136.258">   );</span>
<a href="#l136.259"></a><span id="l136.259"> }</span>
<a href="#l136.260"></a><span id="l136.260"> </span>
<a href="#l136.261"></a><span id="l136.261" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l136.262"></a><span id="l136.262" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l136.263"></a><span id="l136.263">   close_tab(downloadsTab);</span>
<a href="#l136.264"></a><span id="l136.264">   gMockFilePickReg.unregister();</span>
<a href="#l136.265"></a><span id="l136.265" class="difflineminus">-}</span>
<a href="#l136.266"></a><span id="l136.266" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l137.1"></a><span id="l137.1">new file mode 100644</span>
<a href="#l137.2"></a><span id="l137.2" class="difflineminus">--- /dev/null</span>
<a href="#l137.3"></a><span id="l137.3" class="difflineplus">+++ b/mail/test/browser/folder-display/browser.ini</span>
<a href="#l137.4"></a><span id="l137.4" class="difflineat">@@ -0,0 +1,73 @@</span>
<a href="#l137.5"></a><span id="l137.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l137.6"></a><span id="l137.6" class="difflineplus">+prefs =</span>
<a href="#l137.7"></a><span id="l137.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l137.8"></a><span id="l137.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l137.9"></a><span id="l137.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l137.10"></a><span id="l137.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l137.11"></a><span id="l137.11" class="difflineplus">+  mail.account.account1.server=server1</span>
<a href="#l137.12"></a><span id="l137.12" class="difflineplus">+  mail.account.account2.identities=id1,id2</span>
<a href="#l137.13"></a><span id="l137.13" class="difflineplus">+  mail.account.account2.server=server2</span>
<a href="#l137.14"></a><span id="l137.14" class="difflineplus">+  mail.accountmanager.accounts=account1,account2</span>
<a href="#l137.15"></a><span id="l137.15" class="difflineplus">+  mail.accountmanager.defaultaccount=account2</span>
<a href="#l137.16"></a><span id="l137.16" class="difflineplus">+  mail.accountmanager.localfoldersserver=server1</span>
<a href="#l137.17"></a><span id="l137.17" class="difflineplus">+  mail.identity.id1.fullName=Tinderbox</span>
<a href="#l137.18"></a><span id="l137.18" class="difflineplus">+  mail.identity.id1.htmlSigFormat=false</span>
<a href="#l137.19"></a><span id="l137.19" class="difflineplus">+  mail.identity.id1.smtpServer=smtp1</span>
<a href="#l137.20"></a><span id="l137.20" class="difflineplus">+  mail.identity.id1.useremail=tinderbox@foo.invalid</span>
<a href="#l137.21"></a><span id="l137.21" class="difflineplus">+  mail.identity.id1.valid=true</span>
<a href="#l137.22"></a><span id="l137.22" class="difflineplus">+  mail.identity.id2.fullName=Tinderboxpushlog</span>
<a href="#l137.23"></a><span id="l137.23" class="difflineplus">+  mail.identity.id2.htmlSigFormat=true</span>
<a href="#l137.24"></a><span id="l137.24" class="difflineplus">+  mail.identity.id2.smtpServer=smtp1</span>
<a href="#l137.25"></a><span id="l137.25" class="difflineplus">+  mail.identity.id2.useremail=tinderboxpushlog@foo.invalid</span>
<a href="#l137.26"></a><span id="l137.26" class="difflineplus">+  mail.identity.id2.valid=true</span>
<a href="#l137.27"></a><span id="l137.27" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l137.28"></a><span id="l137.28" class="difflineplus">+  mail.server.server1.type=none</span>
<a href="#l137.29"></a><span id="l137.29" class="difflineplus">+  mail.server.server1.userName=nobody</span>
<a href="#l137.30"></a><span id="l137.30" class="difflineplus">+  mail.server.server2.check_new_mail=false</span>
<a href="#l137.31"></a><span id="l137.31" class="difflineplus">+  mail.server.server2.directory-rel=[ProfD]Mail/tinderbox</span>
<a href="#l137.32"></a><span id="l137.32" class="difflineplus">+  mail.server.server2.download_on_biff=true</span>
<a href="#l137.33"></a><span id="l137.33" class="difflineplus">+  mail.server.server2.hostname=tinderbox123</span>
<a href="#l137.34"></a><span id="l137.34" class="difflineplus">+  mail.server.server2.login_at_startup=false</span>
<a href="#l137.35"></a><span id="l137.35" class="difflineplus">+  mail.server.server2.name=tinderbox@foo.invalid</span>
<a href="#l137.36"></a><span id="l137.36" class="difflineplus">+  mail.server.server2.type=pop3</span>
<a href="#l137.37"></a><span id="l137.37" class="difflineplus">+  mail.server.server2.userName=tinderbox</span>
<a href="#l137.38"></a><span id="l137.38" class="difflineplus">+  mail.server.server2.whiteListAbURI=</span>
<a href="#l137.39"></a><span id="l137.39" class="difflineplus">+  mail.shell.checkDefaultClient=false</span>
<a href="#l137.40"></a><span id="l137.40" class="difflineplus">+  mail.smtp.defaultserver=smtp1</span>
<a href="#l137.41"></a><span id="l137.41" class="difflineplus">+  mail.smtpserver.smtp1.hostname=tinderbox123</span>
<a href="#l137.42"></a><span id="l137.42" class="difflineplus">+  mail.smtpserver.smtp1.username=tinderbox</span>
<a href="#l137.43"></a><span id="l137.43" class="difflineplus">+  mail.smtpservers=smtp1</span>
<a href="#l137.44"></a><span id="l137.44" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l137.45"></a><span id="l137.45" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l137.46"></a><span id="l137.46" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l137.47"></a><span id="l137.47" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l137.48"></a><span id="l137.48" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l137.49"></a><span id="l137.49" class="difflineplus">+</span>
<a href="#l137.50"></a><span id="l137.50" class="difflineplus">+[browser_archiveMessages.js]</span>
<a href="#l137.51"></a><span id="l137.51" class="difflineplus">+[browser_closeWindowOnDelete.js]</span>
<a href="#l137.52"></a><span id="l137.52" class="difflineplus">+[browser_columns.js]</span>
<a href="#l137.53"></a><span id="l137.53" class="difflineplus">+[browser_deletionFromVirtualFolders.js]</span>
<a href="#l137.54"></a><span id="l137.54" class="difflineplus">+[browser_deletionWithMultipleDisplays.js]</span>
<a href="#l137.55"></a><span id="l137.55" class="difflineplus">+[browser_displayName.js]</span>
<a href="#l137.56"></a><span id="l137.56" class="difflineplus">+[browser_folderPaneVisibility.js]</span>
<a href="#l137.57"></a><span id="l137.57" class="difflineplus">+[browser_folderToolbar.js]</span>
<a href="#l137.58"></a><span id="l137.58" class="difflineplus">+[browser_invalidDbFolderLoad.js]</span>
<a href="#l137.59"></a><span id="l137.59" class="difflineplus">+[browser_mailViews.js]</span>
<a href="#l137.60"></a><span id="l137.60" class="difflineplus">+[browser_messageCommands.js]</span>
<a href="#l137.61"></a><span id="l137.61" class="difflineplus">+[browser_messageCommandsOnMsgstore.js]</span>
<a href="#l137.62"></a><span id="l137.62" class="difflineplus">+[browser_messagePaneVisibility.js]</span>
<a href="#l137.63"></a><span id="l137.63" class="difflineplus">+[browser_messageReloads.js]</span>
<a href="#l137.64"></a><span id="l137.64" class="difflineplus">+[browser_messageSize.js]</span>
<a href="#l137.65"></a><span id="l137.65" class="difflineplus">+[browser_messageWindow.js]</span>
<a href="#l137.66"></a><span id="l137.66" class="difflineplus">+[browser_openingMessages.js]</span>
<a href="#l137.67"></a><span id="l137.67" class="difflineplus">+[browser_openingMessagesWithoutABackingView.js]</span>
<a href="#l137.68"></a><span id="l137.68" class="difflineplus">+[browser_paneFocus.js]</span>
<a href="#l137.69"></a><span id="l137.69" class="difflineplus">+[browser_recentMenu.js]</span>
<a href="#l137.70"></a><span id="l137.70" class="difflineplus">+[browser_rightClickMiddleClickFolders.js]</span>
<a href="#l137.71"></a><span id="l137.71" class="difflineplus">+[browser_rightClickMiddleClickMessages.js]</span>
<a href="#l137.72"></a><span id="l137.72" class="difflineplus">+[browser_savedsearchReloadAfterCompact.js]</span>
<a href="#l137.73"></a><span id="l137.73" class="difflineplus">+[browser_selection.js]</span>
<a href="#l137.74"></a><span id="l137.74" class="difflineplus">+[browser_summarization.js]</span>
<a href="#l137.75"></a><span id="l137.75" class="difflineplus">+[browser_tabsSimple.js]</span>
<a href="#l137.76"></a><span id="l137.76" class="difflineplus">+[browser_virtualFolderCommands.js]</span>
<a href="#l137.77"></a><span id="l137.77" class="difflineplus">+[browser_watchIgnoreThread.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l138.1"></a><span id="l138.1">copy from mail/test/mozmill/folder-display/test-archive-messages.js</span>
<a href="#l138.2"></a><span id="l138.2">copy to mail/test/browser/folder-display/browser_archiveMessages.js</span>
<a href="#l138.3"></a><span id="l138.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-archive-messages.js</span>
<a href="#l138.4"></a><span id="l138.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_archiveMessages.js</span>
<a href="#l138.5"></a><span id="l138.5" class="difflineat">@@ -26,28 +26,28 @@ var {</span>
<a href="#l138.6"></a><span id="l138.6"> </span>
<a href="#l138.7"></a><span id="l138.7"> var folder;</span>
<a href="#l138.8"></a><span id="l138.8"> </span>
<a href="#l138.9"></a><span id="l138.9"> /**</span>
<a href="#l138.10"></a><span id="l138.10">  * The number of messages in the thread we use to test.</span>
<a href="#l138.11"></a><span id="l138.11">  */</span>
<a href="#l138.12"></a><span id="l138.12"> var NUM_MESSAGES_IN_THREAD = 6;</span>
<a href="#l138.13"></a><span id="l138.13"> </span>
<a href="#l138.14"></a><span id="l138.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l138.15"></a><span id="l138.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l138.16"></a><span id="l138.16">   folder = create_folder(&quot;ThreadedMessages&quot;);</span>
<a href="#l138.17"></a><span id="l138.17">   let thread = create_thread(NUM_MESSAGES_IN_THREAD);</span>
<a href="#l138.18"></a><span id="l138.18">   add_sets_to_folders([folder], [thread]);</span>
<a href="#l138.19"></a><span id="l138.19">   thread = create_thread(NUM_MESSAGES_IN_THREAD);</span>
<a href="#l138.20"></a><span id="l138.20">   add_sets_to_folders([folder], [thread]);</span>
<a href="#l138.21"></a><span id="l138.21" class="difflineminus">-}</span>
<a href="#l138.22"></a><span id="l138.22" class="difflineplus">+});</span>
<a href="#l138.23"></a><span id="l138.23"> </span>
<a href="#l138.24"></a><span id="l138.24"> /**</span>
<a href="#l138.25"></a><span id="l138.25">  * Test archiving messages that are not currently selected.</span>
<a href="#l138.26"></a><span id="l138.26">  */</span>
<a href="#l138.27"></a><span id="l138.27" class="difflineminus">-function test_batch_archiver() {</span>
<a href="#l138.28"></a><span id="l138.28" class="difflineplus">+add_task(function test_batch_archiver() {</span>
<a href="#l138.29"></a><span id="l138.29">   be_in_folder(folder);</span>
<a href="#l138.30"></a><span id="l138.30">   make_display_threaded();</span>
<a href="#l138.31"></a><span id="l138.31"> </span>
<a href="#l138.32"></a><span id="l138.32">   select_none();</span>
<a href="#l138.33"></a><span id="l138.33">   assert_nothing_selected();</span>
<a href="#l138.34"></a><span id="l138.34"> </span>
<a href="#l138.35"></a><span id="l138.35">   /* Select the first (expanded) thread */</span>
<a href="#l138.36"></a><span id="l138.36">   let root = select_click_row(0);</span>
<a href="#l138.37"></a><span id="l138.37" class="difflineat">@@ -107,9 +107,16 @@ function test_batch_archiver() {</span>
<a href="#l138.38"></a><span id="l138.38"> </span>
<a href="#l138.39"></a><span id="l138.39">   select_shift_click_row(2);</span>
<a href="#l138.40"></a><span id="l138.40">   select_shift_click_row(1);</span>
<a href="#l138.41"></a><span id="l138.41">   select_shift_click_row(0);</span>
<a href="#l138.42"></a><span id="l138.42"> </span>
<a href="#l138.43"></a><span id="l138.43">   archive_messages([child1, child3]);</span>
<a href="#l138.44"></a><span id="l138.44">   assert_message_not_in_view([child1, child3]);</span>
<a href="#l138.45"></a><span id="l138.45">   assert_selected_and_displayed(child2);</span>
<a href="#l138.46"></a><span id="l138.46" class="difflineminus">-}</span>
<a href="#l138.47"></a><span id="l138.47" class="difflineplus">+</span>
<a href="#l138.48"></a><span id="l138.48" class="difflineplus">+  Assert.report(</span>
<a href="#l138.49"></a><span id="l138.49" class="difflineplus">+    false,</span>
<a href="#l138.50"></a><span id="l138.50" class="difflineplus">+    undefined,</span>
<a href="#l138.51"></a><span id="l138.51" class="difflineplus">+    undefined,</span>
<a href="#l138.52"></a><span id="l138.52" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l138.53"></a><span id="l138.53" class="difflineplus">+  );</span>
<a href="#l138.54"></a><span id="l138.54" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l139.1"></a><span id="l139.1">copy from mail/test/mozmill/folder-display/test-close-window-on-delete.js</span>
<a href="#l139.2"></a><span id="l139.2">copy to mail/test/browser/folder-display/browser_closeWindowOnDelete.js</span>
<a href="#l139.3"></a><span id="l139.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-close-window-on-delete.js</span>
<a href="#l139.4"></a><span id="l139.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_closeWindowOnDelete.js</span>
<a href="#l139.5"></a><span id="l139.5" class="difflineat">@@ -28,27 +28,27 @@ var {</span>
<a href="#l139.6"></a><span id="l139.6"> var {</span>
<a href="#l139.7"></a><span id="l139.7">   close_window,</span>
<a href="#l139.8"></a><span id="l139.8">   plan_for_window_close,</span>
<a href="#l139.9"></a><span id="l139.9">   wait_for_window_close,</span>
<a href="#l139.10"></a><span id="l139.10"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;);</span>
<a href="#l139.11"></a><span id="l139.11"> </span>
<a href="#l139.12"></a><span id="l139.12"> var folder;</span>
<a href="#l139.13"></a><span id="l139.13"> </span>
<a href="#l139.14"></a><span id="l139.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l139.15"></a><span id="l139.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l139.16"></a><span id="l139.16">   folder = create_folder(&quot;CloseWindowOnDeleteA&quot;);</span>
<a href="#l139.17"></a><span id="l139.17"> </span>
<a href="#l139.18"></a><span id="l139.18">   make_new_sets_in_folder(folder, [{ count: 10 }]);</span>
<a href="#l139.19"></a><span id="l139.19" class="difflineminus">-}</span>
<a href="#l139.20"></a><span id="l139.20" class="difflineplus">+});</span>
<a href="#l139.21"></a><span id="l139.21"> </span>
<a href="#l139.22"></a><span id="l139.22"> /**</span>
<a href="#l139.23"></a><span id="l139.23">  * Delete a message and check that the message window is closed</span>
<a href="#l139.24"></a><span id="l139.24">  * where appropriate.</span>
<a href="#l139.25"></a><span id="l139.25">  */</span>
<a href="#l139.26"></a><span id="l139.26" class="difflineminus">-function test_close_message_window_on_delete_from_message_window() {</span>
<a href="#l139.27"></a><span id="l139.27" class="difflineplus">+add_task(function test_close_message_window_on_delete_from_message_window() {</span>
<a href="#l139.28"></a><span id="l139.28">   set_close_message_on_delete(true);</span>
<a href="#l139.29"></a><span id="l139.29">   be_in_folder(folder);</span>
<a href="#l139.30"></a><span id="l139.30"> </span>
<a href="#l139.31"></a><span id="l139.31">   // select the first message</span>
<a href="#l139.32"></a><span id="l139.32">   select_click_row(0);</span>
<a href="#l139.33"></a><span id="l139.33">   // display it</span>
<a href="#l139.34"></a><span id="l139.34">   let msgc = open_selected_message_in_new_window();</span>
<a href="#l139.35"></a><span id="l139.35"> </span>
<a href="#l139.36"></a><span id="l139.36" class="difflineat">@@ -66,100 +66,104 @@ function test_close_message_window_on_de</span>
<a href="#l139.37"></a><span id="l139.37"> </span>
<a href="#l139.38"></a><span id="l139.38">   if (msgc2.window.closed) {</span>
<a href="#l139.39"></a><span id="l139.39">     throw new Error(&quot;should only have closed the active window&quot;);</span>
<a href="#l139.40"></a><span id="l139.40">   }</span>
<a href="#l139.41"></a><span id="l139.41"> </span>
<a href="#l139.42"></a><span id="l139.42">   close_window(msgc2);</span>
<a href="#l139.43"></a><span id="l139.43"> </span>
<a href="#l139.44"></a><span id="l139.44">   reset_close_message_on_delete();</span>
<a href="#l139.45"></a><span id="l139.45" class="difflineminus">-}</span>
<a href="#l139.46"></a><span id="l139.46" class="difflineplus">+});</span>
<a href="#l139.47"></a><span id="l139.47"> </span>
<a href="#l139.48"></a><span id="l139.48"> /**</span>
<a href="#l139.49"></a><span id="l139.49">  * Delete a message when multiple windows are open to the message, and the</span>
<a href="#l139.50"></a><span id="l139.50">  * message is deleted from one of them.</span>
<a href="#l139.51"></a><span id="l139.51">  */</span>
<a href="#l139.52"></a><span id="l139.52" class="difflineminus">-function test_close_multiple_message_windows_on_delete_from_message_window() {</span>
<a href="#l139.53"></a><span id="l139.53" class="difflineminus">-  set_close_message_on_delete(true);</span>
<a href="#l139.54"></a><span id="l139.54" class="difflineminus">-  be_in_folder(folder);</span>
<a href="#l139.55"></a><span id="l139.55" class="difflineplus">+add_task(</span>
<a href="#l139.56"></a><span id="l139.56" class="difflineplus">+  function test_close_multiple_message_windows_on_delete_from_message_window() {</span>
<a href="#l139.57"></a><span id="l139.57" class="difflineplus">+    set_close_message_on_delete(true);</span>
<a href="#l139.58"></a><span id="l139.58" class="difflineplus">+    be_in_folder(folder);</span>
<a href="#l139.59"></a><span id="l139.59"> </span>
<a href="#l139.60"></a><span id="l139.60" class="difflineminus">-  // select the first message</span>
<a href="#l139.61"></a><span id="l139.61" class="difflineminus">-  select_click_row(0);</span>
<a href="#l139.62"></a><span id="l139.62" class="difflineminus">-  // display it</span>
<a href="#l139.63"></a><span id="l139.63" class="difflineminus">-  let msgc = open_selected_message_in_new_window();</span>
<a href="#l139.64"></a><span id="l139.64" class="difflineminus">-  let msgcA = open_selected_message_in_new_window();</span>
<a href="#l139.65"></a><span id="l139.65" class="difflineplus">+    // select the first message</span>
<a href="#l139.66"></a><span id="l139.66" class="difflineplus">+    select_click_row(0);</span>
<a href="#l139.67"></a><span id="l139.67" class="difflineplus">+    // display it</span>
<a href="#l139.68"></a><span id="l139.68" class="difflineplus">+    let msgc = open_selected_message_in_new_window();</span>
<a href="#l139.69"></a><span id="l139.69" class="difflineplus">+    let msgcA = open_selected_message_in_new_window();</span>
<a href="#l139.70"></a><span id="l139.70"> </span>
<a href="#l139.71"></a><span id="l139.71" class="difflineminus">-  select_click_row(1);</span>
<a href="#l139.72"></a><span id="l139.72" class="difflineminus">-  let msgc2 = open_selected_message_in_new_window();</span>
<a href="#l139.73"></a><span id="l139.73" class="difflineplus">+    select_click_row(1);</span>
<a href="#l139.74"></a><span id="l139.74" class="difflineplus">+    let msgc2 = open_selected_message_in_new_window();</span>
<a href="#l139.75"></a><span id="l139.75"> </span>
<a href="#l139.76"></a><span id="l139.76" class="difflineminus">-  let preCount = folder.getTotalMessages(false);</span>
<a href="#l139.77"></a><span id="l139.77" class="difflineminus">-  msgc.window.focus();</span>
<a href="#l139.78"></a><span id="l139.78" class="difflineminus">-  plan_for_window_close(msgc);</span>
<a href="#l139.79"></a><span id="l139.79" class="difflineminus">-  plan_for_window_close(msgcA);</span>
<a href="#l139.80"></a><span id="l139.80" class="difflineminus">-  press_delete(msgc);</span>
<a href="#l139.81"></a><span id="l139.81" class="difflineplus">+    let preCount = folder.getTotalMessages(false);</span>
<a href="#l139.82"></a><span id="l139.82" class="difflineplus">+    msgc.window.focus();</span>
<a href="#l139.83"></a><span id="l139.83" class="difflineplus">+    plan_for_window_close(msgc);</span>
<a href="#l139.84"></a><span id="l139.84" class="difflineplus">+    plan_for_window_close(msgcA);</span>
<a href="#l139.85"></a><span id="l139.85" class="difflineplus">+    press_delete(msgc);</span>
<a href="#l139.86"></a><span id="l139.86"> </span>
<a href="#l139.87"></a><span id="l139.87" class="difflineminus">-  if (folder.getTotalMessages(false) != preCount - 1) {</span>
<a href="#l139.88"></a><span id="l139.88" class="difflineminus">-    throw new Error(&quot;didn't delete a message before closing window&quot;);</span>
<a href="#l139.89"></a><span id="l139.89" class="difflineplus">+    if (folder.getTotalMessages(false) != preCount - 1) {</span>
<a href="#l139.90"></a><span id="l139.90" class="difflineplus">+      throw new Error(&quot;didn't delete a message before closing window&quot;);</span>
<a href="#l139.91"></a><span id="l139.91" class="difflineplus">+    }</span>
<a href="#l139.92"></a><span id="l139.92" class="difflineplus">+    wait_for_window_close(msgc);</span>
<a href="#l139.93"></a><span id="l139.93" class="difflineplus">+    wait_for_window_close(msgcA);</span>
<a href="#l139.94"></a><span id="l139.94" class="difflineplus">+</span>
<a href="#l139.95"></a><span id="l139.95" class="difflineplus">+    if (msgc2.window.closed) {</span>
<a href="#l139.96"></a><span id="l139.96" class="difflineplus">+      throw new Error(&quot;should only have closed the active window&quot;);</span>
<a href="#l139.97"></a><span id="l139.97" class="difflineplus">+    }</span>
<a href="#l139.98"></a><span id="l139.98" class="difflineplus">+</span>
<a href="#l139.99"></a><span id="l139.99" class="difflineplus">+    close_window(msgc2);</span>
<a href="#l139.100"></a><span id="l139.100" class="difflineplus">+</span>
<a href="#l139.101"></a><span id="l139.101" class="difflineplus">+    reset_close_message_on_delete();</span>
<a href="#l139.102"></a><span id="l139.102">   }</span>
<a href="#l139.103"></a><span id="l139.103" class="difflineminus">-  wait_for_window_close(msgc);</span>
<a href="#l139.104"></a><span id="l139.104" class="difflineminus">-  wait_for_window_close(msgcA);</span>
<a href="#l139.105"></a><span id="l139.105" class="difflineminus">-</span>
<a href="#l139.106"></a><span id="l139.106" class="difflineminus">-  if (msgc2.window.closed) {</span>
<a href="#l139.107"></a><span id="l139.107" class="difflineminus">-    throw new Error(&quot;should only have closed the active window&quot;);</span>
<a href="#l139.108"></a><span id="l139.108" class="difflineminus">-  }</span>
<a href="#l139.109"></a><span id="l139.109" class="difflineminus">-</span>
<a href="#l139.110"></a><span id="l139.110" class="difflineminus">-  close_window(msgc2);</span>
<a href="#l139.111"></a><span id="l139.111" class="difflineminus">-</span>
<a href="#l139.112"></a><span id="l139.112" class="difflineminus">-  reset_close_message_on_delete();</span>
<a href="#l139.113"></a><span id="l139.113" class="difflineminus">-}</span>
<a href="#l139.114"></a><span id="l139.114" class="difflineplus">+);</span>
<a href="#l139.115"></a><span id="l139.115"> </span>
<a href="#l139.116"></a><span id="l139.116"> /**</span>
<a href="#l139.117"></a><span id="l139.117">  * Delete a message when multiple windows are open to the message, and the</span>
<a href="#l139.118"></a><span id="l139.118">  * message is deleted from the 3-pane window.</span>
<a href="#l139.119"></a><span id="l139.119">  */</span>
<a href="#l139.120"></a><span id="l139.120" class="difflineminus">-function test_close_multiple_message_windows_on_delete_from_3pane_window() {</span>
<a href="#l139.121"></a><span id="l139.121" class="difflineminus">-  set_close_message_on_delete(true);</span>
<a href="#l139.122"></a><span id="l139.122" class="difflineminus">-  be_in_folder(folder);</span>
<a href="#l139.123"></a><span id="l139.123" class="difflineplus">+add_task(</span>
<a href="#l139.124"></a><span id="l139.124" class="difflineplus">+  function test_close_multiple_message_windows_on_delete_from_3pane_window() {</span>
<a href="#l139.125"></a><span id="l139.125" class="difflineplus">+    set_close_message_on_delete(true);</span>
<a href="#l139.126"></a><span id="l139.126" class="difflineplus">+    be_in_folder(folder);</span>
<a href="#l139.127"></a><span id="l139.127"> </span>
<a href="#l139.128"></a><span id="l139.128" class="difflineminus">-  // select the first message</span>
<a href="#l139.129"></a><span id="l139.129" class="difflineminus">-  select_click_row(0);</span>
<a href="#l139.130"></a><span id="l139.130" class="difflineminus">-  // display it</span>
<a href="#l139.131"></a><span id="l139.131" class="difflineminus">-  let msgc = open_selected_message_in_new_window();</span>
<a href="#l139.132"></a><span id="l139.132" class="difflineminus">-  let msgcA = open_selected_message_in_new_window();</span>
<a href="#l139.133"></a><span id="l139.133" class="difflineplus">+    // select the first message</span>
<a href="#l139.134"></a><span id="l139.134" class="difflineplus">+    select_click_row(0);</span>
<a href="#l139.135"></a><span id="l139.135" class="difflineplus">+    // display it</span>
<a href="#l139.136"></a><span id="l139.136" class="difflineplus">+    let msgc = open_selected_message_in_new_window();</span>
<a href="#l139.137"></a><span id="l139.137" class="difflineplus">+    let msgcA = open_selected_message_in_new_window();</span>
<a href="#l139.138"></a><span id="l139.138"> </span>
<a href="#l139.139"></a><span id="l139.139" class="difflineminus">-  select_click_row(1);</span>
<a href="#l139.140"></a><span id="l139.140" class="difflineminus">-  let msgc2 = open_selected_message_in_new_window();</span>
<a href="#l139.141"></a><span id="l139.141" class="difflineplus">+    select_click_row(1);</span>
<a href="#l139.142"></a><span id="l139.142" class="difflineplus">+    let msgc2 = open_selected_message_in_new_window();</span>
<a href="#l139.143"></a><span id="l139.143"> </span>
<a href="#l139.144"></a><span id="l139.144" class="difflineminus">-  let preCount = folder.getTotalMessages(false);</span>
<a href="#l139.145"></a><span id="l139.145" class="difflineminus">-  mc.window.focus();</span>
<a href="#l139.146"></a><span id="l139.146" class="difflineminus">-  plan_for_window_close(msgc);</span>
<a href="#l139.147"></a><span id="l139.147" class="difflineminus">-  plan_for_window_close(msgcA);</span>
<a href="#l139.148"></a><span id="l139.148" class="difflineminus">-  select_click_row(0);</span>
<a href="#l139.149"></a><span id="l139.149" class="difflineminus">-  press_delete(mc);</span>
<a href="#l139.150"></a><span id="l139.150" class="difflineplus">+    let preCount = folder.getTotalMessages(false);</span>
<a href="#l139.151"></a><span id="l139.151" class="difflineplus">+    mc.window.focus();</span>
<a href="#l139.152"></a><span id="l139.152" class="difflineplus">+    plan_for_window_close(msgc);</span>
<a href="#l139.153"></a><span id="l139.153" class="difflineplus">+    plan_for_window_close(msgcA);</span>
<a href="#l139.154"></a><span id="l139.154" class="difflineplus">+    select_click_row(0);</span>
<a href="#l139.155"></a><span id="l139.155" class="difflineplus">+    press_delete(mc);</span>
<a href="#l139.156"></a><span id="l139.156"> </span>
<a href="#l139.157"></a><span id="l139.157" class="difflineminus">-  if (folder.getTotalMessages(false) != preCount - 1) {</span>
<a href="#l139.158"></a><span id="l139.158" class="difflineminus">-    throw new Error(&quot;didn't delete a message before closing window&quot;);</span>
<a href="#l139.159"></a><span id="l139.159" class="difflineplus">+    if (folder.getTotalMessages(false) != preCount - 1) {</span>
<a href="#l139.160"></a><span id="l139.160" class="difflineplus">+      throw new Error(&quot;didn't delete a message before closing window&quot;);</span>
<a href="#l139.161"></a><span id="l139.161" class="difflineplus">+    }</span>
<a href="#l139.162"></a><span id="l139.162" class="difflineplus">+    wait_for_window_close(msgc);</span>
<a href="#l139.163"></a><span id="l139.163" class="difflineplus">+    wait_for_window_close(msgcA);</span>
<a href="#l139.164"></a><span id="l139.164" class="difflineplus">+</span>
<a href="#l139.165"></a><span id="l139.165" class="difflineplus">+    if (msgc2.window.closed) {</span>
<a href="#l139.166"></a><span id="l139.166" class="difflineplus">+      throw new Error(&quot;should only have closed the first window&quot;);</span>
<a href="#l139.167"></a><span id="l139.167" class="difflineplus">+    }</span>
<a href="#l139.168"></a><span id="l139.168" class="difflineplus">+</span>
<a href="#l139.169"></a><span id="l139.169" class="difflineplus">+    close_window(msgc2);</span>
<a href="#l139.170"></a><span id="l139.170" class="difflineplus">+</span>
<a href="#l139.171"></a><span id="l139.171" class="difflineplus">+    reset_close_message_on_delete();</span>
<a href="#l139.172"></a><span id="l139.172">   }</span>
<a href="#l139.173"></a><span id="l139.173" class="difflineminus">-  wait_for_window_close(msgc);</span>
<a href="#l139.174"></a><span id="l139.174" class="difflineminus">-  wait_for_window_close(msgcA);</span>
<a href="#l139.175"></a><span id="l139.175" class="difflineminus">-</span>
<a href="#l139.176"></a><span id="l139.176" class="difflineminus">-  if (msgc2.window.closed) {</span>
<a href="#l139.177"></a><span id="l139.177" class="difflineminus">-    throw new Error(&quot;should only have closed the first window&quot;);</span>
<a href="#l139.178"></a><span id="l139.178" class="difflineminus">-  }</span>
<a href="#l139.179"></a><span id="l139.179" class="difflineminus">-</span>
<a href="#l139.180"></a><span id="l139.180" class="difflineminus">-  close_window(msgc2);</span>
<a href="#l139.181"></a><span id="l139.181" class="difflineminus">-</span>
<a href="#l139.182"></a><span id="l139.182" class="difflineminus">-  reset_close_message_on_delete();</span>
<a href="#l139.183"></a><span id="l139.183" class="difflineminus">-}</span>
<a href="#l139.184"></a><span id="l139.184" class="difflineplus">+);</span>
<a href="#l139.185"></a><span id="l139.185"> </span>
<a href="#l139.186"></a><span id="l139.186"> /**</span>
<a href="#l139.187"></a><span id="l139.187">  * Delete a message and check that the message tab is closed</span>
<a href="#l139.188"></a><span id="l139.188">  * where appropriate.</span>
<a href="#l139.189"></a><span id="l139.189">  */</span>
<a href="#l139.190"></a><span id="l139.190" class="difflineminus">-function test_close_message_tab_on_delete_from_message_tab() {</span>
<a href="#l139.191"></a><span id="l139.191" class="difflineplus">+add_task(function test_close_message_tab_on_delete_from_message_tab() {</span>
<a href="#l139.192"></a><span id="l139.192">   set_close_message_on_delete(true);</span>
<a href="#l139.193"></a><span id="l139.193">   be_in_folder(folder);</span>
<a href="#l139.194"></a><span id="l139.194"> </span>
<a href="#l139.195"></a><span id="l139.195">   // select the first message</span>
<a href="#l139.196"></a><span id="l139.196">   select_click_row(0);</span>
<a href="#l139.197"></a><span id="l139.197">   // display it</span>
<a href="#l139.198"></a><span id="l139.198">   let msgc = open_selected_message_in_new_tab(true);</span>
<a href="#l139.199"></a><span id="l139.199"> </span>
<a href="#l139.200"></a><span id="l139.200" class="difflineat">@@ -178,127 +182,140 @@ function test_close_message_tab_on_delet</span>
<a href="#l139.201"></a><span id="l139.201"> </span>
<a href="#l139.202"></a><span id="l139.202">   if (msgc2 != mc.tabmail.tabInfo[1]) {</span>
<a href="#l139.203"></a><span id="l139.203">     throw new Error(&quot;should only have closed the active tab&quot;);</span>
<a href="#l139.204"></a><span id="l139.204">   }</span>
<a href="#l139.205"></a><span id="l139.205"> </span>
<a href="#l139.206"></a><span id="l139.206">   close_tab(msgc2);</span>
<a href="#l139.207"></a><span id="l139.207"> </span>
<a href="#l139.208"></a><span id="l139.208">   reset_close_message_on_delete();</span>
<a href="#l139.209"></a><span id="l139.209" class="difflineminus">-}</span>
<a href="#l139.210"></a><span id="l139.210" class="difflineplus">+});</span>
<a href="#l139.211"></a><span id="l139.211"> </span>
<a href="#l139.212"></a><span id="l139.212"> /**</span>
<a href="#l139.213"></a><span id="l139.213">  * Delete a message when multiple windows are open to the message, and the</span>
<a href="#l139.214"></a><span id="l139.214">  * message is deleted from one of them.</span>
<a href="#l139.215"></a><span id="l139.215">  */</span>
<a href="#l139.216"></a><span id="l139.216" class="difflineminus">-function test_close_multiple_message_tabs_on_delete_from_message_tab() {</span>
<a href="#l139.217"></a><span id="l139.217" class="difflineminus">-  set_close_message_on_delete(true);</span>
<a href="#l139.218"></a><span id="l139.218" class="difflineminus">-  be_in_folder(folder);</span>
<a href="#l139.219"></a><span id="l139.219" class="difflineplus">+add_task(</span>
<a href="#l139.220"></a><span id="l139.220" class="difflineplus">+  function test_close_multiple_message_tabs_on_delete_from_message_tab() {</span>
<a href="#l139.221"></a><span id="l139.221" class="difflineplus">+    set_close_message_on_delete(true);</span>
<a href="#l139.222"></a><span id="l139.222" class="difflineplus">+    be_in_folder(folder);</span>
<a href="#l139.223"></a><span id="l139.223"> </span>
<a href="#l139.224"></a><span id="l139.224" class="difflineminus">-  // select the first message</span>
<a href="#l139.225"></a><span id="l139.225" class="difflineminus">-  select_click_row(0);</span>
<a href="#l139.226"></a><span id="l139.226" class="difflineminus">-  // display it</span>
<a href="#l139.227"></a><span id="l139.227" class="difflineminus">-  let msgc = open_selected_message_in_new_tab(true);</span>
<a href="#l139.228"></a><span id="l139.228" class="difflineminus">-  open_selected_message_in_new_tab(true);</span>
<a href="#l139.229"></a><span id="l139.229" class="difflineplus">+    // select the first message</span>
<a href="#l139.230"></a><span id="l139.230" class="difflineplus">+    select_click_row(0);</span>
<a href="#l139.231"></a><span id="l139.231" class="difflineplus">+    // display it</span>
<a href="#l139.232"></a><span id="l139.232" class="difflineplus">+    let msgc = open_selected_message_in_new_tab(true);</span>
<a href="#l139.233"></a><span id="l139.233" class="difflineplus">+    open_selected_message_in_new_tab(true);</span>
<a href="#l139.234"></a><span id="l139.234"> </span>
<a href="#l139.235"></a><span id="l139.235" class="difflineminus">-  select_click_row(1);</span>
<a href="#l139.236"></a><span id="l139.236" class="difflineminus">-  let msgc2 = open_selected_message_in_new_tab(true);</span>
<a href="#l139.237"></a><span id="l139.237" class="difflineplus">+    select_click_row(1);</span>
<a href="#l139.238"></a><span id="l139.238" class="difflineplus">+    let msgc2 = open_selected_message_in_new_tab(true);</span>
<a href="#l139.239"></a><span id="l139.239"> </span>
<a href="#l139.240"></a><span id="l139.240" class="difflineminus">-  let preCount = folder.getTotalMessages(false);</span>
<a href="#l139.241"></a><span id="l139.241" class="difflineminus">-  switch_tab(msgc);</span>
<a href="#l139.242"></a><span id="l139.242" class="difflineminus">-  press_delete();</span>
<a href="#l139.243"></a><span id="l139.243" class="difflineplus">+    let preCount = folder.getTotalMessages(false);</span>
<a href="#l139.244"></a><span id="l139.244" class="difflineplus">+    switch_tab(msgc);</span>
<a href="#l139.245"></a><span id="l139.245" class="difflineplus">+    press_delete();</span>
<a href="#l139.246"></a><span id="l139.246"> </span>
<a href="#l139.247"></a><span id="l139.247" class="difflineminus">-  if (folder.getTotalMessages(false) != preCount - 1) {</span>
<a href="#l139.248"></a><span id="l139.248" class="difflineminus">-    throw new Error(&quot;didn't delete a message before closing tab&quot;);</span>
<a href="#l139.249"></a><span id="l139.249" class="difflineminus">-  }</span>
<a href="#l139.250"></a><span id="l139.250" class="difflineplus">+    if (folder.getTotalMessages(false) != preCount - 1) {</span>
<a href="#l139.251"></a><span id="l139.251" class="difflineplus">+      throw new Error(&quot;didn't delete a message before closing tab&quot;);</span>
<a href="#l139.252"></a><span id="l139.252" class="difflineplus">+    }</span>
<a href="#l139.253"></a><span id="l139.253" class="difflineplus">+</span>
<a href="#l139.254"></a><span id="l139.254" class="difflineplus">+    assert_number_of_tabs_open(2);</span>
<a href="#l139.255"></a><span id="l139.255"> </span>
<a href="#l139.256"></a><span id="l139.256" class="difflineminus">-  assert_number_of_tabs_open(2);</span>
<a href="#l139.257"></a><span id="l139.257" class="difflineplus">+    if (msgc2 != mc.tabmail.tabInfo[1]) {</span>
<a href="#l139.258"></a><span id="l139.258" class="difflineplus">+      throw new Error(&quot;should only have closed the active tab&quot;);</span>
<a href="#l139.259"></a><span id="l139.259" class="difflineplus">+    }</span>
<a href="#l139.260"></a><span id="l139.260"> </span>
<a href="#l139.261"></a><span id="l139.261" class="difflineminus">-  if (msgc2 != mc.tabmail.tabInfo[1]) {</span>
<a href="#l139.262"></a><span id="l139.262" class="difflineminus">-    throw new Error(&quot;should only have closed the active tab&quot;);</span>
<a href="#l139.263"></a><span id="l139.263" class="difflineplus">+    close_tab(msgc2);</span>
<a href="#l139.264"></a><span id="l139.264" class="difflineplus">+</span>
<a href="#l139.265"></a><span id="l139.265" class="difflineplus">+    reset_close_message_on_delete();</span>
<a href="#l139.266"></a><span id="l139.266">   }</span>
<a href="#l139.267"></a><span id="l139.267" class="difflineminus">-</span>
<a href="#l139.268"></a><span id="l139.268" class="difflineminus">-  close_tab(msgc2);</span>
<a href="#l139.269"></a><span id="l139.269" class="difflineminus">-</span>
<a href="#l139.270"></a><span id="l139.270" class="difflineminus">-  reset_close_message_on_delete();</span>
<a href="#l139.271"></a><span id="l139.271" class="difflineminus">-}</span>
<a href="#l139.272"></a><span id="l139.272" class="difflineplus">+);</span>
<a href="#l139.273"></a><span id="l139.273"> </span>
<a href="#l139.274"></a><span id="l139.274"> /**</span>
<a href="#l139.275"></a><span id="l139.275">  * Delete a message when multiple tabs are open to the message, and the</span>
<a href="#l139.276"></a><span id="l139.276">  * message is deleted from the 3-pane window.</span>
<a href="#l139.277"></a><span id="l139.277">  */</span>
<a href="#l139.278"></a><span id="l139.278" class="difflineminus">-function test_close_multiple_message_tabs_on_delete_from_3pane_window() {</span>
<a href="#l139.279"></a><span id="l139.279" class="difflineminus">-  set_close_message_on_delete(true);</span>
<a href="#l139.280"></a><span id="l139.280" class="difflineminus">-  be_in_folder(folder);</span>
<a href="#l139.281"></a><span id="l139.281" class="difflineplus">+add_task(</span>
<a href="#l139.282"></a><span id="l139.282" class="difflineplus">+  function test_close_multiple_message_tabs_on_delete_from_3pane_window() {</span>
<a href="#l139.283"></a><span id="l139.283" class="difflineplus">+    set_close_message_on_delete(true);</span>
<a href="#l139.284"></a><span id="l139.284" class="difflineplus">+    be_in_folder(folder);</span>
<a href="#l139.285"></a><span id="l139.285"> </span>
<a href="#l139.286"></a><span id="l139.286" class="difflineminus">-  // select the first message</span>
<a href="#l139.287"></a><span id="l139.287" class="difflineminus">-  select_click_row(0);</span>
<a href="#l139.288"></a><span id="l139.288" class="difflineminus">-  // display it</span>
<a href="#l139.289"></a><span id="l139.289" class="difflineminus">-  open_selected_message_in_new_tab(true);</span>
<a href="#l139.290"></a><span id="l139.290" class="difflineminus">-  open_selected_message_in_new_tab(true);</span>
<a href="#l139.291"></a><span id="l139.291" class="difflineplus">+    // select the first message</span>
<a href="#l139.292"></a><span id="l139.292" class="difflineplus">+    select_click_row(0);</span>
<a href="#l139.293"></a><span id="l139.293" class="difflineplus">+    // display it</span>
<a href="#l139.294"></a><span id="l139.294" class="difflineplus">+    open_selected_message_in_new_tab(true);</span>
<a href="#l139.295"></a><span id="l139.295" class="difflineplus">+    open_selected_message_in_new_tab(true);</span>
<a href="#l139.296"></a><span id="l139.296"> </span>
<a href="#l139.297"></a><span id="l139.297" class="difflineminus">-  select_click_row(1);</span>
<a href="#l139.298"></a><span id="l139.298" class="difflineminus">-  let msgc2 = open_selected_message_in_new_tab(true);</span>
<a href="#l139.299"></a><span id="l139.299" class="difflineplus">+    select_click_row(1);</span>
<a href="#l139.300"></a><span id="l139.300" class="difflineplus">+    let msgc2 = open_selected_message_in_new_tab(true);</span>
<a href="#l139.301"></a><span id="l139.301"> </span>
<a href="#l139.302"></a><span id="l139.302" class="difflineminus">-  let preCount = folder.getTotalMessages(false);</span>
<a href="#l139.303"></a><span id="l139.303" class="difflineminus">-  mc.window.focus();</span>
<a href="#l139.304"></a><span id="l139.304" class="difflineminus">-  select_click_row(0);</span>
<a href="#l139.305"></a><span id="l139.305" class="difflineminus">-  press_delete(mc);</span>
<a href="#l139.306"></a><span id="l139.306" class="difflineplus">+    let preCount = folder.getTotalMessages(false);</span>
<a href="#l139.307"></a><span id="l139.307" class="difflineplus">+    mc.window.focus();</span>
<a href="#l139.308"></a><span id="l139.308" class="difflineplus">+    select_click_row(0);</span>
<a href="#l139.309"></a><span id="l139.309" class="difflineplus">+    press_delete(mc);</span>
<a href="#l139.310"></a><span id="l139.310"> </span>
<a href="#l139.311"></a><span id="l139.311" class="difflineminus">-  if (folder.getTotalMessages(false) != preCount - 1) {</span>
<a href="#l139.312"></a><span id="l139.312" class="difflineminus">-    throw new Error(&quot;didn't delete a message before closing window&quot;);</span>
<a href="#l139.313"></a><span id="l139.313" class="difflineminus">-  }</span>
<a href="#l139.314"></a><span id="l139.314" class="difflineplus">+    if (folder.getTotalMessages(false) != preCount - 1) {</span>
<a href="#l139.315"></a><span id="l139.315" class="difflineplus">+      throw new Error(&quot;didn't delete a message before closing window&quot;);</span>
<a href="#l139.316"></a><span id="l139.316" class="difflineplus">+    }</span>
<a href="#l139.317"></a><span id="l139.317"> </span>
<a href="#l139.318"></a><span id="l139.318" class="difflineminus">-  assert_number_of_tabs_open(2);</span>
<a href="#l139.319"></a><span id="l139.319" class="difflineplus">+    assert_number_of_tabs_open(2);</span>
<a href="#l139.320"></a><span id="l139.320"> </span>
<a href="#l139.321"></a><span id="l139.321" class="difflineminus">-  if (msgc2 != mc.tabmail.tabInfo[1]) {</span>
<a href="#l139.322"></a><span id="l139.322" class="difflineminus">-    throw new Error(&quot;should only have closed the active tab&quot;);</span>
<a href="#l139.323"></a><span id="l139.323" class="difflineplus">+    if (msgc2 != mc.tabmail.tabInfo[1]) {</span>
<a href="#l139.324"></a><span id="l139.324" class="difflineplus">+      throw new Error(&quot;should only have closed the active tab&quot;);</span>
<a href="#l139.325"></a><span id="l139.325" class="difflineplus">+    }</span>
<a href="#l139.326"></a><span id="l139.326" class="difflineplus">+</span>
<a href="#l139.327"></a><span id="l139.327" class="difflineplus">+    close_tab(msgc2);</span>
<a href="#l139.328"></a><span id="l139.328" class="difflineplus">+</span>
<a href="#l139.329"></a><span id="l139.329" class="difflineplus">+    reset_close_message_on_delete();</span>
<a href="#l139.330"></a><span id="l139.330">   }</span>
<a href="#l139.331"></a><span id="l139.331" class="difflineminus">-</span>
<a href="#l139.332"></a><span id="l139.332" class="difflineminus">-  close_tab(msgc2);</span>
<a href="#l139.333"></a><span id="l139.333" class="difflineminus">-</span>
<a href="#l139.334"></a><span id="l139.334" class="difflineminus">-  reset_close_message_on_delete();</span>
<a href="#l139.335"></a><span id="l139.335" class="difflineminus">-}</span>
<a href="#l139.336"></a><span id="l139.336" class="difflineplus">+);</span>
<a href="#l139.337"></a><span id="l139.337"> </span>
<a href="#l139.338"></a><span id="l139.338"> /**</span>
<a href="#l139.339"></a><span id="l139.339">  * Delete a message when multiple windows and tabs are open to the message, and</span>
<a href="#l139.340"></a><span id="l139.340">  * the message is deleted from the 3-pane window.</span>
<a href="#l139.341"></a><span id="l139.341">  */</span>
<a href="#l139.342"></a><span id="l139.342" class="difflineminus">-function test_close_multiple_windows_tabs_on_delete_from_3pane_window() {</span>
<a href="#l139.343"></a><span id="l139.343" class="difflineminus">-  set_close_message_on_delete(true);</span>
<a href="#l139.344"></a><span id="l139.344" class="difflineminus">-  be_in_folder(folder);</span>
<a href="#l139.345"></a><span id="l139.345" class="difflineminus">-</span>
<a href="#l139.346"></a><span id="l139.346" class="difflineminus">-  // select the first message</span>
<a href="#l139.347"></a><span id="l139.347" class="difflineminus">-  select_click_row(0);</span>
<a href="#l139.348"></a><span id="l139.348" class="difflineminus">-  // display it</span>
<a href="#l139.349"></a><span id="l139.349" class="difflineminus">-  open_selected_message_in_new_tab(true);</span>
<a href="#l139.350"></a><span id="l139.350" class="difflineminus">-  let msgcA = open_selected_message_in_new_window();</span>
<a href="#l139.351"></a><span id="l139.351" class="difflineplus">+add_task(</span>
<a href="#l139.352"></a><span id="l139.352" class="difflineplus">+  function test_close_multiple_windows_tabs_on_delete_from_3pane_window() {</span>
<a href="#l139.353"></a><span id="l139.353" class="difflineplus">+    set_close_message_on_delete(true);</span>
<a href="#l139.354"></a><span id="l139.354" class="difflineplus">+    be_in_folder(folder);</span>
<a href="#l139.355"></a><span id="l139.355"> </span>
<a href="#l139.356"></a><span id="l139.356" class="difflineminus">-  select_click_row(1);</span>
<a href="#l139.357"></a><span id="l139.357" class="difflineminus">-  let msgc2 = open_selected_message_in_new_tab(true);</span>
<a href="#l139.358"></a><span id="l139.358" class="difflineminus">-  let msgc2A = open_selected_message_in_new_window();</span>
<a href="#l139.359"></a><span id="l139.359" class="difflineplus">+    // select the first message</span>
<a href="#l139.360"></a><span id="l139.360" class="difflineplus">+    select_click_row(0);</span>
<a href="#l139.361"></a><span id="l139.361" class="difflineplus">+    // display it</span>
<a href="#l139.362"></a><span id="l139.362" class="difflineplus">+    open_selected_message_in_new_tab(true);</span>
<a href="#l139.363"></a><span id="l139.363" class="difflineplus">+    let msgcA = open_selected_message_in_new_window();</span>
<a href="#l139.364"></a><span id="l139.364"> </span>
<a href="#l139.365"></a><span id="l139.365" class="difflineminus">-  let preCount = folder.getTotalMessages(false);</span>
<a href="#l139.366"></a><span id="l139.366" class="difflineminus">-  mc.window.focus();</span>
<a href="#l139.367"></a><span id="l139.367" class="difflineminus">-  plan_for_window_close(msgcA);</span>
<a href="#l139.368"></a><span id="l139.368" class="difflineminus">-  select_click_row(0);</span>
<a href="#l139.369"></a><span id="l139.369" class="difflineminus">-  press_delete(mc);</span>
<a href="#l139.370"></a><span id="l139.370" class="difflineplus">+    select_click_row(1);</span>
<a href="#l139.371"></a><span id="l139.371" class="difflineplus">+    let msgc2 = open_selected_message_in_new_tab(true);</span>
<a href="#l139.372"></a><span id="l139.372" class="difflineplus">+    let msgc2A = open_selected_message_in_new_window();</span>
<a href="#l139.373"></a><span id="l139.373" class="difflineplus">+</span>
<a href="#l139.374"></a><span id="l139.374" class="difflineplus">+    let preCount = folder.getTotalMessages(false);</span>
<a href="#l139.375"></a><span id="l139.375" class="difflineplus">+    mc.window.focus();</span>
<a href="#l139.376"></a><span id="l139.376" class="difflineplus">+    plan_for_window_close(msgcA);</span>
<a href="#l139.377"></a><span id="l139.377" class="difflineplus">+    select_click_row(0);</span>
<a href="#l139.378"></a><span id="l139.378" class="difflineplus">+    press_delete(mc);</span>
<a href="#l139.379"></a><span id="l139.379"> </span>
<a href="#l139.380"></a><span id="l139.380" class="difflineminus">-  if (folder.getTotalMessages(false) != preCount - 1) {</span>
<a href="#l139.381"></a><span id="l139.381" class="difflineminus">-    throw new Error(&quot;didn't delete a message before closing window&quot;);</span>
<a href="#l139.382"></a><span id="l139.382" class="difflineminus">-  }</span>
<a href="#l139.383"></a><span id="l139.383" class="difflineminus">-  wait_for_window_close(msgcA);</span>
<a href="#l139.384"></a><span id="l139.384" class="difflineplus">+    if (folder.getTotalMessages(false) != preCount - 1) {</span>
<a href="#l139.385"></a><span id="l139.385" class="difflineplus">+      throw new Error(&quot;didn't delete a message before closing window&quot;);</span>
<a href="#l139.386"></a><span id="l139.386" class="difflineplus">+    }</span>
<a href="#l139.387"></a><span id="l139.387" class="difflineplus">+    wait_for_window_close(msgcA);</span>
<a href="#l139.388"></a><span id="l139.388" class="difflineplus">+</span>
<a href="#l139.389"></a><span id="l139.389" class="difflineplus">+    assert_number_of_tabs_open(2);</span>
<a href="#l139.390"></a><span id="l139.390" class="difflineplus">+</span>
<a href="#l139.391"></a><span id="l139.391" class="difflineplus">+    if (msgc2 != mc.tabmail.tabInfo[1]) {</span>
<a href="#l139.392"></a><span id="l139.392" class="difflineplus">+      throw new Error(&quot;should only have closed the active tab&quot;);</span>
<a href="#l139.393"></a><span id="l139.393" class="difflineplus">+    }</span>
<a href="#l139.394"></a><span id="l139.394"> </span>
<a href="#l139.395"></a><span id="l139.395" class="difflineminus">-  assert_number_of_tabs_open(2);</span>
<a href="#l139.396"></a><span id="l139.396" class="difflineplus">+    if (msgc2A.window.closed) {</span>
<a href="#l139.397"></a><span id="l139.397" class="difflineplus">+      throw new Error(&quot;should only have closed the first window&quot;);</span>
<a href="#l139.398"></a><span id="l139.398" class="difflineplus">+    }</span>
<a href="#l139.399"></a><span id="l139.399" class="difflineplus">+</span>
<a href="#l139.400"></a><span id="l139.400" class="difflineplus">+    close_tab(msgc2);</span>
<a href="#l139.401"></a><span id="l139.401" class="difflineplus">+    close_window(msgc2A);</span>
<a href="#l139.402"></a><span id="l139.402"> </span>
<a href="#l139.403"></a><span id="l139.403" class="difflineminus">-  if (msgc2 != mc.tabmail.tabInfo[1]) {</span>
<a href="#l139.404"></a><span id="l139.404" class="difflineminus">-    throw new Error(&quot;should only have closed the active tab&quot;);</span>
<a href="#l139.405"></a><span id="l139.405" class="difflineplus">+    reset_close_message_on_delete();</span>
<a href="#l139.406"></a><span id="l139.406" class="difflineplus">+</span>
<a href="#l139.407"></a><span id="l139.407" class="difflineplus">+    Assert.report(</span>
<a href="#l139.408"></a><span id="l139.408" class="difflineplus">+      false,</span>
<a href="#l139.409"></a><span id="l139.409" class="difflineplus">+      undefined,</span>
<a href="#l139.410"></a><span id="l139.410" class="difflineplus">+      undefined,</span>
<a href="#l139.411"></a><span id="l139.411" class="difflineplus">+      &quot;Test ran to completion successfully&quot;</span>
<a href="#l139.412"></a><span id="l139.412" class="difflineplus">+    );</span>
<a href="#l139.413"></a><span id="l139.413">   }</span>
<a href="#l139.414"></a><span id="l139.414" class="difflineminus">-</span>
<a href="#l139.415"></a><span id="l139.415" class="difflineminus">-  if (msgc2A.window.closed) {</span>
<a href="#l139.416"></a><span id="l139.416" class="difflineminus">-    throw new Error(&quot;should only have closed the first window&quot;);</span>
<a href="#l139.417"></a><span id="l139.417" class="difflineminus">-  }</span>
<a href="#l139.418"></a><span id="l139.418" class="difflineminus">-</span>
<a href="#l139.419"></a><span id="l139.419" class="difflineminus">-  close_tab(msgc2);</span>
<a href="#l139.420"></a><span id="l139.420" class="difflineminus">-  close_window(msgc2A);</span>
<a href="#l139.421"></a><span id="l139.421" class="difflineminus">-</span>
<a href="#l139.422"></a><span id="l139.422" class="difflineminus">-  reset_close_message_on_delete();</span>
<a href="#l139.423"></a><span id="l139.423" class="difflineminus">-}</span>
<a href="#l139.424"></a><span id="l139.424" class="difflineplus">+);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l140.1"></a><span id="l140.1">copy from mail/test/mozmill/folder-display/test-columns.js</span>
<a href="#l140.2"></a><span id="l140.2">copy to mail/test/browser/folder-display/browser_columns.js</span>
<a href="#l140.3"></a><span id="l140.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-columns.js</span>
<a href="#l140.4"></a><span id="l140.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_columns.js</span>
<a href="#l140.5"></a><span id="l140.5" class="difflineat">@@ -6,17 +6,17 @@</span>
<a href="#l140.6"></a><span id="l140.6">  * Test column default logic and persistence logic.  Persistence comes in both</span>
<a href="#l140.7"></a><span id="l140.7">  *  tab-switching (because of the multiplexed implementation) and</span>
<a href="#l140.8"></a><span id="l140.8">  *  folder-switching forms.</span>
<a href="#l140.9"></a><span id="l140.9">  */</span>
<a href="#l140.10"></a><span id="l140.10"> </span>
<a href="#l140.11"></a><span id="l140.11"> &quot;use strict&quot;;</span>
<a href="#l140.12"></a><span id="l140.12"> </span>
<a href="#l140.13"></a><span id="l140.13"> var elib = ChromeUtils.import(</span>
<a href="#l140.14"></a><span id="l140.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l140.15"></a><span id="l140.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l140.16"></a><span id="l140.16"> );</span>
<a href="#l140.17"></a><span id="l140.17"> </span>
<a href="#l140.18"></a><span id="l140.18"> var {</span>
<a href="#l140.19"></a><span id="l140.19">   be_in_folder,</span>
<a href="#l140.20"></a><span id="l140.20">   close_tab,</span>
<a href="#l140.21"></a><span id="l140.21">   create_folder,</span>
<a href="#l140.22"></a><span id="l140.22">   create_virtual_folder,</span>
<a href="#l140.23"></a><span id="l140.23">   enter_folder,</span>
<a href="#l140.24"></a><span id="l140.24" class="difflineat">@@ -51,17 +51,17 @@ var folderSource, folderParent, folderCh</span>
<a href="#l140.25"></a><span id="l140.25"> var gColumnStateUpdated = false;</span>
<a href="#l140.26"></a><span id="l140.26"> </span>
<a href="#l140.27"></a><span id="l140.27"> var useCorrespondent;</span>
<a href="#l140.28"></a><span id="l140.28"> var INBOX_DEFAULTS;</span>
<a href="#l140.29"></a><span id="l140.29"> var SENT_DEFAULTS;</span>
<a href="#l140.30"></a><span id="l140.30"> var VIRTUAL_DEFAULTS;</span>
<a href="#l140.31"></a><span id="l140.31"> var GLODA_DEFAULTS;</span>
<a href="#l140.32"></a><span id="l140.32"> </span>
<a href="#l140.33"></a><span id="l140.33" class="difflineminus">-function setupModule(module) {</span>
<a href="#l140.34"></a><span id="l140.34" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l140.35"></a><span id="l140.35">   useCorrespondent = Services.prefs.getBoolPref(</span>
<a href="#l140.36"></a><span id="l140.36">     &quot;mail.threadpane.use_correspondents&quot;</span>
<a href="#l140.37"></a><span id="l140.37">   );</span>
<a href="#l140.38"></a><span id="l140.38">   INBOX_DEFAULTS = [</span>
<a href="#l140.39"></a><span id="l140.39">     &quot;threadCol&quot;,</span>
<a href="#l140.40"></a><span id="l140.40">     &quot;flaggedCol&quot;,</span>
<a href="#l140.41"></a><span id="l140.41">     &quot;attachmentCol&quot;,</span>
<a href="#l140.42"></a><span id="l140.42">     &quot;subjectCol&quot;,</span>
<a href="#l140.43"></a><span id="l140.43" class="difflineat">@@ -97,17 +97,17 @@ function setupModule(module) {</span>
<a href="#l140.44"></a><span id="l140.44">     &quot;subjectCol&quot;,</span>
<a href="#l140.45"></a><span id="l140.45">     useCorrespondent ? &quot;correspondentCol&quot; : &quot;senderCol&quot;,</span>
<a href="#l140.46"></a><span id="l140.46">     &quot;dateCol&quot;,</span>
<a href="#l140.47"></a><span id="l140.47">     &quot;locationCol&quot;,</span>
<a href="#l140.48"></a><span id="l140.48">   ];</span>
<a href="#l140.49"></a><span id="l140.49"> </span>
<a href="#l140.50"></a><span id="l140.50">   // create the source</span>
<a href="#l140.51"></a><span id="l140.51">   folderSource = create_folder(&quot;ColumnsApplySource&quot;);</span>
<a href="#l140.52"></a><span id="l140.52" class="difflineminus">-}</span>
<a href="#l140.53"></a><span id="l140.53" class="difflineplus">+});</span>
<a href="#l140.54"></a><span id="l140.54"> </span>
<a href="#l140.55"></a><span id="l140.55"> /**</span>
<a href="#l140.56"></a><span id="l140.56">  * Get the currently visible threadTree columns.</span>
<a href="#l140.57"></a><span id="l140.57">  */</span>
<a href="#l140.58"></a><span id="l140.58"> function get_visible_threadtree_columns() {</span>
<a href="#l140.59"></a><span id="l140.59">   let cols = mc.e(&quot;threadTree&quot;).columns;</span>
<a href="#l140.60"></a><span id="l140.60">   let visibleColumnIds = [];</span>
<a href="#l140.61"></a><span id="l140.61">   for (let col = cols.getFirstColumn(); col != null; col = col.getNext()) {</span>
<a href="#l140.62"></a><span id="l140.62" class="difflineat">@@ -188,55 +188,55 @@ function reorder_column(aColumnId, aBefo</span>
<a href="#l140.63"></a><span id="l140.63">   let col = mc.e(aColumnId);</span>
<a href="#l140.64"></a><span id="l140.64">   let before = mc.e(aBeforeId);</span>
<a href="#l140.65"></a><span id="l140.65">   mc.threadTree._reorderColumn(col, before, true);</span>
<a href="#l140.66"></a><span id="l140.66"> }</span>
<a href="#l140.67"></a><span id="l140.67"> </span>
<a href="#l140.68"></a><span id="l140.68"> /**</span>
<a href="#l140.69"></a><span id="l140.69">  * Make sure we set the proper defaults for an Inbox.</span>
<a href="#l140.70"></a><span id="l140.70">  */</span>
<a href="#l140.71"></a><span id="l140.71" class="difflineminus">-function test_column_defaults_inbox() {</span>
<a href="#l140.72"></a><span id="l140.72" class="difflineplus">+add_task(function test_column_defaults_inbox() {</span>
<a href="#l140.73"></a><span id="l140.73">   // just use the inbox; comes from test-folder-display-helpers</span>
<a href="#l140.74"></a><span id="l140.74">   folderInbox = inboxFolder;</span>
<a href="#l140.75"></a><span id="l140.75">   enter_folder(folderInbox);</span>
<a href="#l140.76"></a><span id="l140.76">   assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l140.77"></a><span id="l140.77" class="difflineminus">-}</span>
<a href="#l140.78"></a><span id="l140.78" class="difflineplus">+});</span>
<a href="#l140.79"></a><span id="l140.79"> </span>
<a href="#l140.80"></a><span id="l140.80"> /**</span>
<a href="#l140.81"></a><span id="l140.81">  * Make sure we set the proper defaults for a Sent folder.</span>
<a href="#l140.82"></a><span id="l140.82">  */</span>
<a href="#l140.83"></a><span id="l140.83" class="difflineminus">-function test_column_defaults_sent() {</span>
<a href="#l140.84"></a><span id="l140.84" class="difflineplus">+add_task(function test_column_defaults_sent() {</span>
<a href="#l140.85"></a><span id="l140.85">   folderSent = create_folder(&quot;ColumnsSent&quot;);</span>
<a href="#l140.86"></a><span id="l140.86">   folderSent.setFlag(Ci.nsMsgFolderFlags.SentMail);</span>
<a href="#l140.87"></a><span id="l140.87"> </span>
<a href="#l140.88"></a><span id="l140.88">   be_in_folder(folderSent);</span>
<a href="#l140.89"></a><span id="l140.89">   assert_visible_columns(SENT_DEFAULTS);</span>
<a href="#l140.90"></a><span id="l140.90" class="difflineminus">-}</span>
<a href="#l140.91"></a><span id="l140.91" class="difflineplus">+});</span>
<a href="#l140.92"></a><span id="l140.92"> </span>
<a href="#l140.93"></a><span id="l140.93"> /**</span>
<a href="#l140.94"></a><span id="l140.94">  * Make sure we set the proper defaults for a multi-folder virtual folder.</span>
<a href="#l140.95"></a><span id="l140.95">  */</span>
<a href="#l140.96"></a><span id="l140.96" class="difflineminus">-function test_column_defaults_cross_folder_virtual_folder() {</span>
<a href="#l140.97"></a><span id="l140.97" class="difflineplus">+add_task(function test_column_defaults_cross_folder_virtual_folder() {</span>
<a href="#l140.98"></a><span id="l140.98">   folderVirtual = create_virtual_folder(</span>
<a href="#l140.99"></a><span id="l140.99">     [folderInbox, folderSent],</span>
<a href="#l140.100"></a><span id="l140.100">     {},</span>
<a href="#l140.101"></a><span id="l140.101">     true,</span>
<a href="#l140.102"></a><span id="l140.102">     &quot;ColumnsVirtual&quot;</span>
<a href="#l140.103"></a><span id="l140.103">   );</span>
<a href="#l140.104"></a><span id="l140.104"> </span>
<a href="#l140.105"></a><span id="l140.105">   be_in_folder(folderVirtual);</span>
<a href="#l140.106"></a><span id="l140.106">   assert_visible_columns(VIRTUAL_DEFAULTS);</span>
<a href="#l140.107"></a><span id="l140.107" class="difflineminus">-}</span>
<a href="#l140.108"></a><span id="l140.108" class="difflineplus">+});</span>
<a href="#l140.109"></a><span id="l140.109"> </span>
<a href="#l140.110"></a><span id="l140.110"> /**</span>
<a href="#l140.111"></a><span id="l140.111">  * Make sure that we initialize our columns from the inbox and that they persist</span>
<a href="#l140.112"></a><span id="l140.112">  *  after that and don't follow the inbox.  This also does a good workout of the</span>
<a href="#l140.113"></a><span id="l140.113">  *  persistence logic.</span>
<a href="#l140.114"></a><span id="l140.114">  */</span>
<a href="#l140.115"></a><span id="l140.115" class="difflineminus">-function test_column_defaults_inherit_from_inbox() {</span>
<a href="#l140.116"></a><span id="l140.116" class="difflineplus">+add_task(function test_column_defaults_inherit_from_inbox() {</span>
<a href="#l140.117"></a><span id="l140.117">   folderA = create_folder(&quot;ColumnsA&quot;);</span>
<a href="#l140.118"></a><span id="l140.118">   // - the folder should inherit from the inbox...</span>
<a href="#l140.119"></a><span id="l140.119">   be_in_folder(folderA);</span>
<a href="#l140.120"></a><span id="l140.120">   assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l140.121"></a><span id="l140.121"> </span>
<a href="#l140.122"></a><span id="l140.122">   // - if we go back to the inbox and change things then the folder's settings</span>
<a href="#l140.123"></a><span id="l140.123">   //  should not change.</span>
<a href="#l140.124"></a><span id="l140.124">   be_in_folder(folderInbox);</span>
<a href="#l140.125"></a><span id="l140.125" class="difflineat">@@ -260,22 +260,22 @@ function test_column_defaults_inherit_fr</span>
<a href="#l140.126"></a><span id="l140.126">   // - and if we restore the inbox, folder B should stay modified too.</span>
<a href="#l140.127"></a><span id="l140.127">   be_in_folder(folderInbox);</span>
<a href="#l140.128"></a><span id="l140.128">   show_column(&quot;dateCol&quot;);</span>
<a href="#l140.129"></a><span id="l140.129">   hide_column(&quot;tagsCol&quot;);</span>
<a href="#l140.130"></a><span id="l140.130">   assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l140.131"></a><span id="l140.131"> </span>
<a href="#l140.132"></a><span id="l140.132">   be_in_folder(folderB);</span>
<a href="#l140.133"></a><span id="l140.133">   assert_visible_columns(columnsB);</span>
<a href="#l140.134"></a><span id="l140.134" class="difflineminus">-}</span>
<a href="#l140.135"></a><span id="l140.135" class="difflineplus">+});</span>
<a href="#l140.136"></a><span id="l140.136"> </span>
<a href="#l140.137"></a><span id="l140.137"> /**</span>
<a href="#l140.138"></a><span id="l140.138">  * Make sure that when we change tabs that things persist/restore correctly.</span>
<a href="#l140.139"></a><span id="l140.139">  */</span>
<a href="#l140.140"></a><span id="l140.140" class="difflineminus">-function test_column_visibility_persists_through_tab_changes() {</span>
<a href="#l140.141"></a><span id="l140.141" class="difflineplus">+add_task(function test_column_visibility_persists_through_tab_changes() {</span>
<a href="#l140.142"></a><span id="l140.142">   let tabA = be_in_folder(folderA);</span>
<a href="#l140.143"></a><span id="l140.143">   assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l140.144"></a><span id="l140.144"> </span>
<a href="#l140.145"></a><span id="l140.145">   let tabB = open_folder_in_new_tab(folderB);</span>
<a href="#l140.146"></a><span id="l140.146">   assert_visible_columns(columnsB);</span>
<a href="#l140.147"></a><span id="l140.147"> </span>
<a href="#l140.148"></a><span id="l140.148">   // - switch back and forth among the loaded and verify</span>
<a href="#l140.149"></a><span id="l140.149">   switch_tab(tabA);</span>
<a href="#l140.150"></a><span id="l140.150" class="difflineat">@@ -306,22 +306,22 @@ function test_column_visibility_persists</span>
<a href="#l140.151"></a><span id="l140.151"> </span>
<a href="#l140.152"></a><span id="l140.152">   switch_tab(tabA);</span>
<a href="#l140.153"></a><span id="l140.153">   assert_visible_columns(aSansJunk);</span>
<a href="#l140.154"></a><span id="l140.154">   // A goes back to &quot;normal&quot;</span>
<a href="#l140.155"></a><span id="l140.155">   show_column(&quot;junkStatusCol&quot;);</span>
<a href="#l140.156"></a><span id="l140.156">   assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l140.157"></a><span id="l140.157"> </span>
<a href="#l140.158"></a><span id="l140.158">   close_tab(tabB);</span>
<a href="#l140.159"></a><span id="l140.159" class="difflineminus">-}</span>
<a href="#l140.160"></a><span id="l140.160" class="difflineplus">+});</span>
<a href="#l140.161"></a><span id="l140.161"> </span>
<a href="#l140.162"></a><span id="l140.162"> /**</span>
<a href="#l140.163"></a><span id="l140.163">  * Make sure that when we change folders that things persist/restore correctly.</span>
<a href="#l140.164"></a><span id="l140.164">  */</span>
<a href="#l140.165"></a><span id="l140.165" class="difflineminus">-function test_column_visibility_persists_through_folder_changes() {</span>
<a href="#l140.166"></a><span id="l140.166" class="difflineplus">+add_task(function test_column_visibility_persists_through_folder_changes() {</span>
<a href="#l140.167"></a><span id="l140.167">   be_in_folder(folderA);</span>
<a href="#l140.168"></a><span id="l140.168">   assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l140.169"></a><span id="l140.169"> </span>
<a href="#l140.170"></a><span id="l140.170">   // more for A</span>
<a href="#l140.171"></a><span id="l140.171">   let aWithExtra = INBOX_DEFAULTS.concat([&quot;sizeCol&quot;, &quot;tagsCol&quot;]);</span>
<a href="#l140.172"></a><span id="l140.172">   show_column(&quot;sizeCol&quot;);</span>
<a href="#l140.173"></a><span id="l140.173">   show_column(&quot;tagsCol&quot;);</span>
<a href="#l140.174"></a><span id="l140.174">   assert_visible_columns(aWithExtra);</span>
<a href="#l140.175"></a><span id="l140.175" class="difflineat">@@ -352,22 +352,22 @@ function test_column_visibility_persists</span>
<a href="#l140.176"></a><span id="l140.176"> </span>
<a href="#l140.177"></a><span id="l140.177">   // check B</span>
<a href="#l140.178"></a><span id="l140.178">   be_in_folder(folderB);</span>
<a href="#l140.179"></a><span id="l140.179">   assert_visible_columns(columnsB);</span>
<a href="#l140.180"></a><span id="l140.180"> </span>
<a href="#l140.181"></a><span id="l140.181">   // check A</span>
<a href="#l140.182"></a><span id="l140.182">   be_in_folder(folderA);</span>
<a href="#l140.183"></a><span id="l140.183">   assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l140.184"></a><span id="l140.184" class="difflineminus">-}</span>
<a href="#l140.185"></a><span id="l140.185" class="difflineplus">+});</span>
<a href="#l140.186"></a><span id="l140.186"> </span>
<a href="#l140.187"></a><span id="l140.187"> /**</span>
<a href="#l140.188"></a><span id="l140.188">  * Test that reordering persists through tab changes and folder changes.</span>
<a href="#l140.189"></a><span id="l140.189">  */</span>
<a href="#l140.190"></a><span id="l140.190" class="difflineminus">-function test_column_reordering_persists() {</span>
<a href="#l140.191"></a><span id="l140.191" class="difflineplus">+add_task(function test_column_reordering_persists() {</span>
<a href="#l140.192"></a><span id="l140.192">   let tabA = be_in_folder(folderA);</span>
<a href="#l140.193"></a><span id="l140.193">   let tabB = open_folder_in_new_tab(folderB);</span>
<a href="#l140.194"></a><span id="l140.194"> </span>
<a href="#l140.195"></a><span id="l140.195">   // put correspondent/sender before subject</span>
<a href="#l140.196"></a><span id="l140.196">   reorder_column(</span>
<a href="#l140.197"></a><span id="l140.197">     useCorrespondent ? &quot;correspondentCol&quot; : &quot;senderCol&quot;,</span>
<a href="#l140.198"></a><span id="l140.198">     &quot;subjectCol&quot;</span>
<a href="#l140.199"></a><span id="l140.199">   );</span>
<a href="#l140.200"></a><span id="l140.200" class="difflineat">@@ -384,17 +384,17 @@ function test_column_reordering_persists</span>
<a href="#l140.201"></a><span id="l140.201"> </span>
<a href="#l140.202"></a><span id="l140.202">   be_in_folder(folderInbox);</span>
<a href="#l140.203"></a><span id="l140.203">   assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l140.204"></a><span id="l140.204"> </span>
<a href="#l140.205"></a><span id="l140.205">   be_in_folder(folderB);</span>
<a href="#l140.206"></a><span id="l140.206">   assert_visible_columns(reorderdB);</span>
<a href="#l140.207"></a><span id="l140.207"> </span>
<a href="#l140.208"></a><span id="l140.208">   close_tab(tabB);</span>
<a href="#l140.209"></a><span id="l140.209" class="difflineminus">-}</span>
<a href="#l140.210"></a><span id="l140.210" class="difflineplus">+});</span>
<a href="#l140.211"></a><span id="l140.211"> </span>
<a href="#l140.212"></a><span id="l140.212"> function invoke_column_picker_option(aActions) {</span>
<a href="#l140.213"></a><span id="l140.213">   // The treecolpicker element itself doesn't have an id, so we have to walk</span>
<a href="#l140.214"></a><span id="l140.214">   // down from the parent to find it.</span>
<a href="#l140.215"></a><span id="l140.215">   //  treadCols</span>
<a href="#l140.216"></a><span id="l140.216">   //   |- hbox                item 0</span>
<a href="#l140.217"></a><span id="l140.217">   //   |- treecolpicker   &lt;-- item 1 this is the one we want</span>
<a href="#l140.218"></a><span id="l140.218">   let threadCols = mc.window.document.getElementById(&quot;threadCols&quot;);</span>
<a href="#l140.219"></a><span id="l140.219" class="difflineat">@@ -404,28 +404,28 @@ function invoke_column_picker_option(aAc</span>
<a href="#l140.220"></a><span id="l140.220">   mc.click(new elib.Elem(colPicker));</span>
<a href="#l140.221"></a><span id="l140.221">   mc.click_menus_in_sequence(colPickerPopup, aActions);</span>
<a href="#l140.222"></a><span id="l140.222"> }</span>
<a href="#l140.223"></a><span id="l140.223"> </span>
<a href="#l140.224"></a><span id="l140.224"> /**</span>
<a href="#l140.225"></a><span id="l140.225">  * The column picker's &quot;reset columns to default&quot; option should set our state</span>
<a href="#l140.226"></a><span id="l140.226">  *  back to the natural state.</span>
<a href="#l140.227"></a><span id="l140.227">  */</span>
<a href="#l140.228"></a><span id="l140.228" class="difflineminus">-function test_reset_to_inbox() {</span>
<a href="#l140.229"></a><span id="l140.229" class="difflineplus">+add_task(function test_reset_to_inbox() {</span>
<a href="#l140.230"></a><span id="l140.230">   // it better have INBOX defaults</span>
<a href="#l140.231"></a><span id="l140.231">   assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l140.232"></a><span id="l140.232"> </span>
<a href="#l140.233"></a><span id="l140.233">   // permute them</span>
<a href="#l140.234"></a><span id="l140.234">   let conExtra = INBOX_DEFAULTS.concat([&quot;sizeCol&quot;]);</span>
<a href="#l140.235"></a><span id="l140.235">   show_column(&quot;sizeCol&quot;);</span>
<a href="#l140.236"></a><span id="l140.236">   assert_visible_columns(conExtra);</span>
<a href="#l140.237"></a><span id="l140.237"> </span>
<a href="#l140.238"></a><span id="l140.238">   // reset!</span>
<a href="#l140.239"></a><span id="l140.239">   invoke_column_picker_option([{ anonid: &quot;menuitem&quot; }]);</span>
<a href="#l140.240"></a><span id="l140.240" class="difflineminus">-}</span>
<a href="#l140.241"></a><span id="l140.241" class="difflineplus">+});</span>
<a href="#l140.242"></a><span id="l140.242"> </span>
<a href="#l140.243"></a><span id="l140.243"> function subtest_say_yes(cwc) {</span>
<a href="#l140.244"></a><span id="l140.244">   cwc.window.document.documentElement.getButton(&quot;accept&quot;).doCommand();</span>
<a href="#l140.245"></a><span id="l140.245"> }</span>
<a href="#l140.246"></a><span id="l140.246"> </span>
<a href="#l140.247"></a><span id="l140.247"> function _apply_to_folder_common(aChildrenToo, folder) {</span>
<a href="#l140.248"></a><span id="l140.248">   if (aChildrenToo) {</span>
<a href="#l140.249"></a><span id="l140.249">     plan_for_observable_event(&quot;msg-folder-columns-propagated&quot;);</span>
<a href="#l140.250"></a><span id="l140.250" class="difflineat">@@ -447,17 +447,17 @@ function _apply_to_folder_common(aChildr</span>
<a href="#l140.251"></a><span id="l140.251">     wait_for_observable_event(&quot;msg-folder-columns-propagated&quot;);</span>
<a href="#l140.252"></a><span id="l140.252">   }</span>
<a href="#l140.253"></a><span id="l140.253"> }</span>
<a href="#l140.254"></a><span id="l140.254"> </span>
<a href="#l140.255"></a><span id="l140.255"> /**</span>
<a href="#l140.256"></a><span id="l140.256">  * Change settings in a folder, apply them to another folder that also has</span>
<a href="#l140.257"></a><span id="l140.257">  *  children.  Make sure the folder changes but the children do not.</span>
<a href="#l140.258"></a><span id="l140.258">  */</span>
<a href="#l140.259"></a><span id="l140.259" class="difflineminus">-function test_apply_to_folder_no_children() {</span>
<a href="#l140.260"></a><span id="l140.260" class="difflineplus">+add_task(function test_apply_to_folder_no_children() {</span>
<a href="#l140.261"></a><span id="l140.261">   folderParent = create_folder(&quot;ColumnsApplyParent&quot;);</span>
<a href="#l140.262"></a><span id="l140.262">   folderParent.createSubfolder(&quot;Child1&quot;, null);</span>
<a href="#l140.263"></a><span id="l140.263">   folderChild1 = folderParent.getChildNamed(&quot;Child1&quot;);</span>
<a href="#l140.264"></a><span id="l140.264">   folderParent.createSubfolder(&quot;Child2&quot;, null);</span>
<a href="#l140.265"></a><span id="l140.265">   folderChild2 = folderParent.getChildNamed(&quot;Child2&quot;);</span>
<a href="#l140.266"></a><span id="l140.266"> </span>
<a href="#l140.267"></a><span id="l140.267">   be_in_folder(folderSource);</span>
<a href="#l140.268"></a><span id="l140.268"> </span>
<a href="#l140.269"></a><span id="l140.269" class="difflineat">@@ -476,23 +476,23 @@ function test_apply_to_folder_no_childre</span>
<a href="#l140.270"></a><span id="l140.270">   be_in_folder(folderParent);</span>
<a href="#l140.271"></a><span id="l140.271">   assert_visible_columns(conExtra);</span>
<a href="#l140.272"></a><span id="l140.272"> </span>
<a href="#l140.273"></a><span id="l140.273">   // but not the children</span>
<a href="#l140.274"></a><span id="l140.274">   be_in_folder(folderChild1);</span>
<a href="#l140.275"></a><span id="l140.275">   assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l140.276"></a><span id="l140.276">   be_in_folder(folderChild2);</span>
<a href="#l140.277"></a><span id="l140.277">   assert_visible_columns(INBOX_DEFAULTS);</span>
<a href="#l140.278"></a><span id="l140.278" class="difflineminus">-}</span>
<a href="#l140.279"></a><span id="l140.279" class="difflineplus">+});</span>
<a href="#l140.280"></a><span id="l140.280"> </span>
<a href="#l140.281"></a><span id="l140.281"> /**</span>
<a href="#l140.282"></a><span id="l140.282">  * Change settings in a folder, apply them to another folder and its children.</span>
<a href="#l140.283"></a><span id="l140.283">  *  Make sure the folder and its children change.</span>
<a href="#l140.284"></a><span id="l140.284">  */</span>
<a href="#l140.285"></a><span id="l140.285" class="difflineminus">-function test_apply_to_folder_and_children() {</span>
<a href="#l140.286"></a><span id="l140.286" class="difflineplus">+add_task(function test_apply_to_folder_and_children() {</span>
<a href="#l140.287"></a><span id="l140.287">   // no need to throttle ourselves during testing.</span>
<a href="#l140.288"></a><span id="l140.288">   MailUtils.INTER_FOLDER_PROCESSING_DELAY_MS = 0;</span>
<a href="#l140.289"></a><span id="l140.289"> </span>
<a href="#l140.290"></a><span id="l140.290">   be_in_folder(folderSource);</span>
<a href="#l140.291"></a><span id="l140.291"> </span>
<a href="#l140.292"></a><span id="l140.292">   invoke_column_picker_option([{ anonid: &quot;menuitem&quot; }]); // reset order!</span>
<a href="#l140.293"></a><span id="l140.293">   let cols = get_visible_threadtree_columns();</span>
<a href="#l140.294"></a><span id="l140.294"> </span>
<a href="#l140.295"></a><span id="l140.295" class="difflineat">@@ -506,23 +506,23 @@ function test_apply_to_folder_and_childr</span>
<a href="#l140.296"></a><span id="l140.296"> </span>
<a href="#l140.297"></a><span id="l140.297">   // make sure it copied to the parent and his children</span>
<a href="#l140.298"></a><span id="l140.298">   be_in_folder(folderParent);</span>
<a href="#l140.299"></a><span id="l140.299">   assert_visible_columns(conExtra);</span>
<a href="#l140.300"></a><span id="l140.300">   be_in_folder(folderChild1);</span>
<a href="#l140.301"></a><span id="l140.301">   assert_visible_columns(conExtra);</span>
<a href="#l140.302"></a><span id="l140.302">   be_in_folder(folderChild2);</span>
<a href="#l140.303"></a><span id="l140.303">   assert_visible_columns(conExtra);</span>
<a href="#l140.304"></a><span id="l140.304" class="difflineminus">-}</span>
<a href="#l140.305"></a><span id="l140.305" class="difflineplus">+});</span>
<a href="#l140.306"></a><span id="l140.306"> </span>
<a href="#l140.307"></a><span id="l140.307"> /**</span>
<a href="#l140.308"></a><span id="l140.308">  * Change settings in an incoming folder, apply them to an outgoing folder that</span>
<a href="#l140.309"></a><span id="l140.309">  * also has children. Make sure the folder changes but the children do not.</span>
<a href="#l140.310"></a><span id="l140.310">  */</span>
<a href="#l140.311"></a><span id="l140.311" class="difflineminus">-function test_apply_to_folder_no_children_swapped() {</span>
<a href="#l140.312"></a><span id="l140.312" class="difflineplus">+add_task(function test_apply_to_folder_no_children_swapped() {</span>
<a href="#l140.313"></a><span id="l140.313">   folderParent = create_folder(&quot;ColumnsApplyParentOutgoing&quot;);</span>
<a href="#l140.314"></a><span id="l140.314">   folderParent.setFlag(Ci.nsMsgFolderFlags.SentMail);</span>
<a href="#l140.315"></a><span id="l140.315">   folderParent.createSubfolder(&quot;Child1&quot;, null);</span>
<a href="#l140.316"></a><span id="l140.316">   folderChild1 = folderParent.getChildNamed(&quot;Child1&quot;);</span>
<a href="#l140.317"></a><span id="l140.317">   folderParent.createSubfolder(&quot;Child2&quot;, null);</span>
<a href="#l140.318"></a><span id="l140.318">   folderChild2 = folderParent.getChildNamed(&quot;Child2&quot;);</span>
<a href="#l140.319"></a><span id="l140.319"> </span>
<a href="#l140.320"></a><span id="l140.320">   be_in_folder(folderSource);</span>
<a href="#l140.321"></a><span id="l140.321" class="difflineat">@@ -555,23 +555,23 @@ function test_apply_to_folder_no_childre</span>
<a href="#l140.322"></a><span id="l140.322">   be_in_folder(folderParent);</span>
<a href="#l140.323"></a><span id="l140.323">   assert_visible_columns(conExtraSwapped);</span>
<a href="#l140.324"></a><span id="l140.324"> </span>
<a href="#l140.325"></a><span id="l140.325">   // But not the children.</span>
<a href="#l140.326"></a><span id="l140.326">   be_in_folder(folderChild1);</span>
<a href="#l140.327"></a><span id="l140.327">   assert_visible_columns(SENT_DEFAULTS);</span>
<a href="#l140.328"></a><span id="l140.328">   be_in_folder(folderChild2);</span>
<a href="#l140.329"></a><span id="l140.329">   assert_visible_columns(SENT_DEFAULTS);</span>
<a href="#l140.330"></a><span id="l140.330" class="difflineminus">-}</span>
<a href="#l140.331"></a><span id="l140.331" class="difflineplus">+});</span>
<a href="#l140.332"></a><span id="l140.332"> </span>
<a href="#l140.333"></a><span id="l140.333"> /**</span>
<a href="#l140.334"></a><span id="l140.334">  * Change settings in an incoming folder, apply them to an outgoing folder and</span>
<a href="#l140.335"></a><span id="l140.335">  * its children. Make sure the folder and its children change.</span>
<a href="#l140.336"></a><span id="l140.336">  */</span>
<a href="#l140.337"></a><span id="l140.337" class="difflineminus">-function test_apply_to_folder_and_children_swapped() {</span>
<a href="#l140.338"></a><span id="l140.338" class="difflineplus">+add_task(function test_apply_to_folder_and_children_swapped() {</span>
<a href="#l140.339"></a><span id="l140.339">   // No need to throttle ourselves during testing.</span>
<a href="#l140.340"></a><span id="l140.340">   MailUtils.INTER_FOLDER_PROCESSING_DELAY_MS = 0;</span>
<a href="#l140.341"></a><span id="l140.341"> </span>
<a href="#l140.342"></a><span id="l140.342">   be_in_folder(folderSource);</span>
<a href="#l140.343"></a><span id="l140.343"> </span>
<a href="#l140.344"></a><span id="l140.344">   invoke_column_picker_option([{ anonid: &quot;menuitem&quot; }]); // reset order!</span>
<a href="#l140.345"></a><span id="l140.345"> </span>
<a href="#l140.346"></a><span id="l140.346">   // permute!</span>
<a href="#l140.347"></a><span id="l140.347" class="difflineat">@@ -594,17 +594,17 @@ function test_apply_to_folder_and_childr</span>
<a href="#l140.348"></a><span id="l140.348">   let conExtraSwapped = [...SENT_DEFAULTS];</span>
<a href="#l140.349"></a><span id="l140.349">   conExtraSwapped[5] = useCorrespondent ? &quot;recipientCol&quot; : &quot;correspondentCol&quot;;</span>
<a href="#l140.350"></a><span id="l140.350">   be_in_folder(folderParent);</span>
<a href="#l140.351"></a><span id="l140.351">   assert_visible_columns(conExtraSwapped);</span>
<a href="#l140.352"></a><span id="l140.352">   be_in_folder(folderChild1);</span>
<a href="#l140.353"></a><span id="l140.353">   assert_visible_columns(conExtraSwapped);</span>
<a href="#l140.354"></a><span id="l140.354">   be_in_folder(folderChild2);</span>
<a href="#l140.355"></a><span id="l140.355">   assert_visible_columns(conExtraSwapped);</span>
<a href="#l140.356"></a><span id="l140.356" class="difflineminus">-}</span>
<a href="#l140.357"></a><span id="l140.357" class="difflineplus">+});</span>
<a href="#l140.358"></a><span id="l140.358"> </span>
<a href="#l140.359"></a><span id="l140.359"> /**</span>
<a href="#l140.360"></a><span id="l140.360">  * Create a fake gloda collection.</span>
<a href="#l140.361"></a><span id="l140.361">  */</span>
<a href="#l140.362"></a><span id="l140.362"> function FakeCollection() {</span>
<a href="#l140.363"></a><span id="l140.363">   this.items = [];</span>
<a href="#l140.364"></a><span id="l140.364"> }</span>
<a href="#l140.365"></a><span id="l140.365"> </span>
<a href="#l140.366"></a><span id="l140.366" class="difflineat">@@ -620,24 +620,24 @@ function wait_for_columns_state_updated(</span>
<a href="#l140.367"></a><span id="l140.367">   Services.prefs.addObserver(STATE_PREF, columns_state_updated);</span>
<a href="#l140.368"></a><span id="l140.368">   mc.waitFor(</span>
<a href="#l140.369"></a><span id="l140.369">     () =&gt; gColumnStateUpdated,</span>
<a href="#l140.370"></a><span id="l140.370">     &quot;Timeout waiting for columns state updated.&quot;</span>
<a href="#l140.371"></a><span id="l140.371">   );</span>
<a href="#l140.372"></a><span id="l140.372">   Services.prefs.removeObserver(STATE_PREF, columns_state_updated);</span>
<a href="#l140.373"></a><span id="l140.373"> }</span>
<a href="#l140.374"></a><span id="l140.374"> </span>
<a href="#l140.375"></a><span id="l140.375" class="difflineminus">-function test_column_defaults_gloda_collection() {</span>
<a href="#l140.376"></a><span id="l140.376" class="difflineplus">+add_task(function test_column_defaults_gloda_collection() {</span>
<a href="#l140.377"></a><span id="l140.377">   let fakeCollection = new FakeCollection();</span>
<a href="#l140.378"></a><span id="l140.378">   mc.tabmail.openTab(&quot;glodaList&quot;, { collection: fakeCollection });</span>
<a href="#l140.379"></a><span id="l140.379">   wait_for_all_messages_to_load();</span>
<a href="#l140.380"></a><span id="l140.380">   assert_visible_columns(GLODA_DEFAULTS);</span>
<a href="#l140.381"></a><span id="l140.381" class="difflineminus">-}</span>
<a href="#l140.382"></a><span id="l140.382" class="difflineplus">+});</span>
<a href="#l140.383"></a><span id="l140.383"> </span>
<a href="#l140.384"></a><span id="l140.384" class="difflineminus">-function test_persist_columns_gloda_collection() {</span>
<a href="#l140.385"></a><span id="l140.385" class="difflineplus">+add_task(function test_persist_columns_gloda_collection() {</span>
<a href="#l140.386"></a><span id="l140.386">   let fakeCollection = new FakeCollection();</span>
<a href="#l140.387"></a><span id="l140.387">   mc.tabmail.openTab(&quot;glodaList&quot;, { collection: fakeCollection });</span>
<a href="#l140.388"></a><span id="l140.388">   wait_for_all_messages_to_load();</span>
<a href="#l140.389"></a><span id="l140.389"> </span>
<a href="#l140.390"></a><span id="l140.390">   plan_for_columns_state_update();</span>
<a href="#l140.391"></a><span id="l140.391">   hide_column(&quot;locationCol&quot;);</span>
<a href="#l140.392"></a><span id="l140.392">   wait_for_columns_state_updated();</span>
<a href="#l140.393"></a><span id="l140.393"> </span>
<a href="#l140.394"></a><span id="l140.394" class="difflineat">@@ -646,29 +646,36 @@ function test_persist_columns_gloda_coll</span>
<a href="#l140.395"></a><span id="l140.395">   wait_for_columns_state_updated();</span>
<a href="#l140.396"></a><span id="l140.396"> </span>
<a href="#l140.397"></a><span id="l140.397">   glodaColumns = GLODA_DEFAULTS.slice(0, -1);</span>
<a href="#l140.398"></a><span id="l140.398">   glodaColumns.push(&quot;accountCol&quot;);</span>
<a href="#l140.399"></a><span id="l140.399"> </span>
<a href="#l140.400"></a><span id="l140.400">   mc.tabmail.openTab(&quot;glodaList&quot;, { collection: fakeCollection });</span>
<a href="#l140.401"></a><span id="l140.401">   wait_for_all_messages_to_load();</span>
<a href="#l140.402"></a><span id="l140.402">   assert_visible_columns(glodaColumns);</span>
<a href="#l140.403"></a><span id="l140.403" class="difflineminus">-}</span>
<a href="#l140.404"></a><span id="l140.404" class="difflineplus">+});</span>
<a href="#l140.405"></a><span id="l140.405"> </span>
<a href="#l140.406"></a><span id="l140.406" class="difflineminus">-function test_reset_columns_gloda_collection() {</span>
<a href="#l140.407"></a><span id="l140.407" class="difflineplus">+add_task(function test_reset_columns_gloda_collection() {</span>
<a href="#l140.408"></a><span id="l140.408">   let fakeCollection = new FakeCollection();</span>
<a href="#l140.409"></a><span id="l140.409">   mc.tabmail.openTab(&quot;glodaList&quot;, { collection: fakeCollection });</span>
<a href="#l140.410"></a><span id="l140.410">   wait_for_all_messages_to_load();</span>
<a href="#l140.411"></a><span id="l140.411">   assert_visible_columns(glodaColumns);</span>
<a href="#l140.412"></a><span id="l140.412"> </span>
<a href="#l140.413"></a><span id="l140.413">   invoke_column_picker_option([{ anonid: &quot;menuitem&quot; }]); // reset!</span>
<a href="#l140.414"></a><span id="l140.414">   assert_visible_columns(glodaColumns); // same, only order (would be) reset</span>
<a href="#l140.415"></a><span id="l140.415"> </span>
<a href="#l140.416"></a><span id="l140.416">   mc.tabmail.openTab(&quot;glodaList&quot;, { collection: fakeCollection });</span>
<a href="#l140.417"></a><span id="l140.417">   wait_for_all_messages_to_load();</span>
<a href="#l140.418"></a><span id="l140.418">   assert_visible_columns(glodaColumns);</span>
<a href="#l140.419"></a><span id="l140.419" class="difflineminus">-}</span>
<a href="#l140.420"></a><span id="l140.420" class="difflineplus">+});</span>
<a href="#l140.421"></a><span id="l140.421"> </span>
<a href="#l140.422"></a><span id="l140.422" class="difflineminus">-function teardownModule() {</span>
<a href="#l140.423"></a><span id="l140.423" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l140.424"></a><span id="l140.424">   while (mc.tabmail.tabInfo.length &gt; 1) {</span>
<a href="#l140.425"></a><span id="l140.425">     mc.tabmail.closeTab(1);</span>
<a href="#l140.426"></a><span id="l140.426">   }</span>
<a href="#l140.427"></a><span id="l140.427" class="difflineminus">-}</span>
<a href="#l140.428"></a><span id="l140.428" class="difflineplus">+</span>
<a href="#l140.429"></a><span id="l140.429" class="difflineplus">+  Assert.report(</span>
<a href="#l140.430"></a><span id="l140.430" class="difflineplus">+    false,</span>
<a href="#l140.431"></a><span id="l140.431" class="difflineplus">+    undefined,</span>
<a href="#l140.432"></a><span id="l140.432" class="difflineplus">+    undefined,</span>
<a href="#l140.433"></a><span id="l140.433" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l140.434"></a><span id="l140.434" class="difflineplus">+  );</span>
<a href="#l140.435"></a><span id="l140.435" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l141.1"></a><span id="l141.1">copy from mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js</span>
<a href="#l141.2"></a><span id="l141.2">copy to mail/test/browser/folder-display/browser_deletionFromVirtualFolders.js</span>
<a href="#l141.3"></a><span id="l141.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-deletion-from-virtual-folders.js</span>
<a href="#l141.4"></a><span id="l141.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_deletionFromVirtualFolders.js</span>
<a href="#l141.5"></a><span id="l141.5" class="difflineat">@@ -44,34 +44,34 @@ var tabFolder, tabMessage, tabMessageBac</span>
<a href="#l141.6"></a><span id="l141.6"> </span>
<a href="#l141.7"></a><span id="l141.7"> var setNormal;</span>
<a href="#l141.8"></a><span id="l141.8"> </span>
<a href="#l141.9"></a><span id="l141.9"> /**</span>
<a href="#l141.10"></a><span id="l141.10">  * The message window controller.</span>
<a href="#l141.11"></a><span id="l141.11">  */</span>
<a href="#l141.12"></a><span id="l141.12"> var msgc;</span>
<a href="#l141.13"></a><span id="l141.13"> </span>
<a href="#l141.14"></a><span id="l141.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l141.15"></a><span id="l141.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l141.16"></a><span id="l141.16">   baseFolder = create_folder(&quot;DeletionFromVirtualFoldersA&quot;);</span>
<a href="#l141.17"></a><span id="l141.17">   // For setTagged, we want exactly as many messages as we plan to delete, so</span>
<a href="#l141.18"></a><span id="l141.18">   // that we can test that the message window and tabs close when they run out</span>
<a href="#l141.19"></a><span id="l141.19">   // of things to display.</span>
<a href="#l141.20"></a><span id="l141.20">   let [, setTagged] = make_new_sets_in_folder(baseFolder, [</span>
<a href="#l141.21"></a><span id="l141.21">     { count: 4 },</span>
<a href="#l141.22"></a><span id="l141.22">     { count: 4 },</span>
<a href="#l141.23"></a><span id="l141.23">   ]);</span>
<a href="#l141.24"></a><span id="l141.24">   setTagged.addTag(&quot;$label1&quot;); // Important, by default</span>
<a href="#l141.25"></a><span id="l141.25">   // We depend on the count for this, too</span>
<a href="#l141.26"></a><span id="l141.26">   [setNormal] = make_new_sets_in_folder(inboxFolder, [{ count: 4 }]);</span>
<a href="#l141.27"></a><span id="l141.27"> </span>
<a href="#l141.28"></a><span id="l141.28">   // Add the view picker to the toolbar</span>
<a href="#l141.29"></a><span id="l141.29">   let toolbar = mc.e(&quot;mail-bar3&quot;);</span>
<a href="#l141.30"></a><span id="l141.30">   toolbar.insertItem(&quot;mailviews-container&quot;, null);</span>
<a href="#l141.31"></a><span id="l141.31">   mc.assertNode(mc.eid(&quot;mailviews-container&quot;));</span>
<a href="#l141.32"></a><span id="l141.32" class="difflineminus">-}</span>
<a href="#l141.33"></a><span id="l141.33" class="difflineplus">+});</span>
<a href="#l141.34"></a><span id="l141.34"> </span>
<a href="#l141.35"></a><span id="l141.35"> // Check whether this message is displayed in the folder tab</span>
<a href="#l141.36"></a><span id="l141.36"> var VERIFY_FOLDER_TAB = 0x1;</span>
<a href="#l141.37"></a><span id="l141.37"> // Check whether this message is displayed in the foreground message tab</span>
<a href="#l141.38"></a><span id="l141.38"> var VERIFY_MESSAGE_TAB = 0x2;</span>
<a href="#l141.39"></a><span id="l141.39"> // Check whether this message is displayed in the background message tab</span>
<a href="#l141.40"></a><span id="l141.40"> var VERIFY_BACKGROUND_MESSAGE_TAB = 0x4;</span>
<a href="#l141.41"></a><span id="l141.41"> // Check whether this message is displayed in the message window</span>
<a href="#l141.42"></a><span id="l141.42" class="difflineat">@@ -108,34 +108,34 @@ function _verify_message_is_displayed_in</span>
<a href="#l141.43"></a><span id="l141.43">   if (aFlags &amp; VERIFY_MESSAGE_WINDOW) {</span>
<a href="#l141.44"></a><span id="l141.44">     assert_selected_and_displayed(msgc, aMessage);</span>
<a href="#l141.45"></a><span id="l141.45">     if (aIndex !== undefined) {</span>
<a href="#l141.46"></a><span id="l141.46">       assert_selected_and_displayed(msgc, aIndex);</span>
<a href="#l141.47"></a><span id="l141.47">     }</span>
<a href="#l141.48"></a><span id="l141.48">   }</span>
<a href="#l141.49"></a><span id="l141.49"> }</span>
<a href="#l141.50"></a><span id="l141.50"> </span>
<a href="#l141.51"></a><span id="l141.51" class="difflineminus">-function test_create_virtual_folders() {</span>
<a href="#l141.52"></a><span id="l141.52" class="difflineplus">+add_task(function test_create_virtual_folders() {</span>
<a href="#l141.53"></a><span id="l141.53">   be_in_folder(baseFolder);</span>
<a href="#l141.54"></a><span id="l141.54"> </span>
<a href="#l141.55"></a><span id="l141.55">   // Apply the mail view</span>
<a href="#l141.56"></a><span id="l141.56">   mc.window.RefreshAllViewPopups(mc.e(&quot;viewPickerPopup&quot;));</span>
<a href="#l141.57"></a><span id="l141.57">   mc.window.ViewChange(&quot;:$label1&quot;);</span>
<a href="#l141.58"></a><span id="l141.58">   wait_for_all_messages_to_load();</span>
<a href="#l141.59"></a><span id="l141.59"> </span>
<a href="#l141.60"></a><span id="l141.60">   // - save it</span>
<a href="#l141.61"></a><span id="l141.61">   plan_for_modal_dialog(</span>
<a href="#l141.62"></a><span id="l141.62">     &quot;mailnews:virtualFolderProperties&quot;,</span>
<a href="#l141.63"></a><span id="l141.63">     subtest_save_mail_view</span>
<a href="#l141.64"></a><span id="l141.64">   );</span>
<a href="#l141.65"></a><span id="l141.65">   // we have to use value here because the option mechanism is not sophisticated</span>
<a href="#l141.66"></a><span id="l141.66">   //  enough.</span>
<a href="#l141.67"></a><span id="l141.67">   mc.window.ViewChange(MailViewConstants.kViewItemVirtual);</span>
<a href="#l141.68"></a><span id="l141.68">   wait_for_modal_dialog(&quot;mailnews:virtualFolderProperties&quot;);</span>
<a href="#l141.69"></a><span id="l141.69" class="difflineminus">-}</span>
<a href="#l141.70"></a><span id="l141.70" class="difflineplus">+});</span>
<a href="#l141.71"></a><span id="l141.71"> </span>
<a href="#l141.72"></a><span id="l141.72"> function subtest_save_mail_view(savc) {</span>
<a href="#l141.73"></a><span id="l141.73">   savc.window.onOK();</span>
<a href="#l141.74"></a><span id="l141.74"> }</span>
<a href="#l141.75"></a><span id="l141.75"> </span>
<a href="#l141.76"></a><span id="l141.76"> function _open_first_message() {</span>
<a href="#l141.77"></a><span id="l141.77">   // Enter the folder and open a message</span>
<a href="#l141.78"></a><span id="l141.78">   tabFolder = be_in_folder(folder);</span>
<a href="#l141.79"></a><span id="l141.79" class="difflineat">@@ -154,195 +154,206 @@ function _open_first_message() {</span>
<a href="#l141.80"></a><span id="l141.80">   assert_tab_titled_from(tabMessageBackground, curMessage);</span>
<a href="#l141.81"></a><span id="l141.81"> </span>
<a href="#l141.82"></a><span id="l141.82">   // Open the window with the message</span>
<a href="#l141.83"></a><span id="l141.83">   switch_tab(tabFolder);</span>
<a href="#l141.84"></a><span id="l141.84">   msgc = open_selected_message_in_new_window();</span>
<a href="#l141.85"></a><span id="l141.85">   assert_selected_and_displayed(msgc, curMessage);</span>
<a href="#l141.86"></a><span id="l141.86"> }</span>
<a href="#l141.87"></a><span id="l141.87"> </span>
<a href="#l141.88"></a><span id="l141.88" class="difflineminus">-function test_open_first_message_in_virtual_folder() {</span>
<a href="#l141.89"></a><span id="l141.89" class="difflineplus">+add_task(function test_open_first_message_in_virtual_folder() {</span>
<a href="#l141.90"></a><span id="l141.90">   folder = baseFolder.getChildNamed(baseFolder.prettyName + &quot;-Important&quot;);</span>
<a href="#l141.91"></a><span id="l141.91">   if (!folder) {</span>
<a href="#l141.92"></a><span id="l141.92">     throw new Error(&quot;DeletionFromVirtualFoldersA-Important was not created!&quot;);</span>
<a href="#l141.93"></a><span id="l141.93">   }</span>
<a href="#l141.94"></a><span id="l141.94"> </span>
<a href="#l141.95"></a><span id="l141.95">   _open_first_message();</span>
<a href="#l141.96"></a><span id="l141.96" class="difflineminus">-}</span>
<a href="#l141.97"></a><span id="l141.97" class="difflineplus">+});</span>
<a href="#l141.98"></a><span id="l141.98"> </span>
<a href="#l141.99"></a><span id="l141.99"> /**</span>
<a href="#l141.100"></a><span id="l141.100">  * Perform a deletion from the folder tab, verify the others update correctly</span>
<a href="#l141.101"></a><span id="l141.101">  * (advancing to the next message).</span>
<a href="#l141.102"></a><span id="l141.102">  */</span>
<a href="#l141.103"></a><span id="l141.103" class="difflineminus">-function test_delete_from_virtual_folder_in_folder_tab() {</span>
<a href="#l141.104"></a><span id="l141.104" class="difflineplus">+add_task(function test_delete_from_virtual_folder_in_folder_tab() {</span>
<a href="#l141.105"></a><span id="l141.105">   // - plan to end up on the guy who is currently at index 1</span>
<a href="#l141.106"></a><span id="l141.106">   curMessage = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l141.107"></a><span id="l141.107">   // while we're at it, figure out who is at 2 for the next step</span>
<a href="#l141.108"></a><span id="l141.108">   nextMessage = mc.dbView.getMsgHdrAt(2);</span>
<a href="#l141.109"></a><span id="l141.109">   // - delete the message</span>
<a href="#l141.110"></a><span id="l141.110">   press_delete();</span>
<a href="#l141.111"></a><span id="l141.111"> </span>
<a href="#l141.112"></a><span id="l141.112">   // - verify all displays</span>
<a href="#l141.113"></a><span id="l141.113">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l141.114"></a><span id="l141.114" class="difflineminus">-}</span>
<a href="#l141.115"></a><span id="l141.115" class="difflineplus">+});</span>
<a href="#l141.116"></a><span id="l141.116"> </span>
<a href="#l141.117"></a><span id="l141.117"> /**</span>
<a href="#l141.118"></a><span id="l141.118">  * Perform a deletion from the message tab, verify the others update correctly</span>
<a href="#l141.119"></a><span id="l141.119">  *  (advancing to the next message).</span>
<a href="#l141.120"></a><span id="l141.120">  */</span>
<a href="#l141.121"></a><span id="l141.121" class="difflineminus">-function test_delete_from_virtual_folder_in_message_tab() {</span>
<a href="#l141.122"></a><span id="l141.122" class="difflineplus">+add_task(function test_delete_from_virtual_folder_in_message_tab() {</span>
<a href="#l141.123"></a><span id="l141.123">   switch_tab(tabMessage);</span>
<a href="#l141.124"></a><span id="l141.124">   // nextMessage is the guy we want to see once the delete completes.</span>
<a href="#l141.125"></a><span id="l141.125">   press_delete();</span>
<a href="#l141.126"></a><span id="l141.126">   curMessage = nextMessage;</span>
<a href="#l141.127"></a><span id="l141.127"> </span>
<a href="#l141.128"></a><span id="l141.128">   // - verify all displays</span>
<a href="#l141.129"></a><span id="l141.129">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l141.130"></a><span id="l141.130"> </span>
<a href="#l141.131"></a><span id="l141.131">   // figure out the next guy...</span>
<a href="#l141.132"></a><span id="l141.132">   nextMessage = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l141.133"></a><span id="l141.133">   if (!nextMessage) {</span>
<a href="#l141.134"></a><span id="l141.134">     throw new Error(&quot;We ran out of messages early?&quot;);</span>
<a href="#l141.135"></a><span id="l141.135">   }</span>
<a href="#l141.136"></a><span id="l141.136" class="difflineminus">-}</span>
<a href="#l141.137"></a><span id="l141.137" class="difflineplus">+});</span>
<a href="#l141.138"></a><span id="l141.138"> </span>
<a href="#l141.139"></a><span id="l141.139"> /**</span>
<a href="#l141.140"></a><span id="l141.140">  * Perform a deletion from the message window, verify the others update</span>
<a href="#l141.141"></a><span id="l141.141">  *  correctly (advancing to the next message).</span>
<a href="#l141.142"></a><span id="l141.142">  */</span>
<a href="#l141.143"></a><span id="l141.143" class="difflineminus">-function test_delete_from_virtual_folder_in_message_window() {</span>
<a href="#l141.144"></a><span id="l141.144" class="difflineplus">+add_task(function test_delete_from_virtual_folder_in_message_window() {</span>
<a href="#l141.145"></a><span id="l141.145">   // - delete</span>
<a href="#l141.146"></a><span id="l141.146">   press_delete(msgc);</span>
<a href="#l141.147"></a><span id="l141.147">   curMessage = nextMessage;</span>
<a href="#l141.148"></a><span id="l141.148">   // - verify all displays</span>
<a href="#l141.149"></a><span id="l141.149">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l141.150"></a><span id="l141.150" class="difflineminus">-}</span>
<a href="#l141.151"></a><span id="l141.151" class="difflineplus">+});</span>
<a href="#l141.152"></a><span id="l141.152"> </span>
<a href="#l141.153"></a><span id="l141.153"> /**</span>
<a href="#l141.154"></a><span id="l141.154">  * Delete the last message in that folder, which should close all message</span>
<a href="#l141.155"></a><span id="l141.155">  *  displays.</span>
<a href="#l141.156"></a><span id="l141.156">  */</span>
<a href="#l141.157"></a><span id="l141.157" class="difflineminus">-function test_delete_last_message_from_virtual_folder_closes_message_displays() {</span>
<a href="#l141.158"></a><span id="l141.158" class="difflineminus">-  // - since we have both foreground and background message tabs, we don't need</span>
<a href="#l141.159"></a><span id="l141.159" class="difflineminus">-  // to open yet another tab to test</span>
<a href="#l141.160"></a><span id="l141.160" class="difflineplus">+add_task(</span>
<a href="#l141.161"></a><span id="l141.161" class="difflineplus">+  function test_delete_last_message_from_virtual_folder_closes_message_displays() {</span>
<a href="#l141.162"></a><span id="l141.162" class="difflineplus">+    // - since we have both foreground and background message tabs, we don't need</span>
<a href="#l141.163"></a><span id="l141.163" class="difflineplus">+    // to open yet another tab to test</span>
<a href="#l141.164"></a><span id="l141.164"> </span>
<a href="#l141.165"></a><span id="l141.165" class="difflineminus">-  // - prep for the message window disappearing</span>
<a href="#l141.166"></a><span id="l141.166" class="difflineminus">-  plan_for_window_close(msgc);</span>
<a href="#l141.167"></a><span id="l141.167" class="difflineplus">+    // - prep for the message window disappearing</span>
<a href="#l141.168"></a><span id="l141.168" class="difflineplus">+    plan_for_window_close(msgc);</span>
<a href="#l141.169"></a><span id="l141.169"> </span>
<a href="#l141.170"></a><span id="l141.170" class="difflineminus">-  // - let's arbitrarily perform the deletion on this message tab</span>
<a href="#l141.171"></a><span id="l141.171" class="difflineminus">-  switch_tab(tabMessage);</span>
<a href="#l141.172"></a><span id="l141.172" class="difflineminus">-  press_delete();</span>
<a href="#l141.173"></a><span id="l141.173" class="difflineplus">+    // - let's arbitrarily perform the deletion on this message tab</span>
<a href="#l141.174"></a><span id="l141.174" class="difflineplus">+    switch_tab(tabMessage);</span>
<a href="#l141.175"></a><span id="l141.175" class="difflineplus">+    press_delete();</span>
<a href="#l141.176"></a><span id="l141.176"> </span>
<a href="#l141.177"></a><span id="l141.177" class="difflineminus">-  // - the message window should have gone away...</span>
<a href="#l141.178"></a><span id="l141.178" class="difflineminus">-  // (this also helps ensure that the 3pane gets enough event loop time to do</span>
<a href="#l141.179"></a><span id="l141.179" class="difflineminus">-  //  all that it needs to accomplish)</span>
<a href="#l141.180"></a><span id="l141.180" class="difflineminus">-  wait_for_window_close(msgc);</span>
<a href="#l141.181"></a><span id="l141.181" class="difflineminus">-  msgc = null;</span>
<a href="#l141.182"></a><span id="l141.182" class="difflineplus">+    // - the message window should have gone away...</span>
<a href="#l141.183"></a><span id="l141.183" class="difflineplus">+    // (this also helps ensure that the 3pane gets enough event loop time to do</span>
<a href="#l141.184"></a><span id="l141.184" class="difflineplus">+    //  all that it needs to accomplish)</span>
<a href="#l141.185"></a><span id="l141.185" class="difflineplus">+    wait_for_window_close(msgc);</span>
<a href="#l141.186"></a><span id="l141.186" class="difflineplus">+    msgc = null;</span>
<a href="#l141.187"></a><span id="l141.187"> </span>
<a href="#l141.188"></a><span id="l141.188" class="difflineminus">-  // - and we should now be on the folder tab and there should be no other tabs</span>
<a href="#l141.189"></a><span id="l141.189" class="difflineminus">-  if (mc.tabmail.tabInfo.length != 1) {</span>
<a href="#l141.190"></a><span id="l141.190" class="difflineminus">-    throw new Error(&quot;There should only be one tab left!&quot;);</span>
<a href="#l141.191"></a><span id="l141.191" class="difflineplus">+    // - and we should now be on the folder tab and there should be no other tabs</span>
<a href="#l141.192"></a><span id="l141.192" class="difflineplus">+    if (mc.tabmail.tabInfo.length != 1) {</span>
<a href="#l141.193"></a><span id="l141.193" class="difflineplus">+      throw new Error(&quot;There should only be one tab left!&quot;);</span>
<a href="#l141.194"></a><span id="l141.194" class="difflineplus">+    }</span>
<a href="#l141.195"></a><span id="l141.195" class="difflineplus">+    // the below check is implied by the previous check if things are sane-ish</span>
<a href="#l141.196"></a><span id="l141.196" class="difflineplus">+    if (mc.tabmail.currentTabInfo != tabFolder) {</span>
<a href="#l141.197"></a><span id="l141.197" class="difflineplus">+      throw new Error(&quot;We should be on the folder tab!&quot;);</span>
<a href="#l141.198"></a><span id="l141.198" class="difflineplus">+    }</span>
<a href="#l141.199"></a><span id="l141.199">   }</span>
<a href="#l141.200"></a><span id="l141.200" class="difflineminus">-  // the below check is implied by the previous check if things are sane-ish</span>
<a href="#l141.201"></a><span id="l141.201" class="difflineminus">-  if (mc.tabmail.currentTabInfo != tabFolder) {</span>
<a href="#l141.202"></a><span id="l141.202" class="difflineminus">-    throw new Error(&quot;We should be on the folder tab!&quot;);</span>
<a href="#l141.203"></a><span id="l141.203" class="difflineminus">-  }</span>
<a href="#l141.204"></a><span id="l141.204" class="difflineminus">-}</span>
<a href="#l141.205"></a><span id="l141.205" class="difflineplus">+);</span>
<a href="#l141.206"></a><span id="l141.206"> </span>
<a href="#l141.207"></a><span id="l141.207"> /**</span>
<a href="#l141.208"></a><span id="l141.208">  * Open the first message in the smart inbox.</span>
<a href="#l141.209"></a><span id="l141.209">  */</span>
<a href="#l141.210"></a><span id="l141.210" class="difflineminus">-function test_open_first_message_in_smart_inbox() {</span>
<a href="#l141.211"></a><span id="l141.211" class="difflineplus">+add_task(function test_open_first_message_in_smart_inbox() {</span>
<a href="#l141.212"></a><span id="l141.212">   // Switch to smart folders</span>
<a href="#l141.213"></a><span id="l141.213">   mc.folderTreeView.mode = &quot;smart&quot;;</span>
<a href="#l141.214"></a><span id="l141.214">   // Select the smart inbox</span>
<a href="#l141.215"></a><span id="l141.215">   folder = get_smart_folder_named(&quot;Inbox&quot;);</span>
<a href="#l141.216"></a><span id="l141.216">   be_in_folder(folder);</span>
<a href="#l141.217"></a><span id="l141.217">   assert_messages_in_view(setNormal);</span>
<a href="#l141.218"></a><span id="l141.218">   // Open the first message</span>
<a href="#l141.219"></a><span id="l141.219">   _open_first_message();</span>
<a href="#l141.220"></a><span id="l141.220" class="difflineminus">-}</span>
<a href="#l141.221"></a><span id="l141.221" class="difflineplus">+});</span>
<a href="#l141.222"></a><span id="l141.222"> </span>
<a href="#l141.223"></a><span id="l141.223"> /**</span>
<a href="#l141.224"></a><span id="l141.224">  * Perform a deletion from the folder tab, verify the others update correctly</span>
<a href="#l141.225"></a><span id="l141.225">  * (advancing to the next message).</span>
<a href="#l141.226"></a><span id="l141.226">  */</span>
<a href="#l141.227"></a><span id="l141.227" class="difflineminus">-function test_delete_from_smart_inbox_in_folder_tab() {</span>
<a href="#l141.228"></a><span id="l141.228" class="difflineplus">+add_task(function test_delete_from_smart_inbox_in_folder_tab() {</span>
<a href="#l141.229"></a><span id="l141.229">   // - plan to end up on the guy who is currently at index 1</span>
<a href="#l141.230"></a><span id="l141.230">   curMessage = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l141.231"></a><span id="l141.231">   // while we're at it, figure out who is at 2 for the next step</span>
<a href="#l141.232"></a><span id="l141.232">   nextMessage = mc.dbView.getMsgHdrAt(2);</span>
<a href="#l141.233"></a><span id="l141.233">   // - delete the message</span>
<a href="#l141.234"></a><span id="l141.234">   press_delete();</span>
<a href="#l141.235"></a><span id="l141.235"> </span>
<a href="#l141.236"></a><span id="l141.236">   // - verify all displays</span>
<a href="#l141.237"></a><span id="l141.237">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l141.238"></a><span id="l141.238" class="difflineminus">-}</span>
<a href="#l141.239"></a><span id="l141.239" class="difflineplus">+});</span>
<a href="#l141.240"></a><span id="l141.240"> </span>
<a href="#l141.241"></a><span id="l141.241"> /**</span>
<a href="#l141.242"></a><span id="l141.242">  * Perform a deletion from the message tab, verify the others update correctly</span>
<a href="#l141.243"></a><span id="l141.243">  *  (advancing to the next message).</span>
<a href="#l141.244"></a><span id="l141.244">  */</span>
<a href="#l141.245"></a><span id="l141.245" class="difflineminus">-function test_delete_from_smart_inbox_in_message_tab() {</span>
<a href="#l141.246"></a><span id="l141.246" class="difflineplus">+add_task(function test_delete_from_smart_inbox_in_message_tab() {</span>
<a href="#l141.247"></a><span id="l141.247">   switch_tab(tabMessage);</span>
<a href="#l141.248"></a><span id="l141.248">   // nextMessage is the guy we want to see once the delete completes.</span>
<a href="#l141.249"></a><span id="l141.249">   press_delete();</span>
<a href="#l141.250"></a><span id="l141.250">   curMessage = nextMessage;</span>
<a href="#l141.251"></a><span id="l141.251"> </span>
<a href="#l141.252"></a><span id="l141.252">   // - verify all displays</span>
<a href="#l141.253"></a><span id="l141.253">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l141.254"></a><span id="l141.254"> </span>
<a href="#l141.255"></a><span id="l141.255">   // figure out the next guy...</span>
<a href="#l141.256"></a><span id="l141.256">   nextMessage = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l141.257"></a><span id="l141.257">   if (!nextMessage) {</span>
<a href="#l141.258"></a><span id="l141.258">     throw new Error(&quot;We ran out of messages early?&quot;);</span>
<a href="#l141.259"></a><span id="l141.259">   }</span>
<a href="#l141.260"></a><span id="l141.260" class="difflineminus">-}</span>
<a href="#l141.261"></a><span id="l141.261" class="difflineplus">+});</span>
<a href="#l141.262"></a><span id="l141.262"> </span>
<a href="#l141.263"></a><span id="l141.263"> /**</span>
<a href="#l141.264"></a><span id="l141.264">  * Perform a deletion from the message window, verify the others update</span>
<a href="#l141.265"></a><span id="l141.265">  *  correctly (advancing to the next message).</span>
<a href="#l141.266"></a><span id="l141.266">  */</span>
<a href="#l141.267"></a><span id="l141.267" class="difflineminus">-function test_delete_from_smart_inbox_in_message_window() {</span>
<a href="#l141.268"></a><span id="l141.268" class="difflineplus">+add_task(function test_delete_from_smart_inbox_in_message_window() {</span>
<a href="#l141.269"></a><span id="l141.269">   // - delete</span>
<a href="#l141.270"></a><span id="l141.270">   press_delete(msgc);</span>
<a href="#l141.271"></a><span id="l141.271">   curMessage = nextMessage;</span>
<a href="#l141.272"></a><span id="l141.272">   // - verify all displays</span>
<a href="#l141.273"></a><span id="l141.273">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l141.274"></a><span id="l141.274" class="difflineminus">-}</span>
<a href="#l141.275"></a><span id="l141.275" class="difflineplus">+});</span>
<a href="#l141.276"></a><span id="l141.276"> </span>
<a href="#l141.277"></a><span id="l141.277"> /**</span>
<a href="#l141.278"></a><span id="l141.278">  * Delete the last message in that folder, which should close all message</span>
<a href="#l141.279"></a><span id="l141.279">  *  displays.</span>
<a href="#l141.280"></a><span id="l141.280">  */</span>
<a href="#l141.281"></a><span id="l141.281" class="difflineminus">-function test_delete_last_message_from_smart_inbox_closes_message_displays() {</span>
<a href="#l141.282"></a><span id="l141.282" class="difflineminus">-  // - since we have both foreground and background message tabs, we don't need</span>
<a href="#l141.283"></a><span id="l141.283" class="difflineminus">-  // to open yet another tab to test</span>
<a href="#l141.284"></a><span id="l141.284" class="difflineplus">+add_task(</span>
<a href="#l141.285"></a><span id="l141.285" class="difflineplus">+  function test_delete_last_message_from_smart_inbox_closes_message_displays() {</span>
<a href="#l141.286"></a><span id="l141.286" class="difflineplus">+    // - since we have both foreground and background message tabs, we don't need</span>
<a href="#l141.287"></a><span id="l141.287" class="difflineplus">+    // to open yet another tab to test</span>
<a href="#l141.288"></a><span id="l141.288"> </span>
<a href="#l141.289"></a><span id="l141.289" class="difflineminus">-  // - prep for the message window disappearing</span>
<a href="#l141.290"></a><span id="l141.290" class="difflineminus">-  plan_for_window_close(msgc);</span>
<a href="#l141.291"></a><span id="l141.291" class="difflineplus">+    // - prep for the message window disappearing</span>
<a href="#l141.292"></a><span id="l141.292" class="difflineplus">+    plan_for_window_close(msgc);</span>
<a href="#l141.293"></a><span id="l141.293"> </span>
<a href="#l141.294"></a><span id="l141.294" class="difflineminus">-  // - let's arbitrarily perform the deletion on this message tab</span>
<a href="#l141.295"></a><span id="l141.295" class="difflineminus">-  switch_tab(tabMessage);</span>
<a href="#l141.296"></a><span id="l141.296" class="difflineminus">-  press_delete();</span>
<a href="#l141.297"></a><span id="l141.297" class="difflineplus">+    // - let's arbitrarily perform the deletion on this message tab</span>
<a href="#l141.298"></a><span id="l141.298" class="difflineplus">+    switch_tab(tabMessage);</span>
<a href="#l141.299"></a><span id="l141.299" class="difflineplus">+    press_delete();</span>
<a href="#l141.300"></a><span id="l141.300"> </span>
<a href="#l141.301"></a><span id="l141.301" class="difflineminus">-  // - the message window should have gone away...</span>
<a href="#l141.302"></a><span id="l141.302" class="difflineminus">-  // (this also helps ensure that the 3pane gets enough event loop time to do</span>
<a href="#l141.303"></a><span id="l141.303" class="difflineminus">-  //  all that it needs to accomplish)</span>
<a href="#l141.304"></a><span id="l141.304" class="difflineminus">-  wait_for_window_close(msgc);</span>
<a href="#l141.305"></a><span id="l141.305" class="difflineminus">-  msgc = null;</span>
<a href="#l141.306"></a><span id="l141.306" class="difflineplus">+    // - the message window should have gone away...</span>
<a href="#l141.307"></a><span id="l141.307" class="difflineplus">+    // (this also helps ensure that the 3pane gets enough event loop time to do</span>
<a href="#l141.308"></a><span id="l141.308" class="difflineplus">+    //  all that it needs to accomplish)</span>
<a href="#l141.309"></a><span id="l141.309" class="difflineplus">+    wait_for_window_close(msgc);</span>
<a href="#l141.310"></a><span id="l141.310" class="difflineplus">+    msgc = null;</span>
<a href="#l141.311"></a><span id="l141.311"> </span>
<a href="#l141.312"></a><span id="l141.312" class="difflineminus">-  // - and we should now be on the folder tab and there should be no other tabs</span>
<a href="#l141.313"></a><span id="l141.313" class="difflineminus">-  if (mc.tabmail.tabInfo.length != 1) {</span>
<a href="#l141.314"></a><span id="l141.314" class="difflineminus">-    throw new Error(&quot;There should only be one tab left!&quot;);</span>
<a href="#l141.315"></a><span id="l141.315" class="difflineplus">+    // - and we should now be on the folder tab and there should be no other tabs</span>
<a href="#l141.316"></a><span id="l141.316" class="difflineplus">+    if (mc.tabmail.tabInfo.length != 1) {</span>
<a href="#l141.317"></a><span id="l141.317" class="difflineplus">+      throw new Error(&quot;There should only be one tab left!&quot;);</span>
<a href="#l141.318"></a><span id="l141.318" class="difflineplus">+    }</span>
<a href="#l141.319"></a><span id="l141.319" class="difflineplus">+    // the below check is implied by the previous check if things are sane-ish</span>
<a href="#l141.320"></a><span id="l141.320" class="difflineplus">+    if (mc.tabmail.currentTabInfo != tabFolder) {</span>
<a href="#l141.321"></a><span id="l141.321" class="difflineplus">+      throw new Error(&quot;We should be on the folder tab!&quot;);</span>
<a href="#l141.322"></a><span id="l141.322" class="difflineplus">+    }</span>
<a href="#l141.323"></a><span id="l141.323">   }</span>
<a href="#l141.324"></a><span id="l141.324" class="difflineminus">-  // the below check is implied by the previous check if things are sane-ish</span>
<a href="#l141.325"></a><span id="l141.325" class="difflineminus">-  if (mc.tabmail.currentTabInfo != tabFolder) {</span>
<a href="#l141.326"></a><span id="l141.326" class="difflineminus">-    throw new Error(&quot;We should be on the folder tab!&quot;);</span>
<a href="#l141.327"></a><span id="l141.327" class="difflineminus">-  }</span>
<a href="#l141.328"></a><span id="l141.328" class="difflineminus">-}</span>
<a href="#l141.329"></a><span id="l141.329" class="difflineplus">+);</span>
<a href="#l141.330"></a><span id="l141.330"> </span>
<a href="#l141.331"></a><span id="l141.331"> /**</span>
<a href="#l141.332"></a><span id="l141.332">  * Switch back to the all folders mode for further tests.</span>
<a href="#l141.333"></a><span id="l141.333">  */</span>
<a href="#l141.334"></a><span id="l141.334" class="difflineminus">-function test_switch_back_to_all_folders_mode() {</span>
<a href="#l141.335"></a><span id="l141.335" class="difflineplus">+add_task(function test_switch_back_to_all_folders_mode() {</span>
<a href="#l141.336"></a><span id="l141.336">   mc.folderTreeView.mode = &quot;all&quot;;</span>
<a href="#l141.337"></a><span id="l141.337" class="difflineminus">-}</span>
<a href="#l141.338"></a><span id="l141.338" class="difflineplus">+</span>
<a href="#l141.339"></a><span id="l141.339" class="difflineplus">+  Assert.report(</span>
<a href="#l141.340"></a><span id="l141.340" class="difflineplus">+    false,</span>
<a href="#l141.341"></a><span id="l141.341" class="difflineplus">+    undefined,</span>
<a href="#l141.342"></a><span id="l141.342" class="difflineplus">+    undefined,</span>
<a href="#l141.343"></a><span id="l141.343" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l141.344"></a><span id="l141.344" class="difflineplus">+  );</span>
<a href="#l141.345"></a><span id="l141.345" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l142.1"></a><span id="l142.1">copy from mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js</span>
<a href="#l142.2"></a><span id="l142.2">copy to mail/test/browser/folder-display/browser_deletionWithMultipleDisplays.js</span>
<a href="#l142.3"></a><span id="l142.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-deletion-with-multiple-displays.js</span>
<a href="#l142.4"></a><span id="l142.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_deletionWithMultipleDisplays.js</span>
<a href="#l142.5"></a><span id="l142.5" class="difflineat">@@ -39,17 +39,19 @@ var folder,</span>
<a href="#l142.6"></a><span id="l142.6">   lastMessageFolder,</span>
<a href="#l142.7"></a><span id="l142.7">   oneBeforeFolder,</span>
<a href="#l142.8"></a><span id="l142.8">   oneAfterFolder,</span>
<a href="#l142.9"></a><span id="l142.9">   multipleDeletionFolder1,</span>
<a href="#l142.10"></a><span id="l142.10">   multipleDeletionFolder2,</span>
<a href="#l142.11"></a><span id="l142.11">   multipleDeletionFolder3,</span>
<a href="#l142.12"></a><span id="l142.12">   multipleDeletionFolder4;</span>
<a href="#l142.13"></a><span id="l142.13"> </span>
<a href="#l142.14"></a><span id="l142.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l142.15"></a><span id="l142.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l142.16"></a><span id="l142.16" class="difflineplus">+  requestLongerTimeout(2);</span>
<a href="#l142.17"></a><span id="l142.17" class="difflineplus">+</span>
<a href="#l142.18"></a><span id="l142.18">   folder = create_folder(&quot;DeletionA&quot;);</span>
<a href="#l142.19"></a><span id="l142.19">   lastMessageFolder = create_folder(&quot;DeletionB&quot;);</span>
<a href="#l142.20"></a><span id="l142.20">   oneBeforeFolder = create_folder(&quot;DeletionC&quot;);</span>
<a href="#l142.21"></a><span id="l142.21">   oneAfterFolder = create_folder(&quot;DeletionD&quot;);</span>
<a href="#l142.22"></a><span id="l142.22">   multipleDeletionFolder1 = create_folder(&quot;DeletionE&quot;);</span>
<a href="#l142.23"></a><span id="l142.23">   multipleDeletionFolder2 = create_folder(&quot;DeletionF&quot;);</span>
<a href="#l142.24"></a><span id="l142.24">   multipleDeletionFolder3 = create_folder(&quot;DeletionG&quot;);</span>
<a href="#l142.25"></a><span id="l142.25">   multipleDeletionFolder4 = create_folder(&quot;DeletionH&quot;);</span>
<a href="#l142.26"></a><span id="l142.26" class="difflineat">@@ -64,17 +66,17 @@ function setupModule(module) {</span>
<a href="#l142.27"></a><span id="l142.27">   make_new_sets_in_folder(oneBeforeFolder, [{ count: 10 }]);</span>
<a href="#l142.28"></a><span id="l142.28">   make_new_sets_in_folder(oneAfterFolder, [{ count: 10 }]);</span>
<a href="#l142.29"></a><span id="l142.29">   make_new_sets_in_folder(multipleDeletionFolder1, [{ count: 30 }]);</span>
<a href="#l142.30"></a><span id="l142.30"> </span>
<a href="#l142.31"></a><span id="l142.31">   // We're depending on selecting the last message here, so these do matter</span>
<a href="#l142.32"></a><span id="l142.32">   make_new_sets_in_folder(multipleDeletionFolder2, [{ count: 10 }]);</span>
<a href="#l142.33"></a><span id="l142.33">   make_new_sets_in_folder(multipleDeletionFolder3, [{ count: 10 }]);</span>
<a href="#l142.34"></a><span id="l142.34">   make_new_sets_in_folder(multipleDeletionFolder4, [{ count: 10 }]);</span>
<a href="#l142.35"></a><span id="l142.35" class="difflineminus">-}</span>
<a href="#l142.36"></a><span id="l142.36" class="difflineplus">+});</span>
<a href="#l142.37"></a><span id="l142.37"> </span>
<a href="#l142.38"></a><span id="l142.38"> var tabFolder, tabMessage, tabMessageBackground, curMessage, nextMessage;</span>
<a href="#l142.39"></a><span id="l142.39"> </span>
<a href="#l142.40"></a><span id="l142.40"> /**</span>
<a href="#l142.41"></a><span id="l142.41">  * The message window controller.  Short names because controllers get used a</span>
<a href="#l142.42"></a><span id="l142.42">  *  lot.</span>
<a href="#l142.43"></a><span id="l142.43">  */</span>
<a href="#l142.44"></a><span id="l142.44"> var msgc;</span>
<a href="#l142.45"></a><span id="l142.45" class="difflineat">@@ -155,73 +157,73 @@ function _verify_message_is_displayed_in</span>
<a href="#l142.46"></a><span id="l142.46"> </span>
<a href="#l142.47"></a><span id="l142.47"> /**</span>
<a href="#l142.48"></a><span id="l142.48">  * Have a message displayed in a folder tab, message tab (foreground and</span>
<a href="#l142.49"></a><span id="l142.49">  * background), and message window. The idea is that as we delete from the</span>
<a href="#l142.50"></a><span id="l142.50">  * various sources, they should all advance in lock-step through their messages,</span>
<a href="#l142.51"></a><span id="l142.51">  * simplifying our lives (but making us explode forevermore the first time any</span>
<a href="#l142.52"></a><span id="l142.52">  * of the tests fail.)</span>
<a href="#l142.53"></a><span id="l142.53">  */</span>
<a href="#l142.54"></a><span id="l142.54" class="difflineminus">-function test_open_first_message_in_all_four_display_mechanisms() {</span>
<a href="#l142.55"></a><span id="l142.55" class="difflineplus">+add_task(function test_open_first_message_in_all_four_display_mechanisms() {</span>
<a href="#l142.56"></a><span id="l142.56">   _open_message_in_all_four_display_mechanisms_helper(folder, 0);</span>
<a href="#l142.57"></a><span id="l142.57" class="difflineminus">-}</span>
<a href="#l142.58"></a><span id="l142.58" class="difflineplus">+});</span>
<a href="#l142.59"></a><span id="l142.59"> </span>
<a href="#l142.60"></a><span id="l142.60"> /**</span>
<a href="#l142.61"></a><span id="l142.61">  * Perform a deletion from the folder tab, verify the others update correctly</span>
<a href="#l142.62"></a><span id="l142.62">  *  (advancing to the next message).</span>
<a href="#l142.63"></a><span id="l142.63">  */</span>
<a href="#l142.64"></a><span id="l142.64" class="difflineminus">-function test_delete_in_folder_tab() {</span>
<a href="#l142.65"></a><span id="l142.65" class="difflineplus">+add_task(function test_delete_in_folder_tab() {</span>
<a href="#l142.66"></a><span id="l142.66">   // - plan to end up on the guy who is currently at index 1</span>
<a href="#l142.67"></a><span id="l142.67">   curMessage = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l142.68"></a><span id="l142.68">   // while we're at it, figure out who is at 2 for the next step</span>
<a href="#l142.69"></a><span id="l142.69">   nextMessage = mc.dbView.getMsgHdrAt(2);</span>
<a href="#l142.70"></a><span id="l142.70">   // - delete the message</span>
<a href="#l142.71"></a><span id="l142.71">   press_delete();</span>
<a href="#l142.72"></a><span id="l142.72"> </span>
<a href="#l142.73"></a><span id="l142.73">   // - verify all displays</span>
<a href="#l142.74"></a><span id="l142.74">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l142.75"></a><span id="l142.75" class="difflineminus">-}</span>
<a href="#l142.76"></a><span id="l142.76" class="difflineplus">+});</span>
<a href="#l142.77"></a><span id="l142.77"> </span>
<a href="#l142.78"></a><span id="l142.78"> /**</span>
<a href="#l142.79"></a><span id="l142.79">  * Perform a deletion from the message tab, verify the others update correctly</span>
<a href="#l142.80"></a><span id="l142.80">  *  (advancing to the next message).</span>
<a href="#l142.81"></a><span id="l142.81">  */</span>
<a href="#l142.82"></a><span id="l142.82" class="difflineminus">-function test_delete_in_message_tab() {</span>
<a href="#l142.83"></a><span id="l142.83" class="difflineplus">+add_task(function test_delete_in_message_tab() {</span>
<a href="#l142.84"></a><span id="l142.84">   switch_tab(tabMessage);</span>
<a href="#l142.85"></a><span id="l142.85">   // nextMessage is the guy we want to see once the delete completes.</span>
<a href="#l142.86"></a><span id="l142.86">   press_delete();</span>
<a href="#l142.87"></a><span id="l142.87">   curMessage = nextMessage;</span>
<a href="#l142.88"></a><span id="l142.88"> </span>
<a href="#l142.89"></a><span id="l142.89">   // - verify all displays</span>
<a href="#l142.90"></a><span id="l142.90">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l142.91"></a><span id="l142.91"> </span>
<a href="#l142.92"></a><span id="l142.92">   // figure out the next guy...</span>
<a href="#l142.93"></a><span id="l142.93">   nextMessage = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l142.94"></a><span id="l142.94">   if (!nextMessage) {</span>
<a href="#l142.95"></a><span id="l142.95">     throw new Error(&quot;We ran out of messages early?&quot;);</span>
<a href="#l142.96"></a><span id="l142.96">   }</span>
<a href="#l142.97"></a><span id="l142.97" class="difflineminus">-}</span>
<a href="#l142.98"></a><span id="l142.98" class="difflineplus">+});</span>
<a href="#l142.99"></a><span id="l142.99"> </span>
<a href="#l142.100"></a><span id="l142.100"> /**</span>
<a href="#l142.101"></a><span id="l142.101">  * Perform a deletion from the message window, verify the others update</span>
<a href="#l142.102"></a><span id="l142.102">  *  correctly (advancing to the next message).</span>
<a href="#l142.103"></a><span id="l142.103">  */</span>
<a href="#l142.104"></a><span id="l142.104" class="difflineminus">-function test_delete_in_message_window() {</span>
<a href="#l142.105"></a><span id="l142.105" class="difflineplus">+add_task(function test_delete_in_message_window() {</span>
<a href="#l142.106"></a><span id="l142.106">   // - delete</span>
<a href="#l142.107"></a><span id="l142.107">   press_delete(msgc);</span>
<a href="#l142.108"></a><span id="l142.108">   curMessage = nextMessage;</span>
<a href="#l142.109"></a><span id="l142.109">   // - verify all displays</span>
<a href="#l142.110"></a><span id="l142.110">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l142.111"></a><span id="l142.111" class="difflineminus">-}</span>
<a href="#l142.112"></a><span id="l142.112" class="difflineplus">+});</span>
<a href="#l142.113"></a><span id="l142.113"> </span>
<a href="#l142.114"></a><span id="l142.114"> /**</span>
<a href="#l142.115"></a><span id="l142.115">  * Delete the last message in that folder, which should close all message</span>
<a href="#l142.116"></a><span id="l142.116">  *  displays.</span>
<a href="#l142.117"></a><span id="l142.117">  */</span>
<a href="#l142.118"></a><span id="l142.118" class="difflineminus">-function test_delete_last_message_closes_message_displays() {</span>
<a href="#l142.119"></a><span id="l142.119" class="difflineplus">+add_task(function test_delete_last_message_closes_message_displays() {</span>
<a href="#l142.120"></a><span id="l142.120">   // - since we have both foreground and background message tabs, we don't need</span>
<a href="#l142.121"></a><span id="l142.121">   // to open yet another tab to test</span>
<a href="#l142.122"></a><span id="l142.122"> </span>
<a href="#l142.123"></a><span id="l142.123">   // - prep for the message window disappearing</span>
<a href="#l142.124"></a><span id="l142.124">   plan_for_window_close(msgc);</span>
<a href="#l142.125"></a><span id="l142.125"> </span>
<a href="#l142.126"></a><span id="l142.126">   // - let's arbitrarily perform the deletion on this message tab</span>
<a href="#l142.127"></a><span id="l142.127">   switch_tab(tabMessage);</span>
<a href="#l142.128"></a><span id="l142.128" class="difflineat">@@ -236,102 +238,102 @@ function test_delete_last_message_closes</span>
<a href="#l142.129"></a><span id="l142.129">   // - and we should now be on the folder tab and there should be no other tabs</span>
<a href="#l142.130"></a><span id="l142.130">   if (mc.tabmail.tabInfo.length != 1) {</span>
<a href="#l142.131"></a><span id="l142.131">     throw new Error(&quot;There should only be one tab left!&quot;);</span>
<a href="#l142.132"></a><span id="l142.132">   }</span>
<a href="#l142.133"></a><span id="l142.133">   // the below check is implied by the previous check if things are sane-ish</span>
<a href="#l142.134"></a><span id="l142.134">   if (mc.tabmail.currentTabInfo != tabFolder) {</span>
<a href="#l142.135"></a><span id="l142.135">     throw new Error(&quot;We should be on the folder tab!&quot;);</span>
<a href="#l142.136"></a><span id="l142.136">   }</span>
<a href="#l142.137"></a><span id="l142.137" class="difflineminus">-}</span>
<a href="#l142.138"></a><span id="l142.138" class="difflineplus">+});</span>
<a href="#l142.139"></a><span id="l142.139"> </span>
<a href="#l142.140"></a><span id="l142.140"> /*</span>
<a href="#l142.141"></a><span id="l142.141">  * Now we retest everything, but while deleting the last message in our</span>
<a href="#l142.142"></a><span id="l142.142">  * selection. We need to make sure we select the previously next-to-last message</span>
<a href="#l142.143"></a><span id="l142.143">  * in that case.</span>
<a href="#l142.144"></a><span id="l142.144">  */</span>
<a href="#l142.145"></a><span id="l142.145"> </span>
<a href="#l142.146"></a><span id="l142.146"> /**</span>
<a href="#l142.147"></a><span id="l142.147">  * Have the last message displayed in a folder tab, message tab (foreground and</span>
<a href="#l142.148"></a><span id="l142.148">  * background), and message window. The idea is that as we delete from the</span>
<a href="#l142.149"></a><span id="l142.149">  * various sources, they should all advance in lock-step through their messages,</span>
<a href="#l142.150"></a><span id="l142.150">  * simplifying our lives (but making us explode forevermore the first time any</span>
<a href="#l142.151"></a><span id="l142.151">  * of the tests fail.)</span>
<a href="#l142.152"></a><span id="l142.152">  */</span>
<a href="#l142.153"></a><span id="l142.153" class="difflineminus">-function test_open_last_message_in_all_four_display_mechanisms() {</span>
<a href="#l142.154"></a><span id="l142.154" class="difflineplus">+add_task(function test_open_last_message_in_all_four_display_mechanisms() {</span>
<a href="#l142.155"></a><span id="l142.155">   // since we have four messages, index 3 is the last message.</span>
<a href="#l142.156"></a><span id="l142.156">   _open_message_in_all_four_display_mechanisms_helper(lastMessageFolder, 3);</span>
<a href="#l142.157"></a><span id="l142.157" class="difflineminus">-}</span>
<a href="#l142.158"></a><span id="l142.158" class="difflineplus">+});</span>
<a href="#l142.159"></a><span id="l142.159"> </span>
<a href="#l142.160"></a><span id="l142.160"> /**</span>
<a href="#l142.161"></a><span id="l142.161">  * Perform a deletion from the folder tab, verify the others update correctly</span>
<a href="#l142.162"></a><span id="l142.162">  * (advancing to the next message).</span>
<a href="#l142.163"></a><span id="l142.163">  */</span>
<a href="#l142.164"></a><span id="l142.164" class="difflineminus">-function test_delete_last_message_in_folder_tab() {</span>
<a href="#l142.165"></a><span id="l142.165" class="difflineplus">+add_task(function test_delete_last_message_in_folder_tab() {</span>
<a href="#l142.166"></a><span id="l142.166">   // - plan to end up on the guy who is currently at index 2</span>
<a href="#l142.167"></a><span id="l142.167">   curMessage = mc.dbView.getMsgHdrAt(2);</span>
<a href="#l142.168"></a><span id="l142.168">   // while we're at it, figure out who is at 1 for the next step</span>
<a href="#l142.169"></a><span id="l142.169">   nextMessage = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l142.170"></a><span id="l142.170">   // - delete the message</span>
<a href="#l142.171"></a><span id="l142.171">   press_delete();</span>
<a href="#l142.172"></a><span id="l142.172"> </span>
<a href="#l142.173"></a><span id="l142.173">   // - verify all displays</span>
<a href="#l142.174"></a><span id="l142.174">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 2);</span>
<a href="#l142.175"></a><span id="l142.175" class="difflineminus">-}</span>
<a href="#l142.176"></a><span id="l142.176" class="difflineplus">+});</span>
<a href="#l142.177"></a><span id="l142.177"> </span>
<a href="#l142.178"></a><span id="l142.178"> /**</span>
<a href="#l142.179"></a><span id="l142.179">  * Perform a deletion from the message tab, verify the others update correctly</span>
<a href="#l142.180"></a><span id="l142.180">  * (advancing to the next message).</span>
<a href="#l142.181"></a><span id="l142.181">  */</span>
<a href="#l142.182"></a><span id="l142.182" class="difflineminus">-function test_delete_last_message_in_message_tab() {</span>
<a href="#l142.183"></a><span id="l142.183" class="difflineplus">+add_task(function test_delete_last_message_in_message_tab() {</span>
<a href="#l142.184"></a><span id="l142.184">   // (we're still on the message tab, and nextMessage is the guy we want to see</span>
<a href="#l142.185"></a><span id="l142.185">   //  once the delete completes.)</span>
<a href="#l142.186"></a><span id="l142.186">   press_delete();</span>
<a href="#l142.187"></a><span id="l142.187">   curMessage = nextMessage;</span>
<a href="#l142.188"></a><span id="l142.188"> </span>
<a href="#l142.189"></a><span id="l142.189">   // - verify all displays</span>
<a href="#l142.190"></a><span id="l142.190">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 1);</span>
<a href="#l142.191"></a><span id="l142.191">   // figure out the next guy...</span>
<a href="#l142.192"></a><span id="l142.192"> </span>
<a href="#l142.193"></a><span id="l142.193">   nextMessage = mc.dbView.getMsgHdrAt(0);</span>
<a href="#l142.194"></a><span id="l142.194">   if (!nextMessage) {</span>
<a href="#l142.195"></a><span id="l142.195">     throw new Error(&quot;We ran out of messages early?&quot;);</span>
<a href="#l142.196"></a><span id="l142.196">   }</span>
<a href="#l142.197"></a><span id="l142.197" class="difflineminus">-}</span>
<a href="#l142.198"></a><span id="l142.198" class="difflineplus">+});</span>
<a href="#l142.199"></a><span id="l142.199"> </span>
<a href="#l142.200"></a><span id="l142.200"> /**</span>
<a href="#l142.201"></a><span id="l142.201">  * Perform a deletion from the message window, verify the others update</span>
<a href="#l142.202"></a><span id="l142.202">  * correctly (advancing to the next message).</span>
<a href="#l142.203"></a><span id="l142.203">  */</span>
<a href="#l142.204"></a><span id="l142.204" class="difflineminus">-function test_delete_last_message_in_message_window() {</span>
<a href="#l142.205"></a><span id="l142.205" class="difflineplus">+add_task(function test_delete_last_message_in_message_window() {</span>
<a href="#l142.206"></a><span id="l142.206">   // Vary this up. Switch to the folder tab instead of staying on the message</span>
<a href="#l142.207"></a><span id="l142.207">   // tab</span>
<a href="#l142.208"></a><span id="l142.208">   switch_tab(tabFolder);</span>
<a href="#l142.209"></a><span id="l142.209">   // - delete</span>
<a href="#l142.210"></a><span id="l142.210">   press_delete(msgc);</span>
<a href="#l142.211"></a><span id="l142.211">   curMessage = nextMessage;</span>
<a href="#l142.212"></a><span id="l142.212">   // - verify all displays</span>
<a href="#l142.213"></a><span id="l142.213">   _verify_message_is_displayed_in(VERIFY_ALL, curMessage, 0);</span>
<a href="#l142.214"></a><span id="l142.214"> </span>
<a href="#l142.215"></a><span id="l142.215">   // - clean up, close the message window and displays</span>
<a href="#l142.216"></a><span id="l142.216">   close_message_window(msgc);</span>
<a href="#l142.217"></a><span id="l142.217">   close_tab(tabMessage);</span>
<a href="#l142.218"></a><span id="l142.218">   close_tab(tabMessageBackground);</span>
<a href="#l142.219"></a><span id="l142.219">   switch_tab(tabFolder);</span>
<a href="#l142.220"></a><span id="l142.220" class="difflineminus">-}</span>
<a href="#l142.221"></a><span id="l142.221" class="difflineplus">+});</span>
<a href="#l142.222"></a><span id="l142.222"> </span>
<a href="#l142.223"></a><span id="l142.223"> /*</span>
<a href="#l142.224"></a><span id="l142.224">  * Our next job is to open up a message, then delete the message one before it</span>
<a href="#l142.225"></a><span id="l142.225">  * in another view. The other selections shouldn't be affected.</span>
<a href="#l142.226"></a><span id="l142.226">  */</span>
<a href="#l142.227"></a><span id="l142.227"> </span>
<a href="#l142.228"></a><span id="l142.228"> /**</span>
<a href="#l142.229"></a><span id="l142.229">  * Test &quot;one before&quot; deletion in the folder tab.</span>
<a href="#l142.230"></a><span id="l142.230">  */</span>
<a href="#l142.231"></a><span id="l142.231" class="difflineminus">-function test_delete_one_before_message_in_folder_tab() {</span>
<a href="#l142.232"></a><span id="l142.232" class="difflineplus">+add_task(function test_delete_one_before_message_in_folder_tab() {</span>
<a href="#l142.233"></a><span id="l142.233">   // Open up message 4 in message tabs and a window (we'll delete message 3).</span>
<a href="#l142.234"></a><span id="l142.234">   _open_message_in_all_four_display_mechanisms_helper(oneBeforeFolder, 4);</span>
<a href="#l142.235"></a><span id="l142.235"> </span>
<a href="#l142.236"></a><span id="l142.236">   let expectedMessage = mc.dbView.getMsgHdrAt(4);</span>
<a href="#l142.237"></a><span id="l142.237">   select_click_row(3);</span>
<a href="#l142.238"></a><span id="l142.238">   press_delete();</span>
<a href="#l142.239"></a><span id="l142.239"> </span>
<a href="#l142.240"></a><span id="l142.240">   // The message tab, background message tab and window shouldn't have changed</span>
<a href="#l142.241"></a><span id="l142.241" class="difflineat">@@ -340,22 +342,22 @@ function test_delete_one_before_message_</span>
<a href="#l142.242"></a><span id="l142.242">     expectedMessage</span>
<a href="#l142.243"></a><span id="l142.243">   );</span>
<a href="#l142.244"></a><span id="l142.244"> </span>
<a href="#l142.245"></a><span id="l142.245">   // Clean up, close everything</span>
<a href="#l142.246"></a><span id="l142.246">   close_message_window(msgc);</span>
<a href="#l142.247"></a><span id="l142.247">   close_tab(tabMessage);</span>
<a href="#l142.248"></a><span id="l142.248">   close_tab(tabMessageBackground);</span>
<a href="#l142.249"></a><span id="l142.249">   switch_tab(tabFolder);</span>
<a href="#l142.250"></a><span id="l142.250" class="difflineminus">-}</span>
<a href="#l142.251"></a><span id="l142.251" class="difflineplus">+});</span>
<a href="#l142.252"></a><span id="l142.252"> </span>
<a href="#l142.253"></a><span id="l142.253"> /**</span>
<a href="#l142.254"></a><span id="l142.254">  * Test &quot;one before&quot; deletion in the message tab.</span>
<a href="#l142.255"></a><span id="l142.255">  */</span>
<a href="#l142.256"></a><span id="l142.256" class="difflineminus">-function test_delete_one_before_message_in_message_tab() {</span>
<a href="#l142.257"></a><span id="l142.257" class="difflineplus">+add_task(function test_delete_one_before_message_in_message_tab() {</span>
<a href="#l142.258"></a><span id="l142.258">   // Open up 3 in a message tab, then select and open up 4 in a background tab</span>
<a href="#l142.259"></a><span id="l142.259">   // and window.</span>
<a href="#l142.260"></a><span id="l142.260">   select_click_row(3);</span>
<a href="#l142.261"></a><span id="l142.261">   tabMessage = open_selected_message_in_new_tab(true);</span>
<a href="#l142.262"></a><span id="l142.262">   let expectedMessage = select_click_row(4);</span>
<a href="#l142.263"></a><span id="l142.263">   tabMessageBackground = open_selected_message_in_new_tab(true);</span>
<a href="#l142.264"></a><span id="l142.264">   msgc = open_selected_message_in_new_window(true);</span>
<a href="#l142.265"></a><span id="l142.265"> </span>
<a href="#l142.266"></a><span id="l142.266" class="difflineat">@@ -369,22 +371,22 @@ function test_delete_one_before_message_</span>
<a href="#l142.267"></a><span id="l142.267">     expectedMessage</span>
<a href="#l142.268"></a><span id="l142.268">   );</span>
<a href="#l142.269"></a><span id="l142.269"> </span>
<a href="#l142.270"></a><span id="l142.270">   // Clean up, close everything</span>
<a href="#l142.271"></a><span id="l142.271">   close_message_window(msgc);</span>
<a href="#l142.272"></a><span id="l142.272">   close_tab(tabMessage);</span>
<a href="#l142.273"></a><span id="l142.273">   close_tab(tabMessageBackground);</span>
<a href="#l142.274"></a><span id="l142.274">   switch_tab(tabFolder);</span>
<a href="#l142.275"></a><span id="l142.275" class="difflineminus">-}</span>
<a href="#l142.276"></a><span id="l142.276" class="difflineplus">+});</span>
<a href="#l142.277"></a><span id="l142.277"> </span>
<a href="#l142.278"></a><span id="l142.278"> /**</span>
<a href="#l142.279"></a><span id="l142.279">  * Test &quot;one before&quot; deletion in the message window.</span>
<a href="#l142.280"></a><span id="l142.280">  */</span>
<a href="#l142.281"></a><span id="l142.281" class="difflineminus">-function test_delete_one_before_message_in_message_window() {</span>
<a href="#l142.282"></a><span id="l142.282" class="difflineplus">+add_task(function test_delete_one_before_message_in_message_window() {</span>
<a href="#l142.283"></a><span id="l142.283">   // Open up 3 in a message window, then select and open up 4 in a background</span>
<a href="#l142.284"></a><span id="l142.284">   // and a foreground tab.</span>
<a href="#l142.285"></a><span id="l142.285">   select_click_row(3);</span>
<a href="#l142.286"></a><span id="l142.286">   msgc = open_selected_message_in_new_window();</span>
<a href="#l142.287"></a><span id="l142.287">   let expectedMessage = select_click_row(4);</span>
<a href="#l142.288"></a><span id="l142.288">   tabMessage = open_selected_message_in_new_tab();</span>
<a href="#l142.289"></a><span id="l142.289">   switch_tab(tabFolder);</span>
<a href="#l142.290"></a><span id="l142.290">   tabMessageBackground = open_selected_message_in_new_tab(true);</span>
<a href="#l142.291"></a><span id="l142.291" class="difflineat">@@ -399,26 +401,26 @@ function test_delete_one_before_message_</span>
<a href="#l142.292"></a><span id="l142.292">     expectedMessage</span>
<a href="#l142.293"></a><span id="l142.293">   );</span>
<a href="#l142.294"></a><span id="l142.294"> </span>
<a href="#l142.295"></a><span id="l142.295">   // Clean up, close everything</span>
<a href="#l142.296"></a><span id="l142.296">   close_message_window(msgc);</span>
<a href="#l142.297"></a><span id="l142.297">   close_tab(tabMessage);</span>
<a href="#l142.298"></a><span id="l142.298">   close_tab(tabMessageBackground);</span>
<a href="#l142.299"></a><span id="l142.299">   switch_tab(tabFolder);</span>
<a href="#l142.300"></a><span id="l142.300" class="difflineminus">-}</span>
<a href="#l142.301"></a><span id="l142.301" class="difflineplus">+});</span>
<a href="#l142.302"></a><span id="l142.302"> </span>
<a href="#l142.303"></a><span id="l142.303"> /*</span>
<a href="#l142.304"></a><span id="l142.304">  * Now do all of that again, but this time delete the message _after_ the open one.</span>
<a href="#l142.305"></a><span id="l142.305">  */</span>
<a href="#l142.306"></a><span id="l142.306"> </span>
<a href="#l142.307"></a><span id="l142.307"> /**</span>
<a href="#l142.308"></a><span id="l142.308">  * Test &quot;one after&quot; deletion in the folder tab.</span>
<a href="#l142.309"></a><span id="l142.309">  */</span>
<a href="#l142.310"></a><span id="l142.310" class="difflineminus">-function test_delete_one_after_message_in_folder_tab() {</span>
<a href="#l142.311"></a><span id="l142.311" class="difflineplus">+add_task(function test_delete_one_after_message_in_folder_tab() {</span>
<a href="#l142.312"></a><span id="l142.312">   // Open up message 4 in message tabs and a window (we'll delete message 5).</span>
<a href="#l142.313"></a><span id="l142.313">   _open_message_in_all_four_display_mechanisms_helper(oneAfterFolder, 4);</span>
<a href="#l142.314"></a><span id="l142.314"> </span>
<a href="#l142.315"></a><span id="l142.315">   let expectedMessage = mc.dbView.getMsgHdrAt(4);</span>
<a href="#l142.316"></a><span id="l142.316">   select_click_row(5);</span>
<a href="#l142.317"></a><span id="l142.317">   press_delete();</span>
<a href="#l142.318"></a><span id="l142.318"> </span>
<a href="#l142.319"></a><span id="l142.319">   // The message tab, background message tab and window shouldn't have changed</span>
<a href="#l142.320"></a><span id="l142.320" class="difflineat">@@ -427,22 +429,22 @@ function test_delete_one_after_message_i</span>
<a href="#l142.321"></a><span id="l142.321">     expectedMessage</span>
<a href="#l142.322"></a><span id="l142.322">   );</span>
<a href="#l142.323"></a><span id="l142.323"> </span>
<a href="#l142.324"></a><span id="l142.324">   // Clean up, close everything</span>
<a href="#l142.325"></a><span id="l142.325">   close_message_window(msgc);</span>
<a href="#l142.326"></a><span id="l142.326">   close_tab(tabMessage);</span>
<a href="#l142.327"></a><span id="l142.327">   close_tab(tabMessageBackground);</span>
<a href="#l142.328"></a><span id="l142.328">   switch_tab(tabFolder);</span>
<a href="#l142.329"></a><span id="l142.329" class="difflineminus">-}</span>
<a href="#l142.330"></a><span id="l142.330" class="difflineplus">+});</span>
<a href="#l142.331"></a><span id="l142.331"> </span>
<a href="#l142.332"></a><span id="l142.332"> /**</span>
<a href="#l142.333"></a><span id="l142.333">  * Test &quot;one after&quot; deletion in the message tab.</span>
<a href="#l142.334"></a><span id="l142.334">  */</span>
<a href="#l142.335"></a><span id="l142.335" class="difflineminus">-function test_delete_one_after_message_in_message_tab() {</span>
<a href="#l142.336"></a><span id="l142.336" class="difflineplus">+add_task(function test_delete_one_after_message_in_message_tab() {</span>
<a href="#l142.337"></a><span id="l142.337">   // Open up 5 in a message tab, then select and open up 4 in a background tab</span>
<a href="#l142.338"></a><span id="l142.338">   // and window.</span>
<a href="#l142.339"></a><span id="l142.339">   select_click_row(5);</span>
<a href="#l142.340"></a><span id="l142.340">   tabMessage = open_selected_message_in_new_tab(true);</span>
<a href="#l142.341"></a><span id="l142.341">   let expectedMessage = select_click_row(4);</span>
<a href="#l142.342"></a><span id="l142.342">   tabMessageBackground = open_selected_message_in_new_tab(true);</span>
<a href="#l142.343"></a><span id="l142.343">   msgc = open_selected_message_in_new_window(true);</span>
<a href="#l142.344"></a><span id="l142.344"> </span>
<a href="#l142.345"></a><span id="l142.345" class="difflineat">@@ -456,22 +458,22 @@ function test_delete_one_after_message_i</span>
<a href="#l142.346"></a><span id="l142.346">     expectedMessage</span>
<a href="#l142.347"></a><span id="l142.347">   );</span>
<a href="#l142.348"></a><span id="l142.348"> </span>
<a href="#l142.349"></a><span id="l142.349">   // Clean up, close everything</span>
<a href="#l142.350"></a><span id="l142.350">   close_message_window(msgc);</span>
<a href="#l142.351"></a><span id="l142.351">   close_tab(tabMessage);</span>
<a href="#l142.352"></a><span id="l142.352">   close_tab(tabMessageBackground);</span>
<a href="#l142.353"></a><span id="l142.353">   switch_tab(tabFolder);</span>
<a href="#l142.354"></a><span id="l142.354" class="difflineminus">-}</span>
<a href="#l142.355"></a><span id="l142.355" class="difflineplus">+});</span>
<a href="#l142.356"></a><span id="l142.356"> </span>
<a href="#l142.357"></a><span id="l142.357"> /**</span>
<a href="#l142.358"></a><span id="l142.358">  * Test &quot;one after&quot; deletion in the message window.</span>
<a href="#l142.359"></a><span id="l142.359">  */</span>
<a href="#l142.360"></a><span id="l142.360" class="difflineminus">-function test_delete_one_after_message_in_message_window() {</span>
<a href="#l142.361"></a><span id="l142.361" class="difflineplus">+add_task(function test_delete_one_after_message_in_message_window() {</span>
<a href="#l142.362"></a><span id="l142.362">   // Open up 5 in a message window, then select and open up 4 in a background</span>
<a href="#l142.363"></a><span id="l142.363">   // and a foreground tab.</span>
<a href="#l142.364"></a><span id="l142.364">   select_click_row(5);</span>
<a href="#l142.365"></a><span id="l142.365">   msgc = open_selected_message_in_new_window();</span>
<a href="#l142.366"></a><span id="l142.366">   let expectedMessage = select_click_row(4);</span>
<a href="#l142.367"></a><span id="l142.367">   tabMessage = open_selected_message_in_new_tab();</span>
<a href="#l142.368"></a><span id="l142.368">   switch_tab(tabFolder);</span>
<a href="#l142.369"></a><span id="l142.369">   tabMessageBackground = open_selected_message_in_new_tab(true);</span>
<a href="#l142.370"></a><span id="l142.370" class="difflineat">@@ -486,232 +488,259 @@ function test_delete_one_after_message_i</span>
<a href="#l142.371"></a><span id="l142.371">     expectedMessage</span>
<a href="#l142.372"></a><span id="l142.372">   );</span>
<a href="#l142.373"></a><span id="l142.373"> </span>
<a href="#l142.374"></a><span id="l142.374">   // Clean up, close everything</span>
<a href="#l142.375"></a><span id="l142.375">   close_message_window(msgc);</span>
<a href="#l142.376"></a><span id="l142.376">   close_tab(tabMessage);</span>
<a href="#l142.377"></a><span id="l142.377">   close_tab(tabMessageBackground);</span>
<a href="#l142.378"></a><span id="l142.378">   switch_tab(tabFolder);</span>
<a href="#l142.379"></a><span id="l142.379" class="difflineminus">-}</span>
<a href="#l142.380"></a><span id="l142.380" class="difflineplus">+});</span>
<a href="#l142.381"></a><span id="l142.381"> </span>
<a href="#l142.382"></a><span id="l142.382"> /*</span>
<a href="#l142.383"></a><span id="l142.383">  * Delete multiple messages in a folder tab. Make sure message displays at the</span>
<a href="#l142.384"></a><span id="l142.384">  * beginning, middle and end of a selection work out.</span>
<a href="#l142.385"></a><span id="l142.385">  */</span>
<a href="#l142.386"></a><span id="l142.386"> </span>
<a href="#l142.387"></a><span id="l142.387"> /**</span>
<a href="#l142.388"></a><span id="l142.388">  * Test deleting multiple messages in a folder tab, with message displays open</span>
<a href="#l142.389"></a><span id="l142.389">  * to the beginning of a selection.</span>
<a href="#l142.390"></a><span id="l142.390">  */</span>
<a href="#l142.391"></a><span id="l142.391" class="difflineminus">-function test_delete_multiple_messages_with_first_selected_message_open() {</span>
<a href="#l142.392"></a><span id="l142.392" class="difflineminus">-  // Open up 2 in a message tab, background tab, and message window.</span>
<a href="#l142.393"></a><span id="l142.393" class="difflineminus">-  _open_message_in_all_four_display_mechanisms_helper(</span>
<a href="#l142.394"></a><span id="l142.394" class="difflineminus">-    multipleDeletionFolder1,</span>
<a href="#l142.395"></a><span id="l142.395" class="difflineminus">-    2</span>
<a href="#l142.396"></a><span id="l142.396" class="difflineminus">-  );</span>
<a href="#l142.397"></a><span id="l142.397" class="difflineplus">+add_task(</span>
<a href="#l142.398"></a><span id="l142.398" class="difflineplus">+  function test_delete_multiple_messages_with_first_selected_message_open() {</span>
<a href="#l142.399"></a><span id="l142.399" class="difflineplus">+    // Open up 2 in a message tab, background tab, and message window.</span>
<a href="#l142.400"></a><span id="l142.400" class="difflineplus">+    _open_message_in_all_four_display_mechanisms_helper(</span>
<a href="#l142.401"></a><span id="l142.401" class="difflineplus">+      multipleDeletionFolder1,</span>
<a href="#l142.402"></a><span id="l142.402" class="difflineplus">+      2</span>
<a href="#l142.403"></a><span id="l142.403" class="difflineplus">+    );</span>
<a href="#l142.404"></a><span id="l142.404"> </span>
<a href="#l142.405"></a><span id="l142.405" class="difflineminus">-  // We'll select 2-5, 8, 9 and 10. We expect 6 to be the next displayed</span>
<a href="#l142.406"></a><span id="l142.406" class="difflineminus">-  // message.</span>
<a href="#l142.407"></a><span id="l142.407" class="difflineminus">-  select_click_row(2);</span>
<a href="#l142.408"></a><span id="l142.408" class="difflineminus">-  select_shift_click_row(5);</span>
<a href="#l142.409"></a><span id="l142.409" class="difflineminus">-  select_control_click_row(8);</span>
<a href="#l142.410"></a><span id="l142.410" class="difflineminus">-  select_control_click_row(9);</span>
<a href="#l142.411"></a><span id="l142.411" class="difflineminus">-  select_control_click_row(10);</span>
<a href="#l142.412"></a><span id="l142.412" class="difflineminus">-  let expectedMessage = mc.dbView.getMsgHdrAt(6);</span>
<a href="#l142.413"></a><span id="l142.413" class="difflineplus">+    // We'll select 2-5, 8, 9 and 10. We expect 6 to be the next displayed</span>
<a href="#l142.414"></a><span id="l142.414" class="difflineplus">+    // message.</span>
<a href="#l142.415"></a><span id="l142.415" class="difflineplus">+    select_click_row(2);</span>
<a href="#l142.416"></a><span id="l142.416" class="difflineplus">+    select_shift_click_row(5);</span>
<a href="#l142.417"></a><span id="l142.417" class="difflineplus">+    select_control_click_row(8);</span>
<a href="#l142.418"></a><span id="l142.418" class="difflineplus">+    select_control_click_row(9);</span>
<a href="#l142.419"></a><span id="l142.419" class="difflineplus">+    select_control_click_row(10);</span>
<a href="#l142.420"></a><span id="l142.420" class="difflineplus">+    let expectedMessage = mc.dbView.getMsgHdrAt(6);</span>
<a href="#l142.421"></a><span id="l142.421"> </span>
<a href="#l142.422"></a><span id="l142.422" class="difflineminus">-  // Delete the selected messages</span>
<a href="#l142.423"></a><span id="l142.423" class="difflineminus">-  press_delete();</span>
<a href="#l142.424"></a><span id="l142.424" class="difflineplus">+    // Delete the selected messages</span>
<a href="#l142.425"></a><span id="l142.425" class="difflineplus">+    press_delete();</span>
<a href="#l142.426"></a><span id="l142.426"> </span>
<a href="#l142.427"></a><span id="l142.427" class="difflineminus">-  // All the displays should now be showing the expectedMessage</span>
<a href="#l142.428"></a><span id="l142.428" class="difflineminus">-  _verify_message_is_displayed_in(VERIFY_ALL, expectedMessage);</span>
<a href="#l142.429"></a><span id="l142.429" class="difflineplus">+    // All the displays should now be showing the expectedMessage</span>
<a href="#l142.430"></a><span id="l142.430" class="difflineplus">+    _verify_message_is_displayed_in(VERIFY_ALL, expectedMessage);</span>
<a href="#l142.431"></a><span id="l142.431"> </span>
<a href="#l142.432"></a><span id="l142.432" class="difflineminus">-  // Clean up, close everything</span>
<a href="#l142.433"></a><span id="l142.433" class="difflineminus">-  close_message_window(msgc);</span>
<a href="#l142.434"></a><span id="l142.434" class="difflineminus">-  close_tab(tabMessage);</span>
<a href="#l142.435"></a><span id="l142.435" class="difflineminus">-  close_tab(tabMessageBackground);</span>
<a href="#l142.436"></a><span id="l142.436" class="difflineminus">-  switch_tab(tabFolder);</span>
<a href="#l142.437"></a><span id="l142.437" class="difflineminus">-}</span>
<a href="#l142.438"></a><span id="l142.438" class="difflineplus">+    // Clean up, close everything</span>
<a href="#l142.439"></a><span id="l142.439" class="difflineplus">+    close_message_window(msgc);</span>
<a href="#l142.440"></a><span id="l142.440" class="difflineplus">+    close_tab(tabMessage);</span>
<a href="#l142.441"></a><span id="l142.441" class="difflineplus">+    close_tab(tabMessageBackground);</span>
<a href="#l142.442"></a><span id="l142.442" class="difflineplus">+    switch_tab(tabFolder);</span>
<a href="#l142.443"></a><span id="l142.443" class="difflineplus">+  }</span>
<a href="#l142.444"></a><span id="l142.444" class="difflineplus">+);</span>
<a href="#l142.445"></a><span id="l142.445"> </span>
<a href="#l142.446"></a><span id="l142.446"> /**</span>
<a href="#l142.447"></a><span id="l142.447">  * Test deleting multiple messages in a folder tab, with message displays open</span>
<a href="#l142.448"></a><span id="l142.448">  * to somewhere in the middle of a selection.</span>
<a href="#l142.449"></a><span id="l142.449">  */</span>
<a href="#l142.450"></a><span id="l142.450" class="difflineminus">-function test_delete_multiple_messages_with_nth_selected_message_open() {</span>
<a href="#l142.451"></a><span id="l142.451" class="difflineminus">-  // Open up 9 in a message tab, background tab, and message window.</span>
<a href="#l142.452"></a><span id="l142.452" class="difflineminus">-  _open_message_in_all_four_display_mechanisms_helper(</span>
<a href="#l142.453"></a><span id="l142.453" class="difflineminus">-    multipleDeletionFolder1,</span>
<a href="#l142.454"></a><span id="l142.454" class="difflineminus">-    9</span>
<a href="#l142.455"></a><span id="l142.455" class="difflineminus">-  );</span>
<a href="#l142.456"></a><span id="l142.456" class="difflineplus">+add_task(</span>
<a href="#l142.457"></a><span id="l142.457" class="difflineplus">+  function test_delete_multiple_messages_with_nth_selected_message_open() {</span>
<a href="#l142.458"></a><span id="l142.458" class="difflineplus">+    // Open up 9 in a message tab, background tab, and message window.</span>
<a href="#l142.459"></a><span id="l142.459" class="difflineplus">+    _open_message_in_all_four_display_mechanisms_helper(</span>
<a href="#l142.460"></a><span id="l142.460" class="difflineplus">+      multipleDeletionFolder1,</span>
<a href="#l142.461"></a><span id="l142.461" class="difflineplus">+      9</span>
<a href="#l142.462"></a><span id="l142.462" class="difflineplus">+    );</span>
<a href="#l142.463"></a><span id="l142.463"> </span>
<a href="#l142.464"></a><span id="l142.464" class="difflineminus">-  // We'll select 2-5, 8, 9 and 10. We expect 11 to be the next displayed</span>
<a href="#l142.465"></a><span id="l142.465" class="difflineminus">-  // message.</span>
<a href="#l142.466"></a><span id="l142.466" class="difflineminus">-  select_click_row(2);</span>
<a href="#l142.467"></a><span id="l142.467" class="difflineminus">-  select_shift_click_row(5);</span>
<a href="#l142.468"></a><span id="l142.468" class="difflineminus">-  select_control_click_row(8);</span>
<a href="#l142.469"></a><span id="l142.469" class="difflineminus">-  select_control_click_row(9);</span>
<a href="#l142.470"></a><span id="l142.470" class="difflineminus">-  select_control_click_row(10);</span>
<a href="#l142.471"></a><span id="l142.471" class="difflineminus">-  let expectedMessage = mc.dbView.getMsgHdrAt(11);</span>
<a href="#l142.472"></a><span id="l142.472" class="difflineplus">+    // We'll select 2-5, 8, 9 and 10. We expect 11 to be the next displayed</span>
<a href="#l142.473"></a><span id="l142.473" class="difflineplus">+    // message.</span>
<a href="#l142.474"></a><span id="l142.474" class="difflineplus">+    select_click_row(2);</span>
<a href="#l142.475"></a><span id="l142.475" class="difflineplus">+    select_shift_click_row(5);</span>
<a href="#l142.476"></a><span id="l142.476" class="difflineplus">+    select_control_click_row(8);</span>
<a href="#l142.477"></a><span id="l142.477" class="difflineplus">+    select_control_click_row(9);</span>
<a href="#l142.478"></a><span id="l142.478" class="difflineplus">+    select_control_click_row(10);</span>
<a href="#l142.479"></a><span id="l142.479" class="difflineplus">+    let expectedMessage = mc.dbView.getMsgHdrAt(11);</span>
<a href="#l142.480"></a><span id="l142.480"> </span>
<a href="#l142.481"></a><span id="l142.481" class="difflineminus">-  // Delete the selected messages</span>
<a href="#l142.482"></a><span id="l142.482" class="difflineminus">-  press_delete();</span>
<a href="#l142.483"></a><span id="l142.483" class="difflineplus">+    // Delete the selected messages</span>
<a href="#l142.484"></a><span id="l142.484" class="difflineplus">+    press_delete();</span>
<a href="#l142.485"></a><span id="l142.485"> </span>
<a href="#l142.486"></a><span id="l142.486" class="difflineminus">-  // The folder tab should now be showing message 2</span>
<a href="#l142.487"></a><span id="l142.487" class="difflineminus">-  assert_selected_and_displayed(2);</span>
<a href="#l142.488"></a><span id="l142.488" class="difflineplus">+    // The folder tab should now be showing message 2</span>
<a href="#l142.489"></a><span id="l142.489" class="difflineplus">+    assert_selected_and_displayed(2);</span>
<a href="#l142.490"></a><span id="l142.490"> </span>
<a href="#l142.491"></a><span id="l142.491" class="difflineminus">-  // The other displays should now be showing the expectedMessage</span>
<a href="#l142.492"></a><span id="l142.492" class="difflineminus">-  _verify_message_is_displayed_in(</span>
<a href="#l142.493"></a><span id="l142.493" class="difflineminus">-    VERIFY_MESSAGE_TAB | VERIFY_BACKGROUND_MESSAGE_TAB | VERIFY_MESSAGE_WINDOW,</span>
<a href="#l142.494"></a><span id="l142.494" class="difflineminus">-    expectedMessage</span>
<a href="#l142.495"></a><span id="l142.495" class="difflineminus">-  );</span>
<a href="#l142.496"></a><span id="l142.496" class="difflineplus">+    // The other displays should now be showing the expectedMessage</span>
<a href="#l142.497"></a><span id="l142.497" class="difflineplus">+    _verify_message_is_displayed_in(</span>
<a href="#l142.498"></a><span id="l142.498" class="difflineplus">+      VERIFY_MESSAGE_TAB |</span>
<a href="#l142.499"></a><span id="l142.499" class="difflineplus">+        VERIFY_BACKGROUND_MESSAGE_TAB |</span>
<a href="#l142.500"></a><span id="l142.500" class="difflineplus">+        VERIFY_MESSAGE_WINDOW,</span>
<a href="#l142.501"></a><span id="l142.501" class="difflineplus">+      expectedMessage</span>
<a href="#l142.502"></a><span id="l142.502" class="difflineplus">+    );</span>
<a href="#l142.503"></a><span id="l142.503"> </span>
<a href="#l142.504"></a><span id="l142.504" class="difflineminus">-  // Clean up, close everything</span>
<a href="#l142.505"></a><span id="l142.505" class="difflineminus">-  close_message_window(msgc);</span>
<a href="#l142.506"></a><span id="l142.506" class="difflineminus">-  close_tab(tabMessage);</span>
<a href="#l142.507"></a><span id="l142.507" class="difflineminus">-  close_tab(tabMessageBackground);</span>
<a href="#l142.508"></a><span id="l142.508" class="difflineminus">-  switch_tab(tabFolder);</span>
<a href="#l142.509"></a><span id="l142.509" class="difflineminus">-}</span>
<a href="#l142.510"></a><span id="l142.510" class="difflineplus">+    // Clean up, close everything</span>
<a href="#l142.511"></a><span id="l142.511" class="difflineplus">+    close_message_window(msgc);</span>
<a href="#l142.512"></a><span id="l142.512" class="difflineplus">+    close_tab(tabMessage);</span>
<a href="#l142.513"></a><span id="l142.513" class="difflineplus">+    close_tab(tabMessageBackground);</span>
<a href="#l142.514"></a><span id="l142.514" class="difflineplus">+    switch_tab(tabFolder);</span>
<a href="#l142.515"></a><span id="l142.515" class="difflineplus">+  }</span>
<a href="#l142.516"></a><span id="l142.516" class="difflineplus">+);</span>
<a href="#l142.517"></a><span id="l142.517"> </span>
<a href="#l142.518"></a><span id="l142.518"> /**</span>
<a href="#l142.519"></a><span id="l142.519">  * Test deleting multiple messages in a folder tab, with message displays open</span>
<a href="#l142.520"></a><span id="l142.520">  * to the end of a selection.</span>
<a href="#l142.521"></a><span id="l142.521">  */</span>
<a href="#l142.522"></a><span id="l142.522" class="difflineminus">-function test_delete_multiple_messages_with_last_selected_message_open() {</span>
<a href="#l142.523"></a><span id="l142.523" class="difflineminus">-  // Open up 10 in a message tab, background tab, and message window.</span>
<a href="#l142.524"></a><span id="l142.524" class="difflineminus">-  _open_message_in_all_four_display_mechanisms_helper(</span>
<a href="#l142.525"></a><span id="l142.525" class="difflineminus">-    multipleDeletionFolder1,</span>
<a href="#l142.526"></a><span id="l142.526" class="difflineminus">-    9</span>
<a href="#l142.527"></a><span id="l142.527" class="difflineminus">-  );</span>
<a href="#l142.528"></a><span id="l142.528" class="difflineplus">+add_task(</span>
<a href="#l142.529"></a><span id="l142.529" class="difflineplus">+  function test_delete_multiple_messages_with_last_selected_message_open() {</span>
<a href="#l142.530"></a><span id="l142.530" class="difflineplus">+    // Open up 10 in a message tab, background tab, and message window.</span>
<a href="#l142.531"></a><span id="l142.531" class="difflineplus">+    _open_message_in_all_four_display_mechanisms_helper(</span>
<a href="#l142.532"></a><span id="l142.532" class="difflineplus">+      multipleDeletionFolder1,</span>
<a href="#l142.533"></a><span id="l142.533" class="difflineplus">+      9</span>
<a href="#l142.534"></a><span id="l142.534" class="difflineplus">+    );</span>
<a href="#l142.535"></a><span id="l142.535"> </span>
<a href="#l142.536"></a><span id="l142.536" class="difflineminus">-  // We'll select 2-5, 8, 9 and 10. We expect 11 to be the next displayed</span>
<a href="#l142.537"></a><span id="l142.537" class="difflineminus">-  // message.</span>
<a href="#l142.538"></a><span id="l142.538" class="difflineminus">-  select_click_row(2);</span>
<a href="#l142.539"></a><span id="l142.539" class="difflineminus">-  select_shift_click_row(5);</span>
<a href="#l142.540"></a><span id="l142.540" class="difflineminus">-  select_control_click_row(8);</span>
<a href="#l142.541"></a><span id="l142.541" class="difflineminus">-  select_control_click_row(9);</span>
<a href="#l142.542"></a><span id="l142.542" class="difflineminus">-  select_control_click_row(10);</span>
<a href="#l142.543"></a><span id="l142.543" class="difflineminus">-  let expectedMessage = mc.dbView.getMsgHdrAt(11);</span>
<a href="#l142.544"></a><span id="l142.544" class="difflineplus">+    // We'll select 2-5, 8, 9 and 10. We expect 11 to be the next displayed</span>
<a href="#l142.545"></a><span id="l142.545" class="difflineplus">+    // message.</span>
<a href="#l142.546"></a><span id="l142.546" class="difflineplus">+    select_click_row(2);</span>
<a href="#l142.547"></a><span id="l142.547" class="difflineplus">+    select_shift_click_row(5);</span>
<a href="#l142.548"></a><span id="l142.548" class="difflineplus">+    select_control_click_row(8);</span>
<a href="#l142.549"></a><span id="l142.549" class="difflineplus">+    select_control_click_row(9);</span>
<a href="#l142.550"></a><span id="l142.550" class="difflineplus">+    select_control_click_row(10);</span>
<a href="#l142.551"></a><span id="l142.551" class="difflineplus">+    let expectedMessage = mc.dbView.getMsgHdrAt(11);</span>
<a href="#l142.552"></a><span id="l142.552"> </span>
<a href="#l142.553"></a><span id="l142.553" class="difflineminus">-  // Delete the selected messages</span>
<a href="#l142.554"></a><span id="l142.554" class="difflineminus">-  press_delete();</span>
<a href="#l142.555"></a><span id="l142.555" class="difflineplus">+    // Delete the selected messages</span>
<a href="#l142.556"></a><span id="l142.556" class="difflineplus">+    press_delete();</span>
<a href="#l142.557"></a><span id="l142.557"> </span>
<a href="#l142.558"></a><span id="l142.558" class="difflineminus">-  // The folder tab should now be showing message 2</span>
<a href="#l142.559"></a><span id="l142.559" class="difflineminus">-  assert_selected_and_displayed(2);</span>
<a href="#l142.560"></a><span id="l142.560" class="difflineplus">+    // The folder tab should now be showing message 2</span>
<a href="#l142.561"></a><span id="l142.561" class="difflineplus">+    assert_selected_and_displayed(2);</span>
<a href="#l142.562"></a><span id="l142.562"> </span>
<a href="#l142.563"></a><span id="l142.563" class="difflineminus">-  // The other displays should now be showing the expectedMessage</span>
<a href="#l142.564"></a><span id="l142.564" class="difflineminus">-  _verify_message_is_displayed_in(</span>
<a href="#l142.565"></a><span id="l142.565" class="difflineminus">-    VERIFY_MESSAGE_TAB | VERIFY_BACKGROUND_MESSAGE_TAB | VERIFY_MESSAGE_WINDOW,</span>
<a href="#l142.566"></a><span id="l142.566" class="difflineminus">-    expectedMessage</span>
<a href="#l142.567"></a><span id="l142.567" class="difflineminus">-  );</span>
<a href="#l142.568"></a><span id="l142.568" class="difflineminus">-  // Clean up, close everything</span>
<a href="#l142.569"></a><span id="l142.569" class="difflineminus">-  close_message_window(msgc);</span>
<a href="#l142.570"></a><span id="l142.570" class="difflineminus">-  close_tab(tabMessage);</span>
<a href="#l142.571"></a><span id="l142.571" class="difflineminus">-  close_tab(tabMessageBackground);</span>
<a href="#l142.572"></a><span id="l142.572" class="difflineminus">-  switch_tab(tabFolder);</span>
<a href="#l142.573"></a><span id="l142.573" class="difflineminus">-}</span>
<a href="#l142.574"></a><span id="l142.574" class="difflineplus">+    // The other displays should now be showing the expectedMessage</span>
<a href="#l142.575"></a><span id="l142.575" class="difflineplus">+    _verify_message_is_displayed_in(</span>
<a href="#l142.576"></a><span id="l142.576" class="difflineplus">+      VERIFY_MESSAGE_TAB |</span>
<a href="#l142.577"></a><span id="l142.577" class="difflineplus">+        VERIFY_BACKGROUND_MESSAGE_TAB |</span>
<a href="#l142.578"></a><span id="l142.578" class="difflineplus">+        VERIFY_MESSAGE_WINDOW,</span>
<a href="#l142.579"></a><span id="l142.579" class="difflineplus">+      expectedMessage</span>
<a href="#l142.580"></a><span id="l142.580" class="difflineplus">+    );</span>
<a href="#l142.581"></a><span id="l142.581" class="difflineplus">+    // Clean up, close everything</span>
<a href="#l142.582"></a><span id="l142.582" class="difflineplus">+    close_message_window(msgc);</span>
<a href="#l142.583"></a><span id="l142.583" class="difflineplus">+    close_tab(tabMessage);</span>
<a href="#l142.584"></a><span id="l142.584" class="difflineplus">+    close_tab(tabMessageBackground);</span>
<a href="#l142.585"></a><span id="l142.585" class="difflineplus">+    switch_tab(tabFolder);</span>
<a href="#l142.586"></a><span id="l142.586" class="difflineplus">+  }</span>
<a href="#l142.587"></a><span id="l142.587" class="difflineplus">+);</span>
<a href="#l142.588"></a><span id="l142.588"> </span>
<a href="#l142.589"></a><span id="l142.589"> /**</span>
<a href="#l142.590"></a><span id="l142.590">  * Test deleting multiple messages in a folder tab (including the last one!),</span>
<a href="#l142.591"></a><span id="l142.591">  * with message displays open to the beginning of a selection.</span>
<a href="#l142.592"></a><span id="l142.592">  */</span>
<a href="#l142.593"></a><span id="l142.593" class="difflineminus">-function test_delete_multiple_messages_including_the_last_one_with_first_open() {</span>
<a href="#l142.594"></a><span id="l142.594" class="difflineminus">-  // 10 messages in this folder. Open up message 1 everywhere.</span>
<a href="#l142.595"></a><span id="l142.595" class="difflineminus">-  _open_message_in_all_four_display_mechanisms_helper(</span>
<a href="#l142.596"></a><span id="l142.596" class="difflineminus">-    multipleDeletionFolder2,</span>
<a href="#l142.597"></a><span id="l142.597" class="difflineminus">-    1</span>
<a href="#l142.598"></a><span id="l142.598" class="difflineminus">-  );</span>
<a href="#l142.599"></a><span id="l142.599" class="difflineplus">+add_task(</span>
<a href="#l142.600"></a><span id="l142.600" class="difflineplus">+  function test_delete_multiple_messages_including_the_last_one_with_first_open() {</span>
<a href="#l142.601"></a><span id="l142.601" class="difflineplus">+    // 10 messages in this folder. Open up message 1 everywhere.</span>
<a href="#l142.602"></a><span id="l142.602" class="difflineplus">+    _open_message_in_all_four_display_mechanisms_helper(</span>
<a href="#l142.603"></a><span id="l142.603" class="difflineplus">+      multipleDeletionFolder2,</span>
<a href="#l142.604"></a><span id="l142.604" class="difflineplus">+      1</span>
<a href="#l142.605"></a><span id="l142.605" class="difflineplus">+    );</span>
<a href="#l142.606"></a><span id="l142.606"> </span>
<a href="#l142.607"></a><span id="l142.607" class="difflineminus">-  // We'll select 1-4, 7, 8 and 9. We expect 5 to be the next displayed message.</span>
<a href="#l142.608"></a><span id="l142.608" class="difflineminus">-  select_click_row(1);</span>
<a href="#l142.609"></a><span id="l142.609" class="difflineminus">-  select_shift_click_row(4);</span>
<a href="#l142.610"></a><span id="l142.610" class="difflineminus">-  select_control_click_row(7);</span>
<a href="#l142.611"></a><span id="l142.611" class="difflineminus">-  select_control_click_row(8);</span>
<a href="#l142.612"></a><span id="l142.612" class="difflineminus">-  select_control_click_row(9);</span>
<a href="#l142.613"></a><span id="l142.613" class="difflineminus">-  let expectedMessage = mc.dbView.getMsgHdrAt(5);</span>
<a href="#l142.614"></a><span id="l142.614" class="difflineplus">+    // We'll select 1-4, 7, 8 and 9. We expect 5 to be the next displayed message.</span>
<a href="#l142.615"></a><span id="l142.615" class="difflineplus">+    select_click_row(1);</span>
<a href="#l142.616"></a><span id="l142.616" class="difflineplus">+    select_shift_click_row(4);</span>
<a href="#l142.617"></a><span id="l142.617" class="difflineplus">+    select_control_click_row(7);</span>
<a href="#l142.618"></a><span id="l142.618" class="difflineplus">+    select_control_click_row(8);</span>
<a href="#l142.619"></a><span id="l142.619" class="difflineplus">+    select_control_click_row(9);</span>
<a href="#l142.620"></a><span id="l142.620" class="difflineplus">+    let expectedMessage = mc.dbView.getMsgHdrAt(5);</span>
<a href="#l142.621"></a><span id="l142.621" class="difflineplus">+</span>
<a href="#l142.622"></a><span id="l142.622" class="difflineplus">+    // Delete the selected messages</span>
<a href="#l142.623"></a><span id="l142.623" class="difflineplus">+    press_delete();</span>
<a href="#l142.624"></a><span id="l142.624"> </span>
<a href="#l142.625"></a><span id="l142.625" class="difflineminus">-  // Delete the selected messages</span>
<a href="#l142.626"></a><span id="l142.626" class="difflineminus">-  press_delete();</span>
<a href="#l142.627"></a><span id="l142.627" class="difflineminus">-</span>
<a href="#l142.628"></a><span id="l142.628" class="difflineminus">-  // All the displays should now be showing the expectedMessage</span>
<a href="#l142.629"></a><span id="l142.629" class="difflineminus">-  _verify_message_is_displayed_in(VERIFY_ALL, expectedMessage);</span>
<a href="#l142.630"></a><span id="l142.630" class="difflineplus">+    // All the displays should now be showing the expectedMessage</span>
<a href="#l142.631"></a><span id="l142.631" class="difflineplus">+    _verify_message_is_displayed_in(VERIFY_ALL, expectedMessage);</span>
<a href="#l142.632"></a><span id="l142.632"> </span>
<a href="#l142.633"></a><span id="l142.633" class="difflineminus">-  // Clean up, close everything</span>
<a href="#l142.634"></a><span id="l142.634" class="difflineminus">-  close_message_window(msgc);</span>
<a href="#l142.635"></a><span id="l142.635" class="difflineminus">-  close_tab(tabMessage);</span>
<a href="#l142.636"></a><span id="l142.636" class="difflineminus">-  close_tab(tabMessageBackground);</span>
<a href="#l142.637"></a><span id="l142.637" class="difflineminus">-  switch_tab(tabFolder);</span>
<a href="#l142.638"></a><span id="l142.638" class="difflineminus">-}</span>
<a href="#l142.639"></a><span id="l142.639" class="difflineplus">+    // Clean up, close everything</span>
<a href="#l142.640"></a><span id="l142.640" class="difflineplus">+    close_message_window(msgc);</span>
<a href="#l142.641"></a><span id="l142.641" class="difflineplus">+    close_tab(tabMessage);</span>
<a href="#l142.642"></a><span id="l142.642" class="difflineplus">+    close_tab(tabMessageBackground);</span>
<a href="#l142.643"></a><span id="l142.643" class="difflineplus">+    switch_tab(tabFolder);</span>
<a href="#l142.644"></a><span id="l142.644" class="difflineplus">+  }</span>
<a href="#l142.645"></a><span id="l142.645" class="difflineplus">+);</span>
<a href="#l142.646"></a><span id="l142.646"> </span>
<a href="#l142.647"></a><span id="l142.647"> /**</span>
<a href="#l142.648"></a><span id="l142.648">  * Test deleting multiple messages in a folder tab (including the last one!),</span>
<a href="#l142.649"></a><span id="l142.649">  * with message displays open to the middle of a selection.</span>
<a href="#l142.650"></a><span id="l142.650">  */</span>
<a href="#l142.651"></a><span id="l142.651" class="difflineminus">-function test_delete_multiple_messages_including_the_last_one_with_nth_open() {</span>
<a href="#l142.652"></a><span id="l142.652" class="difflineminus">-  // 10 messages in this folder. Open up message 7 everywhere.</span>
<a href="#l142.653"></a><span id="l142.653" class="difflineminus">-  _open_message_in_all_four_display_mechanisms_helper(</span>
<a href="#l142.654"></a><span id="l142.654" class="difflineminus">-    multipleDeletionFolder3,</span>
<a href="#l142.655"></a><span id="l142.655" class="difflineminus">-    7</span>
<a href="#l142.656"></a><span id="l142.656" class="difflineminus">-  );</span>
<a href="#l142.657"></a><span id="l142.657" class="difflineplus">+add_task(</span>
<a href="#l142.658"></a><span id="l142.658" class="difflineplus">+  function test_delete_multiple_messages_including_the_last_one_with_nth_open() {</span>
<a href="#l142.659"></a><span id="l142.659" class="difflineplus">+    // 10 messages in this folder. Open up message 7 everywhere.</span>
<a href="#l142.660"></a><span id="l142.660" class="difflineplus">+    _open_message_in_all_four_display_mechanisms_helper(</span>
<a href="#l142.661"></a><span id="l142.661" class="difflineplus">+      multipleDeletionFolder3,</span>
<a href="#l142.662"></a><span id="l142.662" class="difflineplus">+      7</span>
<a href="#l142.663"></a><span id="l142.663" class="difflineplus">+    );</span>
<a href="#l142.664"></a><span id="l142.664"> </span>
<a href="#l142.665"></a><span id="l142.665" class="difflineminus">-  // We'll select 1-4, 7, 8 and 9. We expect 6 to be the next displayed message.</span>
<a href="#l142.666"></a><span id="l142.666" class="difflineminus">-  select_click_row(1);</span>
<a href="#l142.667"></a><span id="l142.667" class="difflineminus">-  select_shift_click_row(4);</span>
<a href="#l142.668"></a><span id="l142.668" class="difflineminus">-  select_control_click_row(7);</span>
<a href="#l142.669"></a><span id="l142.669" class="difflineminus">-  select_control_click_row(8);</span>
<a href="#l142.670"></a><span id="l142.670" class="difflineminus">-  select_control_click_row(9);</span>
<a href="#l142.671"></a><span id="l142.671" class="difflineminus">-  let expectedMessage = mc.dbView.getMsgHdrAt(6);</span>
<a href="#l142.672"></a><span id="l142.672" class="difflineplus">+    // We'll select 1-4, 7, 8 and 9. We expect 6 to be the next displayed message.</span>
<a href="#l142.673"></a><span id="l142.673" class="difflineplus">+    select_click_row(1);</span>
<a href="#l142.674"></a><span id="l142.674" class="difflineplus">+    select_shift_click_row(4);</span>
<a href="#l142.675"></a><span id="l142.675" class="difflineplus">+    select_control_click_row(7);</span>
<a href="#l142.676"></a><span id="l142.676" class="difflineplus">+    select_control_click_row(8);</span>
<a href="#l142.677"></a><span id="l142.677" class="difflineplus">+    select_control_click_row(9);</span>
<a href="#l142.678"></a><span id="l142.678" class="difflineplus">+    let expectedMessage = mc.dbView.getMsgHdrAt(6);</span>
<a href="#l142.679"></a><span id="l142.679" class="difflineplus">+</span>
<a href="#l142.680"></a><span id="l142.680" class="difflineplus">+    // Delete the selected messages</span>
<a href="#l142.681"></a><span id="l142.681" class="difflineplus">+    press_delete();</span>
<a href="#l142.682"></a><span id="l142.682"> </span>
<a href="#l142.683"></a><span id="l142.683" class="difflineminus">-  // Delete the selected messages</span>
<a href="#l142.684"></a><span id="l142.684" class="difflineminus">-  press_delete();</span>
<a href="#l142.685"></a><span id="l142.685" class="difflineminus">-</span>
<a href="#l142.686"></a><span id="l142.686" class="difflineminus">-  // The folder tab should now be showing message 1</span>
<a href="#l142.687"></a><span id="l142.687" class="difflineminus">-  assert_selected_and_displayed(1);</span>
<a href="#l142.688"></a><span id="l142.688" class="difflineplus">+    // The folder tab should now be showing message 1</span>
<a href="#l142.689"></a><span id="l142.689" class="difflineplus">+    assert_selected_and_displayed(1);</span>
<a href="#l142.690"></a><span id="l142.690"> </span>
<a href="#l142.691"></a><span id="l142.691" class="difflineminus">-  // The other displays should now be showing the expectedMessage</span>
<a href="#l142.692"></a><span id="l142.692" class="difflineminus">-  _verify_message_is_displayed_in(</span>
<a href="#l142.693"></a><span id="l142.693" class="difflineminus">-    VERIFY_MESSAGE_TAB | VERIFY_BACKGROUND_MESSAGE_TAB | VERIFY_MESSAGE_WINDOW,</span>
<a href="#l142.694"></a><span id="l142.694" class="difflineminus">-    expectedMessage</span>
<a href="#l142.695"></a><span id="l142.695" class="difflineminus">-  );</span>
<a href="#l142.696"></a><span id="l142.696" class="difflineplus">+    // The other displays should now be showing the expectedMessage</span>
<a href="#l142.697"></a><span id="l142.697" class="difflineplus">+    _verify_message_is_displayed_in(</span>
<a href="#l142.698"></a><span id="l142.698" class="difflineplus">+      VERIFY_MESSAGE_TAB |</span>
<a href="#l142.699"></a><span id="l142.699" class="difflineplus">+        VERIFY_BACKGROUND_MESSAGE_TAB |</span>
<a href="#l142.700"></a><span id="l142.700" class="difflineplus">+        VERIFY_MESSAGE_WINDOW,</span>
<a href="#l142.701"></a><span id="l142.701" class="difflineplus">+      expectedMessage</span>
<a href="#l142.702"></a><span id="l142.702" class="difflineplus">+    );</span>
<a href="#l142.703"></a><span id="l142.703"> </span>
<a href="#l142.704"></a><span id="l142.704" class="difflineminus">-  // Clean up, close everything</span>
<a href="#l142.705"></a><span id="l142.705" class="difflineminus">-  close_message_window(msgc);</span>
<a href="#l142.706"></a><span id="l142.706" class="difflineminus">-  close_tab(tabMessage);</span>
<a href="#l142.707"></a><span id="l142.707" class="difflineminus">-  close_tab(tabMessageBackground);</span>
<a href="#l142.708"></a><span id="l142.708" class="difflineminus">-  switch_tab(tabFolder);</span>
<a href="#l142.709"></a><span id="l142.709" class="difflineminus">-}</span>
<a href="#l142.710"></a><span id="l142.710" class="difflineplus">+    // Clean up, close everything</span>
<a href="#l142.711"></a><span id="l142.711" class="difflineplus">+    close_message_window(msgc);</span>
<a href="#l142.712"></a><span id="l142.712" class="difflineplus">+    close_tab(tabMessage);</span>
<a href="#l142.713"></a><span id="l142.713" class="difflineplus">+    close_tab(tabMessageBackground);</span>
<a href="#l142.714"></a><span id="l142.714" class="difflineplus">+    switch_tab(tabFolder);</span>
<a href="#l142.715"></a><span id="l142.715" class="difflineplus">+  }</span>
<a href="#l142.716"></a><span id="l142.716" class="difflineplus">+);</span>
<a href="#l142.717"></a><span id="l142.717"> </span>
<a href="#l142.718"></a><span id="l142.718"> /**</span>
<a href="#l142.719"></a><span id="l142.719">  * Test deleting multiple messages in a folder tab (including the last one!),</span>
<a href="#l142.720"></a><span id="l142.720">  * with message displays open to the end of a selection.</span>
<a href="#l142.721"></a><span id="l142.721">  */</span>
<a href="#l142.722"></a><span id="l142.722" class="difflineminus">-function test_delete_multiple_messages_including_the_last_one_with_last_open() {</span>
<a href="#l142.723"></a><span id="l142.723" class="difflineminus">-  // 10 messages in this folder. Open up message 9 everywhere.</span>
<a href="#l142.724"></a><span id="l142.724" class="difflineminus">-  _open_message_in_all_four_display_mechanisms_helper(</span>
<a href="#l142.725"></a><span id="l142.725" class="difflineminus">-    multipleDeletionFolder4,</span>
<a href="#l142.726"></a><span id="l142.726" class="difflineminus">-    9</span>
<a href="#l142.727"></a><span id="l142.727" class="difflineminus">-  );</span>
<a href="#l142.728"></a><span id="l142.728" class="difflineplus">+add_task(</span>
<a href="#l142.729"></a><span id="l142.729" class="difflineplus">+  function test_delete_multiple_messages_including_the_last_one_with_last_open() {</span>
<a href="#l142.730"></a><span id="l142.730" class="difflineplus">+    // 10 messages in this folder. Open up message 9 everywhere.</span>
<a href="#l142.731"></a><span id="l142.731" class="difflineplus">+    _open_message_in_all_four_display_mechanisms_helper(</span>
<a href="#l142.732"></a><span id="l142.732" class="difflineplus">+      multipleDeletionFolder4,</span>
<a href="#l142.733"></a><span id="l142.733" class="difflineplus">+      9</span>
<a href="#l142.734"></a><span id="l142.734" class="difflineplus">+    );</span>
<a href="#l142.735"></a><span id="l142.735"> </span>
<a href="#l142.736"></a><span id="l142.736" class="difflineminus">-  // We'll select 1-4, 7, 8 and 9. We expect 6 to be the next displayed message.</span>
<a href="#l142.737"></a><span id="l142.737" class="difflineminus">-  select_click_row(1);</span>
<a href="#l142.738"></a><span id="l142.738" class="difflineminus">-  select_shift_click_row(4);</span>
<a href="#l142.739"></a><span id="l142.739" class="difflineminus">-  select_control_click_row(7);</span>
<a href="#l142.740"></a><span id="l142.740" class="difflineminus">-  select_control_click_row(8);</span>
<a href="#l142.741"></a><span id="l142.741" class="difflineminus">-  select_control_click_row(9);</span>
<a href="#l142.742"></a><span id="l142.742" class="difflineminus">-  let expectedMessage = mc.dbView.getMsgHdrAt(6);</span>
<a href="#l142.743"></a><span id="l142.743" class="difflineplus">+    // We'll select 1-4, 7, 8 and 9. We expect 6 to be the next displayed message.</span>
<a href="#l142.744"></a><span id="l142.744" class="difflineplus">+    select_click_row(1);</span>
<a href="#l142.745"></a><span id="l142.745" class="difflineplus">+    select_shift_click_row(4);</span>
<a href="#l142.746"></a><span id="l142.746" class="difflineplus">+    select_control_click_row(7);</span>
<a href="#l142.747"></a><span id="l142.747" class="difflineplus">+    select_control_click_row(8);</span>
<a href="#l142.748"></a><span id="l142.748" class="difflineplus">+    select_control_click_row(9);</span>
<a href="#l142.749"></a><span id="l142.749" class="difflineplus">+    let expectedMessage = mc.dbView.getMsgHdrAt(6);</span>
<a href="#l142.750"></a><span id="l142.750" class="difflineplus">+</span>
<a href="#l142.751"></a><span id="l142.751" class="difflineplus">+    // Delete the selected messages</span>
<a href="#l142.752"></a><span id="l142.752" class="difflineplus">+    press_delete();</span>
<a href="#l142.753"></a><span id="l142.753" class="difflineplus">+</span>
<a href="#l142.754"></a><span id="l142.754" class="difflineplus">+    // The folder tab should now be showing message 1</span>
<a href="#l142.755"></a><span id="l142.755" class="difflineplus">+    assert_selected_and_displayed(1);</span>
<a href="#l142.756"></a><span id="l142.756"> </span>
<a href="#l142.757"></a><span id="l142.757" class="difflineminus">-  // Delete the selected messages</span>
<a href="#l142.758"></a><span id="l142.758" class="difflineminus">-  press_delete();</span>
<a href="#l142.759"></a><span id="l142.759" class="difflineminus">-</span>
<a href="#l142.760"></a><span id="l142.760" class="difflineminus">-  // The folder tab should now be showing message 1</span>
<a href="#l142.761"></a><span id="l142.761" class="difflineminus">-  assert_selected_and_displayed(1);</span>
<a href="#l142.762"></a><span id="l142.762" class="difflineplus">+    // The other displays should now be showing the expectedMessage</span>
<a href="#l142.763"></a><span id="l142.763" class="difflineplus">+    _verify_message_is_displayed_in(</span>
<a href="#l142.764"></a><span id="l142.764" class="difflineplus">+      VERIFY_MESSAGE_TAB |</span>
<a href="#l142.765"></a><span id="l142.765" class="difflineplus">+        VERIFY_BACKGROUND_MESSAGE_TAB |</span>
<a href="#l142.766"></a><span id="l142.766" class="difflineplus">+        VERIFY_MESSAGE_WINDOW,</span>
<a href="#l142.767"></a><span id="l142.767" class="difflineplus">+      expectedMessage</span>
<a href="#l142.768"></a><span id="l142.768" class="difflineplus">+    );</span>
<a href="#l142.769"></a><span id="l142.769"> </span>
<a href="#l142.770"></a><span id="l142.770" class="difflineminus">-  // The other displays should now be showing the expectedMessage</span>
<a href="#l142.771"></a><span id="l142.771" class="difflineminus">-  _verify_message_is_displayed_in(</span>
<a href="#l142.772"></a><span id="l142.772" class="difflineminus">-    VERIFY_MESSAGE_TAB | VERIFY_BACKGROUND_MESSAGE_TAB | VERIFY_MESSAGE_WINDOW,</span>
<a href="#l142.773"></a><span id="l142.773" class="difflineminus">-    expectedMessage</span>
<a href="#l142.774"></a><span id="l142.774" class="difflineminus">-  );</span>
<a href="#l142.775"></a><span id="l142.775" class="difflineplus">+    // Clean up, close everything</span>
<a href="#l142.776"></a><span id="l142.776" class="difflineplus">+    close_message_window(msgc);</span>
<a href="#l142.777"></a><span id="l142.777" class="difflineplus">+    close_tab(tabMessage);</span>
<a href="#l142.778"></a><span id="l142.778" class="difflineplus">+    close_tab(tabMessageBackground);</span>
<a href="#l142.779"></a><span id="l142.779" class="difflineplus">+    switch_tab(tabFolder);</span>
<a href="#l142.780"></a><span id="l142.780"> </span>
<a href="#l142.781"></a><span id="l142.781" class="difflineminus">-  // Clean up, close everything</span>
<a href="#l142.782"></a><span id="l142.782" class="difflineminus">-  close_message_window(msgc);</span>
<a href="#l142.783"></a><span id="l142.783" class="difflineminus">-  close_tab(tabMessage);</span>
<a href="#l142.784"></a><span id="l142.784" class="difflineminus">-  close_tab(tabMessageBackground);</span>
<a href="#l142.785"></a><span id="l142.785" class="difflineminus">-  switch_tab(tabFolder);</span>
<a href="#l142.786"></a><span id="l142.786" class="difflineminus">-}</span>
<a href="#l142.787"></a><span id="l142.787" class="difflineplus">+    Assert.report(</span>
<a href="#l142.788"></a><span id="l142.788" class="difflineplus">+      false,</span>
<a href="#l142.789"></a><span id="l142.789" class="difflineplus">+      undefined,</span>
<a href="#l142.790"></a><span id="l142.790" class="difflineplus">+      undefined,</span>
<a href="#l142.791"></a><span id="l142.791" class="difflineplus">+      &quot;Test ran to completion successfully&quot;</span>
<a href="#l142.792"></a><span id="l142.792" class="difflineplus">+    );</span>
<a href="#l142.793"></a><span id="l142.793" class="difflineplus">+  }</span>
<a href="#l142.794"></a><span id="l142.794" class="difflineplus">+);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l143.1"></a><span id="l143.1">copy from mail/test/mozmill/folder-display/test-display-name.js</span>
<a href="#l143.2"></a><span id="l143.2">copy to mail/test/browser/folder-display/browser_displayName.js</span>
<a href="#l143.3"></a><span id="l143.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-display-name.js</span>
<a href="#l143.4"></a><span id="l143.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_displayName.js</span>
<a href="#l143.5"></a><span id="l143.5" class="difflineat">@@ -9,17 +9,16 @@</span>
<a href="#l143.6"></a><span id="l143.6"> </span>
<a href="#l143.7"></a><span id="l143.7"> &quot;use strict&quot;;</span>
<a href="#l143.8"></a><span id="l143.8"> </span>
<a href="#l143.9"></a><span id="l143.9"> var { ensure_card_exists } = ChromeUtils.import(</span>
<a href="#l143.10"></a><span id="l143.10">   &quot;resource://testing-common/mozmill/AddressBookHelpers.jsm&quot;</span>
<a href="#l143.11"></a><span id="l143.11"> );</span>
<a href="#l143.12"></a><span id="l143.12"> var {</span>
<a href="#l143.13"></a><span id="l143.13">   add_message_to_folder,</span>
<a href="#l143.14"></a><span id="l143.14" class="difflineminus">-  assert_equals,</span>
<a href="#l143.15"></a><span id="l143.15">   be_in_folder,</span>
<a href="#l143.16"></a><span id="l143.16">   create_folder,</span>
<a href="#l143.17"></a><span id="l143.17">   create_message,</span>
<a href="#l143.18"></a><span id="l143.18">   mc,</span>
<a href="#l143.19"></a><span id="l143.19">   select_click_row,</span>
<a href="#l143.20"></a><span id="l143.20"> } = ChromeUtils.import(</span>
<a href="#l143.21"></a><span id="l143.21">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l143.22"></a><span id="l143.22"> );</span>
<a href="#l143.23"></a><span id="l143.23" class="difflineat">@@ -190,32 +189,32 @@ var messages = [</span>
<a href="#l143.24"></a><span id="l143.24">   },</span>
<a href="#l143.25"></a><span id="l143.25"> ];</span>
<a href="#l143.26"></a><span id="l143.26"> </span>
<a href="#l143.27"></a><span id="l143.27"> var contacts = [</span>
<a href="#l143.28"></a><span id="l143.28">   { email: &quot;aapone@uscmc.invalid&quot;, name: &quot;Sarge&quot;, pdn: true },</span>
<a href="#l143.29"></a><span id="l143.29">   { email: &quot;rjorden@hadleys-hope.invalid&quot;, name: &quot;Newt&quot;, pdn: false },</span>
<a href="#l143.30"></a><span id="l143.30"> ];</span>
<a href="#l143.31"></a><span id="l143.31"> </span>
<a href="#l143.32"></a><span id="l143.32" class="difflineminus">-function setupModule(module) {</span>
<a href="#l143.33"></a><span id="l143.33" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l143.34"></a><span id="l143.34">   folder = create_folder(&quot;DisplayNameA&quot;);</span>
<a href="#l143.35"></a><span id="l143.35"> </span>
<a href="#l143.36"></a><span id="l143.36">   for (let message of messages) {</span>
<a href="#l143.37"></a><span id="l143.37">     add_message_to_folder(</span>
<a href="#l143.38"></a><span id="l143.38">       folder,</span>
<a href="#l143.39"></a><span id="l143.39">       create_message({</span>
<a href="#l143.40"></a><span id="l143.40">         clobberHeaders: message.headers,</span>
<a href="#l143.41"></a><span id="l143.41">       })</span>
<a href="#l143.42"></a><span id="l143.42">     );</span>
<a href="#l143.43"></a><span id="l143.43">   }</span>
<a href="#l143.44"></a><span id="l143.44"> </span>
<a href="#l143.45"></a><span id="l143.45">   for (let contact of contacts) {</span>
<a href="#l143.46"></a><span id="l143.46">     ensure_card_exists(contact.email, contact.name, contact.pdn);</span>
<a href="#l143.47"></a><span id="l143.47">   }</span>
<a href="#l143.48"></a><span id="l143.48" class="difflineminus">-}</span>
<a href="#l143.49"></a><span id="l143.49" class="difflineplus">+});</span>
<a href="#l143.50"></a><span id="l143.50"> </span>
<a href="#l143.51"></a><span id="l143.51"> function check_display_name(index, columnName, expectedName) {</span>
<a href="#l143.52"></a><span id="l143.52">   let columnId;</span>
<a href="#l143.53"></a><span id="l143.53">   switch (columnName) {</span>
<a href="#l143.54"></a><span id="l143.54">     case &quot;from&quot;:</span>
<a href="#l143.55"></a><span id="l143.55">       columnId = &quot;senderCol&quot;;</span>
<a href="#l143.56"></a><span id="l143.56">       break;</span>
<a href="#l143.57"></a><span id="l143.57">     case &quot;recipients&quot;:</span>
<a href="#l143.58"></a><span id="l143.58" class="difflineat">@@ -227,17 +226,18 @@ function check_display_name(index, colum</span>
<a href="#l143.59"></a><span id="l143.59"> </span>
<a href="#l143.60"></a><span id="l143.60">   // Select the nth message</span>
<a href="#l143.61"></a><span id="l143.61">   be_in_folder(folder);</span>
<a href="#l143.62"></a><span id="l143.62">   select_click_row(index);</span>
<a href="#l143.63"></a><span id="l143.63"> </span>
<a href="#l143.64"></a><span id="l143.64">   let tree = mc.folderDisplay.tree;</span>
<a href="#l143.65"></a><span id="l143.65">   let cellText = tree.view.getCellText(index, tree.columns[columnId]);</span>
<a href="#l143.66"></a><span id="l143.66"> </span>
<a href="#l143.67"></a><span id="l143.67" class="difflineminus">-  assert_equals(cellText, expectedName, columnName);</span>
<a href="#l143.68"></a><span id="l143.68" class="difflineplus">+  Assert.equal(cellText, expectedName, columnName);</span>
<a href="#l143.69"></a><span id="l143.69"> }</span>
<a href="#l143.70"></a><span id="l143.70"> </span>
<a href="#l143.71"></a><span id="l143.71"> // Generate a test for each message in |messages|.</span>
<a href="#l143.72"></a><span id="l143.72"> for (let [i, message] of messages.entries()) {</span>
<a href="#l143.73"></a><span id="l143.73">   this[&quot;test_&quot; + message.name] = function(i, message) {</span>
<a href="#l143.74"></a><span id="l143.74">     check_display_name(i, message.expected.column, message.expected.value);</span>
<a href="#l143.75"></a><span id="l143.75">   }.bind(this, i, message);</span>
<a href="#l143.76"></a><span id="l143.76" class="difflineplus">+  add_task(this[`test_${message.name}`]);</span>
<a href="#l143.77"></a><span id="l143.77"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l144.1"></a><span id="l144.1">copy from mail/test/mozmill/folder-display/test-folder-pane-visibility.js</span>
<a href="#l144.2"></a><span id="l144.2">copy to mail/test/browser/folder-display/browser_folderPaneVisibility.js</span>
<a href="#l144.3"></a><span id="l144.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-folder-pane-visibility.js</span>
<a href="#l144.4"></a><span id="l144.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_folderPaneVisibility.js</span>
<a href="#l144.5"></a><span id="l144.5" class="difflineat">@@ -20,20 +20,20 @@ var {</span>
<a href="#l144.6"></a><span id="l144.6">   select_click_row,</span>
<a href="#l144.7"></a><span id="l144.7">   switch_tab,</span>
<a href="#l144.8"></a><span id="l144.8"> } = ChromeUtils.import(</span>
<a href="#l144.9"></a><span id="l144.9">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l144.10"></a><span id="l144.10"> );</span>
<a href="#l144.11"></a><span id="l144.11"> </span>
<a href="#l144.12"></a><span id="l144.12"> var folder;</span>
<a href="#l144.13"></a><span id="l144.13"> </span>
<a href="#l144.14"></a><span id="l144.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l144.15"></a><span id="l144.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l144.16"></a><span id="l144.16">   folder = create_folder(&quot;FolderPaneVisibility&quot;);</span>
<a href="#l144.17"></a><span id="l144.17">   make_new_sets_in_folder(folder, [{ count: 3 }]);</span>
<a href="#l144.18"></a><span id="l144.18" class="difflineminus">-}</span>
<a href="#l144.19"></a><span id="l144.19" class="difflineplus">+});</span>
<a href="#l144.20"></a><span id="l144.20"> </span>
<a href="#l144.21"></a><span id="l144.21"> /**</span>
<a href="#l144.22"></a><span id="l144.22">  * When displaying a folder, assert that the folder pane is visible and all the</span>
<a href="#l144.23"></a><span id="l144.23">  * menus, splitters, etc. are set up right.</span>
<a href="#l144.24"></a><span id="l144.24">  */</span>
<a href="#l144.25"></a><span id="l144.25"> function assert_folder_pane_visible() {</span>
<a href="#l144.26"></a><span id="l144.26">   if (!mc.folderDisplay.folderPaneVisible) {</span>
<a href="#l144.27"></a><span id="l144.27">     throw new Error(</span>
<a href="#l144.28"></a><span id="l144.28" class="difflineat">@@ -106,43 +106,43 @@ function toggle_folder_pane() {</span>
<a href="#l144.29"></a><span id="l144.29">   // Since we don't have a shortcut to toggle the folder pane, we're going to</span>
<a href="#l144.30"></a><span id="l144.30">   // have to collapse it ourselves</span>
<a href="#l144.31"></a><span id="l144.31">   mc.window.MsgToggleFolderPane();</span>
<a href="#l144.32"></a><span id="l144.32"> }</span>
<a href="#l144.33"></a><span id="l144.33"> </span>
<a href="#l144.34"></a><span id="l144.34"> /**</span>
<a href="#l144.35"></a><span id="l144.35">  * By default, the folder pane should be visible.</span>
<a href="#l144.36"></a><span id="l144.36">  */</span>
<a href="#l144.37"></a><span id="l144.37" class="difflineminus">-function test_folder_pane_visible_state_is_right() {</span>
<a href="#l144.38"></a><span id="l144.38" class="difflineplus">+add_task(function test_folder_pane_visible_state_is_right() {</span>
<a href="#l144.39"></a><span id="l144.39">   be_in_folder(folder);</span>
<a href="#l144.40"></a><span id="l144.40">   assert_folder_pane_visible();</span>
<a href="#l144.41"></a><span id="l144.41" class="difflineminus">-}</span>
<a href="#l144.42"></a><span id="l144.42" class="difflineplus">+});</span>
<a href="#l144.43"></a><span id="l144.43"> </span>
<a href="#l144.44"></a><span id="l144.44"> /**</span>
<a href="#l144.45"></a><span id="l144.45">  * Toggle the folder pane off.</span>
<a href="#l144.46"></a><span id="l144.46">  */</span>
<a href="#l144.47"></a><span id="l144.47" class="difflineminus">-function test_toggle_folder_pane_off() {</span>
<a href="#l144.48"></a><span id="l144.48" class="difflineplus">+add_task(function test_toggle_folder_pane_off() {</span>
<a href="#l144.49"></a><span id="l144.49">   toggle_folder_pane();</span>
<a href="#l144.50"></a><span id="l144.50">   assert_folder_pane_hidden();</span>
<a href="#l144.51"></a><span id="l144.51" class="difflineminus">-}</span>
<a href="#l144.52"></a><span id="l144.52" class="difflineplus">+});</span>
<a href="#l144.53"></a><span id="l144.53"> </span>
<a href="#l144.54"></a><span id="l144.54"> /**</span>
<a href="#l144.55"></a><span id="l144.55">  * Toggle the folder pane on.</span>
<a href="#l144.56"></a><span id="l144.56">  */</span>
<a href="#l144.57"></a><span id="l144.57" class="difflineminus">-function test_toggle_folder_pane_on() {</span>
<a href="#l144.58"></a><span id="l144.58" class="difflineplus">+add_task(function test_toggle_folder_pane_on() {</span>
<a href="#l144.59"></a><span id="l144.59">   toggle_folder_pane();</span>
<a href="#l144.60"></a><span id="l144.60">   assert_folder_pane_visible();</span>
<a href="#l144.61"></a><span id="l144.61" class="difflineminus">-}</span>
<a href="#l144.62"></a><span id="l144.62" class="difflineplus">+});</span>
<a href="#l144.63"></a><span id="l144.63"> </span>
<a href="#l144.64"></a><span id="l144.64"> /**</span>
<a href="#l144.65"></a><span id="l144.65">  * Make sure that switching to message tabs of folder tabs with a different</span>
<a href="#l144.66"></a><span id="l144.66">  * folder pane state does not break. This test should cover all transition</span>
<a href="#l144.67"></a><span id="l144.67">  * states.</span>
<a href="#l144.68"></a><span id="l144.68">  */</span>
<a href="#l144.69"></a><span id="l144.69" class="difflineminus">-function test_folder_pane_is_sticky() {</span>
<a href="#l144.70"></a><span id="l144.70" class="difflineplus">+add_task(function test_folder_pane_is_sticky() {</span>
<a href="#l144.71"></a><span id="l144.71">   let tabFolderA = be_in_folder(folder);</span>
<a href="#l144.72"></a><span id="l144.72">   assert_folder_pane_visible();</span>
<a href="#l144.73"></a><span id="l144.73"> </span>
<a href="#l144.74"></a><span id="l144.74">   // [folder+ =&gt; (new) message]</span>
<a href="#l144.75"></a><span id="l144.75">   select_click_row(0);</span>
<a href="#l144.76"></a><span id="l144.76">   let tabMessage = open_selected_message_in_new_tab();</span>
<a href="#l144.77"></a><span id="l144.77">   assert_folder_pane_hidden(true);</span>
<a href="#l144.78"></a><span id="l144.78"> </span>
<a href="#l144.79"></a><span id="l144.79" class="difflineat">@@ -191,25 +191,25 @@ function test_folder_pane_is_sticky() {</span>
<a href="#l144.80"></a><span id="l144.80"> </span>
<a href="#l144.81"></a><span id="l144.81">   // [folder+ =&gt; folder-]</span>
<a href="#l144.82"></a><span id="l144.82">   close_tab(tabFolderB);</span>
<a href="#l144.83"></a><span id="l144.83">   assert_folder_pane_hidden();</span>
<a href="#l144.84"></a><span id="l144.84"> </span>
<a href="#l144.85"></a><span id="l144.85">   // (redundant) [ folder pane toggle - =&gt; + ]</span>
<a href="#l144.86"></a><span id="l144.86">   toggle_folder_pane();</span>
<a href="#l144.87"></a><span id="l144.87">   assert_folder_pane_visible();</span>
<a href="#l144.88"></a><span id="l144.88" class="difflineminus">-}</span>
<a href="#l144.89"></a><span id="l144.89" class="difflineplus">+});</span>
<a href="#l144.90"></a><span id="l144.90"> </span>
<a href="#l144.91"></a><span id="l144.91"> /**</span>
<a href="#l144.92"></a><span id="l144.92">  * Test that if we serialize and restore the tabs then the folder pane is in the</span>
<a href="#l144.93"></a><span id="l144.93">  * expected collapsed/non-collapsed state. Because of the special &quot;first tab&quot;</span>
<a href="#l144.94"></a><span id="l144.94">  * situation, we need to do this twice to test each case for the first tab.  For</span>
<a href="#l144.95"></a><span id="l144.95">  * additional thoroughness we also flip the state we have the other tabs be in.</span>
<a href="#l144.96"></a><span id="l144.96">  */</span>
<a href="#l144.97"></a><span id="l144.97" class="difflineminus">-function test_folder_pane_persistence_generally_works() {</span>
<a href="#l144.98"></a><span id="l144.98" class="difflineplus">+add_task(function test_folder_pane_persistence_generally_works() {</span>
<a href="#l144.99"></a><span id="l144.99">   be_in_folder(folder);</span>
<a href="#l144.100"></a><span id="l144.100"> </span>
<a href="#l144.101"></a><span id="l144.101">   // helper to open tabs with the folder pane in the desired states (1 for</span>
<a href="#l144.102"></a><span id="l144.102">   //  visible, 0 for hidden)</span>
<a href="#l144.103"></a><span id="l144.103">   function openTabs(aConfig) {</span>
<a href="#l144.104"></a><span id="l144.104">     let curState;</span>
<a href="#l144.105"></a><span id="l144.105">     for (let [iTab, folderPaneVisible] of aConfig.entries()) {</span>
<a href="#l144.106"></a><span id="l144.106">       if (iTab == 0) {</span>
<a href="#l144.107"></a><span id="l144.107" class="difflineat">@@ -253,19 +253,21 @@ function test_folder_pane_persistence_ge</span>
<a href="#l144.108"></a><span id="l144.108">   for (let config of configs) {</span>
<a href="#l144.109"></a><span id="l144.109">     openTabs(config);</span>
<a href="#l144.110"></a><span id="l144.110">     verifyTabs(config); // make sure openTabs did its job right</span>
<a href="#l144.111"></a><span id="l144.111">     let state = mc.tabmail.persistTabs();</span>
<a href="#l144.112"></a><span id="l144.112">     closeTabs();</span>
<a href="#l144.113"></a><span id="l144.113">     // toggle the state for the current tab so we can be sure that it knows how</span>
<a href="#l144.114"></a><span id="l144.114">     // to change things.</span>
<a href="#l144.115"></a><span id="l144.115">     toggle_folder_pane();</span>
<a href="#l144.116"></a><span id="l144.116" class="difflineplus">+    SimpleTest.ignoreAllUncaughtExceptions(true);</span>
<a href="#l144.117"></a><span id="l144.117">     mc.tabmail.restoreTabs(state);</span>
<a href="#l144.118"></a><span id="l144.118">     verifyTabs(config);</span>
<a href="#l144.119"></a><span id="l144.119" class="difflineplus">+    SimpleTest.ignoreAllUncaughtExceptions(false);</span>
<a href="#l144.120"></a><span id="l144.120">     closeTabs();</span>
<a href="#l144.121"></a><span id="l144.121"> </span>
<a href="#l144.122"></a><span id="l144.122">     // toggle the first tab again.  This sets - properly for the second pass and</span>
<a href="#l144.123"></a><span id="l144.123">     // restores it to + for when we are done.</span>
<a href="#l144.124"></a><span id="l144.124">     toggle_folder_pane();</span>
<a href="#l144.125"></a><span id="l144.125">   }</span>
<a href="#l144.126"></a><span id="l144.126">   // For one last time, make sure.</span>
<a href="#l144.127"></a><span id="l144.127">   assert_folder_pane_visible();</span>
<a href="#l144.128"></a><span id="l144.128" class="difflineminus">-}</span>
<a href="#l144.129"></a><span id="l144.129" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l145.1"></a><span id="l145.1">copy from mail/test/mozmill/folder-display/test-folder-toolbar.js</span>
<a href="#l145.2"></a><span id="l145.2">copy to mail/test/browser/folder-display/browser_folderToolbar.js</span>
<a href="#l145.3"></a><span id="l145.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-folder-toolbar.js</span>
<a href="#l145.4"></a><span id="l145.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_folderToolbar.js</span>
<a href="#l145.5"></a><span id="l145.5" class="difflineat">@@ -6,17 +6,16 @@</span>
<a href="#l145.6"></a><span id="l145.6">  * Test that opening new folder and message tabs has the expected result and</span>
<a href="#l145.7"></a><span id="l145.7">  *  that closing them doesn't break anything.</span>
<a href="#l145.8"></a><span id="l145.8">  */</span>
<a href="#l145.9"></a><span id="l145.9"> </span>
<a href="#l145.10"></a><span id="l145.10"> &quot;use strict&quot;;</span>
<a href="#l145.11"></a><span id="l145.11"> </span>
<a href="#l145.12"></a><span id="l145.12"> var {</span>
<a href="#l145.13"></a><span id="l145.13">   add_to_toolbar,</span>
<a href="#l145.14"></a><span id="l145.14" class="difflineminus">-  assert_equals,</span>
<a href="#l145.15"></a><span id="l145.15">   assert_folder_selected_and_displayed,</span>
<a href="#l145.16"></a><span id="l145.16">   assert_nothing_selected,</span>
<a href="#l145.17"></a><span id="l145.17">   be_in_folder,</span>
<a href="#l145.18"></a><span id="l145.18">   close_tab,</span>
<a href="#l145.19"></a><span id="l145.19">   create_folder,</span>
<a href="#l145.20"></a><span id="l145.20">   make_new_sets_in_folder,</span>
<a href="#l145.21"></a><span id="l145.21">   mc,</span>
<a href="#l145.22"></a><span id="l145.22">   open_folder_in_new_tab,</span>
<a href="#l145.23"></a><span id="l145.23" class="difflineat">@@ -26,115 +25,111 @@ var {</span>
<a href="#l145.24"></a><span id="l145.24">   switch_tab,</span>
<a href="#l145.25"></a><span id="l145.25">   wait_for_blank_content_pane,</span>
<a href="#l145.26"></a><span id="l145.26"> } = ChromeUtils.import(</span>
<a href="#l145.27"></a><span id="l145.27">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l145.28"></a><span id="l145.28"> );</span>
<a href="#l145.29"></a><span id="l145.29"> </span>
<a href="#l145.30"></a><span id="l145.30"> var folderA, folderB;</span>
<a href="#l145.31"></a><span id="l145.31"> </span>
<a href="#l145.32"></a><span id="l145.32" class="difflineminus">-function setupModule(module) {</span>
<a href="#l145.33"></a><span id="l145.33" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l145.34"></a><span id="l145.34">   folderA = create_folder(&quot;FolderToolbarA&quot;);</span>
<a href="#l145.35"></a><span id="l145.35">   // we need one message to select and open</span>
<a href="#l145.36"></a><span id="l145.36">   folderB = create_folder(&quot;FolderToolbarB&quot;);</span>
<a href="#l145.37"></a><span id="l145.37">   make_new_sets_in_folder(folderB, [{ count: 1 }]);</span>
<a href="#l145.38"></a><span id="l145.38" class="difflineminus">-}</span>
<a href="#l145.39"></a><span id="l145.39" class="difflineplus">+});</span>
<a href="#l145.40"></a><span id="l145.40"> </span>
<a href="#l145.41"></a><span id="l145.41" class="difflineminus">-function test_add_folder_toolbar() {</span>
<a href="#l145.42"></a><span id="l145.42" class="difflineplus">+add_task(function test_add_folder_toolbar() {</span>
<a href="#l145.43"></a><span id="l145.43">   // It should not be present by default</span>
<a href="#l145.44"></a><span id="l145.44">   let folderLoc = mc.eid(&quot;locationFolders&quot;);</span>
<a href="#l145.45"></a><span id="l145.45">   mc.assertNodeNotExist(folderLoc);</span>
<a href="#l145.46"></a><span id="l145.46"> </span>
<a href="#l145.47"></a><span id="l145.47">   // But it should show up when we call</span>
<a href="#l145.48"></a><span id="l145.48">   add_to_toolbar(mc.e(&quot;mail-bar3&quot;), &quot;folder-location-container&quot;);</span>
<a href="#l145.49"></a><span id="l145.49">   folderLoc = mc.eid(&quot;locationFolders&quot;);</span>
<a href="#l145.50"></a><span id="l145.50">   mc.assertNode(folderLoc);</span>
<a href="#l145.51"></a><span id="l145.51"> </span>
<a href="#l145.52"></a><span id="l145.52" class="difflineminus">-  assert_equals(</span>
<a href="#l145.53"></a><span id="l145.53" class="difflineplus">+  Assert.equal(</span>
<a href="#l145.54"></a><span id="l145.54">     !!folderLoc.node.label,</span>
<a href="#l145.55"></a><span id="l145.55">     true,</span>
<a href="#l145.56"></a><span id="l145.56">     &quot;Uninitialized Folder doesn't have a default label.&quot;</span>
<a href="#l145.57"></a><span id="l145.57">   );</span>
<a href="#l145.58"></a><span id="l145.58" class="difflineminus">-}</span>
<a href="#l145.59"></a><span id="l145.59" class="difflineplus">+});</span>
<a href="#l145.60"></a><span id="l145.60"> </span>
<a href="#l145.61"></a><span id="l145.61" class="difflineminus">-function test_folder_toolbar_shows_correct_item() {</span>
<a href="#l145.62"></a><span id="l145.62" class="difflineplus">+add_task(function test_folder_toolbar_shows_correct_item() {</span>
<a href="#l145.63"></a><span id="l145.63">   add_to_toolbar(mc.e(&quot;mail-bar3&quot;), &quot;folder-location-container&quot;);</span>
<a href="#l145.64"></a><span id="l145.64">   let folderLoc = mc.eid(&quot;locationFolders&quot;);</span>
<a href="#l145.65"></a><span id="l145.65"> </span>
<a href="#l145.66"></a><span id="l145.66">   // Start in folder a.</span>
<a href="#l145.67"></a><span id="l145.67">   let tabFolderA = be_in_folder(folderA);</span>
<a href="#l145.68"></a><span id="l145.68">   assert_folder_selected_and_displayed(folderA);</span>
<a href="#l145.69"></a><span id="l145.69">   assert_nothing_selected();</span>
<a href="#l145.70"></a><span id="l145.70" class="difflineminus">-  assert_equals(</span>
<a href="#l145.71"></a><span id="l145.71" class="difflineplus">+  Assert.equal(</span>
<a href="#l145.72"></a><span id="l145.72">     folderLoc.node.label,</span>
<a href="#l145.73"></a><span id="l145.73">     &quot;FolderToolbarA&quot;,</span>
<a href="#l145.74"></a><span id="l145.74">     &quot;Opening FolderA doesn't update toolbar.&quot;</span>
<a href="#l145.75"></a><span id="l145.75">   );</span>
<a href="#l145.76"></a><span id="l145.76"> </span>
<a href="#l145.77"></a><span id="l145.77">   // Open tab b, make sure it works right.</span>
<a href="#l145.78"></a><span id="l145.78">   let tabFolderB = open_folder_in_new_tab(folderB);</span>
<a href="#l145.79"></a><span id="l145.79">   wait_for_blank_content_pane();</span>
<a href="#l145.80"></a><span id="l145.80">   assert_folder_selected_and_displayed(folderB);</span>
<a href="#l145.81"></a><span id="l145.81">   assert_nothing_selected();</span>
<a href="#l145.82"></a><span id="l145.82" class="difflineminus">-  assert_equals(</span>
<a href="#l145.83"></a><span id="l145.83" class="difflineplus">+  Assert.equal(</span>
<a href="#l145.84"></a><span id="l145.84">     folderLoc.node.label,</span>
<a href="#l145.85"></a><span id="l145.85">     &quot;FolderToolbarB&quot;,</span>
<a href="#l145.86"></a><span id="l145.86">     &quot;Opening FolderB in a tab doesn't update toolbar.&quot;</span>
<a href="#l145.87"></a><span id="l145.87">   );</span>
<a href="#l145.88"></a><span id="l145.88"> </span>
<a href="#l145.89"></a><span id="l145.89">   // Go back to tab/folder A and make sure we change correctly.</span>
<a href="#l145.90"></a><span id="l145.90">   switch_tab(tabFolderA);</span>
<a href="#l145.91"></a><span id="l145.91">   assert_folder_selected_and_displayed(folderA);</span>
<a href="#l145.92"></a><span id="l145.92">   assert_nothing_selected();</span>
<a href="#l145.93"></a><span id="l145.93" class="difflineminus">-  assert_equals(</span>
<a href="#l145.94"></a><span id="l145.94" class="difflineplus">+  Assert.equal(</span>
<a href="#l145.95"></a><span id="l145.95">     folderLoc.node.label,</span>
<a href="#l145.96"></a><span id="l145.96">     &quot;FolderToolbarA&quot;,</span>
<a href="#l145.97"></a><span id="l145.97">     &quot;Switching back to FolderA's tab doesn't update toolbar.&quot;</span>
<a href="#l145.98"></a><span id="l145.98">   );</span>
<a href="#l145.99"></a><span id="l145.99"> </span>
<a href="#l145.100"></a><span id="l145.100">   // Go back to tab/folder A and make sure we change correctly.</span>
<a href="#l145.101"></a><span id="l145.101">   switch_tab(tabFolderB);</span>
<a href="#l145.102"></a><span id="l145.102">   assert_folder_selected_and_displayed(folderB);</span>
<a href="#l145.103"></a><span id="l145.103">   assert_nothing_selected();</span>
<a href="#l145.104"></a><span id="l145.104" class="difflineminus">-  assert_equals(</span>
<a href="#l145.105"></a><span id="l145.105" class="difflineplus">+  Assert.equal(</span>
<a href="#l145.106"></a><span id="l145.106">     folderLoc.node.label,</span>
<a href="#l145.107"></a><span id="l145.107">     &quot;FolderToolbarB&quot;,</span>
<a href="#l145.108"></a><span id="l145.108">     &quot;Switching back to FolderB's tab doesn't update toolbar.&quot;</span>
<a href="#l145.109"></a><span id="l145.109">   );</span>
<a href="#l145.110"></a><span id="l145.110">   close_tab(tabFolderB);</span>
<a href="#l145.111"></a><span id="l145.111" class="difflineminus">-}</span>
<a href="#l145.112"></a><span id="l145.112" class="difflineplus">+});</span>
<a href="#l145.113"></a><span id="l145.113"> </span>
<a href="#l145.114"></a><span id="l145.114" class="difflineminus">-function test_folder_toolbar_disappears_on_message_tab() {</span>
<a href="#l145.115"></a><span id="l145.115" class="difflineplus">+add_task(function test_folder_toolbar_disappears_on_message_tab() {</span>
<a href="#l145.116"></a><span id="l145.116">   add_to_toolbar(mc.e(&quot;mail-bar3&quot;), &quot;folder-location-container&quot;);</span>
<a href="#l145.117"></a><span id="l145.117">   be_in_folder(folderB);</span>
<a href="#l145.118"></a><span id="l145.118">   let folderLoc = mc.eid(&quot;locationFolders&quot;);</span>
<a href="#l145.119"></a><span id="l145.119">   mc.assertNode(folderLoc);</span>
<a href="#l145.120"></a><span id="l145.120" class="difflineminus">-  assert_equals(</span>
<a href="#l145.121"></a><span id="l145.121" class="difflineplus">+  Assert.equal(</span>
<a href="#l145.122"></a><span id="l145.122">     folderLoc.node.label,</span>
<a href="#l145.123"></a><span id="l145.123">     &quot;FolderToolbarB&quot;,</span>
<a href="#l145.124"></a><span id="l145.124">     &quot;We should have started in FolderB.&quot;</span>
<a href="#l145.125"></a><span id="l145.125">   );</span>
<a href="#l145.126"></a><span id="l145.126" class="difflineminus">-  assert_equals(</span>
<a href="#l145.127"></a><span id="l145.127" class="difflineminus">-    folderLoc.node.collapsed,</span>
<a href="#l145.128"></a><span id="l145.128" class="difflineminus">-    false,</span>
<a href="#l145.129"></a><span id="l145.129" class="difflineminus">-    &quot;The toolbar should be shown.&quot;</span>
<a href="#l145.130"></a><span id="l145.130" class="difflineminus">-  );</span>
<a href="#l145.131"></a><span id="l145.131" class="difflineplus">+  Assert.equal(folderLoc.node.collapsed, false, &quot;The toolbar should be shown.&quot;);</span>
<a href="#l145.132"></a><span id="l145.132"> </span>
<a href="#l145.133"></a><span id="l145.133">   // Select one message</span>
<a href="#l145.134"></a><span id="l145.134">   select_click_row(0);</span>
<a href="#l145.135"></a><span id="l145.135">   // Open it</span>
<a href="#l145.136"></a><span id="l145.136">   let messageTab = open_selected_message_in_new_tab();</span>
<a href="#l145.137"></a><span id="l145.137"> </span>
<a href="#l145.138"></a><span id="l145.138" class="difflineminus">-  assert_equals(</span>
<a href="#l145.139"></a><span id="l145.139" class="difflineplus">+  Assert.equal(</span>
<a href="#l145.140"></a><span id="l145.140">     mc.e(&quot;folder-location-container&quot;).collapsed,</span>
<a href="#l145.141"></a><span id="l145.141">     true,</span>
<a href="#l145.142"></a><span id="l145.142">     &quot;The toolbar should be hidden.&quot;</span>
<a href="#l145.143"></a><span id="l145.143">   );</span>
<a href="#l145.144"></a><span id="l145.144"> </span>
<a href="#l145.145"></a><span id="l145.145">   // Clean up, close the tab</span>
<a href="#l145.146"></a><span id="l145.146">   close_tab(messageTab);</span>
<a href="#l145.147"></a><span id="l145.147" class="difflineminus">-}</span>
<a href="#l145.148"></a><span id="l145.148" class="difflineplus">+});</span>
<a href="#l145.149"></a><span id="l145.149"> </span>
<a href="#l145.150"></a><span id="l145.150" class="difflineminus">-function test_remove_folder_toolbar() {</span>
<a href="#l145.151"></a><span id="l145.151" class="difflineplus">+add_task(function test_remove_folder_toolbar() {</span>
<a href="#l145.152"></a><span id="l145.152">   remove_from_toolbar(mc.e(&quot;mail-bar3&quot;), &quot;folder-location-container&quot;);</span>
<a href="#l145.153"></a><span id="l145.153"> </span>
<a href="#l145.154"></a><span id="l145.154">   mc.assertNodeNotExist(mc.eid(&quot;locationFolders&quot;));</span>
<a href="#l145.155"></a><span id="l145.155" class="difflineminus">-}</span>
<a href="#l145.156"></a><span id="l145.156" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l146.1"></a><span id="l146.1">copy from mail/test/mozmill/folder-display/test-invalid-db-folder-load.js</span>
<a href="#l146.2"></a><span id="l146.2">copy to mail/test/browser/folder-display/browser_invalidDbFolderLoad.js</span>
<a href="#l146.3"></a><span id="l146.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js</span>
<a href="#l146.4"></a><span id="l146.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_invalidDbFolderLoad.js</span>
<a href="#l146.5"></a><span id="l146.5" class="difflineat">@@ -20,33 +20,40 @@ var {</span>
<a href="#l146.6"></a><span id="l146.6">   select_click_row,</span>
<a href="#l146.7"></a><span id="l146.7"> } = ChromeUtils.import(</span>
<a href="#l146.8"></a><span id="l146.8">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l146.9"></a><span id="l146.9"> );</span>
<a href="#l146.10"></a><span id="l146.10"> </span>
<a href="#l146.11"></a><span id="l146.11"> var folder;</span>
<a href="#l146.12"></a><span id="l146.12"> var setA;</span>
<a href="#l146.13"></a><span id="l146.13"> </span>
<a href="#l146.14"></a><span id="l146.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l146.15"></a><span id="l146.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l146.16"></a><span id="l146.16">   folder = create_folder(&quot;InvalidMSF&quot;);</span>
<a href="#l146.17"></a><span id="l146.17">   [setA] = make_new_sets_in_folder(folder, [{ count: 3 }]);</span>
<a href="#l146.18"></a><span id="l146.18" class="difflineminus">-}</span>
<a href="#l146.19"></a><span id="l146.19" class="difflineplus">+});</span>
<a href="#l146.20"></a><span id="l146.20"> </span>
<a href="#l146.21"></a><span id="l146.21"> /**</span>
<a href="#l146.22"></a><span id="l146.22">  * Check if the db of a folder assumed to be invalid can be restored.</span>
<a href="#l146.23"></a><span id="l146.23">  */</span>
<a href="#l146.24"></a><span id="l146.24" class="difflineminus">-function test_load_folder_with_invalidDB() {</span>
<a href="#l146.25"></a><span id="l146.25" class="difflineplus">+add_task(function test_load_folder_with_invalidDB() {</span>
<a href="#l146.26"></a><span id="l146.26">   folder.msgDatabase.dBFolderInfo.sortType = Ci.nsMsgViewSortType.bySubject;</span>
<a href="#l146.27"></a><span id="l146.27">   folder.msgDatabase.summaryValid = false;</span>
<a href="#l146.28"></a><span id="l146.28">   folder.msgDatabase.ForceClosed();</span>
<a href="#l146.29"></a><span id="l146.29">   folder.msgDatabase = null;</span>
<a href="#l146.30"></a><span id="l146.30">   be_in_folder(folder);</span>
<a href="#l146.31"></a><span id="l146.31"> </span>
<a href="#l146.32"></a><span id="l146.32">   assert_messages_in_view(setA);</span>
<a href="#l146.33"></a><span id="l146.33">   var curMessage = select_click_row(0);</span>
<a href="#l146.34"></a><span id="l146.34">   assert_selected_and_displayed(curMessage);</span>
<a href="#l146.35"></a><span id="l146.35" class="difflineminus">-}</span>
<a href="#l146.36"></a><span id="l146.36" class="difflineplus">+});</span>
<a href="#l146.37"></a><span id="l146.37"> </span>
<a href="#l146.38"></a><span id="l146.38" class="difflineminus">-function test_view_sort_maintained() {</span>
<a href="#l146.39"></a><span id="l146.39" class="difflineplus">+add_task(function test_view_sort_maintained() {</span>
<a href="#l146.40"></a><span id="l146.40">   if (mc.dbView.sortType != Ci.nsMsgViewSortType.bySubject) {</span>
<a href="#l146.41"></a><span id="l146.41">     throw new Error(&quot;view sort type not restored from invalid db&quot;);</span>
<a href="#l146.42"></a><span id="l146.42">   }</span>
<a href="#l146.43"></a><span id="l146.43" class="difflineminus">-}</span>
<a href="#l146.44"></a><span id="l146.44" class="difflineplus">+</span>
<a href="#l146.45"></a><span id="l146.45" class="difflineplus">+  Assert.report(</span>
<a href="#l146.46"></a><span id="l146.46" class="difflineplus">+    false,</span>
<a href="#l146.47"></a><span id="l146.47" class="difflineplus">+    undefined,</span>
<a href="#l146.48"></a><span id="l146.48" class="difflineplus">+    undefined,</span>
<a href="#l146.49"></a><span id="l146.49" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l146.50"></a><span id="l146.50" class="difflineplus">+  );</span>
<a href="#l146.51"></a><span id="l146.51" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l147.1"></a><span id="l147.1">copy from mail/test/mozmill/folder-display/test-mail-views.js</span>
<a href="#l147.2"></a><span id="l147.2">copy to mail/test/browser/folder-display/browser_mailViews.js</span>
<a href="#l147.3"></a><span id="l147.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-mail-views.js</span>
<a href="#l147.4"></a><span id="l147.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_mailViews.js</span>
<a href="#l147.5"></a><span id="l147.5" class="difflineat">@@ -1,16 +1,16 @@</span>
<a href="#l147.6"></a><span id="l147.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l147.7"></a><span id="l147.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l147.8"></a><span id="l147.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l147.9"></a><span id="l147.9"> </span>
<a href="#l147.10"></a><span id="l147.10"> &quot;use strict&quot;;</span>
<a href="#l147.11"></a><span id="l147.11"> </span>
<a href="#l147.12"></a><span id="l147.12"> var elib = ChromeUtils.import(</span>
<a href="#l147.13"></a><span id="l147.13" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l147.14"></a><span id="l147.14" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l147.15"></a><span id="l147.15"> );</span>
<a href="#l147.16"></a><span id="l147.16"> </span>
<a href="#l147.17"></a><span id="l147.17"> var {</span>
<a href="#l147.18"></a><span id="l147.18">   assert_messages_in_view,</span>
<a href="#l147.19"></a><span id="l147.19">   be_in_folder,</span>
<a href="#l147.20"></a><span id="l147.20">   create_folder,</span>
<a href="#l147.21"></a><span id="l147.21">   make_new_sets_in_folder,</span>
<a href="#l147.22"></a><span id="l147.22">   mc,</span>
<a href="#l147.23"></a><span id="l147.23" class="difflineat">@@ -24,34 +24,34 @@ var { plan_for_modal_dialog, wait_for_mo</span>
<a href="#l147.24"></a><span id="l147.24"> </span>
<a href="#l147.25"></a><span id="l147.25"> var { MailViewConstants } = ChromeUtils.import(</span>
<a href="#l147.26"></a><span id="l147.26">   &quot;resource:///modules/MailViewManager.jsm&quot;</span>
<a href="#l147.27"></a><span id="l147.27"> );</span>
<a href="#l147.28"></a><span id="l147.28"> </span>
<a href="#l147.29"></a><span id="l147.29"> var baseFolder, savedFolder;</span>
<a href="#l147.30"></a><span id="l147.30"> var setUntagged, setTagged;</span>
<a href="#l147.31"></a><span id="l147.31"> </span>
<a href="#l147.32"></a><span id="l147.32" class="difflineminus">-var setupModule = function(module) {</span>
<a href="#l147.33"></a><span id="l147.33" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l147.34"></a><span id="l147.34">   // Create a folder with some messages that have no tags and some that are</span>
<a href="#l147.35"></a><span id="l147.35">   //  tagged Important ($label1).</span>
<a href="#l147.36"></a><span id="l147.36">   baseFolder = create_folder(&quot;MailViewA&quot;);</span>
<a href="#l147.37"></a><span id="l147.37">   [setUntagged, setTagged] = make_new_sets_in_folder(baseFolder, [{}, {}]);</span>
<a href="#l147.38"></a><span id="l147.38">   setTagged.addTag(&quot;$label1&quot;); // Important, by default</span>
<a href="#l147.39"></a><span id="l147.39" class="difflineminus">-};</span>
<a href="#l147.40"></a><span id="l147.40" class="difflineplus">+});</span>
<a href="#l147.41"></a><span id="l147.41"> </span>
<a href="#l147.42"></a><span id="l147.42" class="difflineminus">-function test_put_view_picker_on_toolbar() {</span>
<a href="#l147.43"></a><span id="l147.43" class="difflineplus">+add_task(function test_put_view_picker_on_toolbar() {</span>
<a href="#l147.44"></a><span id="l147.44">   let toolbar = mc.e(&quot;mail-bar3&quot;);</span>
<a href="#l147.45"></a><span id="l147.45">   toolbar.insertItem(&quot;mailviews-container&quot;, null);</span>
<a href="#l147.46"></a><span id="l147.46">   mc.assertNode(mc.eid(&quot;mailviews-container&quot;));</span>
<a href="#l147.47"></a><span id="l147.47" class="difflineminus">-}</span>
<a href="#l147.48"></a><span id="l147.48" class="difflineplus">+});</span>
<a href="#l147.49"></a><span id="l147.49"> </span>
<a href="#l147.50"></a><span id="l147.50"> /**</span>
<a href="#l147.51"></a><span id="l147.51">  * https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c97</span>
<a href="#l147.52"></a><span id="l147.52">  */</span>
<a href="#l147.53"></a><span id="l147.53" class="difflineminus">-function test_save_view_as_folder() {</span>
<a href="#l147.54"></a><span id="l147.54" class="difflineplus">+add_task(function test_save_view_as_folder() {</span>
<a href="#l147.55"></a><span id="l147.55">   // - enter the folder</span>
<a href="#l147.56"></a><span id="l147.56">   be_in_folder(baseFolder);</span>
<a href="#l147.57"></a><span id="l147.57"> </span>
<a href="#l147.58"></a><span id="l147.58">   // - apply the mail view</span>
<a href="#l147.59"></a><span id="l147.59">   // okay, mozmill is just not ready to click on the view picker...</span>
<a href="#l147.60"></a><span id="l147.60">   // just call the ViewChange global.  it's sad, but it has the same effects.</span>
<a href="#l147.61"></a><span id="l147.61">   // at least, it does once we've caused the popups to get refreshed.</span>
<a href="#l147.62"></a><span id="l147.62">   mc.window.RefreshAllViewPopups(mc.e(&quot;viewPickerPopup&quot;));</span>
<a href="#l147.63"></a><span id="l147.63" class="difflineat">@@ -62,17 +62,17 @@ function test_save_view_as_folder() {</span>
<a href="#l147.64"></a><span id="l147.64">   plan_for_modal_dialog(</span>
<a href="#l147.65"></a><span id="l147.65">     &quot;mailnews:virtualFolderProperties&quot;,</span>
<a href="#l147.66"></a><span id="l147.66">     subtest_save_mail_view</span>
<a href="#l147.67"></a><span id="l147.67">   );</span>
<a href="#l147.68"></a><span id="l147.68">   // we have to use value here because the option mechanism is not sophisticated</span>
<a href="#l147.69"></a><span id="l147.69">   //  enough.</span>
<a href="#l147.70"></a><span id="l147.70">   mc.window.ViewChange(MailViewConstants.kViewItemVirtual);</span>
<a href="#l147.71"></a><span id="l147.71">   wait_for_modal_dialog(&quot;mailnews:virtualFolderProperties&quot;);</span>
<a href="#l147.72"></a><span id="l147.72" class="difflineminus">-}</span>
<a href="#l147.73"></a><span id="l147.73" class="difflineplus">+});</span>
<a href="#l147.74"></a><span id="l147.74"> </span>
<a href="#l147.75"></a><span id="l147.75"> function subtest_save_mail_view(savc) {</span>
<a href="#l147.76"></a><span id="l147.76">   // - make sure the name is right</span>
<a href="#l147.77"></a><span id="l147.77">   savc.assertValue(savc.eid(&quot;name&quot;), baseFolder.prettyName + &quot;-Important&quot;);</span>
<a href="#l147.78"></a><span id="l147.78"> </span>
<a href="#l147.79"></a><span id="l147.79">   let elem = savc.window.document.getElementById(&quot;searchVal0&quot;);</span>
<a href="#l147.80"></a><span id="l147.80">   let index = 0;</span>
<a href="#l147.81"></a><span id="l147.81"> </span>
<a href="#l147.82"></a><span id="l147.82" class="difflineat">@@ -84,19 +84,26 @@ function subtest_save_mail_view(savc) {</span>
<a href="#l147.83"></a><span id="l147.83"> </span>
<a href="#l147.84"></a><span id="l147.84">   // - make sure the constraint is right</span>
<a href="#l147.85"></a><span id="l147.85">   savc.assertValue(new elib.Elem(elem), &quot;$label1&quot;);</span>
<a href="#l147.86"></a><span id="l147.86"> </span>
<a href="#l147.87"></a><span id="l147.87">   // - save it</span>
<a href="#l147.88"></a><span id="l147.88">   savc.window.onOK();</span>
<a href="#l147.89"></a><span id="l147.89"> }</span>
<a href="#l147.90"></a><span id="l147.90"> </span>
<a href="#l147.91"></a><span id="l147.91" class="difflineminus">-function test_verify_saved_mail_view() {</span>
<a href="#l147.92"></a><span id="l147.92" class="difflineplus">+add_task(function test_verify_saved_mail_view() {</span>
<a href="#l147.93"></a><span id="l147.93">   // - make sure the folder got created</span>
<a href="#l147.94"></a><span id="l147.94">   savedFolder = baseFolder.getChildNamed(baseFolder.prettyName + &quot;-Important&quot;);</span>
<a href="#l147.95"></a><span id="l147.95">   if (!savedFolder) {</span>
<a href="#l147.96"></a><span id="l147.96">     throw new Error(&quot;MailViewA-Important was not created!&quot;);</span>
<a href="#l147.97"></a><span id="l147.97">   }</span>
<a href="#l147.98"></a><span id="l147.98"> </span>
<a href="#l147.99"></a><span id="l147.99">   // - go in the folder and make sure the right messages are displayed</span>
<a href="#l147.100"></a><span id="l147.100">   be_in_folder(savedFolder);</span>
<a href="#l147.101"></a><span id="l147.101">   assert_messages_in_view(setTagged, mc);</span>
<a href="#l147.102"></a><span id="l147.102" class="difflineminus">-}</span>
<a href="#l147.103"></a><span id="l147.103" class="difflineplus">+</span>
<a href="#l147.104"></a><span id="l147.104" class="difflineplus">+  Assert.report(</span>
<a href="#l147.105"></a><span id="l147.105" class="difflineplus">+    false,</span>
<a href="#l147.106"></a><span id="l147.106" class="difflineplus">+    undefined,</span>
<a href="#l147.107"></a><span id="l147.107" class="difflineplus">+    undefined,</span>
<a href="#l147.108"></a><span id="l147.108" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l147.109"></a><span id="l147.109" class="difflineplus">+  );</span>
<a href="#l147.110"></a><span id="l147.110" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l148.1"></a><span id="l148.1">copy from mail/test/mozmill/folder-display/test-message-commands.js</span>
<a href="#l148.2"></a><span id="l148.2">copy to mail/test/browser/folder-display/browser_messageCommands.js</span>
<a href="#l148.3"></a><span id="l148.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-commands.js</span>
<a href="#l148.4"></a><span id="l148.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_messageCommands.js</span>
<a href="#l148.5"></a><span id="l148.5" class="difflineat">@@ -11,21 +11,17 @@</span>
<a href="#l148.6"></a><span id="l148.6"> &quot;use strict&quot;;</span>
<a href="#l148.7"></a><span id="l148.7"> </span>
<a href="#l148.8"></a><span id="l148.8"> var { wait_for_content_tab_load } = ChromeUtils.import(</span>
<a href="#l148.9"></a><span id="l148.9">   &quot;resource://testing-common/mozmill/ContentTabHelpers.jsm&quot;</span>
<a href="#l148.10"></a><span id="l148.10"> );</span>
<a href="#l148.11"></a><span id="l148.11"> var {</span>
<a href="#l148.12"></a><span id="l148.12">   add_sets_to_folders,</span>
<a href="#l148.13"></a><span id="l148.13">   archive_selected_messages,</span>
<a href="#l148.14"></a><span id="l148.14" class="difflineminus">-  assert_equals,</span>
<a href="#l148.15"></a><span id="l148.15" class="difflineminus">-  assert_false,</span>
<a href="#l148.16"></a><span id="l148.16" class="difflineminus">-  assert_not_equals,</span>
<a href="#l148.17"></a><span id="l148.17">   assert_selected_and_displayed,</span>
<a href="#l148.18"></a><span id="l148.18" class="difflineminus">-  assert_true,</span>
<a href="#l148.19"></a><span id="l148.19">   be_in_folder,</span>
<a href="#l148.20"></a><span id="l148.20">   close_popup,</span>
<a href="#l148.21"></a><span id="l148.21">   collapse_all_threads,</span>
<a href="#l148.22"></a><span id="l148.22">   create_folder,</span>
<a href="#l148.23"></a><span id="l148.23">   create_thread,</span>
<a href="#l148.24"></a><span id="l148.24">   make_display_threaded,</span>
<a href="#l148.25"></a><span id="l148.25">   make_display_unthreaded,</span>
<a href="#l148.26"></a><span id="l148.26">   make_new_sets_in_folder,</span>
<a href="#l148.27"></a><span id="l148.27" class="difflineat">@@ -51,17 +47,17 @@ var { MailUtils } = ChromeUtils.import(&quot;</span>
<a href="#l148.28"></a><span id="l148.28"> </span>
<a href="#l148.29"></a><span id="l148.29"> var unreadFolder, shiftDeleteFolder, threadDeleteFolder;</span>
<a href="#l148.30"></a><span id="l148.30"> var archiveSrcFolder = null;</span>
<a href="#l148.31"></a><span id="l148.31"> var archiveURI;</span>
<a href="#l148.32"></a><span id="l148.32"> </span>
<a href="#l148.33"></a><span id="l148.33"> var acctMgr;</span>
<a href="#l148.34"></a><span id="l148.34"> var tagArray;</span>
<a href="#l148.35"></a><span id="l148.35"> </span>
<a href="#l148.36"></a><span id="l148.36" class="difflineminus">-var setupModule = function(module) {</span>
<a href="#l148.37"></a><span id="l148.37" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l148.38"></a><span id="l148.38">   unreadFolder = create_folder(&quot;UnreadFolder&quot;);</span>
<a href="#l148.39"></a><span id="l148.39">   shiftDeleteFolder = create_folder(&quot;ShiftDeleteFolder&quot;);</span>
<a href="#l148.40"></a><span id="l148.40">   threadDeleteFolder = create_folder(&quot;ThreadDeleteFolder&quot;);</span>
<a href="#l148.41"></a><span id="l148.41">   archiveSrcFolder = create_folder(&quot;ArchiveSrc&quot;);</span>
<a href="#l148.42"></a><span id="l148.42"> </span>
<a href="#l148.43"></a><span id="l148.43">   make_new_sets_in_folder(unreadFolder, [{ count: 2 }]);</span>
<a href="#l148.44"></a><span id="l148.44">   make_new_sets_in_folder(shiftDeleteFolder, [{ count: 3 }]);</span>
<a href="#l148.45"></a><span id="l148.45">   add_sets_to_folders(</span>
<a href="#l148.46"></a><span id="l148.46" class="difflineat">@@ -71,30 +67,30 @@ var setupModule = function(module) {</span>
<a href="#l148.47"></a><span id="l148.47"> </span>
<a href="#l148.48"></a><span id="l148.48">   // Create messages from 20 different months, which will mean 2 different</span>
<a href="#l148.49"></a><span id="l148.49">   // years as well.</span>
<a href="#l148.50"></a><span id="l148.50">   make_new_sets_in_folder(archiveSrcFolder, [</span>
<a href="#l148.51"></a><span id="l148.51">     { count: 20, age_incr: { weeks: 5 } },</span>
<a href="#l148.52"></a><span id="l148.52">   ]);</span>
<a href="#l148.53"></a><span id="l148.53"> </span>
<a href="#l148.54"></a><span id="l148.54">   tagArray = MailServices.tags.getAllTags();</span>
<a href="#l148.55"></a><span id="l148.55" class="difflineminus">-};</span>
<a href="#l148.56"></a><span id="l148.56" class="difflineplus">+});</span>
<a href="#l148.57"></a><span id="l148.57"> </span>
<a href="#l148.58"></a><span id="l148.58"> /**</span>
<a href="#l148.59"></a><span id="l148.59">  * Ensures that all messages have a particular read status</span>
<a href="#l148.60"></a><span id="l148.60">  * @param messages an array of nsIMsgDBHdrs to check</span>
<a href="#l148.61"></a><span id="l148.61">  * @param read true if the messages should be marked read, false otherwise</span>
<a href="#l148.62"></a><span id="l148.62">  */</span>
<a href="#l148.63"></a><span id="l148.63"> function check_read_status(messages, read) {</span>
<a href="#l148.64"></a><span id="l148.64">   function read_str(read) {</span>
<a href="#l148.65"></a><span id="l148.65">     return read ? &quot;read&quot; : &quot;unread&quot;;</span>
<a href="#l148.66"></a><span id="l148.66">   }</span>
<a href="#l148.67"></a><span id="l148.67"> </span>
<a href="#l148.68"></a><span id="l148.68">   for (let i = 0; i &lt; messages.length; i++) {</span>
<a href="#l148.69"></a><span id="l148.69" class="difflineminus">-    assert_true(</span>
<a href="#l148.70"></a><span id="l148.70" class="difflineplus">+    Assert.ok(</span>
<a href="#l148.71"></a><span id="l148.71">       messages[i].isRead == read,</span>
<a href="#l148.72"></a><span id="l148.72">       &quot;Message marked as &quot; +</span>
<a href="#l148.73"></a><span id="l148.73">         read_str(messages[i].isRead) +</span>
<a href="#l148.74"></a><span id="l148.74">         &quot;, expected &quot; +</span>
<a href="#l148.75"></a><span id="l148.75">         read_str(read)</span>
<a href="#l148.76"></a><span id="l148.76">     );</span>
<a href="#l148.77"></a><span id="l148.77">   }</span>
<a href="#l148.78"></a><span id="l148.78"> }</span>
<a href="#l148.79"></a><span id="l148.79" class="difflineat">@@ -108,24 +104,24 @@ function check_read_status(messages, rea</span>
<a href="#l148.80"></a><span id="l148.80"> function check_read_menuitems(index, canMarkRead, canMarkUnread) {</span>
<a href="#l148.81"></a><span id="l148.81">   right_click_on_row(index);</span>
<a href="#l148.82"></a><span id="l148.82">   wait_for_popup_to_open(mc.e(&quot;mailContext&quot;));</span>
<a href="#l148.83"></a><span id="l148.83">   mc.click_menus_in_sequence(mc.e(&quot;mailContext&quot;), [{ id: &quot;mailContext-mark&quot; }]);</span>
<a href="#l148.84"></a><span id="l148.84"> </span>
<a href="#l148.85"></a><span id="l148.85">   let readEnabled = !mc.e(&quot;mailContext-markRead&quot;).disabled;</span>
<a href="#l148.86"></a><span id="l148.86">   let unreadEnabled = !mc.e(&quot;mailContext-markUnread&quot;).disabled;</span>
<a href="#l148.87"></a><span id="l148.87"> </span>
<a href="#l148.88"></a><span id="l148.88" class="difflineminus">-  assert_true(</span>
<a href="#l148.89"></a><span id="l148.89" class="difflineplus">+  Assert.ok(</span>
<a href="#l148.90"></a><span id="l148.90">     readEnabled == canMarkRead,</span>
<a href="#l148.91"></a><span id="l148.91">     &quot;Mark read menu item &quot; +</span>
<a href="#l148.92"></a><span id="l148.92">       (canMarkRead ? &quot;dis&quot; : &quot;en&quot;) +</span>
<a href="#l148.93"></a><span id="l148.93">       &quot;abled when it shouldn't be!&quot;</span>
<a href="#l148.94"></a><span id="l148.94">   );</span>
<a href="#l148.95"></a><span id="l148.95"> </span>
<a href="#l148.96"></a><span id="l148.96" class="difflineminus">-  assert_true(</span>
<a href="#l148.97"></a><span id="l148.97" class="difflineplus">+  Assert.ok(</span>
<a href="#l148.98"></a><span id="l148.98">     unreadEnabled == canMarkUnread,</span>
<a href="#l148.99"></a><span id="l148.99">     &quot;Mark unread menu item &quot; +</span>
<a href="#l148.100"></a><span id="l148.100">       (canMarkUnread ? &quot;dis&quot; : &quot;en&quot;) +</span>
<a href="#l148.101"></a><span id="l148.101">       &quot;abled when it shouldn't be!&quot;</span>
<a href="#l148.102"></a><span id="l148.102">   );</span>
<a href="#l148.103"></a><span id="l148.103"> }</span>
<a href="#l148.104"></a><span id="l148.104"> </span>
<a href="#l148.105"></a><span id="l148.105"> function enable_archiving(enabled) {</span>
<a href="#l148.106"></a><span id="l148.106" class="difflineat">@@ -143,253 +139,257 @@ function mark_read_via_menu(index, read)</span>
<a href="#l148.107"></a><span id="l148.107">   wait_for_popup_to_open(mc.e(&quot;mailContext&quot;));</span>
<a href="#l148.108"></a><span id="l148.108">   mc.click_menus_in_sequence(mc.e(&quot;mailContext&quot;), [</span>
<a href="#l148.109"></a><span id="l148.109">     { id: &quot;mailContext-mark&quot; },</span>
<a href="#l148.110"></a><span id="l148.110">     { id: menuItem },</span>
<a href="#l148.111"></a><span id="l148.111">   ]);</span>
<a href="#l148.112"></a><span id="l148.112">   close_popup(mc, mc.eid(&quot;mailContext&quot;));</span>
<a href="#l148.113"></a><span id="l148.113"> }</span>
<a href="#l148.114"></a><span id="l148.114"> </span>
<a href="#l148.115"></a><span id="l148.115" class="difflineminus">-function test_mark_one_read() {</span>
<a href="#l148.116"></a><span id="l148.116" class="difflineplus">+add_task(function test_mark_one_read() {</span>
<a href="#l148.117"></a><span id="l148.117">   be_in_folder(unreadFolder);</span>
<a href="#l148.118"></a><span id="l148.118">   let curMessage = select_click_row(0);</span>
<a href="#l148.119"></a><span id="l148.119"> </span>
<a href="#l148.120"></a><span id="l148.120">   curMessage.markRead(false);</span>
<a href="#l148.121"></a><span id="l148.121">   mark_read_via_menu(0, true);</span>
<a href="#l148.122"></a><span id="l148.122">   check_read_status([curMessage], true);</span>
<a href="#l148.123"></a><span id="l148.123" class="difflineminus">-}</span>
<a href="#l148.124"></a><span id="l148.124" class="difflineplus">+});</span>
<a href="#l148.125"></a><span id="l148.125"> </span>
<a href="#l148.126"></a><span id="l148.126" class="difflineminus">-function test_mark_one_unread() {</span>
<a href="#l148.127"></a><span id="l148.127" class="difflineplus">+add_task(function test_mark_one_unread() {</span>
<a href="#l148.128"></a><span id="l148.128">   be_in_folder(unreadFolder);</span>
<a href="#l148.129"></a><span id="l148.129">   let curMessage = select_click_row(0);</span>
<a href="#l148.130"></a><span id="l148.130"> </span>
<a href="#l148.131"></a><span id="l148.131">   curMessage.markRead(true);</span>
<a href="#l148.132"></a><span id="l148.132">   mark_read_via_menu(0, false);</span>
<a href="#l148.133"></a><span id="l148.133">   check_read_status([curMessage], false);</span>
<a href="#l148.134"></a><span id="l148.134" class="difflineminus">-}</span>
<a href="#l148.135"></a><span id="l148.135" class="difflineplus">+});</span>
<a href="#l148.136"></a><span id="l148.136"> </span>
<a href="#l148.137"></a><span id="l148.137" class="difflineminus">-function test_mark_n_read() {</span>
<a href="#l148.138"></a><span id="l148.138" class="difflineplus">+add_task(function test_mark_n_read() {</span>
<a href="#l148.139"></a><span id="l148.139">   be_in_folder(unreadFolder);</span>
<a href="#l148.140"></a><span id="l148.140">   select_click_row(0);</span>
<a href="#l148.141"></a><span id="l148.141">   let curMessages = select_shift_click_row(1);</span>
<a href="#l148.142"></a><span id="l148.142"> </span>
<a href="#l148.143"></a><span id="l148.143">   for (let i = 0; i &lt; curMessages.length; i++) {</span>
<a href="#l148.144"></a><span id="l148.144">     curMessages[i].markRead(false);</span>
<a href="#l148.145"></a><span id="l148.145">   }</span>
<a href="#l148.146"></a><span id="l148.146">   mark_read_via_menu(0, true);</span>
<a href="#l148.147"></a><span id="l148.147">   check_read_status(curMessages, true);</span>
<a href="#l148.148"></a><span id="l148.148" class="difflineminus">-}</span>
<a href="#l148.149"></a><span id="l148.149" class="difflineplus">+});</span>
<a href="#l148.150"></a><span id="l148.150"> </span>
<a href="#l148.151"></a><span id="l148.151" class="difflineminus">-function test_mark_n_unread() {</span>
<a href="#l148.152"></a><span id="l148.152" class="difflineplus">+add_task(function test_mark_n_unread() {</span>
<a href="#l148.153"></a><span id="l148.153">   be_in_folder(unreadFolder);</span>
<a href="#l148.154"></a><span id="l148.154">   select_click_row(0);</span>
<a href="#l148.155"></a><span id="l148.155">   let curMessages = select_shift_click_row(1);</span>
<a href="#l148.156"></a><span id="l148.156"> </span>
<a href="#l148.157"></a><span id="l148.157">   for (let i = 0; i &lt; curMessages.length; i++) {</span>
<a href="#l148.158"></a><span id="l148.158">     curMessages[i].markRead(true);</span>
<a href="#l148.159"></a><span id="l148.159">   }</span>
<a href="#l148.160"></a><span id="l148.160">   mark_read_via_menu(0, false);</span>
<a href="#l148.161"></a><span id="l148.161">   check_read_status(curMessages, false);</span>
<a href="#l148.162"></a><span id="l148.162" class="difflineminus">-}</span>
<a href="#l148.163"></a><span id="l148.163" class="difflineplus">+});</span>
<a href="#l148.164"></a><span id="l148.164"> </span>
<a href="#l148.165"></a><span id="l148.165" class="difflineminus">-function test_mark_n_read_mixed() {</span>
<a href="#l148.166"></a><span id="l148.166" class="difflineplus">+add_task(function test_mark_n_read_mixed() {</span>
<a href="#l148.167"></a><span id="l148.167">   be_in_folder(unreadFolder);</span>
<a href="#l148.168"></a><span id="l148.168">   select_click_row(0);</span>
<a href="#l148.169"></a><span id="l148.169">   let curMessages = select_shift_click_row(1);</span>
<a href="#l148.170"></a><span id="l148.170"> </span>
<a href="#l148.171"></a><span id="l148.171">   curMessages[0].markRead(true);</span>
<a href="#l148.172"></a><span id="l148.172">   curMessages[1].markRead(false);</span>
<a href="#l148.173"></a><span id="l148.173">   mark_read_via_menu(0, true);</span>
<a href="#l148.174"></a><span id="l148.174">   check_read_status(curMessages, true);</span>
<a href="#l148.175"></a><span id="l148.175"> </span>
<a href="#l148.176"></a><span id="l148.176">   curMessages[0].markRead(false);</span>
<a href="#l148.177"></a><span id="l148.177">   curMessages[1].markRead(true);</span>
<a href="#l148.178"></a><span id="l148.178">   mark_read_via_menu(0, true);</span>
<a href="#l148.179"></a><span id="l148.179">   check_read_status(curMessages, true);</span>
<a href="#l148.180"></a><span id="l148.180" class="difflineminus">-}</span>
<a href="#l148.181"></a><span id="l148.181" class="difflineplus">+});</span>
<a href="#l148.182"></a><span id="l148.182"> </span>
<a href="#l148.183"></a><span id="l148.183" class="difflineminus">-function test_mark_n_unread_mixed() {</span>
<a href="#l148.184"></a><span id="l148.184" class="difflineplus">+add_task(function test_mark_n_unread_mixed() {</span>
<a href="#l148.185"></a><span id="l148.185">   be_in_folder(unreadFolder);</span>
<a href="#l148.186"></a><span id="l148.186">   select_click_row(0);</span>
<a href="#l148.187"></a><span id="l148.187">   let curMessages = select_shift_click_row(1);</span>
<a href="#l148.188"></a><span id="l148.188"> </span>
<a href="#l148.189"></a><span id="l148.189">   curMessages[0].markRead(false);</span>
<a href="#l148.190"></a><span id="l148.190">   curMessages[1].markRead(true);</span>
<a href="#l148.191"></a><span id="l148.191">   mark_read_via_menu(0, false);</span>
<a href="#l148.192"></a><span id="l148.192">   check_read_status(curMessages, false);</span>
<a href="#l148.193"></a><span id="l148.193"> </span>
<a href="#l148.194"></a><span id="l148.194">   curMessages[0].markRead(true);</span>
<a href="#l148.195"></a><span id="l148.195">   curMessages[1].markRead(false);</span>
<a href="#l148.196"></a><span id="l148.196">   mark_read_via_menu(0, false);</span>
<a href="#l148.197"></a><span id="l148.197">   check_read_status(curMessages, false);</span>
<a href="#l148.198"></a><span id="l148.198" class="difflineminus">-}</span>
<a href="#l148.199"></a><span id="l148.199" class="difflineplus">+});</span>
<a href="#l148.200"></a><span id="l148.200"> </span>
<a href="#l148.201"></a><span id="l148.201" class="difflineminus">-function test_toggle_read() {</span>
<a href="#l148.202"></a><span id="l148.202" class="difflineplus">+add_task(function test_toggle_read() {</span>
<a href="#l148.203"></a><span id="l148.203">   be_in_folder(unreadFolder);</span>
<a href="#l148.204"></a><span id="l148.204">   let curMessage = select_click_row(0);</span>
<a href="#l148.205"></a><span id="l148.205"> </span>
<a href="#l148.206"></a><span id="l148.206">   curMessage.markRead(false);</span>
<a href="#l148.207"></a><span id="l148.207">   mc.keypress(null, &quot;m&quot;, {});</span>
<a href="#l148.208"></a><span id="l148.208">   check_read_status([curMessage], true);</span>
<a href="#l148.209"></a><span id="l148.209" class="difflineminus">-}</span>
<a href="#l148.210"></a><span id="l148.210" class="difflineplus">+});</span>
<a href="#l148.211"></a><span id="l148.211"> </span>
<a href="#l148.212"></a><span id="l148.212" class="difflineminus">-function test_toggle_unread() {</span>
<a href="#l148.213"></a><span id="l148.213" class="difflineplus">+add_task(function test_toggle_unread() {</span>
<a href="#l148.214"></a><span id="l148.214">   be_in_folder(unreadFolder);</span>
<a href="#l148.215"></a><span id="l148.215">   let curMessage = select_click_row(0);</span>
<a href="#l148.216"></a><span id="l148.216"> </span>
<a href="#l148.217"></a><span id="l148.217">   curMessage.markRead(true);</span>
<a href="#l148.218"></a><span id="l148.218">   mc.keypress(null, &quot;m&quot;, {});</span>
<a href="#l148.219"></a><span id="l148.219">   check_read_status([curMessage], false);</span>
<a href="#l148.220"></a><span id="l148.220" class="difflineminus">-}</span>
<a href="#l148.221"></a><span id="l148.221" class="difflineplus">+});</span>
<a href="#l148.222"></a><span id="l148.222"> </span>
<a href="#l148.223"></a><span id="l148.223" class="difflineminus">-function test_toggle_mixed() {</span>
<a href="#l148.224"></a><span id="l148.224" class="difflineplus">+add_task(function test_toggle_mixed() {</span>
<a href="#l148.225"></a><span id="l148.225">   be_in_folder(unreadFolder);</span>
<a href="#l148.226"></a><span id="l148.226">   select_click_row(0);</span>
<a href="#l148.227"></a><span id="l148.227">   let curMessages = select_shift_click_row(1);</span>
<a href="#l148.228"></a><span id="l148.228"> </span>
<a href="#l148.229"></a><span id="l148.229">   curMessages[0].markRead(false);</span>
<a href="#l148.230"></a><span id="l148.230">   curMessages[1].markRead(true);</span>
<a href="#l148.231"></a><span id="l148.231">   mc.keypress(null, &quot;m&quot;, {});</span>
<a href="#l148.232"></a><span id="l148.232">   check_read_status(curMessages, true);</span>
<a href="#l148.233"></a><span id="l148.233"> </span>
<a href="#l148.234"></a><span id="l148.234">   curMessages[0].markRead(true);</span>
<a href="#l148.235"></a><span id="l148.235">   curMessages[1].markRead(false);</span>
<a href="#l148.236"></a><span id="l148.236">   mc.keypress(null, &quot;m&quot;, {});</span>
<a href="#l148.237"></a><span id="l148.237">   check_read_status(curMessages, false);</span>
<a href="#l148.238"></a><span id="l148.238" class="difflineminus">-}</span>
<a href="#l148.239"></a><span id="l148.239" class="difflineplus">+});</span>
<a href="#l148.240"></a><span id="l148.240"> </span>
<a href="#l148.241"></a><span id="l148.241" class="difflineminus">-function test_mark_menu_read() {</span>
<a href="#l148.242"></a><span id="l148.242" class="difflineplus">+add_task(function test_mark_menu_read() {</span>
<a href="#l148.243"></a><span id="l148.243">   be_in_folder(unreadFolder);</span>
<a href="#l148.244"></a><span id="l148.244">   let curMessage = select_click_row(0);</span>
<a href="#l148.245"></a><span id="l148.245"> </span>
<a href="#l148.246"></a><span id="l148.246">   curMessage.markRead(false);</span>
<a href="#l148.247"></a><span id="l148.247">   check_read_menuitems(0, true, false);</span>
<a href="#l148.248"></a><span id="l148.248" class="difflineminus">-}</span>
<a href="#l148.249"></a><span id="l148.249" class="difflineplus">+});</span>
<a href="#l148.250"></a><span id="l148.250"> </span>
<a href="#l148.251"></a><span id="l148.251" class="difflineminus">-function test_mark_menu_unread() {</span>
<a href="#l148.252"></a><span id="l148.252" class="difflineplus">+add_task(function test_mark_menu_unread() {</span>
<a href="#l148.253"></a><span id="l148.253">   be_in_folder(unreadFolder);</span>
<a href="#l148.254"></a><span id="l148.254">   let curMessage = select_click_row(0);</span>
<a href="#l148.255"></a><span id="l148.255"> </span>
<a href="#l148.256"></a><span id="l148.256">   curMessage.markRead(true);</span>
<a href="#l148.257"></a><span id="l148.257">   check_read_menuitems(0, false, true);</span>
<a href="#l148.258"></a><span id="l148.258" class="difflineminus">-}</span>
<a href="#l148.259"></a><span id="l148.259" class="difflineplus">+});</span>
<a href="#l148.260"></a><span id="l148.260"> </span>
<a href="#l148.261"></a><span id="l148.261" class="difflineminus">-function test_mark_menu_mixed() {</span>
<a href="#l148.262"></a><span id="l148.262" class="difflineplus">+add_task(function test_mark_menu_mixed() {</span>
<a href="#l148.263"></a><span id="l148.263">   be_in_folder(unreadFolder);</span>
<a href="#l148.264"></a><span id="l148.264">   select_click_row(0);</span>
<a href="#l148.265"></a><span id="l148.265">   let curMessages = select_shift_click_row(1);</span>
<a href="#l148.266"></a><span id="l148.266"> </span>
<a href="#l148.267"></a><span id="l148.267">   curMessages[0].markRead(false);</span>
<a href="#l148.268"></a><span id="l148.268">   curMessages[1].markRead(true);</span>
<a href="#l148.269"></a><span id="l148.269"> </span>
<a href="#l148.270"></a><span id="l148.270">   check_read_menuitems(0, true, true);</span>
<a href="#l148.271"></a><span id="l148.271" class="difflineminus">-}</span>
<a href="#l148.272"></a><span id="l148.272" class="difflineplus">+});</span>
<a href="#l148.273"></a><span id="l148.273"> </span>
<a href="#l148.274"></a><span id="l148.274" class="difflineminus">-function test_mark_all_read() {</span>
<a href="#l148.275"></a><span id="l148.275" class="difflineplus">+add_task(function test_mark_all_read() {</span>
<a href="#l148.276"></a><span id="l148.276">   be_in_folder(unreadFolder);</span>
<a href="#l148.277"></a><span id="l148.277">   let curMessage = select_click_row(0);</span>
<a href="#l148.278"></a><span id="l148.278">   curMessage.markRead(false);</span>
<a href="#l148.279"></a><span id="l148.279"> </span>
<a href="#l148.280"></a><span id="l148.280">   // Make sure we can mark all read with &gt;0 messages unread.</span>
<a href="#l148.281"></a><span id="l148.281">   right_click_on_row(0);</span>
<a href="#l148.282"></a><span id="l148.282">   wait_for_popup_to_open(mc.e(&quot;mailContext&quot;));</span>
<a href="#l148.283"></a><span id="l148.283">   mc.click_menus_in_sequence(mc.e(&quot;mailContext&quot;), [</span>
<a href="#l148.284"></a><span id="l148.284">     { id: &quot;mailContext-mark&quot; },</span>
<a href="#l148.285"></a><span id="l148.285">     { id: &quot;mailContext-markAllRead&quot; },</span>
<a href="#l148.286"></a><span id="l148.286">   ]);</span>
<a href="#l148.287"></a><span id="l148.287">   close_popup(mc, mc.eid(&quot;mailContext&quot;));</span>
<a href="#l148.288"></a><span id="l148.288"> </span>
<a href="#l148.289"></a><span id="l148.289" class="difflineminus">-  assert_true(curMessage.isRead, &quot;Message should have been marked read!&quot;);</span>
<a href="#l148.290"></a><span id="l148.290" class="difflineplus">+  Assert.ok(curMessage.isRead, &quot;Message should have been marked read!&quot;);</span>
<a href="#l148.291"></a><span id="l148.291"> </span>
<a href="#l148.292"></a><span id="l148.292">   // Make sure we can't mark all read, now that all messages are already read.</span>
<a href="#l148.293"></a><span id="l148.293">   right_click_on_row(0);</span>
<a href="#l148.294"></a><span id="l148.294">   wait_for_popup_to_open(mc.e(&quot;mailContext&quot;));</span>
<a href="#l148.295"></a><span id="l148.295">   mc.click_menus_in_sequence(mc.e(&quot;mailContext&quot;), [{ id: &quot;mailContext-mark&quot; }]);</span>
<a href="#l148.296"></a><span id="l148.296"> </span>
<a href="#l148.297"></a><span id="l148.297">   let allReadDisabled = mc.e(&quot;mailContext-markAllRead&quot;).disabled;</span>
<a href="#l148.298"></a><span id="l148.298" class="difflineminus">-  assert_true(allReadDisabled, &quot;Mark All Read menu item should be disabled!&quot;);</span>
<a href="#l148.299"></a><span id="l148.299" class="difflineminus">-}</span>
<a href="#l148.300"></a><span id="l148.300" class="difflineplus">+  Assert.ok(allReadDisabled, &quot;Mark All Read menu item should be disabled!&quot;);</span>
<a href="#l148.301"></a><span id="l148.301" class="difflineplus">+});</span>
<a href="#l148.302"></a><span id="l148.302"> </span>
<a href="#l148.303"></a><span id="l148.303" class="difflineminus">-function test_shift_delete_prompt() {</span>
<a href="#l148.304"></a><span id="l148.304" class="difflineplus">+add_task(function test_shift_delete_prompt() {</span>
<a href="#l148.305"></a><span id="l148.305">   be_in_folder(shiftDeleteFolder);</span>
<a href="#l148.306"></a><span id="l148.306">   let curMessage = select_click_row(0);</span>
<a href="#l148.307"></a><span id="l148.307"> </span>
<a href="#l148.308"></a><span id="l148.308">   // First, try shift-deleting and then cancelling at the prompt.</span>
<a href="#l148.309"></a><span id="l148.309">   Services.prefs.setBoolPref(&quot;mail.warn_on_shift_delete&quot;, true);</span>
<a href="#l148.310"></a><span id="l148.310">   plan_for_modal_dialog(&quot;commonDialog&quot;, function(controller) {</span>
<a href="#l148.311"></a><span id="l148.311">     controller.window.document.documentElement.getButton(&quot;cancel&quot;).doCommand();</span>
<a href="#l148.312"></a><span id="l148.312">   });</span>
<a href="#l148.313"></a><span id="l148.313">   // We don't use press_delete here because we're not actually deleting this</span>
<a href="#l148.314"></a><span id="l148.314">   // time!</span>
<a href="#l148.315"></a><span id="l148.315" class="difflineplus">+  SimpleTest.ignoreAllUncaughtExceptions(true);</span>
<a href="#l148.316"></a><span id="l148.316">   mc.keypress(null, &quot;VK_DELETE&quot;, { shiftKey: true });</span>
<a href="#l148.317"></a><span id="l148.317" class="difflineplus">+  SimpleTest.ignoreAllUncaughtExceptions(false);</span>
<a href="#l148.318"></a><span id="l148.318">   wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l148.319"></a><span id="l148.319">   // Make sure we didn't actually delete the message.</span>
<a href="#l148.320"></a><span id="l148.320" class="difflineminus">-  assert_equals(curMessage, select_click_row(0));</span>
<a href="#l148.321"></a><span id="l148.321" class="difflineplus">+  Assert.equal(curMessage, select_click_row(0));</span>
<a href="#l148.322"></a><span id="l148.322"> </span>
<a href="#l148.323"></a><span id="l148.323">   // Second, try shift-deleting and then accepting the deletion.</span>
<a href="#l148.324"></a><span id="l148.324">   plan_for_modal_dialog(&quot;commonDialog&quot;, function(controller) {</span>
<a href="#l148.325"></a><span id="l148.325">     controller.window.document.documentElement.getButton(&quot;accept&quot;).doCommand();</span>
<a href="#l148.326"></a><span id="l148.326">   });</span>
<a href="#l148.327"></a><span id="l148.327">   press_delete(mc, { shiftKey: true });</span>
<a href="#l148.328"></a><span id="l148.328">   wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l148.329"></a><span id="l148.329">   // Make sure we really did delete the message.</span>
<a href="#l148.330"></a><span id="l148.330" class="difflineminus">-  assert_not_equals(curMessage, select_click_row(0));</span>
<a href="#l148.331"></a><span id="l148.331" class="difflineplus">+  Assert.notEqual(curMessage, select_click_row(0));</span>
<a href="#l148.332"></a><span id="l148.332"> </span>
<a href="#l148.333"></a><span id="l148.333">   // Finally, try shift-deleting when we turned off the prompt.</span>
<a href="#l148.334"></a><span id="l148.334">   Services.prefs.setBoolPref(&quot;mail.warn_on_shift_delete&quot;, false);</span>
<a href="#l148.335"></a><span id="l148.335">   curMessage = select_click_row(0);</span>
<a href="#l148.336"></a><span id="l148.336">   press_delete(mc, { shiftKey: true });</span>
<a href="#l148.337"></a><span id="l148.337">   wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l148.338"></a><span id="l148.338">   // Make sure we really did delete the message.</span>
<a href="#l148.339"></a><span id="l148.339" class="difflineminus">-  assert_not_equals(curMessage, select_click_row(0));</span>
<a href="#l148.340"></a><span id="l148.340" class="difflineplus">+  Assert.notEqual(curMessage, select_click_row(0));</span>
<a href="#l148.341"></a><span id="l148.341"> </span>
<a href="#l148.342"></a><span id="l148.342">   Services.prefs.clearUserPref(&quot;mail.warn_on_shift_delete&quot;);</span>
<a href="#l148.343"></a><span id="l148.343" class="difflineminus">-}</span>
<a href="#l148.344"></a><span id="l148.344" class="difflineplus">+});</span>
<a href="#l148.345"></a><span id="l148.345"> </span>
<a href="#l148.346"></a><span id="l148.346" class="difflineminus">-function test_thread_delete_prompt() {</span>
<a href="#l148.347"></a><span id="l148.347" class="difflineplus">+add_task(function test_thread_delete_prompt() {</span>
<a href="#l148.348"></a><span id="l148.348">   be_in_folder(threadDeleteFolder);</span>
<a href="#l148.349"></a><span id="l148.349">   make_display_threaded();</span>
<a href="#l148.350"></a><span id="l148.350">   collapse_all_threads();</span>
<a href="#l148.351"></a><span id="l148.351"> </span>
<a href="#l148.352"></a><span id="l148.352">   let curMessage = select_click_row(0);</span>
<a href="#l148.353"></a><span id="l148.353">   // First, try deleting and then cancelling at the prompt.</span>
<a href="#l148.354"></a><span id="l148.354">   Services.prefs.setBoolPref(&quot;mail.warn_on_collapsed_thread_operation&quot;, true);</span>
<a href="#l148.355"></a><span id="l148.355">   plan_for_modal_dialog(&quot;commonDialog&quot;, function(controller) {</span>
<a href="#l148.356"></a><span id="l148.356">     controller.window.document.documentElement.getButton(&quot;cancel&quot;).doCommand();</span>
<a href="#l148.357"></a><span id="l148.357">   });</span>
<a href="#l148.358"></a><span id="l148.358">   // We don't use press_delete here because we're not actually deleting this</span>
<a href="#l148.359"></a><span id="l148.359">   // time!</span>
<a href="#l148.360"></a><span id="l148.360" class="difflineplus">+  SimpleTest.ignoreAllUncaughtExceptions(true);</span>
<a href="#l148.361"></a><span id="l148.361">   mc.keypress(null, &quot;VK_DELETE&quot;, {});</span>
<a href="#l148.362"></a><span id="l148.362" class="difflineplus">+  SimpleTest.ignoreAllUncaughtExceptions(false);</span>
<a href="#l148.363"></a><span id="l148.363">   wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l148.364"></a><span id="l148.364">   // Make sure we didn't actually delete the message.</span>
<a href="#l148.365"></a><span id="l148.365" class="difflineminus">-  assert_equals(curMessage, select_click_row(0));</span>
<a href="#l148.366"></a><span id="l148.366" class="difflineplus">+  Assert.equal(curMessage, select_click_row(0));</span>
<a href="#l148.367"></a><span id="l148.367"> </span>
<a href="#l148.368"></a><span id="l148.368">   // Second, try deleting and then accepting the deletion.</span>
<a href="#l148.369"></a><span id="l148.369">   plan_for_modal_dialog(&quot;commonDialog&quot;, function(controller) {</span>
<a href="#l148.370"></a><span id="l148.370">     controller.window.document.documentElement.getButton(&quot;accept&quot;).doCommand();</span>
<a href="#l148.371"></a><span id="l148.371">   });</span>
<a href="#l148.372"></a><span id="l148.372">   press_delete(mc);</span>
<a href="#l148.373"></a><span id="l148.373">   wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l148.374"></a><span id="l148.374">   // Make sure we really did delete the message.</span>
<a href="#l148.375"></a><span id="l148.375" class="difflineminus">-  assert_not_equals(curMessage, select_click_row(0));</span>
<a href="#l148.376"></a><span id="l148.376" class="difflineplus">+  Assert.notEqual(curMessage, select_click_row(0));</span>
<a href="#l148.377"></a><span id="l148.377"> </span>
<a href="#l148.378"></a><span id="l148.378">   // Finally, try shift-deleting when we turned off the prompt.</span>
<a href="#l148.379"></a><span id="l148.379">   Services.prefs.setBoolPref(&quot;mail.warn_on_collapsed_thread_operation&quot;, false);</span>
<a href="#l148.380"></a><span id="l148.380">   curMessage = select_click_row(0);</span>
<a href="#l148.381"></a><span id="l148.381">   press_delete(mc);</span>
<a href="#l148.382"></a><span id="l148.382">   wait_for_modal_dialog(&quot;commonDialog&quot;);</span>
<a href="#l148.383"></a><span id="l148.383">   // Make sure we really did delete the message.</span>
<a href="#l148.384"></a><span id="l148.384" class="difflineminus">-  assert_not_equals(curMessage, select_click_row(0));</span>
<a href="#l148.385"></a><span id="l148.385" class="difflineplus">+  Assert.notEqual(curMessage, select_click_row(0));</span>
<a href="#l148.386"></a><span id="l148.386"> </span>
<a href="#l148.387"></a><span id="l148.387">   Services.prefs.clearUserPref(&quot;mail.warn_on_collapsed_thread_operation&quot;);</span>
<a href="#l148.388"></a><span id="l148.388" class="difflineminus">-}</span>
<a href="#l148.389"></a><span id="l148.389" class="difflineplus">+});</span>
<a href="#l148.390"></a><span id="l148.390"> </span>
<a href="#l148.391"></a><span id="l148.391" class="difflineminus">-function test_yearly_archive() {</span>
<a href="#l148.392"></a><span id="l148.392" class="difflineplus">+add_task(function test_yearly_archive() {</span>
<a href="#l148.393"></a><span id="l148.393">   yearly_archive(false);</span>
<a href="#l148.394"></a><span id="l148.394" class="difflineminus">-}</span>
<a href="#l148.395"></a><span id="l148.395" class="difflineplus">+});</span>
<a href="#l148.396"></a><span id="l148.396"> </span>
<a href="#l148.397"></a><span id="l148.397"> function yearly_archive(keep_structure) {</span>
<a href="#l148.398"></a><span id="l148.398">   be_in_folder(archiveSrcFolder);</span>
<a href="#l148.399"></a><span id="l148.399">   make_display_unthreaded();</span>
<a href="#l148.400"></a><span id="l148.400">   mc.folderDisplay.view.sort(</span>
<a href="#l148.401"></a><span id="l148.401">     Ci.nsMsgViewSortType.byDate,</span>
<a href="#l148.402"></a><span id="l148.402">     Ci.nsMsgViewSortOrder.ascending</span>
<a href="#l148.403"></a><span id="l148.403">   );</span>
<a href="#l148.404"></a><span id="l148.404" class="difflineat">@@ -421,36 +421,36 @@ function yearly_archive(keep_structure) </span>
<a href="#l148.405"></a><span id="l148.405">   let lastArchiveUri = archiveRoot + &quot;/&quot; + lastMsgYear;</span>
<a href="#l148.406"></a><span id="l148.406">   if (keep_structure) {</span>
<a href="#l148.407"></a><span id="l148.407">     firstArchiveUri += &quot;/ArchiveSrc&quot;;</span>
<a href="#l148.408"></a><span id="l148.408">     lastArchiveUri += &quot;/ArchiveSrc&quot;;</span>
<a href="#l148.409"></a><span id="l148.409">   }</span>
<a href="#l148.410"></a><span id="l148.410">   let firstArchiveFolder = MailUtils.getOrCreateFolder(firstArchiveUri);</span>
<a href="#l148.411"></a><span id="l148.411">   let lastArchiveFolder = MailUtils.getOrCreateFolder(lastArchiveUri);</span>
<a href="#l148.412"></a><span id="l148.412">   be_in_folder(firstArchiveFolder);</span>
<a href="#l148.413"></a><span id="l148.413" class="difflineminus">-  assert_true(</span>
<a href="#l148.414"></a><span id="l148.414" class="difflineplus">+  Assert.ok(</span>
<a href="#l148.415"></a><span id="l148.415">     mc.dbView.getMsgHdrAt(0).messageId == firstMsgHdrMsgId,</span>
<a href="#l148.416"></a><span id="l148.416">     &quot;Message should have been archived to &quot; +</span>
<a href="#l148.417"></a><span id="l148.417">       firstArchiveUri +</span>
<a href="#l148.418"></a><span id="l148.418">       &quot;, but it isn't present there&quot;</span>
<a href="#l148.419"></a><span id="l148.419">   );</span>
<a href="#l148.420"></a><span id="l148.420">   be_in_folder(lastArchiveFolder);</span>
<a href="#l148.421"></a><span id="l148.421"> </span>
<a href="#l148.422"></a><span id="l148.422" class="difflineminus">-  assert_true(</span>
<a href="#l148.423"></a><span id="l148.423" class="difflineplus">+  Assert.ok(</span>
<a href="#l148.424"></a><span id="l148.424">     mc.dbView.getMsgHdrAt(0).messageId == lastMsgHdrMsgId,</span>
<a href="#l148.425"></a><span id="l148.425">     &quot;Message should have been archived to &quot; +</span>
<a href="#l148.426"></a><span id="l148.426">       lastArchiveUri +</span>
<a href="#l148.427"></a><span id="l148.427">       &quot;, but it isn't present there&quot;</span>
<a href="#l148.428"></a><span id="l148.428">   );</span>
<a href="#l148.429"></a><span id="l148.429"> }</span>
<a href="#l148.430"></a><span id="l148.430"> </span>
<a href="#l148.431"></a><span id="l148.431" class="difflineminus">-function test_monthly_archive() {</span>
<a href="#l148.432"></a><span id="l148.432" class="difflineplus">+add_task(function test_monthly_archive() {</span>
<a href="#l148.433"></a><span id="l148.433">   enable_archiving(true);</span>
<a href="#l148.434"></a><span id="l148.434">   monthly_archive(false);</span>
<a href="#l148.435"></a><span id="l148.435" class="difflineminus">-}</span>
<a href="#l148.436"></a><span id="l148.436" class="difflineplus">+});</span>
<a href="#l148.437"></a><span id="l148.437"> </span>
<a href="#l148.438"></a><span id="l148.438"> function monthly_archive(keep_structure) {</span>
<a href="#l148.439"></a><span id="l148.439">   be_in_folder(archiveSrcFolder);</span>
<a href="#l148.440"></a><span id="l148.440">   let identity = MailServices.accounts.getFirstIdentityForServer(</span>
<a href="#l148.441"></a><span id="l148.441">     mc.folderDisplay.view.dbView.getMsgHdrAt(0).folder.server</span>
<a href="#l148.442"></a><span id="l148.442">   );</span>
<a href="#l148.443"></a><span id="l148.443">   identity.archiveGranularity = Ci.nsIMsgIdentity.perMonthArchiveFolders;</span>
<a href="#l148.444"></a><span id="l148.444">   select_click_row(0);</span>
<a href="#l148.445"></a><span id="l148.445" class="difflineat">@@ -484,149 +484,149 @@ function monthly_archive(keep_structure)</span>
<a href="#l148.446"></a><span id="l148.446">     archiveRoot + &quot;/&quot; + lastMsgYear + &quot;/&quot; + lastMonthFolderName;</span>
<a href="#l148.447"></a><span id="l148.447">   if (keep_structure) {</span>
<a href="#l148.448"></a><span id="l148.448">     firstArchiveUri += &quot;/ArchiveSrc&quot;;</span>
<a href="#l148.449"></a><span id="l148.449">     lastArchiveUri += &quot;/ArchiveSrc&quot;;</span>
<a href="#l148.450"></a><span id="l148.450">   }</span>
<a href="#l148.451"></a><span id="l148.451">   let firstArchiveFolder = MailUtils.getOrCreateFolder(firstArchiveUri);</span>
<a href="#l148.452"></a><span id="l148.452">   let lastArchiveFolder = MailUtils.getOrCreateFolder(lastArchiveUri);</span>
<a href="#l148.453"></a><span id="l148.453">   be_in_folder(firstArchiveFolder);</span>
<a href="#l148.454"></a><span id="l148.454" class="difflineminus">-  assert_true(</span>
<a href="#l148.455"></a><span id="l148.455" class="difflineplus">+  Assert.ok(</span>
<a href="#l148.456"></a><span id="l148.456">     mc.dbView.getMsgHdrAt(0).messageId == firstMsgHdrMsgId,</span>
<a href="#l148.457"></a><span id="l148.457">     &quot;Message should have been archived to Local Folders/&quot; +</span>
<a href="#l148.458"></a><span id="l148.458">       firstMsgYear +</span>
<a href="#l148.459"></a><span id="l148.459">       &quot;/&quot; +</span>
<a href="#l148.460"></a><span id="l148.460">       firstMonthFolderName +</span>
<a href="#l148.461"></a><span id="l148.461">       &quot;/Archives, but it isn't present there&quot;</span>
<a href="#l148.462"></a><span id="l148.462">   );</span>
<a href="#l148.463"></a><span id="l148.463">   be_in_folder(lastArchiveFolder);</span>
<a href="#l148.464"></a><span id="l148.464" class="difflineminus">-  assert_true(</span>
<a href="#l148.465"></a><span id="l148.465" class="difflineplus">+  Assert.ok(</span>
<a href="#l148.466"></a><span id="l148.466">     mc.dbView.getMsgHdrAt(0).messageId == lastMsgHdrMsgId,</span>
<a href="#l148.467"></a><span id="l148.467">     &quot;Message should have been archived to Local Folders/&quot; +</span>
<a href="#l148.468"></a><span id="l148.468">       lastMsgYear +</span>
<a href="#l148.469"></a><span id="l148.469">       &quot;/&quot; +</span>
<a href="#l148.470"></a><span id="l148.470">       lastMonthFolderName +</span>
<a href="#l148.471"></a><span id="l148.471">       &quot;/Archives, but it isn't present there&quot;</span>
<a href="#l148.472"></a><span id="l148.472">   );</span>
<a href="#l148.473"></a><span id="l148.473"> }</span>
<a href="#l148.474"></a><span id="l148.474"> </span>
<a href="#l148.475"></a><span id="l148.475" class="difflineminus">-function test_folder_structure_archiving() {</span>
<a href="#l148.476"></a><span id="l148.476" class="difflineplus">+add_task(function test_folder_structure_archiving() {</span>
<a href="#l148.477"></a><span id="l148.477">   enable_archiving(true);</span>
<a href="#l148.478"></a><span id="l148.478">   Services.prefs.setBoolPref(</span>
<a href="#l148.479"></a><span id="l148.479">     &quot;mail.identity.default.archive_keep_folder_structure&quot;,</span>
<a href="#l148.480"></a><span id="l148.480">     true</span>
<a href="#l148.481"></a><span id="l148.481">   );</span>
<a href="#l148.482"></a><span id="l148.482">   monthly_archive(true);</span>
<a href="#l148.483"></a><span id="l148.483">   yearly_archive(true);</span>
<a href="#l148.484"></a><span id="l148.484" class="difflineminus">-}</span>
<a href="#l148.485"></a><span id="l148.485" class="difflineplus">+});</span>
<a href="#l148.486"></a><span id="l148.486"> </span>
<a href="#l148.487"></a><span id="l148.487" class="difflineminus">-function test_selection_after_archive() {</span>
<a href="#l148.488"></a><span id="l148.488" class="difflineplus">+add_task(function test_selection_after_archive() {</span>
<a href="#l148.489"></a><span id="l148.489">   enable_archiving(true);</span>
<a href="#l148.490"></a><span id="l148.490">   be_in_folder(archiveSrcFolder);</span>
<a href="#l148.491"></a><span id="l148.491">   let identity = MailServices.accounts.getFirstIdentityForServer(</span>
<a href="#l148.492"></a><span id="l148.492">     mc.folderDisplay.view.dbView.getMsgHdrAt(0).folder.server</span>
<a href="#l148.493"></a><span id="l148.493">   );</span>
<a href="#l148.494"></a><span id="l148.494">   identity.archiveGranularity = Ci.nsIMsgIdentity.perMonthArchiveFolders;</span>
<a href="#l148.495"></a><span id="l148.495">   // We had a bug where we would always select the 0th message after an</span>
<a href="#l148.496"></a><span id="l148.496">   // archive, so test that we'll actually select the next remaining message</span>
<a href="#l148.497"></a><span id="l148.497">   // by archiving rows 1 &amp; 2 and verifying that the 3rd message gets selected.</span>
<a href="#l148.498"></a><span id="l148.498">   let hdrToSelect = select_click_row(3);</span>
<a href="#l148.499"></a><span id="l148.499">   select_click_row(1);</span>
<a href="#l148.500"></a><span id="l148.500">   select_control_click_row(2);</span>
<a href="#l148.501"></a><span id="l148.501">   archive_selected_messages();</span>
<a href="#l148.502"></a><span id="l148.502">   assert_selected_and_displayed(hdrToSelect);</span>
<a href="#l148.503"></a><span id="l148.503" class="difflineminus">-}</span>
<a href="#l148.504"></a><span id="l148.504" class="difflineplus">+});</span>
<a href="#l148.505"></a><span id="l148.505"> </span>
<a href="#l148.506"></a><span id="l148.506" class="difflineminus">-function test_disabled_archive() {</span>
<a href="#l148.507"></a><span id="l148.507" class="difflineplus">+add_task(function test_disabled_archive() {</span>
<a href="#l148.508"></a><span id="l148.508">   enable_archiving(false);</span>
<a href="#l148.509"></a><span id="l148.509">   be_in_folder(archiveSrcFolder);</span>
<a href="#l148.510"></a><span id="l148.510"> </span>
<a href="#l148.511"></a><span id="l148.511">   // test single message</span>
<a href="#l148.512"></a><span id="l148.512">   let current = select_click_row(0);</span>
<a href="#l148.513"></a><span id="l148.513">   mc.keypress(null, &quot;a&quot;, {});</span>
<a href="#l148.514"></a><span id="l148.514">   assert_selected_and_displayed(current);</span>
<a href="#l148.515"></a><span id="l148.515"> </span>
<a href="#l148.516"></a><span id="l148.516" class="difflineminus">-  assert_true(</span>
<a href="#l148.517"></a><span id="l148.517" class="difflineplus">+  Assert.ok(</span>
<a href="#l148.518"></a><span id="l148.518">     mc.e(&quot;hdrArchiveButton&quot;).disabled,</span>
<a href="#l148.519"></a><span id="l148.519">     &quot;Archive button should be disabled when archiving is disabled!&quot;</span>
<a href="#l148.520"></a><span id="l148.520">   );</span>
<a href="#l148.521"></a><span id="l148.521"> </span>
<a href="#l148.522"></a><span id="l148.522">   // test message summaries</span>
<a href="#l148.523"></a><span id="l148.523">   select_click_row(0);</span>
<a href="#l148.524"></a><span id="l148.524">   current = select_shift_click_row(2);</span>
<a href="#l148.525"></a><span id="l148.525">   mc.keypress(null, &quot;a&quot;, {});</span>
<a href="#l148.526"></a><span id="l148.526">   assert_selected_and_displayed(current);</span>
<a href="#l148.527"></a><span id="l148.527"> </span>
<a href="#l148.528"></a><span id="l148.528">   let htmlframe = mc.e(&quot;multimessage&quot;);</span>
<a href="#l148.529"></a><span id="l148.529">   let archiveBtn = htmlframe.contentDocument.getElementById(&quot;hdrArchiveButton&quot;);</span>
<a href="#l148.530"></a><span id="l148.530" class="difflineminus">-  assert_true(</span>
<a href="#l148.531"></a><span id="l148.531" class="difflineplus">+  Assert.ok(</span>
<a href="#l148.532"></a><span id="l148.532">     archiveBtn.collapsed,</span>
<a href="#l148.533"></a><span id="l148.533">     &quot;Multi-message archive button should be disabled when &quot; +</span>
<a href="#l148.534"></a><span id="l148.534">       &quot;archiving is disabled!&quot;</span>
<a href="#l148.535"></a><span id="l148.535">   );</span>
<a href="#l148.536"></a><span id="l148.536"> </span>
<a href="#l148.537"></a><span id="l148.537">   // test message summaries with &quot;large&quot; selection</span>
<a href="#l148.538"></a><span id="l148.538">   mc.folderDisplay.MAX_COUNT_FOR_CAN_ARCHIVE_CHECK = 1;</span>
<a href="#l148.539"></a><span id="l148.539">   select_click_row(0);</span>
<a href="#l148.540"></a><span id="l148.540">   current = select_shift_click_row(2);</span>
<a href="#l148.541"></a><span id="l148.541">   mc.keypress(null, &quot;a&quot;, {});</span>
<a href="#l148.542"></a><span id="l148.542">   assert_selected_and_displayed(current);</span>
<a href="#l148.543"></a><span id="l148.543">   mc.folderDisplay.MAX_COUNT_FOR_CAN_ARCHIVE_CHECK = 100;</span>
<a href="#l148.544"></a><span id="l148.544"> </span>
<a href="#l148.545"></a><span id="l148.545">   htmlframe = mc.e(&quot;multimessage&quot;);</span>
<a href="#l148.546"></a><span id="l148.546">   archiveBtn = htmlframe.contentDocument.getElementById(&quot;hdrArchiveButton&quot;);</span>
<a href="#l148.547"></a><span id="l148.547" class="difflineminus">-  assert_true(</span>
<a href="#l148.548"></a><span id="l148.548" class="difflineplus">+  Assert.ok(</span>
<a href="#l148.549"></a><span id="l148.549">     archiveBtn.collapsed,</span>
<a href="#l148.550"></a><span id="l148.550">     &quot;Multi-message archive button should be disabled when &quot; +</span>
<a href="#l148.551"></a><span id="l148.551">       &quot;archiving is disabled!&quot;</span>
<a href="#l148.552"></a><span id="l148.552">   );</span>
<a href="#l148.553"></a><span id="l148.553" class="difflineminus">-}</span>
<a href="#l148.554"></a><span id="l148.554" class="difflineplus">+});</span>
<a href="#l148.555"></a><span id="l148.555"> </span>
<a href="#l148.556"></a><span id="l148.556"> function check_tag_in_message(message, tag, isSet) {</span>
<a href="#l148.557"></a><span id="l148.557">   let tagSet = message</span>
<a href="#l148.558"></a><span id="l148.558">     .getStringProperty(&quot;keywords&quot;)</span>
<a href="#l148.559"></a><span id="l148.559">     .split(&quot; &quot;)</span>
<a href="#l148.560"></a><span id="l148.560">     .includes(tag.key);</span>
<a href="#l148.561"></a><span id="l148.561">   if (isSet) {</span>
<a href="#l148.562"></a><span id="l148.562" class="difflineminus">-    assert_true(tagSet, &quot;Tag '&quot; + tag.name + &quot;' expected on message!&quot;);</span>
<a href="#l148.563"></a><span id="l148.563" class="difflineplus">+    Assert.ok(tagSet, &quot;Tag '&quot; + tag.name + &quot;' expected on message!&quot;);</span>
<a href="#l148.564"></a><span id="l148.564">   } else {</span>
<a href="#l148.565"></a><span id="l148.565" class="difflineminus">-    assert_false(tagSet, &quot;Tag '&quot; + tag.name + &quot;' not expected on message!&quot;);</span>
<a href="#l148.566"></a><span id="l148.566" class="difflineplus">+    Assert.ok(!tagSet, &quot;Tag '&quot; + tag.name + &quot;' not expected on message!&quot;);</span>
<a href="#l148.567"></a><span id="l148.567">   }</span>
<a href="#l148.568"></a><span id="l148.568"> }</span>
<a href="#l148.569"></a><span id="l148.569"> </span>
<a href="#l148.570"></a><span id="l148.570" class="difflineminus">-function test_tag_keys() {</span>
<a href="#l148.571"></a><span id="l148.571" class="difflineplus">+add_task(function test_tag_keys() {</span>
<a href="#l148.572"></a><span id="l148.572">   be_in_folder(unreadFolder);</span>
<a href="#l148.573"></a><span id="l148.573">   let curMessage = select_click_row(0);</span>
<a href="#l148.574"></a><span id="l148.574"> </span>
<a href="#l148.575"></a><span id="l148.575">   mc.keypress(null, &quot;1&quot;, {});</span>
<a href="#l148.576"></a><span id="l148.576">   check_tag_in_message(curMessage, tagArray[0], true);</span>
<a href="#l148.577"></a><span id="l148.577"> </span>
<a href="#l148.578"></a><span id="l148.578">   mc.keypress(null, &quot;2&quot;, {});</span>
<a href="#l148.579"></a><span id="l148.579">   check_tag_in_message(curMessage, tagArray[0], true);</span>
<a href="#l148.580"></a><span id="l148.580">   check_tag_in_message(curMessage, tagArray[1], true);</span>
<a href="#l148.581"></a><span id="l148.581"> </span>
<a href="#l148.582"></a><span id="l148.582">   mc.keypress(null, &quot;0&quot;, {});</span>
<a href="#l148.583"></a><span id="l148.583">   check_tag_in_message(curMessage, tagArray[0], false);</span>
<a href="#l148.584"></a><span id="l148.584">   check_tag_in_message(curMessage, tagArray[1], false);</span>
<a href="#l148.585"></a><span id="l148.585" class="difflineminus">-}</span>
<a href="#l148.586"></a><span id="l148.586" class="difflineplus">+});</span>
<a href="#l148.587"></a><span id="l148.587"> </span>
<a href="#l148.588"></a><span id="l148.588" class="difflineminus">-function test_tag_keys_disabled_in_content_tab() {</span>
<a href="#l148.589"></a><span id="l148.589" class="difflineplus">+add_task(function test_tag_keys_disabled_in_content_tab() {</span>
<a href="#l148.590"></a><span id="l148.590">   be_in_folder(unreadFolder);</span>
<a href="#l148.591"></a><span id="l148.591">   let curMessage = select_click_row(0);</span>
<a href="#l148.592"></a><span id="l148.592"> </span>
<a href="#l148.593"></a><span id="l148.593">   mc.window.openAddonsMgr(&quot;addons://list/theme&quot;);</span>
<a href="#l148.594"></a><span id="l148.594">   mc.sleep(0);</span>
<a href="#l148.595"></a><span id="l148.595"> </span>
<a href="#l148.596"></a><span id="l148.596">   let tab = mc.tabmail.currentTabInfo;</span>
<a href="#l148.597"></a><span id="l148.597">   wait_for_content_tab_load(tab, &quot;about:addons&quot;, 15000);</span>
<a href="#l148.598"></a><span id="l148.598"> </span>
<a href="#l148.599"></a><span id="l148.599">   // Make sure pressing the &quot;1&quot; key in a content tab doesn't tag a message</span>
<a href="#l148.600"></a><span id="l148.600">   check_tag_in_message(curMessage, tagArray[0], false);</span>
<a href="#l148.601"></a><span id="l148.601">   mc.keypress(null, &quot;1&quot;, {});</span>
<a href="#l148.602"></a><span id="l148.602">   check_tag_in_message(curMessage, tagArray[0], false);</span>
<a href="#l148.603"></a><span id="l148.603"> </span>
<a href="#l148.604"></a><span id="l148.604">   mc.tabmail.closeTab(tab);</span>
<a href="#l148.605"></a><span id="l148.605" class="difflineminus">-}</span>
<a href="#l148.606"></a><span id="l148.606" class="difflineplus">+});</span>
<a href="#l148.607"></a><span id="l148.607"> </span>
<a href="#l148.608"></a><span id="l148.608" class="difflineminus">-function teardownModule() {</span>
<a href="#l148.609"></a><span id="l148.609" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l148.610"></a><span id="l148.610">   // Make sure archiving is enabled at the end</span>
<a href="#l148.611"></a><span id="l148.611">   enable_archiving(true);</span>
<a href="#l148.612"></a><span id="l148.612" class="difflineminus">-}</span>
<a href="#l148.613"></a><span id="l148.613" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l149.1"></a><span id="l149.1">copy from mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js</span>
<a href="#l149.2"></a><span id="l149.2">copy to mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js</span>
<a href="#l149.3"></a><span id="l149.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-commands-on-msgstore.js</span>
<a href="#l149.4"></a><span id="l149.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_messageCommandsOnMsgstore.js</span>
<a href="#l149.5"></a><span id="l149.5" class="difflineat">@@ -10,20 +10,16 @@</span>
<a href="#l149.6"></a><span id="l149.6">  */</span>
<a href="#l149.7"></a><span id="l149.7"> </span>
<a href="#l149.8"></a><span id="l149.8"> &quot;use strict&quot;;</span>
<a href="#l149.9"></a><span id="l149.9"> </span>
<a href="#l149.10"></a><span id="l149.10"> var { open_compose_with_forward, open_compose_with_reply } = ChromeUtils.import(</span>
<a href="#l149.11"></a><span id="l149.11">   &quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;</span>
<a href="#l149.12"></a><span id="l149.12"> );</span>
<a href="#l149.13"></a><span id="l149.13"> var {</span>
<a href="#l149.14"></a><span id="l149.14" class="difflineminus">-  assert_equals,</span>
<a href="#l149.15"></a><span id="l149.15" class="difflineminus">-  assert_false,</span>
<a href="#l149.16"></a><span id="l149.16" class="difflineminus">-  assert_not_equals,</span>
<a href="#l149.17"></a><span id="l149.17" class="difflineminus">-  assert_true,</span>
<a href="#l149.18"></a><span id="l149.18">   be_in_folder,</span>
<a href="#l149.19"></a><span id="l149.19">   create_folder,</span>
<a href="#l149.20"></a><span id="l149.20">   empty_folder,</span>
<a href="#l149.21"></a><span id="l149.21">   get_special_folder,</span>
<a href="#l149.22"></a><span id="l149.22">   make_new_sets_in_folder,</span>
<a href="#l149.23"></a><span id="l149.23">   mc,</span>
<a href="#l149.24"></a><span id="l149.24">   press_delete,</span>
<a href="#l149.25"></a><span id="l149.25">   right_click_on_row,</span>
<a href="#l149.26"></a><span id="l149.26" class="difflineat">@@ -42,55 +38,55 @@ var { MailServices } = ChromeUtils.impor</span>
<a href="#l149.27"></a><span id="l149.27"> var { IOUtils } = ChromeUtils.import(&quot;resource:///modules/IOUtils.js&quot;);</span>
<a href="#l149.28"></a><span id="l149.28"> </span>
<a href="#l149.29"></a><span id="l149.29"> var statusHeader = &quot;X-Mozilla-Status: &quot;;</span>
<a href="#l149.30"></a><span id="l149.30"> </span>
<a href="#l149.31"></a><span id="l149.31"> var gInbox;</span>
<a href="#l149.32"></a><span id="l149.32"> var gOutbox;</span>
<a href="#l149.33"></a><span id="l149.33"> var gAutoRead;</span>
<a href="#l149.34"></a><span id="l149.34"> </span>
<a href="#l149.35"></a><span id="l149.35" class="difflineminus">-function setupModule(module) {</span>
<a href="#l149.36"></a><span id="l149.36" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l149.37"></a><span id="l149.37">   gAutoRead = Services.prefs.getBoolPref(&quot;mailnews.mark_message_read.auto&quot;);</span>
<a href="#l149.38"></a><span id="l149.38">   Services.prefs.setBoolPref(&quot;mailnews.mark_message_read.auto&quot;, false);</span>
<a href="#l149.39"></a><span id="l149.39"> </span>
<a href="#l149.40"></a><span id="l149.40">   gOutbox = get_special_folder(Ci.nsMsgFolderFlags.Queue);</span>
<a href="#l149.41"></a><span id="l149.41">   gInbox = create_folder(&quot;MsgStoreChecks&quot;);</span>
<a href="#l149.42"></a><span id="l149.42">   make_new_sets_in_folder(gInbox, [{ count: 6 }]);</span>
<a href="#l149.43"></a><span id="l149.43"> </span>
<a href="#l149.44"></a><span id="l149.44">   // We delete the first message so that we have to compact anything.</span>
<a href="#l149.45"></a><span id="l149.45">   be_in_folder(gInbox);</span>
<a href="#l149.46"></a><span id="l149.46">   let curMessage = select_click_row(0);</span>
<a href="#l149.47"></a><span id="l149.47">   press_delete(mc);</span>
<a href="#l149.48"></a><span id="l149.48" class="difflineminus">-  assert_not_equals(curMessage, select_click_row(0));</span>
<a href="#l149.49"></a><span id="l149.49" class="difflineplus">+  Assert.notEqual(curMessage, select_click_row(0));</span>
<a href="#l149.50"></a><span id="l149.50"> </span>
<a href="#l149.51"></a><span id="l149.51">   let urlListener = {</span>
<a href="#l149.52"></a><span id="l149.52">     compactDone: false,</span>
<a href="#l149.53"></a><span id="l149.53"> </span>
<a href="#l149.54"></a><span id="l149.54">     OnStartRunningUrl(aUrl) {},</span>
<a href="#l149.55"></a><span id="l149.55">     OnStopRunningUrl(aUrl, aExitCode) {</span>
<a href="#l149.56"></a><span id="l149.56" class="difflineminus">-      assert_equals(aExitCode, 0);</span>
<a href="#l149.57"></a><span id="l149.57" class="difflineminus">-      assert_true(gInbox.msgDatabase.summaryValid);</span>
<a href="#l149.58"></a><span id="l149.58" class="difflineplus">+      Assert.equal(aExitCode, 0);</span>
<a href="#l149.59"></a><span id="l149.59" class="difflineplus">+      Assert.ok(gInbox.msgDatabase.summaryValid);</span>
<a href="#l149.60"></a><span id="l149.60">       this.compactDone = true;</span>
<a href="#l149.61"></a><span id="l149.61">     },</span>
<a href="#l149.62"></a><span id="l149.62">   };</span>
<a href="#l149.63"></a><span id="l149.63"> </span>
<a href="#l149.64"></a><span id="l149.64">   // Compaction adds the X-Mozilla-Status rows into the messages</span>
<a href="#l149.65"></a><span id="l149.65">   // that we will need later on.</span>
<a href="#l149.66"></a><span id="l149.66" class="difflineminus">-  assert_true(gInbox.msgStore.supportsCompaction);</span>
<a href="#l149.67"></a><span id="l149.67" class="difflineplus">+  Assert.ok(gInbox.msgStore.supportsCompaction);</span>
<a href="#l149.68"></a><span id="l149.68">   gInbox.compact(urlListener, null);</span>
<a href="#l149.69"></a><span id="l149.69"> </span>
<a href="#l149.70"></a><span id="l149.70">   mc.waitFor(</span>
<a href="#l149.71"></a><span id="l149.71">     function() {</span>
<a href="#l149.72"></a><span id="l149.72">       return urlListener.compactDone;</span>
<a href="#l149.73"></a><span id="l149.73">     },</span>
<a href="#l149.74"></a><span id="l149.74">     &quot;Timeout waiting for compact to complete&quot;,</span>
<a href="#l149.75"></a><span id="l149.75">     10000,</span>
<a href="#l149.76"></a><span id="l149.76">     100</span>
<a href="#l149.77"></a><span id="l149.77">   );</span>
<a href="#l149.78"></a><span id="l149.78" class="difflineminus">-}</span>
<a href="#l149.79"></a><span id="l149.79" class="difflineplus">+});</span>
<a href="#l149.80"></a><span id="l149.80"> </span>
<a href="#l149.81"></a><span id="l149.81"> /**</span>
<a href="#l149.82"></a><span id="l149.82">  * Checks that a message has particular status stored in the data file.</span>
<a href="#l149.83"></a><span id="l149.83">  * Either the aMsgHdr or the aOffset+aStatusOffset must be non-null.</span>
<a href="#l149.84"></a><span id="l149.84">  *</span>
<a href="#l149.85"></a><span id="l149.85">  * @param aMsgHdr        The nsIMsgDBHdr header of the message to check. Optional.</span>
<a href="#l149.86"></a><span id="l149.86">  * @param aOffset        Offset in the file where the message data starts. Optional.</span>
<a href="#l149.87"></a><span id="l149.87">  * @param aStatusOffset  Offset from the start of the message where the status line is. Optional.</span>
<a href="#l149.88"></a><span id="l149.88" class="difflineat">@@ -108,43 +104,43 @@ function check_status(aMsgHdr, aOffset, </span>
<a href="#l149.89"></a><span id="l149.89"> </span>
<a href="#l149.90"></a><span id="l149.90">   let mboxstring = IOUtils.loadFileToString(folder.filePath);</span>
<a href="#l149.91"></a><span id="l149.91"> </span>
<a href="#l149.92"></a><span id="l149.92">   let expectedStatusString = aStatus.toString(16);</span>
<a href="#l149.93"></a><span id="l149.93">   while (expectedStatusString.length &lt; 4) {</span>
<a href="#l149.94"></a><span id="l149.94">     expectedStatusString = &quot;0&quot; + expectedStatusString;</span>
<a href="#l149.95"></a><span id="l149.95">   }</span>
<a href="#l149.96"></a><span id="l149.96"> </span>
<a href="#l149.97"></a><span id="l149.97" class="difflineminus">-  assert_equals(</span>
<a href="#l149.98"></a><span id="l149.98" class="difflineplus">+  Assert.equal(</span>
<a href="#l149.99"></a><span id="l149.99">     mboxstring.substr(aOffset + aStatusOffset, statusHeader.length),</span>
<a href="#l149.100"></a><span id="l149.100">     statusHeader,</span>
<a href="#l149.101"></a><span id="l149.101">     &quot;The header '&quot; +</span>
<a href="#l149.102"></a><span id="l149.102">       statusHeader +</span>
<a href="#l149.103"></a><span id="l149.103">       &quot;' not found at offset: &quot; +</span>
<a href="#l149.104"></a><span id="l149.104">       aOffset +</span>
<a href="#l149.105"></a><span id="l149.105">       &quot;, statusOffset: &quot; +</span>
<a href="#l149.106"></a><span id="l149.106">       aStatusOffset</span>
<a href="#l149.107"></a><span id="l149.107">   );</span>
<a href="#l149.108"></a><span id="l149.108" class="difflineminus">-  assert_equals(</span>
<a href="#l149.109"></a><span id="l149.109" class="difflineplus">+  Assert.equal(</span>
<a href="#l149.110"></a><span id="l149.110">     mboxstring.substr(aOffset + aStatusOffset + statusHeader.length, 4),</span>
<a href="#l149.111"></a><span id="l149.111">     expectedStatusString</span>
<a href="#l149.112"></a><span id="l149.112">   );</span>
<a href="#l149.113"></a><span id="l149.113"> }</span>
<a href="#l149.114"></a><span id="l149.114"> </span>
<a href="#l149.115"></a><span id="l149.115" class="difflineminus">-function test_mark_messages_read() {</span>
<a href="#l149.116"></a><span id="l149.116" class="difflineplus">+add_task(function test_mark_messages_read() {</span>
<a href="#l149.117"></a><span id="l149.117">   // 5 messages in the folder</span>
<a href="#l149.118"></a><span id="l149.118">   be_in_folder(gInbox);</span>
<a href="#l149.119"></a><span id="l149.119">   let curMessage = select_click_row(0);</span>
<a href="#l149.120"></a><span id="l149.120">   // Store the values because they will be unavailable via the hdr</span>
<a href="#l149.121"></a><span id="l149.121">   // after the message is deleted.</span>
<a href="#l149.122"></a><span id="l149.122">   let offset = curMessage.messageOffset;</span>
<a href="#l149.123"></a><span id="l149.123">   let statusOffset = curMessage.statusOffset;</span>
<a href="#l149.124"></a><span id="l149.124">   check_status(curMessage, null, null, 0); // status = unread</span>
<a href="#l149.125"></a><span id="l149.125">   press_delete(mc);</span>
<a href="#l149.126"></a><span id="l149.126" class="difflineminus">-  assert_not_equals(curMessage, select_click_row(0));</span>
<a href="#l149.127"></a><span id="l149.127" class="difflineplus">+  Assert.notEqual(curMessage, select_click_row(0));</span>
<a href="#l149.128"></a><span id="l149.128">   check_status(</span>
<a href="#l149.129"></a><span id="l149.129">     null,</span>
<a href="#l149.130"></a><span id="l149.130">     offset,</span>
<a href="#l149.131"></a><span id="l149.131">     statusOffset,</span>
<a href="#l149.132"></a><span id="l149.132">     Ci.nsMsgMessageFlags.Read + Ci.nsMsgMessageFlags.Expunged</span>
<a href="#l149.133"></a><span id="l149.133">   );</span>
<a href="#l149.134"></a><span id="l149.134"> </span>
<a href="#l149.135"></a><span id="l149.135">   // 4 messages in the folder.</span>
<a href="#l149.136"></a><span id="l149.136" class="difflineat">@@ -154,54 +150,54 @@ function test_mark_messages_read() {</span>
<a href="#l149.137"></a><span id="l149.137">   // Make sure we can mark all read with &gt;0 messages unread.</span>
<a href="#l149.138"></a><span id="l149.138">   right_click_on_row(0);</span>
<a href="#l149.139"></a><span id="l149.139">   mc.click_menus_in_sequence(mc.e(&quot;mailContext&quot;), [</span>
<a href="#l149.140"></a><span id="l149.140">     { id: &quot;mailContext-mark&quot; },</span>
<a href="#l149.141"></a><span id="l149.141">     { id: &quot;mailContext-markAllRead&quot; },</span>
<a href="#l149.142"></a><span id="l149.142">   ]);</span>
<a href="#l149.143"></a><span id="l149.143"> </span>
<a href="#l149.144"></a><span id="l149.144">   // All the 4 messages should now be read.</span>
<a href="#l149.145"></a><span id="l149.145" class="difflineminus">-  assert_true(curMessage.isRead, &quot;Message should have been marked Read!&quot;);</span>
<a href="#l149.146"></a><span id="l149.146" class="difflineplus">+  Assert.ok(curMessage.isRead, &quot;Message should have been marked Read!&quot;);</span>
<a href="#l149.147"></a><span id="l149.147">   check_status(curMessage, null, null, Ci.nsMsgMessageFlags.Read);</span>
<a href="#l149.148"></a><span id="l149.148">   curMessage = select_click_row(1);</span>
<a href="#l149.149"></a><span id="l149.149" class="difflineminus">-  assert_true(curMessage.isRead, &quot;Message should have been marked Read!&quot;);</span>
<a href="#l149.150"></a><span id="l149.150" class="difflineplus">+  Assert.ok(curMessage.isRead, &quot;Message should have been marked Read!&quot;);</span>
<a href="#l149.151"></a><span id="l149.151">   check_status(curMessage, null, null, Ci.nsMsgMessageFlags.Read);</span>
<a href="#l149.152"></a><span id="l149.152">   curMessage = select_click_row(2);</span>
<a href="#l149.153"></a><span id="l149.153" class="difflineminus">-  assert_true(curMessage.isRead, &quot;Message should have been marked Read!&quot;);</span>
<a href="#l149.154"></a><span id="l149.154" class="difflineplus">+  Assert.ok(curMessage.isRead, &quot;Message should have been marked Read!&quot;);</span>
<a href="#l149.155"></a><span id="l149.155">   check_status(curMessage, null, null, Ci.nsMsgMessageFlags.Read);</span>
<a href="#l149.156"></a><span id="l149.156">   curMessage = select_click_row(3);</span>
<a href="#l149.157"></a><span id="l149.157" class="difflineminus">-  assert_true(curMessage.isRead, &quot;Message should have been marked Read!&quot;);</span>
<a href="#l149.158"></a><span id="l149.158" class="difflineplus">+  Assert.ok(curMessage.isRead, &quot;Message should have been marked Read!&quot;);</span>
<a href="#l149.159"></a><span id="l149.159">   check_status(curMessage, null, null, Ci.nsMsgMessageFlags.Read);</span>
<a href="#l149.160"></a><span id="l149.160"> </span>
<a href="#l149.161"></a><span id="l149.161">   // Let's have the last message unread.</span>
<a href="#l149.162"></a><span id="l149.162">   right_click_on_row(3);</span>
<a href="#l149.163"></a><span id="l149.163">   mc.click_menus_in_sequence(mc.e(&quot;mailContext&quot;), [</span>
<a href="#l149.164"></a><span id="l149.164">     { id: &quot;mailContext-mark&quot; },</span>
<a href="#l149.165"></a><span id="l149.165">     { id: &quot;mailContext-markUnread&quot; },</span>
<a href="#l149.166"></a><span id="l149.166">   ]);</span>
<a href="#l149.167"></a><span id="l149.167" class="difflineminus">-  assert_false(curMessage.isRead, &quot;Message should have not been marked Read!&quot;);</span>
<a href="#l149.168"></a><span id="l149.168" class="difflineplus">+  Assert.ok(!curMessage.isRead, &quot;Message should have not been marked Read!&quot;);</span>
<a href="#l149.169"></a><span id="l149.169">   check_status(curMessage, null, null, 0);</span>
<a href="#l149.170"></a><span id="l149.170" class="difflineminus">-}</span>
<a href="#l149.171"></a><span id="l149.171" class="difflineplus">+});</span>
<a href="#l149.172"></a><span id="l149.172"> </span>
<a href="#l149.173"></a><span id="l149.173" class="difflineminus">-function test_mark_messages_flagged() {</span>
<a href="#l149.174"></a><span id="l149.174" class="difflineplus">+add_task(function test_mark_messages_flagged() {</span>
<a href="#l149.175"></a><span id="l149.175">   // Mark a message with the star.</span>
<a href="#l149.176"></a><span id="l149.176">   let curMessage = select_click_row(1);</span>
<a href="#l149.177"></a><span id="l149.177">   right_click_on_row(1);</span>
<a href="#l149.178"></a><span id="l149.178">   mc.click_menus_in_sequence(mc.e(&quot;mailContext&quot;), [</span>
<a href="#l149.179"></a><span id="l149.179">     { id: &quot;mailContext-mark&quot; },</span>
<a href="#l149.180"></a><span id="l149.180">     { id: &quot;mailContext-markFlagged&quot; },</span>
<a href="#l149.181"></a><span id="l149.181">   ]);</span>
<a href="#l149.182"></a><span id="l149.182" class="difflineminus">-  assert_true(curMessage.isFlagged, &quot;Message should have been marked Flagged!&quot;);</span>
<a href="#l149.183"></a><span id="l149.183" class="difflineplus">+  Assert.ok(curMessage.isFlagged, &quot;Message should have been marked Flagged!&quot;);</span>
<a href="#l149.184"></a><span id="l149.184">   check_status(</span>
<a href="#l149.185"></a><span id="l149.185">     curMessage,</span>
<a href="#l149.186"></a><span id="l149.186">     null,</span>
<a href="#l149.187"></a><span id="l149.187">     null,</span>
<a href="#l149.188"></a><span id="l149.188">     Ci.nsMsgMessageFlags.Read + Ci.nsMsgMessageFlags.Marked</span>
<a href="#l149.189"></a><span id="l149.189">   );</span>
<a href="#l149.190"></a><span id="l149.190" class="difflineminus">-}</span>
<a href="#l149.191"></a><span id="l149.191" class="difflineplus">+});</span>
<a href="#l149.192"></a><span id="l149.192"> </span>
<a href="#l149.193"></a><span id="l149.193"> function subtest_check_queued_message() {</span>
<a href="#l149.194"></a><span id="l149.194">   // Always check the last message in the Outbox for the correct flag.</span>
<a href="#l149.195"></a><span id="l149.195">   be_in_folder(gOutbox);</span>
<a href="#l149.196"></a><span id="l149.196">   let queued = gOutbox.messages;</span>
<a href="#l149.197"></a><span id="l149.197">   while (queued.hasMoreElements()) {</span>
<a href="#l149.198"></a><span id="l149.198">     let msg = queued.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l149.199"></a><span id="l149.199">     if (!queued.hasMoreElements()) {</span>
<a href="#l149.200"></a><span id="l149.200" class="difflineat">@@ -250,28 +246,28 @@ function reply_forward_message(aMsgRow, </span>
<a href="#l149.201"></a><span id="l149.201">   be_in_folder(gInbox);</span>
<a href="#l149.202"></a><span id="l149.202">   let curMessage = select_click_row(aMsgRow);</span>
<a href="#l149.203"></a><span id="l149.203">   let disposition = aReply</span>
<a href="#l149.204"></a><span id="l149.204">     ? gInbox.nsMsgDispositionState_Replied</span>
<a href="#l149.205"></a><span id="l149.205">     : gInbox.nsMsgDispositionState_Forwarded;</span>
<a href="#l149.206"></a><span id="l149.206">   gInbox.addMessageDispositionState(curMessage, disposition);</span>
<a href="#l149.207"></a><span id="l149.207"> }</span>
<a href="#l149.208"></a><span id="l149.208"> </span>
<a href="#l149.209"></a><span id="l149.209" class="difflineminus">-function test_mark_messages_replied() {</span>
<a href="#l149.210"></a><span id="l149.210" class="difflineplus">+add_task(function test_mark_messages_replied() {</span>
<a href="#l149.211"></a><span id="l149.211">   reply_forward_message(2, true);</span>
<a href="#l149.212"></a><span id="l149.212">   let curMessage = select_click_row(2);</span>
<a href="#l149.213"></a><span id="l149.213">   check_status(</span>
<a href="#l149.214"></a><span id="l149.214">     curMessage,</span>
<a href="#l149.215"></a><span id="l149.215">     null,</span>
<a href="#l149.216"></a><span id="l149.216">     null,</span>
<a href="#l149.217"></a><span id="l149.217">     Ci.nsMsgMessageFlags.Replied + Ci.nsMsgMessageFlags.Read</span>
<a href="#l149.218"></a><span id="l149.218">   );</span>
<a href="#l149.219"></a><span id="l149.219" class="difflineminus">-}</span>
<a href="#l149.220"></a><span id="l149.220" class="difflineplus">+});</span>
<a href="#l149.221"></a><span id="l149.221"> </span>
<a href="#l149.222"></a><span id="l149.222" class="difflineminus">-function test_mark_messages_forwarded() {</span>
<a href="#l149.223"></a><span id="l149.223" class="difflineplus">+add_task(function test_mark_messages_forwarded() {</span>
<a href="#l149.224"></a><span id="l149.224">   be_in_folder(gInbox);</span>
<a href="#l149.225"></a><span id="l149.225">   // Forward a clean message.</span>
<a href="#l149.226"></a><span id="l149.226">   reply_forward_message(3, false);</span>
<a href="#l149.227"></a><span id="l149.227">   let curMessage = select_click_row(3);</span>
<a href="#l149.228"></a><span id="l149.228">   check_status(curMessage, null, null, Ci.nsMsgMessageFlags.Forwarded);</span>
<a href="#l149.229"></a><span id="l149.229"> </span>
<a href="#l149.230"></a><span id="l149.230">   // Forward a message that is read and already replied to.</span>
<a href="#l149.231"></a><span id="l149.231">   reply_forward_message(2, false);</span>
<a href="#l149.232"></a><span id="l149.232" class="difflineat">@@ -279,18 +275,18 @@ function test_mark_messages_forwarded() </span>
<a href="#l149.233"></a><span id="l149.233">   check_status(</span>
<a href="#l149.234"></a><span id="l149.234">     curMessage,</span>
<a href="#l149.235"></a><span id="l149.235">     null,</span>
<a href="#l149.236"></a><span id="l149.236">     null,</span>
<a href="#l149.237"></a><span id="l149.237">     Ci.nsMsgMessageFlags.Forwarded +</span>
<a href="#l149.238"></a><span id="l149.238">       Ci.nsMsgMessageFlags.Replied +</span>
<a href="#l149.239"></a><span id="l149.239">       Ci.nsMsgMessageFlags.Read</span>
<a href="#l149.240"></a><span id="l149.240">   );</span>
<a href="#l149.241"></a><span id="l149.241" class="difflineminus">-}</span>
<a href="#l149.242"></a><span id="l149.242" class="difflineplus">+});</span>
<a href="#l149.243"></a><span id="l149.243"> </span>
<a href="#l149.244"></a><span id="l149.244" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l149.245"></a><span id="l149.245" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l149.246"></a><span id="l149.246">   Services.prefs.setBoolPref(&quot;mailnews.mark_message_read.auto&quot;, gAutoRead);</span>
<a href="#l149.247"></a><span id="l149.247">   // Clear all the created messages.</span>
<a href="#l149.248"></a><span id="l149.248">   be_in_folder(gInbox.parent);</span>
<a href="#l149.249"></a><span id="l149.249">   empty_folder(gInbox);</span>
<a href="#l149.250"></a><span id="l149.250">   empty_folder(gOutbox);</span>
<a href="#l149.251"></a><span id="l149.251">   gInbox.server.rootFolder.emptyTrash(null, null);</span>
<a href="#l149.252"></a><span id="l149.252" class="difflineminus">-}</span>
<a href="#l149.253"></a><span id="l149.253" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l150.1"></a><span id="l150.1">copy from mail/test/mozmill/folder-display/test-message-pane-visibility.js</span>
<a href="#l150.2"></a><span id="l150.2">copy to mail/test/browser/folder-display/browser_messagePaneVisibility.js</span>
<a href="#l150.3"></a><span id="l150.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-pane-visibility.js</span>
<a href="#l150.4"></a><span id="l150.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_messagePaneVisibility.js</span>
<a href="#l150.5"></a><span id="l150.5" class="difflineat">@@ -23,62 +23,62 @@ var {</span>
<a href="#l150.6"></a><span id="l150.6">   switch_tab,</span>
<a href="#l150.7"></a><span id="l150.7">   toggle_message_pane,</span>
<a href="#l150.8"></a><span id="l150.8"> } = ChromeUtils.import(</span>
<a href="#l150.9"></a><span id="l150.9">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l150.10"></a><span id="l150.10"> );</span>
<a href="#l150.11"></a><span id="l150.11"> </span>
<a href="#l150.12"></a><span id="l150.12"> var folder;</span>
<a href="#l150.13"></a><span id="l150.13"> </span>
<a href="#l150.14"></a><span id="l150.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l150.15"></a><span id="l150.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l150.16"></a><span id="l150.16">   folder = create_folder(&quot;MessagePaneVisibility&quot;);</span>
<a href="#l150.17"></a><span id="l150.17">   make_new_sets_in_folder(folder, [{ count: 3 }]);</span>
<a href="#l150.18"></a><span id="l150.18" class="difflineminus">-}</span>
<a href="#l150.19"></a><span id="l150.19" class="difflineplus">+});</span>
<a href="#l150.20"></a><span id="l150.20"> </span>
<a href="#l150.21"></a><span id="l150.21"> /**</span>
<a href="#l150.22"></a><span id="l150.22">  * By default, the message pane should be visible.  Make sure that this state of</span>
<a href="#l150.23"></a><span id="l150.23">  *  affairs is correct in terms of menu options, splitters, etc.</span>
<a href="#l150.24"></a><span id="l150.24">  */</span>
<a href="#l150.25"></a><span id="l150.25" class="difflineminus">-function test_message_pane_visible_state_is_right() {</span>
<a href="#l150.26"></a><span id="l150.26" class="difflineplus">+add_task(function test_message_pane_visible_state_is_right() {</span>
<a href="#l150.27"></a><span id="l150.27">   be_in_folder(folder);</span>
<a href="#l150.28"></a><span id="l150.28">   assert_message_pane_visible();</span>
<a href="#l150.29"></a><span id="l150.29" class="difflineminus">-}</span>
<a href="#l150.30"></a><span id="l150.30" class="difflineplus">+});</span>
<a href="#l150.31"></a><span id="l150.31"> </span>
<a href="#l150.32"></a><span id="l150.32"> /**</span>
<a href="#l150.33"></a><span id="l150.33">  * Make sure the account central page does not have the message pane splitter</span>
<a href="#l150.34"></a><span id="l150.34">  *  visible.  This should go elsewhere once we have more tests involving</span>
<a href="#l150.35"></a><span id="l150.35">  *  account central.  (Layout tests?)</span>
<a href="#l150.36"></a><span id="l150.36">  */</span>
<a href="#l150.37"></a><span id="l150.37" class="difflineminus">-function test_account_central_has_no_splitter() {</span>
<a href="#l150.38"></a><span id="l150.38" class="difflineplus">+add_task(function test_account_central_has_no_splitter() {</span>
<a href="#l150.39"></a><span id="l150.39">   be_in_folder(folder.rootFolder);</span>
<a href="#l150.40"></a><span id="l150.40">   assert_message_pane_hidden(true);</span>
<a href="#l150.41"></a><span id="l150.41">   be_in_folder(folder);</span>
<a href="#l150.42"></a><span id="l150.42" class="difflineminus">-}</span>
<a href="#l150.43"></a><span id="l150.43" class="difflineplus">+});</span>
<a href="#l150.44"></a><span id="l150.44"> </span>
<a href="#l150.45"></a><span id="l150.45"> /**</span>
<a href="#l150.46"></a><span id="l150.46">  * Toggle the message off.</span>
<a href="#l150.47"></a><span id="l150.47">  */</span>
<a href="#l150.48"></a><span id="l150.48" class="difflineminus">-function test_toggle_message_pane_off() {</span>
<a href="#l150.49"></a><span id="l150.49" class="difflineplus">+add_task(function test_toggle_message_pane_off() {</span>
<a href="#l150.50"></a><span id="l150.50">   toggle_message_pane();</span>
<a href="#l150.51"></a><span id="l150.51">   assert_message_pane_hidden();</span>
<a href="#l150.52"></a><span id="l150.52" class="difflineminus">-}</span>
<a href="#l150.53"></a><span id="l150.53" class="difflineplus">+});</span>
<a href="#l150.54"></a><span id="l150.54"> </span>
<a href="#l150.55"></a><span id="l150.55"> /**</span>
<a href="#l150.56"></a><span id="l150.56">  * Toggle the message pane on.</span>
<a href="#l150.57"></a><span id="l150.57">  */</span>
<a href="#l150.58"></a><span id="l150.58" class="difflineminus">-function test_toggle_message_pane_on() {</span>
<a href="#l150.59"></a><span id="l150.59" class="difflineplus">+add_task(function test_toggle_message_pane_on() {</span>
<a href="#l150.60"></a><span id="l150.60">   toggle_message_pane();</span>
<a href="#l150.61"></a><span id="l150.61">   assert_message_pane_visible();</span>
<a href="#l150.62"></a><span id="l150.62" class="difflineminus">-}</span>
<a href="#l150.63"></a><span id="l150.63" class="difflineplus">+});</span>
<a href="#l150.64"></a><span id="l150.64"> </span>
<a href="#l150.65"></a><span id="l150.65"> /**</span>
<a href="#l150.66"></a><span id="l150.66">  * Make sure that the message tab isn't broken by being invoked from a folder tab</span>
<a href="#l150.67"></a><span id="l150.67">  *  with a collapsed message pane.</span>
<a href="#l150.68"></a><span id="l150.68">  */</span>
<a href="#l150.69"></a><span id="l150.69" class="difflineminus">-function test_collapsed_message_pane_does_not_break_message_tab() {</span>
<a href="#l150.70"></a><span id="l150.70" class="difflineplus">+add_task(function test_collapsed_message_pane_does_not_break_message_tab() {</span>
<a href="#l150.71"></a><span id="l150.71">   be_in_folder(folder);</span>
<a href="#l150.72"></a><span id="l150.72"> </span>
<a href="#l150.73"></a><span id="l150.73">   // - toggle message pane off</span>
<a href="#l150.74"></a><span id="l150.74">   toggle_message_pane();</span>
<a href="#l150.75"></a><span id="l150.75">   assert_message_pane_hidden();</span>
<a href="#l150.76"></a><span id="l150.76"> </span>
<a href="#l150.77"></a><span id="l150.77">   // - open message tab, make sure the message pane is visible</span>
<a href="#l150.78"></a><span id="l150.78">   select_click_row(0);</span>
<a href="#l150.79"></a><span id="l150.79" class="difflineat">@@ -86,24 +86,24 @@ function test_collapsed_message_pane_doe</span>
<a href="#l150.80"></a><span id="l150.80">   assert_message_pane_visible(true);</span>
<a href="#l150.81"></a><span id="l150.81"> </span>
<a href="#l150.82"></a><span id="l150.82">   // - close the tab, sanity check the transition was okay</span>
<a href="#l150.83"></a><span id="l150.83">   close_tab(tabMessage);</span>
<a href="#l150.84"></a><span id="l150.84">   assert_message_pane_hidden();</span>
<a href="#l150.85"></a><span id="l150.85"> </span>
<a href="#l150.86"></a><span id="l150.86">   // - restore the state...</span>
<a href="#l150.87"></a><span id="l150.87">   toggle_message_pane();</span>
<a href="#l150.88"></a><span id="l150.88" class="difflineminus">-}</span>
<a href="#l150.89"></a><span id="l150.89" class="difflineplus">+});</span>
<a href="#l150.90"></a><span id="l150.90"> </span>
<a href="#l150.91"></a><span id="l150.91"> /**</span>
<a href="#l150.92"></a><span id="l150.92">  * Make sure that switching to message tabs or folder pane tabs with a different</span>
<a href="#l150.93"></a><span id="l150.93">  *  message pane state does not break.  This test should cover all transition</span>
<a href="#l150.94"></a><span id="l150.94">  *  states.</span>
<a href="#l150.95"></a><span id="l150.95">  */</span>
<a href="#l150.96"></a><span id="l150.96" class="difflineminus">-function test_message_pane_is_sticky() {</span>
<a href="#l150.97"></a><span id="l150.97" class="difflineplus">+add_task(function test_message_pane_is_sticky() {</span>
<a href="#l150.98"></a><span id="l150.98">   let tabFolderA = be_in_folder(folder);</span>
<a href="#l150.99"></a><span id="l150.99">   assert_message_pane_visible();</span>
<a href="#l150.100"></a><span id="l150.100"> </span>
<a href="#l150.101"></a><span id="l150.101">   // [folder+ =&gt; (new) message]</span>
<a href="#l150.102"></a><span id="l150.102">   select_click_row(0);</span>
<a href="#l150.103"></a><span id="l150.103">   let tabMessage = open_selected_message_in_new_tab();</span>
<a href="#l150.104"></a><span id="l150.104">   assert_message_pane_visible(true);</span>
<a href="#l150.105"></a><span id="l150.105"> </span>
<a href="#l150.106"></a><span id="l150.106" class="difflineat">@@ -152,26 +152,26 @@ function test_message_pane_is_sticky() {</span>
<a href="#l150.107"></a><span id="l150.107"> </span>
<a href="#l150.108"></a><span id="l150.108">   // [folder+ =&gt; folder-]</span>
<a href="#l150.109"></a><span id="l150.109">   close_tab(tabFolderB);</span>
<a href="#l150.110"></a><span id="l150.110">   assert_message_pane_hidden();</span>
<a href="#l150.111"></a><span id="l150.111"> </span>
<a href="#l150.112"></a><span id="l150.112">   // (redundant) [ folder pane toggle - =&gt; + ]</span>
<a href="#l150.113"></a><span id="l150.113">   toggle_message_pane();</span>
<a href="#l150.114"></a><span id="l150.114">   assert_message_pane_visible();</span>
<a href="#l150.115"></a><span id="l150.115" class="difflineminus">-}</span>
<a href="#l150.116"></a><span id="l150.116" class="difflineplus">+});</span>
<a href="#l150.117"></a><span id="l150.117"> </span>
<a href="#l150.118"></a><span id="l150.118"> /**</span>
<a href="#l150.119"></a><span id="l150.119">  * Test that if we serialize and restore the tabs that the message pane is in</span>
<a href="#l150.120"></a><span id="l150.120">  *  the expected collapsed/non-collapsed state.  Because of the special &quot;first</span>
<a href="#l150.121"></a><span id="l150.121">  *  tab&quot; situation, we need to do this twice to test each case for the first</span>
<a href="#l150.122"></a><span id="l150.122">  *  tab.  For additional thoroughness we also flip the state we have the other</span>
<a href="#l150.123"></a><span id="l150.123">  *  tabs be in.</span>
<a href="#l150.124"></a><span id="l150.124">  */</span>
<a href="#l150.125"></a><span id="l150.125" class="difflineminus">-function test_message_pane_persistence_generally_works() {</span>
<a href="#l150.126"></a><span id="l150.126" class="difflineplus">+add_task(function test_message_pane_persistence_generally_works() {</span>
<a href="#l150.127"></a><span id="l150.127">   be_in_folder(folder);</span>
<a href="#l150.128"></a><span id="l150.128"> </span>
<a href="#l150.129"></a><span id="l150.129">   // helper to open tabs with the message pane in the desired states (1 for</span>
<a href="#l150.130"></a><span id="l150.130">   //  visible, 0 for hidden)</span>
<a href="#l150.131"></a><span id="l150.131">   function openTabs(aConfig) {</span>
<a href="#l150.132"></a><span id="l150.132">     let curState;</span>
<a href="#l150.133"></a><span id="l150.133">     for (let [iTab, messagePaneVisible] of aConfig.entries()) {</span>
<a href="#l150.134"></a><span id="l150.134">       if (iTab == 0) {</span>
<a href="#l150.135"></a><span id="l150.135" class="difflineat">@@ -222,17 +222,19 @@ function test_message_pane_persistence_g</span>
<a href="#l150.136"></a><span id="l150.136">     // XXX This should probably be fixed properly, though.</span>
<a href="#l150.137"></a><span id="l150.137">     switch_tab(0);</span>
<a href="#l150.138"></a><span id="l150.138"> </span>
<a href="#l150.139"></a><span id="l150.139">     let state = mc.tabmail.persistTabs();</span>
<a href="#l150.140"></a><span id="l150.140">     closeTabs();</span>
<a href="#l150.141"></a><span id="l150.141">     // toggle the state for the current tab so we can be sure that it knows how</span>
<a href="#l150.142"></a><span id="l150.142">     //  to change things.</span>
<a href="#l150.143"></a><span id="l150.143">     toggle_message_pane();</span>
<a href="#l150.144"></a><span id="l150.144" class="difflineplus">+    SimpleTest.ignoreAllUncaughtExceptions(true);</span>
<a href="#l150.145"></a><span id="l150.145">     mc.tabmail.restoreTabs(state);</span>
<a href="#l150.146"></a><span id="l150.146">     verifyTabs(config);</span>
<a href="#l150.147"></a><span id="l150.147" class="difflineplus">+    SimpleTest.ignoreAllUncaughtExceptions(false);</span>
<a href="#l150.148"></a><span id="l150.148">     closeTabs();</span>
<a href="#l150.149"></a><span id="l150.149"> </span>
<a href="#l150.150"></a><span id="l150.150">     // toggle the first tab again.  This sets - properly for the second pass and</span>
<a href="#l150.151"></a><span id="l150.151">     //  restores it to + for when we are done.</span>
<a href="#l150.152"></a><span id="l150.152">     toggle_message_pane();</span>
<a href="#l150.153"></a><span id="l150.153">   }</span>
<a href="#l150.154"></a><span id="l150.154" class="difflineminus">-}</span>
<a href="#l150.155"></a><span id="l150.155" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l151.1"></a><span id="l151.1">copy from mail/test/mozmill/folder-display/test-message-reloads.js</span>
<a href="#l151.2"></a><span id="l151.2">copy to mail/test/browser/folder-display/browser_messageReloads.js</span>
<a href="#l151.3"></a><span id="l151.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-reloads.js</span>
<a href="#l151.4"></a><span id="l151.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_messageReloads.js</span>
<a href="#l151.5"></a><span id="l151.5" class="difflineat">@@ -22,22 +22,22 @@ var {</span>
<a href="#l151.6"></a><span id="l151.6">   switch_tab,</span>
<a href="#l151.7"></a><span id="l151.7">   toggle_message_pane,</span>
<a href="#l151.8"></a><span id="l151.8"> } = ChromeUtils.import(</span>
<a href="#l151.9"></a><span id="l151.9">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l151.10"></a><span id="l151.10"> );</span>
<a href="#l151.11"></a><span id="l151.11"> </span>
<a href="#l151.12"></a><span id="l151.12"> var folder;</span>
<a href="#l151.13"></a><span id="l151.13"> </span>
<a href="#l151.14"></a><span id="l151.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l151.15"></a><span id="l151.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l151.16"></a><span id="l151.16">   folder = create_folder(&quot;MessageReloads&quot;);</span>
<a href="#l151.17"></a><span id="l151.17">   make_new_sets_in_folder(folder, [{ count: 1 }]);</span>
<a href="#l151.18"></a><span id="l151.18" class="difflineminus">-}</span>
<a href="#l151.19"></a><span id="l151.19" class="difflineplus">+});</span>
<a href="#l151.20"></a><span id="l151.20"> </span>
<a href="#l151.21"></a><span id="l151.21" class="difflineminus">-function test_message_reloads_work_with_message_pane_toggles() {</span>
<a href="#l151.22"></a><span id="l151.22" class="difflineplus">+add_task(function test_message_reloads_work_with_message_pane_toggles() {</span>
<a href="#l151.23"></a><span id="l151.23">   be_in_folder(folder);</span>
<a href="#l151.24"></a><span id="l151.24"> </span>
<a href="#l151.25"></a><span id="l151.25">   assert_message_pane_visible();</span>
<a href="#l151.26"></a><span id="l151.26">   select_click_row(0);</span>
<a href="#l151.27"></a><span id="l151.27">   // Toggle the message pane off, then on</span>
<a href="#l151.28"></a><span id="l151.28">   toggle_message_pane();</span>
<a href="#l151.29"></a><span id="l151.29">   assert_message_pane_hidden();</span>
<a href="#l151.30"></a><span id="l151.30">   toggle_message_pane();</span>
<a href="#l151.31"></a><span id="l151.31" class="difflineat">@@ -49,9 +49,16 @@ function test_message_reloads_work_with_</span>
<a href="#l151.32"></a><span id="l151.32">   toggle_message_pane();</span>
<a href="#l151.33"></a><span id="l151.33">   assert_message_pane_hidden();</span>
<a href="#l151.34"></a><span id="l151.34">   // Go back to the first tab, and make sure the message is actually displayed</span>
<a href="#l151.35"></a><span id="l151.35">   switch_tab(0);</span>
<a href="#l151.36"></a><span id="l151.36">   assert_message_pane_visible();</span>
<a href="#l151.37"></a><span id="l151.37">   assert_selected_and_displayed(0);</span>
<a href="#l151.38"></a><span id="l151.38"> </span>
<a href="#l151.39"></a><span id="l151.39">   close_tab(tab);</span>
<a href="#l151.40"></a><span id="l151.40" class="difflineminus">-}</span>
<a href="#l151.41"></a><span id="l151.41" class="difflineplus">+</span>
<a href="#l151.42"></a><span id="l151.42" class="difflineplus">+  Assert.report(</span>
<a href="#l151.43"></a><span id="l151.43" class="difflineplus">+    false,</span>
<a href="#l151.44"></a><span id="l151.44" class="difflineplus">+    undefined,</span>
<a href="#l151.45"></a><span id="l151.45" class="difflineplus">+    undefined,</span>
<a href="#l151.46"></a><span id="l151.46" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l151.47"></a><span id="l151.47" class="difflineplus">+  );</span>
<a href="#l151.48"></a><span id="l151.48" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l152.1"></a><span id="l152.1">copy from mail/test/mozmill/folder-display/test-message-size.js</span>
<a href="#l152.2"></a><span id="l152.2">copy to mail/test/browser/folder-display/browser_messageSize.js</span>
<a href="#l152.3"></a><span id="l152.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-size.js</span>
<a href="#l152.4"></a><span id="l152.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_messageSize.js</span>
<a href="#l152.5"></a><span id="l152.5" class="difflineat">@@ -18,32 +18,32 @@ var {</span>
<a href="#l152.6"></a><span id="l152.6">   mc,</span>
<a href="#l152.7"></a><span id="l152.7">   select_click_row,</span>
<a href="#l152.8"></a><span id="l152.8"> } = ChromeUtils.import(</span>
<a href="#l152.9"></a><span id="l152.9">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l152.10"></a><span id="l152.10"> );</span>
<a href="#l152.11"></a><span id="l152.11"> </span>
<a href="#l152.12"></a><span id="l152.12"> var folder;</span>
<a href="#l152.13"></a><span id="l152.13"> </span>
<a href="#l152.14"></a><span id="l152.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l152.15"></a><span id="l152.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l152.16"></a><span id="l152.16">   folder = create_folder(&quot;MessageSizeA&quot;);</span>
<a href="#l152.17"></a><span id="l152.17"> </span>
<a href="#l152.18"></a><span id="l152.18">   // Create messages with sizes in the byte, KB, and MB ranges.</span>
<a href="#l152.19"></a><span id="l152.19">   let bytemsg = create_message({ body: { body: &quot; &quot; } });</span>
<a href="#l152.20"></a><span id="l152.20"> </span>
<a href="#l152.21"></a><span id="l152.21">   let kbstring = &quot;x &quot;.repeat(1024 / 2);</span>
<a href="#l152.22"></a><span id="l152.22">   let kbmsg = create_message({ body: { body: kbstring } });</span>
<a href="#l152.23"></a><span id="l152.23"> </span>
<a href="#l152.24"></a><span id="l152.24">   let mbstring = kbstring.repeat(1024);</span>
<a href="#l152.25"></a><span id="l152.25">   let mbmsg = create_message({ body: { body: mbstring } });</span>
<a href="#l152.26"></a><span id="l152.26"> </span>
<a href="#l152.27"></a><span id="l152.27">   add_message_to_folder(folder, bytemsg);</span>
<a href="#l152.28"></a><span id="l152.28">   add_message_to_folder(folder, kbmsg);</span>
<a href="#l152.29"></a><span id="l152.29">   add_message_to_folder(folder, mbmsg);</span>
<a href="#l152.30"></a><span id="l152.30" class="difflineminus">-}</span>
<a href="#l152.31"></a><span id="l152.31" class="difflineplus">+});</span>
<a href="#l152.32"></a><span id="l152.32"> </span>
<a href="#l152.33"></a><span id="l152.33"> function _help_test_message_size(index, unit) {</span>
<a href="#l152.34"></a><span id="l152.34">   be_in_folder(folder);</span>
<a href="#l152.35"></a><span id="l152.35"> </span>
<a href="#l152.36"></a><span id="l152.36">   // Select the nth message</span>
<a href="#l152.37"></a><span id="l152.37">   let curMessage = select_click_row(index);</span>
<a href="#l152.38"></a><span id="l152.38">   // Look at the size column's data</span>
<a href="#l152.39"></a><span id="l152.39">   let tree = mc.folderDisplay.tree;</span>
<a href="#l152.40"></a><span id="l152.40" class="difflineat">@@ -57,19 +57,26 @@ function _help_test_message_size(index, </span>
<a href="#l152.41"></a><span id="l152.41">   if (isNaN(abbrSize)) {</span>
<a href="#l152.42"></a><span id="l152.42">     throw new Error(&quot;formatted size is not numeric: '&quot; + sizeStr + &quot;'&quot;);</span>
<a href="#l152.43"></a><span id="l152.43">   }</span>
<a href="#l152.44"></a><span id="l152.44">   if (Math.abs(realSize / Math.pow(1024, unit) - abbrSize) &gt; 0.5) {</span>
<a href="#l152.45"></a><span id="l152.45">     throw new Error(&quot;size mismatch: '&quot; + realSize + &quot;' and '&quot; + sizeStr + &quot;'&quot;);</span>
<a href="#l152.46"></a><span id="l152.46">   }</span>
<a href="#l152.47"></a><span id="l152.47"> }</span>
<a href="#l152.48"></a><span id="l152.48"> </span>
<a href="#l152.49"></a><span id="l152.49" class="difflineminus">-function test_byte_message_size() {</span>
<a href="#l152.50"></a><span id="l152.50" class="difflineplus">+add_task(function test_byte_message_size() {</span>
<a href="#l152.51"></a><span id="l152.51">   _help_test_message_size(0, 1);</span>
<a href="#l152.52"></a><span id="l152.52" class="difflineminus">-}</span>
<a href="#l152.53"></a><span id="l152.53" class="difflineplus">+});</span>
<a href="#l152.54"></a><span id="l152.54"> </span>
<a href="#l152.55"></a><span id="l152.55" class="difflineminus">-function test_kb_message_size() {</span>
<a href="#l152.56"></a><span id="l152.56" class="difflineplus">+add_task(function test_kb_message_size() {</span>
<a href="#l152.57"></a><span id="l152.57">   _help_test_message_size(1, 1);</span>
<a href="#l152.58"></a><span id="l152.58" class="difflineminus">-}</span>
<a href="#l152.59"></a><span id="l152.59" class="difflineplus">+});</span>
<a href="#l152.60"></a><span id="l152.60" class="difflineplus">+</span>
<a href="#l152.61"></a><span id="l152.61" class="difflineplus">+add_task(function test_mb_message_size() {</span>
<a href="#l152.62"></a><span id="l152.62" class="difflineplus">+  _help_test_message_size(2, 2);</span>
<a href="#l152.63"></a><span id="l152.63"> </span>
<a href="#l152.64"></a><span id="l152.64" class="difflineminus">-function test_mb_message_size() {</span>
<a href="#l152.65"></a><span id="l152.65" class="difflineminus">-  _help_test_message_size(2, 2);</span>
<a href="#l152.66"></a><span id="l152.66" class="difflineminus">-}</span>
<a href="#l152.67"></a><span id="l152.67" class="difflineplus">+  Assert.report(</span>
<a href="#l152.68"></a><span id="l152.68" class="difflineplus">+    false,</span>
<a href="#l152.69"></a><span id="l152.69" class="difflineplus">+    undefined,</span>
<a href="#l152.70"></a><span id="l152.70" class="difflineplus">+    undefined,</span>
<a href="#l152.71"></a><span id="l152.71" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l152.72"></a><span id="l152.72" class="difflineplus">+  );</span>
<a href="#l152.73"></a><span id="l152.73" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l153.1"></a><span id="l153.1">copy from mail/test/mozmill/folder-display/test-message-window.js</span>
<a href="#l153.2"></a><span id="l153.2">copy to mail/test/browser/folder-display/browser_messageWindow.js</span>
<a href="#l153.3"></a><span id="l153.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-message-window.js</span>
<a href="#l153.4"></a><span id="l153.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_messageWindow.js</span>
<a href="#l153.5"></a><span id="l153.5" class="difflineat">@@ -7,17 +7,16 @@</span>
<a href="#l153.6"></a><span id="l153.6">  *  folder pane.</span>
<a href="#l153.7"></a><span id="l153.7">  */</span>
<a href="#l153.8"></a><span id="l153.8"> </span>
<a href="#l153.9"></a><span id="l153.9"> &quot;use strict&quot;;</span>
<a href="#l153.10"></a><span id="l153.10"> </span>
<a href="#l153.11"></a><span id="l153.11"> var {</span>
<a href="#l153.12"></a><span id="l153.12">   add_sets_to_folders,</span>
<a href="#l153.13"></a><span id="l153.13">   assert_selected_and_displayed,</span>
<a href="#l153.14"></a><span id="l153.14" class="difflineminus">-  assert_true,</span>
<a href="#l153.15"></a><span id="l153.15">   be_in_folder,</span>
<a href="#l153.16"></a><span id="l153.16">   create_folder,</span>
<a href="#l153.17"></a><span id="l153.17">   create_thread,</span>
<a href="#l153.18"></a><span id="l153.18">   open_selected_message_in_new_window,</span>
<a href="#l153.19"></a><span id="l153.19">   plan_for_message_display,</span>
<a href="#l153.20"></a><span id="l153.20">   press_delete,</span>
<a href="#l153.21"></a><span id="l153.21">   select_click_row,</span>
<a href="#l153.22"></a><span id="l153.22">   wait_for_message_display_completion,</span>
<a href="#l153.23"></a><span id="l153.23" class="difflineat">@@ -29,104 +28,104 @@ var {</span>
<a href="#l153.24"></a><span id="l153.24">   plan_for_window_close,</span>
<a href="#l153.25"></a><span id="l153.25">   wait_for_modal_dialog,</span>
<a href="#l153.26"></a><span id="l153.26">   wait_for_window_close,</span>
<a href="#l153.27"></a><span id="l153.27"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;);</span>
<a href="#l153.28"></a><span id="l153.28"> </span>
<a href="#l153.29"></a><span id="l153.29"> var folderA, folderB;</span>
<a href="#l153.30"></a><span id="l153.30"> var curMessage;</span>
<a href="#l153.31"></a><span id="l153.31"> </span>
<a href="#l153.32"></a><span id="l153.32" class="difflineminus">-function setupModule(module) {</span>
<a href="#l153.33"></a><span id="l153.33" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l153.34"></a><span id="l153.34">   folderA = create_folder(&quot;MessageWindowA&quot;);</span>
<a href="#l153.35"></a><span id="l153.35">   folderB = create_folder(&quot;MessageWindowB&quot;);</span>
<a href="#l153.36"></a><span id="l153.36">   // create three messages in the folder to display</span>
<a href="#l153.37"></a><span id="l153.37">   let msg1 = create_thread(1);</span>
<a href="#l153.38"></a><span id="l153.38">   let msg2 = create_thread(1);</span>
<a href="#l153.39"></a><span id="l153.39">   let thread1 = create_thread(2);</span>
<a href="#l153.40"></a><span id="l153.40">   let thread2 = create_thread(2);</span>
<a href="#l153.41"></a><span id="l153.41">   add_sets_to_folders([folderA], [msg1, msg2, thread1, thread2]);</span>
<a href="#l153.42"></a><span id="l153.42">   // add two more messages in another folder</span>
<a href="#l153.43"></a><span id="l153.43">   let msg3 = create_thread(1);</span>
<a href="#l153.44"></a><span id="l153.44">   let msg4 = create_thread(1);</span>
<a href="#l153.45"></a><span id="l153.45">   add_sets_to_folders([folderB], [msg3, msg4]);</span>
<a href="#l153.46"></a><span id="l153.46">   folderA.msgDatabase.dBFolderInfo.viewFlags =</span>
<a href="#l153.47"></a><span id="l153.47">     Ci.nsMsgViewFlagsType.kThreadedDisplay;</span>
<a href="#l153.48"></a><span id="l153.48" class="difflineminus">-}</span>
<a href="#l153.49"></a><span id="l153.49" class="difflineplus">+});</span>
<a href="#l153.50"></a><span id="l153.50"> </span>
<a href="#l153.51"></a><span id="l153.51"> /** The message window controller. */</span>
<a href="#l153.52"></a><span id="l153.52"> var msgc;</span>
<a href="#l153.53"></a><span id="l153.53"> </span>
<a href="#l153.54"></a><span id="l153.54" class="difflineminus">-function test_open_message_window() {</span>
<a href="#l153.55"></a><span id="l153.55" class="difflineplus">+add_task(function test_open_message_window() {</span>
<a href="#l153.56"></a><span id="l153.56">   be_in_folder(folderA);</span>
<a href="#l153.57"></a><span id="l153.57"> </span>
<a href="#l153.58"></a><span id="l153.58">   // select the first message</span>
<a href="#l153.59"></a><span id="l153.59">   curMessage = select_click_row(0);</span>
<a href="#l153.60"></a><span id="l153.60"> </span>
<a href="#l153.61"></a><span id="l153.61">   // display it</span>
<a href="#l153.62"></a><span id="l153.62">   msgc = open_selected_message_in_new_window();</span>
<a href="#l153.63"></a><span id="l153.63">   assert_selected_and_displayed(msgc, curMessage);</span>
<a href="#l153.64"></a><span id="l153.64" class="difflineminus">-}</span>
<a href="#l153.65"></a><span id="l153.65" class="difflineplus">+});</span>
<a href="#l153.66"></a><span id="l153.66"> </span>
<a href="#l153.67"></a><span id="l153.67"> /**</span>
<a href="#l153.68"></a><span id="l153.68">  * Use the &quot;m&quot; keyboard accelerator to mark a message as read or unread.</span>
<a href="#l153.69"></a><span id="l153.69">  */</span>
<a href="#l153.70"></a><span id="l153.70" class="difflineminus">-function test_toggle_read() {</span>
<a href="#l153.71"></a><span id="l153.71" class="difflineplus">+add_task(function test_toggle_read() {</span>
<a href="#l153.72"></a><span id="l153.72">   curMessage.markRead(false);</span>
<a href="#l153.73"></a><span id="l153.73">   msgc.keypress(null, &quot;m&quot;, {});</span>
<a href="#l153.74"></a><span id="l153.74" class="difflineminus">-  assert_true(curMessage.isRead, &quot;Message should have been marked read!&quot;);</span>
<a href="#l153.75"></a><span id="l153.75" class="difflineplus">+  Assert.ok(curMessage.isRead, &quot;Message should have been marked read!&quot;);</span>
<a href="#l153.76"></a><span id="l153.76"> </span>
<a href="#l153.77"></a><span id="l153.77">   msgc.keypress(null, &quot;m&quot;, {});</span>
<a href="#l153.78"></a><span id="l153.78" class="difflineminus">-  assert_true(!curMessage.isRead, &quot;Message should have been marked unread!&quot;);</span>
<a href="#l153.79"></a><span id="l153.79" class="difflineminus">-}</span>
<a href="#l153.80"></a><span id="l153.80" class="difflineplus">+  Assert.ok(!curMessage.isRead, &quot;Message should have been marked unread!&quot;);</span>
<a href="#l153.81"></a><span id="l153.81" class="difflineplus">+});</span>
<a href="#l153.82"></a><span id="l153.82"> </span>
<a href="#l153.83"></a><span id="l153.83"> /**</span>
<a href="#l153.84"></a><span id="l153.84">  * Use the &quot;f&quot; keyboard accelerator to navigate to the next message,</span>
<a href="#l153.85"></a><span id="l153.85">  * and verify that it is indeed loaded.</span>
<a href="#l153.86"></a><span id="l153.86">  */</span>
<a href="#l153.87"></a><span id="l153.87" class="difflineminus">-function test_navigate_to_next_message() {</span>
<a href="#l153.88"></a><span id="l153.88" class="difflineplus">+add_task(function test_navigate_to_next_message() {</span>
<a href="#l153.89"></a><span id="l153.89">   plan_for_message_display(msgc);</span>
<a href="#l153.90"></a><span id="l153.90">   msgc.keypress(null, &quot;f&quot;, {});</span>
<a href="#l153.91"></a><span id="l153.91">   wait_for_message_display_completion(msgc, true);</span>
<a href="#l153.92"></a><span id="l153.92">   assert_selected_and_displayed(msgc, 1);</span>
<a href="#l153.93"></a><span id="l153.93" class="difflineminus">-}</span>
<a href="#l153.94"></a><span id="l153.94" class="difflineplus">+});</span>
<a href="#l153.95"></a><span id="l153.95"> </span>
<a href="#l153.96"></a><span id="l153.96"> /**</span>
<a href="#l153.97"></a><span id="l153.97">  * Delete a single message and verify the next message is loaded. This sets</span>
<a href="#l153.98"></a><span id="l153.98">  * us up for the next test, which is delete on a collapsed thread after</span>
<a href="#l153.99"></a><span id="l153.99">  * the previous message was deleted.</span>
<a href="#l153.100"></a><span id="l153.100">  */</span>
<a href="#l153.101"></a><span id="l153.101" class="difflineminus">-function test_delete_single_message() {</span>
<a href="#l153.102"></a><span id="l153.102" class="difflineplus">+add_task(function test_delete_single_message() {</span>
<a href="#l153.103"></a><span id="l153.103">   plan_for_message_display(msgc);</span>
<a href="#l153.104"></a><span id="l153.104">   press_delete(msgc);</span>
<a href="#l153.105"></a><span id="l153.105">   wait_for_message_display_completion(msgc, true);</span>
<a href="#l153.106"></a><span id="l153.106">   assert_selected_and_displayed(msgc, 1);</span>
<a href="#l153.107"></a><span id="l153.107" class="difflineminus">-}</span>
<a href="#l153.108"></a><span id="l153.108" class="difflineplus">+});</span>
<a href="#l153.109"></a><span id="l153.109"> </span>
<a href="#l153.110"></a><span id="l153.110"> /**</span>
<a href="#l153.111"></a><span id="l153.111">  * Delete the current message, and verify that it only deletes</span>
<a href="#l153.112"></a><span id="l153.112">  * a single message, not the messages in the collapsed thread</span>
<a href="#l153.113"></a><span id="l153.113">  */</span>
<a href="#l153.114"></a><span id="l153.114" class="difflineminus">-function test_del_collapsed_thread() {</span>
<a href="#l153.115"></a><span id="l153.115" class="difflineplus">+add_task(function test_del_collapsed_thread() {</span>
<a href="#l153.116"></a><span id="l153.116">   press_delete(msgc);</span>
<a href="#l153.117"></a><span id="l153.117">   if (folderA.getTotalMessages(false) != 4) {</span>
<a href="#l153.118"></a><span id="l153.118">     throw new Error(&quot;should have only deleted one message&quot;);</span>
<a href="#l153.119"></a><span id="l153.119">   }</span>
<a href="#l153.120"></a><span id="l153.120" class="difflineminus">-}</span>
<a href="#l153.121"></a><span id="l153.121" class="difflineplus">+});</span>
<a href="#l153.122"></a><span id="l153.122"> </span>
<a href="#l153.123"></a><span id="l153.123"> function subtest_say_yes(cwc) {</span>
<a href="#l153.124"></a><span id="l153.124">   cwc.window.document.documentElement.getButton(&quot;accept&quot;).doCommand();</span>
<a href="#l153.125"></a><span id="l153.125"> }</span>
<a href="#l153.126"></a><span id="l153.126"> </span>
<a href="#l153.127"></a><span id="l153.127"> /**</span>
<a href="#l153.128"></a><span id="l153.128">  * Hit n enough times to mark all messages in folder A read, and then accept the</span>
<a href="#l153.129"></a><span id="l153.129">  * modal dialog saying that we should move to the next folder. Then, assert that</span>
<a href="#l153.130"></a><span id="l153.130">  * the message displayed in the standalone message window is folder B's first</span>
<a href="#l153.131"></a><span id="l153.131">  * message (since all messages in folder B were unread).</span>
<a href="#l153.132"></a><span id="l153.132">  */</span>
<a href="#l153.133"></a><span id="l153.133" class="difflineminus">-function test_next_unread() {</span>
<a href="#l153.134"></a><span id="l153.134" class="difflineplus">+add_task(function test_next_unread() {</span>
<a href="#l153.135"></a><span id="l153.135">   for (let i = 0; i &lt; 3; ++i) {</span>
<a href="#l153.136"></a><span id="l153.136">     plan_for_message_display(msgc);</span>
<a href="#l153.137"></a><span id="l153.137">     msgc.keypress(null, &quot;n&quot;, {});</span>
<a href="#l153.138"></a><span id="l153.138">     wait_for_message_display_completion(msgc, true);</span>
<a href="#l153.139"></a><span id="l153.139">   }</span>
<a href="#l153.140"></a><span id="l153.140"> </span>
<a href="#l153.141"></a><span id="l153.141">   plan_for_modal_dialog(&quot;commonDialog&quot;, subtest_say_yes);</span>
<a href="#l153.142"></a><span id="l153.142">   msgc.keypress(null, &quot;n&quot;, {});</span>
<a href="#l153.143"></a><span id="l153.143" class="difflineat">@@ -137,18 +136,18 @@ function test_next_unread() {</span>
<a href="#l153.144"></a><span id="l153.144">   // move to folder B</span>
<a href="#l153.145"></a><span id="l153.145">   be_in_folder(folderB);</span>
<a href="#l153.146"></a><span id="l153.146"> </span>
<a href="#l153.147"></a><span id="l153.147">   // select the first message, and make sure it's not read</span>
<a href="#l153.148"></a><span id="l153.148">   let msg = select_click_row(0);</span>
<a href="#l153.149"></a><span id="l153.149"> </span>
<a href="#l153.150"></a><span id="l153.150">   // make sure we've been displaying the right message</span>
<a href="#l153.151"></a><span id="l153.151">   assert_selected_and_displayed(msgc, msg);</span>
<a href="#l153.152"></a><span id="l153.152" class="difflineminus">-}</span>
<a href="#l153.153"></a><span id="l153.153" class="difflineplus">+});</span>
<a href="#l153.154"></a><span id="l153.154"> </span>
<a href="#l153.155"></a><span id="l153.155"> /**</span>
<a href="#l153.156"></a><span id="l153.156">  * Close the window by hitting escape.</span>
<a href="#l153.157"></a><span id="l153.157">  */</span>
<a href="#l153.158"></a><span id="l153.158" class="difflineminus">-function test_close_message_window() {</span>
<a href="#l153.159"></a><span id="l153.159" class="difflineplus">+add_task(function test_close_message_window() {</span>
<a href="#l153.160"></a><span id="l153.160">   plan_for_window_close(msgc);</span>
<a href="#l153.161"></a><span id="l153.161">   msgc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l153.162"></a><span id="l153.162">   wait_for_window_close(msgc);</span>
<a href="#l153.163"></a><span id="l153.163" class="difflineminus">-}</span>
<a href="#l153.164"></a><span id="l153.164" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l154.1"></a><span id="l154.1">copy from mail/test/mozmill/folder-display/test-opening-messages.js</span>
<a href="#l154.2"></a><span id="l154.2">copy to mail/test/browser/folder-display/browser_openingMessages.js</span>
<a href="#l154.3"></a><span id="l154.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-opening-messages.js</span>
<a href="#l154.4"></a><span id="l154.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_openingMessages.js</span>
<a href="#l154.5"></a><span id="l154.5" class="difflineat">@@ -14,17 +14,16 @@</span>
<a href="#l154.6"></a><span id="l154.6">  *   that multiple messages opened in windows are just the same function called</span>
<a href="#l154.7"></a><span id="l154.7">  *   repeatedly.)</span>
<a href="#l154.8"></a><span id="l154.8">  * - reusing an existing window to show another message</span>
<a href="#l154.9"></a><span id="l154.9">  */</span>
<a href="#l154.10"></a><span id="l154.10"> </span>
<a href="#l154.11"></a><span id="l154.11"> &quot;use strict&quot;;</span>
<a href="#l154.12"></a><span id="l154.12"> </span>
<a href="#l154.13"></a><span id="l154.13"> var {</span>
<a href="#l154.14"></a><span id="l154.14" class="difflineminus">-  assert_equals,</span>
<a href="#l154.15"></a><span id="l154.15">   assert_message_pane_focused,</span>
<a href="#l154.16"></a><span id="l154.16">   assert_number_of_tabs_open,</span>
<a href="#l154.17"></a><span id="l154.17">   assert_selected_and_displayed,</span>
<a href="#l154.18"></a><span id="l154.18">   assert_tab_mode_name,</span>
<a href="#l154.19"></a><span id="l154.19">   assert_tab_titled_from,</span>
<a href="#l154.20"></a><span id="l154.20">   be_in_folder,</span>
<a href="#l154.21"></a><span id="l154.21">   close_message_window,</span>
<a href="#l154.22"></a><span id="l154.22">   close_tab,</span>
<a href="#l154.23"></a><span id="l154.23" class="difflineat">@@ -48,25 +47,25 @@ var { plan_for_new_window, wait_for_new_</span>
<a href="#l154.24"></a><span id="l154.24"> );</span>
<a href="#l154.25"></a><span id="l154.25"> </span>
<a href="#l154.26"></a><span id="l154.26"> // One folder's enough</span>
<a href="#l154.27"></a><span id="l154.27"> var folder = null;</span>
<a href="#l154.28"></a><span id="l154.28"> </span>
<a href="#l154.29"></a><span id="l154.29"> // Number of messages to open for multi-message tests</span>
<a href="#l154.30"></a><span id="l154.30"> var NUM_MESSAGES_TO_OPEN = 5;</span>
<a href="#l154.31"></a><span id="l154.31"> </span>
<a href="#l154.32"></a><span id="l154.32" class="difflineminus">-function setupModule(module) {</span>
<a href="#l154.33"></a><span id="l154.33" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l154.34"></a><span id="l154.34">   folder = create_folder(&quot;OpeningMessagesA&quot;);</span>
<a href="#l154.35"></a><span id="l154.35">   make_new_sets_in_folder(folder, [{ count: 10 }]);</span>
<a href="#l154.36"></a><span id="l154.36" class="difflineminus">-}</span>
<a href="#l154.37"></a><span id="l154.37" class="difflineplus">+});</span>
<a href="#l154.38"></a><span id="l154.38"> </span>
<a href="#l154.39"></a><span id="l154.39"> /**</span>
<a href="#l154.40"></a><span id="l154.40">  * Test opening a single message in a new tab.</span>
<a href="#l154.41"></a><span id="l154.41">  */</span>
<a href="#l154.42"></a><span id="l154.42" class="difflineminus">-function test_open_single_message_in_tab() {</span>
<a href="#l154.43"></a><span id="l154.43" class="difflineplus">+add_task(function test_open_single_message_in_tab() {</span>
<a href="#l154.44"></a><span id="l154.44">   set_open_message_behavior(&quot;NEW_TAB&quot;);</span>
<a href="#l154.45"></a><span id="l154.45">   let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l154.46"></a><span id="l154.46">   let preCount = mc.tabmail.tabContainer.allTabs.length;</span>
<a href="#l154.47"></a><span id="l154.47">   be_in_folder(folder);</span>
<a href="#l154.48"></a><span id="l154.48">   // Select one message</span>
<a href="#l154.49"></a><span id="l154.49">   let msgHdr = select_click_row(1);</span>
<a href="#l154.50"></a><span id="l154.50">   // Open it</span>
<a href="#l154.51"></a><span id="l154.51">   open_selected_message();</span>
<a href="#l154.52"></a><span id="l154.52" class="difflineat">@@ -82,22 +81,22 @@ function test_open_single_message_in_tab</span>
<a href="#l154.53"></a><span id="l154.53">   // Check that the message pane is focused</span>
<a href="#l154.54"></a><span id="l154.54">   assert_message_pane_focused();</span>
<a href="#l154.55"></a><span id="l154.55">   // Check that the message pane in a newly opened tab has full height.</span>
<a href="#l154.56"></a><span id="l154.56">   check_message_pane_in_tab_full_height();</span>
<a href="#l154.57"></a><span id="l154.57">   // Clean up, close the tab</span>
<a href="#l154.58"></a><span id="l154.58">   close_tab(mc.tabmail.currentTabInfo);</span>
<a href="#l154.59"></a><span id="l154.59">   switch_tab(folderTab);</span>
<a href="#l154.60"></a><span id="l154.60">   reset_open_message_behavior();</span>
<a href="#l154.61"></a><span id="l154.61" class="difflineminus">-}</span>
<a href="#l154.62"></a><span id="l154.62" class="difflineplus">+});</span>
<a href="#l154.63"></a><span id="l154.63"> </span>
<a href="#l154.64"></a><span id="l154.64"> /**</span>
<a href="#l154.65"></a><span id="l154.65">  * Test opening multiple messages in new tabs.</span>
<a href="#l154.66"></a><span id="l154.66">  */</span>
<a href="#l154.67"></a><span id="l154.67" class="difflineminus">-function test_open_multiple_messages_in_tabs() {</span>
<a href="#l154.68"></a><span id="l154.68" class="difflineplus">+add_task(function test_open_multiple_messages_in_tabs() {</span>
<a href="#l154.69"></a><span id="l154.69">   set_open_message_behavior(&quot;NEW_TAB&quot;);</span>
<a href="#l154.70"></a><span id="l154.70">   let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l154.71"></a><span id="l154.71">   let preCount = mc.tabmail.tabContainer.allTabs.length;</span>
<a href="#l154.72"></a><span id="l154.72">   be_in_folder(folder);</span>
<a href="#l154.73"></a><span id="l154.73"> </span>
<a href="#l154.74"></a><span id="l154.74">   // Select a bunch of messages</span>
<a href="#l154.75"></a><span id="l154.75">   select_click_row(1);</span>
<a href="#l154.76"></a><span id="l154.76">   let selectedMessages = select_shift_click_row(NUM_MESSAGES_TO_OPEN);</span>
<a href="#l154.77"></a><span id="l154.77" class="difflineat">@@ -124,22 +123,22 @@ function test_open_multiple_messages_in_</span>
<a href="#l154.78"></a><span id="l154.78">   // is focused in each case, then close it to load the previous tab.</span>
<a href="#l154.79"></a><span id="l154.79">   for (let i = 0; i &lt; NUM_MESSAGES_TO_OPEN; i++) {</span>
<a href="#l154.80"></a><span id="l154.80">     assert_selected_and_displayed(selectedMessages.pop());</span>
<a href="#l154.81"></a><span id="l154.81">     assert_message_pane_focused();</span>
<a href="#l154.82"></a><span id="l154.82">     close_tab(mc.tabmail.currentTabInfo);</span>
<a href="#l154.83"></a><span id="l154.83">   }</span>
<a href="#l154.84"></a><span id="l154.84">   switch_tab(folderTab);</span>
<a href="#l154.85"></a><span id="l154.85">   reset_open_message_behavior();</span>
<a href="#l154.86"></a><span id="l154.86" class="difflineminus">-}</span>
<a href="#l154.87"></a><span id="l154.87" class="difflineplus">+});</span>
<a href="#l154.88"></a><span id="l154.88"> </span>
<a href="#l154.89"></a><span id="l154.89"> /**</span>
<a href="#l154.90"></a><span id="l154.90">  * Test opening a message in a new window.</span>
<a href="#l154.91"></a><span id="l154.91">  */</span>
<a href="#l154.92"></a><span id="l154.92" class="difflineminus">-function test_open_message_in_new_window() {</span>
<a href="#l154.93"></a><span id="l154.93" class="difflineplus">+add_task(function test_open_message_in_new_window() {</span>
<a href="#l154.94"></a><span id="l154.94">   set_open_message_behavior(&quot;NEW_WINDOW&quot;);</span>
<a href="#l154.95"></a><span id="l154.95">   be_in_folder(folder);</span>
<a href="#l154.96"></a><span id="l154.96"> </span>
<a href="#l154.97"></a><span id="l154.97">   // Select a message</span>
<a href="#l154.98"></a><span id="l154.98">   let msgHdr = select_click_row(1);</span>
<a href="#l154.99"></a><span id="l154.99"> </span>
<a href="#l154.100"></a><span id="l154.100">   plan_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l154.101"></a><span id="l154.101">   // Open it</span>
<a href="#l154.102"></a><span id="l154.102" class="difflineat">@@ -150,22 +149,22 @@ function test_open_message_in_new_window</span>
<a href="#l154.103"></a><span id="l154.103">   assert_selected_and_displayed(msgc, msgHdr);</span>
<a href="#l154.104"></a><span id="l154.104"> </span>
<a href="#l154.105"></a><span id="l154.105">   // Check that the message pane in a newly opened window has full height.</span>
<a href="#l154.106"></a><span id="l154.106">   check_message_pane_in_window_full_height(msgc);</span>
<a href="#l154.107"></a><span id="l154.107"> </span>
<a href="#l154.108"></a><span id="l154.108">   // Clean up, close the window</span>
<a href="#l154.109"></a><span id="l154.109">   close_message_window(msgc);</span>
<a href="#l154.110"></a><span id="l154.110">   reset_open_message_behavior();</span>
<a href="#l154.111"></a><span id="l154.111" class="difflineminus">-}</span>
<a href="#l154.112"></a><span id="l154.112" class="difflineplus">+});</span>
<a href="#l154.113"></a><span id="l154.113"> </span>
<a href="#l154.114"></a><span id="l154.114"> /**</span>
<a href="#l154.115"></a><span id="l154.115">  * Test reusing an existing window to open a new message.</span>
<a href="#l154.116"></a><span id="l154.116">  */</span>
<a href="#l154.117"></a><span id="l154.117" class="difflineminus">-function test_open_message_in_existing_window() {</span>
<a href="#l154.118"></a><span id="l154.118" class="difflineplus">+add_task(function test_open_message_in_existing_window() {</span>
<a href="#l154.119"></a><span id="l154.119">   set_open_message_behavior(&quot;EXISTING_WINDOW&quot;);</span>
<a href="#l154.120"></a><span id="l154.120">   be_in_folder(folder);</span>
<a href="#l154.121"></a><span id="l154.121"> </span>
<a href="#l154.122"></a><span id="l154.122">   // Open up a window</span>
<a href="#l154.123"></a><span id="l154.123">   select_click_row(1);</span>
<a href="#l154.124"></a><span id="l154.124">   plan_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l154.125"></a><span id="l154.125">   open_selected_message();</span>
<a href="#l154.126"></a><span id="l154.126">   let msgc = wait_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l154.127"></a><span id="l154.127" class="difflineat">@@ -177,34 +176,34 @@ function test_open_message_in_existing_w</span>
<a href="#l154.128"></a><span id="l154.128">   open_selected_message();</span>
<a href="#l154.129"></a><span id="l154.129">   wait_for_message_display_completion(msgc, true);</span>
<a href="#l154.130"></a><span id="l154.130"> </span>
<a href="#l154.131"></a><span id="l154.131">   // Check if our old window displays the message</span>
<a href="#l154.132"></a><span id="l154.132">   assert_selected_and_displayed(msgc, msgHdr);</span>
<a href="#l154.133"></a><span id="l154.133">   // Clean up, close the window</span>
<a href="#l154.134"></a><span id="l154.134">   close_message_window(msgc);</span>
<a href="#l154.135"></a><span id="l154.135">   reset_open_message_behavior();</span>
<a href="#l154.136"></a><span id="l154.136" class="difflineminus">-}</span>
<a href="#l154.137"></a><span id="l154.137" class="difflineplus">+});</span>
<a href="#l154.138"></a><span id="l154.138"> </span>
<a href="#l154.139"></a><span id="l154.139"> /**</span>
<a href="#l154.140"></a><span id="l154.140">  * Check if the message pane in a new tab has the full height, so no</span>
<a href="#l154.141"></a><span id="l154.141">  * empty box is visible below it.</span>
<a href="#l154.142"></a><span id="l154.142">  */</span>
<a href="#l154.143"></a><span id="l154.143"> </span>
<a href="#l154.144"></a><span id="l154.144"> function check_message_pane_in_tab_full_height() {</span>
<a href="#l154.145"></a><span id="l154.145">   let messagesBoxHeight = mc.e(&quot;messagesBox&quot;).getBoundingClientRect().height;</span>
<a href="#l154.146"></a><span id="l154.146">   let displayDeckHeight = mc.e(&quot;displayDeck&quot;).getBoundingClientRect().height;</span>
<a href="#l154.147"></a><span id="l154.147">   let messagePaneBoxWrapperHeight = mc</span>
<a href="#l154.148"></a><span id="l154.148">     .e(&quot;messagepaneboxwrapper&quot;)</span>
<a href="#l154.149"></a><span id="l154.149">     .getBoundingClientRect().height;</span>
<a href="#l154.150"></a><span id="l154.150">   let notificationBoxHeight = mc</span>
<a href="#l154.151"></a><span id="l154.151">     .e(&quot;messenger-notification-footer&quot;)</span>
<a href="#l154.152"></a><span id="l154.152">     .getBoundingClientRect().height;</span>
<a href="#l154.153"></a><span id="l154.153"> </span>
<a href="#l154.154"></a><span id="l154.154" class="difflineminus">-  assert_equals(</span>
<a href="#l154.155"></a><span id="l154.155" class="difflineplus">+  Assert.equal(</span>
<a href="#l154.156"></a><span id="l154.156">     messagesBoxHeight,</span>
<a href="#l154.157"></a><span id="l154.157">     displayDeckHeight + messagePaneBoxWrapperHeight + notificationBoxHeight,</span>
<a href="#l154.158"></a><span id="l154.158">     &quot;messages box height (&quot; +</span>
<a href="#l154.159"></a><span id="l154.159">       messagesBoxHeight +</span>
<a href="#l154.160"></a><span id="l154.160">       &quot;) not equal to the sum of displayDeck height (&quot; +</span>
<a href="#l154.161"></a><span id="l154.161">       displayDeckHeight +</span>
<a href="#l154.162"></a><span id="l154.162">       &quot;) and message pane box wrapper height (&quot; +</span>
<a href="#l154.163"></a><span id="l154.163">       messagePaneBoxWrapperHeight +</span>
<a href="#l154.164"></a><span id="l154.164" class="difflineat">@@ -228,15 +227,15 @@ function check_message_pane_in_window_fu</span>
<a href="#l154.165"></a><span id="l154.165">   for (let child of messengerChildren) {</span>
<a href="#l154.166"></a><span id="l154.166">     try {</span>
<a href="#l154.167"></a><span id="l154.167">       let childRect = child.getBoundingClientRect();</span>
<a href="#l154.168"></a><span id="l154.168">       childrenHeightsSum += childRect.height;</span>
<a href="#l154.169"></a><span id="l154.169">       childrenHeightsStr += '&quot;' + child.id + '&quot;: ' + childRect.height + &quot;, &quot;;</span>
<a href="#l154.170"></a><span id="l154.170">     } catch (ex) {}</span>
<a href="#l154.171"></a><span id="l154.171">   }</span>
<a href="#l154.172"></a><span id="l154.172"> </span>
<a href="#l154.173"></a><span id="l154.173" class="difflineminus">-  assert_equals(</span>
<a href="#l154.174"></a><span id="l154.174" class="difflineplus">+  Assert.equal(</span>
<a href="#l154.175"></a><span id="l154.175">     Math.round(messengerWindowHeight),</span>
<a href="#l154.176"></a><span id="l154.176">     Math.round(childrenHeightsSum),</span>
<a href="#l154.177"></a><span id="l154.177">     &quot;messenger window height not equal to the sum of children heights: &quot; +</span>
<a href="#l154.178"></a><span id="l154.178">       childrenHeightsStr</span>
<a href="#l154.179"></a><span id="l154.179">   );</span>
<a href="#l154.180"></a><span id="l154.180"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l155.1"></a><span id="l155.1">copy from mail/test/mozmill/folder-display/test-opening-messages-without-a-backing-view.js</span>
<a href="#l155.2"></a><span id="l155.2">copy to mail/test/browser/folder-display/browser_openingMessagesWithoutABackingView.js</span>
<a href="#l155.3"></a><span id="l155.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-opening-messages-without-a-backing-view.js</span>
<a href="#l155.4"></a><span id="l155.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_openingMessagesWithoutABackingView.js</span>
<a href="#l155.5"></a><span id="l155.5" class="difflineat">@@ -47,22 +47,22 @@ var { MailViewConstants } = ChromeUtils.</span>
<a href="#l155.6"></a><span id="l155.6"> var folder = null;</span>
<a href="#l155.7"></a><span id="l155.7"> </span>
<a href="#l155.8"></a><span id="l155.8"> // A list of the message headers in this folder</span>
<a href="#l155.9"></a><span id="l155.9"> var msgHdrsInFolder = null;</span>
<a href="#l155.10"></a><span id="l155.10"> </span>
<a href="#l155.11"></a><span id="l155.11"> // Number of messages to open for multi-message tests</span>
<a href="#l155.12"></a><span id="l155.12"> var NUM_MESSAGES_TO_OPEN = 5;</span>
<a href="#l155.13"></a><span id="l155.13"> </span>
<a href="#l155.14"></a><span id="l155.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l155.15"></a><span id="l155.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l155.16"></a><span id="l155.16">   folder = create_folder(&quot;OpeningMessagesNoBackingViewA&quot;);</span>
<a href="#l155.17"></a><span id="l155.17">   make_new_sets_in_folder(folder, [{ count: 10 }]);</span>
<a href="#l155.18"></a><span id="l155.18">   // We don't obey mail view persistence unless the view picker is there</span>
<a href="#l155.19"></a><span id="l155.19">   add_to_toolbar(mc.e(&quot;mail-bar3&quot;), &quot;mailviews-container&quot;);</span>
<a href="#l155.20"></a><span id="l155.20" class="difflineminus">-}</span>
<a href="#l155.21"></a><span id="l155.21" class="difflineplus">+});</span>
<a href="#l155.22"></a><span id="l155.22"> </span>
<a href="#l155.23"></a><span id="l155.23"> /**</span>
<a href="#l155.24"></a><span id="l155.24">  * Test opening a single message without a backing view in a new tab.</span>
<a href="#l155.25"></a><span id="l155.25">  */</span>
<a href="#l155.26"></a><span id="l155.26"> function test_open_single_message_without_backing_view_in_tab() {</span>
<a href="#l155.27"></a><span id="l155.27">   set_open_message_behavior(&quot;NEW_TAB&quot;);</span>
<a href="#l155.28"></a><span id="l155.28">   let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l155.29"></a><span id="l155.29">   let preCount = mc.tabmail.tabContainer.allTabs.length;</span>
<a href="#l155.30"></a><span id="l155.30" class="difflineat">@@ -92,16 +92,17 @@ function test_open_single_message_withou</span>
<a href="#l155.31"></a><span id="l155.31">   assert_selected_and_displayed(msgHdr);</span>
<a href="#l155.32"></a><span id="l155.32">   // Check that the message pane is focused</span>
<a href="#l155.33"></a><span id="l155.33">   assert_message_pane_focused();</span>
<a href="#l155.34"></a><span id="l155.34">   // Clean up, close the tab</span>
<a href="#l155.35"></a><span id="l155.35">   close_tab(mc.tabmail.currentTabInfo);</span>
<a href="#l155.36"></a><span id="l155.36">   switch_tab(folderTab);</span>
<a href="#l155.37"></a><span id="l155.37">   reset_open_message_behavior();</span>
<a href="#l155.38"></a><span id="l155.38"> }</span>
<a href="#l155.39"></a><span id="l155.39" class="difflineplus">+add_task(test_open_single_message_without_backing_view_in_tab);</span>
<a href="#l155.40"></a><span id="l155.40"> </span>
<a href="#l155.41"></a><span id="l155.41"> /**</span>
<a href="#l155.42"></a><span id="l155.42">  * Test opening multiple messages without backing views in new tabs.</span>
<a href="#l155.43"></a><span id="l155.43">  */</span>
<a href="#l155.44"></a><span id="l155.44"> function test_open_multiple_messages_without_backing_views_in_tabs() {</span>
<a href="#l155.45"></a><span id="l155.45">   set_open_message_behavior(&quot;NEW_TAB&quot;);</span>
<a href="#l155.46"></a><span id="l155.46">   let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l155.47"></a><span id="l155.47">   let preCount = mc.tabmail.tabContainer.allTabs.length;</span>
<a href="#l155.48"></a><span id="l155.48" class="difflineat">@@ -133,16 +134,17 @@ function test_open_multiple_messages_wit</span>
<a href="#l155.49"></a><span id="l155.49">   for (let i = 0; i &lt; NUM_MESSAGES_TO_OPEN; i++) {</span>
<a href="#l155.50"></a><span id="l155.50">     assert_selected_and_displayed(msgHdrs.pop());</span>
<a href="#l155.51"></a><span id="l155.51">     assert_message_pane_focused();</span>
<a href="#l155.52"></a><span id="l155.52">     close_tab(mc.tabmail.currentTabInfo);</span>
<a href="#l155.53"></a><span id="l155.53">   }</span>
<a href="#l155.54"></a><span id="l155.54">   switch_tab(folderTab);</span>
<a href="#l155.55"></a><span id="l155.55">   reset_open_message_behavior();</span>
<a href="#l155.56"></a><span id="l155.56"> }</span>
<a href="#l155.57"></a><span id="l155.57" class="difflineplus">+add_task(test_open_multiple_messages_without_backing_views_in_tabs);</span>
<a href="#l155.58"></a><span id="l155.58"> </span>
<a href="#l155.59"></a><span id="l155.59"> /**</span>
<a href="#l155.60"></a><span id="l155.60">  * Test opening a message without a backing view in a new window.</span>
<a href="#l155.61"></a><span id="l155.61">  */</span>
<a href="#l155.62"></a><span id="l155.62"> function test_open_message_without_backing_view_in_new_window() {</span>
<a href="#l155.63"></a><span id="l155.63">   set_open_message_behavior(&quot;NEW_WINDOW&quot;);</span>
<a href="#l155.64"></a><span id="l155.64">   be_in_folder(folder);</span>
<a href="#l155.65"></a><span id="l155.65"> </span>
<a href="#l155.66"></a><span id="l155.66" class="difflineat">@@ -155,16 +157,17 @@ function test_open_message_without_backi</span>
<a href="#l155.67"></a><span id="l155.67">   let msgc = wait_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l155.68"></a><span id="l155.68">   wait_for_message_display_completion(msgc, true);</span>
<a href="#l155.69"></a><span id="l155.69"> </span>
<a href="#l155.70"></a><span id="l155.70">   assert_selected_and_displayed(msgc, msgHdr);</span>
<a href="#l155.71"></a><span id="l155.71">   // Clean up, close the window</span>
<a href="#l155.72"></a><span id="l155.72">   close_message_window(msgc);</span>
<a href="#l155.73"></a><span id="l155.73">   reset_open_message_behavior();</span>
<a href="#l155.74"></a><span id="l155.74"> }</span>
<a href="#l155.75"></a><span id="l155.75" class="difflineplus">+add_task(test_open_message_without_backing_view_in_new_window);</span>
<a href="#l155.76"></a><span id="l155.76"> </span>
<a href="#l155.77"></a><span id="l155.77"> /**</span>
<a href="#l155.78"></a><span id="l155.78">  * Test reusing an existing window to open a new message.</span>
<a href="#l155.79"></a><span id="l155.79">  */</span>
<a href="#l155.80"></a><span id="l155.80"> function test_open_message_without_backing_view_in_existing_window() {</span>
<a href="#l155.81"></a><span id="l155.81">   set_open_message_behavior(&quot;EXISTING_WINDOW&quot;);</span>
<a href="#l155.82"></a><span id="l155.82">   be_in_folder(folder);</span>
<a href="#l155.83"></a><span id="l155.83"> </span>
<a href="#l155.84"></a><span id="l155.84" class="difflineat">@@ -182,44 +185,60 @@ function test_open_message_without_backi</span>
<a href="#l155.85"></a><span id="l155.85">   wait_for_message_display_completion(msgc, true);</span>
<a href="#l155.86"></a><span id="l155.86"> </span>
<a href="#l155.87"></a><span id="l155.87">   // Check if our old window displays the message</span>
<a href="#l155.88"></a><span id="l155.88">   assert_selected_and_displayed(msgc, msgHdr);</span>
<a href="#l155.89"></a><span id="l155.89">   // Clean up, close the window</span>
<a href="#l155.90"></a><span id="l155.90">   close_message_window(msgc);</span>
<a href="#l155.91"></a><span id="l155.91">   reset_open_message_behavior();</span>
<a href="#l155.92"></a><span id="l155.92"> }</span>
<a href="#l155.93"></a><span id="l155.93" class="difflineplus">+add_task(test_open_message_without_backing_view_in_existing_window);</span>
<a href="#l155.94"></a><span id="l155.94"> </span>
<a href="#l155.95"></a><span id="l155.95"> /**</span>
<a href="#l155.96"></a><span id="l155.96">  * Time to throw a spanner in the works. Set a mail view for the folder that</span>
<a href="#l155.97"></a><span id="l155.97">  * excludes every message.</span>
<a href="#l155.98"></a><span id="l155.98">  */</span>
<a href="#l155.99"></a><span id="l155.99" class="difflineminus">-function test_filter_out_all_messages() {</span>
<a href="#l155.100"></a><span id="l155.100" class="difflineplus">+add_task(function test_filter_out_all_messages() {</span>
<a href="#l155.101"></a><span id="l155.101">   set_mail_view(MailViewConstants.kViewItemTags, &quot;$label1&quot;);</span>
<a href="#l155.102"></a><span id="l155.102">   // Make sure all the messages have actually disappeared</span>
<a href="#l155.103"></a><span id="l155.103">   assert_messages_not_in_view(msgHdrsInFolder);</span>
<a href="#l155.104"></a><span id="l155.104" class="difflineminus">-}</span>
<a href="#l155.105"></a><span id="l155.105" class="difflineplus">+});</span>
<a href="#l155.106"></a><span id="l155.106"> </span>
<a href="#l155.107"></a><span id="l155.107"> /**</span>
<a href="#l155.108"></a><span id="l155.108">  * Re-run all the tests.</span>
<a href="#l155.109"></a><span id="l155.109">  */</span>
<a href="#l155.110"></a><span id="l155.110" class="difflineminus">-function test_open_single_message_without_backing_view_in_tab_filtered() {</span>
<a href="#l155.111"></a><span id="l155.111" class="difflineminus">-  test_open_single_message_without_backing_view_in_tab();</span>
<a href="#l155.112"></a><span id="l155.112" class="difflineminus">-}</span>
<a href="#l155.113"></a><span id="l155.113" class="difflineplus">+add_task(</span>
<a href="#l155.114"></a><span id="l155.114" class="difflineplus">+  function test_open_single_message_without_backing_view_in_tab_filtered() {</span>
<a href="#l155.115"></a><span id="l155.115" class="difflineplus">+    test_open_single_message_without_backing_view_in_tab();</span>
<a href="#l155.116"></a><span id="l155.116" class="difflineplus">+  }</span>
<a href="#l155.117"></a><span id="l155.117" class="difflineplus">+);</span>
<a href="#l155.118"></a><span id="l155.118"> </span>
<a href="#l155.119"></a><span id="l155.119" class="difflineminus">-function test_open_multiple_messages_without_backing_views_in_tabs_filtered() {</span>
<a href="#l155.120"></a><span id="l155.120" class="difflineminus">-  test_open_multiple_messages_without_backing_views_in_tabs();</span>
<a href="#l155.121"></a><span id="l155.121" class="difflineminus">-}</span>
<a href="#l155.122"></a><span id="l155.122" class="difflineplus">+add_task(</span>
<a href="#l155.123"></a><span id="l155.123" class="difflineplus">+  function test_open_multiple_messages_without_backing_views_in_tabs_filtered() {</span>
<a href="#l155.124"></a><span id="l155.124" class="difflineplus">+    test_open_multiple_messages_without_backing_views_in_tabs();</span>
<a href="#l155.125"></a><span id="l155.125" class="difflineplus">+  }</span>
<a href="#l155.126"></a><span id="l155.126" class="difflineplus">+);</span>
<a href="#l155.127"></a><span id="l155.127"> </span>
<a href="#l155.128"></a><span id="l155.128" class="difflineminus">-function test_open_message_without_backing_view_in_new_window_filtered() {</span>
<a href="#l155.129"></a><span id="l155.129" class="difflineminus">-  test_open_message_without_backing_view_in_new_window();</span>
<a href="#l155.130"></a><span id="l155.130" class="difflineminus">-}</span>
<a href="#l155.131"></a><span id="l155.131" class="difflineplus">+add_task(</span>
<a href="#l155.132"></a><span id="l155.132" class="difflineplus">+  function test_open_message_without_backing_view_in_new_window_filtered() {</span>
<a href="#l155.133"></a><span id="l155.133" class="difflineplus">+    test_open_message_without_backing_view_in_new_window();</span>
<a href="#l155.134"></a><span id="l155.134" class="difflineplus">+  }</span>
<a href="#l155.135"></a><span id="l155.135" class="difflineplus">+);</span>
<a href="#l155.136"></a><span id="l155.136"> </span>
<a href="#l155.137"></a><span id="l155.137" class="difflineminus">-function test_open_message_without_backing_view_in_existing_window_filtered() {</span>
<a href="#l155.138"></a><span id="l155.138" class="difflineminus">-  test_open_message_without_backing_view_in_existing_window();</span>
<a href="#l155.139"></a><span id="l155.139" class="difflineminus">-}</span>
<a href="#l155.140"></a><span id="l155.140" class="difflineplus">+add_task(</span>
<a href="#l155.141"></a><span id="l155.141" class="difflineplus">+  function test_open_message_without_backing_view_in_existing_window_filtered() {</span>
<a href="#l155.142"></a><span id="l155.142" class="difflineplus">+    test_open_message_without_backing_view_in_existing_window();</span>
<a href="#l155.143"></a><span id="l155.143" class="difflineplus">+  }</span>
<a href="#l155.144"></a><span id="l155.144" class="difflineplus">+);</span>
<a href="#l155.145"></a><span id="l155.145"> </span>
<a href="#l155.146"></a><span id="l155.146"> /**</span>
<a href="#l155.147"></a><span id="l155.147">  * Good hygiene: remove the view picker from the toolbar.</span>
<a href="#l155.148"></a><span id="l155.148">  */</span>
<a href="#l155.149"></a><span id="l155.149" class="difflineminus">-function test_cleanup() {</span>
<a href="#l155.150"></a><span id="l155.150" class="difflineplus">+add_task(function test_cleanup() {</span>
<a href="#l155.151"></a><span id="l155.151">   remove_from_toolbar(mc.e(&quot;mail-bar3&quot;), &quot;mailviews-container&quot;);</span>
<a href="#l155.152"></a><span id="l155.152" class="difflineminus">-}</span>
<a href="#l155.153"></a><span id="l155.153" class="difflineplus">+</span>
<a href="#l155.154"></a><span id="l155.154" class="difflineplus">+  Assert.report(</span>
<a href="#l155.155"></a><span id="l155.155" class="difflineplus">+    false,</span>
<a href="#l155.156"></a><span id="l155.156" class="difflineplus">+    undefined,</span>
<a href="#l155.157"></a><span id="l155.157" class="difflineplus">+    undefined,</span>
<a href="#l155.158"></a><span id="l155.158" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l155.159"></a><span id="l155.159" class="difflineplus">+  );</span>
<a href="#l155.160"></a><span id="l155.160" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l156.1"></a><span id="l156.1">copy from mail/test/mozmill/folder-display/test-pane-focus.js</span>
<a href="#l156.2"></a><span id="l156.2">copy to mail/test/browser/folder-display/browser_paneFocus.js</span>
<a href="#l156.3"></a><span id="l156.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-pane-focus.js</span>
<a href="#l156.4"></a><span id="l156.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_paneFocus.js</span>
<a href="#l156.5"></a><span id="l156.5" class="difflineat">@@ -5,17 +5,16 @@</span>
<a href="#l156.6"></a><span id="l156.6"> /*</span>
<a href="#l156.7"></a><span id="l156.7">  * Test that cycling through the focus of the 3pane's panes works correctly.</span>
<a href="#l156.8"></a><span id="l156.8">  */</span>
<a href="#l156.9"></a><span id="l156.9"> </span>
<a href="#l156.10"></a><span id="l156.10"> &quot;use strict&quot;;</span>
<a href="#l156.11"></a><span id="l156.11"> </span>
<a href="#l156.12"></a><span id="l156.12"> var {</span>
<a href="#l156.13"></a><span id="l156.13">   add_sets_to_folders,</span>
<a href="#l156.14"></a><span id="l156.14" class="difflineminus">-  assert_equals,</span>
<a href="#l156.15"></a><span id="l156.15">   be_in_folder,</span>
<a href="#l156.16"></a><span id="l156.16">   close_tab,</span>
<a href="#l156.17"></a><span id="l156.17">   collapse_all_threads,</span>
<a href="#l156.18"></a><span id="l156.18">   create_folder,</span>
<a href="#l156.19"></a><span id="l156.19">   create_thread,</span>
<a href="#l156.20"></a><span id="l156.20">   make_display_threaded,</span>
<a href="#l156.21"></a><span id="l156.21">   mc,</span>
<a href="#l156.22"></a><span id="l156.22">   open_selected_message_in_new_tab,</span>
<a href="#l156.23"></a><span id="l156.23" class="difflineat">@@ -26,27 +25,27 @@ var {</span>
<a href="#l156.24"></a><span id="l156.24"> } = ChromeUtils.import(</span>
<a href="#l156.25"></a><span id="l156.25">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l156.26"></a><span id="l156.26"> );</span>
<a href="#l156.27"></a><span id="l156.27"> </span>
<a href="#l156.28"></a><span id="l156.28"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l156.29"></a><span id="l156.29"> </span>
<a href="#l156.30"></a><span id="l156.30"> var folder;</span>
<a href="#l156.31"></a><span id="l156.31"> </span>
<a href="#l156.32"></a><span id="l156.32" class="difflineminus">-function setupModule(module) {</span>
<a href="#l156.33"></a><span id="l156.33" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l156.34"></a><span id="l156.34">   folder = create_folder(&quot;PaneFocus&quot;);</span>
<a href="#l156.35"></a><span id="l156.35">   let msg1 = create_thread(1);</span>
<a href="#l156.36"></a><span id="l156.36">   let thread = create_thread(3);</span>
<a href="#l156.37"></a><span id="l156.37">   let msg2 = create_thread(1);</span>
<a href="#l156.38"></a><span id="l156.38">   add_sets_to_folders([folder], [msg1, thread, msg2]);</span>
<a href="#l156.39"></a><span id="l156.39"> </span>
<a href="#l156.40"></a><span id="l156.40">   be_in_folder(folder);</span>
<a href="#l156.41"></a><span id="l156.41">   make_display_threaded();</span>
<a href="#l156.42"></a><span id="l156.42">   collapse_all_threads();</span>
<a href="#l156.43"></a><span id="l156.43" class="difflineminus">-}</span>
<a href="#l156.44"></a><span id="l156.44" class="difflineplus">+});</span>
<a href="#l156.45"></a><span id="l156.45"> </span>
<a href="#l156.46"></a><span id="l156.46"> /**</span>
<a href="#l156.47"></a><span id="l156.47">  * Get the currently-focused pane in the 3pane. One of the folder pane, thread</span>
<a href="#l156.48"></a><span id="l156.48">  * pane, or message pane (single- or multi-message).</span>
<a href="#l156.49"></a><span id="l156.49">  *</span>
<a href="#l156.50"></a><span id="l156.50">  * @return the focused pane</span>
<a href="#l156.51"></a><span id="l156.51">  */</span>
<a href="#l156.52"></a><span id="l156.52"> function get_focused_pane() {</span>
<a href="#l156.53"></a><span id="l156.53" class="difflineat">@@ -75,134 +74,134 @@ function get_focused_pane() {</span>
<a href="#l156.54"></a><span id="l156.54"> function check_pane_cycling(multimessage) {</span>
<a href="#l156.55"></a><span id="l156.55">   let folderPane = mc.e(&quot;folderTree&quot;);</span>
<a href="#l156.56"></a><span id="l156.56">   let threadPane = mc.e(&quot;threadTree&quot;);</span>
<a href="#l156.57"></a><span id="l156.57">   let messagePane = mc.e(multimessage ? &quot;multimessage&quot; : &quot;messagepane&quot;);</span>
<a href="#l156.58"></a><span id="l156.58"> </span>
<a href="#l156.59"></a><span id="l156.59">   folderPane.focus();</span>
<a href="#l156.60"></a><span id="l156.60"> </span>
<a href="#l156.61"></a><span id="l156.61">   mc.keypress(null, &quot;VK_F6&quot;, {});</span>
<a href="#l156.62"></a><span id="l156.62" class="difflineminus">-  assert_equals(threadPane, get_focused_pane());</span>
<a href="#l156.63"></a><span id="l156.63" class="difflineplus">+  Assert.equal(threadPane, get_focused_pane());</span>
<a href="#l156.64"></a><span id="l156.64">   mc.keypress(null, &quot;VK_F6&quot;, {});</span>
<a href="#l156.65"></a><span id="l156.65" class="difflineminus">-  assert_equals(messagePane, get_focused_pane());</span>
<a href="#l156.66"></a><span id="l156.66" class="difflineplus">+  Assert.equal(messagePane, get_focused_pane());</span>
<a href="#l156.67"></a><span id="l156.67">   mc.keypress(null, &quot;VK_F6&quot;, {});</span>
<a href="#l156.68"></a><span id="l156.68" class="difflineminus">-  assert_equals(folderPane, get_focused_pane());</span>
<a href="#l156.69"></a><span id="l156.69" class="difflineplus">+  Assert.equal(folderPane, get_focused_pane());</span>
<a href="#l156.70"></a><span id="l156.70"> </span>
<a href="#l156.71"></a><span id="l156.71">   mc.keypress(null, &quot;VK_F6&quot;, { shiftKey: true });</span>
<a href="#l156.72"></a><span id="l156.72" class="difflineminus">-  assert_equals(messagePane, get_focused_pane());</span>
<a href="#l156.73"></a><span id="l156.73" class="difflineplus">+  Assert.equal(messagePane, get_focused_pane());</span>
<a href="#l156.74"></a><span id="l156.74">   mc.keypress(null, &quot;VK_F6&quot;, { shiftKey: true });</span>
<a href="#l156.75"></a><span id="l156.75" class="difflineminus">-  assert_equals(threadPane, get_focused_pane());</span>
<a href="#l156.76"></a><span id="l156.76" class="difflineplus">+  Assert.equal(threadPane, get_focused_pane());</span>
<a href="#l156.77"></a><span id="l156.77">   mc.keypress(null, &quot;VK_F6&quot;, { shiftKey: true });</span>
<a href="#l156.78"></a><span id="l156.78" class="difflineminus">-  assert_equals(folderPane, get_focused_pane());</span>
<a href="#l156.79"></a><span id="l156.79" class="difflineplus">+  Assert.equal(folderPane, get_focused_pane());</span>
<a href="#l156.80"></a><span id="l156.80"> }</span>
<a href="#l156.81"></a><span id="l156.81"> </span>
<a href="#l156.82"></a><span id="l156.82" class="difflineminus">-function test_no_messages_selected() {</span>
<a href="#l156.83"></a><span id="l156.83" class="difflineplus">+add_task(function test_no_messages_selected() {</span>
<a href="#l156.84"></a><span id="l156.84">   be_in_folder(folder);</span>
<a href="#l156.85"></a><span id="l156.85"> </span>
<a href="#l156.86"></a><span id="l156.86">   // Select nothing</span>
<a href="#l156.87"></a><span id="l156.87">   select_none();</span>
<a href="#l156.88"></a><span id="l156.88">   check_pane_cycling(false);</span>
<a href="#l156.89"></a><span id="l156.89" class="difflineminus">-}</span>
<a href="#l156.90"></a><span id="l156.90" class="difflineplus">+});</span>
<a href="#l156.91"></a><span id="l156.91"> </span>
<a href="#l156.92"></a><span id="l156.92" class="difflineminus">-function test_one_message_selected() {</span>
<a href="#l156.93"></a><span id="l156.93" class="difflineplus">+add_task(function test_one_message_selected() {</span>
<a href="#l156.94"></a><span id="l156.94">   be_in_folder(folder);</span>
<a href="#l156.95"></a><span id="l156.95"> </span>
<a href="#l156.96"></a><span id="l156.96">   // Select a message</span>
<a href="#l156.97"></a><span id="l156.97">   select_click_row(0);</span>
<a href="#l156.98"></a><span id="l156.98">   check_pane_cycling(false);</span>
<a href="#l156.99"></a><span id="l156.99" class="difflineminus">-}</span>
<a href="#l156.100"></a><span id="l156.100" class="difflineplus">+});</span>
<a href="#l156.101"></a><span id="l156.101"> </span>
<a href="#l156.102"></a><span id="l156.102" class="difflineminus">-function test_n_messages_selected() {</span>
<a href="#l156.103"></a><span id="l156.103" class="difflineplus">+add_task(function test_n_messages_selected() {</span>
<a href="#l156.104"></a><span id="l156.104">   be_in_folder(folder);</span>
<a href="#l156.105"></a><span id="l156.105"> </span>
<a href="#l156.106"></a><span id="l156.106">   // Select a thread</span>
<a href="#l156.107"></a><span id="l156.107">   select_click_row(1);</span>
<a href="#l156.108"></a><span id="l156.108">   check_pane_cycling(true);</span>
<a href="#l156.109"></a><span id="l156.109" class="difflineminus">-}</span>
<a href="#l156.110"></a><span id="l156.110" class="difflineplus">+});</span>
<a href="#l156.111"></a><span id="l156.111"> </span>
<a href="#l156.112"></a><span id="l156.112" class="difflineminus">-function test_between_tab_and_single_message() {</span>
<a href="#l156.113"></a><span id="l156.113" class="difflineplus">+add_task(function test_between_tab_and_single_message() {</span>
<a href="#l156.114"></a><span id="l156.114">   be_in_folder(folder);</span>
<a href="#l156.115"></a><span id="l156.115">   select_click_row(0);</span>
<a href="#l156.116"></a><span id="l156.116">   let tab = open_selected_message_in_new_tab(true);</span>
<a href="#l156.117"></a><span id="l156.117"> </span>
<a href="#l156.118"></a><span id="l156.118">   select_click_row(2);</span>
<a href="#l156.119"></a><span id="l156.119"> </span>
<a href="#l156.120"></a><span id="l156.120">   // First, try swapping back and forth between the tabs when the message</span>
<a href="#l156.121"></a><span id="l156.121">   // pane is focused.</span>
<a href="#l156.122"></a><span id="l156.122">   mc.window.SetFocusMessagePane();</span>
<a href="#l156.123"></a><span id="l156.123"> </span>
<a href="#l156.124"></a><span id="l156.124">   switch_tab(tab);</span>
<a href="#l156.125"></a><span id="l156.125" class="difflineminus">-  assert_equals(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.126"></a><span id="l156.126" class="difflineplus">+  Assert.equal(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.127"></a><span id="l156.127"> </span>
<a href="#l156.128"></a><span id="l156.128">   switch_tab();</span>
<a href="#l156.129"></a><span id="l156.129" class="difflineminus">-  assert_equals(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.130"></a><span id="l156.130" class="difflineplus">+  Assert.equal(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.131"></a><span id="l156.131"> </span>
<a href="#l156.132"></a><span id="l156.132">   switch_tab(tab);</span>
<a href="#l156.133"></a><span id="l156.133" class="difflineminus">-  assert_equals(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.134"></a><span id="l156.134" class="difflineplus">+  Assert.equal(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.135"></a><span id="l156.135"> </span>
<a href="#l156.136"></a><span id="l156.136">   switch_tab();</span>
<a href="#l156.137"></a><span id="l156.137" class="difflineminus">-  assert_equals(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.138"></a><span id="l156.138" class="difflineplus">+  Assert.equal(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.139"></a><span id="l156.139"> </span>
<a href="#l156.140"></a><span id="l156.140">   // Now, focus the folder tree and make sure focus updates properly.</span>
<a href="#l156.141"></a><span id="l156.141">   mc.e(&quot;folderTree&quot;).focus();</span>
<a href="#l156.142"></a><span id="l156.142"> </span>
<a href="#l156.143"></a><span id="l156.143">   switch_tab(tab);</span>
<a href="#l156.144"></a><span id="l156.144" class="difflineminus">-  assert_equals(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.145"></a><span id="l156.145" class="difflineplus">+  Assert.equal(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.146"></a><span id="l156.146"> </span>
<a href="#l156.147"></a><span id="l156.147">   switch_tab();</span>
<a href="#l156.148"></a><span id="l156.148" class="difflineminus">-  assert_equals(mc.e(&quot;folderTree&quot;), get_focused_pane());</span>
<a href="#l156.149"></a><span id="l156.149" class="difflineplus">+  Assert.equal(mc.e(&quot;folderTree&quot;), get_focused_pane());</span>
<a href="#l156.150"></a><span id="l156.150"> </span>
<a href="#l156.151"></a><span id="l156.151">   close_tab(tab);</span>
<a href="#l156.152"></a><span id="l156.152" class="difflineminus">-}</span>
<a href="#l156.153"></a><span id="l156.153" class="difflineplus">+});</span>
<a href="#l156.154"></a><span id="l156.154"> </span>
<a href="#l156.155"></a><span id="l156.155" class="difflineminus">-function test_between_tab_and_multi_message() {</span>
<a href="#l156.156"></a><span id="l156.156" class="difflineplus">+add_task(function test_between_tab_and_multi_message() {</span>
<a href="#l156.157"></a><span id="l156.157">   be_in_folder(folder);</span>
<a href="#l156.158"></a><span id="l156.158">   select_click_row(0);</span>
<a href="#l156.159"></a><span id="l156.159">   let tab = open_selected_message_in_new_tab(true);</span>
<a href="#l156.160"></a><span id="l156.160"> </span>
<a href="#l156.161"></a><span id="l156.161">   select_click_row(1);</span>
<a href="#l156.162"></a><span id="l156.162"> </span>
<a href="#l156.163"></a><span id="l156.163">   // First, try swapping back and forth between the tabs when the message</span>
<a href="#l156.164"></a><span id="l156.164">   // pane is focused.</span>
<a href="#l156.165"></a><span id="l156.165">   mc.window.SetFocusMessagePane();</span>
<a href="#l156.166"></a><span id="l156.166"> </span>
<a href="#l156.167"></a><span id="l156.167">   switch_tab(tab);</span>
<a href="#l156.168"></a><span id="l156.168" class="difflineminus">-  assert_equals(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.169"></a><span id="l156.169" class="difflineplus">+  Assert.equal(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.170"></a><span id="l156.170"> </span>
<a href="#l156.171"></a><span id="l156.171">   switch_tab();</span>
<a href="#l156.172"></a><span id="l156.172" class="difflineminus">-  assert_equals(mc.e(&quot;multimessage&quot;), get_focused_pane());</span>
<a href="#l156.173"></a><span id="l156.173" class="difflineplus">+  Assert.equal(mc.e(&quot;multimessage&quot;), get_focused_pane());</span>
<a href="#l156.174"></a><span id="l156.174"> </span>
<a href="#l156.175"></a><span id="l156.175">   switch_tab(tab);</span>
<a href="#l156.176"></a><span id="l156.176" class="difflineminus">-  assert_equals(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.177"></a><span id="l156.177" class="difflineplus">+  Assert.equal(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.178"></a><span id="l156.178"> </span>
<a href="#l156.179"></a><span id="l156.179">   switch_tab();</span>
<a href="#l156.180"></a><span id="l156.180" class="difflineminus">-  assert_equals(mc.e(&quot;multimessage&quot;), get_focused_pane());</span>
<a href="#l156.181"></a><span id="l156.181" class="difflineplus">+  Assert.equal(mc.e(&quot;multimessage&quot;), get_focused_pane());</span>
<a href="#l156.182"></a><span id="l156.182"> </span>
<a href="#l156.183"></a><span id="l156.183">   // Now, focus the folder tree and make sure focus updates properly.</span>
<a href="#l156.184"></a><span id="l156.184">   mc.e(&quot;folderTree&quot;).focus();</span>
<a href="#l156.185"></a><span id="l156.185"> </span>
<a href="#l156.186"></a><span id="l156.186">   switch_tab(tab);</span>
<a href="#l156.187"></a><span id="l156.187" class="difflineminus">-  assert_equals(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.188"></a><span id="l156.188" class="difflineplus">+  Assert.equal(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.189"></a><span id="l156.189"> </span>
<a href="#l156.190"></a><span id="l156.190">   switch_tab();</span>
<a href="#l156.191"></a><span id="l156.191" class="difflineminus">-  assert_equals(mc.e(&quot;folderTree&quot;), get_focused_pane());</span>
<a href="#l156.192"></a><span id="l156.192" class="difflineplus">+  Assert.equal(mc.e(&quot;folderTree&quot;), get_focused_pane());</span>
<a href="#l156.193"></a><span id="l156.193"> </span>
<a href="#l156.194"></a><span id="l156.194">   close_tab(tab);</span>
<a href="#l156.195"></a><span id="l156.195" class="difflineminus">-}</span>
<a href="#l156.196"></a><span id="l156.196" class="difflineplus">+});</span>
<a href="#l156.197"></a><span id="l156.197"> </span>
<a href="#l156.198"></a><span id="l156.198" class="difflineminus">-function test_after_delete() {</span>
<a href="#l156.199"></a><span id="l156.199" class="difflineplus">+add_task(function test_after_delete() {</span>
<a href="#l156.200"></a><span id="l156.200">   be_in_folder(folder);</span>
<a href="#l156.201"></a><span id="l156.201">   make_display_threaded();</span>
<a href="#l156.202"></a><span id="l156.202">   collapse_all_threads();</span>
<a href="#l156.203"></a><span id="l156.203"> </span>
<a href="#l156.204"></a><span id="l156.204">   // Select a message, then delete it to move to the thread</span>
<a href="#l156.205"></a><span id="l156.205">   select_click_row(0);</span>
<a href="#l156.206"></a><span id="l156.206">   mc.window.SetFocusMessagePane();</span>
<a href="#l156.207"></a><span id="l156.207">   press_delete();</span>
<a href="#l156.208"></a><span id="l156.208"> </span>
<a href="#l156.209"></a><span id="l156.209" class="difflineminus">-  assert_equals(mc.e(&quot;multimessage&quot;), get_focused_pane());</span>
<a href="#l156.210"></a><span id="l156.210" class="difflineplus">+  Assert.equal(mc.e(&quot;multimessage&quot;), get_focused_pane());</span>
<a href="#l156.211"></a><span id="l156.211"> </span>
<a href="#l156.212"></a><span id="l156.212">   // Delete the thread (without warning) to move to a message</span>
<a href="#l156.213"></a><span id="l156.213">   Services.prefs.setBoolPref(&quot;mail.warn_on_collapsed_thread_operation&quot;, false);</span>
<a href="#l156.214"></a><span id="l156.214">   press_delete();</span>
<a href="#l156.215"></a><span id="l156.215"> </span>
<a href="#l156.216"></a><span id="l156.216" class="difflineminus">-  assert_equals(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.217"></a><span id="l156.217" class="difflineminus">-}</span>
<a href="#l156.218"></a><span id="l156.218" class="difflineplus">+  Assert.equal(mc.e(&quot;messagepane&quot;), get_focused_pane());</span>
<a href="#l156.219"></a><span id="l156.219" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l157.1"></a><span id="l157.1">copy from mail/test/mozmill/folder-display/test-recent-menu.js</span>
<a href="#l157.2"></a><span id="l157.2">copy to mail/test/browser/folder-display/browser_recentMenu.js</span>
<a href="#l157.3"></a><span id="l157.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-recent-menu.js</span>
<a href="#l157.4"></a><span id="l157.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_recentMenu.js</span>
<a href="#l157.5"></a><span id="l157.5" class="difflineat">@@ -7,17 +7,16 @@</span>
<a href="#l157.6"></a><span id="l157.6">  * that they get updated when messages are moved to folders, and</span>
<a href="#l157.7"></a><span id="l157.7">  * don't get updated when we archive.</span>
<a href="#l157.8"></a><span id="l157.8">  */</span>
<a href="#l157.9"></a><span id="l157.9"> </span>
<a href="#l157.10"></a><span id="l157.10"> &quot;use strict&quot;;</span>
<a href="#l157.11"></a><span id="l157.11"> </span>
<a href="#l157.12"></a><span id="l157.12"> var {</span>
<a href="#l157.13"></a><span id="l157.13">   archive_selected_messages,</span>
<a href="#l157.14"></a><span id="l157.14" class="difflineminus">-  assert_equals,</span>
<a href="#l157.15"></a><span id="l157.15">   be_in_folder,</span>
<a href="#l157.16"></a><span id="l157.16">   create_folder,</span>
<a href="#l157.17"></a><span id="l157.17">   get_special_folder,</span>
<a href="#l157.18"></a><span id="l157.18">   make_new_sets_in_folder,</span>
<a href="#l157.19"></a><span id="l157.19">   mc,</span>
<a href="#l157.20"></a><span id="l157.20">   press_delete,</span>
<a href="#l157.21"></a><span id="l157.21">   right_click_on_row,</span>
<a href="#l157.22"></a><span id="l157.22">   select_click_row,</span>
<a href="#l157.23"></a><span id="l157.23" class="difflineat">@@ -31,46 +30,46 @@ var { MailServices } = ChromeUtils.impor</span>
<a href="#l157.24"></a><span id="l157.24"> );</span>
<a href="#l157.25"></a><span id="l157.25"> var { fixIterator } = ChromeUtils.import(</span>
<a href="#l157.26"></a><span id="l157.26">   &quot;resource:///modules/iteratorUtils.jsm&quot;</span>
<a href="#l157.27"></a><span id="l157.27"> );</span>
<a href="#l157.28"></a><span id="l157.28"> </span>
<a href="#l157.29"></a><span id="l157.29"> var folder1, folder2;</span>
<a href="#l157.30"></a><span id="l157.30"> var gInitRecentMenuCount;</span>
<a href="#l157.31"></a><span id="l157.31"> </span>
<a href="#l157.32"></a><span id="l157.32" class="difflineminus">-var setupModule = function(module) {</span>
<a href="#l157.33"></a><span id="l157.33" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l157.34"></a><span id="l157.34">   // Ensure that there are no updated folders to ensure the recent folder</span>
<a href="#l157.35"></a><span id="l157.35">   // is empty.</span>
<a href="#l157.36"></a><span id="l157.36">   let allFolders = MailServices.accounts.allFolders;</span>
<a href="#l157.37"></a><span id="l157.37">   for (let folder of fixIterator(allFolders, Ci.nsIMsgFolder)) {</span>
<a href="#l157.38"></a><span id="l157.38">     folder.setStringProperty(&quot;MRMTime&quot;, &quot;0&quot;);</span>
<a href="#l157.39"></a><span id="l157.39">   }</span>
<a href="#l157.40"></a><span id="l157.40"> </span>
<a href="#l157.41"></a><span id="l157.41">   // Try to make these folders first in alphabetic order</span>
<a href="#l157.42"></a><span id="l157.42">   folder1 = create_folder(&quot;aaafolder1&quot;);</span>
<a href="#l157.43"></a><span id="l157.43">   folder2 = create_folder(&quot;aaafolder2&quot;);</span>
<a href="#l157.44"></a><span id="l157.44"> </span>
<a href="#l157.45"></a><span id="l157.45">   make_new_sets_in_folder(folder1, [{ count: 3 }]);</span>
<a href="#l157.46"></a><span id="l157.46" class="difflineminus">-};</span>
<a href="#l157.47"></a><span id="l157.47" class="difflineplus">+});</span>
<a href="#l157.48"></a><span id="l157.48"> </span>
<a href="#l157.49"></a><span id="l157.49" class="difflineminus">-function test_move_message() {</span>
<a href="#l157.50"></a><span id="l157.50" class="difflineplus">+add_task(function test_move_message() {</span>
<a href="#l157.51"></a><span id="l157.51">   be_in_folder(folder1);</span>
<a href="#l157.52"></a><span id="l157.52">   let msgHdr = select_click_row(0);</span>
<a href="#l157.53"></a><span id="l157.53">   // This will cause the initial build of the move recent context menu,</span>
<a href="#l157.54"></a><span id="l157.54">   // which should be empty and disabled.</span>
<a href="#l157.55"></a><span id="l157.55">   right_click_on_row(0);</span>
<a href="#l157.56"></a><span id="l157.56">   let popups = mc.click_menus_in_sequence(</span>
<a href="#l157.57"></a><span id="l157.57">     mc.e(&quot;mailContext&quot;),</span>
<a href="#l157.58"></a><span id="l157.58">     [{ id: &quot;mailContext-moveMenu&quot; }, { label: &quot;Recent&quot; }],</span>
<a href="#l157.59"></a><span id="l157.59">     true</span>
<a href="#l157.60"></a><span id="l157.60">   );</span>
<a href="#l157.61"></a><span id="l157.61">   let recentMenu = popups[popups.length - 2].querySelector('[label=&quot;Recent&quot;]');</span>
<a href="#l157.62"></a><span id="l157.62" class="difflineminus">-  assert_equals(recentMenu.getAttribute(&quot;disabled&quot;), &quot;true&quot;);</span>
<a href="#l157.63"></a><span id="l157.63" class="difflineplus">+  Assert.equal(recentMenu.getAttribute(&quot;disabled&quot;), &quot;true&quot;);</span>
<a href="#l157.64"></a><span id="l157.64">   gInitRecentMenuCount = recentMenu.itemCount;</span>
<a href="#l157.65"></a><span id="l157.65" class="difflineminus">-  assert_equals(gInitRecentMenuCount, 0);</span>
<a href="#l157.66"></a><span id="l157.66" class="difflineplus">+  Assert.equal(gInitRecentMenuCount, 0);</span>
<a href="#l157.67"></a><span id="l157.67">   mc.close_popup_sequence(popups);</span>
<a href="#l157.68"></a><span id="l157.68">   let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l157.69"></a><span id="l157.69">   array.appendElement(msgHdr);</span>
<a href="#l157.70"></a><span id="l157.70">   let copyListener = {</span>
<a href="#l157.71"></a><span id="l157.71">     copyDone: false,</span>
<a href="#l157.72"></a><span id="l157.72">     OnStartCopy() {},</span>
<a href="#l157.73"></a><span id="l157.73">     OnProgress(aProgress, aProgressMax) {},</span>
<a href="#l157.74"></a><span id="l157.74">     SetMessageKey(aKey) {},</span>
<a href="#l157.75"></a><span id="l157.75" class="difflineat">@@ -99,69 +98,69 @@ function test_move_message() {</span>
<a href="#l157.76"></a><span id="l157.76">   // id we can use.</span>
<a href="#l157.77"></a><span id="l157.77">   right_click_on_row(0);</span>
<a href="#l157.78"></a><span id="l157.78">   popups = mc.click_menus_in_sequence(</span>
<a href="#l157.79"></a><span id="l157.79">     mc.e(&quot;mailContext&quot;),</span>
<a href="#l157.80"></a><span id="l157.80">     [{ id: &quot;mailContext-moveMenu&quot; }, { label: &quot;Recent&quot; }],</span>
<a href="#l157.81"></a><span id="l157.81">     true</span>
<a href="#l157.82"></a><span id="l157.82">   );</span>
<a href="#l157.83"></a><span id="l157.83">   let recentChildren = popups[popups.length - 1].children;</span>
<a href="#l157.84"></a><span id="l157.84" class="difflineminus">-  assert_equals(</span>
<a href="#l157.85"></a><span id="l157.85" class="difflineplus">+  Assert.equal(</span>
<a href="#l157.86"></a><span id="l157.86">     recentChildren.length,</span>
<a href="#l157.87"></a><span id="l157.87">     gInitRecentMenuCount + 1,</span>
<a href="#l157.88"></a><span id="l157.88">     &quot;recent menu should have one more child after move&quot;</span>
<a href="#l157.89"></a><span id="l157.89">   );</span>
<a href="#l157.90"></a><span id="l157.90" class="difflineminus">-  assert_equals(</span>
<a href="#l157.91"></a><span id="l157.91" class="difflineplus">+  Assert.equal(</span>
<a href="#l157.92"></a><span id="l157.92">     recentChildren[0].label,</span>
<a href="#l157.93"></a><span id="l157.93">     &quot;aaafolder2&quot;,</span>
<a href="#l157.94"></a><span id="l157.94">     &quot;recent menu child should be aaafolder2 after move&quot;</span>
<a href="#l157.95"></a><span id="l157.95">   );</span>
<a href="#l157.96"></a><span id="l157.96">   mc.close_popup_sequence(popups);</span>
<a href="#l157.97"></a><span id="l157.97" class="difflineminus">-}</span>
<a href="#l157.98"></a><span id="l157.98" class="difflineplus">+});</span>
<a href="#l157.99"></a><span id="l157.99"> </span>
<a href="#l157.100"></a><span id="l157.100" class="difflineminus">-function test_delete_message() {</span>
<a href="#l157.101"></a><span id="l157.101" class="difflineplus">+add_task(function test_delete_message() {</span>
<a href="#l157.102"></a><span id="l157.102">   press_delete(mc);</span>
<a href="#l157.103"></a><span id="l157.103">   // We've deleted a message - we should still just have folder2 in the menu.</span>
<a href="#l157.104"></a><span id="l157.104">   right_click_on_row(0);</span>
<a href="#l157.105"></a><span id="l157.105">   let popups = mc.click_menus_in_sequence(</span>
<a href="#l157.106"></a><span id="l157.106">     mc.e(&quot;mailContext&quot;),</span>
<a href="#l157.107"></a><span id="l157.107">     [{ id: &quot;mailContext-moveMenu&quot; }, { label: &quot;Recent&quot; }],</span>
<a href="#l157.108"></a><span id="l157.108">     true</span>
<a href="#l157.109"></a><span id="l157.109">   );</span>
<a href="#l157.110"></a><span id="l157.110">   let recentChildren = popups[popups.length - 1].children;</span>
<a href="#l157.111"></a><span id="l157.111" class="difflineminus">-  assert_equals(</span>
<a href="#l157.112"></a><span id="l157.112" class="difflineplus">+  Assert.equal(</span>
<a href="#l157.113"></a><span id="l157.113">     recentChildren.length,</span>
<a href="#l157.114"></a><span id="l157.114">     gInitRecentMenuCount + 1,</span>
<a href="#l157.115"></a><span id="l157.115">     &quot;delete shouldn't add anything to recent menu&quot;</span>
<a href="#l157.116"></a><span id="l157.116">   );</span>
<a href="#l157.117"></a><span id="l157.117" class="difflineminus">-  assert_equals(</span>
<a href="#l157.118"></a><span id="l157.118" class="difflineplus">+  Assert.equal(</span>
<a href="#l157.119"></a><span id="l157.119">     recentChildren[0].label,</span>
<a href="#l157.120"></a><span id="l157.120">     &quot;aaafolder2&quot;,</span>
<a href="#l157.121"></a><span id="l157.121">     &quot;recent menu should still be aaafolder2 after delete&quot;</span>
<a href="#l157.122"></a><span id="l157.122">   );</span>
<a href="#l157.123"></a><span id="l157.123">   mc.close_popup_sequence(popups);</span>
<a href="#l157.124"></a><span id="l157.124" class="difflineminus">-}</span>
<a href="#l157.125"></a><span id="l157.125" class="difflineplus">+});</span>
<a href="#l157.126"></a><span id="l157.126"> </span>
<a href="#l157.127"></a><span id="l157.127" class="difflineminus">-function test_archive_message() {</span>
<a href="#l157.128"></a><span id="l157.128" class="difflineplus">+add_task(function test_archive_message() {</span>
<a href="#l157.129"></a><span id="l157.129">   archive_selected_messages();</span>
<a href="#l157.130"></a><span id="l157.130">   // We've archived a message - we should still just have folder2 in the menu.</span>
<a href="#l157.131"></a><span id="l157.131">   let archive = get_special_folder(Ci.nsMsgFolderFlags.Archive, false, false);</span>
<a href="#l157.132"></a><span id="l157.132">   let archives = archive.descendants;</span>
<a href="#l157.133"></a><span id="l157.133">   be_in_folder(archives.queryElementAt(0, Ci.nsIMsgFolder));</span>
<a href="#l157.134"></a><span id="l157.134">   right_click_on_row(0);</span>
<a href="#l157.135"></a><span id="l157.135">   let popups = mc.click_menus_in_sequence(</span>
<a href="#l157.136"></a><span id="l157.136">     mc.e(&quot;mailContext&quot;),</span>
<a href="#l157.137"></a><span id="l157.137">     [{ id: &quot;mailContext-moveMenu&quot; }, { label: &quot;Recent&quot; }],</span>
<a href="#l157.138"></a><span id="l157.138">     true</span>
<a href="#l157.139"></a><span id="l157.139">   );</span>
<a href="#l157.140"></a><span id="l157.140">   let recentChildren = popups[popups.length - 1].children;</span>
<a href="#l157.141"></a><span id="l157.141" class="difflineminus">-  assert_equals(</span>
<a href="#l157.142"></a><span id="l157.142" class="difflineplus">+  Assert.equal(</span>
<a href="#l157.143"></a><span id="l157.143">     recentChildren.length,</span>
<a href="#l157.144"></a><span id="l157.144">     gInitRecentMenuCount + 1,</span>
<a href="#l157.145"></a><span id="l157.145">     &quot;archive shouldn't add anything to recent menu&quot;</span>
<a href="#l157.146"></a><span id="l157.146">   );</span>
<a href="#l157.147"></a><span id="l157.147" class="difflineminus">-  assert_equals(</span>
<a href="#l157.148"></a><span id="l157.148" class="difflineplus">+  Assert.equal(</span>
<a href="#l157.149"></a><span id="l157.149">     recentChildren[0].label,</span>
<a href="#l157.150"></a><span id="l157.150">     &quot;aaafolder2&quot;,</span>
<a href="#l157.151"></a><span id="l157.151">     &quot;recent menu should still be aaafolder2 after archive&quot;</span>
<a href="#l157.152"></a><span id="l157.152">   );</span>
<a href="#l157.153"></a><span id="l157.153">   mc.close_popup_sequence(popups);</span>
<a href="#l157.154"></a><span id="l157.154" class="difflineminus">-}</span>
<a href="#l157.155"></a><span id="l157.155" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l158.1"></a><span id="l158.1">copy from mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js</span>
<a href="#l158.2"></a><span id="l158.2">copy to mail/test/browser/folder-display/browser_rightClickMiddleClickFolders.js</span>
<a href="#l158.3"></a><span id="l158.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-right-click-middle-click-folders.js</span>
<a href="#l158.4"></a><span id="l158.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_rightClickMiddleClickFolders.js</span>
<a href="#l158.5"></a><span id="l158.5" class="difflineat">@@ -31,109 +31,109 @@ var {</span>
<a href="#l158.6"></a><span id="l158.6">   set_context_menu_background_tabs,</span>
<a href="#l158.7"></a><span id="l158.7">   switch_tab,</span>
<a href="#l158.8"></a><span id="l158.8"> } = ChromeUtils.import(</span>
<a href="#l158.9"></a><span id="l158.9">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l158.10"></a><span id="l158.10"> );</span>
<a href="#l158.11"></a><span id="l158.11"> </span>
<a href="#l158.12"></a><span id="l158.12"> var folderA, folderB, folderC;</span>
<a href="#l158.13"></a><span id="l158.13"> </span>
<a href="#l158.14"></a><span id="l158.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l158.15"></a><span id="l158.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l158.16"></a><span id="l158.16">   folderA = create_folder(&quot;RightClickMiddleClickFoldersA&quot;);</span>
<a href="#l158.17"></a><span id="l158.17">   folderB = create_folder(&quot;RightClickMiddleClickFoldersB&quot;);</span>
<a href="#l158.18"></a><span id="l158.18">   folderC = create_folder(&quot;RightClickMiddleClickFoldersC&quot;);</span>
<a href="#l158.19"></a><span id="l158.19"> </span>
<a href="#l158.20"></a><span id="l158.20">   // We aren't really interested in the messages the folders contain, but just</span>
<a href="#l158.21"></a><span id="l158.21">   // for appearance's sake, add a message to each folder</span>
<a href="#l158.22"></a><span id="l158.22"> </span>
<a href="#l158.23"></a><span id="l158.23">   make_new_sets_in_folder(folderA, [{ count: 1 }]);</span>
<a href="#l158.24"></a><span id="l158.24">   make_new_sets_in_folder(folderB, [{ count: 1 }]);</span>
<a href="#l158.25"></a><span id="l158.25">   make_new_sets_in_folder(folderC, [{ count: 1 }]);</span>
<a href="#l158.26"></a><span id="l158.26" class="difflineminus">-}</span>
<a href="#l158.27"></a><span id="l158.27" class="difflineplus">+});</span>
<a href="#l158.28"></a><span id="l158.28"> </span>
<a href="#l158.29"></a><span id="l158.29"> /**</span>
<a href="#l158.30"></a><span id="l158.30">  * Make sure that a right-click when there is nothing currently selected does</span>
<a href="#l158.31"></a><span id="l158.31">  *  not cause us to display something, as well as correctly causing a transient</span>
<a href="#l158.32"></a><span id="l158.32">  *  selection to occur.</span>
<a href="#l158.33"></a><span id="l158.33">  */</span>
<a href="#l158.34"></a><span id="l158.34" class="difflineminus">-function test_right_click_folder_with_nothing_selected() {</span>
<a href="#l158.35"></a><span id="l158.35" class="difflineplus">+add_task(function test_right_click_folder_with_nothing_selected() {</span>
<a href="#l158.36"></a><span id="l158.36">   // This should cause folderA to be displayed</span>
<a href="#l158.37"></a><span id="l158.37">   be_in_folder(folderA);</span>
<a href="#l158.38"></a><span id="l158.38"> </span>
<a href="#l158.39"></a><span id="l158.39">   select_no_folders();</span>
<a href="#l158.40"></a><span id="l158.40">   assert_no_folders_selected();</span>
<a href="#l158.41"></a><span id="l158.41"> </span>
<a href="#l158.42"></a><span id="l158.42">   right_click_on_folder(folderB);</span>
<a href="#l158.43"></a><span id="l158.43">   assert_folder_selected(folderB);</span>
<a href="#l158.44"></a><span id="l158.44">   // The displayed folder shouldn't change</span>
<a href="#l158.45"></a><span id="l158.45">   assert_folder_displayed(folderA);</span>
<a href="#l158.46"></a><span id="l158.46"> </span>
<a href="#l158.47"></a><span id="l158.47">   close_popup(mc, mc.eid(&quot;folderPaneContext&quot;));</span>
<a href="#l158.48"></a><span id="l158.48">   assert_no_folders_selected();</span>
<a href="#l158.49"></a><span id="l158.49" class="difflineminus">-}</span>
<a href="#l158.50"></a><span id="l158.50" class="difflineplus">+});</span>
<a href="#l158.51"></a><span id="l158.51"> </span>
<a href="#l158.52"></a><span id="l158.52"> /**</span>
<a href="#l158.53"></a><span id="l158.53">  * One-thing selected, right-click on something else.</span>
<a href="#l158.54"></a><span id="l158.54">  */</span>
<a href="#l158.55"></a><span id="l158.55" class="difflineminus">-function test_right_click_folder_with_one_thing_selected() {</span>
<a href="#l158.56"></a><span id="l158.56" class="difflineplus">+add_task(function test_right_click_folder_with_one_thing_selected() {</span>
<a href="#l158.57"></a><span id="l158.57">   select_click_folder(folderB);</span>
<a href="#l158.58"></a><span id="l158.58">   assert_folder_selected_and_displayed(folderB);</span>
<a href="#l158.59"></a><span id="l158.59"> </span>
<a href="#l158.60"></a><span id="l158.60">   right_click_on_folder(folderA);</span>
<a href="#l158.61"></a><span id="l158.61">   assert_folder_selected(folderA);</span>
<a href="#l158.62"></a><span id="l158.62">   assert_folder_displayed(folderB);</span>
<a href="#l158.63"></a><span id="l158.63"> </span>
<a href="#l158.64"></a><span id="l158.64">   close_popup(mc, mc.eid(&quot;folderPaneContext&quot;));</span>
<a href="#l158.65"></a><span id="l158.65">   assert_folder_selected_and_displayed(folderB);</span>
<a href="#l158.66"></a><span id="l158.66" class="difflineminus">-}</span>
<a href="#l158.67"></a><span id="l158.67" class="difflineplus">+});</span>
<a href="#l158.68"></a><span id="l158.68"> </span>
<a href="#l158.69"></a><span id="l158.69"> /**</span>
<a href="#l158.70"></a><span id="l158.70">  * Many things selected, right-click on something that is not in that selection.</span>
<a href="#l158.71"></a><span id="l158.71">  */</span>
<a href="#l158.72"></a><span id="l158.72" class="difflineminus">-function test_right_click_folder_with_many_things_selected() {</span>
<a href="#l158.73"></a><span id="l158.73" class="difflineplus">+add_task(function test_right_click_folder_with_many_things_selected() {</span>
<a href="#l158.74"></a><span id="l158.74">   select_click_folder(folderA);</span>
<a href="#l158.75"></a><span id="l158.75">   select_shift_click_folder(folderB);</span>
<a href="#l158.76"></a><span id="l158.76">   assert_folders_selected_and_displayed(folderA, folderB);</span>
<a href="#l158.77"></a><span id="l158.77"> </span>
<a href="#l158.78"></a><span id="l158.78">   right_click_on_folder(folderC);</span>
<a href="#l158.79"></a><span id="l158.79">   assert_folder_selected(folderC);</span>
<a href="#l158.80"></a><span id="l158.80">   assert_folder_displayed(folderA);</span>
<a href="#l158.81"></a><span id="l158.81"> </span>
<a href="#l158.82"></a><span id="l158.82">   close_popup(mc, mc.eid(&quot;folderPaneContext&quot;));</span>
<a href="#l158.83"></a><span id="l158.83">   assert_folders_selected_and_displayed(folderA, folderB);</span>
<a href="#l158.84"></a><span id="l158.84" class="difflineminus">-}</span>
<a href="#l158.85"></a><span id="l158.85" class="difflineplus">+});</span>
<a href="#l158.86"></a><span id="l158.86"> </span>
<a href="#l158.87"></a><span id="l158.87"> /**</span>
<a href="#l158.88"></a><span id="l158.88">  * One thing selected, right-click on that.</span>
<a href="#l158.89"></a><span id="l158.89">  */</span>
<a href="#l158.90"></a><span id="l158.90" class="difflineminus">-function test_right_click_folder_on_existing_single_selection() {</span>
<a href="#l158.91"></a><span id="l158.91" class="difflineplus">+add_task(function test_right_click_folder_on_existing_single_selection() {</span>
<a href="#l158.92"></a><span id="l158.92">   select_click_folder(folderA);</span>
<a href="#l158.93"></a><span id="l158.93">   assert_folders_selected_and_displayed(folderA);</span>
<a href="#l158.94"></a><span id="l158.94"> </span>
<a href="#l158.95"></a><span id="l158.95">   right_click_on_folder(folderA);</span>
<a href="#l158.96"></a><span id="l158.96">   assert_folders_selected_and_displayed(folderA);</span>
<a href="#l158.97"></a><span id="l158.97"> </span>
<a href="#l158.98"></a><span id="l158.98">   close_popup(mc, mc.eid(&quot;folderPaneContext&quot;));</span>
<a href="#l158.99"></a><span id="l158.99">   assert_folders_selected_and_displayed(folderA);</span>
<a href="#l158.100"></a><span id="l158.100" class="difflineminus">-}</span>
<a href="#l158.101"></a><span id="l158.101" class="difflineplus">+});</span>
<a href="#l158.102"></a><span id="l158.102"> </span>
<a href="#l158.103"></a><span id="l158.103"> /**</span>
<a href="#l158.104"></a><span id="l158.104">  * Many things selected, right-click somewhere in the selection.</span>
<a href="#l158.105"></a><span id="l158.105">  */</span>
<a href="#l158.106"></a><span id="l158.106" class="difflineminus">-function test_right_click_folder_on_existing_multi_selection() {</span>
<a href="#l158.107"></a><span id="l158.107" class="difflineplus">+add_task(function test_right_click_folder_on_existing_multi_selection() {</span>
<a href="#l158.108"></a><span id="l158.108">   select_click_folder(folderB);</span>
<a href="#l158.109"></a><span id="l158.109">   select_shift_click_folder(folderC);</span>
<a href="#l158.110"></a><span id="l158.110">   assert_folders_selected_and_displayed(folderB, folderC);</span>
<a href="#l158.111"></a><span id="l158.111"> </span>
<a href="#l158.112"></a><span id="l158.112">   right_click_on_folder(folderC);</span>
<a href="#l158.113"></a><span id="l158.113">   assert_folders_selected_and_displayed(folderB, folderC);</span>
<a href="#l158.114"></a><span id="l158.114"> </span>
<a href="#l158.115"></a><span id="l158.115">   close_popup(mc, mc.eid(&quot;folderPaneContext&quot;));</span>
<a href="#l158.116"></a><span id="l158.116">   assert_folders_selected_and_displayed(folderB, folderC);</span>
<a href="#l158.117"></a><span id="l158.117" class="difflineminus">-}</span>
<a href="#l158.118"></a><span id="l158.118" class="difflineplus">+});</span>
<a href="#l158.119"></a><span id="l158.119"> </span>
<a href="#l158.120"></a><span id="l158.120"> /**</span>
<a href="#l158.121"></a><span id="l158.121">  * Middle clicking should open a message in a tab, but not affect our selection.</span>
<a href="#l158.122"></a><span id="l158.122">  */</span>
<a href="#l158.123"></a><span id="l158.123"> function _middle_click_folder_with_nothing_selected_helper(aBackground) {</span>
<a href="#l158.124"></a><span id="l158.124">   // This should cause folderA to be displayed</span>
<a href="#l158.125"></a><span id="l158.125">   be_in_folder(folderA);</span>
<a href="#l158.126"></a><span id="l158.126"> </span>
<a href="#l158.127"></a><span id="l158.127" class="difflineat">@@ -258,17 +258,28 @@ function _generate_background_foreground</span>
<a href="#l158.128"></a><span id="l158.128">       helperFunc(true);</span>
<a href="#l158.129"></a><span id="l158.129">       reset_context_menu_background_tabs();</span>
<a href="#l158.130"></a><span id="l158.130">     };</span>
<a href="#l158.131"></a><span id="l158.131">     global[&quot;test_&quot; + test + &quot;_foreground&quot;] = function() {</span>
<a href="#l158.132"></a><span id="l158.132">       set_context_menu_background_tabs(false);</span>
<a href="#l158.133"></a><span id="l158.133">       helperFunc(false);</span>
<a href="#l158.134"></a><span id="l158.134">       reset_context_menu_background_tabs();</span>
<a href="#l158.135"></a><span id="l158.135">     };</span>
<a href="#l158.136"></a><span id="l158.136" class="difflineplus">+    add_task(global[`test_${test}_background`]);</span>
<a href="#l158.137"></a><span id="l158.137" class="difflineplus">+    add_task(global[`test_${test}_foreground`]);</span>
<a href="#l158.138"></a><span id="l158.138">   }</span>
<a href="#l158.139"></a><span id="l158.139"> }</span>
<a href="#l158.140"></a><span id="l158.140"> </span>
<a href="#l158.141"></a><span id="l158.141"> _generate_background_foreground_tests([</span>
<a href="#l158.142"></a><span id="l158.142">   &quot;middle_click_folder_with_nothing_selected&quot;,</span>
<a href="#l158.143"></a><span id="l158.143">   &quot;middle_click_folder_with_one_thing_selected&quot;,</span>
<a href="#l158.144"></a><span id="l158.144">   &quot;middle_click_folder_with_many_things_selected&quot;,</span>
<a href="#l158.145"></a><span id="l158.145">   &quot;middle_click_folder_on_existing_single_selection&quot;,</span>
<a href="#l158.146"></a><span id="l158.146"> ]);</span>
<a href="#l158.147"></a><span id="l158.147" class="difflineplus">+</span>
<a href="#l158.148"></a><span id="l158.148" class="difflineplus">+add_task(() =&gt; {</span>
<a href="#l158.149"></a><span id="l158.149" class="difflineplus">+  Assert.report(</span>
<a href="#l158.150"></a><span id="l158.150" class="difflineplus">+    false,</span>
<a href="#l158.151"></a><span id="l158.151" class="difflineplus">+    undefined,</span>
<a href="#l158.152"></a><span id="l158.152" class="difflineplus">+    undefined,</span>
<a href="#l158.153"></a><span id="l158.153" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l158.154"></a><span id="l158.154" class="difflineplus">+  );</span>
<a href="#l158.155"></a><span id="l158.155" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l159.1"></a><span id="l159.1">copy from mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js</span>
<a href="#l159.2"></a><span id="l159.2">copy to mail/test/browser/folder-display/browser_rightClickMiddleClickMessages.js</span>
<a href="#l159.3"></a><span id="l159.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-right-click-middle-click-messages.js</span>
<a href="#l159.4"></a><span id="l159.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_rightClickMiddleClickMessages.js</span>
<a href="#l159.5"></a><span id="l159.5" class="difflineat">@@ -4,17 +4,17 @@</span>
<a href="#l159.6"></a><span id="l159.6"> </span>
<a href="#l159.7"></a><span id="l159.7"> /*</span>
<a href="#l159.8"></a><span id="l159.8">  * Test the many horrors involving right-clicks, middle clicks, and selections.</span>
<a href="#l159.9"></a><span id="l159.9">  */</span>
<a href="#l159.10"></a><span id="l159.10"> </span>
<a href="#l159.11"></a><span id="l159.11"> &quot;use strict&quot;;</span>
<a href="#l159.12"></a><span id="l159.12"> </span>
<a href="#l159.13"></a><span id="l159.13"> var elib = ChromeUtils.import(</span>
<a href="#l159.14"></a><span id="l159.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l159.15"></a><span id="l159.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l159.16"></a><span id="l159.16"> );</span>
<a href="#l159.17"></a><span id="l159.17"> </span>
<a href="#l159.18"></a><span id="l159.18"> var {</span>
<a href="#l159.19"></a><span id="l159.19">   add_sets_to_folders,</span>
<a href="#l159.20"></a><span id="l159.20">   assert_displayed,</span>
<a href="#l159.21"></a><span id="l159.21">   assert_message_not_in_view,</span>
<a href="#l159.22"></a><span id="l159.22">   assert_message_pane_focused,</span>
<a href="#l159.23"></a><span id="l159.23">   assert_messages_not_in_view,</span>
<a href="#l159.24"></a><span id="l159.24" class="difflineat">@@ -51,57 +51,57 @@ var {</span>
<a href="#l159.25"></a><span id="l159.25"> </span>
<a href="#l159.26"></a><span id="l159.26"> var folder, threadedFolder;</span>
<a href="#l159.27"></a><span id="l159.27"> </span>
<a href="#l159.28"></a><span id="l159.28"> /**</span>
<a href="#l159.29"></a><span id="l159.29">  * The number of messages in the thread we use to test.</span>
<a href="#l159.30"></a><span id="l159.30">  */</span>
<a href="#l159.31"></a><span id="l159.31"> var NUM_MESSAGES_IN_THREAD = 6;</span>
<a href="#l159.32"></a><span id="l159.32"> </span>
<a href="#l159.33"></a><span id="l159.33" class="difflineminus">-function setupModule(module) {</span>
<a href="#l159.34"></a><span id="l159.34" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l159.35"></a><span id="l159.35">   folder = create_folder(&quot;RightClickMiddleClickA&quot;);</span>
<a href="#l159.36"></a><span id="l159.36">   threadedFolder = create_folder(&quot;RightClickMiddleClickB&quot;);</span>
<a href="#l159.37"></a><span id="l159.37">   // we want exactly as many messages as we plan to delete, so that we can test</span>
<a href="#l159.38"></a><span id="l159.38">   //  that the message window and tabs close when they run out of things to</span>
<a href="#l159.39"></a><span id="l159.39">   //  to display.</span>
<a href="#l159.40"></a><span id="l159.40">   make_new_sets_in_folder(folder, [{ count: 20 }]);</span>
<a href="#l159.41"></a><span id="l159.41">   // Create a few messages and one thread (the order is important here, as it</span>
<a href="#l159.42"></a><span id="l159.42">   // determines where the thread is placed. We want it placed right at the</span>
<a href="#l159.43"></a><span id="l159.43">   // end.)</span>
<a href="#l159.44"></a><span id="l159.44">   make_new_sets_in_folder(threadedFolder, [{ count: 50 }]);</span>
<a href="#l159.45"></a><span id="l159.45">   let thread = create_thread(NUM_MESSAGES_IN_THREAD);</span>
<a href="#l159.46"></a><span id="l159.46">   add_sets_to_folders([threadedFolder], [thread]);</span>
<a href="#l159.47"></a><span id="l159.47" class="difflineminus">-}</span>
<a href="#l159.48"></a><span id="l159.48" class="difflineplus">+});</span>
<a href="#l159.49"></a><span id="l159.49"> </span>
<a href="#l159.50"></a><span id="l159.50"> /**</span>
<a href="#l159.51"></a><span id="l159.51">  * Make sure that a right-click when there is nothing currently selected does</span>
<a href="#l159.52"></a><span id="l159.52">  *  not cause us to display something, as well as correctly causing a transient</span>
<a href="#l159.53"></a><span id="l159.53">  *  selection to occur.</span>
<a href="#l159.54"></a><span id="l159.54">  */</span>
<a href="#l159.55"></a><span id="l159.55" class="difflineminus">-function test_right_click_with_nothing_selected() {</span>
<a href="#l159.56"></a><span id="l159.56" class="difflineplus">+add_task(function test_right_click_with_nothing_selected() {</span>
<a href="#l159.57"></a><span id="l159.57">   be_in_folder(folder);</span>
<a href="#l159.58"></a><span id="l159.58"> </span>
<a href="#l159.59"></a><span id="l159.59">   select_none();</span>
<a href="#l159.60"></a><span id="l159.60">   assert_nothing_selected();</span>
<a href="#l159.61"></a><span id="l159.61"> </span>
<a href="#l159.62"></a><span id="l159.62">   right_click_on_row(1);</span>
<a href="#l159.63"></a><span id="l159.63">   // Check that the popup opens.</span>
<a href="#l159.64"></a><span id="l159.64">   wait_for_popup_to_open(mc.e(&quot;mailContext&quot;));</span>
<a href="#l159.65"></a><span id="l159.65"> </span>
<a href="#l159.66"></a><span id="l159.66">   assert_selected(1);</span>
<a href="#l159.67"></a><span id="l159.67">   assert_displayed();</span>
<a href="#l159.68"></a><span id="l159.68"> </span>
<a href="#l159.69"></a><span id="l159.69">   close_popup(mc, mc.eid(&quot;mailContext&quot;));</span>
<a href="#l159.70"></a><span id="l159.70">   assert_nothing_selected();</span>
<a href="#l159.71"></a><span id="l159.71" class="difflineminus">-}</span>
<a href="#l159.72"></a><span id="l159.72" class="difflineplus">+});</span>
<a href="#l159.73"></a><span id="l159.73"> </span>
<a href="#l159.74"></a><span id="l159.74"> /**</span>
<a href="#l159.75"></a><span id="l159.75">  * Test that clicking on the column header shows the column picker.</span>
<a href="#l159.76"></a><span id="l159.76">  */</span>
<a href="#l159.77"></a><span id="l159.77" class="difflineminus">-function test_right_click_column_header_shows_col_picker() {</span>
<a href="#l159.78"></a><span id="l159.78" class="difflineplus">+add_task(function test_right_click_column_header_shows_col_picker() {</span>
<a href="#l159.79"></a><span id="l159.79">   be_in_folder(folder);</span>
<a href="#l159.80"></a><span id="l159.80"> </span>
<a href="#l159.81"></a><span id="l159.81">   // The treecolpicker element itself doesn't have an id, so we have to walk</span>
<a href="#l159.82"></a><span id="l159.82">   // down from the parent to find it.</span>
<a href="#l159.83"></a><span id="l159.83">   //  treadCols</span>
<a href="#l159.84"></a><span id="l159.84">   //   |- hbox                item 0</span>
<a href="#l159.85"></a><span id="l159.85">   //   |- treecolpicker   &lt;-- item 1 this is the one we want</span>
<a href="#l159.86"></a><span id="l159.86">   let threadCols = mc.window.document.getElementById(&quot;threadCols&quot;);</span>
<a href="#l159.87"></a><span id="l159.87" class="difflineat">@@ -111,85 +111,85 @@ function test_right_click_column_header_</span>
<a href="#l159.88"></a><span id="l159.88">   // Right click the subject column header</span>
<a href="#l159.89"></a><span id="l159.89">   // This should show the column picker popup.</span>
<a href="#l159.90"></a><span id="l159.90">   mc.rightClick(mc.eid(&quot;subjectCol&quot;));</span>
<a href="#l159.91"></a><span id="l159.91"> </span>
<a href="#l159.92"></a><span id="l159.92">   // Check that the popup opens.</span>
<a href="#l159.93"></a><span id="l159.93">   wait_for_popup_to_open(popup);</span>
<a href="#l159.94"></a><span id="l159.94">   // Hide it again, we just wanted to know it was going to be shown.</span>
<a href="#l159.95"></a><span id="l159.95">   close_popup(mc, new elib.Elem(popup));</span>
<a href="#l159.96"></a><span id="l159.96" class="difflineminus">-}</span>
<a href="#l159.97"></a><span id="l159.97" class="difflineplus">+});</span>
<a href="#l159.98"></a><span id="l159.98"> </span>
<a href="#l159.99"></a><span id="l159.99"> /**</span>
<a href="#l159.100"></a><span id="l159.100">  * One-thing selected, right-click on something else.</span>
<a href="#l159.101"></a><span id="l159.101">  */</span>
<a href="#l159.102"></a><span id="l159.102" class="difflineminus">-function test_right_click_with_one_thing_selected() {</span>
<a href="#l159.103"></a><span id="l159.103" class="difflineplus">+add_task(function test_right_click_with_one_thing_selected() {</span>
<a href="#l159.104"></a><span id="l159.104">   be_in_folder(folder);</span>
<a href="#l159.105"></a><span id="l159.105"> </span>
<a href="#l159.106"></a><span id="l159.106">   select_click_row(0);</span>
<a href="#l159.107"></a><span id="l159.107">   assert_selected_and_displayed(0);</span>
<a href="#l159.108"></a><span id="l159.108"> </span>
<a href="#l159.109"></a><span id="l159.109">   right_click_on_row(1);</span>
<a href="#l159.110"></a><span id="l159.110">   assert_selected(1);</span>
<a href="#l159.111"></a><span id="l159.111">   assert_displayed(0);</span>
<a href="#l159.112"></a><span id="l159.112"> </span>
<a href="#l159.113"></a><span id="l159.113">   close_popup(mc, mc.eid(&quot;mailContext&quot;));</span>
<a href="#l159.114"></a><span id="l159.114">   assert_selected_and_displayed(0);</span>
<a href="#l159.115"></a><span id="l159.115" class="difflineminus">-}</span>
<a href="#l159.116"></a><span id="l159.116" class="difflineplus">+});</span>
<a href="#l159.117"></a><span id="l159.117"> </span>
<a href="#l159.118"></a><span id="l159.118"> /**</span>
<a href="#l159.119"></a><span id="l159.119">  * Many things selected, right-click on something that is not in that selection.</span>
<a href="#l159.120"></a><span id="l159.120">  */</span>
<a href="#l159.121"></a><span id="l159.121" class="difflineminus">-function test_right_click_with_many_things_selected() {</span>
<a href="#l159.122"></a><span id="l159.122" class="difflineplus">+add_task(function test_right_click_with_many_things_selected() {</span>
<a href="#l159.123"></a><span id="l159.123">   be_in_folder(folder);</span>
<a href="#l159.124"></a><span id="l159.124"> </span>
<a href="#l159.125"></a><span id="l159.125">   select_click_row(0);</span>
<a href="#l159.126"></a><span id="l159.126">   select_shift_click_row(5);</span>
<a href="#l159.127"></a><span id="l159.127">   assert_selected_and_displayed([0, 5]);</span>
<a href="#l159.128"></a><span id="l159.128"> </span>
<a href="#l159.129"></a><span id="l159.129">   right_click_on_row(6);</span>
<a href="#l159.130"></a><span id="l159.130">   assert_selected(6);</span>
<a href="#l159.131"></a><span id="l159.131">   assert_displayed([0, 5]);</span>
<a href="#l159.132"></a><span id="l159.132"> </span>
<a href="#l159.133"></a><span id="l159.133">   close_popup(mc, mc.eid(&quot;mailContext&quot;));</span>
<a href="#l159.134"></a><span id="l159.134">   assert_selected_and_displayed([0, 5]);</span>
<a href="#l159.135"></a><span id="l159.135" class="difflineminus">-}</span>
<a href="#l159.136"></a><span id="l159.136" class="difflineplus">+});</span>
<a href="#l159.137"></a><span id="l159.137"> </span>
<a href="#l159.138"></a><span id="l159.138"> /**</span>
<a href="#l159.139"></a><span id="l159.139">  * One thing selected, right-click on that.</span>
<a href="#l159.140"></a><span id="l159.140">  */</span>
<a href="#l159.141"></a><span id="l159.141" class="difflineminus">-function test_right_click_on_existing_single_selection() {</span>
<a href="#l159.142"></a><span id="l159.142" class="difflineplus">+add_task(function test_right_click_on_existing_single_selection() {</span>
<a href="#l159.143"></a><span id="l159.143">   be_in_folder(folder);</span>
<a href="#l159.144"></a><span id="l159.144"> </span>
<a href="#l159.145"></a><span id="l159.145">   select_click_row(3);</span>
<a href="#l159.146"></a><span id="l159.146">   assert_selected_and_displayed(3);</span>
<a href="#l159.147"></a><span id="l159.147"> </span>
<a href="#l159.148"></a><span id="l159.148">   right_click_on_row(3);</span>
<a href="#l159.149"></a><span id="l159.149">   assert_selected_and_displayed(3);</span>
<a href="#l159.150"></a><span id="l159.150"> </span>
<a href="#l159.151"></a><span id="l159.151">   close_popup(mc, mc.eid(&quot;mailContext&quot;));</span>
<a href="#l159.152"></a><span id="l159.152">   assert_selected_and_displayed(3);</span>
<a href="#l159.153"></a><span id="l159.153" class="difflineminus">-}</span>
<a href="#l159.154"></a><span id="l159.154" class="difflineplus">+});</span>
<a href="#l159.155"></a><span id="l159.155"> </span>
<a href="#l159.156"></a><span id="l159.156"> /**</span>
<a href="#l159.157"></a><span id="l159.157">  * Many things selected, right-click somewhere in the selection.</span>
<a href="#l159.158"></a><span id="l159.158">  */</span>
<a href="#l159.159"></a><span id="l159.159" class="difflineminus">-function test_right_click_on_existing_multi_selection() {</span>
<a href="#l159.160"></a><span id="l159.160" class="difflineplus">+add_task(function test_right_click_on_existing_multi_selection() {</span>
<a href="#l159.161"></a><span id="l159.161">   be_in_folder(folder);</span>
<a href="#l159.162"></a><span id="l159.162"> </span>
<a href="#l159.163"></a><span id="l159.163">   select_click_row(3);</span>
<a href="#l159.164"></a><span id="l159.164">   select_shift_click_row(6);</span>
<a href="#l159.165"></a><span id="l159.165">   assert_selected_and_displayed([3, 6]);</span>
<a href="#l159.166"></a><span id="l159.166"> </span>
<a href="#l159.167"></a><span id="l159.167">   right_click_on_row(5);</span>
<a href="#l159.168"></a><span id="l159.168">   assert_selected_and_displayed([3, 6]);</span>
<a href="#l159.169"></a><span id="l159.169"> </span>
<a href="#l159.170"></a><span id="l159.170">   close_popup(mc, mc.eid(&quot;mailContext&quot;));</span>
<a href="#l159.171"></a><span id="l159.171">   assert_selected_and_displayed([3, 6]);</span>
<a href="#l159.172"></a><span id="l159.172" class="difflineminus">-}</span>
<a href="#l159.173"></a><span id="l159.173" class="difflineplus">+});</span>
<a href="#l159.174"></a><span id="l159.174"> </span>
<a href="#l159.175"></a><span id="l159.175"> /**</span>
<a href="#l159.176"></a><span id="l159.176">  * Middle clicking should open a message in a tab, but not affect our selection.</span>
<a href="#l159.177"></a><span id="l159.177">  */</span>
<a href="#l159.178"></a><span id="l159.178"> function _middle_click_with_nothing_selected_helper(aBackground) {</span>
<a href="#l159.179"></a><span id="l159.179">   be_in_folder(folder);</span>
<a href="#l159.180"></a><span id="l159.180"> </span>
<a href="#l159.181"></a><span id="l159.181">   select_none();</span>
<a href="#l159.182"></a><span id="l159.182" class="difflineat">@@ -463,81 +463,88 @@ function _generate_background_foreground</span>
<a href="#l159.183"></a><span id="l159.183">   &quot;middle_click_on_existing_multi_selection&quot;,</span>
<a href="#l159.184"></a><span id="l159.184">   &quot;middle_click_on_collapsed_thread_root&quot;,</span>
<a href="#l159.185"></a><span id="l159.185">   &quot;middle_click_on_expanded_thread_root&quot;,</span>
<a href="#l159.186"></a><span id="l159.186"> ]);</span>
<a href="#l159.187"></a><span id="l159.187"> </span>
<a href="#l159.188"></a><span id="l159.188"> /**</span>
<a href="#l159.189"></a><span id="l159.189">  * Right-click on something and delete it, having no selection previously.</span>
<a href="#l159.190"></a><span id="l159.190">  */</span>
<a href="#l159.191"></a><span id="l159.191" class="difflineminus">-function test_right_click_deletion_nothing_selected() {</span>
<a href="#l159.192"></a><span id="l159.192" class="difflineplus">+add_task(function test_right_click_deletion_nothing_selected() {</span>
<a href="#l159.193"></a><span id="l159.193">   be_in_folder(folder);</span>
<a href="#l159.194"></a><span id="l159.194"> </span>
<a href="#l159.195"></a><span id="l159.195">   select_none();</span>
<a href="#l159.196"></a><span id="l159.196">   assert_selected_and_displayed();</span>
<a href="#l159.197"></a><span id="l159.197"> </span>
<a href="#l159.198"></a><span id="l159.198">   let delMessage = right_click_on_row(3);</span>
<a href="#l159.199"></a><span id="l159.199">   delete_via_popup();</span>
<a href="#l159.200"></a><span id="l159.200">   // eh, might as well make sure the deletion worked while we are here</span>
<a href="#l159.201"></a><span id="l159.201">   assert_message_not_in_view(delMessage);</span>
<a href="#l159.202"></a><span id="l159.202"> </span>
<a href="#l159.203"></a><span id="l159.203">   assert_selected_and_displayed();</span>
<a href="#l159.204"></a><span id="l159.204" class="difflineminus">-}</span>
<a href="#l159.205"></a><span id="l159.205" class="difflineplus">+});</span>
<a href="#l159.206"></a><span id="l159.206"> </span>
<a href="#l159.207"></a><span id="l159.207"> /**</span>
<a href="#l159.208"></a><span id="l159.208">  * We want to make sure that the selection post-delete still includes the same</span>
<a href="#l159.209"></a><span id="l159.209">  *  message (and that it is displayed).  In order for this to be interesting,</span>
<a href="#l159.210"></a><span id="l159.210">  *  we want to make sure that we right-click delete a message above the selected</span>
<a href="#l159.211"></a><span id="l159.211">  *  message so there is a shift in row numbering.</span>
<a href="#l159.212"></a><span id="l159.212">  */</span>
<a href="#l159.213"></a><span id="l159.213" class="difflineminus">-function test_right_click_deletion_one_other_thing_selected() {</span>
<a href="#l159.214"></a><span id="l159.214" class="difflineplus">+add_task(function test_right_click_deletion_one_other_thing_selected() {</span>
<a href="#l159.215"></a><span id="l159.215">   be_in_folder(folder);</span>
<a href="#l159.216"></a><span id="l159.216"> </span>
<a href="#l159.217"></a><span id="l159.217">   let curMessage = select_click_row(5);</span>
<a href="#l159.218"></a><span id="l159.218"> </span>
<a href="#l159.219"></a><span id="l159.219">   let delMessage = right_click_on_row(3);</span>
<a href="#l159.220"></a><span id="l159.220">   delete_via_popup();</span>
<a href="#l159.221"></a><span id="l159.221">   assert_message_not_in_view(delMessage);</span>
<a href="#l159.222"></a><span id="l159.222"> </span>
<a href="#l159.223"></a><span id="l159.223">   assert_selected_and_displayed(curMessage);</span>
<a href="#l159.224"></a><span id="l159.224" class="difflineminus">-}</span>
<a href="#l159.225"></a><span id="l159.225" class="difflineplus">+});</span>
<a href="#l159.226"></a><span id="l159.226"> </span>
<a href="#l159.227"></a><span id="l159.227" class="difflineminus">-function test_right_click_deletion_many_other_things_selected() {</span>
<a href="#l159.228"></a><span id="l159.228" class="difflineplus">+add_task(function test_right_click_deletion_many_other_things_selected() {</span>
<a href="#l159.229"></a><span id="l159.229">   be_in_folder(folder);</span>
<a href="#l159.230"></a><span id="l159.230"> </span>
<a href="#l159.231"></a><span id="l159.231">   select_click_row(4);</span>
<a href="#l159.232"></a><span id="l159.232">   let messages = select_shift_click_row(6);</span>
<a href="#l159.233"></a><span id="l159.233"> </span>
<a href="#l159.234"></a><span id="l159.234">   let delMessage = right_click_on_row(2);</span>
<a href="#l159.235"></a><span id="l159.235">   delete_via_popup();</span>
<a href="#l159.236"></a><span id="l159.236">   assert_message_not_in_view(delMessage);</span>
<a href="#l159.237"></a><span id="l159.237"> </span>
<a href="#l159.238"></a><span id="l159.238">   assert_selected_and_displayed(messages);</span>
<a href="#l159.239"></a><span id="l159.239" class="difflineminus">-}</span>
<a href="#l159.240"></a><span id="l159.240" class="difflineplus">+});</span>
<a href="#l159.241"></a><span id="l159.241"> </span>
<a href="#l159.242"></a><span id="l159.242" class="difflineminus">-function test_right_click_deletion_of_one_selected_thing() {</span>
<a href="#l159.243"></a><span id="l159.243" class="difflineplus">+add_task(function test_right_click_deletion_of_one_selected_thing() {</span>
<a href="#l159.244"></a><span id="l159.244">   be_in_folder(folder);</span>
<a href="#l159.245"></a><span id="l159.245"> </span>
<a href="#l159.246"></a><span id="l159.246">   let curMessage = select_click_row(2);</span>
<a href="#l159.247"></a><span id="l159.247"> </span>
<a href="#l159.248"></a><span id="l159.248">   right_click_on_row(2);</span>
<a href="#l159.249"></a><span id="l159.249">   delete_via_popup();</span>
<a href="#l159.250"></a><span id="l159.250">   assert_message_not_in_view(curMessage);</span>
<a href="#l159.251"></a><span id="l159.251"> </span>
<a href="#l159.252"></a><span id="l159.252">   if (!mc.folderDisplay.selectedCount) {</span>
<a href="#l159.253"></a><span id="l159.253">     throw new Error(&quot;We should have tried to select something!&quot;);</span>
<a href="#l159.254"></a><span id="l159.254">   }</span>
<a href="#l159.255"></a><span id="l159.255" class="difflineminus">-}</span>
<a href="#l159.256"></a><span id="l159.256" class="difflineplus">+});</span>
<a href="#l159.257"></a><span id="l159.257"> </span>
<a href="#l159.258"></a><span id="l159.258" class="difflineminus">-function test_right_click_deletion_of_many_selected_things() {</span>
<a href="#l159.259"></a><span id="l159.259" class="difflineplus">+add_task(function test_right_click_deletion_of_many_selected_things() {</span>
<a href="#l159.260"></a><span id="l159.260">   be_in_folder(folder);</span>
<a href="#l159.261"></a><span id="l159.261"> </span>
<a href="#l159.262"></a><span id="l159.262">   select_click_row(2);</span>
<a href="#l159.263"></a><span id="l159.263">   let messages = select_shift_click_row(4);</span>
<a href="#l159.264"></a><span id="l159.264"> </span>
<a href="#l159.265"></a><span id="l159.265">   right_click_on_row(3);</span>
<a href="#l159.266"></a><span id="l159.266">   delete_via_popup();</span>
<a href="#l159.267"></a><span id="l159.267">   assert_messages_not_in_view(messages);</span>
<a href="#l159.268"></a><span id="l159.268"> </span>
<a href="#l159.269"></a><span id="l159.269">   if (!mc.folderDisplay.selectedCount) {</span>
<a href="#l159.270"></a><span id="l159.270">     throw new Error(&quot;We should have tried to select something!&quot;);</span>
<a href="#l159.271"></a><span id="l159.271">   }</span>
<a href="#l159.272"></a><span id="l159.272" class="difflineminus">-}</span>
<a href="#l159.273"></a><span id="l159.273" class="difflineplus">+</span>
<a href="#l159.274"></a><span id="l159.274" class="difflineplus">+  Assert.report(</span>
<a href="#l159.275"></a><span id="l159.275" class="difflineplus">+    false,</span>
<a href="#l159.276"></a><span id="l159.276" class="difflineplus">+    undefined,</span>
<a href="#l159.277"></a><span id="l159.277" class="difflineplus">+    undefined,</span>
<a href="#l159.278"></a><span id="l159.278" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l159.279"></a><span id="l159.279" class="difflineplus">+  );</span>
<a href="#l159.280"></a><span id="l159.280" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l160.1"></a><span id="l160.1">copy from mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js</span>
<a href="#l160.2"></a><span id="l160.2">copy to mail/test/browser/folder-display/browser_savedsearchReloadAfterCompact.js</span>
<a href="#l160.3"></a><span id="l160.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js</span>
<a href="#l160.4"></a><span id="l160.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_savedsearchReloadAfterCompact.js</span>
<a href="#l160.5"></a><span id="l160.5" class="difflineat">@@ -21,17 +21,17 @@ var {</span>
<a href="#l160.6"></a><span id="l160.6"> } = ChromeUtils.import(</span>
<a href="#l160.7"></a><span id="l160.7">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l160.8"></a><span id="l160.8"> );</span>
<a href="#l160.9"></a><span id="l160.9"> </span>
<a href="#l160.10"></a><span id="l160.10"> /**</span>
<a href="#l160.11"></a><span id="l160.11">  * Add some messages to a folder, delete the first one, and create a saved</span>
<a href="#l160.12"></a><span id="l160.12">  * search over the inbox and the folder. Then, compact folders.</span>
<a href="#l160.13"></a><span id="l160.13">  */</span>
<a href="#l160.14"></a><span id="l160.14" class="difflineminus">-function test_setup_virtual_folder_and_compact() {</span>
<a href="#l160.15"></a><span id="l160.15" class="difflineplus">+add_task(function test_setup_virtual_folder_and_compact() {</span>
<a href="#l160.16"></a><span id="l160.16">   let otherFolder = create_folder(&quot;otherFolder&quot;);</span>
<a href="#l160.17"></a><span id="l160.17">   make_new_sets_in_folder(otherFolder, [{ count: 2 }]);</span>
<a href="#l160.18"></a><span id="l160.18"> </span>
<a href="#l160.19"></a><span id="l160.19">   /**</span>
<a href="#l160.20"></a><span id="l160.20">    * We delete the first message in the local folder, so compaction of the</span>
<a href="#l160.21"></a><span id="l160.21">    * folder will invalidate the key of the second message in the folder. Then,</span>
<a href="#l160.22"></a><span id="l160.22">    * we select the second message and issue the compact. This causes saving the</span>
<a href="#l160.23"></a><span id="l160.23">    * selection on the compaction notification to fail. We test the saved search</span>
<a href="#l160.24"></a><span id="l160.24" class="difflineat">@@ -67,9 +67,16 @@ function test_setup_virtual_folder_and_c</span>
<a href="#l160.25"></a><span id="l160.25">       10000,</span>
<a href="#l160.26"></a><span id="l160.26">       100</span>
<a href="#l160.27"></a><span id="l160.27">     );</span>
<a href="#l160.28"></a><span id="l160.28">   }</span>
<a href="#l160.29"></a><span id="l160.29">   // Let the event queue clear.</span>
<a href="#l160.30"></a><span id="l160.30">   mc.sleep(0);</span>
<a href="#l160.31"></a><span id="l160.31">   // Check view is still valid</span>
<a href="#l160.32"></a><span id="l160.32">   mc.dbView.getMsgHdrAt(0);</span>
<a href="#l160.33"></a><span id="l160.33" class="difflineminus">-}</span>
<a href="#l160.34"></a><span id="l160.34" class="difflineplus">+</span>
<a href="#l160.35"></a><span id="l160.35" class="difflineplus">+  Assert.report(</span>
<a href="#l160.36"></a><span id="l160.36" class="difflineplus">+    false,</span>
<a href="#l160.37"></a><span id="l160.37" class="difflineplus">+    undefined,</span>
<a href="#l160.38"></a><span id="l160.38" class="difflineplus">+    undefined,</span>
<a href="#l160.39"></a><span id="l160.39" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l160.40"></a><span id="l160.40" class="difflineplus">+  );</span>
<a href="#l160.41"></a><span id="l160.41" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l161.1"></a><span id="l161.1">copy from mail/test/mozmill/folder-display/test-selection.js</span>
<a href="#l161.2"></a><span id="l161.2">copy to mail/test/browser/folder-display/browser_selection.js</span>
<a href="#l161.3"></a><span id="l161.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-selection.js</span>
<a href="#l161.4"></a><span id="l161.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_selection.js</span>
<a href="#l161.5"></a><span id="l161.5" class="difflineat">@@ -32,48 +32,48 @@ var {</span>
<a href="#l161.6"></a><span id="l161.6"> } = ChromeUtils.import(</span>
<a href="#l161.7"></a><span id="l161.7">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l161.8"></a><span id="l161.8"> );</span>
<a href="#l161.9"></a><span id="l161.9"> </span>
<a href="#l161.10"></a><span id="l161.10"> // let us have 2 folders</span>
<a href="#l161.11"></a><span id="l161.11"> var folder = null,</span>
<a href="#l161.12"></a><span id="l161.12">   folder2 = null;</span>
<a href="#l161.13"></a><span id="l161.13"> </span>
<a href="#l161.14"></a><span id="l161.14" class="difflineminus">-var setupModule = function(module) {</span>
<a href="#l161.15"></a><span id="l161.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l161.16"></a><span id="l161.16">   folder = create_folder(&quot;SelectionA&quot;);</span>
<a href="#l161.17"></a><span id="l161.17">   folder2 = create_folder(&quot;SelectionB&quot;);</span>
<a href="#l161.18"></a><span id="l161.18">   make_new_sets_in_folders([folder, folder2], [{ count: 50 }]);</span>
<a href="#l161.19"></a><span id="l161.19" class="difflineminus">-};</span>
<a href="#l161.20"></a><span id="l161.20" class="difflineplus">+});</span>
<a href="#l161.21"></a><span id="l161.21"> </span>
<a href="#l161.22"></a><span id="l161.22"> // https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c80</span>
<a href="#l161.23"></a><span id="l161.23" class="difflineminus">-function test_selection_on_entry() {</span>
<a href="#l161.24"></a><span id="l161.24" class="difflineplus">+add_task(function test_selection_on_entry() {</span>
<a href="#l161.25"></a><span id="l161.25">   enter_folder(folder);</span>
<a href="#l161.26"></a><span id="l161.26">   assert_nothing_selected();</span>
<a href="#l161.27"></a><span id="l161.27" class="difflineminus">-}</span>
<a href="#l161.28"></a><span id="l161.28" class="difflineplus">+});</span>
<a href="#l161.29"></a><span id="l161.29"> </span>
<a href="#l161.30"></a><span id="l161.30" class="difflineminus">-function test_selection_extension() {</span>
<a href="#l161.31"></a><span id="l161.31" class="difflineplus">+add_task(function test_selection_extension() {</span>
<a href="#l161.32"></a><span id="l161.32">   be_in_folder(folder);</span>
<a href="#l161.33"></a><span id="l161.33"> </span>
<a href="#l161.34"></a><span id="l161.34">   // https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c79 (was good)</span>
<a href="#l161.35"></a><span id="l161.35">   select_click_row(1);</span>
<a href="#l161.36"></a><span id="l161.36">   select_control_click_row(2);</span>
<a href="#l161.37"></a><span id="l161.37">   press_delete();</span>
<a href="#l161.38"></a><span id="l161.38">   assert_selected_and_displayed(1);</span>
<a href="#l161.39"></a><span id="l161.39">   // https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c79 (was bad)</span>
<a href="#l161.40"></a><span id="l161.40">   select_click_row(2);</span>
<a href="#l161.41"></a><span id="l161.41">   select_control_click_row(1);</span>
<a href="#l161.42"></a><span id="l161.42">   press_delete();</span>
<a href="#l161.43"></a><span id="l161.43">   assert_selected_and_displayed(1);</span>
<a href="#l161.44"></a><span id="l161.44"> </span>
<a href="#l161.45"></a><span id="l161.45">   // https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c87 first bit</span>
<a href="#l161.46"></a><span id="l161.46">   press_delete();</span>
<a href="#l161.47"></a><span id="l161.47">   assert_selected_and_displayed(1);</span>
<a href="#l161.48"></a><span id="l161.48" class="difflineminus">-}</span>
<a href="#l161.49"></a><span id="l161.49" class="difflineplus">+});</span>
<a href="#l161.50"></a><span id="l161.50"> </span>
<a href="#l161.51"></a><span id="l161.51" class="difflineminus">-function test_selection_select_column() {</span>
<a href="#l161.52"></a><span id="l161.52" class="difflineplus">+add_task(function test_selection_select_column() {</span>
<a href="#l161.53"></a><span id="l161.53">   be_in_folder(folder);</span>
<a href="#l161.54"></a><span id="l161.54">   mc.e(&quot;selectCol&quot;).removeAttribute(&quot;hidden&quot;);</span>
<a href="#l161.55"></a><span id="l161.55">   select_none();</span>
<a href="#l161.56"></a><span id="l161.56">   select_column_click_row(0);</span>
<a href="#l161.57"></a><span id="l161.57">   assert_selected_and_displayed(0);</span>
<a href="#l161.58"></a><span id="l161.58">   select_column_click_row(0);</span>
<a href="#l161.59"></a><span id="l161.59">   assert_nothing_selected();</span>
<a href="#l161.60"></a><span id="l161.60">   select_column_click_row(2);</span>
<a href="#l161.61"></a><span id="l161.61" class="difflineat">@@ -82,64 +82,64 @@ function test_selection_select_column() </span>
<a href="#l161.62"></a><span id="l161.62">   // This only takes a range.</span>
<a href="#l161.63"></a><span id="l161.63">   assert_selected_and_displayed([2, 4]); // ensures multi-message summary</span>
<a href="#l161.64"></a><span id="l161.64">   select_column_click_row(2);</span>
<a href="#l161.65"></a><span id="l161.65">   assert_selected_and_displayed([3, 4]); // ensures multi-message summary</span>
<a href="#l161.66"></a><span id="l161.66">   select_column_click_row(3);</span>
<a href="#l161.67"></a><span id="l161.67">   assert_selected_and_displayed(4);</span>
<a href="#l161.68"></a><span id="l161.68">   select_column_click_row(4);</span>
<a href="#l161.69"></a><span id="l161.69">   assert_nothing_selected();</span>
<a href="#l161.70"></a><span id="l161.70" class="difflineminus">-}</span>
<a href="#l161.71"></a><span id="l161.71" class="difflineplus">+});</span>
<a href="#l161.72"></a><span id="l161.72"> </span>
<a href="#l161.73"></a><span id="l161.73" class="difflineminus">-function test_selection_select_column_deselection() {</span>
<a href="#l161.74"></a><span id="l161.74" class="difflineplus">+add_task(function test_selection_select_column_deselection() {</span>
<a href="#l161.75"></a><span id="l161.75">   be_in_folder(folder);</span>
<a href="#l161.76"></a><span id="l161.76">   select_none();</span>
<a href="#l161.77"></a><span id="l161.77">   select_column_click_row(3);</span>
<a href="#l161.78"></a><span id="l161.78">   select_column_click_row(3);</span>
<a href="#l161.79"></a><span id="l161.79">   assert_nothing_selected();</span>
<a href="#l161.80"></a><span id="l161.80">   right_click_on_row(7);</span>
<a href="#l161.81"></a><span id="l161.81">   delete_via_popup();</span>
<a href="#l161.82"></a><span id="l161.82">   assert_nothing_selected();</span>
<a href="#l161.83"></a><span id="l161.83">   mc.e(&quot;selectCol&quot;).setAttribute(&quot;hidden&quot;, true);</span>
<a href="#l161.84"></a><span id="l161.84" class="difflineminus">-}</span>
<a href="#l161.85"></a><span id="l161.85" class="difflineplus">+});</span>
<a href="#l161.86"></a><span id="l161.86"> </span>
<a href="#l161.87"></a><span id="l161.87"> // https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c87 last bit</span>
<a href="#l161.88"></a><span id="l161.88" class="difflineminus">-function test_selection_last_message_deleted() {</span>
<a href="#l161.89"></a><span id="l161.89" class="difflineplus">+add_task(function test_selection_last_message_deleted() {</span>
<a href="#l161.90"></a><span id="l161.90">   be_in_folder(folder);</span>
<a href="#l161.91"></a><span id="l161.91">   select_click_row(-1);</span>
<a href="#l161.92"></a><span id="l161.92">   press_delete();</span>
<a href="#l161.93"></a><span id="l161.93">   assert_selected_and_displayed(-1);</span>
<a href="#l161.94"></a><span id="l161.94" class="difflineminus">-}</span>
<a href="#l161.95"></a><span id="l161.95" class="difflineminus">-test_selection_last_message_deleted.EXCLUDED_PLATFORMS = [&quot;darwin&quot;, &quot;linux&quot;];</span>
<a href="#l161.96"></a><span id="l161.96" class="difflineplus">+}).__skipMe =</span>
<a href="#l161.97"></a><span id="l161.97" class="difflineplus">+  AppConstants.platform == &quot;linux&quot; || AppConstants.platform == &quot;macosx&quot;;</span>
<a href="#l161.98"></a><span id="l161.98"> </span>
<a href="#l161.99"></a><span id="l161.99" class="difflineminus">-function test_selection_persists_through_threading_changes() {</span>
<a href="#l161.100"></a><span id="l161.100" class="difflineplus">+add_task(function test_selection_persists_through_threading_changes() {</span>
<a href="#l161.101"></a><span id="l161.101">   be_in_folder(folder);</span>
<a href="#l161.102"></a><span id="l161.102"> </span>
<a href="#l161.103"></a><span id="l161.103">   make_display_unthreaded();</span>
<a href="#l161.104"></a><span id="l161.104">   let message = select_click_row(3);</span>
<a href="#l161.105"></a><span id="l161.105">   make_display_threaded();</span>
<a href="#l161.106"></a><span id="l161.106">   assert_selected_and_displayed(message);</span>
<a href="#l161.107"></a><span id="l161.107">   make_display_grouped();</span>
<a href="#l161.108"></a><span id="l161.108">   assert_selected_and_displayed(message);</span>
<a href="#l161.109"></a><span id="l161.109" class="difflineminus">-}</span>
<a href="#l161.110"></a><span id="l161.110" class="difflineplus">+});</span>
<a href="#l161.111"></a><span id="l161.111"> </span>
<a href="#l161.112"></a><span id="l161.112"> // https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c82 2nd half</span>
<a href="#l161.113"></a><span id="l161.113" class="difflineminus">-function test_no_selection_persists_through_threading_changes() {</span>
<a href="#l161.114"></a><span id="l161.114" class="difflineplus">+add_task(function test_no_selection_persists_through_threading_changes() {</span>
<a href="#l161.115"></a><span id="l161.115">   be_in_folder(folder);</span>
<a href="#l161.116"></a><span id="l161.116"> </span>
<a href="#l161.117"></a><span id="l161.117">   make_display_unthreaded();</span>
<a href="#l161.118"></a><span id="l161.118">   select_none();</span>
<a href="#l161.119"></a><span id="l161.119">   make_display_threaded();</span>
<a href="#l161.120"></a><span id="l161.120">   assert_nothing_selected();</span>
<a href="#l161.121"></a><span id="l161.121">   make_display_grouped();</span>
<a href="#l161.122"></a><span id="l161.122">   assert_nothing_selected();</span>
<a href="#l161.123"></a><span id="l161.123">   make_display_unthreaded();</span>
<a href="#l161.124"></a><span id="l161.124" class="difflineminus">-}</span>
<a href="#l161.125"></a><span id="l161.125" class="difflineplus">+});</span>
<a href="#l161.126"></a><span id="l161.126"> </span>
<a href="#l161.127"></a><span id="l161.127" class="difflineminus">-function test_selection_persists_through_folder_tab_changes() {</span>
<a href="#l161.128"></a><span id="l161.128" class="difflineplus">+add_task(function test_selection_persists_through_folder_tab_changes() {</span>
<a href="#l161.129"></a><span id="l161.129">   let tab1 = be_in_folder(folder);</span>
<a href="#l161.130"></a><span id="l161.130"> </span>
<a href="#l161.131"></a><span id="l161.131">   select_click_row(2);</span>
<a href="#l161.132"></a><span id="l161.132"> </span>
<a href="#l161.133"></a><span id="l161.133">   let tab2 = open_folder_in_new_tab(folder2);</span>
<a href="#l161.134"></a><span id="l161.134">   wait_for_blank_content_pane();</span>
<a href="#l161.135"></a><span id="l161.135">   assert_nothing_selected();</span>
<a href="#l161.136"></a><span id="l161.136"> </span>
<a href="#l161.137"></a><span id="l161.137" class="difflineat">@@ -155,44 +155,51 @@ function test_selection_persists_through</span>
<a href="#l161.138"></a><span id="l161.138">   select_shift_click_row(4); // 2-4 selected</span>
<a href="#l161.139"></a><span id="l161.139">   assert_selected_and_displayed([2, 4]); // ensures multi-message summary</span>
<a href="#l161.140"></a><span id="l161.140"> </span>
<a href="#l161.141"></a><span id="l161.141">   switch_tab(tab2);</span>
<a href="#l161.142"></a><span id="l161.142">   assert_selected_and_displayed(3);</span>
<a href="#l161.143"></a><span id="l161.143"> </span>
<a href="#l161.144"></a><span id="l161.144">   close_tab(tab2);</span>
<a href="#l161.145"></a><span id="l161.145">   assert_selected_and_displayed([2, 4]);</span>
<a href="#l161.146"></a><span id="l161.146" class="difflineminus">-}</span>
<a href="#l161.147"></a><span id="l161.147" class="difflineplus">+});</span>
<a href="#l161.148"></a><span id="l161.148"> </span>
<a href="#l161.149"></a><span id="l161.149"> // https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c87</span>
<a href="#l161.150"></a><span id="l161.150"> /**</span>
<a href="#l161.151"></a><span id="l161.151">  * Verify that we scroll to new messages when we enter a folder.</span>
<a href="#l161.152"></a><span id="l161.152">  */</span>
<a href="#l161.153"></a><span id="l161.153" class="difflineminus">-function test_enter_scroll_to_new() {</span>
<a href="#l161.154"></a><span id="l161.154" class="difflineplus">+add_task(function test_enter_scroll_to_new() {</span>
<a href="#l161.155"></a><span id="l161.155">   // be in the folder</span>
<a href="#l161.156"></a><span id="l161.156">   be_in_folder(folder);</span>
<a href="#l161.157"></a><span id="l161.157">   // make sure the sort is ascending...</span>
<a href="#l161.158"></a><span id="l161.158">   mc.folderDisplay.view.sortAscending();</span>
<a href="#l161.159"></a><span id="l161.159">   // leave the folder so that the messages get marked as read</span>
<a href="#l161.160"></a><span id="l161.160">   enter_folder(folder.rootFolder);</span>
<a href="#l161.161"></a><span id="l161.161">   // add a new message, and make sure it is new</span>
<a href="#l161.162"></a><span id="l161.162">   make_new_sets_in_folder(folder, [{ count: 1 }]);</span>
<a href="#l161.163"></a><span id="l161.163">   // enter the folder</span>
<a href="#l161.164"></a><span id="l161.164">   enter_folder(folder);</span>
<a href="#l161.165"></a><span id="l161.165">   // make sure it (which must be the last row) is visible</span>
<a href="#l161.166"></a><span id="l161.166">   assert_visible(-1);</span>
<a href="#l161.167"></a><span id="l161.167" class="difflineminus">-}</span>
<a href="#l161.168"></a><span id="l161.168" class="difflineminus">-test_enter_scroll_to_new.EXCLUDED_PLATFORMS = [&quot;darwin&quot;, &quot;linux&quot;];</span>
<a href="#l161.169"></a><span id="l161.169" class="difflineplus">+}).__skipMe =</span>
<a href="#l161.170"></a><span id="l161.170" class="difflineplus">+  AppConstants.platform == &quot;linux&quot; || AppConstants.platform == &quot;macosx&quot;;</span>
<a href="#l161.171"></a><span id="l161.171"> </span>
<a href="#l161.172"></a><span id="l161.172"> /**</span>
<a href="#l161.173"></a><span id="l161.173">  * Test that the last selected message persists through folder changes.</span>
<a href="#l161.174"></a><span id="l161.174">  */</span>
<a href="#l161.175"></a><span id="l161.175" class="difflineminus">-function test_selection_persists_through_folder_changes() {</span>
<a href="#l161.176"></a><span id="l161.176" class="difflineplus">+add_task(function test_selection_persists_through_folder_changes() {</span>
<a href="#l161.177"></a><span id="l161.177">   // be in the folder</span>
<a href="#l161.178"></a><span id="l161.178">   be_in_folder(folder);</span>
<a href="#l161.179"></a><span id="l161.179">   // select a message</span>
<a href="#l161.180"></a><span id="l161.180">   select_click_row(3);</span>
<a href="#l161.181"></a><span id="l161.181">   // leave and re-enter the folder</span>
<a href="#l161.182"></a><span id="l161.182">   enter_folder(folder.rootFolder);</span>
<a href="#l161.183"></a><span id="l161.183">   enter_folder(folder);</span>
<a href="#l161.184"></a><span id="l161.184">   // make sure it is selected and displayed</span>
<a href="#l161.185"></a><span id="l161.185">   assert_selected_and_displayed(3);</span>
<a href="#l161.186"></a><span id="l161.186" class="difflineminus">-}</span>
<a href="#l161.187"></a><span id="l161.187" class="difflineplus">+</span>
<a href="#l161.188"></a><span id="l161.188" class="difflineplus">+  Assert.report(</span>
<a href="#l161.189"></a><span id="l161.189" class="difflineplus">+    false,</span>
<a href="#l161.190"></a><span id="l161.190" class="difflineplus">+    undefined,</span>
<a href="#l161.191"></a><span id="l161.191" class="difflineplus">+    undefined,</span>
<a href="#l161.192"></a><span id="l161.192" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l161.193"></a><span id="l161.193" class="difflineplus">+  );</span>
<a href="#l161.194"></a><span id="l161.194" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l162.1"></a><span id="l162.1">copy from mail/test/mozmill/folder-display/test-summarization.js</span>
<a href="#l162.2"></a><span id="l162.2">copy to mail/test/browser/folder-display/browser_summarization.js</span>
<a href="#l162.3"></a><span id="l162.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-summarization.js</span>
<a href="#l162.4"></a><span id="l162.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_summarization.js</span>
<a href="#l162.5"></a><span id="l162.5" class="difflineat">@@ -57,44 +57,44 @@ var {</span>
<a href="#l162.6"></a><span id="l162.6"> </span>
<a href="#l162.7"></a><span id="l162.7"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l162.8"></a><span id="l162.8">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l162.9"></a><span id="l162.9"> );</span>
<a href="#l162.10"></a><span id="l162.10"> </span>
<a href="#l162.11"></a><span id="l162.11"> var folder;</span>
<a href="#l162.12"></a><span id="l162.12"> var thread1, thread2, msg1, msg2;</span>
<a href="#l162.13"></a><span id="l162.13"> </span>
<a href="#l162.14"></a><span id="l162.14" class="difflineminus">-var setupModule = function(module) {</span>
<a href="#l162.15"></a><span id="l162.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l162.16"></a><span id="l162.16">   folder = create_folder(&quot;SummarizationA&quot;);</span>
<a href="#l162.17"></a><span id="l162.17">   thread1 = create_thread(10);</span>
<a href="#l162.18"></a><span id="l162.18">   msg1 = create_thread(1);</span>
<a href="#l162.19"></a><span id="l162.19">   thread2 = create_thread(10);</span>
<a href="#l162.20"></a><span id="l162.20">   msg2 = create_thread(1);</span>
<a href="#l162.21"></a><span id="l162.21">   add_sets_to_folders([folder], [thread1, msg1, thread2, msg2]);</span>
<a href="#l162.22"></a><span id="l162.22" class="difflineminus">-};</span>
<a href="#l162.23"></a><span id="l162.23" class="difflineplus">+});</span>
<a href="#l162.24"></a><span id="l162.24"> </span>
<a href="#l162.25"></a><span id="l162.25" class="difflineminus">-function test_basic_summarization() {</span>
<a href="#l162.26"></a><span id="l162.26" class="difflineplus">+add_task(function test_basic_summarization() {</span>
<a href="#l162.27"></a><span id="l162.27">   be_in_folder(folder);</span>
<a href="#l162.28"></a><span id="l162.28"> </span>
<a href="#l162.29"></a><span id="l162.29">   // - make sure we get a summary</span>
<a href="#l162.30"></a><span id="l162.30">   select_click_row(0);</span>
<a href="#l162.31"></a><span id="l162.31">   select_shift_click_row(5);</span>
<a href="#l162.32"></a><span id="l162.32">   // this will verify a multi-message display is happening</span>
<a href="#l162.33"></a><span id="l162.33">   assert_selected_and_displayed([0, 5]);</span>
<a href="#l162.34"></a><span id="l162.34" class="difflineminus">-}</span>
<a href="#l162.35"></a><span id="l162.35" class="difflineplus">+});</span>
<a href="#l162.36"></a><span id="l162.36"> </span>
<a href="#l162.37"></a><span id="l162.37" class="difflineminus">-function test_summarization_goes_away() {</span>
<a href="#l162.38"></a><span id="l162.38" class="difflineplus">+add_task(function test_summarization_goes_away() {</span>
<a href="#l162.39"></a><span id="l162.39">   select_none();</span>
<a href="#l162.40"></a><span id="l162.40">   assert_nothing_selected();</span>
<a href="#l162.41"></a><span id="l162.41" class="difflineminus">-}</span>
<a href="#l162.42"></a><span id="l162.42" class="difflineplus">+});</span>
<a href="#l162.43"></a><span id="l162.43"> </span>
<a href="#l162.44"></a><span id="l162.44"> /**</span>
<a href="#l162.45"></a><span id="l162.45">  * Verify that we update summarization when switching amongst tabs.</span>
<a href="#l162.46"></a><span id="l162.46">  */</span>
<a href="#l162.47"></a><span id="l162.47" class="difflineminus">-function test_folder_tabs_update_correctly() {</span>
<a href="#l162.48"></a><span id="l162.48" class="difflineplus">+add_task(function test_folder_tabs_update_correctly() {</span>
<a href="#l162.49"></a><span id="l162.49">   // tab with summary</span>
<a href="#l162.50"></a><span id="l162.50">   let tabA = be_in_folder(folder);</span>
<a href="#l162.51"></a><span id="l162.51">   select_click_row(0);</span>
<a href="#l162.52"></a><span id="l162.52">   select_control_click_row(2);</span>
<a href="#l162.53"></a><span id="l162.53">   assert_selected_and_displayed(0, 2);</span>
<a href="#l162.54"></a><span id="l162.54"> </span>
<a href="#l162.55"></a><span id="l162.55">   // tab with nothing</span>
<a href="#l162.56"></a><span id="l162.56">   let tabB = open_folder_in_new_tab(folder);</span>
<a href="#l162.57"></a><span id="l162.57" class="difflineat">@@ -121,19 +121,19 @@ function test_folder_tabs_update_correct</span>
<a href="#l162.58"></a><span id="l162.58">   switch_tab(tabA);</span>
<a href="#l162.59"></a><span id="l162.59">   assert_selected_and_displayed(0, 2);</span>
<a href="#l162.60"></a><span id="l162.60">   switch_tab(tabB);</span>
<a href="#l162.61"></a><span id="l162.61">   assert_selected_and_displayed([0, 3]);</span>
<a href="#l162.62"></a><span id="l162.62"> </span>
<a href="#l162.63"></a><span id="l162.63">   // closing tab returns state correctly...</span>
<a href="#l162.64"></a><span id="l162.64">   close_tab(tabB);</span>
<a href="#l162.65"></a><span id="l162.65">   assert_selected_and_displayed(0, 2);</span>
<a href="#l162.66"></a><span id="l162.66" class="difflineminus">-}</span>
<a href="#l162.67"></a><span id="l162.67" class="difflineplus">+});</span>
<a href="#l162.68"></a><span id="l162.68"> </span>
<a href="#l162.69"></a><span id="l162.69" class="difflineminus">-function test_message_tabs_update_correctly() {</span>
<a href="#l162.70"></a><span id="l162.70" class="difflineplus">+add_task(function test_message_tabs_update_correctly() {</span>
<a href="#l162.71"></a><span id="l162.71">   let tabFolder = be_in_folder(folder);</span>
<a href="#l162.72"></a><span id="l162.72">   let message = select_click_row(0);</span>
<a href="#l162.73"></a><span id="l162.73">   assert_selected_and_displayed(0);</span>
<a href="#l162.74"></a><span id="l162.74"> </span>
<a href="#l162.75"></a><span id="l162.75">   let tabMessage = open_selected_message_in_new_tab();</span>
<a href="#l162.76"></a><span id="l162.76">   assert_selected_and_displayed(message);</span>
<a href="#l162.77"></a><span id="l162.77"> </span>
<a href="#l162.78"></a><span id="l162.78">   switch_tab(tabFolder);</span>
<a href="#l162.79"></a><span id="l162.79" class="difflineat">@@ -142,23 +142,23 @@ function test_message_tabs_update_correc</span>
<a href="#l162.80"></a><span id="l162.80"> </span>
<a href="#l162.81"></a><span id="l162.81">   switch_tab(tabMessage);</span>
<a href="#l162.82"></a><span id="l162.82">   assert_selected_and_displayed(message);</span>
<a href="#l162.83"></a><span id="l162.83"> </span>
<a href="#l162.84"></a><span id="l162.84">   switch_tab(tabFolder);</span>
<a href="#l162.85"></a><span id="l162.85">   assert_selected_and_displayed([0, 2]);</span>
<a href="#l162.86"></a><span id="l162.86"> </span>
<a href="#l162.87"></a><span id="l162.87">   close_tab(tabMessage);</span>
<a href="#l162.88"></a><span id="l162.88" class="difflineminus">-}</span>
<a href="#l162.89"></a><span id="l162.89" class="difflineplus">+});</span>
<a href="#l162.90"></a><span id="l162.90"> </span>
<a href="#l162.91"></a><span id="l162.91"> /**</span>
<a href="#l162.92"></a><span id="l162.92">  * Test the stabilization logic by making the stabilization interval absurd and</span>
<a href="#l162.93"></a><span id="l162.93">  *  then manually clearing things up.</span>
<a href="#l162.94"></a><span id="l162.94">  */</span>
<a href="#l162.95"></a><span id="l162.95" class="difflineminus">-function test_selection_stabilization_logic() {</span>
<a href="#l162.96"></a><span id="l162.96" class="difflineplus">+add_task(function test_selection_stabilization_logic() {</span>
<a href="#l162.97"></a><span id="l162.97">   // make sure all summarization has run to completion.</span>
<a href="#l162.98"></a><span id="l162.98">   mc.sleep(0);</span>
<a href="#l162.99"></a><span id="l162.99">   // make it inconceivable that the timeout happens.</span>
<a href="#l162.100"></a><span id="l162.100">   mc.window.MessageDisplayWidget.prototype.SUMMARIZATION_SELECTION_STABILITY_INTERVAL_MS = 10000;</span>
<a href="#l162.101"></a><span id="l162.101">   // does not summarize anything, does not affect timer</span>
<a href="#l162.102"></a><span id="l162.102">   select_click_row(0);</span>
<a href="#l162.103"></a><span id="l162.103">   // does summarize things.  timer will be tick tick ticking!</span>
<a href="#l162.104"></a><span id="l162.104">   select_shift_click_row(1);</span>
<a href="#l162.105"></a><span id="l162.105" class="difflineat">@@ -189,19 +189,19 @@ function test_selection_stabilization_lo</span>
<a href="#l162.106"></a><span id="l162.106">   // - pretend the timer fired.</span>
<a href="#l162.107"></a><span id="l162.107">   // we need to de-schedule the timer, but do not need to clear the variable</span>
<a href="#l162.108"></a><span id="l162.108">   //  because it will just get overwritten anyways</span>
<a href="#l162.109"></a><span id="l162.109">   mc.window.clearTimeout(mc.messageDisplay._summaryStabilityTimeout);</span>
<a href="#l162.110"></a><span id="l162.110">   mc.messageDisplay._showSummary(true);</span>
<a href="#l162.111"></a><span id="l162.111"> </span>
<a href="#l162.112"></a><span id="l162.112">   // - the summary should now be up-to-date</span>
<a href="#l162.113"></a><span id="l162.113">   assert_selected_and_displayed([0, 2]);</span>
<a href="#l162.114"></a><span id="l162.114" class="difflineminus">-}</span>
<a href="#l162.115"></a><span id="l162.115" class="difflineplus">+});</span>
<a href="#l162.116"></a><span id="l162.116"> </span>
<a href="#l162.117"></a><span id="l162.117" class="difflineminus">-function test_summarization_thread_detection() {</span>
<a href="#l162.118"></a><span id="l162.118" class="difflineplus">+add_task(function test_summarization_thread_detection() {</span>
<a href="#l162.119"></a><span id="l162.119">   select_none();</span>
<a href="#l162.120"></a><span id="l162.120">   assert_nothing_selected();</span>
<a href="#l162.121"></a><span id="l162.121">   make_display_threaded();</span>
<a href="#l162.122"></a><span id="l162.122">   select_click_row(0);</span>
<a href="#l162.123"></a><span id="l162.123">   select_shift_click_row(9);</span>
<a href="#l162.124"></a><span id="l162.124">   let messages = mc.folderDisplay.selectedMessages;</span>
<a href="#l162.125"></a><span id="l162.125">   toggle_thread_row(0);</span>
<a href="#l162.126"></a><span id="l162.126">   assert_messages_summarized(mc, messages);</span>
<a href="#l162.127"></a><span id="l162.127" class="difflineat">@@ -212,28 +212,28 @@ function test_summarization_thread_detec</span>
<a href="#l162.128"></a><span id="l162.128">   assert_summary_contains_N_elts(&quot;.item_header &gt; .date&quot;, 0);</span>
<a href="#l162.129"></a><span id="l162.129">   assert_summary_contains_N_elts(&quot;.item_header &gt; .subject&quot;, 2);</span>
<a href="#l162.130"></a><span id="l162.130">   select_none();</span>
<a href="#l162.131"></a><span id="l162.131">   assert_nothing_selected();</span>
<a href="#l162.132"></a><span id="l162.132">   select_click_row(1); // select a single message</span>
<a href="#l162.133"></a><span id="l162.133">   select_shift_click_row(2); // add a thread</span>
<a href="#l162.134"></a><span id="l162.134">   assert_summary_contains_N_elts(&quot;.item_header &gt; .date&quot;, 0);</span>
<a href="#l162.135"></a><span id="l162.135">   assert_summary_contains_N_elts(&quot;.item_header &gt; .subject&quot;, 2);</span>
<a href="#l162.136"></a><span id="l162.136" class="difflineminus">-}</span>
<a href="#l162.137"></a><span id="l162.137" class="difflineplus">+});</span>
<a href="#l162.138"></a><span id="l162.138"> </span>
<a href="#l162.139"></a><span id="l162.139"> /**</span>
<a href="#l162.140"></a><span id="l162.140">  * If you are looking at a message that becomes part of a thread because of the</span>
<a href="#l162.141"></a><span id="l162.141">  *  arrival of a new message, expand the thread so you do not have the message</span>
<a href="#l162.142"></a><span id="l162.142">  *  turn into a summary beneath your feet.</span>
<a href="#l162.143"></a><span id="l162.143">  *</span>
<a href="#l162.144"></a><span id="l162.144">  * There are really two cases here:</span>
<a href="#l162.145"></a><span id="l162.145">  * - The thread gets moved because its sorted position changes.</span>
<a href="#l162.146"></a><span id="l162.146">  * - The thread does not move.</span>
<a href="#l162.147"></a><span id="l162.147">  */</span>
<a href="#l162.148"></a><span id="l162.148" class="difflineminus">-function test_new_thread_that_was_not_summarized_expands() {</span>
<a href="#l162.149"></a><span id="l162.149" class="difflineplus">+add_task(function test_new_thread_that_was_not_summarized_expands() {</span>
<a href="#l162.150"></a><span id="l162.150">   be_in_folder(folder);</span>
<a href="#l162.151"></a><span id="l162.151">   make_display_threaded();</span>
<a href="#l162.152"></a><span id="l162.152"> </span>
<a href="#l162.153"></a><span id="l162.153">   // - create the base messages</span>
<a href="#l162.154"></a><span id="l162.154">   let [willMoveMsg, willNotMoveMsg] = make_new_sets_in_folders(</span>
<a href="#l162.155"></a><span id="l162.155">     [folder],</span>
<a href="#l162.156"></a><span id="l162.156">     [{ count: 1 }, { count: 1 }]</span>
<a href="#l162.157"></a><span id="l162.157">   );</span>
<a href="#l162.158"></a><span id="l162.158" class="difflineat">@@ -252,46 +252,48 @@ function test_new_thread_that_was_not_su</span>
<a href="#l162.159"></a><span id="l162.159">   // - do the move case</span>
<a href="#l162.160"></a><span id="l162.160">   select_click_row(willMoveMsg);</span>
<a href="#l162.161"></a><span id="l162.161">   assert_selected_and_displayed(willMoveMsg);</span>
<a href="#l162.162"></a><span id="l162.162"> </span>
<a href="#l162.163"></a><span id="l162.163">   // give it a friend...</span>
<a href="#l162.164"></a><span id="l162.164">   make_new_sets_in_folders([folder], [{ count: 1, inReplyTo: willMoveMsg }]);</span>
<a href="#l162.165"></a><span id="l162.165">   assert_expanded(willMoveMsg);</span>
<a href="#l162.166"></a><span id="l162.166">   assert_selected_and_displayed(willMoveMsg);</span>
<a href="#l162.167"></a><span id="l162.167" class="difflineminus">-}</span>
<a href="#l162.168"></a><span id="l162.168" class="difflineplus">+});</span>
<a href="#l162.169"></a><span id="l162.169"> </span>
<a href="#l162.170"></a><span id="l162.170"> /**</span>
<a href="#l162.171"></a><span id="l162.171">  * Selecting an existing (and collapsed) thread, then add a message and make</span>
<a href="#l162.172"></a><span id="l162.172">  *  sure the summary updates.</span>
<a href="#l162.173"></a><span id="l162.173">  */</span>
<a href="#l162.174"></a><span id="l162.174" class="difflineminus">-function test_summary_updates_when_new_message_added_to_collapsed_thread() {</span>
<a href="#l162.175"></a><span id="l162.175" class="difflineminus">-  be_in_folder(folder);</span>
<a href="#l162.176"></a><span id="l162.176" class="difflineminus">-  make_display_threaded();</span>
<a href="#l162.177"></a><span id="l162.177" class="difflineminus">-  collapse_all_threads();</span>
<a href="#l162.178"></a><span id="l162.178" class="difflineplus">+add_task(</span>
<a href="#l162.179"></a><span id="l162.179" class="difflineplus">+  function test_summary_updates_when_new_message_added_to_collapsed_thread() {</span>
<a href="#l162.180"></a><span id="l162.180" class="difflineplus">+    be_in_folder(folder);</span>
<a href="#l162.181"></a><span id="l162.181" class="difflineplus">+    make_display_threaded();</span>
<a href="#l162.182"></a><span id="l162.182" class="difflineplus">+    collapse_all_threads();</span>
<a href="#l162.183"></a><span id="l162.183"> </span>
<a href="#l162.184"></a><span id="l162.184" class="difflineminus">-  // - select the thread root, thereby summarizing it</span>
<a href="#l162.185"></a><span id="l162.185" class="difflineminus">-  let thread1Root = select_click_row(thread1); // this just uses the root msg</span>
<a href="#l162.186"></a><span id="l162.186" class="difflineminus">-  assert_collapsed(thread1Root);</span>
<a href="#l162.187"></a><span id="l162.187" class="difflineminus">-  // just the thread root should be selected</span>
<a href="#l162.188"></a><span id="l162.188" class="difflineminus">-  assert_selected(thread1Root);</span>
<a href="#l162.189"></a><span id="l162.189" class="difflineminus">-  // but the whole thread should be summarized</span>
<a href="#l162.190"></a><span id="l162.190" class="difflineminus">-  assert_messages_summarized(mc, thread1);</span>
<a href="#l162.191"></a><span id="l162.191" class="difflineplus">+    // - select the thread root, thereby summarizing it</span>
<a href="#l162.192"></a><span id="l162.192" class="difflineplus">+    let thread1Root = select_click_row(thread1); // this just uses the root msg</span>
<a href="#l162.193"></a><span id="l162.193" class="difflineplus">+    assert_collapsed(thread1Root);</span>
<a href="#l162.194"></a><span id="l162.194" class="difflineplus">+    // just the thread root should be selected</span>
<a href="#l162.195"></a><span id="l162.195" class="difflineplus">+    assert_selected(thread1Root);</span>
<a href="#l162.196"></a><span id="l162.196" class="difflineplus">+    // but the whole thread should be summarized</span>
<a href="#l162.197"></a><span id="l162.197" class="difflineplus">+    assert_messages_summarized(mc, thread1);</span>
<a href="#l162.198"></a><span id="l162.198"> </span>
<a href="#l162.199"></a><span id="l162.199" class="difflineminus">-  // - add a new message, make sure it's in the summary now.</span>
<a href="#l162.200"></a><span id="l162.200" class="difflineminus">-  let [thread1Extra] = make_new_sets_in_folders(</span>
<a href="#l162.201"></a><span id="l162.201" class="difflineminus">-    [folder],</span>
<a href="#l162.202"></a><span id="l162.202" class="difflineminus">-    [{ count: 1, inReplyTo: thread1 }]</span>
<a href="#l162.203"></a><span id="l162.203" class="difflineminus">-  );</span>
<a href="#l162.204"></a><span id="l162.204" class="difflineminus">-  let thread1All = thread1.union(thread1Extra);</span>
<a href="#l162.205"></a><span id="l162.205" class="difflineminus">-  assert_selected(thread1Root);</span>
<a href="#l162.206"></a><span id="l162.206" class="difflineminus">-  assert_messages_summarized(mc, thread1All);</span>
<a href="#l162.207"></a><span id="l162.207" class="difflineminus">-}</span>
<a href="#l162.208"></a><span id="l162.208" class="difflineplus">+    // - add a new message, make sure it's in the summary now.</span>
<a href="#l162.209"></a><span id="l162.209" class="difflineplus">+    let [thread1Extra] = make_new_sets_in_folders(</span>
<a href="#l162.210"></a><span id="l162.210" class="difflineplus">+      [folder],</span>
<a href="#l162.211"></a><span id="l162.211" class="difflineplus">+      [{ count: 1, inReplyTo: thread1 }]</span>
<a href="#l162.212"></a><span id="l162.212" class="difflineplus">+    );</span>
<a href="#l162.213"></a><span id="l162.213" class="difflineplus">+    let thread1All = thread1.union(thread1Extra);</span>
<a href="#l162.214"></a><span id="l162.214" class="difflineplus">+    assert_selected(thread1Root);</span>
<a href="#l162.215"></a><span id="l162.215" class="difflineplus">+    assert_messages_summarized(mc, thread1All);</span>
<a href="#l162.216"></a><span id="l162.216" class="difflineplus">+  }</span>
<a href="#l162.217"></a><span id="l162.217" class="difflineplus">+);</span>
<a href="#l162.218"></a><span id="l162.218"> </span>
<a href="#l162.219"></a><span id="l162.219" class="difflineminus">-function test_summary_when_multiple_identities() {</span>
<a href="#l162.220"></a><span id="l162.220" class="difflineplus">+add_task(function test_summary_when_multiple_identities() {</span>
<a href="#l162.221"></a><span id="l162.221">   // First half of the test, makes sure messageDisplay.js understands there's</span>
<a href="#l162.222"></a><span id="l162.222">   // only one thread</span>
<a href="#l162.223"></a><span id="l162.223">   let folder1 = create_folder(&quot;Search1&quot;);</span>
<a href="#l162.224"></a><span id="l162.224">   be_in_folder(folder1);</span>
<a href="#l162.225"></a><span id="l162.225">   let thread1 = create_thread(1);</span>
<a href="#l162.226"></a><span id="l162.226">   add_sets_to_folders([folder1], [thread1]);</span>
<a href="#l162.227"></a><span id="l162.227"> </span>
<a href="#l162.228"></a><span id="l162.228">   let folder2 = create_folder(&quot;Search2&quot;);</span>
<a href="#l162.229"></a><span id="l162.229" class="difflineat">@@ -338,17 +340,17 @@ function test_summary_when_multiple_iden</span>
<a href="#l162.230"></a><span id="l162.230">   // Second half of the test, makes sure MultiMessageSummary groups messages</span>
<a href="#l162.231"></a><span id="l162.231">   // according to their view thread id</span>
<a href="#l162.232"></a><span id="l162.232">   thread1 = create_thread(1);</span>
<a href="#l162.233"></a><span id="l162.233">   add_sets_to_folders([folder1], [thread1]);</span>
<a href="#l162.234"></a><span id="l162.234">   be_in_folder(folderVirtual);</span>
<a href="#l162.235"></a><span id="l162.235">   select_shift_click_row(1);</span>
<a href="#l162.236"></a><span id="l162.236"> </span>
<a href="#l162.237"></a><span id="l162.237">   assert_summary_contains_N_elts(&quot;.item_header &gt; .subject&quot;, 2);</span>
<a href="#l162.238"></a><span id="l162.238" class="difflineminus">-}</span>
<a href="#l162.239"></a><span id="l162.239" class="difflineplus">+});</span>
<a href="#l162.240"></a><span id="l162.240"> </span>
<a href="#l162.241"></a><span id="l162.241"> function extract_first_address(thread) {</span>
<a href="#l162.242"></a><span id="l162.242">   let addresses = MailServices.headerParser.parseEncodedHeader(</span>
<a href="#l162.243"></a><span id="l162.243">     thread1.getMsgHdr(0).mime2DecodedAuthor</span>
<a href="#l162.244"></a><span id="l162.244">   );</span>
<a href="#l162.245"></a><span id="l162.245">   return addresses[0];</span>
<a href="#l162.246"></a><span id="l162.246"> }</span>
<a href="#l162.247"></a><span id="l162.247"> </span>
<a href="#l162.248"></a><span id="l162.248" class="difflineat">@@ -361,46 +363,53 @@ function check_address_name(name) {</span>
<a href="#l162.249"></a><span id="l162.249">         name +</span>
<a href="#l162.250"></a><span id="l162.250">         &quot;', found '&quot; +</span>
<a href="#l162.251"></a><span id="l162.251">         match.textContent +</span>
<a href="#l162.252"></a><span id="l162.252">         &quot;'&quot;</span>
<a href="#l162.253"></a><span id="l162.253">     );</span>
<a href="#l162.254"></a><span id="l162.254">   }</span>
<a href="#l162.255"></a><span id="l162.255"> }</span>
<a href="#l162.256"></a><span id="l162.256"> </span>
<a href="#l162.257"></a><span id="l162.257" class="difflineminus">-function test_display_name_no_abook() {</span>
<a href="#l162.258"></a><span id="l162.258" class="difflineplus">+add_task(function test_display_name_no_abook() {</span>
<a href="#l162.259"></a><span id="l162.259">   be_in_folder(folder);</span>
<a href="#l162.260"></a><span id="l162.260"> </span>
<a href="#l162.261"></a><span id="l162.261">   let address = extract_first_address(thread1);</span>
<a href="#l162.262"></a><span id="l162.262">   ensure_no_card_exists(address.email);</span>
<a href="#l162.263"></a><span id="l162.263"> </span>
<a href="#l162.264"></a><span id="l162.264">   collapse_all_threads();</span>
<a href="#l162.265"></a><span id="l162.265">   select_click_row(thread1);</span>
<a href="#l162.266"></a><span id="l162.266"> </span>
<a href="#l162.267"></a><span id="l162.267">   // No address book entry, we display name and e-mail address.</span>
<a href="#l162.268"></a><span id="l162.268">   check_address_name(address.name + &quot; &lt;&quot; + address.email + &quot;&gt;&quot;);</span>
<a href="#l162.269"></a><span id="l162.269" class="difflineminus">-}</span>
<a href="#l162.270"></a><span id="l162.270" class="difflineplus">+});</span>
<a href="#l162.271"></a><span id="l162.271"> </span>
<a href="#l162.272"></a><span id="l162.272" class="difflineminus">-function test_display_name_abook() {</span>
<a href="#l162.273"></a><span id="l162.273" class="difflineplus">+add_task(function test_display_name_abook() {</span>
<a href="#l162.274"></a><span id="l162.274">   be_in_folder(folder);</span>
<a href="#l162.275"></a><span id="l162.275"> </span>
<a href="#l162.276"></a><span id="l162.276">   let address = extract_first_address(thread1);</span>
<a href="#l162.277"></a><span id="l162.277">   ensure_card_exists(address.email, &quot;My Friend&quot;, true);</span>
<a href="#l162.278"></a><span id="l162.278"> </span>
<a href="#l162.279"></a><span id="l162.279">   collapse_all_threads();</span>
<a href="#l162.280"></a><span id="l162.280">   select_click_row(thread1);</span>
<a href="#l162.281"></a><span id="l162.281"> </span>
<a href="#l162.282"></a><span id="l162.282">   check_address_name(&quot;My Friend&quot;);</span>
<a href="#l162.283"></a><span id="l162.283" class="difflineminus">-}</span>
<a href="#l162.284"></a><span id="l162.284" class="difflineplus">+});</span>
<a href="#l162.285"></a><span id="l162.285"> </span>
<a href="#l162.286"></a><span id="l162.286" class="difflineminus">-function test_display_name_abook_no_pdn() {</span>
<a href="#l162.287"></a><span id="l162.287" class="difflineplus">+add_task(function test_display_name_abook_no_pdn() {</span>
<a href="#l162.288"></a><span id="l162.288">   be_in_folder(folder);</span>
<a href="#l162.289"></a><span id="l162.289"> </span>
<a href="#l162.290"></a><span id="l162.290">   let address = extract_first_address(thread1);</span>
<a href="#l162.291"></a><span id="l162.291">   ensure_card_exists(address.email, &quot;My Friend&quot;, false);</span>
<a href="#l162.292"></a><span id="l162.292"> </span>
<a href="#l162.293"></a><span id="l162.293">   collapse_all_threads();</span>
<a href="#l162.294"></a><span id="l162.294">   select_click_row(thread1);</span>
<a href="#l162.295"></a><span id="l162.295"> </span>
<a href="#l162.296"></a><span id="l162.296">   // With address book entry but display name not preferred, we display name and</span>
<a href="#l162.297"></a><span id="l162.297">   // e-mail address.</span>
<a href="#l162.298"></a><span id="l162.298">   check_address_name(address.name + &quot; &lt;&quot; + address.email + &quot;&gt;&quot;);</span>
<a href="#l162.299"></a><span id="l162.299" class="difflineminus">-}</span>
<a href="#l162.300"></a><span id="l162.300" class="difflineplus">+</span>
<a href="#l162.301"></a><span id="l162.301" class="difflineplus">+  Assert.report(</span>
<a href="#l162.302"></a><span id="l162.302" class="difflineplus">+    false,</span>
<a href="#l162.303"></a><span id="l162.303" class="difflineplus">+    undefined,</span>
<a href="#l162.304"></a><span id="l162.304" class="difflineplus">+    undefined,</span>
<a href="#l162.305"></a><span id="l162.305" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l162.306"></a><span id="l162.306" class="difflineplus">+  );</span>
<a href="#l162.307"></a><span id="l162.307" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l163.1"></a><span id="l163.1">copy from mail/test/mozmill/folder-display/test-tabs-simple.js</span>
<a href="#l163.2"></a><span id="l163.2">copy to mail/test/browser/folder-display/browser_tabsSimple.js</span>
<a href="#l163.3"></a><span id="l163.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-tabs-simple.js</span>
<a href="#l163.4"></a><span id="l163.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_tabsSimple.js</span>
<a href="#l163.5"></a><span id="l163.5" class="difflineat">@@ -34,155 +34,162 @@ var {</span>
<a href="#l163.6"></a><span id="l163.6">   switch_tab,</span>
<a href="#l163.7"></a><span id="l163.7">   wait_for_blank_content_pane,</span>
<a href="#l163.8"></a><span id="l163.8"> } = ChromeUtils.import(</span>
<a href="#l163.9"></a><span id="l163.9">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l163.10"></a><span id="l163.10"> );</span>
<a href="#l163.11"></a><span id="l163.11"> </span>
<a href="#l163.12"></a><span id="l163.12"> var folderA, folderB, setA, setB;</span>
<a href="#l163.13"></a><span id="l163.13"> </span>
<a href="#l163.14"></a><span id="l163.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l163.15"></a><span id="l163.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l163.16"></a><span id="l163.16">   folderA = create_folder(&quot;TabsSimpleA&quot;);</span>
<a href="#l163.17"></a><span id="l163.17">   folderB = create_folder(&quot;TabsSimpleB&quot;);</span>
<a href="#l163.18"></a><span id="l163.18"> </span>
<a href="#l163.19"></a><span id="l163.19">   // We will verify we are seeing the right folder by checking that it has the</span>
<a href="#l163.20"></a><span id="l163.20">   //  right messages in it.</span>
<a href="#l163.21"></a><span id="l163.21">   [setA] = make_new_sets_in_folder(folderA, [{}]);</span>
<a href="#l163.22"></a><span id="l163.22">   [setB] = make_new_sets_in_folder(folderB, [{}]);</span>
<a href="#l163.23"></a><span id="l163.23" class="difflineminus">-}</span>
<a href="#l163.24"></a><span id="l163.24" class="difflineplus">+});</span>
<a href="#l163.25"></a><span id="l163.25"> </span>
<a href="#l163.26"></a><span id="l163.26"> /** The tabs in our test. */</span>
<a href="#l163.27"></a><span id="l163.27"> var tabFolderA, tabFolderB, tabMessageA, tabMessageB;</span>
<a href="#l163.28"></a><span id="l163.28"> /** The message that we selected for tab display, to check it worked right. */</span>
<a href="#l163.29"></a><span id="l163.29"> var messageA, messageB;</span>
<a href="#l163.30"></a><span id="l163.30"> </span>
<a href="#l163.31"></a><span id="l163.31"> /**</span>
<a href="#l163.32"></a><span id="l163.32">  * Make sure the default tab works right.</span>
<a href="#l163.33"></a><span id="l163.33">  */</span>
<a href="#l163.34"></a><span id="l163.34" class="difflineminus">-function test_open_folder_a() {</span>
<a href="#l163.35"></a><span id="l163.35" class="difflineplus">+add_task(function test_open_folder_a() {</span>
<a href="#l163.36"></a><span id="l163.36">   tabFolderA = be_in_folder(folderA);</span>
<a href="#l163.37"></a><span id="l163.37">   assert_messages_in_view(setA);</span>
<a href="#l163.38"></a><span id="l163.38">   assert_nothing_selected();</span>
<a href="#l163.39"></a><span id="l163.39">   // Focus the folder tree here</span>
<a href="#l163.40"></a><span id="l163.40">   focus_folder_tree();</span>
<a href="#l163.41"></a><span id="l163.41" class="difflineminus">-}</span>
<a href="#l163.42"></a><span id="l163.42" class="difflineplus">+});</span>
<a href="#l163.43"></a><span id="l163.43"> </span>
<a href="#l163.44"></a><span id="l163.44"> /**</span>
<a href="#l163.45"></a><span id="l163.45">  * Open tab b, make sure it works right.</span>
<a href="#l163.46"></a><span id="l163.46">  */</span>
<a href="#l163.47"></a><span id="l163.47" class="difflineminus">-function test_open_folder_b_in_tab() {</span>
<a href="#l163.48"></a><span id="l163.48" class="difflineplus">+add_task(function test_open_folder_b_in_tab() {</span>
<a href="#l163.49"></a><span id="l163.49">   tabFolderB = open_folder_in_new_tab(folderB);</span>
<a href="#l163.50"></a><span id="l163.50">   wait_for_blank_content_pane();</span>
<a href="#l163.51"></a><span id="l163.51">   assert_messages_in_view(setB);</span>
<a href="#l163.52"></a><span id="l163.52">   assert_nothing_selected();</span>
<a href="#l163.53"></a><span id="l163.53">   focus_thread_tree();</span>
<a href="#l163.54"></a><span id="l163.54" class="difflineminus">-}</span>
<a href="#l163.55"></a><span id="l163.55" class="difflineplus">+});</span>
<a href="#l163.56"></a><span id="l163.56"> </span>
<a href="#l163.57"></a><span id="l163.57"> /**</span>
<a href="#l163.58"></a><span id="l163.58">  * Go back to tab/folder A and make sure we change correctly.</span>
<a href="#l163.59"></a><span id="l163.59">  */</span>
<a href="#l163.60"></a><span id="l163.60" class="difflineminus">-function test_switch_to_tab_folder_a() {</span>
<a href="#l163.61"></a><span id="l163.61" class="difflineplus">+add_task(function test_switch_to_tab_folder_a() {</span>
<a href="#l163.62"></a><span id="l163.62">   switch_tab(tabFolderA);</span>
<a href="#l163.63"></a><span id="l163.63">   assert_messages_in_view(setA);</span>
<a href="#l163.64"></a><span id="l163.64">   assert_nothing_selected();</span>
<a href="#l163.65"></a><span id="l163.65">   assert_folder_tree_focused();</span>
<a href="#l163.66"></a><span id="l163.66" class="difflineminus">-}</span>
<a href="#l163.67"></a><span id="l163.67" class="difflineplus">+});</span>
<a href="#l163.68"></a><span id="l163.68"> </span>
<a href="#l163.69"></a><span id="l163.69"> /**</span>
<a href="#l163.70"></a><span id="l163.70">  * Select a message in folder A and open it in a new window, making sure that</span>
<a href="#l163.71"></a><span id="l163.71">  *  the displayed message is the right one.</span>
<a href="#l163.72"></a><span id="l163.72">  */</span>
<a href="#l163.73"></a><span id="l163.73" class="difflineminus">-function test_open_message_a_in_tab() {</span>
<a href="#l163.74"></a><span id="l163.74" class="difflineplus">+add_task(function test_open_message_a_in_tab() {</span>
<a href="#l163.75"></a><span id="l163.75">   // (this focuses the thread tree for tabFolderA...)</span>
<a href="#l163.76"></a><span id="l163.76">   messageA = select_click_row(0);</span>
<a href="#l163.77"></a><span id="l163.77">   // (...refocus the folder tree for our sticky check below)</span>
<a href="#l163.78"></a><span id="l163.78">   focus_folder_tree();</span>
<a href="#l163.79"></a><span id="l163.79">   tabMessageA = open_selected_message_in_new_tab();</span>
<a href="#l163.80"></a><span id="l163.80">   assert_selected_and_displayed(messageA);</span>
<a href="#l163.81"></a><span id="l163.81">   assert_message_pane_focused();</span>
<a href="#l163.82"></a><span id="l163.82" class="difflineminus">-}</span>
<a href="#l163.83"></a><span id="l163.83" class="difflineplus">+});</span>
<a href="#l163.84"></a><span id="l163.84"> </span>
<a href="#l163.85"></a><span id="l163.85"> /**</span>
<a href="#l163.86"></a><span id="l163.86">  * Go back to tab/folder B and make sure we change correctly.</span>
<a href="#l163.87"></a><span id="l163.87">  */</span>
<a href="#l163.88"></a><span id="l163.88" class="difflineminus">-function test_switch_to_tab_folder_b() {</span>
<a href="#l163.89"></a><span id="l163.89" class="difflineplus">+add_task(function test_switch_to_tab_folder_b() {</span>
<a href="#l163.90"></a><span id="l163.90">   switch_tab(tabFolderB);</span>
<a href="#l163.91"></a><span id="l163.91">   assert_messages_in_view(setB);</span>
<a href="#l163.92"></a><span id="l163.92">   assert_nothing_selected();</span>
<a href="#l163.93"></a><span id="l163.93">   assert_thread_tree_focused();</span>
<a href="#l163.94"></a><span id="l163.94" class="difflineminus">-}</span>
<a href="#l163.95"></a><span id="l163.95" class="difflineplus">+});</span>
<a href="#l163.96"></a><span id="l163.96"> </span>
<a href="#l163.97"></a><span id="l163.97"> /**</span>
<a href="#l163.98"></a><span id="l163.98">  * Select a message in folder B and open it in a new window, making sure that</span>
<a href="#l163.99"></a><span id="l163.99">  *  the displayed message is the right one.</span>
<a href="#l163.100"></a><span id="l163.100">  */</span>
<a href="#l163.101"></a><span id="l163.101" class="difflineminus">-function test_open_message_b_in_tab() {</span>
<a href="#l163.102"></a><span id="l163.102" class="difflineplus">+add_task(function test_open_message_b_in_tab() {</span>
<a href="#l163.103"></a><span id="l163.103">   messageB = select_click_row(0);</span>
<a href="#l163.104"></a><span id="l163.104">   // Let's focus the message pane now</span>
<a href="#l163.105"></a><span id="l163.105">   focus_message_pane();</span>
<a href="#l163.106"></a><span id="l163.106">   tabMessageB = open_selected_message_in_new_tab();</span>
<a href="#l163.107"></a><span id="l163.107">   assert_selected_and_displayed(messageB);</span>
<a href="#l163.108"></a><span id="l163.108">   assert_message_pane_focused();</span>
<a href="#l163.109"></a><span id="l163.109" class="difflineminus">-}</span>
<a href="#l163.110"></a><span id="l163.110" class="difflineplus">+});</span>
<a href="#l163.111"></a><span id="l163.111"> </span>
<a href="#l163.112"></a><span id="l163.112"> /**</span>
<a href="#l163.113"></a><span id="l163.113">  * Switch to message tab A.</span>
<a href="#l163.114"></a><span id="l163.114">  */</span>
<a href="#l163.115"></a><span id="l163.115" class="difflineminus">-function test_switch_to_message_a() {</span>
<a href="#l163.116"></a><span id="l163.116" class="difflineplus">+add_task(function test_switch_to_message_a() {</span>
<a href="#l163.117"></a><span id="l163.117">   switch_tab(tabMessageA);</span>
<a href="#l163.118"></a><span id="l163.118">   assert_selected_and_displayed(messageA);</span>
<a href="#l163.119"></a><span id="l163.119">   assert_message_pane_focused();</span>
<a href="#l163.120"></a><span id="l163.120" class="difflineminus">-}</span>
<a href="#l163.121"></a><span id="l163.121" class="difflineplus">+});</span>
<a href="#l163.122"></a><span id="l163.122"> </span>
<a href="#l163.123"></a><span id="l163.123"> /**</span>
<a href="#l163.124"></a><span id="l163.124">  * Close message tab A (when it's in the foreground).</span>
<a href="#l163.125"></a><span id="l163.125">  */</span>
<a href="#l163.126"></a><span id="l163.126" class="difflineminus">-function test_close_message_a() {</span>
<a href="#l163.127"></a><span id="l163.127" class="difflineplus">+add_task(function test_close_message_a() {</span>
<a href="#l163.128"></a><span id="l163.128">   close_tab();</span>
<a href="#l163.129"></a><span id="l163.129">   // our current tab is now undefined for the purposes of this test.</span>
<a href="#l163.130"></a><span id="l163.130" class="difflineminus">-}</span>
<a href="#l163.131"></a><span id="l163.131" class="difflineplus">+});</span>
<a href="#l163.132"></a><span id="l163.132"> </span>
<a href="#l163.133"></a><span id="l163.133"> /**</span>
<a href="#l163.134"></a><span id="l163.134">  * Make sure all the other tabs are still happy.</span>
<a href="#l163.135"></a><span id="l163.135">  */</span>
<a href="#l163.136"></a><span id="l163.136" class="difflineminus">-function test_tabs_are_still_happy() {</span>
<a href="#l163.137"></a><span id="l163.137" class="difflineplus">+add_task(function test_tabs_are_still_happy() {</span>
<a href="#l163.138"></a><span id="l163.138">   switch_tab(tabFolderB);</span>
<a href="#l163.139"></a><span id="l163.139">   assert_messages_in_view(setB);</span>
<a href="#l163.140"></a><span id="l163.140">   assert_selected_and_displayed(messageB);</span>
<a href="#l163.141"></a><span id="l163.141">   assert_message_pane_focused();</span>
<a href="#l163.142"></a><span id="l163.142"> </span>
<a href="#l163.143"></a><span id="l163.143">   switch_tab(tabMessageB);</span>
<a href="#l163.144"></a><span id="l163.144">   assert_selected_and_displayed(messageB);</span>
<a href="#l163.145"></a><span id="l163.145">   assert_message_pane_focused();</span>
<a href="#l163.146"></a><span id="l163.146"> </span>
<a href="#l163.147"></a><span id="l163.147">   switch_tab(tabFolderA);</span>
<a href="#l163.148"></a><span id="l163.148">   assert_messages_in_view(setA);</span>
<a href="#l163.149"></a><span id="l163.149">   assert_selected_and_displayed(messageA);</span>
<a href="#l163.150"></a><span id="l163.150">   // focus restoration uses setTimeout(0) and so we need to give it a chance</span>
<a href="#l163.151"></a><span id="l163.151">   mc.sleep(0);</span>
<a href="#l163.152"></a><span id="l163.152">   assert_folder_tree_focused();</span>
<a href="#l163.153"></a><span id="l163.153" class="difflineminus">-}</span>
<a href="#l163.154"></a><span id="l163.154" class="difflineplus">+});</span>
<a href="#l163.155"></a><span id="l163.155"> </span>
<a href="#l163.156"></a><span id="l163.156"> /**</span>
<a href="#l163.157"></a><span id="l163.157">  * Close message tab B (when it's in the background).</span>
<a href="#l163.158"></a><span id="l163.158">  */</span>
<a href="#l163.159"></a><span id="l163.159" class="difflineminus">-function test_close_message_b() {</span>
<a href="#l163.160"></a><span id="l163.160" class="difflineplus">+add_task(function test_close_message_b() {</span>
<a href="#l163.161"></a><span id="l163.161">   close_tab(tabMessageB);</span>
<a href="#l163.162"></a><span id="l163.162">   // we should still be on folder A</span>
<a href="#l163.163"></a><span id="l163.163">   assert_messages_in_view(setA);</span>
<a href="#l163.164"></a><span id="l163.164">   assert_selected_and_displayed(messageA);</span>
<a href="#l163.165"></a><span id="l163.165">   assert_folder_tree_focused();</span>
<a href="#l163.166"></a><span id="l163.166" class="difflineminus">-}</span>
<a href="#l163.167"></a><span id="l163.167" class="difflineplus">+});</span>
<a href="#l163.168"></a><span id="l163.168"> </span>
<a href="#l163.169"></a><span id="l163.169"> /**</span>
<a href="#l163.170"></a><span id="l163.170">  * Switch to tab B, close it, make sure we end up on tab A.</span>
<a href="#l163.171"></a><span id="l163.171">  */</span>
<a href="#l163.172"></a><span id="l163.172" class="difflineminus">-function test_close_folder_b() {</span>
<a href="#l163.173"></a><span id="l163.173" class="difflineplus">+add_task(function test_close_folder_b() {</span>
<a href="#l163.174"></a><span id="l163.174">   switch_tab(tabFolderB);</span>
<a href="#l163.175"></a><span id="l163.175">   assert_messages_in_view(setB);</span>
<a href="#l163.176"></a><span id="l163.176">   assert_selected_and_displayed(messageB);</span>
<a href="#l163.177"></a><span id="l163.177">   assert_message_pane_focused();</span>
<a href="#l163.178"></a><span id="l163.178"> </span>
<a href="#l163.179"></a><span id="l163.179">   close_tab();</span>
<a href="#l163.180"></a><span id="l163.180">   assert_messages_in_view(setA);</span>
<a href="#l163.181"></a><span id="l163.181">   assert_selected_and_displayed(messageA);</span>
<a href="#l163.182"></a><span id="l163.182">   assert_folder_tree_focused();</span>
<a href="#l163.183"></a><span id="l163.183" class="difflineminus">-}</span>
<a href="#l163.184"></a><span id="l163.184" class="difflineplus">+</span>
<a href="#l163.185"></a><span id="l163.185" class="difflineplus">+  Assert.report(</span>
<a href="#l163.186"></a><span id="l163.186" class="difflineplus">+    false,</span>
<a href="#l163.187"></a><span id="l163.187" class="difflineplus">+    undefined,</span>
<a href="#l163.188"></a><span id="l163.188" class="difflineplus">+    undefined,</span>
<a href="#l163.189"></a><span id="l163.189" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l163.190"></a><span id="l163.190" class="difflineplus">+  );</span>
<a href="#l163.191"></a><span id="l163.191" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l164.1"></a><span id="l164.1">copy from mail/test/mozmill/folder-display/test-virtual-folder-commands.js</span>
<a href="#l164.2"></a><span id="l164.2">copy to mail/test/browser/folder-display/browser_virtualFolderCommands.js</span>
<a href="#l164.3"></a><span id="l164.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-virtual-folder-commands.js</span>
<a href="#l164.4"></a><span id="l164.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_virtualFolderCommands.js</span>
<a href="#l164.5"></a><span id="l164.5" class="difflineat">@@ -4,75 +4,74 @@</span>
<a href="#l164.6"></a><span id="l164.6"> </span>
<a href="#l164.7"></a><span id="l164.7"> /*</span>
<a href="#l164.8"></a><span id="l164.8">  * Test that commands on virtual folders work properly.</span>
<a href="#l164.9"></a><span id="l164.9">  */</span>
<a href="#l164.10"></a><span id="l164.10"> </span>
<a href="#l164.11"></a><span id="l164.11"> &quot;use strict&quot;;</span>
<a href="#l164.12"></a><span id="l164.12"> </span>
<a href="#l164.13"></a><span id="l164.13"> var {</span>
<a href="#l164.14"></a><span id="l164.14" class="difflineminus">-  assert_true,</span>
<a href="#l164.15"></a><span id="l164.15">   be_in_folder,</span>
<a href="#l164.16"></a><span id="l164.16">   expand_all_threads,</span>
<a href="#l164.17"></a><span id="l164.17">   make_display_threaded,</span>
<a href="#l164.18"></a><span id="l164.18">   make_folder_with_sets,</span>
<a href="#l164.19"></a><span id="l164.19">   make_virtual_folder,</span>
<a href="#l164.20"></a><span id="l164.20">   mc,</span>
<a href="#l164.21"></a><span id="l164.21">   select_click_row,</span>
<a href="#l164.22"></a><span id="l164.22"> } = ChromeUtils.import(</span>
<a href="#l164.23"></a><span id="l164.23">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l164.24"></a><span id="l164.24"> );</span>
<a href="#l164.25"></a><span id="l164.25"> </span>
<a href="#l164.26"></a><span id="l164.26"> var msgsPerThread = 5;</span>
<a href="#l164.27"></a><span id="l164.27"> var singleVirtFolder;</span>
<a href="#l164.28"></a><span id="l164.28"> var multiVirtFolder;</span>
<a href="#l164.29"></a><span id="l164.29"> </span>
<a href="#l164.30"></a><span id="l164.30" class="difflineminus">-function setupModule(module) {</span>
<a href="#l164.31"></a><span id="l164.31" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l164.32"></a><span id="l164.32">   let [folderOne] = make_folder_with_sets([{ msgsPerThread }]);</span>
<a href="#l164.33"></a><span id="l164.33">   let [folderTwo] = make_folder_with_sets([{ msgsPerThread }]);</span>
<a href="#l164.34"></a><span id="l164.34"> </span>
<a href="#l164.35"></a><span id="l164.35">   singleVirtFolder = make_virtual_folder([folderOne], {});</span>
<a href="#l164.36"></a><span id="l164.36">   multiVirtFolder = make_virtual_folder([folderOne, folderTwo], {});</span>
<a href="#l164.37"></a><span id="l164.37" class="difflineminus">-}</span>
<a href="#l164.38"></a><span id="l164.38" class="difflineplus">+});</span>
<a href="#l164.39"></a><span id="l164.39"> </span>
<a href="#l164.40"></a><span id="l164.40" class="difflineminus">-function test_single_folder_select_thread() {</span>
<a href="#l164.41"></a><span id="l164.41" class="difflineplus">+add_task(function test_single_folder_select_thread() {</span>
<a href="#l164.42"></a><span id="l164.42">   be_in_folder(singleVirtFolder);</span>
<a href="#l164.43"></a><span id="l164.43">   make_display_threaded();</span>
<a href="#l164.44"></a><span id="l164.44">   expand_all_threads();</span>
<a href="#l164.45"></a><span id="l164.45"> </span>
<a href="#l164.46"></a><span id="l164.46">   // Try selecting the thread from the root message.</span>
<a href="#l164.47"></a><span id="l164.47">   select_click_row(0);</span>
<a href="#l164.48"></a><span id="l164.48">   mc.keypress(null, &quot;a&quot;, { accelKey: true, shiftKey: true });</span>
<a href="#l164.49"></a><span id="l164.49" class="difflineminus">-  assert_true(</span>
<a href="#l164.50"></a><span id="l164.50" class="difflineplus">+  Assert.ok(</span>
<a href="#l164.51"></a><span id="l164.51">     mc.folderDisplay.selectedCount == msgsPerThread,</span>
<a href="#l164.52"></a><span id="l164.52">     &quot;Didn't select all messages in the thread!&quot;</span>
<a href="#l164.53"></a><span id="l164.53">   );</span>
<a href="#l164.54"></a><span id="l164.54"> </span>
<a href="#l164.55"></a><span id="l164.55">   // Now try selecting the thread from a non-root message.</span>
<a href="#l164.56"></a><span id="l164.56">   select_click_row(1);</span>
<a href="#l164.57"></a><span id="l164.57">   mc.keypress(null, &quot;a&quot;, { accelKey: true, shiftKey: true });</span>
<a href="#l164.58"></a><span id="l164.58" class="difflineminus">-  assert_true(</span>
<a href="#l164.59"></a><span id="l164.59" class="difflineplus">+  Assert.ok(</span>
<a href="#l164.60"></a><span id="l164.60">     mc.folderDisplay.selectedCount == msgsPerThread,</span>
<a href="#l164.61"></a><span id="l164.61">     &quot;Didn't select all messages in the thread!&quot;</span>
<a href="#l164.62"></a><span id="l164.62">   );</span>
<a href="#l164.63"></a><span id="l164.63" class="difflineminus">-}</span>
<a href="#l164.64"></a><span id="l164.64" class="difflineplus">+});</span>
<a href="#l164.65"></a><span id="l164.65"> </span>
<a href="#l164.66"></a><span id="l164.66" class="difflineminus">-function test_cross_folder_select_thread() {</span>
<a href="#l164.67"></a><span id="l164.67" class="difflineplus">+add_task(function test_cross_folder_select_thread() {</span>
<a href="#l164.68"></a><span id="l164.68">   be_in_folder(multiVirtFolder);</span>
<a href="#l164.69"></a><span id="l164.69">   make_display_threaded();</span>
<a href="#l164.70"></a><span id="l164.70">   expand_all_threads();</span>
<a href="#l164.71"></a><span id="l164.71"> </span>
<a href="#l164.72"></a><span id="l164.72">   // Try selecting the thread from the root message.</span>
<a href="#l164.73"></a><span id="l164.73">   select_click_row(0);</span>
<a href="#l164.74"></a><span id="l164.74">   mc.keypress(null, &quot;a&quot;, { accelKey: true, shiftKey: true });</span>
<a href="#l164.75"></a><span id="l164.75" class="difflineminus">-  assert_true(</span>
<a href="#l164.76"></a><span id="l164.76" class="difflineplus">+  Assert.ok(</span>
<a href="#l164.77"></a><span id="l164.77">     mc.folderDisplay.selectedCount == msgsPerThread,</span>
<a href="#l164.78"></a><span id="l164.78">     &quot;Didn't select all messages in the thread!&quot;</span>
<a href="#l164.79"></a><span id="l164.79">   );</span>
<a href="#l164.80"></a><span id="l164.80"> </span>
<a href="#l164.81"></a><span id="l164.81">   // Now try selecting the thread from a non-root message.</span>
<a href="#l164.82"></a><span id="l164.82">   select_click_row(1);</span>
<a href="#l164.83"></a><span id="l164.83">   mc.keypress(null, &quot;a&quot;, { accelKey: true, shiftKey: true });</span>
<a href="#l164.84"></a><span id="l164.84" class="difflineminus">-  assert_true(</span>
<a href="#l164.85"></a><span id="l164.85" class="difflineplus">+  Assert.ok(</span>
<a href="#l164.86"></a><span id="l164.86">     mc.folderDisplay.selectedCount == msgsPerThread,</span>
<a href="#l164.87"></a><span id="l164.87">     &quot;Didn't select all messages in the thread!&quot;</span>
<a href="#l164.88"></a><span id="l164.88">   );</span>
<a href="#l164.89"></a><span id="l164.89" class="difflineminus">-}</span>
<a href="#l164.90"></a><span id="l164.90" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l165.1"></a><span id="l165.1">copy from mail/test/mozmill/folder-display/test-watch-ignore-thread.js</span>
<a href="#l165.2"></a><span id="l165.2">copy to mail/test/browser/folder-display/browser_watchIgnoreThread.js</span>
<a href="#l165.3"></a><span id="l165.3" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-watch-ignore-thread.js</span>
<a href="#l165.4"></a><span id="l165.4" class="difflineplus">+++ b/mail/test/browser/folder-display/browser_watchIgnoreThread.js</span>
<a href="#l165.5"></a><span id="l165.5" class="difflineat">@@ -23,43 +23,43 @@ var {</span>
<a href="#l165.6"></a><span id="l165.6">   select_click_row,</span>
<a href="#l165.7"></a><span id="l165.7"> } = ChromeUtils.import(</span>
<a href="#l165.8"></a><span id="l165.8">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l165.9"></a><span id="l165.9"> );</span>
<a href="#l165.10"></a><span id="l165.10"> </span>
<a href="#l165.11"></a><span id="l165.11"> var folder;</span>
<a href="#l165.12"></a><span id="l165.12"> var thread1, thread2, thread3;</span>
<a href="#l165.13"></a><span id="l165.13"> </span>
<a href="#l165.14"></a><span id="l165.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l165.15"></a><span id="l165.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l165.16"></a><span id="l165.16">   folder = create_folder(&quot;WatchIgnoreThreadTest&quot;);</span>
<a href="#l165.17"></a><span id="l165.17">   thread1 = create_thread(3);</span>
<a href="#l165.18"></a><span id="l165.18">   thread2 = create_thread(4);</span>
<a href="#l165.19"></a><span id="l165.19">   thread3 = create_thread(5);</span>
<a href="#l165.20"></a><span id="l165.20">   add_sets_to_folders([folder], [thread1, thread2, thread3]);</span>
<a href="#l165.21"></a><span id="l165.21"> </span>
<a href="#l165.22"></a><span id="l165.22">   be_in_folder(folder);</span>
<a href="#l165.23"></a><span id="l165.23">   make_display_threaded();</span>
<a href="#l165.24"></a><span id="l165.24">   expand_all_threads();</span>
<a href="#l165.25"></a><span id="l165.25" class="difflineminus">-}</span>
<a href="#l165.26"></a><span id="l165.26" class="difflineplus">+});</span>
<a href="#l165.27"></a><span id="l165.27"> </span>
<a href="#l165.28"></a><span id="l165.28"> /**</span>
<a href="#l165.29"></a><span id="l165.29">  * Click one of the menu items in the appmenu View | Messages menu.</span>
<a href="#l165.30"></a><span id="l165.30">  * @param {string} menuId  The id of the menu item to click.</span>
<a href="#l165.31"></a><span id="l165.31">  */</span>
<a href="#l165.32"></a><span id="l165.32"> function clickViewMessagesItem(menuId) {</span>
<a href="#l165.33"></a><span id="l165.33">   mc.click_through_appmenu(</span>
<a href="#l165.34"></a><span id="l165.34">     [{ id: &quot;appmenu_View&quot; }, { id: &quot;appmenu_viewMessagesMenu&quot; }],</span>
<a href="#l165.35"></a><span id="l165.35">     { id: menuId }</span>
<a href="#l165.36"></a><span id="l165.36">   );</span>
<a href="#l165.37"></a><span id="l165.37"> }</span>
<a href="#l165.38"></a><span id="l165.38"> </span>
<a href="#l165.39"></a><span id="l165.39"> /**</span>
<a href="#l165.40"></a><span id="l165.40">  * Test that Ignore Thread works as expected.</span>
<a href="#l165.41"></a><span id="l165.41">  */</span>
<a href="#l165.42"></a><span id="l165.42" class="difflineminus">-function test_ignore_thread() {</span>
<a href="#l165.43"></a><span id="l165.43" class="difflineplus">+add_task(function test_ignore_thread() {</span>
<a href="#l165.44"></a><span id="l165.44">   let t1root = thread1.getMsgHdr(0);</span>
<a href="#l165.45"></a><span id="l165.45"> </span>
<a href="#l165.46"></a><span id="l165.46">   let t1second = select_click_row(1);</span>
<a href="#l165.47"></a><span id="l165.47">   assert_selected_and_displayed(t1second);</span>
<a href="#l165.48"></a><span id="l165.48"> </span>
<a href="#l165.49"></a><span id="l165.49">   // Ignore this thread.</span>
<a href="#l165.50"></a><span id="l165.50">   mc.keypress(null, &quot;K&quot;, { shiftKey: false, accelKey: false });</span>
<a href="#l165.51"></a><span id="l165.51"> </span>
<a href="#l165.52"></a><span id="l165.52" class="difflineat">@@ -70,43 +70,43 @@ function test_ignore_thread() {</span>
<a href="#l165.53"></a><span id="l165.53">   // The ignored thread should still be visible (with an ignored icon).</span>
<a href="#l165.54"></a><span id="l165.54">   assert_visible(t1root);</span>
<a href="#l165.55"></a><span id="l165.55"> </span>
<a href="#l165.56"></a><span id="l165.56">   // Go to another folder then back. Ignored messages should now be hidden.</span>
<a href="#l165.57"></a><span id="l165.57">   be_in_folder(inboxFolder);</span>
<a href="#l165.58"></a><span id="l165.58">   be_in_folder(folder);</span>
<a href="#l165.59"></a><span id="l165.59">   select_click_row(0);</span>
<a href="#l165.60"></a><span id="l165.60">   assert_selected_and_displayed(t2root);</span>
<a href="#l165.61"></a><span id="l165.61" class="difflineminus">-}</span>
<a href="#l165.62"></a><span id="l165.62" class="difflineplus">+});</span>
<a href="#l165.63"></a><span id="l165.63"> </span>
<a href="#l165.64"></a><span id="l165.64"> /**</span>
<a href="#l165.65"></a><span id="l165.65">  * Test that ignored threads are shown when the View | Threads |</span>
<a href="#l165.66"></a><span id="l165.66">  * Ignored Threads option is checked.</span>
<a href="#l165.67"></a><span id="l165.67">  */</span>
<a href="#l165.68"></a><span id="l165.68" class="difflineminus">-function test_view_threads_ignored_threads() {</span>
<a href="#l165.69"></a><span id="l165.69" class="difflineplus">+add_task(function test_view_threads_ignored_threads() {</span>
<a href="#l165.70"></a><span id="l165.70">   let t1root = thread1.getMsgHdr(0);</span>
<a href="#l165.71"></a><span id="l165.71">   let t2root = thread2.getMsgHdr(0);</span>
<a href="#l165.72"></a><span id="l165.72"> </span>
<a href="#l165.73"></a><span id="l165.73">   // Check &quot;Ignored Threads&quot; - the ignored messages should appear =&gt;</span>
<a href="#l165.74"></a><span id="l165.74">   // the first row is the first message of the first thread.</span>
<a href="#l165.75"></a><span id="l165.75">   clickViewMessagesItem(&quot;appmenu_viewIgnoredThreadsMenuItem&quot;);</span>
<a href="#l165.76"></a><span id="l165.76">   select_click_row(0);</span>
<a href="#l165.77"></a><span id="l165.77">   assert_selected_and_displayed(t1root);</span>
<a href="#l165.78"></a><span id="l165.78"> </span>
<a href="#l165.79"></a><span id="l165.79">   // Uncheck &quot;Ignored Threads&quot; - the ignored messages should get hidden.</span>
<a href="#l165.80"></a><span id="l165.80">   clickViewMessagesItem(&quot;appmenu_viewIgnoredThreadsMenuItem&quot;);</span>
<a href="#l165.81"></a><span id="l165.81">   select_click_row(0);</span>
<a href="#l165.82"></a><span id="l165.82">   assert_selected_and_displayed(t2root);</span>
<a href="#l165.83"></a><span id="l165.83">   assert_not_shown(thread1.msgHdrList);</span>
<a href="#l165.84"></a><span id="l165.84" class="difflineminus">-}</span>
<a href="#l165.85"></a><span id="l165.85" class="difflineplus">+});</span>
<a href="#l165.86"></a><span id="l165.86"> </span>
<a href="#l165.87"></a><span id="l165.87"> /**</span>
<a href="#l165.88"></a><span id="l165.88">  * Test that Watch Thread makes the thread watched.</span>
<a href="#l165.89"></a><span id="l165.89">  */</span>
<a href="#l165.90"></a><span id="l165.90" class="difflineminus">-function test_watch_thread() {</span>
<a href="#l165.91"></a><span id="l165.91" class="difflineplus">+add_task(function test_watch_thread() {</span>
<a href="#l165.92"></a><span id="l165.92">   let t2second = select_click_row(1);</span>
<a href="#l165.93"></a><span id="l165.93">   let t3root = thread3.getMsgHdr(0);</span>
<a href="#l165.94"></a><span id="l165.94">   assert_selected_and_displayed(t2second);</span>
<a href="#l165.95"></a><span id="l165.95"> </span>
<a href="#l165.96"></a><span id="l165.96">   // Watch this thread.</span>
<a href="#l165.97"></a><span id="l165.97">   mc.keypress(null, &quot;W&quot;, { shiftKey: false, accelKey: false });</span>
<a href="#l165.98"></a><span id="l165.98"> </span>
<a href="#l165.99"></a><span id="l165.99">   // Choose &quot;Watched Threads with Unread&quot;.</span>
<a href="#l165.100"></a><span id="l165.100" class="difflineat">@@ -116,9 +116,16 @@ function test_watch_thread() {</span>
<a href="#l165.101"></a><span id="l165.101">   assert_not_shown(thread1.msgHdrList);</span>
<a href="#l165.102"></a><span id="l165.102">   assert_not_shown(thread3.msgHdrList);</span>
<a href="#l165.103"></a><span id="l165.103"> </span>
<a href="#l165.104"></a><span id="l165.104">   // Choose &quot;All Messages&quot; again.</span>
<a href="#l165.105"></a><span id="l165.105">   clickViewMessagesItem(&quot;appmenu_viewAllMessagesMenuItem&quot;);</span>
<a href="#l165.106"></a><span id="l165.106">   assert_not_shown(thread1.msgHdrList); // still ignored (and now shown)</span>
<a href="#l165.107"></a><span id="l165.107">   select_click_row(thread2.msgHdrList.length);</span>
<a href="#l165.108"></a><span id="l165.108">   assert_selected_and_displayed(t3root);</span>
<a href="#l165.109"></a><span id="l165.109" class="difflineminus">-}</span>
<a href="#l165.110"></a><span id="l165.110" class="difflineplus">+</span>
<a href="#l165.111"></a><span id="l165.111" class="difflineplus">+  Assert.report(</span>
<a href="#l165.112"></a><span id="l165.112" class="difflineplus">+    false,</span>
<a href="#l165.113"></a><span id="l165.113" class="difflineplus">+    undefined,</span>
<a href="#l165.114"></a><span id="l165.114" class="difflineplus">+    undefined,</span>
<a href="#l165.115"></a><span id="l165.115" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l165.116"></a><span id="l165.116" class="difflineplus">+  );</span>
<a href="#l165.117"></a><span id="l165.117" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l166.1"></a><span id="l166.1">new file mode 100644</span>
<a href="#l166.2"></a><span id="l166.2" class="difflineminus">--- /dev/null</span>
<a href="#l166.3"></a><span id="l166.3" class="difflineplus">+++ b/mail/test/browser/folder-pane/browser.ini</span>
<a href="#l166.4"></a><span id="l166.4" class="difflineat">@@ -0,0 +1,45 @@</span>
<a href="#l166.5"></a><span id="l166.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l166.6"></a><span id="l166.6" class="difflineplus">+prefs =</span>
<a href="#l166.7"></a><span id="l166.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l166.8"></a><span id="l166.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l166.9"></a><span id="l166.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l166.10"></a><span id="l166.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l166.11"></a><span id="l166.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l166.12"></a><span id="l166.12" class="difflineplus">+  mail.shell.checkDefaultClient=false</span>
<a href="#l166.13"></a><span id="l166.13" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l166.14"></a><span id="l166.14" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l166.15"></a><span id="l166.15" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l166.16"></a><span id="l166.16" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l166.17"></a><span id="l166.17" class="difflineplus">+  mail.account.account2.identities=id1,id2</span>
<a href="#l166.18"></a><span id="l166.18" class="difflineplus">+  mail.account.account2.server=server2</span>
<a href="#l166.19"></a><span id="l166.19" class="difflineplus">+  mail.accountmanager.accounts=account2</span>
<a href="#l166.20"></a><span id="l166.20" class="difflineplus">+  mail.accountmanager.defaultaccount=account2</span>
<a href="#l166.21"></a><span id="l166.21" class="difflineplus">+  mail.identity.id1.fullName=Tinderbox</span>
<a href="#l166.22"></a><span id="l166.22" class="difflineplus">+  mail.identity.id1.htmlSigFormat=false</span>
<a href="#l166.23"></a><span id="l166.23" class="difflineplus">+  mail.identity.id1.smtpServer=smtp1</span>
<a href="#l166.24"></a><span id="l166.24" class="difflineplus">+  mail.identity.id1.useremail=tinderbox@foo.invalid</span>
<a href="#l166.25"></a><span id="l166.25" class="difflineplus">+  mail.identity.id1.valid=true</span>
<a href="#l166.26"></a><span id="l166.26" class="difflineplus">+  mail.identity.id2.fullName=Tinderboxpushlog</span>
<a href="#l166.27"></a><span id="l166.27" class="difflineplus">+  mail.identity.id2.htmlSigFormat=true</span>
<a href="#l166.28"></a><span id="l166.28" class="difflineplus">+  mail.identity.id2.smtpServer=smtp1</span>
<a href="#l166.29"></a><span id="l166.29" class="difflineplus">+  mail.identity.id2.useremail=tinderboxpushlog@foo.invalid</span>
<a href="#l166.30"></a><span id="l166.30" class="difflineplus">+  mail.identity.id2.valid=true</span>
<a href="#l166.31"></a><span id="l166.31" class="difflineplus">+  mail.server.server2.check_new_mail=false</span>
<a href="#l166.32"></a><span id="l166.32" class="difflineplus">+  mail.server.server2.directory-rel=[ProfD]Mail/tinderbox</span>
<a href="#l166.33"></a><span id="l166.33" class="difflineplus">+  mail.server.server2.download_on_biff=true</span>
<a href="#l166.34"></a><span id="l166.34" class="difflineplus">+  mail.server.server2.hostname=tinderbox123</span>
<a href="#l166.35"></a><span id="l166.35" class="difflineplus">+  mail.server.server2.login_at_startup=false</span>
<a href="#l166.36"></a><span id="l166.36" class="difflineplus">+  mail.server.server2.name=tinderbox@foo.invalid</span>
<a href="#l166.37"></a><span id="l166.37" class="difflineplus">+  mail.server.server2.type=pop3</span>
<a href="#l166.38"></a><span id="l166.38" class="difflineplus">+  mail.server.server2.userName=tinderbox</span>
<a href="#l166.39"></a><span id="l166.39" class="difflineplus">+  mail.server.server2.whiteListAbURI=</span>
<a href="#l166.40"></a><span id="l166.40" class="difflineplus">+  mail.smtp.defaultserver=smtp1</span>
<a href="#l166.41"></a><span id="l166.41" class="difflineplus">+  mail.smtpserver.smtp1.hostname=tinderbox123</span>
<a href="#l166.42"></a><span id="l166.42" class="difflineplus">+  mail.smtpserver.smtp1.username=tinderbox</span>
<a href="#l166.43"></a><span id="l166.43" class="difflineplus">+  mail.smtpservers=smtp1</span>
<a href="#l166.44"></a><span id="l166.44" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l166.45"></a><span id="l166.45" class="difflineplus">+</span>
<a href="#l166.46"></a><span id="l166.46" class="difflineplus">+[browser_displayMessageWithFolderModes.js]</span>
<a href="#l166.47"></a><span id="l166.47" class="difflineplus">+[browser_folderNamesInRecentMode.js]</span>
<a href="#l166.48"></a><span id="l166.48" class="difflineplus">+[browser_folderPane.js]</span>
<a href="#l166.49"></a><span id="l166.49" class="difflineplus">+[browser_folderPaneConsumers.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l167.1"></a><span id="l167.1">copy from mail/test/mozmill/folder-pane/test-display-message-with-folder-modes.js</span>
<a href="#l167.2"></a><span id="l167.2">copy to mail/test/browser/folder-pane/browser_displayMessageWithFolderModes.js</span>
<a href="#l167.3"></a><span id="l167.3" class="difflineminus">--- a/mail/test/mozmill/folder-pane/test-display-message-with-folder-modes.js</span>
<a href="#l167.4"></a><span id="l167.4" class="difflineplus">+++ b/mail/test/browser/folder-pane/browser_displayMessageWithFolderModes.js</span>
<a href="#l167.5"></a><span id="l167.5" class="difflineat">@@ -39,17 +39,17 @@ var {</span>
<a href="#l167.6"></a><span id="l167.6"> </span>
<a href="#l167.7"></a><span id="l167.7"> var folder;</span>
<a href="#l167.8"></a><span id="l167.8"> var dummyFolder;</span>
<a href="#l167.9"></a><span id="l167.9"> var inbox2Folder;</span>
<a href="#l167.10"></a><span id="l167.10"> var smartInboxFolder;</span>
<a href="#l167.11"></a><span id="l167.11"> </span>
<a href="#l167.12"></a><span id="l167.12"> var msgHdr;</span>
<a href="#l167.13"></a><span id="l167.13"> </span>
<a href="#l167.14"></a><span id="l167.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l167.15"></a><span id="l167.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l167.16"></a><span id="l167.16">   assert_folder_mode(&quot;all&quot;);</span>
<a href="#l167.17"></a><span id="l167.17">   assert_folder_tree_view_row_count(7);</span>
<a href="#l167.18"></a><span id="l167.18"> </span>
<a href="#l167.19"></a><span id="l167.19">   // This is a subfolder of the inbox so that</span>
<a href="#l167.20"></a><span id="l167.20">   // test_display_message_in_smart_folder_mode_works is able to test that we</span>
<a href="#l167.21"></a><span id="l167.21">   // don't attempt to expand any inboxes.</span>
<a href="#l167.22"></a><span id="l167.22">   inboxFolder.createSubfolder(&quot;DisplayMessageWithFolderModesA&quot;, null);</span>
<a href="#l167.23"></a><span id="l167.23">   folder = inboxFolder.getChildNamed(&quot;DisplayMessageWithFolderModesA&quot;);</span>
<a href="#l167.24"></a><span id="l167.24" class="difflineat">@@ -65,83 +65,87 @@ function setupModule(module) {</span>
<a href="#l167.25"></a><span id="l167.25"> </span>
<a href="#l167.26"></a><span id="l167.26">   // Create another subfolder on the top level that is not a parent of the</span>
<a href="#l167.27"></a><span id="l167.27">   // 2 folders so that it is not visible in Favorite mode.</span>
<a href="#l167.28"></a><span id="l167.28">   inboxFolder.server.rootFolder.createSubfolder(&quot;Inbox2&quot;, null);</span>
<a href="#l167.29"></a><span id="l167.29">   inbox2Folder = inboxFolder.server.rootFolder.getChildNamed(&quot;Inbox2&quot;);</span>
<a href="#l167.30"></a><span id="l167.30"> </span>
<a href="#l167.31"></a><span id="l167.31">   be_in_folder(folder);</span>
<a href="#l167.32"></a><span id="l167.32">   msgHdr = mc.dbView.getMsgHdrAt(0);</span>
<a href="#l167.33"></a><span id="l167.33" class="difflineminus">-}</span>
<a href="#l167.34"></a><span id="l167.34" class="difflineplus">+});</span>
<a href="#l167.35"></a><span id="l167.35"> </span>
<a href="#l167.36"></a><span id="l167.36"> /**</span>
<a href="#l167.37"></a><span id="l167.37">  * Test that displaying a message causes a switch to the default folder mode if</span>
<a href="#l167.38"></a><span id="l167.38">  * the folder isn't present in the current folder mode.</span>
<a href="#l167.39"></a><span id="l167.39">  */</span>
<a href="#l167.40"></a><span id="l167.40" class="difflineminus">-function test_display_message_with_folder_not_present_in_current_folder_mode() {</span>
<a href="#l167.41"></a><span id="l167.41" class="difflineminus">-  // Make sure the folder doesn't appear in the favorite folder mode just</span>
<a href="#l167.42"></a><span id="l167.42" class="difflineminus">-  // because it was selected last before switching</span>
<a href="#l167.43"></a><span id="l167.43" class="difflineminus">-  be_in_folder(inboxFolder);</span>
<a href="#l167.44"></a><span id="l167.44" class="difflineplus">+add_task(</span>
<a href="#l167.45"></a><span id="l167.45" class="difflineplus">+  function test_display_message_with_folder_not_present_in_current_folder_mode() {</span>
<a href="#l167.46"></a><span id="l167.46" class="difflineplus">+    // Make sure the folder doesn't appear in the favorite folder mode just</span>
<a href="#l167.47"></a><span id="l167.47" class="difflineplus">+    // because it was selected last before switching</span>
<a href="#l167.48"></a><span id="l167.48" class="difflineplus">+    be_in_folder(inboxFolder);</span>
<a href="#l167.49"></a><span id="l167.49"> </span>
<a href="#l167.50"></a><span id="l167.50" class="difflineminus">-  // Move to favorite folders. This folder isn't currently a favorite folder</span>
<a href="#l167.51"></a><span id="l167.51" class="difflineminus">-  mc.folderTreeView.mode = &quot;favorite&quot;;</span>
<a href="#l167.52"></a><span id="l167.52" class="difflineminus">-  assert_folder_not_visible(folder);</span>
<a href="#l167.53"></a><span id="l167.53" class="difflineminus">-  assert_folder_not_visible(inboxFolder);</span>
<a href="#l167.54"></a><span id="l167.54" class="difflineminus">-  assert_folder_not_visible(inbox2Folder);</span>
<a href="#l167.55"></a><span id="l167.55" class="difflineplus">+    // Move to favorite folders. This folder isn't currently a favorite folder</span>
<a href="#l167.56"></a><span id="l167.56" class="difflineplus">+    mc.folderTreeView.mode = &quot;favorite&quot;;</span>
<a href="#l167.57"></a><span id="l167.57" class="difflineplus">+    assert_folder_not_visible(folder);</span>
<a href="#l167.58"></a><span id="l167.58" class="difflineplus">+    assert_folder_not_visible(inboxFolder);</span>
<a href="#l167.59"></a><span id="l167.59" class="difflineplus">+    assert_folder_not_visible(inbox2Folder);</span>
<a href="#l167.60"></a><span id="l167.60"> </span>
<a href="#l167.61"></a><span id="l167.61" class="difflineminus">-  // Try displaying a message</span>
<a href="#l167.62"></a><span id="l167.62" class="difflineminus">-  display_message_in_folder_tab(msgHdr);</span>
<a href="#l167.63"></a><span id="l167.63" class="difflineplus">+    // Try displaying a message</span>
<a href="#l167.64"></a><span id="l167.64" class="difflineplus">+    display_message_in_folder_tab(msgHdr);</span>
<a href="#l167.65"></a><span id="l167.65"> </span>
<a href="#l167.66"></a><span id="l167.66" class="difflineminus">-  assert_folder_mode(mc.window.kDefaultMode);</span>
<a href="#l167.67"></a><span id="l167.67" class="difflineminus">-  assert_folder_selected_and_displayed(folder);</span>
<a href="#l167.68"></a><span id="l167.68" class="difflineminus">-  assert_selected_and_displayed(msgHdr);</span>
<a href="#l167.69"></a><span id="l167.69" class="difflineminus">-}</span>
<a href="#l167.70"></a><span id="l167.70" class="difflineplus">+    assert_folder_mode(mc.window.kDefaultMode);</span>
<a href="#l167.71"></a><span id="l167.71" class="difflineplus">+    assert_folder_selected_and_displayed(folder);</span>
<a href="#l167.72"></a><span id="l167.72" class="difflineplus">+    assert_selected_and_displayed(msgHdr);</span>
<a href="#l167.73"></a><span id="l167.73" class="difflineplus">+  }</span>
<a href="#l167.74"></a><span id="l167.74" class="difflineplus">+);</span>
<a href="#l167.75"></a><span id="l167.75"> </span>
<a href="#l167.76"></a><span id="l167.76"> /**</span>
<a href="#l167.77"></a><span id="l167.77">  * Test that displaying a message _does not_ cause a switch to the default</span>
<a href="#l167.78"></a><span id="l167.78">  * folder mode if the folder is present in the current folder mode.</span>
<a href="#l167.79"></a><span id="l167.79">  */</span>
<a href="#l167.80"></a><span id="l167.80" class="difflineminus">-function test_display_message_with_folder_present_in_current_folder_mode() {</span>
<a href="#l167.81"></a><span id="l167.81" class="difflineminus">-  // Mark the folder as a favorite</span>
<a href="#l167.82"></a><span id="l167.82" class="difflineminus">-  folder.setFlag(Ci.nsMsgFolderFlags.Favorite);</span>
<a href="#l167.83"></a><span id="l167.83" class="difflineminus">-  // Also mark the dummy folder as a favorite, in preparation for</span>
<a href="#l167.84"></a><span id="l167.84" class="difflineminus">-  // test_display_message_in_smart_folder_mode_works</span>
<a href="#l167.85"></a><span id="l167.85" class="difflineminus">-  dummyFolder.setFlag(Ci.nsMsgFolderFlags.Favorite);</span>
<a href="#l167.86"></a><span id="l167.86" class="difflineplus">+add_task(</span>
<a href="#l167.87"></a><span id="l167.87" class="difflineplus">+  function test_display_message_with_folder_present_in_current_folder_mode() {</span>
<a href="#l167.88"></a><span id="l167.88" class="difflineplus">+    // Mark the folder as a favorite</span>
<a href="#l167.89"></a><span id="l167.89" class="difflineplus">+    folder.setFlag(Ci.nsMsgFolderFlags.Favorite);</span>
<a href="#l167.90"></a><span id="l167.90" class="difflineplus">+    // Also mark the dummy folder as a favorite, in preparation for</span>
<a href="#l167.91"></a><span id="l167.91" class="difflineplus">+    // test_display_message_in_smart_folder_mode_works</span>
<a href="#l167.92"></a><span id="l167.92" class="difflineplus">+    dummyFolder.setFlag(Ci.nsMsgFolderFlags.Favorite);</span>
<a href="#l167.93"></a><span id="l167.93"> </span>
<a href="#l167.94"></a><span id="l167.94" class="difflineminus">-  // Make sure the folder doesn't appear in the favorite folder mode just</span>
<a href="#l167.95"></a><span id="l167.95" class="difflineminus">-  // because it was selected last before switching</span>
<a href="#l167.96"></a><span id="l167.96" class="difflineminus">-  be_in_folder(inboxFolder);</span>
<a href="#l167.97"></a><span id="l167.97" class="difflineplus">+    // Make sure the folder doesn't appear in the favorite folder mode just</span>
<a href="#l167.98"></a><span id="l167.98" class="difflineplus">+    // because it was selected last before switching</span>
<a href="#l167.99"></a><span id="l167.99" class="difflineplus">+    be_in_folder(inboxFolder);</span>
<a href="#l167.100"></a><span id="l167.100"> </span>
<a href="#l167.101"></a><span id="l167.101" class="difflineminus">-  // Switch to favorite folders. Check that the folder is now in the view, as is</span>
<a href="#l167.102"></a><span id="l167.102" class="difflineminus">-  // the dummy folder</span>
<a href="#l167.103"></a><span id="l167.103" class="difflineminus">-  mc.folderTreeView.mode = &quot;favorite&quot;;</span>
<a href="#l167.104"></a><span id="l167.104" class="difflineminus">-  assert_folder_visible(folder);</span>
<a href="#l167.105"></a><span id="l167.105" class="difflineminus">-  assert_folder_visible(dummyFolder);</span>
<a href="#l167.106"></a><span id="l167.106" class="difflineminus">-  // Also their parent folder should be visible.</span>
<a href="#l167.107"></a><span id="l167.107" class="difflineminus">-  assert_folder_visible(inboxFolder);</span>
<a href="#l167.108"></a><span id="l167.108" class="difflineminus">-  // But not a sibling of their parent, which is not Favorite.</span>
<a href="#l167.109"></a><span id="l167.109" class="difflineminus">-  assert_folder_not_visible(inbox2Folder);</span>
<a href="#l167.110"></a><span id="l167.110" class="difflineplus">+    // Switch to favorite folders. Check that the folder is now in the view, as is</span>
<a href="#l167.111"></a><span id="l167.111" class="difflineplus">+    // the dummy folder</span>
<a href="#l167.112"></a><span id="l167.112" class="difflineplus">+    mc.folderTreeView.mode = &quot;favorite&quot;;</span>
<a href="#l167.113"></a><span id="l167.113" class="difflineplus">+    assert_folder_visible(folder);</span>
<a href="#l167.114"></a><span id="l167.114" class="difflineplus">+    assert_folder_visible(dummyFolder);</span>
<a href="#l167.115"></a><span id="l167.115" class="difflineplus">+    // Also their parent folder should be visible.</span>
<a href="#l167.116"></a><span id="l167.116" class="difflineplus">+    assert_folder_visible(inboxFolder);</span>
<a href="#l167.117"></a><span id="l167.117" class="difflineplus">+    // But not a sibling of their parent, which is not Favorite.</span>
<a href="#l167.118"></a><span id="l167.118" class="difflineplus">+    assert_folder_not_visible(inbox2Folder);</span>
<a href="#l167.119"></a><span id="l167.119"> </span>
<a href="#l167.120"></a><span id="l167.120" class="difflineminus">-  // Try displaying a message</span>
<a href="#l167.121"></a><span id="l167.121" class="difflineminus">-  display_message_in_folder_tab(msgHdr);</span>
<a href="#l167.122"></a><span id="l167.122" class="difflineplus">+    // Try displaying a message</span>
<a href="#l167.123"></a><span id="l167.123" class="difflineplus">+    display_message_in_folder_tab(msgHdr);</span>
<a href="#l167.124"></a><span id="l167.124"> </span>
<a href="#l167.125"></a><span id="l167.125" class="difflineminus">-  assert_folder_mode(&quot;favorite&quot;);</span>
<a href="#l167.126"></a><span id="l167.126" class="difflineminus">-  assert_folder_selected_and_displayed(folder);</span>
<a href="#l167.127"></a><span id="l167.127" class="difflineminus">-  assert_selected_and_displayed(msgHdr);</span>
<a href="#l167.128"></a><span id="l167.128" class="difflineplus">+    assert_folder_mode(&quot;favorite&quot;);</span>
<a href="#l167.129"></a><span id="l167.129" class="difflineplus">+    assert_folder_selected_and_displayed(folder);</span>
<a href="#l167.130"></a><span id="l167.130" class="difflineplus">+    assert_selected_and_displayed(msgHdr);</span>
<a href="#l167.131"></a><span id="l167.131"> </span>
<a href="#l167.132"></a><span id="l167.132" class="difflineminus">-  // Now unset the flags so that we don't affect later tests.</span>
<a href="#l167.133"></a><span id="l167.133" class="difflineminus">-  folder.clearFlag(Ci.nsMsgFolderFlags.Favorite);</span>
<a href="#l167.134"></a><span id="l167.134" class="difflineminus">-  dummyFolder.clearFlag(Ci.nsMsgFolderFlags.Favorite);</span>
<a href="#l167.135"></a><span id="l167.135" class="difflineminus">-}</span>
<a href="#l167.136"></a><span id="l167.136" class="difflineplus">+    // Now unset the flags so that we don't affect later tests.</span>
<a href="#l167.137"></a><span id="l167.137" class="difflineplus">+    folder.clearFlag(Ci.nsMsgFolderFlags.Favorite);</span>
<a href="#l167.138"></a><span id="l167.138" class="difflineplus">+    dummyFolder.clearFlag(Ci.nsMsgFolderFlags.Favorite);</span>
<a href="#l167.139"></a><span id="l167.139" class="difflineplus">+  }</span>
<a href="#l167.140"></a><span id="l167.140" class="difflineplus">+);</span>
<a href="#l167.141"></a><span id="l167.141"> </span>
<a href="#l167.142"></a><span id="l167.142"> /**</span>
<a href="#l167.143"></a><span id="l167.143">  * Test that displaying a message in smart folders mode causes the parent in the</span>
<a href="#l167.144"></a><span id="l167.144">  * view to expand.</span>
<a href="#l167.145"></a><span id="l167.145">  */</span>
<a href="#l167.146"></a><span id="l167.146" class="difflineminus">-function test_display_message_in_smart_folder_mode_works() {</span>
<a href="#l167.147"></a><span id="l167.147" class="difflineplus">+add_task(function test_display_message_in_smart_folder_mode_works() {</span>
<a href="#l167.148"></a><span id="l167.148">   // Clear the message selection, otherwise msgHdr will still be displayed and</span>
<a href="#l167.149"></a><span id="l167.149">   // display_message_in_folder_tab(msgHdr) will be a no-op.</span>
<a href="#l167.150"></a><span id="l167.150">   select_none();</span>
<a href="#l167.151"></a><span id="l167.151">   mc.folderTreeView.mode = &quot;all&quot;;</span>
<a href="#l167.152"></a><span id="l167.152"> </span>
<a href="#l167.153"></a><span id="l167.153">   // Switch to the dummy folder, otherwise msgHdr will be in the view and the</span>
<a href="#l167.154"></a><span id="l167.154">   // display message in folder tab logic will simply select the message without</span>
<a href="#l167.155"></a><span id="l167.155">   // bothering to expand any folders.</span>
<a href="#l167.156"></a><span id="l167.156" class="difflineat">@@ -165,23 +169,23 @@ function test_display_message_in_smart_f</span>
<a href="#l167.157"></a><span id="l167.157">   display_message_in_folder_tab(msgHdr);</span>
<a href="#l167.158"></a><span id="l167.158"> </span>
<a href="#l167.159"></a><span id="l167.159">   // Check that the right folders have expanded</span>
<a href="#l167.160"></a><span id="l167.160">   assert_folder_mode(&quot;smart&quot;);</span>
<a href="#l167.161"></a><span id="l167.161">   assert_folder_collapsed(smartInboxFolder);</span>
<a href="#l167.162"></a><span id="l167.162">   assert_folder_expanded(rootFolder);</span>
<a href="#l167.163"></a><span id="l167.163">   assert_folder_selected_and_displayed(folder);</span>
<a href="#l167.164"></a><span id="l167.164">   assert_selected_and_displayed(msgHdr);</span>
<a href="#l167.165"></a><span id="l167.165" class="difflineminus">-}</span>
<a href="#l167.166"></a><span id="l167.166" class="difflineplus">+});</span>
<a href="#l167.167"></a><span id="l167.167"> </span>
<a href="#l167.168"></a><span id="l167.168"> /**</span>
<a href="#l167.169"></a><span id="l167.169">  * Test that displaying a message in an inbox in smart folders mode causes the</span>
<a href="#l167.170"></a><span id="l167.170">  * message to be displayed in the smart inbox.</span>
<a href="#l167.171"></a><span id="l167.171">  */</span>
<a href="#l167.172"></a><span id="l167.172" class="difflineminus">-function test_display_inbox_message_in_smart_folder_mode_works() {</span>
<a href="#l167.173"></a><span id="l167.173" class="difflineplus">+add_task(function test_display_inbox_message_in_smart_folder_mode_works() {</span>
<a href="#l167.174"></a><span id="l167.174">   be_in_folder(inboxFolder);</span>
<a href="#l167.175"></a><span id="l167.175">   let inboxMsgHdr = mc.dbView.getMsgHdrAt(0);</span>
<a href="#l167.176"></a><span id="l167.176"> </span>
<a href="#l167.177"></a><span id="l167.177">   // Collapse everything</span>
<a href="#l167.178"></a><span id="l167.178">   collapse_folder(smartInboxFolder);</span>
<a href="#l167.179"></a><span id="l167.179">   assert_folder_collapsed(smartInboxFolder);</span>
<a href="#l167.180"></a><span id="l167.180">   assert_folder_not_visible(inboxFolder);</span>
<a href="#l167.181"></a><span id="l167.181">   let rootFolder = folder.server.rootFolder;</span>
<a href="#l167.182"></a><span id="l167.182" class="difflineat">@@ -196,25 +200,34 @@ function test_display_inbox_message_in_s</span>
<a href="#l167.183"></a><span id="l167.183">   display_message_in_folder_tab(inboxMsgHdr);</span>
<a href="#l167.184"></a><span id="l167.184"> </span>
<a href="#l167.185"></a><span id="l167.185">   // Check that nothing has expanded, and that the right folder is selected</span>
<a href="#l167.186"></a><span id="l167.186">   assert_folder_mode(&quot;smart&quot;);</span>
<a href="#l167.187"></a><span id="l167.187">   assert_folder_collapsed(smartInboxFolder);</span>
<a href="#l167.188"></a><span id="l167.188">   assert_folder_collapsed(rootFolder);</span>
<a href="#l167.189"></a><span id="l167.189">   assert_folder_selected_and_displayed(smartInboxFolder);</span>
<a href="#l167.190"></a><span id="l167.190">   assert_selected_and_displayed(inboxMsgHdr);</span>
<a href="#l167.191"></a><span id="l167.191" class="difflineminus">-}</span>
<a href="#l167.192"></a><span id="l167.192" class="difflineplus">+});</span>
<a href="#l167.193"></a><span id="l167.193"> </span>
<a href="#l167.194"></a><span id="l167.194"> /**</span>
<a href="#l167.195"></a><span id="l167.195">  * Move back to the all folders mode.</span>
<a href="#l167.196"></a><span id="l167.196">  */</span>
<a href="#l167.197"></a><span id="l167.197" class="difflineminus">-function test_switch_to_all_folders() {</span>
<a href="#l167.198"></a><span id="l167.198" class="difflineplus">+add_task(function test_switch_to_all_folders() {</span>
<a href="#l167.199"></a><span id="l167.199">   mc.folderTreeView.mode = &quot;all&quot;;</span>
<a href="#l167.200"></a><span id="l167.200">   assert_folder_tree_view_row_count(10);</span>
<a href="#l167.201"></a><span id="l167.201" class="difflineminus">-}</span>
<a href="#l167.202"></a><span id="l167.202" class="difflineplus">+});</span>
<a href="#l167.203"></a><span id="l167.203"> </span>
<a href="#l167.204"></a><span id="l167.204" class="difflineminus">-function teardownModule() {</span>
<a href="#l167.205"></a><span id="l167.205" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l167.206"></a><span id="l167.206">   // Remove our folders</span>
<a href="#l167.207"></a><span id="l167.207">   inboxFolder.propagateDelete(folder, true, null);</span>
<a href="#l167.208"></a><span id="l167.208">   inboxFolder.propagateDelete(dummyFolder, true, null);</span>
<a href="#l167.209"></a><span id="l167.209">   inboxFolder.server.rootFolder.propagateDelete(inbox2Folder, true, null);</span>
<a href="#l167.210"></a><span id="l167.210">   assert_folder_tree_view_row_count(7);</span>
<a href="#l167.211"></a><span id="l167.211" class="difflineminus">-}</span>
<a href="#l167.212"></a><span id="l167.212" class="difflineplus">+</span>
<a href="#l167.213"></a><span id="l167.213" class="difflineplus">+  document.getElementById(&quot;folderTree&quot;).focus();</span>
<a href="#l167.214"></a><span id="l167.214" class="difflineplus">+</span>
<a href="#l167.215"></a><span id="l167.215" class="difflineplus">+  Assert.report(</span>
<a href="#l167.216"></a><span id="l167.216" class="difflineplus">+    false,</span>
<a href="#l167.217"></a><span id="l167.217" class="difflineplus">+    undefined,</span>
<a href="#l167.218"></a><span id="l167.218" class="difflineplus">+    undefined,</span>
<a href="#l167.219"></a><span id="l167.219" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l167.220"></a><span id="l167.220" class="difflineplus">+  );</span>
<a href="#l167.221"></a><span id="l167.221" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l168.1"></a><span id="l168.1">copy from mail/test/mozmill/folder-pane/test-folder-names-in-recent-mode.js</span>
<a href="#l168.2"></a><span id="l168.2">copy to mail/test/browser/folder-pane/browser_folderNamesInRecentMode.js</span>
<a href="#l168.3"></a><span id="l168.3" class="difflineminus">--- a/mail/test/mozmill/folder-pane/test-folder-names-in-recent-mode.js</span>
<a href="#l168.4"></a><span id="l168.4" class="difflineplus">+++ b/mail/test/browser/folder-pane/browser_folderNamesInRecentMode.js</span>
<a href="#l168.5"></a><span id="l168.5" class="difflineat">@@ -21,39 +21,39 @@ var {</span>
<a href="#l168.6"></a><span id="l168.6"> </span>
<a href="#l168.7"></a><span id="l168.7"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l168.8"></a><span id="l168.8">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l168.9"></a><span id="l168.9"> );</span>
<a href="#l168.10"></a><span id="l168.10"> var { fixIterator } = ChromeUtils.import(</span>
<a href="#l168.11"></a><span id="l168.11">   &quot;resource:///modules/iteratorUtils.jsm&quot;</span>
<a href="#l168.12"></a><span id="l168.12"> );</span>
<a href="#l168.13"></a><span id="l168.13"> </span>
<a href="#l168.14"></a><span id="l168.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l168.15"></a><span id="l168.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l168.16"></a><span id="l168.16">   assert_folder_mode(&quot;all&quot;);</span>
<a href="#l168.17"></a><span id="l168.17">   assert_folder_tree_view_row_count(7);</span>
<a href="#l168.18"></a><span id="l168.18" class="difflineminus">-}</span>
<a href="#l168.19"></a><span id="l168.19" class="difflineplus">+});</span>
<a href="#l168.20"></a><span id="l168.20"> </span>
<a href="#l168.21"></a><span id="l168.21" class="difflineminus">-function test_folder_names_in_recent_view_mode() {</span>
<a href="#l168.22"></a><span id="l168.22" class="difflineplus">+add_task(function test_folder_names_in_recent_view_mode() {</span>
<a href="#l168.23"></a><span id="l168.23">   // We need 2 local accounts that have pristine folders with</span>
<a href="#l168.24"></a><span id="l168.24">   // unmodified times, so that it does not influence the</span>
<a href="#l168.25"></a><span id="l168.25">   // list of Recent folders. So clear out the most-recently-used time.</span>
<a href="#l168.26"></a><span id="l168.26">   for (let acc of fixIterator(</span>
<a href="#l168.27"></a><span id="l168.27">     MailServices.accounts.accounts,</span>
<a href="#l168.28"></a><span id="l168.28">     Ci.nsIMsgAccount</span>
<a href="#l168.29"></a><span id="l168.29">   )) {</span>
<a href="#l168.30"></a><span id="l168.30">     for (let fld of fixIterator(</span>
<a href="#l168.31"></a><span id="l168.31">       acc.incomingServer.rootFolder.subFolders,</span>
<a href="#l168.32"></a><span id="l168.32">       Ci.nsIMsgFolder</span>
<a href="#l168.33"></a><span id="l168.33">     )) {</span>
<a href="#l168.34"></a><span id="l168.34">       fld.setStringProperty(&quot;MRUTime&quot;, &quot;0&quot;);</span>
<a href="#l168.35"></a><span id="l168.35">     }</span>
<a href="#l168.36"></a><span id="l168.36">   }</span>
<a href="#l168.37"></a><span id="l168.37"> </span>
<a href="#l168.38"></a><span id="l168.38" class="difflineminus">-  let acc1 = MailServices.accounts.accounts.queryElementAt(0, Ci.nsIMsgAccount);</span>
<a href="#l168.39"></a><span id="l168.39" class="difflineminus">-  let acc2 = MailServices.accounts.accounts.queryElementAt(1, Ci.nsIMsgAccount);</span>
<a href="#l168.40"></a><span id="l168.40" class="difflineplus">+  let acc1 = MailServices.accounts.accounts.queryElementAt(1, Ci.nsIMsgAccount);</span>
<a href="#l168.41"></a><span id="l168.41" class="difflineplus">+  let acc2 = MailServices.accounts.accounts.queryElementAt(0, Ci.nsIMsgAccount);</span>
<a href="#l168.42"></a><span id="l168.42">   let rootFolder1 = acc1.incomingServer.rootFolder;</span>
<a href="#l168.43"></a><span id="l168.43">   let rootFolder2 = acc2.incomingServer.rootFolder;</span>
<a href="#l168.44"></a><span id="l168.44"> </span>
<a href="#l168.45"></a><span id="l168.45">   // Create some test folders.</span>
<a href="#l168.46"></a><span id="l168.46">   rootFolder1.createSubfolder(&quot;uniqueName&quot;, null);</span>
<a href="#l168.47"></a><span id="l168.47">   rootFolder1.createSubfolder(&quot;duplicatedName&quot;, null);</span>
<a href="#l168.48"></a><span id="l168.48">   rootFolder2.createSubfolder(&quot;duplicatedName&quot;, null);</span>
<a href="#l168.49"></a><span id="l168.49">   let inbox2 = rootFolder2.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l168.50"></a><span id="l168.50" class="difflineat">@@ -84,14 +84,23 @@ function test_folder_names_in_recent_vie</span>
<a href="#l168.51"></a><span id="l168.51">   assert_folder_at_index_as(3, &quot;uniqueName - Local Folders (1)&quot;);</span>
<a href="#l168.52"></a><span id="l168.52">   assert_folder_tree_view_row_count(4);</span>
<a href="#l168.53"></a><span id="l168.53"> </span>
<a href="#l168.54"></a><span id="l168.54">   // Remove our folders to clean up.</span>
<a href="#l168.55"></a><span id="l168.55">   rootFolder1.propagateDelete(fUnique, true, null);</span>
<a href="#l168.56"></a><span id="l168.56">   rootFolder1.propagateDelete(fDup1, true, null);</span>
<a href="#l168.57"></a><span id="l168.57">   rootFolder2.propagateDelete(fDup2, true, null);</span>
<a href="#l168.58"></a><span id="l168.58">   rootFolder2.propagateDelete(fDup3, true, null);</span>
<a href="#l168.59"></a><span id="l168.59" class="difflineminus">-}</span>
<a href="#l168.60"></a><span id="l168.60" class="difflineplus">+});</span>
<a href="#l168.61"></a><span id="l168.61"> </span>
<a href="#l168.62"></a><span id="l168.62" class="difflineminus">-function teardownModule() {</span>
<a href="#l168.63"></a><span id="l168.63" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l168.64"></a><span id="l168.64">   mc.window.gFolderTreeView.mode = &quot;all&quot;;</span>
<a href="#l168.65"></a><span id="l168.65">   assert_folder_tree_view_row_count(7);</span>
<a href="#l168.66"></a><span id="l168.66" class="difflineminus">-}</span>
<a href="#l168.67"></a><span id="l168.67" class="difflineplus">+</span>
<a href="#l168.68"></a><span id="l168.68" class="difflineplus">+  document.getElementById(&quot;folderTree&quot;).focus();</span>
<a href="#l168.69"></a><span id="l168.69" class="difflineplus">+</span>
<a href="#l168.70"></a><span id="l168.70" class="difflineplus">+  Assert.report(</span>
<a href="#l168.71"></a><span id="l168.71" class="difflineplus">+    false,</span>
<a href="#l168.72"></a><span id="l168.72" class="difflineplus">+    undefined,</span>
<a href="#l168.73"></a><span id="l168.73" class="difflineplus">+    undefined,</span>
<a href="#l168.74"></a><span id="l168.74" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l168.75"></a><span id="l168.75" class="difflineplus">+  );</span>
<a href="#l168.76"></a><span id="l168.76" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l169.1"></a><span id="l169.1">copy from mail/test/mozmill/folder-pane/test-folder-pane.js</span>
<a href="#l169.2"></a><span id="l169.2">copy to mail/test/browser/folder-pane/browser_folderPane.js</span>
<a href="#l169.3"></a><span id="l169.3" class="difflineminus">--- a/mail/test/mozmill/folder-pane/test-folder-pane.js</span>
<a href="#l169.4"></a><span id="l169.4" class="difflineplus">+++ b/mail/test/browser/folder-pane/browser_folderPane.js</span>
<a href="#l169.5"></a><span id="l169.5" class="difflineat">@@ -29,17 +29,17 @@ var { MailServices } = ChromeUtils.impor</span>
<a href="#l169.6"></a><span id="l169.6">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l169.7"></a><span id="l169.7"> );</span>
<a href="#l169.8"></a><span id="l169.8"> </span>
<a href="#l169.9"></a><span id="l169.9"> /**</span>
<a href="#l169.10"></a><span id="l169.10">  * Assert the Folder Pane is in All Folder mode by default.  Check that the</span>
<a href="#l169.11"></a><span id="l169.11">  * correct number of rows for accounts and folders are always shown as new</span>
<a href="#l169.12"></a><span id="l169.12">  * folders are created, expanded, and collapsed.</span>
<a href="#l169.13"></a><span id="l169.13">  */</span>
<a href="#l169.14"></a><span id="l169.14" class="difflineminus">-function test_all_folders_toggle_folder_open_state() {</span>
<a href="#l169.15"></a><span id="l169.15" class="difflineplus">+add_task(function test_all_folders_toggle_folder_open_state() {</span>
<a href="#l169.16"></a><span id="l169.16">   // Test that we are in All Folders mode by default</span>
<a href="#l169.17"></a><span id="l169.17">   assert_folder_mode(&quot;all&quot;);</span>
<a href="#l169.18"></a><span id="l169.18"> </span>
<a href="#l169.19"></a><span id="l169.19">   let pop3Server = MailServices.accounts.FindServer(</span>
<a href="#l169.20"></a><span id="l169.20">     &quot;tinderbox&quot;,</span>
<a href="#l169.21"></a><span id="l169.21">     FAKE_SERVER_HOSTNAME,</span>
<a href="#l169.22"></a><span id="l169.22">     &quot;pop3&quot;</span>
<a href="#l169.23"></a><span id="l169.23">   );</span>
<a href="#l169.24"></a><span id="l169.24" class="difflineat">@@ -111,9 +111,16 @@ function test_all_folders_toggle_folder_</span>
<a href="#l169.25"></a><span id="l169.25">   expand_folder(pop3Server.rootFolder);</span>
<a href="#l169.26"></a><span id="l169.26">   folder.clearFlag(Ci.nsMsgFolderFlags.Archive);</span>
<a href="#l169.27"></a><span id="l169.27">   pop3Server.rootFolder.propagateDelete(folder, true, null);</span>
<a href="#l169.28"></a><span id="l169.28">   MailServices.accounts.localFoldersServer.rootFolder.propagateDelete(</span>
<a href="#l169.29"></a><span id="l169.29">     folderA,</span>
<a href="#l169.30"></a><span id="l169.30">     true,</span>
<a href="#l169.31"></a><span id="l169.31">     null</span>
<a href="#l169.32"></a><span id="l169.32">   );</span>
<a href="#l169.33"></a><span id="l169.33" class="difflineminus">-}</span>
<a href="#l169.34"></a><span id="l169.34" class="difflineplus">+</span>
<a href="#l169.35"></a><span id="l169.35" class="difflineplus">+  Assert.report(</span>
<a href="#l169.36"></a><span id="l169.36" class="difflineplus">+    false,</span>
<a href="#l169.37"></a><span id="l169.37" class="difflineplus">+    undefined,</span>
<a href="#l169.38"></a><span id="l169.38" class="difflineplus">+    undefined,</span>
<a href="#l169.39"></a><span id="l169.39" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l169.40"></a><span id="l169.40" class="difflineplus">+  );</span>
<a href="#l169.41"></a><span id="l169.41" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l170.1"></a><span id="l170.1">copy from mail/test/mozmill/folder-pane/test-folder-pane-consumers.js</span>
<a href="#l170.2"></a><span id="l170.2">copy to mail/test/browser/folder-pane/browser_folderPaneConsumers.js</span>
<a href="#l170.3"></a><span id="l170.3" class="difflineminus">--- a/mail/test/mozmill/folder-pane/test-folder-pane-consumers.js</span>
<a href="#l170.4"></a><span id="l170.4" class="difflineplus">+++ b/mail/test/browser/folder-pane/browser_folderPaneConsumers.js</span>
<a href="#l170.5"></a><span id="l170.5" class="difflineat">@@ -1,50 +1,54 @@</span>
<a href="#l170.6"></a><span id="l170.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l170.7"></a><span id="l170.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l170.8"></a><span id="l170.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l170.9"></a><span id="l170.9"> </span>
<a href="#l170.10"></a><span id="l170.10"> /*</span>
<a href="#l170.11"></a><span id="l170.11">  * Tests for other dialogs using the tree view implementation in folderPane.js.</span>
<a href="#l170.12"></a><span id="l170.12">  */</span>
<a href="#l170.13"></a><span id="l170.13"> </span>
<a href="#l170.14"></a><span id="l170.14" class="difflineplus">+/* globals gFolderTreeView */</span>
<a href="#l170.15"></a><span id="l170.15" class="difflineplus">+</span>
<a href="#l170.16"></a><span id="l170.16"> &quot;use strict&quot;;</span>
<a href="#l170.17"></a><span id="l170.17"> </span>
<a href="#l170.18"></a><span id="l170.18" class="difflineminus">-var { assert_true, mc } = ChromeUtils.import(</span>
<a href="#l170.19"></a><span id="l170.19" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l170.20"></a><span id="l170.20">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l170.21"></a><span id="l170.21"> );</span>
<a href="#l170.22"></a><span id="l170.22"> var { NNTP_PORT, setupLocalServer } = ChromeUtils.import(</span>
<a href="#l170.23"></a><span id="l170.23">   &quot;resource://testing-common/mozmill/NNTPHelpers.jsm&quot;</span>
<a href="#l170.24"></a><span id="l170.24"> );</span>
<a href="#l170.25"></a><span id="l170.25"> var { plan_for_modal_dialog, wait_for_modal_dialog } = ChromeUtils.import(</span>
<a href="#l170.26"></a><span id="l170.26">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l170.27"></a><span id="l170.27"> );</span>
<a href="#l170.28"></a><span id="l170.28"> </span>
<a href="#l170.29"></a><span id="l170.29"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l170.30"></a><span id="l170.30">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l170.31"></a><span id="l170.31"> );</span>
<a href="#l170.32"></a><span id="l170.32"> </span>
<a href="#l170.33"></a><span id="l170.33"> var nntpAccount;</span>
<a href="#l170.34"></a><span id="l170.34"> </span>
<a href="#l170.35"></a><span id="l170.35" class="difflineminus">-function setupModule(module) {</span>
<a href="#l170.36"></a><span id="l170.36" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l170.37"></a><span id="l170.37" class="difflineplus">+  gFolderTreeView.selectFolder(gFolderTreeView._enumerateFolders[1]);</span>
<a href="#l170.38"></a><span id="l170.38" class="difflineplus">+</span>
<a href="#l170.39"></a><span id="l170.39">   let server = setupLocalServer(NNTP_PORT);</span>
<a href="#l170.40"></a><span id="l170.40">   nntpAccount = MailServices.accounts.FindAccountForServer(server);</span>
<a href="#l170.41"></a><span id="l170.41" class="difflineminus">-}</span>
<a href="#l170.42"></a><span id="l170.42" class="difflineplus">+});</span>
<a href="#l170.43"></a><span id="l170.43"> </span>
<a href="#l170.44"></a><span id="l170.44" class="difflineminus">-function test_virtual_folder_selection_tree() {</span>
<a href="#l170.45"></a><span id="l170.45" class="difflineplus">+add_task(function test_virtual_folder_selection_tree() {</span>
<a href="#l170.46"></a><span id="l170.46">   plan_for_modal_dialog(</span>
<a href="#l170.47"></a><span id="l170.47">     &quot;mailnews:virtualFolderProperties&quot;,</span>
<a href="#l170.48"></a><span id="l170.48">     subtest_create_virtual_folder</span>
<a href="#l170.49"></a><span id="l170.49">   );</span>
<a href="#l170.50"></a><span id="l170.50">   mc.click_through_appmenu([{ id: &quot;appmenu_new&quot; }], {</span>
<a href="#l170.51"></a><span id="l170.51">     id: &quot;appmenu_newVirtualFolder&quot;,</span>
<a href="#l170.52"></a><span id="l170.52">   });</span>
<a href="#l170.53"></a><span id="l170.53"> </span>
<a href="#l170.54"></a><span id="l170.54">   wait_for_modal_dialog(&quot;mailnews:virtualFolderProperties&quot;);</span>
<a href="#l170.55"></a><span id="l170.55" class="difflineminus">-}</span>
<a href="#l170.56"></a><span id="l170.56" class="difflineplus">+});</span>
<a href="#l170.57"></a><span id="l170.57"> </span>
<a href="#l170.58"></a><span id="l170.58"> function subtest_create_virtual_folder(vfc) {</span>
<a href="#l170.59"></a><span id="l170.59">   // Open the folder chooser.</span>
<a href="#l170.60"></a><span id="l170.60">   plan_for_modal_dialog(</span>
<a href="#l170.61"></a><span id="l170.61">     &quot;mailnews:virtualFolderList&quot;,</span>
<a href="#l170.62"></a><span id="l170.62">     subtest_check_virtual_folder_list</span>
<a href="#l170.63"></a><span id="l170.63">   );</span>
<a href="#l170.64"></a><span id="l170.64">   vfc.click(vfc.eid(&quot;folderListPicker&quot;));</span>
<a href="#l170.65"></a><span id="l170.65" class="difflineat">@@ -55,33 +59,33 @@ function subtest_create_virtual_folder(v</span>
<a href="#l170.66"></a><span id="l170.66"> </span>
<a href="#l170.67"></a><span id="l170.67"> /**</span>
<a href="#l170.68"></a><span id="l170.68">  * Bug 464710</span>
<a href="#l170.69"></a><span id="l170.69">  * Check the folder list picker is not empty.</span>
<a href="#l170.70"></a><span id="l170.70">  */</span>
<a href="#l170.71"></a><span id="l170.71"> function subtest_check_virtual_folder_list(listc) {</span>
<a href="#l170.72"></a><span id="l170.72">   let tree = listc.e(&quot;folderPickerTree&quot;);</span>
<a href="#l170.73"></a><span id="l170.73">   // We should see the folders from the 2 base local accounts here.</span>
<a href="#l170.74"></a><span id="l170.74" class="difflineminus">-  assert_true(</span>
<a href="#l170.75"></a><span id="l170.75" class="difflineplus">+  Assert.ok(</span>
<a href="#l170.76"></a><span id="l170.76">     tree.view.rowCount &gt; 0,</span>
<a href="#l170.77"></a><span id="l170.77">     &quot;Folder tree was empty in virtual folder selection!&quot;</span>
<a href="#l170.78"></a><span id="l170.78">   );</span>
<a href="#l170.79"></a><span id="l170.79">   listc.window.document.documentElement.cancelDialog();</span>
<a href="#l170.80"></a><span id="l170.80"> }</span>
<a href="#l170.81"></a><span id="l170.81"> </span>
<a href="#l170.82"></a><span id="l170.82" class="difflineminus">-function test_offline_sync_folder_selection_tree() {</span>
<a href="#l170.83"></a><span id="l170.83" class="difflineplus">+add_task(function test_offline_sync_folder_selection_tree() {</span>
<a href="#l170.84"></a><span id="l170.84">   plan_for_modal_dialog(&quot;mailnews:synchronizeOffline&quot;, subtest_offline_sync);</span>
<a href="#l170.85"></a><span id="l170.85"> </span>
<a href="#l170.86"></a><span id="l170.86">   mc.click_through_appmenu(</span>
<a href="#l170.87"></a><span id="l170.87">     [{ id: &quot;appmenu_File&quot; }, { id: &quot;appmenu_offline&quot; }],</span>
<a href="#l170.88"></a><span id="l170.88">     { id: &quot;appmenu_synchronizeOffline&quot; }</span>
<a href="#l170.89"></a><span id="l170.89">   );</span>
<a href="#l170.90"></a><span id="l170.90"> </span>
<a href="#l170.91"></a><span id="l170.91">   wait_for_modal_dialog(&quot;mailnews:synchronizeOffline&quot;);</span>
<a href="#l170.92"></a><span id="l170.92" class="difflineminus">-}</span>
<a href="#l170.93"></a><span id="l170.93" class="difflineplus">+});</span>
<a href="#l170.94"></a><span id="l170.94"> </span>
<a href="#l170.95"></a><span id="l170.95"> function subtest_offline_sync(osc) {</span>
<a href="#l170.96"></a><span id="l170.96">   // Open the folder chooser.</span>
<a href="#l170.97"></a><span id="l170.97">   plan_for_modal_dialog(</span>
<a href="#l170.98"></a><span id="l170.98">     &quot;mailnews:selectOffline&quot;,</span>
<a href="#l170.99"></a><span id="l170.99">     subtest_check_offline_folder_list</span>
<a href="#l170.100"></a><span id="l170.100">   );</span>
<a href="#l170.101"></a><span id="l170.101">   osc.click(osc.eid(&quot;select&quot;));</span>
<a href="#l170.102"></a><span id="l170.102" class="difflineat">@@ -92,18 +96,20 @@ function subtest_offline_sync(osc) {</span>
<a href="#l170.103"></a><span id="l170.103"> </span>
<a href="#l170.104"></a><span id="l170.104"> /**</span>
<a href="#l170.105"></a><span id="l170.105">  * Bug 464710</span>
<a href="#l170.106"></a><span id="l170.106">  * Check the folder list picker is not empty.</span>
<a href="#l170.107"></a><span id="l170.107">  */</span>
<a href="#l170.108"></a><span id="l170.108"> function subtest_check_offline_folder_list(listc) {</span>
<a href="#l170.109"></a><span id="l170.109">   let tree = listc.e(&quot;synchronizeTree&quot;);</span>
<a href="#l170.110"></a><span id="l170.110">   // We should see the newsgroups from the NNTP server here.</span>
<a href="#l170.111"></a><span id="l170.111" class="difflineminus">-  assert_true(</span>
<a href="#l170.112"></a><span id="l170.112" class="difflineplus">+  Assert.ok(</span>
<a href="#l170.113"></a><span id="l170.113">     tree.view.rowCount &gt; 0,</span>
<a href="#l170.114"></a><span id="l170.114">     &quot;Folder tree was empty in offline sync selection!&quot;</span>
<a href="#l170.115"></a><span id="l170.115">   );</span>
<a href="#l170.116"></a><span id="l170.116">   listc.window.document.documentElement.cancelDialog();</span>
<a href="#l170.117"></a><span id="l170.117"> }</span>
<a href="#l170.118"></a><span id="l170.118"> </span>
<a href="#l170.119"></a><span id="l170.119" class="difflineminus">-function teardownModule() {</span>
<a href="#l170.120"></a><span id="l170.120" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l170.121"></a><span id="l170.121">   MailServices.accounts.removeAccount(nntpAccount);</span>
<a href="#l170.122"></a><span id="l170.122" class="difflineminus">-}</span>
<a href="#l170.123"></a><span id="l170.123" class="difflineplus">+</span>
<a href="#l170.124"></a><span id="l170.124" class="difflineplus">+  document.getElementById(&quot;folderTree&quot;).focus();</span>
<a href="#l170.125"></a><span id="l170.125" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l171.1"></a><span id="l171.1">new file mode 100644</span>
<a href="#l171.2"></a><span id="l171.2" class="difflineminus">--- /dev/null</span>
<a href="#l171.3"></a><span id="l171.3" class="difflineplus">+++ b/mail/test/browser/folder-tree-modes/browser.ini</span>
<a href="#l171.4"></a><span id="l171.4" class="difflineat">@@ -0,0 +1,61 @@</span>
<a href="#l171.5"></a><span id="l171.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l171.6"></a><span id="l171.6" class="difflineplus">+prefs =</span>
<a href="#l171.7"></a><span id="l171.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l171.8"></a><span id="l171.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l171.9"></a><span id="l171.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l171.10"></a><span id="l171.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l171.11"></a><span id="l171.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l171.12"></a><span id="l171.12" class="difflineplus">+  mail.shell.checkDefaultClient=false</span>
<a href="#l171.13"></a><span id="l171.13" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l171.14"></a><span id="l171.14" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l171.15"></a><span id="l171.15" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l171.16"></a><span id="l171.16" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l171.17"></a><span id="l171.17" class="difflineplus">+  mail.account.account1.server=server1</span>
<a href="#l171.18"></a><span id="l171.18" class="difflineplus">+  mail.account.account2.identities=id1,id2</span>
<a href="#l171.19"></a><span id="l171.19" class="difflineplus">+  mail.account.account2.server=server2</span>
<a href="#l171.20"></a><span id="l171.20" class="difflineplus">+  mail.accountmanager.accounts=account1,account2</span>
<a href="#l171.21"></a><span id="l171.21" class="difflineplus">+  mail.accountmanager.defaultaccount=account2</span>
<a href="#l171.22"></a><span id="l171.22" class="difflineplus">+  mail.accountmanager.localfoldersserver=server1</span>
<a href="#l171.23"></a><span id="l171.23" class="difflineplus">+  mail.identity.id1.fullName=Tinderbox</span>
<a href="#l171.24"></a><span id="l171.24" class="difflineplus">+  mail.identity.id1.htmlSigFormat=false</span>
<a href="#l171.25"></a><span id="l171.25" class="difflineplus">+  mail.identity.id1.smtpServer=smtp1</span>
<a href="#l171.26"></a><span id="l171.26" class="difflineplus">+  mail.identity.id1.useremail=tinderbox@foo.invalid</span>
<a href="#l171.27"></a><span id="l171.27" class="difflineplus">+  mail.identity.id1.valid=true</span>
<a href="#l171.28"></a><span id="l171.28" class="difflineplus">+  mail.identity.id2.fullName=Tinderboxpushlog</span>
<a href="#l171.29"></a><span id="l171.29" class="difflineplus">+  mail.identity.id2.htmlSigFormat=true</span>
<a href="#l171.30"></a><span id="l171.30" class="difflineplus">+  mail.identity.id2.smtpServer=smtp1</span>
<a href="#l171.31"></a><span id="l171.31" class="difflineplus">+  mail.identity.id2.useremail=tinderboxpushlog@foo.invalid</span>
<a href="#l171.32"></a><span id="l171.32" class="difflineplus">+  mail.identity.id2.valid=true</span>
<a href="#l171.33"></a><span id="l171.33" class="difflineplus">+  mail.server.server1.type=none</span>
<a href="#l171.34"></a><span id="l171.34" class="difflineplus">+  mail.server.server1.userName=nobody</span>
<a href="#l171.35"></a><span id="l171.35" class="difflineplus">+  mail.server.server2.check_new_mail=false</span>
<a href="#l171.36"></a><span id="l171.36" class="difflineplus">+  mail.server.server2.directory-rel=[ProfD]Mail/tinderbox</span>
<a href="#l171.37"></a><span id="l171.37" class="difflineplus">+  mail.server.server2.download_on_biff=true</span>
<a href="#l171.38"></a><span id="l171.38" class="difflineplus">+  mail.server.server2.hostname=tinderbox123</span>
<a href="#l171.39"></a><span id="l171.39" class="difflineplus">+  mail.server.server2.login_at_startup=false</span>
<a href="#l171.40"></a><span id="l171.40" class="difflineplus">+  mail.server.server2.name=tinderbox@foo.invalid</span>
<a href="#l171.41"></a><span id="l171.41" class="difflineplus">+  mail.server.server2.type=pop3</span>
<a href="#l171.42"></a><span id="l171.42" class="difflineplus">+  mail.server.server2.userName=tinderbox</span>
<a href="#l171.43"></a><span id="l171.43" class="difflineplus">+  mail.server.server2.whiteListAbURI=</span>
<a href="#l171.44"></a><span id="l171.44" class="difflineplus">+  mail.smtp.defaultserver=smtp1</span>
<a href="#l171.45"></a><span id="l171.45" class="difflineplus">+  mail.smtpserver.smtp1.hostname=tinderbox123</span>
<a href="#l171.46"></a><span id="l171.46" class="difflineplus">+  mail.smtpserver.smtp1.username=tinderbox</span>
<a href="#l171.47"></a><span id="l171.47" class="difflineplus">+  mail.smtpservers=smtp1</span>
<a href="#l171.48"></a><span id="l171.48" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l171.49"></a><span id="l171.49" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l171.50"></a><span id="l171.50" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l171.51"></a><span id="l171.51" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l171.52"></a><span id="l171.52" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l171.53"></a><span id="l171.53" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l171.54"></a><span id="l171.54" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l171.55"></a><span id="l171.55" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l171.56"></a><span id="l171.56" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l171.57"></a><span id="l171.57" class="difflineplus">+support-files = test-extension/**</span>
<a href="#l171.58"></a><span id="l171.58" class="difflineplus">+</span>
<a href="#l171.59"></a><span id="l171.59" class="difflineplus">+[browser_customFolderTreeMode.js]</span>
<a href="#l171.60"></a><span id="l171.60" class="difflineplus">+skip-if = true</span>
<a href="#l171.61"></a><span id="l171.61" class="difflineplus">+[browser_customSmartFolder.js]</span>
<a href="#l171.62"></a><span id="l171.62" class="difflineplus">+skip-if = true</span>
<a href="#l171.63"></a><span id="l171.63" class="difflineplus">+[browser_modeSwitching.js]</span>
<a href="#l171.64"></a><span id="l171.64" class="difflineplus">+[browser_smartFolders.js]</span>
<a href="#l171.65"></a><span id="l171.65" class="difflineplus">+[browser_unreadFolders.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l172.1"></a><span id="l172.1">copy from mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js</span>
<a href="#l172.2"></a><span id="l172.2">copy to mail/test/browser/folder-tree-modes/browser_customFolderTreeMode.js</span>
<a href="#l172.3"></a><span id="l172.3" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/test-custom-folder-tree-mode.js</span>
<a href="#l172.4"></a><span id="l172.4" class="difflineplus">+++ b/mail/test/browser/folder-tree-modes/browser_customFolderTreeMode.js</span>
<a href="#l172.5"></a><span id="l172.5" class="difflineat">@@ -26,54 +26,54 @@ var {</span>
<a href="#l172.6"></a><span id="l172.6"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;);</span>
<a href="#l172.7"></a><span id="l172.7"> </span>
<a href="#l172.8"></a><span id="l172.8"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l172.9"></a><span id="l172.9">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l172.10"></a><span id="l172.10"> );</span>
<a href="#l172.11"></a><span id="l172.11"> </span>
<a href="#l172.12"></a><span id="l172.12"> var gInbox;</span>
<a href="#l172.13"></a><span id="l172.13"> </span>
<a href="#l172.14"></a><span id="l172.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l172.15"></a><span id="l172.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l172.16"></a><span id="l172.16">   let server = MailServices.accounts.FindServer(</span>
<a href="#l172.17"></a><span id="l172.17">     &quot;tinderbox&quot;,</span>
<a href="#l172.18"></a><span id="l172.18">     FAKE_SERVER_HOSTNAME,</span>
<a href="#l172.19"></a><span id="l172.19">     &quot;pop3&quot;</span>
<a href="#l172.20"></a><span id="l172.20">   );</span>
<a href="#l172.21"></a><span id="l172.21">   gInbox = get_special_folder(Ci.nsMsgFolderFlags.Inbox, false, server);</span>
<a href="#l172.22"></a><span id="l172.22" class="difflineminus">-}</span>
<a href="#l172.23"></a><span id="l172.23" class="difflineplus">+});</span>
<a href="#l172.24"></a><span id="l172.24"> </span>
<a href="#l172.25"></a><span id="l172.25"> // Provided by the extension in test-extension</span>
<a href="#l172.26"></a><span id="l172.26"> var kTestModeID = &quot;testmode&quot;;</span>
<a href="#l172.27"></a><span id="l172.27"> </span>
<a href="#l172.28"></a><span id="l172.28"> /**</span>
<a href="#l172.29"></a><span id="l172.29">  * Switch to the mode and verify that it displays correctly.</span>
<a href="#l172.30"></a><span id="l172.30">  */</span>
<a href="#l172.31"></a><span id="l172.31" class="difflineminus">-function test_switch_to_test_mode() {</span>
<a href="#l172.32"></a><span id="l172.32" class="difflineplus">+add_task(function test_switch_to_test_mode() {</span>
<a href="#l172.33"></a><span id="l172.33">   mc.folderTreeView.mode = kTestModeID;</span>
<a href="#l172.34"></a><span id="l172.34">   assert_folder_mode(kTestModeID);</span>
<a href="#l172.35"></a><span id="l172.35">   assert_folder_visible(gInbox);</span>
<a href="#l172.36"></a><span id="l172.36" class="difflineminus">-}</span>
<a href="#l172.37"></a><span id="l172.37" class="difflineplus">+});</span>
<a href="#l172.38"></a><span id="l172.38"> </span>
<a href="#l172.39"></a><span id="l172.39"> /**</span>
<a href="#l172.40"></a><span id="l172.40">  * Open a new 3-pane window while the custom mode is selected, and make sure</span>
<a href="#l172.41"></a><span id="l172.41">  * that the mode displayed in the new window is the custom mode.</span>
<a href="#l172.42"></a><span id="l172.42">  */</span>
<a href="#l172.43"></a><span id="l172.43" class="difflineminus">-function test_open_new_window_with_custom_mode() {</span>
<a href="#l172.44"></a><span id="l172.44" class="difflineplus">+add_task(function test_open_new_window_with_custom_mode() {</span>
<a href="#l172.45"></a><span id="l172.45">   // Our selection may get lost while changing modes, and be_in_folder is</span>
<a href="#l172.46"></a><span id="l172.46">   // not sufficient to ensure actual selection.</span>
<a href="#l172.47"></a><span id="l172.47">   mc.folderTreeView.selectFolder(gInbox);</span>
<a href="#l172.48"></a><span id="l172.48"> </span>
<a href="#l172.49"></a><span id="l172.49">   plan_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l172.50"></a><span id="l172.50">   mc.window.MsgOpenNewWindowForFolder(null, -1);</span>
<a href="#l172.51"></a><span id="l172.51">   let mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l172.52"></a><span id="l172.52"> </span>
<a href="#l172.53"></a><span id="l172.53">   assert_folder_mode(kTestModeID, mc2);</span>
<a href="#l172.54"></a><span id="l172.54">   assert_folder_visible(gInbox, mc2);</span>
<a href="#l172.55"></a><span id="l172.55"> </span>
<a href="#l172.56"></a><span id="l172.56">   close_window(mc2);</span>
<a href="#l172.57"></a><span id="l172.57" class="difflineminus">-}</span>
<a href="#l172.58"></a><span id="l172.58" class="difflineplus">+});</span>
<a href="#l172.59"></a><span id="l172.59"> </span>
<a href="#l172.60"></a><span id="l172.60"> /**</span>
<a href="#l172.61"></a><span id="l172.61">  * Switch back to all folders.</span>
<a href="#l172.62"></a><span id="l172.62">  */</span>
<a href="#l172.63"></a><span id="l172.63" class="difflineminus">-function test_switch_to_all_folders() {</span>
<a href="#l172.64"></a><span id="l172.64" class="difflineplus">+add_task(function test_switch_to_all_folders() {</span>
<a href="#l172.65"></a><span id="l172.65">   mc.folderTreeView.mode = &quot;all&quot;;</span>
<a href="#l172.66"></a><span id="l172.66" class="difflineminus">-}</span>
<a href="#l172.67"></a><span id="l172.67" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l173.1"></a><span id="l173.1">copy from mail/test/mozmill/folder-tree-modes/test-custom-smart-folder.js</span>
<a href="#l173.2"></a><span id="l173.2">copy to mail/test/browser/folder-tree-modes/browser_customSmartFolder.js</span>
<a href="#l173.3"></a><span id="l173.3" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/test-custom-smart-folder.js</span>
<a href="#l173.4"></a><span id="l173.4" class="difflineplus">+++ b/mail/test/browser/folder-tree-modes/browser_customSmartFolder.js</span>
<a href="#l173.5"></a><span id="l173.5" class="difflineat">@@ -38,17 +38,17 @@ var smartFolderInbox;</span>
<a href="#l173.6"></a><span id="l173.6"> var smartFolderA;</span>
<a href="#l173.7"></a><span id="l173.7"> </span>
<a href="#l173.8"></a><span id="l173.8"> var nsMsgFolderFlags = Ci.nsMsgFolderFlags;</span>
<a href="#l173.9"></a><span id="l173.9"> </span>
<a href="#l173.10"></a><span id="l173.10"> /**</span>
<a href="#l173.11"></a><span id="l173.11">  * create two smart folder types and two real folders, one for each</span>
<a href="#l173.12"></a><span id="l173.12">  * smart folder type</span>
<a href="#l173.13"></a><span id="l173.13">  */</span>
<a href="#l173.14"></a><span id="l173.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l173.15"></a><span id="l173.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l173.16"></a><span id="l173.16">   rootFolder = inboxFolder.server.rootFolder;</span>
<a href="#l173.17"></a><span id="l173.17"> </span>
<a href="#l173.18"></a><span id="l173.18">   // register a new smart folder type</span>
<a href="#l173.19"></a><span id="l173.19">   mc.folderTreeView</span>
<a href="#l173.20"></a><span id="l173.20">     .getFolderTreeMode(&quot;smart&quot;)</span>
<a href="#l173.21"></a><span id="l173.21">     .addSmartFolderType(smartParentNameA, false, false);</span>
<a href="#l173.22"></a><span id="l173.22">   mc.folderTreeView</span>
<a href="#l173.23"></a><span id="l173.23">     .getFolderTreeMode(&quot;smart&quot;)</span>
<a href="#l173.24"></a><span id="l173.24" class="difflineat">@@ -65,37 +65,37 @@ function setupModule(module) {</span>
<a href="#l173.25"></a><span id="l173.25">   // bad perf.</span>
<a href="#l173.26"></a><span id="l173.26">   mc.window.setSmartFolderName(subfolderA, smartParentNameA);</span>
<a href="#l173.27"></a><span id="l173.27">   mc.window.setSmartFolderName(subfolderB, smartParentNameB);</span>
<a href="#l173.28"></a><span id="l173.28"> </span>
<a href="#l173.29"></a><span id="l173.29">   // The message itself doesn't really matter, as long as there's at least one</span>
<a href="#l173.30"></a><span id="l173.30">   // in the folder.</span>
<a href="#l173.31"></a><span id="l173.31">   make_new_sets_in_folder(subfolderA, [{ count: 1 }]);</span>
<a href="#l173.32"></a><span id="l173.32">   make_new_sets_in_folder(subfolderB, [{ count: 1 }]);</span>
<a href="#l173.33"></a><span id="l173.33" class="difflineminus">-}</span>
<a href="#l173.34"></a><span id="l173.34" class="difflineplus">+});</span>
<a href="#l173.35"></a><span id="l173.35"> </span>
<a href="#l173.36"></a><span id="l173.36"> /**</span>
<a href="#l173.37"></a><span id="l173.37">  * Switch to the smart folder mode, get the smart inbox.</span>
<a href="#l173.38"></a><span id="l173.38">  */</span>
<a href="#l173.39"></a><span id="l173.39" class="difflineminus">-function test_switch_to_smart_folder_mode() {</span>
<a href="#l173.40"></a><span id="l173.40" class="difflineplus">+add_task(function test_switch_to_smart_folder_mode() {</span>
<a href="#l173.41"></a><span id="l173.41">   mc.folderTreeView.mode = &quot;smart&quot;;</span>
<a href="#l173.42"></a><span id="l173.42">   assert_folder_mode(&quot;smart&quot;);</span>
<a href="#l173.43"></a><span id="l173.43"> </span>
<a href="#l173.44"></a><span id="l173.44">   smartFolderA = get_smart_folder_named(smartParentNameA);</span>
<a href="#l173.45"></a><span id="l173.45">   mc.folderTreeView.selectFolder(smartFolderA);</span>
<a href="#l173.46"></a><span id="l173.46" class="difflineminus">-}</span>
<a href="#l173.47"></a><span id="l173.47" class="difflineplus">+});</span>
<a href="#l173.48"></a><span id="l173.48"> </span>
<a href="#l173.49"></a><span id="l173.49" class="difflineminus">-function test_cache_property() {</span>
<a href="#l173.50"></a><span id="l173.50" class="difflineplus">+add_task(function test_cache_property() {</span>
<a href="#l173.51"></a><span id="l173.51">   if (mc.window.getSmartFolderName(subfolderA) != smartParentNameA) {</span>
<a href="#l173.52"></a><span id="l173.52">     throw new Error(&quot;smartFolderName A cache property not set&quot;);</span>
<a href="#l173.53"></a><span id="l173.53">   }</span>
<a href="#l173.54"></a><span id="l173.54">   if (mc.window.getSmartFolderName(subfolderB) != smartParentNameB) {</span>
<a href="#l173.55"></a><span id="l173.55">     throw new Error(&quot;smartFolderName B cache property not set&quot;);</span>
<a href="#l173.56"></a><span id="l173.56">   }</span>
<a href="#l173.57"></a><span id="l173.57" class="difflineminus">-}</span>
<a href="#l173.58"></a><span id="l173.58" class="difflineplus">+});</span>
<a href="#l173.59"></a><span id="l173.59"> </span>
<a href="#l173.60"></a><span id="l173.60"> function _test_smart_folder_type(folder, parentName) {</span>
<a href="#l173.61"></a><span id="l173.61">   let smartMode = mc.folderTreeView.getFolderTreeMode(&quot;smart&quot;);</span>
<a href="#l173.62"></a><span id="l173.62">   let [flag, name] = smartMode._getSmartFolderType(folder);</span>
<a href="#l173.63"></a><span id="l173.63">   if (flag != 0) {</span>
<a href="#l173.64"></a><span id="l173.64">     throw new Error(</span>
<a href="#l173.65"></a><span id="l173.65">       &quot;custom smart folder definition [&quot; + parentName + &quot;] has a flag&quot;</span>
<a href="#l173.66"></a><span id="l173.66">     );</span>
<a href="#l173.67"></a><span id="l173.67" class="difflineat">@@ -108,32 +108,32 @@ function _test_smart_folder_type(folder,</span>
<a href="#l173.68"></a><span id="l173.68">         name +</span>
<a href="#l173.69"></a><span id="l173.69">         &quot;] should be [&quot; +</span>
<a href="#l173.70"></a><span id="l173.70">         parentName +</span>
<a href="#l173.71"></a><span id="l173.71">         &quot;]&quot;</span>
<a href="#l173.72"></a><span id="l173.72">     );</span>
<a href="#l173.73"></a><span id="l173.73">   }</span>
<a href="#l173.74"></a><span id="l173.74"> }</span>
<a href="#l173.75"></a><span id="l173.75"> </span>
<a href="#l173.76"></a><span id="l173.76" class="difflineminus">-function test_smart_folder_type() {</span>
<a href="#l173.77"></a><span id="l173.77" class="difflineplus">+add_task(function test_smart_folder_type() {</span>
<a href="#l173.78"></a><span id="l173.78">   _test_smart_folder_type(subfolderA, smartParentNameA);</span>
<a href="#l173.79"></a><span id="l173.79">   _test_smart_folder_type(subfolderB, smartParentNameB);</span>
<a href="#l173.80"></a><span id="l173.80" class="difflineminus">-}</span>
<a href="#l173.81"></a><span id="l173.81" class="difflineplus">+});</span>
<a href="#l173.82"></a><span id="l173.82"> </span>
<a href="#l173.83"></a><span id="l173.83"> /**</span>
<a href="#l173.84"></a><span id="l173.84">  * Test that our custom smart folders exist</span>
<a href="#l173.85"></a><span id="l173.85">  */</span>
<a href="#l173.86"></a><span id="l173.86"> </span>
<a href="#l173.87"></a><span id="l173.87" class="difflineminus">-function test_custom_folder_exists() {</span>
<a href="#l173.88"></a><span id="l173.88" class="difflineplus">+add_task(function test_custom_folder_exists() {</span>
<a href="#l173.89"></a><span id="l173.89">   assert_folder_mode(&quot;smart&quot;);</span>
<a href="#l173.90"></a><span id="l173.90">   assert_folder_displayed(smartFolderA);</span>
<a href="#l173.91"></a><span id="l173.91">   // this is our custom smart folder parent created in folderPane.js</span>
<a href="#l173.92"></a><span id="l173.92">   mc.folderTreeView.selectFolder(subfolderA);</span>
<a href="#l173.93"></a><span id="l173.93">   assert_folder_selected_and_displayed(subfolderA);</span>
<a href="#l173.94"></a><span id="l173.94" class="difflineminus">-}</span>
<a href="#l173.95"></a><span id="l173.95" class="difflineplus">+});</span>
<a href="#l173.96"></a><span id="l173.96"> </span>
<a href="#l173.97"></a><span id="l173.97"> function FTVItemHasChild(parentFTVItem, childFolder, recurse) {</span>
<a href="#l173.98"></a><span id="l173.98">   for (let child of parentFTVItem.children) {</span>
<a href="#l173.99"></a><span id="l173.99">     if (</span>
<a href="#l173.100"></a><span id="l173.100">       child._folder.URI == childFolder.URI ||</span>
<a href="#l173.101"></a><span id="l173.101">       (recurse &amp;&amp; FTVItemHasChild(child, childFolder, recurse))</span>
<a href="#l173.102"></a><span id="l173.102">     ) {</span>
<a href="#l173.103"></a><span id="l173.103">       return true;</span>
<a href="#l173.104"></a><span id="l173.104" class="difflineat">@@ -141,68 +141,68 @@ function FTVItemHasChild(parentFTVItem, </span>
<a href="#l173.105"></a><span id="l173.105">   }</span>
<a href="#l173.106"></a><span id="l173.106">   return false;</span>
<a href="#l173.107"></a><span id="l173.107"> }</span>
<a href="#l173.108"></a><span id="l173.108"> </span>
<a href="#l173.109"></a><span id="l173.109"> /**</span>
<a href="#l173.110"></a><span id="l173.110">  * test that our real smart folder is in fact a child if the correct</span>
<a href="#l173.111"></a><span id="l173.111">  * smart folder parent</span>
<a href="#l173.112"></a><span id="l173.112">  */</span>
<a href="#l173.113"></a><span id="l173.113" class="difflineminus">-function test_smart_child_parent_relationship() {</span>
<a href="#l173.114"></a><span id="l173.114" class="difflineplus">+add_task(function test_smart_child_parent_relationship() {</span>
<a href="#l173.115"></a><span id="l173.115">   let folderIndex = assert_folder_visible(smartFolderA);</span>
<a href="#l173.116"></a><span id="l173.116">   let folderFTVItem = mc.folderTreeView.getFTVItemForIndex(folderIndex);</span>
<a href="#l173.117"></a><span id="l173.117">   if (!FTVItemHasChild(folderFTVItem, subfolderA, false)) {</span>
<a href="#l173.118"></a><span id="l173.118">     throw new Error(</span>
<a href="#l173.119"></a><span id="l173.119">       &quot;Folder: &quot; +</span>
<a href="#l173.120"></a><span id="l173.120">         subfolderA.name +</span>
<a href="#l173.121"></a><span id="l173.121">         &quot; is not a child of our smart parent folder&quot;</span>
<a href="#l173.122"></a><span id="l173.122">     );</span>
<a href="#l173.123"></a><span id="l173.123">   }</span>
<a href="#l173.124"></a><span id="l173.124">   assert_folder_mode(&quot;smart&quot;);</span>
<a href="#l173.125"></a><span id="l173.125" class="difflineminus">-}</span>
<a href="#l173.126"></a><span id="l173.126" class="difflineplus">+});</span>
<a href="#l173.127"></a><span id="l173.127"> </span>
<a href="#l173.128"></a><span id="l173.128"> /**</span>
<a href="#l173.129"></a><span id="l173.129">  * test that our real smart folder is NOT a child of the smart inbox in the</span>
<a href="#l173.130"></a><span id="l173.130">  * tree view.</span>
<a href="#l173.131"></a><span id="l173.131">  */</span>
<a href="#l173.132"></a><span id="l173.132" class="difflineminus">-function test_real_child_parent_relationship() {</span>
<a href="#l173.133"></a><span id="l173.133" class="difflineplus">+add_task(function test_real_child_parent_relationship() {</span>
<a href="#l173.134"></a><span id="l173.134">   smartFolderInbox = get_smart_folder_named(&quot;Inbox&quot;);</span>
<a href="#l173.135"></a><span id="l173.135">   expand_folder(smartFolderInbox);</span>
<a href="#l173.136"></a><span id="l173.136">   // the real parent should be an Inbox</span>
<a href="#l173.137"></a><span id="l173.137">   let folderIndex = assert_folder_visible(subfolderA.parent);</span>
<a href="#l173.138"></a><span id="l173.138">   let folderFTVItem = mc.folderTreeView.getFTVItemForIndex(folderIndex);</span>
<a href="#l173.139"></a><span id="l173.139">   // in the tree, subfolder is a child of our magic smart folder, and should not</span>
<a href="#l173.140"></a><span id="l173.140">   // be a child of inbox</span>
<a href="#l173.141"></a><span id="l173.141">   if (FTVItemHasChild(folderFTVItem, subfolderA, true)) {</span>
<a href="#l173.142"></a><span id="l173.142">     throw new Error(</span>
<a href="#l173.143"></a><span id="l173.143">       &quot;Folder: &quot; + subfolderA.name + &quot; should not be a child of an inbox&quot;</span>
<a href="#l173.144"></a><span id="l173.144">     );</span>
<a href="#l173.145"></a><span id="l173.145">   }</span>
<a href="#l173.146"></a><span id="l173.146">   assert_folder_mode(&quot;smart&quot;);</span>
<a href="#l173.147"></a><span id="l173.147" class="difflineminus">-}</span>
<a href="#l173.148"></a><span id="l173.148" class="difflineplus">+});</span>
<a href="#l173.149"></a><span id="l173.149"> </span>
<a href="#l173.150"></a><span id="l173.150"> /**</span>
<a href="#l173.151"></a><span id="l173.151">  * test collapse/expand states of one of our smart folders</span>
<a href="#l173.152"></a><span id="l173.152">  */</span>
<a href="#l173.153"></a><span id="l173.153" class="difflineminus">-function test_smart_subfolder() {</span>
<a href="#l173.154"></a><span id="l173.154" class="difflineplus">+add_task(function test_smart_subfolder() {</span>
<a href="#l173.155"></a><span id="l173.155">   assert_folder_mode(&quot;smart&quot;);</span>
<a href="#l173.156"></a><span id="l173.156">   collapse_folder(smartFolderA);</span>
<a href="#l173.157"></a><span id="l173.157">   assert_folder_collapsed(smartFolderA);</span>
<a href="#l173.158"></a><span id="l173.158">   assert_folder_not_visible(subfolderA);</span>
<a href="#l173.159"></a><span id="l173.159"> </span>
<a href="#l173.160"></a><span id="l173.160">   expand_folder(smartFolderA);</span>
<a href="#l173.161"></a><span id="l173.161">   assert_folder_expanded(smartFolderA);</span>
<a href="#l173.162"></a><span id="l173.162">   assert_folder_visible(subfolderA);</span>
<a href="#l173.163"></a><span id="l173.163" class="difflineminus">-}</span>
<a href="#l173.164"></a><span id="l173.164" class="difflineplus">+});</span>
<a href="#l173.165"></a><span id="l173.165"> </span>
<a href="#l173.166"></a><span id="l173.166"> /**</span>
<a href="#l173.167"></a><span id="l173.167">  * Switch back to all folders.</span>
<a href="#l173.168"></a><span id="l173.168">  */</span>
<a href="#l173.169"></a><span id="l173.169" class="difflineminus">-function test_return_to_all_folders() {</span>
<a href="#l173.170"></a><span id="l173.170" class="difflineplus">+add_task(function test_return_to_all_folders() {</span>
<a href="#l173.171"></a><span id="l173.171">   assert_folder_mode(&quot;smart&quot;);</span>
<a href="#l173.172"></a><span id="l173.172">   mc.folderTreeView.mode = &quot;all&quot;;</span>
<a href="#l173.173"></a><span id="l173.173">   assert_folder_mode(&quot;all&quot;);</span>
<a href="#l173.174"></a><span id="l173.174" class="difflineminus">-}</span>
<a href="#l173.175"></a><span id="l173.175" class="difflineplus">+});</span>
<a href="#l173.176"></a><span id="l173.176"> </span>
<a href="#l173.177"></a><span id="l173.177" class="difflineminus">-function teardownModule() {</span>
<a href="#l173.178"></a><span id="l173.178" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l173.179"></a><span id="l173.179">   inboxFolder.propagateDelete(subfolderA, true, null);</span>
<a href="#l173.180"></a><span id="l173.180">   inboxFolder.propagateDelete(subfolderB, true, null);</span>
<a href="#l173.181"></a><span id="l173.181" class="difflineminus">-}</span>
<a href="#l173.182"></a><span id="l173.182" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l174.1"></a><span id="l174.1">copy from mail/test/mozmill/folder-tree-modes/test-mode-switching.js</span>
<a href="#l174.2"></a><span id="l174.2">copy to mail/test/browser/folder-tree-modes/browser_modeSwitching.js</span>
<a href="#l174.3"></a><span id="l174.3" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/test-mode-switching.js</span>
<a href="#l174.4"></a><span id="l174.4" class="difflineplus">+++ b/mail/test/browser/folder-tree-modes/browser_modeSwitching.js</span>
<a href="#l174.5"></a><span id="l174.5" class="difflineat">@@ -6,20 +6,18 @@</span>
<a href="#l174.6"></a><span id="l174.6">  * Bug 978592.</span>
<a href="#l174.7"></a><span id="l174.7">  * Test that switching folder modes via menu works and also compact versions</span>
<a href="#l174.8"></a><span id="l174.8">  * can be toggled properly.</span>
<a href="#l174.9"></a><span id="l174.9">  */</span>
<a href="#l174.10"></a><span id="l174.10"> </span>
<a href="#l174.11"></a><span id="l174.11"> &quot;use strict&quot;;</span>
<a href="#l174.12"></a><span id="l174.12"> </span>
<a href="#l174.13"></a><span id="l174.13"> var {</span>
<a href="#l174.14"></a><span id="l174.14" class="difflineminus">-  assert_equals,</span>
<a href="#l174.15"></a><span id="l174.15">   assert_folder_not_visible,</span>
<a href="#l174.16"></a><span id="l174.16">   assert_folder_visible,</span>
<a href="#l174.17"></a><span id="l174.17" class="difflineminus">-  assert_true,</span>
<a href="#l174.18"></a><span id="l174.18">   inboxFolder,</span>
<a href="#l174.19"></a><span id="l174.19">   make_new_sets_in_folder,</span>
<a href="#l174.20"></a><span id="l174.20">   mc,</span>
<a href="#l174.21"></a><span id="l174.21">   select_no_folders,</span>
<a href="#l174.22"></a><span id="l174.22">   toggle_main_menu,</span>
<a href="#l174.23"></a><span id="l174.23"> } = ChromeUtils.import(</span>
<a href="#l174.24"></a><span id="l174.24">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l174.25"></a><span id="l174.25"> );</span>
<a href="#l174.26"></a><span id="l174.26" class="difflineat">@@ -33,17 +31,17 @@ var tree;</span>
<a href="#l174.27"></a><span id="l174.27"> var modeList_menu;</span>
<a href="#l174.28"></a><span id="l174.28"> var modeList_appmenu;</span>
<a href="#l174.29"></a><span id="l174.29"> var view_menu;</span>
<a href="#l174.30"></a><span id="l174.30"> var view_menupopup;</span>
<a href="#l174.31"></a><span id="l174.31"> var appmenu_button;</span>
<a href="#l174.32"></a><span id="l174.32"> var appmenu_mainView;</span>
<a href="#l174.33"></a><span id="l174.33"> var menu_state;</span>
<a href="#l174.34"></a><span id="l174.34"> </span>
<a href="#l174.35"></a><span id="l174.35" class="difflineminus">-function setupModule(module) {</span>
<a href="#l174.36"></a><span id="l174.36" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l174.37"></a><span id="l174.37">   rootFolder = inboxFolder.server.rootFolder;</span>
<a href="#l174.38"></a><span id="l174.38"> </span>
<a href="#l174.39"></a><span id="l174.39">   // Create one folder with unread messages and one favorite folder.</span>
<a href="#l174.40"></a><span id="l174.40">   inboxFolder.createSubfolder(&quot;UnreadFolder&quot;, null);</span>
<a href="#l174.41"></a><span id="l174.41">   unreadFolder = inboxFolder.getChildNamed(&quot;UnreadFolder&quot;);</span>
<a href="#l174.42"></a><span id="l174.42"> </span>
<a href="#l174.43"></a><span id="l174.43">   inboxFolder.createSubfolder(&quot;FavoriteFolder&quot;, null);</span>
<a href="#l174.44"></a><span id="l174.44">   favoriteFolder = inboxFolder.getChildNamed(&quot;FavoriteFolder&quot;);</span>
<a href="#l174.45"></a><span id="l174.45" class="difflineat">@@ -62,64 +60,64 @@ function setupModule(module) {</span>
<a href="#l174.46"></a><span id="l174.46">   appmenu_button = mc.eid(&quot;button-appmenu&quot;);</span>
<a href="#l174.47"></a><span id="l174.47">   appmenu_mainView = mc.e(&quot;appMenu-mainView&quot;);</span>
<a href="#l174.48"></a><span id="l174.48"> </span>
<a href="#l174.49"></a><span id="l174.49">   tree = mc.folderTreeView;</span>
<a href="#l174.50"></a><span id="l174.50"> </span>
<a href="#l174.51"></a><span id="l174.51">   select_no_folders();</span>
<a href="#l174.52"></a><span id="l174.52">   // Main menu is needed for this whole test file.</span>
<a href="#l174.53"></a><span id="l174.53">   menu_state = toggle_main_menu(true);</span>
<a href="#l174.54"></a><span id="l174.54" class="difflineminus">-}</span>
<a href="#l174.55"></a><span id="l174.55" class="difflineplus">+});</span>
<a href="#l174.56"></a><span id="l174.56"> </span>
<a href="#l174.57"></a><span id="l174.57"> /**</span>
<a href="#l174.58"></a><span id="l174.58">  * Check if both &quot;Compact view&quot; checkboxes in menu are of the expected state.</span>
<a href="#l174.59"></a><span id="l174.59">  *</span>
<a href="#l174.60"></a><span id="l174.60">  * @param aChecked  Boolean whether checkbox should be checked or not.</span>
<a href="#l174.61"></a><span id="l174.61">  * @param aDisabled  Optional boolean whether the menuitem should be disabled..</span>
<a href="#l174.62"></a><span id="l174.62">  */</span>
<a href="#l174.63"></a><span id="l174.63"> function assert_compact_state(aChecked, aDisabled) {</span>
<a href="#l174.64"></a><span id="l174.64" class="difflineminus">-  assert_equals(toggle_menu.hasAttribute(&quot;checked&quot;), aChecked);</span>
<a href="#l174.65"></a><span id="l174.65" class="difflineminus">-  assert_equals(toggle_appmenu.hasAttribute(&quot;checked&quot;), aChecked);</span>
<a href="#l174.66"></a><span id="l174.66" class="difflineplus">+  Assert.equal(toggle_menu.hasAttribute(&quot;checked&quot;), aChecked);</span>
<a href="#l174.67"></a><span id="l174.67" class="difflineplus">+  Assert.equal(toggle_appmenu.hasAttribute(&quot;checked&quot;), aChecked);</span>
<a href="#l174.68"></a><span id="l174.68">   if (aDisabled != undefined) {</span>
<a href="#l174.69"></a><span id="l174.69" class="difflineminus">-    assert_equals(toggle_menu.disabled, aDisabled);</span>
<a href="#l174.70"></a><span id="l174.70" class="difflineminus">-    assert_equals(toggle_appmenu.disabled, aDisabled);</span>
<a href="#l174.71"></a><span id="l174.71" class="difflineplus">+    Assert.equal(toggle_menu.disabled, aDisabled);</span>
<a href="#l174.72"></a><span id="l174.72" class="difflineplus">+    Assert.equal(toggle_appmenu.disabled, aDisabled);</span>
<a href="#l174.73"></a><span id="l174.73">   }</span>
<a href="#l174.74"></a><span id="l174.74"> }</span>
<a href="#l174.75"></a><span id="l174.75"> </span>
<a href="#l174.76"></a><span id="l174.76"> /**</span>
<a href="#l174.77"></a><span id="l174.77">  * Check whether the expected folder mode is selected in menus and internally.</span>
<a href="#l174.78"></a><span id="l174.78">  *</span>
<a href="#l174.79"></a><span id="l174.79">  * @param aMode  The name of the expected mode.</span>
<a href="#l174.80"></a><span id="l174.80">  */</span>
<a href="#l174.81"></a><span id="l174.81"> function assert_mode_selected(aMode) {</span>
<a href="#l174.82"></a><span id="l174.82" class="difflineminus">-  assert_equals(tree.mode, aMode);</span>
<a href="#l174.83"></a><span id="l174.83" class="difflineplus">+  Assert.equal(tree.mode, aMode);</span>
<a href="#l174.84"></a><span id="l174.84">   let baseMode = tree.baseMode();</span>
<a href="#l174.85"></a><span id="l174.85">   assert_compact_state(baseMode != tree.mode);</span>
<a href="#l174.86"></a><span id="l174.86">   // We need to open the menu because only then the right mode is set in them.</span>
<a href="#l174.87"></a><span id="l174.87">   if (!mc.mozmillModule.isMac) {</span>
<a href="#l174.88"></a><span id="l174.88">     // On OS X the main menu seems not accessible for clicking from mozmill.</span>
<a href="#l174.89"></a><span id="l174.89">     mc.click(view_menu);</span>
<a href="#l174.90"></a><span id="l174.90">     let popuplist = mc.click_menus_in_sequence(</span>
<a href="#l174.91"></a><span id="l174.91">       view_menupopup,</span>
<a href="#l174.92"></a><span id="l174.92">       [{ id: modeList_menu.parentNode.id }],</span>
<a href="#l174.93"></a><span id="l174.93">       true</span>
<a href="#l174.94"></a><span id="l174.94">     );</span>
<a href="#l174.95"></a><span id="l174.95" class="difflineminus">-    assert_true(</span>
<a href="#l174.96"></a><span id="l174.96" class="difflineplus">+    Assert.ok(</span>
<a href="#l174.97"></a><span id="l174.97">       modeList_menu</span>
<a href="#l174.98"></a><span id="l174.98">         .querySelector('[value=&quot;' + baseMode + '&quot;]')</span>
<a href="#l174.99"></a><span id="l174.99">         .hasAttribute(&quot;checked&quot;)</span>
<a href="#l174.100"></a><span id="l174.100">     );</span>
<a href="#l174.101"></a><span id="l174.101">     mc.close_popup_sequence(popuplist);</span>
<a href="#l174.102"></a><span id="l174.102">   }</span>
<a href="#l174.103"></a><span id="l174.103">   mc.click_through_appmenu([</span>
<a href="#l174.104"></a><span id="l174.104">     { id: &quot;appmenu_View&quot; },</span>
<a href="#l174.105"></a><span id="l174.105">     { id: &quot;appmenu_FolderViews&quot; },</span>
<a href="#l174.106"></a><span id="l174.106">   ]);</span>
<a href="#l174.107"></a><span id="l174.107"> </span>
<a href="#l174.108"></a><span id="l174.108" class="difflineminus">-  assert_true(</span>
<a href="#l174.109"></a><span id="l174.109" class="difflineplus">+  Assert.ok(</span>
<a href="#l174.110"></a><span id="l174.110">     modeList_appmenu</span>
<a href="#l174.111"></a><span id="l174.111">       .querySelector('[value=&quot;' + baseMode + '&quot;]')</span>
<a href="#l174.112"></a><span id="l174.112">       .hasAttribute(&quot;checked&quot;)</span>
<a href="#l174.113"></a><span id="l174.113">   );</span>
<a href="#l174.114"></a><span id="l174.114">   // Close the appmenu by clicking the appmenu button again.</span>
<a href="#l174.115"></a><span id="l174.115">   mc.click(appmenu_button);</span>
<a href="#l174.116"></a><span id="l174.116"> }</span>
<a href="#l174.117"></a><span id="l174.117"> </span>
<a href="#l174.118"></a><span id="l174.118" class="difflineat">@@ -284,30 +282,30 @@ function subtest_switch_to_smart_folders</span>
<a href="#l174.119"></a><span id="l174.119">   // This mode should be rejected as it doesn't exist.</span>
<a href="#l174.120"></a><span id="l174.120">   tree.mode = mode + &quot;_compact&quot;;</span>
<a href="#l174.121"></a><span id="l174.121">   assert_mode_selected(mode);</span>
<a href="#l174.122"></a><span id="l174.122"> }</span>
<a href="#l174.123"></a><span id="l174.123"> </span>
<a href="#l174.124"></a><span id="l174.124"> /**</span>
<a href="#l174.125"></a><span id="l174.125">  * Toggle folder modes through different means and sequences.</span>
<a href="#l174.126"></a><span id="l174.126">  */</span>
<a href="#l174.127"></a><span id="l174.127" class="difflineminus">-function test_toggling_modes() {</span>
<a href="#l174.128"></a><span id="l174.128" class="difflineplus">+add_task(function test_toggling_modes() {</span>
<a href="#l174.129"></a><span id="l174.129">   subtest_switch_to_all_folders(false);</span>
<a href="#l174.130"></a><span id="l174.130">   subtest_switch_to_smart_folders(false);</span>
<a href="#l174.131"></a><span id="l174.131"> </span>
<a href="#l174.132"></a><span id="l174.132">   subtest_switch_to_unread_folders(false);</span>
<a href="#l174.133"></a><span id="l174.133">   subtest_switch_to_favorite_folders(false);</span>
<a href="#l174.134"></a><span id="l174.134">   subtest_switch_to_recent_folders(false);</span>
<a href="#l174.135"></a><span id="l174.135"> </span>
<a href="#l174.136"></a><span id="l174.136">   subtest_switch_to_unread_folders(true);</span>
<a href="#l174.137"></a><span id="l174.137">   subtest_switch_to_favorite_folders(true);</span>
<a href="#l174.138"></a><span id="l174.138">   subtest_switch_to_recent_folders(true);</span>
<a href="#l174.139"></a><span id="l174.139"> </span>
<a href="#l174.140"></a><span id="l174.140">   subtest_switch_to_smart_folders(true);</span>
<a href="#l174.141"></a><span id="l174.141">   subtest_switch_to_all_folders(true);</span>
<a href="#l174.142"></a><span id="l174.142" class="difflineminus">-}</span>
<a href="#l174.143"></a><span id="l174.143" class="difflineplus">+});</span>
<a href="#l174.144"></a><span id="l174.144"> </span>
<a href="#l174.145"></a><span id="l174.145" class="difflineminus">-function teardownModule() {</span>
<a href="#l174.146"></a><span id="l174.146" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l174.147"></a><span id="l174.147">   tree.mode = &quot;all&quot;;</span>
<a href="#l174.148"></a><span id="l174.148">   inboxFolder.propagateDelete(unreadFolder, true, null);</span>
<a href="#l174.149"></a><span id="l174.149">   inboxFolder.propagateDelete(favoriteFolder, true, null);</span>
<a href="#l174.150"></a><span id="l174.150">   toggle_main_menu(menu_state);</span>
<a href="#l174.151"></a><span id="l174.151" class="difflineminus">-}</span>
<a href="#l174.152"></a><span id="l174.152" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l175.1"></a><span id="l175.1">copy from mail/test/mozmill/folder-tree-modes/test-smart-folders.js</span>
<a href="#l175.2"></a><span id="l175.2">copy to mail/test/browser/folder-tree-modes/browser_smartFolders.js</span>
<a href="#l175.3"></a><span id="l175.3" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/test-smart-folders.js</span>
<a href="#l175.4"></a><span id="l175.4" class="difflineplus">+++ b/mail/test/browser/folder-tree-modes/browser_smartFolders.js</span>
<a href="#l175.5"></a><span id="l175.5" class="difflineat">@@ -42,34 +42,34 @@ var rootFolder;</span>
<a href="#l175.6"></a><span id="l175.6"> var inboxSubfolder;</span>
<a href="#l175.7"></a><span id="l175.7"> var trashFolder;</span>
<a href="#l175.8"></a><span id="l175.8"> var trashSubfolder;</span>
<a href="#l175.9"></a><span id="l175.9"> </span>
<a href="#l175.10"></a><span id="l175.10"> var smartInboxFolder;</span>
<a href="#l175.11"></a><span id="l175.11"> </span>
<a href="#l175.12"></a><span id="l175.12"> var inboxSet;</span>
<a href="#l175.13"></a><span id="l175.13"> </span>
<a href="#l175.14"></a><span id="l175.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l175.15"></a><span id="l175.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l175.16"></a><span id="l175.16">   rootFolder = inboxFolder.server.rootFolder;</span>
<a href="#l175.17"></a><span id="l175.17"> </span>
<a href="#l175.18"></a><span id="l175.18">   // Create a folder as a subfolder of the inbox</span>
<a href="#l175.19"></a><span id="l175.19">   inboxFolder.createSubfolder(&quot;SmartFoldersA&quot;, null);</span>
<a href="#l175.20"></a><span id="l175.20">   inboxSubfolder = inboxFolder.getChildNamed(&quot;SmartFoldersA&quot;);</span>
<a href="#l175.21"></a><span id="l175.21"> </span>
<a href="#l175.22"></a><span id="l175.22">   trashFolder = inboxFolder.server.rootFolder.getFolderWithFlags(</span>
<a href="#l175.23"></a><span id="l175.23">     Ci.nsMsgFolderFlags.Trash</span>
<a href="#l175.24"></a><span id="l175.24">   );</span>
<a href="#l175.25"></a><span id="l175.25">   trashFolder.createSubfolder(&quot;SmartFoldersB&quot;, null);</span>
<a href="#l175.26"></a><span id="l175.26">   trashSubfolder = trashFolder.getChildNamed(&quot;SmartFoldersB&quot;);</span>
<a href="#l175.27"></a><span id="l175.27"> </span>
<a href="#l175.28"></a><span id="l175.28">   // The message itself doesn't really matter, as long as there's at least one</span>
<a href="#l175.29"></a><span id="l175.29">   // in the folder.</span>
<a href="#l175.30"></a><span id="l175.30">   [inboxSet] = make_new_sets_in_folder(inboxFolder, [{ count: 1 }]);</span>
<a href="#l175.31"></a><span id="l175.31">   make_new_sets_in_folder(inboxSubfolder, [{ count: 1 }]);</span>
<a href="#l175.32"></a><span id="l175.32" class="difflineminus">-}</span>
<a href="#l175.33"></a><span id="l175.33" class="difflineplus">+});</span>
<a href="#l175.34"></a><span id="l175.34"> </span>
<a href="#l175.35"></a><span id="l175.35"> /**</span>
<a href="#l175.36"></a><span id="l175.36">  * Assert that the given folder is considered to be the container of the given</span>
<a href="#l175.37"></a><span id="l175.37">  * message header in this folder mode.</span>
<a href="#l175.38"></a><span id="l175.38">  */</span>
<a href="#l175.39"></a><span id="l175.39"> function assert_folder_for_msg_hdr(aMsgHdr, aFolder) {</span>
<a href="#l175.40"></a><span id="l175.40">   let actualFolder = mc.folderTreeView.getFolderForMsgHdr(aMsgHdr);</span>
<a href="#l175.41"></a><span id="l175.41">   if (actualFolder != aFolder) {</span>
<a href="#l175.42"></a><span id="l175.42" class="difflineat">@@ -82,28 +82,28 @@ function assert_folder_for_msg_hdr(aMsgH</span>
<a href="#l175.43"></a><span id="l175.43">         actualFolder.URI</span>
<a href="#l175.44"></a><span id="l175.44">     );</span>
<a href="#l175.45"></a><span id="l175.45">   }</span>
<a href="#l175.46"></a><span id="l175.46"> }</span>
<a href="#l175.47"></a><span id="l175.47"> </span>
<a href="#l175.48"></a><span id="l175.48"> /**</span>
<a href="#l175.49"></a><span id="l175.49">  * Switch to the smart folder mode.</span>
<a href="#l175.50"></a><span id="l175.50">  */</span>
<a href="#l175.51"></a><span id="l175.51" class="difflineminus">-function test_switch_to_smart_folders() {</span>
<a href="#l175.52"></a><span id="l175.52" class="difflineplus">+add_task(function test_switch_to_smart_folders() {</span>
<a href="#l175.53"></a><span id="l175.53">   mc.folderTreeView.mode = &quot;smart&quot;;</span>
<a href="#l175.54"></a><span id="l175.54"> </span>
<a href="#l175.55"></a><span id="l175.55">   // The smart inbox may not have been created at setupModule time, so get it</span>
<a href="#l175.56"></a><span id="l175.56">   // now</span>
<a href="#l175.57"></a><span id="l175.57">   smartInboxFolder = get_smart_folder_named(&quot;Inbox&quot;);</span>
<a href="#l175.58"></a><span id="l175.58" class="difflineminus">-}</span>
<a href="#l175.59"></a><span id="l175.59" class="difflineplus">+});</span>
<a href="#l175.60"></a><span id="l175.60"> </span>
<a href="#l175.61"></a><span id="l175.61"> /**</span>
<a href="#l175.62"></a><span id="l175.62">  * Test the getParentOfFolder function.</span>
<a href="#l175.63"></a><span id="l175.63">  */</span>
<a href="#l175.64"></a><span id="l175.64" class="difflineminus">-function test_get_parent_of_folder() {</span>
<a href="#l175.65"></a><span id="l175.65" class="difflineplus">+add_task(function test_get_parent_of_folder() {</span>
<a href="#l175.66"></a><span id="l175.66">   // An inbox should have the special inbox as its parent</span>
<a href="#l175.67"></a><span id="l175.67">   assert_folder_child_in_view(inboxFolder, smartInboxFolder);</span>
<a href="#l175.68"></a><span id="l175.68">   // Similarly for the trash folder</span>
<a href="#l175.69"></a><span id="l175.69">   assert_folder_child_in_view(trashFolder, get_smart_folder_named(&quot;Trash&quot;));</span>
<a href="#l175.70"></a><span id="l175.70"> </span>
<a href="#l175.71"></a><span id="l175.71">   // A child of the inbox (a shallow special folder) should have the account's</span>
<a href="#l175.72"></a><span id="l175.72">   // root folder as its parent</span>
<a href="#l175.73"></a><span id="l175.73">   assert_folder_child_in_view(inboxSubfolder, rootFolder);</span>
<a href="#l175.74"></a><span id="l175.74" class="difflineat">@@ -112,76 +112,76 @@ function test_get_parent_of_folder() {</span>
<a href="#l175.75"></a><span id="l175.75">   assert_folder_child_in_view(trashSubfolder, trashFolder);</span>
<a href="#l175.76"></a><span id="l175.76"> </span>
<a href="#l175.77"></a><span id="l175.77">   // Subfolders of subfolders of the inbox should behave as normal</span>
<a href="#l175.78"></a><span id="l175.78">   inboxSubfolder.createSubfolder(&quot;SmartFoldersC&quot;, null);</span>
<a href="#l175.79"></a><span id="l175.79">   assert_folder_child_in_view(</span>
<a href="#l175.80"></a><span id="l175.80">     inboxSubfolder.getChildNamed(&quot;SmartFoldersC&quot;),</span>
<a href="#l175.81"></a><span id="l175.81">     inboxSubfolder</span>
<a href="#l175.82"></a><span id="l175.82">   );</span>
<a href="#l175.83"></a><span id="l175.83" class="difflineminus">-}</span>
<a href="#l175.84"></a><span id="l175.84" class="difflineplus">+});</span>
<a href="#l175.85"></a><span id="l175.85"> </span>
<a href="#l175.86"></a><span id="l175.86"> /**</span>
<a href="#l175.87"></a><span id="l175.87">  * Test the getFolderForMsgHdr function.</span>
<a href="#l175.88"></a><span id="l175.88">  */</span>
<a href="#l175.89"></a><span id="l175.89" class="difflineminus">-function test_get_folder_for_msg_hdr() {</span>
<a href="#l175.90"></a><span id="l175.90" class="difflineplus">+add_task(function test_get_folder_for_msg_hdr() {</span>
<a href="#l175.91"></a><span id="l175.91">   be_in_folder(inboxFolder);</span>
<a href="#l175.92"></a><span id="l175.92">   let inboxMsgHdr = mc.dbView.getMsgHdrAt(0);</span>
<a href="#l175.93"></a><span id="l175.93">   assert_folder_for_msg_hdr(inboxMsgHdr, smartInboxFolder);</span>
<a href="#l175.94"></a><span id="l175.94"> </span>
<a href="#l175.95"></a><span id="l175.95">   be_in_folder(inboxSubfolder);</span>
<a href="#l175.96"></a><span id="l175.96">   let inboxSubMsgHdr = mc.dbView.getMsgHdrAt(0);</span>
<a href="#l175.97"></a><span id="l175.97">   assert_folder_for_msg_hdr(inboxSubMsgHdr, inboxSubfolder);</span>
<a href="#l175.98"></a><span id="l175.98" class="difflineminus">-}</span>
<a href="#l175.99"></a><span id="l175.99" class="difflineplus">+});</span>
<a href="#l175.100"></a><span id="l175.100"> </span>
<a href="#l175.101"></a><span id="l175.101"> /**</span>
<a href="#l175.102"></a><span id="l175.102">  * Test that selectFolder expands a collapsed smart inbox.</span>
<a href="#l175.103"></a><span id="l175.103">  */</span>
<a href="#l175.104"></a><span id="l175.104" class="difflineminus">-function test_select_folder_expands_collapsed_smart_inbox() {</span>
<a href="#l175.105"></a><span id="l175.105" class="difflineplus">+add_task(function test_select_folder_expands_collapsed_smart_inbox() {</span>
<a href="#l175.106"></a><span id="l175.106">   // Collapse the smart inbox</span>
<a href="#l175.107"></a><span id="l175.107">   collapse_folder(smartInboxFolder);</span>
<a href="#l175.108"></a><span id="l175.108">   assert_folder_collapsed(smartInboxFolder);</span>
<a href="#l175.109"></a><span id="l175.109"> </span>
<a href="#l175.110"></a><span id="l175.110">   // Also collapse the account root, make sure selectFolder don't expand it</span>
<a href="#l175.111"></a><span id="l175.111">   collapse_folder(rootFolder);</span>
<a href="#l175.112"></a><span id="l175.112">   assert_folder_collapsed(rootFolder);</span>
<a href="#l175.113"></a><span id="l175.113"> </span>
<a href="#l175.114"></a><span id="l175.114">   // Now attempt to select the folder.</span>
<a href="#l175.115"></a><span id="l175.115">   mc.folderTreeView.selectFolder(inboxFolder);</span>
<a href="#l175.116"></a><span id="l175.116"> </span>
<a href="#l175.117"></a><span id="l175.117">   assert_folder_collapsed(rootFolder);</span>
<a href="#l175.118"></a><span id="l175.118">   assert_folder_expanded(smartInboxFolder);</span>
<a href="#l175.119"></a><span id="l175.119">   assert_folder_selected_and_displayed(inboxFolder);</span>
<a href="#l175.120"></a><span id="l175.120" class="difflineminus">-}</span>
<a href="#l175.121"></a><span id="l175.121" class="difflineplus">+});</span>
<a href="#l175.122"></a><span id="l175.122"> </span>
<a href="#l175.123"></a><span id="l175.123"> /**</span>
<a href="#l175.124"></a><span id="l175.124">  * Test that selectFolder expands a collapsed account root.</span>
<a href="#l175.125"></a><span id="l175.125">  */</span>
<a href="#l175.126"></a><span id="l175.126" class="difflineminus">-function test_select_folder_expands_collapsed_account_root() {</span>
<a href="#l175.127"></a><span id="l175.127" class="difflineplus">+add_task(function test_select_folder_expands_collapsed_account_root() {</span>
<a href="#l175.128"></a><span id="l175.128">   // Collapse the account root</span>
<a href="#l175.129"></a><span id="l175.129">   collapse_folder(rootFolder);</span>
<a href="#l175.130"></a><span id="l175.130">   assert_folder_collapsed(rootFolder);</span>
<a href="#l175.131"></a><span id="l175.131"> </span>
<a href="#l175.132"></a><span id="l175.132">   // Also collapse the smart inbox, make sure selectFolder don't expand it</span>
<a href="#l175.133"></a><span id="l175.133">   collapse_folder(smartInboxFolder);</span>
<a href="#l175.134"></a><span id="l175.134">   assert_folder_collapsed(smartInboxFolder);</span>
<a href="#l175.135"></a><span id="l175.135"> </span>
<a href="#l175.136"></a><span id="l175.136">   // Now attempt to select the folder.</span>
<a href="#l175.137"></a><span id="l175.137">   mc.folderTreeView.selectFolder(inboxSubfolder);</span>
<a href="#l175.138"></a><span id="l175.138"> </span>
<a href="#l175.139"></a><span id="l175.139">   assert_folder_collapsed(smartInboxFolder);</span>
<a href="#l175.140"></a><span id="l175.140">   assert_folder_expanded(rootFolder);</span>
<a href="#l175.141"></a><span id="l175.141">   assert_folder_selected_and_displayed(inboxSubfolder);</span>
<a href="#l175.142"></a><span id="l175.142" class="difflineminus">-}</span>
<a href="#l175.143"></a><span id="l175.143" class="difflineplus">+});</span>
<a href="#l175.144"></a><span id="l175.144"> </span>
<a href="#l175.145"></a><span id="l175.145"> /**</span>
<a href="#l175.146"></a><span id="l175.146">  * Test that smart folders are updated when the folders they should be</span>
<a href="#l175.147"></a><span id="l175.147">  * searching over are added/removed or have the relevant flag set/cleared.</span>
<a href="#l175.148"></a><span id="l175.148">  */</span>
<a href="#l175.149"></a><span id="l175.149" class="difflineminus">-function test_folder_flag_changes() {</span>
<a href="#l175.150"></a><span id="l175.150" class="difflineplus">+add_task(function test_folder_flag_changes() {</span>
<a href="#l175.151"></a><span id="l175.151">   expand_folder(smartInboxFolder);</span>
<a href="#l175.152"></a><span id="l175.152">   // Now attempt to select the folder.</span>
<a href="#l175.153"></a><span id="l175.153">   mc.folderTreeView.selectFolder(inboxSubfolder);</span>
<a href="#l175.154"></a><span id="l175.154">   // Need to archive two messages in two different accounts in order to</span>
<a href="#l175.155"></a><span id="l175.155">   // create a smart Archives folder.</span>
<a href="#l175.156"></a><span id="l175.156">   select_click_row(0);</span>
<a href="#l175.157"></a><span id="l175.157">   archive_selected_messages();</span>
<a href="#l175.158"></a><span id="l175.158">   let pop3Server = MailServices.accounts.FindServer(</span>
<a href="#l175.159"></a><span id="l175.159" class="difflineat">@@ -235,17 +235,17 @@ function test_folder_flag_changes() {</span>
<a href="#l175.160"></a><span id="l175.160">   for (let folder of fixIterator(allDescendants, Ci.nsIMsgFolder)) {</span>
<a href="#l175.161"></a><span id="l175.161">     desiredScope += folder.URI + &quot;|&quot;;</span>
<a href="#l175.162"></a><span id="l175.162">   }</span>
<a href="#l175.163"></a><span id="l175.163"> </span>
<a href="#l175.164"></a><span id="l175.164">   if (archiveScope != desiredScope) {</span>
<a href="#l175.165"></a><span id="l175.165">     throw new Error(&quot;archive scope wrong after removing folder&quot;);</span>
<a href="#l175.166"></a><span id="l175.166">   }</span>
<a href="#l175.167"></a><span id="l175.167">   assert_folder_and_children_not_in_scope(archiveFolder, archiveScope);</span>
<a href="#l175.168"></a><span id="l175.168" class="difflineminus">-}</span>
<a href="#l175.169"></a><span id="l175.169" class="difflineplus">+});</span>
<a href="#l175.170"></a><span id="l175.170"> </span>
<a href="#l175.171"></a><span id="l175.171"> function assert_folder_and_children_in_scope(folder, searchScope) {</span>
<a href="#l175.172"></a><span id="l175.172">   let folderURI = &quot;|&quot; + folder.URI + &quot;|&quot;;</span>
<a href="#l175.173"></a><span id="l175.173">   assert_uri_found(folderURI, searchScope);</span>
<a href="#l175.174"></a><span id="l175.174">   let allDescendants = folder.descendants;</span>
<a href="#l175.175"></a><span id="l175.175">   for (let folder of fixIterator(allDescendants, Ci.nsIMsgFolder)) {</span>
<a href="#l175.176"></a><span id="l175.176">     assert_uri_found(folder.URI, searchScope);</span>
<a href="#l175.177"></a><span id="l175.177">   }</span>
<a href="#l175.178"></a><span id="l175.178" class="difflineat">@@ -272,17 +272,24 @@ function assert_uri_not_found(folderURI,</span>
<a href="#l175.179"></a><span id="l175.179">       &quot;scope &quot; + scopeList + &quot;contains &quot; + folderURI + &quot; but shouldn't&quot;</span>
<a href="#l175.180"></a><span id="l175.180">     );</span>
<a href="#l175.181"></a><span id="l175.181">   }</span>
<a href="#l175.182"></a><span id="l175.182"> }</span>
<a href="#l175.183"></a><span id="l175.183"> </span>
<a href="#l175.184"></a><span id="l175.184"> /**</span>
<a href="#l175.185"></a><span id="l175.185">  * Move back to the all folders mode.</span>
<a href="#l175.186"></a><span id="l175.186">  */</span>
<a href="#l175.187"></a><span id="l175.187" class="difflineminus">-function test_switch_to_all_folders() {</span>
<a href="#l175.188"></a><span id="l175.188" class="difflineplus">+add_task(function test_switch_to_all_folders() {</span>
<a href="#l175.189"></a><span id="l175.189">   mc.folderTreeView.mode = &quot;all&quot;;</span>
<a href="#l175.190"></a><span id="l175.190" class="difflineminus">-}</span>
<a href="#l175.191"></a><span id="l175.191" class="difflineplus">+});</span>
<a href="#l175.192"></a><span id="l175.192"> </span>
<a href="#l175.193"></a><span id="l175.193" class="difflineminus">-function teardownModule() {</span>
<a href="#l175.194"></a><span id="l175.194" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l175.195"></a><span id="l175.195">   inboxFolder.propagateDelete(inboxSubfolder, true, null);</span>
<a href="#l175.196"></a><span id="l175.196">   delete_message_set(inboxSet);</span>
<a href="#l175.197"></a><span id="l175.197">   trashFolder.propagateDelete(trashSubfolder, true, null);</span>
<a href="#l175.198"></a><span id="l175.198" class="difflineminus">-}</span>
<a href="#l175.199"></a><span id="l175.199" class="difflineplus">+</span>
<a href="#l175.200"></a><span id="l175.200" class="difflineplus">+  Assert.report(</span>
<a href="#l175.201"></a><span id="l175.201" class="difflineplus">+    false,</span>
<a href="#l175.202"></a><span id="l175.202" class="difflineplus">+    undefined,</span>
<a href="#l175.203"></a><span id="l175.203" class="difflineplus">+    undefined,</span>
<a href="#l175.204"></a><span id="l175.204" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l175.205"></a><span id="l175.205" class="difflineplus">+  );</span>
<a href="#l175.206"></a><span id="l175.206" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l176.1"></a><span id="l176.1">copy from mail/test/mozmill/folder-tree-modes/test-unread-folders.js</span>
<a href="#l176.2"></a><span id="l176.2">copy to mail/test/browser/folder-tree-modes/browser_unreadFolders.js</span>
<a href="#l176.3"></a><span id="l176.3" class="difflineminus">--- a/mail/test/mozmill/folder-tree-modes/test-unread-folders.js</span>
<a href="#l176.4"></a><span id="l176.4" class="difflineplus">+++ b/mail/test/browser/folder-tree-modes/browser_unreadFolders.js</span>
<a href="#l176.5"></a><span id="l176.5" class="difflineat">@@ -22,72 +22,79 @@ var {</span>
<a href="#l176.6"></a><span id="l176.6"> );</span>
<a href="#l176.7"></a><span id="l176.7"> </span>
<a href="#l176.8"></a><span id="l176.8"> var rootFolder;</span>
<a href="#l176.9"></a><span id="l176.9"> var inboxSubfolder;</span>
<a href="#l176.10"></a><span id="l176.10"> var trashFolder;</span>
<a href="#l176.11"></a><span id="l176.11"> var trashSubfolder;</span>
<a href="#l176.12"></a><span id="l176.12"> var inboxSet;</span>
<a href="#l176.13"></a><span id="l176.13"> </span>
<a href="#l176.14"></a><span id="l176.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l176.15"></a><span id="l176.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l176.16"></a><span id="l176.16">   rootFolder = inboxFolder.server.rootFolder;</span>
<a href="#l176.17"></a><span id="l176.17"> </span>
<a href="#l176.18"></a><span id="l176.18">   // Create a folder as a subfolder of the inbox</span>
<a href="#l176.19"></a><span id="l176.19">   inboxFolder.createSubfolder(&quot;UnreadFoldersA&quot;, null);</span>
<a href="#l176.20"></a><span id="l176.20">   inboxSubfolder = inboxFolder.getChildNamed(&quot;UnreadFoldersA&quot;);</span>
<a href="#l176.21"></a><span id="l176.21"> </span>
<a href="#l176.22"></a><span id="l176.22">   trashFolder = inboxFolder.server.rootFolder.getFolderWithFlags(</span>
<a href="#l176.23"></a><span id="l176.23">     Ci.nsMsgFolderFlags.Trash</span>
<a href="#l176.24"></a><span id="l176.24">   );</span>
<a href="#l176.25"></a><span id="l176.25">   trashFolder.createSubfolder(&quot;UnreadFoldersB&quot;, null);</span>
<a href="#l176.26"></a><span id="l176.26">   trashSubfolder = trashFolder.getChildNamed(&quot;UnreadFoldersB&quot;);</span>
<a href="#l176.27"></a><span id="l176.27"> </span>
<a href="#l176.28"></a><span id="l176.28">   // The message itself doesn't really matter, as long as there's at least one</span>
<a href="#l176.29"></a><span id="l176.29">   // in the folder.</span>
<a href="#l176.30"></a><span id="l176.30">   [inboxSet] = make_new_sets_in_folder(inboxFolder, [{ count: 1 }]);</span>
<a href="#l176.31"></a><span id="l176.31">   make_new_sets_in_folder(inboxSubfolder, [{ count: 1 }]);</span>
<a href="#l176.32"></a><span id="l176.32" class="difflineminus">-}</span>
<a href="#l176.33"></a><span id="l176.33" class="difflineplus">+});</span>
<a href="#l176.34"></a><span id="l176.34"> </span>
<a href="#l176.35"></a><span id="l176.35"> /**</span>
<a href="#l176.36"></a><span id="l176.36">  * Switch to the all folders mode.</span>
<a href="#l176.37"></a><span id="l176.37">  */</span>
<a href="#l176.38"></a><span id="l176.38" class="difflineminus">-function test_switch_to_all_folders() {</span>
<a href="#l176.39"></a><span id="l176.39" class="difflineplus">+add_task(function test_switch_to_all_folders() {</span>
<a href="#l176.40"></a><span id="l176.40">   mc.folderTreeView.mode = &quot;all&quot;;</span>
<a href="#l176.41"></a><span id="l176.41">   be_in_folder(inboxFolder);</span>
<a href="#l176.42"></a><span id="l176.42" class="difflineminus">-}</span>
<a href="#l176.43"></a><span id="l176.43" class="difflineplus">+});</span>
<a href="#l176.44"></a><span id="l176.44"> </span>
<a href="#l176.45"></a><span id="l176.45"> /**</span>
<a href="#l176.46"></a><span id="l176.46">  * Switch to the unread folder mode.</span>
<a href="#l176.47"></a><span id="l176.47">  */</span>
<a href="#l176.48"></a><span id="l176.48" class="difflineminus">-function test_switch_to_unread_folders() {</span>
<a href="#l176.49"></a><span id="l176.49" class="difflineplus">+add_task(function test_switch_to_unread_folders() {</span>
<a href="#l176.50"></a><span id="l176.50">   mc.folderTreeView.mode = &quot;unread&quot;;</span>
<a href="#l176.51"></a><span id="l176.51" class="difflineminus">-}</span>
<a href="#l176.52"></a><span id="l176.52" class="difflineplus">+});</span>
<a href="#l176.53"></a><span id="l176.53"> </span>
<a href="#l176.54"></a><span id="l176.54"> /**</span>
<a href="#l176.55"></a><span id="l176.55">  * Test that inbox and inboxSubfolder are in view</span>
<a href="#l176.56"></a><span id="l176.56">  */</span>
<a href="#l176.57"></a><span id="l176.57" class="difflineminus">-function test_folder_population() {</span>
<a href="#l176.58"></a><span id="l176.58" class="difflineplus">+add_task(function test_folder_population() {</span>
<a href="#l176.59"></a><span id="l176.59">   assert_folder_visible(inboxFolder);</span>
<a href="#l176.60"></a><span id="l176.60">   assert_folder_visible(inboxSubfolder);</span>
<a href="#l176.61"></a><span id="l176.61" class="difflineminus">-}</span>
<a href="#l176.62"></a><span id="l176.62" class="difflineplus">+});</span>
<a href="#l176.63"></a><span id="l176.63"> </span>
<a href="#l176.64"></a><span id="l176.64"> /**</span>
<a href="#l176.65"></a><span id="l176.65">  * Test that a folder newly getting unread messages doesn't</span>
<a href="#l176.66"></a><span id="l176.66">  * change the selected folder in unread folders mode.</span>
<a href="#l176.67"></a><span id="l176.67">  */</span>
<a href="#l176.68"></a><span id="l176.68" class="difflineminus">-function test_newly_added_folder() {</span>
<a href="#l176.69"></a><span id="l176.69" class="difflineplus">+add_task(function test_newly_added_folder() {</span>
<a href="#l176.70"></a><span id="l176.70">   let [newSet] = make_new_sets_in_folder(trashFolder, [{ count: 1 }]);</span>
<a href="#l176.71"></a><span id="l176.71">   assert_folder_visible(trashFolder);</span>
<a href="#l176.72"></a><span id="l176.72">   if (mc.folderTreeView.getSelectedFolders()[0] != inboxFolder) {</span>
<a href="#l176.73"></a><span id="l176.73">     throw new Error(</span>
<a href="#l176.74"></a><span id="l176.74">       &quot;Inbox folder should be selected after new unread folder&quot; +</span>
<a href="#l176.75"></a><span id="l176.75">         &quot; added to unread view&quot;</span>
<a href="#l176.76"></a><span id="l176.76">     );</span>
<a href="#l176.77"></a><span id="l176.77">   }</span>
<a href="#l176.78"></a><span id="l176.78">   delete_message_set(newSet);</span>
<a href="#l176.79"></a><span id="l176.79" class="difflineminus">-}</span>
<a href="#l176.80"></a><span id="l176.80" class="difflineplus">+});</span>
<a href="#l176.81"></a><span id="l176.81"> </span>
<a href="#l176.82"></a><span id="l176.82" class="difflineminus">-function teardownModule() {</span>
<a href="#l176.83"></a><span id="l176.83" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l176.84"></a><span id="l176.84">   inboxFolder.propagateDelete(inboxSubfolder, true, null);</span>
<a href="#l176.85"></a><span id="l176.85">   delete_message_set(inboxSet);</span>
<a href="#l176.86"></a><span id="l176.86">   trashFolder.propagateDelete(trashSubfolder, true, null);</span>
<a href="#l176.87"></a><span id="l176.87">   mc.folderTreeView.mode = &quot;all&quot;;</span>
<a href="#l176.88"></a><span id="l176.88" class="difflineminus">-}</span>
<a href="#l176.89"></a><span id="l176.89" class="difflineplus">+</span>
<a href="#l176.90"></a><span id="l176.90" class="difflineplus">+  Assert.report(</span>
<a href="#l176.91"></a><span id="l176.91" class="difflineplus">+    false,</span>
<a href="#l176.92"></a><span id="l176.92" class="difflineplus">+    undefined,</span>
<a href="#l176.93"></a><span id="l176.93" class="difflineplus">+    undefined,</span>
<a href="#l176.94"></a><span id="l176.94" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l176.95"></a><span id="l176.95" class="difflineplus">+  );</span>
<a href="#l176.96"></a><span id="l176.96" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l177.1"></a><span id="l177.1">copy from mail/test/mozmill/folder-tree-modes/test-extension/bootstrap.js</span>
<a href="#l177.2"></a><span id="l177.2">copy to mail/test/browser/folder-tree-modes/test-extension/bootstrap.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l178.1"></a><span id="l178.1">copy from mail/test/mozmill/folder-tree-modes/test-extension/chrome.manifest</span>
<a href="#l178.2"></a><span id="l178.2">copy to mail/test/browser/folder-tree-modes/test-extension/chrome.manifest</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l179.1"></a><span id="l179.1">copy from mail/test/mozmill/folder-tree-modes/test-extension/manifest.json</span>
<a href="#l179.2"></a><span id="l179.2">copy to mail/test/browser/folder-tree-modes/test-extension/manifest.json</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l180.1"></a><span id="l180.1">new file mode 100644</span>
<a href="#l180.2"></a><span id="l180.2" class="difflineminus">--- /dev/null</span>
<a href="#l180.3"></a><span id="l180.3" class="difflineplus">+++ b/mail/test/browser/folder-widget/browser.ini</span>
<a href="#l180.4"></a><span id="l180.4" class="difflineat">@@ -0,0 +1,45 @@</span>
<a href="#l180.5"></a><span id="l180.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l180.6"></a><span id="l180.6" class="difflineplus">+prefs =</span>
<a href="#l180.7"></a><span id="l180.7" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l180.8"></a><span id="l180.8" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l180.9"></a><span id="l180.9" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l180.10"></a><span id="l180.10" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l180.11"></a><span id="l180.11" class="difflineplus">+  mail.shell.checkDefaultClient=false</span>
<a href="#l180.12"></a><span id="l180.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l180.13"></a><span id="l180.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l180.14"></a><span id="l180.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l180.15"></a><span id="l180.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l180.16"></a><span id="l180.16" class="difflineplus">+  mail.account.account1.server=server1</span>
<a href="#l180.17"></a><span id="l180.17" class="difflineplus">+  mail.account.account2.identities=id1,id2</span>
<a href="#l180.18"></a><span id="l180.18" class="difflineplus">+  mail.account.account2.server=server2</span>
<a href="#l180.19"></a><span id="l180.19" class="difflineplus">+  mail.accountmanager.accounts=account1,account2</span>
<a href="#l180.20"></a><span id="l180.20" class="difflineplus">+  mail.accountmanager.defaultaccount=account2</span>
<a href="#l180.21"></a><span id="l180.21" class="difflineplus">+  mail.accountmanager.localfoldersserver=server1</span>
<a href="#l180.22"></a><span id="l180.22" class="difflineplus">+  mail.identity.id1.fullName=Tinderbox</span>
<a href="#l180.23"></a><span id="l180.23" class="difflineplus">+  mail.identity.id1.htmlSigFormat=false</span>
<a href="#l180.24"></a><span id="l180.24" class="difflineplus">+  mail.identity.id1.smtpServer=smtp1</span>
<a href="#l180.25"></a><span id="l180.25" class="difflineplus">+  mail.identity.id1.useremail=tinderbox@foo.invalid</span>
<a href="#l180.26"></a><span id="l180.26" class="difflineplus">+  mail.identity.id1.valid=true</span>
<a href="#l180.27"></a><span id="l180.27" class="difflineplus">+  mail.identity.id2.fullName=Tinderboxpushlog</span>
<a href="#l180.28"></a><span id="l180.28" class="difflineplus">+  mail.identity.id2.htmlSigFormat=true</span>
<a href="#l180.29"></a><span id="l180.29" class="difflineplus">+  mail.identity.id2.smtpServer=smtp1</span>
<a href="#l180.30"></a><span id="l180.30" class="difflineplus">+  mail.identity.id2.useremail=tinderboxpushlog@foo.invalid</span>
<a href="#l180.31"></a><span id="l180.31" class="difflineplus">+  mail.identity.id2.valid=true</span>
<a href="#l180.32"></a><span id="l180.32" class="difflineplus">+  mail.server.server1.type=none</span>
<a href="#l180.33"></a><span id="l180.33" class="difflineplus">+  mail.server.server1.userName=nobody</span>
<a href="#l180.34"></a><span id="l180.34" class="difflineplus">+  mail.server.server2.check_new_mail=false</span>
<a href="#l180.35"></a><span id="l180.35" class="difflineplus">+  mail.server.server2.directory-rel=[ProfD]Mail/tinderbox</span>
<a href="#l180.36"></a><span id="l180.36" class="difflineplus">+  mail.server.server2.download_on_biff=true</span>
<a href="#l180.37"></a><span id="l180.37" class="difflineplus">+  mail.server.server2.hostname=tinderbox123</span>
<a href="#l180.38"></a><span id="l180.38" class="difflineplus">+  mail.server.server2.login_at_startup=false</span>
<a href="#l180.39"></a><span id="l180.39" class="difflineplus">+  mail.server.server2.name=tinderbox@foo.invalid</span>
<a href="#l180.40"></a><span id="l180.40" class="difflineplus">+  mail.server.server2.type=pop3</span>
<a href="#l180.41"></a><span id="l180.41" class="difflineplus">+  mail.server.server2.userName=tinderbox</span>
<a href="#l180.42"></a><span id="l180.42" class="difflineplus">+  mail.server.server2.whiteListAbURI=</span>
<a href="#l180.43"></a><span id="l180.43" class="difflineplus">+  mail.smtp.defaultserver=smtp1</span>
<a href="#l180.44"></a><span id="l180.44" class="difflineplus">+  mail.smtpserver.smtp1.hostname=tinderbox123</span>
<a href="#l180.45"></a><span id="l180.45" class="difflineplus">+  mail.smtpserver.smtp1.username=tinderbox</span>
<a href="#l180.46"></a><span id="l180.46" class="difflineplus">+  mail.smtpservers=smtp1</span>
<a href="#l180.47"></a><span id="l180.47" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l180.48"></a><span id="l180.48" class="difflineplus">+</span>
<a href="#l180.49"></a><span id="l180.49" class="difflineplus">+[browser_messageFilters.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l181.1"></a><span id="l181.1">copy from mail/test/mozmill/folder-widget/test-message-filters.js</span>
<a href="#l181.2"></a><span id="l181.2">copy to mail/test/browser/folder-widget/browser_messageFilters.js</span>
<a href="#l181.3"></a><span id="l181.3" class="difflineminus">--- a/mail/test/mozmill/folder-widget/test-message-filters.js</span>
<a href="#l181.4"></a><span id="l181.4" class="difflineplus">+++ b/mail/test/browser/folder-widget/browser_messageFilters.js</span>
<a href="#l181.5"></a><span id="l181.5" class="difflineat">@@ -4,27 +4,23 @@</span>
<a href="#l181.6"></a><span id="l181.6"> </span>
<a href="#l181.7"></a><span id="l181.7"> /*</span>
<a href="#l181.8"></a><span id="l181.8">  * Test various properties of the message filters.</span>
<a href="#l181.9"></a><span id="l181.9">  */</span>
<a href="#l181.10"></a><span id="l181.10"> </span>
<a href="#l181.11"></a><span id="l181.11"> &quot;use strict&quot;;</span>
<a href="#l181.12"></a><span id="l181.12"> </span>
<a href="#l181.13"></a><span id="l181.13"> var elib = ChromeUtils.import(</span>
<a href="#l181.14"></a><span id="l181.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l181.15"></a><span id="l181.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l181.16"></a><span id="l181.16"> );</span>
<a href="#l181.17"></a><span id="l181.17"> </span>
<a href="#l181.18"></a><span id="l181.18"> var { create_ldap_address_book } = ChromeUtils.import(</span>
<a href="#l181.19"></a><span id="l181.19">   &quot;resource://testing-common/mozmill/AddressBookHelpers.jsm&quot;</span>
<a href="#l181.20"></a><span id="l181.20"> );</span>
<a href="#l181.21"></a><span id="l181.21"> var {</span>
<a href="#l181.22"></a><span id="l181.22" class="difflineminus">-  assert_equals,</span>
<a href="#l181.23"></a><span id="l181.23" class="difflineminus">-  assert_false,</span>
<a href="#l181.24"></a><span id="l181.24" class="difflineminus">-  assert_not_equals,</span>
<a href="#l181.25"></a><span id="l181.25" class="difflineminus">-  assert_true,</span>
<a href="#l181.26"></a><span id="l181.26">   be_in_folder,</span>
<a href="#l181.27"></a><span id="l181.27">   close_popup,</span>
<a href="#l181.28"></a><span id="l181.28">   create_folder,</span>
<a href="#l181.29"></a><span id="l181.29">   make_new_sets_in_folder,</span>
<a href="#l181.30"></a><span id="l181.30">   mc,</span>
<a href="#l181.31"></a><span id="l181.31"> } = ChromeUtils.import(</span>
<a href="#l181.32"></a><span id="l181.32">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l181.33"></a><span id="l181.33"> );</span>
<a href="#l181.34"></a><span id="l181.34" class="difflineat">@@ -46,30 +42,30 @@ var {</span>
<a href="#l181.35"></a><span id="l181.35"> var { gMockPromptService } = ChromeUtils.import(</span>
<a href="#l181.36"></a><span id="l181.36">   &quot;resource://testing-common/mozmill/PromptHelpers.jsm&quot;</span>
<a href="#l181.37"></a><span id="l181.37"> );</span>
<a href="#l181.38"></a><span id="l181.38"> </span>
<a href="#l181.39"></a><span id="l181.39"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l181.40"></a><span id="l181.40"> </span>
<a href="#l181.41"></a><span id="l181.41"> var folderA;</span>
<a href="#l181.42"></a><span id="l181.42"> </span>
<a href="#l181.43"></a><span id="l181.43" class="difflineminus">-function setupModule(module) {</span>
<a href="#l181.44"></a><span id="l181.44" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l181.45"></a><span id="l181.45">   setupNNTPDaemon();</span>
<a href="#l181.46"></a><span id="l181.46"> </span>
<a href="#l181.47"></a><span id="l181.47">   folderA = create_folder(&quot;FolderToolbarA&quot;);</span>
<a href="#l181.48"></a><span id="l181.48">   // we need one message to select and open</span>
<a href="#l181.49"></a><span id="l181.49">   make_new_sets_in_folder(folderA, [{ count: 1 }]);</span>
<a href="#l181.50"></a><span id="l181.50"> </span>
<a href="#l181.51"></a><span id="l181.51">   setupLocalServer(NNTP_PORT);</span>
<a href="#l181.52"></a><span id="l181.52" class="difflineminus">-}</span>
<a href="#l181.53"></a><span id="l181.53" class="difflineplus">+});</span>
<a href="#l181.54"></a><span id="l181.54"> </span>
<a href="#l181.55"></a><span id="l181.55"> /*</span>
<a href="#l181.56"></a><span id="l181.56">  * Test that the message filter list shows newsgroup servers.</span>
<a href="#l181.57"></a><span id="l181.57">  */</span>
<a href="#l181.58"></a><span id="l181.58" class="difflineminus">-function test_message_filter_shows_newsgroup_server() {</span>
<a href="#l181.59"></a><span id="l181.59" class="difflineplus">+add_task(function test_message_filter_shows_newsgroup_server() {</span>
<a href="#l181.60"></a><span id="l181.60">   be_in_folder(folderA);</span>
<a href="#l181.61"></a><span id="l181.61"> </span>
<a href="#l181.62"></a><span id="l181.62">   // Open the &quot;Tools  Message Filters&quot; window,</span>
<a href="#l181.63"></a><span id="l181.63">   // a.k.a. &quot;tasksMenu  filtersCmd&quot;.</span>
<a href="#l181.64"></a><span id="l181.64">   plan_for_new_window(&quot;mailnews:filterlist&quot;);</span>
<a href="#l181.65"></a><span id="l181.65">   mc.menus.Tools.filtersCmd.click();</span>
<a href="#l181.66"></a><span id="l181.66">   let filterc = wait_for_new_window(&quot;mailnews:filterlist&quot;);</span>
<a href="#l181.67"></a><span id="l181.67">   wait_for_window_focused(filterc.window);</span>
<a href="#l181.68"></a><span id="l181.68" class="difflineat">@@ -89,43 +85,43 @@ function test_message_filter_shows_newsg</span>
<a href="#l181.69"></a><span id="l181.69">   // filterc.select(popup, 2);</span>
<a href="#l181.70"></a><span id="l181.70">   // let nntpPopup = new elib.Elem(nntp.node.menupopup);</span>
<a href="#l181.71"></a><span id="l181.71">   // filterc.click(nntpPopup);</span>
<a href="#l181.72"></a><span id="l181.72">   // filterc.mouseover(nntpPopup);</span>
<a href="#l181.73"></a><span id="l181.73">   // filterc.select(nntpPopup, 2);</span>
<a href="#l181.74"></a><span id="l181.74"> </span>
<a href="#l181.75"></a><span id="l181.75">   // This one initializes the menuitems, but it's kinda hacky.</span>
<a href="#l181.76"></a><span id="l181.76">   nntp.node.menupopup._ensureInitialized();</span>
<a href="#l181.77"></a><span id="l181.77" class="difflineminus">-  assert_equals(</span>
<a href="#l181.78"></a><span id="l181.78" class="difflineplus">+  Assert.equal(</span>
<a href="#l181.79"></a><span id="l181.79">     nntp.node.itemCount,</span>
<a href="#l181.80"></a><span id="l181.80">     5,</span>
<a href="#l181.81"></a><span id="l181.81">     &quot;Incorrect number of children for the NNTP server&quot;</span>
<a href="#l181.82"></a><span id="l181.82">   );</span>
<a href="#l181.83"></a><span id="l181.83">   close_window(filterc);</span>
<a href="#l181.84"></a><span id="l181.84" class="difflineminus">-}</span>
<a href="#l181.85"></a><span id="l181.85" class="difflineplus">+});</span>
<a href="#l181.86"></a><span id="l181.86"> </span>
<a href="#l181.87"></a><span id="l181.87"> /*</span>
<a href="#l181.88"></a><span id="l181.88">  * Test that customizing the toolbar doesn't lead to doubled accounts in</span>
<a href="#l181.89"></a><span id="l181.89">  * the Get Mail menu.  (bug 520457)</span>
<a href="#l181.90"></a><span id="l181.90">  */</span>
<a href="#l181.91"></a><span id="l181.91" class="difflineminus">-function test_customize_toolbar_doesnt_double_get_mail_menu() {</span>
<a href="#l181.92"></a><span id="l181.92" class="difflineplus">+add_task(function test_customize_toolbar_doesnt_double_get_mail_menu() {</span>
<a href="#l181.93"></a><span id="l181.93">   be_in_folder(folderA);</span>
<a href="#l181.94"></a><span id="l181.94"> </span>
<a href="#l181.95"></a><span id="l181.95">   /**</span>
<a href="#l181.96"></a><span id="l181.96">    * Get the getAllNewMessages menu and check the number of items.</span>
<a href="#l181.97"></a><span id="l181.97">    */</span>
<a href="#l181.98"></a><span id="l181.98">   function check_getAllNewMsgMenu() {</span>
<a href="#l181.99"></a><span id="l181.99">     wait_for_window_focused(mc.window);</span>
<a href="#l181.100"></a><span id="l181.100"> </span>
<a href="#l181.101"></a><span id="l181.101">     const subview = mc.click_through_appmenu([</span>
<a href="#l181.102"></a><span id="l181.102">       { id: &quot;appmenu_File&quot; },</span>
<a href="#l181.103"></a><span id="l181.103">       { id: &quot;appmenu_getNewMsgFor&quot; },</span>
<a href="#l181.104"></a><span id="l181.104">     ]);</span>
<a href="#l181.105"></a><span id="l181.105"> </span>
<a href="#l181.106"></a><span id="l181.106" class="difflineminus">-    assert_equals(</span>
<a href="#l181.107"></a><span id="l181.107" class="difflineplus">+    Assert.equal(</span>
<a href="#l181.108"></a><span id="l181.108">       subview.children.length,</span>
<a href="#l181.109"></a><span id="l181.109">       5,</span>
<a href="#l181.110"></a><span id="l181.110">       &quot;Incorrect number of items for GetNewMessages before customization&quot;</span>
<a href="#l181.111"></a><span id="l181.111">     );</span>
<a href="#l181.112"></a><span id="l181.112"> </span>
<a href="#l181.113"></a><span id="l181.113">     // Close the appmenu.</span>
<a href="#l181.114"></a><span id="l181.114">     mc.click(mc.eid(&quot;button-appmenu&quot;));</span>
<a href="#l181.115"></a><span id="l181.115">   }</span>
<a href="#l181.116"></a><span id="l181.116" class="difflineat">@@ -140,21 +136,18 @@ function test_customize_toolbar_doesnt_d</span>
<a href="#l181.117"></a><span id="l181.117"> </span>
<a href="#l181.118"></a><span id="l181.118">   let customc = wait_for_new_window(&quot;mailnews:customizeToolbar&quot;);</span>
<a href="#l181.119"></a><span id="l181.119">   wait_for_window_focused(customc.window);</span>
<a href="#l181.120"></a><span id="l181.120">   plan_for_window_close(customc);</span>
<a href="#l181.121"></a><span id="l181.121">   customc.click(customc.eid(&quot;donebutton&quot;));</span>
<a href="#l181.122"></a><span id="l181.122">   wait_for_window_close();</span>
<a href="#l181.123"></a><span id="l181.123"> </span>
<a href="#l181.124"></a><span id="l181.124">   check_getAllNewMsgMenu();</span>
<a href="#l181.125"></a><span id="l181.125" class="difflineminus">-}</span>
<a href="#l181.126"></a><span id="l181.126" class="difflineminus">-test_customize_toolbar_doesnt_double_get_mail_menu.EXCLUDED_PLATFORMS = [</span>
<a href="#l181.127"></a><span id="l181.127" class="difflineminus">-  &quot;winnt&quot;,</span>
<a href="#l181.128"></a><span id="l181.128" class="difflineminus">-  &quot;darwin&quot;,</span>
<a href="#l181.129"></a><span id="l181.129" class="difflineminus">-];</span>
<a href="#l181.130"></a><span id="l181.130" class="difflineplus">+}).__skipMe =</span>
<a href="#l181.131"></a><span id="l181.131" class="difflineplus">+  AppConstants.platform == &quot;macosx&quot; || AppConstants.platform == &quot;win&quot;;</span>
<a href="#l181.132"></a><span id="l181.132"> </span>
<a href="#l181.133"></a><span id="l181.133"> /* A helper function that opens up the new filter dialog (assuming that the</span>
<a href="#l181.134"></a><span id="l181.134">  * main filters dialog is already open), creates a simple filter, and then</span>
<a href="#l181.135"></a><span id="l181.135">  * closes the dialog.</span>
<a href="#l181.136"></a><span id="l181.136">  */</span>
<a href="#l181.137"></a><span id="l181.137"> function create_simple_filter() {</span>
<a href="#l181.138"></a><span id="l181.138">   // Open the &quot;Tools  Message Filters&quot; window,</span>
<a href="#l181.139"></a><span id="l181.139">   // a.k.a. &quot;tasksMenu  filtersCmd&quot;.</span>
<a href="#l181.140"></a><span id="l181.140" class="difflineat">@@ -187,23 +180,23 @@ function create_simple_filter() {</span>
<a href="#l181.141"></a><span id="l181.141">   plan_for_modal_dialog(&quot;mailnews:filtereditor&quot;, fill_in_filter_fields);</span>
<a href="#l181.142"></a><span id="l181.142">   filterc.click(filterc.eid(&quot;newButton&quot;));</span>
<a href="#l181.143"></a><span id="l181.143">   wait_for_modal_dialog(&quot;mailnews:filtereditor&quot;);</span>
<a href="#l181.144"></a><span id="l181.144"> }</span>
<a href="#l181.145"></a><span id="l181.145"> </span>
<a href="#l181.146"></a><span id="l181.146"> /*</span>
<a href="#l181.147"></a><span id="l181.147">  * Test that the address books can appear in the message filter dropdown</span>
<a href="#l181.148"></a><span id="l181.148">  */</span>
<a href="#l181.149"></a><span id="l181.149" class="difflineminus">-function test_address_books_appear_in_message_filter_dropdown() {</span>
<a href="#l181.150"></a><span id="l181.150" class="difflineplus">+add_task(function test_address_books_appear_in_message_filter_dropdown() {</span>
<a href="#l181.151"></a><span id="l181.151">   // Create a remote address book - we don't want this to appear in the</span>
<a href="#l181.152"></a><span id="l181.152">   // dropdown.</span>
<a href="#l181.153"></a><span id="l181.153">   let ldapAb = create_ldap_address_book(&quot;Some LDAP Address Book&quot;);</span>
<a href="#l181.154"></a><span id="l181.154"> </span>
<a href="#l181.155"></a><span id="l181.155">   // Sanity check - this LDAP book should be remote.</span>
<a href="#l181.156"></a><span id="l181.156" class="difflineminus">-  assert_true(ldapAb.isRemote);</span>
<a href="#l181.157"></a><span id="l181.157" class="difflineplus">+  Assert.ok(ldapAb.isRemote);</span>
<a href="#l181.158"></a><span id="l181.158"> </span>
<a href="#l181.159"></a><span id="l181.159">   // Open the &quot;Tools  Message Filters&quot; window,</span>
<a href="#l181.160"></a><span id="l181.160">   // a.k.a. &quot;tasksMenu  filtersCmd&quot;.</span>
<a href="#l181.161"></a><span id="l181.161">   mc.menus.Tools.filtersCmd.click();</span>
<a href="#l181.162"></a><span id="l181.162"> </span>
<a href="#l181.163"></a><span id="l181.163">   // We'll assume that the filters dialog is already open from</span>
<a href="#l181.164"></a><span id="l181.164">   // the previous tests.</span>
<a href="#l181.165"></a><span id="l181.165">   let filterc = wait_for_existing_window(&quot;mailnews:filterlist&quot;);</span>
<a href="#l181.166"></a><span id="l181.166" class="difflineat">@@ -221,37 +214,37 @@ function test_address_books_appear_in_me</span>
<a href="#l181.167"></a><span id="l181.167"> </span>
<a href="#l181.168"></a><span id="l181.168">     // The magic number &quot;4&quot; is because the address book list is the</span>
<a href="#l181.169"></a><span id="l181.169">     // 4th child node of the search-value widget.</span>
<a href="#l181.170"></a><span id="l181.170">     let abList = searchValue.children[4];</span>
<a href="#l181.171"></a><span id="l181.171"> </span>
<a href="#l181.172"></a><span id="l181.172">     // We should have 2 address books here - one for the Personal Address</span>
<a href="#l181.173"></a><span id="l181.173">     // Book, and one for Collected Addresses.  The LDAP address book should</span>
<a href="#l181.174"></a><span id="l181.174">     // not be shown, since it isn't a local address book.</span>
<a href="#l181.175"></a><span id="l181.175" class="difflineminus">-    assert_equals(</span>
<a href="#l181.176"></a><span id="l181.176" class="difflineplus">+    Assert.equal(</span>
<a href="#l181.177"></a><span id="l181.177">       2,</span>
<a href="#l181.178"></a><span id="l181.178">       abList.itemCount,</span>
<a href="#l181.179"></a><span id="l181.179">       &quot;Did not display the correct number &quot; +</span>
<a href="#l181.180"></a><span id="l181.180">         &quot;of address books in the filter menu list.&quot;</span>
<a href="#l181.181"></a><span id="l181.181">     );</span>
<a href="#l181.182"></a><span id="l181.182">   }</span>
<a href="#l181.183"></a><span id="l181.183"> </span>
<a href="#l181.184"></a><span id="l181.184">   // Let's open the filter editor.</span>
<a href="#l181.185"></a><span id="l181.185">   plan_for_modal_dialog(&quot;mailnews:filtereditor&quot;, filterEditorOpened);</span>
<a href="#l181.186"></a><span id="l181.186">   filterc.click(filterc.eid(&quot;newButton&quot;));</span>
<a href="#l181.187"></a><span id="l181.187">   wait_for_modal_dialog(&quot;mailnews:filtereditor&quot;);</span>
<a href="#l181.188"></a><span id="l181.188" class="difflineminus">-}</span>
<a href="#l181.189"></a><span id="l181.189" class="difflineplus">+});</span>
<a href="#l181.190"></a><span id="l181.190"> </span>
<a href="#l181.191"></a><span id="l181.191"> /* Test that if the user has started running a filter, and the</span>
<a href="#l181.192"></a><span id="l181.192">  * &quot;quit-application-requested&quot; notification is fired, the user</span>
<a href="#l181.193"></a><span id="l181.193">  * is given a dialog asking whether or not to quit.</span>
<a href="#l181.194"></a><span id="l181.194">  *</span>
<a href="#l181.195"></a><span id="l181.195">  * This also tests whether or not cancelling quit works.</span>
<a href="#l181.196"></a><span id="l181.196">  */</span>
<a href="#l181.197"></a><span id="l181.197" class="difflineminus">-function test_can_cancel_quit_on_filter_changes() {</span>
<a href="#l181.198"></a><span id="l181.198" class="difflineplus">+add_task(function test_can_cancel_quit_on_filter_changes() {</span>
<a href="#l181.199"></a><span id="l181.199">   // Register the Mock Prompt Service</span>
<a href="#l181.200"></a><span id="l181.200">   gMockPromptService.register();</span>
<a href="#l181.201"></a><span id="l181.201"> </span>
<a href="#l181.202"></a><span id="l181.202">   create_simple_filter();</span>
<a href="#l181.203"></a><span id="l181.203"> </span>
<a href="#l181.204"></a><span id="l181.204">   let filterc = wait_for_existing_window(&quot;mailnews:filterlist&quot;);</span>
<a href="#l181.205"></a><span id="l181.205">   let runButton = filterc.e(&quot;runFiltersButton&quot;);</span>
<a href="#l181.206"></a><span id="l181.206">   runButton.setAttribute(&quot;label&quot;, runButton.getAttribute(&quot;stoplabel&quot;));</span>
<a href="#l181.207"></a><span id="l181.207" class="difflineat">@@ -261,60 +254,62 @@ function test_can_cancel_quit_on_filter_</span>
<a href="#l181.208"></a><span id="l181.208">   );</span>
<a href="#l181.209"></a><span id="l181.209"> </span>
<a href="#l181.210"></a><span id="l181.210">   // Set the Mock Prompt Service to return false, so that we</span>
<a href="#l181.211"></a><span id="l181.211">   // cancel the quit.</span>
<a href="#l181.212"></a><span id="l181.212">   gMockPromptService.returnValue = false;</span>
<a href="#l181.213"></a><span id="l181.213">   // Trigger the quit-application-request notification</span>
<a href="#l181.214"></a><span id="l181.214">   Services.obs.notifyObservers(cancelQuit, &quot;quit-application-requested&quot;);</span>
<a href="#l181.215"></a><span id="l181.215">   let promptState = gMockPromptService.promptState;</span>
<a href="#l181.216"></a><span id="l181.216" class="difflineminus">-  assert_not_equals(null, promptState, &quot;Expected a confirmEx prompt&quot;);</span>
<a href="#l181.217"></a><span id="l181.217" class="difflineplus">+  Assert.notEqual(null, promptState, &quot;Expected a confirmEx prompt&quot;);</span>
<a href="#l181.218"></a><span id="l181.218"> </span>
<a href="#l181.219"></a><span id="l181.219" class="difflineminus">-  assert_equals(&quot;confirmEx&quot;, promptState.method);</span>
<a href="#l181.220"></a><span id="l181.220" class="difflineplus">+  Assert.equal(&quot;confirmEx&quot;, promptState.method);</span>
<a href="#l181.221"></a><span id="l181.221">   // Since we returned false on the confirmation dialog,</span>
<a href="#l181.222"></a><span id="l181.222">   // we should be cancelling the quit - so cancelQuit.data</span>
<a href="#l181.223"></a><span id="l181.223">   // should now be true</span>
<a href="#l181.224"></a><span id="l181.224" class="difflineminus">-  assert_true(cancelQuit.data, &quot;Didn't cancel the quit&quot;);</span>
<a href="#l181.225"></a><span id="l181.225" class="difflineplus">+  Assert.ok(cancelQuit.data, &quot;Didn't cancel the quit&quot;);</span>
<a href="#l181.226"></a><span id="l181.226"> </span>
<a href="#l181.227"></a><span id="l181.227">   // Unregister the Mock Prompt Service</span>
<a href="#l181.228"></a><span id="l181.228">   gMockPromptService.unregister();</span>
<a href="#l181.229"></a><span id="l181.229" class="difflineminus">-}</span>
<a href="#l181.230"></a><span id="l181.230" class="difflineplus">+});</span>
<a href="#l181.231"></a><span id="l181.231"> </span>
<a href="#l181.232"></a><span id="l181.232"> /* Test that if the user has started running a filter, and the</span>
<a href="#l181.233"></a><span id="l181.233">  * &quot;quit-application-requested&quot; notification is fired, the user</span>
<a href="#l181.234"></a><span id="l181.234">  * is given a dialog asking whether or not to quit.</span>
<a href="#l181.235"></a><span id="l181.235">  *</span>
<a href="#l181.236"></a><span id="l181.236">  * This also tests whether or not allowing quit works.</span>
<a href="#l181.237"></a><span id="l181.237">  */</span>
<a href="#l181.238"></a><span id="l181.238" class="difflineminus">-function test_can_quit_on_filter_changes() {</span>
<a href="#l181.239"></a><span id="l181.239" class="difflineplus">+add_task(function test_can_quit_on_filter_changes() {</span>
<a href="#l181.240"></a><span id="l181.240">   // Register the Mock Prompt Service</span>
<a href="#l181.241"></a><span id="l181.241">   gMockPromptService.register();</span>
<a href="#l181.242"></a><span id="l181.242"> </span>
<a href="#l181.243"></a><span id="l181.243">   let filterc = wait_for_existing_window(&quot;mailnews:filterlist&quot;);</span>
<a href="#l181.244"></a><span id="l181.244"> </span>
<a href="#l181.245"></a><span id="l181.245">   // There should already be 1 filter defined from previous test.</span>
<a href="#l181.246"></a><span id="l181.246">   let filterCount = filterc.e(&quot;filterList&quot;).itemCount;</span>
<a href="#l181.247"></a><span id="l181.247" class="difflineminus">-  assert_equals(filterCount, 1);</span>
<a href="#l181.248"></a><span id="l181.248" class="difflineplus">+  Assert.equal(filterCount, 1);</span>
<a href="#l181.249"></a><span id="l181.249"> </span>
<a href="#l181.250"></a><span id="l181.250">   let runButton = filterc.e(&quot;runFiltersButton&quot;);</span>
<a href="#l181.251"></a><span id="l181.251">   runButton.setAttribute(&quot;label&quot;, runButton.getAttribute(&quot;stoplabel&quot;));</span>
<a href="#l181.252"></a><span id="l181.252"> </span>
<a href="#l181.253"></a><span id="l181.253">   let cancelQuit = Cc[&quot;@mozilla.org/supports-PRBool;1&quot;].createInstance(</span>
<a href="#l181.254"></a><span id="l181.254">     Ci.nsISupportsPRBool</span>
<a href="#l181.255"></a><span id="l181.255">   );</span>
<a href="#l181.256"></a><span id="l181.256"> </span>
<a href="#l181.257"></a><span id="l181.257">   // Set the Mock Prompt Service to return true, so that we</span>
<a href="#l181.258"></a><span id="l181.258">   // allow the quit.</span>
<a href="#l181.259"></a><span id="l181.259">   gMockPromptService.returnValue = true;</span>
<a href="#l181.260"></a><span id="l181.260">   // Trigger the quit-application-request notification</span>
<a href="#l181.261"></a><span id="l181.261">   Services.obs.notifyObservers(cancelQuit, &quot;quit-application-requested&quot;);</span>
<a href="#l181.262"></a><span id="l181.262">   let promptState = gMockPromptService.promptState;</span>
<a href="#l181.263"></a><span id="l181.263" class="difflineminus">-  assert_not_equals(null, promptState, &quot;Expected a confirmEx prompt&quot;);</span>
<a href="#l181.264"></a><span id="l181.264" class="difflineplus">+  Assert.notEqual(null, promptState, &quot;Expected a confirmEx prompt&quot;);</span>
<a href="#l181.265"></a><span id="l181.265"> </span>
<a href="#l181.266"></a><span id="l181.266" class="difflineminus">-  assert_equals(&quot;confirmEx&quot;, promptState.method);</span>
<a href="#l181.267"></a><span id="l181.267" class="difflineplus">+  Assert.equal(&quot;confirmEx&quot;, promptState.method);</span>
<a href="#l181.268"></a><span id="l181.268">   // Since we returned true on the confirmation dialog,</span>
<a href="#l181.269"></a><span id="l181.269">   // we should be allowing the quit - so cancelQuit.data</span>
<a href="#l181.270"></a><span id="l181.270">   // should now be false</span>
<a href="#l181.271"></a><span id="l181.271" class="difflineminus">-  assert_false(cancelQuit.data, &quot;Cancelled the quit&quot;);</span>
<a href="#l181.272"></a><span id="l181.272" class="difflineplus">+  Assert.ok(!cancelQuit.data, &quot;Cancelled the quit&quot;);</span>
<a href="#l181.273"></a><span id="l181.273"> </span>
<a href="#l181.274"></a><span id="l181.274">   // Unregister the Mock Prompt Service</span>
<a href="#l181.275"></a><span id="l181.275">   gMockPromptService.unregister();</span>
<a href="#l181.276"></a><span id="l181.276" class="difflineminus">-}</span>
<a href="#l181.277"></a><span id="l181.277" class="difflineplus">+</span>
<a href="#l181.278"></a><span id="l181.278" class="difflineplus">+  close_window(filterc);</span>
<a href="#l181.279"></a><span id="l181.279" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l182.1"></a><span id="l182.1">new file mode 100644</span>
<a href="#l182.2"></a><span id="l182.2" class="difflineminus">--- /dev/null</span>
<a href="#l182.3"></a><span id="l182.3" class="difflineplus">+++ b/mail/test/browser/im/browser.ini</span>
<a href="#l182.4"></a><span id="l182.4" class="difflineat">@@ -0,0 +1,20 @@</span>
<a href="#l182.5"></a><span id="l182.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l182.6"></a><span id="l182.6" class="difflineplus">+prefs =</span>
<a href="#l182.7"></a><span id="l182.7" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l182.8"></a><span id="l182.8" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l182.9"></a><span id="l182.9" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l182.10"></a><span id="l182.10" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l182.11"></a><span id="l182.11" class="difflineplus">+  mail.shell.checkDefaultClient=false</span>
<a href="#l182.12"></a><span id="l182.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l182.13"></a><span id="l182.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l182.14"></a><span id="l182.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l182.15"></a><span id="l182.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l182.16"></a><span id="l182.16" class="difflineplus">+  messenger.account.account1.autoLogin=false</span>
<a href="#l182.17"></a><span id="l182.17" class="difflineplus">+  messenger.account.account1.firstConnectionState=1</span>
<a href="#l182.18"></a><span id="l182.18" class="difflineplus">+  messenger.account.account1.name=mozmilltest@irc.mozilla.invalid</span>
<a href="#l182.19"></a><span id="l182.19" class="difflineplus">+  messenger.account.account1.prpl=prpl-irc</span>
<a href="#l182.20"></a><span id="l182.20" class="difflineplus">+  messenger.accounts=account1</span>
<a href="#l182.21"></a><span id="l182.21" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l182.22"></a><span id="l182.22" class="difflineplus">+</span>
<a href="#l182.23"></a><span id="l182.23" class="difflineplus">+[browser_chatTabRestore.js]</span>
<a href="#l182.24"></a><span id="l182.24" class="difflineplus">+[browser_toolbarButtons.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l183.1"></a><span id="l183.1">copy from mail/test/mozmill/im/test-chat-tab-restore.js</span>
<a href="#l183.2"></a><span id="l183.2">copy to mail/test/browser/im/browser_chatTabRestore.js</span>
<a href="#l183.3"></a><span id="l183.3" class="difflineminus">--- a/mail/test/mozmill/im/test-chat-tab-restore.js</span>
<a href="#l183.4"></a><span id="l183.4" class="difflineplus">+++ b/mail/test/browser/im/browser_chatTabRestore.js</span>
<a href="#l183.5"></a><span id="l183.5" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l183.6"></a><span id="l183.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l183.7"></a><span id="l183.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l183.8"></a><span id="l183.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l183.9"></a><span id="l183.9"> </span>
<a href="#l183.10"></a><span id="l183.10"> &quot;use strict&quot;;</span>
<a href="#l183.11"></a><span id="l183.11"> </span>
<a href="#l183.12"></a><span id="l183.12" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l183.13"></a><span id="l183.13" class="difflineplus">+var utils = ChromeUtils.import(&quot;resource://testing-common/mozmill/utils.jsm&quot;);</span>
<a href="#l183.14"></a><span id="l183.14"> </span>
<a href="#l183.15"></a><span id="l183.15"> var { assert_tab_mode_name, mark_action, mc } = ChromeUtils.import(</span>
<a href="#l183.16"></a><span id="l183.16">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l183.17"></a><span id="l183.17"> );</span>
<a href="#l183.18"></a><span id="l183.18"> </span>
<a href="#l183.19"></a><span id="l183.19"> /**</span>
<a href="#l183.20"></a><span id="l183.20">  * Create a new chat tab, making that tab the current tab. We block until the</span>
<a href="#l183.21"></a><span id="l183.21">  * message finishes loading. (Inspired by open_selected_message_in_new_tab)</span>
<a href="#l183.22"></a><span id="l183.22" class="difflineat">@@ -58,17 +58,17 @@ function wait_for_chat_tab_to_open(aCont</span>
<a href="#l183.23"></a><span id="l183.23">   mark_action(&quot;imh&quot;, &quot;/wait_for_chat_tab_to_open&quot;, []);</span>
<a href="#l183.24"></a><span id="l183.24"> }</span>
<a href="#l183.25"></a><span id="l183.25"> </span>
<a href="#l183.26"></a><span id="l183.26"> /*</span>
<a href="#l183.27"></a><span id="l183.27">  * This tests that the chat tab is restored properly after tabs are</span>
<a href="#l183.28"></a><span id="l183.28">  * serialized. As for folder tabs, we can't test a restart (can we ?), so we</span>
<a href="#l183.29"></a><span id="l183.29">  * just test the persist/restore cycle.</span>
<a href="#l183.30"></a><span id="l183.30">  */</span>
<a href="#l183.31"></a><span id="l183.31" class="difflineminus">-function test_chat_tab_restore() {</span>
<a href="#l183.32"></a><span id="l183.32" class="difflineplus">+add_task(function test_chat_tab_restore() {</span>
<a href="#l183.33"></a><span id="l183.33">   // Close everything but the first tab.</span>
<a href="#l183.34"></a><span id="l183.34">   let closeTabs = function() {</span>
<a href="#l183.35"></a><span id="l183.35">     while (mc.tabmail.tabInfo.length &gt; 1) {</span>
<a href="#l183.36"></a><span id="l183.36">       mc.tabmail.closeTab(1);</span>
<a href="#l183.37"></a><span id="l183.37">     }</span>
<a href="#l183.38"></a><span id="l183.38">   };</span>
<a href="#l183.39"></a><span id="l183.39"> </span>
<a href="#l183.40"></a><span id="l183.40">   open_chat_tab();</span>
<a href="#l183.41"></a><span id="l183.41" class="difflineat">@@ -81,9 +81,16 @@ function test_chat_tab_restore() {</span>
<a href="#l183.42"></a><span id="l183.42">   }</span>
<a href="#l183.43"></a><span id="l183.43"> </span>
<a href="#l183.44"></a><span id="l183.44">   let tabTypes = [&quot;folder&quot;, &quot;chat&quot;];</span>
<a href="#l183.45"></a><span id="l183.45">   for (let i in tabTypes) {</span>
<a href="#l183.46"></a><span id="l183.46">     assert_tab_mode_name(mc.tabmail.tabInfo[i], tabTypes[i]);</span>
<a href="#l183.47"></a><span id="l183.47">   }</span>
<a href="#l183.48"></a><span id="l183.48"> </span>
<a href="#l183.49"></a><span id="l183.49">   closeTabs();</span>
<a href="#l183.50"></a><span id="l183.50" class="difflineminus">-}</span>
<a href="#l183.51"></a><span id="l183.51" class="difflineplus">+</span>
<a href="#l183.52"></a><span id="l183.52" class="difflineplus">+  Assert.report(</span>
<a href="#l183.53"></a><span id="l183.53" class="difflineplus">+    false,</span>
<a href="#l183.54"></a><span id="l183.54" class="difflineplus">+    undefined,</span>
<a href="#l183.55"></a><span id="l183.55" class="difflineplus">+    undefined,</span>
<a href="#l183.56"></a><span id="l183.56" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l183.57"></a><span id="l183.57" class="difflineplus">+  );</span>
<a href="#l183.58"></a><span id="l183.58" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l184.1"></a><span id="l184.1">copy from mail/test/mozmill/im/test-toolbar-buttons.js</span>
<a href="#l184.2"></a><span id="l184.2">copy to mail/test/browser/im/browser_toolbarButtons.js</span>
<a href="#l184.3"></a><span id="l184.3" class="difflineminus">--- a/mail/test/mozmill/im/test-toolbar-buttons.js</span>
<a href="#l184.4"></a><span id="l184.4" class="difflineplus">+++ b/mail/test/browser/im/browser_toolbarButtons.js</span>
<a href="#l184.5"></a><span id="l184.5" class="difflineat">@@ -1,148 +1,142 @@</span>
<a href="#l184.6"></a><span id="l184.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l184.7"></a><span id="l184.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l184.8"></a><span id="l184.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l184.9"></a><span id="l184.9"> </span>
<a href="#l184.10"></a><span id="l184.10"> &quot;use strict&quot;;</span>
<a href="#l184.11"></a><span id="l184.11"> </span>
<a href="#l184.12"></a><span id="l184.12" class="difflineminus">-var {</span>
<a href="#l184.13"></a><span id="l184.13" class="difflineminus">-  assert_equals,</span>
<a href="#l184.14"></a><span id="l184.14" class="difflineminus">-  assert_false,</span>
<a href="#l184.15"></a><span id="l184.15" class="difflineminus">-  assert_not_equals,</span>
<a href="#l184.16"></a><span id="l184.16" class="difflineminus">-  assert_true,</span>
<a href="#l184.17"></a><span id="l184.17" class="difflineminus">-  mc,</span>
<a href="#l184.18"></a><span id="l184.18" class="difflineminus">-} = ChromeUtils.import(</span>
<a href="#l184.19"></a><span id="l184.19" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l184.20"></a><span id="l184.20">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l184.21"></a><span id="l184.21"> );</span>
<a href="#l184.22"></a><span id="l184.22"> </span>
<a href="#l184.23"></a><span id="l184.23"> var { Services } = ChromeUtils.import(&quot;resource:///modules/imServices.jsm&quot;);</span>
<a href="#l184.24"></a><span id="l184.24"> </span>
<a href="#l184.25"></a><span id="l184.25"> /* This test checks that the toolbar buttons of the chat toolbar are</span>
<a href="#l184.26"></a><span id="l184.26">  * correctly disabled/enabled, and that the placeholder displayed in</span>
<a href="#l184.27"></a><span id="l184.27">  * the middle of the chat tab is correct.</span>
<a href="#l184.28"></a><span id="l184.28">  */</span>
<a href="#l184.29"></a><span id="l184.29" class="difflineminus">-function test_toolbar_and_placeholder() {</span>
<a href="#l184.30"></a><span id="l184.30" class="difflineminus">-  assert_not_equals(</span>
<a href="#l184.31"></a><span id="l184.31" class="difflineplus">+add_task(function test_toolbar_and_placeholder() {</span>
<a href="#l184.32"></a><span id="l184.32" class="difflineplus">+  Assert.notEqual(</span>
<a href="#l184.33"></a><span id="l184.33">     mc.tabmail.selectedTab.mode.type,</span>
<a href="#l184.34"></a><span id="l184.34">     &quot;chat&quot;,</span>
<a href="#l184.35"></a><span id="l184.35">     &quot;the chat tab shouldn't be selected at startup&quot;</span>
<a href="#l184.36"></a><span id="l184.36">   );</span>
<a href="#l184.37"></a><span id="l184.37">   mc.click(mc.eid(&quot;button-chat&quot;));</span>
<a href="#l184.38"></a><span id="l184.38" class="difflineminus">-  assert_equals(</span>
<a href="#l184.39"></a><span id="l184.39" class="difflineplus">+  Assert.equal(</span>
<a href="#l184.40"></a><span id="l184.40">     mc.tabmail.selectedTab.mode.type,</span>
<a href="#l184.41"></a><span id="l184.41">     &quot;chat&quot;,</span>
<a href="#l184.42"></a><span id="l184.42">     &quot;the chat tab should be selected&quot;</span>
<a href="#l184.43"></a><span id="l184.43">   );</span>
<a href="#l184.44"></a><span id="l184.44"> </span>
<a href="#l184.45"></a><span id="l184.45">   // Check that &quot;No connected account&quot; placeholder is correct.</span>
<a href="#l184.46"></a><span id="l184.46" class="difflineminus">-  assert_equals(</span>
<a href="#l184.47"></a><span id="l184.47" class="difflineplus">+  Assert.equal(</span>
<a href="#l184.48"></a><span id="l184.48">     mc.e(&quot;conversationsDeck&quot;).selectedPanel.id,</span>
<a href="#l184.49"></a><span id="l184.49">     &quot;noConvScreen&quot;,</span>
<a href="#l184.50"></a><span id="l184.50">     &quot;'Your chat accounts are not connected.' placeholder&quot;</span>
<a href="#l184.51"></a><span id="l184.51">   );</span>
<a href="#l184.52"></a><span id="l184.52" class="difflineminus">-  assert_true(</span>
<a href="#l184.53"></a><span id="l184.53" class="difflineplus">+  Assert.ok(</span>
<a href="#l184.54"></a><span id="l184.54">     mc.e(&quot;noConvInnerBox&quot;).hidden,</span>
<a href="#l184.55"></a><span id="l184.55">     &quot;the 'No conversation' placeholder is hidden&quot;</span>
<a href="#l184.56"></a><span id="l184.56">   );</span>
<a href="#l184.57"></a><span id="l184.57" class="difflineminus">-  assert_true(</span>
<a href="#l184.58"></a><span id="l184.58" class="difflineplus">+  Assert.ok(</span>
<a href="#l184.59"></a><span id="l184.59">     mc.e(&quot;noAccountInnerBox&quot;).hidden,</span>
<a href="#l184.60"></a><span id="l184.60">     &quot;the 'No account' placeholder is hidden&quot;</span>
<a href="#l184.61"></a><span id="l184.61">   );</span>
<a href="#l184.62"></a><span id="l184.62" class="difflineminus">-  assert_false(</span>
<a href="#l184.63"></a><span id="l184.63" class="difflineminus">-    mc.e(&quot;noConnectedAccountInnerBox&quot;).hidden,</span>
<a href="#l184.64"></a><span id="l184.64" class="difflineplus">+  Assert.ok(</span>
<a href="#l184.65"></a><span id="l184.65" class="difflineplus">+    !mc.e(&quot;noConnectedAccountInnerBox&quot;).hidden,</span>
<a href="#l184.66"></a><span id="l184.66">     &quot;the 'No connected account' placeholder is visible&quot;</span>
<a href="#l184.67"></a><span id="l184.67">   );</span>
<a href="#l184.68"></a><span id="l184.68">   let chatHandler = mc.window.chatHandler;</span>
<a href="#l184.69"></a><span id="l184.69" class="difflineminus">-  assert_equals(</span>
<a href="#l184.70"></a><span id="l184.70" class="difflineplus">+  Assert.equal(</span>
<a href="#l184.71"></a><span id="l184.71">     chatHandler._placeHolderButtonId,</span>
<a href="#l184.72"></a><span id="l184.72">     &quot;openIMAccountManagerButton&quot;,</span>
<a href="#l184.73"></a><span id="l184.73">     &quot;the correct placeholder button is visible&quot;</span>
<a href="#l184.74"></a><span id="l184.74">   );</span>
<a href="#l184.75"></a><span id="l184.75" class="difflineminus">-  assert_equals(</span>
<a href="#l184.76"></a><span id="l184.76" class="difflineplus">+  Assert.equal(</span>
<a href="#l184.77"></a><span id="l184.77">     mc.window.document.activeElement.id,</span>
<a href="#l184.78"></a><span id="l184.78">     chatHandler._placeHolderButtonId,</span>
<a href="#l184.79"></a><span id="l184.79">     &quot;the placeholder button is focused&quot;</span>
<a href="#l184.80"></a><span id="l184.80">   );</span>
<a href="#l184.81"></a><span id="l184.81"> </span>
<a href="#l184.82"></a><span id="l184.82">   // check that add contact and join chat are disabled</span>
<a href="#l184.83"></a><span id="l184.83" class="difflineminus">-  assert_true(</span>
<a href="#l184.84"></a><span id="l184.84" class="difflineplus">+  Assert.ok(</span>
<a href="#l184.85"></a><span id="l184.85">     mc.e(&quot;button-add-buddy&quot;).disabled,</span>
<a href="#l184.86"></a><span id="l184.86">     &quot;the Add Buddy button is disabled&quot;</span>
<a href="#l184.87"></a><span id="l184.87">   );</span>
<a href="#l184.88"></a><span id="l184.88" class="difflineminus">-  assert_true(</span>
<a href="#l184.89"></a><span id="l184.89" class="difflineplus">+  Assert.ok(</span>
<a href="#l184.90"></a><span id="l184.90">     mc.e(&quot;button-join-chat&quot;).disabled,</span>
<a href="#l184.91"></a><span id="l184.91">     &quot;the Join Chat button is disabled&quot;</span>
<a href="#l184.92"></a><span id="l184.92">   );</span>
<a href="#l184.93"></a><span id="l184.93"> </span>
<a href="#l184.94"></a><span id="l184.94">   // The next tests require an account, get the unwrapped default IRC account.</span>
<a href="#l184.95"></a><span id="l184.95">   let account = Services.accounts.getAccountByNumericId(1);</span>
<a href="#l184.96"></a><span id="l184.96" class="difflineminus">-  assert_equals(</span>
<a href="#l184.97"></a><span id="l184.97" class="difflineplus">+  Assert.equal(</span>
<a href="#l184.98"></a><span id="l184.98">     account.protocol.id,</span>
<a href="#l184.99"></a><span id="l184.99">     &quot;prpl-irc&quot;,</span>
<a href="#l184.100"></a><span id="l184.100">     &quot;the default IM account is an IRC account&quot;</span>
<a href="#l184.101"></a><span id="l184.101">   );</span>
<a href="#l184.102"></a><span id="l184.102">   let ircAccount = account.prplAccount.wrappedJSObject;</span>
<a href="#l184.103"></a><span id="l184.103"> </span>
<a href="#l184.104"></a><span id="l184.104">   // Pretend the account is connected and check how the UI reacts</span>
<a href="#l184.105"></a><span id="l184.105">   ircAccount.reportConnected();</span>
<a href="#l184.106"></a><span id="l184.106"> </span>
<a href="#l184.107"></a><span id="l184.107">   // check that add contact and join chat are no longer disabled</span>
<a href="#l184.108"></a><span id="l184.108" class="difflineminus">-  assert_false(</span>
<a href="#l184.109"></a><span id="l184.109" class="difflineminus">-    mc.e(&quot;button-add-buddy&quot;).disabled,</span>
<a href="#l184.110"></a><span id="l184.110" class="difflineplus">+  Assert.ok(</span>
<a href="#l184.111"></a><span id="l184.111" class="difflineplus">+    !mc.e(&quot;button-add-buddy&quot;).disabled,</span>
<a href="#l184.112"></a><span id="l184.112">     &quot;the Add Buddy button is not disabled&quot;</span>
<a href="#l184.113"></a><span id="l184.113">   );</span>
<a href="#l184.114"></a><span id="l184.114" class="difflineminus">-  assert_false(</span>
<a href="#l184.115"></a><span id="l184.115" class="difflineminus">-    mc.e(&quot;button-join-chat&quot;).disabled,</span>
<a href="#l184.116"></a><span id="l184.116" class="difflineplus">+  Assert.ok(</span>
<a href="#l184.117"></a><span id="l184.117" class="difflineplus">+    !mc.e(&quot;button-join-chat&quot;).disabled,</span>
<a href="#l184.118"></a><span id="l184.118">     &quot;the Join Chat button is not disabled&quot;</span>
<a href="#l184.119"></a><span id="l184.119">   );</span>
<a href="#l184.120"></a><span id="l184.120"> </span>
<a href="#l184.121"></a><span id="l184.121">   // Check that the &quot;No conversations&quot; placeholder is correct.</span>
<a href="#l184.122"></a><span id="l184.122" class="difflineminus">-  assert_false(</span>
<a href="#l184.123"></a><span id="l184.123" class="difflineminus">-    mc.e(&quot;noConvInnerBox&quot;).hidden,</span>
<a href="#l184.124"></a><span id="l184.124" class="difflineplus">+  Assert.ok(</span>
<a href="#l184.125"></a><span id="l184.125" class="difflineplus">+    !mc.e(&quot;noConvInnerBox&quot;).hidden,</span>
<a href="#l184.126"></a><span id="l184.126">     &quot;the 'No conversation' placeholder is visible&quot;</span>
<a href="#l184.127"></a><span id="l184.127">   );</span>
<a href="#l184.128"></a><span id="l184.128" class="difflineminus">-  assert_true(</span>
<a href="#l184.129"></a><span id="l184.129" class="difflineplus">+  Assert.ok(</span>
<a href="#l184.130"></a><span id="l184.130">     mc.e(&quot;noAccountInnerBox&quot;).hidden,</span>
<a href="#l184.131"></a><span id="l184.131">     &quot;the 'No account' placeholder is hidden&quot;</span>
<a href="#l184.132"></a><span id="l184.132">   );</span>
<a href="#l184.133"></a><span id="l184.133" class="difflineminus">-  assert_true(</span>
<a href="#l184.134"></a><span id="l184.134" class="difflineplus">+  Assert.ok(</span>
<a href="#l184.135"></a><span id="l184.135">     mc.e(&quot;noConnectedAccountInnerBox&quot;).hidden,</span>
<a href="#l184.136"></a><span id="l184.136">     &quot;the 'No connected account' placeholder is hidden&quot;</span>
<a href="#l184.137"></a><span id="l184.137">   );</span>
<a href="#l184.138"></a><span id="l184.138" class="difflineminus">-  assert_false(chatHandler._placeHolderButtonId, &quot;no placeholder button&quot;);</span>
<a href="#l184.139"></a><span id="l184.139" class="difflineplus">+  Assert.ok(!chatHandler._placeHolderButtonId, &quot;no placeholder button&quot;);</span>
<a href="#l184.140"></a><span id="l184.140"> </span>
<a href="#l184.141"></a><span id="l184.141">   // Now check that the UI reacts to account disconnections too.</span>
<a href="#l184.142"></a><span id="l184.142">   ircAccount.reportDisconnected();</span>
<a href="#l184.143"></a><span id="l184.143"> </span>
<a href="#l184.144"></a><span id="l184.144">   // check that add contact and join chat are disabled again.</span>
<a href="#l184.145"></a><span id="l184.145" class="difflineminus">-  assert_true(</span>
<a href="#l184.146"></a><span id="l184.146" class="difflineplus">+  Assert.ok(</span>
<a href="#l184.147"></a><span id="l184.147">     mc.e(&quot;button-add-buddy&quot;).disabled,</span>
<a href="#l184.148"></a><span id="l184.148">     &quot;the Add Buddy button is disabled&quot;</span>
<a href="#l184.149"></a><span id="l184.149">   );</span>
<a href="#l184.150"></a><span id="l184.150" class="difflineminus">-  assert_true(</span>
<a href="#l184.151"></a><span id="l184.151" class="difflineplus">+  Assert.ok(</span>
<a href="#l184.152"></a><span id="l184.152">     mc.e(&quot;button-join-chat&quot;).disabled,</span>
<a href="#l184.153"></a><span id="l184.153">     &quot;the Join Chat button is disabled&quot;</span>
<a href="#l184.154"></a><span id="l184.154">   );</span>
<a href="#l184.155"></a><span id="l184.155"> </span>
<a href="#l184.156"></a><span id="l184.156">   // Check that the &quot;No connected account&quot; placeholder is back.</span>
<a href="#l184.157"></a><span id="l184.157" class="difflineminus">-  assert_true(</span>
<a href="#l184.158"></a><span id="l184.158" class="difflineplus">+  Assert.ok(</span>
<a href="#l184.159"></a><span id="l184.159">     mc.e(&quot;noConvInnerBox&quot;).hidden,</span>
<a href="#l184.160"></a><span id="l184.160">     &quot;the 'No conversation' placeholder is hidden&quot;</span>
<a href="#l184.161"></a><span id="l184.161">   );</span>
<a href="#l184.162"></a><span id="l184.162" class="difflineminus">-  assert_true(</span>
<a href="#l184.163"></a><span id="l184.163" class="difflineplus">+  Assert.ok(</span>
<a href="#l184.164"></a><span id="l184.164">     mc.e(&quot;noAccountInnerBox&quot;).hidden,</span>
<a href="#l184.165"></a><span id="l184.165">     &quot;the 'No account' placeholder is hidden&quot;</span>
<a href="#l184.166"></a><span id="l184.166">   );</span>
<a href="#l184.167"></a><span id="l184.167" class="difflineminus">-  assert_false(</span>
<a href="#l184.168"></a><span id="l184.168" class="difflineminus">-    mc.e(&quot;noConnectedAccountInnerBox&quot;).hidden,</span>
<a href="#l184.169"></a><span id="l184.169" class="difflineplus">+  Assert.ok(</span>
<a href="#l184.170"></a><span id="l184.170" class="difflineplus">+    !mc.e(&quot;noConnectedAccountInnerBox&quot;).hidden,</span>
<a href="#l184.171"></a><span id="l184.171">     &quot;the 'No connected account' placeholder is visible&quot;</span>
<a href="#l184.172"></a><span id="l184.172">   );</span>
<a href="#l184.173"></a><span id="l184.173" class="difflineminus">-  assert_equals(</span>
<a href="#l184.174"></a><span id="l184.174" class="difflineplus">+  Assert.equal(</span>
<a href="#l184.175"></a><span id="l184.175">     chatHandler._placeHolderButtonId,</span>
<a href="#l184.176"></a><span id="l184.176">     &quot;openIMAccountManagerButton&quot;,</span>
<a href="#l184.177"></a><span id="l184.177">     &quot;the correct placeholder button is visible&quot;</span>
<a href="#l184.178"></a><span id="l184.178">   );</span>
<a href="#l184.179"></a><span id="l184.179"> </span>
<a href="#l184.180"></a><span id="l184.180">   while (mc.tabmail.tabInfo.length &gt; 1) {</span>
<a href="#l184.181"></a><span id="l184.181">     mc.tabmail.closeTab(1);</span>
<a href="#l184.182"></a><span id="l184.182">   }</span>
<a href="#l184.183"></a><span id="l184.183" class="difflineminus">-}</span>
<a href="#l184.184"></a><span id="l184.184" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l185.1"></a><span id="l185.1">new file mode 100644</span>
<a href="#l185.2"></a><span id="l185.2" class="difflineminus">--- /dev/null</span>
<a href="#l185.3"></a><span id="l185.3" class="difflineplus">+++ b/mail/test/browser/instrumentation/browser.ini</span>
<a href="#l185.4"></a><span id="l185.4" class="difflineat">@@ -0,0 +1,17 @@</span>
<a href="#l185.5"></a><span id="l185.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l185.6"></a><span id="l185.6" class="difflineplus">+prefs =</span>
<a href="#l185.7"></a><span id="l185.7" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l185.8"></a><span id="l185.8" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l185.9"></a><span id="l185.9" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l185.10"></a><span id="l185.10" class="difflineplus">+  mail.provider.enabled=false</span>
<a href="#l185.11"></a><span id="l185.11" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l185.12"></a><span id="l185.12" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l185.13"></a><span id="l185.13" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l185.14"></a><span id="l185.14" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l185.15"></a><span id="l185.15" class="difflineplus">+  mail.wizard.logging.dump=All</span>
<a href="#l185.16"></a><span id="l185.16" class="difflineplus">+  mailnews.auto_config_url=http://mochi.test:8888/browser/comm/mail/test/browser/account/xml</span>
<a href="#l185.17"></a><span id="l185.17" class="difflineplus">+  mailnews.auto_config.addons_url=about:blank</span>
<a href="#l185.18"></a><span id="l185.18" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l185.19"></a><span id="l185.19" class="difflineplus">+</span>
<a href="#l185.20"></a><span id="l185.20" class="difflineplus">+[browser_instrumentSetup.js]</span>
<a href="#l185.21"></a><span id="l185.21" class="difflineplus">+skip-if = true</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l186.1"></a><span id="l186.1">copy from mail/test/mozmill/instrumentation/test-instrument-setup.js</span>
<a href="#l186.2"></a><span id="l186.2">copy to mail/test/browser/instrumentation/browser_instrumentSetup.js</span>
<a href="#l186.3"></a><span id="l186.3" class="difflineminus">--- a/mail/test/mozmill/instrumentation/test-instrument-setup.js</span>
<a href="#l186.4"></a><span id="l186.4" class="difflineplus">+++ b/mail/test/browser/instrumentation/browser_instrumentSetup.js</span>
<a href="#l186.5"></a><span id="l186.5" class="difflineat">@@ -1,19 +1,19 @@</span>
<a href="#l186.6"></a><span id="l186.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l186.7"></a><span id="l186.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l186.8"></a><span id="l186.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l186.9"></a><span id="l186.9"> </span>
<a href="#l186.10"></a><span id="l186.10"> &quot;use strict&quot;;</span>
<a href="#l186.11"></a><span id="l186.11"> </span>
<a href="#l186.12"></a><span id="l186.12"> var elib = ChromeUtils.import(</span>
<a href="#l186.13"></a><span id="l186.13" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l186.14"></a><span id="l186.14" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l186.15"></a><span id="l186.15"> );</span>
<a href="#l186.16"></a><span id="l186.16"> </span>
<a href="#l186.17"></a><span id="l186.17" class="difflineminus">-var { assert_equals, mc } = ChromeUtils.import(</span>
<a href="#l186.18"></a><span id="l186.18" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l186.19"></a><span id="l186.19">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l186.20"></a><span id="l186.20"> );</span>
<a href="#l186.21"></a><span id="l186.21"> var { input_value } = ChromeUtils.import(</span>
<a href="#l186.22"></a><span id="l186.22">   &quot;resource://testing-common/mozmill/KeyboardHelpers.jsm&quot;</span>
<a href="#l186.23"></a><span id="l186.23"> );</span>
<a href="#l186.24"></a><span id="l186.24"> var {</span>
<a href="#l186.25"></a><span id="l186.25">   plan_for_window_close,</span>
<a href="#l186.26"></a><span id="l186.26">   wait_for_existing_window,</span>
<a href="#l186.27"></a><span id="l186.27" class="difflineat">@@ -27,28 +27,17 @@ var { MailServices } = ChromeUtils.impor</span>
<a href="#l186.28"></a><span id="l186.28"> </span>
<a href="#l186.29"></a><span id="l186.29"> var user = {</span>
<a href="#l186.30"></a><span id="l186.30">   name: &quot;Roger Sterling&quot;,</span>
<a href="#l186.31"></a><span id="l186.31">   email: &quot;roger.sterling@example.com&quot;,</span>
<a href="#l186.32"></a><span id="l186.32">   incomingHost: &quot;testin.example.com&quot;,</span>
<a href="#l186.33"></a><span id="l186.33">   outgoingHost: &quot;testout.example.com&quot;,</span>
<a href="#l186.34"></a><span id="l186.34"> };</span>
<a href="#l186.35"></a><span id="l186.35"> </span>
<a href="#l186.36"></a><span id="l186.36" class="difflineminus">-function setupModule(module) {</span>
<a href="#l186.37"></a><span id="l186.37" class="difflineminus">-  Services.prefs.setCharPref(&quot;mail.wizard.logging.dump&quot;, &quot;All&quot;);</span>
<a href="#l186.38"></a><span id="l186.38" class="difflineminus">-</span>
<a href="#l186.39"></a><span id="l186.39" class="difflineminus">-  // Set the pref to load a local autoconfig file.</span>
<a href="#l186.40"></a><span id="l186.40" class="difflineminus">-  let url = collector.addHttpResource(&quot;../account/xml&quot;, &quot;autoconfig&quot;);</span>
<a href="#l186.41"></a><span id="l186.41" class="difflineminus">-  Services.prefs.setCharPref(&quot;mailnews.auto_config_url&quot;, url);</span>
<a href="#l186.42"></a><span id="l186.42" class="difflineminus">-</span>
<a href="#l186.43"></a><span id="l186.43" class="difflineminus">-  // Force .com MIME-Type to text/xml</span>
<a href="#l186.44"></a><span id="l186.44" class="difflineminus">-  collector.httpd.registerContentType(&quot;com&quot;, &quot;text/xml&quot;);</span>
<a href="#l186.45"></a><span id="l186.45" class="difflineminus">-}</span>
<a href="#l186.46"></a><span id="l186.46" class="difflineminus">-</span>
<a href="#l186.47"></a><span id="l186.47" class="difflineminus">-function test_mail_account_setup() {</span>
<a href="#l186.48"></a><span id="l186.48" class="difflineplus">+add_task(function test_mail_account_setup() {</span>
<a href="#l186.49"></a><span id="l186.49">   let awc = wait_for_existing_window(&quot;mail:autoconfig&quot;);</span>
<a href="#l186.50"></a><span id="l186.50"> </span>
<a href="#l186.51"></a><span id="l186.51">   // Input user's account information</span>
<a href="#l186.52"></a><span id="l186.52">   awc.e(&quot;realname&quot;).focus();</span>
<a href="#l186.53"></a><span id="l186.53">   input_value(awc, user.name);</span>
<a href="#l186.54"></a><span id="l186.54">   awc.keypress(null, &quot;VK_TAB&quot;, {});</span>
<a href="#l186.55"></a><span id="l186.55">   input_value(awc, user.email);</span>
<a href="#l186.56"></a><span id="l186.56"> </span>
<a href="#l186.57"></a><span id="l186.57" class="difflineat">@@ -69,28 +58,26 @@ function test_mail_account_setup() {</span>
<a href="#l186.58"></a><span id="l186.58">   wait_for_window_close();</span>
<a href="#l186.59"></a><span id="l186.59"> </span>
<a href="#l186.60"></a><span id="l186.60">   // we expect to have accountAdded and smtpServerAdded events.</span>
<a href="#l186.61"></a><span id="l186.61">   if (!events.accountAdded.data) {</span>
<a href="#l186.62"></a><span id="l186.62">     throw new Error(&quot;failed to add an account&quot;);</span>
<a href="#l186.63"></a><span id="l186.63">   } else if (!events.smtpServerAdded.data) {</span>
<a href="#l186.64"></a><span id="l186.64">     throw new Error(&quot;failed to add an smtp server&quot;);</span>
<a href="#l186.65"></a><span id="l186.65">   }</span>
<a href="#l186.66"></a><span id="l186.66" class="difflineminus">-}</span>
<a href="#l186.67"></a><span id="l186.67" class="difflineplus">+});</span>
<a href="#l186.68"></a><span id="l186.68"> </span>
<a href="#l186.69"></a><span id="l186.69"> // Remove the accounts we added.</span>
<a href="#l186.70"></a><span id="l186.70" class="difflineminus">-function tearDownModule(module) {</span>
<a href="#l186.71"></a><span id="l186.71" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l186.72"></a><span id="l186.72">   let incomingServer = MailServices.accounts.FindServer(</span>
<a href="#l186.73"></a><span id="l186.73">     &quot;roger.sterling&quot;,</span>
<a href="#l186.74"></a><span id="l186.74">     user.incomingHost,</span>
<a href="#l186.75"></a><span id="l186.75">     &quot;pop3&quot;</span>
<a href="#l186.76"></a><span id="l186.76">   );</span>
<a href="#l186.77"></a><span id="l186.77" class="difflineminus">-  assert_equals(incomingServer.hostName, user.incomingHost);</span>
<a href="#l186.78"></a><span id="l186.78" class="difflineplus">+  Assert.equal(incomingServer.hostName, user.incomingHost);</span>
<a href="#l186.79"></a><span id="l186.79">   let account = MailServices.accounts.FindAccountForServer(incomingServer);</span>
<a href="#l186.80"></a><span id="l186.80"> </span>
<a href="#l186.81"></a><span id="l186.81">   let identity = account.defaultIdentity;</span>
<a href="#l186.82"></a><span id="l186.82">   let outgoingServer = MailServices.smtp.getServerByKey(identity.smtpServerKey);</span>
<a href="#l186.83"></a><span id="l186.83" class="difflineminus">-  assert_equals(outgoingServer.hostname, user.outgoingHost);</span>
<a href="#l186.84"></a><span id="l186.84" class="difflineplus">+  Assert.equal(outgoingServer.hostname, user.outgoingHost);</span>
<a href="#l186.85"></a><span id="l186.85">   MailServices.smtp.deleteServer(outgoingServer);</span>
<a href="#l186.86"></a><span id="l186.86">   MailServices.accounts.removeAccount(account, true);</span>
<a href="#l186.87"></a><span id="l186.87" class="difflineminus">-</span>
<a href="#l186.88"></a><span id="l186.88" class="difflineminus">-  Services.prefs.clearUserPref(&quot;mailnews.auto_config_url&quot;);</span>
<a href="#l186.89"></a><span id="l186.89" class="difflineminus">-}</span>
<a href="#l186.90"></a><span id="l186.90" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l187.1"></a><span id="l187.1">new file mode 100644</span>
<a href="#l187.2"></a><span id="l187.2" class="difflineminus">--- /dev/null</span>
<a href="#l187.3"></a><span id="l187.3" class="difflineplus">+++ b/mail/test/browser/junk-commands/browser.ini</span>
<a href="#l187.4"></a><span id="l187.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l187.5"></a><span id="l187.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l187.6"></a><span id="l187.6" class="difflineplus">+prefs =</span>
<a href="#l187.7"></a><span id="l187.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l187.8"></a><span id="l187.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l187.9"></a><span id="l187.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l187.10"></a><span id="l187.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l187.11"></a><span id="l187.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l187.12"></a><span id="l187.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l187.13"></a><span id="l187.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l187.14"></a><span id="l187.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l187.15"></a><span id="l187.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l187.16"></a><span id="l187.16" class="difflineplus">+  mailnews.ui.junk.firstuse=false</span>
<a href="#l187.17"></a><span id="l187.17" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l187.18"></a><span id="l187.18" class="difflineplus">+</span>
<a href="#l187.19"></a><span id="l187.19" class="difflineplus">+[browser_junkCommands.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l188.1"></a><span id="l188.1">copy from mail/test/mozmill/junk-commands/test-junk-commands.js</span>
<a href="#l188.2"></a><span id="l188.2">copy to mail/test/browser/junk-commands/browser_junkCommands.js</span>
<a href="#l188.3"></a><span id="l188.3" class="difflineminus">--- a/mail/test/mozmill/junk-commands/test-junk-commands.js</span>
<a href="#l188.4"></a><span id="l188.4" class="difflineplus">+++ b/mail/test/browser/junk-commands/browser_junkCommands.js</span>
<a href="#l188.5"></a><span id="l188.5" class="difflineat">@@ -1,15 +1,15 @@</span>
<a href="#l188.6"></a><span id="l188.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l188.7"></a><span id="l188.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l188.8"></a><span id="l188.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l188.9"></a><span id="l188.9"> </span>
<a href="#l188.10"></a><span id="l188.10"> &quot;use strict&quot;;</span>
<a href="#l188.11"></a><span id="l188.11"> </span>
<a href="#l188.12"></a><span id="l188.12" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l188.13"></a><span id="l188.13" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l188.14"></a><span id="l188.14"> </span>
<a href="#l188.15"></a><span id="l188.15"> var {</span>
<a href="#l188.16"></a><span id="l188.16">   be_in_folder,</span>
<a href="#l188.17"></a><span id="l188.17">   create_folder,</span>
<a href="#l188.18"></a><span id="l188.18">   make_new_sets_in_folder,</span>
<a href="#l188.19"></a><span id="l188.19">   select_click_row,</span>
<a href="#l188.20"></a><span id="l188.20">   select_none,</span>
<a href="#l188.21"></a><span id="l188.21">   select_shift_click_row,</span>
<a href="#l188.22"></a><span id="l188.22" class="difflineat">@@ -19,20 +19,20 @@ var {</span>
<a href="#l188.23"></a><span id="l188.23"> var {</span>
<a href="#l188.24"></a><span id="l188.24">   delete_mail_marked_as_junk,</span>
<a href="#l188.25"></a><span id="l188.25">   mark_selected_messages_as_junk,</span>
<a href="#l188.26"></a><span id="l188.26"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/JunkHelpers.jsm&quot;);</span>
<a href="#l188.27"></a><span id="l188.27"> </span>
<a href="#l188.28"></a><span id="l188.28"> // One folder's enough</span>
<a href="#l188.29"></a><span id="l188.29"> var folder = null;</span>
<a href="#l188.30"></a><span id="l188.30"> </span>
<a href="#l188.31"></a><span id="l188.31" class="difflineminus">-function setupModule(module) {</span>
<a href="#l188.32"></a><span id="l188.32" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l188.33"></a><span id="l188.33">   folder = create_folder(&quot;JunkCommandsA&quot;);</span>
<a href="#l188.34"></a><span id="l188.34">   make_new_sets_in_folder(folder, [{ count: 30 }]);</span>
<a href="#l188.35"></a><span id="l188.35" class="difflineminus">-}</span>
<a href="#l188.36"></a><span id="l188.36" class="difflineplus">+});</span>
<a href="#l188.37"></a><span id="l188.37"> </span>
<a href="#l188.38"></a><span id="l188.38"> /**</span>
<a href="#l188.39"></a><span id="l188.39">  * The number of messages to mark as junk and expect to be deleted.</span>
<a href="#l188.40"></a><span id="l188.40">  */</span>
<a href="#l188.41"></a><span id="l188.41"> var NUM_MESSAGES_TO_JUNK = 8;</span>
<a href="#l188.42"></a><span id="l188.42"> </span>
<a href="#l188.43"></a><span id="l188.43"> /**</span>
<a href="#l188.44"></a><span id="l188.44">  * Helper to check whether a folder has the right number of messages.</span>
<a href="#l188.45"></a><span id="l188.45" class="difflineat">@@ -53,29 +53,29 @@ function _assert_folder_total_messages(a</span>
<a href="#l188.46"></a><span id="l188.46">         &quot; messages.&quot;</span>
<a href="#l188.47"></a><span id="l188.47">     );</span>
<a href="#l188.48"></a><span id="l188.48">   }</span>
<a href="#l188.49"></a><span id="l188.49"> }</span>
<a href="#l188.50"></a><span id="l188.50"> </span>
<a href="#l188.51"></a><span id="l188.51"> /**</span>
<a href="#l188.52"></a><span id="l188.52">  * Test deleting junk messages with no messages marked as junk.</span>
<a href="#l188.53"></a><span id="l188.53">  */</span>
<a href="#l188.54"></a><span id="l188.54" class="difflineminus">-function test_delete_no_junk_messages() {</span>
<a href="#l188.55"></a><span id="l188.55" class="difflineplus">+add_task(function test_delete_no_junk_messages() {</span>
<a href="#l188.56"></a><span id="l188.56">   let initialNumMessages = folder.getTotalMessages(false);</span>
<a href="#l188.57"></a><span id="l188.57">   be_in_folder(folder);</span>
<a href="#l188.58"></a><span id="l188.58">   select_none();</span>
<a href="#l188.59"></a><span id="l188.59">   delete_mail_marked_as_junk(0);</span>
<a href="#l188.60"></a><span id="l188.60">   // Check if we still have the same number of messages</span>
<a href="#l188.61"></a><span id="l188.61">   _assert_folder_total_messages(folder, initialNumMessages);</span>
<a href="#l188.62"></a><span id="l188.62" class="difflineminus">-}</span>
<a href="#l188.63"></a><span id="l188.63" class="difflineplus">+});</span>
<a href="#l188.64"></a><span id="l188.64"> </span>
<a href="#l188.65"></a><span id="l188.65"> /**</span>
<a href="#l188.66"></a><span id="l188.66">  * Test deleting junk messages with some messages marked as junk.</span>
<a href="#l188.67"></a><span id="l188.67">  */</span>
<a href="#l188.68"></a><span id="l188.68" class="difflineminus">-function test_delete_junk_messages() {</span>
<a href="#l188.69"></a><span id="l188.69" class="difflineplus">+add_task(function test_delete_junk_messages() {</span>
<a href="#l188.70"></a><span id="l188.70">   let initialNumMessages = folder.getTotalMessages(false);</span>
<a href="#l188.71"></a><span id="l188.71">   be_in_folder(folder);</span>
<a href="#l188.72"></a><span id="l188.72">   select_click_row(1);</span>
<a href="#l188.73"></a><span id="l188.73">   let selectedMessages = select_shift_click_row(NUM_MESSAGES_TO_JUNK);</span>
<a href="#l188.74"></a><span id="l188.74">   // Mark these messages as junk</span>
<a href="#l188.75"></a><span id="l188.75">   mark_selected_messages_as_junk();</span>
<a href="#l188.76"></a><span id="l188.76">   // Now delete junk mail</span>
<a href="#l188.77"></a><span id="l188.77">   delete_mail_marked_as_junk(NUM_MESSAGES_TO_JUNK);</span>
<a href="#l188.78"></a><span id="l188.78" class="difflineat">@@ -89,9 +89,16 @@ function test_delete_junk_messages() {</span>
<a href="#l188.79"></a><span id="l188.79">   for (let msgHdr of selectedMessages) {</span>
<a href="#l188.80"></a><span id="l188.80">     let key = msgHdr.messageKey;</span>
<a href="#l188.81"></a><span id="l188.81">     if (db.ContainsKey(key)) {</span>
<a href="#l188.82"></a><span id="l188.82">       throw new Error(</span>
<a href="#l188.83"></a><span id="l188.83">         &quot;The database shouldn't contain key &quot; + key + &quot;, but does.&quot;</span>
<a href="#l188.84"></a><span id="l188.84">       );</span>
<a href="#l188.85"></a><span id="l188.85">     }</span>
<a href="#l188.86"></a><span id="l188.86">   }</span>
<a href="#l188.87"></a><span id="l188.87" class="difflineminus">-}</span>
<a href="#l188.88"></a><span id="l188.88" class="difflineplus">+</span>
<a href="#l188.89"></a><span id="l188.89" class="difflineplus">+  Assert.report(</span>
<a href="#l188.90"></a><span id="l188.90" class="difflineplus">+    false,</span>
<a href="#l188.91"></a><span id="l188.91" class="difflineplus">+    undefined,</span>
<a href="#l188.92"></a><span id="l188.92" class="difflineplus">+    undefined,</span>
<a href="#l188.93"></a><span id="l188.93" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l188.94"></a><span id="l188.94" class="difflineplus">+  );</span>
<a href="#l188.95"></a><span id="l188.95" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l189.1"></a><span id="l189.1">new file mode 100644</span>
<a href="#l189.2"></a><span id="l189.2" class="difflineminus">--- /dev/null</span>
<a href="#l189.3"></a><span id="l189.3" class="difflineplus">+++ b/mail/test/browser/keyboard/browser.ini</span>
<a href="#l189.4"></a><span id="l189.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l189.5"></a><span id="l189.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l189.6"></a><span id="l189.6" class="difflineplus">+prefs =</span>
<a href="#l189.7"></a><span id="l189.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l189.8"></a><span id="l189.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l189.9"></a><span id="l189.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l189.10"></a><span id="l189.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l189.11"></a><span id="l189.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l189.12"></a><span id="l189.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l189.13"></a><span id="l189.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l189.14"></a><span id="l189.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l189.15"></a><span id="l189.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l189.16"></a><span id="l189.16" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l189.17"></a><span id="l189.17" class="difflineplus">+</span>
<a href="#l189.18"></a><span id="l189.18" class="difflineplus">+[browser_spacehit.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l190.1"></a><span id="l190.1">copy from mail/test/mozmill/keyboard/test-spacehit.js</span>
<a href="#l190.2"></a><span id="l190.2">copy to mail/test/browser/keyboard/browser_spacehit.js</span>
<a href="#l190.3"></a><span id="l190.3" class="difflineminus">--- a/mail/test/mozmill/keyboard/test-spacehit.js</span>
<a href="#l190.4"></a><span id="l190.4" class="difflineplus">+++ b/mail/test/browser/keyboard/browser_spacehit.js</span>
<a href="#l190.5"></a><span id="l190.5" class="difflineat">@@ -5,44 +5,42 @@</span>
<a href="#l190.6"></a><span id="l190.6"> /**</span>
<a href="#l190.7"></a><span id="l190.7">  * Tests that the space bar only advances to the next unread message</span>
<a href="#l190.8"></a><span id="l190.8">  * when mail.advance_on_spacebar is true (default).</span>
<a href="#l190.9"></a><span id="l190.9">  */</span>
<a href="#l190.10"></a><span id="l190.10"> </span>
<a href="#l190.11"></a><span id="l190.11"> &quot;use strict&quot;;</span>
<a href="#l190.12"></a><span id="l190.12"> </span>
<a href="#l190.13"></a><span id="l190.13"> var {</span>
<a href="#l190.14"></a><span id="l190.14" class="difflineminus">-  assert_equals,</span>
<a href="#l190.15"></a><span id="l190.15" class="difflineminus">-  assert_not_equals,</span>
<a href="#l190.16"></a><span id="l190.16">   be_in_folder,</span>
<a href="#l190.17"></a><span id="l190.17">   create_folder,</span>
<a href="#l190.18"></a><span id="l190.18">   make_new_sets_in_folder,</span>
<a href="#l190.19"></a><span id="l190.19">   mc,</span>
<a href="#l190.20"></a><span id="l190.20">   select_click_row,</span>
<a href="#l190.21"></a><span id="l190.21">   wait_for_message_display_completion,</span>
<a href="#l190.22"></a><span id="l190.22"> } = ChromeUtils.import(</span>
<a href="#l190.23"></a><span id="l190.23">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l190.24"></a><span id="l190.24"> );</span>
<a href="#l190.25"></a><span id="l190.25"> </span>
<a href="#l190.26"></a><span id="l190.26"> // Get original preference value</span>
<a href="#l190.27"></a><span id="l190.27"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l190.28"></a><span id="l190.28"> var prefName = &quot;mail.advance_on_spacebar&quot;;</span>
<a href="#l190.29"></a><span id="l190.29"> var prefValue = Services.prefs.getBoolPref(prefName);</span>
<a href="#l190.30"></a><span id="l190.30"> </span>
<a href="#l190.31"></a><span id="l190.31" class="difflineminus">-function setupModule(module) {</span>
<a href="#l190.32"></a><span id="l190.32" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l190.33"></a><span id="l190.33">   // Create four unread messages in a sample folder</span>
<a href="#l190.34"></a><span id="l190.34">   let folder = create_folder(&quot;Sample&quot;);</span>
<a href="#l190.35"></a><span id="l190.35">   make_new_sets_in_folder(folder, [{ count: 4 }]);</span>
<a href="#l190.36"></a><span id="l190.36">   be_in_folder(folder);</span>
<a href="#l190.37"></a><span id="l190.37" class="difflineminus">-}</span>
<a href="#l190.38"></a><span id="l190.38" class="difflineplus">+});</span>
<a href="#l190.39"></a><span id="l190.39"> </span>
<a href="#l190.40"></a><span id="l190.40" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l190.41"></a><span id="l190.41" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l190.42"></a><span id="l190.42">   // Restore original preference value</span>
<a href="#l190.43"></a><span id="l190.43">   Services.prefs.setBoolPref(prefName, prefValue);</span>
<a href="#l190.44"></a><span id="l190.44" class="difflineminus">-}</span>
<a href="#l190.45"></a><span id="l190.45" class="difflineplus">+});</span>
<a href="#l190.46"></a><span id="l190.46"> </span>
<a href="#l190.47"></a><span id="l190.47"> /**</span>
<a href="#l190.48"></a><span id="l190.48">  * The second of four simple messages is selected and [Shift-]Space is</span>
<a href="#l190.49"></a><span id="l190.49">  * pressed to determine if focus changes to a new message.</span>
<a href="#l190.50"></a><span id="l190.50">  *</span>
<a href="#l190.51"></a><span id="l190.51">  * @param aAdvance whether to advance</span>
<a href="#l190.52"></a><span id="l190.52">  * @param aShift whether to press Shift key</span>
<a href="#l190.53"></a><span id="l190.53">  */</span>
<a href="#l190.54"></a><span id="l190.54" class="difflineat">@@ -52,43 +50,43 @@ function subtest_advance_on_spacebar(aAd</span>
<a href="#l190.55"></a><span id="l190.55">   // Select the second message</span>
<a href="#l190.56"></a><span id="l190.56">   let oldmessage = select_click_row(1);</span>
<a href="#l190.57"></a><span id="l190.57">   wait_for_message_display_completion(mc);</span>
<a href="#l190.58"></a><span id="l190.58">   // Press [Shift-]Space</span>
<a href="#l190.59"></a><span id="l190.59">   mc.keypress(null, &quot; &quot;, { shiftKey: aShift });</span>
<a href="#l190.60"></a><span id="l190.60">   // Check that message focus changes iff aAdvance is true</span>
<a href="#l190.61"></a><span id="l190.61">   let newmessage = mc.folderDisplay.selectedMessage;</span>
<a href="#l190.62"></a><span id="l190.62">   aAdvance</span>
<a href="#l190.63"></a><span id="l190.63" class="difflineminus">-    ? assert_not_equals(oldmessage, newmessage)</span>
<a href="#l190.64"></a><span id="l190.64" class="difflineminus">-    : assert_equals(oldmessage, newmessage);</span>
<a href="#l190.65"></a><span id="l190.65" class="difflineplus">+    ? Assert.notEqual(oldmessage, newmessage)</span>
<a href="#l190.66"></a><span id="l190.66" class="difflineplus">+    : Assert.equal(oldmessage, newmessage);</span>
<a href="#l190.67"></a><span id="l190.67"> }</span>
<a href="#l190.68"></a><span id="l190.68"> </span>
<a href="#l190.69"></a><span id="l190.69"> /**</span>
<a href="#l190.70"></a><span id="l190.70">  * Test that focus remains on current message when preference is false</span>
<a href="#l190.71"></a><span id="l190.71">  * and spacebar is pressed.</span>
<a href="#l190.72"></a><span id="l190.72">  */</span>
<a href="#l190.73"></a><span id="l190.73" class="difflineminus">-function test_noadvance_on_space() {</span>
<a href="#l190.74"></a><span id="l190.74" class="difflineplus">+add_task(function test_noadvance_on_space() {</span>
<a href="#l190.75"></a><span id="l190.75">   subtest_advance_on_spacebar(false, false);</span>
<a href="#l190.76"></a><span id="l190.76" class="difflineminus">-}</span>
<a href="#l190.77"></a><span id="l190.77" class="difflineplus">+});</span>
<a href="#l190.78"></a><span id="l190.78"> </span>
<a href="#l190.79"></a><span id="l190.79"> /**</span>
<a href="#l190.80"></a><span id="l190.80">  * Test that focus remains on current message when preference is false</span>
<a href="#l190.81"></a><span id="l190.81">  * and shift-spacebar is pressed.</span>
<a href="#l190.82"></a><span id="l190.82">  */</span>
<a href="#l190.83"></a><span id="l190.83" class="difflineminus">-function test_noadvance_on_shiftspace() {</span>
<a href="#l190.84"></a><span id="l190.84" class="difflineplus">+add_task(function test_noadvance_on_shiftspace() {</span>
<a href="#l190.85"></a><span id="l190.85">   subtest_advance_on_spacebar(false, true);</span>
<a href="#l190.86"></a><span id="l190.86" class="difflineminus">-}</span>
<a href="#l190.87"></a><span id="l190.87" class="difflineplus">+});</span>
<a href="#l190.88"></a><span id="l190.88"> </span>
<a href="#l190.89"></a><span id="l190.89"> /**</span>
<a href="#l190.90"></a><span id="l190.90">  * Test that focus advances to next message when preference is true</span>
<a href="#l190.91"></a><span id="l190.91">  * and spacebar is pressed.</span>
<a href="#l190.92"></a><span id="l190.92">  */</span>
<a href="#l190.93"></a><span id="l190.93" class="difflineminus">-function test_advance_on_space() {</span>
<a href="#l190.94"></a><span id="l190.94" class="difflineplus">+add_task(function test_advance_on_space() {</span>
<a href="#l190.95"></a><span id="l190.95">   subtest_advance_on_spacebar(true, false);</span>
<a href="#l190.96"></a><span id="l190.96" class="difflineminus">-}</span>
<a href="#l190.97"></a><span id="l190.97" class="difflineplus">+});</span>
<a href="#l190.98"></a><span id="l190.98"> </span>
<a href="#l190.99"></a><span id="l190.99"> /**</span>
<a href="#l190.100"></a><span id="l190.100">  * Test that focus advances to previous message when preference is true</span>
<a href="#l190.101"></a><span id="l190.101">  * and shift-spacebar is pressed.</span>
<a href="#l190.102"></a><span id="l190.102">  */</span>
<a href="#l190.103"></a><span id="l190.103" class="difflineminus">-function test_advance_on_shiftspace() {</span>
<a href="#l190.104"></a><span id="l190.104" class="difflineplus">+add_task(function test_advance_on_shiftspace() {</span>
<a href="#l190.105"></a><span id="l190.105">   subtest_advance_on_spacebar(true, true);</span>
<a href="#l190.106"></a><span id="l190.106" class="difflineminus">-}</span>
<a href="#l190.107"></a><span id="l190.107" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l191.1"></a><span id="l191.1">new file mode 100644</span>
<a href="#l191.2"></a><span id="l191.2" class="difflineminus">--- /dev/null</span>
<a href="#l191.3"></a><span id="l191.3" class="difflineplus">+++ b/mail/test/browser/message-header/browser.ini</span>
<a href="#l191.4"></a><span id="l191.4" class="difflineat">@@ -0,0 +1,19 @@</span>
<a href="#l191.5"></a><span id="l191.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l191.6"></a><span id="l191.6" class="difflineplus">+prefs =</span>
<a href="#l191.7"></a><span id="l191.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l191.8"></a><span id="l191.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l191.9"></a><span id="l191.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l191.10"></a><span id="l191.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l191.11"></a><span id="l191.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l191.12"></a><span id="l191.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l191.13"></a><span id="l191.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l191.14"></a><span id="l191.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l191.15"></a><span id="l191.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l191.16"></a><span id="l191.16" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l191.17"></a><span id="l191.17" class="difflineplus">+support-files = data/**</span>
<a href="#l191.18"></a><span id="l191.18" class="difflineplus">+</span>
<a href="#l191.19"></a><span id="l191.19" class="difflineplus">+[browser_messageHeader.js]</span>
<a href="#l191.20"></a><span id="l191.20" class="difflineplus">+[browser_phishingBar.js]</span>
<a href="#l191.21"></a><span id="l191.21" class="difflineplus">+[browser_replyIdentity.js]</span>
<a href="#l191.22"></a><span id="l191.22" class="difflineplus">+[browser_replyToListFromAddressSelection.js]</span>
<a href="#l191.23"></a><span id="l191.23" class="difflineplus">+[browser_returnReceipt.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l192.1"></a><span id="l192.1">copy from mail/test/mozmill/message-header/test-message-header.js</span>
<a href="#l192.2"></a><span id="l192.2">copy to mail/test/browser/message-header/browser_messageHeader.js</span>
<a href="#l192.3"></a><span id="l192.3" class="difflineminus">--- a/mail/test/mozmill/message-header/test-message-header.js</span>
<a href="#l192.4"></a><span id="l192.4" class="difflineplus">+++ b/mail/test/browser/message-header/browser_messageHeader.js</span>
<a href="#l192.5"></a><span id="l192.5" class="difflineat">@@ -5,35 +5,32 @@</span>
<a href="#l192.6"></a><span id="l192.6"> /**</span>
<a href="#l192.7"></a><span id="l192.7">  * Test functionality in the message header, e.g. tagging, contact editing,</span>
<a href="#l192.8"></a><span id="l192.8">  * the more button ...</span>
<a href="#l192.9"></a><span id="l192.9">  */</span>
<a href="#l192.10"></a><span id="l192.10"> </span>
<a href="#l192.11"></a><span id="l192.11"> &quot;use strict&quot;;</span>
<a href="#l192.12"></a><span id="l192.12"> </span>
<a href="#l192.13"></a><span id="l192.13"> var elib = ChromeUtils.import(</span>
<a href="#l192.14"></a><span id="l192.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l192.15"></a><span id="l192.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l192.16"></a><span id="l192.16"> );</span>
<a href="#l192.17"></a><span id="l192.17"> </span>
<a href="#l192.18"></a><span id="l192.18"> var {</span>
<a href="#l192.19"></a><span id="l192.19">   create_address_book,</span>
<a href="#l192.20"></a><span id="l192.20">   create_mailing_list,</span>
<a href="#l192.21"></a><span id="l192.21">   ensure_no_card_exists,</span>
<a href="#l192.22"></a><span id="l192.22">   get_cards_in_all_address_books_for_email,</span>
<a href="#l192.23"></a><span id="l192.23">   get_mailing_list_from_address_book,</span>
<a href="#l192.24"></a><span id="l192.24"> } = ChromeUtils.import(</span>
<a href="#l192.25"></a><span id="l192.25">   &quot;resource://testing-common/mozmill/AddressBookHelpers.jsm&quot;</span>
<a href="#l192.26"></a><span id="l192.26"> );</span>
<a href="#l192.27"></a><span id="l192.27"> </span>
<a href="#l192.28"></a><span id="l192.28"> var {</span>
<a href="#l192.29"></a><span id="l192.29">   add_message_to_folder,</span>
<a href="#l192.30"></a><span id="l192.30" class="difflineminus">-  assert_equals,</span>
<a href="#l192.31"></a><span id="l192.31" class="difflineminus">-  assert_not_equals,</span>
<a href="#l192.32"></a><span id="l192.32">   assert_selected_and_displayed,</span>
<a href="#l192.33"></a><span id="l192.33" class="difflineminus">-  assert_true,</span>
<a href="#l192.34"></a><span id="l192.34">   be_in_folder,</span>
<a href="#l192.35"></a><span id="l192.35">   close_popup,</span>
<a href="#l192.36"></a><span id="l192.36">   create_folder,</span>
<a href="#l192.37"></a><span id="l192.37">   create_message,</span>
<a href="#l192.38"></a><span id="l192.38">   gDefaultWindowHeight,</span>
<a href="#l192.39"></a><span id="l192.39">   mc,</span>
<a href="#l192.40"></a><span id="l192.40">   msgGen,</span>
<a href="#l192.41"></a><span id="l192.41">   restore_default_window_size,</span>
<a href="#l192.42"></a><span id="l192.42" class="difflineat">@@ -58,17 +55,17 @@ var { MailServices } = ChromeUtils.impor</span>
<a href="#l192.43"></a><span id="l192.43"> var folder, folderMore;</span>
<a href="#l192.44"></a><span id="l192.44"> var gInterestingMessage;</span>
<a href="#l192.45"></a><span id="l192.45"> </span>
<a href="#l192.46"></a><span id="l192.46"> /**</span>
<a href="#l192.47"></a><span id="l192.47">  * Wraps a call to querySelector in an elib.Elem.</span>
<a href="#l192.48"></a><span id="l192.48">  */</span>
<a href="#l192.49"></a><span id="l192.49"> const getElement = (elem, query) =&gt; new elib.Elem(elem.querySelector(query));</span>
<a href="#l192.50"></a><span id="l192.50"> </span>
<a href="#l192.51"></a><span id="l192.51" class="difflineminus">-function setupModule(module) {</span>
<a href="#l192.52"></a><span id="l192.52" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l192.53"></a><span id="l192.53">   folder = create_folder(&quot;MessageWindowA&quot;);</span>
<a href="#l192.54"></a><span id="l192.54">   folderMore = create_folder(&quot;MesageHeaderMoreButton&quot;);</span>
<a href="#l192.55"></a><span id="l192.55"> </span>
<a href="#l192.56"></a><span id="l192.56">   // create a message that has the interesting headers that commonly</span>
<a href="#l192.57"></a><span id="l192.57">   // show up in the message header pane for testing</span>
<a href="#l192.58"></a><span id="l192.58">   gInterestingMessage = create_message({</span>
<a href="#l192.59"></a><span id="l192.59">     cc: msgGen.makeNamesAndAddresses(20), // YYY</span>
<a href="#l192.60"></a><span id="l192.60">     subject:</span>
<a href="#l192.61"></a><span id="l192.61" class="difflineat">@@ -108,28 +105,26 @@ function setupModule(module) {</span>
<a href="#l192.62"></a><span id="l192.62">   // everything that might be in the way</span>
<a href="#l192.63"></a><span id="l192.63">   collapse_panes(mc.e(&quot;folderpane_splitter&quot;), true);</span>
<a href="#l192.64"></a><span id="l192.64">   collapse_panes(mc.e(&quot;tabmail-container&quot;), true);</span>
<a href="#l192.65"></a><span id="l192.65"> </span>
<a href="#l192.66"></a><span id="l192.66">   // Disable animations on the panel, so that we don't have to deal with</span>
<a href="#l192.67"></a><span id="l192.67">   // async openings.</span>
<a href="#l192.68"></a><span id="l192.68">   let contactPanel = mc.eid(&quot;editContactPanel&quot;).getNode();</span>
<a href="#l192.69"></a><span id="l192.69">   contactPanel.setAttribute(&quot;animate&quot;, false);</span>
<a href="#l192.70"></a><span id="l192.70" class="difflineplus">+});</span>
<a href="#l192.71"></a><span id="l192.71"> </span>
<a href="#l192.72"></a><span id="l192.72" class="difflineminus">-  test_a11y_attrs.__force_skip__ = true; // disabled for now, see bug 1489748</span>
<a href="#l192.73"></a><span id="l192.73" class="difflineminus">-}</span>
<a href="#l192.74"></a><span id="l192.74" class="difflineminus">-</span>
<a href="#l192.75"></a><span id="l192.75" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l192.76"></a><span id="l192.76" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l192.77"></a><span id="l192.77">   let contactPanel = mc.eid(&quot;editContactPanel&quot;).getNode();</span>
<a href="#l192.78"></a><span id="l192.78">   contactPanel.removeAttribute(&quot;animate&quot;);</span>
<a href="#l192.79"></a><span id="l192.79"> </span>
<a href="#l192.80"></a><span id="l192.80">   // Now restore the panes we hid in setupModule</span>
<a href="#l192.81"></a><span id="l192.81">   collapse_panes(mc.e(&quot;folderpane_splitter&quot;), false);</span>
<a href="#l192.82"></a><span id="l192.82">   collapse_panes(mc.e(&quot;tabmail-container&quot;), false);</span>
<a href="#l192.83"></a><span id="l192.83" class="difflineminus">-}</span>
<a href="#l192.84"></a><span id="l192.84" class="difflineplus">+});</span>
<a href="#l192.85"></a><span id="l192.85"> </span>
<a href="#l192.86"></a><span id="l192.86"> /**</span>
<a href="#l192.87"></a><span id="l192.87">  * Helper function that takes an array of mail-emailaddress elements and</span>
<a href="#l192.88"></a><span id="l192.88">  * returns the last one in the list that is not hidden. Returns null if no</span>
<a href="#l192.89"></a><span id="l192.89">  * such element exists.</span>
<a href="#l192.90"></a><span id="l192.90">  *</span>
<a href="#l192.91"></a><span id="l192.91">  * @param aAddrs an array of mail-emailaddress elements.</span>
<a href="#l192.92"></a><span id="l192.92">  */</span>
<a href="#l192.93"></a><span id="l192.93" class="difflineat">@@ -137,17 +132,17 @@ function get_last_visible_address(aAddrs</span>
<a href="#l192.94"></a><span id="l192.94">   for (let i = aAddrs.length - 1; i &gt;= 0; --i) {</span>
<a href="#l192.95"></a><span id="l192.95">     if (!aAddrs[i].hidden) {</span>
<a href="#l192.96"></a><span id="l192.96">       return aAddrs[i];</span>
<a href="#l192.97"></a><span id="l192.97">     }</span>
<a href="#l192.98"></a><span id="l192.98">   }</span>
<a href="#l192.99"></a><span id="l192.99">   return null;</span>
<a href="#l192.100"></a><span id="l192.100"> }</span>
<a href="#l192.101"></a><span id="l192.101"> </span>
<a href="#l192.102"></a><span id="l192.102" class="difflineminus">-function test_add_tag_with_really_long_label() {</span>
<a href="#l192.103"></a><span id="l192.103" class="difflineplus">+add_task(function test_add_tag_with_really_long_label() {</span>
<a href="#l192.104"></a><span id="l192.104">   be_in_folder(folder);</span>
<a href="#l192.105"></a><span id="l192.105"> </span>
<a href="#l192.106"></a><span id="l192.106">   // select the first message, which will display it</span>
<a href="#l192.107"></a><span id="l192.107">   let curMessage = select_click_row(0);</span>
<a href="#l192.108"></a><span id="l192.108"> </span>
<a href="#l192.109"></a><span id="l192.109">   assert_selected_and_displayed(mc, curMessage);</span>
<a href="#l192.110"></a><span id="l192.110"> </span>
<a href="#l192.111"></a><span id="l192.111">   let topColumn = mc.eid(&quot;expandedfromTableHeader&quot;).node;</span>
<a href="#l192.112"></a><span id="l192.112" class="difflineat">@@ -208,17 +203,17 @@ function test_add_tag_with_really_long_l</span>
<a href="#l192.113"></a><span id="l192.113">     );</span>
<a href="#l192.114"></a><span id="l192.114">   }</span>
<a href="#l192.115"></a><span id="l192.115"> </span>
<a href="#l192.116"></a><span id="l192.116">   // Remove the tag and put it back so that the a11y label gets regenerated</span>
<a href="#l192.117"></a><span id="l192.117">   // with the normal value rather than &quot;taaaaaaaags&quot;</span>
<a href="#l192.118"></a><span id="l192.118">   tagsLabel.value = oldTagsValue;</span>
<a href="#l192.119"></a><span id="l192.119">   mc.keypress(mc.eid(&quot;expandedfromTableHeader&quot;), &quot;1&quot;, {});</span>
<a href="#l192.120"></a><span id="l192.120">   mc.keypress(mc.eid(&quot;expandedfromTableHeader&quot;), &quot;1&quot;, {});</span>
<a href="#l192.121"></a><span id="l192.121" class="difflineminus">-}</span>
<a href="#l192.122"></a><span id="l192.122" class="difflineplus">+});</span>
<a href="#l192.123"></a><span id="l192.123"> </span>
<a href="#l192.124"></a><span id="l192.124"> /**</span>
<a href="#l192.125"></a><span id="l192.125">  * @param headerName used for pretty-printing in exceptions</span>
<a href="#l192.126"></a><span id="l192.126">  * @param headerValueElement  Function returning the DOM element</span>
<a href="#l192.127"></a><span id="l192.127">  *                            with the data.</span>
<a href="#l192.128"></a><span id="l192.128">  * @param expectedName  Function returning the expected value of</span>
<a href="#l192.129"></a><span id="l192.129">  *                      nsIAccessible.name for the DOM element in question</span>
<a href="#l192.130"></a><span id="l192.130">  * @param expectedRole the expected value for nsIAccessible.role</span>
<a href="#l192.131"></a><span id="l192.131" class="difflineat">@@ -378,39 +373,39 @@ let gAccService = Cc[&quot;@mozilla.org/acces</span>
<a href="#l192.132"></a><span id="l192.132">  * do the right thing with the given message header.</span>
<a href="#l192.133"></a><span id="l192.133">  *</span>
<a href="#l192.134"></a><span id="l192.134">  * @param {Object} aHeaderInfo  Information about how to do the verification;</span>
<a href="#l192.135"></a><span id="l192.135">  *                              See the comments above the headersToTest array</span>
<a href="#l192.136"></a><span id="l192.136">  *                              for details.</span>
<a href="#l192.137"></a><span id="l192.137">  */</span>
<a href="#l192.138"></a><span id="l192.138"> function verify_header_a11y(aHeaderInfo) {</span>
<a href="#l192.139"></a><span id="l192.139">   let headerValueElement = aHeaderInfo.headerValueElement(mc);</span>
<a href="#l192.140"></a><span id="l192.140" class="difflineminus">-  assert_not_equals(</span>
<a href="#l192.141"></a><span id="l192.141" class="difflineplus">+  Assert.notEqual(</span>
<a href="#l192.142"></a><span id="l192.142">     headerValueElement,</span>
<a href="#l192.143"></a><span id="l192.143">     null,</span>
<a href="#l192.144"></a><span id="l192.144">     `element not found for header '${aHeaderInfo.headerName}'`</span>
<a href="#l192.145"></a><span id="l192.145">   );</span>
<a href="#l192.146"></a><span id="l192.146"> </span>
<a href="#l192.147"></a><span id="l192.147">   let headerAccessible;</span>
<a href="#l192.148"></a><span id="l192.148">   mc.waitFor(</span>
<a href="#l192.149"></a><span id="l192.149">     () =&gt;</span>
<a href="#l192.150"></a><span id="l192.150">       (headerAccessible = gAccService.getAccessibleFor(headerValueElement)) !=</span>
<a href="#l192.151"></a><span id="l192.151">       null,</span>
<a href="#l192.152"></a><span id="l192.152">     `didn't find accessible element for header '${aHeaderInfo.headerName}'`</span>
<a href="#l192.153"></a><span id="l192.153">   );</span>
<a href="#l192.154"></a><span id="l192.154"> </span>
<a href="#l192.155"></a><span id="l192.155" class="difflineminus">-  assert_equals(</span>
<a href="#l192.156"></a><span id="l192.156" class="difflineplus">+  Assert.equal(</span>
<a href="#l192.157"></a><span id="l192.157">     headerAccessible.role,</span>
<a href="#l192.158"></a><span id="l192.158">     aHeaderInfo.expectedRole,</span>
<a href="#l192.159"></a><span id="l192.159">     `role for ${aHeaderInfo.headerName} was ${headerAccessible.role}; ` +</span>
<a href="#l192.160"></a><span id="l192.160">       `should have been ${aHeaderInfo.expectedRole}`</span>
<a href="#l192.161"></a><span id="l192.161">   );</span>
<a href="#l192.162"></a><span id="l192.162"> </span>
<a href="#l192.163"></a><span id="l192.163">   let expectedName = aHeaderInfo.expectedName(mc, headerValueElement);</span>
<a href="#l192.164"></a><span id="l192.164" class="difflineminus">-  assert_equals(</span>
<a href="#l192.165"></a><span id="l192.165" class="difflineplus">+  Assert.equal(</span>
<a href="#l192.166"></a><span id="l192.166">     headerAccessible.name,</span>
<a href="#l192.167"></a><span id="l192.167">     expectedName,</span>
<a href="#l192.168"></a><span id="l192.168">     `headerAccessible.name for ${aHeaderInfo.headerName} ` +</span>
<a href="#l192.169"></a><span id="l192.169">       `was '${headerAccessible.name}'; expected '${expectedName}'`</span>
<a href="#l192.170"></a><span id="l192.170">   );</span>
<a href="#l192.171"></a><span id="l192.171"> }</span>
<a href="#l192.172"></a><span id="l192.172"> </span>
<a href="#l192.173"></a><span id="l192.173"> /**</span>
<a href="#l192.174"></a><span id="l192.174" class="difflineat">@@ -421,35 +416,35 @@ function verify_header_a11y(aHeaderInfo)</span>
<a href="#l192.175"></a><span id="l192.175">  * nicely with, and the toggling of the &quot;more&quot; button on the cc field was</span>
<a href="#l192.176"></a><span id="l192.176">  * causing this test to fail on the cc element. Tests with accessibility</span>
<a href="#l192.177"></a><span id="l192.177">  * hardware/software showed that the code was working fine. Therefore the test</span>
<a href="#l192.178"></a><span id="l192.178">  * may be suspect.</span>
<a href="#l192.179"></a><span id="l192.179">  *</span>
<a href="#l192.180"></a><span id="l192.180">  * XXX The gInterestingMessage has no tags until after</span>
<a href="#l192.181"></a><span id="l192.181">  * test_add_tag_with_really_long_label, so ensure it runs after that one.</span>
<a href="#l192.182"></a><span id="l192.182">  */</span>
<a href="#l192.183"></a><span id="l192.183" class="difflineminus">-function test_a11y_attrs() {</span>
<a href="#l192.184"></a><span id="l192.184" class="difflineplus">+add_task(function test_a11y_attrs() {</span>
<a href="#l192.185"></a><span id="l192.185">   be_in_folder(folder);</span>
<a href="#l192.186"></a><span id="l192.186"> </span>
<a href="#l192.187"></a><span id="l192.187">   // Convert the SyntheticMessage gInterestingMessage into an actual</span>
<a href="#l192.188"></a><span id="l192.188">   // nsIMsgDBHdr XPCOM message.</span>
<a href="#l192.189"></a><span id="l192.189">   let hdr = folder.msgDatabase.getMsgHdrForMessageID(</span>
<a href="#l192.190"></a><span id="l192.190">     gInterestingMessage.messageId</span>
<a href="#l192.191"></a><span id="l192.191">   );</span>
<a href="#l192.192"></a><span id="l192.192"> </span>
<a href="#l192.193"></a><span id="l192.193">   // select and open the interesting message</span>
<a href="#l192.194"></a><span id="l192.194">   let curMessage = select_click_row(mc.dbView.findIndexOfMsgHdr(hdr, false));</span>
<a href="#l192.195"></a><span id="l192.195"> </span>
<a href="#l192.196"></a><span id="l192.196">   // make sure it loads</span>
<a href="#l192.197"></a><span id="l192.197">   assert_selected_and_displayed(mc, curMessage);</span>
<a href="#l192.198"></a><span id="l192.198"> </span>
<a href="#l192.199"></a><span id="l192.199">   headersToTest.forEach(verify_header_a11y);</span>
<a href="#l192.200"></a><span id="l192.200" class="difflineminus">-}</span>
<a href="#l192.201"></a><span id="l192.201" class="difflineplus">+}).skip(); // disabled for now, see bug 1489748</span>
<a href="#l192.202"></a><span id="l192.202"> </span>
<a href="#l192.203"></a><span id="l192.203" class="difflineminus">-function test_more_button_with_many_recipients() {</span>
<a href="#l192.204"></a><span id="l192.204" class="difflineplus">+add_task(function test_more_button_with_many_recipients() {</span>
<a href="#l192.205"></a><span id="l192.205">   // Start on the interesting message.</span>
<a href="#l192.206"></a><span id="l192.206">   let curMessage = select_click_row(0);</span>
<a href="#l192.207"></a><span id="l192.207"> </span>
<a href="#l192.208"></a><span id="l192.208">   // make sure it loads</span>
<a href="#l192.209"></a><span id="l192.209">   wait_for_message_display_completion(mc);</span>
<a href="#l192.210"></a><span id="l192.210">   assert_selected_and_displayed(mc, curMessage);</span>
<a href="#l192.211"></a><span id="l192.211"> </span>
<a href="#l192.212"></a><span id="l192.212">   // Check the mode of the header.</span>
<a href="#l192.213"></a><span id="l192.213" class="difflineat">@@ -482,56 +477,56 @@ function test_more_button_with_many_reci</span>
<a href="#l192.214"></a><span id="l192.214">     throw new Error(</span>
<a href="#l192.215"></a><span id="l192.215">       &quot;Header Mode changed from &quot; +</span>
<a href="#l192.216"></a><span id="l192.216">         previousHeaderMode +</span>
<a href="#l192.217"></a><span id="l192.217">         &quot; to &quot; +</span>
<a href="#l192.218"></a><span id="l192.218">         headerBox.node.getAttribute(&quot;show_header_mode&quot;) +</span>
<a href="#l192.219"></a><span id="l192.219">         &quot; and didn't change back.&quot;</span>
<a href="#l192.220"></a><span id="l192.220">     );</span>
<a href="#l192.221"></a><span id="l192.221">   }</span>
<a href="#l192.222"></a><span id="l192.222" class="difflineminus">-}</span>
<a href="#l192.223"></a><span id="l192.223" class="difflineplus">+});</span>
<a href="#l192.224"></a><span id="l192.224"> </span>
<a href="#l192.225"></a><span id="l192.225"> /**</span>
<a href="#l192.226"></a><span id="l192.226">  * Test that we can open up the inline contact editor when we</span>
<a href="#l192.227"></a><span id="l192.227">  * click on the star.</span>
<a href="#l192.228"></a><span id="l192.228">  */</span>
<a href="#l192.229"></a><span id="l192.229" class="difflineminus">-function test_clicking_star_opens_inline_contact_editor() {</span>
<a href="#l192.230"></a><span id="l192.230" class="difflineplus">+add_task(function test_clicking_star_opens_inline_contact_editor() {</span>
<a href="#l192.231"></a><span id="l192.231">   // Make sure we're in the right folder</span>
<a href="#l192.232"></a><span id="l192.232">   be_in_folder(folder);</span>
<a href="#l192.233"></a><span id="l192.233">   // Add a new message</span>
<a href="#l192.234"></a><span id="l192.234">   let msg = create_message();</span>
<a href="#l192.235"></a><span id="l192.235">   add_message_to_folder(folder, msg);</span>
<a href="#l192.236"></a><span id="l192.236">   // Open the latest message</span>
<a href="#l192.237"></a><span id="l192.237">   select_click_row(-1);</span>
<a href="#l192.238"></a><span id="l192.238">   wait_for_message_display_completion(mc);</span>
<a href="#l192.239"></a><span id="l192.239">   // Make sure the star is clicked, and we add the</span>
<a href="#l192.240"></a><span id="l192.240">   // new contact to our address book</span>
<a href="#l192.241"></a><span id="l192.241">   let toDescription = mc.window.document.getElementById(&quot;expandedtoBox&quot;)</span>
<a href="#l192.242"></a><span id="l192.242">     .emailAddresses;</span>
<a href="#l192.243"></a><span id="l192.243"> </span>
<a href="#l192.244"></a><span id="l192.244">   // Ensure that the inline contact editing panel is not open</span>
<a href="#l192.245"></a><span id="l192.245">   let contactPanel = mc.eid(&quot;editContactPanel&quot;).getNode();</span>
<a href="#l192.246"></a><span id="l192.246" class="difflineminus">-  assert_not_equals(contactPanel.state, &quot;open&quot;);</span>
<a href="#l192.247"></a><span id="l192.247" class="difflineplus">+  Assert.notEqual(contactPanel.state, &quot;open&quot;);</span>
<a href="#l192.248"></a><span id="l192.248">   subtest_more_widget_star_click(toDescription);</span>
<a href="#l192.249"></a><span id="l192.249"> </span>
<a href="#l192.250"></a><span id="l192.250">   // Ok, if we're here, then the star has been clicked, and</span>
<a href="#l192.251"></a><span id="l192.251">   // the contact has been added to our AB.</span>
<a href="#l192.252"></a><span id="l192.252">   let addrs = toDescription.getElementsByTagName(&quot;mail-emailaddress&quot;);</span>
<a href="#l192.253"></a><span id="l192.253">   let lastAddr = get_last_visible_address(addrs);</span>
<a href="#l192.254"></a><span id="l192.254"> </span>
<a href="#l192.255"></a><span id="l192.255">   // Click on the star, and ensure that the inline contact</span>
<a href="#l192.256"></a><span id="l192.256">   // editing panel opens</span>
<a href="#l192.257"></a><span id="l192.257">   mc.click(getElement(lastAddr, &quot;.emailStar&quot;));</span>
<a href="#l192.258"></a><span id="l192.258">   mc.waitFor(</span>
<a href="#l192.259"></a><span id="l192.259">     () =&gt; contactPanel.state == &quot;open&quot;,</span>
<a href="#l192.260"></a><span id="l192.260">     () =&gt;</span>
<a href="#l192.261"></a><span id="l192.261">       &quot;Timeout waiting for contactPanel to open; state=&quot; + contactPanel.state</span>
<a href="#l192.262"></a><span id="l192.262">   );</span>
<a href="#l192.263"></a><span id="l192.263">   contactPanel.hidePopup();</span>
<a href="#l192.264"></a><span id="l192.264" class="difflineminus">-}</span>
<a href="#l192.265"></a><span id="l192.265" class="difflineplus">+});</span>
<a href="#l192.266"></a><span id="l192.266"> </span>
<a href="#l192.267"></a><span id="l192.267"> /**</span>
<a href="#l192.268"></a><span id="l192.268">  * Ensure that the specified element is visible/hidden</span>
<a href="#l192.269"></a><span id="l192.269">  *</span>
<a href="#l192.270"></a><span id="l192.270">  * @param id the id of the element to check</span>
<a href="#l192.271"></a><span id="l192.271">  * @param visible true if the element should be visible, false otherwise</span>
<a href="#l192.272"></a><span id="l192.272">  */</span>
<a href="#l192.273"></a><span id="l192.273"> function assert_shown(id, visible) {</span>
<a href="#l192.274"></a><span id="l192.274" class="difflineat">@@ -540,17 +535,17 @@ function assert_shown(id, visible) {</span>
<a href="#l192.275"></a><span id="l192.275">       '&quot;' + id + '&quot; should be ' + (visible ? &quot;visible&quot; : &quot;hidden&quot;)</span>
<a href="#l192.276"></a><span id="l192.276">     );</span>
<a href="#l192.277"></a><span id="l192.277">   }</span>
<a href="#l192.278"></a><span id="l192.278"> }</span>
<a href="#l192.279"></a><span id="l192.279"> </span>
<a href="#l192.280"></a><span id="l192.280"> /**</span>
<a href="#l192.281"></a><span id="l192.281">  * Test that clicking references context menu works properly.</span>
<a href="#l192.282"></a><span id="l192.282">  */</span>
<a href="#l192.283"></a><span id="l192.283" class="difflineminus">-function test_msg_id_context_menu() {</span>
<a href="#l192.284"></a><span id="l192.284" class="difflineplus">+add_task(function test_msg_id_context_menu() {</span>
<a href="#l192.285"></a><span id="l192.285">   Services.prefs.setBoolPref(&quot;mailnews.headers.showReferences&quot;, true);</span>
<a href="#l192.286"></a><span id="l192.286"> </span>
<a href="#l192.287"></a><span id="l192.287">   // Add a new message</span>
<a href="#l192.288"></a><span id="l192.288">   let msg = create_message({</span>
<a href="#l192.289"></a><span id="l192.289">     clobberHeaders: {</span>
<a href="#l192.290"></a><span id="l192.290">       References:</span>
<a href="#l192.291"></a><span id="l192.291">         &quot;&lt;4880C986@example.com&gt; &lt;4880CAB2@example.com&gt; &lt;4880CC76@example.com&gt;&quot;,</span>
<a href="#l192.292"></a><span id="l192.292">     },</span>
<a href="#l192.293"></a><span id="l192.293" class="difflineat">@@ -568,146 +563,152 @@ function test_msg_id_context_menu() {</span>
<a href="#l192.294"></a><span id="l192.294">   // Ensure Open Message For ID is shown... and that Open Browser With Message-ID</span>
<a href="#l192.295"></a><span id="l192.295">   // isn't shown.</span>
<a href="#l192.296"></a><span id="l192.296">   assert_shown(&quot;messageIdContext-openMessageForMsgId&quot;, true);</span>
<a href="#l192.297"></a><span id="l192.297">   assert_shown(&quot;messageIdContext-openBrowserWithMsgId&quot;, false);</span>
<a href="#l192.298"></a><span id="l192.298"> </span>
<a href="#l192.299"></a><span id="l192.299">   close_popup(mc, mc.eid(&quot;messageIdContext&quot;));</span>
<a href="#l192.300"></a><span id="l192.300"> </span>
<a href="#l192.301"></a><span id="l192.301">   Services.prefs.setBoolPref(&quot;mailnews.headers.showReferences&quot;, false);</span>
<a href="#l192.302"></a><span id="l192.302" class="difflineminus">-}</span>
<a href="#l192.303"></a><span id="l192.303" class="difflineplus">+});</span>
<a href="#l192.304"></a><span id="l192.304"> </span>
<a href="#l192.305"></a><span id="l192.305"> /**</span>
<a href="#l192.306"></a><span id="l192.306">  * Test that if a contact belongs to a mailing list within their</span>
<a href="#l192.307"></a><span id="l192.307">  * address book, then the inline contact editor will not allow</span>
<a href="#l192.308"></a><span id="l192.308">  * the user to change what address book the contact belongs to.</span>
<a href="#l192.309"></a><span id="l192.309">  * The editor should also show a message to explain why the</span>
<a href="#l192.310"></a><span id="l192.310">  * contact cannot be moved.</span>
<a href="#l192.311"></a><span id="l192.311">  */</span>
<a href="#l192.312"></a><span id="l192.312" class="difflineminus">-function test_address_book_switch_disabled_on_contact_in_mailing_list() {</span>
<a href="#l192.313"></a><span id="l192.313" class="difflineminus">-  const MAILING_LIST_DIRNAME = &quot;Some Mailing List&quot;;</span>
<a href="#l192.314"></a><span id="l192.314" class="difflineminus">-  const ADDRESS_BOOK_NAME = &quot;Some Address Book&quot;;</span>
<a href="#l192.315"></a><span id="l192.315" class="difflineminus">-  // Add a new message</span>
<a href="#l192.316"></a><span id="l192.316" class="difflineminus">-  let msg = create_message();</span>
<a href="#l192.317"></a><span id="l192.317" class="difflineminus">-  add_message_to_folder(folder, msg);</span>
<a href="#l192.318"></a><span id="l192.318" class="difflineplus">+add_task(</span>
<a href="#l192.319"></a><span id="l192.319" class="difflineplus">+  function test_address_book_switch_disabled_on_contact_in_mailing_list() {</span>
<a href="#l192.320"></a><span id="l192.320" class="difflineplus">+    const MAILING_LIST_DIRNAME = &quot;Some Mailing List&quot;;</span>
<a href="#l192.321"></a><span id="l192.321" class="difflineplus">+    const ADDRESS_BOOK_NAME = &quot;Some Address Book&quot;;</span>
<a href="#l192.322"></a><span id="l192.322" class="difflineplus">+    // Add a new message</span>
<a href="#l192.323"></a><span id="l192.323" class="difflineplus">+    let msg = create_message();</span>
<a href="#l192.324"></a><span id="l192.324" class="difflineplus">+    add_message_to_folder(folder, msg);</span>
<a href="#l192.325"></a><span id="l192.325"> </span>
<a href="#l192.326"></a><span id="l192.326" class="difflineminus">-  // Make sure we're in the right folder</span>
<a href="#l192.327"></a><span id="l192.327" class="difflineminus">-  be_in_folder(folder);</span>
<a href="#l192.328"></a><span id="l192.328" class="difflineplus">+    // Make sure we're in the right folder</span>
<a href="#l192.329"></a><span id="l192.329" class="difflineplus">+    be_in_folder(folder);</span>
<a href="#l192.330"></a><span id="l192.330" class="difflineplus">+</span>
<a href="#l192.331"></a><span id="l192.331" class="difflineplus">+    // Open the latest message</span>
<a href="#l192.332"></a><span id="l192.332" class="difflineplus">+    select_click_row(-1);</span>
<a href="#l192.333"></a><span id="l192.333"> </span>
<a href="#l192.334"></a><span id="l192.334" class="difflineminus">-  // Open the latest message</span>
<a href="#l192.335"></a><span id="l192.335" class="difflineminus">-  select_click_row(-1);</span>
<a href="#l192.336"></a><span id="l192.336" class="difflineplus">+    // Make sure the star is clicked, and we add the</span>
<a href="#l192.337"></a><span id="l192.337" class="difflineplus">+    // new contact to our address book</span>
<a href="#l192.338"></a><span id="l192.338" class="difflineplus">+    let toDescription = mc.window.document.getElementById(&quot;expandedtoBox&quot;)</span>
<a href="#l192.339"></a><span id="l192.339" class="difflineplus">+      .emailAddresses;</span>
<a href="#l192.340"></a><span id="l192.340"> </span>
<a href="#l192.341"></a><span id="l192.341" class="difflineminus">-  // Make sure the star is clicked, and we add the</span>
<a href="#l192.342"></a><span id="l192.342" class="difflineminus">-  // new contact to our address book</span>
<a href="#l192.343"></a><span id="l192.343" class="difflineminus">-  let toDescription = mc.window.document.getElementById(&quot;expandedtoBox&quot;)</span>
<a href="#l192.344"></a><span id="l192.344" class="difflineminus">-    .emailAddresses;</span>
<a href="#l192.345"></a><span id="l192.345" class="difflineplus">+    // Ensure that the inline contact editing panel is not open</span>
<a href="#l192.346"></a><span id="l192.346" class="difflineplus">+    let contactPanel = mc.eid(&quot;editContactPanel&quot;).getNode();</span>
<a href="#l192.347"></a><span id="l192.347" class="difflineplus">+    Assert.notEqual(contactPanel.state, &quot;open&quot;);</span>
<a href="#l192.348"></a><span id="l192.348"> </span>
<a href="#l192.349"></a><span id="l192.349" class="difflineminus">-  // Ensure that the inline contact editing panel is not open</span>
<a href="#l192.350"></a><span id="l192.350" class="difflineminus">-  let contactPanel = mc.eid(&quot;editContactPanel&quot;).getNode();</span>
<a href="#l192.351"></a><span id="l192.351" class="difflineminus">-  assert_not_equals(contactPanel.state, &quot;open&quot;);</span>
<a href="#l192.352"></a><span id="l192.352" class="difflineplus">+    subtest_more_widget_star_click(toDescription);</span>
<a href="#l192.353"></a><span id="l192.353"> </span>
<a href="#l192.354"></a><span id="l192.354" class="difflineminus">-  subtest_more_widget_star_click(toDescription);</span>
<a href="#l192.355"></a><span id="l192.355" class="difflineplus">+    // Ok, if we're here, then the star has been clicked, and</span>
<a href="#l192.356"></a><span id="l192.356" class="difflineplus">+    // the contact has been added to our AB.</span>
<a href="#l192.357"></a><span id="l192.357" class="difflineplus">+    let addrs = toDescription.getElementsByTagName(&quot;mail-emailaddress&quot;);</span>
<a href="#l192.358"></a><span id="l192.358" class="difflineplus">+    let lastAddr = get_last_visible_address(addrs);</span>
<a href="#l192.359"></a><span id="l192.359"> </span>
<a href="#l192.360"></a><span id="l192.360" class="difflineminus">-  // Ok, if we're here, then the star has been clicked, and</span>
<a href="#l192.361"></a><span id="l192.361" class="difflineminus">-  // the contact has been added to our AB.</span>
<a href="#l192.362"></a><span id="l192.362" class="difflineminus">-  let addrs = toDescription.getElementsByTagName(&quot;mail-emailaddress&quot;);</span>
<a href="#l192.363"></a><span id="l192.363" class="difflineminus">-  let lastAddr = get_last_visible_address(addrs);</span>
<a href="#l192.364"></a><span id="l192.364" class="difflineplus">+    // Click on the star, and ensure that the inline contact</span>
<a href="#l192.365"></a><span id="l192.365" class="difflineplus">+    // editing panel opens</span>
<a href="#l192.366"></a><span id="l192.366" class="difflineplus">+    mc.click(getElement(lastAddr, &quot;.emailStar&quot;));</span>
<a href="#l192.367"></a><span id="l192.367" class="difflineplus">+    mc.waitFor(</span>
<a href="#l192.368"></a><span id="l192.368" class="difflineplus">+      () =&gt; contactPanel.state == &quot;open&quot;,</span>
<a href="#l192.369"></a><span id="l192.369" class="difflineplus">+      () =&gt;</span>
<a href="#l192.370"></a><span id="l192.370" class="difflineplus">+        &quot;Timeout waiting for contactPanel to open; state=&quot; + contactPanel.state</span>
<a href="#l192.371"></a><span id="l192.371" class="difflineplus">+    );</span>
<a href="#l192.372"></a><span id="l192.372"> </span>
<a href="#l192.373"></a><span id="l192.373" class="difflineminus">-  // Click on the star, and ensure that the inline contact</span>
<a href="#l192.374"></a><span id="l192.374" class="difflineminus">-  // editing panel opens</span>
<a href="#l192.375"></a><span id="l192.375" class="difflineminus">-  mc.click(getElement(lastAddr, &quot;.emailStar&quot;));</span>
<a href="#l192.376"></a><span id="l192.376" class="difflineminus">-  mc.waitFor(</span>
<a href="#l192.377"></a><span id="l192.377" class="difflineminus">-    () =&gt; contactPanel.state == &quot;open&quot;,</span>
<a href="#l192.378"></a><span id="l192.378" class="difflineminus">-    () =&gt;</span>
<a href="#l192.379"></a><span id="l192.379" class="difflineminus">-      &quot;Timeout waiting for contactPanel to open; state=&quot; + contactPanel.state</span>
<a href="#l192.380"></a><span id="l192.380" class="difflineminus">-  );</span>
<a href="#l192.381"></a><span id="l192.381" class="difflineplus">+    let abDrop = mc.eid(&quot;editContactAddressBookList&quot;).getNode();</span>
<a href="#l192.382"></a><span id="l192.382" class="difflineplus">+    let warningMsg = mc.eid(&quot;contactMoveDisabledText&quot;).getNode();</span>
<a href="#l192.383"></a><span id="l192.383"> </span>
<a href="#l192.384"></a><span id="l192.384" class="difflineminus">-  let abDrop = mc.eid(&quot;editContactAddressBookList&quot;).getNode();</span>
<a href="#l192.385"></a><span id="l192.385" class="difflineminus">-  let warningMsg = mc.eid(&quot;contactMoveDisabledText&quot;).getNode();</span>
<a href="#l192.386"></a><span id="l192.386" class="difflineplus">+    // Ensure that the address book dropdown is not disabled</span>
<a href="#l192.387"></a><span id="l192.387" class="difflineplus">+    Assert.ok(!abDrop.disabled);</span>
<a href="#l192.388"></a><span id="l192.388" class="difflineplus">+    // We should not be displaying any warning</span>
<a href="#l192.389"></a><span id="l192.389" class="difflineplus">+    Assert.ok(warningMsg.collapsed);</span>
<a href="#l192.390"></a><span id="l192.390"> </span>
<a href="#l192.391"></a><span id="l192.391" class="difflineminus">-  // Ensure that the address book dropdown is not disabled</span>
<a href="#l192.392"></a><span id="l192.392" class="difflineminus">-  assert_true(!abDrop.disabled);</span>
<a href="#l192.393"></a><span id="l192.393" class="difflineminus">-  // We should not be displaying any warning</span>
<a href="#l192.394"></a><span id="l192.394" class="difflineminus">-  assert_true(warningMsg.collapsed);</span>
<a href="#l192.395"></a><span id="l192.395" class="difflineplus">+    // Now close the popup</span>
<a href="#l192.396"></a><span id="l192.396" class="difflineplus">+    contactPanel.hidePopup();</span>
<a href="#l192.397"></a><span id="l192.397"> </span>
<a href="#l192.398"></a><span id="l192.398" class="difflineminus">-  // Now close the popup</span>
<a href="#l192.399"></a><span id="l192.399" class="difflineminus">-  contactPanel.hidePopup();</span>
<a href="#l192.400"></a><span id="l192.400" class="difflineplus">+    // For the contact that was added, create a mailing list in the</span>
<a href="#l192.401"></a><span id="l192.401" class="difflineplus">+    // address book it resides in, and then add that contact to the</span>
<a href="#l192.402"></a><span id="l192.402" class="difflineplus">+    // mailing list</span>
<a href="#l192.403"></a><span id="l192.403" class="difflineplus">+    addrs = toDescription.getElementsByTagName(&quot;mail-emailaddress&quot;);</span>
<a href="#l192.404"></a><span id="l192.404" class="difflineplus">+    let targetAddr = get_last_visible_address(addrs).getAttribute(</span>
<a href="#l192.405"></a><span id="l192.405" class="difflineplus">+      &quot;emailAddress&quot;</span>
<a href="#l192.406"></a><span id="l192.406" class="difflineplus">+    );</span>
<a href="#l192.407"></a><span id="l192.407"> </span>
<a href="#l192.408"></a><span id="l192.408" class="difflineminus">-  // For the contact that was added, create a mailing list in the</span>
<a href="#l192.409"></a><span id="l192.409" class="difflineminus">-  // address book it resides in, and then add that contact to the</span>
<a href="#l192.410"></a><span id="l192.410" class="difflineminus">-  // mailing list</span>
<a href="#l192.411"></a><span id="l192.411" class="difflineminus">-  addrs = toDescription.getElementsByTagName(&quot;mail-emailaddress&quot;);</span>
<a href="#l192.412"></a><span id="l192.412" class="difflineminus">-  let targetAddr = get_last_visible_address(addrs).getAttribute(&quot;emailAddress&quot;);</span>
<a href="#l192.413"></a><span id="l192.413" class="difflineminus">-</span>
<a href="#l192.414"></a><span id="l192.414" class="difflineminus">-  let cards = get_cards_in_all_address_books_for_email(targetAddr);</span>
<a href="#l192.415"></a><span id="l192.415" class="difflineplus">+    let cards = get_cards_in_all_address_books_for_email(targetAddr);</span>
<a href="#l192.416"></a><span id="l192.416"> </span>
<a href="#l192.417"></a><span id="l192.417" class="difflineminus">-  // There should be only one copy of this email address</span>
<a href="#l192.418"></a><span id="l192.418" class="difflineminus">-  // in the address books.</span>
<a href="#l192.419"></a><span id="l192.419" class="difflineminus">-  assert_equals(cards.length, 1);</span>
<a href="#l192.420"></a><span id="l192.420" class="difflineminus">-  let card = cards[0];</span>
<a href="#l192.421"></a><span id="l192.421" class="difflineplus">+    // There should be only one copy of this email address</span>
<a href="#l192.422"></a><span id="l192.422" class="difflineplus">+    // in the address books.</span>
<a href="#l192.423"></a><span id="l192.423" class="difflineplus">+    Assert.equal(cards.length, 1);</span>
<a href="#l192.424"></a><span id="l192.424" class="difflineplus">+    let card = cards[0];</span>
<a href="#l192.425"></a><span id="l192.425"> </span>
<a href="#l192.426"></a><span id="l192.426" class="difflineminus">-  // Remove the card from any of the address books</span>
<a href="#l192.427"></a><span id="l192.427" class="difflineminus">-  ensure_no_card_exists(targetAddr);</span>
<a href="#l192.428"></a><span id="l192.428" class="difflineplus">+    // Remove the card from any of the address books</span>
<a href="#l192.429"></a><span id="l192.429" class="difflineplus">+    ensure_no_card_exists(targetAddr);</span>
<a href="#l192.430"></a><span id="l192.430"> </span>
<a href="#l192.431"></a><span id="l192.431" class="difflineminus">-  // Add the card to a new address book, and insert it</span>
<a href="#l192.432"></a><span id="l192.432" class="difflineminus">-  // into a mailing list under that address book</span>
<a href="#l192.433"></a><span id="l192.433" class="difflineminus">-  let ab = create_address_book(ADDRESS_BOOK_NAME);</span>
<a href="#l192.434"></a><span id="l192.434" class="difflineminus">-  ab.dropCard(card, false);</span>
<a href="#l192.435"></a><span id="l192.435" class="difflineminus">-  let ml = create_mailing_list(MAILING_LIST_DIRNAME);</span>
<a href="#l192.436"></a><span id="l192.436" class="difflineminus">-  ab.addMailList(ml);</span>
<a href="#l192.437"></a><span id="l192.437" class="difflineplus">+    // Add the card to a new address book, and insert it</span>
<a href="#l192.438"></a><span id="l192.438" class="difflineplus">+    // into a mailing list under that address book</span>
<a href="#l192.439"></a><span id="l192.439" class="difflineplus">+    let ab = create_address_book(ADDRESS_BOOK_NAME);</span>
<a href="#l192.440"></a><span id="l192.440" class="difflineplus">+    ab.dropCard(card, false);</span>
<a href="#l192.441"></a><span id="l192.441" class="difflineplus">+    let ml = create_mailing_list(MAILING_LIST_DIRNAME);</span>
<a href="#l192.442"></a><span id="l192.442" class="difflineplus">+    ab.addMailList(ml);</span>
<a href="#l192.443"></a><span id="l192.443"> </span>
<a href="#l192.444"></a><span id="l192.444" class="difflineminus">-  // Now we have to retrieve the mailing list from</span>
<a href="#l192.445"></a><span id="l192.445" class="difflineminus">-  // the address book, in order for us to add and</span>
<a href="#l192.446"></a><span id="l192.446" class="difflineminus">-  // delete cards from it.</span>
<a href="#l192.447"></a><span id="l192.447" class="difflineminus">-  ml = get_mailing_list_from_address_book(ab, MAILING_LIST_DIRNAME);</span>
<a href="#l192.448"></a><span id="l192.448" class="difflineminus">-  ml.addCard(card);</span>
<a href="#l192.449"></a><span id="l192.449" class="difflineplus">+    // Now we have to retrieve the mailing list from</span>
<a href="#l192.450"></a><span id="l192.450" class="difflineplus">+    // the address book, in order for us to add and</span>
<a href="#l192.451"></a><span id="l192.451" class="difflineplus">+    // delete cards from it.</span>
<a href="#l192.452"></a><span id="l192.452" class="difflineplus">+    ml = get_mailing_list_from_address_book(ab, MAILING_LIST_DIRNAME);</span>
<a href="#l192.453"></a><span id="l192.453" class="difflineplus">+    ml.addCard(card);</span>
<a href="#l192.454"></a><span id="l192.454"> </span>
<a href="#l192.455"></a><span id="l192.455" class="difflineminus">-  // Re-open the inline contact editing panel</span>
<a href="#l192.456"></a><span id="l192.456" class="difflineminus">-  mc.click(getElement(lastAddr, &quot;.emailStar&quot;));</span>
<a href="#l192.457"></a><span id="l192.457" class="difflineminus">-  mc.waitFor(</span>
<a href="#l192.458"></a><span id="l192.458" class="difflineminus">-    () =&gt; contactPanel.state == &quot;open&quot;,</span>
<a href="#l192.459"></a><span id="l192.459" class="difflineminus">-    () =&gt;</span>
<a href="#l192.460"></a><span id="l192.460" class="difflineminus">-      &quot;Timeout waiting for contactPanel to open; state=&quot; + contactPanel.state</span>
<a href="#l192.461"></a><span id="l192.461" class="difflineminus">-  );</span>
<a href="#l192.462"></a><span id="l192.462" class="difflineplus">+    // Re-open the inline contact editing panel</span>
<a href="#l192.463"></a><span id="l192.463" class="difflineplus">+    mc.click(getElement(lastAddr, &quot;.emailStar&quot;));</span>
<a href="#l192.464"></a><span id="l192.464" class="difflineplus">+    mc.waitFor(</span>
<a href="#l192.465"></a><span id="l192.465" class="difflineplus">+      () =&gt; contactPanel.state == &quot;open&quot;,</span>
<a href="#l192.466"></a><span id="l192.466" class="difflineplus">+      () =&gt;</span>
<a href="#l192.467"></a><span id="l192.467" class="difflineplus">+        &quot;Timeout waiting for contactPanel to open; state=&quot; + contactPanel.state</span>
<a href="#l192.468"></a><span id="l192.468" class="difflineplus">+    );</span>
<a href="#l192.469"></a><span id="l192.469"> </span>
<a href="#l192.470"></a><span id="l192.470" class="difflineminus">-  // The dropdown should be disabled now</span>
<a href="#l192.471"></a><span id="l192.471" class="difflineminus">-  assert_true(abDrop.disabled);</span>
<a href="#l192.472"></a><span id="l192.472" class="difflineminus">-  // We should be displaying a warning</span>
<a href="#l192.473"></a><span id="l192.473" class="difflineminus">-  assert_true(!warningMsg.collapsed);</span>
<a href="#l192.474"></a><span id="l192.474" class="difflineplus">+    // The dropdown should be disabled now</span>
<a href="#l192.475"></a><span id="l192.475" class="difflineplus">+    Assert.ok(abDrop.disabled);</span>
<a href="#l192.476"></a><span id="l192.476" class="difflineplus">+    // We should be displaying a warning</span>
<a href="#l192.477"></a><span id="l192.477" class="difflineplus">+    Assert.ok(!warningMsg.collapsed);</span>
<a href="#l192.478"></a><span id="l192.478"> </span>
<a href="#l192.479"></a><span id="l192.479" class="difflineminus">-  contactPanel.hidePopup();</span>
<a href="#l192.480"></a><span id="l192.480" class="difflineplus">+    contactPanel.hidePopup();</span>
<a href="#l192.481"></a><span id="l192.481"> </span>
<a href="#l192.482"></a><span id="l192.482" class="difflineminus">-  // And if we remove the contact from the mailing list, the</span>
<a href="#l192.483"></a><span id="l192.483" class="difflineminus">-  // warning should be gone and the address book switching</span>
<a href="#l192.484"></a><span id="l192.484" class="difflineminus">-  // menu re-enabled.</span>
<a href="#l192.485"></a><span id="l192.485" class="difflineplus">+    // And if we remove the contact from the mailing list, the</span>
<a href="#l192.486"></a><span id="l192.486" class="difflineplus">+    // warning should be gone and the address book switching</span>
<a href="#l192.487"></a><span id="l192.487" class="difflineplus">+    // menu re-enabled.</span>
<a href="#l192.488"></a><span id="l192.488"> </span>
<a href="#l192.489"></a><span id="l192.489" class="difflineminus">-  let cardArray = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l192.490"></a><span id="l192.490" class="difflineminus">-  cardArray.appendElement(card);</span>
<a href="#l192.491"></a><span id="l192.491" class="difflineminus">-  ml.deleteCards(cardArray);</span>
<a href="#l192.492"></a><span id="l192.492" class="difflineplus">+    let cardArray = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(</span>
<a href="#l192.493"></a><span id="l192.493" class="difflineplus">+      Ci.nsIMutableArray</span>
<a href="#l192.494"></a><span id="l192.494" class="difflineplus">+    );</span>
<a href="#l192.495"></a><span id="l192.495" class="difflineplus">+    cardArray.appendElement(card);</span>
<a href="#l192.496"></a><span id="l192.496" class="difflineplus">+    ml.deleteCards(cardArray);</span>
<a href="#l192.497"></a><span id="l192.497"> </span>
<a href="#l192.498"></a><span id="l192.498" class="difflineminus">-  // Re-open the inline contact editing panel</span>
<a href="#l192.499"></a><span id="l192.499" class="difflineminus">-  mc.click(getElement(lastAddr, &quot;.emailStar&quot;));</span>
<a href="#l192.500"></a><span id="l192.500" class="difflineminus">-  mc.waitFor(</span>
<a href="#l192.501"></a><span id="l192.501" class="difflineminus">-    () =&gt; contactPanel.state == &quot;open&quot;,</span>
<a href="#l192.502"></a><span id="l192.502" class="difflineminus">-    () =&gt;</span>
<a href="#l192.503"></a><span id="l192.503" class="difflineminus">-      &quot;Timeout waiting for contactPanel to open; state=&quot; + contactPanel.state</span>
<a href="#l192.504"></a><span id="l192.504" class="difflineminus">-  );</span>
<a href="#l192.505"></a><span id="l192.505" class="difflineplus">+    // Re-open the inline contact editing panel</span>
<a href="#l192.506"></a><span id="l192.506" class="difflineplus">+    mc.click(getElement(lastAddr, &quot;.emailStar&quot;));</span>
<a href="#l192.507"></a><span id="l192.507" class="difflineplus">+    mc.waitFor(</span>
<a href="#l192.508"></a><span id="l192.508" class="difflineplus">+      () =&gt; contactPanel.state == &quot;open&quot;,</span>
<a href="#l192.509"></a><span id="l192.509" class="difflineplus">+      () =&gt;</span>
<a href="#l192.510"></a><span id="l192.510" class="difflineplus">+        &quot;Timeout waiting for contactPanel to open; state=&quot; + contactPanel.state</span>
<a href="#l192.511"></a><span id="l192.511" class="difflineplus">+    );</span>
<a href="#l192.512"></a><span id="l192.512"> </span>
<a href="#l192.513"></a><span id="l192.513" class="difflineminus">-  // Ensure that the address book dropdown is not disabled</span>
<a href="#l192.514"></a><span id="l192.514" class="difflineminus">-  assert_true(!abDrop.disabled);</span>
<a href="#l192.515"></a><span id="l192.515" class="difflineminus">-  // We should not be displaying any warning</span>
<a href="#l192.516"></a><span id="l192.516" class="difflineminus">-  assert_true(warningMsg.collapsed);</span>
<a href="#l192.517"></a><span id="l192.517" class="difflineplus">+    // Ensure that the address book dropdown is not disabled</span>
<a href="#l192.518"></a><span id="l192.518" class="difflineplus">+    Assert.ok(!abDrop.disabled);</span>
<a href="#l192.519"></a><span id="l192.519" class="difflineplus">+    // We should not be displaying any warning</span>
<a href="#l192.520"></a><span id="l192.520" class="difflineplus">+    Assert.ok(warningMsg.collapsed);</span>
<a href="#l192.521"></a><span id="l192.521"> </span>
<a href="#l192.522"></a><span id="l192.522" class="difflineminus">-  contactPanel.hidePopup();</span>
<a href="#l192.523"></a><span id="l192.523" class="difflineminus">-}</span>
<a href="#l192.524"></a><span id="l192.524" class="difflineplus">+    contactPanel.hidePopup();</span>
<a href="#l192.525"></a><span id="l192.525" class="difflineplus">+  }</span>
<a href="#l192.526"></a><span id="l192.526" class="difflineplus">+);</span>
<a href="#l192.527"></a><span id="l192.527"> </span>
<a href="#l192.528"></a><span id="l192.528"> /**</span>
<a href="#l192.529"></a><span id="l192.529">  * Test that clicking the adding an address node adds it to the address book.</span>
<a href="#l192.530"></a><span id="l192.530">  */</span>
<a href="#l192.531"></a><span id="l192.531" class="difflineminus">-function test_add_contact_from_context_menu() {</span>
<a href="#l192.532"></a><span id="l192.532" class="difflineplus">+add_task(function test_add_contact_from_context_menu() {</span>
<a href="#l192.533"></a><span id="l192.533">   // Click the contact to show the emailAddressPopup popup menu.</span>
<a href="#l192.534"></a><span id="l192.534">   mc.click(</span>
<a href="#l192.535"></a><span id="l192.535">     new elib.Elem(mc.e(&quot;expandedfromBox&quot;, { tagName: &quot;mail-emailaddress&quot; }))</span>
<a href="#l192.536"></a><span id="l192.536">   );</span>
<a href="#l192.537"></a><span id="l192.537"> </span>
<a href="#l192.538"></a><span id="l192.538">   var addToAddressBookItem = mc.window.document.getElementById(</span>
<a href="#l192.539"></a><span id="l192.539">     &quot;addToAddressBookItem&quot;</span>
<a href="#l192.540"></a><span id="l192.540">   );</span>
<a href="#l192.541"></a><span id="l192.541" class="difflineat">@@ -737,19 +738,19 @@ function test_add_contact_from_context_m</span>
<a href="#l192.542"></a><span id="l192.542">   );</span>
<a href="#l192.543"></a><span id="l192.543">   if (!addToAddressBookItem.hidden) {</span>
<a href="#l192.544"></a><span id="l192.544">     throw new Error(&quot;addToAddressBookItem is NOT hidden for known contact&quot;);</span>
<a href="#l192.545"></a><span id="l192.545">   }</span>
<a href="#l192.546"></a><span id="l192.546">   editContactItem = mc.window.document.getElementById(&quot;editContactItem&quot;);</span>
<a href="#l192.547"></a><span id="l192.547">   if (editContactItem.hidden) {</span>
<a href="#l192.548"></a><span id="l192.548">     throw new Error(&quot;editContactItem is hidden for known contact&quot;);</span>
<a href="#l192.549"></a><span id="l192.549">   }</span>
<a href="#l192.550"></a><span id="l192.550" class="difflineminus">-}</span>
<a href="#l192.551"></a><span id="l192.551" class="difflineplus">+});</span>
<a href="#l192.552"></a><span id="l192.552"> </span>
<a href="#l192.553"></a><span id="l192.553" class="difflineminus">-function test_that_msg_without_date_clears_previous_headers() {</span>
<a href="#l192.554"></a><span id="l192.554" class="difflineplus">+add_task(function test_that_msg_without_date_clears_previous_headers() {</span>
<a href="#l192.555"></a><span id="l192.555">   be_in_folder(folder);</span>
<a href="#l192.556"></a><span id="l192.556"> </span>
<a href="#l192.557"></a><span id="l192.557">   // create a message: with descritive subject</span>
<a href="#l192.558"></a><span id="l192.558">   let msg = create_message({ subject: &quot;this is without date&quot; });</span>
<a href="#l192.559"></a><span id="l192.559"> </span>
<a href="#l192.560"></a><span id="l192.560">   // ensure that this message doesn't have a Date header</span>
<a href="#l192.561"></a><span id="l192.561">   delete msg.headers.Date;</span>
<a href="#l192.562"></a><span id="l192.562"> </span>
<a href="#l192.563"></a><span id="l192.563" class="difflineat">@@ -770,17 +771,17 @@ function test_that_msg_without_date_clea</span>
<a href="#l192.564"></a><span id="l192.564">   // certain bugs in the display of this header could cause the collapse</span>
<a href="#l192.565"></a><span id="l192.565">   // never to have happened.</span>
<a href="#l192.566"></a><span id="l192.566">   if (!mc.e(&quot;expandednewsgroupsRow&quot;).hasAttribute(&quot;hidden&quot;)) {</span>
<a href="#l192.567"></a><span id="l192.567">     throw new Error(</span>
<a href="#l192.568"></a><span id="l192.568">       &quot;Expected &lt;row&gt; element for Newsgroups header to be &quot; +</span>
<a href="#l192.569"></a><span id="l192.569">         &quot;collapsed, but it wasn't\n!&quot;</span>
<a href="#l192.570"></a><span id="l192.570">     );</span>
<a href="#l192.571"></a><span id="l192.571">   }</span>
<a href="#l192.572"></a><span id="l192.572" class="difflineminus">-}</span>
<a href="#l192.573"></a><span id="l192.573" class="difflineplus">+});</span>
<a href="#l192.574"></a><span id="l192.574"> </span>
<a href="#l192.575"></a><span id="l192.575"> /**</span>
<a href="#l192.576"></a><span id="l192.576">  * Test various aspects of the (n more) widgetry.</span>
<a href="#l192.577"></a><span id="l192.577">  */</span>
<a href="#l192.578"></a><span id="l192.578"> function test_more_widget() {</span>
<a href="#l192.579"></a><span id="l192.579">   // generate message with 35 recips (effectively guarantees overflow for n=3)</span>
<a href="#l192.580"></a><span id="l192.580">   be_in_folder(folder);</span>
<a href="#l192.581"></a><span id="l192.581">   let msg = create_message({</span>
<a href="#l192.582"></a><span id="l192.582" class="difflineat">@@ -827,21 +828,22 @@ function test_more_widget() {</span>
<a href="#l192.583"></a><span id="l192.583">   wait_for_message_display_completion(mc);</span>
<a href="#l192.584"></a><span id="l192.584">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l192.585"></a><span id="l192.585">   subtest_more_button_tooltip(msg);</span>
<a href="#l192.586"></a><span id="l192.586">   Services.prefs.setIntPref(</span>
<a href="#l192.587"></a><span id="l192.587">     &quot;mailnews.headers.show_n_lines_before_more&quot;,</span>
<a href="#l192.588"></a><span id="l192.588">     showNLinesPref</span>
<a href="#l192.589"></a><span id="l192.589">   );</span>
<a href="#l192.590"></a><span id="l192.590"> }</span>
<a href="#l192.591"></a><span id="l192.591" class="difflineplus">+add_task(test_more_widget);</span>
<a href="#l192.592"></a><span id="l192.592"> </span>
<a href="#l192.593"></a><span id="l192.593"> /**</span>
<a href="#l192.594"></a><span id="l192.594">  * Test that all addresses are shown in show all header mode</span>
<a href="#l192.595"></a><span id="l192.595">  */</span>
<a href="#l192.596"></a><span id="l192.596" class="difflineminus">-function test_show_all_header_mode() {</span>
<a href="#l192.597"></a><span id="l192.597" class="difflineplus">+add_task(function test_show_all_header_mode() {</span>
<a href="#l192.598"></a><span id="l192.598">   // generate message with 35 recips (effectively guarantees overflow for n=3)</span>
<a href="#l192.599"></a><span id="l192.599">   be_in_folder(folder);</span>
<a href="#l192.600"></a><span id="l192.600">   let msg = create_message({</span>
<a href="#l192.601"></a><span id="l192.601">     toCount: 35,</span>
<a href="#l192.602"></a><span id="l192.602">     subject: &quot;many To addresses for test_show_all_header_mode&quot;,</span>
<a href="#l192.603"></a><span id="l192.603">   });</span>
<a href="#l192.604"></a><span id="l192.604"> </span>
<a href="#l192.605"></a><span id="l192.605">   // add the message to the end of the folder</span>
<a href="#l192.606"></a><span id="l192.606" class="difflineat">@@ -859,17 +861,17 @@ function test_show_all_header_mode() {</span>
<a href="#l192.607"></a><span id="l192.607">   let toDescription = mc.window.document.getElementById(&quot;expandedtoBox&quot;)</span>
<a href="#l192.608"></a><span id="l192.608">     .emailAddresses;</span>
<a href="#l192.609"></a><span id="l192.609"> </span>
<a href="#l192.610"></a><span id="l192.610">   change_to_header_normal_mode();</span>
<a href="#l192.611"></a><span id="l192.611">   subtest_more_widget_display(toDescription);</span>
<a href="#l192.612"></a><span id="l192.612">   subtest_change_to_all_header_mode(toDescription);</span>
<a href="#l192.613"></a><span id="l192.613">   change_to_header_normal_mode();</span>
<a href="#l192.614"></a><span id="l192.614">   subtest_more_widget_click(toDescription);</span>
<a href="#l192.615"></a><span id="l192.615" class="difflineminus">-}</span>
<a href="#l192.616"></a><span id="l192.616" class="difflineplus">+});</span>
<a href="#l192.617"></a><span id="l192.617"> </span>
<a href="#l192.618"></a><span id="l192.618"> function change_to_header_normal_mode() {</span>
<a href="#l192.619"></a><span id="l192.619">   // XXX Clicking on check menu items doesn't work in 1.4.1b1 (bug 474486)...</span>
<a href="#l192.620"></a><span id="l192.620">   //  mc.click(new elib.Elem(mc.menus.View.viewheadersmenu.viewnormalheaders));</span>
<a href="#l192.621"></a><span id="l192.621">   // ... so call the function instead.</span>
<a href="#l192.622"></a><span id="l192.622">   mc.window.MsgViewNormalHeaders();</span>
<a href="#l192.623"></a><span id="l192.623">   mc.sleep(0);</span>
<a href="#l192.624"></a><span id="l192.624"> }</span>
<a href="#l192.625"></a><span id="l192.625" class="difflineat">@@ -993,30 +995,30 @@ function subtest_more_widget_star_click(</span>
<a href="#l192.626"></a><span id="l192.626">     throw new Error(&quot;address not updated after clicking star&quot;);</span>
<a href="#l192.627"></a><span id="l192.627">   }</span>
<a href="#l192.628"></a><span id="l192.628"> }</span>
<a href="#l192.629"></a><span id="l192.629"> </span>
<a href="#l192.630"></a><span id="l192.630"> /**</span>
<a href="#l192.631"></a><span id="l192.631">  * Make sure the (more) widget hidden pref actually works with a</span>
<a href="#l192.632"></a><span id="l192.632">  * non-default value.</span>
<a href="#l192.633"></a><span id="l192.633">  */</span>
<a href="#l192.634"></a><span id="l192.634" class="difflineminus">-function test_more_widget_with_maxlines_of_3() {</span>
<a href="#l192.635"></a><span id="l192.635" class="difflineplus">+add_task(function test_more_widget_with_maxlines_of_3() {</span>
<a href="#l192.636"></a><span id="l192.636">   // set maxLines to 3</span>
<a href="#l192.637"></a><span id="l192.637">   Services.prefs.setIntPref(&quot;mailnews.headers.show_n_lines_before_more&quot;, 3);</span>
<a href="#l192.638"></a><span id="l192.638"> </span>
<a href="#l192.639"></a><span id="l192.639">   // call test_more_widget again</span>
<a href="#l192.640"></a><span id="l192.640">   // We need to look at the second last article in the display list.</span>
<a href="#l192.641"></a><span id="l192.641">   test_more_widget();</span>
<a href="#l192.642"></a><span id="l192.642" class="difflineminus">-}</span>
<a href="#l192.643"></a><span id="l192.643" class="difflineplus">+});</span>
<a href="#l192.644"></a><span id="l192.644"> </span>
<a href="#l192.645"></a><span id="l192.645"> /**</span>
<a href="#l192.646"></a><span id="l192.646">  * Make sure the (more) widget hidden pref also works with an</span>
<a href="#l192.647"></a><span id="l192.647">  * &quot;all&quot; (0) non-default value.</span>
<a href="#l192.648"></a><span id="l192.648">  */</span>
<a href="#l192.649"></a><span id="l192.649" class="difflineminus">-function test_more_widget_with_disabled_more() {</span>
<a href="#l192.650"></a><span id="l192.650" class="difflineplus">+add_task(function test_more_widget_with_disabled_more() {</span>
<a href="#l192.651"></a><span id="l192.651">   // set maxLines to 0</span>
<a href="#l192.652"></a><span id="l192.652">   Services.prefs.setIntPref(&quot;mailnews.headers.show_n_lines_before_more&quot;, 0);</span>
<a href="#l192.653"></a><span id="l192.653"> </span>
<a href="#l192.654"></a><span id="l192.654">   // generate message with 35 recips (effectively guarantees overflow for n=3)</span>
<a href="#l192.655"></a><span id="l192.655">   be_in_folder(folder);</span>
<a href="#l192.656"></a><span id="l192.656">   let msg = create_message({ toCount: 35 });</span>
<a href="#l192.657"></a><span id="l192.657"> </span>
<a href="#l192.658"></a><span id="l192.658">   // add the message to the end of the folder</span>
<a href="#l192.659"></a><span id="l192.659" class="difflineat">@@ -1043,24 +1045,24 @@ function test_more_widget_with_disabled_</span>
<a href="#l192.660"></a><span id="l192.660">   let newNumLines = help_get_num_lines(toDescription);</span>
<a href="#l192.661"></a><span id="l192.661">   if (newNumLines &lt;= 3) {</span>
<a href="#l192.662"></a><span id="l192.662">     throw new Error(</span>
<a href="#l192.663"></a><span id="l192.663">       &quot;number of address lines present in all addresses mode = &quot; +</span>
<a href="#l192.664"></a><span id="l192.664">         newNumLines +</span>
<a href="#l192.665"></a><span id="l192.665">         &quot;&lt;= number of expected minimum of 3 lines filled&quot;</span>
<a href="#l192.666"></a><span id="l192.666">     );</span>
<a href="#l192.667"></a><span id="l192.667">   }</span>
<a href="#l192.668"></a><span id="l192.668" class="difflineminus">-}</span>
<a href="#l192.669"></a><span id="l192.669" class="difflineplus">+});</span>
<a href="#l192.670"></a><span id="l192.670"> </span>
<a href="#l192.671"></a><span id="l192.671"> /**</span>
<a href="#l192.672"></a><span id="l192.672">  * When the window gets too narrow the toolbar should float above the From</span>
<a href="#l192.673"></a><span id="l192.673">  *  line.  Then they need to return back to the right when we get large</span>
<a href="#l192.674"></a><span id="l192.674">  *  enough again.</span>
<a href="#l192.675"></a><span id="l192.675">  */</span>
<a href="#l192.676"></a><span id="l192.676" class="difflineminus">-function test_toolbar_collapse_and_expand() {</span>
<a href="#l192.677"></a><span id="l192.677" class="difflineplus">+add_task(function test_toolbar_collapse_and_expand() {</span>
<a href="#l192.678"></a><span id="l192.678">   be_in_folder(folder);</span>
<a href="#l192.679"></a><span id="l192.679">   // Select and open a message, in this case the last, for no particular reason.</span>
<a href="#l192.680"></a><span id="l192.680">   select_click_row(-1);</span>
<a href="#l192.681"></a><span id="l192.681"> </span>
<a href="#l192.682"></a><span id="l192.682">   try {</span>
<a href="#l192.683"></a><span id="l192.683">     let expandedHeadersTopBox = mc.e(&quot;expandedHeadersTopBox&quot;);</span>
<a href="#l192.684"></a><span id="l192.684"> </span>
<a href="#l192.685"></a><span id="l192.685">     resize_to(mc, 1200, gDefaultWindowHeight);</span>
<a href="#l192.686"></a><span id="l192.686" class="difflineat">@@ -1078,17 +1080,17 @@ function test_toolbar_collapse_and_expan</span>
<a href="#l192.687"></a><span id="l192.687">     mc.waitFor(</span>
<a href="#l192.688"></a><span id="l192.688">       () =&gt; expandedHeadersTopBox.clientHeight == shortHeight,</span>
<a href="#l192.689"></a><span id="l192.689">       &quot;The header box should have returned to its wide size!&quot;</span>
<a href="#l192.690"></a><span id="l192.690">     );</span>
<a href="#l192.691"></a><span id="l192.691">   } finally {</span>
<a href="#l192.692"></a><span id="l192.692">     // restore window to nominal dimensions</span>
<a href="#l192.693"></a><span id="l192.693">     restore_default_window_size();</span>
<a href="#l192.694"></a><span id="l192.694">   }</span>
<a href="#l192.695"></a><span id="l192.695" class="difflineminus">-}</span>
<a href="#l192.696"></a><span id="l192.696" class="difflineplus">+});</span>
<a href="#l192.697"></a><span id="l192.697"> </span>
<a href="#l192.698"></a><span id="l192.698"> /**</span>
<a href="#l192.699"></a><span id="l192.699">  * Test if the tooltip text of the more widget contains the correct addresses</span>
<a href="#l192.700"></a><span id="l192.700">  * not shown in the header and the number of addresses also hidden in the</span>
<a href="#l192.701"></a><span id="l192.701">  * tooltip text.</span>
<a href="#l192.702"></a><span id="l192.702">  * @param aMsg the message for which the subtest should be performed</span>
<a href="#l192.703"></a><span id="l192.703">  */</span>
<a href="#l192.704"></a><span id="l192.704"> function subtest_more_button_tooltip(aMsg) {</span>
<a href="#l192.705"></a><span id="l192.705" class="difflineat">@@ -1099,22 +1101,22 @@ function subtest_more_button_tooltip(aMs</span>
<a href="#l192.706"></a><span id="l192.706">   let shownToAddrNum = get_number_of_addresses_in_header(&quot;expandedtoBox&quot;);</span>
<a href="#l192.707"></a><span id="l192.707">   let shownCCAddrNum = get_number_of_addresses_in_header(&quot;expandedccBox&quot;);</span>
<a href="#l192.708"></a><span id="l192.708"> </span>
<a href="#l192.709"></a><span id="l192.709">   // first check the number of addresses in the more widget</span>
<a href="#l192.710"></a><span id="l192.710">   let hiddenCCAddrsNum = ccAddrs.length - shownCCAddrNum;</span>
<a href="#l192.711"></a><span id="l192.711">   let hiddenToAddrsNum = toAddrs.length - shownToAddrNum;</span>
<a href="#l192.712"></a><span id="l192.712"> </span>
<a href="#l192.713"></a><span id="l192.713">   let moreNumberTo = get_number_of_more_button(&quot;expandedtoBox&quot;);</span>
<a href="#l192.714"></a><span id="l192.714" class="difflineminus">-  assert_not_equals(NaN, moreNumberTo);</span>
<a href="#l192.715"></a><span id="l192.715" class="difflineminus">-  assert_equals(hiddenToAddrsNum, moreNumberTo);</span>
<a href="#l192.716"></a><span id="l192.716" class="difflineplus">+  Assert.notEqual(NaN, moreNumberTo);</span>
<a href="#l192.717"></a><span id="l192.717" class="difflineplus">+  Assert.equal(hiddenToAddrsNum, moreNumberTo);</span>
<a href="#l192.718"></a><span id="l192.718"> </span>
<a href="#l192.719"></a><span id="l192.719">   let moreNumberCC = get_number_of_more_button(&quot;expandedccBox&quot;);</span>
<a href="#l192.720"></a><span id="l192.720" class="difflineminus">-  assert_not_equals(NaN, moreNumberCC);</span>
<a href="#l192.721"></a><span id="l192.721" class="difflineminus">-  assert_equals(hiddenCCAddrsNum, moreNumberCC);</span>
<a href="#l192.722"></a><span id="l192.722" class="difflineplus">+  Assert.notEqual(NaN, moreNumberCC);</span>
<a href="#l192.723"></a><span id="l192.723" class="difflineplus">+  Assert.equal(hiddenCCAddrsNum, moreNumberCC);</span>
<a href="#l192.724"></a><span id="l192.724"> </span>
<a href="#l192.725"></a><span id="l192.725">   subtest_addresses_in_tooltip_text(</span>
<a href="#l192.726"></a><span id="l192.726">     aMsg.recipients,</span>
<a href="#l192.727"></a><span id="l192.727">     &quot;expandedtoBox&quot;,</span>
<a href="#l192.728"></a><span id="l192.728">     shownToAddrNum,</span>
<a href="#l192.729"></a><span id="l192.729">     hiddenToAddrsNum</span>
<a href="#l192.730"></a><span id="l192.730">   );</span>
<a href="#l192.731"></a><span id="l192.731">   subtest_addresses_in_tooltip_text(</span>
<a href="#l192.732"></a><span id="l192.732" class="difflineat">@@ -1187,36 +1189,36 @@ function subtest_addresses_in_tooltip_te</span>
<a href="#l192.733"></a><span id="l192.733">   let maxTooltipAddrsNum = headerBoxElement.maxAddressesInMoreTooltipValue;</span>
<a href="#l192.734"></a><span id="l192.734">   let addrsNumInTooltip = 0;</span>
<a href="#l192.735"></a><span id="l192.735"> </span>
<a href="#l192.736"></a><span id="l192.736">   for (</span>
<a href="#l192.737"></a><span id="l192.737">     let i = aShownAddrsNum;</span>
<a href="#l192.738"></a><span id="l192.738">     i &lt; addresses.length &amp;&amp; i &lt; maxTooltipAddrsNum + aShownAddrsNum;</span>
<a href="#l192.739"></a><span id="l192.739">     i++</span>
<a href="#l192.740"></a><span id="l192.740">   ) {</span>
<a href="#l192.741"></a><span id="l192.741" class="difflineminus">-    assert_true(</span>
<a href="#l192.742"></a><span id="l192.742" class="difflineplus">+    Assert.ok(</span>
<a href="#l192.743"></a><span id="l192.743">       tooltipText.includes(addresses[i].toString()),</span>
<a href="#l192.744"></a><span id="l192.744">       addresses[i].toString()</span>
<a href="#l192.745"></a><span id="l192.745">     );</span>
<a href="#l192.746"></a><span id="l192.746">     addrsNumInTooltip += 1;</span>
<a href="#l192.747"></a><span id="l192.747">   }</span>
<a href="#l192.748"></a><span id="l192.748"> </span>
<a href="#l192.749"></a><span id="l192.749">   if (aHiddenAddrsNum &lt; maxTooltipAddrsNum) {</span>
<a href="#l192.750"></a><span id="l192.750" class="difflineminus">-    assert_equals(aHiddenAddrsNum, addrsNumInTooltip);</span>
<a href="#l192.751"></a><span id="l192.751" class="difflineplus">+    Assert.equal(aHiddenAddrsNum, addrsNumInTooltip);</span>
<a href="#l192.752"></a><span id="l192.752">   } else {</span>
<a href="#l192.753"></a><span id="l192.753" class="difflineminus">-    assert_equals(maxTooltipAddrsNum, addrsNumInTooltip);</span>
<a href="#l192.754"></a><span id="l192.754" class="difflineplus">+    Assert.equal(maxTooltipAddrsNum, addrsNumInTooltip);</span>
<a href="#l192.755"></a><span id="l192.755">     // check if &quot;, and X more&quot; shows the correct number</span>
<a href="#l192.756"></a><span id="l192.756">     let moreTooltipSplit = tooltipText.split(&quot;, &quot;);</span>
<a href="#l192.757"></a><span id="l192.757">     let words = mc.window.document</span>
<a href="#l192.758"></a><span id="l192.758">       .getElementById(&quot;bundle_messenger&quot;)</span>
<a href="#l192.759"></a><span id="l192.759">       .getString(&quot;headerMoreAddrsTooltip&quot;);</span>
<a href="#l192.760"></a><span id="l192.760">     let remainingAddresses =</span>
<a href="#l192.761"></a><span id="l192.761">       addresses.length - aShownAddrsNum - maxTooltipAddrsNum;</span>
<a href="#l192.762"></a><span id="l192.762">     let moreForm = mc.window.PluralForm.get(remainingAddresses, words).replace(</span>
<a href="#l192.763"></a><span id="l192.763">       &quot;#1&quot;,</span>
<a href="#l192.764"></a><span id="l192.764">       remainingAddresses</span>
<a href="#l192.765"></a><span id="l192.765">     );</span>
<a href="#l192.766"></a><span id="l192.766" class="difflineminus">-    assert_equals(</span>
<a href="#l192.767"></a><span id="l192.767" class="difflineplus">+    Assert.equal(</span>
<a href="#l192.768"></a><span id="l192.768">       moreForm,</span>
<a href="#l192.769"></a><span id="l192.769">       &quot;, &quot; + moreTooltipSplit[moreTooltipSplit.length - 1]</span>
<a href="#l192.770"></a><span id="l192.770">     );</span>
<a href="#l192.771"></a><span id="l192.771">   }</span>
<a href="#l192.772"></a><span id="l192.772"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l193.1"></a><span id="l193.1">copy from mail/test/mozmill/message-header/test-phishing-bar.js</span>
<a href="#l193.2"></a><span id="l193.2">copy to mail/test/browser/message-header/browser_phishingBar.js</span>
<a href="#l193.3"></a><span id="l193.3" class="difflineminus">--- a/mail/test/mozmill/message-header/test-phishing-bar.js</span>
<a href="#l193.4"></a><span id="l193.4" class="difflineplus">+++ b/mail/test/browser/message-header/browser_phishingBar.js</span>
<a href="#l193.5"></a><span id="l193.5" class="difflineat">@@ -3,17 +3,20 @@</span>
<a href="#l193.6"></a><span id="l193.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l193.7"></a><span id="l193.7"> </span>
<a href="#l193.8"></a><span id="l193.8"> /**</span>
<a href="#l193.9"></a><span id="l193.9">  * Test that phishing notifications behave properly.</span>
<a href="#l193.10"></a><span id="l193.10">  */</span>
<a href="#l193.11"></a><span id="l193.11"> </span>
<a href="#l193.12"></a><span id="l193.12"> &quot;use strict&quot;;</span>
<a href="#l193.13"></a><span id="l193.13"> </span>
<a href="#l193.14"></a><span id="l193.14" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l193.15"></a><span id="l193.15" class="difflineplus">+var elementslib = ChromeUtils.import(</span>
<a href="#l193.16"></a><span id="l193.16" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l193.17"></a><span id="l193.17" class="difflineplus">+);</span>
<a href="#l193.18"></a><span id="l193.18" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l193.19"></a><span id="l193.19"> </span>
<a href="#l193.20"></a><span id="l193.20"> var { gMockExtProtSvcReg } = ChromeUtils.import(</span>
<a href="#l193.21"></a><span id="l193.21">   &quot;resource://testing-common/mozmill/ContentTabHelpers.jsm&quot;</span>
<a href="#l193.22"></a><span id="l193.22"> );</span>
<a href="#l193.23"></a><span id="l193.23"> var {</span>
<a href="#l193.24"></a><span id="l193.24">   add_message_to_folder,</span>
<a href="#l193.25"></a><span id="l193.25">   be_in_folder,</span>
<a href="#l193.26"></a><span id="l193.26">   create_folder,</span>
<a href="#l193.27"></a><span id="l193.27" class="difflineat">@@ -40,17 +43,17 @@ var {</span>
<a href="#l193.28"></a><span id="l193.28">   wait_for_new_window,</span>
<a href="#l193.29"></a><span id="l193.29"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;);</span>
<a href="#l193.30"></a><span id="l193.30"> </span>
<a href="#l193.31"></a><span id="l193.31"> var folder;</span>
<a href="#l193.32"></a><span id="l193.32"> </span>
<a href="#l193.33"></a><span id="l193.33"> var kBoxId = &quot;mail-notification-top&quot;;</span>
<a href="#l193.34"></a><span id="l193.34"> var kNotificationValue = &quot;maybeScam&quot;;</span>
<a href="#l193.35"></a><span id="l193.35"> </span>
<a href="#l193.36"></a><span id="l193.36" class="difflineminus">-function setupModule(module) {</span>
<a href="#l193.37"></a><span id="l193.37" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l193.38"></a><span id="l193.38">   gMockExtProtSvcReg.register();</span>
<a href="#l193.39"></a><span id="l193.39"> </span>
<a href="#l193.40"></a><span id="l193.40">   folder = create_folder(&quot;PhishingBarA&quot;);</span>
<a href="#l193.41"></a><span id="l193.41">   add_message_to_folder(</span>
<a href="#l193.42"></a><span id="l193.42">     folder,</span>
<a href="#l193.43"></a><span id="l193.43">     create_message({</span>
<a href="#l193.44"></a><span id="l193.44">       body: {</span>
<a href="#l193.45"></a><span id="l193.45">         body: '&lt;form action=&quot;http://localhost/download-me&quot;&gt;&lt;input&gt;&lt;/form&gt;.',</span>
<a href="#l193.46"></a><span id="l193.46" class="difflineat">@@ -100,17 +103,21 @@ function setupModule(module) {</span>
<a href="#l193.47"></a><span id="l193.47">     folder,</span>
<a href="#l193.48"></a><span id="l193.48">     create_message({</span>
<a href="#l193.49"></a><span id="l193.49">       body: {</span>
<a href="#l193.50"></a><span id="l193.50">         body: '&lt;form action=&quot;http://localhost/download-me&quot;&gt;&lt;input&gt;&lt;/form&gt;.',</span>
<a href="#l193.51"></a><span id="l193.51">         contentType: &quot;text/html&quot;,</span>
<a href="#l193.52"></a><span id="l193.52">       },</span>
<a href="#l193.53"></a><span id="l193.53">     })</span>
<a href="#l193.54"></a><span id="l193.54">   );</span>
<a href="#l193.55"></a><span id="l193.55" class="difflineminus">-}</span>
<a href="#l193.56"></a><span id="l193.56" class="difflineplus">+});</span>
<a href="#l193.57"></a><span id="l193.57" class="difflineplus">+</span>
<a href="#l193.58"></a><span id="l193.58" class="difflineplus">+registerCleanupFunction(() =&gt; {</span>
<a href="#l193.59"></a><span id="l193.59" class="difflineplus">+  gMockExtProtSvcReg.unregister();</span>
<a href="#l193.60"></a><span id="l193.60" class="difflineplus">+});</span>
<a href="#l193.61"></a><span id="l193.61"> </span>
<a href="#l193.62"></a><span id="l193.62"> function teardownModule() {</span>
<a href="#l193.63"></a><span id="l193.63">   gMockExtProtSvcReg.unregister();</span>
<a href="#l193.64"></a><span id="l193.64"> }</span>
<a href="#l193.65"></a><span id="l193.65"> </span>
<a href="#l193.66"></a><span id="l193.66"> /**</span>
<a href="#l193.67"></a><span id="l193.67">  * Make sure the notification shows, and goes away once the Ignore menuitem</span>
<a href="#l193.68"></a><span id="l193.68">  * is clicked.</span>
<a href="#l193.69"></a><span id="l193.69" class="difflineat">@@ -139,49 +146,47 @@ function click_link_if_available() {</span>
<a href="#l193.70"></a><span id="l193.70">     msgBody.getElementsByTagName(&quot;a&quot;)[0].click();</span>
<a href="#l193.71"></a><span id="l193.71">   }</span>
<a href="#l193.72"></a><span id="l193.72"> }</span>
<a href="#l193.73"></a><span id="l193.73"> </span>
<a href="#l193.74"></a><span id="l193.74"> /**</span>
<a href="#l193.75"></a><span id="l193.75">  * Test that when viewing a message, choosing ignore hides the the phishing</span>
<a href="#l193.76"></a><span id="l193.76">  * notification.</span>
<a href="#l193.77"></a><span id="l193.77">  */</span>
<a href="#l193.78"></a><span id="l193.78" class="difflineminus">-function test_ignore_phishing_warning_from_message() {</span>
<a href="#l193.79"></a><span id="l193.79" class="difflineplus">+add_task(function test_ignore_phishing_warning_from_message() {</span>
<a href="#l193.80"></a><span id="l193.80">   be_in_folder(folder);</span>
<a href="#l193.81"></a><span id="l193.81">   select_click_row(0);</span>
<a href="#l193.82"></a><span id="l193.82">   assert_ignore_works(mc);</span>
<a href="#l193.83"></a><span id="l193.83"> </span>
<a href="#l193.84"></a><span id="l193.84">   select_click_row(1);</span>
<a href="#l193.85"></a><span id="l193.85">   // msg 1 is normal -&gt; no phishing warning</span>
<a href="#l193.86"></a><span id="l193.86">   assert_notification_displayed(mc, kBoxId, kNotificationValue, false);</span>
<a href="#l193.87"></a><span id="l193.87">   select_click_row(0);</span>
<a href="#l193.88"></a><span id="l193.88">   // msg 0 is a potential phishing attempt, but we ignored it so that should</span>
<a href="#l193.89"></a><span id="l193.89">   // be remembered</span>
<a href="#l193.90"></a><span id="l193.90">   assert_notification_displayed(mc, kBoxId, kNotificationValue, false);</span>
<a href="#l193.91"></a><span id="l193.91" class="difflineminus">-}</span>
<a href="#l193.92"></a><span id="l193.92" class="difflineplus">+});</span>
<a href="#l193.93"></a><span id="l193.93"> </span>
<a href="#l193.94"></a><span id="l193.94"> /**</span>
<a href="#l193.95"></a><span id="l193.95">  * Test that when viewing en eml file, choosing ignore hides the phishing</span>
<a href="#l193.96"></a><span id="l193.96">  * notification.</span>
<a href="#l193.97"></a><span id="l193.97">  */</span>
<a href="#l193.98"></a><span id="l193.98" class="difflineminus">-function test_ignore_phishing_warning_from_eml() {</span>
<a href="#l193.99"></a><span id="l193.99" class="difflineminus">-  let thisFilePath = os.getFileForPath(__file__);</span>
<a href="#l193.100"></a><span id="l193.100" class="difflineminus">-  let file = os.getFileForPath(os.abspath(&quot;./evil.eml&quot;, thisFilePath));</span>
<a href="#l193.101"></a><span id="l193.101" class="difflineplus">+add_task(function test_ignore_phishing_warning_from_eml() {</span>
<a href="#l193.102"></a><span id="l193.102" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(&quot;data/evil.eml&quot;));</span>
<a href="#l193.103"></a><span id="l193.103"> </span>
<a href="#l193.104"></a><span id="l193.104">   let msgc = open_message_from_file(file);</span>
<a href="#l193.105"></a><span id="l193.105">   assert_ignore_works(msgc);</span>
<a href="#l193.106"></a><span id="l193.106">   close_window(msgc);</span>
<a href="#l193.107"></a><span id="l193.107" class="difflineminus">-}</span>
<a href="#l193.108"></a><span id="l193.108" class="difflineplus">+});</span>
<a href="#l193.109"></a><span id="l193.109"> </span>
<a href="#l193.110"></a><span id="l193.110"> /**</span>
<a href="#l193.111"></a><span id="l193.111">  * Test that when viewing an attached eml file, the phishing notification works.</span>
<a href="#l193.112"></a><span id="l193.112">  */</span>
<a href="#l193.113"></a><span id="l193.113" class="difflineminus">-function test_ignore_phishing_warning_from_eml_attachment() {</span>
<a href="#l193.114"></a><span id="l193.114" class="difflineminus">-  let thisFilePath = os.getFileForPath(__file__);</span>
<a href="#l193.115"></a><span id="l193.115" class="difflineminus">-  let file = os.getFileForPath(os.abspath(&quot;./evil-attached.eml&quot;, thisFilePath));</span>
<a href="#l193.116"></a><span id="l193.116" class="difflineplus">+add_task(function test_ignore_phishing_warning_from_eml_attachment() {</span>
<a href="#l193.117"></a><span id="l193.117" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(&quot;data/evil-attached.eml&quot;));</span>
<a href="#l193.118"></a><span id="l193.118"> </span>
<a href="#l193.119"></a><span id="l193.119">   let msgc = open_message_from_file(file);</span>
<a href="#l193.120"></a><span id="l193.120"> </span>
<a href="#l193.121"></a><span id="l193.121">   // Make sure the root message shows the phishing bar.</span>
<a href="#l193.122"></a><span id="l193.122">   wait_for_notification_to_show(msgc, kBoxId, kNotificationValue);</span>
<a href="#l193.123"></a><span id="l193.123"> </span>
<a href="#l193.124"></a><span id="l193.124">   // Open the attached message.</span>
<a href="#l193.125"></a><span id="l193.125">   plan_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l193.126"></a><span id="l193.126" class="difflineat">@@ -192,45 +197,47 @@ function test_ignore_phishing_warning_fr</span>
<a href="#l193.127"></a><span id="l193.127">   let msgc2 = wait_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l193.128"></a><span id="l193.128">   wait_for_message_display_completion(msgc2, true);</span>
<a href="#l193.129"></a><span id="l193.129"> </span>
<a href="#l193.130"></a><span id="l193.130">   // Now make sure the attached message shows the phishing bar.</span>
<a href="#l193.131"></a><span id="l193.131">   wait_for_notification_to_show(msgc2, kBoxId, kNotificationValue);</span>
<a href="#l193.132"></a><span id="l193.132"> </span>
<a href="#l193.133"></a><span id="l193.133">   close_window(msgc2);</span>
<a href="#l193.134"></a><span id="l193.134">   close_window(msgc);</span>
<a href="#l193.135"></a><span id="l193.135" class="difflineminus">-}</span>
<a href="#l193.136"></a><span id="l193.136" class="difflineplus">+});</span>
<a href="#l193.137"></a><span id="l193.137"> </span>
<a href="#l193.138"></a><span id="l193.138"> /**</span>
<a href="#l193.139"></a><span id="l193.139">  * Test that when viewing a message with an auto-linked ip address, we don't</span>
<a href="#l193.140"></a><span id="l193.140">  * get a warning when clicking the link.</span>
<a href="#l193.141"></a><span id="l193.141">  * We'll have http://130.128.4.1 vs. http://130.128.4.1/</span>
<a href="#l193.142"></a><span id="l193.142">  */</span>
<a href="#l193.143"></a><span id="l193.143"> function test_no_phishing_warning_for_ip_sameish_text() {</span>
<a href="#l193.144"></a><span id="l193.144">   be_in_folder(folder);</span>
<a href="#l193.145"></a><span id="l193.145">   select_click_row(2); // Mail with Public IP address.</span>
<a href="#l193.146"></a><span id="l193.146">   click_link_if_available();</span>
<a href="#l193.147"></a><span id="l193.147">   assert_notification_displayed(mc, kBoxId, kNotificationValue, false); // not shown</span>
<a href="#l193.148"></a><span id="l193.148"> }</span>
<a href="#l193.149"></a><span id="l193.149" class="difflineplus">+add_task(test_no_phishing_warning_for_ip_sameish_text);</span>
<a href="#l193.150"></a><span id="l193.150"> </span>
<a href="#l193.151"></a><span id="l193.151"> /**</span>
<a href="#l193.152"></a><span id="l193.152">  * Test that when viewing a message with a link whose base domain matches but</span>
<a href="#l193.153"></a><span id="l193.153">  * has a different subdomain (e.g. http://subdomain.google.com/ vs</span>
<a href="#l193.154"></a><span id="l193.154">  * http://google.com/), we don't get a warning if the link is pressed.</span>
<a href="#l193.155"></a><span id="l193.155">  */</span>
<a href="#l193.156"></a><span id="l193.156"> function test_no_phishing_warning_for_subdomain() {</span>
<a href="#l193.157"></a><span id="l193.157">   be_in_folder(folder);</span>
<a href="#l193.158"></a><span id="l193.158">   select_click_row(3);</span>
<a href="#l193.159"></a><span id="l193.159">   click_link_if_available();</span>
<a href="#l193.160"></a><span id="l193.160">   assert_notification_displayed(mc, kBoxId, kNotificationValue, false); // not shown</span>
<a href="#l193.161"></a><span id="l193.161"> </span>
<a href="#l193.162"></a><span id="l193.162">   select_click_row(4);</span>
<a href="#l193.163"></a><span id="l193.163">   click_link_if_available();</span>
<a href="#l193.164"></a><span id="l193.164">   assert_notification_displayed(mc, kBoxId, kNotificationValue, false); // not shown</span>
<a href="#l193.165"></a><span id="l193.165"> }</span>
<a href="#l193.166"></a><span id="l193.166" class="difflineplus">+add_task(test_no_phishing_warning_for_subdomain);</span>
<a href="#l193.167"></a><span id="l193.167"> </span>
<a href="#l193.168"></a><span id="l193.168"> /**</span>
<a href="#l193.169"></a><span id="l193.169">  * Test that when clicking a link where the text and/or href</span>
<a href="#l193.170"></a><span id="l193.170">  * has no TLD, we still warn as appropriate.</span>
<a href="#l193.171"></a><span id="l193.171">  */</span>
<a href="#l193.172"></a><span id="l193.172"> function test_phishing_warning_for_local_domain() {</span>
<a href="#l193.173"></a><span id="l193.173">   be_in_folder(folder);</span>
<a href="#l193.174"></a><span id="l193.174">   select_click_row(5);</span>
<a href="#l193.175"></a><span id="l193.175" class="difflineat">@@ -238,19 +245,27 @@ function test_phishing_warning_for_local</span>
<a href="#l193.176"></a><span id="l193.176">   let dialogAppeared = false;</span>
<a href="#l193.177"></a><span id="l193.177"> </span>
<a href="#l193.178"></a><span id="l193.178">   plan_for_modal_dialog(&quot;commonDialog&quot;, function(ctrler) {</span>
<a href="#l193.179"></a><span id="l193.179">     dialogAppeared = true;</span>
<a href="#l193.180"></a><span id="l193.180">   });</span>
<a href="#l193.181"></a><span id="l193.181"> </span>
<a href="#l193.182"></a><span id="l193.182">   click_link_if_available();</span>
<a href="#l193.183"></a><span id="l193.183"> </span>
<a href="#l193.184"></a><span id="l193.184" class="difflineminus">-  return dialogAppeared;</span>
<a href="#l193.185"></a><span id="l193.185" class="difflineplus">+  Assert.ok(dialogAppeared);</span>
<a href="#l193.186"></a><span id="l193.186"> }</span>
<a href="#l193.187"></a><span id="l193.187" class="difflineplus">+add_task(test_phishing_warning_for_local_domain);</span>
<a href="#l193.188"></a><span id="l193.188"> </span>
<a href="#l193.189"></a><span id="l193.189"> /**</span>
<a href="#l193.190"></a><span id="l193.190">  * Test that we warn about emails which contain &lt;form&gt;s with action attributes.</span>
<a href="#l193.191"></a><span id="l193.191">  */</span>
<a href="#l193.192"></a><span id="l193.192" class="difflineminus">-function test_phishing_warning_for_action_form() {</span>
<a href="#l193.193"></a><span id="l193.193" class="difflineplus">+add_task(function test_phishing_warning_for_action_form() {</span>
<a href="#l193.194"></a><span id="l193.194">   be_in_folder(folder);</span>
<a href="#l193.195"></a><span id="l193.195">   select_click_row(6);</span>
<a href="#l193.196"></a><span id="l193.196">   assert_notification_displayed(mc, kBoxId, kNotificationValue, true); // shown</span>
<a href="#l193.197"></a><span id="l193.197" class="difflineminus">-}</span>
<a href="#l193.198"></a><span id="l193.198" class="difflineplus">+</span>
<a href="#l193.199"></a><span id="l193.199" class="difflineplus">+  Assert.report(</span>
<a href="#l193.200"></a><span id="l193.200" class="difflineplus">+    false,</span>
<a href="#l193.201"></a><span id="l193.201" class="difflineplus">+    undefined,</span>
<a href="#l193.202"></a><span id="l193.202" class="difflineplus">+    undefined,</span>
<a href="#l193.203"></a><span id="l193.203" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l193.204"></a><span id="l193.204" class="difflineplus">+  );</span>
<a href="#l193.205"></a><span id="l193.205" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l194.1"></a><span id="l194.1">copy from mail/test/mozmill/message-header/test-reply-identity.js</span>
<a href="#l194.2"></a><span id="l194.2">copy to mail/test/browser/message-header/browser_replyIdentity.js</span>
<a href="#l194.3"></a><span id="l194.3" class="difflineminus">--- a/mail/test/mozmill/message-header/test-reply-identity.js</span>
<a href="#l194.4"></a><span id="l194.4" class="difflineplus">+++ b/mail/test/browser/message-header/browser_replyIdentity.js</span>
<a href="#l194.5"></a><span id="l194.5" class="difflineat">@@ -26,17 +26,17 @@ var { MailServices } = ChromeUtils.impor</span>
<a href="#l194.6"></a><span id="l194.6">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l194.7"></a><span id="l194.7"> );</span>
<a href="#l194.8"></a><span id="l194.8"> </span>
<a href="#l194.9"></a><span id="l194.9"> var testFolder = null;</span>
<a href="#l194.10"></a><span id="l194.10"> </span>
<a href="#l194.11"></a><span id="l194.11"> var identity1Email = &quot;carl@example.com&quot;;</span>
<a href="#l194.12"></a><span id="l194.12"> var identity2Email = &quot;lenny@springfield.invalid&quot;;</span>
<a href="#l194.13"></a><span id="l194.13"> </span>
<a href="#l194.14"></a><span id="l194.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l194.15"></a><span id="l194.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l194.16"></a><span id="l194.16">   addIdentitiesAndFolder();</span>
<a href="#l194.17"></a><span id="l194.17">   // Msg #0</span>
<a href="#l194.18"></a><span id="l194.18">   add_message_to_folder(</span>
<a href="#l194.19"></a><span id="l194.19">     testFolder,</span>
<a href="#l194.20"></a><span id="l194.20">     create_message({</span>
<a href="#l194.21"></a><span id="l194.21">       from: &quot;Homer &lt;homer@example.com&gt;&quot;,</span>
<a href="#l194.22"></a><span id="l194.22">       to: &quot;workers@springfield.invalid&quot;,</span>
<a href="#l194.23"></a><span id="l194.23">       subject: &quot;no matching identity, like bcc/list&quot;,</span>
<a href="#l194.24"></a><span id="l194.24" class="difflineat">@@ -106,17 +106,17 @@ function setupModule(module) {</span>
<a href="#l194.25"></a><span id="l194.25">       from: identity2Email + &quot; &lt;&quot; + identity2Email + &quot;&gt;&quot;,</span>
<a href="#l194.26"></a><span id="l194.26">       to: &quot;Marge &lt;marge@example.com&gt;&quot;,</span>
<a href="#l194.27"></a><span id="l194.27">       subject: &quot;from second self&quot;,</span>
<a href="#l194.28"></a><span id="l194.28">       body: {</span>
<a href="#l194.29"></a><span id="l194.29">         body: &quot;All my life I've had one dream, to achieve my many goals.&quot;,</span>
<a href="#l194.30"></a><span id="l194.30">       },</span>
<a href="#l194.31"></a><span id="l194.31">     })</span>
<a href="#l194.32"></a><span id="l194.32">   );</span>
<a href="#l194.33"></a><span id="l194.33" class="difflineminus">-}</span>
<a href="#l194.34"></a><span id="l194.34" class="difflineplus">+});</span>
<a href="#l194.35"></a><span id="l194.35"> </span>
<a href="#l194.36"></a><span id="l194.36"> function addIdentitiesAndFolder() {</span>
<a href="#l194.37"></a><span id="l194.37">   let server = MailServices.accounts.createIncomingServer(</span>
<a href="#l194.38"></a><span id="l194.38">     &quot;nobody&quot;,</span>
<a href="#l194.39"></a><span id="l194.39">     &quot;Reply Identity Testing&quot;,</span>
<a href="#l194.40"></a><span id="l194.40">     &quot;pop3&quot;</span>
<a href="#l194.41"></a><span id="l194.41">   );</span>
<a href="#l194.42"></a><span id="l194.42">   testFolder = server.rootFolder</span>
<a href="#l194.43"></a><span id="l194.43" class="difflineat">@@ -142,84 +142,91 @@ function checkReply(replyWin, expectedFr</span>
<a href="#l194.44"></a><span id="l194.44">       &quot;The From address is not correctly selected! Expected: &quot; +</span>
<a href="#l194.45"></a><span id="l194.45">         expectedFromEmail +</span>
<a href="#l194.46"></a><span id="l194.46">         &quot;; Actual: &quot; +</span>
<a href="#l194.47"></a><span id="l194.47">         identityList.selectedItem.label</span>
<a href="#l194.48"></a><span id="l194.48">     );</span>
<a href="#l194.49"></a><span id="l194.49">   }</span>
<a href="#l194.50"></a><span id="l194.50"> }</span>
<a href="#l194.51"></a><span id="l194.51"> </span>
<a href="#l194.52"></a><span id="l194.52" class="difflineminus">-function test_reply_no_matching_identity() {</span>
<a href="#l194.53"></a><span id="l194.53" class="difflineplus">+add_task(function test_reply_no_matching_identity() {</span>
<a href="#l194.54"></a><span id="l194.54">   be_in_folder(testFolder);</span>
<a href="#l194.55"></a><span id="l194.55"> </span>
<a href="#l194.56"></a><span id="l194.56">   let msg = select_click_row(0);</span>
<a href="#l194.57"></a><span id="l194.57">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l194.58"></a><span id="l194.58"> </span>
<a href="#l194.59"></a><span id="l194.59">   let replyWin = open_compose_with_reply();</span>
<a href="#l194.60"></a><span id="l194.60">   // Should have selected the default identity.</span>
<a href="#l194.61"></a><span id="l194.61">   checkReply(replyWin, identity1Email);</span>
<a href="#l194.62"></a><span id="l194.62">   close_compose_window(replyWin);</span>
<a href="#l194.63"></a><span id="l194.63" class="difflineminus">-}</span>
<a href="#l194.64"></a><span id="l194.64" class="difflineplus">+});</span>
<a href="#l194.65"></a><span id="l194.65"> </span>
<a href="#l194.66"></a><span id="l194.66" class="difflineminus">-function test_reply_matching_only_deliveredto() {</span>
<a href="#l194.67"></a><span id="l194.67" class="difflineplus">+add_task(function test_reply_matching_only_deliveredto() {</span>
<a href="#l194.68"></a><span id="l194.68">   be_in_folder(testFolder);</span>
<a href="#l194.69"></a><span id="l194.69"> </span>
<a href="#l194.70"></a><span id="l194.70">   let msg = select_click_row(1);</span>
<a href="#l194.71"></a><span id="l194.71">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l194.72"></a><span id="l194.72"> </span>
<a href="#l194.73"></a><span id="l194.73">   let replyWin = open_compose_with_reply();</span>
<a href="#l194.74"></a><span id="l194.74">   // Should have selected the second id, which is listed in Delivered-To:.</span>
<a href="#l194.75"></a><span id="l194.75">   checkReply(replyWin, identity2Email);</span>
<a href="#l194.76"></a><span id="l194.76">   close_compose_window(replyWin);</span>
<a href="#l194.77"></a><span id="l194.77" class="difflineminus">-}</span>
<a href="#l194.78"></a><span id="l194.78" class="difflineplus">+});</span>
<a href="#l194.79"></a><span id="l194.79"> </span>
<a href="#l194.80"></a><span id="l194.80" class="difflineminus">-function test_reply_matching_subaddress() {</span>
<a href="#l194.81"></a><span id="l194.81" class="difflineplus">+add_task(function test_reply_matching_subaddress() {</span>
<a href="#l194.82"></a><span id="l194.82">   be_in_folder(testFolder);</span>
<a href="#l194.83"></a><span id="l194.83"> </span>
<a href="#l194.84"></a><span id="l194.84">   let msg = select_click_row(2);</span>
<a href="#l194.85"></a><span id="l194.85">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l194.86"></a><span id="l194.86"> </span>
<a href="#l194.87"></a><span id="l194.87">   let replyWin = open_compose_with_reply();</span>
<a href="#l194.88"></a><span id="l194.88">   // Should have selected the first id, the email doesn't fully match.</span>
<a href="#l194.89"></a><span id="l194.89">   // other.lenny != &quot;our&quot; lenny</span>
<a href="#l194.90"></a><span id="l194.90">   checkReply(replyWin, identity1Email);</span>
<a href="#l194.91"></a><span id="l194.91">   close_compose_window(replyWin);</span>
<a href="#l194.92"></a><span id="l194.92" class="difflineminus">-}</span>
<a href="#l194.93"></a><span id="l194.93" class="difflineplus">+});</span>
<a href="#l194.94"></a><span id="l194.94"> </span>
<a href="#l194.95"></a><span id="l194.95" class="difflineminus">-function test_reply_to_matching_second_id() {</span>
<a href="#l194.96"></a><span id="l194.96" class="difflineplus">+add_task(function test_reply_to_matching_second_id() {</span>
<a href="#l194.97"></a><span id="l194.97">   be_in_folder(testFolder);</span>
<a href="#l194.98"></a><span id="l194.98"> </span>
<a href="#l194.99"></a><span id="l194.99">   let msg = select_click_row(3);</span>
<a href="#l194.100"></a><span id="l194.100">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l194.101"></a><span id="l194.101"> </span>
<a href="#l194.102"></a><span id="l194.102">   let replyWin = open_compose_with_reply();</span>
<a href="#l194.103"></a><span id="l194.103">   // Should have selected the second id, which was in To;.</span>
<a href="#l194.104"></a><span id="l194.104">   checkReply(replyWin, identity2Email);</span>
<a href="#l194.105"></a><span id="l194.105">   close_compose_window(replyWin);</span>
<a href="#l194.106"></a><span id="l194.106" class="difflineminus">-}</span>
<a href="#l194.107"></a><span id="l194.107" class="difflineplus">+});</span>
<a href="#l194.108"></a><span id="l194.108"> </span>
<a href="#l194.109"></a><span id="l194.109" class="difflineminus">-function test_deliveredto_to_matching_only_parlty() {</span>
<a href="#l194.110"></a><span id="l194.110" class="difflineplus">+add_task(function test_deliveredto_to_matching_only_parlty() {</span>
<a href="#l194.111"></a><span id="l194.111">   be_in_folder(testFolder);</span>
<a href="#l194.112"></a><span id="l194.112"> </span>
<a href="#l194.113"></a><span id="l194.113">   let msg = select_click_row(4);</span>
<a href="#l194.114"></a><span id="l194.114">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l194.115"></a><span id="l194.115"> </span>
<a href="#l194.116"></a><span id="l194.116">   let replyWin = open_compose_with_reply();</span>
<a href="#l194.117"></a><span id="l194.117">   // Should have selected the (default) first id.</span>
<a href="#l194.118"></a><span id="l194.118">   checkReply(replyWin, identity1Email);</span>
<a href="#l194.119"></a><span id="l194.119">   close_compose_window(replyWin);</span>
<a href="#l194.120"></a><span id="l194.120" class="difflineminus">-}</span>
<a href="#l194.121"></a><span id="l194.121" class="difflineplus">+});</span>
<a href="#l194.122"></a><span id="l194.122"> </span>
<a href="#l194.123"></a><span id="l194.123"> /**</span>
<a href="#l194.124"></a><span id="l194.124">  * A reply from self is treated as a follow-up. And this self</span>
<a href="#l194.125"></a><span id="l194.125">  * was the second identity, so the reply should also be from the second identity.</span>
<a href="#l194.126"></a><span id="l194.126">  */</span>
<a href="#l194.127"></a><span id="l194.127" class="difflineminus">-function test_reply_to_self_second_id() {</span>
<a href="#l194.128"></a><span id="l194.128" class="difflineplus">+add_task(function test_reply_to_self_second_id() {</span>
<a href="#l194.129"></a><span id="l194.129">   be_in_folder(testFolder);</span>
<a href="#l194.130"></a><span id="l194.130"> </span>
<a href="#l194.131"></a><span id="l194.131">   let msg = select_click_row(5);</span>
<a href="#l194.132"></a><span id="l194.132">   assert_selected_and_displayed(mc, msg);</span>
<a href="#l194.133"></a><span id="l194.133"> </span>
<a href="#l194.134"></a><span id="l194.134">   let replyWin = open_compose_with_reply();</span>
<a href="#l194.135"></a><span id="l194.135">   // Should have selected the second id, which was in From.</span>
<a href="#l194.136"></a><span id="l194.136">   checkReply(replyWin, identity2Email);</span>
<a href="#l194.137"></a><span id="l194.137">   close_compose_window(replyWin, false /* no prompt*/);</span>
<a href="#l194.138"></a><span id="l194.138" class="difflineminus">-}</span>
<a href="#l194.139"></a><span id="l194.139" class="difflineplus">+</span>
<a href="#l194.140"></a><span id="l194.140" class="difflineplus">+  Assert.report(</span>
<a href="#l194.141"></a><span id="l194.141" class="difflineplus">+    false,</span>
<a href="#l194.142"></a><span id="l194.142" class="difflineplus">+    undefined,</span>
<a href="#l194.143"></a><span id="l194.143" class="difflineplus">+    undefined,</span>
<a href="#l194.144"></a><span id="l194.144" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l194.145"></a><span id="l194.145" class="difflineplus">+  );</span>
<a href="#l194.146"></a><span id="l194.146" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l195.1"></a><span id="l195.1">copy from mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js</span>
<a href="#l195.2"></a><span id="l195.2">copy to mail/test/browser/message-header/browser_replyToListFromAddressSelection.js</span>
<a href="#l195.3"></a><span id="l195.3" class="difflineminus">--- a/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js</span>
<a href="#l195.4"></a><span id="l195.4" class="difflineplus">+++ b/mail/test/browser/message-header/browser_replyToListFromAddressSelection.js</span>
<a href="#l195.5"></a><span id="l195.5" class="difflineat">@@ -3,19 +3,20 @@</span>
<a href="#l195.6"></a><span id="l195.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l195.7"></a><span id="l195.7"> </span>
<a href="#l195.8"></a><span id="l195.8"> /*</span>
<a href="#l195.9"></a><span id="l195.9">  *  Test for the most suitable identity in From address for reply-to-list</span>
<a href="#l195.10"></a><span id="l195.10">  */</span>
<a href="#l195.11"></a><span id="l195.11"> </span>
<a href="#l195.12"></a><span id="l195.12"> &quot;use strict&quot;;</span>
<a href="#l195.13"></a><span id="l195.13"> </span>
<a href="#l195.14"></a><span id="l195.14" class="difflineminus">-var { open_compose_with_reply_to_list } = ChromeUtils.import(</span>
<a href="#l195.15"></a><span id="l195.15" class="difflineminus">-  &quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;</span>
<a href="#l195.16"></a><span id="l195.16" class="difflineminus">-);</span>
<a href="#l195.17"></a><span id="l195.17" class="difflineplus">+var {</span>
<a href="#l195.18"></a><span id="l195.18" class="difflineplus">+  close_compose_window,</span>
<a href="#l195.19"></a><span id="l195.19" class="difflineplus">+  open_compose_with_reply_to_list,</span>
<a href="#l195.20"></a><span id="l195.20" class="difflineplus">+} = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l195.21"></a><span id="l195.21"> var {</span>
<a href="#l195.22"></a><span id="l195.22">   assert_selected_and_displayed,</span>
<a href="#l195.23"></a><span id="l195.23">   be_in_folder,</span>
<a href="#l195.24"></a><span id="l195.24">   mc,</span>
<a href="#l195.25"></a><span id="l195.25">   select_click_row,</span>
<a href="#l195.26"></a><span id="l195.26"> } = ChromeUtils.import(</span>
<a href="#l195.27"></a><span id="l195.27">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l195.28"></a><span id="l195.28"> );</span>
<a href="#l195.29"></a><span id="l195.29" class="difflineat">@@ -25,20 +26,20 @@ var { MailServices } = ChromeUtils.impor</span>
<a href="#l195.30"></a><span id="l195.30"> );</span>
<a href="#l195.31"></a><span id="l195.31"> </span>
<a href="#l195.32"></a><span id="l195.32"> var testFolder = null;</span>
<a href="#l195.33"></a><span id="l195.33"> var msgHdr = null;</span>
<a href="#l195.34"></a><span id="l195.34"> var replyToListWindow = null;</span>
<a href="#l195.35"></a><span id="l195.35"> </span>
<a href="#l195.36"></a><span id="l195.36"> var identityString1 = &quot;tinderbox_correct_identity@foo.invalid&quot;;</span>
<a href="#l195.37"></a><span id="l195.37"> </span>
<a href="#l195.38"></a><span id="l195.38" class="difflineminus">-function setupModule(module) {</span>
<a href="#l195.39"></a><span id="l195.39" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l195.40"></a><span id="l195.40">   addIdentitiesAndFolder();</span>
<a href="#l195.41"></a><span id="l195.41">   addMessageToFolder(testFolder);</span>
<a href="#l195.42"></a><span id="l195.42" class="difflineminus">-}</span>
<a href="#l195.43"></a><span id="l195.43" class="difflineplus">+});</span>
<a href="#l195.44"></a><span id="l195.44"> </span>
<a href="#l195.45"></a><span id="l195.45"> function addMessageToFolder(aFolder) {</span>
<a href="#l195.46"></a><span id="l195.46">   var msgId =</span>
<a href="#l195.47"></a><span id="l195.47">     Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l195.48"></a><span id="l195.48">       .getService(Ci.nsIUUIDGenerator)</span>
<a href="#l195.49"></a><span id="l195.49">       .generateUUID() + &quot;@mozillamessaging.invalid&quot;;</span>
<a href="#l195.50"></a><span id="l195.50"> </span>
<a href="#l195.51"></a><span id="l195.51">   var source =</span>
<a href="#l195.52"></a><span id="l195.52" class="difflineat">@@ -92,17 +93,17 @@ function addIdentitiesAndFolder() {</span>
<a href="#l195.53"></a><span id="l195.53">   testFolder = localRoot.createLocalSubfolder(&quot;Test Folder&quot;);</span>
<a href="#l195.54"></a><span id="l195.54"> </span>
<a href="#l195.55"></a><span id="l195.55">   let account = MailServices.accounts.createAccount();</span>
<a href="#l195.56"></a><span id="l195.56">   account.incomingServer = server;</span>
<a href="#l195.57"></a><span id="l195.57">   account.addIdentity(identity);</span>
<a href="#l195.58"></a><span id="l195.58">   account.addIdentity(identity2);</span>
<a href="#l195.59"></a><span id="l195.59"> }</span>
<a href="#l195.60"></a><span id="l195.60"> </span>
<a href="#l195.61"></a><span id="l195.61" class="difflineminus">-function test_Reply_To_List_From_Address() {</span>
<a href="#l195.62"></a><span id="l195.62" class="difflineplus">+add_task(function test_Reply_To_List_From_Address() {</span>
<a href="#l195.63"></a><span id="l195.63">   be_in_folder(testFolder);</span>
<a href="#l195.64"></a><span id="l195.64"> </span>
<a href="#l195.65"></a><span id="l195.65">   let curMessage = select_click_row(0);</span>
<a href="#l195.66"></a><span id="l195.66">   assert_selected_and_displayed(mc, curMessage);</span>
<a href="#l195.67"></a><span id="l195.67"> </span>
<a href="#l195.68"></a><span id="l195.68">   replyToListWindow = open_compose_with_reply_to_list();</span>
<a href="#l195.69"></a><span id="l195.69"> </span>
<a href="#l195.70"></a><span id="l195.70">   var identityList = replyToListWindow.e(&quot;msgIdentity&quot;);</span>
<a href="#l195.71"></a><span id="l195.71" class="difflineat">@@ -111,9 +112,18 @@ function test_Reply_To_List_From_Address</span>
<a href="#l195.72"></a><span id="l195.72">   if (!identityList.selectedItem.label.includes(identityString1)) {</span>
<a href="#l195.73"></a><span id="l195.73">     throw new Error(</span>
<a href="#l195.74"></a><span id="l195.74">       &quot;The From address is not correctly selected! Expected: &quot; +</span>
<a href="#l195.75"></a><span id="l195.75">         identityString1 +</span>
<a href="#l195.76"></a><span id="l195.76">         &quot;; Actual: &quot; +</span>
<a href="#l195.77"></a><span id="l195.77">         identityList.selectedItem.label</span>
<a href="#l195.78"></a><span id="l195.78">     );</span>
<a href="#l195.79"></a><span id="l195.79">   }</span>
<a href="#l195.80"></a><span id="l195.80" class="difflineminus">-}</span>
<a href="#l195.81"></a><span id="l195.81" class="difflineplus">+</span>
<a href="#l195.82"></a><span id="l195.82" class="difflineplus">+  close_compose_window(replyToListWindow);</span>
<a href="#l195.83"></a><span id="l195.83" class="difflineplus">+</span>
<a href="#l195.84"></a><span id="l195.84" class="difflineplus">+  Assert.report(</span>
<a href="#l195.85"></a><span id="l195.85" class="difflineplus">+    false,</span>
<a href="#l195.86"></a><span id="l195.86" class="difflineplus">+    undefined,</span>
<a href="#l195.87"></a><span id="l195.87" class="difflineplus">+    undefined,</span>
<a href="#l195.88"></a><span id="l195.88" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l195.89"></a><span id="l195.89" class="difflineplus">+  );</span>
<a href="#l195.90"></a><span id="l195.90" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l196.1"></a><span id="l196.1">copy from mail/test/mozmill/message-header/test-return-receipt.js</span>
<a href="#l196.2"></a><span id="l196.2">copy to mail/test/browser/message-header/browser_returnReceipt.js</span>
<a href="#l196.3"></a><span id="l196.3" class="difflineminus">--- a/mail/test/mozmill/message-header/test-return-receipt.js</span>
<a href="#l196.4"></a><span id="l196.4" class="difflineplus">+++ b/mail/test/browser/message-header/browser_returnReceipt.js</span>
<a href="#l196.5"></a><span id="l196.5" class="difflineat">@@ -23,17 +23,17 @@ var { assert_notification_displayed } = </span>
<a href="#l196.6"></a><span id="l196.6">   &quot;resource://testing-common/mozmill/NotificationBoxHelpers.jsm&quot;</span>
<a href="#l196.7"></a><span id="l196.7"> );</span>
<a href="#l196.8"></a><span id="l196.8"> </span>
<a href="#l196.9"></a><span id="l196.9"> var folder;</span>
<a href="#l196.10"></a><span id="l196.10"> </span>
<a href="#l196.11"></a><span id="l196.11"> var kBoxId = &quot;mail-notification-top&quot;;</span>
<a href="#l196.12"></a><span id="l196.12"> var kNotificationValue = &quot;mdnRequested&quot;;</span>
<a href="#l196.13"></a><span id="l196.13"> </span>
<a href="#l196.14"></a><span id="l196.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l196.15"></a><span id="l196.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l196.16"></a><span id="l196.16">   folder = create_folder(&quot;ReturnReceiptTest&quot;);</span>
<a href="#l196.17"></a><span id="l196.17"> </span>
<a href="#l196.18"></a><span id="l196.18">   // Create a message that requests a return receipt.</span>
<a href="#l196.19"></a><span id="l196.19">   let msg0 = create_message({</span>
<a href="#l196.20"></a><span id="l196.20">     from: [&quot;Ake&quot;, &quot;ake@example.com&quot;],</span>
<a href="#l196.21"></a><span id="l196.21">     clobberHeaders: { &quot;Disposition-Notification-To&quot;: &quot;ake@example.com&quot; },</span>
<a href="#l196.22"></a><span id="l196.22">   });</span>
<a href="#l196.23"></a><span id="l196.23">   add_message_to_folder(folder, msg0);</span>
<a href="#l196.24"></a><span id="l196.24" class="difflineat">@@ -75,17 +75,17 @@ function setupModule(module) {</span>
<a href="#l196.25"></a><span id="l196.25"> </span>
<a href="#l196.26"></a><span id="l196.26">   // Create a message that requests a return receipt to different addresses</span>
<a href="#l196.27"></a><span id="l196.27">   // using non-standard header.</span>
<a href="#l196.28"></a><span id="l196.28">   let msg6 = create_message({</span>
<a href="#l196.29"></a><span id="l196.29">     from: [&quot;Bobby&quot;, &quot;bob@example.org&quot;],</span>
<a href="#l196.30"></a><span id="l196.30">     clobberHeaders: { &quot;Return-Receipt-To&quot;: &quot;ex1@example.com, ex2@example.com&quot; },</span>
<a href="#l196.31"></a><span id="l196.31">   });</span>
<a href="#l196.32"></a><span id="l196.32">   add_message_to_folder(folder, msg6);</span>
<a href="#l196.33"></a><span id="l196.33" class="difflineminus">-}</span>
<a href="#l196.34"></a><span id="l196.34" class="difflineplus">+});</span>
<a href="#l196.35"></a><span id="l196.35"> </span>
<a href="#l196.36"></a><span id="l196.36"> /** Utility to select a message. */</span>
<a href="#l196.37"></a><span id="l196.37"> function gotoMsg(row) {</span>
<a href="#l196.38"></a><span id="l196.38">   be_in_folder(folder);</span>
<a href="#l196.39"></a><span id="l196.39">   let curMessage = select_click_row(row);</span>
<a href="#l196.40"></a><span id="l196.40">   assert_selected_and_displayed(mc, curMessage);</span>
<a href="#l196.41"></a><span id="l196.41"> }</span>
<a href="#l196.42"></a><span id="l196.42"> </span>
<a href="#l196.43"></a><span id="l196.43" class="difflineat">@@ -120,74 +120,81 @@ function assert_mdn_text_contains(text, </span>
<a href="#l196.44"></a><span id="l196.44">     );</span>
<a href="#l196.45"></a><span id="l196.45">   }</span>
<a href="#l196.46"></a><span id="l196.46"> }</span>
<a href="#l196.47"></a><span id="l196.47"> </span>
<a href="#l196.48"></a><span id="l196.48"> /**</span>
<a href="#l196.49"></a><span id="l196.49">  * Test that return receipts are not shown when Disposition-Notification-To</span>
<a href="#l196.50"></a><span id="l196.50">  * and Return-Receipt-To isn't set.</span>
<a href="#l196.51"></a><span id="l196.51">  */</span>
<a href="#l196.52"></a><span id="l196.52" class="difflineminus">-function test_no_mdn_for_normal_msgs() {</span>
<a href="#l196.53"></a><span id="l196.53" class="difflineplus">+add_task(function test_no_mdn_for_normal_msgs() {</span>
<a href="#l196.54"></a><span id="l196.54">   gotoMsg(1); // This message doesn't request a return receipt.</span>
<a href="#l196.55"></a><span id="l196.55">   assert_mdn_shown(false);</span>
<a href="#l196.56"></a><span id="l196.56" class="difflineminus">-}</span>
<a href="#l196.57"></a><span id="l196.57" class="difflineplus">+});</span>
<a href="#l196.58"></a><span id="l196.58"> </span>
<a href="#l196.59"></a><span id="l196.59"> /**</span>
<a href="#l196.60"></a><span id="l196.60">  * Test that return receipts are shown when Disposition-Notification-To is set.</span>
<a href="#l196.61"></a><span id="l196.61">  */</span>
<a href="#l196.62"></a><span id="l196.62" class="difflineminus">-function test_basic_mdn_shown() {</span>
<a href="#l196.63"></a><span id="l196.63" class="difflineplus">+add_task(function test_basic_mdn_shown() {</span>
<a href="#l196.64"></a><span id="l196.64">   gotoMsg(0); // This message requests a return receipt.</span>
<a href="#l196.65"></a><span id="l196.65">   assert_mdn_shown(true);</span>
<a href="#l196.66"></a><span id="l196.66">   assert_mdn_text_contains(&quot;ake@example.com&quot;, false); // only name should show</span>
<a href="#l196.67"></a><span id="l196.67" class="difflineminus">-}</span>
<a href="#l196.68"></a><span id="l196.68" class="difflineplus">+});</span>
<a href="#l196.69"></a><span id="l196.69"> </span>
<a href="#l196.70"></a><span id="l196.70"> /**</span>
<a href="#l196.71"></a><span id="l196.71">  * Test that return receipts are shown when Return-Receipt-To is set.</span>
<a href="#l196.72"></a><span id="l196.72">  */</span>
<a href="#l196.73"></a><span id="l196.73" class="difflineminus">-function test_basic_mdn_shown_nonrfc() {</span>
<a href="#l196.74"></a><span id="l196.74" class="difflineplus">+add_task(function test_basic_mdn_shown_nonrfc() {</span>
<a href="#l196.75"></a><span id="l196.75">   gotoMsg(4); // This message requests a return receipt.</span>
<a href="#l196.76"></a><span id="l196.76">   assert_mdn_shown(true);</span>
<a href="#l196.77"></a><span id="l196.77">   assert_mdn_text_contains(&quot;ake@example.com&quot;, false); // only name should show</span>
<a href="#l196.78"></a><span id="l196.78" class="difflineminus">-}</span>
<a href="#l196.79"></a><span id="l196.79" class="difflineplus">+});</span>
<a href="#l196.80"></a><span id="l196.80"> </span>
<a href="#l196.81"></a><span id="l196.81"> /**</span>
<a href="#l196.82"></a><span id="l196.82">  * Test that return receipts warns when the mdn address is different.</span>
<a href="#l196.83"></a><span id="l196.83">  * The RFC compliant version.</span>
<a href="#l196.84"></a><span id="l196.84">  */</span>
<a href="#l196.85"></a><span id="l196.85" class="difflineminus">-function test_mdn_when_from_and_disposition_to_differs() {</span>
<a href="#l196.86"></a><span id="l196.86" class="difflineplus">+add_task(function test_mdn_when_from_and_disposition_to_differs() {</span>
<a href="#l196.87"></a><span id="l196.87">   gotoMsg(2); // Should display a notification with warning.</span>
<a href="#l196.88"></a><span id="l196.88">   assert_mdn_shown(true);</span>
<a href="#l196.89"></a><span id="l196.89">   assert_mdn_text_contains(&quot;other@example.com&quot;, true); // address should show</span>
<a href="#l196.90"></a><span id="l196.90" class="difflineminus">-}</span>
<a href="#l196.91"></a><span id="l196.91" class="difflineplus">+});</span>
<a href="#l196.92"></a><span id="l196.92"> </span>
<a href="#l196.93"></a><span id="l196.93"> /**</span>
<a href="#l196.94"></a><span id="l196.94">  * Test that return receipts warns when the mdn address is different.</span>
<a href="#l196.95"></a><span id="l196.95">  * The RFC non-compliant version.</span>
<a href="#l196.96"></a><span id="l196.96">  */</span>
<a href="#l196.97"></a><span id="l196.97" class="difflineminus">-function test_mdn_when_from_and_disposition_to_differs_nonrfc() {</span>
<a href="#l196.98"></a><span id="l196.98" class="difflineplus">+add_task(function test_mdn_when_from_and_disposition_to_differs_nonrfc() {</span>
<a href="#l196.99"></a><span id="l196.99">   gotoMsg(5); // Should display a notification with warning.</span>
<a href="#l196.100"></a><span id="l196.100">   assert_mdn_shown(true);</span>
<a href="#l196.101"></a><span id="l196.101">   assert_mdn_text_contains(&quot;other@example.com&quot;, true); // address should show</span>
<a href="#l196.102"></a><span id="l196.102" class="difflineminus">-}</span>
<a href="#l196.103"></a><span id="l196.103" class="difflineplus">+});</span>
<a href="#l196.104"></a><span id="l196.104"> </span>
<a href="#l196.105"></a><span id="l196.105"> /**</span>
<a href="#l196.106"></a><span id="l196.106">  * Test that return receipts warns when the mdn address consists of multiple</span>
<a href="#l196.107"></a><span id="l196.107">  * addresses.</span>
<a href="#l196.108"></a><span id="l196.108">  */</span>
<a href="#l196.109"></a><span id="l196.109" class="difflineminus">-function test_mdn_when_disposition_to_multi() {</span>
<a href="#l196.110"></a><span id="l196.110" class="difflineplus">+add_task(function test_mdn_when_disposition_to_multi() {</span>
<a href="#l196.111"></a><span id="l196.111">   gotoMsg(3);</span>
<a href="#l196.112"></a><span id="l196.112">   // Should display a notification with warning listing all the addresses.</span>
<a href="#l196.113"></a><span id="l196.113">   assert_mdn_shown(true);</span>
<a href="#l196.114"></a><span id="l196.114">   assert_mdn_text_contains(&quot;ex1@example.com&quot;, true);</span>
<a href="#l196.115"></a><span id="l196.115">   assert_mdn_text_contains(&quot;ex2@example.com&quot;, true);</span>
<a href="#l196.116"></a><span id="l196.116" class="difflineminus">-}</span>
<a href="#l196.117"></a><span id="l196.117" class="difflineplus">+});</span>
<a href="#l196.118"></a><span id="l196.118"> </span>
<a href="#l196.119"></a><span id="l196.119"> /**</span>
<a href="#l196.120"></a><span id="l196.120">  * Test that return receipts warns when the mdn address consists of multiple</span>
<a href="#l196.121"></a><span id="l196.121">  * addresses. Non-RFC compliant version.</span>
<a href="#l196.122"></a><span id="l196.122">  */</span>
<a href="#l196.123"></a><span id="l196.123" class="difflineminus">-function test_mdn_when_disposition_to_multi_nonrfc() {</span>
<a href="#l196.124"></a><span id="l196.124" class="difflineplus">+add_task(function test_mdn_when_disposition_to_multi_nonrfc() {</span>
<a href="#l196.125"></a><span id="l196.125">   gotoMsg(6);</span>
<a href="#l196.126"></a><span id="l196.126">   // Should display a notification with warning listing all the addresses.</span>
<a href="#l196.127"></a><span id="l196.127">   assert_mdn_shown(true);</span>
<a href="#l196.128"></a><span id="l196.128">   assert_mdn_text_contains(&quot;ex1@example.com&quot;, true);</span>
<a href="#l196.129"></a><span id="l196.129">   assert_mdn_text_contains(&quot;ex2@example.com&quot;, true);</span>
<a href="#l196.130"></a><span id="l196.130" class="difflineminus">-}</span>
<a href="#l196.131"></a><span id="l196.131" class="difflineplus">+</span>
<a href="#l196.132"></a><span id="l196.132" class="difflineplus">+  Assert.report(</span>
<a href="#l196.133"></a><span id="l196.133" class="difflineplus">+    false,</span>
<a href="#l196.134"></a><span id="l196.134" class="difflineplus">+    undefined,</span>
<a href="#l196.135"></a><span id="l196.135" class="difflineplus">+    undefined,</span>
<a href="#l196.136"></a><span id="l196.136" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l196.137"></a><span id="l196.137" class="difflineplus">+  );</span>
<a href="#l196.138"></a><span id="l196.138" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l197.1"></a><span id="l197.1">copy from mail/test/mozmill/message-header/evil-attached.eml</span>
<a href="#l197.2"></a><span id="l197.2">copy to mail/test/browser/message-header/data/evil-attached.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l198.1"></a><span id="l198.1">copy from mail/test/mozmill/message-header/evil.eml</span>
<a href="#l198.2"></a><span id="l198.2">copy to mail/test/browser/message-header/data/evil.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l199.1"></a><span id="l199.1">new file mode 100644</span>
<a href="#l199.2"></a><span id="l199.2" class="difflineminus">--- /dev/null</span>
<a href="#l199.3"></a><span id="l199.3" class="difflineplus">+++ b/mail/test/browser/message-reader/browser.ini</span>
<a href="#l199.4"></a><span id="l199.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l199.5"></a><span id="l199.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l199.6"></a><span id="l199.6" class="difflineplus">+prefs =</span>
<a href="#l199.7"></a><span id="l199.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l199.8"></a><span id="l199.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l199.9"></a><span id="l199.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l199.10"></a><span id="l199.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l199.11"></a><span id="l199.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l199.12"></a><span id="l199.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l199.13"></a><span id="l199.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l199.14"></a><span id="l199.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l199.15"></a><span id="l199.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l199.16"></a><span id="l199.16" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l199.17"></a><span id="l199.17" class="difflineplus">+support-files = data/**</span>
<a href="#l199.18"></a><span id="l199.18" class="difflineplus">+</span>
<a href="#l199.19"></a><span id="l199.19" class="difflineplus">+[browser_bug594646.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l200.1"></a><span id="l200.1">copy from mail/test/mozmill/message-reader/test-bug594646.js</span>
<a href="#l200.2"></a><span id="l200.2">copy to mail/test/browser/message-reader/browser_bug594646.js</span>
<a href="#l200.3"></a><span id="l200.3" class="difflineminus">--- a/mail/test/mozmill/message-reader/test-bug594646.js</span>
<a href="#l200.4"></a><span id="l200.4" class="difflineplus">+++ b/mail/test/browser/message-reader/browser_bug594646.js</span>
<a href="#l200.5"></a><span id="l200.5" class="difflineat">@@ -6,35 +6,35 @@</span>
<a href="#l200.6"></a><span id="l200.6"> </span>
<a href="#l200.7"></a><span id="l200.7"> /**</span>
<a href="#l200.8"></a><span id="l200.8">  * Tests that opening an .eml file the body of the message is correct,</span>
<a href="#l200.9"></a><span id="l200.9">  * that it hasn't been UTF-8 mojibake'd.</span>
<a href="#l200.10"></a><span id="l200.10">  */</span>
<a href="#l200.11"></a><span id="l200.11"> </span>
<a href="#l200.12"></a><span id="l200.12"> &quot;use strict&quot;;</span>
<a href="#l200.13"></a><span id="l200.13"> </span>
<a href="#l200.14"></a><span id="l200.14" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l200.15"></a><span id="l200.15" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l200.16"></a><span id="l200.16"> </span>
<a href="#l200.17"></a><span id="l200.17" class="difflineminus">-var { assert_equals, open_message_from_file } = ChromeUtils.import(</span>
<a href="#l200.18"></a><span id="l200.18" class="difflineplus">+var { open_message_from_file } = ChromeUtils.import(</span>
<a href="#l200.19"></a><span id="l200.19">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l200.20"></a><span id="l200.20"> );</span>
<a href="#l200.21"></a><span id="l200.21"> var { close_window } = ChromeUtils.import(</span>
<a href="#l200.22"></a><span id="l200.22">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l200.23"></a><span id="l200.23"> );</span>
<a href="#l200.24"></a><span id="l200.24"> </span>
<a href="#l200.25"></a><span id="l200.25"> var gReferenceTextContent;</span>
<a href="#l200.26"></a><span id="l200.26"> </span>
<a href="#l200.27"></a><span id="l200.27" class="difflineminus">-function setupModule(module) {</span>
<a href="#l200.28"></a><span id="l200.28" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l200.29"></a><span id="l200.29">   gReferenceTextContent = extract_eml_body_textcontent(</span>
<a href="#l200.30"></a><span id="l200.30">     &quot;./bug594646_reference.eml&quot;</span>
<a href="#l200.31"></a><span id="l200.31">   );</span>
<a href="#l200.32"></a><span id="l200.32" class="difflineminus">-}</span>
<a href="#l200.33"></a><span id="l200.33" class="difflineplus">+});</span>
<a href="#l200.34"></a><span id="l200.34"> </span>
<a href="#l200.35"></a><span id="l200.35"> function extract_eml_body_textcontent(eml) {</span>
<a href="#l200.36"></a><span id="l200.36" class="difflineminus">-  let file = os.getFileForPath(os.abspath(eml, os.getFileForPath(__file__)));</span>
<a href="#l200.37"></a><span id="l200.37" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(`data/${eml}`));</span>
<a href="#l200.38"></a><span id="l200.38">   let msgc = open_message_from_file(file);</span>
<a href="#l200.39"></a><span id="l200.39"> </span>
<a href="#l200.40"></a><span id="l200.40">   // Be sure to view message body as Original HTML</span>
<a href="#l200.41"></a><span id="l200.41">   msgc.window.MsgBodyAllowHTML();</span>
<a href="#l200.42"></a><span id="l200.42"> </span>
<a href="#l200.43"></a><span id="l200.43">   let textContent =</span>
<a href="#l200.44"></a><span id="l200.44">     msgc.window.msgWindow.messageWindowDocShell.contentViewer.DOMDocument</span>
<a href="#l200.45"></a><span id="l200.45">       .documentElement.textContent;</span>
<a href="#l200.46"></a><span id="l200.46" class="difflineat">@@ -43,48 +43,54 @@ function extract_eml_body_textcontent(em</span>
<a href="#l200.47"></a><span id="l200.47">   return textContent;</span>
<a href="#l200.48"></a><span id="l200.48"> }</span>
<a href="#l200.49"></a><span id="l200.49"> </span>
<a href="#l200.50"></a><span id="l200.50"> /**</span>
<a href="#l200.51"></a><span id="l200.51">  * Checks that the text content is equal for the .eml files.</span>
<a href="#l200.52"></a><span id="l200.52">  */</span>
<a href="#l200.53"></a><span id="l200.53"> function check_eml_textcontent(eml) {</span>
<a href="#l200.54"></a><span id="l200.54">   let textContent = extract_eml_body_textcontent(eml);</span>
<a href="#l200.55"></a><span id="l200.55" class="difflineminus">-  assert_equals(gReferenceTextContent, textContent);</span>
<a href="#l200.56"></a><span id="l200.56" class="difflineplus">+  Assert.equal(gReferenceTextContent, textContent);</span>
<a href="#l200.57"></a><span id="l200.57"> }</span>
<a href="#l200.58"></a><span id="l200.58"> </span>
<a href="#l200.59"></a><span id="l200.59"> /**</span>
<a href="#l200.60"></a><span id="l200.60">  * This test exercises the bug for reversed http-equiv, content order:</span>
<a href="#l200.61"></a><span id="l200.61">  *  &lt;head&gt;</span>
<a href="#l200.62"></a><span id="l200.62">  *    &lt;meta content=&quot;text/html; charset=ISO-8859-2&quot;; http-equiv=&quot;content-type&quot;&gt;</span>
<a href="#l200.63"></a><span id="l200.63">  *  &lt;/head&gt;</span>
<a href="#l200.64"></a><span id="l200.64">  */</span>
<a href="#l200.65"></a><span id="l200.65" class="difflineminus">-function test_original_html_characters_head_meta_content_charset_httpEq() {</span>
<a href="#l200.66"></a><span id="l200.66" class="difflineminus">-  check_eml_textcontent(&quot;./bug594646_reversed_order_8bit.eml&quot;);</span>
<a href="#l200.67"></a><span id="l200.67" class="difflineminus">-  check_eml_textcontent(&quot;./bug594646_reversed_order_qp.eml&quot;);</span>
<a href="#l200.68"></a><span id="l200.68" class="difflineminus">-  check_eml_textcontent(&quot;./bug594646_reversed_order_b64.eml&quot;);</span>
<a href="#l200.69"></a><span id="l200.69" class="difflineminus">-}</span>
<a href="#l200.70"></a><span id="l200.70" class="difflineplus">+add_task(</span>
<a href="#l200.71"></a><span id="l200.71" class="difflineplus">+  function test_original_html_characters_head_meta_content_charset_httpEq() {</span>
<a href="#l200.72"></a><span id="l200.72" class="difflineplus">+    check_eml_textcontent(&quot;./bug594646_reversed_order_8bit.eml&quot;);</span>
<a href="#l200.73"></a><span id="l200.73" class="difflineplus">+    check_eml_textcontent(&quot;./bug594646_reversed_order_qp.eml&quot;);</span>
<a href="#l200.74"></a><span id="l200.74" class="difflineplus">+    check_eml_textcontent(&quot;./bug594646_reversed_order_b64.eml&quot;);</span>
<a href="#l200.75"></a><span id="l200.75" class="difflineplus">+  }</span>
<a href="#l200.76"></a><span id="l200.76" class="difflineplus">+);</span>
<a href="#l200.77"></a><span id="l200.77"> </span>
<a href="#l200.78"></a><span id="l200.78"> /**</span>
<a href="#l200.79"></a><span id="l200.79">  * This test exercises the bug for newline delimited charset:</span>
<a href="#l200.80"></a><span id="l200.80">  *  &lt;head&gt;</span>
<a href="#l200.81"></a><span id="l200.81">  *    &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;</span>
<a href="#l200.82"></a><span id="l200.82">  *          charset=ISO-8859-2&quot;&gt;</span>
<a href="#l200.83"></a><span id="l200.83">  *  &lt;/head&gt;</span>
<a href="#l200.84"></a><span id="l200.84">  */</span>
<a href="#l200.85"></a><span id="l200.85" class="difflineminus">-function test_original_html_characters_head_meta_httpEq_content_newline_charset() {</span>
<a href="#l200.86"></a><span id="l200.86" class="difflineminus">-  check_eml_textcontent(&quot;./bug594646_newline_charset_8bit.eml&quot;);</span>
<a href="#l200.87"></a><span id="l200.87" class="difflineminus">-  check_eml_textcontent(&quot;./bug594646_newline_charset_qp.eml&quot;);</span>
<a href="#l200.88"></a><span id="l200.88" class="difflineminus">-  check_eml_textcontent(&quot;./bug594646_newline_charset_b64.eml&quot;);</span>
<a href="#l200.89"></a><span id="l200.89" class="difflineminus">-}</span>
<a href="#l200.90"></a><span id="l200.90" class="difflineplus">+add_task(</span>
<a href="#l200.91"></a><span id="l200.91" class="difflineplus">+  function test_original_html_characters_head_meta_httpEq_content_newline_charset() {</span>
<a href="#l200.92"></a><span id="l200.92" class="difflineplus">+    check_eml_textcontent(&quot;./bug594646_newline_charset_8bit.eml&quot;);</span>
<a href="#l200.93"></a><span id="l200.93" class="difflineplus">+    check_eml_textcontent(&quot;./bug594646_newline_charset_qp.eml&quot;);</span>
<a href="#l200.94"></a><span id="l200.94" class="difflineplus">+    check_eml_textcontent(&quot;./bug594646_newline_charset_b64.eml&quot;);</span>
<a href="#l200.95"></a><span id="l200.95" class="difflineplus">+  }</span>
<a href="#l200.96"></a><span id="l200.96" class="difflineplus">+);</span>
<a href="#l200.97"></a><span id="l200.97"> </span>
<a href="#l200.98"></a><span id="l200.98"> /**</span>
<a href="#l200.99"></a><span id="l200.99">  * This test exercises the bug for newline delimited and reverse ordered http-equiv:</span>
<a href="#l200.100"></a><span id="l200.100">  *  &lt;head&gt;</span>
<a href="#l200.101"></a><span id="l200.101">  *    &lt;meta content=&quot;text/html; charset=ISO-8859-2&quot;</span>
<a href="#l200.102"></a><span id="l200.102">  *          http-equiv=&quot;content-type&quot;&gt;</span>
<a href="#l200.103"></a><span id="l200.103">  *  &lt;/head&gt;</span>
<a href="#l200.104"></a><span id="l200.104">  */</span>
<a href="#l200.105"></a><span id="l200.105" class="difflineminus">-function test_original_html_characters_head_meta_content_charset_newline_httpEq() {</span>
<a href="#l200.106"></a><span id="l200.106" class="difflineminus">-  check_eml_textcontent(&quot;./bug594646_newline_httpequiv_8bit.eml&quot;);</span>
<a href="#l200.107"></a><span id="l200.107" class="difflineminus">-  check_eml_textcontent(&quot;./bug594646_newline_httpequiv_qp.eml&quot;);</span>
<a href="#l200.108"></a><span id="l200.108" class="difflineminus">-  check_eml_textcontent(&quot;./bug594646_newline_httpequiv_b64.eml&quot;);</span>
<a href="#l200.109"></a><span id="l200.109" class="difflineminus">-}</span>
<a href="#l200.110"></a><span id="l200.110" class="difflineplus">+add_task(</span>
<a href="#l200.111"></a><span id="l200.111" class="difflineplus">+  function test_original_html_characters_head_meta_content_charset_newline_httpEq() {</span>
<a href="#l200.112"></a><span id="l200.112" class="difflineplus">+    check_eml_textcontent(&quot;./bug594646_newline_httpequiv_8bit.eml&quot;);</span>
<a href="#l200.113"></a><span id="l200.113" class="difflineplus">+    check_eml_textcontent(&quot;./bug594646_newline_httpequiv_qp.eml&quot;);</span>
<a href="#l200.114"></a><span id="l200.114" class="difflineplus">+    check_eml_textcontent(&quot;./bug594646_newline_httpequiv_b64.eml&quot;);</span>
<a href="#l200.115"></a><span id="l200.115" class="difflineplus">+  }</span>
<a href="#l200.116"></a><span id="l200.116" class="difflineplus">+);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l201.1"></a><span id="l201.1">copy from mail/test/mozmill/message-reader/bug594646_newline_charset_8bit.eml</span>
<a href="#l201.2"></a><span id="l201.2">copy to mail/test/browser/message-reader/data/bug594646_newline_charset_8bit.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l202.1"></a><span id="l202.1">copy from mail/test/mozmill/message-reader/bug594646_newline_charset_b64.eml</span>
<a href="#l202.2"></a><span id="l202.2">copy to mail/test/browser/message-reader/data/bug594646_newline_charset_b64.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l203.1"></a><span id="l203.1">copy from mail/test/mozmill/message-reader/bug594646_newline_charset_qp.eml</span>
<a href="#l203.2"></a><span id="l203.2">copy to mail/test/browser/message-reader/data/bug594646_newline_charset_qp.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l204.1"></a><span id="l204.1">copy from mail/test/mozmill/message-reader/bug594646_newline_httpequiv_8bit.eml</span>
<a href="#l204.2"></a><span id="l204.2">copy to mail/test/browser/message-reader/data/bug594646_newline_httpequiv_8bit.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l205.1"></a><span id="l205.1">copy from mail/test/mozmill/message-reader/bug594646_newline_httpequiv_b64.eml</span>
<a href="#l205.2"></a><span id="l205.2">copy to mail/test/browser/message-reader/data/bug594646_newline_httpequiv_b64.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l206.1"></a><span id="l206.1">copy from mail/test/mozmill/message-reader/bug594646_newline_httpequiv_qp.eml</span>
<a href="#l206.2"></a><span id="l206.2">copy to mail/test/browser/message-reader/data/bug594646_newline_httpequiv_qp.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l207.1"></a><span id="l207.1">copy from mail/test/mozmill/message-reader/bug594646_reference.eml</span>
<a href="#l207.2"></a><span id="l207.2">copy to mail/test/browser/message-reader/data/bug594646_reference.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l208.1"></a><span id="l208.1">copy from mail/test/mozmill/message-reader/bug594646_reversed_order_8bit.eml</span>
<a href="#l208.2"></a><span id="l208.2">copy to mail/test/browser/message-reader/data/bug594646_reversed_order_8bit.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l209.1"></a><span id="l209.1">copy from mail/test/mozmill/message-reader/bug594646_reversed_order_b64.eml</span>
<a href="#l209.2"></a><span id="l209.2">copy to mail/test/browser/message-reader/data/bug594646_reversed_order_b64.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l210.1"></a><span id="l210.1">copy from mail/test/mozmill/message-reader/bug594646_reversed_order_qp.eml</span>
<a href="#l210.2"></a><span id="l210.2">copy to mail/test/browser/message-reader/data/bug594646_reversed_order_qp.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l211.1"></a><span id="l211.1">new file mode 100644</span>
<a href="#l211.2"></a><span id="l211.2" class="difflineminus">--- /dev/null</span>
<a href="#l211.3"></a><span id="l211.3" class="difflineplus">+++ b/mail/test/browser/message-window/browser.ini</span>
<a href="#l211.4"></a><span id="l211.4" class="difflineat">@@ -0,0 +1,21 @@</span>
<a href="#l211.5"></a><span id="l211.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l211.6"></a><span id="l211.6" class="difflineplus">+prefs =</span>
<a href="#l211.7"></a><span id="l211.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l211.8"></a><span id="l211.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l211.9"></a><span id="l211.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l211.10"></a><span id="l211.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l211.11"></a><span id="l211.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l211.12"></a><span id="l211.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l211.13"></a><span id="l211.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l211.14"></a><span id="l211.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l211.15"></a><span id="l211.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l211.16"></a><span id="l211.16" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l211.17"></a><span id="l211.17" class="difflineplus">+support-files = data/**</span>
<a href="#l211.18"></a><span id="l211.18" class="difflineplus">+</span>
<a href="#l211.19"></a><span id="l211.19" class="difflineplus">+[browser_autohideMenubar.js]</span>
<a href="#l211.20"></a><span id="l211.20" class="difflineplus">+skip-if = os == &quot;linux&quot; || os = &quot;mac&quot;</span>
<a href="#l211.21"></a><span id="l211.21" class="difflineplus">+[browser_commands.js]</span>
<a href="#l211.22"></a><span id="l211.22" class="difflineplus">+[browser_emlSubject.js]</span>
<a href="#l211.23"></a><span id="l211.23" class="difflineplus">+[browser_messageSidebar.js]</span>
<a href="#l211.24"></a><span id="l211.24" class="difflineplus">+[browser_vcardActions.js]</span>
<a href="#l211.25"></a><span id="l211.25" class="difflineplus">+[browser_viewPlaintext.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l212.1"></a><span id="l212.1">copy from mail/test/mozmill/message-window/test-autohide-menubar.js</span>
<a href="#l212.2"></a><span id="l212.2">copy to mail/test/browser/message-window/browser_autohideMenubar.js</span>
<a href="#l212.3"></a><span id="l212.3" class="difflineminus">--- a/mail/test/mozmill/message-window/test-autohide-menubar.js</span>
<a href="#l212.4"></a><span id="l212.4" class="difflineplus">+++ b/mail/test/browser/message-window/browser_autohideMenubar.js</span>
<a href="#l212.5"></a><span id="l212.5" class="difflineat">@@ -3,17 +3,17 @@</span>
<a href="#l212.6"></a><span id="l212.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l212.7"></a><span id="l212.7"> </span>
<a href="#l212.8"></a><span id="l212.8"> /* Test that the menubar can be set to &quot;autohide&quot;. This should only have an</span>
<a href="#l212.9"></a><span id="l212.9">    effect on Windows. */</span>
<a href="#l212.10"></a><span id="l212.10"> </span>
<a href="#l212.11"></a><span id="l212.11"> &quot;use strict&quot;;</span>
<a href="#l212.12"></a><span id="l212.12"> </span>
<a href="#l212.13"></a><span id="l212.13"> var elib = ChromeUtils.import(</span>
<a href="#l212.14"></a><span id="l212.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l212.15"></a><span id="l212.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l212.16"></a><span id="l212.16"> );</span>
<a href="#l212.17"></a><span id="l212.17"> </span>
<a href="#l212.18"></a><span id="l212.18"> var { open_address_book_window } = ChromeUtils.import(</span>
<a href="#l212.19"></a><span id="l212.19">   &quot;resource://testing-common/mozmill/AddressBookHelpers.jsm&quot;</span>
<a href="#l212.20"></a><span id="l212.20"> );</span>
<a href="#l212.21"></a><span id="l212.21"> var { close_compose_window, open_compose_new_mail } = ChromeUtils.import(</span>
<a href="#l212.22"></a><span id="l212.22">   &quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;</span>
<a href="#l212.23"></a><span id="l212.23"> );</span>
<a href="#l212.24"></a><span id="l212.24" class="difflineat">@@ -28,23 +28,23 @@ var {</span>
<a href="#l212.25"></a><span id="l212.25">   toggle_main_menu,</span>
<a href="#l212.26"></a><span id="l212.26"> } = ChromeUtils.import(</span>
<a href="#l212.27"></a><span id="l212.27">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l212.28"></a><span id="l212.28"> );</span>
<a href="#l212.29"></a><span id="l212.29"> </span>
<a href="#l212.30"></a><span id="l212.30"> var menuFolder;</span>
<a href="#l212.31"></a><span id="l212.31"> var menuState;</span>
<a href="#l212.32"></a><span id="l212.32"> </span>
<a href="#l212.33"></a><span id="l212.33" class="difflineminus">-function setupModule(module) {</span>
<a href="#l212.34"></a><span id="l212.34" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l212.35"></a><span id="l212.35">   menuFolder = create_folder(&quot;menuFolder&quot;);</span>
<a href="#l212.36"></a><span id="l212.36">   make_new_sets_in_folder(menuFolder, [{ count: 1 }]);</span>
<a href="#l212.37"></a><span id="l212.37"> </span>
<a href="#l212.38"></a><span id="l212.38">   // Make the menubar not autohide by default.</span>
<a href="#l212.39"></a><span id="l212.39">   menuState = toggle_main_menu(true);</span>
<a href="#l212.40"></a><span id="l212.40" class="difflineminus">-}</span>
<a href="#l212.41"></a><span id="l212.41" class="difflineplus">+});</span>
<a href="#l212.42"></a><span id="l212.42"> </span>
<a href="#l212.43"></a><span id="l212.43"> /**</span>
<a href="#l212.44"></a><span id="l212.44">  * Set the autohide attribute of the menubar.</span>
<a href="#l212.45"></a><span id="l212.45">  *</span>
<a href="#l212.46"></a><span id="l212.46">  * @param controller the mozmill controller for the window</span>
<a href="#l212.47"></a><span id="l212.47">  * @param elem the element to click on (usually the menubar)</span>
<a href="#l212.48"></a><span id="l212.48">  * @param hide true to hide, false otherwise</span>
<a href="#l212.49"></a><span id="l212.49">  */</span>
<a href="#l212.50"></a><span id="l212.50" class="difflineat">@@ -79,46 +79,42 @@ function help_test_autohide(controller, </span>
<a href="#l212.51"></a><span id="l212.51">     hiddenChecker(false),</span>
<a href="#l212.52"></a><span id="l212.52">     &quot;Menubar should be shown after pressing alt!&quot;</span>
<a href="#l212.53"></a><span id="l212.53">   );</span>
<a href="#l212.54"></a><span id="l212.54"> </span>
<a href="#l212.55"></a><span id="l212.55">   set_autohide_menubar(controller, menubar, false);</span>
<a href="#l212.56"></a><span id="l212.56">   controller.waitFor(hiddenChecker(false), &quot;Menubar should be shown!&quot;);</span>
<a href="#l212.57"></a><span id="l212.57"> }</span>
<a href="#l212.58"></a><span id="l212.58"> </span>
<a href="#l212.59"></a><span id="l212.59" class="difflineminus">-function test_autohidden_menubar_3pane() {</span>
<a href="#l212.60"></a><span id="l212.60" class="difflineplus">+add_task(function test_autohidden_menubar_3pane() {</span>
<a href="#l212.61"></a><span id="l212.61">   let menubar = mc.e(&quot;mail-toolbar-menubar2&quot;);</span>
<a href="#l212.62"></a><span id="l212.62">   help_test_autohide(mc, menubar);</span>
<a href="#l212.63"></a><span id="l212.63" class="difflineminus">-}</span>
<a href="#l212.64"></a><span id="l212.64" class="difflineminus">-test_autohidden_menubar_3pane.EXCLUDED_PLATFORMS = [&quot;darwin&quot;, &quot;linux&quot;];</span>
<a href="#l212.65"></a><span id="l212.65" class="difflineplus">+});</span>
<a href="#l212.66"></a><span id="l212.66"> </span>
<a href="#l212.67"></a><span id="l212.67" class="difflineminus">-function test_autohidden_menubar_message_window() {</span>
<a href="#l212.68"></a><span id="l212.68" class="difflineplus">+add_task(function test_autohidden_menubar_message_window() {</span>
<a href="#l212.69"></a><span id="l212.69">   be_in_folder(menuFolder);</span>
<a href="#l212.70"></a><span id="l212.70">   select_click_row(0);</span>
<a href="#l212.71"></a><span id="l212.71">   let msgc = open_selected_message_in_new_window();</span>
<a href="#l212.72"></a><span id="l212.72">   msgc.window.focus();</span>
<a href="#l212.73"></a><span id="l212.73">   let menubar = msgc.e(&quot;mail-toolbar-menubar2&quot;);</span>
<a href="#l212.74"></a><span id="l212.74"> </span>
<a href="#l212.75"></a><span id="l212.75">   help_test_autohide(msgc, menubar);</span>
<a href="#l212.76"></a><span id="l212.76">   close_message_window(msgc);</span>
<a href="#l212.77"></a><span id="l212.77" class="difflineminus">-}</span>
<a href="#l212.78"></a><span id="l212.78" class="difflineminus">-test_autohidden_menubar_message_window.EXCLUDED_PLATFORMS = [&quot;darwin&quot;, &quot;linux&quot;];</span>
<a href="#l212.79"></a><span id="l212.79" class="difflineplus">+});</span>
<a href="#l212.80"></a><span id="l212.80"> </span>
<a href="#l212.81"></a><span id="l212.81" class="difflineminus">-function test_autohidden_menubar_compose_window() {</span>
<a href="#l212.82"></a><span id="l212.82" class="difflineplus">+add_task(function test_autohidden_menubar_compose_window() {</span>
<a href="#l212.83"></a><span id="l212.83">   let cwc = open_compose_new_mail();</span>
<a href="#l212.84"></a><span id="l212.84">   let menubar = cwc.e(&quot;compose-toolbar-menubar2&quot;);</span>
<a href="#l212.85"></a><span id="l212.85"> </span>
<a href="#l212.86"></a><span id="l212.86">   help_test_autohide(cwc, menubar);</span>
<a href="#l212.87"></a><span id="l212.87">   close_compose_window(cwc);</span>
<a href="#l212.88"></a><span id="l212.88" class="difflineminus">-}</span>
<a href="#l212.89"></a><span id="l212.89" class="difflineminus">-test_autohidden_menubar_compose_window.EXCLUDED_PLATFORMS = [&quot;darwin&quot;, &quot;linux&quot;];</span>
<a href="#l212.90"></a><span id="l212.90" class="difflineplus">+});</span>
<a href="#l212.91"></a><span id="l212.91"> </span>
<a href="#l212.92"></a><span id="l212.92" class="difflineminus">-function test_autohidden_menubar_address_book() {</span>
<a href="#l212.93"></a><span id="l212.93" class="difflineplus">+add_task(function test_autohidden_menubar_address_book() {</span>
<a href="#l212.94"></a><span id="l212.94">   let abc = open_address_book_window();</span>
<a href="#l212.95"></a><span id="l212.95">   let menubar = abc.e(&quot;addrbook-toolbar-menubar2&quot;);</span>
<a href="#l212.96"></a><span id="l212.96"> </span>
<a href="#l212.97"></a><span id="l212.97">   help_test_autohide(abc, menubar);</span>
<a href="#l212.98"></a><span id="l212.98" class="difflineminus">-}</span>
<a href="#l212.99"></a><span id="l212.99" class="difflineminus">-test_autohidden_menubar_address_book.EXCLUDED_PLATFORMS = [&quot;darwin&quot;, &quot;linux&quot;];</span>
<a href="#l212.100"></a><span id="l212.100" class="difflineplus">+});</span>
<a href="#l212.101"></a><span id="l212.101"> </span>
<a href="#l212.102"></a><span id="l212.102" class="difflineminus">-function teardownModule() {</span>
<a href="#l212.103"></a><span id="l212.103" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l212.104"></a><span id="l212.104">   toggle_main_menu(menuState);</span>
<a href="#l212.105"></a><span id="l212.105" class="difflineminus">-}</span>
<a href="#l212.106"></a><span id="l212.106" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l213.1"></a><span id="l213.1">copy from mail/test/mozmill/message-window/test-commands.js</span>
<a href="#l213.2"></a><span id="l213.2">copy to mail/test/browser/message-window/browser_commands.js</span>
<a href="#l213.3"></a><span id="l213.3" class="difflineminus">--- a/mail/test/mozmill/message-window/test-commands.js</span>
<a href="#l213.4"></a><span id="l213.4" class="difflineplus">+++ b/mail/test/browser/message-window/browser_commands.js</span>
<a href="#l213.5"></a><span id="l213.5" class="difflineat">@@ -3,45 +3,44 @@</span>
<a href="#l213.6"></a><span id="l213.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l213.7"></a><span id="l213.7"> </span>
<a href="#l213.8"></a><span id="l213.8"> &quot;use strict&quot;;</span>
<a href="#l213.9"></a><span id="l213.9"> </span>
<a href="#l213.10"></a><span id="l213.10"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l213.11"></a><span id="l213.11">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l213.12"></a><span id="l213.12"> );</span>
<a href="#l213.13"></a><span id="l213.13"> var elib = ChromeUtils.import(</span>
<a href="#l213.14"></a><span id="l213.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l213.15"></a><span id="l213.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l213.16"></a><span id="l213.16"> );</span>
<a href="#l213.17"></a><span id="l213.17" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l213.18"></a><span id="l213.18" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l213.19"></a><span id="l213.19"> </span>
<a href="#l213.20"></a><span id="l213.20"> var {</span>
<a href="#l213.21"></a><span id="l213.21" class="difflineminus">-  assert_equals,</span>
<a href="#l213.22"></a><span id="l213.22">   be_in_folder,</span>
<a href="#l213.23"></a><span id="l213.23">   create_folder,</span>
<a href="#l213.24"></a><span id="l213.24">   make_new_sets_in_folder,</span>
<a href="#l213.25"></a><span id="l213.25">   mc,</span>
<a href="#l213.26"></a><span id="l213.26">   open_message_from_file,</span>
<a href="#l213.27"></a><span id="l213.27">   press_delete,</span>
<a href="#l213.28"></a><span id="l213.28">   select_click_row,</span>
<a href="#l213.29"></a><span id="l213.29"> } = ChromeUtils.import(</span>
<a href="#l213.30"></a><span id="l213.30">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l213.31"></a><span id="l213.31"> );</span>
<a href="#l213.32"></a><span id="l213.32"> var { close_window } = ChromeUtils.import(</span>
<a href="#l213.33"></a><span id="l213.33">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l213.34"></a><span id="l213.34"> );</span>
<a href="#l213.35"></a><span id="l213.35"> </span>
<a href="#l213.36"></a><span id="l213.36"> var folder1, folder2;</span>
<a href="#l213.37"></a><span id="l213.37"> </span>
<a href="#l213.38"></a><span id="l213.38" class="difflineminus">-var setupModule = function(module) {</span>
<a href="#l213.39"></a><span id="l213.39" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l213.40"></a><span id="l213.40">   folder1 = create_folder(&quot;CopyFromFolder&quot;);</span>
<a href="#l213.41"></a><span id="l213.41">   folder2 = create_folder(&quot;CopyToFolder&quot;);</span>
<a href="#l213.42"></a><span id="l213.42">   make_new_sets_in_folder(folder1, [{ count: 1 }]);</span>
<a href="#l213.43"></a><span id="l213.43" class="difflineminus">-};</span>
<a href="#l213.44"></a><span id="l213.44" class="difflineplus">+});</span>
<a href="#l213.45"></a><span id="l213.45"> </span>
<a href="#l213.46"></a><span id="l213.46" class="difflineminus">-function test_copy_eml_message() {</span>
<a href="#l213.47"></a><span id="l213.47" class="difflineplus">+add_task(function test_copy_eml_message() {</span>
<a href="#l213.48"></a><span id="l213.48">   // First, copy an email to a folder and delete it immediately just so it shows</span>
<a href="#l213.49"></a><span id="l213.49">   // up in the recent folders list. This simplifies navigation of the copy</span>
<a href="#l213.50"></a><span id="l213.50">   // context menu.</span>
<a href="#l213.51"></a><span id="l213.51">   be_in_folder(folder1);</span>
<a href="#l213.52"></a><span id="l213.52">   let message = select_click_row(0);</span>
<a href="#l213.53"></a><span id="l213.53">   let array = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l213.54"></a><span id="l213.54">   array.appendElement(message);</span>
<a href="#l213.55"></a><span id="l213.55">   MailServices.copy.CopyMessages(</span>
<a href="#l213.56"></a><span id="l213.56" class="difflineat">@@ -53,25 +52,24 @@ function test_copy_eml_message() {</span>
<a href="#l213.57"></a><span id="l213.57">     mc.window.msgWindow,</span>
<a href="#l213.58"></a><span id="l213.58">     true</span>
<a href="#l213.59"></a><span id="l213.59">   );</span>
<a href="#l213.60"></a><span id="l213.60">   be_in_folder(folder2);</span>
<a href="#l213.61"></a><span id="l213.61">   select_click_row(0);</span>
<a href="#l213.62"></a><span id="l213.62">   press_delete(mc);</span>
<a href="#l213.63"></a><span id="l213.63"> </span>
<a href="#l213.64"></a><span id="l213.64">   // Now, open a .eml file and copy it to our folder.</span>
<a href="#l213.65"></a><span id="l213.65" class="difflineminus">-  let thisFilePath = os.getFileForPath(__file__);</span>
<a href="#l213.66"></a><span id="l213.66" class="difflineminus">-  let file = os.getFileForPath(os.abspath(&quot;./evil.eml&quot;, thisFilePath));</span>
<a href="#l213.67"></a><span id="l213.67" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(&quot;data/evil.eml&quot;));</span>
<a href="#l213.68"></a><span id="l213.68">   let msgc = open_message_from_file(file);</span>
<a href="#l213.69"></a><span id="l213.69"> </span>
<a href="#l213.70"></a><span id="l213.70">   let documentChild = msgc.e(&quot;messagepane&quot;).contentDocument.firstElementChild;</span>
<a href="#l213.71"></a><span id="l213.71">   msgc.rightClick(new elib.Elem(documentChild));</span>
<a href="#l213.72"></a><span id="l213.72">   msgc.click_menus_in_sequence(msgc.e(&quot;mailContext&quot;), [</span>
<a href="#l213.73"></a><span id="l213.73">     { id: &quot;mailContext-copyMenu&quot; },</span>
<a href="#l213.74"></a><span id="l213.74">     { label: &quot;Recent&quot; },</span>
<a href="#l213.75"></a><span id="l213.75">     { label: &quot;CopyToFolder&quot; },</span>
<a href="#l213.76"></a><span id="l213.76">   ]);</span>
<a href="#l213.77"></a><span id="l213.77">   close_window(msgc);</span>
<a href="#l213.78"></a><span id="l213.78"> </span>
<a href="#l213.79"></a><span id="l213.79">   // Make sure the copy worked.</span>
<a href="#l213.80"></a><span id="l213.80">   let copiedMessage = select_click_row(0);</span>
<a href="#l213.81"></a><span id="l213.81" class="difflineminus">-  assert_equals(copiedMessage.mime2DecodedSubject, &quot;An email&quot;);</span>
<a href="#l213.82"></a><span id="l213.82" class="difflineminus">-}</span>
<a href="#l213.83"></a><span id="l213.83" class="difflineplus">+  Assert.equal(copiedMessage.mime2DecodedSubject, &quot;An email&quot;);</span>
<a href="#l213.84"></a><span id="l213.84" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l214.1"></a><span id="l214.1">copy from mail/test/mozmill/message-window/test-eml-subject.js</span>
<a href="#l214.2"></a><span id="l214.2">copy to mail/test/browser/message-window/browser_emlSubject.js</span>
<a href="#l214.3"></a><span id="l214.3" class="difflineminus">--- a/mail/test/mozmill/message-window/test-eml-subject.js</span>
<a href="#l214.4"></a><span id="l214.4" class="difflineplus">+++ b/mail/test/browser/message-window/browser_emlSubject.js</span>
<a href="#l214.5"></a><span id="l214.5" class="difflineat">@@ -3,54 +3,52 @@</span>
<a href="#l214.6"></a><span id="l214.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l214.7"></a><span id="l214.7"> </span>
<a href="#l214.8"></a><span id="l214.8"> /**</span>
<a href="#l214.9"></a><span id="l214.9">  * Tests that opening an .eml file with empty subject works.</span>
<a href="#l214.10"></a><span id="l214.10">  */</span>
<a href="#l214.11"></a><span id="l214.11"> </span>
<a href="#l214.12"></a><span id="l214.12"> &quot;use strict&quot;;</span>
<a href="#l214.13"></a><span id="l214.13"> </span>
<a href="#l214.14"></a><span id="l214.14" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l214.15"></a><span id="l214.15" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l214.16"></a><span id="l214.16"> </span>
<a href="#l214.17"></a><span id="l214.17" class="difflineminus">-var { assert_equals, open_message_from_file } = ChromeUtils.import(</span>
<a href="#l214.18"></a><span id="l214.18" class="difflineplus">+var { open_message_from_file } = ChromeUtils.import(</span>
<a href="#l214.19"></a><span id="l214.19">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l214.20"></a><span id="l214.20"> );</span>
<a href="#l214.21"></a><span id="l214.21"> var { close_window } = ChromeUtils.import(</span>
<a href="#l214.22"></a><span id="l214.22">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l214.23"></a><span id="l214.23"> );</span>
<a href="#l214.24"></a><span id="l214.24"> </span>
<a href="#l214.25"></a><span id="l214.25"> var { StringBundle } = ChromeUtils.import(</span>
<a href="#l214.26"></a><span id="l214.26">   &quot;resource:///modules/StringBundle.js&quot;</span>
<a href="#l214.27"></a><span id="l214.27"> );</span>
<a href="#l214.28"></a><span id="l214.28"> var { AppConstants } = ChromeUtils.import(</span>
<a href="#l214.29"></a><span id="l214.29">   &quot;resource://gre/modules/AppConstants.jsm&quot;</span>
<a href="#l214.30"></a><span id="l214.30"> );</span>
<a href="#l214.31"></a><span id="l214.31"> </span>
<a href="#l214.32"></a><span id="l214.32" class="difflineminus">-var setupModule = function(module) {};</span>
<a href="#l214.33"></a><span id="l214.33" class="difflineminus">-</span>
<a href="#l214.34"></a><span id="l214.34"> function check_eml_window_title(subject, eml) {</span>
<a href="#l214.35"></a><span id="l214.35" class="difflineminus">-  let file = os.getFileForPath(os.abspath(eml, os.getFileForPath(__file__)));</span>
<a href="#l214.36"></a><span id="l214.36" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(`data/${eml}`));</span>
<a href="#l214.37"></a><span id="l214.37">   let msgc = open_message_from_file(file);</span>
<a href="#l214.38"></a><span id="l214.38"> </span>
<a href="#l214.39"></a><span id="l214.39">   let brandBundle = new StringBundle(</span>
<a href="#l214.40"></a><span id="l214.40">     &quot;chrome://branding/locale/brand.properties&quot;</span>
<a href="#l214.41"></a><span id="l214.41">   );</span>
<a href="#l214.42"></a><span id="l214.42">   let productName = brandBundle.get(&quot;brandFullName&quot;);</span>
<a href="#l214.43"></a><span id="l214.43">   let expectedTitle = subject;</span>
<a href="#l214.44"></a><span id="l214.44">   if (expectedTitle &amp;&amp; AppConstants.platform != &quot;macosx&quot;) {</span>
<a href="#l214.45"></a><span id="l214.45">     expectedTitle += &quot; - &quot;;</span>
<a href="#l214.46"></a><span id="l214.46">   }</span>
<a href="#l214.47"></a><span id="l214.47"> </span>
<a href="#l214.48"></a><span id="l214.48">   if (!expectedTitle || AppConstants.platform != &quot;macosx&quot;) {</span>
<a href="#l214.49"></a><span id="l214.49">     expectedTitle += productName;</span>
<a href="#l214.50"></a><span id="l214.50">   }</span>
<a href="#l214.51"></a><span id="l214.51"> </span>
<a href="#l214.52"></a><span id="l214.52" class="difflineminus">-  assert_equals(msgc.window.document.title, expectedTitle);</span>
<a href="#l214.53"></a><span id="l214.53" class="difflineplus">+  Assert.equal(msgc.window.document.title, expectedTitle);</span>
<a href="#l214.54"></a><span id="l214.54">   close_window(msgc);</span>
<a href="#l214.55"></a><span id="l214.55"> }</span>
<a href="#l214.56"></a><span id="l214.56"> </span>
<a href="#l214.57"></a><span id="l214.57" class="difflineminus">-function test_eml_empty_subject() {</span>
<a href="#l214.58"></a><span id="l214.58" class="difflineplus">+add_task(function test_eml_empty_subject() {</span>
<a href="#l214.59"></a><span id="l214.59">   check_eml_window_title(&quot;&quot;, &quot;./emptySubject.eml&quot;);</span>
<a href="#l214.60"></a><span id="l214.60" class="difflineminus">-}</span>
<a href="#l214.61"></a><span id="l214.61" class="difflineplus">+});</span>
<a href="#l214.62"></a><span id="l214.62"> </span>
<a href="#l214.63"></a><span id="l214.63" class="difflineminus">-function test_eml_normal_subject() {</span>
<a href="#l214.64"></a><span id="l214.64" class="difflineplus">+add_task(function test_eml_normal_subject() {</span>
<a href="#l214.65"></a><span id="l214.65">   check_eml_window_title(&quot;An email&quot;, &quot;./evil.eml&quot;);</span>
<a href="#l214.66"></a><span id="l214.66" class="difflineminus">-}</span>
<a href="#l214.67"></a><span id="l214.67" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l215.1"></a><span id="l215.1">copy from mail/test/mozmill/message-window/test-message-sidebar.js</span>
<a href="#l215.2"></a><span id="l215.2">copy to mail/test/browser/message-window/browser_messageSidebar.js</span>
<a href="#l215.3"></a><span id="l215.3" class="difflineminus">--- a/mail/test/mozmill/message-window/test-message-sidebar.js</span>
<a href="#l215.4"></a><span id="l215.4" class="difflineplus">+++ b/mail/test/browser/message-window/browser_messageSidebar.js</span>
<a href="#l215.5"></a><span id="l215.5" class="difflineat">@@ -3,11 +3,18 @@</span>
<a href="#l215.6"></a><span id="l215.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l215.7"></a><span id="l215.7"> </span>
<a href="#l215.8"></a><span id="l215.8"> &quot;use strict&quot;;</span>
<a href="#l215.9"></a><span id="l215.9"> </span>
<a href="#l215.10"></a><span id="l215.10"> var { mc } = ChromeUtils.import(</span>
<a href="#l215.11"></a><span id="l215.11">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l215.12"></a><span id="l215.12"> );</span>
<a href="#l215.13"></a><span id="l215.13"> </span>
<a href="#l215.14"></a><span id="l215.14" class="difflineminus">-function test_messagepane_extension_points_exist() {</span>
<a href="#l215.15"></a><span id="l215.15" class="difflineplus">+add_task(function test_messagepane_extension_points_exist() {</span>
<a href="#l215.16"></a><span id="l215.16">   mc.assertNode(mc.eid(&quot;messagepanewrapper&quot;));</span>
<a href="#l215.17"></a><span id="l215.17" class="difflineminus">-}</span>
<a href="#l215.18"></a><span id="l215.18" class="difflineplus">+</span>
<a href="#l215.19"></a><span id="l215.19" class="difflineplus">+  Assert.report(</span>
<a href="#l215.20"></a><span id="l215.20" class="difflineplus">+    false,</span>
<a href="#l215.21"></a><span id="l215.21" class="difflineplus">+    undefined,</span>
<a href="#l215.22"></a><span id="l215.22" class="difflineplus">+    undefined,</span>
<a href="#l215.23"></a><span id="l215.23" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l215.24"></a><span id="l215.24" class="difflineplus">+  );</span>
<a href="#l215.25"></a><span id="l215.25" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l216.1"></a><span id="l216.1">copy from mail/test/mozmill/message-window/test-vcard-actions.js</span>
<a href="#l216.2"></a><span id="l216.2">copy to mail/test/browser/message-window/browser_vcardActions.js</span>
<a href="#l216.3"></a><span id="l216.3" class="difflineminus">--- a/mail/test/mozmill/message-window/test-vcard-actions.js</span>
<a href="#l216.4"></a><span id="l216.4" class="difflineplus">+++ b/mail/test/browser/message-window/browser_vcardActions.js</span>
<a href="#l216.5"></a><span id="l216.5" class="difflineat">@@ -3,59 +3,60 @@</span>
<a href="#l216.6"></a><span id="l216.6">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l216.7"></a><span id="l216.7"> </span>
<a href="#l216.8"></a><span id="l216.8"> /**</span>
<a href="#l216.9"></a><span id="l216.9">  * Tests for attached vcards.</span>
<a href="#l216.10"></a><span id="l216.10">  */</span>
<a href="#l216.11"></a><span id="l216.11"> </span>
<a href="#l216.12"></a><span id="l216.12"> &quot;use strict&quot;;</span>
<a href="#l216.13"></a><span id="l216.13"> </span>
<a href="#l216.14"></a><span id="l216.14" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l216.15"></a><span id="l216.15" class="difflineplus">+var elementslib = ChromeUtils.import(</span>
<a href="#l216.16"></a><span id="l216.16" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l216.17"></a><span id="l216.17" class="difflineplus">+);</span>
<a href="#l216.18"></a><span id="l216.18" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l216.19"></a><span id="l216.19"> </span>
<a href="#l216.20"></a><span id="l216.20"> var { get_cards_in_all_address_books_for_email } = ChromeUtils.import(</span>
<a href="#l216.21"></a><span id="l216.21">   &quot;resource://testing-common/mozmill/AddressBookHelpers.jsm&quot;</span>
<a href="#l216.22"></a><span id="l216.22"> );</span>
<a href="#l216.23"></a><span id="l216.23" class="difflineminus">-var { assert_equals, open_message_from_file } = ChromeUtils.import(</span>
<a href="#l216.24"></a><span id="l216.24" class="difflineplus">+var { open_message_from_file } = ChromeUtils.import(</span>
<a href="#l216.25"></a><span id="l216.25">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l216.26"></a><span id="l216.26"> );</span>
<a href="#l216.27"></a><span id="l216.27"> var {</span>
<a href="#l216.28"></a><span id="l216.28">   close_window,</span>
<a href="#l216.29"></a><span id="l216.29">   plan_for_modal_dialog,</span>
<a href="#l216.30"></a><span id="l216.30">   wait_for_modal_dialog,</span>
<a href="#l216.31"></a><span id="l216.31"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;);</span>
<a href="#l216.32"></a><span id="l216.32"> </span>
<a href="#l216.33"></a><span id="l216.33"> /**</span>
<a href="#l216.34"></a><span id="l216.34">  * Bug 1374779</span>
<a href="#l216.35"></a><span id="l216.35">  * Check if clicking attached vcard image opens new card dialog and adds a contact.</span>
<a href="#l216.36"></a><span id="l216.36">  */</span>
<a href="#l216.37"></a><span id="l216.37" class="difflineminus">-function test_check_vcard_icon() {</span>
<a href="#l216.38"></a><span id="l216.38" class="difflineminus">-  let file = os.getFileForPath(</span>
<a href="#l216.39"></a><span id="l216.39" class="difflineminus">-    os.abspath(&quot;./test-vcard-icon.eml&quot;, os.getFileForPath(__file__))</span>
<a href="#l216.40"></a><span id="l216.40" class="difflineminus">-  );</span>
<a href="#l216.41"></a><span id="l216.41" class="difflineplus">+add_task(function test_check_vcard_icon() {</span>
<a href="#l216.42"></a><span id="l216.42" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(&quot;data/test-vcard-icon.eml&quot;));</span>
<a href="#l216.43"></a><span id="l216.43">   let msgc = open_message_from_file(file);</span>
<a href="#l216.44"></a><span id="l216.44"> </span>
<a href="#l216.45"></a><span id="l216.45">   let newcards = get_cards_in_all_address_books_for_email(</span>
<a href="#l216.46"></a><span id="l216.46">     &quot;meister@example.com&quot;</span>
<a href="#l216.47"></a><span id="l216.47">   );</span>
<a href="#l216.48"></a><span id="l216.48" class="difflineminus">-  assert_equals(newcards.length, 0);</span>
<a href="#l216.49"></a><span id="l216.49" class="difflineplus">+  Assert.equal(newcards.length, 0);</span>
<a href="#l216.50"></a><span id="l216.50"> </span>
<a href="#l216.51"></a><span id="l216.51">   function subtest_check_card(cardc) {</span>
<a href="#l216.52"></a><span id="l216.52">     // Check new card is properly prefilled.</span>
<a href="#l216.53"></a><span id="l216.53">     let emailField = cardc.e(&quot;PrimaryEmail&quot;);</span>
<a href="#l216.54"></a><span id="l216.54" class="difflineminus">-    assert_equals(emailField.value, &quot;meister@example.com&quot;);</span>
<a href="#l216.55"></a><span id="l216.55" class="difflineplus">+    Assert.equal(emailField.value, &quot;meister@example.com&quot;);</span>
<a href="#l216.56"></a><span id="l216.56">     cardc.window.document.documentElement.acceptDialog();</span>
<a href="#l216.57"></a><span id="l216.57">   }</span>
<a href="#l216.58"></a><span id="l216.58"> </span>
<a href="#l216.59"></a><span id="l216.59">   // Click icon on the vcard block.</span>
<a href="#l216.60"></a><span id="l216.60">   let vcard = msgc</span>
<a href="#l216.61"></a><span id="l216.61">     .e(&quot;messagepane&quot;)</span>
<a href="#l216.62"></a><span id="l216.62">     .contentDocument.querySelector(&quot;.moz-vcard-badge&quot;);</span>
<a href="#l216.63"></a><span id="l216.63">   // Check new card dialog opens.</span>
<a href="#l216.64"></a><span id="l216.64">   plan_for_modal_dialog(&quot;mailnews:newcarddialog&quot;, subtest_check_card);</span>
<a href="#l216.65"></a><span id="l216.65">   msgc.click(new elementslib.Elem(vcard));</span>
<a href="#l216.66"></a><span id="l216.66">   wait_for_modal_dialog(&quot;mailnews:newcarddialog&quot;);</span>
<a href="#l216.67"></a><span id="l216.67"> </span>
<a href="#l216.68"></a><span id="l216.68">   // Check new card was created from the vcard.</span>
<a href="#l216.69"></a><span id="l216.69">   newcards = get_cards_in_all_address_books_for_email(&quot;meister@example.com&quot;);</span>
<a href="#l216.70"></a><span id="l216.70" class="difflineminus">-  assert_equals(newcards.length, 1);</span>
<a href="#l216.71"></a><span id="l216.71" class="difflineplus">+  Assert.equal(newcards.length, 1);</span>
<a href="#l216.72"></a><span id="l216.72"> </span>
<a href="#l216.73"></a><span id="l216.73">   close_window(msgc);</span>
<a href="#l216.74"></a><span id="l216.74" class="difflineminus">-}</span>
<a href="#l216.75"></a><span id="l216.75" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l217.1"></a><span id="l217.1">copy from mail/test/mozmill/message-window/test-view-plaintext.js</span>
<a href="#l217.2"></a><span id="l217.2">copy to mail/test/browser/message-window/browser_viewPlaintext.js</span>
<a href="#l217.3"></a><span id="l217.3" class="difflineminus">--- a/mail/test/mozmill/message-window/test-view-plaintext.js</span>
<a href="#l217.4"></a><span id="l217.4" class="difflineplus">+++ b/mail/test/browser/message-window/browser_viewPlaintext.js</span>
<a href="#l217.5"></a><span id="l217.5" class="difflineat">@@ -3,19 +3,19 @@</span>
<a href="#l217.6"></a><span id="l217.6">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l217.7"></a><span id="l217.7"> </span>
<a href="#l217.8"></a><span id="l217.8"> /**</span>
<a href="#l217.9"></a><span id="l217.9">  * Tests that the plain text part of multipart/alternative messages can be correctly viewed.</span>
<a href="#l217.10"></a><span id="l217.10">  */</span>
<a href="#l217.11"></a><span id="l217.11"> </span>
<a href="#l217.12"></a><span id="l217.12"> &quot;use strict&quot;;</span>
<a href="#l217.13"></a><span id="l217.13"> </span>
<a href="#l217.14"></a><span id="l217.14" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l217.15"></a><span id="l217.15" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l217.16"></a><span id="l217.16"> </span>
<a href="#l217.17"></a><span id="l217.17" class="difflineminus">-var { assert_false, assert_true, open_message_from_file } = ChromeUtils.import(</span>
<a href="#l217.18"></a><span id="l217.18" class="difflineplus">+var { open_message_from_file } = ChromeUtils.import(</span>
<a href="#l217.19"></a><span id="l217.19">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l217.20"></a><span id="l217.20"> );</span>
<a href="#l217.21"></a><span id="l217.21"> var { close_window } = ChromeUtils.import(</span>
<a href="#l217.22"></a><span id="l217.22">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l217.23"></a><span id="l217.23"> );</span>
<a href="#l217.24"></a><span id="l217.24"> </span>
<a href="#l217.25"></a><span id="l217.25"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l217.26"></a><span id="l217.26"> </span>
<a href="#l217.27"></a><span id="l217.27" class="difflineat">@@ -26,48 +26,46 @@ var { Services } = ChromeUtils.import(&quot;r</span>
<a href="#l217.28"></a><span id="l217.28">  * @param aExpected       Expected content.</span>
<a href="#l217.29"></a><span id="l217.29">  * @param aDontWantToSee  Content of other MIME parts we don't want to see.</span>
<a href="#l217.30"></a><span id="l217.30">  */</span>
<a href="#l217.31"></a><span id="l217.31"> function check_content(aWindow, aExpected, aDontWantToSee) {</span>
<a href="#l217.32"></a><span id="l217.32">   let messagePane = aWindow.document.getElementById(&quot;messagepane&quot;);</span>
<a href="#l217.33"></a><span id="l217.33">   let messageContent = messagePane.contentDocument.firstChild.textContent;</span>
<a href="#l217.34"></a><span id="l217.34"> </span>
<a href="#l217.35"></a><span id="l217.35">   if (aExpected != aDontWantToSee) {</span>
<a href="#l217.36"></a><span id="l217.36" class="difflineminus">-    assert_true(</span>
<a href="#l217.37"></a><span id="l217.37" class="difflineplus">+    Assert.ok(</span>
<a href="#l217.38"></a><span id="l217.38">       messageContent.includes(aExpected),</span>
<a href="#l217.39"></a><span id="l217.39">       &quot;Didn't find expected content&quot;</span>
<a href="#l217.40"></a><span id="l217.40">     );</span>
<a href="#l217.41"></a><span id="l217.41" class="difflineminus">-    assert_false(</span>
<a href="#l217.42"></a><span id="l217.42" class="difflineminus">-      messageContent.includes(aDontWantToSee),</span>
<a href="#l217.43"></a><span id="l217.43" class="difflineplus">+    Assert.ok(</span>
<a href="#l217.44"></a><span id="l217.44" class="difflineplus">+      !messageContent.includes(aDontWantToSee),</span>
<a href="#l217.45"></a><span id="l217.45">       &quot;Found content that shouldn't be there&quot;</span>
<a href="#l217.46"></a><span id="l217.46">     );</span>
<a href="#l217.47"></a><span id="l217.47">   } else {</span>
<a href="#l217.48"></a><span id="l217.48">     let ind = messageContent.indexOf(aExpected);</span>
<a href="#l217.49"></a><span id="l217.49" class="difflineminus">-    assert_true(ind &gt;= 0, &quot;Didn't find expected content&quot;);</span>
<a href="#l217.50"></a><span id="l217.50" class="difflineplus">+    Assert.ok(ind &gt;= 0, &quot;Didn't find expected content&quot;);</span>
<a href="#l217.51"></a><span id="l217.51">     if (ind &gt;= 0) {</span>
<a href="#l217.52"></a><span id="l217.52" class="difflineminus">-      assert_false(</span>
<a href="#l217.53"></a><span id="l217.53" class="difflineminus">-        messageContent.substr(ind + aExpected.length).includes(aExpected),</span>
<a href="#l217.54"></a><span id="l217.54" class="difflineplus">+      Assert.ok(</span>
<a href="#l217.55"></a><span id="l217.55" class="difflineplus">+        !messageContent.substr(ind + aExpected.length).includes(aExpected),</span>
<a href="#l217.56"></a><span id="l217.56">         &quot;Found content a second time&quot;</span>
<a href="#l217.57"></a><span id="l217.57">       );</span>
<a href="#l217.58"></a><span id="l217.58">     }</span>
<a href="#l217.59"></a><span id="l217.59">   }</span>
<a href="#l217.60"></a><span id="l217.60"> }</span>
<a href="#l217.61"></a><span id="l217.61"> </span>
<a href="#l217.62"></a><span id="l217.62"> /**</span>
<a href="#l217.63"></a><span id="l217.63">  * Load a message from a file and display it as plain text and HTML. Check that the</span>
<a href="#l217.64"></a><span id="l217.64">  * correct MIME part is displayed.</span>
<a href="#l217.65"></a><span id="l217.65">  *</span>
<a href="#l217.66"></a><span id="l217.66">  * @param aFilePath            Path to the file containing the message to load and display.</span>
<a href="#l217.67"></a><span id="l217.67">  * @param aExpectedPlainText   Expected content when viewed as plain text.</span>
<a href="#l217.68"></a><span id="l217.68">  * @param aExpectedHTML        Expected content when viewed as HTML.</span>
<a href="#l217.69"></a><span id="l217.69">  */</span>
<a href="#l217.70"></a><span id="l217.70"> function checkSingleMessage(aFilePath, aExpectedPlainText, aExpectedHTML) {</span>
<a href="#l217.71"></a><span id="l217.71" class="difflineminus">-  let file = os.getFileForPath(</span>
<a href="#l217.72"></a><span id="l217.72" class="difflineminus">-    os.abspath(aFilePath, os.getFileForPath(__file__))</span>
<a href="#l217.73"></a><span id="l217.73" class="difflineminus">-  );</span>
<a href="#l217.74"></a><span id="l217.74" class="difflineplus">+  let file = new FileUtils.File(getTestFilePath(`data/${aFilePath}`));</span>
<a href="#l217.75"></a><span id="l217.75"> </span>
<a href="#l217.76"></a><span id="l217.76">   // Load and display as plain text.</span>
<a href="#l217.77"></a><span id="l217.77">   Services.prefs.setBoolPref(&quot;mailnews.display.prefer_plaintext&quot;, true);</span>
<a href="#l217.78"></a><span id="l217.78">   Services.prefs.setIntPref(&quot;mailnews.display.html_as&quot;, 1);</span>
<a href="#l217.79"></a><span id="l217.79">   let msgc = open_message_from_file(file);</span>
<a href="#l217.80"></a><span id="l217.80">   check_content(msgc.window, aExpectedPlainText, aExpectedHTML);</span>
<a href="#l217.81"></a><span id="l217.81">   close_window(msgc);</span>
<a href="#l217.82"></a><span id="l217.82"> </span>
<a href="#l217.83"></a><span id="l217.83" class="difflineat">@@ -78,17 +76,17 @@ function checkSingleMessage(aFilePath, a</span>
<a href="#l217.84"></a><span id="l217.84">   check_content(msgc.window, aExpectedHTML, aExpectedPlainText);</span>
<a href="#l217.85"></a><span id="l217.85">   close_window(msgc);</span>
<a href="#l217.86"></a><span id="l217.86"> }</span>
<a href="#l217.87"></a><span id="l217.87"> </span>
<a href="#l217.88"></a><span id="l217.88"> /**</span>
<a href="#l217.89"></a><span id="l217.89">  * Tests that messages with various MIME parts are shown correctly when displayed</span>
<a href="#l217.90"></a><span id="l217.90">  * as plain text or HTML.</span>
<a href="#l217.91"></a><span id="l217.91">  */</span>
<a href="#l217.92"></a><span id="l217.92" class="difflineminus">-function test_view() {</span>
<a href="#l217.93"></a><span id="l217.93" class="difflineplus">+add_task(function test_view() {</span>
<a href="#l217.94"></a><span id="l217.94">   // First the straight forward tests:</span>
<a href="#l217.95"></a><span id="l217.95">   // 1) multipart/alternative</span>
<a href="#l217.96"></a><span id="l217.96">   // 2) multipart/alternative with embedded multipart/related</span>
<a href="#l217.97"></a><span id="l217.97">   // 3) multipart/alternative with embedded multipart/related embedded in multipart/mixed</span>
<a href="#l217.98"></a><span id="l217.98">   checkSingleMessage(&quot;./test-alt.eml&quot;, &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l217.99"></a><span id="l217.99">   checkSingleMessage(&quot;./test-alt-rel.eml&quot;, &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l217.100"></a><span id="l217.100">   checkSingleMessage(</span>
<a href="#l217.101"></a><span id="l217.101">     &quot;./test-alt-rel-with-attach.eml&quot;,</span>
<a href="#l217.102"></a><span id="l217.102" class="difflineat">@@ -116,14 +114,14 @@ function test_view() {</span>
<a href="#l217.103"></a><span id="l217.103"> </span>
<a href="#l217.104"></a><span id="l217.104">   // Now some cases that don't work yet.</span>
<a href="#l217.105"></a><span id="l217.105">   // 9) multipart/related with embedded multipart/alternative</span>
<a href="#l217.106"></a><span id="l217.106">   checkSingleMessage(&quot;./test-rel-alt.eml&quot;, &quot;HTML Body&quot;, &quot;HTML Body&quot;);</span>
<a href="#l217.107"></a><span id="l217.107"> </span>
<a href="#l217.108"></a><span id="l217.108">   // Bug 1367156: Rogue message which has an image as the last part.</span>
<a href="#l217.109"></a><span id="l217.109">   checkSingleMessage(&quot;./test-alt-rogue.eml&quot;, &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l217.110"></a><span id="l217.110">   checkSingleMessage(&quot;./test-alt-rogue2.eml&quot;, &quot;Plain Text&quot;, &quot;HTML Body&quot;);</span>
<a href="#l217.111"></a><span id="l217.111" class="difflineminus">-}</span>
<a href="#l217.112"></a><span id="l217.112" class="difflineplus">+});</span>
<a href="#l217.113"></a><span id="l217.113"> </span>
<a href="#l217.114"></a><span id="l217.114" class="difflineminus">-function teardownModule() {</span>
<a href="#l217.115"></a><span id="l217.115" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l217.116"></a><span id="l217.116">   Services.prefs.clearUserPref(&quot;mailnews.display.prefer_plaintext&quot;);</span>
<a href="#l217.117"></a><span id="l217.117">   Services.prefs.clearUserPref(&quot;mailnews.display.html_as&quot;);</span>
<a href="#l217.118"></a><span id="l217.118" class="difflineminus">-}</span>
<a href="#l217.119"></a><span id="l217.119" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l218.1"></a><span id="l218.1">copy from mail/test/mozmill/message-window/emptySubject.eml</span>
<a href="#l218.2"></a><span id="l218.2">copy to mail/test/browser/message-window/data/emptySubject.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l219.1"></a><span id="l219.1">copy from mail/test/mozmill/message-window/evil.eml</span>
<a href="#l219.2"></a><span id="l219.2">copy to mail/test/browser/message-window/data/evil.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l220.1"></a><span id="l220.1">copy from mail/test/mozmill/message-window/test-alt-HTML-missing.eml</span>
<a href="#l220.2"></a><span id="l220.2">copy to mail/test/browser/message-window/data/test-alt-HTML-missing.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l221.1"></a><span id="l221.1">copy from mail/test/mozmill/message-window/test-alt-plain-HTML-reversed.eml</span>
<a href="#l221.2"></a><span id="l221.2">copy to mail/test/browser/message-window/data/test-alt-plain-HTML-reversed.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l222.1"></a><span id="l222.1">copy from mail/test/mozmill/message-window/test-alt-plain-missing.eml</span>
<a href="#l222.2"></a><span id="l222.2">copy to mail/test/browser/message-window/data/test-alt-plain-missing.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l223.1"></a><span id="l223.1">copy from mail/test/mozmill/message-window/test-alt-rel-text.eml</span>
<a href="#l223.2"></a><span id="l223.2">copy to mail/test/browser/message-window/data/test-alt-rel-text.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l224.1"></a><span id="l224.1">copy from mail/test/mozmill/message-window/test-alt-rel-with-attach.eml</span>
<a href="#l224.2"></a><span id="l224.2">copy to mail/test/browser/message-window/data/test-alt-rel-with-attach.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l225.1"></a><span id="l225.1">copy from mail/test/mozmill/message-window/test-alt-rel.eml</span>
<a href="#l225.2"></a><span id="l225.2">copy to mail/test/browser/message-window/data/test-alt-rel.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l226.1"></a><span id="l226.1">copy from mail/test/mozmill/message-window/test-alt-rogue.eml</span>
<a href="#l226.2"></a><span id="l226.2">copy to mail/test/browser/message-window/data/test-alt-rogue.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l227.1"></a><span id="l227.1">copy from mail/test/mozmill/message-window/test-alt-rogue2.eml</span>
<a href="#l227.2"></a><span id="l227.2">copy to mail/test/browser/message-window/data/test-alt-rogue2.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l228.1"></a><span id="l228.1">copy from mail/test/mozmill/message-window/test-alt.eml</span>
<a href="#l228.2"></a><span id="l228.2">copy to mail/test/browser/message-window/data/test-alt.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l229.1"></a><span id="l229.1">copy from mail/test/mozmill/message-window/test-rel-alt.eml</span>
<a href="#l229.2"></a><span id="l229.2">copy to mail/test/browser/message-window/data/test-rel-alt.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l230.1"></a><span id="l230.1">copy from mail/test/mozmill/message-window/test-triple-alt.eml</span>
<a href="#l230.2"></a><span id="l230.2">copy to mail/test/browser/message-window/data/test-triple-alt.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l231.1"></a><span id="l231.1">copy from mail/test/mozmill/message-window/test-vcard-icon.eml</span>
<a href="#l231.2"></a><span id="l231.2">copy to mail/test/browser/message-window/data/test-vcard-icon.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l232.1"></a><span id="l232.1">new file mode 100644</span>
<a href="#l232.2"></a><span id="l232.2" class="difflineminus">--- /dev/null</span>
<a href="#l232.3"></a><span id="l232.3" class="difflineplus">+++ b/mail/test/browser/moz.build</span>
<a href="#l232.4"></a><span id="l232.4" class="difflineat">@@ -0,0 +1,40 @@</span>
<a href="#l232.5"></a><span id="l232.5" class="difflineplus">+# vim: set filetype=python:</span>
<a href="#l232.6"></a><span id="l232.6" class="difflineplus">+# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l232.7"></a><span id="l232.7" class="difflineplus">+# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l232.8"></a><span id="l232.8" class="difflineplus">+# file, you can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l232.9"></a><span id="l232.9" class="difflineplus">+</span>
<a href="#l232.10"></a><span id="l232.10" class="difflineplus">+BROWSER_CHROME_MANIFESTS += [</span>
<a href="#l232.11"></a><span id="l232.11" class="difflineplus">+    'account/browser.ini',</span>
<a href="#l232.12"></a><span id="l232.12" class="difflineplus">+    'addrbook/browser.ini',</span>
<a href="#l232.13"></a><span id="l232.13" class="difflineplus">+    'attachment/browser.ini',</span>
<a href="#l232.14"></a><span id="l232.14" class="difflineplus">+    'cloudfile/browser.ini',</span>
<a href="#l232.15"></a><span id="l232.15" class="difflineplus">+    'composition/browser.ini',</span>
<a href="#l232.16"></a><span id="l232.16" class="difflineplus">+    'content-policy/browser.ini',</span>
<a href="#l232.17"></a><span id="l232.17" class="difflineplus">+    'content-tabs/browser.ini',</span>
<a href="#l232.18"></a><span id="l232.18" class="difflineplus">+    'cookies/browser.ini',</span>
<a href="#l232.19"></a><span id="l232.19" class="difflineplus">+    'downloads/browser.ini',</span>
<a href="#l232.20"></a><span id="l232.20" class="difflineplus">+    'folder-display/browser.ini',</span>
<a href="#l232.21"></a><span id="l232.21" class="difflineplus">+    'folder-pane/browser.ini',</span>
<a href="#l232.22"></a><span id="l232.22" class="difflineplus">+    'folder-tree-modes/browser.ini',</span>
<a href="#l232.23"></a><span id="l232.23" class="difflineplus">+    'folder-widget/browser.ini',</span>
<a href="#l232.24"></a><span id="l232.24" class="difflineplus">+    'im/browser.ini',</span>
<a href="#l232.25"></a><span id="l232.25" class="difflineplus">+    'instrumentation/browser.ini',</span>
<a href="#l232.26"></a><span id="l232.26" class="difflineplus">+    'junk-commands/browser.ini',</span>
<a href="#l232.27"></a><span id="l232.27" class="difflineplus">+    'keyboard/browser.ini',</span>
<a href="#l232.28"></a><span id="l232.28" class="difflineplus">+    'message-header/browser.ini',</span>
<a href="#l232.29"></a><span id="l232.29" class="difflineplus">+    'message-reader/browser.ini',</span>
<a href="#l232.30"></a><span id="l232.30" class="difflineplus">+    'message-window/browser.ini',</span>
<a href="#l232.31"></a><span id="l232.31" class="difflineplus">+    'multiple-identities/browser.ini',</span>
<a href="#l232.32"></a><span id="l232.32" class="difflineplus">+    'newmailaccount/browser.ini',</span>
<a href="#l232.33"></a><span id="l232.33" class="difflineplus">+    'notification/browser.ini',</span>
<a href="#l232.34"></a><span id="l232.34" class="difflineplus">+    'override-main-menu-collapse/browser.ini',</span>
<a href="#l232.35"></a><span id="l232.35" class="difflineplus">+    'pref-window/browser.ini',</span>
<a href="#l232.36"></a><span id="l232.36" class="difflineplus">+    'quick-filter-bar/browser.ini',</span>
<a href="#l232.37"></a><span id="l232.37" class="difflineplus">+    'search-window/browser.ini',</span>
<a href="#l232.38"></a><span id="l232.38" class="difflineplus">+    'session-store/browser.ini',</span>
<a href="#l232.39"></a><span id="l232.39" class="difflineplus">+    'smime/browser.ini',</span>
<a href="#l232.40"></a><span id="l232.40" class="difflineplus">+    'startup-firstrun/browser.ini',</span>
<a href="#l232.41"></a><span id="l232.41" class="difflineplus">+    'subscribe/browser.ini',</span>
<a href="#l232.42"></a><span id="l232.42" class="difflineplus">+    'tabmail/browser.ini',</span>
<a href="#l232.43"></a><span id="l232.43" class="difflineplus">+    'utils/browser.ini',</span>
<a href="#l232.44"></a><span id="l232.44" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l233.1"></a><span id="l233.1">new file mode 100644</span>
<a href="#l233.2"></a><span id="l233.2" class="difflineminus">--- /dev/null</span>
<a href="#l233.3"></a><span id="l233.3" class="difflineplus">+++ b/mail/test/browser/multiple-identities/browser.ini</span>
<a href="#l233.4"></a><span id="l233.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l233.5"></a><span id="l233.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l233.6"></a><span id="l233.6" class="difflineplus">+prefs =</span>
<a href="#l233.7"></a><span id="l233.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l233.8"></a><span id="l233.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l233.9"></a><span id="l233.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l233.10"></a><span id="l233.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l233.11"></a><span id="l233.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l233.12"></a><span id="l233.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l233.13"></a><span id="l233.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l233.14"></a><span id="l233.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l233.15"></a><span id="l233.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l233.16"></a><span id="l233.16" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l233.17"></a><span id="l233.17" class="difflineplus">+</span>
<a href="#l233.18"></a><span id="l233.18" class="difflineplus">+[browser_displayNames.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l234.1"></a><span id="l234.1">copy from mail/test/mozmill/multiple-identities/test-display-names.js</span>
<a href="#l234.2"></a><span id="l234.2">copy to mail/test/browser/multiple-identities/browser_displayNames.js</span>
<a href="#l234.3"></a><span id="l234.3" class="difflineminus">--- a/mail/test/mozmill/multiple-identities/test-display-names.js</span>
<a href="#l234.4"></a><span id="l234.4" class="difflineplus">+++ b/mail/test/browser/multiple-identities/browser_displayNames.js</span>
<a href="#l234.5"></a><span id="l234.5" class="difflineat">@@ -9,17 +9,16 @@</span>
<a href="#l234.6"></a><span id="l234.6"> </span>
<a href="#l234.7"></a><span id="l234.7"> &quot;use strict&quot;;</span>
<a href="#l234.8"></a><span id="l234.8"> </span>
<a href="#l234.9"></a><span id="l234.9"> var { ensure_card_exists, ensure_no_card_exists } = ChromeUtils.import(</span>
<a href="#l234.10"></a><span id="l234.10">   &quot;resource://testing-common/mozmill/AddressBookHelpers.jsm&quot;</span>
<a href="#l234.11"></a><span id="l234.11"> );</span>
<a href="#l234.12"></a><span id="l234.12"> var {</span>
<a href="#l234.13"></a><span id="l234.13">   add_message_to_folder,</span>
<a href="#l234.14"></a><span id="l234.14" class="difflineminus">-  assert_true,</span>
<a href="#l234.15"></a><span id="l234.15">   be_in_folder,</span>
<a href="#l234.16"></a><span id="l234.16">   create_folder,</span>
<a href="#l234.17"></a><span id="l234.17">   create_message,</span>
<a href="#l234.18"></a><span id="l234.18">   mc,</span>
<a href="#l234.19"></a><span id="l234.19">   select_click_row,</span>
<a href="#l234.20"></a><span id="l234.20"> } = ChromeUtils.import(</span>
<a href="#l234.21"></a><span id="l234.21">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l234.22"></a><span id="l234.22"> );</span>
<a href="#l234.23"></a><span id="l234.23" class="difflineat">@@ -34,17 +33,17 @@ var decoyFolder;</span>
<a href="#l234.24"></a><span id="l234.24"> var localAccount;</span>
<a href="#l234.25"></a><span id="l234.25"> var secondIdentity;</span>
<a href="#l234.26"></a><span id="l234.26"> var myEmail = &quot;sender@nul.invalid&quot;; // Dictated by messagerInjector.js</span>
<a href="#l234.27"></a><span id="l234.27"> var friendEmail = &quot;carl@sagan.invalid&quot;;</span>
<a href="#l234.28"></a><span id="l234.28"> var friendName = &quot;Carl Sagan&quot;;</span>
<a href="#l234.29"></a><span id="l234.29"> var headertoFieldMe;</span>
<a href="#l234.30"></a><span id="l234.30"> var collectedAddresses;</span>
<a href="#l234.31"></a><span id="l234.31"> </span>
<a href="#l234.32"></a><span id="l234.32" class="difflineminus">-function setupModule(module) {</span>
<a href="#l234.33"></a><span id="l234.33" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l234.34"></a><span id="l234.34">   localAccount = MailServices.accounts.FindAccountForServer(</span>
<a href="#l234.35"></a><span id="l234.35">     MailServices.accounts.localFoldersServer</span>
<a href="#l234.36"></a><span id="l234.36">   );</span>
<a href="#l234.37"></a><span id="l234.37"> </span>
<a href="#l234.38"></a><span id="l234.38">   // We need to make sure we have only one identity:</span>
<a href="#l234.39"></a><span id="l234.39">   // 1) Delete all accounts except for Local Folders</span>
<a href="#l234.40"></a><span id="l234.40">   for (let i = MailServices.accounts.accounts.length - 1; i &gt;= 0; i--) {</span>
<a href="#l234.41"></a><span id="l234.41">     let account = MailServices.accounts.accounts.queryElementAt(</span>
<a href="#l234.42"></a><span id="l234.42" class="difflineat">@@ -83,35 +82,35 @@ function setupModule(module) {</span>
<a href="#l234.43"></a><span id="l234.43">   collectedAddresses = MailServices.ab.getDirectory(</span>
<a href="#l234.44"></a><span id="l234.44">     &quot;jsaddrbook://history.sqlite&quot;</span>
<a href="#l234.45"></a><span id="l234.45">   );</span>
<a href="#l234.46"></a><span id="l234.46"> </span>
<a href="#l234.47"></a><span id="l234.47">   let bundle = Services.strings.createBundle(</span>
<a href="#l234.48"></a><span id="l234.48">     &quot;chrome://messenger/locale/messenger.properties&quot;</span>
<a href="#l234.49"></a><span id="l234.49">   );</span>
<a href="#l234.50"></a><span id="l234.50">   headertoFieldMe = bundle.GetStringFromName(&quot;headertoFieldMe&quot;);</span>
<a href="#l234.51"></a><span id="l234.51" class="difflineminus">-}</span>
<a href="#l234.52"></a><span id="l234.52" class="difflineplus">+});</span>
<a href="#l234.53"></a><span id="l234.53"> </span>
<a href="#l234.54"></a><span id="l234.54"> function ensure_single_identity() {</span>
<a href="#l234.55"></a><span id="l234.55">   if (localAccount.identities.length &gt; 1) {</span>
<a href="#l234.56"></a><span id="l234.56">     localAccount.removeIdentity(secondIdentity);</span>
<a href="#l234.57"></a><span id="l234.57">   }</span>
<a href="#l234.58"></a><span id="l234.58" class="difflineminus">-  assert_true(</span>
<a href="#l234.59"></a><span id="l234.59" class="difflineplus">+  Assert.ok(</span>
<a href="#l234.60"></a><span id="l234.60">     MailServices.accounts.allIdentities.length == 1,</span>
<a href="#l234.61"></a><span id="l234.61">     &quot;Expected 1 identity, but got &quot; +</span>
<a href="#l234.62"></a><span id="l234.62">       MailServices.accounts.allIdentities.length +</span>
<a href="#l234.63"></a><span id="l234.63">       &quot; identities&quot;</span>
<a href="#l234.64"></a><span id="l234.64">   );</span>
<a href="#l234.65"></a><span id="l234.65"> }</span>
<a href="#l234.66"></a><span id="l234.66"> </span>
<a href="#l234.67"></a><span id="l234.67"> function ensure_multiple_identities() {</span>
<a href="#l234.68"></a><span id="l234.68">   if (localAccount.identities.length == 1) {</span>
<a href="#l234.69"></a><span id="l234.69">     localAccount.addIdentity(secondIdentity);</span>
<a href="#l234.70"></a><span id="l234.70">   }</span>
<a href="#l234.71"></a><span id="l234.71" class="difflineminus">-  assert_true(</span>
<a href="#l234.72"></a><span id="l234.72" class="difflineplus">+  Assert.ok(</span>
<a href="#l234.73"></a><span id="l234.73">     MailServices.accounts.allIdentities.length &gt; 1,</span>
<a href="#l234.74"></a><span id="l234.74">     &quot;Expected multiple identities, but got only one identity&quot;</span>
<a href="#l234.75"></a><span id="l234.75">   );</span>
<a href="#l234.76"></a><span id="l234.76"> }</span>
<a href="#l234.77"></a><span id="l234.77"> </span>
<a href="#l234.78"></a><span id="l234.78"> function help_test_display_name(message, field, expectedValue) {</span>
<a href="#l234.79"></a><span id="l234.79">   // Switch to a decoy folder first to ensure that we refresh the message we're</span>
<a href="#l234.80"></a><span id="l234.80">   // looking at in order to update information changed in address book entries.</span>
<a href="#l234.81"></a><span id="l234.81" class="difflineat">@@ -123,83 +122,83 @@ function help_test_display_name(message,</span>
<a href="#l234.82"></a><span id="l234.82">     .e(&quot;expanded&quot; + field + &quot;Box&quot;, { tagName: &quot;mail-emailaddress&quot; })</span>
<a href="#l234.83"></a><span id="l234.83">     .querySelector(&quot;.emaillabel&quot;).value;</span>
<a href="#l234.84"></a><span id="l234.84"> </span>
<a href="#l234.85"></a><span id="l234.85">   if (value != expectedValue) {</span>
<a href="#l234.86"></a><span id="l234.86">     throw new Error(&quot;got '&quot; + value + &quot;' but expected '&quot; + expectedValue + &quot;'&quot;);</span>
<a href="#l234.87"></a><span id="l234.87">   }</span>
<a href="#l234.88"></a><span id="l234.88"> }</span>
<a href="#l234.89"></a><span id="l234.89"> </span>
<a href="#l234.90"></a><span id="l234.90" class="difflineminus">-function test_single_identity() {</span>
<a href="#l234.91"></a><span id="l234.91" class="difflineplus">+add_task(function test_single_identity() {</span>
<a href="#l234.92"></a><span id="l234.92">   ensure_no_card_exists(myEmail);</span>
<a href="#l234.93"></a><span id="l234.93">   ensure_single_identity();</span>
<a href="#l234.94"></a><span id="l234.94">   help_test_display_name(0, &quot;to&quot;, headertoFieldMe);</span>
<a href="#l234.95"></a><span id="l234.95" class="difflineminus">-}</span>
<a href="#l234.96"></a><span id="l234.96" class="difflineplus">+});</span>
<a href="#l234.97"></a><span id="l234.97"> </span>
<a href="#l234.98"></a><span id="l234.98" class="difflineminus">-function test_single_identity_in_abook() {</span>
<a href="#l234.99"></a><span id="l234.99" class="difflineplus">+add_task(function test_single_identity_in_abook() {</span>
<a href="#l234.100"></a><span id="l234.100">   ensure_card_exists(myEmail, &quot;President Frankenstein&quot;, true);</span>
<a href="#l234.101"></a><span id="l234.101">   ensure_single_identity();</span>
<a href="#l234.102"></a><span id="l234.102">   help_test_display_name(0, &quot;to&quot;, &quot;President Frankenstein&quot;);</span>
<a href="#l234.103"></a><span id="l234.103" class="difflineminus">-}</span>
<a href="#l234.104"></a><span id="l234.104" class="difflineplus">+});</span>
<a href="#l234.105"></a><span id="l234.105"> </span>
<a href="#l234.106"></a><span id="l234.106" class="difflineminus">-function test_single_identity_in_abook_no_pdn() {</span>
<a href="#l234.107"></a><span id="l234.107" class="difflineplus">+add_task(function test_single_identity_in_abook_no_pdn() {</span>
<a href="#l234.108"></a><span id="l234.108">   ensure_card_exists(myEmail, &quot;President Frankenstein&quot;);</span>
<a href="#l234.109"></a><span id="l234.109">   ensure_single_identity();</span>
<a href="#l234.110"></a><span id="l234.110">   help_test_display_name(0, &quot;to&quot;, headertoFieldMe);</span>
<a href="#l234.111"></a><span id="l234.111" class="difflineminus">-}</span>
<a href="#l234.112"></a><span id="l234.112" class="difflineplus">+});</span>
<a href="#l234.113"></a><span id="l234.113"> </span>
<a href="#l234.114"></a><span id="l234.114" class="difflineminus">-function test_multiple_identities() {</span>
<a href="#l234.115"></a><span id="l234.115" class="difflineplus">+add_task(function test_multiple_identities() {</span>
<a href="#l234.116"></a><span id="l234.116">   ensure_no_card_exists(myEmail);</span>
<a href="#l234.117"></a><span id="l234.117">   ensure_multiple_identities();</span>
<a href="#l234.118"></a><span id="l234.118">   help_test_display_name(0, &quot;to&quot;, headertoFieldMe + &quot; &lt;&quot; + myEmail + &quot;&gt;&quot;);</span>
<a href="#l234.119"></a><span id="l234.119" class="difflineminus">-}</span>
<a href="#l234.120"></a><span id="l234.120" class="difflineplus">+});</span>
<a href="#l234.121"></a><span id="l234.121"> </span>
<a href="#l234.122"></a><span id="l234.122" class="difflineminus">-function test_multiple_identities_in_abook() {</span>
<a href="#l234.123"></a><span id="l234.123" class="difflineplus">+add_task(function test_multiple_identities_in_abook() {</span>
<a href="#l234.124"></a><span id="l234.124">   ensure_card_exists(myEmail, &quot;President Frankenstein&quot;, true);</span>
<a href="#l234.125"></a><span id="l234.125">   ensure_multiple_identities();</span>
<a href="#l234.126"></a><span id="l234.126">   help_test_display_name(0, &quot;to&quot;, &quot;President Frankenstein&quot;);</span>
<a href="#l234.127"></a><span id="l234.127" class="difflineminus">-}</span>
<a href="#l234.128"></a><span id="l234.128" class="difflineplus">+});</span>
<a href="#l234.129"></a><span id="l234.129"> </span>
<a href="#l234.130"></a><span id="l234.130" class="difflineminus">-function test_multiple_identities_in_abook_no_pdn() {</span>
<a href="#l234.131"></a><span id="l234.131" class="difflineplus">+add_task(function test_multiple_identities_in_abook_no_pdn() {</span>
<a href="#l234.132"></a><span id="l234.132">   ensure_card_exists(myEmail, &quot;President Frankenstein&quot;);</span>
<a href="#l234.133"></a><span id="l234.133">   ensure_multiple_identities();</span>
<a href="#l234.134"></a><span id="l234.134">   help_test_display_name(0, &quot;to&quot;, headertoFieldMe + &quot; &lt;&quot; + myEmail + &quot;&gt;&quot;);</span>
<a href="#l234.135"></a><span id="l234.135" class="difflineminus">-}</span>
<a href="#l234.136"></a><span id="l234.136" class="difflineplus">+});</span>
<a href="#l234.137"></a><span id="l234.137"> </span>
<a href="#l234.138"></a><span id="l234.138" class="difflineminus">-function test_no_header_name() {</span>
<a href="#l234.139"></a><span id="l234.139" class="difflineplus">+add_task(function test_no_header_name() {</span>
<a href="#l234.140"></a><span id="l234.140">   ensure_no_card_exists(friendEmail);</span>
<a href="#l234.141"></a><span id="l234.141">   ensure_single_identity();</span>
<a href="#l234.142"></a><span id="l234.142">   help_test_display_name(1, &quot;from&quot;, friendEmail);</span>
<a href="#l234.143"></a><span id="l234.143" class="difflineminus">-}</span>
<a href="#l234.144"></a><span id="l234.144" class="difflineplus">+});</span>
<a href="#l234.145"></a><span id="l234.145"> </span>
<a href="#l234.146"></a><span id="l234.146" class="difflineminus">-function test_no_header_name_in_abook() {</span>
<a href="#l234.147"></a><span id="l234.147" class="difflineplus">+add_task(function test_no_header_name_in_abook() {</span>
<a href="#l234.148"></a><span id="l234.148">   ensure_card_exists(friendEmail, &quot;My Buddy&quot;, true);</span>
<a href="#l234.149"></a><span id="l234.149">   ensure_single_identity();</span>
<a href="#l234.150"></a><span id="l234.150">   help_test_display_name(1, &quot;from&quot;, &quot;My Buddy&quot;);</span>
<a href="#l234.151"></a><span id="l234.151" class="difflineminus">-}</span>
<a href="#l234.152"></a><span id="l234.152" class="difflineplus">+});</span>
<a href="#l234.153"></a><span id="l234.153"> </span>
<a href="#l234.154"></a><span id="l234.154" class="difflineminus">-function test_no_header_name_in_abook_no_pdn() {</span>
<a href="#l234.155"></a><span id="l234.155" class="difflineplus">+add_task(function test_no_header_name_in_abook_no_pdn() {</span>
<a href="#l234.156"></a><span id="l234.156">   ensure_card_exists(friendEmail, &quot;My Buddy&quot;);</span>
<a href="#l234.157"></a><span id="l234.157">   ensure_single_identity();</span>
<a href="#l234.158"></a><span id="l234.158">   // With address book entry but display name not preferred, we display name and</span>
<a href="#l234.159"></a><span id="l234.159">   // e-mail address or only the e-mail address if no name exists.</span>
<a href="#l234.160"></a><span id="l234.160">   help_test_display_name(1, &quot;from&quot;, &quot;carl@sagan.invalid&quot;);</span>
<a href="#l234.161"></a><span id="l234.161" class="difflineminus">-}</span>
<a href="#l234.162"></a><span id="l234.162" class="difflineplus">+});</span>
<a href="#l234.163"></a><span id="l234.163"> </span>
<a href="#l234.164"></a><span id="l234.164" class="difflineminus">-function test_header_name() {</span>
<a href="#l234.165"></a><span id="l234.165" class="difflineplus">+add_task(function test_header_name() {</span>
<a href="#l234.166"></a><span id="l234.166">   ensure_no_card_exists(friendEmail);</span>
<a href="#l234.167"></a><span id="l234.167">   ensure_single_identity();</span>
<a href="#l234.168"></a><span id="l234.168">   help_test_display_name(2, &quot;from&quot;, friendName + &quot; &lt;&quot; + friendEmail + &quot;&gt;&quot;);</span>
<a href="#l234.169"></a><span id="l234.169" class="difflineminus">-}</span>
<a href="#l234.170"></a><span id="l234.170" class="difflineplus">+});</span>
<a href="#l234.171"></a><span id="l234.171"> </span>
<a href="#l234.172"></a><span id="l234.172" class="difflineminus">-function test_header_name_in_abook() {</span>
<a href="#l234.173"></a><span id="l234.173" class="difflineplus">+add_task(function test_header_name_in_abook() {</span>
<a href="#l234.174"></a><span id="l234.174">   ensure_card_exists(friendEmail, &quot;My Buddy&quot;, true);</span>
<a href="#l234.175"></a><span id="l234.175">   ensure_single_identity();</span>
<a href="#l234.176"></a><span id="l234.176">   help_test_display_name(2, &quot;from&quot;, &quot;My Buddy&quot;);</span>
<a href="#l234.177"></a><span id="l234.177" class="difflineminus">-}</span>
<a href="#l234.178"></a><span id="l234.178" class="difflineplus">+});</span>
<a href="#l234.179"></a><span id="l234.179"> </span>
<a href="#l234.180"></a><span id="l234.180" class="difflineminus">-function test_header_name_in_abook_no_pdn() {</span>
<a href="#l234.181"></a><span id="l234.181" class="difflineplus">+add_task(function test_header_name_in_abook_no_pdn() {</span>
<a href="#l234.182"></a><span id="l234.182">   ensure_card_exists(friendEmail, &quot;My Buddy&quot;);</span>
<a href="#l234.183"></a><span id="l234.183">   ensure_single_identity();</span>
<a href="#l234.184"></a><span id="l234.184">   // With address book entry but display name not preferred, we display name and</span>
<a href="#l234.185"></a><span id="l234.185">   // e-mail address.</span>
<a href="#l234.186"></a><span id="l234.186">   help_test_display_name(2, &quot;from&quot;, &quot;Carl Sagan &lt;carl@sagan.invalid&gt;&quot;);</span>
<a href="#l234.187"></a><span id="l234.187" class="difflineminus">-}</span>
<a href="#l234.188"></a><span id="l234.188" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l235.1"></a><span id="l235.1">copy from mail/test/mozmill/multiple-identities/readme.txt</span>
<a href="#l235.2"></a><span id="l235.2">copy to mail/test/browser/multiple-identities/readme.txt</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l236.1"></a><span id="l236.1">new file mode 100644</span>
<a href="#l236.2"></a><span id="l236.2" class="difflineminus">--- /dev/null</span>
<a href="#l236.3"></a><span id="l236.3" class="difflineplus">+++ b/mail/test/browser/newmailaccount/browser.ini</span>
<a href="#l236.4"></a><span id="l236.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l236.5"></a><span id="l236.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l236.6"></a><span id="l236.6" class="difflineplus">+prefs =</span>
<a href="#l236.7"></a><span id="l236.7" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l236.8"></a><span id="l236.8" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l236.9"></a><span id="l236.9" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l236.10"></a><span id="l236.10" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l236.11"></a><span id="l236.11" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l236.12"></a><span id="l236.12" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l236.13"></a><span id="l236.13" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l236.14"></a><span id="l236.14" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l236.15"></a><span id="l236.15" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l236.16"></a><span id="l236.16" class="difflineplus">+support-files = html/**</span>
<a href="#l236.17"></a><span id="l236.17" class="difflineplus">+</span>
<a href="#l236.18"></a><span id="l236.18" class="difflineplus">+[browser_newmailaccount.js]</span>
<a href="#l236.19"></a><span id="l236.19" class="difflineplus">+skip-if = true</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l237.1"></a><span id="l237.1">copy from mail/test/mozmill/newmailaccount/test-newmailaccount.js</span>
<a href="#l237.2"></a><span id="l237.2">copy to mail/test/browser/newmailaccount/browser_newmailaccount.js</span>
<a href="#l237.3"></a><span id="l237.3" class="difflineminus">--- a/mail/test/mozmill/newmailaccount/test-newmailaccount.js</span>
<a href="#l237.4"></a><span id="l237.4" class="difflineplus">+++ b/mail/test/browser/newmailaccount/browser_newmailaccount.js</span>
<a href="#l237.5"></a><span id="l237.5" class="difflineat">@@ -4,20 +4,20 @@</span>
<a href="#l237.6"></a><span id="l237.6"> </span>
<a href="#l237.7"></a><span id="l237.7"> /**</span>
<a href="#l237.8"></a><span id="l237.8">  * Tests the get an account (account provisioning) workflow.</span>
<a href="#l237.9"></a><span id="l237.9">  */</span>
<a href="#l237.10"></a><span id="l237.10"> </span>
<a href="#l237.11"></a><span id="l237.11"> &quot;use strict&quot;;</span>
<a href="#l237.12"></a><span id="l237.12"> </span>
<a href="#l237.13"></a><span id="l237.13"> var elib = ChromeUtils.import(</span>
<a href="#l237.14"></a><span id="l237.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l237.15"></a><span id="l237.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l237.16"></a><span id="l237.16"> );</span>
<a href="#l237.17"></a><span id="l237.17"> var { HttpServer } = ChromeUtils.import(</span>
<a href="#l237.18"></a><span id="l237.18" class="difflineminus">-  &quot;chrome://mozmill/content/stdlib/httpd.jsm&quot;</span>
<a href="#l237.19"></a><span id="l237.19" class="difflineplus">+  &quot;resource://testing-common/mozmill/httpd.jsm&quot;</span>
<a href="#l237.20"></a><span id="l237.20"> );</span>
<a href="#l237.21"></a><span id="l237.21"> </span>
<a href="#l237.22"></a><span id="l237.22"> var {</span>
<a href="#l237.23"></a><span id="l237.23">   gMockExtProtSvc,</span>
<a href="#l237.24"></a><span id="l237.24">   gMockExtProtSvcReg,</span>
<a href="#l237.25"></a><span id="l237.25">   open_content_tab_with_click,</span>
<a href="#l237.26"></a><span id="l237.26">   plan_for_content_tab_load,</span>
<a href="#l237.27"></a><span id="l237.27">   wait_for_content_tab_load,</span>
<a href="#l237.28"></a><span id="l237.28" class="difflineat">@@ -25,24 +25,17 @@ var {</span>
<a href="#l237.29"></a><span id="l237.29">   &quot;resource://testing-common/mozmill/ContentTabHelpers.jsm&quot;</span>
<a href="#l237.30"></a><span id="l237.30"> );</span>
<a href="#l237.31"></a><span id="l237.31"> var {</span>
<a href="#l237.32"></a><span id="l237.32">   assert_element_visible,</span>
<a href="#l237.33"></a><span id="l237.33">   wait_for_element_enabled,</span>
<a href="#l237.34"></a><span id="l237.34">   wait_for_element_invisible,</span>
<a href="#l237.35"></a><span id="l237.35">   wait_for_element_visible,</span>
<a href="#l237.36"></a><span id="l237.36"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/DOMHelpers.jsm&quot;);</span>
<a href="#l237.37"></a><span id="l237.37" class="difflineminus">-var {</span>
<a href="#l237.38"></a><span id="l237.38" class="difflineminus">-  assert_equals,</span>
<a href="#l237.39"></a><span id="l237.39" class="difflineminus">-  assert_false,</span>
<a href="#l237.40"></a><span id="l237.40" class="difflineminus">-  assert_not_equals,</span>
<a href="#l237.41"></a><span id="l237.41" class="difflineminus">-  assert_selected_tab,</span>
<a href="#l237.42"></a><span id="l237.42" class="difflineminus">-  assert_true,</span>
<a href="#l237.43"></a><span id="l237.43" class="difflineminus">-  mc,</span>
<a href="#l237.44"></a><span id="l237.44" class="difflineminus">-} = ChromeUtils.import(</span>
<a href="#l237.45"></a><span id="l237.45" class="difflineplus">+var { assert_selected_tab, mc } = ChromeUtils.import(</span>
<a href="#l237.46"></a><span id="l237.46">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l237.47"></a><span id="l237.47"> );</span>
<a href="#l237.48"></a><span id="l237.48"> var {</span>
<a href="#l237.49"></a><span id="l237.49">   assert_links_not_shown,</span>
<a href="#l237.50"></a><span id="l237.50">   assert_links_shown,</span>
<a href="#l237.51"></a><span id="l237.51">   gConsoleListener,</span>
<a href="#l237.52"></a><span id="l237.52">   open_provisioner_window,</span>
<a href="#l237.53"></a><span id="l237.53">   remove_email_account,</span>
<a href="#l237.54"></a><span id="l237.54" class="difflineat">@@ -68,61 +61,62 @@ var {</span>
<a href="#l237.55"></a><span id="l237.55"> </span>
<a href="#l237.56"></a><span id="l237.56"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l237.57"></a><span id="l237.57"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l237.58"></a><span id="l237.58">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l237.59"></a><span id="l237.59"> );</span>
<a href="#l237.60"></a><span id="l237.60"> </span>
<a href="#l237.61"></a><span id="l237.61"> // RELATIVE_ROOT messes with the collector, so we have to bring the path back</span>
<a href="#l237.62"></a><span id="l237.62"> // so we get the right path for the resources.</span>
<a href="#l237.63"></a><span id="l237.63" class="difflineminus">-var url = collector.addHttpResource(&quot;../newmailaccount/html&quot;, &quot;&quot;);</span>
<a href="#l237.64"></a><span id="l237.64" class="difflineplus">+var url =</span>
<a href="#l237.65"></a><span id="l237.65" class="difflineplus">+  &quot;http://mochi.test:8888/browser/comm/mail/test/browser/newmailaccount/html/&quot;;</span>
<a href="#l237.66"></a><span id="l237.66"> var kProvisionerUrl =</span>
<a href="#l237.67"></a><span id="l237.67">   &quot;chrome://messenger/content/newmailaccount/accountProvisioner.xhtml&quot;;</span>
<a href="#l237.68"></a><span id="l237.68"> var kProvisionerEnabledPref = &quot;mail.provider.enabled&quot;;</span>
<a href="#l237.69"></a><span id="l237.69"> var kSuggestFromNamePref = &quot;mail.provider.suggestFromName&quot;;</span>
<a href="#l237.70"></a><span id="l237.70"> var kProviderListPref = &quot;mail.provider.providerList&quot;;</span>
<a href="#l237.71"></a><span id="l237.71" class="difflineminus">-var kDefaultServerPort = 4444;</span>
<a href="#l237.72"></a><span id="l237.72" class="difflineminus">-var kDefaultServerRoot = &quot;http://localhost:&quot; + kDefaultServerPort;</span>
<a href="#l237.73"></a><span id="l237.73" class="difflineplus">+var kDefaultServerPort = 8888;</span>
<a href="#l237.74"></a><span id="l237.74" class="difflineplus">+var kDefaultServerRoot = &quot;http://mochi.test:&quot; + kDefaultServerPort;</span>
<a href="#l237.75"></a><span id="l237.75"> </span>
<a href="#l237.76"></a><span id="l237.76"> Services.prefs.setCharPref(kProviderListPref, url + &quot;providerList&quot;);</span>
<a href="#l237.77"></a><span id="l237.77"> Services.prefs.setCharPref(kSuggestFromNamePref, url + &quot;suggestFromName&quot;);</span>
<a href="#l237.78"></a><span id="l237.78"> </span>
<a href="#l237.79"></a><span id="l237.79"> // Here's a name that we'll type in later on.  It's a global const because</span>
<a href="#l237.80"></a><span id="l237.80"> // we'll be using it in several distinct modal dialog event loops.</span>
<a href="#l237.81"></a><span id="l237.81"> var NAME = &quot;Leonard Shelby&quot;;</span>
<a href="#l237.82"></a><span id="l237.82"> </span>
<a href="#l237.83"></a><span id="l237.83"> // Record what the original value of the mail.provider.enabled pref is so</span>
<a href="#l237.84"></a><span id="l237.84"> // that we can put it back once the tests are done.</span>
<a href="#l237.85"></a><span id="l237.85"> var gProvisionerEnabled = Services.prefs.getBoolPref(kProvisionerEnabledPref);</span>
<a href="#l237.86"></a><span id="l237.86"> var gOldAcceptLangs = Services.locale.requestedLocales;</span>
<a href="#l237.87"></a><span id="l237.87"> var gNumAccounts;</span>
<a href="#l237.88"></a><span id="l237.88"> </span>
<a href="#l237.89"></a><span id="l237.89" class="difflineminus">-function setupModule(module) {</span>
<a href="#l237.90"></a><span id="l237.90" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l237.91"></a><span id="l237.91">   // Make sure we enable the Account Provisioner.</span>
<a href="#l237.92"></a><span id="l237.92">   Services.prefs.setBoolPref(kProvisionerEnabledPref, true);</span>
<a href="#l237.93"></a><span id="l237.93">   // Restrict the user's language to just en-US</span>
<a href="#l237.94"></a><span id="l237.94">   Services.locale.requestedLocales = [&quot;en-US&quot;];</span>
<a href="#l237.95"></a><span id="l237.95"> </span>
<a href="#l237.96"></a><span id="l237.96">   // Add a &quot;bar&quot; search engine that we can switch to be the default.</span>
<a href="#l237.97"></a><span id="l237.97">   let engineAdded = false;</span>
<a href="#l237.98"></a><span id="l237.98">   Services.search</span>
<a href="#l237.99"></a><span id="l237.99">     .addEngineWithDetails(&quot;bar&quot;, {</span>
<a href="#l237.100"></a><span id="l237.100">       method: &quot;post&quot;,</span>
<a href="#l237.101"></a><span id="l237.101">       template: &quot;http://www.example.com/search?q={searchTerms}&quot;,</span>
<a href="#l237.102"></a><span id="l237.102">     })</span>
<a href="#l237.103"></a><span id="l237.103">     .then(() =&gt; (engineAdded = true));</span>
<a href="#l237.104"></a><span id="l237.104">   mc.waitFor(() =&gt; engineAdded);</span>
<a href="#l237.105"></a><span id="l237.105" class="difflineminus">-}</span>
<a href="#l237.106"></a><span id="l237.106" class="difflineplus">+});</span>
<a href="#l237.107"></a><span id="l237.107"> </span>
<a href="#l237.108"></a><span id="l237.108" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l237.109"></a><span id="l237.109" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l237.110"></a><span id="l237.110">   // Put the mail.provider.enabled pref back the way it was.</span>
<a href="#l237.111"></a><span id="l237.111">   Services.prefs.setBoolPref(kProvisionerEnabledPref, gProvisionerEnabled);</span>
<a href="#l237.112"></a><span id="l237.112">   // And same with the user languages</span>
<a href="#l237.113"></a><span id="l237.113">   Services.locale.requestedLocales = gOldAcceptLangs;</span>
<a href="#l237.114"></a><span id="l237.114" class="difflineminus">-}</span>
<a href="#l237.115"></a><span id="l237.115" class="difflineplus">+});</span>
<a href="#l237.116"></a><span id="l237.116"> </span>
<a href="#l237.117"></a><span id="l237.117"> /* Helper function that returns the number of accounts associated with the</span>
<a href="#l237.118"></a><span id="l237.118">  * current profile.</span>
<a href="#l237.119"></a><span id="l237.119">  */</span>
<a href="#l237.120"></a><span id="l237.120"> function nAccounts() {</span>
<a href="#l237.121"></a><span id="l237.121">   return MailServices.accounts.accounts.length;</span>
<a href="#l237.122"></a><span id="l237.122"> }</span>
<a href="#l237.123"></a><span id="l237.123"> </span>
<a href="#l237.124"></a><span id="l237.124" class="difflineat">@@ -188,31 +182,32 @@ function test_get_an_account(aCloseAndRe</span>
<a href="#l237.125"></a><span id="l237.125">   let ac = wait_for_new_window(&quot;AccountCreation&quot;);</span>
<a href="#l237.126"></a><span id="l237.126"> </span>
<a href="#l237.127"></a><span id="l237.127">   plan_for_window_close(ac);</span>
<a href="#l237.128"></a><span id="l237.128">   subtest_get_an_account_part_2(ac);</span>
<a href="#l237.129"></a><span id="l237.129">   wait_for_window_close();</span>
<a href="#l237.130"></a><span id="l237.130"> </span>
<a href="#l237.131"></a><span id="l237.131">   // Make sure we set the default search engine</span>
<a href="#l237.132"></a><span id="l237.132">   let engine = Services.search.getEngineByName(&quot;bar&quot;);</span>
<a href="#l237.133"></a><span id="l237.133" class="difflineminus">-  assert_equals(engine, Services.search.defaultEngine);</span>
<a href="#l237.134"></a><span id="l237.134" class="difflineplus">+  Assert.equal(engine, Services.search.defaultEngine);</span>
<a href="#l237.135"></a><span id="l237.135"> </span>
<a href="#l237.136"></a><span id="l237.136">   // Restore the original search engine.</span>
<a href="#l237.137"></a><span id="l237.137">   Services.search.defaultEngine = originalEngine;</span>
<a href="#l237.138"></a><span id="l237.138">   remove_email_account(&quot;green@example.com&quot;);</span>
<a href="#l237.139"></a><span id="l237.139"> }</span>
<a href="#l237.140"></a><span id="l237.140" class="difflineplus">+add_task(test_get_an_account);</span>
<a href="#l237.141"></a><span id="l237.141"> </span>
<a href="#l237.142"></a><span id="l237.142"> /**</span>
<a href="#l237.143"></a><span id="l237.143">  * This is a subtest for test_get_an_account, and runs the first time the</span>
<a href="#l237.144"></a><span id="l237.144">  * account provisioner window is opened.</span>
<a href="#l237.145"></a><span id="l237.145">  */</span>
<a href="#l237.146"></a><span id="l237.146"> function subtest_get_an_account(w) {</span>
<a href="#l237.147"></a><span id="l237.147">   // Make sure we don't have bar as the default engine yet.</span>
<a href="#l237.148"></a><span id="l237.148">   let engine = Services.search.getEngineByName(&quot;bar&quot;);</span>
<a href="#l237.149"></a><span id="l237.149" class="difflineminus">-  assert_not_equals(engine, Services.search.defaultEngine);</span>
<a href="#l237.150"></a><span id="l237.150" class="difflineplus">+  Assert.notEqual(engine, Services.search.defaultEngine);</span>
<a href="#l237.151"></a><span id="l237.151"> </span>
<a href="#l237.152"></a><span id="l237.152">   wait_for_provider_list_loaded(w);</span>
<a href="#l237.153"></a><span id="l237.153">   wait_for_search_ready(w);</span>
<a href="#l237.154"></a><span id="l237.154"> </span>
<a href="#l237.155"></a><span id="l237.155">   // Fill in some data</span>
<a href="#l237.156"></a><span id="l237.156">   type_in_search_name(w, &quot;Green Llama&quot;);</span>
<a href="#l237.157"></a><span id="l237.157"> </span>
<a href="#l237.158"></a><span id="l237.158">   w.click(w.eid(&quot;searchSubmit&quot;));</span>
<a href="#l237.159"></a><span id="l237.159" class="difflineat">@@ -238,49 +233,49 @@ function subtest_get_an_account(w) {</span>
<a href="#l237.160"></a><span id="l237.160"> }</span>
<a href="#l237.161"></a><span id="l237.161"> </span>
<a href="#l237.162"></a><span id="l237.162"> /**</span>
<a href="#l237.163"></a><span id="l237.163">  * This is a subtest for test_get_an_account, and runs the second time the</span>
<a href="#l237.164"></a><span id="l237.164">  * account provisioner window is opened.</span>
<a href="#l237.165"></a><span id="l237.165">  */</span>
<a href="#l237.166"></a><span id="l237.166"> function subtest_get_an_account_part_2(w) {</span>
<a href="#l237.167"></a><span id="l237.167">   // An account should have been added.</span>
<a href="#l237.168"></a><span id="l237.168" class="difflineminus">-  assert_equals(nAccounts(), gNumAccounts + 1);</span>
<a href="#l237.169"></a><span id="l237.169" class="difflineplus">+  Assert.equal(nAccounts(), gNumAccounts + 1);</span>
<a href="#l237.170"></a><span id="l237.170"> </span>
<a href="#l237.171"></a><span id="l237.171">   // We want this provider to be our default search engine.</span>
<a href="#l237.172"></a><span id="l237.172">   wait_for_element_invisible(w, &quot;window&quot;);</span>
<a href="#l237.173"></a><span id="l237.173">   wait_for_element_visible(w, &quot;successful_account&quot;);</span>
<a href="#l237.174"></a><span id="l237.174"> </span>
<a href="#l237.175"></a><span id="l237.175">   // Make sure the search engine is checked</span>
<a href="#l237.176"></a><span id="l237.176" class="difflineminus">-  assert_true(w.e(&quot;search_engine_check&quot;).checked);</span>
<a href="#l237.177"></a><span id="l237.177" class="difflineplus">+  Assert.ok(w.e(&quot;search_engine_check&quot;).checked);</span>
<a href="#l237.178"></a><span id="l237.178"> </span>
<a href="#l237.179"></a><span id="l237.179">   // Then click &quot;Finish&quot;</span>
<a href="#l237.180"></a><span id="l237.180">   mc.click(w.eid(&quot;closeWindow&quot;));</span>
<a href="#l237.181"></a><span id="l237.181"> }</span>
<a href="#l237.182"></a><span id="l237.182"> </span>
<a href="#l237.183"></a><span id="l237.183"> /**</span>
<a href="#l237.184"></a><span id="l237.184">  * Runs test_get_an_account again, but this time, closes and restores the</span>
<a href="#l237.185"></a><span id="l237.185">  * order form tab before submitting it.</span>
<a href="#l237.186"></a><span id="l237.186">  */</span>
<a href="#l237.187"></a><span id="l237.187" class="difflineminus">-function test_restored_ap_tab_works() {</span>
<a href="#l237.188"></a><span id="l237.188" class="difflineplus">+add_task(function test_restored_ap_tab_works() {</span>
<a href="#l237.189"></a><span id="l237.189">   test_get_an_account(true);</span>
<a href="#l237.190"></a><span id="l237.190" class="difflineminus">-}</span>
<a href="#l237.191"></a><span id="l237.191" class="difflineplus">+});</span>
<a href="#l237.192"></a><span id="l237.192"> </span>
<a href="#l237.193"></a><span id="l237.193"> /**</span>
<a href="#l237.194"></a><span id="l237.194">  * Test that clicking on the &quot;I think I'll configure my account later&quot;</span>
<a href="#l237.195"></a><span id="l237.195">  * button dismisses the Account Provisioner window.</span>
<a href="#l237.196"></a><span id="l237.196">  */</span>
<a href="#l237.197"></a><span id="l237.197" class="difflineminus">-function test_can_dismiss_account_provisioner() {</span>
<a href="#l237.198"></a><span id="l237.198" class="difflineplus">+add_task(function test_can_dismiss_account_provisioner() {</span>
<a href="#l237.199"></a><span id="l237.199">   plan_for_modal_dialog(</span>
<a href="#l237.200"></a><span id="l237.200">     &quot;AccountCreation&quot;,</span>
<a href="#l237.201"></a><span id="l237.201">     subtest_can_dismiss_account_provisioner</span>
<a href="#l237.202"></a><span id="l237.202">   );</span>
<a href="#l237.203"></a><span id="l237.203">   open_provisioner_window();</span>
<a href="#l237.204"></a><span id="l237.204">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.205"></a><span id="l237.205" class="difflineminus">-}</span>
<a href="#l237.206"></a><span id="l237.206" class="difflineplus">+});</span>
<a href="#l237.207"></a><span id="l237.207"> </span>
<a href="#l237.208"></a><span id="l237.208"> /**</span>
<a href="#l237.209"></a><span id="l237.209">  * Subtest for test_can_dismiss_account_provisioner, that runs</span>
<a href="#l237.210"></a><span id="l237.210">  * once the modal dialog has opened.  This function just clicks the</span>
<a href="#l237.211"></a><span id="l237.211">  * &quot;I think I'll configure my account later&quot; button, and then waits</span>
<a href="#l237.212"></a><span id="l237.212">  * for itself to close.</span>
<a href="#l237.213"></a><span id="l237.213">  */</span>
<a href="#l237.214"></a><span id="l237.214"> function subtest_can_dismiss_account_provisioner(w) {</span>
<a href="#l237.215"></a><span id="l237.215" class="difflineat">@@ -291,29 +286,29 @@ function subtest_can_dismiss_account_pro</span>
<a href="#l237.216"></a><span id="l237.216">   // Ensure that the window has closed.</span>
<a href="#l237.217"></a><span id="l237.217">   wait_for_window_close();</span>
<a href="#l237.218"></a><span id="l237.218"> }</span>
<a href="#l237.219"></a><span id="l237.219"> </span>
<a href="#l237.220"></a><span id="l237.220"> /**</span>
<a href="#l237.221"></a><span id="l237.221">  * Test that clicking on the &quot;Skip this and use my existing email&quot; button</span>
<a href="#l237.222"></a><span id="l237.222">  * sends us to the existing email account wizard.</span>
<a href="#l237.223"></a><span id="l237.223">  */</span>
<a href="#l237.224"></a><span id="l237.224" class="difflineminus">-function test_can_switch_to_existing_email_account_wizard() {</span>
<a href="#l237.225"></a><span id="l237.225" class="difflineplus">+add_task(function test_can_switch_to_existing_email_account_wizard() {</span>
<a href="#l237.226"></a><span id="l237.226">   plan_for_modal_dialog(</span>
<a href="#l237.227"></a><span id="l237.227">     &quot;AccountCreation&quot;,</span>
<a href="#l237.228"></a><span id="l237.228">     subtest_can_switch_to_existing_email_account_wizard</span>
<a href="#l237.229"></a><span id="l237.229">   );</span>
<a href="#l237.230"></a><span id="l237.230">   open_provisioner_window();</span>
<a href="#l237.231"></a><span id="l237.231">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.232"></a><span id="l237.232">   // Ensure that the existing email account wizard opened.</span>
<a href="#l237.233"></a><span id="l237.233">   let wizard = wait_for_new_window(&quot;mail:autoconfig&quot;);</span>
<a href="#l237.234"></a><span id="l237.234"> </span>
<a href="#l237.235"></a><span id="l237.235">   // Then close the wizard</span>
<a href="#l237.236"></a><span id="l237.236">   close_window(wizard);</span>
<a href="#l237.237"></a><span id="l237.237" class="difflineminus">-}</span>
<a href="#l237.238"></a><span id="l237.238" class="difflineplus">+});</span>
<a href="#l237.239"></a><span id="l237.239"> </span>
<a href="#l237.240"></a><span id="l237.240"> /**</span>
<a href="#l237.241"></a><span id="l237.241">  * Subtest for test_can_switch_to_existing_email_account_wizard.  This</span>
<a href="#l237.242"></a><span id="l237.242">  * function simply clicks on the &quot;Skip this and use my existing email&quot;</span>
<a href="#l237.243"></a><span id="l237.243">  * button, and then waits for itself to close.</span>
<a href="#l237.244"></a><span id="l237.244">  */</span>
<a href="#l237.245"></a><span id="l237.245"> function subtest_can_switch_to_existing_email_account_wizard(w) {</span>
<a href="#l237.246"></a><span id="l237.246">   plan_for_window_close(w);</span>
<a href="#l237.247"></a><span id="l237.247" class="difflineat">@@ -325,24 +320,24 @@ function subtest_can_switch_to_existing_</span>
<a href="#l237.248"></a><span id="l237.248">   // Ensure that the Account Provisioner window closed</span>
<a href="#l237.249"></a><span id="l237.249">   wait_for_window_close();</span>
<a href="#l237.250"></a><span id="l237.250"> }</span>
<a href="#l237.251"></a><span id="l237.251"> </span>
<a href="#l237.252"></a><span id="l237.252"> /**</span>
<a href="#l237.253"></a><span id="l237.253">  * Test that clicking on the &quot;Other languages&quot; div causes account</span>
<a href="#l237.254"></a><span id="l237.254">  * providers with other languages to be displayed.</span>
<a href="#l237.255"></a><span id="l237.255">  */</span>
<a href="#l237.256"></a><span id="l237.256" class="difflineminus">-function test_can_display_providers_in_other_languages() {</span>
<a href="#l237.257"></a><span id="l237.257" class="difflineplus">+add_task(function test_can_display_providers_in_other_languages() {</span>
<a href="#l237.258"></a><span id="l237.258">   plan_for_modal_dialog(</span>
<a href="#l237.259"></a><span id="l237.259">     &quot;AccountCreation&quot;,</span>
<a href="#l237.260"></a><span id="l237.260">     subtest_can_display_providers_in_other_languages</span>
<a href="#l237.261"></a><span id="l237.261">   );</span>
<a href="#l237.262"></a><span id="l237.262">   open_provisioner_window();</span>
<a href="#l237.263"></a><span id="l237.263">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.264"></a><span id="l237.264" class="difflineminus">-}</span>
<a href="#l237.265"></a><span id="l237.265" class="difflineplus">+});</span>
<a href="#l237.266"></a><span id="l237.266"> </span>
<a href="#l237.267"></a><span id="l237.267"> /**</span>
<a href="#l237.268"></a><span id="l237.268">  * Subtest for test_can_display_providers_in_other_languages. This function</span>
<a href="#l237.269"></a><span id="l237.269">  * simply clicks on the div for displaying account providers in other</span>
<a href="#l237.270"></a><span id="l237.270">  * languages, and ensures that those other providers become visible.</span>
<a href="#l237.271"></a><span id="l237.271">  */</span>
<a href="#l237.272"></a><span id="l237.272"> function subtest_can_display_providers_in_other_languages(w) {</span>
<a href="#l237.273"></a><span id="l237.273">   wait_for_provider_list_loaded(w);</span>
<a href="#l237.274"></a><span id="l237.274" class="difflineat">@@ -359,17 +354,17 @@ function subtest_can_display_providers_i</span>
<a href="#l237.275"></a><span id="l237.275">   wait_for_element_invisible(w, &quot;otherLangDesc&quot;);</span>
<a href="#l237.276"></a><span id="l237.276"> }</span>
<a href="#l237.277"></a><span id="l237.277"> </span>
<a href="#l237.278"></a><span id="l237.278"> /**</span>
<a href="#l237.279"></a><span id="l237.279">  * Spawn the provisioner window by clicking on the menuitem,</span>
<a href="#l237.280"></a><span id="l237.280">  * then flip back and forth between that and the existing email</span>
<a href="#l237.281"></a><span id="l237.281">  * wizard, and then test to see if we can dismiss the provisioner.</span>
<a href="#l237.282"></a><span id="l237.282">  */</span>
<a href="#l237.283"></a><span id="l237.283" class="difflineminus">-function test_flip_flop_from_provisioner_menuitem() {</span>
<a href="#l237.284"></a><span id="l237.284" class="difflineplus">+add_task(function test_flip_flop_from_provisioner_menuitem() {</span>
<a href="#l237.285"></a><span id="l237.285">   plan_for_modal_dialog(</span>
<a href="#l237.286"></a><span id="l237.286">     &quot;AccountCreation&quot;,</span>
<a href="#l237.287"></a><span id="l237.287">     subtest_flip_flop_from_provisioner_menuitem</span>
<a href="#l237.288"></a><span id="l237.288">   );</span>
<a href="#l237.289"></a><span id="l237.289">   plan_for_new_window(&quot;mail:autoconfig&quot;);</span>
<a href="#l237.290"></a><span id="l237.290">   open_provisioner_window();</span>
<a href="#l237.291"></a><span id="l237.291">   plan_for_new_window(&quot;mail:autoconfig&quot;);</span>
<a href="#l237.292"></a><span id="l237.292">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.293"></a><span id="l237.293" class="difflineat">@@ -388,17 +383,17 @@ function test_flip_flop_from_provisioner</span>
<a href="#l237.294"></a><span id="l237.294">     wizard.click(wizard.eid(&quot;provisioner_button&quot;));</span>
<a href="#l237.295"></a><span id="l237.295">     wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.296"></a><span id="l237.296">   }</span>
<a href="#l237.297"></a><span id="l237.297"> </span>
<a href="#l237.298"></a><span id="l237.298">   wizard = wait_for_new_window(&quot;mail:autoconfig&quot;);</span>
<a href="#l237.299"></a><span id="l237.299">   plan_for_modal_dialog(&quot;AccountCreation&quot;, subtest_close_provisioner);</span>
<a href="#l237.300"></a><span id="l237.300">   wizard.click(wizard.eid(&quot;provisioner_button&quot;));</span>
<a href="#l237.301"></a><span id="l237.301">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.302"></a><span id="l237.302" class="difflineminus">-}</span>
<a href="#l237.303"></a><span id="l237.303" class="difflineplus">+});</span>
<a href="#l237.304"></a><span id="l237.304"> </span>
<a href="#l237.305"></a><span id="l237.305"> /**</span>
<a href="#l237.306"></a><span id="l237.306">  * This function is used by test_flip_flop_from_provisioner_menuitem to switch</span>
<a href="#l237.307"></a><span id="l237.307">  * back from the account provisioner to the wizard.</span>
<a href="#l237.308"></a><span id="l237.308">  */</span>
<a href="#l237.309"></a><span id="l237.309"> function subtest_flip_flop_from_provisioner_menuitem(w) {</span>
<a href="#l237.310"></a><span id="l237.310">   // We need to wait for the wizard to be closed, or else</span>
<a href="#l237.311"></a><span id="l237.311">   // it'll try to refocus when we click on the button to</span>
<a href="#l237.312"></a><span id="l237.312" class="difflineat">@@ -421,30 +416,30 @@ function subtest_close_provisioner(w) {</span>
<a href="#l237.313"></a><span id="l237.313">   // Ensure that the window has closed.</span>
<a href="#l237.314"></a><span id="l237.314">   wait_for_window_close();</span>
<a href="#l237.315"></a><span id="l237.315"> }</span>
<a href="#l237.316"></a><span id="l237.316"> </span>
<a href="#l237.317"></a><span id="l237.317"> /**</span>
<a href="#l237.318"></a><span id="l237.318">  * Test that the name typed into the search field gets persisted after</span>
<a href="#l237.319"></a><span id="l237.319">  * doing a search, or choosing to go to the email setup wizard.</span>
<a href="#l237.320"></a><span id="l237.320">  */</span>
<a href="#l237.321"></a><span id="l237.321" class="difflineminus">-function test_persist_name_in_search_field() {</span>
<a href="#l237.322"></a><span id="l237.322" class="difflineplus">+add_task(function test_persist_name_in_search_field() {</span>
<a href="#l237.323"></a><span id="l237.323">   plan_for_modal_dialog(</span>
<a href="#l237.324"></a><span id="l237.324">     &quot;AccountCreation&quot;,</span>
<a href="#l237.325"></a><span id="l237.325">     subtest_persist_name_in_search_field</span>
<a href="#l237.326"></a><span id="l237.326">   );</span>
<a href="#l237.327"></a><span id="l237.327">   open_provisioner_window();</span>
<a href="#l237.328"></a><span id="l237.328">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.329"></a><span id="l237.329">   plan_for_modal_dialog(</span>
<a href="#l237.330"></a><span id="l237.330">     &quot;AccountCreation&quot;,</span>
<a href="#l237.331"></a><span id="l237.331">     subtest_persist_name_in_search_field_part_2</span>
<a href="#l237.332"></a><span id="l237.332">   );</span>
<a href="#l237.333"></a><span id="l237.333">   open_provisioner_window();</span>
<a href="#l237.334"></a><span id="l237.334">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.335"></a><span id="l237.335" class="difflineminus">-}</span>
<a href="#l237.336"></a><span id="l237.336" class="difflineplus">+});</span>
<a href="#l237.337"></a><span id="l237.337"> </span>
<a href="#l237.338"></a><span id="l237.338"> /**</span>
<a href="#l237.339"></a><span id="l237.339">  * Subtest used by test_persist_name_in_search_field.  This function simply</span>
<a href="#l237.340"></a><span id="l237.340">  * puts a name into the search field, starts a search, and then dismisses</span>
<a href="#l237.341"></a><span id="l237.341">  * the window.</span>
<a href="#l237.342"></a><span id="l237.342">  */</span>
<a href="#l237.343"></a><span id="l237.343"> function subtest_persist_name_in_search_field(w) {</span>
<a href="#l237.344"></a><span id="l237.344">   wait_for_provider_list_loaded(w);</span>
<a href="#l237.345"></a><span id="l237.345" class="difflineat">@@ -472,24 +467,24 @@ function subtest_persist_name_in_search_</span>
<a href="#l237.346"></a><span id="l237.346"> function subtest_persist_name_in_search_field_part_2(w) {</span>
<a href="#l237.347"></a><span id="l237.347">   mc.waitFor(() =&gt; w.e(&quot;name&quot;).value == NAME);</span>
<a href="#l237.348"></a><span id="l237.348"> }</span>
<a href="#l237.349"></a><span id="l237.349"> </span>
<a href="#l237.350"></a><span id="l237.350"> /**</span>
<a href="#l237.351"></a><span id="l237.351">  * Test that names with HTML characters are escaped properly when displayed</span>
<a href="#l237.352"></a><span id="l237.352">  * back to the user.</span>
<a href="#l237.353"></a><span id="l237.353">  */</span>
<a href="#l237.354"></a><span id="l237.354" class="difflineminus">-function test_html_characters_and_ampersands() {</span>
<a href="#l237.355"></a><span id="l237.355" class="difflineplus">+add_task(function test_html_characters_and_ampersands() {</span>
<a href="#l237.356"></a><span id="l237.356">   plan_for_modal_dialog(</span>
<a href="#l237.357"></a><span id="l237.357">     &quot;AccountCreation&quot;,</span>
<a href="#l237.358"></a><span id="l237.358">     subtest_html_characters_and_ampersands</span>
<a href="#l237.359"></a><span id="l237.359">   );</span>
<a href="#l237.360"></a><span id="l237.360">   open_provisioner_window();</span>
<a href="#l237.361"></a><span id="l237.361">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.362"></a><span id="l237.362" class="difflineminus">-}</span>
<a href="#l237.363"></a><span id="l237.363" class="difflineplus">+});</span>
<a href="#l237.364"></a><span id="l237.364"> </span>
<a href="#l237.365"></a><span id="l237.365"> /**</span>
<a href="#l237.366"></a><span id="l237.366">  * Subtest used by test_html_characters_and_ampersands.  This function puts</span>
<a href="#l237.367"></a><span id="l237.367">  * a name with HTML tags into the search input, does a search, and ensures</span>
<a href="#l237.368"></a><span id="l237.368">  * that the rendered name has escaped the HTML tags properly.</span>
<a href="#l237.369"></a><span id="l237.369">  */</span>
<a href="#l237.370"></a><span id="l237.370"> function subtest_html_characters_and_ampersands(w) {</span>
<a href="#l237.371"></a><span id="l237.371">   wait_for_provider_list_loaded(w);</span>
<a href="#l237.372"></a><span id="l237.372" class="difflineat">@@ -503,46 +498,46 @@ function subtest_html_characters_and_amp</span>
<a href="#l237.373"></a><span id="l237.373"> </span>
<a href="#l237.374"></a><span id="l237.374">   // Do the search.</span>
<a href="#l237.375"></a><span id="l237.375">   w.click(w.eid(&quot;searchSubmit&quot;));</span>
<a href="#l237.376"></a><span id="l237.376"> </span>
<a href="#l237.377"></a><span id="l237.377">   wait_for_search_results(w);</span>
<a href="#l237.378"></a><span id="l237.378"> </span>
<a href="#l237.379"></a><span id="l237.379">   let displayedName = w.e(&quot;FirstAndLastName&quot;).textContent;</span>
<a href="#l237.380"></a><span id="l237.380"> </span>
<a href="#l237.381"></a><span id="l237.381" class="difflineminus">-  assert_not_equals(CLEVER_STRING, displayedName);</span>
<a href="#l237.382"></a><span id="l237.382" class="difflineplus">+  Assert.notEqual(CLEVER_STRING, displayedName);</span>
<a href="#l237.383"></a><span id="l237.383">   // &amp; should have been replaced with &amp;amp;, and the</span>
<a href="#l237.384"></a><span id="l237.384">   // greater than / less than characters with &amp;gt; and</span>
<a href="#l237.385"></a><span id="l237.385">   // &amp;lt; respectively.</span>
<a href="#l237.386"></a><span id="l237.386" class="difflineminus">-  assert_true(</span>
<a href="#l237.387"></a><span id="l237.387" class="difflineplus">+  Assert.ok(</span>
<a href="#l237.388"></a><span id="l237.388">     displayedName.includes(&quot;&amp;amp;&quot;),</span>
<a href="#l237.389"></a><span id="l237.389">     &quot;Should have eliminated ampersands&quot;</span>
<a href="#l237.390"></a><span id="l237.390">   );</span>
<a href="#l237.391"></a><span id="l237.391" class="difflineminus">-  assert_true(</span>
<a href="#l237.392"></a><span id="l237.392" class="difflineplus">+  Assert.ok(</span>
<a href="#l237.393"></a><span id="l237.393">     displayedName.includes(&quot;&amp;gt;&quot;),</span>
<a href="#l237.394"></a><span id="l237.394">     &quot;Should have eliminated greater-than signs&quot;</span>
<a href="#l237.395"></a><span id="l237.395">   );</span>
<a href="#l237.396"></a><span id="l237.396" class="difflineminus">-  assert_true(</span>
<a href="#l237.397"></a><span id="l237.397" class="difflineplus">+  Assert.ok(</span>
<a href="#l237.398"></a><span id="l237.398">     displayedName.includes(&quot;&amp;lt;&quot;),</span>
<a href="#l237.399"></a><span id="l237.399">     &quot;Should have eliminated less-than signs&quot;</span>
<a href="#l237.400"></a><span id="l237.400">   );</span>
<a href="#l237.401"></a><span id="l237.401"> }</span>
<a href="#l237.402"></a><span id="l237.402"> </span>
<a href="#l237.403"></a><span id="l237.403"> /**</span>
<a href="#l237.404"></a><span id="l237.404">  * Test that only the terms of service and privacy links for selected</span>
<a href="#l237.405"></a><span id="l237.405">  * providers are shown in the disclaimer.</span>
<a href="#l237.406"></a><span id="l237.406">  */</span>
<a href="#l237.407"></a><span id="l237.407" class="difflineminus">-function test_show_tos_privacy_links_for_selected_providers() {</span>
<a href="#l237.408"></a><span id="l237.408" class="difflineplus">+add_task(function test_show_tos_privacy_links_for_selected_providers() {</span>
<a href="#l237.409"></a><span id="l237.409">   plan_for_modal_dialog(</span>
<a href="#l237.410"></a><span id="l237.410">     &quot;AccountCreation&quot;,</span>
<a href="#l237.411"></a><span id="l237.411">     subtest_show_tos_privacy_links_for_selected_providers</span>
<a href="#l237.412"></a><span id="l237.412">   );</span>
<a href="#l237.413"></a><span id="l237.413">   open_provisioner_window();</span>
<a href="#l237.414"></a><span id="l237.414">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.415"></a><span id="l237.415" class="difflineminus">-}</span>
<a href="#l237.416"></a><span id="l237.416" class="difflineplus">+});</span>
<a href="#l237.417"></a><span id="l237.417"> </span>
<a href="#l237.418"></a><span id="l237.418"> /**</span>
<a href="#l237.419"></a><span id="l237.419">  * Subtest used by test_show_tos_privacy_links_for_selected_providers.  This</span>
<a href="#l237.420"></a><span id="l237.420">  * function selects and deselects a series of providers, and ensures that the</span>
<a href="#l237.421"></a><span id="l237.421">  * appropriate terms of service and privacy links are shown.</span>
<a href="#l237.422"></a><span id="l237.422">  */</span>
<a href="#l237.423"></a><span id="l237.423"> function subtest_show_tos_privacy_links_for_selected_providers(w) {</span>
<a href="#l237.424"></a><span id="l237.424">   wait_for_provider_list_loaded(w);</span>
<a href="#l237.425"></a><span id="l237.425" class="difflineat">@@ -621,27 +616,27 @@ function subtest_show_tos_privacy_links_</span>
<a href="#l237.426"></a><span id="l237.426">     &quot;http://www.example.com/foo-privacy&quot;,</span>
<a href="#l237.427"></a><span id="l237.427">   ]);</span>
<a href="#l237.428"></a><span id="l237.428"> }</span>
<a href="#l237.429"></a><span id="l237.429"> </span>
<a href="#l237.430"></a><span id="l237.430"> /**</span>
<a href="#l237.431"></a><span id="l237.431">  * Test that if the search goes bad on the server-side, that we show an</span>
<a href="#l237.432"></a><span id="l237.432">  * error.</span>
<a href="#l237.433"></a><span id="l237.433">  */</span>
<a href="#l237.434"></a><span id="l237.434" class="difflineminus">-function test_shows_error_on_bad_suggest_from_name() {</span>
<a href="#l237.435"></a><span id="l237.435" class="difflineplus">+add_task(function test_shows_error_on_bad_suggest_from_name() {</span>
<a href="#l237.436"></a><span id="l237.436">   let original = Services.prefs.getCharPref(kSuggestFromNamePref);</span>
<a href="#l237.437"></a><span id="l237.437">   Services.prefs.setCharPref(kSuggestFromNamePref, url + &quot;badSuggestFromName&quot;);</span>
<a href="#l237.438"></a><span id="l237.438">   plan_for_modal_dialog(</span>
<a href="#l237.439"></a><span id="l237.439">     &quot;AccountCreation&quot;,</span>
<a href="#l237.440"></a><span id="l237.440">     subtest_shows_error_on_bad_suggest_from_name</span>
<a href="#l237.441"></a><span id="l237.441">   );</span>
<a href="#l237.442"></a><span id="l237.442">   open_provisioner_window();</span>
<a href="#l237.443"></a><span id="l237.443">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.444"></a><span id="l237.444">   Services.prefs.setCharPref(kSuggestFromNamePref, original);</span>
<a href="#l237.445"></a><span id="l237.445" class="difflineminus">-}</span>
<a href="#l237.446"></a><span id="l237.446" class="difflineplus">+});</span>
<a href="#l237.447"></a><span id="l237.447"> </span>
<a href="#l237.448"></a><span id="l237.448"> /**</span>
<a href="#l237.449"></a><span id="l237.449">  * Subtest for test_shows_error_on_bad_suggest_from_name.  This function does</span>
<a href="#l237.450"></a><span id="l237.450">  * a search, and then ensures that an error is displayed, since we got back</span>
<a href="#l237.451"></a><span id="l237.451">  * garbage from the server.</span>
<a href="#l237.452"></a><span id="l237.452">  */</span>
<a href="#l237.453"></a><span id="l237.453"> function subtest_shows_error_on_bad_suggest_from_name(w) {</span>
<a href="#l237.454"></a><span id="l237.454">   wait_for_provider_list_loaded(w);</span>
<a href="#l237.455"></a><span id="l237.455" class="difflineat">@@ -656,30 +651,30 @@ function subtest_shows_error_on_bad_sugg</span>
<a href="#l237.456"></a><span id="l237.456">     () =&gt; !w.window.document.querySelector(&quot;#notifications &gt; .error&quot;).hidden</span>
<a href="#l237.457"></a><span id="l237.457">   );</span>
<a href="#l237.458"></a><span id="l237.458"> }</span>
<a href="#l237.459"></a><span id="l237.459"> </span>
<a href="#l237.460"></a><span id="l237.460"> /**</span>
<a href="#l237.461"></a><span id="l237.461">  * Test that if we get an empty result from the server after a search, that</span>
<a href="#l237.462"></a><span id="l237.462">  * we show an error message.</span>
<a href="#l237.463"></a><span id="l237.463">  */</span>
<a href="#l237.464"></a><span id="l237.464" class="difflineminus">-function test_shows_error_on_empty_suggest_from_name() {</span>
<a href="#l237.465"></a><span id="l237.465" class="difflineplus">+add_task(function test_shows_error_on_empty_suggest_from_name() {</span>
<a href="#l237.466"></a><span id="l237.466">   let original = Services.prefs.getCharPref(kSuggestFromNamePref);</span>
<a href="#l237.467"></a><span id="l237.467">   Services.prefs.setCharPref(</span>
<a href="#l237.468"></a><span id="l237.468">     kSuggestFromNamePref,</span>
<a href="#l237.469"></a><span id="l237.469">     url + &quot;emptySuggestFromName&quot;</span>
<a href="#l237.470"></a><span id="l237.470">   );</span>
<a href="#l237.471"></a><span id="l237.471">   plan_for_modal_dialog(</span>
<a href="#l237.472"></a><span id="l237.472">     &quot;AccountCreation&quot;,</span>
<a href="#l237.473"></a><span id="l237.473">     subtest_shows_error_on_empty_suggest_from_name</span>
<a href="#l237.474"></a><span id="l237.474">   );</span>
<a href="#l237.475"></a><span id="l237.475">   open_provisioner_window();</span>
<a href="#l237.476"></a><span id="l237.476">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.477"></a><span id="l237.477">   Services.prefs.setCharPref(kSuggestFromNamePref, original);</span>
<a href="#l237.478"></a><span id="l237.478" class="difflineminus">-}</span>
<a href="#l237.479"></a><span id="l237.479" class="difflineplus">+});</span>
<a href="#l237.480"></a><span id="l237.480"> </span>
<a href="#l237.481"></a><span id="l237.481"> /**</span>
<a href="#l237.482"></a><span id="l237.482">  * Subtest for test_shows_error_on_empty_suggest_from_name. This function does</span>
<a href="#l237.483"></a><span id="l237.483">  * a search, and then ensures that an error is displayed, since we got back</span>
<a href="#l237.484"></a><span id="l237.484">  * an empty result from the server.</span>
<a href="#l237.485"></a><span id="l237.485">  */</span>
<a href="#l237.486"></a><span id="l237.486"> function subtest_shows_error_on_empty_suggest_from_name(w) {</span>
<a href="#l237.487"></a><span id="l237.487">   wait_for_provider_list_loaded(w);</span>
<a href="#l237.488"></a><span id="l237.488" class="difflineat">@@ -695,17 +690,17 @@ function subtest_shows_error_on_empty_su</span>
<a href="#l237.489"></a><span id="l237.489">   );</span>
<a href="#l237.490"></a><span id="l237.490"> }</span>
<a href="#l237.491"></a><span id="l237.491"> </span>
<a href="#l237.492"></a><span id="l237.492"> /**</span>
<a href="#l237.493"></a><span id="l237.493">  * Tests that if a provider returns broken or erroneous XML back</span>
<a href="#l237.494"></a><span id="l237.494">  * to the user after account registration, that we log the error</span>
<a href="#l237.495"></a><span id="l237.495">  * in the error console.</span>
<a href="#l237.496"></a><span id="l237.496">  */</span>
<a href="#l237.497"></a><span id="l237.497" class="difflineminus">-function test_throws_console_error_on_corrupt_XML() {</span>
<a href="#l237.498"></a><span id="l237.498" class="difflineplus">+add_task(function test_throws_console_error_on_corrupt_XML() {</span>
<a href="#l237.499"></a><span id="l237.499">   // Open the provisioner - once opened, let subtest_get_an_account run.</span>
<a href="#l237.500"></a><span id="l237.500">   get_to_order_form(&quot;corrupt@corrupt.invalid&quot;);</span>
<a href="#l237.501"></a><span id="l237.501">   let tab = mc.tabmail.currentTabInfo;</span>
<a href="#l237.502"></a><span id="l237.502"> </span>
<a href="#l237.503"></a><span id="l237.503">   // Record how many accounts we start with.</span>
<a href="#l237.504"></a><span id="l237.504">   gNumAccounts = nAccounts();</span>
<a href="#l237.505"></a><span id="l237.505"> </span>
<a href="#l237.506"></a><span id="l237.506">   gConsoleListener.reset();</span>
<a href="#l237.507"></a><span id="l237.507" class="difflineat">@@ -720,97 +715,97 @@ function test_throws_console_error_on_co</span>
<a href="#l237.508"></a><span id="l237.508">     &quot;input[value=Send]&quot;</span>
<a href="#l237.509"></a><span id="l237.509">   );</span>
<a href="#l237.510"></a><span id="l237.510">   mc.click(new elib.Elem(btn));</span>
<a href="#l237.511"></a><span id="l237.511">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.512"></a><span id="l237.512"> </span>
<a href="#l237.513"></a><span id="l237.513">   gConsoleListener.wait();</span>
<a href="#l237.514"></a><span id="l237.514"> </span>
<a href="#l237.515"></a><span id="l237.515">   Services.console.unregisterListener(gConsoleListener);</span>
<a href="#l237.516"></a><span id="l237.516" class="difflineminus">-}</span>
<a href="#l237.517"></a><span id="l237.517" class="difflineplus">+});</span>
<a href="#l237.518"></a><span id="l237.518"> </span>
<a href="#l237.519"></a><span id="l237.519"> /**</span>
<a href="#l237.520"></a><span id="l237.520">  * Test that if the providerList is invalid or broken JSON, that</span>
<a href="#l237.521"></a><span id="l237.521">  * we &quot;go offline&quot; and display an error message.</span>
<a href="#l237.522"></a><span id="l237.522">  */</span>
<a href="#l237.523"></a><span id="l237.523" class="difflineminus">-function test_broken_provider_list_goes_offline() {</span>
<a href="#l237.524"></a><span id="l237.524" class="difflineplus">+add_task(function test_broken_provider_list_goes_offline() {</span>
<a href="#l237.525"></a><span id="l237.525">   let original = Services.prefs.getCharPref(kProviderListPref);</span>
<a href="#l237.526"></a><span id="l237.526">   Services.prefs.setCharPref(kProviderListPref, url + &quot;providerListBad&quot;);</span>
<a href="#l237.527"></a><span id="l237.527"> </span>
<a href="#l237.528"></a><span id="l237.528">   plan_for_modal_dialog(</span>
<a href="#l237.529"></a><span id="l237.529">     &quot;AccountCreation&quot;,</span>
<a href="#l237.530"></a><span id="l237.530">     subtest_broken_provider_list_goes_offline</span>
<a href="#l237.531"></a><span id="l237.531">   );</span>
<a href="#l237.532"></a><span id="l237.532">   open_provisioner_window();</span>
<a href="#l237.533"></a><span id="l237.533">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.534"></a><span id="l237.534">   Services.prefs.setCharPref(kProviderListPref, original);</span>
<a href="#l237.535"></a><span id="l237.535" class="difflineminus">-}</span>
<a href="#l237.536"></a><span id="l237.536" class="difflineplus">+});</span>
<a href="#l237.537"></a><span id="l237.537"> </span>
<a href="#l237.538"></a><span id="l237.538"> /**</span>
<a href="#l237.539"></a><span id="l237.539">  * Subtest for test_broken_provider_list_goes_offline. This function just</span>
<a href="#l237.540"></a><span id="l237.540">  * waits for the offline message to appear.</span>
<a href="#l237.541"></a><span id="l237.541">  */</span>
<a href="#l237.542"></a><span id="l237.542"> function subtest_broken_provider_list_goes_offline(w) {</span>
<a href="#l237.543"></a><span id="l237.543">   wait_to_be_offline(w);</span>
<a href="#l237.544"></a><span id="l237.544"> }</span>
<a href="#l237.545"></a><span id="l237.545"> </span>
<a href="#l237.546"></a><span id="l237.546"> /**</span>
<a href="#l237.547"></a><span id="l237.547">  * Test that if a provider has not included some of the required fields,</span>
<a href="#l237.548"></a><span id="l237.548">  * then they're not included as a potential provider for the user.</span>
<a href="#l237.549"></a><span id="l237.549">  */</span>
<a href="#l237.550"></a><span id="l237.550" class="difflineminus">-function test_incomplete_provider_not_displayed() {</span>
<a href="#l237.551"></a><span id="l237.551" class="difflineplus">+add_task(function test_incomplete_provider_not_displayed() {</span>
<a href="#l237.552"></a><span id="l237.552">   let original = Services.prefs.getCharPref(kProviderListPref);</span>
<a href="#l237.553"></a><span id="l237.553">   Services.prefs.setCharPref(kProviderListPref, url + &quot;providerListIncomplete&quot;);</span>
<a href="#l237.554"></a><span id="l237.554"> </span>
<a href="#l237.555"></a><span id="l237.555">   plan_for_modal_dialog(</span>
<a href="#l237.556"></a><span id="l237.556">     &quot;AccountCreation&quot;,</span>
<a href="#l237.557"></a><span id="l237.557">     subtest_incomplete_provider_not_displayed</span>
<a href="#l237.558"></a><span id="l237.558">   );</span>
<a href="#l237.559"></a><span id="l237.559">   open_provisioner_window();</span>
<a href="#l237.560"></a><span id="l237.560">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.561"></a><span id="l237.561">   Services.prefs.setCharPref(kProviderListPref, original);</span>
<a href="#l237.562"></a><span id="l237.562" class="difflineminus">-}</span>
<a href="#l237.563"></a><span id="l237.563" class="difflineplus">+});</span>
<a href="#l237.564"></a><span id="l237.564"> </span>
<a href="#l237.565"></a><span id="l237.565"> /**</span>
<a href="#l237.566"></a><span id="l237.566">  * Subtest for test_incomplete_provider_not_displayed. This function just</span>
<a href="#l237.567"></a><span id="l237.567">  * ensures that the provider that didn't include all of the required fields</span>
<a href="#l237.568"></a><span id="l237.568">  * is not displayed.</span>
<a href="#l237.569"></a><span id="l237.569">  */</span>
<a href="#l237.570"></a><span id="l237.570"> function subtest_incomplete_provider_not_displayed(w) {</span>
<a href="#l237.571"></a><span id="l237.571">   wait_for_provider_list_loaded(w);</span>
<a href="#l237.572"></a><span id="l237.572">   // Make sure that the provider that didn't include the required fields</span>
<a href="#l237.573"></a><span id="l237.573">   // is not displayed.</span>
<a href="#l237.574"></a><span id="l237.574">   let input = w.window.document.querySelectorAll(</span>
<a href="#l237.575"></a><span id="l237.575">     'input[type=&quot;checkbox&quot;][value=&quot;corrupt&quot;]'</span>
<a href="#l237.576"></a><span id="l237.576">   );</span>
<a href="#l237.577"></a><span id="l237.577" class="difflineminus">-  assert_equals(</span>
<a href="#l237.578"></a><span id="l237.578" class="difflineplus">+  Assert.equal(</span>
<a href="#l237.579"></a><span id="l237.579">     0,</span>
<a href="#l237.580"></a><span id="l237.580">     input.length,</span>
<a href="#l237.581"></a><span id="l237.581">     &quot;The Corrupt provider should not have been displayed&quot;</span>
<a href="#l237.582"></a><span id="l237.582">   );</span>
<a href="#l237.583"></a><span id="l237.583"> </span>
<a href="#l237.584"></a><span id="l237.584">   // And check to ensure that at least one other provider is displayed</span>
<a href="#l237.585"></a><span id="l237.585">   input = w.window.document.querySelectorAll(</span>
<a href="#l237.586"></a><span id="l237.586">     'input[type=&quot;checkbox&quot;][value=&quot;foo&quot;]'</span>
<a href="#l237.587"></a><span id="l237.587">   );</span>
<a href="#l237.588"></a><span id="l237.588" class="difflineminus">-  assert_equals(1, input.length, &quot;The foo provider should have been displayed&quot;);</span>
<a href="#l237.589"></a><span id="l237.589" class="difflineplus">+  Assert.equal(1, input.length, &quot;The foo provider should have been displayed&quot;);</span>
<a href="#l237.590"></a><span id="l237.590"> }</span>
<a href="#l237.591"></a><span id="l237.591"> </span>
<a href="#l237.592"></a><span id="l237.592"> /**</span>
<a href="#l237.593"></a><span id="l237.593">  * Test that if the search text input is empty, or if no providers are selected,</span>
<a href="#l237.594"></a><span id="l237.594">  * that the search submit button is disabled.</span>
<a href="#l237.595"></a><span id="l237.595">  */</span>
<a href="#l237.596"></a><span id="l237.596" class="difflineminus">-function test_search_button_disabled_cases() {</span>
<a href="#l237.597"></a><span id="l237.597" class="difflineplus">+add_task(function test_search_button_disabled_cases() {</span>
<a href="#l237.598"></a><span id="l237.598">   plan_for_modal_dialog(</span>
<a href="#l237.599"></a><span id="l237.599">     &quot;AccountCreation&quot;,</span>
<a href="#l237.600"></a><span id="l237.600">     subtest_search_button_disabled_cases</span>
<a href="#l237.601"></a><span id="l237.601">   );</span>
<a href="#l237.602"></a><span id="l237.602">   open_provisioner_window();</span>
<a href="#l237.603"></a><span id="l237.603">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.604"></a><span id="l237.604" class="difflineminus">-}</span>
<a href="#l237.605"></a><span id="l237.605" class="difflineplus">+});</span>
<a href="#l237.606"></a><span id="l237.606"> </span>
<a href="#l237.607"></a><span id="l237.607"> /**</span>
<a href="#l237.608"></a><span id="l237.608">  * Subtest for test_search_button_disabled_cases.  This function ensures that</span>
<a href="#l237.609"></a><span id="l237.609">  * if the search input is empty, or if no providers are selected, then the</span>
<a href="#l237.610"></a><span id="l237.610">  * search submit button is disabled.  If, on the other hand some providers</span>
<a href="#l237.611"></a><span id="l237.611">  * are selected AND some text is in the search input, then the search submit</span>
<a href="#l237.612"></a><span id="l237.612">  * button should be enabled.</span>
<a href="#l237.613"></a><span id="l237.613">  */</span>
<a href="#l237.614"></a><span id="l237.614" class="difflineat">@@ -882,17 +877,17 @@ function subtest_search_button_disabled_</span>
<a href="#l237.615"></a><span id="l237.615">  * Tests that when we pref off the Account Provisioner, the menuitem for it</span>
<a href="#l237.616"></a><span id="l237.616">  * becomes hidden, and the button to switch to it from the Existing Account</span>
<a href="#l237.617"></a><span id="l237.617">  * wizard also becomes hidden.  Note that this doesn't test explicitly</span>
<a href="#l237.618"></a><span id="l237.618">  * whether or not the Account Provisioner spawns when there are no accounts.</span>
<a href="#l237.619"></a><span id="l237.619">  * The tests in this file will fail if the Account Provisioner does not spawn</span>
<a href="#l237.620"></a><span id="l237.620">  * with no accounts, and when preffed off, if the Account Provisioner does</span>
<a href="#l237.621"></a><span id="l237.621">  * spawn (which it shouldn't), the instrumentation Mozmill test should fail.</span>
<a href="#l237.622"></a><span id="l237.622">  */</span>
<a href="#l237.623"></a><span id="l237.623" class="difflineminus">-function test_can_pref_off_account_provisioner() {</span>
<a href="#l237.624"></a><span id="l237.624" class="difflineplus">+add_task(function test_can_pref_off_account_provisioner() {</span>
<a href="#l237.625"></a><span id="l237.625">   // First, we'll disable the account provisioner.</span>
<a href="#l237.626"></a><span id="l237.626">   Services.prefs.setBoolPref(&quot;mail.provider.enabled&quot;, false);</span>
<a href="#l237.627"></a><span id="l237.627"> </span>
<a href="#l237.628"></a><span id="l237.628">   // We'll use the Mozmill Menu API to grab the main menu...</span>
<a href="#l237.629"></a><span id="l237.629">   let mailMenuBar = mc.getMenu(&quot;#mail-menubar&quot;);</span>
<a href="#l237.630"></a><span id="l237.630">   let newMenuPopup = mc.eid(&quot;menu_NewPopup&quot;);</span>
<a href="#l237.631"></a><span id="l237.631">   let newMailAccountMenuitem = mc.eid(&quot;newMailAccountMenuItem&quot;);</span>
<a href="#l237.632"></a><span id="l237.632"> </span>
<a href="#l237.633"></a><span id="l237.633" class="difflineat">@@ -916,17 +911,17 @@ function test_can_pref_off_account_provi</span>
<a href="#l237.634"></a><span id="l237.634">   // Open up the Existing Account wizard</span>
<a href="#l237.635"></a><span id="l237.635">   plan_for_new_window(&quot;mail:autoconfig&quot;);</span>
<a href="#l237.636"></a><span id="l237.636">   mc.click(newMailAccountMenuitem);</span>
<a href="#l237.637"></a><span id="l237.637"> </span>
<a href="#l237.638"></a><span id="l237.638">   // Ensure that the existing email account wizard opened.</span>
<a href="#l237.639"></a><span id="l237.639">   let wizard = wait_for_new_window(&quot;mail:autoconfig&quot;);</span>
<a href="#l237.640"></a><span id="l237.640"> </span>
<a href="#l237.641"></a><span id="l237.641">   // And make sure the Get a New Account button is hidden.</span>
<a href="#l237.642"></a><span id="l237.642" class="difflineminus">-  assert_true(wizard.eid(&quot;provisioner_button&quot;).getNode().hidden);</span>
<a href="#l237.643"></a><span id="l237.643" class="difflineplus">+  Assert.ok(wizard.eid(&quot;provisioner_button&quot;).getNode().hidden);</span>
<a href="#l237.644"></a><span id="l237.644"> </span>
<a href="#l237.645"></a><span id="l237.645">   // Alright, close the Wizard.</span>
<a href="#l237.646"></a><span id="l237.646">   plan_for_window_close(wizard);</span>
<a href="#l237.647"></a><span id="l237.647">   close_window(wizard);</span>
<a href="#l237.648"></a><span id="l237.648">   wait_for_window_close();</span>
<a href="#l237.649"></a><span id="l237.649"> </span>
<a href="#l237.650"></a><span id="l237.650">   // Ok, now pref the Account Provisioner back on</span>
<a href="#l237.651"></a><span id="l237.651">   Services.prefs.setBoolPref(&quot;mail.provider.enabled&quot;, true);</span>
<a href="#l237.652"></a><span id="l237.652" class="difflineat">@@ -943,45 +938,43 @@ function test_can_pref_off_account_provi</span>
<a href="#l237.653"></a><span id="l237.653">   plan_for_new_window(&quot;mail:autoconfig&quot;);</span>
<a href="#l237.654"></a><span id="l237.654">   mc.click(newMailAccountMenuitem);</span>
<a href="#l237.655"></a><span id="l237.655"> </span>
<a href="#l237.656"></a><span id="l237.656">   // Ensure that the existing email account wizard opened.</span>
<a href="#l237.657"></a><span id="l237.657">   wizard = wait_for_new_window(&quot;mail:autoconfig&quot;);</span>
<a href="#l237.658"></a><span id="l237.658"> </span>
<a href="#l237.659"></a><span id="l237.659">   // Make sure that the button to open the Account Provisioner dialog is</span>
<a href="#l237.660"></a><span id="l237.660">   // NOT hidden.</span>
<a href="#l237.661"></a><span id="l237.661" class="difflineminus">-  assert_false(wizard.eid(&quot;provisioner_button&quot;).getNode().hidden);</span>
<a href="#l237.662"></a><span id="l237.662" class="difflineplus">+  Assert.ok(!wizard.eid(&quot;provisioner_button&quot;).getNode().hidden);</span>
<a href="#l237.663"></a><span id="l237.663"> </span>
<a href="#l237.664"></a><span id="l237.664">   // Alright, close up.</span>
<a href="#l237.665"></a><span id="l237.665">   close_window(wizard);</span>
<a href="#l237.666"></a><span id="l237.666"> </span>
<a href="#l237.667"></a><span id="l237.667">   // And finally restore the menu to the way it was.</span>
<a href="#l237.668"></a><span id="l237.668">   newMenuPopup.getNode().allowevents = oldAllowEvents;</span>
<a href="#l237.669"></a><span id="l237.669" class="difflineminus">-}</span>
<a href="#l237.670"></a><span id="l237.670" class="difflineminus">-</span>
<a href="#l237.671"></a><span id="l237.671" class="difflineplus">+}).__skipMe = AppConstants.platform == &quot;macosx&quot;;</span>
<a href="#l237.672"></a><span id="l237.672"> // We cannot control menus via Mozmill in OSX, so we'll skip this test.</span>
<a href="#l237.673"></a><span id="l237.673" class="difflineminus">-test_can_pref_off_account_provisioner.EXCLUDED_PLATFORMS = [&quot;darwin&quot;];</span>
<a href="#l237.674"></a><span id="l237.674"> </span>
<a href="#l237.675"></a><span id="l237.675"> /**</span>
<a href="#l237.676"></a><span id="l237.676">  * Tests that if we load a provider list that does not include providers in</span>
<a href="#l237.677"></a><span id="l237.677">  * other languages, then the &quot;show me providers in other languages&quot; link is</span>
<a href="#l237.678"></a><span id="l237.678">  * hidden.</span>
<a href="#l237.679"></a><span id="l237.679">  */</span>
<a href="#l237.680"></a><span id="l237.680" class="difflineminus">-function test_other_lang_link_hides() {</span>
<a href="#l237.681"></a><span id="l237.681" class="difflineplus">+add_task(function test_other_lang_link_hides() {</span>
<a href="#l237.682"></a><span id="l237.682">   let original = Services.prefs.getCharPref(kProviderListPref);</span>
<a href="#l237.683"></a><span id="l237.683">   Services.prefs.setCharPref(</span>
<a href="#l237.684"></a><span id="l237.684">     kProviderListPref,</span>
<a href="#l237.685"></a><span id="l237.685">     url + &quot;providerListNoOtherLangs&quot;</span>
<a href="#l237.686"></a><span id="l237.686">   );</span>
<a href="#l237.687"></a><span id="l237.687"> </span>
<a href="#l237.688"></a><span id="l237.688">   plan_for_modal_dialog(&quot;AccountCreation&quot;, subtest_other_lang_link_hides);</span>
<a href="#l237.689"></a><span id="l237.689">   open_provisioner_window();</span>
<a href="#l237.690"></a><span id="l237.690">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.691"></a><span id="l237.691">   Services.prefs.setCharPref(kProviderListPref, original);</span>
<a href="#l237.692"></a><span id="l237.692" class="difflineminus">-}</span>
<a href="#l237.693"></a><span id="l237.693" class="difflineplus">+});</span>
<a href="#l237.694"></a><span id="l237.694"> </span>
<a href="#l237.695"></a><span id="l237.695"> /**</span>
<a href="#l237.696"></a><span id="l237.696">  * Subtest for test_other_lang_link_hides that just waits for the provider</span>
<a href="#l237.697"></a><span id="l237.697">  * list to be loaded, and then ensures that the &quot;show me providers in other</span>
<a href="#l237.698"></a><span id="l237.698">  * languages&quot; link is not visible.</span>
<a href="#l237.699"></a><span id="l237.699">  */</span>
<a href="#l237.700"></a><span id="l237.700"> function subtest_other_lang_link_hides(w) {</span>
<a href="#l237.701"></a><span id="l237.701">   wait_for_provider_list_loaded(w);</span>
<a href="#l237.702"></a><span id="l237.702" class="difflineat">@@ -1025,17 +1018,17 @@ function sub_get_to_order_form(aControll</span>
<a href="#l237.703"></a><span id="l237.703">   aController.click(aController.eid(&quot;searchSubmit&quot;));</span>
<a href="#l237.704"></a><span id="l237.704">   wait_for_search_results(aController);</span>
<a href="#l237.705"></a><span id="l237.705"> </span>
<a href="#l237.706"></a><span id="l237.706">   // Click on the requested address. This reveals the button with the price.</span>
<a href="#l237.707"></a><span id="l237.707">   let addressElts = [</span>
<a href="#l237.708"></a><span id="l237.708">     ...aController.window.document.querySelectorAll(&quot;.address&quot;),</span>
<a href="#l237.709"></a><span id="l237.709">   ];</span>
<a href="#l237.710"></a><span id="l237.710">   let address = addressElts.filter(a =&gt; a.textContent == aAddress).shift();</span>
<a href="#l237.711"></a><span id="l237.711" class="difflineminus">-  assert_true(!!address, &quot;Couldn't find the requested address &quot; + aAddress);</span>
<a href="#l237.712"></a><span id="l237.712" class="difflineplus">+  Assert.ok(!!address, &quot;Couldn't find the requested address &quot; + aAddress);</span>
<a href="#l237.713"></a><span id="l237.713">   aController.click(new elib.Elem(address));</span>
<a href="#l237.714"></a><span id="l237.714">   aController.waitFor(</span>
<a href="#l237.715"></a><span id="l237.715">     () =&gt;</span>
<a href="#l237.716"></a><span id="l237.716">       aController.window.document.querySelectorAll(</span>
<a href="#l237.717"></a><span id="l237.717">         'button.create:not([disabled=&quot;true&quot;])'</span>
<a href="#l237.718"></a><span id="l237.718">       ).length &gt; 0</span>
<a href="#l237.719"></a><span id="l237.719">   );</span>
<a href="#l237.720"></a><span id="l237.720"> </span>
<a href="#l237.721"></a><span id="l237.721" class="difflineat">@@ -1059,60 +1052,60 @@ function close_dialog_immediately(aContr</span>
<a href="#l237.722"></a><span id="l237.722">   mc.click(new elib.Elem(aController.window.document.querySelector(&quot;.close&quot;)));</span>
<a href="#l237.723"></a><span id="l237.723">   wait_for_window_close();</span>
<a href="#l237.724"></a><span id="l237.724"> }</span>
<a href="#l237.725"></a><span id="l237.725"> </span>
<a href="#l237.726"></a><span id="l237.726"> /**</span>
<a href="#l237.727"></a><span id="l237.727">  * Test that clicking on links in the order form open in the same account</span>
<a href="#l237.728"></a><span id="l237.728">  * provisioner tab.</span>
<a href="#l237.729"></a><span id="l237.729">  */</span>
<a href="#l237.730"></a><span id="l237.730" class="difflineminus">-function test_internal_link_opening_behaviour() {</span>
<a href="#l237.731"></a><span id="l237.731" class="difflineplus">+add_task(function test_internal_link_opening_behaviour() {</span>
<a href="#l237.732"></a><span id="l237.732">   get_to_order_form();</span>
<a href="#l237.733"></a><span id="l237.733"> </span>
<a href="#l237.734"></a><span id="l237.734">   // Open the provisioner - once opened, let subtest_get_an_account run...</span>
<a href="#l237.735"></a><span id="l237.735">   let tab = mc.tabmail.currentTabInfo;</span>
<a href="#l237.736"></a><span id="l237.736">   let doc = tab.browser.contentWindow.document;</span>
<a href="#l237.737"></a><span id="l237.737"> </span>
<a href="#l237.738"></a><span id="l237.738">   // Click on the internal link.</span>
<a href="#l237.739"></a><span id="l237.739">   mc.click(new elib.Elem(doc.getElementById(&quot;internal&quot;)));</span>
<a href="#l237.740"></a><span id="l237.740"> </span>
<a href="#l237.741"></a><span id="l237.741">   // We should load the target page in the current tab browser.</span>
<a href="#l237.742"></a><span id="l237.742">   wait_for_browser_load(tab.browser, function(aURL) {</span>
<a href="#l237.743"></a><span id="l237.743">     return aURL.host == &quot;localhost&quot; &amp;&amp; aURL.pathQueryRef == &quot;/target.html&quot;;</span>
<a href="#l237.744"></a><span id="l237.744">   });</span>
<a href="#l237.745"></a><span id="l237.745">   // Now close the tab.</span>
<a href="#l237.746"></a><span id="l237.746">   mc.tabmail.closeTab(tab);</span>
<a href="#l237.747"></a><span id="l237.747" class="difflineminus">-}</span>
<a href="#l237.748"></a><span id="l237.748" class="difflineplus">+});</span>
<a href="#l237.749"></a><span id="l237.749"> </span>
<a href="#l237.750"></a><span id="l237.750"> /**</span>
<a href="#l237.751"></a><span id="l237.751">  * Test that window.open in the order form opens in new content tabs.</span>
<a href="#l237.752"></a><span id="l237.752">  */</span>
<a href="#l237.753"></a><span id="l237.753" class="difflineminus">-function test_window_open_link_opening_behaviour() {</span>
<a href="#l237.754"></a><span id="l237.754" class="difflineplus">+add_task(function test_window_open_link_opening_behaviour() {</span>
<a href="#l237.755"></a><span id="l237.755">   get_to_order_form();</span>
<a href="#l237.756"></a><span id="l237.756"> </span>
<a href="#l237.757"></a><span id="l237.757">   let tab = mc.tabmail.currentTabInfo;</span>
<a href="#l237.758"></a><span id="l237.758">   let doc = tab.browser.contentWindow.document;</span>
<a href="#l237.759"></a><span id="l237.759"> </span>
<a href="#l237.760"></a><span id="l237.760">   // First, click on the Javascript link - this should open in a new content</span>
<a href="#l237.761"></a><span id="l237.761">   // tab and be focused.</span>
<a href="#l237.762"></a><span id="l237.762">   let newTabLink = doc.getElementById(&quot;newtab&quot;);</span>
<a href="#l237.763"></a><span id="l237.763">   open_content_tab_with_click(newTabLink, function(aURL) {</span>
<a href="#l237.764"></a><span id="l237.764">     return aURL.host == &quot;localhost&quot; &amp;&amp; aURL.pathQueryRef == &quot;/target.html&quot;;</span>
<a href="#l237.765"></a><span id="l237.765">   });</span>
<a href="#l237.766"></a><span id="l237.766"> </span>
<a href="#l237.767"></a><span id="l237.767">   // Close the new tab.</span>
<a href="#l237.768"></a><span id="l237.768">   let newTab = mc.tabmail.currentTabInfo;</span>
<a href="#l237.769"></a><span id="l237.769">   mc.tabmail.closeTab(newTab);</span>
<a href="#l237.770"></a><span id="l237.770">   mc.tabmail.closeTab(tab);</span>
<a href="#l237.771"></a><span id="l237.771" class="difflineminus">-}</span>
<a href="#l237.772"></a><span id="l237.772" class="difflineplus">+});</span>
<a href="#l237.773"></a><span id="l237.773"> </span>
<a href="#l237.774"></a><span id="l237.774"> /**</span>
<a href="#l237.775"></a><span id="l237.775">  * Test that links with target=&quot;_blank&quot; open in the default browser.</span>
<a href="#l237.776"></a><span id="l237.776">  */</span>
<a href="#l237.777"></a><span id="l237.777" class="difflineminus">-function test_external_link_opening_behaviour() {</span>
<a href="#l237.778"></a><span id="l237.778" class="difflineplus">+add_task(function test_external_link_opening_behaviour() {</span>
<a href="#l237.779"></a><span id="l237.779">   get_to_order_form();</span>
<a href="#l237.780"></a><span id="l237.780"> </span>
<a href="#l237.781"></a><span id="l237.781">   let tab = mc.tabmail.currentTabInfo;</span>
<a href="#l237.782"></a><span id="l237.782">   let doc = tab.browser.contentWindow.document;</span>
<a href="#l237.783"></a><span id="l237.783"> </span>
<a href="#l237.784"></a><span id="l237.784">   // Mock out the ExternalProtocolService.</span>
<a href="#l237.785"></a><span id="l237.785">   gMockExtProtSvcReg.register();</span>
<a href="#l237.786"></a><span id="l237.786"> </span>
<a href="#l237.787"></a><span id="l237.787" class="difflineat">@@ -1124,23 +1117,23 @@ function test_external_link_opening_beha</span>
<a href="#l237.788"></a><span id="l237.788">     () =&gt; gMockExtProtSvc.urlLoaded(targetHref),</span>
<a href="#l237.789"></a><span id="l237.789">     &quot;Timed out waiting for the link &quot; +</span>
<a href="#l237.790"></a><span id="l237.790">       targetHref +</span>
<a href="#l237.791"></a><span id="l237.791">       &quot;to be &quot; +</span>
<a href="#l237.792"></a><span id="l237.792">       &quot;opened in the default browser.&quot;</span>
<a href="#l237.793"></a><span id="l237.793">   );</span>
<a href="#l237.794"></a><span id="l237.794">   gMockExtProtSvcReg.unregister();</span>
<a href="#l237.795"></a><span id="l237.795">   mc.tabmail.closeTab(tab);</span>
<a href="#l237.796"></a><span id="l237.796" class="difflineminus">-}</span>
<a href="#l237.797"></a><span id="l237.797" class="difflineplus">+});</span>
<a href="#l237.798"></a><span id="l237.798"> </span>
<a href="#l237.799"></a><span id="l237.799"> /**</span>
<a href="#l237.800"></a><span id="l237.800">  * Test that if the provider returns XML that we can't turn into an account,</span>
<a href="#l237.801"></a><span id="l237.801">  * then we error out and go back to the Account Provisioner dialog.</span>
<a href="#l237.802"></a><span id="l237.802">  */</span>
<a href="#l237.803"></a><span id="l237.803" class="difflineminus">-function test_return_to_provisioner_on_error_XML() {</span>
<a href="#l237.804"></a><span id="l237.804" class="difflineplus">+add_task(function test_return_to_provisioner_on_error_XML() {</span>
<a href="#l237.805"></a><span id="l237.805">   const kOriginalTabNum = mc.tabmail.tabContainer.allTabs.length;</span>
<a href="#l237.806"></a><span id="l237.806"> </span>
<a href="#l237.807"></a><span id="l237.807">   get_to_order_form(&quot;error@error.invalid&quot;);</span>
<a href="#l237.808"></a><span id="l237.808"> </span>
<a href="#l237.809"></a><span id="l237.809">   let tab = mc.tabmail.currentTabInfo;</span>
<a href="#l237.810"></a><span id="l237.810"> </span>
<a href="#l237.811"></a><span id="l237.811">   plan_for_modal_dialog(&quot;AccountCreation&quot;, close_dialog_immediately);</span>
<a href="#l237.812"></a><span id="l237.812"> </span>
<a href="#l237.813"></a><span id="l237.813" class="difflineat">@@ -1150,36 +1143,36 @@ function test_return_to_provisioner_on_e</span>
<a href="#l237.814"></a><span id="l237.814">   );</span>
<a href="#l237.815"></a><span id="l237.815">   mc.click(new elib.Elem(btn));</span>
<a href="#l237.816"></a><span id="l237.816"> </span>
<a href="#l237.817"></a><span id="l237.817">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.818"></a><span id="l237.818"> </span>
<a href="#l237.819"></a><span id="l237.819">   // We should be done executing the function defined in plan_for_modal_dialog</span>
<a href="#l237.820"></a><span id="l237.820">   // now, so the Account Provisioner dialog should be closed, and the order</span>
<a href="#l237.821"></a><span id="l237.821">   // form tab should have been closed.</span>
<a href="#l237.822"></a><span id="l237.822" class="difflineminus">-  assert_equals(</span>
<a href="#l237.823"></a><span id="l237.823" class="difflineplus">+  Assert.equal(</span>
<a href="#l237.824"></a><span id="l237.824">     kOriginalTabNum,</span>
<a href="#l237.825"></a><span id="l237.825">     mc.tabmail.tabContainer.allTabs.length,</span>
<a href="#l237.826"></a><span id="l237.826">     &quot;Timed out waiting for the order form tab to close.&quot;</span>
<a href="#l237.827"></a><span id="l237.827">   );</span>
<a href="#l237.828"></a><span id="l237.828" class="difflineminus">-}</span>
<a href="#l237.829"></a><span id="l237.829" class="difflineplus">+});</span>
<a href="#l237.830"></a><span id="l237.830"> </span>
<a href="#l237.831"></a><span id="l237.831"> /**</span>
<a href="#l237.832"></a><span id="l237.832">  * Test that if we initiate a search, then the search input, the search button,</span>
<a href="#l237.833"></a><span id="l237.833">  * and all checkboxes should be disabled. The ability to close the window should</span>
<a href="#l237.834"></a><span id="l237.834">  * still be enabled though.</span>
<a href="#l237.835"></a><span id="l237.835">  */</span>
<a href="#l237.836"></a><span id="l237.836" class="difflineminus">-function test_disabled_fields_when_searching() {</span>
<a href="#l237.837"></a><span id="l237.837" class="difflineplus">+add_task(function test_disabled_fields_when_searching() {</span>
<a href="#l237.838"></a><span id="l237.838">   plan_for_modal_dialog(</span>
<a href="#l237.839"></a><span id="l237.839">     &quot;AccountCreation&quot;,</span>
<a href="#l237.840"></a><span id="l237.840">     subtest_disabled_fields_when_searching</span>
<a href="#l237.841"></a><span id="l237.841">   );</span>
<a href="#l237.842"></a><span id="l237.842">   open_provisioner_window();</span>
<a href="#l237.843"></a><span id="l237.843">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.844"></a><span id="l237.844" class="difflineminus">-}</span>
<a href="#l237.845"></a><span id="l237.845" class="difflineplus">+});</span>
<a href="#l237.846"></a><span id="l237.846"> </span>
<a href="#l237.847"></a><span id="l237.847"> /**</span>
<a href="#l237.848"></a><span id="l237.848">  * Subtest for test_disabled_fields_when_searching. Sets up a fake HTTP server</span>
<a href="#l237.849"></a><span id="l237.849">  * that slowly returns a search suggestion, and then checks to ensure all the</span>
<a href="#l237.850"></a><span id="l237.850">  * right fields are disabled (search input, search button, all check boxes).</span>
<a href="#l237.851"></a><span id="l237.851">  * We also make sure those fields are renabled once the test is completed.</span>
<a href="#l237.852"></a><span id="l237.852">  */</span>
<a href="#l237.853"></a><span id="l237.853"> function subtest_disabled_fields_when_searching(aController) {</span>
<a href="#l237.854"></a><span id="l237.854" class="difflineat">@@ -1277,34 +1270,34 @@ function subtest_disabled_fields_when_se</span>
<a href="#l237.855"></a><span id="l237.855"> </span>
<a href="#l237.856"></a><span id="l237.856">   close_dialog_immediately(aController);</span>
<a href="#l237.857"></a><span id="l237.857"> }</span>
<a href="#l237.858"></a><span id="l237.858"> </span>
<a href="#l237.859"></a><span id="l237.859"> /**</span>
<a href="#l237.860"></a><span id="l237.860">  * Tests that the search button is disabled if there is no initially</span>
<a href="#l237.861"></a><span id="l237.861">  * supported language for the user.</span>
<a href="#l237.862"></a><span id="l237.862">  */</span>
<a href="#l237.863"></a><span id="l237.863" class="difflineminus">-function test_search_button_disabled_if_no_lang_support() {</span>
<a href="#l237.864"></a><span id="l237.864" class="difflineplus">+add_task(function test_search_button_disabled_if_no_lang_support() {</span>
<a href="#l237.865"></a><span id="l237.865">   // Set the user's supported language to something ridiculous (caching the</span>
<a href="#l237.866"></a><span id="l237.866">   // old one so we can put it back later).</span>
<a href="#l237.867"></a><span id="l237.867">   let originalReqLocales = Services.locale.requestedLocales;</span>
<a href="#l237.868"></a><span id="l237.868">   Services.locale.requestedLocales = [&quot;foo&quot;];</span>
<a href="#l237.869"></a><span id="l237.869"> </span>
<a href="#l237.870"></a><span id="l237.870">   plan_for_modal_dialog(&quot;AccountCreation&quot;, function(aController) {</span>
<a href="#l237.871"></a><span id="l237.871">     wait_for_provider_list_loaded(aController);</span>
<a href="#l237.872"></a><span id="l237.872">     // The search button should be disabled.</span>
<a href="#l237.873"></a><span id="l237.873">     wait_for_element_enabled(aController, aController.e(&quot;searchSubmit&quot;), false);</span>
<a href="#l237.874"></a><span id="l237.874">     close_dialog_immediately(aController);</span>
<a href="#l237.875"></a><span id="l237.875">   });</span>
<a href="#l237.876"></a><span id="l237.876"> </span>
<a href="#l237.877"></a><span id="l237.877">   open_provisioner_window();</span>
<a href="#l237.878"></a><span id="l237.878">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.879"></a><span id="l237.879"> </span>
<a href="#l237.880"></a><span id="l237.880">   Services.locale.requestedLocales = originalReqLocales;</span>
<a href="#l237.881"></a><span id="l237.881" class="difflineminus">-}</span>
<a href="#l237.882"></a><span id="l237.882" class="difflineplus">+});</span>
<a href="#l237.883"></a><span id="l237.883"> </span>
<a href="#l237.884"></a><span id="l237.884"> /**</span>
<a href="#l237.885"></a><span id="l237.885">  * Subtest used by several functions that checks to make sure that the</span>
<a href="#l237.886"></a><span id="l237.886">  * search button is disabled when the Account Provisioner dialog is opened,</span>
<a href="#l237.887"></a><span id="l237.887">  * in case there's no search input yet.</span>
<a href="#l237.888"></a><span id="l237.888">  */</span>
<a href="#l237.889"></a><span id="l237.889"> function subtest_search_button_enabled_state_on_init(aController) {</span>
<a href="#l237.890"></a><span id="l237.890">   wait_for_provider_list_loaded(aController);</span>
<a href="#l237.891"></a><span id="l237.891" class="difflineat">@@ -1317,29 +1310,29 @@ function subtest_search_button_enabled_s</span>
<a href="#l237.892"></a><span id="l237.892">   close_dialog_immediately(aController);</span>
<a href="#l237.893"></a><span id="l237.893"> }</span>
<a href="#l237.894"></a><span id="l237.894"> </span>
<a href="#l237.895"></a><span id="l237.895"> /**</span>
<a href="#l237.896"></a><span id="l237.896">  * Test that if the providerList contains entries with supported languages</span>
<a href="#l237.897"></a><span id="l237.897">  * including &quot;*&quot;, they are always displayed, even if the users locale pref</span>
<a href="#l237.898"></a><span id="l237.898">  * is not set to &quot;*&quot;.</span>
<a href="#l237.899"></a><span id="l237.899">  */</span>
<a href="#l237.900"></a><span id="l237.900" class="difflineminus">-function test_provider_language_wildcard() {</span>
<a href="#l237.901"></a><span id="l237.901" class="difflineplus">+add_task(function test_provider_language_wildcard() {</span>
<a href="#l237.902"></a><span id="l237.902">   let originalReqLocales = Services.locale.requestedLocales;</span>
<a href="#l237.903"></a><span id="l237.903">   Services.locale.requestedLocales = [&quot;foo-ba&quot;];</span>
<a href="#l237.904"></a><span id="l237.904"> </span>
<a href="#l237.905"></a><span id="l237.905">   let original = Services.prefs.getCharPref(kProviderListPref);</span>
<a href="#l237.906"></a><span id="l237.906">   Services.prefs.setCharPref(kProviderListPref, url + &quot;providerListWildcard&quot;);</span>
<a href="#l237.907"></a><span id="l237.907"> </span>
<a href="#l237.908"></a><span id="l237.908">   plan_for_modal_dialog(&quot;AccountCreation&quot;, subtest_provider_language_wildcard);</span>
<a href="#l237.909"></a><span id="l237.909">   open_provisioner_window();</span>
<a href="#l237.910"></a><span id="l237.910">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.911"></a><span id="l237.911">   Services.prefs.setCharPref(kProviderListPref, original);</span>
<a href="#l237.912"></a><span id="l237.912">   Services.locale.requestedLocales = originalReqLocales;</span>
<a href="#l237.913"></a><span id="l237.913" class="difflineminus">-}</span>
<a href="#l237.914"></a><span id="l237.914" class="difflineplus">+});</span>
<a href="#l237.915"></a><span id="l237.915"> </span>
<a href="#l237.916"></a><span id="l237.916"> /**</span>
<a href="#l237.917"></a><span id="l237.917">  * Subtest used by test_provider_language_wildcard, ensures that the</span>
<a href="#l237.918"></a><span id="l237.918">  * &quot;Universal&quot; and &quot;OtherUniversal&quot; providers are displayed, but the French</span>
<a href="#l237.919"></a><span id="l237.919">  * and German ones are not.</span>
<a href="#l237.920"></a><span id="l237.920">  */</span>
<a href="#l237.921"></a><span id="l237.921"> function subtest_provider_language_wildcard(aController) {</span>
<a href="#l237.922"></a><span id="l237.922">   wait_for_provider_list_loaded(aController);</span>
<a href="#l237.923"></a><span id="l237.923" class="difflineat">@@ -1351,32 +1344,32 @@ function subtest_provider_language_wildc</span>
<a href="#l237.924"></a><span id="l237.924">   wait_for_element_invisible(aController, &quot;german-check&quot;);</span>
<a href="#l237.925"></a><span id="l237.925">   close_dialog_immediately(aController);</span>
<a href="#l237.926"></a><span id="l237.926"> }</span>
<a href="#l237.927"></a><span id="l237.927"> </span>
<a href="#l237.928"></a><span id="l237.928"> /**</span>
<a href="#l237.929"></a><span id="l237.929">  * Tests that the search button is disabled if we start up the Account</span>
<a href="#l237.930"></a><span id="l237.930">  * Provisioner, and we have no search in the input.</span>
<a href="#l237.931"></a><span id="l237.931">  */</span>
<a href="#l237.932"></a><span id="l237.932" class="difflineminus">-function test_search_button_disabled_if_no_query_on_init() {</span>
<a href="#l237.933"></a><span id="l237.933" class="difflineplus">+add_task(function test_search_button_disabled_if_no_query_on_init() {</span>
<a href="#l237.934"></a><span id="l237.934">   Services.prefs.setStringPref(&quot;mail.provider.realname&quot;, &quot;&quot;);</span>
<a href="#l237.935"></a><span id="l237.935">   plan_for_modal_dialog(</span>
<a href="#l237.936"></a><span id="l237.936">     &quot;AccountCreation&quot;,</span>
<a href="#l237.937"></a><span id="l237.937">     subtest_search_button_enabled_state_on_init</span>
<a href="#l237.938"></a><span id="l237.938">   );</span>
<a href="#l237.939"></a><span id="l237.939">   open_provisioner_window();</span>
<a href="#l237.940"></a><span id="l237.940">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.941"></a><span id="l237.941" class="difflineminus">-}</span>
<a href="#l237.942"></a><span id="l237.942" class="difflineplus">+});</span>
<a href="#l237.943"></a><span id="l237.943"> </span>
<a href="#l237.944"></a><span id="l237.944"> /**</span>
<a href="#l237.945"></a><span id="l237.945">  * Test that if we try to open the Account Provisioner dialog when an</span>
<a href="#l237.946"></a><span id="l237.946">  * Account Provisioner tab is opened, that we focus the tab instead of opening</span>
<a href="#l237.947"></a><span id="l237.947">  * the dialog.</span>
<a href="#l237.948"></a><span id="l237.948">  */</span>
<a href="#l237.949"></a><span id="l237.949" class="difflineminus">-function test_get_new_account_focuses_existing_ap_tab() {</span>
<a href="#l237.950"></a><span id="l237.950" class="difflineplus">+add_task(function test_get_new_account_focuses_existing_ap_tab() {</span>
<a href="#l237.951"></a><span id="l237.951">   get_to_order_form(&quot;green@example.com&quot;);</span>
<a href="#l237.952"></a><span id="l237.952">   let apTab = mc.tabmail.getTabInfoForCurrentOrFirstModeInstance(</span>
<a href="#l237.953"></a><span id="l237.953">     mc.tabmail.tabModes.accountProvisionerTab</span>
<a href="#l237.954"></a><span id="l237.954">   );</span>
<a href="#l237.955"></a><span id="l237.955"> </span>
<a href="#l237.956"></a><span id="l237.956">   // Switch back to the inbox tab.</span>
<a href="#l237.957"></a><span id="l237.957">   mc.tabmail.switchToTab(0);</span>
<a href="#l237.958"></a><span id="l237.958"> </span>
<a href="#l237.959"></a><span id="l237.959" class="difflineat">@@ -1397,26 +1390,26 @@ function test_get_new_account_focuses_ex</span>
<a href="#l237.960"></a><span id="l237.960"> </span>
<a href="#l237.961"></a><span id="l237.961">   // Click on the &quot;Get a new Account&quot; button in the wizard.</span>
<a href="#l237.962"></a><span id="l237.962">   wizard.click(wizard.eid(&quot;provisioner_button&quot;));</span>
<a href="#l237.963"></a><span id="l237.963"> </span>
<a href="#l237.964"></a><span id="l237.964">   // If we got here, that means that we weren't blocked by a dialog</span>
<a href="#l237.965"></a><span id="l237.965">   // being opened, which is what we wanted..</span>
<a href="#l237.966"></a><span id="l237.966">   assert_selected_tab(apTab);</span>
<a href="#l237.967"></a><span id="l237.967">   mc.tabmail.closeTab(apTab);</span>
<a href="#l237.968"></a><span id="l237.968" class="difflineminus">-}</span>
<a href="#l237.969"></a><span id="l237.969" class="difflineplus">+});</span>
<a href="#l237.970"></a><span id="l237.970"> </span>
<a href="#l237.971"></a><span id="l237.971"> /**</span>
<a href="#l237.972"></a><span id="l237.972">  * Test that some prices can be per-address, instead of per-provider.</span>
<a href="#l237.973"></a><span id="l237.973">  */</span>
<a href="#l237.974"></a><span id="l237.974" class="difflineminus">-function test_per_address_prices() {</span>
<a href="#l237.975"></a><span id="l237.975" class="difflineplus">+add_task(function test_per_address_prices() {</span>
<a href="#l237.976"></a><span id="l237.976">   plan_for_modal_dialog(&quot;AccountCreation&quot;, subtest_per_address_prices);</span>
<a href="#l237.977"></a><span id="l237.977">   open_provisioner_window();</span>
<a href="#l237.978"></a><span id="l237.978">   wait_for_modal_dialog(&quot;AccountCreation&quot;);</span>
<a href="#l237.979"></a><span id="l237.979" class="difflineminus">-}</span>
<a href="#l237.980"></a><span id="l237.980" class="difflineplus">+});</span>
<a href="#l237.981"></a><span id="l237.981"> </span>
<a href="#l237.982"></a><span id="l237.982"> /**</span>
<a href="#l237.983"></a><span id="l237.983">  * Subtest used by test_html_characters_and_ampersands.  This function puts</span>
<a href="#l237.984"></a><span id="l237.984">  * a name with HTML tags into the search input, does a search, and ensures</span>
<a href="#l237.985"></a><span id="l237.985">  * that the rendered name has escaped the HTML tags properly.</span>
<a href="#l237.986"></a><span id="l237.986">  */</span>
<a href="#l237.987"></a><span id="l237.987"> function subtest_per_address_prices(w) {</span>
<a href="#l237.988"></a><span id="l237.988">   wait_for_provider_list_loaded(w);</span>
<a href="#l237.989"></a><span id="l237.989" class="difflineat">@@ -1439,17 +1432,17 @@ function subtest_per_address_prices(w) {</span>
<a href="#l237.990"></a><span id="l237.990">   let multi;</span>
<a href="#l237.991"></a><span id="l237.991">   for (let provider of providers) {</span>
<a href="#l237.992"></a><span id="l237.992">     if (provider.innerHTML == &quot;multi&quot;) {</span>
<a href="#l237.993"></a><span id="l237.993">       multi = provider;</span>
<a href="#l237.994"></a><span id="l237.994">       price = provider.parentNode.querySelector(&quot;.price&quot;);</span>
<a href="#l237.995"></a><span id="l237.995">       break;</span>
<a href="#l237.996"></a><span id="l237.996">     }</span>
<a href="#l237.997"></a><span id="l237.997">   }</span>
<a href="#l237.998"></a><span id="l237.998" class="difflineminus">-  assert_equals(price.innerHTML, prices[0].slice(0, 6));</span>
<a href="#l237.999"></a><span id="l237.999" class="difflineplus">+  Assert.equal(price.innerHTML, prices[0].slice(0, 6));</span>
<a href="#l237.1000"></a><span id="l237.1000"> </span>
<a href="#l237.1001"></a><span id="l237.1001">   // Click on the multi provider. This reveals the buttons with the prices.</span>
<a href="#l237.1002"></a><span id="l237.1002">   mc.click(new elib.Elem(multi));</span>
<a href="#l237.1003"></a><span id="l237.1003">   mc.waitFor(</span>
<a href="#l237.1004"></a><span id="l237.1004">     () =&gt;</span>
<a href="#l237.1005"></a><span id="l237.1005">       w.window.document.querySelectorAll('button.create:not([disabled=&quot;true&quot;])')</span>
<a href="#l237.1006"></a><span id="l237.1006">         .length &gt; 0</span>
<a href="#l237.1007"></a><span id="l237.1007">   );</span>
<a href="#l237.1008"></a><span id="l237.1008" class="difflineat">@@ -1459,12 +1452,12 @@ function subtest_per_address_prices(w) {</span>
<a href="#l237.1009"></a><span id="l237.1009">     'button.create:not([disabled=&quot;true&quot;])'</span>
<a href="#l237.1010"></a><span id="l237.1010">   );</span>
<a href="#l237.1011"></a><span id="l237.1011">   let index = 0;</span>
<a href="#l237.1012"></a><span id="l237.1012">   for (let button of buttons) {</span>
<a href="#l237.1013"></a><span id="l237.1013">     // Emulate jquery's :visible selector</span>
<a href="#l237.1014"></a><span id="l237.1014">     if (button.offsetWidth == 0 &amp;&amp; button.offsetHeight == 0) {</span>
<a href="#l237.1015"></a><span id="l237.1015">       continue;</span>
<a href="#l237.1016"></a><span id="l237.1016">     }</span>
<a href="#l237.1017"></a><span id="l237.1017" class="difflineminus">-    assert_equals(button.innerHTML, prices[index]);</span>
<a href="#l237.1018"></a><span id="l237.1018" class="difflineplus">+    Assert.equal(button.innerHTML, prices[index]);</span>
<a href="#l237.1019"></a><span id="l237.1019">     index++;</span>
<a href="#l237.1020"></a><span id="l237.1020">   }</span>
<a href="#l237.1021"></a><span id="l237.1021"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l238.1"></a><span id="l238.1">copy from mail/test/mozmill/newmailaccount/html/badSuggestFromName</span>
<a href="#l238.2"></a><span id="l238.2">copy to mail/test/browser/newmailaccount/html/badSuggestFromName</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l239.1"></a><span id="l239.1">copy from mail/test/mozmill/newmailaccount/html/config.xml</span>
<a href="#l239.2"></a><span id="l239.2">copy to mail/test/browser/newmailaccount/html/config.xml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l240.1"></a><span id="l240.1">copy from mail/test/mozmill/newmailaccount/html/configCorrupt.xml</span>
<a href="#l240.2"></a><span id="l240.2">copy to mail/test/browser/newmailaccount/html/configCorrupt.xml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l241.1"></a><span id="l241.1">copy from mail/test/mozmill/newmailaccount/html/configError.xml</span>
<a href="#l241.2"></a><span id="l241.2">copy to mail/test/browser/newmailaccount/html/configError.xml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l242.1"></a><span id="l242.1">copy from mail/test/mozmill/newmailaccount/html/emptySuggestFromName</span>
<a href="#l242.2"></a><span id="l242.2">copy to mail/test/browser/newmailaccount/html/emptySuggestFromName</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l243.1"></a><span id="l243.1">copy from mail/test/mozmill/newmailaccount/html/providerList</span>
<a href="#l243.2"></a><span id="l243.2">copy to mail/test/browser/newmailaccount/html/providerList</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l244.1"></a><span id="l244.1">copy from mail/test/mozmill/newmailaccount/html/providerListBad</span>
<a href="#l244.2"></a><span id="l244.2">copy to mail/test/browser/newmailaccount/html/providerListBad</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l245.1"></a><span id="l245.1">copy from mail/test/mozmill/newmailaccount/html/providerListIncomplete</span>
<a href="#l245.2"></a><span id="l245.2">copy to mail/test/browser/newmailaccount/html/providerListIncomplete</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l246.1"></a><span id="l246.1">copy from mail/test/mozmill/newmailaccount/html/providerListNoOtherLangs</span>
<a href="#l246.2"></a><span id="l246.2">copy to mail/test/browser/newmailaccount/html/providerListNoOtherLangs</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l247.1"></a><span id="l247.1">copy from mail/test/mozmill/newmailaccount/html/providerListWildcard</span>
<a href="#l247.2"></a><span id="l247.2">copy to mail/test/browser/newmailaccount/html/providerListWildcard</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l248.1"></a><span id="l248.1">copy from mail/test/mozmill/newmailaccount/html/registration.html</span>
<a href="#l248.2"></a><span id="l248.2">copy to mail/test/browser/newmailaccount/html/registration.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l249.1"></a><span id="l249.1">copy from mail/test/mozmill/newmailaccount/html/registrationCorrupt.html</span>
<a href="#l249.2"></a><span id="l249.2">copy to mail/test/browser/newmailaccount/html/registrationCorrupt.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l250.1"></a><span id="l250.1">copy from mail/test/mozmill/newmailaccount/html/registrationError.html</span>
<a href="#l250.2"></a><span id="l250.2">copy to mail/test/browser/newmailaccount/html/registrationError.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l251.1"></a><span id="l251.1">copy from mail/test/mozmill/newmailaccount/html/suggestFromName</span>
<a href="#l251.2"></a><span id="l251.2">copy to mail/test/browser/newmailaccount/html/suggestFromName</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l252.1"></a><span id="l252.1">copy from mail/test/mozmill/newmailaccount/html/target.html</span>
<a href="#l252.2"></a><span id="l252.2">copy to mail/test/browser/newmailaccount/html/target.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l253.1"></a><span id="l253.1">new file mode 100644</span>
<a href="#l253.2"></a><span id="l253.2" class="difflineminus">--- /dev/null</span>
<a href="#l253.3"></a><span id="l253.3" class="difflineplus">+++ b/mail/test/browser/notification/browser.ini</span>
<a href="#l253.4"></a><span id="l253.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l253.5"></a><span id="l253.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l253.6"></a><span id="l253.6" class="difflineplus">+prefs =</span>
<a href="#l253.7"></a><span id="l253.7" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l253.8"></a><span id="l253.8" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l253.9"></a><span id="l253.9" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l253.10"></a><span id="l253.10" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l253.11"></a><span id="l253.11" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l253.12"></a><span id="l253.12" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l253.13"></a><span id="l253.13" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l253.14"></a><span id="l253.14" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l253.15"></a><span id="l253.15" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l253.16"></a><span id="l253.16" class="difflineplus">+</span>
<a href="#l253.17"></a><span id="l253.17" class="difflineplus">+[browser_notification.js]</span>
<a href="#l253.18"></a><span id="l253.18" class="difflineplus">+skip-if = os == &quot;mac&quot; || os == &quot;win&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l254.1"></a><span id="l254.1">copy from mail/test/mozmill/notification/test-notification.js</span>
<a href="#l254.2"></a><span id="l254.2">copy to mail/test/browser/notification/browser_notification.js</span>
<a href="#l254.3"></a><span id="l254.3" class="difflineminus">--- a/mail/test/mozmill/notification/test-notification.js</span>
<a href="#l254.4"></a><span id="l254.4" class="difflineplus">+++ b/mail/test/browser/notification/browser_notification.js</span>
<a href="#l254.5"></a><span id="l254.5" class="difflineat">@@ -1,17 +1,15 @@</span>
<a href="#l254.6"></a><span id="l254.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l254.7"></a><span id="l254.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l254.8"></a><span id="l254.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l254.9"></a><span id="l254.9"> </span>
<a href="#l254.10"></a><span id="l254.10"> &quot;use strict&quot;;</span>
<a href="#l254.11"></a><span id="l254.11"> </span>
<a href="#l254.12"></a><span id="l254.12"> var {</span>
<a href="#l254.13"></a><span id="l254.13" class="difflineminus">-  assert_false,</span>
<a href="#l254.14"></a><span id="l254.14" class="difflineminus">-  assert_true,</span>
<a href="#l254.15"></a><span id="l254.15">   be_in_folder,</span>
<a href="#l254.16"></a><span id="l254.16">   create_folder,</span>
<a href="#l254.17"></a><span id="l254.17">   make_new_sets_in_folder,</span>
<a href="#l254.18"></a><span id="l254.18"> } = ChromeUtils.import(</span>
<a href="#l254.19"></a><span id="l254.19">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l254.20"></a><span id="l254.20"> );</span>
<a href="#l254.21"></a><span id="l254.21"> var {</span>
<a href="#l254.22"></a><span id="l254.22">   plan_for_new_window,</span>
<a href="#l254.23"></a><span id="l254.23" class="difflineat">@@ -53,16 +51,17 @@ var gMockAlertsService = {</span>
<a href="#l254.24"></a><span id="l254.24">     textClickable,</span>
<a href="#l254.25"></a><span id="l254.25">     cookie,</span>
<a href="#l254.26"></a><span id="l254.26">     alertListener,</span>
<a href="#l254.27"></a><span id="l254.27">     name</span>
<a href="#l254.28"></a><span id="l254.28">   ) {</span>
<a href="#l254.29"></a><span id="l254.29">     // Setting the _doFail flag allows us to revert to the newmailalert.xul</span>
<a href="#l254.30"></a><span id="l254.30">     // notification</span>
<a href="#l254.31"></a><span id="l254.31">     if (this._doFail) {</span>
<a href="#l254.32"></a><span id="l254.32" class="difflineplus">+      SimpleTest.expectUncaughtException(true);</span>
<a href="#l254.33"></a><span id="l254.33">       throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l254.34"></a><span id="l254.34">     }</span>
<a href="#l254.35"></a><span id="l254.35">     this._didNotify = true;</span>
<a href="#l254.36"></a><span id="l254.36">     this._imageUrl = imageUrl;</span>
<a href="#l254.37"></a><span id="l254.37">     this._title = title;</span>
<a href="#l254.38"></a><span id="l254.38">     this._text = text;</span>
<a href="#l254.39"></a><span id="l254.39">     this._textClickable = textClickable;</span>
<a href="#l254.40"></a><span id="l254.40">     this._cookie = cookie;</span>
<a href="#l254.41"></a><span id="l254.41" class="difflineat">@@ -107,17 +106,17 @@ var gMockAlertsServiceFactory = {</span>
<a href="#l254.42"></a><span id="l254.42">     if (!aIID.equals(Ci.nsIAlertsService)) {</span>
<a href="#l254.43"></a><span id="l254.43">       throw Cr.NS_ERROR_NO_INTERFACE;</span>
<a href="#l254.44"></a><span id="l254.44">     }</span>
<a href="#l254.45"></a><span id="l254.45"> </span>
<a href="#l254.46"></a><span id="l254.46">     return gMockAlertsService;</span>
<a href="#l254.47"></a><span id="l254.47">   },</span>
<a href="#l254.48"></a><span id="l254.48"> };</span>
<a href="#l254.49"></a><span id="l254.49"> </span>
<a href="#l254.50"></a><span id="l254.50" class="difflineminus">-function setupModule(module) {</span>
<a href="#l254.51"></a><span id="l254.51" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l254.52"></a><span id="l254.52">   // Register the mock alerts service</span>
<a href="#l254.53"></a><span id="l254.53">   Components.manager</span>
<a href="#l254.54"></a><span id="l254.54">     .QueryInterface(Ci.nsIComponentRegistrar)</span>
<a href="#l254.55"></a><span id="l254.55">     .registerFactory(</span>
<a href="#l254.56"></a><span id="l254.56">       Components.ID(&quot;{1bda6c33-b089-43df-a8fd-111907d6385a}&quot;),</span>
<a href="#l254.57"></a><span id="l254.57">       &quot;Mock Alerts Service&quot;,</span>
<a href="#l254.58"></a><span id="l254.58">       &quot;@mozilla.org/system-alerts-service;1&quot;,</span>
<a href="#l254.59"></a><span id="l254.59">       gMockAlertsServiceFactory</span>
<a href="#l254.60"></a><span id="l254.60" class="difflineat">@@ -153,24 +152,24 @@ function setupModule(module) {</span>
<a href="#l254.61"></a><span id="l254.61">   // Create the target folders</span>
<a href="#l254.62"></a><span id="l254.62">   gFolder = create_folder(&quot;My Folder&quot;);</span>
<a href="#l254.63"></a><span id="l254.63">   let localRoot = server.rootFolder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l254.64"></a><span id="l254.64">   gFolder2 = localRoot.createLocalSubfolder(&quot;Another Folder&quot;);</span>
<a href="#l254.65"></a><span id="l254.65"> </span>
<a href="#l254.66"></a><span id="l254.66">   var account = MailServices.accounts.createAccount();</span>
<a href="#l254.67"></a><span id="l254.67">   account.incomingServer = server;</span>
<a href="#l254.68"></a><span id="l254.68">   account.addIdentity(identity2);</span>
<a href="#l254.69"></a><span id="l254.69" class="difflineminus">-}</span>
<a href="#l254.70"></a><span id="l254.70" class="difflineplus">+});</span>
<a href="#l254.71"></a><span id="l254.71"> </span>
<a href="#l254.72"></a><span id="l254.72" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l254.73"></a><span id="l254.73" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l254.74"></a><span id="l254.74">   put_bool_prefs_back();</span>
<a href="#l254.75"></a><span id="l254.75">   if (Services.appinfo.OS != &quot;Darwin&quot;) {</span>
<a href="#l254.76"></a><span id="l254.76">     Services.prefs.setIntPref(&quot;alerts.totalOpenTime&quot;, gTotalOpenTime);</span>
<a href="#l254.77"></a><span id="l254.77">   }</span>
<a href="#l254.78"></a><span id="l254.78" class="difflineminus">-}</span>
<a href="#l254.79"></a><span id="l254.79" class="difflineplus">+});</span>
<a href="#l254.80"></a><span id="l254.80"> </span>
<a href="#l254.81"></a><span id="l254.81"> function setupTest(test) {</span>
<a href="#l254.82"></a><span id="l254.82">   gFolder.markAllMessagesRead(null);</span>
<a href="#l254.83"></a><span id="l254.83">   gMockAlertsService._reset();</span>
<a href="#l254.84"></a><span id="l254.84">   gMockAlertsService._doFail = false;</span>
<a href="#l254.85"></a><span id="l254.85">   gFolder.biffState = Ci.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l254.86"></a><span id="l254.86">   gFolder2.biffState = Ci.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l254.87"></a><span id="l254.87"> </span>
<a href="#l254.88"></a><span id="l254.88" class="difflineat">@@ -212,385 +211,364 @@ function make_gradually_newer_sets_in_fo</span>
<a href="#l254.89"></a><span id="l254.89">   }</span>
<a href="#l254.90"></a><span id="l254.90">   make_new_sets_in_folder(aFolder, aArgs);</span>
<a href="#l254.91"></a><span id="l254.91"> }</span>
<a href="#l254.92"></a><span id="l254.92"> </span>
<a href="#l254.93"></a><span id="l254.93"> /**</span>
<a href="#l254.94"></a><span id="l254.94">  * Test that we revert to newmailalert.xul if there is no system</span>
<a href="#l254.95"></a><span id="l254.95">  * notification service present.</span>
<a href="#l254.96"></a><span id="l254.96">  */</span>
<a href="#l254.97"></a><span id="l254.97" class="difflineminus">-function test_revert_to_newmailalert() {</span>
<a href="#l254.98"></a><span id="l254.98" class="difflineplus">+add_task(function test_revert_to_newmailalert() {</span>
<a href="#l254.99"></a><span id="l254.99" class="difflineplus">+  setupTest();</span>
<a href="#l254.100"></a><span id="l254.100">   // Set up the gMockAlertsService so that it fails</span>
<a href="#l254.101"></a><span id="l254.101">   // to send a notification.</span>
<a href="#l254.102"></a><span id="l254.102">   gMockAlertsService._doFail = true;</span>
<a href="#l254.103"></a><span id="l254.103"> </span>
<a href="#l254.104"></a><span id="l254.104">   // We expect the newmailalert.xul window...</span>
<a href="#l254.105"></a><span id="l254.105">   plan_for_new_window(&quot;alert:alert&quot;);</span>
<a href="#l254.106"></a><span id="l254.106">   make_gradually_newer_sets_in_folder(gFolder, [{ count: 2 }]);</span>
<a href="#l254.107"></a><span id="l254.107">   let controller = wait_for_new_window(&quot;alert:alert&quot;);</span>
<a href="#l254.108"></a><span id="l254.108">   plan_for_window_close(controller);</span>
<a href="#l254.109"></a><span id="l254.109">   wait_for_window_close();</span>
<a href="#l254.110"></a><span id="l254.110" class="difflineminus">-}</span>
<a href="#l254.111"></a><span id="l254.111" class="difflineminus">-test_revert_to_newmailalert.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l254.112"></a><span id="l254.112" class="difflineplus">+});</span>
<a href="#l254.113"></a><span id="l254.113"> </span>
<a href="#l254.114"></a><span id="l254.114"> /**</span>
<a href="#l254.115"></a><span id="l254.115">  * Test that receiving new mail causes a notification to appear</span>
<a href="#l254.116"></a><span id="l254.116">  */</span>
<a href="#l254.117"></a><span id="l254.117" class="difflineminus">-function test_new_mail_received_causes_notification() {</span>
<a href="#l254.118"></a><span id="l254.118" class="difflineplus">+add_task(function test_new_mail_received_causes_notification() {</span>
<a href="#l254.119"></a><span id="l254.119" class="difflineplus">+  setupTest();</span>
<a href="#l254.120"></a><span id="l254.120">   make_gradually_newer_sets_in_folder(gFolder, [{ count: 1 }]);</span>
<a href="#l254.121"></a><span id="l254.121" class="difflineminus">-  assert_true(</span>
<a href="#l254.122"></a><span id="l254.122" class="difflineminus">-    gMockAlertsService._didNotify,</span>
<a href="#l254.123"></a><span id="l254.123" class="difflineminus">-    &quot;Did not show alert notification.&quot;</span>
<a href="#l254.124"></a><span id="l254.124" class="difflineminus">-  );</span>
<a href="#l254.125"></a><span id="l254.125" class="difflineminus">-}</span>
<a href="#l254.126"></a><span id="l254.126" class="difflineminus">-test_new_mail_received_causes_notification.EXCLUDED_PLATFORMS = [</span>
<a href="#l254.127"></a><span id="l254.127" class="difflineminus">-  &quot;winnt&quot;,</span>
<a href="#l254.128"></a><span id="l254.128" class="difflineminus">-  &quot;darwin&quot;,</span>
<a href="#l254.129"></a><span id="l254.129" class="difflineminus">-];</span>
<a href="#l254.130"></a><span id="l254.130" class="difflineplus">+  Assert.ok(gMockAlertsService._didNotify, &quot;Did not show alert notification.&quot;);</span>
<a href="#l254.131"></a><span id="l254.131" class="difflineplus">+});</span>
<a href="#l254.132"></a><span id="l254.132"> </span>
<a href="#l254.133"></a><span id="l254.133"> /**</span>
<a href="#l254.134"></a><span id="l254.134">  * Test that if notification shows, we don't show newmailalert.xul</span>
<a href="#l254.135"></a><span id="l254.135">  */</span>
<a href="#l254.136"></a><span id="l254.136" class="difflineminus">-function test_dont_show_newmailalert() {</span>
<a href="#l254.137"></a><span id="l254.137" class="difflineplus">+add_task(function test_dont_show_newmailalert() {</span>
<a href="#l254.138"></a><span id="l254.138" class="difflineplus">+  setupTest();</span>
<a href="#l254.139"></a><span id="l254.139">   make_gradually_newer_sets_in_folder(gFolder, [{ count: 1 }]);</span>
<a href="#l254.140"></a><span id="l254.140"> </span>
<a href="#l254.141"></a><span id="l254.141">   // Wait for newmailalert.xul to show</span>
<a href="#l254.142"></a><span id="l254.142">   plan_for_new_window(&quot;alert:alert&quot;);</span>
<a href="#l254.143"></a><span id="l254.143">   try {</span>
<a href="#l254.144"></a><span id="l254.144">     wait_for_new_window(&quot;alert:alert&quot;);</span>
<a href="#l254.145"></a><span id="l254.145">     throw Error(&quot;Opened newmailalert.xul when we shouldn't have.&quot;);</span>
<a href="#l254.146"></a><span id="l254.146">   } catch (e) {</span>
<a href="#l254.147"></a><span id="l254.147">     // Correct behaviour - the window didn't show.</span>
<a href="#l254.148"></a><span id="l254.148">   }</span>
<a href="#l254.149"></a><span id="l254.149" class="difflineminus">-}</span>
<a href="#l254.150"></a><span id="l254.150" class="difflineminus">-test_new_mail_received_causes_notification.EXCLUDED_PLATFORMS = [</span>
<a href="#l254.151"></a><span id="l254.151" class="difflineminus">-  &quot;winnt&quot;,</span>
<a href="#l254.152"></a><span id="l254.152" class="difflineminus">-  &quot;darwin&quot;,</span>
<a href="#l254.153"></a><span id="l254.153" class="difflineminus">-];</span>
<a href="#l254.154"></a><span id="l254.154" class="difflineplus">+});</span>
<a href="#l254.155"></a><span id="l254.155"> </span>
<a href="#l254.156"></a><span id="l254.156"> /**</span>
<a href="#l254.157"></a><span id="l254.157">  * Test that we notify, showing the oldest new, unread message received</span>
<a href="#l254.158"></a><span id="l254.158">  * since the last notification.</span>
<a href="#l254.159"></a><span id="l254.159">  */</span>
<a href="#l254.160"></a><span id="l254.160" class="difflineminus">-function test_show_oldest_new_unread_since_last_notification() {</span>
<a href="#l254.161"></a><span id="l254.161" class="difflineplus">+add_task(function test_show_oldest_new_unread_since_last_notification() {</span>
<a href="#l254.162"></a><span id="l254.162" class="difflineplus">+  setupTest();</span>
<a href="#l254.163"></a><span id="l254.163">   let notifyFirst = &quot;This should notify first&quot;;</span>
<a href="#l254.164"></a><span id="l254.164" class="difflineminus">-  assert_false(gMockAlertsService._didNotify, &quot;Should not have notified yet.&quot;);</span>
<a href="#l254.165"></a><span id="l254.165" class="difflineplus">+  Assert.ok(!gMockAlertsService._didNotify, &quot;Should not have notified yet.&quot;);</span>
<a href="#l254.166"></a><span id="l254.166">   make_gradually_newer_sets_in_folder(gFolder, [</span>
<a href="#l254.167"></a><span id="l254.167">     { count: 1, body: { body: notifyFirst } },</span>
<a href="#l254.168"></a><span id="l254.168">   ]);</span>
<a href="#l254.169"></a><span id="l254.169" class="difflineminus">-  assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l254.170"></a><span id="l254.170" class="difflineminus">-  assert_true(</span>
<a href="#l254.171"></a><span id="l254.171" class="difflineplus">+  Assert.ok(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l254.172"></a><span id="l254.172" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.173"></a><span id="l254.173">     gMockAlertsService._text.includes(notifyFirst, 1),</span>
<a href="#l254.174"></a><span id="l254.174">     &quot;Should have notified for the first message&quot;</span>
<a href="#l254.175"></a><span id="l254.175">   );</span>
<a href="#l254.176"></a><span id="l254.176"> </span>
<a href="#l254.177"></a><span id="l254.177">   be_in_folder(gFolder);</span>
<a href="#l254.178"></a><span id="l254.178">   gFolder.biffState = Ci.nsIMsgFolder.nsMsgBiffState_NoMail;</span>
<a href="#l254.179"></a><span id="l254.179">   gMockAlertsService._reset();</span>
<a href="#l254.180"></a><span id="l254.180"> </span>
<a href="#l254.181"></a><span id="l254.181">   let notifySecond = &quot;This should notify second&quot;;</span>
<a href="#l254.182"></a><span id="l254.182" class="difflineminus">-  assert_false(gMockAlertsService._didNotify, &quot;Should not have notified yet.&quot;);</span>
<a href="#l254.183"></a><span id="l254.183" class="difflineplus">+  Assert.ok(!gMockAlertsService._didNotify, &quot;Should not have notified yet.&quot;);</span>
<a href="#l254.184"></a><span id="l254.184">   make_gradually_newer_sets_in_folder(gFolder, [</span>
<a href="#l254.185"></a><span id="l254.185">     { count: 1, body: { body: notifySecond } },</span>
<a href="#l254.186"></a><span id="l254.186">   ]);</span>
<a href="#l254.187"></a><span id="l254.187" class="difflineminus">-  assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l254.188"></a><span id="l254.188" class="difflineminus">-  assert_true(</span>
<a href="#l254.189"></a><span id="l254.189" class="difflineplus">+  Assert.ok(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l254.190"></a><span id="l254.190" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.191"></a><span id="l254.191">     gMockAlertsService._text.includes(notifySecond, 1),</span>
<a href="#l254.192"></a><span id="l254.192">     &quot;Should have notified for the second message&quot;</span>
<a href="#l254.193"></a><span id="l254.193">   );</span>
<a href="#l254.194"></a><span id="l254.194" class="difflineminus">-}</span>
<a href="#l254.195"></a><span id="l254.195" class="difflineminus">-test_show_oldest_new_unread_since_last_notification.EXCLUDED_PLATFORMS = [</span>
<a href="#l254.196"></a><span id="l254.196" class="difflineminus">-  &quot;winnt&quot;,</span>
<a href="#l254.197"></a><span id="l254.197" class="difflineminus">-  &quot;darwin&quot;,</span>
<a href="#l254.198"></a><span id="l254.198" class="difflineminus">-];</span>
<a href="#l254.199"></a><span id="l254.199" class="difflineplus">+});</span>
<a href="#l254.200"></a><span id="l254.200"> </span>
<a href="#l254.201"></a><span id="l254.201"> /**</span>
<a href="#l254.202"></a><span id="l254.202">  * Test that notifications work across different accounts.</span>
<a href="#l254.203"></a><span id="l254.203">  */</span>
<a href="#l254.204"></a><span id="l254.204" class="difflineminus">-function test_notification_works_across_accounts() {</span>
<a href="#l254.205"></a><span id="l254.205" class="difflineplus">+add_task(function test_notification_works_across_accounts() {</span>
<a href="#l254.206"></a><span id="l254.206" class="difflineplus">+  setupTest();</span>
<a href="#l254.207"></a><span id="l254.207">   // Cause a notification in the first folder</span>
<a href="#l254.208"></a><span id="l254.208">   make_gradually_newer_sets_in_folder(gFolder, [{ count: 1 }]);</span>
<a href="#l254.209"></a><span id="l254.209" class="difflineminus">-  assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l254.210"></a><span id="l254.210" class="difflineplus">+  Assert.ok(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l254.211"></a><span id="l254.211"> </span>
<a href="#l254.212"></a><span id="l254.212">   gMockAlertsService._reset();</span>
<a href="#l254.213"></a><span id="l254.213">   // We'll set the time for these messages to be slightly further</span>
<a href="#l254.214"></a><span id="l254.214">   // into the past.  That way, test_notification_independent_across_accounts</span>
<a href="#l254.215"></a><span id="l254.215">   // has an opportunity to send slightly newer messages that are older than</span>
<a href="#l254.216"></a><span id="l254.216">   // the messages sent to gFolder.</span>
<a href="#l254.217"></a><span id="l254.217">   make_gradually_newer_sets_in_folder(gFolder2, [</span>
<a href="#l254.218"></a><span id="l254.218">     { count: 2, age: { minutes: gMsgMinutes + 20 } },</span>
<a href="#l254.219"></a><span id="l254.219">   ]);</span>
<a href="#l254.220"></a><span id="l254.220" class="difflineminus">-  assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l254.221"></a><span id="l254.221" class="difflineminus">-}</span>
<a href="#l254.222"></a><span id="l254.222" class="difflineminus">-test_notification_works_across_accounts.EXCLUDED_PLATFORMS = [</span>
<a href="#l254.223"></a><span id="l254.223" class="difflineminus">-  &quot;winnt&quot;,</span>
<a href="#l254.224"></a><span id="l254.224" class="difflineminus">-  &quot;darwin&quot;,</span>
<a href="#l254.225"></a><span id="l254.225" class="difflineminus">-];</span>
<a href="#l254.226"></a><span id="l254.226" class="difflineplus">+  Assert.ok(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l254.227"></a><span id="l254.227" class="difflineplus">+});</span>
<a href="#l254.228"></a><span id="l254.228"> </span>
<a href="#l254.229"></a><span id="l254.229"> /* Test that notification timestamps are independent from account</span>
<a href="#l254.230"></a><span id="l254.230">  * to account.  This is for the scenario where we have two accounts, and</span>
<a href="#l254.231"></a><span id="l254.231">  * one has notified while the other is still updating.  When the second</span>
<a href="#l254.232"></a><span id="l254.232">  * account completes, if it has new mail, it should notify, even if second</span>
<a href="#l254.233"></a><span id="l254.233">  * account's newest mail is older than the first account's newest mail.</span>
<a href="#l254.234"></a><span id="l254.234">  */</span>
<a href="#l254.235"></a><span id="l254.235" class="difflineminus">-function test_notifications_independent_across_accounts() {</span>
<a href="#l254.236"></a><span id="l254.236" class="difflineplus">+add_task(function test_notifications_independent_across_accounts() {</span>
<a href="#l254.237"></a><span id="l254.237" class="difflineplus">+  setupTest();</span>
<a href="#l254.238"></a><span id="l254.238">   make_gradually_newer_sets_in_folder(gFolder, [{ count: 1 }]);</span>
<a href="#l254.239"></a><span id="l254.239" class="difflineminus">-  assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l254.240"></a><span id="l254.240" class="difflineplus">+  Assert.ok(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l254.241"></a><span id="l254.241"> </span>
<a href="#l254.242"></a><span id="l254.242">   gMockAlertsService._reset();</span>
<a href="#l254.243"></a><span id="l254.243">   // Next, let's make some mail arrive in the second folder, but</span>
<a href="#l254.244"></a><span id="l254.244">   // let's have that mail be slightly older than the mail that</span>
<a href="#l254.245"></a><span id="l254.245">   // landed in the first folder.  We should still notify.</span>
<a href="#l254.246"></a><span id="l254.246">   make_gradually_newer_sets_in_folder(gFolder2, [</span>
<a href="#l254.247"></a><span id="l254.247">     { count: 2, age: { minutes: gMsgMinutes + 10 } },</span>
<a href="#l254.248"></a><span id="l254.248">   ]);</span>
<a href="#l254.249"></a><span id="l254.249" class="difflineminus">-  assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l254.250"></a><span id="l254.250" class="difflineminus">-}</span>
<a href="#l254.251"></a><span id="l254.251" class="difflineminus">-test_notifications_independent_across_accounts.EXCLUDED_PLATFORMS = [</span>
<a href="#l254.252"></a><span id="l254.252" class="difflineminus">-  &quot;winnt&quot;,</span>
<a href="#l254.253"></a><span id="l254.253" class="difflineminus">-  &quot;darwin&quot;,</span>
<a href="#l254.254"></a><span id="l254.254" class="difflineminus">-];</span>
<a href="#l254.255"></a><span id="l254.255" class="difflineplus">+  Assert.ok(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l254.256"></a><span id="l254.256" class="difflineplus">+});</span>
<a href="#l254.257"></a><span id="l254.257"> </span>
<a href="#l254.258"></a><span id="l254.258"> /**</span>
<a href="#l254.259"></a><span id="l254.259">  * Test that we can show the message subject in the notification.</span>
<a href="#l254.260"></a><span id="l254.260">  */</span>
<a href="#l254.261"></a><span id="l254.261" class="difflineminus">-function test_show_subject() {</span>
<a href="#l254.262"></a><span id="l254.262" class="difflineplus">+add_task(function test_show_subject() {</span>
<a href="#l254.263"></a><span id="l254.263" class="difflineplus">+  setupTest();</span>
<a href="#l254.264"></a><span id="l254.264">   let subject = &quot;This should be displayed&quot;;</span>
<a href="#l254.265"></a><span id="l254.265">   make_gradually_newer_sets_in_folder(gFolder, [{ count: 1, subject }]);</span>
<a href="#l254.266"></a><span id="l254.266" class="difflineminus">-  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.267"></a><span id="l254.267" class="difflineminus">-  assert_true(</span>
<a href="#l254.268"></a><span id="l254.268" class="difflineplus">+  Assert.ok(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.269"></a><span id="l254.269" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.270"></a><span id="l254.270">     gMockAlertsService._text.includes(subject),</span>
<a href="#l254.271"></a><span id="l254.271">     &quot;Should have displayed the subject&quot;</span>
<a href="#l254.272"></a><span id="l254.272">   );</span>
<a href="#l254.273"></a><span id="l254.273" class="difflineminus">-}</span>
<a href="#l254.274"></a><span id="l254.274" class="difflineminus">-test_show_subject.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l254.275"></a><span id="l254.275" class="difflineplus">+});</span>
<a href="#l254.276"></a><span id="l254.276"> </span>
<a href="#l254.277"></a><span id="l254.277"> /**</span>
<a href="#l254.278"></a><span id="l254.278">  * Test that we can hide the message subject in the notification.</span>
<a href="#l254.279"></a><span id="l254.279">  */</span>
<a href="#l254.280"></a><span id="l254.280" class="difflineminus">-function test_hide_subject() {</span>
<a href="#l254.281"></a><span id="l254.281" class="difflineplus">+add_task(function test_hide_subject() {</span>
<a href="#l254.282"></a><span id="l254.282" class="difflineplus">+  setupTest();</span>
<a href="#l254.283"></a><span id="l254.283">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_subject&quot;, false);</span>
<a href="#l254.284"></a><span id="l254.284">   let subject = &quot;This should not be displayed&quot;;</span>
<a href="#l254.285"></a><span id="l254.285">   make_gradually_newer_sets_in_folder(gFolder, [{ count: 1, subject }]);</span>
<a href="#l254.286"></a><span id="l254.286" class="difflineminus">-  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.287"></a><span id="l254.287" class="difflineminus">-  assert_true(</span>
<a href="#l254.288"></a><span id="l254.288" class="difflineplus">+  Assert.ok(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.289"></a><span id="l254.289" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.290"></a><span id="l254.290">     !gMockAlertsService._text.includes(subject),</span>
<a href="#l254.291"></a><span id="l254.291">     &quot;Should not have displayed the subject&quot;</span>
<a href="#l254.292"></a><span id="l254.292">   );</span>
<a href="#l254.293"></a><span id="l254.293" class="difflineminus">-}</span>
<a href="#l254.294"></a><span id="l254.294" class="difflineminus">-test_hide_subject.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l254.295"></a><span id="l254.295" class="difflineplus">+});</span>
<a href="#l254.296"></a><span id="l254.296"> </span>
<a href="#l254.297"></a><span id="l254.297"> /**</span>
<a href="#l254.298"></a><span id="l254.298">  * Test that we can show just the message sender in the notification.</span>
<a href="#l254.299"></a><span id="l254.299">  */</span>
<a href="#l254.300"></a><span id="l254.300" class="difflineminus">-function test_show_only_subject() {</span>
<a href="#l254.301"></a><span id="l254.301" class="difflineplus">+add_task(function test_show_only_subject() {</span>
<a href="#l254.302"></a><span id="l254.302" class="difflineplus">+  setupTest();</span>
<a href="#l254.303"></a><span id="l254.303">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, false);</span>
<a href="#l254.304"></a><span id="l254.304">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_sender&quot;, false);</span>
<a href="#l254.305"></a><span id="l254.305">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_subject&quot;, true);</span>
<a href="#l254.306"></a><span id="l254.306"> </span>
<a href="#l254.307"></a><span id="l254.307">   let sender = [&quot;John Cleese&quot;, &quot;john@cleese.invalid&quot;];</span>
<a href="#l254.308"></a><span id="l254.308">   let subject = &quot;This should not be displayed&quot;;</span>
<a href="#l254.309"></a><span id="l254.309">   let messageBody = &quot;My message preview&quot;;</span>
<a href="#l254.310"></a><span id="l254.310"> </span>
<a href="#l254.311"></a><span id="l254.311">   make_gradually_newer_sets_in_folder(gFolder, [</span>
<a href="#l254.312"></a><span id="l254.312">     { count: 1, from: sender, subject, body: { body: messageBody } },</span>
<a href="#l254.313"></a><span id="l254.313">   ]);</span>
<a href="#l254.314"></a><span id="l254.314" class="difflineminus">-  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.315"></a><span id="l254.315" class="difflineminus">-  assert_true(</span>
<a href="#l254.316"></a><span id="l254.316" class="difflineplus">+  Assert.ok(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.317"></a><span id="l254.317" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.318"></a><span id="l254.318">     gMockAlertsService._text.includes(subject),</span>
<a href="#l254.319"></a><span id="l254.319">     &quot;Should have displayed the subject&quot;</span>
<a href="#l254.320"></a><span id="l254.320">   );</span>
<a href="#l254.321"></a><span id="l254.321" class="difflineminus">-  assert_true(</span>
<a href="#l254.322"></a><span id="l254.322" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.323"></a><span id="l254.323">     !gMockAlertsService._text.includes(messageBody),</span>
<a href="#l254.324"></a><span id="l254.324">     &quot;Should not have displayed the preview&quot;</span>
<a href="#l254.325"></a><span id="l254.325">   );</span>
<a href="#l254.326"></a><span id="l254.326" class="difflineminus">-  assert_true(</span>
<a href="#l254.327"></a><span id="l254.327" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.328"></a><span id="l254.328">     !gMockAlertsService._text.includes(sender[0]),</span>
<a href="#l254.329"></a><span id="l254.329">     &quot;Should not have displayed the sender&quot;</span>
<a href="#l254.330"></a><span id="l254.330">   );</span>
<a href="#l254.331"></a><span id="l254.331" class="difflineminus">-}</span>
<a href="#l254.332"></a><span id="l254.332" class="difflineminus">-test_show_only_subject.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l254.333"></a><span id="l254.333" class="difflineplus">+});</span>
<a href="#l254.334"></a><span id="l254.334"> </span>
<a href="#l254.335"></a><span id="l254.335"> /**</span>
<a href="#l254.336"></a><span id="l254.336">  * Test that we can show the message sender in the notification.</span>
<a href="#l254.337"></a><span id="l254.337">  */</span>
<a href="#l254.338"></a><span id="l254.338" class="difflineminus">-function test_show_sender() {</span>
<a href="#l254.339"></a><span id="l254.339" class="difflineplus">+add_task(function test_show_sender() {</span>
<a href="#l254.340"></a><span id="l254.340" class="difflineplus">+  setupTest();</span>
<a href="#l254.341"></a><span id="l254.341">   let sender = [&quot;John Cleese&quot;, &quot;john@cleese.invalid&quot;];</span>
<a href="#l254.342"></a><span id="l254.342">   make_gradually_newer_sets_in_folder(gFolder, [{ count: 1, from: sender }]);</span>
<a href="#l254.343"></a><span id="l254.343" class="difflineminus">-  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.344"></a><span id="l254.344" class="difflineminus">-  assert_true(</span>
<a href="#l254.345"></a><span id="l254.345" class="difflineplus">+  Assert.ok(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.346"></a><span id="l254.346" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.347"></a><span id="l254.347">     gMockAlertsService._text.includes(sender[0]),</span>
<a href="#l254.348"></a><span id="l254.348">     &quot;Should have displayed the sender&quot;</span>
<a href="#l254.349"></a><span id="l254.349">   );</span>
<a href="#l254.350"></a><span id="l254.350" class="difflineminus">-}</span>
<a href="#l254.351"></a><span id="l254.351" class="difflineminus">-test_show_sender.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l254.352"></a><span id="l254.352" class="difflineplus">+});</span>
<a href="#l254.353"></a><span id="l254.353"> </span>
<a href="#l254.354"></a><span id="l254.354"> /**</span>
<a href="#l254.355"></a><span id="l254.355">  * Test that we can hide the message sender in the notification.</span>
<a href="#l254.356"></a><span id="l254.356">  */</span>
<a href="#l254.357"></a><span id="l254.357" class="difflineminus">-function test_hide_sender() {</span>
<a href="#l254.358"></a><span id="l254.358" class="difflineplus">+add_task(function test_hide_sender() {</span>
<a href="#l254.359"></a><span id="l254.359" class="difflineplus">+  setupTest();</span>
<a href="#l254.360"></a><span id="l254.360">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_sender&quot;, false);</span>
<a href="#l254.361"></a><span id="l254.361">   let sender = [&quot;John Cleese&quot;, &quot;john@cleese.invalid&quot;];</span>
<a href="#l254.362"></a><span id="l254.362">   make_gradually_newer_sets_in_folder(gFolder, [{ count: 1, from: sender }]);</span>
<a href="#l254.363"></a><span id="l254.363" class="difflineminus">-  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.364"></a><span id="l254.364" class="difflineminus">-  assert_true(</span>
<a href="#l254.365"></a><span id="l254.365" class="difflineplus">+  Assert.ok(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.366"></a><span id="l254.366" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.367"></a><span id="l254.367">     !gMockAlertsService._text.includes(sender[0]),</span>
<a href="#l254.368"></a><span id="l254.368">     &quot;Should not have displayed the sender&quot;</span>
<a href="#l254.369"></a><span id="l254.369">   );</span>
<a href="#l254.370"></a><span id="l254.370" class="difflineminus">-}</span>
<a href="#l254.371"></a><span id="l254.371" class="difflineminus">-test_hide_sender.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l254.372"></a><span id="l254.372" class="difflineplus">+});</span>
<a href="#l254.373"></a><span id="l254.373"> </span>
<a href="#l254.374"></a><span id="l254.374"> /**</span>
<a href="#l254.375"></a><span id="l254.375">  * Test that we can show just the message sender in the notification.</span>
<a href="#l254.376"></a><span id="l254.376">  */</span>
<a href="#l254.377"></a><span id="l254.377" class="difflineminus">-function test_show_only_sender() {</span>
<a href="#l254.378"></a><span id="l254.378" class="difflineplus">+add_task(function test_show_only_sender() {</span>
<a href="#l254.379"></a><span id="l254.379" class="difflineplus">+  setupTest();</span>
<a href="#l254.380"></a><span id="l254.380">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, false);</span>
<a href="#l254.381"></a><span id="l254.381">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_sender&quot;, true);</span>
<a href="#l254.382"></a><span id="l254.382">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_subject&quot;, false);</span>
<a href="#l254.383"></a><span id="l254.383"> </span>
<a href="#l254.384"></a><span id="l254.384">   let sender = [&quot;John Cleese&quot;, &quot;john@cleese.invalid&quot;];</span>
<a href="#l254.385"></a><span id="l254.385">   let subject = &quot;This should not be displayed&quot;;</span>
<a href="#l254.386"></a><span id="l254.386">   let messageBody = &quot;My message preview&quot;;</span>
<a href="#l254.387"></a><span id="l254.387"> </span>
<a href="#l254.388"></a><span id="l254.388">   make_gradually_newer_sets_in_folder(gFolder, [</span>
<a href="#l254.389"></a><span id="l254.389">     { count: 1, from: sender, subject, body: { body: messageBody } },</span>
<a href="#l254.390"></a><span id="l254.390">   ]);</span>
<a href="#l254.391"></a><span id="l254.391" class="difflineminus">-  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.392"></a><span id="l254.392" class="difflineminus">-  assert_true(</span>
<a href="#l254.393"></a><span id="l254.393" class="difflineplus">+  Assert.ok(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.394"></a><span id="l254.394" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.395"></a><span id="l254.395">     gMockAlertsService._text.includes(sender[0]),</span>
<a href="#l254.396"></a><span id="l254.396">     &quot;Should have displayed the sender&quot;</span>
<a href="#l254.397"></a><span id="l254.397">   );</span>
<a href="#l254.398"></a><span id="l254.398" class="difflineminus">-  assert_true(</span>
<a href="#l254.399"></a><span id="l254.399" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.400"></a><span id="l254.400">     !gMockAlertsService._text.includes(messageBody),</span>
<a href="#l254.401"></a><span id="l254.401">     &quot;Should not have displayed the preview&quot;</span>
<a href="#l254.402"></a><span id="l254.402">   );</span>
<a href="#l254.403"></a><span id="l254.403" class="difflineminus">-  assert_true(</span>
<a href="#l254.404"></a><span id="l254.404" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.405"></a><span id="l254.405">     !gMockAlertsService._text.includes(subject),</span>
<a href="#l254.406"></a><span id="l254.406">     &quot;Should not have displayed the subject&quot;</span>
<a href="#l254.407"></a><span id="l254.407">   );</span>
<a href="#l254.408"></a><span id="l254.408" class="difflineminus">-}</span>
<a href="#l254.409"></a><span id="l254.409" class="difflineminus">-test_show_only_sender.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l254.410"></a><span id="l254.410" class="difflineplus">+});</span>
<a href="#l254.411"></a><span id="l254.411"> </span>
<a href="#l254.412"></a><span id="l254.412"> /**</span>
<a href="#l254.413"></a><span id="l254.413">  * Test that we can show the message preview in the notification.</span>
<a href="#l254.414"></a><span id="l254.414">  */</span>
<a href="#l254.415"></a><span id="l254.415" class="difflineminus">-function test_show_preview() {</span>
<a href="#l254.416"></a><span id="l254.416" class="difflineplus">+add_task(function test_show_preview() {</span>
<a href="#l254.417"></a><span id="l254.417" class="difflineplus">+  setupTest();</span>
<a href="#l254.418"></a><span id="l254.418">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, true);</span>
<a href="#l254.419"></a><span id="l254.419">   let messageBody = &quot;My message preview&quot;;</span>
<a href="#l254.420"></a><span id="l254.420">   make_gradually_newer_sets_in_folder(gFolder, [</span>
<a href="#l254.421"></a><span id="l254.421">     { count: 1, body: { body: messageBody } },</span>
<a href="#l254.422"></a><span id="l254.422">   ]);</span>
<a href="#l254.423"></a><span id="l254.423" class="difflineminus">-  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.424"></a><span id="l254.424" class="difflineminus">-  assert_true(</span>
<a href="#l254.425"></a><span id="l254.425" class="difflineplus">+  Assert.ok(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.426"></a><span id="l254.426" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.427"></a><span id="l254.427">     gMockAlertsService._text.includes(messageBody),</span>
<a href="#l254.428"></a><span id="l254.428">     &quot;Should have displayed the preview&quot;</span>
<a href="#l254.429"></a><span id="l254.429">   );</span>
<a href="#l254.430"></a><span id="l254.430" class="difflineminus">-}</span>
<a href="#l254.431"></a><span id="l254.431" class="difflineminus">-test_show_preview.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l254.432"></a><span id="l254.432" class="difflineplus">+});</span>
<a href="#l254.433"></a><span id="l254.433"> </span>
<a href="#l254.434"></a><span id="l254.434"> /**</span>
<a href="#l254.435"></a><span id="l254.435">  * Test that we can hide the message preview in the notification.</span>
<a href="#l254.436"></a><span id="l254.436">  */</span>
<a href="#l254.437"></a><span id="l254.437" class="difflineminus">-function test_hide_preview() {</span>
<a href="#l254.438"></a><span id="l254.438" class="difflineplus">+add_task(function test_hide_preview() {</span>
<a href="#l254.439"></a><span id="l254.439" class="difflineplus">+  setupTest();</span>
<a href="#l254.440"></a><span id="l254.440">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, false);</span>
<a href="#l254.441"></a><span id="l254.441">   let messageBody = &quot;My message preview&quot;;</span>
<a href="#l254.442"></a><span id="l254.442">   make_gradually_newer_sets_in_folder(gFolder, [</span>
<a href="#l254.443"></a><span id="l254.443">     { count: 1, body: { body: messageBody } },</span>
<a href="#l254.444"></a><span id="l254.444">   ]);</span>
<a href="#l254.445"></a><span id="l254.445" class="difflineminus">-  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.446"></a><span id="l254.446" class="difflineminus">-  assert_true(</span>
<a href="#l254.447"></a><span id="l254.447" class="difflineplus">+  Assert.ok(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.448"></a><span id="l254.448" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.449"></a><span id="l254.449">     !gMockAlertsService._text.includes(messageBody),</span>
<a href="#l254.450"></a><span id="l254.450">     &quot;Should not have displayed the preview&quot;</span>
<a href="#l254.451"></a><span id="l254.451">   );</span>
<a href="#l254.452"></a><span id="l254.452" class="difflineminus">-}</span>
<a href="#l254.453"></a><span id="l254.453" class="difflineminus">-test_hide_preview.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l254.454"></a><span id="l254.454" class="difflineplus">+});</span>
<a href="#l254.455"></a><span id="l254.455"> </span>
<a href="#l254.456"></a><span id="l254.456"> /**</span>
<a href="#l254.457"></a><span id="l254.457">  * Test that we can show justthe message preview in the notification.</span>
<a href="#l254.458"></a><span id="l254.458">  */</span>
<a href="#l254.459"></a><span id="l254.459" class="difflineminus">-function test_show_only_preview() {</span>
<a href="#l254.460"></a><span id="l254.460" class="difflineplus">+add_task(function test_show_only_preview() {</span>
<a href="#l254.461"></a><span id="l254.461" class="difflineplus">+  setupTest();</span>
<a href="#l254.462"></a><span id="l254.462">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_preview&quot;, true);</span>
<a href="#l254.463"></a><span id="l254.463">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_sender&quot;, false);</span>
<a href="#l254.464"></a><span id="l254.464">   Services.prefs.setBoolPref(&quot;mail.biff.alert.show_subject&quot;, false);</span>
<a href="#l254.465"></a><span id="l254.465"> </span>
<a href="#l254.466"></a><span id="l254.466">   let sender = [&quot;John Cleese&quot;, &quot;john@cleese.invalid&quot;];</span>
<a href="#l254.467"></a><span id="l254.467">   let subject = &quot;This should not be displayed&quot;;</span>
<a href="#l254.468"></a><span id="l254.468">   let messageBody = &quot;My message preview&quot;;</span>
<a href="#l254.469"></a><span id="l254.469">   make_gradually_newer_sets_in_folder(gFolder, [</span>
<a href="#l254.470"></a><span id="l254.470">     { count: 1, from: sender, subject, body: { body: messageBody } },</span>
<a href="#l254.471"></a><span id="l254.471">   ]);</span>
<a href="#l254.472"></a><span id="l254.472" class="difflineminus">-  assert_true(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.473"></a><span id="l254.473" class="difflineminus">-  assert_true(</span>
<a href="#l254.474"></a><span id="l254.474" class="difflineplus">+  Assert.ok(gMockAlertsService._didNotify, &quot;Should have notified&quot;);</span>
<a href="#l254.475"></a><span id="l254.475" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.476"></a><span id="l254.476">     gMockAlertsService._text.includes(messageBody),</span>
<a href="#l254.477"></a><span id="l254.477">     &quot;Should have displayed the preview: &quot; + gMockAlertsService._text</span>
<a href="#l254.478"></a><span id="l254.478">   );</span>
<a href="#l254.479"></a><span id="l254.479" class="difflineminus">-  assert_true(</span>
<a href="#l254.480"></a><span id="l254.480" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.481"></a><span id="l254.481">     !gMockAlertsService._text.includes(sender[0]),</span>
<a href="#l254.482"></a><span id="l254.482">     &quot;Should not have displayed the sender&quot;</span>
<a href="#l254.483"></a><span id="l254.483">   );</span>
<a href="#l254.484"></a><span id="l254.484" class="difflineminus">-  assert_true(</span>
<a href="#l254.485"></a><span id="l254.485" class="difflineplus">+  Assert.ok(</span>
<a href="#l254.486"></a><span id="l254.486">     !gMockAlertsService._text.includes(subject),</span>
<a href="#l254.487"></a><span id="l254.487">     &quot;Should not have displayed the subject&quot;</span>
<a href="#l254.488"></a><span id="l254.488">   );</span>
<a href="#l254.489"></a><span id="l254.489" class="difflineminus">-}</span>
<a href="#l254.490"></a><span id="l254.490" class="difflineminus">-test_show_only_preview.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l254.491"></a><span id="l254.491" class="difflineplus">+});</span>
<a href="#l254.492"></a><span id="l254.492"> </span>
<a href="#l254.493"></a><span id="l254.493"> /**</span>
<a href="#l254.494"></a><span id="l254.494">  * Test that we can receive notifications even when the biff state of</span>
<a href="#l254.495"></a><span id="l254.495">  * the folder has not been changed.</span>
<a href="#l254.496"></a><span id="l254.496">  */</span>
<a href="#l254.497"></a><span id="l254.497" class="difflineminus">-function test_still_notify_with_unchanged_biff() {</span>
<a href="#l254.498"></a><span id="l254.498" class="difflineplus">+add_task(function test_still_notify_with_unchanged_biff() {</span>
<a href="#l254.499"></a><span id="l254.499" class="difflineplus">+  setupTest();</span>
<a href="#l254.500"></a><span id="l254.500">   // For now, we'll make sure that if we receive 10 pieces</span>
<a href="#l254.501"></a><span id="l254.501">   // of email, one after the other, we'll be notified for all</span>
<a href="#l254.502"></a><span id="l254.502">   // (assuming of course that the notifications have a chance</span>
<a href="#l254.503"></a><span id="l254.503">   // to close in between arrivals - we don't want a queue of</span>
<a href="#l254.504"></a><span id="l254.504">   // notifications to go through).</span>
<a href="#l254.505"></a><span id="l254.505">   const HOW_MUCH_MAIL = 10;</span>
<a href="#l254.506"></a><span id="l254.506"> </span>
<a href="#l254.507"></a><span id="l254.507" class="difflineminus">-  assert_false(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l254.508"></a><span id="l254.508" class="difflineplus">+  Assert.ok(!gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l254.509"></a><span id="l254.509"> </span>
<a href="#l254.510"></a><span id="l254.510">   for (let i = 0; i &lt; HOW_MUCH_MAIL; i++) {</span>
<a href="#l254.511"></a><span id="l254.511">     make_gradually_newer_sets_in_folder(gFolder, [{ count: 1 }]);</span>
<a href="#l254.512"></a><span id="l254.512" class="difflineminus">-    assert_true(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l254.513"></a><span id="l254.513" class="difflineplus">+    Assert.ok(gMockAlertsService._didNotify, &quot;Should have notified.&quot;);</span>
<a href="#l254.514"></a><span id="l254.514">     gMockAlertsService._reset();</span>
<a href="#l254.515"></a><span id="l254.515">   }</span>
<a href="#l254.516"></a><span id="l254.516" class="difflineminus">-}</span>
<a href="#l254.517"></a><span id="l254.517" class="difflineminus">-test_still_notify_with_unchanged_biff.EXCLUDED_PLATFORMS = [&quot;winnt&quot;, &quot;darwin&quot;];</span>
<a href="#l254.518"></a><span id="l254.518" class="difflineplus">+});</span>
<a href="#l254.519"></a><span id="l254.519"> </span>
<a href="#l254.520"></a><span id="l254.520"> /**</span>
<a href="#l254.521"></a><span id="l254.521">  * Test that we don't receive notifications for Draft, Queue, SentMail,</span>
<a href="#l254.522"></a><span id="l254.522">  * Templates or Junk folders.</span>
<a href="#l254.523"></a><span id="l254.523">  */</span>
<a href="#l254.524"></a><span id="l254.524" class="difflineminus">-function test_no_notification_for_uninteresting_folders() {</span>
<a href="#l254.525"></a><span id="l254.525" class="difflineplus">+add_task(function test_no_notification_for_uninteresting_folders() {</span>
<a href="#l254.526"></a><span id="l254.526" class="difflineplus">+  setupTest();</span>
<a href="#l254.527"></a><span id="l254.527">   var someFolder = create_folder(&quot;Uninteresting Folder&quot;);</span>
<a href="#l254.528"></a><span id="l254.528">   var uninterestingFlags = [</span>
<a href="#l254.529"></a><span id="l254.529">     Ci.nsMsgFolderFlags.Drafts,</span>
<a href="#l254.530"></a><span id="l254.530">     Ci.nsMsgFolderFlags.Queue,</span>
<a href="#l254.531"></a><span id="l254.531">     Ci.nsMsgFolderFlags.SentMail,</span>
<a href="#l254.532"></a><span id="l254.532">     Ci.nsMsgFolderFlags.Templates,</span>
<a href="#l254.533"></a><span id="l254.533">     Ci.nsMsgFolderFlags.Junk,</span>
<a href="#l254.534"></a><span id="l254.534">     Ci.nsMsgFolderFlags.Archive,</span>
<a href="#l254.535"></a><span id="l254.535">   ];</span>
<a href="#l254.536"></a><span id="l254.536"> </span>
<a href="#l254.537"></a><span id="l254.537">   for (let i = 0; i &lt; uninterestingFlags.length; i++) {</span>
<a href="#l254.538"></a><span id="l254.538">     someFolder.flags = uninterestingFlags[i];</span>
<a href="#l254.539"></a><span id="l254.539">     make_gradually_newer_sets_in_folder(someFolder, [{ count: 1 }]);</span>
<a href="#l254.540"></a><span id="l254.540" class="difflineminus">-    assert_false(gMockAlertsService._didNotify, &quot;Showed alert notification.&quot;);</span>
<a href="#l254.541"></a><span id="l254.541" class="difflineplus">+    Assert.ok(!gMockAlertsService._didNotify, &quot;Showed alert notification.&quot;);</span>
<a href="#l254.542"></a><span id="l254.542">   }</span>
<a href="#l254.543"></a><span id="l254.543"> </span>
<a href="#l254.544"></a><span id="l254.544">   // However, we want to ensure that Inboxes *always* notify, even</span>
<a href="#l254.545"></a><span id="l254.545">   // if they possess the flags we consider uninteresting.</span>
<a href="#l254.546"></a><span id="l254.546">   someFolder.flags = Ci.nsMsgFolderFlags.Inbox;</span>
<a href="#l254.547"></a><span id="l254.547"> </span>
<a href="#l254.548"></a><span id="l254.548">   for (let i = 0; i &lt; uninterestingFlags.length; i++) {</span>
<a href="#l254.549"></a><span id="l254.549">     someFolder.flags |= uninterestingFlags[i];</span>
<a href="#l254.550"></a><span id="l254.550">     make_gradually_newer_sets_in_folder(someFolder, [{ count: 1 }]);</span>
<a href="#l254.551"></a><span id="l254.551" class="difflineminus">-    assert_true(</span>
<a href="#l254.552"></a><span id="l254.552" class="difflineplus">+    Assert.ok(</span>
<a href="#l254.553"></a><span id="l254.553">       gMockAlertsService._didNotify,</span>
<a href="#l254.554"></a><span id="l254.554">       &quot;Did not show alert notification.&quot;</span>
<a href="#l254.555"></a><span id="l254.555">     );</span>
<a href="#l254.556"></a><span id="l254.556">     someFolder.flags = someFolder.flags &amp; ~uninterestingFlags[i];</span>
<a href="#l254.557"></a><span id="l254.557">   }</span>
<a href="#l254.558"></a><span id="l254.558" class="difflineminus">-}</span>
<a href="#l254.559"></a><span id="l254.559" class="difflineminus">-test_no_notification_for_uninteresting_folders.EXCLUDED_PLATFORMS = [</span>
<a href="#l254.560"></a><span id="l254.560" class="difflineminus">-  &quot;winnt&quot;,</span>
<a href="#l254.561"></a><span id="l254.561" class="difflineminus">-  &quot;darwin&quot;,</span>
<a href="#l254.562"></a><span id="l254.562" class="difflineminus">-];</span>
<a href="#l254.563"></a><span id="l254.563" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l255.1"></a><span id="l255.1">new file mode 100644</span>
<a href="#l255.2"></a><span id="l255.2" class="difflineminus">--- /dev/null</span>
<a href="#l255.3"></a><span id="l255.3" class="difflineplus">+++ b/mail/test/browser/override-main-menu-collapse/browser.ini</span>
<a href="#l255.4"></a><span id="l255.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l255.5"></a><span id="l255.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l255.6"></a><span id="l255.6" class="difflineplus">+prefs =</span>
<a href="#l255.7"></a><span id="l255.7" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l255.8"></a><span id="l255.8" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l255.9"></a><span id="l255.9" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l255.10"></a><span id="l255.10" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l255.11"></a><span id="l255.11" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l255.12"></a><span id="l255.12" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l255.13"></a><span id="l255.13" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l255.14"></a><span id="l255.14" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l255.15"></a><span id="l255.15" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l255.16"></a><span id="l255.16" class="difflineplus">+</span>
<a href="#l255.17"></a><span id="l255.17" class="difflineplus">+[browser_overrideMainmenuCollapse.js]</span>
<a href="#l255.18"></a><span id="l255.18" class="difflineplus">+skip-if = true</span>
<a href="#l255.19"></a><span id="l255.19" class="difflineplus">+# skip-if = os == &quot;mac&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l256.1"></a><span id="l256.1">copy from mail/test/mozmill/override-main-menu-collapse/test-override-mainmenu-collapse.js</span>
<a href="#l256.2"></a><span id="l256.2">copy to mail/test/browser/override-main-menu-collapse/browser_overrideMainmenuCollapse.js</span>
<a href="#l256.3"></a><span id="l256.3" class="difflineminus">--- a/mail/test/mozmill/override-main-menu-collapse/test-override-mainmenu-collapse.js</span>
<a href="#l256.4"></a><span id="l256.4" class="difflineplus">+++ b/mail/test/browser/override-main-menu-collapse/browser_overrideMainmenuCollapse.js</span>
<a href="#l256.5"></a><span id="l256.5" class="difflineat">@@ -5,26 +5,26 @@</span>
<a href="#l256.6"></a><span id="l256.6"> /**</span>
<a href="#l256.7"></a><span id="l256.7">  * Tests that the main menu will NOT be collapsed by default if Thunderbird</span>
<a href="#l256.8"></a><span id="l256.8">  * starts with no accounts created, and mail.main_menu.collapse_by_default set</span>
<a href="#l256.9"></a><span id="l256.9">  * to false.</span>
<a href="#l256.10"></a><span id="l256.10">  */</span>
<a href="#l256.11"></a><span id="l256.11"> </span>
<a href="#l256.12"></a><span id="l256.12"> &quot;use strict&quot;;</span>
<a href="#l256.13"></a><span id="l256.13"> </span>
<a href="#l256.14"></a><span id="l256.14" class="difflineminus">-var { assert_false, mc } = ChromeUtils.import(</span>
<a href="#l256.15"></a><span id="l256.15" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l256.16"></a><span id="l256.16">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l256.17"></a><span id="l256.17"> );</span>
<a href="#l256.18"></a><span id="l256.18"> var { close_window, wait_for_existing_window } = ChromeUtils.import(</span>
<a href="#l256.19"></a><span id="l256.19">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l256.20"></a><span id="l256.20"> );</span>
<a href="#l256.21"></a><span id="l256.21"> </span>
<a href="#l256.22"></a><span id="l256.22"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l256.23"></a><span id="l256.23"> </span>
<a href="#l256.24"></a><span id="l256.24" class="difflineminus">-function test_main_menu_not_collapsed() {</span>
<a href="#l256.25"></a><span id="l256.25" class="difflineplus">+add_task(function test_main_menu_not_collapsed() {</span>
<a href="#l256.26"></a><span id="l256.26">   // Due to random oranges on slower machines, we need to ensure that startup</span>
<a href="#l256.27"></a><span id="l256.27">   // is complete before running this test.</span>
<a href="#l256.28"></a><span id="l256.28">   let done = false;</span>
<a href="#l256.29"></a><span id="l256.29">   let observer = {</span>
<a href="#l256.30"></a><span id="l256.30">     observe(aSubject, aTopic, aData) {</span>
<a href="#l256.31"></a><span id="l256.31">       if (aTopic == &quot;mail-startup-done&quot;) {</span>
<a href="#l256.32"></a><span id="l256.32">         done = true;</span>
<a href="#l256.33"></a><span id="l256.33">       }</span>
<a href="#l256.34"></a><span id="l256.34" class="difflineat">@@ -37,16 +37,15 @@ function test_main_menu_not_collapsed() </span>
<a href="#l256.35"></a><span id="l256.35">   // cause mail-startup-done to eventually be fired.</span>
<a href="#l256.36"></a><span id="l256.36">   let wizard = wait_for_existing_window(&quot;mail:autoconfig&quot;);</span>
<a href="#l256.37"></a><span id="l256.37">   close_window(wizard);</span>
<a href="#l256.38"></a><span id="l256.38"> </span>
<a href="#l256.39"></a><span id="l256.39">   // Spin the event loop until mail-startup-done is fired.</span>
<a href="#l256.40"></a><span id="l256.40">   mc.waitFor(() =&gt; done);</span>
<a href="#l256.41"></a><span id="l256.41"> </span>
<a href="#l256.42"></a><span id="l256.42">   let mainMenu = mc.e(&quot;mail-toolbar-menubar2&quot;);</span>
<a href="#l256.43"></a><span id="l256.43" class="difflineminus">-  assert_false(</span>
<a href="#l256.44"></a><span id="l256.44" class="difflineminus">-    mainMenu.hasAttribute(&quot;autohide&quot;),</span>
<a href="#l256.45"></a><span id="l256.45" class="difflineplus">+  Assert.ok(</span>
<a href="#l256.46"></a><span id="l256.46" class="difflineplus">+    !mainMenu.hasAttribute(&quot;autohide&quot;),</span>
<a href="#l256.47"></a><span id="l256.47">     &quot;The main menu should not have the autohide attribute.&quot;</span>
<a href="#l256.48"></a><span id="l256.48">   );</span>
<a href="#l256.49"></a><span id="l256.49"> </span>
<a href="#l256.50"></a><span id="l256.50">   Services.obs.removeObserver(observer, &quot;mail-startup-done&quot;);</span>
<a href="#l256.51"></a><span id="l256.51" class="difflineminus">-}</span>
<a href="#l256.52"></a><span id="l256.52" class="difflineminus">-test_main_menu_not_collapsed.EXCLUDED_PLATFORMS = [&quot;Darwin&quot;];</span>
<a href="#l256.53"></a><span id="l256.53" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l257.1"></a><span id="l257.1">new file mode 100644</span>
<a href="#l257.2"></a><span id="l257.2" class="difflineminus">--- /dev/null</span>
<a href="#l257.3"></a><span id="l257.3" class="difflineplus">+++ b/mail/test/browser/pref-window/browser.ini</span>
<a href="#l257.4"></a><span id="l257.4" class="difflineat">@@ -0,0 +1,13 @@</span>
<a href="#l257.5"></a><span id="l257.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l257.6"></a><span id="l257.6" class="difflineplus">+prefs =</span>
<a href="#l257.7"></a><span id="l257.7" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l257.8"></a><span id="l257.8" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l257.9"></a><span id="l257.9" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l257.10"></a><span id="l257.10" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l257.11"></a><span id="l257.11" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l257.12"></a><span id="l257.12" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l257.13"></a><span id="l257.13" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l257.14"></a><span id="l257.14" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l257.15"></a><span id="l257.15" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l257.16"></a><span id="l257.16" class="difflineplus">+</span>
<a href="#l257.17"></a><span id="l257.17" class="difflineplus">+[browser_fontChooser.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l258.1"></a><span id="l258.1">copy from mail/test/mozmill/pref-window/test-font-chooser.js</span>
<a href="#l258.2"></a><span id="l258.2">copy to mail/test/browser/pref-window/browser_fontChooser.js</span>
<a href="#l258.3"></a><span id="l258.3" class="difflineminus">--- a/mail/test/mozmill/pref-window/test-font-chooser.js</span>
<a href="#l258.4"></a><span id="l258.4" class="difflineplus">+++ b/mail/test/browser/pref-window/browser_fontChooser.js</span>
<a href="#l258.5"></a><span id="l258.5" class="difflineat">@@ -40,17 +40,58 @@ var gTodayPane;</span>
<a href="#l258.6"></a><span id="l258.6"> const kLanguage = &quot;x-western&quot;;</span>
<a href="#l258.7"></a><span id="l258.7"> </span>
<a href="#l258.8"></a><span id="l258.8"> // A list of fonts present on the computer for each font type.</span>
<a href="#l258.9"></a><span id="l258.9"> var gRealFontLists = {};</span>
<a href="#l258.10"></a><span id="l258.10"> </span>
<a href="#l258.11"></a><span id="l258.11"> // A list of font types to consider</span>
<a href="#l258.12"></a><span id="l258.12"> const kFontTypes = [&quot;serif&quot;, &quot;sans-serif&quot;, &quot;monospace&quot;];</span>
<a href="#l258.13"></a><span id="l258.13"> </span>
<a href="#l258.14"></a><span id="l258.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l258.15"></a><span id="l258.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l258.16"></a><span id="l258.16" class="difflineplus">+  if (AppConstants.platform == &quot;win&quot;) {</span>
<a href="#l258.17"></a><span id="l258.17" class="difflineplus">+    Services.prefs.setStringPref(</span>
<a href="#l258.18"></a><span id="l258.18" class="difflineplus">+      &quot;font.name-list.serif.x-western&quot;,</span>
<a href="#l258.19"></a><span id="l258.19" class="difflineplus">+      &quot;bc7e8c62-0634-467f-a029-fe6abcdf1582, Times New Roman&quot;</span>
<a href="#l258.20"></a><span id="l258.20" class="difflineplus">+    );</span>
<a href="#l258.21"></a><span id="l258.21" class="difflineplus">+    Services.prefs.setStringPref(</span>
<a href="#l258.22"></a><span id="l258.22" class="difflineplus">+      &quot;font.name-list.sans-serif.x-western&quot;,</span>
<a href="#l258.23"></a><span id="l258.23" class="difflineplus">+      &quot;419129aa-43b7-40c4-b554-83d99b504b89, Arial&quot;</span>
<a href="#l258.24"></a><span id="l258.24" class="difflineplus">+    );</span>
<a href="#l258.25"></a><span id="l258.25" class="difflineplus">+    Services.prefs.setStringPref(</span>
<a href="#l258.26"></a><span id="l258.26" class="difflineplus">+      &quot;font.name-list.monospace.x-western&quot;,</span>
<a href="#l258.27"></a><span id="l258.27" class="difflineplus">+      &quot;348df6e5-e874-4d21-ad4b-359b530a33b7, Courier New&quot;</span>
<a href="#l258.28"></a><span id="l258.28" class="difflineplus">+    );</span>
<a href="#l258.29"></a><span id="l258.29" class="difflineplus">+  } else if (AppConstants.platform == &quot;macosx&quot;) {</span>
<a href="#l258.30"></a><span id="l258.30" class="difflineplus">+    Services.prefs.setStringPref(</span>
<a href="#l258.31"></a><span id="l258.31" class="difflineplus">+      &quot;font.name-list.serif.x-western&quot;,</span>
<a href="#l258.32"></a><span id="l258.32" class="difflineplus">+      &quot;bc7e8c62-0634-467f-a029-fe6abcdf1582, Times&quot;</span>
<a href="#l258.33"></a><span id="l258.33" class="difflineplus">+    );</span>
<a href="#l258.34"></a><span id="l258.34" class="difflineplus">+    Services.prefs.setStringPref(</span>
<a href="#l258.35"></a><span id="l258.35" class="difflineplus">+      &quot;font.name-list.sans-serif.x-western&quot;,</span>
<a href="#l258.36"></a><span id="l258.36" class="difflineplus">+      &quot;419129aa-43b7-40c4-b554-83d99b504b89, Helvetica&quot;</span>
<a href="#l258.37"></a><span id="l258.37" class="difflineplus">+    );</span>
<a href="#l258.38"></a><span id="l258.38" class="difflineplus">+    Services.prefs.setStringPref(</span>
<a href="#l258.39"></a><span id="l258.39" class="difflineplus">+      &quot;font.name-list.monospace.x-western&quot;,</span>
<a href="#l258.40"></a><span id="l258.40" class="difflineplus">+      &quot;348df6e5-e874-4d21-ad4b-359b530a33b7, Courier&quot;</span>
<a href="#l258.41"></a><span id="l258.41" class="difflineplus">+    );</span>
<a href="#l258.42"></a><span id="l258.42" class="difflineplus">+  } else {</span>
<a href="#l258.43"></a><span id="l258.43" class="difflineplus">+    Services.prefs.setStringPref(</span>
<a href="#l258.44"></a><span id="l258.44" class="difflineplus">+      &quot;font.name-list.serif.x-western&quot;,</span>
<a href="#l258.45"></a><span id="l258.45" class="difflineplus">+      &quot;bc7e8c62-0634-467f-a029-fe6abcdf1582, serif&quot;</span>
<a href="#l258.46"></a><span id="l258.46" class="difflineplus">+    );</span>
<a href="#l258.47"></a><span id="l258.47" class="difflineplus">+    Services.prefs.setStringPref(</span>
<a href="#l258.48"></a><span id="l258.48" class="difflineplus">+      &quot;font.name-list.sans-serif.x-western&quot;,</span>
<a href="#l258.49"></a><span id="l258.49" class="difflineplus">+      &quot;419129aa-43b7-40c4-b554-83d99b504b89, sans-serif&quot;</span>
<a href="#l258.50"></a><span id="l258.50" class="difflineplus">+    );</span>
<a href="#l258.51"></a><span id="l258.51" class="difflineplus">+    Services.prefs.setStringPref(</span>
<a href="#l258.52"></a><span id="l258.52" class="difflineplus">+      &quot;font.name-list.monospace.x-western&quot;,</span>
<a href="#l258.53"></a><span id="l258.53" class="difflineplus">+      &quot;348df6e5-e874-4d21-ad4b-359b530a33b7, monospace&quot;</span>
<a href="#l258.54"></a><span id="l258.54" class="difflineplus">+    );</span>
<a href="#l258.55"></a><span id="l258.55" class="difflineplus">+  }</span>
<a href="#l258.56"></a><span id="l258.56" class="difflineplus">+</span>
<a href="#l258.57"></a><span id="l258.57">   let finished = false;</span>
<a href="#l258.58"></a><span id="l258.58">   buildFontList().then(() =&gt; (finished = true), Cu.reportError);</span>
<a href="#l258.59"></a><span id="l258.59">   mc.waitFor(</span>
<a href="#l258.60"></a><span id="l258.60">     () =&gt; finished,</span>
<a href="#l258.61"></a><span id="l258.61">     &quot;Timeout waiting for font enumeration to complete.&quot;</span>
<a href="#l258.62"></a><span id="l258.62">   );</span>
<a href="#l258.63"></a><span id="l258.63"> </span>
<a href="#l258.64"></a><span id="l258.64">   // Hide Lightning's Today pane as it obscures buttons in preferences in the</span>
<a href="#l258.65"></a><span id="l258.65" class="difflineat">@@ -58,17 +99,17 @@ function setupModule(module) {</span>
<a href="#l258.66"></a><span id="l258.66">   gTodayPane = mc.e(&quot;today-pane-panel&quot;);</span>
<a href="#l258.67"></a><span id="l258.67">   if (gTodayPane) {</span>
<a href="#l258.68"></a><span id="l258.68">     if (!gTodayPane.collapsed) {</span>
<a href="#l258.69"></a><span id="l258.69">       mc.keypress(null, &quot;VK_F11&quot;, {});</span>
<a href="#l258.70"></a><span id="l258.70">     } else {</span>
<a href="#l258.71"></a><span id="l258.71">       gTodayPane = null;</span>
<a href="#l258.72"></a><span id="l258.72">     }</span>
<a href="#l258.73"></a><span id="l258.73">   }</span>
<a href="#l258.74"></a><span id="l258.74" class="difflineminus">-}</span>
<a href="#l258.75"></a><span id="l258.75" class="difflineplus">+});</span>
<a href="#l258.76"></a><span id="l258.76"> </span>
<a href="#l258.77"></a><span id="l258.77"> async function buildFontList() {</span>
<a href="#l258.78"></a><span id="l258.78">   gFontEnumerator = Cc[&quot;@mozilla.org/gfx/fontenumerator;1&quot;].createInstance(</span>
<a href="#l258.79"></a><span id="l258.79">     Ci.nsIFontEnumerator</span>
<a href="#l258.80"></a><span id="l258.80">   );</span>
<a href="#l258.81"></a><span id="l258.81">   for (let fontType of kFontTypes) {</span>
<a href="#l258.82"></a><span id="l258.82">     gRealFontLists[fontType] = await gFontEnumerator.EnumerateFontsAsync(</span>
<a href="#l258.83"></a><span id="l258.83">       kLanguage,</span>
<a href="#l258.84"></a><span id="l258.84" class="difflineat">@@ -188,17 +229,17 @@ function _verify_fonts_displayed(aDefaul</span>
<a href="#l258.85"></a><span id="l258.85">   close_pref_tab(prefTab);</span>
<a href="#l258.86"></a><span id="l258.86"> }</span>
<a href="#l258.87"></a><span id="l258.87"> </span>
<a href="#l258.88"></a><span id="l258.88"> /**</span>
<a href="#l258.89"></a><span id="l258.89">  * Test that for a particular language, whatever's in</span>
<a href="#l258.90"></a><span id="l258.90">  * font.name.&lt;type&gt;.&lt;language&gt; is displayed in the font chooser (if it is</span>
<a href="#l258.91"></a><span id="l258.91">  * present on the computer).</span>
<a href="#l258.92"></a><span id="l258.92">  */</span>
<a href="#l258.93"></a><span id="l258.93" class="difflineminus">-function test_font_name_displayed() {</span>
<a href="#l258.94"></a><span id="l258.94" class="difflineplus">+add_task(function test_font_name_displayed() {</span>
<a href="#l258.95"></a><span id="l258.95">   Services.prefs.setCharPref(&quot;font.language.group&quot;, kLanguage);</span>
<a href="#l258.96"></a><span id="l258.96"> </span>
<a href="#l258.97"></a><span id="l258.97">   // Pick the first font for each font type and set it.</span>
<a href="#l258.98"></a><span id="l258.98">   let expected = {};</span>
<a href="#l258.99"></a><span id="l258.99">   for (let [fontType, fontList] of Object.entries(gRealFontLists)) {</span>
<a href="#l258.100"></a><span id="l258.100">     // Work around bug 698238 (on Windows, Courier is returned by the enumerator but</span>
<a href="#l258.101"></a><span id="l258.101">     // substituted with Courier New) by getting the standard (substituted) family</span>
<a href="#l258.102"></a><span id="l258.102">     // name for each font.</span>
<a href="#l258.103"></a><span id="l258.103" class="difflineat">@@ -207,32 +248,33 @@ function test_font_name_displayed() {</span>
<a href="#l258.104"></a><span id="l258.104">       &quot;font.name.&quot; + fontType + &quot;.&quot; + kLanguage,</span>
<a href="#l258.105"></a><span id="l258.105">       standardFamily</span>
<a href="#l258.106"></a><span id="l258.106">     );</span>
<a href="#l258.107"></a><span id="l258.107">     expected[fontType] = standardFamily;</span>
<a href="#l258.108"></a><span id="l258.108">   }</span>
<a href="#l258.109"></a><span id="l258.109"> </span>
<a href="#l258.110"></a><span id="l258.110">   let fontTypes = kFontTypes.map(fontType =&gt; expected[fontType]);</span>
<a href="#l258.111"></a><span id="l258.111">   _verify_fonts_displayed(false, ...fontTypes);</span>
<a href="#l258.112"></a><span id="l258.112" class="difflineminus">-}</span>
<a href="#l258.113"></a><span id="l258.113" class="difflineplus">+  teardownTest();</span>
<a href="#l258.114"></a><span id="l258.114" class="difflineplus">+});</span>
<a href="#l258.115"></a><span id="l258.115"> </span>
<a href="#l258.116"></a><span id="l258.116"> // Fonts definitely not present on a computer -- we simply use UUIDs. These</span>
<a href="#l258.117"></a><span id="l258.117"> // should be kept in sync with the ones in *-prefs.js.</span>
<a href="#l258.118"></a><span id="l258.118"> const kFakeFonts = {</span>
<a href="#l258.119"></a><span id="l258.119">   serif: &quot;bc7e8c62-0634-467f-a029-fe6abcdf1582&quot;,</span>
<a href="#l258.120"></a><span id="l258.120">   &quot;sans-serif&quot;: &quot;419129aa-43b7-40c4-b554-83d99b504b89&quot;,</span>
<a href="#l258.121"></a><span id="l258.121">   monospace: &quot;348df6e5-e874-4d21-ad4b-359b530a33b7&quot;,</span>
<a href="#l258.122"></a><span id="l258.122"> };</span>
<a href="#l258.123"></a><span id="l258.123"> </span>
<a href="#l258.124"></a><span id="l258.124"> /**</span>
<a href="#l258.125"></a><span id="l258.125">  * Test that for a particular language, if font.name.&lt;type&gt;.&lt;language&gt; is not</span>
<a href="#l258.126"></a><span id="l258.126">  * present on the computer, we fall back to displaying what's in</span>
<a href="#l258.127"></a><span id="l258.127">  * font.name-list.&lt;type&gt;.&lt;language&gt;.</span>
<a href="#l258.128"></a><span id="l258.128">  */</span>
<a href="#l258.129"></a><span id="l258.129" class="difflineminus">-function test_font_name_not_present() {</span>
<a href="#l258.130"></a><span id="l258.130" class="difflineplus">+add_task(function test_font_name_not_present() {</span>
<a href="#l258.131"></a><span id="l258.131">   Services.prefs.setCharPref(&quot;font.language.group&quot;, kLanguage);</span>
<a href="#l258.132"></a><span id="l258.132"> </span>
<a href="#l258.133"></a><span id="l258.133">   // The fonts we're expecting to see selected in the font chooser for</span>
<a href="#l258.134"></a><span id="l258.134">   // test_font_name_not_present.</span>
<a href="#l258.135"></a><span id="l258.135">   let expected = {};</span>
<a href="#l258.136"></a><span id="l258.136">   for (let [fontType, fakeFont] of Object.entries(kFakeFonts)) {</span>
<a href="#l258.137"></a><span id="l258.137">     // Look at the font.name-list. We need to verify that the first font is the</span>
<a href="#l258.138"></a><span id="l258.138">     // fake one, and that the second one is present on the user's computer.</span>
<a href="#l258.139"></a><span id="l258.139" class="difflineat">@@ -276,22 +318,30 @@ function test_font_name_not_present() {</span>
<a href="#l258.140"></a><span id="l258.140">     Services.prefs.setCharPref(</span>
<a href="#l258.141"></a><span id="l258.141">       &quot;font.name.&quot; + fontType + &quot;.&quot; + kLanguage,</span>
<a href="#l258.142"></a><span id="l258.142">       fakeFont</span>
<a href="#l258.143"></a><span id="l258.143">     );</span>
<a href="#l258.144"></a><span id="l258.144">   }</span>
<a href="#l258.145"></a><span id="l258.145"> </span>
<a href="#l258.146"></a><span id="l258.146">   let fontTypes = kFontTypes.map(fontType =&gt; expected[fontType]);</span>
<a href="#l258.147"></a><span id="l258.147">   _verify_fonts_displayed(true, ...fontTypes);</span>
<a href="#l258.148"></a><span id="l258.148" class="difflineminus">-}</span>
<a href="#l258.149"></a><span id="l258.149" class="difflineplus">+  teardownTest();</span>
<a href="#l258.150"></a><span id="l258.150" class="difflineplus">+});</span>
<a href="#l258.151"></a><span id="l258.151"> </span>
<a href="#l258.152"></a><span id="l258.152"> function teardownTest() {</span>
<a href="#l258.153"></a><span id="l258.153">   // nsIPrefBranch.resetBranch() is not implemented in M-C, so we can't use</span>
<a href="#l258.154"></a><span id="l258.154">   // Services.prefs.resetBranch().</span>
<a href="#l258.155"></a><span id="l258.155">   Preferences.resetBranch(&quot;font.name.&quot;);</span>
<a href="#l258.156"></a><span id="l258.156"> }</span>
<a href="#l258.157"></a><span id="l258.157"> </span>
<a href="#l258.158"></a><span id="l258.158" class="difflineminus">-function teardownModule() {</span>
<a href="#l258.159"></a><span id="l258.159" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l258.160"></a><span id="l258.160">   Services.prefs.clearUserPref(&quot;font.language.group&quot;);</span>
<a href="#l258.161"></a><span id="l258.161">   if (gTodayPane &amp;&amp; gTodayPane.collapsed) {</span>
<a href="#l258.162"></a><span id="l258.162">     mc.keypress(null, &quot;VK_F11&quot;, {});</span>
<a href="#l258.163"></a><span id="l258.163">   }</span>
<a href="#l258.164"></a><span id="l258.164" class="difflineminus">-}</span>
<a href="#l258.165"></a><span id="l258.165" class="difflineplus">+</span>
<a href="#l258.166"></a><span id="l258.166" class="difflineplus">+  Assert.report(</span>
<a href="#l258.167"></a><span id="l258.167" class="difflineplus">+    false,</span>
<a href="#l258.168"></a><span id="l258.168" class="difflineplus">+    undefined,</span>
<a href="#l258.169"></a><span id="l258.169" class="difflineplus">+    undefined,</span>
<a href="#l258.170"></a><span id="l258.170" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l258.171"></a><span id="l258.171" class="difflineplus">+  );</span>
<a href="#l258.172"></a><span id="l258.172" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l259.1"></a><span id="l259.1">new file mode 100644</span>
<a href="#l259.2"></a><span id="l259.2" class="difflineminus">--- /dev/null</span>
<a href="#l259.3"></a><span id="l259.3" class="difflineplus">+++ b/mail/test/browser/quick-filter-bar/browser.ini</span>
<a href="#l259.4"></a><span id="l259.4" class="difflineat">@@ -0,0 +1,17 @@</span>
<a href="#l259.5"></a><span id="l259.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l259.6"></a><span id="l259.6" class="difflineplus">+prefs =</span>
<a href="#l259.7"></a><span id="l259.7" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l259.8"></a><span id="l259.8" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l259.9"></a><span id="l259.9" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l259.10"></a><span id="l259.10" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l259.11"></a><span id="l259.11" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l259.12"></a><span id="l259.12" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l259.13"></a><span id="l259.13" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l259.14"></a><span id="l259.14" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l259.15"></a><span id="l259.15" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l259.16"></a><span id="l259.16" class="difflineplus">+</span>
<a href="#l259.17"></a><span id="l259.17" class="difflineplus">+[browser_displayIssues.js]</span>
<a href="#l259.18"></a><span id="l259.18" class="difflineplus">+[browser_filterLogic.js]</span>
<a href="#l259.19"></a><span id="l259.19" class="difflineplus">+[browser_keyboardInterface.js]</span>
<a href="#l259.20"></a><span id="l259.20" class="difflineplus">+[browser_stickyFilterLogic.js]</span>
<a href="#l259.21"></a><span id="l259.21" class="difflineplus">+[browser_toggleBar.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l260.1"></a><span id="l260.1">copy from mail/test/mozmill/quick-filter-bar/test-display-issues.js</span>
<a href="#l260.2"></a><span id="l260.2">copy to mail/test/browser/quick-filter-bar/browser_displayIssues.js</span>
<a href="#l260.3"></a><span id="l260.3" class="difflineminus">--- a/mail/test/mozmill/quick-filter-bar/test-display-issues.js</span>
<a href="#l260.4"></a><span id="l260.4" class="difflineplus">+++ b/mail/test/browser/quick-filter-bar/browser_displayIssues.js</span>
<a href="#l260.5"></a><span id="l260.5" class="difflineat">@@ -12,17 +12,16 @@</span>
<a href="#l260.6"></a><span id="l260.6"> &quot;use strict&quot;;</span>
<a href="#l260.7"></a><span id="l260.7"> </span>
<a href="#l260.8"></a><span id="l260.8"> var { collapse_panes } = ChromeUtils.import(</span>
<a href="#l260.9"></a><span id="l260.9">   &quot;resource://testing-common/mozmill/DOMHelpers.jsm&quot;</span>
<a href="#l260.10"></a><span id="l260.10"> );</span>
<a href="#l260.11"></a><span id="l260.11"> var {</span>
<a href="#l260.12"></a><span id="l260.12">   assert_default_window_size,</span>
<a href="#l260.13"></a><span id="l260.13">   assert_pane_layout,</span>
<a href="#l260.14"></a><span id="l260.14" class="difflineminus">-  assert_true,</span>
<a href="#l260.15"></a><span id="l260.15">   be_in_folder,</span>
<a href="#l260.16"></a><span id="l260.16">   create_folder,</span>
<a href="#l260.17"></a><span id="l260.17">   gDefaultWindowHeight,</span>
<a href="#l260.18"></a><span id="l260.18">   gDefaultWindowWidth,</span>
<a href="#l260.19"></a><span id="l260.19">   kClassicMailLayout,</span>
<a href="#l260.20"></a><span id="l260.20">   kVerticalMailLayout,</span>
<a href="#l260.21"></a><span id="l260.21">   mark_action,</span>
<a href="#l260.22"></a><span id="l260.22">   mc,</span>
<a href="#l260.23"></a><span id="l260.23" class="difflineat">@@ -47,23 +46,23 @@ var folder;</span>
<a href="#l260.24"></a><span id="l260.24"> var setUnstarred, setStarred;</span>
<a href="#l260.25"></a><span id="l260.25"> var gOriginalPaneWidth;</span>
<a href="#l260.26"></a><span id="l260.26"> </span>
<a href="#l260.27"></a><span id="l260.27"> var gEnlargedWindowWidth = 1260;</span>
<a href="#l260.28"></a><span id="l260.28"> var gShrunkenWindowWidth = 600;</span>
<a href="#l260.29"></a><span id="l260.29"> </span>
<a href="#l260.30"></a><span id="l260.30"> var gTodayPane;</span>
<a href="#l260.31"></a><span id="l260.31"> </span>
<a href="#l260.32"></a><span id="l260.32" class="difflineminus">-function setupModule(module) {</span>
<a href="#l260.33"></a><span id="l260.33" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l260.34"></a><span id="l260.34">   folder = create_folder(&quot;QuickFilterBarDisplayIssues&quot;);</span>
<a href="#l260.35"></a><span id="l260.35">   be_in_folder(folder);</span>
<a href="#l260.36"></a><span id="l260.36"> </span>
<a href="#l260.37"></a><span id="l260.37">   // Let's check window dimensions so we can enlarge from them.</span>
<a href="#l260.38"></a><span id="l260.38">   restore_default_window_size();</span>
<a href="#l260.39"></a><span id="l260.39" class="difflineminus">-  assert_true(</span>
<a href="#l260.40"></a><span id="l260.40" class="difflineplus">+  Assert.ok(</span>
<a href="#l260.41"></a><span id="l260.41">     gEnlargedWindowWidth &gt; gDefaultWindowWidth,</span>
<a href="#l260.42"></a><span id="l260.42">     &quot;Main window too large for the test logic&quot;</span>
<a href="#l260.43"></a><span id="l260.43">   );</span>
<a href="#l260.44"></a><span id="l260.44"> </span>
<a href="#l260.45"></a><span id="l260.45">   // Store folder pane width that we will change temporarily.</span>
<a href="#l260.46"></a><span id="l260.46">   let folderPaneBox = mc.e(&quot;folderPaneBox&quot;);</span>
<a href="#l260.47"></a><span id="l260.47">   gOriginalPaneWidth = folderPaneBox.width;</span>
<a href="#l260.48"></a><span id="l260.48"> </span>
<a href="#l260.49"></a><span id="l260.49" class="difflineat">@@ -72,26 +71,26 @@ function setupModule(module) {</span>
<a href="#l260.50"></a><span id="l260.50">   gTodayPane = mc.e(&quot;today-pane-panel&quot;);</span>
<a href="#l260.51"></a><span id="l260.51">   if (gTodayPane) {</span>
<a href="#l260.52"></a><span id="l260.52">     if (!gTodayPane.collapsed) {</span>
<a href="#l260.53"></a><span id="l260.53">       mc.keypress(null, &quot;VK_F11&quot;, {});</span>
<a href="#l260.54"></a><span id="l260.54">     } else {</span>
<a href="#l260.55"></a><span id="l260.55">       gTodayPane = null;</span>
<a href="#l260.56"></a><span id="l260.56">     }</span>
<a href="#l260.57"></a><span id="l260.57">   }</span>
<a href="#l260.58"></a><span id="l260.58" class="difflineminus">-}</span>
<a href="#l260.59"></a><span id="l260.59" class="difflineplus">+});</span>
<a href="#l260.60"></a><span id="l260.60"> </span>
<a href="#l260.61"></a><span id="l260.61"> /**</span>
<a href="#l260.62"></a><span id="l260.62">  * When the window gets too narrow the collapsible button labels need to get</span>
<a href="#l260.63"></a><span id="l260.63">  *  gone.  Then they need to come back when we get large enough again.</span>
<a href="#l260.64"></a><span id="l260.64">  *</span>
<a href="#l260.65"></a><span id="l260.65">  * Because the mozmill window sizing is weird and confusing, we force our size</span>
<a href="#l260.66"></a><span id="l260.66">  *  in both cases but do save/restore around our test.</span>
<a href="#l260.67"></a><span id="l260.67">  */</span>
<a href="#l260.68"></a><span id="l260.68" class="difflineminus">-function test_buttons_collapse_and_expand() {</span>
<a href="#l260.69"></a><span id="l260.69" class="difflineplus">+add_task(function test_buttons_collapse_and_expand() {</span>
<a href="#l260.70"></a><span id="l260.70">   assert_quick_filter_bar_visible(true); // precondition</span>
<a href="#l260.71"></a><span id="l260.71"> </span>
<a href="#l260.72"></a><span id="l260.72">   let qfbCollapsy = mc.e(&quot;quick-filter-bar-collapsible-buttons&quot;);</span>
<a href="#l260.73"></a><span id="l260.73">   let qfbExemplarButton = mc.e(&quot;qfb-unread&quot;); // (arbitrary labeled button)</span>
<a href="#l260.74"></a><span id="l260.74">   let qfbExemplarLabel = qfbExemplarButton.querySelector(&quot;.toolbarbutton-text&quot;);</span>
<a href="#l260.75"></a><span id="l260.75"> </span>
<a href="#l260.76"></a><span id="l260.76">   function logState(aWhen) {</span>
<a href="#l260.77"></a><span id="l260.77">     mark_action(&quot;test&quot;, &quot;log_window_state&quot;, [</span>
<a href="#l260.78"></a><span id="l260.78" class="difflineat">@@ -148,19 +147,20 @@ function test_buttons_collapse_and_expan</span>
<a href="#l260.79"></a><span id="l260.79">   logState(&quot;tiny&quot;);</span>
<a href="#l260.80"></a><span id="l260.80">   assertCollapsed();</span>
<a href="#l260.81"></a><span id="l260.81"> </span>
<a href="#l260.82"></a><span id="l260.82">   // -- GIANT again!</span>
<a href="#l260.83"></a><span id="l260.83">   resize_to(mc, gEnlargedWindowWidth, gDefaultWindowHeight);</span>
<a href="#l260.84"></a><span id="l260.84">   collapse_panes(mc.e(&quot;folderpane_splitter&quot;), true);</span>
<a href="#l260.85"></a><span id="l260.85">   logState(&quot;giant again!&quot;);</span>
<a href="#l260.86"></a><span id="l260.86">   assertExpanded();</span>
<a href="#l260.87"></a><span id="l260.87" class="difflineminus">-}</span>
<a href="#l260.88"></a><span id="l260.88" class="difflineplus">+  teardownTest();</span>
<a href="#l260.89"></a><span id="l260.89" class="difflineplus">+});</span>
<a href="#l260.90"></a><span id="l260.90"> </span>
<a href="#l260.91"></a><span id="l260.91" class="difflineminus">-function test_buttons_collapse_and_expand_on_spawn_in_vertical_mode() {</span>
<a href="#l260.92"></a><span id="l260.92" class="difflineplus">+add_task(function test_buttons_collapse_and_expand_on_spawn_in_vertical_mode() {</span>
<a href="#l260.93"></a><span id="l260.93">   // Assume we're in classic layout to start - since this is where we'll</span>
<a href="#l260.94"></a><span id="l260.94">   // reset to once we're done.</span>
<a href="#l260.95"></a><span id="l260.95">   assert_pane_layout(kClassicMailLayout);</span>
<a href="#l260.96"></a><span id="l260.96"> </span>
<a href="#l260.97"></a><span id="l260.97">   // Put us in vertical mode</span>
<a href="#l260.98"></a><span id="l260.98">   set_pane_layout(kVerticalMailLayout);</span>
<a href="#l260.99"></a><span id="l260.99"> </span>
<a href="#l260.100"></a><span id="l260.100">   // Make our window nice and wide.</span>
<a href="#l260.101"></a><span id="l260.101" class="difflineat">@@ -175,29 +175,37 @@ function test_buttons_collapse_and_expan</span>
<a href="#l260.102"></a><span id="l260.102">   let qfb = mc2.e(&quot;quick-filter-bar-collapsible-buttons&quot;);</span>
<a href="#l260.103"></a><span id="l260.103">   mc2.waitFor(</span>
<a href="#l260.104"></a><span id="l260.104">     () =&gt; qfb.getAttribute(&quot;shrink&quot;) == &quot;true&quot;,</span>
<a href="#l260.105"></a><span id="l260.105">     &quot;New 3pane should have had a collapsed QFB&quot;</span>
<a href="#l260.106"></a><span id="l260.106">   );</span>
<a href="#l260.107"></a><span id="l260.107">   close_window(mc2);</span>
<a href="#l260.108"></a><span id="l260.108"> </span>
<a href="#l260.109"></a><span id="l260.109">   set_pane_layout(kClassicMailLayout);</span>
<a href="#l260.110"></a><span id="l260.110" class="difflineminus">-}</span>
<a href="#l260.111"></a><span id="l260.111" class="difflineplus">+  teardownTest();</span>
<a href="#l260.112"></a><span id="l260.112" class="difflineplus">+});</span>
<a href="#l260.113"></a><span id="l260.113"> </span>
<a href="#l260.114"></a><span id="l260.114"> function teardownTest() {</span>
<a href="#l260.115"></a><span id="l260.115">   clear_constraints();</span>
<a href="#l260.116"></a><span id="l260.116">   // make it visible if it's not</span>
<a href="#l260.117"></a><span id="l260.117">   if (mc.e(&quot;quick-filter-bar&quot;).collapsed) {</span>
<a href="#l260.118"></a><span id="l260.118">     toggle_quick_filter_bar();</span>
<a href="#l260.119"></a><span id="l260.119">   }</span>
<a href="#l260.120"></a><span id="l260.120"> }</span>
<a href="#l260.121"></a><span id="l260.121"> </span>
<a href="#l260.122"></a><span id="l260.122" class="difflineminus">-function teardownModule() {</span>
<a href="#l260.123"></a><span id="l260.123" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l260.124"></a><span id="l260.124">   // Restore the window to original layout.</span>
<a href="#l260.125"></a><span id="l260.125">   restore_default_window_size();</span>
<a href="#l260.126"></a><span id="l260.126">   collapse_panes(mc.e(&quot;folderpane_splitter&quot;), false);</span>
<a href="#l260.127"></a><span id="l260.127">   let folderPaneBox = mc.e(&quot;folderPaneBox&quot;);</span>
<a href="#l260.128"></a><span id="l260.128">   folderPaneBox.width = gOriginalPaneWidth;</span>
<a href="#l260.129"></a><span id="l260.129"> </span>
<a href="#l260.130"></a><span id="l260.130">   if (gTodayPane &amp;&amp; gTodayPane.collapsed) {</span>
<a href="#l260.131"></a><span id="l260.131">     mc.keypress(null, &quot;VK_F11&quot;, {});</span>
<a href="#l260.132"></a><span id="l260.132">   }</span>
<a href="#l260.133"></a><span id="l260.133" class="difflineminus">-}</span>
<a href="#l260.134"></a><span id="l260.134" class="difflineplus">+</span>
<a href="#l260.135"></a><span id="l260.135" class="difflineplus">+  Assert.report(</span>
<a href="#l260.136"></a><span id="l260.136" class="difflineplus">+    false,</span>
<a href="#l260.137"></a><span id="l260.137" class="difflineplus">+    undefined,</span>
<a href="#l260.138"></a><span id="l260.138" class="difflineplus">+    undefined,</span>
<a href="#l260.139"></a><span id="l260.139" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l260.140"></a><span id="l260.140" class="difflineplus">+  );</span>
<a href="#l260.141"></a><span id="l260.141" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l261.1"></a><span id="l261.1">copy from mail/test/mozmill/quick-filter-bar/test-filter-logic.js</span>
<a href="#l261.2"></a><span id="l261.2">copy to mail/test/browser/quick-filter-bar/browser_filterLogic.js</span>
<a href="#l261.3"></a><span id="l261.3" class="difflineminus">--- a/mail/test/mozmill/quick-filter-bar/test-filter-logic.js</span>
<a href="#l261.4"></a><span id="l261.4" class="difflineplus">+++ b/mail/test/browser/quick-filter-bar/browser_filterLogic.js</span>
<a href="#l261.5"></a><span id="l261.5" class="difflineat">@@ -34,60 +34,63 @@ var {</span>
<a href="#l261.6"></a><span id="l261.6"> } = ChromeUtils.import(</span>
<a href="#l261.7"></a><span id="l261.7">   &quot;resource://testing-common/mozmill/QuickFilterBarHelpers.jsm&quot;</span>
<a href="#l261.8"></a><span id="l261.8"> );</span>
<a href="#l261.9"></a><span id="l261.9"> </span>
<a href="#l261.10"></a><span id="l261.10"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l261.11"></a><span id="l261.11">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l261.12"></a><span id="l261.12"> );</span>
<a href="#l261.13"></a><span id="l261.13"> </span>
<a href="#l261.14"></a><span id="l261.14" class="difflineminus">-function test_filter_unread() {</span>
<a href="#l261.15"></a><span id="l261.15" class="difflineplus">+add_task(function test_filter_unread() {</span>
<a href="#l261.16"></a><span id="l261.16">   let folder = create_folder(&quot;QuickFilterBarFilterUnread&quot;);</span>
<a href="#l261.17"></a><span id="l261.17">   let [unread, read] = make_new_sets_in_folder(folder, [</span>
<a href="#l261.18"></a><span id="l261.18">     { count: 1 },</span>
<a href="#l261.19"></a><span id="l261.19">     { count: 1 },</span>
<a href="#l261.20"></a><span id="l261.20">   ]);</span>
<a href="#l261.21"></a><span id="l261.21">   read.setRead(true);</span>
<a href="#l261.22"></a><span id="l261.22"> </span>
<a href="#l261.23"></a><span id="l261.23">   be_in_folder(folder);</span>
<a href="#l261.24"></a><span id="l261.24">   toggle_boolean_constraints(&quot;unread&quot;);</span>
<a href="#l261.25"></a><span id="l261.25">   assert_messages_in_view(unread);</span>
<a href="#l261.26"></a><span id="l261.26" class="difflineminus">-}</span>
<a href="#l261.27"></a><span id="l261.27" class="difflineplus">+  teardownTest();</span>
<a href="#l261.28"></a><span id="l261.28" class="difflineplus">+});</span>
<a href="#l261.29"></a><span id="l261.29"> </span>
<a href="#l261.30"></a><span id="l261.30" class="difflineminus">-function test_filter_starred() {</span>
<a href="#l261.31"></a><span id="l261.31" class="difflineplus">+add_task(function test_filter_starred() {</span>
<a href="#l261.32"></a><span id="l261.32">   let folder = create_folder(&quot;QuickFilterBarFilterStarred&quot;);</span>
<a href="#l261.33"></a><span id="l261.33">   let [, starred] = make_new_sets_in_folder(folder, [</span>
<a href="#l261.34"></a><span id="l261.34">     { count: 1 },</span>
<a href="#l261.35"></a><span id="l261.35">     { count: 1 },</span>
<a href="#l261.36"></a><span id="l261.36">   ]);</span>
<a href="#l261.37"></a><span id="l261.37">   starred.setStarred(true);</span>
<a href="#l261.38"></a><span id="l261.38"> </span>
<a href="#l261.39"></a><span id="l261.39">   be_in_folder(folder);</span>
<a href="#l261.40"></a><span id="l261.40">   toggle_boolean_constraints(&quot;starred&quot;);</span>
<a href="#l261.41"></a><span id="l261.41">   assert_messages_in_view(starred);</span>
<a href="#l261.42"></a><span id="l261.42" class="difflineminus">-}</span>
<a href="#l261.43"></a><span id="l261.43" class="difflineplus">+  teardownTest();</span>
<a href="#l261.44"></a><span id="l261.44" class="difflineplus">+});</span>
<a href="#l261.45"></a><span id="l261.45"> </span>
<a href="#l261.46"></a><span id="l261.46" class="difflineminus">-function test_filter_simple_intersection_unread_and_starred() {</span>
<a href="#l261.47"></a><span id="l261.47" class="difflineplus">+add_task(function test_filter_simple_intersection_unread_and_starred() {</span>
<a href="#l261.48"></a><span id="l261.48">   let folder = create_folder(&quot;QuickFilterBarFilterUnreadAndStarred&quot;);</span>
<a href="#l261.49"></a><span id="l261.49">   let [, readUnstarred, unreadStarred, readStarred] = make_new_sets_in_folder(</span>
<a href="#l261.50"></a><span id="l261.50">     folder,</span>
<a href="#l261.51"></a><span id="l261.51">     [{ count: 1 }, { count: 1 }, { count: 1 }, { count: 1 }]</span>
<a href="#l261.52"></a><span id="l261.52">   );</span>
<a href="#l261.53"></a><span id="l261.53">   readUnstarred.setRead(true);</span>
<a href="#l261.54"></a><span id="l261.54">   unreadStarred.setStarred(true);</span>
<a href="#l261.55"></a><span id="l261.55">   readStarred.setRead(true);</span>
<a href="#l261.56"></a><span id="l261.56">   readStarred.setStarred(true);</span>
<a href="#l261.57"></a><span id="l261.57"> </span>
<a href="#l261.58"></a><span id="l261.58">   be_in_folder(folder);</span>
<a href="#l261.59"></a><span id="l261.59">   toggle_boolean_constraints(&quot;unread&quot;, &quot;starred&quot;);</span>
<a href="#l261.60"></a><span id="l261.60"> </span>
<a href="#l261.61"></a><span id="l261.61">   assert_messages_in_view(unreadStarred);</span>
<a href="#l261.62"></a><span id="l261.62" class="difflineminus">-}</span>
<a href="#l261.63"></a><span id="l261.63" class="difflineplus">+  teardownTest();</span>
<a href="#l261.64"></a><span id="l261.64" class="difflineplus">+});</span>
<a href="#l261.65"></a><span id="l261.65"> </span>
<a href="#l261.66"></a><span id="l261.66" class="difflineminus">-function test_filter_attachments() {</span>
<a href="#l261.67"></a><span id="l261.67" class="difflineplus">+add_task(function test_filter_attachments() {</span>
<a href="#l261.68"></a><span id="l261.68">   let attachSetDef = {</span>
<a href="#l261.69"></a><span id="l261.69">     count: 1,</span>
<a href="#l261.70"></a><span id="l261.70">     attachments: [</span>
<a href="#l261.71"></a><span id="l261.71">       {</span>
<a href="#l261.72"></a><span id="l261.72">         filename: &quot;foo.png&quot;,</span>
<a href="#l261.73"></a><span id="l261.73">         contentType: &quot;image/png&quot;,</span>
<a href="#l261.74"></a><span id="l261.74">         encoding: &quot;base64&quot;,</span>
<a href="#l261.75"></a><span id="l261.75">         charset: null,</span>
<a href="#l261.76"></a><span id="l261.76" class="difflineat">@@ -105,17 +108,18 @@ function test_filter_attachments() {</span>
<a href="#l261.77"></a><span id="l261.77">     noAttachSetDef,</span>
<a href="#l261.78"></a><span id="l261.78">     attachSetDef,</span>
<a href="#l261.79"></a><span id="l261.79">   ]);</span>
<a href="#l261.80"></a><span id="l261.80"> </span>
<a href="#l261.81"></a><span id="l261.81">   be_in_folder(folder);</span>
<a href="#l261.82"></a><span id="l261.82">   toggle_boolean_constraints(&quot;attachments&quot;);</span>
<a href="#l261.83"></a><span id="l261.83"> </span>
<a href="#l261.84"></a><span id="l261.84">   assert_messages_in_view(setAttach);</span>
<a href="#l261.85"></a><span id="l261.85" class="difflineminus">-}</span>
<a href="#l261.86"></a><span id="l261.86" class="difflineplus">+  teardownTest();</span>
<a href="#l261.87"></a><span id="l261.87" class="difflineplus">+});</span>
<a href="#l261.88"></a><span id="l261.88"> </span>
<a href="#l261.89"></a><span id="l261.89"> /**</span>
<a href="#l261.90"></a><span id="l261.90">  * Create a card for the given e-mail address, adding it to the first address</span>
<a href="#l261.91"></a><span id="l261.91">  * book we can find.</span>
<a href="#l261.92"></a><span id="l261.92">  */</span>
<a href="#l261.93"></a><span id="l261.93"> function add_email_to_address_book(aEmailAddr) {</span>
<a href="#l261.94"></a><span id="l261.94">   let card = Cc[&quot;@mozilla.org/addressbook/cardproperty;1&quot;].createInstance(</span>
<a href="#l261.95"></a><span id="l261.95">     Ci.nsIAbCard</span>
<a href="#l261.96"></a><span id="l261.96" class="difflineat">@@ -129,30 +133,31 @@ function add_email_to_address_book(aEmai</span>
<a href="#l261.97"></a><span id="l261.97">       addrbook.addCard(card);</span>
<a href="#l261.98"></a><span id="l261.98">       return;</span>
<a href="#l261.99"></a><span id="l261.99">     }</span>
<a href="#l261.100"></a><span id="l261.100">   }</span>
<a href="#l261.101"></a><span id="l261.101"> </span>
<a href="#l261.102"></a><span id="l261.102">   throw new Error(&quot;Unable to find any suitable address book.&quot;);</span>
<a href="#l261.103"></a><span id="l261.103"> }</span>
<a href="#l261.104"></a><span id="l261.104"> </span>
<a href="#l261.105"></a><span id="l261.105" class="difflineminus">-function test_filter_in_address_book() {</span>
<a href="#l261.106"></a><span id="l261.106" class="difflineplus">+add_task(function test_filter_in_address_book() {</span>
<a href="#l261.107"></a><span id="l261.107">   let bookSetDef = {</span>
<a href="#l261.108"></a><span id="l261.108">     from: [&quot;Qbert Q Qbington&quot;, &quot;q@q.invalid&quot;],</span>
<a href="#l261.109"></a><span id="l261.109">     count: 1,</span>
<a href="#l261.110"></a><span id="l261.110">   };</span>
<a href="#l261.111"></a><span id="l261.111">   add_email_to_address_book(bookSetDef.from[1]);</span>
<a href="#l261.112"></a><span id="l261.112">   let folder = create_folder(&quot;MesssageFilterBarInAddressBook&quot;);</span>
<a href="#l261.113"></a><span id="l261.113">   let [setBook] = make_new_sets_in_folder(folder, [bookSetDef, { count: 1 }]);</span>
<a href="#l261.114"></a><span id="l261.114">   be_in_folder(folder);</span>
<a href="#l261.115"></a><span id="l261.115">   toggle_boolean_constraints(&quot;addrbook&quot;);</span>
<a href="#l261.116"></a><span id="l261.116">   assert_messages_in_view(setBook);</span>
<a href="#l261.117"></a><span id="l261.117" class="difflineminus">-}</span>
<a href="#l261.118"></a><span id="l261.118" class="difflineplus">+  teardownTest();</span>
<a href="#l261.119"></a><span id="l261.119" class="difflineplus">+});</span>
<a href="#l261.120"></a><span id="l261.120"> </span>
<a href="#l261.121"></a><span id="l261.121" class="difflineminus">-function test_filter_tags() {</span>
<a href="#l261.122"></a><span id="l261.122" class="difflineplus">+add_task(function test_filter_tags() {</span>
<a href="#l261.123"></a><span id="l261.123">   let folder = create_folder(&quot;QuickFilterBarTags&quot;);</span>
<a href="#l261.124"></a><span id="l261.124">   const tagA = &quot;$label1&quot;,</span>
<a href="#l261.125"></a><span id="l261.125">     tagB = &quot;$label2&quot;,</span>
<a href="#l261.126"></a><span id="l261.126">     tagC = &quot;$label3&quot;;</span>
<a href="#l261.127"></a><span id="l261.127">   let [setNoTag, setTagA, setTagB, setTagAB, setTagC] = make_new_sets_in_folder(</span>
<a href="#l261.128"></a><span id="l261.128">     folder,</span>
<a href="#l261.129"></a><span id="l261.129">     [{ count: 1 }, { count: 1 }, { count: 1 }, { count: 1 }, { count: 1 }]</span>
<a href="#l261.130"></a><span id="l261.130">   );</span>
<a href="#l261.131"></a><span id="l261.131" class="difflineat">@@ -191,19 +196,20 @@ function test_filter_tags() {</span>
<a href="#l261.132"></a><span id="l261.132">   // tag&quot;.</span>
<a href="#l261.133"></a><span id="l261.133">   toggle_boolean_constraints(&quot;tags&quot;);</span>
<a href="#l261.134"></a><span id="l261.134">   toggle_tag_constraints(tagC);</span>
<a href="#l261.135"></a><span id="l261.135">   assert_messages_in_view(setTagC);</span>
<a href="#l261.136"></a><span id="l261.136"> </span>
<a href="#l261.137"></a><span id="l261.137">   toggle_boolean_constraints(&quot;tags&quot;); // no constraints</span>
<a href="#l261.138"></a><span id="l261.138">   toggle_boolean_constraints(&quot;tags&quot;); // should be any tag (not tagC!)</span>
<a href="#l261.139"></a><span id="l261.139">   assert_messages_in_view([setTagA, setTagB, setTagAB, setTagC]);</span>
<a href="#l261.140"></a><span id="l261.140" class="difflineminus">-}</span>
<a href="#l261.141"></a><span id="l261.141" class="difflineplus">+  teardownTest();</span>
<a href="#l261.142"></a><span id="l261.142" class="difflineplus">+});</span>
<a href="#l261.143"></a><span id="l261.143"> </span>
<a href="#l261.144"></a><span id="l261.144" class="difflineminus">-function test_filter_text_single_word_and_predicates() {</span>
<a href="#l261.145"></a><span id="l261.145" class="difflineplus">+add_task(function test_filter_text_single_word_and_predicates() {</span>
<a href="#l261.146"></a><span id="l261.146">   let folder = create_folder(&quot;QuickFilterBarTextSingleWord&quot;);</span>
<a href="#l261.147"></a><span id="l261.147">   let whoFoo = [&quot;zabba&quot;, &quot;foo@madeup.invalid&quot;];</span>
<a href="#l261.148"></a><span id="l261.148">   let [</span>
<a href="#l261.149"></a><span id="l261.149">     ,</span>
<a href="#l261.150"></a><span id="l261.150">     setSenderFoo,</span>
<a href="#l261.151"></a><span id="l261.151">     setRecipientsFoo,</span>
<a href="#l261.152"></a><span id="l261.152">     setSubjectFoo,</span>
<a href="#l261.153"></a><span id="l261.153">     setBodyFoo,</span>
<a href="#l261.154"></a><span id="l261.154" class="difflineat">@@ -250,27 +256,28 @@ function test_filter_text_single_word_an</span>
<a href="#l261.155"></a><span id="l261.155">   set_filter_text(&quot;notgonnamatchevercauseisayso&quot;);</span>
<a href="#l261.156"></a><span id="l261.156">   assert_messages_in_view([]);</span>
<a href="#l261.157"></a><span id="l261.157">   // disable body, still should get nothing</span>
<a href="#l261.158"></a><span id="l261.158">   toggle_text_constraints(&quot;body&quot;);</span>
<a href="#l261.159"></a><span id="l261.159">   assert_messages_in_view([]);</span>
<a href="#l261.160"></a><span id="l261.160"> </span>
<a href="#l261.161"></a><span id="l261.161">   // (we are leaving with the defaults once again active)</span>
<a href="#l261.162"></a><span id="l261.162">   assert_text_constraints_checked(&quot;sender&quot;, &quot;recipients&quot;, &quot;subject&quot;);</span>
<a href="#l261.163"></a><span id="l261.163" class="difflineminus">-}</span>
<a href="#l261.164"></a><span id="l261.164" class="difflineplus">+  teardownTest();</span>
<a href="#l261.165"></a><span id="l261.165" class="difflineplus">+});</span>
<a href="#l261.166"></a><span id="l261.166"> </span>
<a href="#l261.167"></a><span id="l261.167"> /**</span>
<a href="#l261.168"></a><span id="l261.168">  * Verify that the multi-word logic is actually splitting the words into</span>
<a href="#l261.169"></a><span id="l261.169">  *  different terms and that the terms can match in different predicates.</span>
<a href="#l261.170"></a><span id="l261.170">  *  This means that given &quot;foo bar&quot; we should be able to match &quot;bar foo&quot; in</span>
<a href="#l261.171"></a><span id="l261.171">  *  a subject and &quot;foo&quot; in the sender and &quot;bar&quot; in the recipient.  And that</span>
<a href="#l261.172"></a><span id="l261.172">  *  constitutes sufficient positive coverage, although we also want to make</span>
<a href="#l261.173"></a><span id="l261.173">  *  sure that just a single term match is insufficient.</span>
<a href="#l261.174"></a><span id="l261.174">  */</span>
<a href="#l261.175"></a><span id="l261.175" class="difflineminus">-function test_filter_text_multi_word() {</span>
<a href="#l261.176"></a><span id="l261.176" class="difflineplus">+add_task(function test_filter_text_multi_word() {</span>
<a href="#l261.177"></a><span id="l261.177">   let folder = create_folder(&quot;QuickFilterBarTextMultiWord&quot;);</span>
<a href="#l261.178"></a><span id="l261.178"> </span>
<a href="#l261.179"></a><span id="l261.179">   let whoFoo = [&quot;foo&quot;, &quot;zabba@madeup.invalid&quot;];</span>
<a href="#l261.180"></a><span id="l261.180">   let whoBar = [&quot;zabba&quot;, &quot;bar@madeup.invalid&quot;];</span>
<a href="#l261.181"></a><span id="l261.181">   let [, setPeepMatch, setSubjReverse] = make_new_sets_in_folder(folder, [</span>
<a href="#l261.182"></a><span id="l261.182">     { count: 1 },</span>
<a href="#l261.183"></a><span id="l261.183">     { count: 1, from: whoFoo, to: [whoBar] },</span>
<a href="#l261.184"></a><span id="l261.184">     { count: 1, subject: &quot;bar foo&quot; },</span>
<a href="#l261.185"></a><span id="l261.185" class="difflineat">@@ -278,23 +285,24 @@ function test_filter_text_multi_word() {</span>
<a href="#l261.186"></a><span id="l261.186">   ]);</span>
<a href="#l261.187"></a><span id="l261.187">   be_in_folder(folder);</span>
<a href="#l261.188"></a><span id="l261.188"> </span>
<a href="#l261.189"></a><span id="l261.189">   // (precondition)</span>
<a href="#l261.190"></a><span id="l261.190">   assert_text_constraints_checked(&quot;sender&quot;, &quot;recipients&quot;, &quot;subject&quot;);</span>
<a href="#l261.191"></a><span id="l261.191"> </span>
<a href="#l261.192"></a><span id="l261.192">   set_filter_text(&quot;foo bar&quot;);</span>
<a href="#l261.193"></a><span id="l261.193">   assert_messages_in_view([setPeepMatch, setSubjReverse]);</span>
<a href="#l261.194"></a><span id="l261.194" class="difflineminus">-}</span>
<a href="#l261.195"></a><span id="l261.195" class="difflineplus">+  teardownTest();</span>
<a href="#l261.196"></a><span id="l261.196" class="difflineplus">+});</span>
<a href="#l261.197"></a><span id="l261.197"> </span>
<a href="#l261.198"></a><span id="l261.198"> /**</span>
<a href="#l261.199"></a><span id="l261.199">  * Verify that the quickfilter bar has OR functionality using</span>
<a href="#l261.200"></a><span id="l261.200">  * | (Pipe character) - Bug 586131</span>
<a href="#l261.201"></a><span id="l261.201">  */</span>
<a href="#l261.202"></a><span id="l261.202" class="difflineminus">-function test_filter_or_operator() {</span>
<a href="#l261.203"></a><span id="l261.203" class="difflineplus">+add_task(function test_filter_or_operator() {</span>
<a href="#l261.204"></a><span id="l261.204">   let folder = create_folder(&quot;QuickFilterBarOrOperator&quot;);</span>
<a href="#l261.205"></a><span id="l261.205"> </span>
<a href="#l261.206"></a><span id="l261.206">   let whoFoo = [&quot;foo&quot;, &quot;zabba@madeup.invalid&quot;];</span>
<a href="#l261.207"></a><span id="l261.207">   let whoBar = [&quot;zabba&quot;, &quot;bar@madeup.invalid&quot;];</span>
<a href="#l261.208"></a><span id="l261.208">   let whoTest = [&quot;test&quot;, &quot;test@madeup.invalid&quot;];</span>
<a href="#l261.209"></a><span id="l261.209">   let [</span>
<a href="#l261.210"></a><span id="l261.210">     setInert,</span>
<a href="#l261.211"></a><span id="l261.211">     setSenderFoo,</span>
<a href="#l261.212"></a><span id="l261.212" class="difflineat">@@ -332,24 +340,25 @@ function test_filter_or_operator() {</span>
<a href="#l261.213"></a><span id="l261.213">     setSenderFoo,</span>
<a href="#l261.214"></a><span id="l261.214">     setToBar,</span>
<a href="#l261.215"></a><span id="l261.215">     setSubject3,</span>
<a href="#l261.216"></a><span id="l261.216">     setMail1,</span>
<a href="#l261.217"></a><span id="l261.217">   ]);</span>
<a href="#l261.218"></a><span id="l261.218"> </span>
<a href="#l261.219"></a><span id="l261.219">   set_filter_text(&quot;test | foo  bar |logic&quot;);</span>
<a href="#l261.220"></a><span id="l261.220">   assert_messages_not_in_view([setInert, setSenderFoo, setToBar, setSubject3]);</span>
<a href="#l261.221"></a><span id="l261.221" class="difflineminus">-}</span>
<a href="#l261.222"></a><span id="l261.222" class="difflineplus">+  teardownTest();</span>
<a href="#l261.223"></a><span id="l261.223" class="difflineplus">+});</span>
<a href="#l261.224"></a><span id="l261.224"> </span>
<a href="#l261.225"></a><span id="l261.225"> /**</span>
<a href="#l261.226"></a><span id="l261.226">  * Make sure that when dropping all constraints on toggle off or changing</span>
<a href="#l261.227"></a><span id="l261.227">  *  folders that we persist/propagate the state of the</span>
<a href="#l261.228"></a><span id="l261.228">  *  sender/recipients/subject/body toggle buttons.</span>
<a href="#l261.229"></a><span id="l261.229">  */</span>
<a href="#l261.230"></a><span id="l261.230" class="difflineminus">-function test_filter_text_constraints_propagate() {</span>
<a href="#l261.231"></a><span id="l261.231" class="difflineplus">+add_task(function test_filter_text_constraints_propagate() {</span>
<a href="#l261.232"></a><span id="l261.232">   let whoFoo = [&quot;foo&quot;, &quot;zabba@madeup.invalid&quot;];</span>
<a href="#l261.233"></a><span id="l261.233">   let whoBar = [&quot;zabba&quot;, &quot;bar@madeup.invalid&quot;];</span>
<a href="#l261.234"></a><span id="l261.234"> </span>
<a href="#l261.235"></a><span id="l261.235">   let folderOne = create_folder(&quot;QuickFilterBarTextPropagate1&quot;);</span>
<a href="#l261.236"></a><span id="l261.236">   let [setSubjFoo, setWhoFoo] = make_new_sets_in_folder(folderOne, [</span>
<a href="#l261.237"></a><span id="l261.237">     { count: 1, subject: &quot;foo&quot; },</span>
<a href="#l261.238"></a><span id="l261.238">     { count: 1, from: whoFoo },</span>
<a href="#l261.239"></a><span id="l261.239">   ]);</span>
<a href="#l261.240"></a><span id="l261.240" class="difflineat">@@ -376,28 +385,29 @@ function test_filter_text_constraints_pr</span>
<a href="#l261.241"></a><span id="l261.241">   assert_messages_in_view([setWhoFoo]);</span>
<a href="#l261.242"></a><span id="l261.242">   assert_text_constraints_checked(&quot;sender&quot;, &quot;recipients&quot;);</span>
<a href="#l261.243"></a><span id="l261.243"> </span>
<a href="#l261.244"></a><span id="l261.244">   // -- now change folders and make sure the settings stick</span>
<a href="#l261.245"></a><span id="l261.245">   be_in_folder(folderTwo);</span>
<a href="#l261.246"></a><span id="l261.246">   set_filter_text(&quot;bar&quot;);</span>
<a href="#l261.247"></a><span id="l261.247">   assert_messages_in_view([setWhoBar]);</span>
<a href="#l261.248"></a><span id="l261.248">   assert_text_constraints_checked(&quot;sender&quot;, &quot;recipients&quot;);</span>
<a href="#l261.249"></a><span id="l261.249" class="difflineminus">-}</span>
<a href="#l261.250"></a><span id="l261.250" class="difflineplus">+  teardownTest();</span>
<a href="#l261.251"></a><span id="l261.251" class="difflineplus">+});</span>
<a href="#l261.252"></a><span id="l261.252"> </span>
<a href="#l261.253"></a><span id="l261.253"> /**</span>
<a href="#l261.254"></a><span id="l261.254">  * Here is what the results label does:</span>
<a href="#l261.255"></a><span id="l261.255">  * - No filter active: results label is not visible.</span>
<a href="#l261.256"></a><span id="l261.256">  * - Filter active, messages: it says the number of messages.</span>
<a href="#l261.257"></a><span id="l261.257">  * - Filter active, no messages: it says there are no messages.</span>
<a href="#l261.258"></a><span id="l261.258">  *</span>
<a href="#l261.259"></a><span id="l261.259">  * Additional nuances:</span>
<a href="#l261.260"></a><span id="l261.260">  * - The count needs to update as the user deletes messages or what not.</span>
<a href="#l261.261"></a><span id="l261.261">  */</span>
<a href="#l261.262"></a><span id="l261.262" class="difflineminus">-function test_results_label() {</span>
<a href="#l261.263"></a><span id="l261.263" class="difflineplus">+add_task(function test_results_label() {</span>
<a href="#l261.264"></a><span id="l261.264">   let folder = create_folder(&quot;QuickFilterBarResultsLabel&quot;);</span>
<a href="#l261.265"></a><span id="l261.265">   let [setImmortal, setMortal, setGoldfish] = make_new_sets_in_folder(folder, [</span>
<a href="#l261.266"></a><span id="l261.266">     { count: 1 },</span>
<a href="#l261.267"></a><span id="l261.267">     { count: 1 },</span>
<a href="#l261.268"></a><span id="l261.268">     { count: 1 },</span>
<a href="#l261.269"></a><span id="l261.269">   ]);</span>
<a href="#l261.270"></a><span id="l261.270"> </span>
<a href="#l261.271"></a><span id="l261.271">   be_in_folder(folder);</span>
<a href="#l261.272"></a><span id="l261.272" class="difflineat">@@ -414,17 +424,25 @@ function test_results_label() {</span>
<a href="#l261.273"></a><span id="l261.273">   delete_message_set(setGoldfish);</span>
<a href="#l261.274"></a><span id="l261.274">   assert_results_label_count(2);</span>
<a href="#l261.275"></a><span id="l261.275"> </span>
<a href="#l261.276"></a><span id="l261.276">   delete_message_set(setMortal);</span>
<a href="#l261.277"></a><span id="l261.277">   assert_results_label_count(1);</span>
<a href="#l261.278"></a><span id="l261.278"> </span>
<a href="#l261.279"></a><span id="l261.279">   delete_message_set(setImmortal);</span>
<a href="#l261.280"></a><span id="l261.280">   assert_results_label_count(0);</span>
<a href="#l261.281"></a><span id="l261.281" class="difflineminus">-}</span>
<a href="#l261.282"></a><span id="l261.282" class="difflineplus">+  teardownTest();</span>
<a href="#l261.283"></a><span id="l261.283" class="difflineplus">+});</span>
<a href="#l261.284"></a><span id="l261.284"> </span>
<a href="#l261.285"></a><span id="l261.285"> function teardownTest() {</span>
<a href="#l261.286"></a><span id="l261.286">   clear_constraints();</span>
<a href="#l261.287"></a><span id="l261.287">   // make it visible if it's not</span>
<a href="#l261.288"></a><span id="l261.288">   if (mc.e(&quot;quick-filter-bar&quot;).collapsed) {</span>
<a href="#l261.289"></a><span id="l261.289">     toggle_quick_filter_bar();</span>
<a href="#l261.290"></a><span id="l261.290">   }</span>
<a href="#l261.291"></a><span id="l261.291" class="difflineplus">+</span>
<a href="#l261.292"></a><span id="l261.292" class="difflineplus">+  Assert.report(</span>
<a href="#l261.293"></a><span id="l261.293" class="difflineplus">+    false,</span>
<a href="#l261.294"></a><span id="l261.294" class="difflineplus">+    undefined,</span>
<a href="#l261.295"></a><span id="l261.295" class="difflineplus">+    undefined,</span>
<a href="#l261.296"></a><span id="l261.296" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l261.297"></a><span id="l261.297" class="difflineplus">+  );</span>
<a href="#l261.298"></a><span id="l261.298"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l262.1"></a><span id="l262.1">copy from mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js</span>
<a href="#l262.2"></a><span id="l262.2">copy to mail/test/browser/quick-filter-bar/browser_keyboardInterface.js</span>
<a href="#l262.3"></a><span id="l262.3" class="difflineminus">--- a/mail/test/mozmill/quick-filter-bar/test-keyboard-interface.js</span>
<a href="#l262.4"></a><span id="l262.4" class="difflineplus">+++ b/mail/test/browser/quick-filter-bar/browser_keyboardInterface.js</span>
<a href="#l262.5"></a><span id="l262.5" class="difflineat">@@ -29,36 +29,36 @@ var {</span>
<a href="#l262.6"></a><span id="l262.6">   toggle_boolean_constraints,</span>
<a href="#l262.7"></a><span id="l262.7">   toggle_quick_filter_bar,</span>
<a href="#l262.8"></a><span id="l262.8"> } = ChromeUtils.import(</span>
<a href="#l262.9"></a><span id="l262.9">   &quot;resource://testing-common/mozmill/QuickFilterBarHelpers.jsm&quot;</span>
<a href="#l262.10"></a><span id="l262.10"> );</span>
<a href="#l262.11"></a><span id="l262.11"> </span>
<a href="#l262.12"></a><span id="l262.12"> var folder;</span>
<a href="#l262.13"></a><span id="l262.13"> </span>
<a href="#l262.14"></a><span id="l262.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l262.15"></a><span id="l262.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l262.16"></a><span id="l262.16">   folder = create_folder(&quot;QuickFilterBarKeyboardInterface&quot;);</span>
<a href="#l262.17"></a><span id="l262.17">   // we need a message so we can select it so we can find in message</span>
<a href="#l262.18"></a><span id="l262.18">   make_new_sets_in_folder(folder, [{ count: 1 }]);</span>
<a href="#l262.19"></a><span id="l262.19">   be_in_folder(folder);</span>
<a href="#l262.20"></a><span id="l262.20" class="difflineminus">-}</span>
<a href="#l262.21"></a><span id="l262.21" class="difflineplus">+});</span>
<a href="#l262.22"></a><span id="l262.22"> </span>
<a href="#l262.23"></a><span id="l262.23"> /**</span>
<a href="#l262.24"></a><span id="l262.24">  * The rules for pressing escape:</span>
<a href="#l262.25"></a><span id="l262.25">  * - If there are any applied constraints:</span>
<a href="#l262.26"></a><span id="l262.26">  *   - If there is a 'most recent' constraint, it is relaxed and the 'most</span>
<a href="#l262.27"></a><span id="l262.27">  *     recent' field gets cleared, so that if escape gets hit again...</span>
<a href="#l262.28"></a><span id="l262.28">  *   - If there is no 'most recent' constraint, all constraints are cleared.</span>
<a href="#l262.29"></a><span id="l262.29">  * - If there are no applied constraints, we close the filter bar.</span>
<a href="#l262.30"></a><span id="l262.30">  *</span>
<a href="#l262.31"></a><span id="l262.31">  * We test these rules two ways:</span>
<a href="#l262.32"></a><span id="l262.32">  * 1) With the focus in the thread pane.</span>
<a href="#l262.33"></a><span id="l262.33">  * 2) With our focus in our text-box.</span>
<a href="#l262.34"></a><span id="l262.34">  */</span>
<a href="#l262.35"></a><span id="l262.35" class="difflineminus">-function test_escape_rules() {</span>
<a href="#l262.36"></a><span id="l262.36" class="difflineplus">+add_task(function test_escape_rules() {</span>
<a href="#l262.37"></a><span id="l262.37">   assert_quick_filter_bar_visible(true); // (precondition)</span>
<a href="#l262.38"></a><span id="l262.38"> </span>
<a href="#l262.39"></a><span id="l262.39">   // the common logic for each bit...</span>
<a href="#l262.40"></a><span id="l262.40">   function legwork() {</span>
<a href="#l262.41"></a><span id="l262.41">     // apply two...</span>
<a href="#l262.42"></a><span id="l262.42">     toggle_boolean_constraints(&quot;unread&quot;, &quot;starred&quot;, &quot;addrbook&quot;);</span>
<a href="#l262.43"></a><span id="l262.43">     assert_constraints_expressed({</span>
<a href="#l262.44"></a><span id="l262.44">       unread: true,</span>
<a href="#l262.45"></a><span id="l262.45" class="difflineat">@@ -105,43 +105,45 @@ function test_escape_rules() {</span>
<a href="#l262.46"></a><span id="l262.46">   mc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l262.47"></a><span id="l262.47">   assert_quick_filter_bar_visible(true);</span>
<a href="#l262.48"></a><span id="l262.48">   assert_constraints_expressed({});</span>
<a href="#l262.49"></a><span id="l262.49">   assert_filter_text(&quot;&quot;);</span>
<a href="#l262.50"></a><span id="l262.50"> </span>
<a href="#l262.51"></a><span id="l262.51">   // Next escape should close the box</span>
<a href="#l262.52"></a><span id="l262.52">   mc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l262.53"></a><span id="l262.53">   assert_quick_filter_bar_visible(false);</span>
<a href="#l262.54"></a><span id="l262.54" class="difflineminus">-}</span>
<a href="#l262.55"></a><span id="l262.55" class="difflineplus">+  teardownTest();</span>
<a href="#l262.56"></a><span id="l262.56" class="difflineplus">+});</span>
<a href="#l262.57"></a><span id="l262.57"> </span>
<a href="#l262.58"></a><span id="l262.58"> /**</span>
<a href="#l262.59"></a><span id="l262.59">  * It's fairly important that the gloda search widget eats escape when people</span>
<a href="#l262.60"></a><span id="l262.60">  * press escape in there.  Because gloda is disabled by default, we need to</span>
<a href="#l262.61"></a><span id="l262.61">  * viciously uncollapse it ourselves and then cleanup afterwards...</span>
<a href="#l262.62"></a><span id="l262.62">  */</span>
<a href="#l262.63"></a><span id="l262.63" class="difflineminus">-function test_escape_does_not_reach_us_from_gloda_search() {</span>
<a href="#l262.64"></a><span id="l262.64" class="difflineplus">+add_task(function test_escape_does_not_reach_us_from_gloda_search() {</span>
<a href="#l262.65"></a><span id="l262.65">   let glodaSearchWidget = mc.e(&quot;searchInput&quot;);</span>
<a href="#l262.66"></a><span id="l262.66">   try {</span>
<a href="#l262.67"></a><span id="l262.67">     // uncollapse and focus the gloda search widget</span>
<a href="#l262.68"></a><span id="l262.68">     glodaSearchWidget.removeAttribute(&quot;hidden&quot;);</span>
<a href="#l262.69"></a><span id="l262.69">     glodaSearchWidget.focus();</span>
<a href="#l262.70"></a><span id="l262.70"> </span>
<a href="#l262.71"></a><span id="l262.71">     mc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l262.72"></a><span id="l262.72"> </span>
<a href="#l262.73"></a><span id="l262.73">     assert_quick_filter_bar_visible(true);</span>
<a href="#l262.74"></a><span id="l262.74">   } finally {</span>
<a href="#l262.75"></a><span id="l262.75">     glodaSearchWidget.setAttribute(&quot;hidden&quot;, &quot;hidden&quot;);</span>
<a href="#l262.76"></a><span id="l262.76">   }</span>
<a href="#l262.77"></a><span id="l262.77" class="difflineminus">-}</span>
<a href="#l262.78"></a><span id="l262.78" class="difflineplus">+  teardownTest();</span>
<a href="#l262.79"></a><span id="l262.79" class="difflineplus">+});</span>
<a href="#l262.80"></a><span id="l262.80"> </span>
<a href="#l262.81"></a><span id="l262.81"> /**</span>
<a href="#l262.82"></a><span id="l262.82">  * Control-shift-k expands the quick filter bar when it's collapsed. When</span>
<a href="#l262.83"></a><span id="l262.83">  * already expanded, it focuses the text box and selects its text.</span>
<a href="#l262.84"></a><span id="l262.84">  */</span>
<a href="#l262.85"></a><span id="l262.85" class="difflineminus">-function test_control_shift_k_shows_quick_filter_bar() {</span>
<a href="#l262.86"></a><span id="l262.86" class="difflineplus">+add_task(function test_control_shift_k_shows_quick_filter_bar() {</span>
<a href="#l262.87"></a><span id="l262.87">   let dispatcha = mc.window.document.commandDispatcher;</span>
<a href="#l262.88"></a><span id="l262.88">   let qfbTextbox = mc.e(&quot;qfb-qs-textbox&quot;);</span>
<a href="#l262.89"></a><span id="l262.89"> </span>
<a href="#l262.90"></a><span id="l262.90">   // focus explicitly on the thread pane so we know where the focus is.</span>
<a href="#l262.91"></a><span id="l262.91">   mc.e(&quot;threadTree&quot;).focus();</span>
<a href="#l262.92"></a><span id="l262.92">   // select a message so we can find in message</span>
<a href="#l262.93"></a><span id="l262.93">   select_click_row(0);</span>
<a href="#l262.94"></a><span id="l262.94"> </span>
<a href="#l262.95"></a><span id="l262.95" class="difflineat">@@ -174,17 +176,25 @@ function test_control_shift_k_shows_quic</span>
<a href="#l262.96"></a><span id="l262.96">   mc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l262.97"></a><span id="l262.97">   assert_quick_filter_bar_visible(true);</span>
<a href="#l262.98"></a><span id="l262.98">   assert_filter_text(&quot;&quot;);</span>
<a href="#l262.99"></a><span id="l262.99"> </span>
<a href="#l262.100"></a><span id="l262.100">   // hit escape one more time and make sure we finally collapsed the quick</span>
<a href="#l262.101"></a><span id="l262.101">   // filter bar.</span>
<a href="#l262.102"></a><span id="l262.102">   mc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l262.103"></a><span id="l262.103">   assert_quick_filter_bar_visible(false);</span>
<a href="#l262.104"></a><span id="l262.104" class="difflineminus">-}</span>
<a href="#l262.105"></a><span id="l262.105" class="difflineplus">+  teardownTest();</span>
<a href="#l262.106"></a><span id="l262.106" class="difflineplus">+});</span>
<a href="#l262.107"></a><span id="l262.107"> </span>
<a href="#l262.108"></a><span id="l262.108"> function teardownTest() {</span>
<a href="#l262.109"></a><span id="l262.109">   clear_constraints();</span>
<a href="#l262.110"></a><span id="l262.110">   // make it visible if it's not</span>
<a href="#l262.111"></a><span id="l262.111">   if (mc.e(&quot;quick-filter-bar&quot;).collapsed) {</span>
<a href="#l262.112"></a><span id="l262.112">     toggle_quick_filter_bar();</span>
<a href="#l262.113"></a><span id="l262.113">   }</span>
<a href="#l262.114"></a><span id="l262.114" class="difflineplus">+</span>
<a href="#l262.115"></a><span id="l262.115" class="difflineplus">+  Assert.report(</span>
<a href="#l262.116"></a><span id="l262.116" class="difflineplus">+    false,</span>
<a href="#l262.117"></a><span id="l262.117" class="difflineplus">+    undefined,</span>
<a href="#l262.118"></a><span id="l262.118" class="difflineplus">+    undefined,</span>
<a href="#l262.119"></a><span id="l262.119" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l262.120"></a><span id="l262.120" class="difflineplus">+  );</span>
<a href="#l262.121"></a><span id="l262.121"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l263.1"></a><span id="l263.1">copy from mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js</span>
<a href="#l263.2"></a><span id="l263.2">copy to mail/test/browser/quick-filter-bar/browser_stickyFilterLogic.js</span>
<a href="#l263.3"></a><span id="l263.3" class="difflineminus">--- a/mail/test/mozmill/quick-filter-bar/test-sticky-filter-logic.js</span>
<a href="#l263.4"></a><span id="l263.4" class="difflineplus">+++ b/mail/test/browser/quick-filter-bar/browser_stickyFilterLogic.js</span>
<a href="#l263.5"></a><span id="l263.5" class="difflineat">@@ -31,17 +31,17 @@ var {</span>
<a href="#l263.6"></a><span id="l263.6">   toggle_tag_constraints,</span>
<a href="#l263.7"></a><span id="l263.7"> } = ChromeUtils.import(</span>
<a href="#l263.8"></a><span id="l263.8">   &quot;resource://testing-common/mozmill/QuickFilterBarHelpers.jsm&quot;</span>
<a href="#l263.9"></a><span id="l263.9"> );</span>
<a href="#l263.10"></a><span id="l263.10"> </span>
<a href="#l263.11"></a><span id="l263.11"> /**</span>
<a href="#l263.12"></a><span id="l263.12">  * Persist the current settings through folder change and inherit into a new tab.</span>
<a href="#l263.13"></a><span id="l263.13">  */</span>
<a href="#l263.14"></a><span id="l263.14" class="difflineminus">-function test_sticky_basics() {</span>
<a href="#l263.15"></a><span id="l263.15" class="difflineplus">+add_task(function test_sticky_basics() {</span>
<a href="#l263.16"></a><span id="l263.16">   let folderOne = create_folder(&quot;QuickFilterBarStickyBasics1&quot;);</span>
<a href="#l263.17"></a><span id="l263.17">   let [unreadOne, readOne] = make_new_sets_in_folder(folderOne, [</span>
<a href="#l263.18"></a><span id="l263.18">     { count: 1 },</span>
<a href="#l263.19"></a><span id="l263.19">     { count: 1 },</span>
<a href="#l263.20"></a><span id="l263.20">   ]);</span>
<a href="#l263.21"></a><span id="l263.21">   readOne.setRead(true);</span>
<a href="#l263.22"></a><span id="l263.22"> </span>
<a href="#l263.23"></a><span id="l263.23">   let folderTwo = create_folder(&quot;QuickFilterBarStickyBasics2&quot;);</span>
<a href="#l263.24"></a><span id="l263.24" class="difflineat">@@ -62,31 +62,32 @@ function test_sticky_basics() {</span>
<a href="#l263.25"></a><span id="l263.25">   assert_messages_in_view(unreadTwo);</span>
<a href="#l263.26"></a><span id="l263.26"> </span>
<a href="#l263.27"></a><span id="l263.27">   // -- inherit into a new folder</span>
<a href="#l263.28"></a><span id="l263.28">   let tabB = open_folder_in_new_tab(folderOne);</span>
<a href="#l263.29"></a><span id="l263.29">   assert_constraints_expressed({ sticky: true, unread: true });</span>
<a href="#l263.30"></a><span id="l263.30">   assert_messages_in_view(unreadOne);</span>
<a href="#l263.31"></a><span id="l263.31"> </span>
<a href="#l263.32"></a><span id="l263.32">   close_tab(tabB);</span>
<a href="#l263.33"></a><span id="l263.33" class="difflineminus">-}</span>
<a href="#l263.34"></a><span id="l263.34" class="difflineplus">+  teardownTest();</span>
<a href="#l263.35"></a><span id="l263.35" class="difflineplus">+});</span>
<a href="#l263.36"></a><span id="l263.36"> </span>
<a href="#l263.37"></a><span id="l263.37"> /**</span>
<a href="#l263.38"></a><span id="l263.38">  * The semantics of sticky tags are not obvious; there were decisions involved:</span>
<a href="#l263.39"></a><span id="l263.39">  * - If the user has the tag facet enabled but not explicitly filtered on</span>
<a href="#l263.40"></a><span id="l263.40">  *   specific tags then we propagate just &quot;true&quot; to cause the faceting to</span>
<a href="#l263.41"></a><span id="l263.41">  *   run in the new folder.  In other words, the list of displayed tags should</span>
<a href="#l263.42"></a><span id="l263.42">  *   change.</span>
<a href="#l263.43"></a><span id="l263.43">  * - If the user has filtered on specific tags, then we do and must propagate</span>
<a href="#l263.44"></a><span id="l263.44">  *   the list of tags.</span>
<a href="#l263.45"></a><span id="l263.45">  *</span>
<a href="#l263.46"></a><span id="l263.46">  * We only need to do folder changes from here on out since the logic is</span>
<a href="#l263.47"></a><span id="l263.47">  *  identical (and tested to be identical in |test_sticky_basics|).</span>
<a href="#l263.48"></a><span id="l263.48">  */</span>
<a href="#l263.49"></a><span id="l263.49" class="difflineminus">-function test_sticky_tags() {</span>
<a href="#l263.50"></a><span id="l263.50" class="difflineplus">+add_task(function test_sticky_tags() {</span>
<a href="#l263.51"></a><span id="l263.51">   let folderOne = create_folder(&quot;QuickFilterBarStickyTags1&quot;);</span>
<a href="#l263.52"></a><span id="l263.52">   let folderTwo = create_folder(&quot;QuickFilterBarStickyTags2&quot;);</span>
<a href="#l263.53"></a><span id="l263.53">   const tagA = &quot;$label1&quot;,</span>
<a href="#l263.54"></a><span id="l263.54">     tagB = &quot;$label2&quot;,</span>
<a href="#l263.55"></a><span id="l263.55">     tagC = &quot;$label3&quot;;</span>
<a href="#l263.56"></a><span id="l263.56">   let [, setTagA1, setTagB1] = make_new_sets_in_folder(folderOne, [</span>
<a href="#l263.57"></a><span id="l263.57">     { count: 1 },</span>
<a href="#l263.58"></a><span id="l263.58">     { count: 1 },</span>
<a href="#l263.59"></a><span id="l263.59" class="difflineat">@@ -118,34 +119,43 @@ function test_sticky_tags() {</span>
<a href="#l263.60"></a><span id="l263.60">   assert_tag_constraints_visible(tagA, tagC);</span>
<a href="#l263.61"></a><span id="l263.61">   assert_messages_in_view([setTagA1]);</span>
<a href="#l263.62"></a><span id="l263.62"> </span>
<a href="#l263.63"></a><span id="l263.63">   // -- if we turn off sticky, make sure that things clear when we change</span>
<a href="#l263.64"></a><span id="l263.64">   //     folders.  (we had a bug with this before.)</span>
<a href="#l263.65"></a><span id="l263.65">   toggle_boolean_constraints(&quot;sticky&quot;);</span>
<a href="#l263.66"></a><span id="l263.66">   be_in_folder(folderTwo);</span>
<a href="#l263.67"></a><span id="l263.67">   assert_constraints_expressed({});</span>
<a href="#l263.68"></a><span id="l263.68" class="difflineminus">-}</span>
<a href="#l263.69"></a><span id="l263.69" class="difflineplus">+  teardownTest();</span>
<a href="#l263.70"></a><span id="l263.70" class="difflineplus">+});</span>
<a href="#l263.71"></a><span id="l263.71"> </span>
<a href="#l263.72"></a><span id="l263.72"> /**</span>
<a href="#l263.73"></a><span id="l263.73">  * All we are testing propagating is the text value; the text states are always</span>
<a href="#l263.74"></a><span id="l263.74">  *  propagated and that is tested in test-filter-logic.js by</span>
<a href="#l263.75"></a><span id="l263.75">  *  |test_filter_text_constraints_propagate|.</span>
<a href="#l263.76"></a><span id="l263.76">  */</span>
<a href="#l263.77"></a><span id="l263.77" class="difflineminus">-function test_sticky_text() {</span>
<a href="#l263.78"></a><span id="l263.78" class="difflineplus">+add_task(function test_sticky_text() {</span>
<a href="#l263.79"></a><span id="l263.79">   let folderOne = create_folder(&quot;QuickFilterBarStickyText1&quot;);</span>
<a href="#l263.80"></a><span id="l263.80">   let folderTwo = create_folder(&quot;QuickFilterBarStickyText2&quot;);</span>
<a href="#l263.81"></a><span id="l263.81"> </span>
<a href="#l263.82"></a><span id="l263.82">   be_in_folder(folderOne);</span>
<a href="#l263.83"></a><span id="l263.83">   toggle_boolean_constraints(&quot;sticky&quot;);</span>
<a href="#l263.84"></a><span id="l263.84">   set_filter_text(&quot;foo&quot;);</span>
<a href="#l263.85"></a><span id="l263.85"> </span>
<a href="#l263.86"></a><span id="l263.86">   be_in_folder(folderTwo);</span>
<a href="#l263.87"></a><span id="l263.87">   assert_filter_text(&quot;foo&quot;);</span>
<a href="#l263.88"></a><span id="l263.88" class="difflineminus">-}</span>
<a href="#l263.89"></a><span id="l263.89" class="difflineplus">+  teardownTest();</span>
<a href="#l263.90"></a><span id="l263.90" class="difflineplus">+});</span>
<a href="#l263.91"></a><span id="l263.91"> </span>
<a href="#l263.92"></a><span id="l263.92"> function teardownTest() {</span>
<a href="#l263.93"></a><span id="l263.93">   clear_constraints();</span>
<a href="#l263.94"></a><span id="l263.94">   // make it visible if it's not</span>
<a href="#l263.95"></a><span id="l263.95">   if (mc.e(&quot;quick-filter-bar&quot;).collapsed) {</span>
<a href="#l263.96"></a><span id="l263.96">     toggle_quick_filter_bar();</span>
<a href="#l263.97"></a><span id="l263.97">   }</span>
<a href="#l263.98"></a><span id="l263.98" class="difflineplus">+</span>
<a href="#l263.99"></a><span id="l263.99" class="difflineplus">+  Assert.report(</span>
<a href="#l263.100"></a><span id="l263.100" class="difflineplus">+    false,</span>
<a href="#l263.101"></a><span id="l263.101" class="difflineplus">+    undefined,</span>
<a href="#l263.102"></a><span id="l263.102" class="difflineplus">+    undefined,</span>
<a href="#l263.103"></a><span id="l263.103" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l263.104"></a><span id="l263.104" class="difflineplus">+  );</span>
<a href="#l263.105"></a><span id="l263.105"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l264.1"></a><span id="l264.1">copy from mail/test/mozmill/quick-filter-bar/test-toggle-bar.js</span>
<a href="#l264.2"></a><span id="l264.2">copy to mail/test/browser/quick-filter-bar/browser_toggleBar.js</span>
<a href="#l264.3"></a><span id="l264.3" class="difflineminus">--- a/mail/test/mozmill/quick-filter-bar/test-toggle-bar.js</span>
<a href="#l264.4"></a><span id="l264.4" class="difflineplus">+++ b/mail/test/browser/quick-filter-bar/browser_toggleBar.js</span>
<a href="#l264.5"></a><span id="l264.5" class="difflineat">@@ -27,77 +27,89 @@ var {</span>
<a href="#l264.6"></a><span id="l264.6">   toggle_quick_filter_bar,</span>
<a href="#l264.7"></a><span id="l264.7"> } = ChromeUtils.import(</span>
<a href="#l264.8"></a><span id="l264.8">   &quot;resource://testing-common/mozmill/QuickFilterBarHelpers.jsm&quot;</span>
<a href="#l264.9"></a><span id="l264.9"> );</span>
<a href="#l264.10"></a><span id="l264.10"> </span>
<a href="#l264.11"></a><span id="l264.11"> var folder;</span>
<a href="#l264.12"></a><span id="l264.12"> var setUnstarred, setStarred;</span>
<a href="#l264.13"></a><span id="l264.13"> </span>
<a href="#l264.14"></a><span id="l264.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l264.15"></a><span id="l264.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l264.16"></a><span id="l264.16">   folder = create_folder(&quot;QuickFilterBarToggleBar&quot;);</span>
<a href="#l264.17"></a><span id="l264.17">   [setUnstarred, setStarred] = make_new_sets_in_folder(folder, [</span>
<a href="#l264.18"></a><span id="l264.18">     { count: 1 },</span>
<a href="#l264.19"></a><span id="l264.19">     { count: 1 },</span>
<a href="#l264.20"></a><span id="l264.20">   ]);</span>
<a href="#l264.21"></a><span id="l264.21">   setStarred.setStarred(true);</span>
<a href="#l264.22"></a><span id="l264.22" class="difflineminus">-}</span>
<a href="#l264.23"></a><span id="l264.23" class="difflineplus">+});</span>
<a href="#l264.24"></a><span id="l264.24"> </span>
<a href="#l264.25"></a><span id="l264.25" class="difflineminus">-function test_hidden_on_account_central() {</span>
<a href="#l264.26"></a><span id="l264.26" class="difflineplus">+add_task(function test_hidden_on_account_central() {</span>
<a href="#l264.27"></a><span id="l264.27">   be_in_folder(folder.rootFolder);</span>
<a href="#l264.28"></a><span id="l264.28">   assert_quick_filter_button_enabled(false);</span>
<a href="#l264.29"></a><span id="l264.29">   assert_quick_filter_bar_visible(false);</span>
<a href="#l264.30"></a><span id="l264.30" class="difflineminus">-}</span>
<a href="#l264.31"></a><span id="l264.31" class="difflineplus">+  teardownTest();</span>
<a href="#l264.32"></a><span id="l264.32" class="difflineplus">+});</span>
<a href="#l264.33"></a><span id="l264.33"> </span>
<a href="#l264.34"></a><span id="l264.34" class="difflineminus">-function test_visible_by_default() {</span>
<a href="#l264.35"></a><span id="l264.35" class="difflineplus">+add_task(function test_visible_by_default() {</span>
<a href="#l264.36"></a><span id="l264.36">   be_in_folder(folder);</span>
<a href="#l264.37"></a><span id="l264.37">   assert_quick_filter_button_enabled(true);</span>
<a href="#l264.38"></a><span id="l264.38">   assert_quick_filter_bar_visible(true);</span>
<a href="#l264.39"></a><span id="l264.39" class="difflineminus">-}</span>
<a href="#l264.40"></a><span id="l264.40" class="difflineplus">+  teardownTest();</span>
<a href="#l264.41"></a><span id="l264.41" class="difflineplus">+});</span>
<a href="#l264.42"></a><span id="l264.42"> </span>
<a href="#l264.43"></a><span id="l264.43" class="difflineminus">-function test_direct_toggle() {</span>
<a href="#l264.44"></a><span id="l264.44" class="difflineplus">+add_task(function test_direct_toggle() {</span>
<a href="#l264.45"></a><span id="l264.45">   assert_quick_filter_bar_visible(true);</span>
<a href="#l264.46"></a><span id="l264.46">   toggle_quick_filter_bar();</span>
<a href="#l264.47"></a><span id="l264.47">   assert_quick_filter_bar_visible(false);</span>
<a href="#l264.48"></a><span id="l264.48">   toggle_quick_filter_bar();</span>
<a href="#l264.49"></a><span id="l264.49">   assert_quick_filter_bar_visible(true);</span>
<a href="#l264.50"></a><span id="l264.50" class="difflineminus">-}</span>
<a href="#l264.51"></a><span id="l264.51" class="difflineplus">+  teardownTest();</span>
<a href="#l264.52"></a><span id="l264.52" class="difflineplus">+});</span>
<a href="#l264.53"></a><span id="l264.53"> </span>
<a href="#l264.54"></a><span id="l264.54" class="difflineminus">-function test_control_shift_k_triggers_display() {</span>
<a href="#l264.55"></a><span id="l264.55" class="difflineplus">+add_task(function test_control_shift_k_triggers_display() {</span>
<a href="#l264.56"></a><span id="l264.56">   // hide it</span>
<a href="#l264.57"></a><span id="l264.57">   toggle_quick_filter_bar();</span>
<a href="#l264.58"></a><span id="l264.58">   assert_quick_filter_bar_visible(false);</span>
<a href="#l264.59"></a><span id="l264.59"> </span>
<a href="#l264.60"></a><span id="l264.60">   // focus explicitly on the thread pane so we know where the focus is.</span>
<a href="#l264.61"></a><span id="l264.61">   mc.e(&quot;threadTree&quot;).focus();</span>
<a href="#l264.62"></a><span id="l264.62"> </span>
<a href="#l264.63"></a><span id="l264.63">   // hit control-shift-k</span>
<a href="#l264.64"></a><span id="l264.64">   mc.keypress(null, &quot;k&quot;, { accelKey: true, shiftKey: true });</span>
<a href="#l264.65"></a><span id="l264.65"> </span>
<a href="#l264.66"></a><span id="l264.66">   // now we should be visible again!</span>
<a href="#l264.67"></a><span id="l264.67">   assert_quick_filter_bar_visible(true);</span>
<a href="#l264.68"></a><span id="l264.68" class="difflineminus">-}</span>
<a href="#l264.69"></a><span id="l264.69" class="difflineplus">+  teardownTest();</span>
<a href="#l264.70"></a><span id="l264.70" class="difflineplus">+});</span>
<a href="#l264.71"></a><span id="l264.71"> </span>
<a href="#l264.72"></a><span id="l264.72" class="difflineminus">-function test_constraints_disappear_when_collapsed() {</span>
<a href="#l264.73"></a><span id="l264.73" class="difflineplus">+add_task(function test_constraints_disappear_when_collapsed() {</span>
<a href="#l264.74"></a><span id="l264.74">   // set some constraints</span>
<a href="#l264.75"></a><span id="l264.75">   toggle_boolean_constraints(&quot;starred&quot;);</span>
<a href="#l264.76"></a><span id="l264.76">   assert_constraints_expressed({ starred: true });</span>
<a href="#l264.77"></a><span id="l264.77">   assert_messages_in_view(setStarred);</span>
<a href="#l264.78"></a><span id="l264.78"> </span>
<a href="#l264.79"></a><span id="l264.79">   // collapse, now we should see them all again!</span>
<a href="#l264.80"></a><span id="l264.80">   toggle_quick_filter_bar();</span>
<a href="#l264.81"></a><span id="l264.81">   assert_messages_in_view([setUnstarred, setStarred]);</span>
<a href="#l264.82"></a><span id="l264.82"> </span>
<a href="#l264.83"></a><span id="l264.83">   // uncollapse, we should still see them all!</span>
<a href="#l264.84"></a><span id="l264.84">   toggle_quick_filter_bar();</span>
<a href="#l264.85"></a><span id="l264.85">   assert_messages_in_view([setUnstarred, setStarred]);</span>
<a href="#l264.86"></a><span id="l264.86"> </span>
<a href="#l264.87"></a><span id="l264.87">   // there better be no constraints left!</span>
<a href="#l264.88"></a><span id="l264.88">   assert_constraints_expressed({});</span>
<a href="#l264.89"></a><span id="l264.89" class="difflineminus">-}</span>
<a href="#l264.90"></a><span id="l264.90" class="difflineplus">+  teardownTest();</span>
<a href="#l264.91"></a><span id="l264.91" class="difflineplus">+});</span>
<a href="#l264.92"></a><span id="l264.92"> </span>
<a href="#l264.93"></a><span id="l264.93"> function teardownTest() {</span>
<a href="#l264.94"></a><span id="l264.94">   clear_constraints();</span>
<a href="#l264.95"></a><span id="l264.95">   // make it visible if it's not</span>
<a href="#l264.96"></a><span id="l264.96">   if (mc.e(&quot;quick-filter-bar&quot;).collapsed) {</span>
<a href="#l264.97"></a><span id="l264.97">     toggle_quick_filter_bar();</span>
<a href="#l264.98"></a><span id="l264.98">   }</span>
<a href="#l264.99"></a><span id="l264.99" class="difflineplus">+</span>
<a href="#l264.100"></a><span id="l264.100" class="difflineplus">+  Assert.report(</span>
<a href="#l264.101"></a><span id="l264.101" class="difflineplus">+    false,</span>
<a href="#l264.102"></a><span id="l264.102" class="difflineplus">+    undefined,</span>
<a href="#l264.103"></a><span id="l264.103" class="difflineplus">+    undefined,</span>
<a href="#l264.104"></a><span id="l264.104" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l264.105"></a><span id="l264.105" class="difflineplus">+  );</span>
<a href="#l264.106"></a><span id="l264.106"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l265.1"></a><span id="l265.1">new file mode 100644</span>
<a href="#l265.2"></a><span id="l265.2" class="difflineminus">--- /dev/null</span>
<a href="#l265.3"></a><span id="l265.3" class="difflineplus">+++ b/mail/test/browser/search-window/browser.ini</span>
<a href="#l265.4"></a><span id="l265.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l265.5"></a><span id="l265.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l265.6"></a><span id="l265.6" class="difflineplus">+prefs =</span>
<a href="#l265.7"></a><span id="l265.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l265.8"></a><span id="l265.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l265.9"></a><span id="l265.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l265.10"></a><span id="l265.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l265.11"></a><span id="l265.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l265.12"></a><span id="l265.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l265.13"></a><span id="l265.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l265.14"></a><span id="l265.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l265.15"></a><span id="l265.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l265.16"></a><span id="l265.16" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l265.17"></a><span id="l265.17" class="difflineplus">+</span>
<a href="#l265.18"></a><span id="l265.18" class="difflineplus">+[browser_multipleSearchWindows.js]</span>
<a href="#l265.19"></a><span id="l265.19" class="difflineplus">+[browser_rightClickToOpenSearchWindow.js]</span>
<a href="#l265.20"></a><span id="l265.20" class="difflineplus">+[browser_searchWindow.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l266.1"></a><span id="l266.1">copy from mail/test/mozmill/search-window/test-multiple-search-windows.js</span>
<a href="#l266.2"></a><span id="l266.2">copy to mail/test/browser/search-window/browser_multipleSearchWindows.js</span>
<a href="#l266.3"></a><span id="l266.3" class="difflineminus">--- a/mail/test/mozmill/search-window/test-multiple-search-windows.js</span>
<a href="#l266.4"></a><span id="l266.4" class="difflineplus">+++ b/mail/test/browser/search-window/browser_multipleSearchWindows.js</span>
<a href="#l266.5"></a><span id="l266.5" class="difflineat">@@ -16,25 +16,25 @@ var {</span>
<a href="#l266.6"></a><span id="l266.6">   assert_search_window_folder_displayed,</span>
<a href="#l266.7"></a><span id="l266.7">   close_search_window,</span>
<a href="#l266.8"></a><span id="l266.8">   open_search_window,</span>
<a href="#l266.9"></a><span id="l266.9"> } = ChromeUtils.import(</span>
<a href="#l266.10"></a><span id="l266.10">   &quot;resource://testing-common/mozmill/SearchWindowHelpers.jsm&quot;</span>
<a href="#l266.11"></a><span id="l266.11"> );</span>
<a href="#l266.12"></a><span id="l266.12"> </span>
<a href="#l266.13"></a><span id="l266.13"> var folderA, folderB;</span>
<a href="#l266.14"></a><span id="l266.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l266.15"></a><span id="l266.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l266.16"></a><span id="l266.16">   folderA = create_folder(&quot;MultipleSearchWindowsA&quot;);</span>
<a href="#l266.17"></a><span id="l266.17">   folderB = create_folder(&quot;MultipleSearchWindowsB&quot;);</span>
<a href="#l266.18"></a><span id="l266.18" class="difflineminus">-}</span>
<a href="#l266.19"></a><span id="l266.19" class="difflineplus">+});</span>
<a href="#l266.20"></a><span id="l266.20"> </span>
<a href="#l266.21"></a><span id="l266.21"> /**</span>
<a href="#l266.22"></a><span id="l266.22">  * Test bringing up multiple search windows for multiple folders.</span>
<a href="#l266.23"></a><span id="l266.23">  */</span>
<a href="#l266.24"></a><span id="l266.24" class="difflineminus">-function test_show_multiple_search_windows_for_multiple_folders() {</span>
<a href="#l266.25"></a><span id="l266.25" class="difflineplus">+add_task(function test_show_multiple_search_windows_for_multiple_folders() {</span>
<a href="#l266.26"></a><span id="l266.26">   be_in_folder(folderA);</span>
<a href="#l266.27"></a><span id="l266.27"> </span>
<a href="#l266.28"></a><span id="l266.28">   let swcA = open_search_window();</span>
<a href="#l266.29"></a><span id="l266.29">   // Check whether the window's displaying the right folder</span>
<a href="#l266.30"></a><span id="l266.30">   assert_search_window_folder_displayed(swcA, folderA);</span>
<a href="#l266.31"></a><span id="l266.31"> </span>
<a href="#l266.32"></a><span id="l266.32">   mc.window.focus();</span>
<a href="#l266.33"></a><span id="l266.33">   be_in_folder(folderB);</span>
<a href="#l266.34"></a><span id="l266.34" class="difflineat">@@ -43,31 +43,38 @@ function test_show_multiple_search_windo</span>
<a href="#l266.35"></a><span id="l266.35"> </span>
<a href="#l266.36"></a><span id="l266.36">   // Now check whether both windows are displaying the right folders</span>
<a href="#l266.37"></a><span id="l266.37">   assert_search_window_folder_displayed(swcA, folderA);</span>
<a href="#l266.38"></a><span id="l266.38">   assert_search_window_folder_displayed(swcB, folderB);</span>
<a href="#l266.39"></a><span id="l266.39"> </span>
<a href="#l266.40"></a><span id="l266.40">   // Clean up, close both windows</span>
<a href="#l266.41"></a><span id="l266.41">   close_search_window(swcA);</span>
<a href="#l266.42"></a><span id="l266.42">   close_search_window(swcB);</span>
<a href="#l266.43"></a><span id="l266.43" class="difflineminus">-}</span>
<a href="#l266.44"></a><span id="l266.44" class="difflineplus">+});</span>
<a href="#l266.45"></a><span id="l266.45"> </span>
<a href="#l266.46"></a><span id="l266.46"> /**</span>
<a href="#l266.47"></a><span id="l266.47">  * Test bringing up multiple search windows for the same folder.</span>
<a href="#l266.48"></a><span id="l266.48">  */</span>
<a href="#l266.49"></a><span id="l266.49" class="difflineminus">-function test_show_multiple_search_windows_for_the_same_folder() {</span>
<a href="#l266.50"></a><span id="l266.50" class="difflineplus">+add_task(function test_show_multiple_search_windows_for_the_same_folder() {</span>
<a href="#l266.51"></a><span id="l266.51">   be_in_folder(folderA);</span>
<a href="#l266.52"></a><span id="l266.52">   let swc1 = open_search_window();</span>
<a href="#l266.53"></a><span id="l266.53">   // Check whether the window's displaying the right folder</span>
<a href="#l266.54"></a><span id="l266.54">   assert_search_window_folder_displayed(swc1, folderA);</span>
<a href="#l266.55"></a><span id="l266.55"> </span>
<a href="#l266.56"></a><span id="l266.56">   mc.window.focus();</span>
<a href="#l266.57"></a><span id="l266.57">   // This should time out if a second search window isn't opened</span>
<a href="#l266.58"></a><span id="l266.58">   let swc2 = open_search_window();</span>
<a href="#l266.59"></a><span id="l266.59"> </span>
<a href="#l266.60"></a><span id="l266.60">   // Now check whether both windows are displaying the right folders</span>
<a href="#l266.61"></a><span id="l266.61">   assert_search_window_folder_displayed(swc1, folderA);</span>
<a href="#l266.62"></a><span id="l266.62">   assert_search_window_folder_displayed(swc2, folderA);</span>
<a href="#l266.63"></a><span id="l266.63"> </span>
<a href="#l266.64"></a><span id="l266.64">   // Clean up, close both windows</span>
<a href="#l266.65"></a><span id="l266.65">   close_search_window(swc1);</span>
<a href="#l266.66"></a><span id="l266.66">   close_search_window(swc2);</span>
<a href="#l266.67"></a><span id="l266.67" class="difflineminus">-}</span>
<a href="#l266.68"></a><span id="l266.68" class="difflineplus">+</span>
<a href="#l266.69"></a><span id="l266.69" class="difflineplus">+  Assert.report(</span>
<a href="#l266.70"></a><span id="l266.70" class="difflineplus">+    false,</span>
<a href="#l266.71"></a><span id="l266.71" class="difflineplus">+    undefined,</span>
<a href="#l266.72"></a><span id="l266.72" class="difflineplus">+    undefined,</span>
<a href="#l266.73"></a><span id="l266.73" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l266.74"></a><span id="l266.74" class="difflineplus">+  );</span>
<a href="#l266.75"></a><span id="l266.75" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l267.1"></a><span id="l267.1">copy from mail/test/mozmill/search-window/test-right-click-to-open-search-window.js</span>
<a href="#l267.2"></a><span id="l267.2">copy to mail/test/browser/search-window/browser_rightClickToOpenSearchWindow.js</span>
<a href="#l267.3"></a><span id="l267.3" class="difflineminus">--- a/mail/test/mozmill/search-window/test-right-click-to-open-search-window.js</span>
<a href="#l267.4"></a><span id="l267.4" class="difflineplus">+++ b/mail/test/browser/search-window/browser_rightClickToOpenSearchWindow.js</span>
<a href="#l267.5"></a><span id="l267.5" class="difflineat">@@ -19,53 +19,60 @@ var {</span>
<a href="#l267.6"></a><span id="l267.6">   close_search_window,</span>
<a href="#l267.7"></a><span id="l267.7">   open_search_window,</span>
<a href="#l267.8"></a><span id="l267.8">   open_search_window_from_context_menu,</span>
<a href="#l267.9"></a><span id="l267.9"> } = ChromeUtils.import(</span>
<a href="#l267.10"></a><span id="l267.10">   &quot;resource://testing-common/mozmill/SearchWindowHelpers.jsm&quot;</span>
<a href="#l267.11"></a><span id="l267.11"> );</span>
<a href="#l267.12"></a><span id="l267.12"> </span>
<a href="#l267.13"></a><span id="l267.13"> var folderA, folderB;</span>
<a href="#l267.14"></a><span id="l267.14" class="difflineminus">-function setupModule(module) {</span>
<a href="#l267.15"></a><span id="l267.15" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l267.16"></a><span id="l267.16">   folderA = create_folder(&quot;RightClickToOpenSearchWindowA&quot;);</span>
<a href="#l267.17"></a><span id="l267.17">   folderB = create_folder(&quot;RightClickToOpenSearchWindowB&quot;);</span>
<a href="#l267.18"></a><span id="l267.18" class="difflineminus">-}</span>
<a href="#l267.19"></a><span id="l267.19" class="difflineplus">+});</span>
<a href="#l267.20"></a><span id="l267.20"> </span>
<a href="#l267.21"></a><span id="l267.21"> /**</span>
<a href="#l267.22"></a><span id="l267.22">  * Test opening a search window while nothing is selected.</span>
<a href="#l267.23"></a><span id="l267.23">  */</span>
<a href="#l267.24"></a><span id="l267.24" class="difflineminus">-function test_open_search_window_with_nothing_selected() {</span>
<a href="#l267.25"></a><span id="l267.25" class="difflineplus">+add_task(function test_open_search_window_with_nothing_selected() {</span>
<a href="#l267.26"></a><span id="l267.26">   // Make sure the folders we need are visible</span>
<a href="#l267.27"></a><span id="l267.27">   enter_folder(folderB);</span>
<a href="#l267.28"></a><span id="l267.28">   select_no_folders();</span>
<a href="#l267.29"></a><span id="l267.29">   assert_no_folders_selected();</span>
<a href="#l267.30"></a><span id="l267.30"> </span>
<a href="#l267.31"></a><span id="l267.31">   let swc = open_search_window_from_context_menu(folderA);</span>
<a href="#l267.32"></a><span id="l267.32">   assert_search_window_folder_displayed(swc, folderA);</span>
<a href="#l267.33"></a><span id="l267.33"> </span>
<a href="#l267.34"></a><span id="l267.34">   close_search_window(swc);</span>
<a href="#l267.35"></a><span id="l267.35" class="difflineminus">-}</span>
<a href="#l267.36"></a><span id="l267.36" class="difflineplus">+});</span>
<a href="#l267.37"></a><span id="l267.37"> </span>
<a href="#l267.38"></a><span id="l267.38"> /**</span>
<a href="#l267.39"></a><span id="l267.39">  * Test opening a search window while the same folder is selected.</span>
<a href="#l267.40"></a><span id="l267.40">  */</span>
<a href="#l267.41"></a><span id="l267.41" class="difflineminus">-function test_open_search_window_with_existing_single_selection() {</span>
<a href="#l267.42"></a><span id="l267.42" class="difflineplus">+add_task(function test_open_search_window_with_existing_single_selection() {</span>
<a href="#l267.43"></a><span id="l267.43">   select_click_folder(folderA);</span>
<a href="#l267.44"></a><span id="l267.44">   assert_folders_selected_and_displayed(folderA);</span>
<a href="#l267.45"></a><span id="l267.45"> </span>
<a href="#l267.46"></a><span id="l267.46">   let swc = open_search_window_from_context_menu(folderA);</span>
<a href="#l267.47"></a><span id="l267.47">   assert_search_window_folder_displayed(swc, folderA);</span>
<a href="#l267.48"></a><span id="l267.48"> </span>
<a href="#l267.49"></a><span id="l267.49">   close_search_window(swc);</span>
<a href="#l267.50"></a><span id="l267.50" class="difflineminus">-}</span>
<a href="#l267.51"></a><span id="l267.51" class="difflineplus">+});</span>
<a href="#l267.52"></a><span id="l267.52"> </span>
<a href="#l267.53"></a><span id="l267.53"> /**</span>
<a href="#l267.54"></a><span id="l267.54">  * Test opening a search window while a different folder is selected.</span>
<a href="#l267.55"></a><span id="l267.55">  */</span>
<a href="#l267.56"></a><span id="l267.56" class="difflineminus">-function test_open_search_window_with_one_thing_selected() {</span>
<a href="#l267.57"></a><span id="l267.57" class="difflineplus">+add_task(function test_open_search_window_with_one_thing_selected() {</span>
<a href="#l267.58"></a><span id="l267.58">   select_click_folder(folderA);</span>
<a href="#l267.59"></a><span id="l267.59">   assert_folders_selected_and_displayed(folderA);</span>
<a href="#l267.60"></a><span id="l267.60"> </span>
<a href="#l267.61"></a><span id="l267.61">   let swc = open_search_window_from_context_menu(folderB);</span>
<a href="#l267.62"></a><span id="l267.62">   assert_search_window_folder_displayed(swc, folderB);</span>
<a href="#l267.63"></a><span id="l267.63"> </span>
<a href="#l267.64"></a><span id="l267.64">   close_search_window(swc);</span>
<a href="#l267.65"></a><span id="l267.65" class="difflineminus">-}</span>
<a href="#l267.66"></a><span id="l267.66" class="difflineplus">+</span>
<a href="#l267.67"></a><span id="l267.67" class="difflineplus">+  Assert.report(</span>
<a href="#l267.68"></a><span id="l267.68" class="difflineplus">+    false,</span>
<a href="#l267.69"></a><span id="l267.69" class="difflineplus">+    undefined,</span>
<a href="#l267.70"></a><span id="l267.70" class="difflineplus">+    undefined,</span>
<a href="#l267.71"></a><span id="l267.71" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l267.72"></a><span id="l267.72" class="difflineplus">+  );</span>
<a href="#l267.73"></a><span id="l267.73" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l268.1"></a><span id="l268.1">copy from mail/test/mozmill/search-window/test-search-window.js</span>
<a href="#l268.2"></a><span id="l268.2">copy to mail/test/browser/search-window/browser_searchWindow.js</span>
<a href="#l268.3"></a><span id="l268.3" class="difflineminus">--- a/mail/test/mozmill/search-window/test-search-window.js</span>
<a href="#l268.4"></a><span id="l268.4" class="difflineplus">+++ b/mail/test/browser/search-window/browser_searchWindow.js</span>
<a href="#l268.5"></a><span id="l268.5" class="difflineat">@@ -5,17 +5,17 @@</span>
<a href="#l268.6"></a><span id="l268.6"> /*</span>
<a href="#l268.7"></a><span id="l268.7">  * Tests:</span>
<a href="#l268.8"></a><span id="l268.8">  * - https://bugzilla.mozilla.org/show_bug.cgi?id=474701#c96 first para</span>
<a href="#l268.9"></a><span id="l268.9">  */</span>
<a href="#l268.10"></a><span id="l268.10"> </span>
<a href="#l268.11"></a><span id="l268.11"> &quot;use strict&quot;;</span>
<a href="#l268.12"></a><span id="l268.12"> </span>
<a href="#l268.13"></a><span id="l268.13"> var elib = ChromeUtils.import(</span>
<a href="#l268.14"></a><span id="l268.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l268.15"></a><span id="l268.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l268.16"></a><span id="l268.16"> );</span>
<a href="#l268.17"></a><span id="l268.17"> </span>
<a href="#l268.18"></a><span id="l268.18"> var {</span>
<a href="#l268.19"></a><span id="l268.19">   assert_messages_in_view,</span>
<a href="#l268.20"></a><span id="l268.20">   assert_number_of_tabs_open,</span>
<a href="#l268.21"></a><span id="l268.21">   assert_selected_and_displayed,</span>
<a href="#l268.22"></a><span id="l268.22">   assert_tab_mode_name,</span>
<a href="#l268.23"></a><span id="l268.23">   assert_tab_titled_from,</span>
<a href="#l268.24"></a><span id="l268.24" class="difflineat">@@ -56,45 +56,45 @@ var {</span>
<a href="#l268.25"></a><span id="l268.25"> var folder, setFoo, setBar, setFooBar;</span>
<a href="#l268.26"></a><span id="l268.26"> </span>
<a href="#l268.27"></a><span id="l268.27"> // Number of messages to open for multi-message tests</span>
<a href="#l268.28"></a><span id="l268.28"> var NUM_MESSAGES_TO_OPEN = 5;</span>
<a href="#l268.29"></a><span id="l268.29"> </span>
<a href="#l268.30"></a><span id="l268.30"> /**</span>
<a href="#l268.31"></a><span id="l268.31">  * Create some messages that our constraint below will satisfy</span>
<a href="#l268.32"></a><span id="l268.32">  */</span>
<a href="#l268.33"></a><span id="l268.33" class="difflineminus">-function test_create_messages() {</span>
<a href="#l268.34"></a><span id="l268.34" class="difflineplus">+add_task(function test_create_messages() {</span>
<a href="#l268.35"></a><span id="l268.35">   folder = create_folder(&quot;SearchWindowA&quot;);</span>
<a href="#l268.36"></a><span id="l268.36">   [setFoo, setBar, setFooBar] = make_new_sets_in_folder(folder, [</span>
<a href="#l268.37"></a><span id="l268.37">     { subject: &quot;foo&quot; },</span>
<a href="#l268.38"></a><span id="l268.38">     { subject: &quot;bar&quot; },</span>
<a href="#l268.39"></a><span id="l268.39">     { subject: &quot;foo bar&quot; },</span>
<a href="#l268.40"></a><span id="l268.40">   ]);</span>
<a href="#l268.41"></a><span id="l268.41" class="difflineminus">-}</span>
<a href="#l268.42"></a><span id="l268.42" class="difflineplus">+});</span>
<a href="#l268.43"></a><span id="l268.43"> </span>
<a href="#l268.44"></a><span id="l268.44"> /**</span>
<a href="#l268.45"></a><span id="l268.45">  * The search window controller.</span>
<a href="#l268.46"></a><span id="l268.46">  */</span>
<a href="#l268.47"></a><span id="l268.47"> var swc = null;</span>
<a href="#l268.48"></a><span id="l268.48"> </span>
<a href="#l268.49"></a><span id="l268.49"> /**</span>
<a href="#l268.50"></a><span id="l268.50">  * Bring up the search window.</span>
<a href="#l268.51"></a><span id="l268.51">  */</span>
<a href="#l268.52"></a><span id="l268.52" class="difflineminus">-function test_show_search_window() {</span>
<a href="#l268.53"></a><span id="l268.53" class="difflineplus">+add_task(function test_show_search_window() {</span>
<a href="#l268.54"></a><span id="l268.54">   // put us in the folder we care about so it defaults to that</span>
<a href="#l268.55"></a><span id="l268.55">   be_in_folder(folder);</span>
<a href="#l268.56"></a><span id="l268.56"> </span>
<a href="#l268.57"></a><span id="l268.57">   swc = open_search_window();</span>
<a href="#l268.58"></a><span id="l268.58">   assert_search_window_folder_displayed(swc, folder);</span>
<a href="#l268.59"></a><span id="l268.59" class="difflineminus">-}</span>
<a href="#l268.60"></a><span id="l268.60" class="difflineplus">+});</span>
<a href="#l268.61"></a><span id="l268.61"> </span>
<a href="#l268.62"></a><span id="l268.62"> /**</span>
<a href="#l268.63"></a><span id="l268.63">  * Set up the search.</span>
<a href="#l268.64"></a><span id="l268.64">  */</span>
<a href="#l268.65"></a><span id="l268.65" class="difflineminus">-function test_enter_some_stuff() {</span>
<a href="#l268.66"></a><span id="l268.66" class="difflineplus">+add_task(function test_enter_some_stuff() {</span>
<a href="#l268.67"></a><span id="l268.67">   // - turn off search subfolders</span>
<a href="#l268.68"></a><span id="l268.68">   // (we're not testing the UI, direct access is fine)</span>
<a href="#l268.69"></a><span id="l268.69">   swc.e(&quot;checkSearchSubFolders&quot;).removeAttribute(&quot;checked&quot;);</span>
<a href="#l268.70"></a><span id="l268.70"> </span>
<a href="#l268.71"></a><span id="l268.71">   // - put &quot;foo&quot; in the subject contains box</span>
<a href="#l268.72"></a><span id="l268.72">   // Each filter criterion is a listitem in the listbox with id=searchTermList.</span>
<a href="#l268.73"></a><span id="l268.73">   // Each filter criterion has id &quot;searchRowN&quot;, and the textbox has id</span>
<a href="#l268.74"></a><span id="l268.74">   //  &quot;searchValN&quot; exposing the value on attribute &quot;value&quot;.</span>
<a href="#l268.75"></a><span id="l268.75" class="difflineat">@@ -121,22 +121,22 @@ function test_enter_some_stuff() {</span>
<a href="#l268.76"></a><span id="l268.76">   index = 0;</span>
<a href="#l268.77"></a><span id="l268.77"> </span>
<a href="#l268.78"></a><span id="l268.78">   if (searchVal1.hasAttribute(&quot;selectedIndex&quot;)) {</span>
<a href="#l268.79"></a><span id="l268.79">     index = parseInt(searchVal1.getAttribute(&quot;selectedIndex&quot;));</span>
<a href="#l268.80"></a><span id="l268.80">   }</span>
<a href="#l268.81"></a><span id="l268.81"> </span>
<a href="#l268.82"></a><span id="l268.82">   searchVal1 = searchVal1.children[index];</span>
<a href="#l268.83"></a><span id="l268.83">   searchVal1.value = &quot;bar&quot;;</span>
<a href="#l268.84"></a><span id="l268.84" class="difflineminus">-}</span>
<a href="#l268.85"></a><span id="l268.85" class="difflineplus">+});</span>
<a href="#l268.86"></a><span id="l268.86"> </span>
<a href="#l268.87"></a><span id="l268.87"> /**</span>
<a href="#l268.88"></a><span id="l268.88">  * Trigger the search, make sure the right results show up.</span>
<a href="#l268.89"></a><span id="l268.89">  */</span>
<a href="#l268.90"></a><span id="l268.90" class="difflineminus">-function test_go_search() {</span>
<a href="#l268.91"></a><span id="l268.91" class="difflineplus">+add_task(function test_go_search() {</span>
<a href="#l268.92"></a><span id="l268.92">   // - Trigger the search</span>
<a href="#l268.93"></a><span id="l268.93">   // The &quot;Search&quot; button has id &quot;search-button&quot;</span>
<a href="#l268.94"></a><span id="l268.94">   swc.click(swc.eid(&quot;search-button&quot;));</span>
<a href="#l268.95"></a><span id="l268.95">   wait_for_all_messages_to_load(swc);</span>
<a href="#l268.96"></a><span id="l268.96"> </span>
<a href="#l268.97"></a><span id="l268.97">   // - Verify we got the right messages</span>
<a href="#l268.98"></a><span id="l268.98">   assert_messages_in_view(setFooBar, swc);</span>
<a href="#l268.99"></a><span id="l268.99"> </span>
<a href="#l268.100"></a><span id="l268.100" class="difflineat">@@ -145,22 +145,22 @@ function test_go_search() {</span>
<a href="#l268.101"></a><span id="l268.101">   // (label: &quot;New Saved Search Folder&quot;, source: virtualFolderProperties.xul</span>
<a href="#l268.102"></a><span id="l268.102">   //  no windowtype, id: &quot;virtualFolderPropertiesDialog&quot;)</span>
<a href="#l268.103"></a><span id="l268.103">   plan_for_modal_dialog(</span>
<a href="#l268.104"></a><span id="l268.104">     &quot;mailnews:virtualFolderProperties&quot;,</span>
<a href="#l268.105"></a><span id="l268.105">     subtest_save_search</span>
<a href="#l268.106"></a><span id="l268.106">   );</span>
<a href="#l268.107"></a><span id="l268.107">   swc.click(swc.eid(&quot;saveAsVFButton&quot;));</span>
<a href="#l268.108"></a><span id="l268.108">   wait_for_modal_dialog(&quot;mailnews:virtualFolderProperties&quot;);</span>
<a href="#l268.109"></a><span id="l268.109" class="difflineminus">-}</span>
<a href="#l268.110"></a><span id="l268.110" class="difflineplus">+});</span>
<a href="#l268.111"></a><span id="l268.111"> </span>
<a href="#l268.112"></a><span id="l268.112"> /**</span>
<a href="#l268.113"></a><span id="l268.113">  * Test opening a single search result in a new tab.</span>
<a href="#l268.114"></a><span id="l268.114">  */</span>
<a href="#l268.115"></a><span id="l268.115" class="difflineminus">-function test_open_single_search_result_in_tab() {</span>
<a href="#l268.116"></a><span id="l268.116" class="difflineplus">+add_task(function test_open_single_search_result_in_tab() {</span>
<a href="#l268.117"></a><span id="l268.117">   swc.window.focus();</span>
<a href="#l268.118"></a><span id="l268.118">   set_open_message_behavior(&quot;NEW_TAB&quot;);</span>
<a href="#l268.119"></a><span id="l268.119">   let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l268.120"></a><span id="l268.120">   let preCount = mc.tabmail.tabContainer.allTabs.length;</span>
<a href="#l268.121"></a><span id="l268.121"> </span>
<a href="#l268.122"></a><span id="l268.122">   // Select one message</span>
<a href="#l268.123"></a><span id="l268.123">   swc.e(&quot;threadTree&quot;).focus();</span>
<a href="#l268.124"></a><span id="l268.124">   let msgHdr = select_click_row(1, swc);</span>
<a href="#l268.125"></a><span id="l268.125" class="difflineat">@@ -174,22 +174,22 @@ function test_open_single_search_result_</span>
<a href="#l268.126"></a><span id="l268.126">   // opened tab is in the foreground)</span>
<a href="#l268.127"></a><span id="l268.127">   assert_tab_mode_name(null, &quot;message&quot;);</span>
<a href="#l268.128"></a><span id="l268.128">   // Check that the message header displayed is the right one</span>
<a href="#l268.129"></a><span id="l268.129">   assert_selected_and_displayed(msgHdr);</span>
<a href="#l268.130"></a><span id="l268.130">   // Clean up, close the tab</span>
<a href="#l268.131"></a><span id="l268.131">   close_tab(mc.tabmail.currentTabInfo);</span>
<a href="#l268.132"></a><span id="l268.132">   switch_tab(folderTab);</span>
<a href="#l268.133"></a><span id="l268.133">   reset_open_message_behavior();</span>
<a href="#l268.134"></a><span id="l268.134" class="difflineminus">-}</span>
<a href="#l268.135"></a><span id="l268.135" class="difflineplus">+});</span>
<a href="#l268.136"></a><span id="l268.136"> </span>
<a href="#l268.137"></a><span id="l268.137"> /**</span>
<a href="#l268.138"></a><span id="l268.138">  * Test opening multiple search results in new tabs.</span>
<a href="#l268.139"></a><span id="l268.139">  */</span>
<a href="#l268.140"></a><span id="l268.140" class="difflineminus">-function test_open_multiple_search_results_in_new_tabs() {</span>
<a href="#l268.141"></a><span id="l268.141" class="difflineplus">+add_task(function test_open_multiple_search_results_in_new_tabs() {</span>
<a href="#l268.142"></a><span id="l268.142">   swc.window.focus();</span>
<a href="#l268.143"></a><span id="l268.143">   set_open_message_behavior(&quot;NEW_TAB&quot;);</span>
<a href="#l268.144"></a><span id="l268.144">   let folderTab = mc.tabmail.currentTabInfo;</span>
<a href="#l268.145"></a><span id="l268.145">   let preCount = mc.tabmail.tabContainer.allTabs.length;</span>
<a href="#l268.146"></a><span id="l268.146"> </span>
<a href="#l268.147"></a><span id="l268.147">   // Select a bunch of messages</span>
<a href="#l268.148"></a><span id="l268.148">   swc.e(&quot;threadTree&quot;).focus();</span>
<a href="#l268.149"></a><span id="l268.149">   select_click_row(1, swc);</span>
<a href="#l268.150"></a><span id="l268.150" class="difflineat">@@ -216,22 +216,22 @@ function test_open_multiple_search_resul</span>
<a href="#l268.151"></a><span id="l268.151">   // Check whether each tab has the correct message, then close it to load the</span>
<a href="#l268.152"></a><span id="l268.152">   // previous tab.</span>
<a href="#l268.153"></a><span id="l268.153">   for (let i = 0; i &lt; NUM_MESSAGES_TO_OPEN; i++) {</span>
<a href="#l268.154"></a><span id="l268.154">     assert_selected_and_displayed(selectedMessages.pop());</span>
<a href="#l268.155"></a><span id="l268.155">     close_tab(mc.tabmail.currentTabInfo);</span>
<a href="#l268.156"></a><span id="l268.156">   }</span>
<a href="#l268.157"></a><span id="l268.157">   switch_tab(folderTab);</span>
<a href="#l268.158"></a><span id="l268.158">   reset_open_message_behavior();</span>
<a href="#l268.159"></a><span id="l268.159" class="difflineminus">-}</span>
<a href="#l268.160"></a><span id="l268.160" class="difflineplus">+});</span>
<a href="#l268.161"></a><span id="l268.161"> </span>
<a href="#l268.162"></a><span id="l268.162"> /**</span>
<a href="#l268.163"></a><span id="l268.163">  * Test opening a search result in a new window.</span>
<a href="#l268.164"></a><span id="l268.164">  */</span>
<a href="#l268.165"></a><span id="l268.165" class="difflineminus">-function test_open_search_result_in_new_window() {</span>
<a href="#l268.166"></a><span id="l268.166" class="difflineplus">+add_task(function test_open_search_result_in_new_window() {</span>
<a href="#l268.167"></a><span id="l268.167">   swc.window.focus();</span>
<a href="#l268.168"></a><span id="l268.168">   set_open_message_behavior(&quot;NEW_WINDOW&quot;);</span>
<a href="#l268.169"></a><span id="l268.169"> </span>
<a href="#l268.170"></a><span id="l268.170">   // Select a message</span>
<a href="#l268.171"></a><span id="l268.171">   swc.e(&quot;threadTree&quot;).focus();</span>
<a href="#l268.172"></a><span id="l268.172">   let msgHdr = select_click_row(1, swc);</span>
<a href="#l268.173"></a><span id="l268.173"> </span>
<a href="#l268.174"></a><span id="l268.174">   plan_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l268.175"></a><span id="l268.175" class="difflineat">@@ -239,22 +239,22 @@ function test_open_search_result_in_new_</span>
<a href="#l268.176"></a><span id="l268.176">   open_selected_message(swc);</span>
<a href="#l268.177"></a><span id="l268.177">   let msgc = wait_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l268.178"></a><span id="l268.178">   wait_for_message_display_completion(msgc, true);</span>
<a href="#l268.179"></a><span id="l268.179"> </span>
<a href="#l268.180"></a><span id="l268.180">   assert_selected_and_displayed(msgc, msgHdr);</span>
<a href="#l268.181"></a><span id="l268.181">   // Clean up, close the window</span>
<a href="#l268.182"></a><span id="l268.182">   close_message_window(msgc);</span>
<a href="#l268.183"></a><span id="l268.183">   reset_open_message_behavior();</span>
<a href="#l268.184"></a><span id="l268.184" class="difflineminus">-}</span>
<a href="#l268.185"></a><span id="l268.185" class="difflineplus">+});</span>
<a href="#l268.186"></a><span id="l268.186"> </span>
<a href="#l268.187"></a><span id="l268.187"> /**</span>
<a href="#l268.188"></a><span id="l268.188">  * Test reusing an existing window to open another search result.</span>
<a href="#l268.189"></a><span id="l268.189">  */</span>
<a href="#l268.190"></a><span id="l268.190" class="difflineminus">-function test_open_search_result_in_existing_window() {</span>
<a href="#l268.191"></a><span id="l268.191" class="difflineplus">+add_task(function test_open_search_result_in_existing_window() {</span>
<a href="#l268.192"></a><span id="l268.192">   swc.window.focus();</span>
<a href="#l268.193"></a><span id="l268.193">   set_open_message_behavior(&quot;EXISTING_WINDOW&quot;);</span>
<a href="#l268.194"></a><span id="l268.194"> </span>
<a href="#l268.195"></a><span id="l268.195">   // Open up a window</span>
<a href="#l268.196"></a><span id="l268.196">   swc.e(&quot;threadTree&quot;).focus();</span>
<a href="#l268.197"></a><span id="l268.197">   select_click_row(1, swc);</span>
<a href="#l268.198"></a><span id="l268.198">   plan_for_new_window(&quot;mail:messageWindow&quot;);</span>
<a href="#l268.199"></a><span id="l268.199">   open_selected_message(swc);</span>
<a href="#l268.200"></a><span id="l268.200" class="difflineat">@@ -267,17 +267,17 @@ function test_open_search_result_in_exis</span>
<a href="#l268.201"></a><span id="l268.201">   open_selected_message(swc);</span>
<a href="#l268.202"></a><span id="l268.202">   wait_for_message_display_completion(msgc, true);</span>
<a href="#l268.203"></a><span id="l268.203"> </span>
<a href="#l268.204"></a><span id="l268.204">   // Check if our old window displays the message</span>
<a href="#l268.205"></a><span id="l268.205">   assert_selected_and_displayed(msgc, msgHdr);</span>
<a href="#l268.206"></a><span id="l268.206">   // Clean up, close the window</span>
<a href="#l268.207"></a><span id="l268.207">   close_message_window(msgc);</span>
<a href="#l268.208"></a><span id="l268.208">   reset_open_message_behavior();</span>
<a href="#l268.209"></a><span id="l268.209" class="difflineminus">-}</span>
<a href="#l268.210"></a><span id="l268.210" class="difflineplus">+});</span>
<a href="#l268.211"></a><span id="l268.211"> </span>
<a href="#l268.212"></a><span id="l268.212"> /**</span>
<a href="#l268.213"></a><span id="l268.213">  * Save the search, making sure the constraints propagated.</span>
<a href="#l268.214"></a><span id="l268.214">  */</span>
<a href="#l268.215"></a><span id="l268.215"> function subtest_save_search(savc) {</span>
<a href="#l268.216"></a><span id="l268.216">   // - make sure our constraint propagated</span>
<a href="#l268.217"></a><span id="l268.217">   // The query constraints are displayed using the same widgets (and code) that</span>
<a href="#l268.218"></a><span id="l268.218">   //  we used to enter them, so it's very similar to check.</span>
<a href="#l268.219"></a><span id="l268.219" class="difflineat">@@ -309,30 +309,37 @@ function subtest_save_search(savc) {</span>
<a href="#l268.220"></a><span id="l268.220">   savc.type(savc.eid(&quot;name&quot;), &quot;SearchSaved&quot;);</span>
<a href="#l268.221"></a><span id="l268.221"> </span>
<a href="#l268.222"></a><span id="l268.222">   // - save it!</span>
<a href="#l268.223"></a><span id="l268.223">   // this will close the dialog, which wait_for_modal_dialog is making sure</span>
<a href="#l268.224"></a><span id="l268.224">   //  happens.</span>
<a href="#l268.225"></a><span id="l268.225">   savc.window.document.documentElement.acceptDialog();</span>
<a href="#l268.226"></a><span id="l268.226"> }</span>
<a href="#l268.227"></a><span id="l268.227"> </span>
<a href="#l268.228"></a><span id="l268.228" class="difflineminus">-function test_close_search_window() {</span>
<a href="#l268.229"></a><span id="l268.229" class="difflineplus">+add_task(function test_close_search_window() {</span>
<a href="#l268.230"></a><span id="l268.230">   swc.window.focus();</span>
<a href="#l268.231"></a><span id="l268.231">   // now close the search window</span>
<a href="#l268.232"></a><span id="l268.232">   plan_for_window_close(swc);</span>
<a href="#l268.233"></a><span id="l268.233">   swc.keypress(null, &quot;VK_ESCAPE&quot;, {});</span>
<a href="#l268.234"></a><span id="l268.234">   wait_for_window_close(swc);</span>
<a href="#l268.235"></a><span id="l268.235">   swc = null;</span>
<a href="#l268.236"></a><span id="l268.236" class="difflineminus">-}</span>
<a href="#l268.237"></a><span id="l268.237" class="difflineplus">+});</span>
<a href="#l268.238"></a><span id="l268.238"> </span>
<a href="#l268.239"></a><span id="l268.239"> /**</span>
<a href="#l268.240"></a><span id="l268.240">  * Make sure the folder showed up with the right name, and that displaying it</span>
<a href="#l268.241"></a><span id="l268.241">  *  has the right contents.</span>
<a href="#l268.242"></a><span id="l268.242">  */</span>
<a href="#l268.243"></a><span id="l268.243" class="difflineminus">-function test_verify_saved_search() {</span>
<a href="#l268.244"></a><span id="l268.244" class="difflineplus">+add_task(function test_verify_saved_search() {</span>
<a href="#l268.245"></a><span id="l268.245">   let savedFolder = folder.getChildNamed(&quot;SearchSaved&quot;);</span>
<a href="#l268.246"></a><span id="l268.246">   if (savedFolder == null) {</span>
<a href="#l268.247"></a><span id="l268.247">     throw new Error(&quot;Saved folder did not show up.&quot;);</span>
<a href="#l268.248"></a><span id="l268.248">   }</span>
<a href="#l268.249"></a><span id="l268.249"> </span>
<a href="#l268.250"></a><span id="l268.250">   be_in_folder(savedFolder);</span>
<a href="#l268.251"></a><span id="l268.251">   assert_messages_in_view(setFooBar);</span>
<a href="#l268.252"></a><span id="l268.252" class="difflineminus">-}</span>
<a href="#l268.253"></a><span id="l268.253" class="difflineplus">+</span>
<a href="#l268.254"></a><span id="l268.254" class="difflineplus">+  Assert.report(</span>
<a href="#l268.255"></a><span id="l268.255" class="difflineplus">+    false,</span>
<a href="#l268.256"></a><span id="l268.256" class="difflineplus">+    undefined,</span>
<a href="#l268.257"></a><span id="l268.257" class="difflineplus">+    undefined,</span>
<a href="#l268.258"></a><span id="l268.258" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l268.259"></a><span id="l268.259" class="difflineplus">+  );</span>
<a href="#l268.260"></a><span id="l268.260" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l269.1"></a><span id="l269.1">new file mode 100644</span>
<a href="#l269.2"></a><span id="l269.2" class="difflineminus">--- /dev/null</span>
<a href="#l269.3"></a><span id="l269.3" class="difflineplus">+++ b/mail/test/browser/session-store/browser.ini</span>
<a href="#l269.4"></a><span id="l269.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l269.5"></a><span id="l269.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l269.6"></a><span id="l269.6" class="difflineplus">+prefs =</span>
<a href="#l269.7"></a><span id="l269.7" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l269.8"></a><span id="l269.8" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l269.9"></a><span id="l269.9" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l269.10"></a><span id="l269.10" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l269.11"></a><span id="l269.11" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l269.12"></a><span id="l269.12" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l269.13"></a><span id="l269.13" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l269.14"></a><span id="l269.14" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l269.15"></a><span id="l269.15" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l269.16"></a><span id="l269.16" class="difflineplus">+</span>
<a href="#l269.17"></a><span id="l269.17" class="difflineplus">+[browser_sessionStore.js]</span>
<a href="#l269.18"></a><span id="l269.18" class="difflineplus">+skip-if = true</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l270.1"></a><span id="l270.1">copy from mail/test/mozmill/session-store/test-session-store.js</span>
<a href="#l270.2"></a><span id="l270.2">copy to mail/test/browser/session-store/browser_sessionStore.js</span>
<a href="#l270.3"></a><span id="l270.3" class="difflineminus">--- a/mail/test/mozmill/session-store/test-session-store.js</span>
<a href="#l270.4"></a><span id="l270.4" class="difflineplus">+++ b/mail/test/browser/session-store/browser_sessionStore.js</span>
<a href="#l270.5"></a><span id="l270.5" class="difflineat">@@ -5,31 +5,30 @@</span>
<a href="#l270.6"></a><span id="l270.6"> /*</span>
<a href="#l270.7"></a><span id="l270.7">  * Session Storage Tests. Session Restoration Tests are currently implemented in</span>
<a href="#l270.8"></a><span id="l270.8">  * folder-display/test-message-pane-visibility.js.</span>
<a href="#l270.9"></a><span id="l270.9">  */</span>
<a href="#l270.10"></a><span id="l270.10"> </span>
<a href="#l270.11"></a><span id="l270.11"> &quot;use strict&quot;;</span>
<a href="#l270.12"></a><span id="l270.12"> </span>
<a href="#l270.13"></a><span id="l270.13"> var controller = ChromeUtils.import(</span>
<a href="#l270.14"></a><span id="l270.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/controller.jsm&quot;</span>
<a href="#l270.15"></a><span id="l270.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/controller.jsm&quot;</span>
<a href="#l270.16"></a><span id="l270.16"> );</span>
<a href="#l270.17"></a><span id="l270.17"> var EventUtils = ChromeUtils.import(</span>
<a href="#l270.18"></a><span id="l270.18" class="difflineminus">-  &quot;chrome://mozmill/content/stdlib/EventUtils.jsm&quot;</span>
<a href="#l270.19"></a><span id="l270.19" class="difflineplus">+  &quot;resource://testing-common/mozmill/EventUtils.jsm&quot;</span>
<a href="#l270.20"></a><span id="l270.20"> );</span>
<a href="#l270.21"></a><span id="l270.21" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l270.22"></a><span id="l270.22" class="difflineplus">+var mozmill = ChromeUtils.import(</span>
<a href="#l270.23"></a><span id="l270.23" class="difflineplus">+  &quot;resource://testing-common/mozmill/mozmill.jsm&quot;</span>
<a href="#l270.24"></a><span id="l270.24" class="difflineplus">+);</span>
<a href="#l270.25"></a><span id="l270.25" class="difflineplus">+var utils = ChromeUtils.import(&quot;resource://testing-common/mozmill/utils.jsm&quot;);</span>
<a href="#l270.26"></a><span id="l270.26"> </span>
<a href="#l270.27"></a><span id="l270.27"> var {</span>
<a href="#l270.28"></a><span id="l270.28" class="difflineminus">-  assert_equals,</span>
<a href="#l270.29"></a><span id="l270.29" class="difflineminus">-  assert_false,</span>
<a href="#l270.30"></a><span id="l270.30">   assert_message_pane_hidden,</span>
<a href="#l270.31"></a><span id="l270.31">   assert_message_pane_visible,</span>
<a href="#l270.32"></a><span id="l270.32" class="difflineminus">-  assert_not_equals,</span>
<a href="#l270.33"></a><span id="l270.33">   assert_pane_layout,</span>
<a href="#l270.34"></a><span id="l270.34" class="difflineminus">-  assert_true,</span>
<a href="#l270.35"></a><span id="l270.35">   be_in_folder,</span>
<a href="#l270.36"></a><span id="l270.36">   create_folder,</span>
<a href="#l270.37"></a><span id="l270.37">   kClassicMailLayout,</span>
<a href="#l270.38"></a><span id="l270.38">   kVerticalMailLayout,</span>
<a href="#l270.39"></a><span id="l270.39">   make_new_sets_in_folder,</span>
<a href="#l270.40"></a><span id="l270.40">   mc,</span>
<a href="#l270.41"></a><span id="l270.41">   set_mc,</span>
<a href="#l270.42"></a><span id="l270.42">   set_pane_layout,</span>
<a href="#l270.43"></a><span id="l270.43" class="difflineat">@@ -109,96 +108,96 @@ function openAddressBook() {</span>
<a href="#l270.44"></a><span id="l270.44">     &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l270.45"></a><span id="l270.45">     null</span>
<a href="#l270.46"></a><span id="l270.46">   );</span>
<a href="#l270.47"></a><span id="l270.47">   return wait_for_new_window(&quot;mail:addressbook&quot;);</span>
<a href="#l270.48"></a><span id="l270.48"> }</span>
<a href="#l270.49"></a><span id="l270.49"> </span>
<a href="#l270.50"></a><span id="l270.50"> /* :::::::: The Tests ::::::::::::::: */</span>
<a href="#l270.51"></a><span id="l270.51"> </span>
<a href="#l270.52"></a><span id="l270.52" class="difflineminus">-function setupModule(module) {</span>
<a href="#l270.53"></a><span id="l270.53" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l270.54"></a><span id="l270.54">   folderA = create_folder(&quot;SessionStoreA&quot;);</span>
<a href="#l270.55"></a><span id="l270.55">   make_new_sets_in_folder(folderA, [{ count: 3 }]);</span>
<a href="#l270.56"></a><span id="l270.56"> </span>
<a href="#l270.57"></a><span id="l270.57">   folderB = create_folder(&quot;SessionStoreB&quot;);</span>
<a href="#l270.58"></a><span id="l270.58">   make_new_sets_in_folder(folderB, [{ count: 3 }]);</span>
<a href="#l270.59"></a><span id="l270.59"> </span>
<a href="#l270.60"></a><span id="l270.60">   SessionStoreManager.stopPeriodicSave();</span>
<a href="#l270.61"></a><span id="l270.61"> </span>
<a href="#l270.62"></a><span id="l270.62">   // Opt out of calendar promotion so we don't show the &quot;ligthing now</span>
<a href="#l270.63"></a><span id="l270.63">   // integrated&quot; notification bar (which gives us unexpected heights).</span>
<a href="#l270.64"></a><span id="l270.64">   Services.prefs.setBoolPref(&quot;calendar.integration.notify&quot;, false);</span>
<a href="#l270.65"></a><span id="l270.65" class="difflineminus">-}</span>
<a href="#l270.66"></a><span id="l270.66" class="difflineplus">+});</span>
<a href="#l270.67"></a><span id="l270.67"> </span>
<a href="#l270.68"></a><span id="l270.68" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l270.69"></a><span id="l270.69" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l270.70"></a><span id="l270.70">   folderA.server.rootFolder.propagateDelete(folderA, true, null);</span>
<a href="#l270.71"></a><span id="l270.71">   folderB.server.rootFolder.propagateDelete(folderB, true, null);</span>
<a href="#l270.72"></a><span id="l270.72">   Services.prefs.clearUserPref(&quot;calendar.integration.notify&quot;);</span>
<a href="#l270.73"></a><span id="l270.73" class="difflineminus">-}</span>
<a href="#l270.74"></a><span id="l270.74" class="difflineplus">+});</span>
<a href="#l270.75"></a><span id="l270.75"> </span>
<a href="#l270.76"></a><span id="l270.76" class="difflineminus">-function test_periodic_session_persistence_simple() {</span>
<a href="#l270.77"></a><span id="l270.77" class="difflineplus">+add_task(function test_periodic_session_persistence_simple() {</span>
<a href="#l270.78"></a><span id="l270.78">   // delete the session file if it exists</span>
<a href="#l270.79"></a><span id="l270.79">   let sessionFile = SessionStoreManager.sessionFile;</span>
<a href="#l270.80"></a><span id="l270.80">   if (sessionFile.exists()) {</span>
<a href="#l270.81"></a><span id="l270.81">     sessionFile.remove(false);</span>
<a href="#l270.82"></a><span id="l270.82">   }</span>
<a href="#l270.83"></a><span id="l270.83"> </span>
<a href="#l270.84"></a><span id="l270.84">   utils.waitFor(() =&gt; !sessionFile.exists(), &quot;session file should not exist&quot;);</span>
<a href="#l270.85"></a><span id="l270.85"> </span>
<a href="#l270.86"></a><span id="l270.86">   // change some state to guarantee the file will be recreated</span>
<a href="#l270.87"></a><span id="l270.87">   // if periodic session persistence works</span>
<a href="#l270.88"></a><span id="l270.88">   be_in_folder(folderA);</span>
<a href="#l270.89"></a><span id="l270.89"> </span>
<a href="#l270.90"></a><span id="l270.90">   // if periodic session persistence is working, the file should be</span>
<a href="#l270.91"></a><span id="l270.91">   // re-created</span>
<a href="#l270.92"></a><span id="l270.92">   SessionStoreManager._saveState();</span>
<a href="#l270.93"></a><span id="l270.93">   waitForFileRefresh();</span>
<a href="#l270.94"></a><span id="l270.94" class="difflineminus">-}</span>
<a href="#l270.95"></a><span id="l270.95" class="difflineplus">+});</span>
<a href="#l270.96"></a><span id="l270.96"> </span>
<a href="#l270.97"></a><span id="l270.97" class="difflineminus">-function test_periodic_nondirty_session_persistence() {</span>
<a href="#l270.98"></a><span id="l270.98" class="difflineplus">+add_task(function test_periodic_nondirty_session_persistence() {</span>
<a href="#l270.99"></a><span id="l270.99">   // This changes state.</span>
<a href="#l270.100"></a><span id="l270.100">   be_in_folder(folderB);</span>
<a href="#l270.101"></a><span id="l270.101"> </span>
<a href="#l270.102"></a><span id="l270.102">   SessionStoreManager._saveState();</span>
<a href="#l270.103"></a><span id="l270.103">   waitForFileRefresh();</span>
<a href="#l270.104"></a><span id="l270.104"> </span>
<a href="#l270.105"></a><span id="l270.105">   // delete the session file</span>
<a href="#l270.106"></a><span id="l270.106">   let sessionFile = SessionStoreManager.sessionFile;</span>
<a href="#l270.107"></a><span id="l270.107">   sessionFile.remove(false);</span>
<a href="#l270.108"></a><span id="l270.108"> </span>
<a href="#l270.109"></a><span id="l270.109">   // Since the state of the session hasn't changed since last _saveState(),</span>
<a href="#l270.110"></a><span id="l270.110">   // the session file should not be re-created.</span>
<a href="#l270.111"></a><span id="l270.111">   SessionStoreManager._saveState();</span>
<a href="#l270.112"></a><span id="l270.112">   controller.sleep(kSaveDelayMs + asyncFileWriteDelayMS);</span>
<a href="#l270.113"></a><span id="l270.113"> </span>
<a href="#l270.114"></a><span id="l270.114">   utils.waitFor(() =&gt; !sessionFile.exists(), &quot;session file should not exist&quot;);</span>
<a href="#l270.115"></a><span id="l270.115" class="difflineminus">-}</span>
<a href="#l270.116"></a><span id="l270.116" class="difflineplus">+});</span>
<a href="#l270.117"></a><span id="l270.117"> </span>
<a href="#l270.118"></a><span id="l270.118" class="difflineminus">-function test_single_3pane_periodic_session_persistence() {</span>
<a href="#l270.119"></a><span id="l270.119" class="difflineplus">+add_task(function test_single_3pane_periodic_session_persistence() {</span>
<a href="#l270.120"></a><span id="l270.120">   be_in_folder(folderA);</span>
<a href="#l270.121"></a><span id="l270.121"> </span>
<a href="#l270.122"></a><span id="l270.122">   // get the state object. this assumes there is one and only one</span>
<a href="#l270.123"></a><span id="l270.123">   // 3pane window.</span>
<a href="#l270.124"></a><span id="l270.124">   let mail3PaneWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l270.125"></a><span id="l270.125">   let state = mail3PaneWindow.getWindowStateForSessionPersistence();</span>
<a href="#l270.126"></a><span id="l270.126"> </span>
<a href="#l270.127"></a><span id="l270.127">   SessionStoreManager._saveState();</span>
<a href="#l270.128"></a><span id="l270.128">   waitForFileRefresh();</span>
<a href="#l270.129"></a><span id="l270.129"> </span>
<a href="#l270.130"></a><span id="l270.130">   // load the saved state from disk</span>
<a href="#l270.131"></a><span id="l270.131">   let loadedState = readFile();</span>
<a href="#l270.132"></a><span id="l270.132" class="difflineminus">-  assert_true(loadedState, &quot;previously saved state should be non-null&quot;);</span>
<a href="#l270.133"></a><span id="l270.133" class="difflineplus">+  Assert.ok(loadedState, &quot;previously saved state should be non-null&quot;);</span>
<a href="#l270.134"></a><span id="l270.134"> </span>
<a href="#l270.135"></a><span id="l270.135">   // get the state object for the one and only one 3pane window</span>
<a href="#l270.136"></a><span id="l270.136">   let windowState = loadedState.windows[0];</span>
<a href="#l270.137"></a><span id="l270.137" class="difflineminus">-  assert_true(</span>
<a href="#l270.138"></a><span id="l270.138" class="difflineplus">+  Assert.ok(</span>
<a href="#l270.139"></a><span id="l270.139">     JSON.stringify(windowState) == JSON.stringify(state),</span>
<a href="#l270.140"></a><span id="l270.140">     &quot;saved state and loaded state should be equal&quot;</span>
<a href="#l270.141"></a><span id="l270.141">   );</span>
<a href="#l270.142"></a><span id="l270.142" class="difflineminus">-}</span>
<a href="#l270.143"></a><span id="l270.143" class="difflineplus">+});</span>
<a href="#l270.144"></a><span id="l270.144"> </span>
<a href="#l270.145"></a><span id="l270.145"> function test_restore_single_3pane_persistence() {</span>
<a href="#l270.146"></a><span id="l270.146">   be_in_folder(folderA);</span>
<a href="#l270.147"></a><span id="l270.147">   toggle_message_pane();</span>
<a href="#l270.148"></a><span id="l270.148">   assert_message_pane_hidden();</span>
<a href="#l270.149"></a><span id="l270.149"> </span>
<a href="#l270.150"></a><span id="l270.150">   // get the state object. this assumes there is one and only one</span>
<a href="#l270.151"></a><span id="l270.151">   // 3pane window.</span>
<a href="#l270.152"></a><span id="l270.152" class="difflineat">@@ -220,53 +219,54 @@ function test_restore_single_3pane_persi</span>
<a href="#l270.153"></a><span id="l270.153">   // restore message pane.</span>
<a href="#l270.154"></a><span id="l270.154">   toggle_message_pane();</span>
<a href="#l270.155"></a><span id="l270.155"> </span>
<a href="#l270.156"></a><span id="l270.156">   // We don't need the address book window any more.</span>
<a href="#l270.157"></a><span id="l270.157">   plan_for_window_close(abwc);</span>
<a href="#l270.158"></a><span id="l270.158">   abwc.window.close();</span>
<a href="#l270.159"></a><span id="l270.159">   wait_for_window_close();</span>
<a href="#l270.160"></a><span id="l270.160"> }</span>
<a href="#l270.161"></a><span id="l270.161" class="difflineplus">+add_task(test_restore_single_3pane_persistence);</span>
<a href="#l270.162"></a><span id="l270.162"> </span>
<a href="#l270.163"></a><span id="l270.163" class="difflineminus">-function test_restore_single_3pane_persistence_again() {</span>
<a href="#l270.164"></a><span id="l270.164" class="difflineplus">+add_task(function test_restore_single_3pane_persistence_again() {</span>
<a href="#l270.165"></a><span id="l270.165">   // test that repeating the save w/o changing the state restores</span>
<a href="#l270.166"></a><span id="l270.166">   // correctly.</span>
<a href="#l270.167"></a><span id="l270.167">   test_restore_single_3pane_persistence();</span>
<a href="#l270.168"></a><span id="l270.168" class="difflineminus">-}</span>
<a href="#l270.169"></a><span id="l270.169" class="difflineplus">+});</span>
<a href="#l270.170"></a><span id="l270.170"> </span>
<a href="#l270.171"></a><span id="l270.171" class="difflineminus">-function test_message_pane_height_persistence() {</span>
<a href="#l270.172"></a><span id="l270.172" class="difflineplus">+add_task(function test_message_pane_height_persistence() {</span>
<a href="#l270.173"></a><span id="l270.173">   be_in_folder(folderA);</span>
<a href="#l270.174"></a><span id="l270.174">   assert_message_pane_visible();</span>
<a href="#l270.175"></a><span id="l270.175">   assert_pane_layout(kClassicMailLayout);</span>
<a href="#l270.176"></a><span id="l270.176"> </span>
<a href="#l270.177"></a><span id="l270.177">   // Get the state object. This assumes there is one and only one</span>
<a href="#l270.178"></a><span id="l270.178">   // 3pane window.</span>
<a href="#l270.179"></a><span id="l270.179">   let mail3PaneWindow = Services.wm.getMostRecentWindow(&quot;mail:3pane&quot;);</span>
<a href="#l270.180"></a><span id="l270.180"> </span>
<a href="#l270.181"></a><span id="l270.181">   let oldHeight = mc.e(&quot;messagepaneboxwrapper&quot;).clientHeight;</span>
<a href="#l270.182"></a><span id="l270.182">   let minHeight = Math.floor(</span>
<a href="#l270.183"></a><span id="l270.183">     mc.e(&quot;messagepaneboxwrapper&quot;).getAttribute(&quot;minheight&quot;)</span>
<a href="#l270.184"></a><span id="l270.184">   );</span>
<a href="#l270.185"></a><span id="l270.185">   let newHeight = Math.floor((minHeight + oldHeight) / 2);</span>
<a href="#l270.186"></a><span id="l270.186">   let diffHeight = oldHeight - newHeight;</span>
<a href="#l270.187"></a><span id="l270.187"> </span>
<a href="#l270.188"></a><span id="l270.188" class="difflineminus">-  assert_not_equals(</span>
<a href="#l270.189"></a><span id="l270.189" class="difflineplus">+  Assert.notEqual(</span>
<a href="#l270.190"></a><span id="l270.190">     oldHeight,</span>
<a href="#l270.191"></a><span id="l270.191">     newHeight,</span>
<a href="#l270.192"></a><span id="l270.192">     &quot;To really perform a test the new message pane height should be &quot; +</span>
<a href="#l270.193"></a><span id="l270.193">       &quot;should be different from the old one but they are the same: &quot; +</span>
<a href="#l270.194"></a><span id="l270.194">       newHeight</span>
<a href="#l270.195"></a><span id="l270.195">   );</span>
<a href="#l270.196"></a><span id="l270.196"> </span>
<a href="#l270.197"></a><span id="l270.197">   _move_splitter(mc.e(&quot;threadpane-splitter&quot;), 0, diffHeight);</span>
<a href="#l270.198"></a><span id="l270.198"> </span>
<a href="#l270.199"></a><span id="l270.199">   // Check that the moving of the threadpane-splitter resulted in the correct height.</span>
<a href="#l270.200"></a><span id="l270.200">   let actualHeight = mc.e(&quot;messagepaneboxwrapper&quot;).clientHeight;</span>
<a href="#l270.201"></a><span id="l270.201"> </span>
<a href="#l270.202"></a><span id="l270.202" class="difflineminus">-  assert_equals(</span>
<a href="#l270.203"></a><span id="l270.203" class="difflineplus">+  Assert.equal(</span>
<a href="#l270.204"></a><span id="l270.204">     newHeight,</span>
<a href="#l270.205"></a><span id="l270.205">     actualHeight,</span>
<a href="#l270.206"></a><span id="l270.206">     &quot;The message pane height should be &quot; +</span>
<a href="#l270.207"></a><span id="l270.207">       newHeight +</span>
<a href="#l270.208"></a><span id="l270.208">       &quot;, but is actually &quot; +</span>
<a href="#l270.209"></a><span id="l270.209">       actualHeight +</span>
<a href="#l270.210"></a><span id="l270.210">       &quot;. The oldHeight was: &quot; +</span>
<a href="#l270.211"></a><span id="l270.211">       oldHeight</span>
<a href="#l270.212"></a><span id="l270.212" class="difflineat">@@ -283,17 +283,17 @@ function test_message_pane_height_persis</span>
<a href="#l270.213"></a><span id="l270.213"> </span>
<a href="#l270.214"></a><span id="l270.214">   mc = open3PaneWindow();</span>
<a href="#l270.215"></a><span id="l270.215">   set_mc(mc);</span>
<a href="#l270.216"></a><span id="l270.216">   be_in_folder(folderA);</span>
<a href="#l270.217"></a><span id="l270.217">   assert_message_pane_visible();</span>
<a href="#l270.218"></a><span id="l270.218"> </span>
<a href="#l270.219"></a><span id="l270.219">   actualHeight = mc.e(&quot;messagepaneboxwrapper&quot;).clientHeight;</span>
<a href="#l270.220"></a><span id="l270.220"> </span>
<a href="#l270.221"></a><span id="l270.221" class="difflineminus">-  assert_equals(</span>
<a href="#l270.222"></a><span id="l270.222" class="difflineplus">+  Assert.equal(</span>
<a href="#l270.223"></a><span id="l270.223">     newHeight,</span>
<a href="#l270.224"></a><span id="l270.224">     actualHeight,</span>
<a href="#l270.225"></a><span id="l270.225">     &quot;The message pane height should be &quot; +</span>
<a href="#l270.226"></a><span id="l270.226">       newHeight +</span>
<a href="#l270.227"></a><span id="l270.227">       &quot;, but is actually &quot; +</span>
<a href="#l270.228"></a><span id="l270.228">       actualHeight +</span>
<a href="#l270.229"></a><span id="l270.229">       &quot;. The oldHeight was: &quot; +</span>
<a href="#l270.230"></a><span id="l270.230">       oldHeight</span>
<a href="#l270.231"></a><span id="l270.231" class="difflineat">@@ -308,32 +308,32 @@ function test_message_pane_height_persis</span>
<a href="#l270.232"></a><span id="l270.232">   controller.sleep(asyncFileWriteDelayMS);</span>
<a href="#l270.233"></a><span id="l270.233"> </span>
<a href="#l270.234"></a><span id="l270.234">   mc = open3PaneWindow();</span>
<a href="#l270.235"></a><span id="l270.235">   set_mc(mc);</span>
<a href="#l270.236"></a><span id="l270.236">   be_in_folder(folderA);</span>
<a href="#l270.237"></a><span id="l270.237">   assert_message_pane_visible();</span>
<a href="#l270.238"></a><span id="l270.238"> </span>
<a href="#l270.239"></a><span id="l270.239">   actualHeight = mc.e(&quot;messagepaneboxwrapper&quot;).clientHeight;</span>
<a href="#l270.240"></a><span id="l270.240" class="difflineminus">-  assert_equals(</span>
<a href="#l270.241"></a><span id="l270.241" class="difflineplus">+  Assert.equal(</span>
<a href="#l270.242"></a><span id="l270.242">     oldHeight,</span>
<a href="#l270.243"></a><span id="l270.243">     actualHeight,</span>
<a href="#l270.244"></a><span id="l270.244">     &quot;The message pane height should be &quot; +</span>
<a href="#l270.245"></a><span id="l270.245">       oldHeight +</span>
<a href="#l270.246"></a><span id="l270.246">       &quot;, but is actually &quot; +</span>
<a href="#l270.247"></a><span id="l270.247">       actualHeight</span>
<a href="#l270.248"></a><span id="l270.248">   );</span>
<a href="#l270.249"></a><span id="l270.249"> </span>
<a href="#l270.250"></a><span id="l270.250">   // We don't need the address book window any more.</span>
<a href="#l270.251"></a><span id="l270.251">   plan_for_window_close(abwc);</span>
<a href="#l270.252"></a><span id="l270.252">   abwc.window.close();</span>
<a href="#l270.253"></a><span id="l270.253">   wait_for_window_close();</span>
<a href="#l270.254"></a><span id="l270.254" class="difflineminus">-}</span>
<a href="#l270.255"></a><span id="l270.255" class="difflineplus">+});</span>
<a href="#l270.256"></a><span id="l270.256"> </span>
<a href="#l270.257"></a><span id="l270.257" class="difflineminus">-function test_message_pane_width_persistence() {</span>
<a href="#l270.258"></a><span id="l270.258" class="difflineplus">+add_task(function test_message_pane_width_persistence() {</span>
<a href="#l270.259"></a><span id="l270.259">   be_in_folder(folderA);</span>
<a href="#l270.260"></a><span id="l270.260">   assert_message_pane_visible();</span>
<a href="#l270.261"></a><span id="l270.261"> </span>
<a href="#l270.262"></a><span id="l270.262">   // At the beginning we are in classic layout.  We will switch to</span>
<a href="#l270.263"></a><span id="l270.263">   // vertical layout to test the width, and then back to classic layout.</span>
<a href="#l270.264"></a><span id="l270.264">   assert_pane_layout(kClassicMailLayout);</span>
<a href="#l270.265"></a><span id="l270.265">   set_pane_layout(kVerticalMailLayout);</span>
<a href="#l270.266"></a><span id="l270.266">   assert_pane_layout(kVerticalMailLayout);</span>
<a href="#l270.267"></a><span id="l270.267" class="difflineat">@@ -344,17 +344,17 @@ function test_message_pane_width_persist</span>
<a href="#l270.268"></a><span id="l270.268"> </span>
<a href="#l270.269"></a><span id="l270.269">   let oldWidth = mc.e(&quot;messagepaneboxwrapper&quot;).clientWidth;</span>
<a href="#l270.270"></a><span id="l270.270">   let minWidth = Math.floor(</span>
<a href="#l270.271"></a><span id="l270.271">     mc.e(&quot;messagepaneboxwrapper&quot;).getAttribute(&quot;minwidth&quot;)</span>
<a href="#l270.272"></a><span id="l270.272">   );</span>
<a href="#l270.273"></a><span id="l270.273">   let newWidth = Math.floor((minWidth + oldWidth) / 2);</span>
<a href="#l270.274"></a><span id="l270.274">   let diffWidth = oldWidth - newWidth;</span>
<a href="#l270.275"></a><span id="l270.275"> </span>
<a href="#l270.276"></a><span id="l270.276" class="difflineminus">-  assert_not_equals(</span>
<a href="#l270.277"></a><span id="l270.277" class="difflineplus">+  Assert.notEqual(</span>
<a href="#l270.278"></a><span id="l270.278">     newWidth,</span>
<a href="#l270.279"></a><span id="l270.279">     oldWidth,</span>
<a href="#l270.280"></a><span id="l270.280">     &quot;To really perform a test the new message pane width should be &quot; +</span>
<a href="#l270.281"></a><span id="l270.281">       &quot;should be different from the old one but they are the same: &quot; +</span>
<a href="#l270.282"></a><span id="l270.282">       newWidth</span>
<a href="#l270.283"></a><span id="l270.283">   );</span>
<a href="#l270.284"></a><span id="l270.284"> </span>
<a href="#l270.285"></a><span id="l270.285">   // We move the threadpane-splitter and not the folderpane_splitter because</span>
<a href="#l270.286"></a><span id="l270.286" class="difflineat">@@ -391,17 +391,17 @@ function test_message_pane_width_persist</span>
<a href="#l270.287"></a><span id="l270.287"> </span>
<a href="#l270.288"></a><span id="l270.288">   mc = open3PaneWindow();</span>
<a href="#l270.289"></a><span id="l270.289">   set_mc(mc);</span>
<a href="#l270.290"></a><span id="l270.290">   be_in_folder(folderA);</span>
<a href="#l270.291"></a><span id="l270.291">   assert_message_pane_visible();</span>
<a href="#l270.292"></a><span id="l270.292">   assert_pane_layout(kVerticalMailLayout);</span>
<a href="#l270.293"></a><span id="l270.293"> </span>
<a href="#l270.294"></a><span id="l270.294">   actualWidth = mc.e(&quot;messagepaneboxwrapper&quot;).clientWidth;</span>
<a href="#l270.295"></a><span id="l270.295" class="difflineminus">-  assert_equals(</span>
<a href="#l270.296"></a><span id="l270.296" class="difflineplus">+  Assert.equal(</span>
<a href="#l270.297"></a><span id="l270.297">     newWidth,</span>
<a href="#l270.298"></a><span id="l270.298">     actualWidth,</span>
<a href="#l270.299"></a><span id="l270.299">     &quot;The message pane width should be &quot; +</span>
<a href="#l270.300"></a><span id="l270.300">       newWidth +</span>
<a href="#l270.301"></a><span id="l270.301">       &quot;, but is actually &quot; +</span>
<a href="#l270.302"></a><span id="l270.302">       actualWidth</span>
<a href="#l270.303"></a><span id="l270.303">   );</span>
<a href="#l270.304"></a><span id="l270.304"> </span>
<a href="#l270.305"></a><span id="l270.305" class="difflineat">@@ -431,36 +431,36 @@ function test_message_pane_width_persist</span>
<a href="#l270.306"></a><span id="l270.306"> </span>
<a href="#l270.307"></a><span id="l270.307">   mc = open3PaneWindow();</span>
<a href="#l270.308"></a><span id="l270.308">   set_mc(mc);</span>
<a href="#l270.309"></a><span id="l270.309">   be_in_folder(folderA);</span>
<a href="#l270.310"></a><span id="l270.310">   assert_message_pane_visible();</span>
<a href="#l270.311"></a><span id="l270.311">   assert_pane_layout(kVerticalMailLayout);</span>
<a href="#l270.312"></a><span id="l270.312"> </span>
<a href="#l270.313"></a><span id="l270.313">   actualWidth = mc.e(&quot;messagepaneboxwrapper&quot;).clientWidth;</span>
<a href="#l270.314"></a><span id="l270.314" class="difflineminus">-  assert_equals(</span>
<a href="#l270.315"></a><span id="l270.315" class="difflineplus">+  Assert.equal(</span>
<a href="#l270.316"></a><span id="l270.316">     oldWidth,</span>
<a href="#l270.317"></a><span id="l270.317">     actualWidth,</span>
<a href="#l270.318"></a><span id="l270.318">     &quot;The message pane width should be &quot; +</span>
<a href="#l270.319"></a><span id="l270.319">       oldWidth +</span>
<a href="#l270.320"></a><span id="l270.320">       &quot;, but is actually &quot; +</span>
<a href="#l270.321"></a><span id="l270.321">       actualWidth</span>
<a href="#l270.322"></a><span id="l270.322">   );</span>
<a href="#l270.323"></a><span id="l270.323"> </span>
<a href="#l270.324"></a><span id="l270.324">   // The layout is reset to classical mail layout.</span>
<a href="#l270.325"></a><span id="l270.325">   set_pane_layout(kClassicMailLayout);</span>
<a href="#l270.326"></a><span id="l270.326">   assert_pane_layout(kClassicMailLayout);</span>
<a href="#l270.327"></a><span id="l270.327"> </span>
<a href="#l270.328"></a><span id="l270.328">   // We don't need the address book window any more.</span>
<a href="#l270.329"></a><span id="l270.329">   plan_for_window_close(abwc);</span>
<a href="#l270.330"></a><span id="l270.330">   abwc.window.close();</span>
<a href="#l270.331"></a><span id="l270.331">   wait_for_window_close();</span>
<a href="#l270.332"></a><span id="l270.332" class="difflineminus">-}</span>
<a href="#l270.333"></a><span id="l270.333" class="difflineplus">+});</span>
<a href="#l270.334"></a><span id="l270.334"> </span>
<a href="#l270.335"></a><span id="l270.335" class="difflineminus">-function test_multiple_3pane_periodic_session_persistence() {</span>
<a href="#l270.336"></a><span id="l270.336" class="difflineplus">+add_task(function test_multiple_3pane_periodic_session_persistence() {</span>
<a href="#l270.337"></a><span id="l270.337">   // open a few more 3pane windows</span>
<a href="#l270.338"></a><span id="l270.338">   for (var i = 0; i &lt; 3; ++i) {</span>
<a href="#l270.339"></a><span id="l270.339">     open3PaneWindow();</span>
<a href="#l270.340"></a><span id="l270.340">   }</span>
<a href="#l270.341"></a><span id="l270.341"> </span>
<a href="#l270.342"></a><span id="l270.342">   // then get the state objects for each window</span>
<a href="#l270.343"></a><span id="l270.343">   let state = [];</span>
<a href="#l270.344"></a><span id="l270.344">   let enumerator = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l270.345"></a><span id="l270.345" class="difflineat">@@ -468,68 +468,68 @@ function test_multiple_3pane_periodic_se</span>
<a href="#l270.346"></a><span id="l270.346">     state.push(enumerator.getNext().getWindowStateForSessionPersistence());</span>
<a href="#l270.347"></a><span id="l270.347">   }</span>
<a href="#l270.348"></a><span id="l270.348"> </span>
<a href="#l270.349"></a><span id="l270.349">   SessionStoreManager._saveState();</span>
<a href="#l270.350"></a><span id="l270.350">   waitForFileRefresh();</span>
<a href="#l270.351"></a><span id="l270.351"> </span>
<a href="#l270.352"></a><span id="l270.352">   // load the saved state from disk</span>
<a href="#l270.353"></a><span id="l270.353">   let loadedState = readFile();</span>
<a href="#l270.354"></a><span id="l270.354" class="difflineminus">-  assert_true(loadedState, &quot;previously saved state should be non-null&quot;);</span>
<a href="#l270.355"></a><span id="l270.355" class="difflineplus">+  Assert.ok(loadedState, &quot;previously saved state should be non-null&quot;);</span>
<a href="#l270.356"></a><span id="l270.356"> </span>
<a href="#l270.357"></a><span id="l270.357" class="difflineminus">-  assert_equals(</span>
<a href="#l270.358"></a><span id="l270.358" class="difflineplus">+  Assert.equal(</span>
<a href="#l270.359"></a><span id="l270.359">     loadedState.windows.length,</span>
<a href="#l270.360"></a><span id="l270.360">     state.length,</span>
<a href="#l270.361"></a><span id="l270.361">     &quot;number of windows in saved state and loaded state should be equal&quot;</span>
<a href="#l270.362"></a><span id="l270.362">   );</span>
<a href="#l270.363"></a><span id="l270.363"> </span>
<a href="#l270.364"></a><span id="l270.364">   for (let i = 0; i &lt; state.length; ++i) {</span>
<a href="#l270.365"></a><span id="l270.365" class="difflineminus">-    assert_true(</span>
<a href="#l270.366"></a><span id="l270.366" class="difflineplus">+    Assert.ok(</span>
<a href="#l270.367"></a><span id="l270.367">       JSON.stringify(loadedState.windows[i]) == JSON.stringify(state[i]),</span>
<a href="#l270.368"></a><span id="l270.368">       &quot;saved state and loaded state should be equal&quot;</span>
<a href="#l270.369"></a><span id="l270.369">     );</span>
<a href="#l270.370"></a><span id="l270.370">   }</span>
<a href="#l270.371"></a><span id="l270.371"> </span>
<a href="#l270.372"></a><span id="l270.372">   // close all but one 3pane window</span>
<a href="#l270.373"></a><span id="l270.373">   enumerator = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l270.374"></a><span id="l270.374">   while (enumerator.hasMoreElements()) {</span>
<a href="#l270.375"></a><span id="l270.375">     let window = enumerator.getNext();</span>
<a href="#l270.376"></a><span id="l270.376">     if (enumerator.hasMoreElements()) {</span>
<a href="#l270.377"></a><span id="l270.377">       window.close();</span>
<a href="#l270.378"></a><span id="l270.378">     }</span>
<a href="#l270.379"></a><span id="l270.379">   }</span>
<a href="#l270.380"></a><span id="l270.380" class="difflineminus">-}</span>
<a href="#l270.381"></a><span id="l270.381" class="difflineplus">+});</span>
<a href="#l270.382"></a><span id="l270.382"> </span>
<a href="#l270.383"></a><span id="l270.383"> async function test_bad_session_file_simple() {</span>
<a href="#l270.384"></a><span id="l270.384">   // forcefully write a bad session file</span>
<a href="#l270.385"></a><span id="l270.385">   let data = &quot;BAD SESSION FILE&quot;;</span>
<a href="#l270.386"></a><span id="l270.386">   let fos = FileUtils.openSafeFileOutputStream(SessionStoreManager.sessionFile);</span>
<a href="#l270.387"></a><span id="l270.387">   fos.write(data, data.length);</span>
<a href="#l270.388"></a><span id="l270.388">   FileUtils.closeSafeFileOutputStream(fos);</span>
<a href="#l270.389"></a><span id="l270.389"> </span>
<a href="#l270.390"></a><span id="l270.390">   // tell the session store manager to try loading the bad session file.</span>
<a href="#l270.391"></a><span id="l270.391">   // NOTE: periodic session persistence is not enabled in this test</span>
<a href="#l270.392"></a><span id="l270.392">   SessionStoreManager._store = null;</span>
<a href="#l270.393"></a><span id="l270.393">   await SessionStoreManager._loadSessionFile();</span>
<a href="#l270.394"></a><span id="l270.394"> </span>
<a href="#l270.395"></a><span id="l270.395">   // since the session file is bad, the session store manager's state field</span>
<a href="#l270.396"></a><span id="l270.396">   // should be null</span>
<a href="#l270.397"></a><span id="l270.397" class="difflineminus">-  assert_false(</span>
<a href="#l270.398"></a><span id="l270.398" class="difflineminus">-    SessionStoreManager._initialState,</span>
<a href="#l270.399"></a><span id="l270.399" class="difflineplus">+  Assert.ok(</span>
<a href="#l270.400"></a><span id="l270.400" class="difflineplus">+    !SessionStoreManager._initialState,</span>
<a href="#l270.401"></a><span id="l270.401">     &quot;saved state is bad so state object should be null&quot;</span>
<a href="#l270.402"></a><span id="l270.402">   );</span>
<a href="#l270.403"></a><span id="l270.403"> </span>
<a href="#l270.404"></a><span id="l270.404">   // The bad session file should now not exist.</span>
<a href="#l270.405"></a><span id="l270.405">   utils.waitFor(</span>
<a href="#l270.406"></a><span id="l270.406">     () =&gt; !SessionStoreManager.sessionFile.exists(),</span>
<a href="#l270.407"></a><span id="l270.407">     &quot;session file should now not exist&quot;</span>
<a href="#l270.408"></a><span id="l270.408">   );</span>
<a href="#l270.409"></a><span id="l270.409"> }</span>
<a href="#l270.410"></a><span id="l270.410"> </span>
<a href="#l270.411"></a><span id="l270.411" class="difflineminus">-function test_clean_shutdown_session_persistence_simple() {</span>
<a href="#l270.412"></a><span id="l270.412" class="difflineplus">+add_task(function test_clean_shutdown_session_persistence_simple() {</span>
<a href="#l270.413"></a><span id="l270.413">   // open a few more 3pane windows</span>
<a href="#l270.414"></a><span id="l270.414">   for (var i = 0; i &lt; 3; ++i) {</span>
<a href="#l270.415"></a><span id="l270.415">     open3PaneWindow();</span>
<a href="#l270.416"></a><span id="l270.416">   }</span>
<a href="#l270.417"></a><span id="l270.417"> </span>
<a href="#l270.418"></a><span id="l270.418">   // make sure we have a different window open, so that we don't start shutting</span>
<a href="#l270.419"></a><span id="l270.419">   // down just because the last window was closed</span>
<a href="#l270.420"></a><span id="l270.420">   let abwc = openAddressBook();</span>
<a href="#l270.421"></a><span id="l270.421" class="difflineat">@@ -547,38 +547,38 @@ function test_clean_shutdown_session_per</span>
<a href="#l270.422"></a><span id="l270.422">   }</span>
<a href="#l270.423"></a><span id="l270.423"> </span>
<a href="#l270.424"></a><span id="l270.424">   // Wait for session file to be created (removed in prior test) after</span>
<a href="#l270.425"></a><span id="l270.425">   // all 3pane windows close and for session write to finish.</span>
<a href="#l270.426"></a><span id="l270.426">   waitForFileRefresh();</span>
<a href="#l270.427"></a><span id="l270.427"> </span>
<a href="#l270.428"></a><span id="l270.428">   // load the saved state from disk</span>
<a href="#l270.429"></a><span id="l270.429">   let loadedState = readFile();</span>
<a href="#l270.430"></a><span id="l270.430" class="difflineminus">-  assert_true(loadedState, &quot;previously saved state should be non-null&quot;);</span>
<a href="#l270.431"></a><span id="l270.431" class="difflineplus">+  Assert.ok(loadedState, &quot;previously saved state should be non-null&quot;);</span>
<a href="#l270.432"></a><span id="l270.432"> </span>
<a href="#l270.433"></a><span id="l270.433" class="difflineminus">-  assert_equals(</span>
<a href="#l270.434"></a><span id="l270.434" class="difflineplus">+  Assert.equal(</span>
<a href="#l270.435"></a><span id="l270.435">     loadedState.windows.length,</span>
<a href="#l270.436"></a><span id="l270.436">     1,</span>
<a href="#l270.437"></a><span id="l270.437">     &quot;only the state of the last 3pane window should have been saved&quot;</span>
<a href="#l270.438"></a><span id="l270.438">   );</span>
<a href="#l270.439"></a><span id="l270.439"> </span>
<a href="#l270.440"></a><span id="l270.440">   // get the state object for the one and only one 3pane window</span>
<a href="#l270.441"></a><span id="l270.441">   let windowState = loadedState.windows[0];</span>
<a href="#l270.442"></a><span id="l270.442" class="difflineminus">-  assert_true(</span>
<a href="#l270.443"></a><span id="l270.443" class="difflineplus">+  Assert.ok(</span>
<a href="#l270.444"></a><span id="l270.444">     JSON.stringify(windowState) == JSON.stringify(lastWindowState),</span>
<a href="#l270.445"></a><span id="l270.445">     &quot;saved state and loaded state should be equal&quot;</span>
<a href="#l270.446"></a><span id="l270.446">   );</span>
<a href="#l270.447"></a><span id="l270.447"> </span>
<a href="#l270.448"></a><span id="l270.448">   open3PaneWindow();</span>
<a href="#l270.449"></a><span id="l270.449"> </span>
<a href="#l270.450"></a><span id="l270.450">   // We don't need the address book window any more.</span>
<a href="#l270.451"></a><span id="l270.451">   plan_for_window_close(abwc);</span>
<a href="#l270.452"></a><span id="l270.452">   abwc.window.close();</span>
<a href="#l270.453"></a><span id="l270.453">   wait_for_window_close();</span>
<a href="#l270.454"></a><span id="l270.454" class="difflineminus">-}</span>
<a href="#l270.455"></a><span id="l270.455" class="difflineplus">+});</span>
<a href="#l270.456"></a><span id="l270.456"> </span>
<a href="#l270.457"></a><span id="l270.457"> /*</span>
<a href="#l270.458"></a><span id="l270.458">  * A set of private helper functions for drag'n'drop</span>
<a href="#l270.459"></a><span id="l270.459">  * These functions are inspired by tabmail/test-tabmail-dragndrop.js</span>
<a href="#l270.460"></a><span id="l270.460">  */</span>
<a href="#l270.461"></a><span id="l270.461"> </span>
<a href="#l270.462"></a><span id="l270.462"> function _move_splitter(aSplitter, aDiffX, aDiffY) {</span>
<a href="#l270.463"></a><span id="l270.463">   // catch the splitter in the middle</span>
<a href="#l270.464"></a><span id="l270.464" class="difflineat">@@ -608,17 +608,17 @@ function _move_splitter(aSplitter, aDiff</span>
<a href="#l270.465"></a><span id="l270.465">  * values against some given tolerance.</span>
<a href="#l270.466"></a><span id="l270.466">  *</span>
<a href="#l270.467"></a><span id="l270.467">  * @param aLeft one value to check equivalence with</span>
<a href="#l270.468"></a><span id="l270.468">  * @param aRight the other value to check equivalence with</span>
<a href="#l270.469"></a><span id="l270.469">  * @param aTolerance how fuzzy can our equivalence be?</span>
<a href="#l270.470"></a><span id="l270.470">  * @param aMessage the message to give off if we're outside of tolerance.</span>
<a href="#l270.471"></a><span id="l270.471">  */</span>
<a href="#l270.472"></a><span id="l270.472"> function assert_equals_fuzzy(aLeft, aRight, aTolerance, aMessage) {</span>
<a href="#l270.473"></a><span id="l270.473" class="difflineminus">-  assert_true(Math.abs(aLeft - aRight) &lt;= aTolerance, aMessage);</span>
<a href="#l270.474"></a><span id="l270.474" class="difflineplus">+  Assert.ok(Math.abs(aLeft - aRight) &lt;= aTolerance, aMessage);</span>
<a href="#l270.475"></a><span id="l270.475"> }</span>
<a href="#l270.476"></a><span id="l270.476"> </span>
<a href="#l270.477"></a><span id="l270.477"> // XXX todo</span>
<a href="#l270.478"></a><span id="l270.478"> // - crash test: not sure if this test should be here. restoring a crashed</span>
<a href="#l270.479"></a><span id="l270.479"> //               session depends on periodically saved session data (there is</span>
<a href="#l270.480"></a><span id="l270.480"> //               already a test for this). session restoration tests do not</span>
<a href="#l270.481"></a><span id="l270.481"> //               belong here. see test-message-pane-visibility.</span>
<a href="#l270.482"></a><span id="l270.482"> //               when testing restoration in test-message-pane-visibility, also</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l271.1"></a><span id="l271.1">new file mode 100644</span>
<a href="#l271.2"></a><span id="l271.2" class="difflineminus">--- /dev/null</span>
<a href="#l271.3"></a><span id="l271.3" class="difflineplus">+++ b/mail/test/browser/smime/browser.ini</span>
<a href="#l271.4"></a><span id="l271.4" class="difflineat">@@ -0,0 +1,15 @@</span>
<a href="#l271.5"></a><span id="l271.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l271.6"></a><span id="l271.6" class="difflineplus">+prefs =</span>
<a href="#l271.7"></a><span id="l271.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l271.8"></a><span id="l271.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l271.9"></a><span id="l271.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l271.10"></a><span id="l271.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l271.11"></a><span id="l271.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l271.12"></a><span id="l271.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l271.13"></a><span id="l271.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l271.14"></a><span id="l271.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l271.15"></a><span id="l271.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l271.16"></a><span id="l271.16" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l271.17"></a><span id="l271.17" class="difflineplus">+support-files = data/**</span>
<a href="#l271.18"></a><span id="l271.18" class="difflineplus">+</span>
<a href="#l271.19"></a><span id="l271.19" class="difflineplus">+[browser_multipartAlternative.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l272.1"></a><span id="l272.1">copy from mail/test/mozmill/smime/test-smime-multipart-alternative.js</span>
<a href="#l272.2"></a><span id="l272.2">copy to mail/test/browser/smime/browser_multipartAlternative.js</span>
<a href="#l272.3"></a><span id="l272.3" class="difflineminus">--- a/mail/test/mozmill/smime/test-smime-multipart-alternative.js</span>
<a href="#l272.4"></a><span id="l272.4" class="difflineplus">+++ b/mail/test/browser/smime/browser_multipartAlternative.js</span>
<a href="#l272.5"></a><span id="l272.5" class="difflineat">@@ -5,67 +5,65 @@</span>
<a href="#l272.6"></a><span id="l272.6"> /**</span>
<a href="#l272.7"></a><span id="l272.7">  * Test that a reply to a multipart/alternative message with two</span>
<a href="#l272.8"></a><span id="l272.8">  * encrypted parts doesn't leak the secret plaintext from the second</span>
<a href="#l272.9"></a><span id="l272.9">  * part.</span>
<a href="#l272.10"></a><span id="l272.10">  */</span>
<a href="#l272.11"></a><span id="l272.11"> </span>
<a href="#l272.12"></a><span id="l272.12"> &quot;use strict&quot;;</span>
<a href="#l272.13"></a><span id="l272.13"> </span>
<a href="#l272.14"></a><span id="l272.14" class="difflineminus">-var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l272.15"></a><span id="l272.15" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l272.16"></a><span id="l272.16"> </span>
<a href="#l272.17"></a><span id="l272.17"> var {</span>
<a href="#l272.18"></a><span id="l272.18">   close_compose_window,</span>
<a href="#l272.19"></a><span id="l272.19">   get_msg_source,</span>
<a href="#l272.20"></a><span id="l272.20">   open_compose_with_reply,</span>
<a href="#l272.21"></a><span id="l272.21"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;);</span>
<a href="#l272.22"></a><span id="l272.22"> var {</span>
<a href="#l272.23"></a><span id="l272.23" class="difflineminus">-  assert_false,</span>
<a href="#l272.24"></a><span id="l272.24">   be_in_folder,</span>
<a href="#l272.25"></a><span id="l272.25">   get_special_folder,</span>
<a href="#l272.26"></a><span id="l272.26">   open_message_from_file,</span>
<a href="#l272.27"></a><span id="l272.27">   press_delete,</span>
<a href="#l272.28"></a><span id="l272.28">   select_click_row,</span>
<a href="#l272.29"></a><span id="l272.29">   smimeUtils_ensureNSS,</span>
<a href="#l272.30"></a><span id="l272.30">   smimeUtils_loadCertificateAndKey,</span>
<a href="#l272.31"></a><span id="l272.31">   smimeUtils_loadPEMCertificate,</span>
<a href="#l272.32"></a><span id="l272.32"> } = ChromeUtils.import(</span>
<a href="#l272.33"></a><span id="l272.33">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l272.34"></a><span id="l272.34"> );</span>
<a href="#l272.35"></a><span id="l272.35"> var { close_window } = ChromeUtils.import(</span>
<a href="#l272.36"></a><span id="l272.36">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l272.37"></a><span id="l272.37"> );</span>
<a href="#l272.38"></a><span id="l272.38"> </span>
<a href="#l272.39"></a><span id="l272.39" class="difflineplus">+var { FileUtils } = ChromeUtils.import(&quot;resource://gre/modules/FileUtils.jsm&quot;);</span>
<a href="#l272.40"></a><span id="l272.40"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l272.41"></a><span id="l272.41"> var { MailServices } = ChromeUtils.import(</span>
<a href="#l272.42"></a><span id="l272.42">   &quot;resource:///modules/MailServices.jsm&quot;</span>
<a href="#l272.43"></a><span id="l272.43"> );</span>
<a href="#l272.44"></a><span id="l272.44"> </span>
<a href="#l272.45"></a><span id="l272.45"> var gDrafts;</span>
<a href="#l272.46"></a><span id="l272.46"> </span>
<a href="#l272.47"></a><span id="l272.47" class="difflineminus">-function setupModule(module) {</span>
<a href="#l272.48"></a><span id="l272.48" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l272.49"></a><span id="l272.49">   gDrafts = get_special_folder(Ci.nsMsgFolderFlags.Drafts, true);</span>
<a href="#l272.50"></a><span id="l272.50"> </span>
<a href="#l272.51"></a><span id="l272.51">   Services.prefs.setBoolPref(&quot;mail.identity.id1.compose_html&quot;, true);</span>
<a href="#l272.52"></a><span id="l272.52" class="difflineminus">-}</span>
<a href="#l272.53"></a><span id="l272.53" class="difflineplus">+});</span>
<a href="#l272.54"></a><span id="l272.54"> </span>
<a href="#l272.55"></a><span id="l272.55" class="difflineminus">-function get_file_for_path(path) {</span>
<a href="#l272.56"></a><span id="l272.56" class="difflineminus">-  return os.getFileForPath(os.abspath(path, os.getFileForPath(__file__)));</span>
<a href="#l272.57"></a><span id="l272.57" class="difflineminus">-}</span>
<a href="#l272.58"></a><span id="l272.58" class="difflineminus">-</span>
<a href="#l272.59"></a><span id="l272.59" class="difflineminus">-function test_multipart_alternative() {</span>
<a href="#l272.60"></a><span id="l272.60" class="difflineplus">+add_task(function test_multipart_alternative() {</span>
<a href="#l272.61"></a><span id="l272.61">   smimeUtils_ensureNSS();</span>
<a href="#l272.62"></a><span id="l272.62">   smimeUtils_loadPEMCertificate(</span>
<a href="#l272.63"></a><span id="l272.63" class="difflineminus">-    get_file_for_path(&quot;./TestCA.pem&quot;),</span>
<a href="#l272.64"></a><span id="l272.64" class="difflineplus">+    new FileUtils.File(getTestFilePath(&quot;data/TestCA.pem&quot;)),</span>
<a href="#l272.65"></a><span id="l272.65">     Ci.nsIX509Cert.CA_CERT</span>
<a href="#l272.66"></a><span id="l272.66">   );</span>
<a href="#l272.67"></a><span id="l272.67" class="difflineminus">-  smimeUtils_loadCertificateAndKey(get_file_for_path(&quot;./Bob.p12&quot;));</span>
<a href="#l272.68"></a><span id="l272.68" class="difflineplus">+  smimeUtils_loadCertificateAndKey(</span>
<a href="#l272.69"></a><span id="l272.69" class="difflineplus">+    new FileUtils.File(getTestFilePath(&quot;data/Bob.p12&quot;))</span>
<a href="#l272.70"></a><span id="l272.70" class="difflineplus">+  );</span>
<a href="#l272.71"></a><span id="l272.71"> </span>
<a href="#l272.72"></a><span id="l272.72">   let msgc = open_message_from_file(</span>
<a href="#l272.73"></a><span id="l272.73" class="difflineminus">-    get_file_for_path(&quot;./multipart-alternative.eml&quot;)</span>
<a href="#l272.74"></a><span id="l272.74" class="difflineplus">+    new FileUtils.File(getTestFilePath(&quot;data/multipart-alternative.eml&quot;))</span>
<a href="#l272.75"></a><span id="l272.75">   );</span>
<a href="#l272.76"></a><span id="l272.76"> </span>
<a href="#l272.77"></a><span id="l272.77">   let cwc = open_compose_with_reply(msgc);</span>
<a href="#l272.78"></a><span id="l272.78"> </span>
<a href="#l272.79"></a><span id="l272.79">   close_window(msgc);</span>
<a href="#l272.80"></a><span id="l272.80"> </span>
<a href="#l272.81"></a><span id="l272.81">   // Now save the message as a draft.</span>
<a href="#l272.82"></a><span id="l272.82">   cwc.keypress(null, &quot;s&quot;, { shiftKey: false, accelKey: true });</span>
<a href="#l272.83"></a><span id="l272.83" class="difflineat">@@ -73,20 +71,20 @@ function test_multipart_alternative() {</span>
<a href="#l272.84"></a><span id="l272.84"> </span>
<a href="#l272.85"></a><span id="l272.85">   // Now check the message content in the drafts folder.</span>
<a href="#l272.86"></a><span id="l272.86">   be_in_folder(gDrafts);</span>
<a href="#l272.87"></a><span id="l272.87">   let message = select_click_row(0);</span>
<a href="#l272.88"></a><span id="l272.88">   let messageContent = get_msg_source(message);</span>
<a href="#l272.89"></a><span id="l272.89"> </span>
<a href="#l272.90"></a><span id="l272.90">   // Check for a single line that contains text and make sure there is a</span>
<a href="#l272.91"></a><span id="l272.91">   // space at the end for a flowed reply.</span>
<a href="#l272.92"></a><span id="l272.92" class="difflineminus">-  assert_false(</span>
<a href="#l272.93"></a><span id="l272.93" class="difflineminus">-    messageContent.includes(&quot;SECRET-TEXT&quot;),</span>
<a href="#l272.94"></a><span id="l272.94" class="difflineplus">+  Assert.ok(</span>
<a href="#l272.95"></a><span id="l272.95" class="difflineplus">+    !messageContent.includes(&quot;SECRET-TEXT&quot;),</span>
<a href="#l272.96"></a><span id="l272.96">     &quot;Secret text was found, but shouldn't be there.&quot;</span>
<a href="#l272.97"></a><span id="l272.97">   );</span>
<a href="#l272.98"></a><span id="l272.98"> </span>
<a href="#l272.99"></a><span id="l272.99">   // Delete the outgoing message.</span>
<a href="#l272.100"></a><span id="l272.100">   press_delete();</span>
<a href="#l272.101"></a><span id="l272.101" class="difflineminus">-}</span>
<a href="#l272.102"></a><span id="l272.102" class="difflineplus">+});</span>
<a href="#l272.103"></a><span id="l272.103"> </span>
<a href="#l272.104"></a><span id="l272.104" class="difflineminus">-function teardownModule() {</span>
<a href="#l272.105"></a><span id="l272.105" class="difflineplus">+registerCleanupFunction(function teardownModule() {</span>
<a href="#l272.106"></a><span id="l272.106">   Services.prefs.clearUserPref(&quot;mail.identity.id1.compose_html&quot;);</span>
<a href="#l272.107"></a><span id="l272.107" class="difflineminus">-}</span>
<a href="#l272.108"></a><span id="l272.108" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l273.1"></a><span id="l273.1">copy from mail/test/mozmill/smime/Bob.p12</span>
<a href="#l273.2"></a><span id="l273.2">copy to mail/test/browser/smime/data/Bob.p12</span>
<a href="#l273.3"></a><span id="l273.3"></span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l274.1"></a><span id="l274.1">copy from mail/test/mozmill/smime/README.md</span>
<a href="#l274.2"></a><span id="l274.2">copy to mail/test/browser/smime/data/README.md</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l275.1"></a><span id="l275.1">copy from mail/test/mozmill/smime/TestCA.pem</span>
<a href="#l275.2"></a><span id="l275.2">copy to mail/test/browser/smime/data/TestCA.pem</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l276.1"></a><span id="l276.1">copy from mail/test/mozmill/smime/multipart-alternative.eml</span>
<a href="#l276.2"></a><span id="l276.2">copy to mail/test/browser/smime/data/multipart-alternative.eml</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l277.1"></a><span id="l277.1">new file mode 100644</span>
<a href="#l277.2"></a><span id="l277.2" class="difflineminus">--- /dev/null</span>
<a href="#l277.3"></a><span id="l277.3" class="difflineplus">+++ b/mail/test/browser/startup-firstrun/browser.ini</span>
<a href="#l277.4"></a><span id="l277.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l277.5"></a><span id="l277.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l277.6"></a><span id="l277.6" class="difflineplus">+prefs =</span>
<a href="#l277.7"></a><span id="l277.7" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l277.8"></a><span id="l277.8" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l277.9"></a><span id="l277.9" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l277.10"></a><span id="l277.10" class="difflineplus">+  mail.provider.enabled=false,</span>
<a href="#l277.11"></a><span id="l277.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l277.12"></a><span id="l277.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l277.13"></a><span id="l277.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l277.14"></a><span id="l277.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l277.15"></a><span id="l277.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l277.16"></a><span id="l277.16" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l277.17"></a><span id="l277.17" class="difflineplus">+</span>
<a href="#l277.18"></a><span id="l277.18" class="difflineplus">+[browser_menubarCollapsed.js]</span>
<a href="#l277.19"></a><span id="l277.19" class="difflineplus">+skip-if = true</span>
<a href="#l277.20"></a><span id="l277.20" class="difflineplus">+# skip-if = os == &quot;mac&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l278.1"></a><span id="l278.1">copy from mail/test/mozmill/startup-firstrun/test-menubar-collapsed.js</span>
<a href="#l278.2"></a><span id="l278.2">copy to mail/test/browser/startup-firstrun/browser_menubarCollapsed.js</span>
<a href="#l278.3"></a><span id="l278.3" class="difflineminus">--- a/mail/test/mozmill/startup-firstrun/test-menubar-collapsed.js</span>
<a href="#l278.4"></a><span id="l278.4" class="difflineplus">+++ b/mail/test/browser/startup-firstrun/browser_menubarCollapsed.js</span>
<a href="#l278.5"></a><span id="l278.5" class="difflineat">@@ -4,26 +4,26 @@</span>
<a href="#l278.6"></a><span id="l278.6"> </span>
<a href="#l278.7"></a><span id="l278.7"> /**</span>
<a href="#l278.8"></a><span id="l278.8">  * Tests that the main menu will be collapsed by default if Thunderbird starts</span>
<a href="#l278.9"></a><span id="l278.9">  * with no accounts created.</span>
<a href="#l278.10"></a><span id="l278.10">  */</span>
<a href="#l278.11"></a><span id="l278.11"> </span>
<a href="#l278.12"></a><span id="l278.12"> &quot;use strict&quot;;</span>
<a href="#l278.13"></a><span id="l278.13"> </span>
<a href="#l278.14"></a><span id="l278.14" class="difflineminus">-var { assert_equals, mc } = ChromeUtils.import(</span>
<a href="#l278.15"></a><span id="l278.15" class="difflineplus">+var { mc } = ChromeUtils.import(</span>
<a href="#l278.16"></a><span id="l278.16">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l278.17"></a><span id="l278.17"> );</span>
<a href="#l278.18"></a><span id="l278.18"> var { close_window, wait_for_existing_window } = ChromeUtils.import(</span>
<a href="#l278.19"></a><span id="l278.19">   &quot;resource://testing-common/mozmill/WindowHelpers.jsm&quot;</span>
<a href="#l278.20"></a><span id="l278.20"> );</span>
<a href="#l278.21"></a><span id="l278.21"> </span>
<a href="#l278.22"></a><span id="l278.22"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l278.23"></a><span id="l278.23"> </span>
<a href="#l278.24"></a><span id="l278.24" class="difflineminus">-function test_main_menu_collapsed() {</span>
<a href="#l278.25"></a><span id="l278.25" class="difflineplus">+add_task(function test_main_menu_collapsed() {</span>
<a href="#l278.26"></a><span id="l278.26">   // Due to random oranges on slower machines, we need to ensure that startup</span>
<a href="#l278.27"></a><span id="l278.27">   // is complete before running this test.</span>
<a href="#l278.28"></a><span id="l278.28">   let done = false;</span>
<a href="#l278.29"></a><span id="l278.29">   let observer = {</span>
<a href="#l278.30"></a><span id="l278.30">     observe(aSubject, aTopic, aData) {</span>
<a href="#l278.31"></a><span id="l278.31">       if (aTopic == &quot;mail-startup-done&quot;) {</span>
<a href="#l278.32"></a><span id="l278.32">         done = true;</span>
<a href="#l278.33"></a><span id="l278.33">       }</span>
<a href="#l278.34"></a><span id="l278.34" class="difflineat">@@ -36,17 +36,16 @@ function test_main_menu_collapsed() {</span>
<a href="#l278.35"></a><span id="l278.35">   // cause mail-startup-done to eventually be fired.</span>
<a href="#l278.36"></a><span id="l278.36">   let wizard = wait_for_existing_window(&quot;mail:autoconfig&quot;);</span>
<a href="#l278.37"></a><span id="l278.37">   close_window(wizard);</span>
<a href="#l278.38"></a><span id="l278.38"> </span>
<a href="#l278.39"></a><span id="l278.39">   // Spin the event loop until mail-startup-done is fired.</span>
<a href="#l278.40"></a><span id="l278.40">   mc.waitFor(() =&gt; done);</span>
<a href="#l278.41"></a><span id="l278.41"> </span>
<a href="#l278.42"></a><span id="l278.42">   let mainMenu = mc.e(&quot;mail-toolbar-menubar2&quot;);</span>
<a href="#l278.43"></a><span id="l278.43" class="difflineminus">-  assert_equals(</span>
<a href="#l278.44"></a><span id="l278.44" class="difflineplus">+  Assert.equal(</span>
<a href="#l278.45"></a><span id="l278.45">     mainMenu.getAttribute(&quot;autohide&quot;),</span>
<a href="#l278.46"></a><span id="l278.46">     &quot;true&quot;,</span>
<a href="#l278.47"></a><span id="l278.47">     &quot;The main menu should have the autohide attribute set to true.&quot;</span>
<a href="#l278.48"></a><span id="l278.48">   );</span>
<a href="#l278.49"></a><span id="l278.49"> </span>
<a href="#l278.50"></a><span id="l278.50">   Services.obs.removeObserver(observer, &quot;mail-startup-done&quot;);</span>
<a href="#l278.51"></a><span id="l278.51" class="difflineminus">-}</span>
<a href="#l278.52"></a><span id="l278.52" class="difflineminus">-test_main_menu_collapsed.EXCLUDED_PLATFORMS = [&quot;Darwin&quot;];</span>
<a href="#l278.53"></a><span id="l278.53" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l279.1"></a><span id="l279.1">new file mode 100644</span>
<a href="#l279.2"></a><span id="l279.2" class="difflineminus">--- /dev/null</span>
<a href="#l279.3"></a><span id="l279.3" class="difflineplus">+++ b/mail/test/browser/subscribe/browser.ini</span>
<a href="#l279.4"></a><span id="l279.4" class="difflineat">@@ -0,0 +1,13 @@</span>
<a href="#l279.5"></a><span id="l279.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l279.6"></a><span id="l279.6" class="difflineplus">+prefs =</span>
<a href="#l279.7"></a><span id="l279.7" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l279.8"></a><span id="l279.8" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l279.9"></a><span id="l279.9" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l279.10"></a><span id="l279.10" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l279.11"></a><span id="l279.11" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l279.12"></a><span id="l279.12" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l279.13"></a><span id="l279.13" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l279.14"></a><span id="l279.14" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l279.15"></a><span id="l279.15" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l279.16"></a><span id="l279.16" class="difflineplus">+</span>
<a href="#l279.17"></a><span id="l279.17" class="difflineplus">+[browser_newsFilter.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l280.1"></a><span id="l280.1">copy from mail/test/mozmill/subscribe/test-subscribe-news-filter.js</span>
<a href="#l280.2"></a><span id="l280.2">copy to mail/test/browser/subscribe/browser_newsFilter.js</span>
<a href="#l280.3"></a><span id="l280.3" class="difflineminus">--- a/mail/test/mozmill/subscribe/test-subscribe-news-filter.js</span>
<a href="#l280.4"></a><span id="l280.4" class="difflineplus">+++ b/mail/test/browser/subscribe/browser_newsFilter.js</span>
<a href="#l280.5"></a><span id="l280.5" class="difflineat">@@ -1,17 +1,17 @@</span>
<a href="#l280.6"></a><span id="l280.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l280.7"></a><span id="l280.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l280.8"></a><span id="l280.8">  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l280.9"></a><span id="l280.9"> </span>
<a href="#l280.10"></a><span id="l280.10"> /* Test that the subscribe window for news servers has working autocomplete. */</span>
<a href="#l280.11"></a><span id="l280.11"> </span>
<a href="#l280.12"></a><span id="l280.12"> &quot;use strict&quot;;</span>
<a href="#l280.13"></a><span id="l280.13"> </span>
<a href="#l280.14"></a><span id="l280.14" class="difflineminus">-var utils = ChromeUtils.import(&quot;chrome://mozmill/content/modules/utils.jsm&quot;);</span>
<a href="#l280.15"></a><span id="l280.15" class="difflineplus">+var utils = ChromeUtils.import(&quot;resource://testing-common/mozmill/utils.jsm&quot;);</span>
<a href="#l280.16"></a><span id="l280.16"> </span>
<a href="#l280.17"></a><span id="l280.17"> var {</span>
<a href="#l280.18"></a><span id="l280.18">   NNTP_PORT,</span>
<a href="#l280.19"></a><span id="l280.19">   setupLocalServer,</span>
<a href="#l280.20"></a><span id="l280.20">   setupNNTPDaemon,</span>
<a href="#l280.21"></a><span id="l280.21">   shutdownNNTPServer,</span>
<a href="#l280.22"></a><span id="l280.22">   startupNNTPServer,</span>
<a href="#l280.23"></a><span id="l280.23"> } = ChromeUtils.import(&quot;resource://testing-common/mozmill/NNTPHelpers.jsm&quot;);</span>
<a href="#l280.24"></a><span id="l280.24" class="difflineat">@@ -23,24 +23,31 @@ var {</span>
<a href="#l280.25"></a><span id="l280.25">   &quot;resource://testing-common/mozmill/SubscribeWindowHelpers.jsm&quot;</span>
<a href="#l280.26"></a><span id="l280.26"> );</span>
<a href="#l280.27"></a><span id="l280.27"> </span>
<a href="#l280.28"></a><span id="l280.28"> /**</span>
<a href="#l280.29"></a><span id="l280.29">  * Checks that the filter in the subscribe window works correctly</span>
<a href="#l280.30"></a><span id="l280.30">  * (shows only newsgroups matching all of several search strings</span>
<a href="#l280.31"></a><span id="l280.31">  * separated by whitespace)</span>
<a href="#l280.32"></a><span id="l280.32">  */</span>
<a href="#l280.33"></a><span id="l280.33" class="difflineminus">-function test_subscribe_newsgroup_filter() {</span>
<a href="#l280.34"></a><span id="l280.34" class="difflineplus">+add_task(function test_subscribe_newsgroup_filter() {</span>
<a href="#l280.35"></a><span id="l280.35">   var daemon = setupNNTPDaemon();</span>
<a href="#l280.36"></a><span id="l280.36">   var remoteServer = startupNNTPServer(daemon, NNTP_PORT);</span>
<a href="#l280.37"></a><span id="l280.37">   let server = setupLocalServer(NNTP_PORT);</span>
<a href="#l280.38"></a><span id="l280.38">   let rootFolder = server.rootFolder;</span>
<a href="#l280.39"></a><span id="l280.39">   open_subscribe_window_from_context_menu(rootFolder, filter_test_helper);</span>
<a href="#l280.40"></a><span id="l280.40">   shutdownNNTPServer(remoteServer);</span>
<a href="#l280.41"></a><span id="l280.41" class="difflineminus">-}</span>
<a href="#l280.42"></a><span id="l280.42" class="difflineplus">+</span>
<a href="#l280.43"></a><span id="l280.43" class="difflineplus">+  Assert.report(</span>
<a href="#l280.44"></a><span id="l280.44" class="difflineplus">+    false,</span>
<a href="#l280.45"></a><span id="l280.45" class="difflineplus">+    undefined,</span>
<a href="#l280.46"></a><span id="l280.46" class="difflineplus">+    undefined,</span>
<a href="#l280.47"></a><span id="l280.47" class="difflineplus">+    &quot;Test ran to completion successfully&quot;</span>
<a href="#l280.48"></a><span id="l280.48" class="difflineplus">+  );</span>
<a href="#l280.49"></a><span id="l280.49" class="difflineplus">+});</span>
<a href="#l280.50"></a><span id="l280.50"> </span>
<a href="#l280.51"></a><span id="l280.51"> /**</span>
<a href="#l280.52"></a><span id="l280.52">  * Helper function (callback), needed because the subscribe window is modal.</span>
<a href="#l280.53"></a><span id="l280.53">  * @param swc Controller for the subscribe window</span>
<a href="#l280.54"></a><span id="l280.54">  */</span>
<a href="#l280.55"></a><span id="l280.55"> function filter_test_helper(swc) {</span>
<a href="#l280.56"></a><span id="l280.56">   enter_text_in_search_box(swc, &quot;subscribe empty&quot;);</span>
<a href="#l280.57"></a><span id="l280.57">   utils.waitFor(</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l281.1"></a><span id="l281.1">new file mode 100644</span>
<a href="#l281.2"></a><span id="l281.2" class="difflineminus">--- /dev/null</span>
<a href="#l281.3"></a><span id="l281.3" class="difflineplus">+++ b/mail/test/browser/tabmail/browser.ini</span>
<a href="#l281.4"></a><span id="l281.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l281.5"></a><span id="l281.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l281.6"></a><span id="l281.6" class="difflineplus">+prefs =</span>
<a href="#l281.7"></a><span id="l281.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l281.8"></a><span id="l281.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l281.9"></a><span id="l281.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l281.10"></a><span id="l281.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l281.11"></a><span id="l281.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l281.12"></a><span id="l281.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l281.13"></a><span id="l281.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l281.14"></a><span id="l281.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l281.15"></a><span id="l281.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l281.16"></a><span id="l281.16" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l281.17"></a><span id="l281.17" class="difflineplus">+</span>
<a href="#l281.18"></a><span id="l281.18" class="difflineplus">+[browser_closing.js]</span>
<a href="#l281.19"></a><span id="l281.19" class="difflineplus">+[browser_customize.js]</span>
<a href="#l281.20"></a><span id="l281.20" class="difflineplus">+[browser_dragndrop.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l282.1"></a><span id="l282.1">copy from mail/test/mozmill/tabmail/test-tabmail-closing.js</span>
<a href="#l282.2"></a><span id="l282.2">copy to mail/test/browser/tabmail/browser_closing.js</span>
<a href="#l282.3"></a><span id="l282.3" class="difflineminus">--- a/mail/test/mozmill/tabmail/test-tabmail-closing.js</span>
<a href="#l282.4"></a><span id="l282.4" class="difflineplus">+++ b/mail/test/browser/tabmail/browser_closing.js</span>
<a href="#l282.5"></a><span id="l282.5" class="difflineat">@@ -4,17 +4,16 @@</span>
<a href="#l282.6"></a><span id="l282.6"> </span>
<a href="#l282.7"></a><span id="l282.7"> /*</span>
<a href="#l282.8"></a><span id="l282.8">  * Test tabmail behaviour when tabs close.</span>
<a href="#l282.9"></a><span id="l282.9">  */</span>
<a href="#l282.10"></a><span id="l282.10"> </span>
<a href="#l282.11"></a><span id="l282.11"> &quot;use strict&quot;;</span>
<a href="#l282.12"></a><span id="l282.12"> </span>
<a href="#l282.13"></a><span id="l282.13"> var {</span>
<a href="#l282.14"></a><span id="l282.14" class="difflineminus">-  assert_equals,</span>
<a href="#l282.15"></a><span id="l282.15">   assert_selected_tab,</span>
<a href="#l282.16"></a><span id="l282.16">   be_in_folder,</span>
<a href="#l282.17"></a><span id="l282.17">   collapse_all_threads,</span>
<a href="#l282.18"></a><span id="l282.18">   create_folder,</span>
<a href="#l282.19"></a><span id="l282.19">   make_display_threaded,</span>
<a href="#l282.20"></a><span id="l282.20">   make_new_sets_in_folder,</span>
<a href="#l282.21"></a><span id="l282.21">   mc,</span>
<a href="#l282.22"></a><span id="l282.22">   open_selected_message_in_new_tab,</span>
<a href="#l282.23"></a><span id="l282.23" class="difflineat">@@ -24,26 +23,26 @@ var {</span>
<a href="#l282.24"></a><span id="l282.24"> } = ChromeUtils.import(</span>
<a href="#l282.25"></a><span id="l282.25">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l282.26"></a><span id="l282.26"> );</span>
<a href="#l282.27"></a><span id="l282.27"> </span>
<a href="#l282.28"></a><span id="l282.28"> var gFolder;</span>
<a href="#l282.29"></a><span id="l282.29"> </span>
<a href="#l282.30"></a><span id="l282.30"> var MSGS_PER_THREAD = 3;</span>
<a href="#l282.31"></a><span id="l282.31"> </span>
<a href="#l282.32"></a><span id="l282.32" class="difflineminus">-function setupModule(module) {</span>
<a href="#l282.33"></a><span id="l282.33" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l282.34"></a><span id="l282.34">   gFolder = create_folder(&quot;test-tabmail-closing folder&quot;);</span>
<a href="#l282.35"></a><span id="l282.35">   make_new_sets_in_folder(gFolder, [{ msgsPerThread: MSGS_PER_THREAD }]);</span>
<a href="#l282.36"></a><span id="l282.36" class="difflineminus">-}</span>
<a href="#l282.37"></a><span id="l282.37" class="difflineplus">+});</span>
<a href="#l282.38"></a><span id="l282.38"> </span>
<a href="#l282.39"></a><span id="l282.39"> /**</span>
<a href="#l282.40"></a><span id="l282.40">  * Test that if we open up a message in a tab from the inbox tab, that</span>
<a href="#l282.41"></a><span id="l282.41">  * if we immediately close that tab, we switch back to the inbox tab.</span>
<a href="#l282.42"></a><span id="l282.42">  */</span>
<a href="#l282.43"></a><span id="l282.43" class="difflineminus">-function test_closed_single_message_tab_returns_to_inbox() {</span>
<a href="#l282.44"></a><span id="l282.44" class="difflineplus">+add_task(function test_closed_single_message_tab_returns_to_inbox() {</span>
<a href="#l282.45"></a><span id="l282.45">   be_in_folder(gFolder);</span>
<a href="#l282.46"></a><span id="l282.46">   make_display_threaded();</span>
<a href="#l282.47"></a><span id="l282.47">   let inboxTab = mc.tabmail.currentTabInfo;</span>
<a href="#l282.48"></a><span id="l282.48"> </span>
<a href="#l282.49"></a><span id="l282.49">   select_click_row(0);</span>
<a href="#l282.50"></a><span id="l282.50">   // Open a message in a new tab...</span>
<a href="#l282.51"></a><span id="l282.51">   open_selected_message_in_new_tab(false);</span>
<a href="#l282.52"></a><span id="l282.52"> </span>
<a href="#l282.53"></a><span id="l282.53" class="difflineat">@@ -55,24 +54,24 @@ function test_closed_single_message_tab_</span>
<a href="#l282.54"></a><span id="l282.54">   // Close the second tab</span>
<a href="#l282.55"></a><span id="l282.55">   mc.tabmail.closeTab(2);</span>
<a href="#l282.56"></a><span id="l282.56"> </span>
<a href="#l282.57"></a><span id="l282.57">   // We should have gone back to the inbox tab</span>
<a href="#l282.58"></a><span id="l282.58">   assert_selected_tab(inboxTab);</span>
<a href="#l282.59"></a><span id="l282.59"> </span>
<a href="#l282.60"></a><span id="l282.60">   // Close the first tab</span>
<a href="#l282.61"></a><span id="l282.61">   mc.tabmail.closeTab(1);</span>
<a href="#l282.62"></a><span id="l282.62" class="difflineminus">-}</span>
<a href="#l282.63"></a><span id="l282.63" class="difflineplus">+});</span>
<a href="#l282.64"></a><span id="l282.64"> </span>
<a href="#l282.65"></a><span id="l282.65"> /**</span>
<a href="#l282.66"></a><span id="l282.66">  * Test that if we open up some message tabs from the inbox tab, and then</span>
<a href="#l282.67"></a><span id="l282.67">  * switch around in those tabs, closing the tabs doesn't immediately jump</span>
<a href="#l282.68"></a><span id="l282.68">  * you back to the inbox tab.</span>
<a href="#l282.69"></a><span id="l282.69">  */</span>
<a href="#l282.70"></a><span id="l282.70" class="difflineminus">-function test_does_not_go_to_opener_if_switched() {</span>
<a href="#l282.71"></a><span id="l282.71" class="difflineplus">+add_task(function test_does_not_go_to_opener_if_switched() {</span>
<a href="#l282.72"></a><span id="l282.72">   be_in_folder(gFolder);</span>
<a href="#l282.73"></a><span id="l282.73">   make_display_threaded();</span>
<a href="#l282.74"></a><span id="l282.74"> </span>
<a href="#l282.75"></a><span id="l282.75">   select_click_row(0);</span>
<a href="#l282.76"></a><span id="l282.76">   // Open a message in a new tab...</span>
<a href="#l282.77"></a><span id="l282.77">   open_selected_message_in_new_tab(false);</span>
<a href="#l282.78"></a><span id="l282.78"> </span>
<a href="#l282.79"></a><span id="l282.79">   // Open a second message in a new tab...</span>
<a href="#l282.80"></a><span id="l282.80" class="difflineat">@@ -90,38 +89,38 @@ function test_does_not_go_to_opener_if_s</span>
<a href="#l282.81"></a><span id="l282.81">   // Close the second tab</span>
<a href="#l282.82"></a><span id="l282.82">   mc.tabmail.closeTab(2);</span>
<a href="#l282.83"></a><span id="l282.83"> </span>
<a href="#l282.84"></a><span id="l282.84">   // We should have gone back to the second tab</span>
<a href="#l282.85"></a><span id="l282.85">   assert_selected_tab(firstTab);</span>
<a href="#l282.86"></a><span id="l282.86"> </span>
<a href="#l282.87"></a><span id="l282.87">   // Close the first tab</span>
<a href="#l282.88"></a><span id="l282.88">   mc.tabmail.closeTab(1);</span>
<a href="#l282.89"></a><span id="l282.89" class="difflineminus">-}</span>
<a href="#l282.90"></a><span id="l282.90" class="difflineplus">+});</span>
<a href="#l282.91"></a><span id="l282.91"> </span>
<a href="#l282.92"></a><span id="l282.92"> /**</span>
<a href="#l282.93"></a><span id="l282.93">  * Test that if we open a whole thread up in message tabs, closing</span>
<a href="#l282.94"></a><span id="l282.94">  * the last message tab takes us to the second last message tab as opposed</span>
<a href="#l282.95"></a><span id="l282.95">  * to the inbox tab.</span>
<a href="#l282.96"></a><span id="l282.96">  */</span>
<a href="#l282.97"></a><span id="l282.97" class="difflineminus">-function test_opening_thread_in_tabs_closing_behaviour() {</span>
<a href="#l282.98"></a><span id="l282.98" class="difflineplus">+add_task(function test_opening_thread_in_tabs_closing_behaviour() {</span>
<a href="#l282.99"></a><span id="l282.99">   be_in_folder(gFolder);</span>
<a href="#l282.100"></a><span id="l282.100">   make_display_threaded();</span>
<a href="#l282.101"></a><span id="l282.101">   collapse_all_threads();</span>
<a href="#l282.102"></a><span id="l282.102"> </span>
<a href="#l282.103"></a><span id="l282.103">   // Open a thread as a series of message tabs.</span>
<a href="#l282.104"></a><span id="l282.104">   select_click_row(0);</span>
<a href="#l282.105"></a><span id="l282.105">   open_selected_messages(mc);</span>
<a href="#l282.106"></a><span id="l282.106"> </span>
<a href="#l282.107"></a><span id="l282.107">   // At this point, the last message tab should be selected already.  We</span>
<a href="#l282.108"></a><span id="l282.108">   // close that tab, and the second last message tab should be selected.</span>
<a href="#l282.109"></a><span id="l282.109">   // We should close that tab, and the third last tab should be selected,</span>
<a href="#l282.110"></a><span id="l282.110">   // etc.</span>
<a href="#l282.111"></a><span id="l282.111">   for (let i = MSGS_PER_THREAD; i &gt; 0; --i) {</span>
<a href="#l282.112"></a><span id="l282.112">     let previousTab = mc.tabmail.tabContainer.getItemAtIndex(i - 1);</span>
<a href="#l282.113"></a><span id="l282.113">     mc.tabmail.closeTab(i);</span>
<a href="#l282.114"></a><span id="l282.114" class="difflineminus">-    assert_equals(</span>
<a href="#l282.115"></a><span id="l282.115" class="difflineplus">+    Assert.equal(</span>
<a href="#l282.116"></a><span id="l282.116">       previousTab,</span>
<a href="#l282.117"></a><span id="l282.117">       mc.tabmail.tabContainer.selectedItem,</span>
<a href="#l282.118"></a><span id="l282.118">       &quot;Expected tab at index &quot; + (i - 1) + &quot; to be selected.&quot;</span>
<a href="#l282.119"></a><span id="l282.119">     );</span>
<a href="#l282.120"></a><span id="l282.120">   }</span>
<a href="#l282.121"></a><span id="l282.121" class="difflineminus">-}</span>
<a href="#l282.122"></a><span id="l282.122" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l283.1"></a><span id="l283.1">copy from mail/test/mozmill/tabmail/test-tabmail-customize.js</span>
<a href="#l283.2"></a><span id="l283.2">copy to mail/test/browser/tabmail/browser_customize.js</span>
<a href="#l283.3"></a><span id="l283.3" class="difflineminus">--- a/mail/test/mozmill/tabmail/test-tabmail-customize.js</span>
<a href="#l283.4"></a><span id="l283.4" class="difflineplus">+++ b/mail/test/browser/tabmail/browser_customize.js</span>
<a href="#l283.5"></a><span id="l283.5" class="difflineat">@@ -6,67 +6,62 @@</span>
<a href="#l283.6"></a><span id="l283.6">  * Tests customization features of the tabs toolbar.</span>
<a href="#l283.7"></a><span id="l283.7">  */</span>
<a href="#l283.8"></a><span id="l283.8"> </span>
<a href="#l283.9"></a><span id="l283.9"> &quot;use strict&quot;;</span>
<a href="#l283.10"></a><span id="l283.10"> </span>
<a href="#l283.11"></a><span id="l283.11"> var { CustomizeDialogHelper } = ChromeUtils.import(</span>
<a href="#l283.12"></a><span id="l283.12">   &quot;resource://testing-common/mozmill/CustomizationHelpers.jsm&quot;</span>
<a href="#l283.13"></a><span id="l283.13"> );</span>
<a href="#l283.14"></a><span id="l283.14" class="difflineminus">-var {</span>
<a href="#l283.15"></a><span id="l283.15" class="difflineminus">-  assert_equals,</span>
<a href="#l283.16"></a><span id="l283.16" class="difflineminus">-  assert_not_equals,</span>
<a href="#l283.17"></a><span id="l283.17" class="difflineminus">-  mc,</span>
<a href="#l283.18"></a><span id="l283.18" class="difflineminus">-  wait_for_popup_to_open,</span>
<a href="#l283.19"></a><span id="l283.19" class="difflineminus">-} = ChromeUtils.import(</span>
<a href="#l283.20"></a><span id="l283.20" class="difflineplus">+var { mc, wait_for_popup_to_open } = ChromeUtils.import(</span>
<a href="#l283.21"></a><span id="l283.21">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l283.22"></a><span id="l283.22"> );</span>
<a href="#l283.23"></a><span id="l283.23"> var { drag_n_drop_element } = ChromeUtils.import(</span>
<a href="#l283.24"></a><span id="l283.24">   &quot;resource://testing-common/mozmill/MouseEventHelpers.jsm&quot;</span>
<a href="#l283.25"></a><span id="l283.25"> );</span>
<a href="#l283.26"></a><span id="l283.26"> </span>
<a href="#l283.27"></a><span id="l283.27"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l283.28"></a><span id="l283.28"> </span>
<a href="#l283.29"></a><span id="l283.29"> var gCDHelper;</span>
<a href="#l283.30"></a><span id="l283.30"> </span>
<a href="#l283.31"></a><span id="l283.31" class="difflineminus">-function setupModule(module) {</span>
<a href="#l283.32"></a><span id="l283.32" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l283.33"></a><span id="l283.33">   gCDHelper = new CustomizeDialogHelper(</span>
<a href="#l283.34"></a><span id="l283.34">     &quot;mail-toolbar-menubar2&quot;,</span>
<a href="#l283.35"></a><span id="l283.35">     &quot;CustomizeMailToolbar&quot;,</span>
<a href="#l283.36"></a><span id="l283.36">     &quot;mailnews:customizeToolbar&quot;</span>
<a href="#l283.37"></a><span id="l283.37">   );</span>
<a href="#l283.38"></a><span id="l283.38" class="difflineminus">-}</span>
<a href="#l283.39"></a><span id="l283.39" class="difflineplus">+});</span>
<a href="#l283.40"></a><span id="l283.40"> </span>
<a href="#l283.41"></a><span id="l283.41" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l283.42"></a><span id="l283.42" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l283.43"></a><span id="l283.43">   // Let's reset any and all of our changes to the toolbar</span>
<a href="#l283.44"></a><span id="l283.44">   gCDHelper.restoreDefaultButtons(mc);</span>
<a href="#l283.45"></a><span id="l283.45" class="difflineminus">-}</span>
<a href="#l283.46"></a><span id="l283.46" class="difflineplus">+});</span>
<a href="#l283.47"></a><span id="l283.47"> </span>
<a href="#l283.48"></a><span id="l283.48"> /**</span>
<a href="#l283.49"></a><span id="l283.49">  * Test that we can access the customize context menu by right</span>
<a href="#l283.50"></a><span id="l283.50">  * clicking on the tabs toolbar.</span>
<a href="#l283.51"></a><span id="l283.51">  */</span>
<a href="#l283.52"></a><span id="l283.52" class="difflineminus">-function test_open_context_menu() {</span>
<a href="#l283.53"></a><span id="l283.53" class="difflineplus">+add_task(function test_open_context_menu() {</span>
<a href="#l283.54"></a><span id="l283.54">   // First, ensure that the context menu is closed.</span>
<a href="#l283.55"></a><span id="l283.55">   let contextPopup = mc.e(&quot;toolbar-context-menu&quot;);</span>
<a href="#l283.56"></a><span id="l283.56" class="difflineminus">-  assert_not_equals(contextPopup.state, &quot;open&quot;);</span>
<a href="#l283.57"></a><span id="l283.57" class="difflineplus">+  Assert.notEqual(contextPopup.state, &quot;open&quot;);</span>
<a href="#l283.58"></a><span id="l283.58"> </span>
<a href="#l283.59"></a><span id="l283.59">   // Right click on the tab bar</span>
<a href="#l283.60"></a><span id="l283.60">   mc.rightClick(mc.eid(&quot;tabmail-tabs&quot;));</span>
<a href="#l283.61"></a><span id="l283.61"> </span>
<a href="#l283.62"></a><span id="l283.62">   // Ensure that the popup opened</span>
<a href="#l283.63"></a><span id="l283.63">   wait_for_popup_to_open(contextPopup);</span>
<a href="#l283.64"></a><span id="l283.64" class="difflineminus">-}</span>
<a href="#l283.65"></a><span id="l283.65" class="difflineplus">+});</span>
<a href="#l283.66"></a><span id="l283.66"> </span>
<a href="#l283.67"></a><span id="l283.67"> /**</span>
<a href="#l283.68"></a><span id="l283.68">  * Test that, when customizing the toolbars, if the user drags an item onto</span>
<a href="#l283.69"></a><span id="l283.69">  * the tab bar, they're redirected to the toolbar directly to the right of</span>
<a href="#l283.70"></a><span id="l283.70">  * the tab bar.</span>
<a href="#l283.71"></a><span id="l283.71">  */</span>
<a href="#l283.72"></a><span id="l283.72" class="difflineminus">-function test_redirects_toolbarbutton_drops() {</span>
<a href="#l283.73"></a><span id="l283.73" class="difflineplus">+add_task(function test_redirects_toolbarbutton_drops() {</span>
<a href="#l283.74"></a><span id="l283.74">   Services.prefs.setBoolPref(&quot;toolkit.customization.unsafe_drag_events&quot;, true);</span>
<a href="#l283.75"></a><span id="l283.75">   // Restore the default buttons to get defined starting conditions.</span>
<a href="#l283.76"></a><span id="l283.76">   gCDHelper.restoreDefaultButtons(mc);</span>
<a href="#l283.77"></a><span id="l283.77"> </span>
<a href="#l283.78"></a><span id="l283.78">   let tabbar = mc.e(&quot;tabmail-tabs&quot;);</span>
<a href="#l283.79"></a><span id="l283.79">   let toolbar = mc.e(&quot;tabbar-toolbar&quot;);</span>
<a href="#l283.80"></a><span id="l283.80"> </span>
<a href="#l283.81"></a><span id="l283.81">   // First, let's open up the customize toolbar window.</span>
<a href="#l283.82"></a><span id="l283.82" class="difflineat">@@ -89,17 +84,17 @@ function test_redirects_toolbarbutton_dr</span>
<a href="#l283.83"></a><span id="l283.83">       mc.window,</span>
<a href="#l283.84"></a><span id="l283.84">       0.5,</span>
<a href="#l283.85"></a><span id="l283.85">       0.5,</span>
<a href="#l283.86"></a><span id="l283.86">       ctw.window</span>
<a href="#l283.87"></a><span id="l283.87">     );</span>
<a href="#l283.88"></a><span id="l283.88"> </span>
<a href="#l283.89"></a><span id="l283.89">     // Now let's check to make sure that this button is now the first</span>
<a href="#l283.90"></a><span id="l283.90">     // item in the tab bar toolbar.</span>
<a href="#l283.91"></a><span id="l283.91" class="difflineminus">-    assert_equals(</span>
<a href="#l283.92"></a><span id="l283.92" class="difflineplus">+    Assert.equal(</span>
<a href="#l283.93"></a><span id="l283.93">       toolbar.firstElementChild.id,</span>
<a href="#l283.94"></a><span id="l283.94">       aButtonId,</span>
<a href="#l283.95"></a><span id="l283.95">       &quot;Button was not added as first child!&quot;</span>
<a href="#l283.96"></a><span id="l283.96">     );</span>
<a href="#l283.97"></a><span id="l283.97">   });</span>
<a href="#l283.98"></a><span id="l283.98"> </span>
<a href="#l283.99"></a><span id="l283.99">   // Ok, now let's try to grab some toolbar buttons from mail-bar3, and</span>
<a href="#l283.100"></a><span id="l283.100">   // make sure we can drop those on the tab bar too.</span>
<a href="#l283.101"></a><span id="l283.101" class="difflineat">@@ -114,19 +109,19 @@ function test_redirects_toolbarbutton_dr</span>
<a href="#l283.102"></a><span id="l283.102">         mc.window,</span>
<a href="#l283.103"></a><span id="l283.103">         0.5,</span>
<a href="#l283.104"></a><span id="l283.104">         0.5,</span>
<a href="#l283.105"></a><span id="l283.105">         mc.window</span>
<a href="#l283.106"></a><span id="l283.106">       );</span>
<a href="#l283.107"></a><span id="l283.107"> </span>
<a href="#l283.108"></a><span id="l283.108">       // Now let's check to make sure that this button is now the first</span>
<a href="#l283.109"></a><span id="l283.109">       // item in the tab bar toolbar.</span>
<a href="#l283.110"></a><span id="l283.110" class="difflineminus">-      assert_equals(</span>
<a href="#l283.111"></a><span id="l283.111" class="difflineplus">+      Assert.equal(</span>
<a href="#l283.112"></a><span id="l283.112">         toolbar.firstElementChild.id,</span>
<a href="#l283.113"></a><span id="l283.113">         &quot;wrapper-&quot; + aButtonId,</span>
<a href="#l283.114"></a><span id="l283.114">         &quot;Button was not added as first child!&quot;</span>
<a href="#l283.115"></a><span id="l283.115">       );</span>
<a href="#l283.116"></a><span id="l283.116">     }</span>
<a href="#l283.117"></a><span id="l283.117">   );</span>
<a href="#l283.118"></a><span id="l283.118"> </span>
<a href="#l283.119"></a><span id="l283.119">   gCDHelper.close(ctw);</span>
<a href="#l283.120"></a><span id="l283.120">   Services.prefs.clearUserPref(&quot;toolkit.customization.unsafe_drag_events&quot;);</span>
<a href="#l283.121"></a><span id="l283.121" class="difflineminus">-}</span>
<a href="#l283.122"></a><span id="l283.122" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l284.1"></a><span id="l284.1">copy from mail/test/mozmill/tabmail/test-tabmail-dragndrop.js</span>
<a href="#l284.2"></a><span id="l284.2">copy to mail/test/browser/tabmail/browser_dragndrop.js</span>
<a href="#l284.3"></a><span id="l284.3" class="difflineminus">--- a/mail/test/mozmill/tabmail/test-tabmail-dragndrop.js</span>
<a href="#l284.4"></a><span id="l284.4" class="difflineplus">+++ b/mail/test/browser/tabmail/browser_dragndrop.js</span>
<a href="#l284.5"></a><span id="l284.5" class="difflineat">@@ -4,29 +4,27 @@</span>
<a href="#l284.6"></a><span id="l284.6"> </span>
<a href="#l284.7"></a><span id="l284.7"> &quot;use strict&quot;;</span>
<a href="#l284.8"></a><span id="l284.8"> </span>
<a href="#l284.9"></a><span id="l284.9"> /*</span>
<a href="#l284.10"></a><span id="l284.10">  * Test rearanging tabs via drag'n'drop.</span>
<a href="#l284.11"></a><span id="l284.11">  */</span>
<a href="#l284.12"></a><span id="l284.12"> </span>
<a href="#l284.13"></a><span id="l284.13"> var elib = ChromeUtils.import(</span>
<a href="#l284.14"></a><span id="l284.14" class="difflineminus">-  &quot;chrome://mozmill/content/modules/elementslib.jsm&quot;</span>
<a href="#l284.15"></a><span id="l284.15" class="difflineplus">+  &quot;resource://testing-common/mozmill/elementslib.jsm&quot;</span>
<a href="#l284.16"></a><span id="l284.16"> );</span>
<a href="#l284.17"></a><span id="l284.17"> var EventUtils = ChromeUtils.import(</span>
<a href="#l284.18"></a><span id="l284.18" class="difflineminus">-  &quot;chrome://mozmill/content/stdlib/EventUtils.jsm&quot;</span>
<a href="#l284.19"></a><span id="l284.19" class="difflineplus">+  &quot;resource://testing-common/mozmill/EventUtils.jsm&quot;</span>
<a href="#l284.20"></a><span id="l284.20"> );</span>
<a href="#l284.21"></a><span id="l284.21"> </span>
<a href="#l284.22"></a><span id="l284.22"> var {</span>
<a href="#l284.23"></a><span id="l284.23" class="difflineminus">-  assert_equals,</span>
<a href="#l284.24"></a><span id="l284.24">   assert_folder_selected_and_displayed,</span>
<a href="#l284.25"></a><span id="l284.25">   assert_number_of_tabs_open,</span>
<a href="#l284.26"></a><span id="l284.26">   assert_row_visible,</span>
<a href="#l284.27"></a><span id="l284.27">   assert_selected_and_displayed,</span>
<a href="#l284.28"></a><span id="l284.28" class="difflineminus">-  assert_true,</span>
<a href="#l284.29"></a><span id="l284.29">   be_in_folder,</span>
<a href="#l284.30"></a><span id="l284.30">   close_popup,</span>
<a href="#l284.31"></a><span id="l284.31">   create_folder,</span>
<a href="#l284.32"></a><span id="l284.32">   display_message_in_folder_tab,</span>
<a href="#l284.33"></a><span id="l284.33">   make_new_sets_in_folder,</span>
<a href="#l284.34"></a><span id="l284.34">   mc,</span>
<a href="#l284.35"></a><span id="l284.35">   open_selected_message_in_new_tab,</span>
<a href="#l284.36"></a><span id="l284.36">   select_click_row,</span>
<a href="#l284.37"></a><span id="l284.37" class="difflineat">@@ -53,26 +51,26 @@ var {</span>
<a href="#l284.38"></a><span id="l284.38"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l284.39"></a><span id="l284.39"> </span>
<a href="#l284.40"></a><span id="l284.40"> var folder;</span>
<a href="#l284.41"></a><span id="l284.41"> var msgHdrsInFolder = [];</span>
<a href="#l284.42"></a><span id="l284.42"> </span>
<a href="#l284.43"></a><span id="l284.43"> // The number of messages in folder.</span>
<a href="#l284.44"></a><span id="l284.44"> var NUM_MESSAGES_IN_FOLDER = 15;</span>
<a href="#l284.45"></a><span id="l284.45"> </span>
<a href="#l284.46"></a><span id="l284.46" class="difflineminus">-function setupModule(module) {</span>
<a href="#l284.47"></a><span id="l284.47" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l284.48"></a><span id="l284.48">   folder = create_folder(&quot;MessageFolder&quot;);</span>
<a href="#l284.49"></a><span id="l284.49">   make_new_sets_in_folder(folder, [{ count: NUM_MESSAGES_IN_FOLDER }]);</span>
<a href="#l284.50"></a><span id="l284.50" class="difflineminus">-}</span>
<a href="#l284.51"></a><span id="l284.51" class="difflineplus">+});</span>
<a href="#l284.52"></a><span id="l284.52"> </span>
<a href="#l284.53"></a><span id="l284.53"> /**</span>
<a href="#l284.54"></a><span id="l284.54">  * Verifies our test environment is setup correctly and initializes</span>
<a href="#l284.55"></a><span id="l284.55">  * all global variables.</span>
<a href="#l284.56"></a><span id="l284.56">  */</span>
<a href="#l284.57"></a><span id="l284.57" class="difflineminus">-function test_tab_reorder_setup_globals() {</span>
<a href="#l284.58"></a><span id="l284.58" class="difflineplus">+add_task(function test_tab_reorder_setup_globals() {</span>
<a href="#l284.59"></a><span id="l284.59">   be_in_folder(folder);</span>
<a href="#l284.60"></a><span id="l284.60">   // Scroll to the top</span>
<a href="#l284.61"></a><span id="l284.61">   mc.folderDisplay.ensureRowIsVisible(0);</span>
<a href="#l284.62"></a><span id="l284.62">   let msgHdr = mc.dbView.getMsgHdrAt(1);</span>
<a href="#l284.63"></a><span id="l284.63"> </span>
<a href="#l284.64"></a><span id="l284.64">   display_message_in_folder_tab(msgHdr, false);</span>
<a href="#l284.65"></a><span id="l284.65"> </span>
<a href="#l284.66"></a><span id="l284.66">   // Check that the right message is displayed</span>
<a href="#l284.67"></a><span id="l284.67" class="difflineat">@@ -88,51 +86,52 @@ function test_tab_reorder_setup_globals(</span>
<a href="#l284.68"></a><span id="l284.68">   // order of messages in the arrays is the same as in the views.</span>
<a href="#l284.69"></a><span id="l284.69">   be_in_folder(folder);</span>
<a href="#l284.70"></a><span id="l284.70">   for (let i = 0; i &lt; NUM_MESSAGES_IN_FOLDER; i++) {</span>
<a href="#l284.71"></a><span id="l284.71">     msgHdrsInFolder.push(mc.dbView.getMsgHdrAt(i));</span>
<a href="#l284.72"></a><span id="l284.72">   }</span>
<a href="#l284.73"></a><span id="l284.73"> </span>
<a href="#l284.74"></a><span id="l284.74">   // Mark all messages read</span>
<a href="#l284.75"></a><span id="l284.75">   folder.markAllMessagesRead(null);</span>
<a href="#l284.76"></a><span id="l284.76" class="difflineminus">-}</span>
<a href="#l284.77"></a><span id="l284.77" class="difflineplus">+  teardownTest();</span>
<a href="#l284.78"></a><span id="l284.78" class="difflineplus">+});</span>
<a href="#l284.79"></a><span id="l284.79"> </span>
<a href="#l284.80"></a><span id="l284.80"> /**</span>
<a href="#l284.81"></a><span id="l284.81">  * Tests reordering tabs by drag'n'drop within the tabbar</span>
<a href="#l284.82"></a><span id="l284.82">  *</span>
<a href="#l284.83"></a><span id="l284.83">  * It opens additional movable and closable tabs. The picks the first</span>
<a href="#l284.84"></a><span id="l284.84">  * movable tab and drops it onto the third movable tab.</span>
<a href="#l284.85"></a><span id="l284.85">  */</span>
<a href="#l284.86"></a><span id="l284.86" class="difflineminus">-function test_tab_reorder_tabbar() {</span>
<a href="#l284.87"></a><span id="l284.87" class="difflineplus">+add_task(function test_tab_reorder_tabbar() {</span>
<a href="#l284.88"></a><span id="l284.88">   // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l284.89"></a><span id="l284.89">   mc.tabmail.closeOtherTabs(0);</span>
<a href="#l284.90"></a><span id="l284.90">   assert_number_of_tabs_open(1);</span>
<a href="#l284.91"></a><span id="l284.91"> </span>
<a href="#l284.92"></a><span id="l284.92">   be_in_folder(folder);</span>
<a href="#l284.93"></a><span id="l284.93"> </span>
<a href="#l284.94"></a><span id="l284.94">   // Open four tabs</span>
<a href="#l284.95"></a><span id="l284.95">   for (let idx = 0; idx &lt; 4; idx++) {</span>
<a href="#l284.96"></a><span id="l284.96">     select_click_row(idx);</span>
<a href="#l284.97"></a><span id="l284.97">     open_selected_message_in_new_tab(true);</span>
<a href="#l284.98"></a><span id="l284.98">   }</span>
<a href="#l284.99"></a><span id="l284.99"> </span>
<a href="#l284.100"></a><span id="l284.100">   // Check if every thing is correctly initialized</span>
<a href="#l284.101"></a><span id="l284.101">   assert_number_of_tabs_open(5);</span>
<a href="#l284.102"></a><span id="l284.102"> </span>
<a href="#l284.103"></a><span id="l284.103" class="difflineminus">-  assert_true(</span>
<a href="#l284.104"></a><span id="l284.104" class="difflineplus">+  Assert.ok(</span>
<a href="#l284.105"></a><span id="l284.105">     mc.tabmail.tabModes.message.tabs[0] == mc.tabmail.tabInfo[1],</span>
<a href="#l284.106"></a><span id="l284.106">     &quot; tabMode.tabs and tabInfo out of sync&quot;</span>
<a href="#l284.107"></a><span id="l284.107">   );</span>
<a href="#l284.108"></a><span id="l284.108"> </span>
<a href="#l284.109"></a><span id="l284.109" class="difflineminus">-  assert_true(</span>
<a href="#l284.110"></a><span id="l284.110" class="difflineplus">+  Assert.ok(</span>
<a href="#l284.111"></a><span id="l284.111">     mc.tabmail.tabModes.message.tabs[1] == mc.tabmail.tabInfo[2],</span>
<a href="#l284.112"></a><span id="l284.112">     &quot; tabMode.tabs and tabInfo out of sync&quot;</span>
<a href="#l284.113"></a><span id="l284.113">   );</span>
<a href="#l284.114"></a><span id="l284.114"> </span>
<a href="#l284.115"></a><span id="l284.115" class="difflineminus">-  assert_true(</span>
<a href="#l284.116"></a><span id="l284.116" class="difflineplus">+  Assert.ok(</span>
<a href="#l284.117"></a><span id="l284.117">     mc.tabmail.tabModes.message.tabs[2] == mc.tabmail.tabInfo[3],</span>
<a href="#l284.118"></a><span id="l284.118">     &quot; tabMode.tabs and tabInfo out of sync&quot;</span>
<a href="#l284.119"></a><span id="l284.119">   );</span>
<a href="#l284.120"></a><span id="l284.120"> </span>
<a href="#l284.121"></a><span id="l284.121">   // Start dragging the first tab</span>
<a href="#l284.122"></a><span id="l284.122">   switch_tab(1);</span>
<a href="#l284.123"></a><span id="l284.123">   assert_selected_and_displayed(msgHdrsInFolder[0]);</span>
<a href="#l284.124"></a><span id="l284.124"> </span>
<a href="#l284.125"></a><span id="l284.125" class="difflineat">@@ -150,48 +149,49 @@ function test_tab_reorder_tabbar() {</span>
<a href="#l284.126"></a><span id="l284.126">   );</span>
<a href="#l284.127"></a><span id="l284.127"> </span>
<a href="#l284.128"></a><span id="l284.128">   wait_for_message_display_completion(mc);</span>
<a href="#l284.129"></a><span id="l284.129"> </span>
<a href="#l284.130"></a><span id="l284.130">   // if every thing went well...</span>
<a href="#l284.131"></a><span id="l284.131">   assert_number_of_tabs_open(5);</span>
<a href="#l284.132"></a><span id="l284.132"> </span>
<a href="#l284.133"></a><span id="l284.133">   // ... we should find tab1 at the third position...</span>
<a href="#l284.134"></a><span id="l284.134" class="difflineminus">-  assert_equals(tab1, mc.tabmail.tabContainer.allTabs[3], &quot;Moving tab1 failed&quot;);</span>
<a href="#l284.135"></a><span id="l284.135" class="difflineplus">+  Assert.equal(tab1, mc.tabmail.tabContainer.allTabs[3], &quot;Moving tab1 failed&quot;);</span>
<a href="#l284.136"></a><span id="l284.136">   switch_tab(3);</span>
<a href="#l284.137"></a><span id="l284.137">   assert_selected_and_displayed(msgHdrsInFolder[0]);</span>
<a href="#l284.138"></a><span id="l284.138"> </span>
<a href="#l284.139"></a><span id="l284.139">   // ... while tab3 moves one up and gets second.</span>
<a href="#l284.140"></a><span id="l284.140" class="difflineminus">-  assert_true(tab3 == mc.tabmail.tabContainer.allTabs[2], &quot;Moving tab3 failed&quot;);</span>
<a href="#l284.141"></a><span id="l284.141" class="difflineplus">+  Assert.ok(tab3 == mc.tabmail.tabContainer.allTabs[2], &quot;Moving tab3 failed&quot;);</span>
<a href="#l284.142"></a><span id="l284.142">   switch_tab(2);</span>
<a href="#l284.143"></a><span id="l284.143">   assert_selected_and_displayed(msgHdrsInFolder[2]);</span>
<a href="#l284.144"></a><span id="l284.144"> </span>
<a href="#l284.145"></a><span id="l284.145">   // we have one &quot;message&quot; tab and three &quot;folder&quot; tabs, thus tabInfo[1-3] and</span>
<a href="#l284.146"></a><span id="l284.146">   // tabMode[&quot;message&quot;].tabs[0-2] have to be same, otherwise something went</span>
<a href="#l284.147"></a><span id="l284.147">   // wrong while moving tabs around</span>
<a href="#l284.148"></a><span id="l284.148" class="difflineminus">-  assert_true(</span>
<a href="#l284.149"></a><span id="l284.149" class="difflineplus">+  Assert.ok(</span>
<a href="#l284.150"></a><span id="l284.150">     mc.tabmail.tabModes.message.tabs[0] == mc.tabmail.tabInfo[1],</span>
<a href="#l284.151"></a><span id="l284.151">     &quot; tabMode.tabs and tabInfo out of sync&quot;</span>
<a href="#l284.152"></a><span id="l284.152">   );</span>
<a href="#l284.153"></a><span id="l284.153"> </span>
<a href="#l284.154"></a><span id="l284.154" class="difflineminus">-  assert_true(</span>
<a href="#l284.155"></a><span id="l284.155" class="difflineplus">+  Assert.ok(</span>
<a href="#l284.156"></a><span id="l284.156">     mc.tabmail.tabModes.message.tabs[1] == mc.tabmail.tabInfo[2],</span>
<a href="#l284.157"></a><span id="l284.157">     &quot; tabMode.tabs and tabInfo out of sync&quot;</span>
<a href="#l284.158"></a><span id="l284.158">   );</span>
<a href="#l284.159"></a><span id="l284.159"> </span>
<a href="#l284.160"></a><span id="l284.160" class="difflineminus">-  assert_true(</span>
<a href="#l284.161"></a><span id="l284.161" class="difflineplus">+  Assert.ok(</span>
<a href="#l284.162"></a><span id="l284.162">     mc.tabmail.tabModes.message.tabs[2] == mc.tabmail.tabInfo[3],</span>
<a href="#l284.163"></a><span id="l284.163">     &quot; tabMode.tabs and tabInfo out of sync&quot;</span>
<a href="#l284.164"></a><span id="l284.164">   );</span>
<a href="#l284.165"></a><span id="l284.165" class="difflineminus">-}</span>
<a href="#l284.166"></a><span id="l284.166" class="difflineplus">+  teardownTest();</span>
<a href="#l284.167"></a><span id="l284.167" class="difflineplus">+});</span>
<a href="#l284.168"></a><span id="l284.168"> </span>
<a href="#l284.169"></a><span id="l284.169"> /**</span>
<a href="#l284.170"></a><span id="l284.170">  * Tests drag'n'drop tab reordering between windows</span>
<a href="#l284.171"></a><span id="l284.171">  */</span>
<a href="#l284.172"></a><span id="l284.172" class="difflineminus">-function test_tab_reorder_window() {</span>
<a href="#l284.173"></a><span id="l284.173" class="difflineplus">+add_task(function test_tab_reorder_window() {</span>
<a href="#l284.174"></a><span id="l284.174">   // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l284.175"></a><span id="l284.175">   mc.tabmail.closeOtherTabs(0);</span>
<a href="#l284.176"></a><span id="l284.176">   assert_number_of_tabs_open(1);</span>
<a href="#l284.177"></a><span id="l284.177"> </span>
<a href="#l284.178"></a><span id="l284.178">   let mc2 = null;</span>
<a href="#l284.179"></a><span id="l284.179"> </span>
<a href="#l284.180"></a><span id="l284.180">   be_in_folder(folder);</span>
<a href="#l284.181"></a><span id="l284.181"> </span>
<a href="#l284.182"></a><span id="l284.182" class="difflineat">@@ -217,55 +217,56 @@ function test_tab_reorder_window() {</span>
<a href="#l284.183"></a><span id="l284.183">     &quot;all,chrome,dialog=no,status,toolbar&quot;,</span>
<a href="#l284.184"></a><span id="l284.184">     args</span>
<a href="#l284.185"></a><span id="l284.185">   );</span>
<a href="#l284.186"></a><span id="l284.186"> </span>
<a href="#l284.187"></a><span id="l284.187">   mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l284.188"></a><span id="l284.188">   wait_for_message_display_completion(mc2, true);</span>
<a href="#l284.189"></a><span id="l284.189"> </span>
<a href="#l284.190"></a><span id="l284.190">   // Double check if we are listening to the right window.</span>
<a href="#l284.191"></a><span id="l284.191" class="difflineminus">-  assert_true(aWnd2 == mc2.window, &quot;Opening Window failed&quot;);</span>
<a href="#l284.192"></a><span id="l284.192" class="difflineplus">+  Assert.ok(aWnd2 == mc2.window, &quot;Opening Window failed&quot;);</span>
<a href="#l284.193"></a><span id="l284.193"> </span>
<a href="#l284.194"></a><span id="l284.194">   // Start dragging the first tab ...</span>
<a href="#l284.195"></a><span id="l284.195">   let tabA = mc.tabmail.tabContainer.allTabs[1];</span>
<a href="#l284.196"></a><span id="l284.196" class="difflineminus">-  assert_true(tabA, &quot;No movable Tab&quot;);</span>
<a href="#l284.197"></a><span id="l284.197" class="difflineplus">+  Assert.ok(tabA, &quot;No movable Tab&quot;);</span>
<a href="#l284.198"></a><span id="l284.198"> </span>
<a href="#l284.199"></a><span id="l284.199">   // We drop onto the Folder Tab, it is guaranteed to exist.</span>
<a href="#l284.200"></a><span id="l284.200">   let tabB = mc2.tabmail.tabContainer.allTabs[0];</span>
<a href="#l284.201"></a><span id="l284.201" class="difflineminus">-  assert_true(tabB, &quot;No movable Tab&quot;);</span>
<a href="#l284.202"></a><span id="l284.202" class="difflineplus">+  Assert.ok(tabB, &quot;No movable Tab&quot;);</span>
<a href="#l284.203"></a><span id="l284.203"> </span>
<a href="#l284.204"></a><span id="l284.204">   drag_n_drop_element(</span>
<a href="#l284.205"></a><span id="l284.205">     tabA,</span>
<a href="#l284.206"></a><span id="l284.206">     mc.window,</span>
<a href="#l284.207"></a><span id="l284.207">     tabB,</span>
<a href="#l284.208"></a><span id="l284.208">     mc2.window,</span>
<a href="#l284.209"></a><span id="l284.209">     0.75,</span>
<a href="#l284.210"></a><span id="l284.210">     0.0,</span>
<a href="#l284.211"></a><span id="l284.211">     mc.tabmail.tabContainer</span>
<a href="#l284.212"></a><span id="l284.212">   );</span>
<a href="#l284.213"></a><span id="l284.213"> </span>
<a href="#l284.214"></a><span id="l284.214">   wait_for_message_display_completion(mc2);</span>
<a href="#l284.215"></a><span id="l284.215"> </span>
<a href="#l284.216"></a><span id="l284.216" class="difflineminus">-  assert_true(</span>
<a href="#l284.217"></a><span id="l284.217" class="difflineplus">+  Assert.ok(</span>
<a href="#l284.218"></a><span id="l284.218">     mc.tabmail.tabContainer.allTabs.length == 1,</span>
<a href="#l284.219"></a><span id="l284.219">     &quot;Moving tab to new window failed, tab still in old window&quot;</span>
<a href="#l284.220"></a><span id="l284.220">   );</span>
<a href="#l284.221"></a><span id="l284.221"> </span>
<a href="#l284.222"></a><span id="l284.222" class="difflineminus">-  assert_true(</span>
<a href="#l284.223"></a><span id="l284.223" class="difflineplus">+  Assert.ok(</span>
<a href="#l284.224"></a><span id="l284.224">     mc2.tabmail.tabContainer.allTabs.length == 2,</span>
<a href="#l284.225"></a><span id="l284.225">     &quot;Moving tab to new window failed, no new tab in new window&quot;</span>
<a href="#l284.226"></a><span id="l284.226">   );</span>
<a href="#l284.227"></a><span id="l284.227"> </span>
<a href="#l284.228"></a><span id="l284.228">   assert_selected_and_displayed(mc2, msgHdrsInFolder[1]);</span>
<a href="#l284.229"></a><span id="l284.229" class="difflineminus">-}</span>
<a href="#l284.230"></a><span id="l284.230" class="difflineplus">+  teardownTest();</span>
<a href="#l284.231"></a><span id="l284.231" class="difflineplus">+});</span>
<a href="#l284.232"></a><span id="l284.232"> </span>
<a href="#l284.233"></a><span id="l284.233"> /**</span>
<a href="#l284.234"></a><span id="l284.234">  * Tests detaching tabs into windows via drag'n'drop</span>
<a href="#l284.235"></a><span id="l284.235">  */</span>
<a href="#l284.236"></a><span id="l284.236" class="difflineminus">-function test_tab_reorder_detach() {</span>
<a href="#l284.237"></a><span id="l284.237" class="difflineplus">+add_task(function test_tab_reorder_detach() {</span>
<a href="#l284.238"></a><span id="l284.238">   // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l284.239"></a><span id="l284.239">   mc.tabmail.closeOtherTabs(0);</span>
<a href="#l284.240"></a><span id="l284.240">   assert_number_of_tabs_open(1);</span>
<a href="#l284.241"></a><span id="l284.241"> </span>
<a href="#l284.242"></a><span id="l284.242">   let mc2 = null;</span>
<a href="#l284.243"></a><span id="l284.243"> </span>
<a href="#l284.244"></a><span id="l284.244">   be_in_folder(folder);</span>
<a href="#l284.245"></a><span id="l284.245"> </span>
<a href="#l284.246"></a><span id="l284.246" class="difflineat">@@ -295,33 +296,34 @@ function test_tab_reorder_detach() {</span>
<a href="#l284.247"></a><span id="l284.247">     screenX: dropContent.screenX + dropRect.width / 2,</span>
<a href="#l284.248"></a><span id="l284.248">     screenY: dropContent.screenY + dropRect.height / 2,</span>
<a href="#l284.249"></a><span id="l284.249">   });</span>
<a href="#l284.250"></a><span id="l284.250"> </span>
<a href="#l284.251"></a><span id="l284.251">   // ... and wait for the new window</span>
<a href="#l284.252"></a><span id="l284.252">   mc2 = wait_for_new_window(&quot;mail:3pane&quot;);</span>
<a href="#l284.253"></a><span id="l284.253">   wait_for_message_display_completion(mc2, true);</span>
<a href="#l284.254"></a><span id="l284.254"> </span>
<a href="#l284.255"></a><span id="l284.255" class="difflineminus">-  assert_true(</span>
<a href="#l284.256"></a><span id="l284.256" class="difflineplus">+  Assert.ok(</span>
<a href="#l284.257"></a><span id="l284.257">     mc.tabmail.tabContainer.allTabs.length == 1,</span>
<a href="#l284.258"></a><span id="l284.258">     &quot;Moving tab to new window failed, tab still in old window&quot;</span>
<a href="#l284.259"></a><span id="l284.259">   );</span>
<a href="#l284.260"></a><span id="l284.260"> </span>
<a href="#l284.261"></a><span id="l284.261" class="difflineminus">-  assert_true(</span>
<a href="#l284.262"></a><span id="l284.262" class="difflineplus">+  Assert.ok(</span>
<a href="#l284.263"></a><span id="l284.263">     mc2.tabmail.tabContainer.allTabs.length == 2,</span>
<a href="#l284.264"></a><span id="l284.264">     &quot;Moving tab to new window failed, no new tab in new window&quot;</span>
<a href="#l284.265"></a><span id="l284.265">   );</span>
<a href="#l284.266"></a><span id="l284.266"> </span>
<a href="#l284.267"></a><span id="l284.267">   assert_selected_and_displayed(mc2, msgHdrsInFolder[2]);</span>
<a href="#l284.268"></a><span id="l284.268" class="difflineminus">-}</span>
<a href="#l284.269"></a><span id="l284.269" class="difflineplus">+  teardownTest();</span>
<a href="#l284.270"></a><span id="l284.270" class="difflineplus">+});</span>
<a href="#l284.271"></a><span id="l284.271"> </span>
<a href="#l284.272"></a><span id="l284.272"> /**</span>
<a href="#l284.273"></a><span id="l284.273">  * Test undo of recently closed tabs.</span>
<a href="#l284.274"></a><span id="l284.274">  */</span>
<a href="#l284.275"></a><span id="l284.275" class="difflineminus">-function test_tab_undo() {</span>
<a href="#l284.276"></a><span id="l284.276" class="difflineplus">+add_task(function test_tab_undo() {</span>
<a href="#l284.277"></a><span id="l284.277">   // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l284.278"></a><span id="l284.278">   mc.tabmail.closeOtherTabs(0);</span>
<a href="#l284.279"></a><span id="l284.279">   assert_number_of_tabs_open(1);</span>
<a href="#l284.280"></a><span id="l284.280"> </span>
<a href="#l284.281"></a><span id="l284.281">   be_in_folder(folder);</span>
<a href="#l284.282"></a><span id="l284.282"> </span>
<a href="#l284.283"></a><span id="l284.283">   // Open five tabs...</span>
<a href="#l284.284"></a><span id="l284.284">   for (let idx = 0; idx &lt; 5; idx++) {</span>
<a href="#l284.285"></a><span id="l284.285" class="difflineat">@@ -347,17 +349,18 @@ function test_tab_undo() {</span>
<a href="#l284.286"></a><span id="l284.286">   assert_number_of_tabs_open(4);</span>
<a href="#l284.287"></a><span id="l284.287">   assert_selected_and_displayed(mc, msgHdrsInFolder[3]);</span>
<a href="#l284.288"></a><span id="l284.288"> </span>
<a href="#l284.289"></a><span id="l284.289">   // msgHdrsInFolder[2] won't be restorend it was closed with disabled undo.</span>
<a href="#l284.290"></a><span id="l284.290"> </span>
<a href="#l284.291"></a><span id="l284.291">   mc.tabmail.undoCloseTab();</span>
<a href="#l284.292"></a><span id="l284.292">   assert_number_of_tabs_open(5);</span>
<a href="#l284.293"></a><span id="l284.293">   assert_selected_and_displayed(mc, msgHdrsInFolder[1]);</span>
<a href="#l284.294"></a><span id="l284.294" class="difflineminus">-}</span>
<a href="#l284.295"></a><span id="l284.295" class="difflineplus">+  teardownTest();</span>
<a href="#l284.296"></a><span id="l284.296" class="difflineplus">+});</span>
<a href="#l284.297"></a><span id="l284.297"> </span>
<a href="#l284.298"></a><span id="l284.298"> function _synthesizeRecentlyClosedMenu() {</span>
<a href="#l284.299"></a><span id="l284.299">   mc.rightClick(new elib.Elem(mc.tabmail.tabContainer.allTabs[1]));</span>
<a href="#l284.300"></a><span id="l284.300"> </span>
<a href="#l284.301"></a><span id="l284.301">   let tabContextMenu = mc.window.document.getElementById(&quot;tabContextMenu&quot;);</span>
<a href="#l284.302"></a><span id="l284.302">   wait_for_popup_to_open(tabContextMenu);</span>
<a href="#l284.303"></a><span id="l284.303"> </span>
<a href="#l284.304"></a><span id="l284.304">   let recentlyClosedTabs = tabContextMenu.querySelector(</span>
<a href="#l284.305"></a><span id="l284.305" class="difflineat">@@ -373,24 +376,24 @@ function _synthesizeRecentlyClosedMenu()</span>
<a href="#l284.306"></a><span id="l284.306"> function _teardownRecentlyClosedMenu() {</span>
<a href="#l284.307"></a><span id="l284.307">   let menu = mc.window.document.getElementById(&quot;tabContextMenu&quot;);</span>
<a href="#l284.308"></a><span id="l284.308">   close_popup(mc, new elib.Elem(menu));</span>
<a href="#l284.309"></a><span id="l284.309"> }</span>
<a href="#l284.310"></a><span id="l284.310"> </span>
<a href="#l284.311"></a><span id="l284.311"> /**</span>
<a href="#l284.312"></a><span id="l284.312">  * Tests the recently closed tabs menu.</span>
<a href="#l284.313"></a><span id="l284.313">  */</span>
<a href="#l284.314"></a><span id="l284.314" class="difflineminus">-function test_tab_recentlyClosed() {</span>
<a href="#l284.315"></a><span id="l284.315" class="difflineplus">+add_task(function test_tab_recentlyClosed() {</span>
<a href="#l284.316"></a><span id="l284.316">   // Ensure only one tab is open, otherwise our test most likey fail anyway.</span>
<a href="#l284.317"></a><span id="l284.317">   mc.tabmail.closeOtherTabs(0, true);</span>
<a href="#l284.318"></a><span id="l284.318">   assert_number_of_tabs_open(1);</span>
<a href="#l284.319"></a><span id="l284.319"> </span>
<a href="#l284.320"></a><span id="l284.320">   // We start with a clean tab history.</span>
<a href="#l284.321"></a><span id="l284.321">   mc.tabmail.clearRecentlyClosedTabs();</span>
<a href="#l284.322"></a><span id="l284.322" class="difflineminus">-  assert_equals(mc.tabmail.recentlyClosedTabs.length, 0);</span>
<a href="#l284.323"></a><span id="l284.323" class="difflineplus">+  Assert.equal(mc.tabmail.recentlyClosedTabs.length, 0);</span>
<a href="#l284.324"></a><span id="l284.324"> </span>
<a href="#l284.325"></a><span id="l284.325">   // The history is cleaned so let's open 15 tabs...</span>
<a href="#l284.326"></a><span id="l284.326">   be_in_folder(folder);</span>
<a href="#l284.327"></a><span id="l284.327"> </span>
<a href="#l284.328"></a><span id="l284.328">   for (let idx = 0; idx &lt; 15; idx++) {</span>
<a href="#l284.329"></a><span id="l284.329">     select_click_row(idx);</span>
<a href="#l284.330"></a><span id="l284.330">     open_selected_message_in_new_tab(true);</span>
<a href="#l284.331"></a><span id="l284.331">   }</span>
<a href="#l284.332"></a><span id="l284.332" class="difflineat">@@ -412,60 +415,60 @@ function test_tab_recentlyClosed() {</span>
<a href="#l284.333"></a><span id="l284.333">   }</span>
<a href="#l284.334"></a><span id="l284.334"> </span>
<a href="#l284.335"></a><span id="l284.335">   assert_number_of_tabs_open(2);</span>
<a href="#l284.336"></a><span id="l284.336"> </span>
<a href="#l284.337"></a><span id="l284.337">   // ...then open the context menu.</span>
<a href="#l284.338"></a><span id="l284.338">   let menu = _synthesizeRecentlyClosedMenu();</span>
<a href="#l284.339"></a><span id="l284.339"> </span>
<a href="#l284.340"></a><span id="l284.340">   // Check if the context menu was populated correctly...</span>
<a href="#l284.341"></a><span id="l284.341" class="difflineminus">-  assert_true(menu.itemCount == 12, &quot;Failed to populate context menu&quot;);</span>
<a href="#l284.342"></a><span id="l284.342" class="difflineplus">+  Assert.ok(menu.itemCount == 12, &quot;Failed to populate context menu&quot;);</span>
<a href="#l284.343"></a><span id="l284.343">   for (let idx = 0; idx &lt; 10; idx++) {</span>
<a href="#l284.344"></a><span id="l284.344" class="difflineminus">-    assert_true(</span>
<a href="#l284.345"></a><span id="l284.345" class="difflineplus">+    Assert.ok(</span>
<a href="#l284.346"></a><span id="l284.346">       tabTitles[idx] == menu.getItemAtIndex(idx).label,</span>
<a href="#l284.347"></a><span id="l284.347">       &quot;Tab Title does not match Menu item&quot;</span>
<a href="#l284.348"></a><span id="l284.348">     );</span>
<a href="#l284.349"></a><span id="l284.349">   }</span>
<a href="#l284.350"></a><span id="l284.350"> </span>
<a href="#l284.351"></a><span id="l284.351">   // Restore the most recently closed tab</span>
<a href="#l284.352"></a><span id="l284.352">   EventUtils.synthesizeMouse(menu.getItemAtIndex(0), 5, 5, {}, mc.window);</span>
<a href="#l284.353"></a><span id="l284.353">   _teardownRecentlyClosedMenu();</span>
<a href="#l284.354"></a><span id="l284.354"> </span>
<a href="#l284.355"></a><span id="l284.355">   wait_for_message_display_completion(mc);</span>
<a href="#l284.356"></a><span id="l284.356">   assert_number_of_tabs_open(3);</span>
<a href="#l284.357"></a><span id="l284.357">   assert_selected_and_displayed(msgHdrsInFolder[14]);</span>
<a href="#l284.358"></a><span id="l284.358"> </span>
<a href="#l284.359"></a><span id="l284.359">   // The context menu should now contain one item less.</span>
<a href="#l284.360"></a><span id="l284.360">   _synthesizeRecentlyClosedMenu();</span>
<a href="#l284.361"></a><span id="l284.361"> </span>
<a href="#l284.362"></a><span id="l284.362" class="difflineminus">-  assert_true(menu.itemCount == 11, &quot;Failed to populate context menu&quot;);</span>
<a href="#l284.363"></a><span id="l284.363" class="difflineplus">+  Assert.ok(menu.itemCount == 11, &quot;Failed to populate context menu&quot;);</span>
<a href="#l284.364"></a><span id="l284.364">   for (let idx = 0; idx &lt; 9; idx++) {</span>
<a href="#l284.365"></a><span id="l284.365" class="difflineminus">-    assert_true(</span>
<a href="#l284.366"></a><span id="l284.366" class="difflineplus">+    Assert.ok(</span>
<a href="#l284.367"></a><span id="l284.367">       tabTitles[idx + 1] == menu.getItemAtIndex(idx).label,</span>
<a href="#l284.368"></a><span id="l284.368">       &quot;Tab Title does not match Menu item&quot;</span>
<a href="#l284.369"></a><span id="l284.369">     );</span>
<a href="#l284.370"></a><span id="l284.370">   }</span>
<a href="#l284.371"></a><span id="l284.371"> </span>
<a href="#l284.372"></a><span id="l284.372">   // Now we restore an &quot;random&quot; tab.</span>
<a href="#l284.373"></a><span id="l284.373">   EventUtils.synthesizeMouse(menu.getItemAtIndex(5), 5, 5, {}, mc.window);</span>
<a href="#l284.374"></a><span id="l284.374">   _teardownRecentlyClosedMenu();</span>
<a href="#l284.375"></a><span id="l284.375"> </span>
<a href="#l284.376"></a><span id="l284.376">   wait_for_message_display_completion(mc);</span>
<a href="#l284.377"></a><span id="l284.377">   assert_number_of_tabs_open(4);</span>
<a href="#l284.378"></a><span id="l284.378">   assert_selected_and_displayed(msgHdrsInFolder[8]);</span>
<a href="#l284.379"></a><span id="l284.379"> </span>
<a href="#l284.380"></a><span id="l284.380">   // finally restore all tabs</span>
<a href="#l284.381"></a><span id="l284.381">   _synthesizeRecentlyClosedMenu();</span>
<a href="#l284.382"></a><span id="l284.382"> </span>
<a href="#l284.383"></a><span id="l284.383" class="difflineminus">-  assert_true(menu.itemCount == 10, &quot;Failed to populate context menu&quot;);</span>
<a href="#l284.384"></a><span id="l284.384" class="difflineminus">-  assert_true(</span>
<a href="#l284.385"></a><span id="l284.385" class="difflineplus">+  Assert.ok(menu.itemCount == 10, &quot;Failed to populate context menu&quot;);</span>
<a href="#l284.386"></a><span id="l284.386" class="difflineplus">+  Assert.ok(</span>
<a href="#l284.387"></a><span id="l284.387">     tabTitles[1] == menu.getItemAtIndex(0).label,</span>
<a href="#l284.388"></a><span id="l284.388">     &quot;Tab Title does not match Menu item&quot;</span>
<a href="#l284.389"></a><span id="l284.389">   );</span>
<a href="#l284.390"></a><span id="l284.390" class="difflineminus">-  assert_true(</span>
<a href="#l284.391"></a><span id="l284.391" class="difflineplus">+  Assert.ok(</span>
<a href="#l284.392"></a><span id="l284.392">     tabTitles[7] == menu.getItemAtIndex(5).label,</span>
<a href="#l284.393"></a><span id="l284.393">     &quot;Tab Title does not match Menu item&quot;</span>
<a href="#l284.394"></a><span id="l284.394">   );</span>
<a href="#l284.395"></a><span id="l284.395"> </span>
<a href="#l284.396"></a><span id="l284.396">   EventUtils.synthesizeMouse(</span>
<a href="#l284.397"></a><span id="l284.397">     menu.getItemAtIndex(menu.itemCount - 1),</span>
<a href="#l284.398"></a><span id="l284.398">     5,</span>
<a href="#l284.399"></a><span id="l284.399">     5,</span>
<a href="#l284.400"></a><span id="l284.400" class="difflineat">@@ -474,37 +477,27 @@ function test_tab_recentlyClosed() {</span>
<a href="#l284.401"></a><span id="l284.401">   );</span>
<a href="#l284.402"></a><span id="l284.402">   _teardownRecentlyClosedMenu();</span>
<a href="#l284.403"></a><span id="l284.403"> </span>
<a href="#l284.404"></a><span id="l284.404">   wait_for_message_display_completion(mc);</span>
<a href="#l284.405"></a><span id="l284.405"> </span>
<a href="#l284.406"></a><span id="l284.406">   // out of the 16 tab, we closed all except two. As the history can store</span>
<a href="#l284.407"></a><span id="l284.407">   // only 10 items we have to endup with exactly 10 + 2 tabs.</span>
<a href="#l284.408"></a><span id="l284.408">   assert_number_of_tabs_open(12);</span>
<a href="#l284.409"></a><span id="l284.409" class="difflineminus">-}</span>
<a href="#l284.410"></a><span id="l284.410" class="difflineplus">+  teardownTest();</span>
<a href="#l284.411"></a><span id="l284.411" class="difflineplus">+});</span>
<a href="#l284.412"></a><span id="l284.412"> </span>
<a href="#l284.413"></a><span id="l284.413"> function teardownTest(test) {</span>
<a href="#l284.414"></a><span id="l284.414" class="difflineminus">-  switch (test) {</span>
<a href="#l284.415"></a><span id="l284.415" class="difflineminus">-    case test_tab_reorder_detach:</span>
<a href="#l284.416"></a><span id="l284.416" class="difflineminus">-    case test_tab_reorder_window:</span>
<a href="#l284.417"></a><span id="l284.417" class="difflineminus">-      // Some test cases open new windows, thus we need to ensure all</span>
<a href="#l284.418"></a><span id="l284.418" class="difflineminus">-      // opened windows get closed.</span>
<a href="#l284.419"></a><span id="l284.419" class="difflineminus">-</span>
<a href="#l284.420"></a><span id="l284.420" class="difflineminus">-      let en = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l284.421"></a><span id="l284.421" class="difflineminus">-</span>
<a href="#l284.422"></a><span id="l284.422" class="difflineminus">-      while (en.hasMoreElements()) {</span>
<a href="#l284.423"></a><span id="l284.423" class="difflineminus">-        var win = en.getNext();</span>
<a href="#l284.424"></a><span id="l284.424" class="difflineplus">+  // Some test cases open new windows, thus we need to ensure all</span>
<a href="#l284.425"></a><span id="l284.425" class="difflineplus">+  // opened windows get closed.</span>
<a href="#l284.426"></a><span id="l284.426" class="difflineplus">+  let en = Services.wm.getEnumerator(&quot;mail:3pane&quot;);</span>
<a href="#l284.427"></a><span id="l284.427" class="difflineplus">+  while (en.hasMoreElements()) {</span>
<a href="#l284.428"></a><span id="l284.428" class="difflineplus">+    var win = en.getNext();</span>
<a href="#l284.429"></a><span id="l284.429"> </span>
<a href="#l284.430"></a><span id="l284.430" class="difflineminus">-        if (win != mc.window) {</span>
<a href="#l284.431"></a><span id="l284.431" class="difflineminus">-          close_window(new mozmill.controller.MozMillController(win));</span>
<a href="#l284.432"></a><span id="l284.432" class="difflineminus">-        }</span>
<a href="#l284.433"></a><span id="l284.433" class="difflineminus">-      }</span>
<a href="#l284.434"></a><span id="l284.434" class="difflineminus">-</span>
<a href="#l284.435"></a><span id="l284.435" class="difflineminus">-    // fall through!</span>
<a href="#l284.436"></a><span id="l284.436" class="difflineplus">+    if (win != mc.window) {</span>
<a href="#l284.437"></a><span id="l284.437" class="difflineplus">+      win.close();</span>
<a href="#l284.438"></a><span id="l284.438" class="difflineplus">+    }</span>
<a href="#l284.439"></a><span id="l284.439" class="difflineplus">+  }</span>
<a href="#l284.440"></a><span id="l284.440"> </span>
<a href="#l284.441"></a><span id="l284.441" class="difflineminus">-    case test_tab_reorder_tabbar:</span>
<a href="#l284.442"></a><span id="l284.442" class="difflineminus">-    case test_tab_recentlyClosed:</span>
<a href="#l284.443"></a><span id="l284.443" class="difflineminus">-    case test_tab_undo:</span>
<a href="#l284.444"></a><span id="l284.444" class="difflineminus">-      // clean up the tabbbar</span>
<a href="#l284.445"></a><span id="l284.445" class="difflineminus">-      mc.tabmail.closeOtherTabs(0);</span>
<a href="#l284.446"></a><span id="l284.446" class="difflineminus">-      assert_number_of_tabs_open(1);</span>
<a href="#l284.447"></a><span id="l284.447" class="difflineminus">-  }</span>
<a href="#l284.448"></a><span id="l284.448" class="difflineplus">+  // clean up the tabbbar</span>
<a href="#l284.449"></a><span id="l284.449" class="difflineplus">+  mc.tabmail.closeOtherTabs(0);</span>
<a href="#l284.450"></a><span id="l284.450" class="difflineplus">+  assert_number_of_tabs_open(1);</span>
<a href="#l284.451"></a><span id="l284.451"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l285.1"></a><span id="l285.1">new file mode 100644</span>
<a href="#l285.2"></a><span id="l285.2" class="difflineminus">--- /dev/null</span>
<a href="#l285.3"></a><span id="l285.3" class="difflineplus">+++ b/mail/test/browser/utils/browser.ini</span>
<a href="#l285.4"></a><span id="l285.4" class="difflineat">@@ -0,0 +1,16 @@</span>
<a href="#l285.5"></a><span id="l285.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l285.6"></a><span id="l285.6" class="difflineplus">+prefs =</span>
<a href="#l285.7"></a><span id="l285.7" class="difflineplus">+  browser.tabs.remote.autostart=false</span>
<a href="#l285.8"></a><span id="l285.8" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l285.9"></a><span id="l285.9" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l285.10"></a><span id="l285.10" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l285.11"></a><span id="l285.11" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l285.12"></a><span id="l285.12" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l285.13"></a><span id="l285.13" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l285.14"></a><span id="l285.14" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l285.15"></a><span id="l285.15" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l285.16"></a><span id="l285.16" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l285.17"></a><span id="l285.17" class="difflineplus">+</span>
<a href="#l285.18"></a><span id="l285.18" class="difflineplus">+[browser_extensionSupport.js]</span>
<a href="#l285.19"></a><span id="l285.19" class="difflineplus">+[browser_iteratorUtils.js]</span>
<a href="#l285.20"></a><span id="l285.20" class="difflineplus">+support-files = html/collections.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l286.1"></a><span id="l286.1">copy from mail/test/mozmill/utils/test-extensionSupport.js</span>
<a href="#l286.2"></a><span id="l286.2">copy to mail/test/browser/utils/browser_extensionSupport.js</span>
<a href="#l286.3"></a><span id="l286.3" class="difflineminus">--- a/mail/test/mozmill/utils/test-extensionSupport.js</span>
<a href="#l286.4"></a><span id="l286.4" class="difflineplus">+++ b/mail/test/browser/utils/browser_extensionSupport.js</span>
<a href="#l286.5"></a><span id="l286.5" class="difflineat">@@ -1,38 +1,38 @@</span>
<a href="#l286.6"></a><span id="l286.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l286.7"></a><span id="l286.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l286.8"></a><span id="l286.8">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l286.9"></a><span id="l286.9"> </span>
<a href="#l286.10"></a><span id="l286.10"> /**</span>
<a href="#l286.11"></a><span id="l286.11">  * Tests ExtensionSupport.jsm functions.</span>
<a href="#l286.12"></a><span id="l286.12">  */</span>
<a href="#l286.13"></a><span id="l286.13"> </span>
<a href="#l286.14"></a><span id="l286.14" class="difflineplus">+/* globals gFolderTreeView */</span>
<a href="#l286.15"></a><span id="l286.15" class="difflineplus">+</span>
<a href="#l286.16"></a><span id="l286.16"> var {</span>
<a href="#l286.17"></a><span id="l286.17">   close_address_book_window,</span>
<a href="#l286.18"></a><span id="l286.18">   open_address_book_window,</span>
<a href="#l286.19"></a><span id="l286.19"> } = ChromeUtils.import(</span>
<a href="#l286.20"></a><span id="l286.20">   &quot;resource://testing-common/mozmill/AddressBookHelpers.jsm&quot;</span>
<a href="#l286.21"></a><span id="l286.21"> );</span>
<a href="#l286.22"></a><span id="l286.22"> var { close_compose_window, open_compose_new_mail } = ChromeUtils.import(</span>
<a href="#l286.23"></a><span id="l286.23">   &quot;resource://testing-common/mozmill/ComposeHelpers.jsm&quot;</span>
<a href="#l286.24"></a><span id="l286.24"> );</span>
<a href="#l286.25"></a><span id="l286.25" class="difflineminus">-var { assert_equals, assert_false, assert_true } = ChromeUtils.import(</span>
<a href="#l286.26"></a><span id="l286.26" class="difflineminus">-  &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l286.27"></a><span id="l286.27" class="difflineminus">-);</span>
<a href="#l286.28"></a><span id="l286.28"> </span>
<a href="#l286.29"></a><span id="l286.29"> var { ExtensionSupport } = ChromeUtils.import(</span>
<a href="#l286.30"></a><span id="l286.30">   &quot;resource:///modules/ExtensionSupport.jsm&quot;</span>
<a href="#l286.31"></a><span id="l286.31"> );</span>
<a href="#l286.32"></a><span id="l286.32"> </span>
<a href="#l286.33"></a><span id="l286.33"> /**</span>
<a href="#l286.34"></a><span id="l286.34">  * Bug 1450288</span>
<a href="#l286.35"></a><span id="l286.35">  * Test ExtensionSupport.registerWindowListener and ExtensionSupport.unregisterWindowListener.</span>
<a href="#l286.36"></a><span id="l286.36">  */</span>
<a href="#l286.37"></a><span id="l286.37" class="difflineminus">-function test_windowListeners() {</span>
<a href="#l286.38"></a><span id="l286.38" class="difflineplus">+add_task(function test_windowListeners() {</span>
<a href="#l286.39"></a><span id="l286.39" class="difflineplus">+  gFolderTreeView.selectFolder(gFolderTreeView._enumerateFolders[1]);</span>
<a href="#l286.40"></a><span id="l286.40">   // There may be some pre-existing listeners already set up, e.g. mozmill ones.</span>
<a href="#l286.41"></a><span id="l286.41">   let originalListenerCount = ExtensionSupport.registeredWindowListenerCount;</span>
<a href="#l286.42"></a><span id="l286.42"> </span>
<a href="#l286.43"></a><span id="l286.43">   let addonRunCount = [];</span>
<a href="#l286.44"></a><span id="l286.44">   addonRunCount.load = new Map();</span>
<a href="#l286.45"></a><span id="l286.45">   addonRunCount.unload = new Map();</span>
<a href="#l286.46"></a><span id="l286.46"> </span>
<a href="#l286.47"></a><span id="l286.47">   function addonListener(aAddon, aEvent) {</span>
<a href="#l286.48"></a><span id="l286.48" class="difflineat">@@ -46,124 +46,124 @@ function test_windowListeners() {</span>
<a href="#l286.49"></a><span id="l286.49">     if (!addonRunCount[aEvent].has(aAddon)) {</span>
<a href="#l286.50"></a><span id="l286.50">       return 0;</span>
<a href="#l286.51"></a><span id="l286.51">     }</span>
<a href="#l286.52"></a><span id="l286.52"> </span>
<a href="#l286.53"></a><span id="l286.53">     return addonRunCount[aEvent].get(aAddon);</span>
<a href="#l286.54"></a><span id="l286.54">   }</span>
<a href="#l286.55"></a><span id="l286.55"> </span>
<a href="#l286.56"></a><span id="l286.56">   // Extension listening to all windows and all events.</span>
<a href="#l286.57"></a><span id="l286.57" class="difflineminus">-  assert_true(</span>
<a href="#l286.58"></a><span id="l286.58" class="difflineplus">+  Assert.ok(</span>
<a href="#l286.59"></a><span id="l286.59">     ExtensionSupport.registerWindowListener(&quot;test-addon1&quot;, {</span>
<a href="#l286.60"></a><span id="l286.60">       onLoadWindow() {</span>
<a href="#l286.61"></a><span id="l286.61">         addonListener(&quot;test-addon1&quot;, &quot;load&quot;);</span>
<a href="#l286.62"></a><span id="l286.62">       },</span>
<a href="#l286.63"></a><span id="l286.63">       onUnloadWindow() {</span>
<a href="#l286.64"></a><span id="l286.64">         addonListener(&quot;test-addon1&quot;, &quot;unload&quot;);</span>
<a href="#l286.65"></a><span id="l286.65">       },</span>
<a href="#l286.66"></a><span id="l286.66">     })</span>
<a href="#l286.67"></a><span id="l286.67">   );</span>
<a href="#l286.68"></a><span id="l286.68"> </span>
<a href="#l286.69"></a><span id="l286.69" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon1&quot;, &quot;load&quot;), 1);</span>
<a href="#l286.70"></a><span id="l286.70" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon1&quot;, &quot;load&quot;), 2);</span>
<a href="#l286.71"></a><span id="l286.71"> </span>
<a href="#l286.72"></a><span id="l286.72">   // Extension listening to compose window only.</span>
<a href="#l286.73"></a><span id="l286.73" class="difflineminus">-  assert_true(</span>
<a href="#l286.74"></a><span id="l286.74" class="difflineplus">+  Assert.ok(</span>
<a href="#l286.75"></a><span id="l286.75">     ExtensionSupport.registerWindowListener(&quot;test-addon2&quot;, {</span>
<a href="#l286.76"></a><span id="l286.76">       chromeURLs: [</span>
<a href="#l286.77"></a><span id="l286.77">         &quot;chrome://messenger/content/messengercompose/messengercompose.xul&quot;,</span>
<a href="#l286.78"></a><span id="l286.78">       ],</span>
<a href="#l286.79"></a><span id="l286.79">       onLoadWindow() {</span>
<a href="#l286.80"></a><span id="l286.80">         addonListener(&quot;test-addon2&quot;, &quot;load&quot;);</span>
<a href="#l286.81"></a><span id="l286.81">       },</span>
<a href="#l286.82"></a><span id="l286.82">       onUnloadWindow() {</span>
<a href="#l286.83"></a><span id="l286.83">         addonListener(&quot;test-addon2&quot;, &quot;unload&quot;);</span>
<a href="#l286.84"></a><span id="l286.84">       },</span>
<a href="#l286.85"></a><span id="l286.85">     })</span>
<a href="#l286.86"></a><span id="l286.86">   );</span>
<a href="#l286.87"></a><span id="l286.87"> </span>
<a href="#l286.88"></a><span id="l286.88">   let cwc = open_compose_new_mail();</span>
<a href="#l286.89"></a><span id="l286.89"> </span>
<a href="#l286.90"></a><span id="l286.90" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon1&quot;, &quot;load&quot;), 2);</span>
<a href="#l286.91"></a><span id="l286.91" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon2&quot;, &quot;load&quot;), 1);</span>
<a href="#l286.92"></a><span id="l286.92" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon1&quot;, &quot;load&quot;), 3);</span>
<a href="#l286.93"></a><span id="l286.93" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon2&quot;, &quot;load&quot;), 1);</span>
<a href="#l286.94"></a><span id="l286.94"> </span>
<a href="#l286.95"></a><span id="l286.95">   // Extension listening to compose window once while it is already open.</span>
<a href="#l286.96"></a><span id="l286.96" class="difflineminus">-  assert_true(</span>
<a href="#l286.97"></a><span id="l286.97" class="difflineplus">+  Assert.ok(</span>
<a href="#l286.98"></a><span id="l286.98">     ExtensionSupport.registerWindowListener(&quot;test-addon3&quot;, {</span>
<a href="#l286.99"></a><span id="l286.99">       chromeURLs: [</span>
<a href="#l286.100"></a><span id="l286.100">         &quot;chrome://messenger/content/messengercompose/messengercompose.xul&quot;,</span>
<a href="#l286.101"></a><span id="l286.101">       ],</span>
<a href="#l286.102"></a><span id="l286.102">       onLoadWindow() {</span>
<a href="#l286.103"></a><span id="l286.103">         addonListener(&quot;test-addon3&quot;, &quot;load&quot;);</span>
<a href="#l286.104"></a><span id="l286.104">         ExtensionSupport.unregisterWindowListener(&quot;test-addon3&quot;);</span>
<a href="#l286.105"></a><span id="l286.105">       },</span>
<a href="#l286.106"></a><span id="l286.106">     })</span>
<a href="#l286.107"></a><span id="l286.107">   );</span>
<a href="#l286.108"></a><span id="l286.108"> </span>
<a href="#l286.109"></a><span id="l286.109" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon3&quot;, &quot;load&quot;), 1);</span>
<a href="#l286.110"></a><span id="l286.110" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon3&quot;, &quot;load&quot;), 1);</span>
<a href="#l286.111"></a><span id="l286.111"> </span>
<a href="#l286.112"></a><span id="l286.112">   // Extension listening to compose window while it is already open.</span>
<a href="#l286.113"></a><span id="l286.113" class="difflineminus">-  assert_true(</span>
<a href="#l286.114"></a><span id="l286.114" class="difflineplus">+  Assert.ok(</span>
<a href="#l286.115"></a><span id="l286.115">     ExtensionSupport.registerWindowListener(&quot;test-addon4&quot;, {</span>
<a href="#l286.116"></a><span id="l286.116">       chromeURLs: [</span>
<a href="#l286.117"></a><span id="l286.117">         &quot;chrome://messenger/content/messengercompose/messengercompose.xul&quot;,</span>
<a href="#l286.118"></a><span id="l286.118">       ],</span>
<a href="#l286.119"></a><span id="l286.119">       onLoadWindow() {</span>
<a href="#l286.120"></a><span id="l286.120">         addonListener(&quot;test-addon4&quot;, &quot;load&quot;);</span>
<a href="#l286.121"></a><span id="l286.121">       },</span>
<a href="#l286.122"></a><span id="l286.122">       onUnloadWindow() {</span>
<a href="#l286.123"></a><span id="l286.123">         addonListener(&quot;test-addon4&quot;, &quot;unload&quot;);</span>
<a href="#l286.124"></a><span id="l286.124">         ExtensionSupport.unregisterWindowListener(&quot;test-addon4&quot;);</span>
<a href="#l286.125"></a><span id="l286.125">       },</span>
<a href="#l286.126"></a><span id="l286.126">     })</span>
<a href="#l286.127"></a><span id="l286.127">   );</span>
<a href="#l286.128"></a><span id="l286.128"> </span>
<a href="#l286.129"></a><span id="l286.129" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon4&quot;, &quot;load&quot;), 1);</span>
<a href="#l286.130"></a><span id="l286.130" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon4&quot;, &quot;load&quot;), 1);</span>
<a href="#l286.131"></a><span id="l286.131"> </span>
<a href="#l286.132"></a><span id="l286.132">   close_compose_window(cwc);</span>
<a href="#l286.133"></a><span id="l286.133"> </span>
<a href="#l286.134"></a><span id="l286.134" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon1&quot;, &quot;unload&quot;), 1);</span>
<a href="#l286.135"></a><span id="l286.135" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon2&quot;, &quot;unload&quot;), 1);</span>
<a href="#l286.136"></a><span id="l286.136" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon3&quot;, &quot;unload&quot;), 0);</span>
<a href="#l286.137"></a><span id="l286.137" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon4&quot;, &quot;unload&quot;), 1);</span>
<a href="#l286.138"></a><span id="l286.138" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon1&quot;, &quot;unload&quot;), 1);</span>
<a href="#l286.139"></a><span id="l286.139" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon2&quot;, &quot;unload&quot;), 1);</span>
<a href="#l286.140"></a><span id="l286.140" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon3&quot;, &quot;unload&quot;), 0);</span>
<a href="#l286.141"></a><span id="l286.141" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon4&quot;, &quot;unload&quot;), 1);</span>
<a href="#l286.142"></a><span id="l286.142"> </span>
<a href="#l286.143"></a><span id="l286.143">   cwc = open_compose_new_mail();</span>
<a href="#l286.144"></a><span id="l286.144"> </span>
<a href="#l286.145"></a><span id="l286.145" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon1&quot;, &quot;load&quot;), 3);</span>
<a href="#l286.146"></a><span id="l286.146" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon1&quot;, &quot;load&quot;), 4);</span>
<a href="#l286.147"></a><span id="l286.147">   // Addon3 didn't listen to the new compose window, addon2 did.</span>
<a href="#l286.148"></a><span id="l286.148" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon2&quot;, &quot;load&quot;), 2);</span>
<a href="#l286.149"></a><span id="l286.149" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon3&quot;, &quot;load&quot;), 1);</span>
<a href="#l286.150"></a><span id="l286.150" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon2&quot;, &quot;load&quot;), 2);</span>
<a href="#l286.151"></a><span id="l286.151" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon3&quot;, &quot;load&quot;), 1);</span>
<a href="#l286.152"></a><span id="l286.152"> </span>
<a href="#l286.153"></a><span id="l286.153">   close_compose_window(cwc);</span>
<a href="#l286.154"></a><span id="l286.154"> </span>
<a href="#l286.155"></a><span id="l286.155" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon1&quot;, &quot;unload&quot;), 2);</span>
<a href="#l286.156"></a><span id="l286.156" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon2&quot;, &quot;unload&quot;), 2);</span>
<a href="#l286.157"></a><span id="l286.157" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon3&quot;, &quot;unload&quot;), 0);</span>
<a href="#l286.158"></a><span id="l286.158" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon1&quot;, &quot;unload&quot;), 2);</span>
<a href="#l286.159"></a><span id="l286.159" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon2&quot;, &quot;unload&quot;), 2);</span>
<a href="#l286.160"></a><span id="l286.160" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon3&quot;, &quot;unload&quot;), 0);</span>
<a href="#l286.161"></a><span id="l286.161"> </span>
<a href="#l286.162"></a><span id="l286.162">   let abc = open_address_book_window();</span>
<a href="#l286.163"></a><span id="l286.163">   // Only Addon1 listens to any window.</span>
<a href="#l286.164"></a><span id="l286.164" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon1&quot;, &quot;load&quot;), 4);</span>
<a href="#l286.165"></a><span id="l286.165" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon2&quot;, &quot;load&quot;), 2);</span>
<a href="#l286.166"></a><span id="l286.166" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon3&quot;, &quot;load&quot;), 1);</span>
<a href="#l286.167"></a><span id="l286.167" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon4&quot;, &quot;load&quot;), 1);</span>
<a href="#l286.168"></a><span id="l286.168" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon1&quot;, &quot;load&quot;), 5);</span>
<a href="#l286.169"></a><span id="l286.169" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon2&quot;, &quot;load&quot;), 2);</span>
<a href="#l286.170"></a><span id="l286.170" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon3&quot;, &quot;load&quot;), 1);</span>
<a href="#l286.171"></a><span id="l286.171" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon4&quot;, &quot;load&quot;), 1);</span>
<a href="#l286.172"></a><span id="l286.172"> </span>
<a href="#l286.173"></a><span id="l286.173">   close_address_book_window(abc);</span>
<a href="#l286.174"></a><span id="l286.174"> </span>
<a href="#l286.175"></a><span id="l286.175" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon1&quot;, &quot;unload&quot;), 3);</span>
<a href="#l286.176"></a><span id="l286.176" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon2&quot;, &quot;unload&quot;), 2);</span>
<a href="#l286.177"></a><span id="l286.177" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon3&quot;, &quot;unload&quot;), 0);</span>
<a href="#l286.178"></a><span id="l286.178" class="difflineminus">-  assert_equals(addonCount(&quot;test-addon4&quot;, &quot;unload&quot;), 1);</span>
<a href="#l286.179"></a><span id="l286.179" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon1&quot;, &quot;unload&quot;), 3);</span>
<a href="#l286.180"></a><span id="l286.180" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon2&quot;, &quot;unload&quot;), 2);</span>
<a href="#l286.181"></a><span id="l286.181" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon3&quot;, &quot;unload&quot;), 0);</span>
<a href="#l286.182"></a><span id="l286.182" class="difflineplus">+  Assert.equal(addonCount(&quot;test-addon4&quot;, &quot;unload&quot;), 1);</span>
<a href="#l286.183"></a><span id="l286.183"> </span>
<a href="#l286.184"></a><span id="l286.184">   // Registering with some invalid data should fail.</span>
<a href="#l286.185"></a><span id="l286.185" class="difflineminus">-  assert_false(ExtensionSupport.registerWindowListener(&quot;&quot;, {}));</span>
<a href="#l286.186"></a><span id="l286.186" class="difflineminus">-  assert_false(ExtensionSupport.registerWindowListener(&quot;test-addon1&quot;, {}));</span>
<a href="#l286.187"></a><span id="l286.187" class="difflineminus">-  assert_false(ExtensionSupport.registerWindowListener(&quot;test-addon5&quot;, {}));</span>
<a href="#l286.188"></a><span id="l286.188" class="difflineminus">-  assert_false(ExtensionSupport.unregisterWindowListener(&quot;&quot;));</span>
<a href="#l286.189"></a><span id="l286.189" class="difflineminus">-  assert_false(ExtensionSupport.unregisterWindowListener(&quot;test-addon5&quot;));</span>
<a href="#l286.190"></a><span id="l286.190" class="difflineplus">+  Assert.ok(!ExtensionSupport.registerWindowListener(&quot;&quot;, {}));</span>
<a href="#l286.191"></a><span id="l286.191" class="difflineplus">+  Assert.ok(!ExtensionSupport.registerWindowListener(&quot;test-addon1&quot;, {}));</span>
<a href="#l286.192"></a><span id="l286.192" class="difflineplus">+  Assert.ok(!ExtensionSupport.registerWindowListener(&quot;test-addon5&quot;, {}));</span>
<a href="#l286.193"></a><span id="l286.193" class="difflineplus">+  Assert.ok(!ExtensionSupport.unregisterWindowListener(&quot;&quot;));</span>
<a href="#l286.194"></a><span id="l286.194" class="difflineplus">+  Assert.ok(!ExtensionSupport.unregisterWindowListener(&quot;test-addon5&quot;));</span>
<a href="#l286.195"></a><span id="l286.195"> </span>
<a href="#l286.196"></a><span id="l286.196">   // Clean up addon registrations. addon3 unregistered itself already.</span>
<a href="#l286.197"></a><span id="l286.197" class="difflineminus">-  assert_true(ExtensionSupport.unregisterWindowListener(&quot;test-addon1&quot;));</span>
<a href="#l286.198"></a><span id="l286.198" class="difflineminus">-  assert_true(ExtensionSupport.unregisterWindowListener(&quot;test-addon2&quot;));</span>
<a href="#l286.199"></a><span id="l286.199" class="difflineminus">-  assert_false(ExtensionSupport.unregisterWindowListener(&quot;test-addon3&quot;));</span>
<a href="#l286.200"></a><span id="l286.200" class="difflineminus">-  assert_equals(</span>
<a href="#l286.201"></a><span id="l286.201" class="difflineplus">+  Assert.ok(ExtensionSupport.unregisterWindowListener(&quot;test-addon1&quot;));</span>
<a href="#l286.202"></a><span id="l286.202" class="difflineplus">+  Assert.ok(ExtensionSupport.unregisterWindowListener(&quot;test-addon2&quot;));</span>
<a href="#l286.203"></a><span id="l286.203" class="difflineplus">+  Assert.ok(!ExtensionSupport.unregisterWindowListener(&quot;test-addon3&quot;));</span>
<a href="#l286.204"></a><span id="l286.204" class="difflineplus">+  Assert.equal(</span>
<a href="#l286.205"></a><span id="l286.205">     ExtensionSupport.registeredWindowListenerCount,</span>
<a href="#l286.206"></a><span id="l286.206">     originalListenerCount</span>
<a href="#l286.207"></a><span id="l286.207">   );</span>
<a href="#l286.208"></a><span id="l286.208" class="difflineminus">-}</span>
<a href="#l286.209"></a><span id="l286.209" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l287.1"></a><span id="l287.1">copy from mail/test/mozmill/utils/test-iteratorUtils.js</span>
<a href="#l287.2"></a><span id="l287.2">copy to mail/test/browser/utils/browser_iteratorUtils.js</span>
<a href="#l287.3"></a><span id="l287.3" class="difflineminus">--- a/mail/test/mozmill/utils/test-iteratorUtils.js</span>
<a href="#l287.4"></a><span id="l287.4" class="difflineplus">+++ b/mail/test/browser/utils/browser_iteratorUtils.js</span>
<a href="#l287.5"></a><span id="l287.5" class="difflineat">@@ -4,77 +4,81 @@</span>
<a href="#l287.6"></a><span id="l287.6"> </span>
<a href="#l287.7"></a><span id="l287.7"> /**</span>
<a href="#l287.8"></a><span id="l287.8">  * Tests iteratorUtils with items pulled from content into chrome.</span>
<a href="#l287.9"></a><span id="l287.9">  */</span>
<a href="#l287.10"></a><span id="l287.10"> </span>
<a href="#l287.11"></a><span id="l287.11"> var { open_content_tab_with_url } = ChromeUtils.import(</span>
<a href="#l287.12"></a><span id="l287.12">   &quot;resource://testing-common/mozmill/ContentTabHelpers.jsm&quot;</span>
<a href="#l287.13"></a><span id="l287.13"> );</span>
<a href="#l287.14"></a><span id="l287.14" class="difflineminus">-var { assert_equals, close_tab } = ChromeUtils.import(</span>
<a href="#l287.15"></a><span id="l287.15" class="difflineplus">+var { close_tab } = ChromeUtils.import(</span>
<a href="#l287.16"></a><span id="l287.16">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l287.17"></a><span id="l287.17"> );</span>
<a href="#l287.18"></a><span id="l287.18"> </span>
<a href="#l287.19"></a><span id="l287.19"> var iteratorUtils = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l287.20"></a><span id="l287.20"> var { Services } = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l287.21"></a><span id="l287.21"> </span>
<a href="#l287.22"></a><span id="l287.22"> var kWhatsNewPref = &quot;mailnews.start_page.override_url&quot;;</span>
<a href="#l287.23"></a><span id="l287.23"> </span>
<a href="#l287.24"></a><span id="l287.24" class="difflineminus">-var gUrl = collector.addHttpResource(&quot;../utils/html&quot;, &quot;&quot;);</span>
<a href="#l287.25"></a><span id="l287.25" class="difflineminus">-var gCollectionsUrl = gUrl + &quot;collections.html&quot;;</span>
<a href="#l287.26"></a><span id="l287.26" class="difflineminus">-var gOriginalWhatsNew, gTab;</span>
<a href="#l287.27"></a><span id="l287.27" class="difflineplus">+var gCollectionsUrl = Services.io.newURI(</span>
<a href="#l287.28"></a><span id="l287.28" class="difflineplus">+  getRootDirectory(gTestPath) + &quot;html/collections.html&quot;</span>
<a href="#l287.29"></a><span id="l287.29" class="difflineplus">+).spec;</span>
<a href="#l287.30"></a><span id="l287.30" class="difflineplus">+var gTab;</span>
<a href="#l287.31"></a><span id="l287.31"> </span>
<a href="#l287.32"></a><span id="l287.32" class="difflineminus">-function setupModule(module) {</span>
<a href="#l287.33"></a><span id="l287.33" class="difflineminus">-  gOriginalWhatsNew = Services.prefs.getCharPref(kWhatsNewPref);</span>
<a href="#l287.34"></a><span id="l287.34" class="difflineplus">+add_task(function setupModule(module) {</span>
<a href="#l287.35"></a><span id="l287.35">   Services.prefs.setCharPref(kWhatsNewPref, gCollectionsUrl);</span>
<a href="#l287.36"></a><span id="l287.36" class="difflineminus">-}</span>
<a href="#l287.37"></a><span id="l287.37" class="difflineplus">+});</span>
<a href="#l287.38"></a><span id="l287.38"> </span>
<a href="#l287.39"></a><span id="l287.39" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l287.40"></a><span id="l287.40" class="difflineminus">-  Services.prefs.setCharPref(kWhatsNewPref, gOriginalWhatsNew);</span>
<a href="#l287.41"></a><span id="l287.41" class="difflineminus">-}</span>
<a href="#l287.42"></a><span id="l287.42" class="difflineplus">+registerCleanupFunction(function teardownModule(module) {</span>
<a href="#l287.43"></a><span id="l287.43" class="difflineplus">+  Services.prefs.clearUserPref(kWhatsNewPref);</span>
<a href="#l287.44"></a><span id="l287.44" class="difflineplus">+});</span>
<a href="#l287.45"></a><span id="l287.45"> </span>
<a href="#l287.46"></a><span id="l287.46"> function setupTest() {</span>
<a href="#l287.47"></a><span id="l287.47">   gTab = open_content_tab_with_url(gCollectionsUrl);</span>
<a href="#l287.48"></a><span id="l287.48"> }</span>
<a href="#l287.49"></a><span id="l287.49"> </span>
<a href="#l287.50"></a><span id="l287.50"> function teardownTest() {</span>
<a href="#l287.51"></a><span id="l287.51">   close_tab(gTab);</span>
<a href="#l287.52"></a><span id="l287.52"> }</span>
<a href="#l287.53"></a><span id="l287.53"> </span>
<a href="#l287.54"></a><span id="l287.54"> /**</span>
<a href="#l287.55"></a><span id="l287.55">  * Tests that we can use iteratorUtils.toArray on an Iterator created</span>
<a href="#l287.56"></a><span id="l287.56">  * and pulled in from content.</span>
<a href="#l287.57"></a><span id="l287.57">  */</span>
<a href="#l287.58"></a><span id="l287.58" class="difflineminus">-function test_toArray_builtin_content_iterator() {</span>
<a href="#l287.59"></a><span id="l287.59" class="difflineplus">+add_task(function test_toArray_builtin_content_iterator() {</span>
<a href="#l287.60"></a><span id="l287.60" class="difflineplus">+  setupTest();</span>
<a href="#l287.61"></a><span id="l287.61">   // kExpected matches our expectations for the contents of gIterator</span>
<a href="#l287.62"></a><span id="l287.62">   // defined collections.html.</span>
<a href="#l287.63"></a><span id="l287.63">   const kExpected = [1, 2, 3, 4, 5];</span>
<a href="#l287.64"></a><span id="l287.64"> </span>
<a href="#l287.65"></a><span id="l287.65">   // Yank the iterator out from content</span>
<a href="#l287.66"></a><span id="l287.66">   let iter = gTab.browser.contentWindow.wrappedJSObject.gIterator;</span>
<a href="#l287.67"></a><span id="l287.67">   let iterArray = iteratorUtils.toArray(iter);</span>
<a href="#l287.68"></a><span id="l287.68"> </span>
<a href="#l287.69"></a><span id="l287.69" class="difflineminus">-  assert_equals(kExpected.length, iterArray.length);</span>
<a href="#l287.70"></a><span id="l287.70" class="difflineplus">+  Assert.equal(kExpected.length, iterArray.length);</span>
<a href="#l287.71"></a><span id="l287.71"> </span>
<a href="#l287.72"></a><span id="l287.72">   kExpected.forEach((val, i) =&gt; {</span>
<a href="#l287.73"></a><span id="l287.73" class="difflineminus">-    assert_equals(val, iterArray[i]);</span>
<a href="#l287.74"></a><span id="l287.74" class="difflineplus">+    Assert.equal(val, iterArray[i]);</span>
<a href="#l287.75"></a><span id="l287.75">   });</span>
<a href="#l287.76"></a><span id="l287.76" class="difflineminus">-}</span>
<a href="#l287.77"></a><span id="l287.77" class="difflineplus">+  teardownTest();</span>
<a href="#l287.78"></a><span id="l287.78" class="difflineplus">+});</span>
<a href="#l287.79"></a><span id="l287.79"> </span>
<a href="#l287.80"></a><span id="l287.80"> /**</span>
<a href="#l287.81"></a><span id="l287.81">  * Tests that we can use iteratorUtils.toArray on a custom iterator created</span>
<a href="#l287.82"></a><span id="l287.82">  * and pulled in from content.</span>
<a href="#l287.83"></a><span id="l287.83">  */</span>
<a href="#l287.84"></a><span id="l287.84" class="difflineminus">-function test_toArray_custom_content_iterator() {</span>
<a href="#l287.85"></a><span id="l287.85" class="difflineplus">+add_task(function test_toArray_custom_content_iterator() {</span>
<a href="#l287.86"></a><span id="l287.86" class="difflineplus">+  setupTest();</span>
<a href="#l287.87"></a><span id="l287.87">   // kExpected matches our expectations for the contents of gCustomIterator</span>
<a href="#l287.88"></a><span id="l287.88">   // defined in collections.html.</span>
<a href="#l287.89"></a><span id="l287.89">   const kExpected = [6, 7, 8, 9];</span>
<a href="#l287.90"></a><span id="l287.90"> </span>
<a href="#l287.91"></a><span id="l287.91">   // Yank the iterator out from content</span>
<a href="#l287.92"></a><span id="l287.92">   let iter = gTab.browser.contentWindow.wrappedJSObject.gCustomIterator;</span>
<a href="#l287.93"></a><span id="l287.93">   let iterArray = iteratorUtils.toArray(iter);</span>
<a href="#l287.94"></a><span id="l287.94"> </span>
<a href="#l287.95"></a><span id="l287.95" class="difflineminus">-  assert_equals(kExpected.length, iterArray.length);</span>
<a href="#l287.96"></a><span id="l287.96" class="difflineplus">+  Assert.equal(kExpected.length, iterArray.length);</span>
<a href="#l287.97"></a><span id="l287.97"> </span>
<a href="#l287.98"></a><span id="l287.98">   for (let [i, val] of kExpected.entries()) {</span>
<a href="#l287.99"></a><span id="l287.99" class="difflineminus">-    assert_equals(val, iterArray[i]);</span>
<a href="#l287.100"></a><span id="l287.100" class="difflineplus">+    Assert.equal(val, iterArray[i]);</span>
<a href="#l287.101"></a><span id="l287.101">   }</span>
<a href="#l287.102"></a><span id="l287.102" class="difflineminus">-}</span>
<a href="#l287.103"></a><span id="l287.103" class="difflineplus">+  teardownTest();</span>
<a href="#l287.104"></a><span id="l287.104" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l288.1"></a><span id="l288.1">copy from mail/test/mozmill/utils/html/collections.html</span>
<a href="#l288.2"></a><span id="l288.2">copy to mail/test/browser/utils/html/collections.html</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l289.1"></a><span id="l289.1" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-manager.js</span>
<a href="#l289.2"></a><span id="l289.2" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-manager.js</span>
<a href="#l289.3"></a><span id="l289.3" class="difflineat">@@ -67,17 +67,17 @@ function destroy_account(aKey) {</span>
<a href="#l289.4"></a><span id="l289.4"> }</span>
<a href="#l289.5"></a><span id="l289.5"> </span>
<a href="#l289.6"></a><span id="l289.6"> /**</span>
<a href="#l289.7"></a><span id="l289.7">  * Tests that we load the accounts and display them in the</span>
<a href="#l289.8"></a><span id="l289.8">  * account richlistbox in the correct order (by displayName,</span>
<a href="#l289.9"></a><span id="l289.9">  * case-insensitive)</span>
<a href="#l289.10"></a><span id="l289.10">  */</span>
<a href="#l289.11"></a><span id="l289.11"> function test_load_accounts_and_properly_order() {</span>
<a href="#l289.12"></a><span id="l289.12" class="difflineminus">-  let prefTab = open_pref_tab(&quot;paneCompose&quot;);</span>
<a href="#l289.13"></a><span id="l289.13" class="difflineplus">+  let prefTab = open_pref_tab(&quot;paneCompose&quot;, &quot;compositionAttachmentsCategory&quot;);</span>
<a href="#l289.14"></a><span id="l289.14"> </span>
<a href="#l289.15"></a><span id="l289.15">   let richList = content_tab_e(prefTab, &quot;cloudFileView&quot;);</span>
<a href="#l289.16"></a><span id="l289.16">   assert_equals(4, richList.itemCount, &quot;Should be displaying 4 accounts&quot;);</span>
<a href="#l289.17"></a><span id="l289.17"> </span>
<a href="#l289.18"></a><span id="l289.18">   // Since we're sorting alphabetically by the displayName,</span>
<a href="#l289.19"></a><span id="l289.19">   // case-insensitive, the items should be ordered with the</span>
<a href="#l289.20"></a><span id="l289.20">   // following accountKeys:</span>
<a href="#l289.21"></a><span id="l289.21">   //</span>
<a href="#l289.22"></a><span id="l289.22" class="difflineat">@@ -95,17 +95,17 @@ function test_load_accounts_and_properly</span>
<a href="#l289.23"></a><span id="l289.23"> /**</span>
<a href="#l289.24"></a><span id="l289.24">  * Tests that a link in the management pane is loaded in</span>
<a href="#l289.25"></a><span id="l289.25">  * a browser and not in the management pane.</span>
<a href="#l289.26"></a><span id="l289.26">  */</span>
<a href="#l289.27"></a><span id="l289.27"> test_external_link.__force_skip__ = true;</span>
<a href="#l289.28"></a><span id="l289.28"> function test_external_link() {</span>
<a href="#l289.29"></a><span id="l289.29">   gMockExtProtSvcReg.register();</span>
<a href="#l289.30"></a><span id="l289.30"> </span>
<a href="#l289.31"></a><span id="l289.31" class="difflineminus">-  let prefTab = open_pref_tab(&quot;paneCompose&quot;);</span>
<a href="#l289.32"></a><span id="l289.32" class="difflineplus">+  let prefTab = open_pref_tab(&quot;paneCompose&quot;, &quot;compositionAttachmentsCategory&quot;);</span>
<a href="#l289.33"></a><span id="l289.33">   content_tab_e(prefTab, &quot;cloudFileView&quot;).selectedIndex = 0;</span>
<a href="#l289.34"></a><span id="l289.34"> </span>
<a href="#l289.35"></a><span id="l289.35">   let iframe = content_tab_e(prefTab, &quot;cloudFileSettingsWrapper&quot;)</span>
<a href="#l289.36"></a><span id="l289.36">     .firstElementChild;</span>
<a href="#l289.37"></a><span id="l289.37">   wait_for_frame_load(iframe, kSettingsWithLink + &quot;?accountId=someKey3&quot;);</span>
<a href="#l289.38"></a><span id="l289.38">   mc.click(new elementslib.ID(iframe.contentDocument, &quot;a&quot;));</span>
<a href="#l289.39"></a><span id="l289.39"> </span>
<a href="#l289.40"></a><span id="l289.40">   let targetHref = &quot;https://www.example.com/&quot;;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l290.1"></a><span id="l290.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/CloudfileHelpers.jsm</span>
<a href="#l290.2"></a><span id="l290.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/CloudfileHelpers.jsm</span>
<a href="#l290.3"></a><span id="l290.3" class="difflineat">@@ -6,24 +6,25 @@</span>
<a href="#l290.4"></a><span id="l290.4"> </span>
<a href="#l290.5"></a><span id="l290.5"> this.EXPORTED_SYMBOLS = [</span>
<a href="#l290.6"></a><span id="l290.6">   &quot;gMockCloudfileManager&quot;,</span>
<a href="#l290.7"></a><span id="l290.7">   &quot;MockCloudfileAccount&quot;,</span>
<a href="#l290.8"></a><span id="l290.8">   &quot;getFile&quot;,</span>
<a href="#l290.9"></a><span id="l290.9">   &quot;collectFiles&quot;,</span>
<a href="#l290.10"></a><span id="l290.10"> ];</span>
<a href="#l290.11"></a><span id="l290.11"> </span>
<a href="#l290.12"></a><span id="l290.12" class="difflineplus">+var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l290.13"></a><span id="l290.13" class="difflineplus">+</span>
<a href="#l290.14"></a><span id="l290.14"> var fdh = ChromeUtils.import(</span>
<a href="#l290.15"></a><span id="l290.15">   &quot;resource://testing-common/mozmill/FolderDisplayHelpers.jsm&quot;</span>
<a href="#l290.16"></a><span id="l290.16"> );</span>
<a href="#l290.17"></a><span id="l290.17"> </span>
<a href="#l290.18"></a><span id="l290.18"> var { cloudFileAccounts } = ChromeUtils.import(</span>
<a href="#l290.19"></a><span id="l290.19">   &quot;resource:///modules/cloudFileAccounts.jsm&quot;</span>
<a href="#l290.20"></a><span id="l290.20"> );</span>
<a href="#l290.21"></a><span id="l290.21" class="difflineminus">-var os = ChromeUtils.import(&quot;resource://testing-common/mozmill/os.jsm&quot;);</span>
<a href="#l290.22"></a><span id="l290.22"> </span>
<a href="#l290.23"></a><span id="l290.23"> var kDefaults = {</span>
<a href="#l290.24"></a><span id="l290.24">   type: &quot;default&quot;,</span>
<a href="#l290.25"></a><span id="l290.25">   iconURL: &quot;chrome://messenger/content/extension.svg&quot;,</span>
<a href="#l290.26"></a><span id="l290.26">   accountKey: null,</span>
<a href="#l290.27"></a><span id="l290.27">   managementURL: &quot;&quot;,</span>
<a href="#l290.28"></a><span id="l290.28">   authErr: cloudFileAccounts.constants.authErr,</span>
<a href="#l290.29"></a><span id="l290.29">   offlineErr: cloudFileAccounts.constants.offlineErr,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l291.1"></a><span id="l291.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/PrefTabHelpers.jsm</span>
<a href="#l291.2"></a><span id="l291.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/PrefTabHelpers.jsm</span>
<a href="#l291.3"></a><span id="l291.3" class="difflineat">@@ -22,20 +22,20 @@ var cth = ChromeUtils.import(</span>
<a href="#l291.4"></a><span id="l291.4"> </span>
<a href="#l291.5"></a><span id="l291.5"> /**</span>
<a href="#l291.6"></a><span id="l291.6">  * Open the preferences tab with the given pane displayed. The pane needs to</span>
<a href="#l291.7"></a><span id="l291.7">  * be one of the prefpane ids in mail/components/preferences/aboutPreferences.xul.</span>
<a href="#l291.8"></a><span id="l291.8">  *</span>
<a href="#l291.9"></a><span id="l291.9">  * @param aPaneID The ID of the pref pane to display (see</span>
<a href="#l291.10"></a><span id="l291.10">  *     mail/components/preferences/aboutPreferences.xul for valid IDs.)</span>
<a href="#l291.11"></a><span id="l291.11">  */</span>
<a href="#l291.12"></a><span id="l291.12" class="difflineminus">-function open_pref_tab(aPaneID) {</span>
<a href="#l291.13"></a><span id="l291.13" class="difflineplus">+function open_pref_tab(aPaneID, aScrollTo) {</span>
<a href="#l291.14"></a><span id="l291.14">   let tab = cth.open_content_tab_with_click(</span>
<a href="#l291.15"></a><span id="l291.15">     function() {</span>
<a href="#l291.16"></a><span id="l291.16" class="difflineminus">-      fdh.mc.window.openOptionsDialog(aPaneID);</span>
<a href="#l291.17"></a><span id="l291.17" class="difflineplus">+      fdh.mc.window.openOptionsDialog(aPaneID, aScrollTo);</span>
<a href="#l291.18"></a><span id="l291.18">     },</span>
<a href="#l291.19"></a><span id="l291.19">     &quot;about:preferences&quot;,</span>
<a href="#l291.20"></a><span id="l291.20">     fdh.mc,</span>
<a href="#l291.21"></a><span id="l291.21">     &quot;preferencesTab&quot;</span>
<a href="#l291.22"></a><span id="l291.22">   );</span>
<a href="#l291.23"></a><span id="l291.23">   utils.waitFor(</span>
<a href="#l291.24"></a><span id="l291.24">     () =&gt; tab.browser.contentWindow.getCurrentPaneID() == aPaneID,</span>
<a href="#l291.25"></a><span id="l291.25">     &quot;Timed out waiting for prefpane &quot; + aPaneID + &quot; to load.&quot;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l292.1"></a><span id="l292.1" class="difflineminus">--- a/mozharness/unittests/thunderbird_extra.py</span>
<a href="#l292.2"></a><span id="l292.2" class="difflineplus">+++ b/mozharness/unittests/thunderbird_extra.py</span>
<a href="#l292.3"></a><span id="l292.3" class="difflineat">@@ -23,11 +23,11 @@ config = {</span>
<a href="#l292.4"></a><span id="l292.4">         },</span>
<a href="#l292.5"></a><span id="l292.5">     },</span>
<a href="#l292.6"></a><span id="l292.6">     &quot;all_mozmill_suites&quot;: {</span>
<a href="#l292.7"></a><span id="l292.7">         &quot;mozmill&quot;: [&quot;--list=tests/mozmill/mozmilltests.list&quot;],</span>
<a href="#l292.8"></a><span id="l292.8">     },</span>
<a href="#l292.9"></a><span id="l292.9">     &quot;all_mochitest_suites&quot;: {</span>
<a href="#l292.10"></a><span id="l292.10">         &quot;browser-chrome-thunderbird&quot;: [&quot;--flavor=browser&quot;,</span>
<a href="#l292.11"></a><span id="l292.11">                                        &quot;--subsuite=thunderbird&quot;,</span>
<a href="#l292.12"></a><span id="l292.12" class="difflineminus">-                                       &quot;--leak-threshold=10485760&quot;],</span>
<a href="#l292.13"></a><span id="l292.13" class="difflineplus">+                                       &quot;--leak-threshold=125829120&quot;],  # 120MB</span>
<a href="#l292.14"></a><span id="l292.14">     },</span>
<a href="#l292.15"></a><span id="l292.15"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l293.1"></a><span id="l293.1" class="difflineminus">--- a/taskcluster/ci/test/tests.yml</span>
<a href="#l293.2"></a><span id="l293.2" class="difflineplus">+++ b/taskcluster/ci/test/tests.yml</span>
<a href="#l293.3"></a><span id="l293.3" class="difflineat">@@ -95,16 +95,17 @@ mochitest-thunderbird:</span>
<a href="#l293.4"></a><span id="l293.4">     description: &quot;Mochitest browser-chrome-thunderbird run&quot;</span>
<a href="#l293.5"></a><span id="l293.5">     suite:</span>
<a href="#l293.6"></a><span id="l293.6">         category: mochitest</span>
<a href="#l293.7"></a><span id="l293.7">         name: browser-chrome-thunderbird</span>
<a href="#l293.8"></a><span id="l293.8">     treeherder-symbol: M(bct)</span>
<a href="#l293.9"></a><span id="l293.9">     run-on-projects: built-projects</span>
<a href="#l293.10"></a><span id="l293.10">     loopback-video: true</span>
<a href="#l293.11"></a><span id="l293.11">     max-run-time: 3600</span>
<a href="#l293.12"></a><span id="l293.12" class="difflineplus">+    chunks: 10</span>
<a href="#l293.13"></a><span id="l293.13">     e10s: false</span>
<a href="#l293.14"></a><span id="l293.14">     mozharness:</span>
<a href="#l293.15"></a><span id="l293.15">         script: desktop_unittest.py</span>
<a href="#l293.16"></a><span id="l293.16">         mochitest-flavor: browser</span>
<a href="#l293.17"></a><span id="l293.17">         config:</span>
<a href="#l293.18"></a><span id="l293.18">             by-test-platform:</span>
<a href="#l293.19"></a><span id="l293.19">                 windows.*:</span>
<a href="#l293.20"></a><span id="l293.20">                     - unittests/win_unittest.py</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:32Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

