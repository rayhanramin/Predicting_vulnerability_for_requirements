<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 2746:16d5b2734303a052c81f785fd35085419b95587b</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 16d5b2734303a052c81f785fd35085419b95587b" />
<meta property="og:url" content="/comm-central/rev/16d5b2734303a052c81f785fd35085419b95587b" />
<meta property="og:description" content="convert some PR_ASSERTS to NS_ASSERTIONS in libmime, r/sr=standard8, 495447" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 16d5b2734303a052c81f785fd35085419b95587b 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/16d5b2734303a052c81f785fd35085419b95587b">shortlog</a> |
<a href="/comm-central/log/16d5b2734303a052c81f785fd35085419b95587b">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/16d5b2734303a052c81f785fd35085419b95587b">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/16d5b2734303a052c81f785fd35085419b95587b">files</a> |
changeset |
<a href="/comm-central/raw-rev/16d5b2734303a052c81f785fd35085419b95587b">raw</a>  | <a href="/comm-central/archive/16d5b2734303a052c81f785fd35085419b95587b.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
convert some PR_ASSERTS to NS_ASSERTIONS in libmime, r/sr=standard8, 495447
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Mon, 01 Jun 2009 13:35:51 -0700</td></tr>

<tr>
 <td>changeset 2746</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/16d5b2734303a052c81f785fd35085419b95587b">16d5b2734303a052c81f785fd35085419b95587b</a></td>
</tr>



<tr>
<td>parent 2745</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/06120d394da85d577cff6b687f4539b9ea2bb4d8">06120d394da85d577cff6b687f4539b9ea2bb4d8</a>
</td>
</tr>

<tr>
<td>child 2747</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/f293d3b61d5bb3d64d15512a8d0a5b5b52ed190b">f293d3b61d5bb3d64d15512a8d0a5b5b52ed190b</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=16d5b2734303a052c81f785fd35085419b95587b">2225</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Mon, 01 Jun 2009 20:35:39 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@16d5b2734303 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=16d5b2734303a052c81f785fd35085419b95587b">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=16d5b2734303a052c81f785fd35085419b95587b&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=16d5b2734303a052c81f785fd35085419b95587b&newProject=comm-central&newRevision=16d5b2734303a052c81f785fd35085419b95587b&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=16d5b2734303a052c81f785fd35085419b95587b&newProject=comm-central&newRevision=16d5b2734303a052c81f785fd35085419b95587b&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=16d5b2734303a052c81f785fd35085419b95587b&newProject=comm-central&newRevision=16d5b2734303a052c81f785fd35085419b95587b&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>

<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=495447">495447</a></td></tr>




</table></div>

<div class="page_body description">convert some PR_ASSERTS to NS_ASSERTIONS in libmime, r/sr=standard8, 495447</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemsg.cpp">mailnews/mime/src/mimemsg.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemsg.cpp">file</a> |
<a href="/comm-central/annotate/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemsg.cpp">annotate</a> |
<a href="/comm-central/diff/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemsg.cpp">diff</a> |
<a href="/comm-central/comparison/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemsg.cpp">comparison</a> |
<a href="/comm-central/log/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemsg.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemsig.cpp">mailnews/mime/src/mimemsig.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemsig.cpp">file</a> |
<a href="/comm-central/annotate/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemsig.cpp">annotate</a> |
<a href="/comm-central/diff/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemsig.cpp">diff</a> |
<a href="/comm-central/comparison/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemsig.cpp">comparison</a> |
<a href="/comm-central/log/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemsig.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemult.cpp">mailnews/mime/src/mimemult.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemult.cpp">file</a> |
<a href="/comm-central/annotate/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemult.cpp">annotate</a> |
<a href="/comm-central/diff/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemult.cpp">diff</a> |
<a href="/comm-central/comparison/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemult.cpp">comparison</a> |
<a href="/comm-central/log/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/mimemult.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/nsStreamConverter.cpp">mailnews/mime/src/nsStreamConverter.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/nsStreamConverter.cpp">file</a> |
<a href="/comm-central/annotate/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/nsStreamConverter.cpp">annotate</a> |
<a href="/comm-central/diff/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/nsStreamConverter.cpp">diff</a> |
<a href="/comm-central/comparison/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/nsStreamConverter.cpp">comparison</a> |
<a href="/comm-central/log/16d5b2734303a052c81f785fd35085419b95587b/mailnews/mime/src/nsStreamConverter.cpp">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/mime/src/mimemsg.cpp</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/mime/src/mimemsg.cpp</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -145,17 +145,17 @@ static int</span>
<a href="#l1.4"></a><span id="l1.4"> MimeMessage_parse_line (const char *aLine, PRInt32 aLength, MimeObject *obj)</span>
<a href="#l1.5"></a><span id="l1.5"> {</span>
<a href="#l1.6"></a><span id="l1.6">   const char * line = aLine;</span>
<a href="#l1.7"></a><span id="l1.7">   PRInt32 length = aLength;</span>
<a href="#l1.8"></a><span id="l1.8"> </span>
<a href="#l1.9"></a><span id="l1.9">   MimeMessage *msg = (MimeMessage *) obj;</span>
<a href="#l1.10"></a><span id="l1.10">   int status = 0;</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-  PR_ASSERT(line &amp;&amp; *line);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+  NS_ASSERTION(line &amp;&amp; *line, &quot;empty line in mime msg parse_line&quot;);</span>
<a href="#l1.14"></a><span id="l1.14">   if (!line || !*line) return -1;</span>
<a href="#l1.15"></a><span id="l1.15"> </span>
<a href="#l1.16"></a><span id="l1.16">   if (msg-&gt;grabSubject)</span>
<a href="#l1.17"></a><span id="l1.17">   {</span>
<a href="#l1.18"></a><span id="l1.18">     if ( (!PL_strncasecmp(line, &quot;Subject: &quot;, 9)) &amp;&amp; (obj-&gt;parent) )</span>
<a href="#l1.19"></a><span id="l1.19">     {</span>
<a href="#l1.20"></a><span id="l1.20">       if ( (obj-&gt;headers) &amp;&amp; (!obj-&gt;headers-&gt;munged_subject) )</span>
<a href="#l1.21"></a><span id="l1.21">       {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mailnews/mime/src/mimemsig.cpp</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mailnews/mime/src/mimemsig.cpp</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -253,17 +253,17 @@ MimeMultipartSigned_parse_line (const ch</span>
<a href="#l2.4"></a><span id="l2.4">       sig-&gt;state = MimeMultipartSignedSignatureLine;</span>
<a href="#l2.5"></a><span id="l2.5">       break;</span>
<a href="#l2.6"></a><span id="l2.6"> </span>
<a href="#l2.7"></a><span id="l2.7">     case MimeMultipartEpilogue:</span>
<a href="#l2.8"></a><span id="l2.8">       sig-&gt;state = MimeMultipartSignedEpilogue;</span>
<a href="#l2.9"></a><span id="l2.9">       break;</span>
<a href="#l2.10"></a><span id="l2.10"> </span>
<a href="#l2.11"></a><span id="l2.11">     default:  /* bad state */</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">-      PR_ASSERT(0);</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+      NS_ERROR(&quot;bad state in MultipartSigned parse line&quot;);</span>
<a href="#l2.14"></a><span id="l2.14">       return -1;</span>
<a href="#l2.15"></a><span id="l2.15">       break;</span>
<a href="#l2.16"></a><span id="l2.16">     }</span>
<a href="#l2.17"></a><span id="l2.17">   }</span>
<a href="#l2.18"></a><span id="l2.18"> </span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20">   /* Perform multipart/signed-related actions on this line based on the state</span>
<a href="#l2.21"></a><span id="l2.21">    of the parser.</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineat">@@ -273,18 +273,18 @@ MimeMultipartSigned_parse_line (const ch</span>
<a href="#l2.23"></a><span id="l2.23">   case MimeMultipartSignedPreamble:</span>
<a href="#l2.24"></a><span id="l2.24">     /* Do nothing. */</span>
<a href="#l2.25"></a><span id="l2.25">     break;</span>
<a href="#l2.26"></a><span id="l2.26"> </span>
<a href="#l2.27"></a><span id="l2.27">   case MimeMultipartSignedBodyFirstLine:</span>
<a href="#l2.28"></a><span id="l2.28">     /* We have just moved out of the MimeMultipartSignedBodyHeaders</span>
<a href="#l2.29"></a><span id="l2.29">      state, so cache away the headers that apply only to the body part.</span>
<a href="#l2.30"></a><span id="l2.30">      */</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineminus">-    PR_ASSERT(mult-&gt;hdrs);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineminus">-    PR_ASSERT(!sig-&gt;body_hdrs);</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+    NS_ASSERTION(mult-&gt;hdrs, &quot;null multipart hdrs&quot;);</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+    NS_ASSERTION(!sig-&gt;body_hdrs, &quot;signed part shouldn't have already have body_hdrs&quot;);</span>
<a href="#l2.35"></a><span id="l2.35">     sig-&gt;body_hdrs = mult-&gt;hdrs;</span>
<a href="#l2.36"></a><span id="l2.36">     mult-&gt;hdrs = 0;</span>
<a href="#l2.37"></a><span id="l2.37"> </span>
<a href="#l2.38"></a><span id="l2.38">     /* fall through. */</span>
<a href="#l2.39"></a><span id="l2.39"> </span>
<a href="#l2.40"></a><span id="l2.40">   case MimeMultipartSignedBodyFirstHeader:</span>
<a href="#l2.41"></a><span id="l2.41">   case MimeMultipartSignedBodyHeaders:</span>
<a href="#l2.42"></a><span id="l2.42">   case MimeMultipartSignedBodyLine:</span>
<a href="#l2.43"></a><span id="l2.43" class="difflineat">@@ -294,18 +294,19 @@ MimeMultipartSigned_parse_line (const ch</span>
<a href="#l2.44"></a><span id="l2.44">       /* Set error change */</span>
<a href="#l2.45"></a><span id="l2.45">       PR_SetError(0, 0);</span>
<a href="#l2.46"></a><span id="l2.46">       /* Initialize the signature verification library. */</span>
<a href="#l2.47"></a><span id="l2.47">       sig-&gt;crypto_closure = (((MimeMultipartSignedClass *) obj-&gt;clazz)</span>
<a href="#l2.48"></a><span id="l2.48">                  -&gt;crypto_init) (obj);</span>
<a href="#l2.49"></a><span id="l2.49">       if (!sig-&gt;crypto_closure)</span>
<a href="#l2.50"></a><span id="l2.50">       {</span>
<a href="#l2.51"></a><span id="l2.51">         status = PR_GetError();</span>
<a href="#l2.52"></a><span id="l2.52" class="difflineminus">-        PR_ASSERT(status &lt; 0);</span>
<a href="#l2.53"></a><span id="l2.53" class="difflineminus">-        if (status &gt;= 0) status = -1;</span>
<a href="#l2.54"></a><span id="l2.54" class="difflineplus">+        NS_ASSERTION(status &lt; 0, &quot;got non-negative status&quot;);</span>
<a href="#l2.55"></a><span id="l2.55" class="difflineplus">+        if (status &gt;= 0)</span>
<a href="#l2.56"></a><span id="l2.56" class="difflineplus">+          status = -1;</span>
<a href="#l2.57"></a><span id="l2.57">         return status;</span>
<a href="#l2.58"></a><span id="l2.58">       }</span>
<a href="#l2.59"></a><span id="l2.59">     }</span>
<a href="#l2.60"></a><span id="l2.60"> </span>
<a href="#l2.61"></a><span id="l2.61">     if (hash_line_p)</span>
<a href="#l2.62"></a><span id="l2.62">     {</span>
<a href="#l2.63"></a><span id="l2.63">       /* this is the first hashed line if this is the first header</span>
<a href="#l2.64"></a><span id="l2.64">        (that is, if it's the first line in the header state after</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineat">@@ -517,17 +518,18 @@ MimeMultipartSigned_parse_child_line (Mi</span>
<a href="#l2.66"></a><span id="l2.66">   PR_ASSERT(cont-&gt;nchildren == 0);</span>
<a href="#l2.67"></a><span id="l2.67">   if (cont-&gt;nchildren != 0) return -1;</span>
<a href="#l2.68"></a><span id="l2.68"> </span>
<a href="#l2.69"></a><span id="l2.69">   switch (sig-&gt;state)</span>
<a href="#l2.70"></a><span id="l2.70">   {</span>
<a href="#l2.71"></a><span id="l2.71">   case MimeMultipartSignedPreamble:</span>
<a href="#l2.72"></a><span id="l2.72">   case MimeMultipartSignedBodyFirstHeader:</span>
<a href="#l2.73"></a><span id="l2.73">   case MimeMultipartSignedBodyHeaders:</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineminus">-    PR_ASSERT(0);  /* How'd we get here?  Oh well, fall through. */</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+    // How'd we get here?  Oh well, fall through.</span>
<a href="#l2.76"></a><span id="l2.76" class="difflineplus">+    NS_ERROR(&quot;wrong state in parse child line&quot;);</span>
<a href="#l2.77"></a><span id="l2.77"> </span>
<a href="#l2.78"></a><span id="l2.78">   case MimeMultipartSignedBodyFirstLine:</span>
<a href="#l2.79"></a><span id="l2.79">     PR_ASSERT(first_line_p);</span>
<a href="#l2.80"></a><span id="l2.80">     if (!sig-&gt;part_buffer)</span>
<a href="#l2.81"></a><span id="l2.81">     {</span>
<a href="#l2.82"></a><span id="l2.82">       sig-&gt;part_buffer = MimePartBufferCreate();</span>
<a href="#l2.83"></a><span id="l2.83">       if (!sig-&gt;part_buffer)</span>
<a href="#l2.84"></a><span id="l2.84">       return MIME_OUT_OF_MEMORY;</span>
<a href="#l2.85"></a><span id="l2.85" class="difflineat">@@ -570,34 +572,35 @@ MimeMultipartSigned_parse_child_line (Mi</span>
<a href="#l2.86"></a><span id="l2.86">     /* Now push out the line sans trailing newline. */</span>
<a href="#l2.87"></a><span id="l2.87">     if (length &gt; 0)</span>
<a href="#l2.88"></a><span id="l2.88">       status = MimePartBufferWrite (sig-&gt;part_buffer, line, length);</span>
<a href="#l2.89"></a><span id="l2.89">     if (status &lt; 0) return status;</span>
<a href="#l2.90"></a><span id="l2.90">     }</span>
<a href="#l2.91"></a><span id="l2.91">   break;</span>
<a href="#l2.92"></a><span id="l2.92"> </span>
<a href="#l2.93"></a><span id="l2.93">   case MimeMultipartSignedSignatureHeaders:</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-    PR_ASSERT(0);  /* How'd we get here?  Oh well, fall through. */</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+    // How'd we get here?  Oh well, fall through.</span>
<a href="#l2.96"></a><span id="l2.96" class="difflineplus">+    NS_ERROR(&quot;should have already parse sig hdrs&quot;);</span>
<a href="#l2.97"></a><span id="l2.97"> </span>
<a href="#l2.98"></a><span id="l2.98">   case MimeMultipartSignedSignatureFirstLine:</span>
<a href="#l2.99"></a><span id="l2.99">   case MimeMultipartSignedSignatureLine:</span>
<a href="#l2.100"></a><span id="l2.100">     /* Nothing to do here -- hashing of the signature part is handled up</span>
<a href="#l2.101"></a><span id="l2.101">      in MimeMultipartSigned_parse_line().</span>
<a href="#l2.102"></a><span id="l2.102">      */</span>
<a href="#l2.103"></a><span id="l2.103">     break;</span>
<a href="#l2.104"></a><span id="l2.104"> </span>
<a href="#l2.105"></a><span id="l2.105">   case MimeMultipartSignedEpilogue:</span>
<a href="#l2.106"></a><span id="l2.106">     /* Too many kids?  MimeMultipartSigned_create_child() should have</span>
<a href="#l2.107"></a><span id="l2.107">      prevented us from getting here. */</span>
<a href="#l2.108"></a><span id="l2.108" class="difflineminus">-    PR_ASSERT(0);</span>
<a href="#l2.109"></a><span id="l2.109" class="difflineplus">+    NS_ERROR(&quot;too many kids?&quot;);</span>
<a href="#l2.110"></a><span id="l2.110">     return -1;</span>
<a href="#l2.111"></a><span id="l2.111">     break;</span>
<a href="#l2.112"></a><span id="l2.112"> </span>
<a href="#l2.113"></a><span id="l2.113">   default: /* bad state */</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineminus">-    PR_ASSERT(0);</span>
<a href="#l2.115"></a><span id="l2.115" class="difflineplus">+    NS_ERROR(&quot;bad state in multipart signed parse line&quot;);</span>
<a href="#l2.116"></a><span id="l2.116">     return -1;</span>
<a href="#l2.117"></a><span id="l2.117">     break;</span>
<a href="#l2.118"></a><span id="l2.118">   }</span>
<a href="#l2.119"></a><span id="l2.119"> </span>
<a href="#l2.120"></a><span id="l2.120">   return status;</span>
<a href="#l2.121"></a><span id="l2.121"> }</span>
<a href="#l2.122"></a><span id="l2.122"> </span>
<a href="#l2.123"></a><span id="l2.123"> </span>
<a href="#l2.124"></a><span id="l2.124" class="difflineat">@@ -640,17 +643,18 @@ MimeMultipartSigned_emit_child (MimeObje</span>
<a href="#l2.125"></a><span id="l2.125">       obj-&gt;options-&gt;state &amp;&amp;</span>
<a href="#l2.126"></a><span id="l2.126">       obj-&gt;options-&gt;generate_post_header_html_fn &amp;&amp;</span>
<a href="#l2.127"></a><span id="l2.127">       !obj-&gt;options-&gt;state-&gt;post_header_html_run_p)</span>
<a href="#l2.128"></a><span id="l2.128">     {</span>
<a href="#l2.129"></a><span id="l2.129">       MimeHeaders *outer_headers=nsnull;</span>
<a href="#l2.130"></a><span id="l2.130">       MimeObject *p;</span>
<a href="#l2.131"></a><span id="l2.131">       for (p = obj; p-&gt;parent; p = p-&gt;parent)</span>
<a href="#l2.132"></a><span id="l2.132">       outer_headers = p-&gt;headers;</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineminus">-      PR_ASSERT(obj-&gt;options-&gt;state-&gt;first_data_written_p);</span>
<a href="#l2.134"></a><span id="l2.134" class="difflineplus">+      NS_ASSERTION(obj-&gt;options-&gt;state-&gt;first_data_written_p,</span>
<a href="#l2.135"></a><span id="l2.135" class="difflineplus">+                   &quot;should have already written some data&quot;);</span>
<a href="#l2.136"></a><span id="l2.136">       html = obj-&gt;options-&gt;generate_post_header_html_fn(NULL,</span>
<a href="#l2.137"></a><span id="l2.137">                           obj-&gt;options-&gt;html_closure,</span>
<a href="#l2.138"></a><span id="l2.138">                               outer_headers);</span>
<a href="#l2.139"></a><span id="l2.139">       obj-&gt;options-&gt;state-&gt;post_header_html_run_p = PR_TRUE;</span>
<a href="#l2.140"></a><span id="l2.140">       if (html)</span>
<a href="#l2.141"></a><span id="l2.141">       {</span>
<a href="#l2.142"></a><span id="l2.142">         status = MimeObject_write(obj, html, strlen(html), PR_FALSE);</span>
<a href="#l2.143"></a><span id="l2.143">         PR_Free(html);</span>
<a href="#l2.144"></a><span id="l2.144" class="difflineat">@@ -664,17 +668,17 @@ MimeMultipartSigned_emit_child (MimeObje</span>
<a href="#l2.145"></a><span id="l2.145">    and using the one our superclass defines.  Perhaps instead we should add</span>
<a href="#l2.146"></a><span id="l2.146">    a new method on this class, and initialize that method to be the</span>
<a href="#l2.147"></a><span id="l2.147">    create_child method of the superclass.  Whatever.</span>
<a href="#l2.148"></a><span id="l2.148">    */</span>
<a href="#l2.149"></a><span id="l2.149"> </span>
<a href="#l2.150"></a><span id="l2.150"> </span>
<a href="#l2.151"></a><span id="l2.151">   /* The superclass method expects to find the headers for the part that it's</span>
<a href="#l2.152"></a><span id="l2.152">    to create in mult-&gt;hdrs, so ensure that they're there. */</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineminus">-  PR_ASSERT(!mult-&gt;hdrs);</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+  NS_ASSERTION(!mult-&gt;hdrs, &quot;shouldn't already have hdrs for multipart&quot;);</span>
<a href="#l2.155"></a><span id="l2.155">   if (mult-&gt;hdrs) MimeHeaders_free(mult-&gt;hdrs);</span>
<a href="#l2.156"></a><span id="l2.156">   mult-&gt;hdrs = sig-&gt;body_hdrs;</span>
<a href="#l2.157"></a><span id="l2.157">   sig-&gt;body_hdrs = 0;</span>
<a href="#l2.158"></a><span id="l2.158"> </span>
<a href="#l2.159"></a><span id="l2.159">   /* Run the superclass create_child method.</span>
<a href="#l2.160"></a><span id="l2.160">    */</span>
<a href="#l2.161"></a><span id="l2.161">   status = (((MimeMultipartClass *)(&amp;MIME_SUPERCLASS))-&gt;create_child(obj));</span>
<a href="#l2.162"></a><span id="l2.162">   if (status &lt; 0) return status;</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineat">@@ -733,21 +737,23 @@ MimeMultipartSigned_emit_child (MimeObje</span>
<a href="#l2.164"></a><span id="l2.164">                                 &quot;x-jsemitter-part-path&quot;,</span>
<a href="#l2.165"></a><span id="l2.165">                                 part_path);</span>
<a href="#l2.166"></a><span id="l2.166">       PR_Free(part_path);</span>
<a href="#l2.167"></a><span id="l2.167">     }</span>
<a href="#l2.168"></a><span id="l2.168">   }</span>
<a href="#l2.169"></a><span id="l2.169"> </span>
<a href="#l2.170"></a><span id="l2.170">   /* Retrieve the child that it created.</span>
<a href="#l2.171"></a><span id="l2.171">    */</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-  PR_ASSERT(cont-&gt;nchildren == 1);</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineminus">-  if (cont-&gt;nchildren != 1) return -1;</span>
<a href="#l2.174"></a><span id="l2.174" class="difflineplus">+  NS_ASSERTION(cont-&gt;nchildren == 1, &quot;should only have one child&quot;);</span>
<a href="#l2.175"></a><span id="l2.175" class="difflineplus">+  if (cont-&gt;nchildren != 1)</span>
<a href="#l2.176"></a><span id="l2.176" class="difflineplus">+    return -1;</span>
<a href="#l2.177"></a><span id="l2.177">   body = cont-&gt;children[0];</span>
<a href="#l2.178"></a><span id="l2.178" class="difflineminus">-  PR_ASSERT(body);</span>
<a href="#l2.179"></a><span id="l2.179" class="difflineminus">-  if (!body) return -1;</span>
<a href="#l2.180"></a><span id="l2.180" class="difflineplus">+  NS_ASSERTION(body, &quot;missing body&quot;);</span>
<a href="#l2.181"></a><span id="l2.181" class="difflineplus">+  if (!body)</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineplus">+    return -1;</span>
<a href="#l2.183"></a><span id="l2.183"> </span>
<a href="#l2.184"></a><span id="l2.184"> #ifdef MIME_DRAFTS</span>
<a href="#l2.185"></a><span id="l2.185">   if (body-&gt;options-&gt;decompose_file_p) {</span>
<a href="#l2.186"></a><span id="l2.186">     body-&gt;options-&gt;signed_p = PR_TRUE;</span>
<a href="#l2.187"></a><span id="l2.187">     if (!mime_typep(body, (MimeObjectClass*)&amp;mimeMultipartClass) &amp;&amp;</span>
<a href="#l2.188"></a><span id="l2.188">     body-&gt;options-&gt;decompose_file_init_fn)</span>
<a href="#l2.189"></a><span id="l2.189">     body-&gt;options-&gt;decompose_file_init_fn ( body-&gt;options-&gt;stream_closure, body-&gt;headers );</span>
<a href="#l2.190"></a><span id="l2.190">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/mime/src/mimemult.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/mime/src/mimemult.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -147,20 +147,20 @@ int MimeWriteAString(MimeObject *obj, co</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> static int</span>
<a href="#l3.6"></a><span id="l3.6"> MimeMultipart_parse_line (const char *line, PRInt32 length, MimeObject *obj)</span>
<a href="#l3.7"></a><span id="l3.7"> {</span>
<a href="#l3.8"></a><span id="l3.8">   MimeMultipart *mult = (MimeMultipart *) obj;</span>
<a href="#l3.9"></a><span id="l3.9">   int status = 0;</span>
<a href="#l3.10"></a><span id="l3.10">   MimeMultipartBoundaryType boundary;</span>
<a href="#l3.11"></a><span id="l3.11"> </span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  PR_ASSERT(line &amp;&amp; *line);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  NS_ASSERTION(line &amp;&amp; *line, &quot;empty line in multipart parse_line&quot;);</span>
<a href="#l3.14"></a><span id="l3.14">   if (!line || !*line) return -1;</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-  PR_ASSERT(!obj-&gt;closed_p);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+  NS_ASSERTION(!obj-&gt;closed_p, &quot;obj shouldn't already be closed&quot;);</span>
<a href="#l3.18"></a><span id="l3.18">   if (obj-&gt;closed_p) return -1;</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20">   /* If we're supposed to write this object, but aren't supposed to convert</span>
<a href="#l3.21"></a><span id="l3.21">      it to HTML, simply pass it through unaltered. */</span>
<a href="#l3.22"></a><span id="l3.22">   if (obj-&gt;output_p &amp;&amp;</span>
<a href="#l3.23"></a><span id="l3.23">     obj-&gt;options &amp;&amp;</span>
<a href="#l3.24"></a><span id="l3.24">     !obj-&gt;options-&gt;write_html_p &amp;&amp;</span>
<a href="#l3.25"></a><span id="l3.25">     obj-&gt;options-&gt;output_fn</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineat">@@ -187,17 +187,17 @@ MimeMultipart_parse_line (const char *li</span>
<a href="#l3.27"></a><span id="l3.27">     </span>
<a href="#l3.28"></a><span id="l3.28">     if (boundary == MimeMultipartBoundaryTypeTerminator)</span>
<a href="#l3.29"></a><span id="l3.29">       mult-&gt;state = MimeMultipartEpilogue;</span>
<a href="#l3.30"></a><span id="l3.30">     else</span>
<a href="#l3.31"></a><span id="l3.31">     {</span>
<a href="#l3.32"></a><span id="l3.32">       mult-&gt;state = MimeMultipartHeaders;</span>
<a href="#l3.33"></a><span id="l3.33">       </span>
<a href="#l3.34"></a><span id="l3.34">       /* Reset the header parser for this upcoming part. */</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineminus">-      PR_ASSERT(!mult-&gt;hdrs);</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+      NS_ASSERTION(!mult-&gt;hdrs, &quot;mult-&gt;hdrs should be null here&quot;);</span>
<a href="#l3.37"></a><span id="l3.37">       if (mult-&gt;hdrs)</span>
<a href="#l3.38"></a><span id="l3.38">         MimeHeaders_free(mult-&gt;hdrs);</span>
<a href="#l3.39"></a><span id="l3.39">       mult-&gt;hdrs = MimeHeaders_new();</span>
<a href="#l3.40"></a><span id="l3.40">       if (!mult-&gt;hdrs)</span>
<a href="#l3.41"></a><span id="l3.41">         return MIME_OUT_OF_MEMORY;</span>
<a href="#l3.42"></a><span id="l3.42">       if (obj-&gt;options-&gt;state-&gt;partsToStrip.Length() &gt; 0)</span>
<a href="#l3.43"></a><span id="l3.43">       {</span>
<a href="#l3.44"></a><span id="l3.44">         nsCAutoString newPart(mime_part_address(obj));</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineat">@@ -302,17 +302,18 @@ MimeMultipart_parse_line (const char *li</span>
<a href="#l3.46"></a><span id="l3.46">                                  &amp;now);</span>
<a href="#l3.47"></a><span id="l3.47">           MimeWriteAString(obj, nsDependentCString(timeBuffer));</span>
<a href="#l3.48"></a><span id="l3.48">           MimeWriteAString(obj, NS_LITERAL_CSTRING(&quot;\&quot;&quot;MSG_LINEBREAK));</span>
<a href="#l3.49"></a><span id="l3.49">           MimeWriteAString(obj, NS_LITERAL_CSTRING(MSG_LINEBREAK&quot;The original MIME headers for this attachment are:&quot;MSG_LINEBREAK));</span>
<a href="#l3.50"></a><span id="l3.50">           MimeHeaders_write_raw_headers(mult-&gt;hdrs, obj-&gt;options, PR_FALSE);</span>
<a href="#l3.51"></a><span id="l3.51">         }</span>
<a href="#l3.52"></a><span id="l3.52">         status = ((MimeMultipartClass *) obj-&gt;clazz)-&gt;create_child(obj);</span>
<a href="#l3.53"></a><span id="l3.53">         if (status &lt; 0) return status;</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineminus">-        PR_ASSERT(mult-&gt;state != MimeMultipartHeaders);</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+        NS_ASSERTION(mult-&gt;state != MimeMultipartHeaders,</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+                     &quot;mult-&gt;state shouldn't be MimeMultipartHeaders&quot;);</span>
<a href="#l3.57"></a><span id="l3.57"> </span>
<a href="#l3.58"></a><span id="l3.58">         // Ok, at this point, we need to examine the headers and see if there</span>
<a href="#l3.59"></a><span id="l3.59">         // is a special charset (i.e. non US-ASCII) for this message. If so, </span>
<a href="#l3.60"></a><span id="l3.60">         // we need to tell the emitter that this is the case for use in in any</span>
<a href="#l3.61"></a><span id="l3.61">         // possible reply or forward operation.</span>
<a href="#l3.62"></a><span id="l3.62">         //</span>
<a href="#l3.63"></a><span id="l3.63">         PRBool isBody = PR_FALSE;</span>
<a href="#l3.64"></a><span id="l3.64">         PRBool isAlternative = PR_FALSE;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineat">@@ -424,17 +425,17 @@ MimeMultipart_parse_line (const char *li</span>
<a href="#l3.66"></a><span id="l3.66">       if (status &lt; 0) return status;</span>
<a href="#l3.67"></a><span id="l3.67">       break;</span>
<a href="#l3.68"></a><span id="l3.68"> </span>
<a href="#l3.69"></a><span id="l3.69">     case MimeMultipartSkipPartLine:</span>
<a href="#l3.70"></a><span id="l3.70">       /* we are skipping that part, therefore just ignore the line */</span>
<a href="#l3.71"></a><span id="l3.71">       break;</span>
<a href="#l3.72"></a><span id="l3.72"> </span>
<a href="#l3.73"></a><span id="l3.73">     default:</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-      PR_ASSERT(0);</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+      NS_ERROR(&quot;unexpected state in parse line&quot;);</span>
<a href="#l3.76"></a><span id="l3.76">       return -1;</span>
<a href="#l3.77"></a><span id="l3.77">   }</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79">   if (obj-&gt;options-&gt;format_out == nsMimeOutput::nsMimeMessageAttach &amp;&amp; </span>
<a href="#l3.80"></a><span id="l3.80">       (!obj-&gt;options-&gt;state-&gt;strippingPart &amp;&amp; mult-&gt;state != MimeMultipartPartLine))</span>
<a href="#l3.81"></a><span id="l3.81">       return MimeObject_write(obj, line, length, PR_FALSE);</span>
<a href="#l3.82"></a><span id="l3.82">   return 0;</span>
<a href="#l3.83"></a><span id="l3.83"> }</span>
<a href="#l3.84"></a><span id="l3.84" class="difflineat">@@ -755,17 +756,17 @@ MimeMultipart_parse_eof (MimeObject *obj</span>
<a href="#l3.85"></a><span id="l3.85"> </span>
<a href="#l3.86"></a><span id="l3.86">   /* Now call parse_eof for our active child, if there is one.</span>
<a href="#l3.87"></a><span id="l3.87">    */</span>
<a href="#l3.88"></a><span id="l3.88">   if (cont-&gt;nchildren &gt; 0 &amp;&amp;</span>
<a href="#l3.89"></a><span id="l3.89">     (mult-&gt;state == MimeMultipartPartLine ||</span>
<a href="#l3.90"></a><span id="l3.90">      mult-&gt;state == MimeMultipartPartFirstLine))</span>
<a href="#l3.91"></a><span id="l3.91">   {</span>
<a href="#l3.92"></a><span id="l3.92">     MimeObject *kid = cont-&gt;children[cont-&gt;nchildren-1];</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineminus">-    PR_ASSERT(kid);</span>
<a href="#l3.94"></a><span id="l3.94" class="difflineplus">+    NS_ASSERTION(kid, &quot;not expecting null kid&quot;);</span>
<a href="#l3.95"></a><span id="l3.95">     if (kid)</span>
<a href="#l3.96"></a><span id="l3.96">     {</span>
<a href="#l3.97"></a><span id="l3.97">       int status = kid-&gt;clazz-&gt;parse_eof(kid, abort_p);</span>
<a href="#l3.98"></a><span id="l3.98">       if (status &lt; 0) return status;</span>
<a href="#l3.99"></a><span id="l3.99">     }</span>
<a href="#l3.100"></a><span id="l3.100">   }</span>
<a href="#l3.101"></a><span id="l3.101"> </span>
<a href="#l3.102"></a><span id="l3.102">   return ((MimeObjectClass*)&amp;MIME_SUPERCLASS)-&gt;parse_eof(obj, abort_p);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/mime/src/nsStreamConverter.cpp</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/mime/src/nsStreamConverter.cpp</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -254,21 +254,21 @@ bridge_new_new_uri(void *bridgeStream, n</span>
<a href="#l4.4"></a><span id="l4.4"> }</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6"> static int</span>
<a href="#l4.7"></a><span id="l4.7"> mime_headers_callback ( void *closure, MimeHeaders *headers )</span>
<a href="#l4.8"></a><span id="l4.8"> {</span>
<a href="#l4.9"></a><span id="l4.9">   // We get away with this because this doesn't get called on draft operations.</span>
<a href="#l4.10"></a><span id="l4.10">   struct mime_stream_data *msd = (struct mime_stream_data *)closure;</span>
<a href="#l4.11"></a><span id="l4.11"> </span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  PR_ASSERT ( msd &amp;&amp; headers );</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  NS_ASSERTION(msd &amp;&amp; headers, &quot;null mime stream data or headers&quot;);</span>
<a href="#l4.14"></a><span id="l4.14">   if ( !msd || ! headers )</span>
<a href="#l4.15"></a><span id="l4.15">     return 0;</span>
<a href="#l4.16"></a><span id="l4.16"> </span>
<a href="#l4.17"></a><span id="l4.17" class="difflineminus">-  PR_ASSERT ( msd-&gt;headers == NULL );</span>
<a href="#l4.18"></a><span id="l4.18" class="difflineplus">+  NS_ASSERTION(!msd-&gt;headers, &quot;non-null mime stream data headers&quot;);</span>
<a href="#l4.19"></a><span id="l4.19">   msd-&gt;headers = MimeHeaders_copy ( headers );</span>
<a href="#l4.20"></a><span id="l4.20">   return 0;</span>
<a href="#l4.21"></a><span id="l4.21"> }</span>
<a href="#l4.22"></a><span id="l4.22"> </span>
<a href="#l4.23"></a><span id="l4.23"> nsresult</span>
<a href="#l4.24"></a><span id="l4.24"> bridge_set_mime_stream_converter_listener(void *bridgeStream, nsIMimeStreamConverterListener* listener,</span>
<a href="#l4.25"></a><span id="l4.25">                                           nsMimeOutputType aOutputType)</span>
<a href="#l4.26"></a><span id="l4.26"> {</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

