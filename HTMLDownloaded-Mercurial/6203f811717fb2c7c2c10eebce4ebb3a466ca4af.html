<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 18382:6203f811717fb2c7c2c10eebce4ebb3a466ca4af</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 6203f811717fb2c7c2c10eebce4ebb3a466ca4af" />
<meta property="og:url" content="/comm-central/rev/6203f811717fb2c7c2c10eebce4ebb3a466ca4af" />
<meta property="og:description" content="Bug 764987 - &quot;Allow extensions to add exposed protocols in nsMsgContentPolicy&quot;. r=rkent" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 6203f811717fb2c7c2c10eebce4ebb3a466ca4af 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/6203f811717fb2c7c2c10eebce4ebb3a466ca4af">shortlog</a> |
<a href="/comm-central/log/6203f811717fb2c7c2c10eebce4ebb3a466ca4af">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/6203f811717fb2c7c2c10eebce4ebb3a466ca4af">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/6203f811717fb2c7c2c10eebce4ebb3a466ca4af">files</a> |
changeset |
<a href="/comm-central/raw-rev/6203f811717fb2c7c2c10eebce4ebb3a466ca4af">raw</a>  | <a href="/comm-central/archive/6203f811717fb2c7c2c10eebce4ebb3a466ca4af.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=764987">Bug 764987</a> - &quot;Allow extensions to add exposed protocols in nsMsgContentPolicy&quot;. r=rkent
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#75;&#101;&#110;&#116;&#32;&#74;&#97;&#109;&#101;&#115;&#32;&#60;&#114;&#107;&#101;&#110;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Wed, 16 Sep 2015 14:08:00 +0200</td></tr>

<tr>
 <td>changeset 18382</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/6203f811717fb2c7c2c10eebce4ebb3a466ca4af">6203f811717fb2c7c2c10eebce4ebb3a466ca4af</a></td>
</tr>



<tr>
<td>parent 18381</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/d8297b57fec96d7735db58823e77ed38e9bc4993">d8297b57fec96d7735db58823e77ed38e9bc4993</a>
</td>
</tr>

<tr>
<td>child 18383</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/e9fe39e33a27ca7274180dd570c74b79162d35b2">e9fe39e33a27ca7274180dd570c74b79162d35b2</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=6203f811717fb2c7c2c10eebce4ebb3a466ca4af">11266</a></td></tr>
<tr><td>push user</td><td>aleth@instantbird.org</td></tr>
<tr><td>push date</td><td class="date age">Thu, 17 Sep 2015 17:33:20 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@e9fe39e33a27 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e9fe39e33a27ca7274180dd570c74b79162d35b2">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=e9fe39e33a27ca7274180dd570c74b79162d35b2&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e9fe39e33a27ca7274180dd570c74b79162d35b2&newProject=comm-central&newRevision=a922edf851e5c69dc39639956fa1f74820a2e199&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e9fe39e33a27ca7274180dd570c74b79162d35b2&newProject=comm-central&newRevision=a922edf851e5c69dc39639956fa1f74820a2e199&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=e9fe39e33a27ca7274180dd570c74b79162d35b2&newProject=comm-central&newRevision=a922edf851e5c69dc39639956fa1f74820a2e199&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28rkent%29&revcount=50">rkent</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=764987">764987</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=764987">Bug 764987</a> - &quot;Allow extensions to add exposed protocols in nsMsgContentPolicy&quot;. r=rkent</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/public/moz.build">mailnews/base/public/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/public/moz.build">file</a> |
<a href="/comm-central/annotate/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/public/moz.build">annotate</a> |
<a href="/comm-central/diff/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/public/moz.build">diff</a> |
<a href="/comm-central/comparison/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/public/moz.build">comparison</a> |
<a href="/comm-central/log/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/public/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/public/nsIMsgContentPolicy.idl">mailnews/base/public/nsIMsgContentPolicy.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/public/nsIMsgContentPolicy.idl">file</a> |
<a href="/comm-central/annotate/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/public/nsIMsgContentPolicy.idl">annotate</a> |
<a href="/comm-central/diff/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/public/nsIMsgContentPolicy.idl">diff</a> |
<a href="/comm-central/comparison/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/public/nsIMsgContentPolicy.idl">comparison</a> |
<a href="/comm-central/log/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/public/nsIMsgContentPolicy.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/src/nsMsgContentPolicy.cpp">mailnews/base/src/nsMsgContentPolicy.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/src/nsMsgContentPolicy.cpp">file</a> |
<a href="/comm-central/annotate/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/src/nsMsgContentPolicy.cpp">annotate</a> |
<a href="/comm-central/diff/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/src/nsMsgContentPolicy.cpp">diff</a> |
<a href="/comm-central/comparison/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/src/nsMsgContentPolicy.cpp">comparison</a> |
<a href="/comm-central/log/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/src/nsMsgContentPolicy.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/src/nsMsgContentPolicy.h">mailnews/base/src/nsMsgContentPolicy.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/src/nsMsgContentPolicy.h">file</a> |
<a href="/comm-central/annotate/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/src/nsMsgContentPolicy.h">annotate</a> |
<a href="/comm-central/diff/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/src/nsMsgContentPolicy.h">diff</a> |
<a href="/comm-central/comparison/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/src/nsMsgContentPolicy.h">comparison</a> |
<a href="/comm-central/log/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/src/nsMsgContentPolicy.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/test/unit/test_nsIMsgContentPolicy.js">mailnews/base/test/unit/test_nsIMsgContentPolicy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/test/unit/test_nsIMsgContentPolicy.js">file</a> |
<a href="/comm-central/annotate/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/test/unit/test_nsIMsgContentPolicy.js">annotate</a> |
<a href="/comm-central/diff/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/test/unit/test_nsIMsgContentPolicy.js">diff</a> |
<a href="/comm-central/comparison/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/test/unit/test_nsIMsgContentPolicy.js">comparison</a> |
<a href="/comm-central/log/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/test/unit/test_nsIMsgContentPolicy.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/test/unit/xpcshell.ini">mailnews/base/test/unit/xpcshell.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/test/unit/xpcshell.ini">file</a> |
<a href="/comm-central/annotate/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/test/unit/xpcshell.ini">annotate</a> |
<a href="/comm-central/diff/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/test/unit/xpcshell.ini">diff</a> |
<a href="/comm-central/comparison/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/test/unit/xpcshell.ini">comparison</a> |
<a href="/comm-central/log/6203f811717fb2c7c2c10eebce4ebb3a466ca4af/mailnews/base/test/unit/xpcshell.ini">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mailnews/base/public/moz.build</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mailnews/base/public/moz.build</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -17,16 +17,17 @@ XPIDL_SOURCES += [</span>
<a href="#l1.4"></a><span id="l1.4">     'nsIMessenger.idl',</span>
<a href="#l1.5"></a><span id="l1.5">     'nsIMessengerMigrator.idl',</span>
<a href="#l1.6"></a><span id="l1.6">     'nsIMessengerOSIntegration.idl',</span>
<a href="#l1.7"></a><span id="l1.7">     'nsIMessengerWindowService.idl',</span>
<a href="#l1.8"></a><span id="l1.8">     'nsIMsgAccount.idl',</span>
<a href="#l1.9"></a><span id="l1.9">     'nsIMsgAccountManager.idl',</span>
<a href="#l1.10"></a><span id="l1.10">     'nsIMsgAsyncPrompter.idl',</span>
<a href="#l1.11"></a><span id="l1.11">     'nsIMsgBiffManager.idl',</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineplus">+    'nsIMsgContentPolicy.idl',</span>
<a href="#l1.13"></a><span id="l1.13">     'nsIMsgCopyService.idl',</span>
<a href="#l1.14"></a><span id="l1.14">     'nsIMsgCopyServiceListener.idl',</span>
<a href="#l1.15"></a><span id="l1.15">     'nsIMsgCustomColumnHandler.idl',</span>
<a href="#l1.16"></a><span id="l1.16">     'nsIMsgDBView.idl',</span>
<a href="#l1.17"></a><span id="l1.17">     'nsIMsgFolder.idl',</span>
<a href="#l1.18"></a><span id="l1.18">     'nsIMsgFolderCache.idl',</span>
<a href="#l1.19"></a><span id="l1.19">     'nsIMsgFolderCacheElement.idl',</span>
<a href="#l1.20"></a><span id="l1.20">     'nsIMsgFolderCompactor.idl',</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">new file mode 100644</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineminus">--- /dev/null</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineplus">+++ b/mailnews/base/public/nsIMsgContentPolicy.idl</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineat">@@ -0,0 +1,36 @@</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineplus">+/* -*- mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l2.6"></a><span id="l2.6" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.7"></a><span id="l2.7" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l2.8"></a><span id="l2.8" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.9"></a><span id="l2.9" class="difflineplus">+</span>
<a href="#l2.10"></a><span id="l2.10" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineplus">+</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+[scriptable, uuid(c29b2fd3-64d0-4083-a096-c20a9b847a99)]</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineplus">+</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineplus">+/**</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+ * This interface provide functions which help extension developers</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ * add their customized schema to the exposed protocls of nsMsgContentPolicy.</span>
<a href="#l2.17"></a><span id="l2.17" class="difflineplus">+ * By default, a list of existing protocols (such as imap and nntp)</span>
<a href="#l2.18"></a><span id="l2.18" class="difflineplus">+ * are allowed to process urls locally, while non-matching urls are required</span>
<a href="#l2.19"></a><span id="l2.19" class="difflineplus">+ * to be processed as external.</span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+ * This interface allows additional protocols to be added to</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+ * the list of protocols that are processed locally.</span>
<a href="#l2.22"></a><span id="l2.22" class="difflineplus">+ * Typically this would be used in cases where a new messaging protocol</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineplus">+ * is being added by an extension.</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineplus">+ */</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+interface nsIMsgContentPolicy : nsISupports {</span>
<a href="#l2.26"></a><span id="l2.26" class="difflineplus">+  /**</span>
<a href="#l2.27"></a><span id="l2.27" class="difflineplus">+   * Add the specific aScheme to nsMsgContentPolicy's exposed protocols.</span>
<a href="#l2.28"></a><span id="l2.28" class="difflineplus">+   *</span>
<a href="#l2.29"></a><span id="l2.29" class="difflineplus">+   * @param aScheme scheme who will be added to nsMsgContentPolicy's exposed protocols</span>
<a href="#l2.30"></a><span id="l2.30" class="difflineplus">+   */</span>
<a href="#l2.31"></a><span id="l2.31" class="difflineplus">+  void addExposedProtocol(in ACString aScheme);</span>
<a href="#l2.32"></a><span id="l2.32" class="difflineplus">+</span>
<a href="#l2.33"></a><span id="l2.33" class="difflineplus">+  /**</span>
<a href="#l2.34"></a><span id="l2.34" class="difflineplus">+   * Remove the specific aScheme from nsMsgContentPolicy's exposed protocols.</span>
<a href="#l2.35"></a><span id="l2.35" class="difflineplus">+   *</span>
<a href="#l2.36"></a><span id="l2.36" class="difflineplus">+   * @param aScheme scheme who will be removed from nsMsgContentPolicy's exposed protocols</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineplus">+   */</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineplus">+  void removeExposedProtocol(in ACString aScheme);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineplus">+};</span>
<a href="#l2.40"></a><span id="l2.40" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mailnews/base/src/nsMsgContentPolicy.cpp</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgContentPolicy.cpp</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -28,28 +28,29 @@</span>
<a href="#l3.4"></a><span id="l3.4"> </span>
<a href="#l3.5"></a><span id="l3.5"> static const char kBlockRemoteImages[] = &quot;mailnews.message_display.disable_remote_image&quot;;</span>
<a href="#l3.6"></a><span id="l3.6"> static const char kAllowPlugins[] = &quot;mailnews.message_display.allow_plugins&quot;;</span>
<a href="#l3.7"></a><span id="l3.7"> static const char kTrustedDomains[] =  &quot;mail.trusteddomains&quot;;</span>
<a href="#l3.8"></a><span id="l3.8"> </span>
<a href="#l3.9"></a><span id="l3.9"> using namespace mozilla::mailnews;</span>
<a href="#l3.10"></a><span id="l3.10"> </span>
<a href="#l3.11"></a><span id="l3.11"> // Per message headder flags to keep track of whether the user is allowing remote</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-// content for a particular message. </span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+// content for a particular message.</span>
<a href="#l3.14"></a><span id="l3.14"> // if you change or add more values to these constants, be sure to modify</span>
<a href="#l3.15"></a><span id="l3.15"> // the corresponding definitions in mailWindowOverlay.js</span>
<a href="#l3.16"></a><span id="l3.16"> #define kNoRemoteContentPolicy 0</span>
<a href="#l3.17"></a><span id="l3.17"> #define kBlockRemoteContent 1</span>
<a href="#l3.18"></a><span id="l3.18"> #define kAllowRemoteContent 2</span>
<a href="#l3.19"></a><span id="l3.19"> </span>
<a href="#l3.20"></a><span id="l3.20" class="difflineminus">-NS_IMPL_ISUPPORTS(nsMsgContentPolicy, </span>
<a href="#l3.21"></a><span id="l3.21" class="difflineminus">-                   nsIContentPolicy,</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineminus">-                   nsIWebProgressListener,</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineminus">-                   nsIObserver,</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineminus">-                   nsISupportsWeakReference)</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+NS_IMPL_ISUPPORTS(nsMsgContentPolicy,</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+                  nsIContentPolicy,</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+                  nsIWebProgressListener,</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+                  nsIMsgContentPolicy,</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+                  nsIObserver,</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+                  nsISupportsWeakReference)</span>
<a href="#l3.31"></a><span id="l3.31"> </span>
<a href="#l3.32"></a><span id="l3.32"> nsMsgContentPolicy::nsMsgContentPolicy()</span>
<a href="#l3.33"></a><span id="l3.33"> {</span>
<a href="#l3.34"></a><span id="l3.34">   mAllowPlugins = false;</span>
<a href="#l3.35"></a><span id="l3.35">   mBlockRemoteImages = true;</span>
<a href="#l3.36"></a><span id="l3.36"> }</span>
<a href="#l3.37"></a><span id="l3.37"> </span>
<a href="#l3.38"></a><span id="l3.38"> nsMsgContentPolicy::~nsMsgContentPolicy()</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineat">@@ -82,32 +83,32 @@ nsresult nsMsgContentPolicy::Init()</span>
<a href="#l3.40"></a><span id="l3.40">   // Grab a handle on the PermissionManager service for managing allowed remote</span>
<a href="#l3.41"></a><span id="l3.41">   // content senders.</span>
<a href="#l3.42"></a><span id="l3.42">   mPermissionManager = do_GetService(NS_PERMISSIONMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l3.43"></a><span id="l3.43">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.44"></a><span id="l3.44"> </span>
<a href="#l3.45"></a><span id="l3.45">   return NS_OK;</span>
<a href="#l3.46"></a><span id="l3.46"> }</span>
<a href="#l3.47"></a><span id="l3.47"> </span>
<a href="#l3.48"></a><span id="l3.48" class="difflineminus">-/** </span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+/**</span>
<a href="#l3.50"></a><span id="l3.50">  * @returns true if the sender referenced by aMsgHdr is explicitly allowed to</span>
<a href="#l3.51"></a><span id="l3.51">  *          load remote images according to the PermissionManager</span>
<a href="#l3.52"></a><span id="l3.52">  */</span>
<a href="#l3.53"></a><span id="l3.53"> bool</span>
<a href="#l3.54"></a><span id="l3.54"> nsMsgContentPolicy::ShouldAcceptRemoteContentForSender(nsIMsgDBHdr *aMsgHdr)</span>
<a href="#l3.55"></a><span id="l3.55"> {</span>
<a href="#l3.56"></a><span id="l3.56">   if (!aMsgHdr)</span>
<a href="#l3.57"></a><span id="l3.57">     return false;</span>
<a href="#l3.58"></a><span id="l3.58"> </span>
<a href="#l3.59"></a><span id="l3.59">   // extract the e-mail address from the msg hdr</span>
<a href="#l3.60"></a><span id="l3.60">   nsCString author;</span>
<a href="#l3.61"></a><span id="l3.61">   nsresult rv = aMsgHdr-&gt;GetAuthor(getter_Copies(author));</span>
<a href="#l3.62"></a><span id="l3.62">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l3.63"></a><span id="l3.63"> </span>
<a href="#l3.64"></a><span id="l3.64" class="difflineminus">-  nsCString emailAddress; </span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+  nsCString emailAddress;</span>
<a href="#l3.66"></a><span id="l3.66">   ExtractEmail(EncodedHeader(author), emailAddress);</span>
<a href="#l3.67"></a><span id="l3.67">   if (emailAddress.IsEmpty())</span>
<a href="#l3.68"></a><span id="l3.68">     return false;</span>
<a href="#l3.69"></a><span id="l3.69"> </span>
<a href="#l3.70"></a><span id="l3.70">   nsCOMPtr&lt;nsIIOService&gt; ios = do_GetService(&quot;@mozilla.org/network/io-service;1&quot;, &amp;rv);</span>
<a href="#l3.71"></a><span id="l3.71">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l3.72"></a><span id="l3.72">   nsCOMPtr&lt;nsIURI&gt; mailURI;</span>
<a href="#l3.73"></a><span id="l3.73">   emailAddress.Insert(&quot;mailto:&quot;, 0);</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineat">@@ -129,17 +130,17 @@ nsMsgContentPolicy::ShouldAcceptRemoteCo</span>
<a href="#l3.75"></a><span id="l3.75">  */</span>
<a href="#l3.76"></a><span id="l3.76"> bool nsMsgContentPolicy::IsTrustedDomain(nsIURI * aContentLocation)</span>
<a href="#l3.77"></a><span id="l3.77"> {</span>
<a href="#l3.78"></a><span id="l3.78">   bool trustedDomain = false;</span>
<a href="#l3.79"></a><span id="l3.79">   // get the host name of the server hosting the remote image</span>
<a href="#l3.80"></a><span id="l3.80">   nsAutoCString host;</span>
<a href="#l3.81"></a><span id="l3.81">   nsresult rv = aContentLocation-&gt;GetHost(host);</span>
<a href="#l3.82"></a><span id="l3.82"> </span>
<a href="#l3.83"></a><span id="l3.83" class="difflineminus">-  if (NS_SUCCEEDED(rv) &amp;&amp; !mTrustedMailDomains.IsEmpty()) </span>
<a href="#l3.84"></a><span id="l3.84" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; !mTrustedMailDomains.IsEmpty())</span>
<a href="#l3.85"></a><span id="l3.85">     trustedDomain = MsgHostDomainIsTrusted(host, mTrustedMailDomains);</span>
<a href="#l3.86"></a><span id="l3.86"> </span>
<a href="#l3.87"></a><span id="l3.87">   return trustedDomain;</span>
<a href="#l3.88"></a><span id="l3.88"> }</span>
<a href="#l3.89"></a><span id="l3.89"> </span>
<a href="#l3.90"></a><span id="l3.90"> NS_IMETHODIMP</span>
<a href="#l3.91"></a><span id="l3.91"> nsMsgContentPolicy::ShouldLoad(uint32_t          aContentType,</span>
<a href="#l3.92"></a><span id="l3.92">                                nsIURI           *aContentLocation,</span>
<a href="#l3.93"></a><span id="l3.93" class="difflineat">@@ -188,24 +189,24 @@ nsMsgContentPolicy::ShouldLoad(uint32_t </span>
<a href="#l3.94"></a><span id="l3.94">     return NS_OK;</span>
<a href="#l3.95"></a><span id="l3.95"> #endif</span>
<a href="#l3.96"></a><span id="l3.96"> </span>
<a href="#l3.97"></a><span id="l3.97">   switch(aContentType) {</span>
<a href="#l3.98"></a><span id="l3.98">     // Plugins (nsIContentPolicy::TYPE_OBJECT) are blocked on document load.</span>
<a href="#l3.99"></a><span id="l3.99">   case nsIContentPolicy::TYPE_DOCUMENT:</span>
<a href="#l3.100"></a><span id="l3.100">     // At this point, we have no intention of supporting a different JS</span>
<a href="#l3.101"></a><span id="l3.101">     // setting on a subdocument, so we don't worry about TYPE_SUBDOCUMENT here.</span>
<a href="#l3.102"></a><span id="l3.102" class="difflineminus">-   </span>
<a href="#l3.103"></a><span id="l3.103" class="difflineplus">+</span>
<a href="#l3.104"></a><span id="l3.104">     // If the timing were right, we'd enable JavaScript on the docshell</span>
<a href="#l3.105"></a><span id="l3.105">     // for non mailnews URIs here.  However, at this point, the</span>
<a href="#l3.106"></a><span id="l3.106" class="difflineminus">-    // old document may still be around, so we can't do any enabling just yet.  </span>
<a href="#l3.107"></a><span id="l3.107" class="difflineminus">-    // Instead, we apply the policy in nsIWebProgressListener::OnLocationChange. </span>
<a href="#l3.108"></a><span id="l3.108" class="difflineplus">+    // old document may still be around, so we can't do any enabling just yet.</span>
<a href="#l3.109"></a><span id="l3.109" class="difflineplus">+    // Instead, we apply the policy in nsIWebProgressListener::OnLocationChange.</span>
<a href="#l3.110"></a><span id="l3.110">     // For now, we explicitly disable JavaScript in order to be safe rather than</span>
<a href="#l3.111"></a><span id="l3.111">     // sorry, because OnLocationChange isn't guaranteed to necessarily be called</span>
<a href="#l3.112"></a><span id="l3.112" class="difflineminus">-    // soon enough to disable it in time (though bz says it _should_ be called </span>
<a href="#l3.113"></a><span id="l3.113" class="difflineplus">+    // soon enough to disable it in time (though bz says it _should_ be called</span>
<a href="#l3.114"></a><span id="l3.114">     // soon enough &quot;in all sane cases&quot;).</span>
<a href="#l3.115"></a><span id="l3.115">     rv = SetDisableItemsOnMailNewsUrlDocshells(aContentLocation,</span>
<a href="#l3.116"></a><span id="l3.116">                                                aRequestingContext);</span>
<a href="#l3.117"></a><span id="l3.117">     // if something went wrong during the tweaking, reject this content</span>
<a href="#l3.118"></a><span id="l3.118">     if (NS_FAILED(rv)) {</span>
<a href="#l3.119"></a><span id="l3.119">       NS_WARNING(&quot;Failed to set disable items on docShells&quot;);</span>
<a href="#l3.120"></a><span id="l3.120">       *aDecision = nsIContentPolicy::REJECT_TYPE;</span>
<a href="#l3.121"></a><span id="l3.121">       return NS_OK;</span>
<a href="#l3.122"></a><span id="l3.122" class="difflineat">@@ -216,46 +217,46 @@ nsMsgContentPolicy::ShouldLoad(uint32_t </span>
<a href="#l3.123"></a><span id="l3.123">     // We cannot block CSP reports.</span>
<a href="#l3.124"></a><span id="l3.124">     *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l3.125"></a><span id="l3.125">     return NS_OK;</span>
<a href="#l3.126"></a><span id="l3.126">     break;</span>
<a href="#l3.127"></a><span id="l3.127"> </span>
<a href="#l3.128"></a><span id="l3.128">   default:</span>
<a href="#l3.129"></a><span id="l3.129">     break;</span>
<a href="#l3.130"></a><span id="l3.130">   }</span>
<a href="#l3.131"></a><span id="l3.131" class="difflineminus">-  </span>
<a href="#l3.132"></a><span id="l3.132" class="difflineplus">+</span>
<a href="#l3.133"></a><span id="l3.133">   // NOTE: Not using NS_ENSURE_ARG_POINTER because this is a legitimate case</span>
<a href="#l3.134"></a><span id="l3.134">   // that can happen.  Also keep in mind that the default policy used for a</span>
<a href="#l3.135"></a><span id="l3.135">   // failure code is ACCEPT.</span>
<a href="#l3.136"></a><span id="l3.136">   if (!aRequestingLocation)</span>
<a href="#l3.137"></a><span id="l3.137">     return NS_ERROR_INVALID_POINTER;</span>
<a href="#l3.138"></a><span id="l3.138"> </span>
<a href="#l3.139"></a><span id="l3.139"> #ifdef DEBUG_MsgContentPolicy</span>
<a href="#l3.140"></a><span id="l3.140">   (void)aRequestingLocation-&gt;GetSpec(spec);</span>
<a href="#l3.141"></a><span id="l3.141">   fprintf(stderr, &quot;aRequestingLocation = %s\n&quot;, spec.get());</span>
<a href="#l3.142"></a><span id="l3.142"> #endif</span>
<a href="#l3.143"></a><span id="l3.143"> </span>
<a href="#l3.144"></a><span id="l3.144">   // If the requesting location is safe, accept the content location request.</span>
<a href="#l3.145"></a><span id="l3.145">   if (IsSafeRequestingLocation(aRequestingLocation))</span>
<a href="#l3.146"></a><span id="l3.146">     return rv;</span>
<a href="#l3.147"></a><span id="l3.147"> </span>
<a href="#l3.148"></a><span id="l3.148" class="difflineminus">-  // Now default to reject so early returns via NS_ENSURE_SUCCESS </span>
<a href="#l3.149"></a><span id="l3.149" class="difflineplus">+  // Now default to reject so early returns via NS_ENSURE_SUCCESS</span>
<a href="#l3.150"></a><span id="l3.150">   // cause content to be rejected.</span>
<a href="#l3.151"></a><span id="l3.151">   *aDecision = nsIContentPolicy::REJECT_REQUEST;</span>
<a href="#l3.152"></a><span id="l3.152"> </span>
<a href="#l3.153"></a><span id="l3.153">   // if aContentLocation is a protocol we handle (imap, pop3, mailbox, etc)</span>
<a href="#l3.154"></a><span id="l3.154">   // or is a chrome url, then allow the load</span>
<a href="#l3.155"></a><span id="l3.155"> </span>
<a href="#l3.156"></a><span id="l3.156">   if (IsExposedProtocol(aContentLocation))</span>
<a href="#l3.157"></a><span id="l3.157">   {</span>
<a href="#l3.158"></a><span id="l3.158">     *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l3.159"></a><span id="l3.159">     return NS_OK;</span>
<a href="#l3.160"></a><span id="l3.160">   }</span>
<a href="#l3.161"></a><span id="l3.161"> </span>
<a href="#l3.162"></a><span id="l3.162" class="difflineminus">-  // never load unexposed protocols except for http, https and file. </span>
<a href="#l3.163"></a><span id="l3.163" class="difflineplus">+  // never load unexposed protocols except for http, https and file.</span>
<a href="#l3.164"></a><span id="l3.164">   // Protocols like ftp are always blocked.</span>
<a href="#l3.165"></a><span id="l3.165">   if (ShouldBlockUnexposedProtocol(aContentLocation))</span>
<a href="#l3.166"></a><span id="l3.166">     return NS_OK;</span>
<a href="#l3.167"></a><span id="l3.167"> </span>
<a href="#l3.168"></a><span id="l3.168">   // If we are allowing all remote content...</span>
<a href="#l3.169"></a><span id="l3.169">   if (!mBlockRemoteImages)</span>
<a href="#l3.170"></a><span id="l3.170">   {</span>
<a href="#l3.171"></a><span id="l3.171">     *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l3.172"></a><span id="l3.172" class="difflineat">@@ -385,16 +386,20 @@ nsMsgContentPolicy::IsExposedProtocol(ns</span>
<a href="#l3.173"></a><span id="l3.173">       MsgLowerCaseEqualsLiteral(contentScheme, &quot;nntp&quot;) ||</span>
<a href="#l3.174"></a><span id="l3.174">       MsgLowerCaseEqualsLiteral(contentScheme, &quot;imap&quot;) ||</span>
<a href="#l3.175"></a><span id="l3.175">       MsgLowerCaseEqualsLiteral(contentScheme, &quot;addbook&quot;) ||</span>
<a href="#l3.176"></a><span id="l3.176">       MsgLowerCaseEqualsLiteral(contentScheme, &quot;pop&quot;) ||</span>
<a href="#l3.177"></a><span id="l3.177">       MsgLowerCaseEqualsLiteral(contentScheme, &quot;mailbox&quot;) ||</span>
<a href="#l3.178"></a><span id="l3.178">       MsgLowerCaseEqualsLiteral(contentScheme, &quot;about&quot;))</span>
<a href="#l3.179"></a><span id="l3.179">     return true;</span>
<a href="#l3.180"></a><span id="l3.180"> </span>
<a href="#l3.181"></a><span id="l3.181" class="difflineplus">+  // check if customized exposed scheme</span>
<a href="#l3.182"></a><span id="l3.182" class="difflineplus">+  if (mCustomExposedProtocols.Contains(contentScheme))</span>
<a href="#l3.183"></a><span id="l3.183" class="difflineplus">+    return true;</span>
<a href="#l3.184"></a><span id="l3.184" class="difflineplus">+</span>
<a href="#l3.185"></a><span id="l3.185">   bool isData;</span>
<a href="#l3.186"></a><span id="l3.186">   bool isChrome;</span>
<a href="#l3.187"></a><span id="l3.187">   bool isRes;</span>
<a href="#l3.188"></a><span id="l3.188">   rv = aContentLocation-&gt;SchemeIs(&quot;chrome&quot;, &amp;isChrome);</span>
<a href="#l3.189"></a><span id="l3.189">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l3.190"></a><span id="l3.190">   rv = aContentLocation-&gt;SchemeIs(&quot;resource&quot;, &amp;isRes);</span>
<a href="#l3.191"></a><span id="l3.191">   NS_ENSURE_SUCCESS(rv, false);</span>
<a href="#l3.192"></a><span id="l3.192">   rv = aContentLocation-&gt;SchemeIs(&quot;data&quot;, &amp;isData);</span>
<a href="#l3.193"></a><span id="l3.193" class="difflineat">@@ -463,17 +468,17 @@ nsMsgContentPolicy::ShouldAcceptRemoteCo</span>
<a href="#l3.194"></a><span id="l3.194"> </span>
<a href="#l3.195"></a><span id="l3.195">   int16_t result = allowForSender ?</span>
<a href="#l3.196"></a><span id="l3.196">     static_cast&lt;int16_t&gt;(nsIContentPolicy::ACCEPT) :</span>
<a href="#l3.197"></a><span id="l3.197">     static_cast&lt;int16_t&gt;(nsIContentPolicy::REJECT_REQUEST);</span>
<a href="#l3.198"></a><span id="l3.198"> </span>
<a href="#l3.199"></a><span id="l3.199">   // kNoRemoteContentPolicy means we have never set a value on the message</span>
<a href="#l3.200"></a><span id="l3.200">   if (result == nsIContentPolicy::REJECT_REQUEST &amp;&amp; !remoteContentPolicy)</span>
<a href="#l3.201"></a><span id="l3.201">     aMsgHdr-&gt;SetUint32Property(&quot;remoteContentPolicy&quot;, kBlockRemoteContent);</span>
<a href="#l3.202"></a><span id="l3.202" class="difflineminus">-  </span>
<a href="#l3.203"></a><span id="l3.203" class="difflineplus">+</span>
<a href="#l3.204"></a><span id="l3.204">   return result;</span>
<a href="#l3.205"></a><span id="l3.205"> }</span>
<a href="#l3.206"></a><span id="l3.206"> </span>
<a href="#l3.207"></a><span id="l3.207"> class RemoteContentNotifierEvent : public nsRunnable</span>
<a href="#l3.208"></a><span id="l3.208"> {</span>
<a href="#l3.209"></a><span id="l3.209"> public:</span>
<a href="#l3.210"></a><span id="l3.210">   RemoteContentNotifierEvent(nsIMsgWindow *aMsgWindow, nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l3.211"></a><span id="l3.211">                              nsIURI *aContentURI)</span>
<a href="#l3.212"></a><span id="l3.212" class="difflineat">@@ -493,17 +498,17 @@ public:</span>
<a href="#l3.213"></a><span id="l3.213">   }</span>
<a href="#l3.214"></a><span id="l3.214"> </span>
<a href="#l3.215"></a><span id="l3.215"> private:</span>
<a href="#l3.216"></a><span id="l3.216">   nsCOMPtr&lt;nsIMsgWindow&gt; mMsgWindow;</span>
<a href="#l3.217"></a><span id="l3.217">   nsCOMPtr&lt;nsIMsgDBHdr&gt; mMsgHdr;</span>
<a href="#l3.218"></a><span id="l3.218">   nsCOMPtr&lt;nsIURI&gt; mContentURI;</span>
<a href="#l3.219"></a><span id="l3.219"> };</span>
<a href="#l3.220"></a><span id="l3.220"> </span>
<a href="#l3.221"></a><span id="l3.221" class="difflineminus">-/** </span>
<a href="#l3.222"></a><span id="l3.222" class="difflineplus">+/**</span>
<a href="#l3.223"></a><span id="l3.223">  * This function is used to determine if we allow content for a remote message.</span>
<a href="#l3.224"></a><span id="l3.224">  * If we reject loading remote content, then we'll inform the message window</span>
<a href="#l3.225"></a><span id="l3.225">  * that this message has remote content (and hence we are not loading it).</span>
<a href="#l3.226"></a><span id="l3.226">  *</span>
<a href="#l3.227"></a><span id="l3.227">  * See ShouldAcceptRemoteContentForMsgHdr for the actual decisions that</span>
<a href="#l3.228"></a><span id="l3.228">  * determine if we are going to allow remote content.</span>
<a href="#l3.229"></a><span id="l3.229">  */</span>
<a href="#l3.230"></a><span id="l3.230"> void</span>
<a href="#l3.231"></a><span id="l3.231" class="difflineat">@@ -543,32 +548,32 @@ nsMsgContentPolicy::ShouldAcceptContentF</span>
<a href="#l3.232"></a><span id="l3.232">                                                   aContentLocation);</span>
<a href="#l3.233"></a><span id="l3.233"> </span>
<a href="#l3.234"></a><span id="l3.234">   // If we're not allowing the remote content, tell the nsIMsgWindow loading</span>
<a href="#l3.235"></a><span id="l3.235">   // this url that this is the case, so that the UI knows to show the remote</span>
<a href="#l3.236"></a><span id="l3.236">   // content header bar, so the user can override if they wish.</span>
<a href="#l3.237"></a><span id="l3.237">   if (*aDecision == nsIContentPolicy::REJECT_REQUEST)</span>
<a href="#l3.238"></a><span id="l3.238">   {</span>
<a href="#l3.239"></a><span id="l3.239">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l3.240"></a><span id="l3.240" class="difflineminus">-    (void)mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow)); </span>
<a href="#l3.241"></a><span id="l3.241" class="difflineplus">+    (void)mailnewsUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l3.242"></a><span id="l3.242">     if (msgWindow)</span>
<a href="#l3.243"></a><span id="l3.243">     {</span>
<a href="#l3.244"></a><span id="l3.244">       nsCOMPtr&lt;nsIRunnable&gt; event =</span>
<a href="#l3.245"></a><span id="l3.245">         new RemoteContentNotifierEvent(msgWindow, msgHdr, aContentLocation);</span>
<a href="#l3.246"></a><span id="l3.246">       // Post this as an event because it can cause dom mutations, and we</span>
<a href="#l3.247"></a><span id="l3.247">       // get called at a bad time to be causing dom mutations.</span>
<a href="#l3.248"></a><span id="l3.248">       if (event)</span>
<a href="#l3.249"></a><span id="l3.249">         NS_DispatchToCurrentThread(event);</span>
<a href="#l3.250"></a><span id="l3.250">     }</span>
<a href="#l3.251"></a><span id="l3.251">   }</span>
<a href="#l3.252"></a><span id="l3.252"> }</span>
<a href="#l3.253"></a><span id="l3.253"> </span>
<a href="#l3.254"></a><span id="l3.254" class="difflineminus">-/** </span>
<a href="#l3.255"></a><span id="l3.255" class="difflineplus">+/**</span>
<a href="#l3.256"></a><span id="l3.256">  * Content policy logic for compose windows</span>
<a href="#l3.257"></a><span id="l3.257" class="difflineminus">- * </span>
<a href="#l3.258"></a><span id="l3.258" class="difflineplus">+ *</span>
<a href="#l3.259"></a><span id="l3.259">  */</span>
<a href="#l3.260"></a><span id="l3.260"> void nsMsgContentPolicy::ComposeShouldLoad(nsIMsgCompose *aMsgCompose,</span>
<a href="#l3.261"></a><span id="l3.261">                                            nsISupports *aRequestingContext,</span>
<a href="#l3.262"></a><span id="l3.262">                                            nsIURI *aContentLocation,</span>
<a href="#l3.263"></a><span id="l3.263">                                            int16_t *aDecision)</span>
<a href="#l3.264"></a><span id="l3.264"> {</span>
<a href="#l3.265"></a><span id="l3.265">   NS_PRECONDITION(*aDecision == nsIContentPolicy::REJECT_REQUEST,</span>
<a href="#l3.266"></a><span id="l3.266">                   &quot;ComposeShouldLoad expects default decision to be reject!&quot;);</span>
<a href="#l3.267"></a><span id="l3.267" class="difflineat">@@ -596,29 +601,29 @@ void nsMsgContentPolicy::ComposeShouldLo</span>
<a href="#l3.268"></a><span id="l3.268">     *aDecision = ShouldAcceptRemoteContentForMsgHdr(msgHdr, nullptr,</span>
<a href="#l3.269"></a><span id="l3.269">                                                     aContentLocation);</span>
<a href="#l3.270"></a><span id="l3.270"> </span>
<a href="#l3.271"></a><span id="l3.271">     // Special case image elements. When replying to a message, we want to allow</span>
<a href="#l3.272"></a><span id="l3.272">     // the user to add remote images to the message. But we don't want remote</span>
<a href="#l3.273"></a><span id="l3.273">     // images that are a part of the quoted content to load. Fortunately, after</span>
<a href="#l3.274"></a><span id="l3.274">     // the quoted message has been inserted into the document, mail compose</span>
<a href="#l3.275"></a><span id="l3.275">     // flags remote content elements that came from the original message with a</span>
<a href="#l3.276"></a><span id="l3.276" class="difflineminus">-    // moz-do-not-send attribute. </span>
<a href="#l3.277"></a><span id="l3.277" class="difflineplus">+    // moz-do-not-send attribute.</span>
<a href="#l3.278"></a><span id="l3.278">     if (*aDecision == nsIContentPolicy::REJECT_REQUEST)</span>
<a href="#l3.279"></a><span id="l3.279">     {</span>
<a href="#l3.280"></a><span id="l3.280">       bool insertingQuotedContent = true;</span>
<a href="#l3.281"></a><span id="l3.281">       aMsgCompose-&gt;GetInsertingQuotedContent(&amp;insertingQuotedContent);</span>
<a href="#l3.282"></a><span id="l3.282">       nsCOMPtr&lt;nsIDOMHTMLImageElement&gt; imageElement(do_QueryInterface(aRequestingContext));</span>
<a href="#l3.283"></a><span id="l3.283">       if (!insertingQuotedContent &amp;&amp; imageElement)</span>
<a href="#l3.284"></a><span id="l3.284">       {</span>
<a href="#l3.285"></a><span id="l3.285">         nsCOMPtr&lt;nsIDOMElement&gt; element(do_QueryInterface(imageElement));</span>
<a href="#l3.286"></a><span id="l3.286">         if (element)</span>
<a href="#l3.287"></a><span id="l3.287">         {</span>
<a href="#l3.288"></a><span id="l3.288">           bool doNotSendAttrib;</span>
<a href="#l3.289"></a><span id="l3.289" class="difflineminus">-          if (NS_SUCCEEDED(element-&gt;HasAttribute(NS_LITERAL_STRING(&quot;moz-do-not-send&quot;), &amp;doNotSendAttrib)) &amp;&amp; </span>
<a href="#l3.290"></a><span id="l3.290" class="difflineplus">+          if (NS_SUCCEEDED(element-&gt;HasAttribute(NS_LITERAL_STRING(&quot;moz-do-not-send&quot;), &amp;doNotSendAttrib)) &amp;&amp;</span>
<a href="#l3.291"></a><span id="l3.291">               !doNotSendAttrib)</span>
<a href="#l3.292"></a><span id="l3.292">             *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l3.293"></a><span id="l3.293">         }</span>
<a href="#l3.294"></a><span id="l3.294">       }</span>
<a href="#l3.295"></a><span id="l3.295">     }</span>
<a href="#l3.296"></a><span id="l3.296">   }</span>
<a href="#l3.297"></a><span id="l3.297"> }</span>
<a href="#l3.298"></a><span id="l3.298"> </span>
<a href="#l3.299"></a><span id="l3.299" class="difflineat">@@ -650,18 +655,18 @@ already_AddRefed&lt;nsIMsgCompose&gt; nsMsgCon</span>
<a href="#l3.300"></a><span id="l3.300"> </span>
<a href="#l3.301"></a><span id="l3.301"> nsresult nsMsgContentPolicy::SetDisableItemsOnMailNewsUrlDocshells(</span>
<a href="#l3.302"></a><span id="l3.302">   nsIURI *aContentLocation, nsISupports *aRequestingContext)</span>
<a href="#l3.303"></a><span id="l3.303"> {</span>
<a href="#l3.304"></a><span id="l3.304">   // XXX if this class changes so that this method can be called from</span>
<a href="#l3.305"></a><span id="l3.305">   // ShouldProcess, and if it's possible for this to be null when called from</span>
<a href="#l3.306"></a><span id="l3.306">   // ShouldLoad, but not in the corresponding ShouldProcess call,</span>
<a href="#l3.307"></a><span id="l3.307">   // we need to re-think the assumptions underlying this code.</span>
<a href="#l3.308"></a><span id="l3.308" class="difflineminus">-  </span>
<a href="#l3.309"></a><span id="l3.309" class="difflineminus">-  // If there's no docshell to get to, there's nowhere for the JavaScript to </span>
<a href="#l3.310"></a><span id="l3.310" class="difflineplus">+</span>
<a href="#l3.311"></a><span id="l3.311" class="difflineplus">+  // If there's no docshell to get to, there's nowhere for the JavaScript to</span>
<a href="#l3.312"></a><span id="l3.312">   // run, so we're already safe and don't need to disable anything.</span>
<a href="#l3.313"></a><span id="l3.313">   if (!aRequestingContext) {</span>
<a href="#l3.314"></a><span id="l3.314">     return NS_OK;</span>
<a href="#l3.315"></a><span id="l3.315">   }</span>
<a href="#l3.316"></a><span id="l3.316"> </span>
<a href="#l3.317"></a><span id="l3.317">   nsresult rv;</span>
<a href="#l3.318"></a><span id="l3.318">   bool isAllowedContent = !ShouldBlockUnexposedProtocol(aContentLocation);</span>
<a href="#l3.319"></a><span id="l3.319">   nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(aContentLocation, &amp;rv);</span>
<a href="#l3.320"></a><span id="l3.320" class="difflineat">@@ -676,17 +681,17 @@ nsresult nsMsgContentPolicy::SetDisableI</span>
<a href="#l3.321"></a><span id="l3.321">   nsCOMPtr&lt;nsIFrameLoaderOwner&gt; flOwner = do_QueryInterface(aRequestingContext,</span>
<a href="#l3.322"></a><span id="l3.322">                                                             &amp;rv);</span>
<a href="#l3.323"></a><span id="l3.323">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.324"></a><span id="l3.324"> </span>
<a href="#l3.325"></a><span id="l3.325">   nsCOMPtr&lt;nsIFrameLoader&gt; frameLoader;</span>
<a href="#l3.326"></a><span id="l3.326">   rv = flOwner-&gt;GetFrameLoader(getter_AddRefs(frameLoader));</span>
<a href="#l3.327"></a><span id="l3.327">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.328"></a><span id="l3.328">   NS_ENSURE_TRUE(frameLoader, NS_ERROR_INVALID_POINTER);</span>
<a href="#l3.329"></a><span id="l3.329" class="difflineminus">-  </span>
<a href="#l3.330"></a><span id="l3.330" class="difflineplus">+</span>
<a href="#l3.331"></a><span id="l3.331">   nsCOMPtr&lt;nsIDocShell&gt; docShell;</span>
<a href="#l3.332"></a><span id="l3.332">   rv = frameLoader-&gt;GetDocShell(getter_AddRefs(docShell));</span>
<a href="#l3.333"></a><span id="l3.333">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.334"></a><span id="l3.334"> </span>
<a href="#l3.335"></a><span id="l3.335">   nsCOMPtr&lt;nsIDocShellTreeItem&gt; docshellTreeItem(do_QueryInterface(docShell, &amp;rv));</span>
<a href="#l3.336"></a><span id="l3.336">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.337"></a><span id="l3.337"> </span>
<a href="#l3.338"></a><span id="l3.338">   // what sort of docshell is this?</span>
<a href="#l3.339"></a><span id="l3.339" class="difflineat">@@ -744,17 +749,17 @@ nsMsgContentPolicy::GetRootDocShellForCo</span>
<a href="#l3.340"></a><span id="l3.340"> </span>
<a href="#l3.341"></a><span id="l3.341"> /**</span>
<a href="#l3.342"></a><span id="l3.342">  * Gets the originating URI that started off a set of requests, accounting</span>
<a href="#l3.343"></a><span id="l3.343">  * for multiple iframes.</span>
<a href="#l3.344"></a><span id="l3.344">  *</span>
<a href="#l3.345"></a><span id="l3.345">  * Navigates up the docshell tree from aRequestingContext and finds the</span>
<a href="#l3.346"></a><span id="l3.346">  * highest parent with the same type docshell as aRequestingContext, then</span>
<a href="#l3.347"></a><span id="l3.347">  * returns the URI associated with that docshell.</span>
<a href="#l3.348"></a><span id="l3.348" class="difflineminus">- */ </span>
<a href="#l3.349"></a><span id="l3.349" class="difflineplus">+ */</span>
<a href="#l3.350"></a><span id="l3.350"> nsresult</span>
<a href="#l3.351"></a><span id="l3.351"> nsMsgContentPolicy::GetOriginatingURIForContext(nsISupports *aRequestingContext,</span>
<a href="#l3.352"></a><span id="l3.352">                                                 nsIURI **aURI)</span>
<a href="#l3.353"></a><span id="l3.353"> {</span>
<a href="#l3.354"></a><span id="l3.354">   NS_ENSURE_ARG_POINTER(aRequestingContext);</span>
<a href="#l3.355"></a><span id="l3.355">   nsresult rv;</span>
<a href="#l3.356"></a><span id="l3.356"> </span>
<a href="#l3.357"></a><span id="l3.357">   nsIDocShell *shell = NS_CP_GetDocShellFromContext(aRequestingContext);</span>
<a href="#l3.358"></a><span id="l3.358" class="difflineat">@@ -778,26 +783,26 @@ nsMsgContentPolicy::ShouldProcess(uint32</span>
<a href="#l3.359"></a><span id="l3.359">                                   nsISupports      *aRequestingContext,</span>
<a href="#l3.360"></a><span id="l3.360">                                   const nsACString &amp;aMimeGuess,</span>
<a href="#l3.361"></a><span id="l3.361">                                   nsISupports      *aExtra,</span>
<a href="#l3.362"></a><span id="l3.362">                                   nsIPrincipal     *aRequestPrincipal,</span>
<a href="#l3.363"></a><span id="l3.363">                                   int16_t          *aDecision)</span>
<a href="#l3.364"></a><span id="l3.364"> {</span>
<a href="#l3.365"></a><span id="l3.365">   // XXX Returning ACCEPT is presumably only a reasonable thing to do if we</span>
<a href="#l3.366"></a><span id="l3.366">   // think that ShouldLoad is going to catch all possible cases (i.e. that</span>
<a href="#l3.367"></a><span id="l3.367" class="difflineminus">-  // everything we use to make decisions is going to be available at </span>
<a href="#l3.368"></a><span id="l3.368" class="difflineplus">+  // everything we use to make decisions is going to be available at</span>
<a href="#l3.369"></a><span id="l3.369">   // ShouldLoad time, and not only become available in time for ShouldProcess).</span>
<a href="#l3.370"></a><span id="l3.370">   // Do we think that's actually the case?</span>
<a href="#l3.371"></a><span id="l3.371">   *aDecision = nsIContentPolicy::ACCEPT;</span>
<a href="#l3.372"></a><span id="l3.372">   return NS_OK;</span>
<a href="#l3.373"></a><span id="l3.373"> }</span>
<a href="#l3.374"></a><span id="l3.374"> </span>
<a href="#l3.375"></a><span id="l3.375"> NS_IMETHODIMP nsMsgContentPolicy::Observe(nsISupports *aSubject, const char *aTopic, const char16_t *aData)</span>
<a href="#l3.376"></a><span id="l3.376"> {</span>
<a href="#l3.377"></a><span id="l3.377" class="difflineminus">-  if (!strcmp(NS_PREFBRANCH_PREFCHANGE_TOPIC_ID, aTopic)) </span>
<a href="#l3.378"></a><span id="l3.378" class="difflineplus">+  if (!strcmp(NS_PREFBRANCH_PREFCHANGE_TOPIC_ID, aTopic))</span>
<a href="#l3.379"></a><span id="l3.379">   {</span>
<a href="#l3.380"></a><span id="l3.380">     NS_LossyConvertUTF16toASCII pref(aData);</span>
<a href="#l3.381"></a><span id="l3.381"> </span>
<a href="#l3.382"></a><span id="l3.382">     nsresult rv;</span>
<a href="#l3.383"></a><span id="l3.383"> </span>
<a href="#l3.384"></a><span id="l3.384">     nsCOMPtr&lt;nsIPrefBranch&gt; prefBranchInt = do_QueryInterface(aSubject, &amp;rv);</span>
<a href="#l3.385"></a><span id="l3.385">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l3.386"></a><span id="l3.386"> </span>
<a href="#l3.387"></a><span id="l3.387" class="difflineat">@@ -805,21 +810,21 @@ NS_IMETHODIMP nsMsgContentPolicy::Observ</span>
<a href="#l3.388"></a><span id="l3.388">       prefBranchInt-&gt;GetBoolPref(kBlockRemoteImages, &amp;mBlockRemoteImages);</span>
<a href="#l3.389"></a><span id="l3.389">     if (pref.Equals(kAllowPlugins))</span>
<a href="#l3.390"></a><span id="l3.390">       prefBranchInt-&gt;GetBoolPref(kAllowPlugins, &amp;mAllowPlugins);</span>
<a href="#l3.391"></a><span id="l3.391">   }</span>
<a href="#l3.392"></a><span id="l3.392"> </span>
<a href="#l3.393"></a><span id="l3.393">   return NS_OK;</span>
<a href="#l3.394"></a><span id="l3.394"> }</span>
<a href="#l3.395"></a><span id="l3.395"> </span>
<a href="#l3.396"></a><span id="l3.396" class="difflineminus">-/** </span>
<a href="#l3.397"></a><span id="l3.397" class="difflineplus">+/**</span>
<a href="#l3.398"></a><span id="l3.398">  * We implement the nsIWebProgressListener interface in order to enforce</span>
<a href="#l3.399"></a><span id="l3.399">  * settings at onLocationChange time.</span>
<a href="#l3.400"></a><span id="l3.400">  */</span>
<a href="#l3.401"></a><span id="l3.401" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l3.402"></a><span id="l3.402" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.403"></a><span id="l3.403"> nsMsgContentPolicy::OnStateChange(nsIWebProgress *aWebProgress,</span>
<a href="#l3.404"></a><span id="l3.404">                                   nsIRequest *aRequest, uint32_t aStateFlags,</span>
<a href="#l3.405"></a><span id="l3.405">                                   nsresult aStatus)</span>
<a href="#l3.406"></a><span id="l3.406"> {</span>
<a href="#l3.407"></a><span id="l3.407">   return NS_OK;</span>
<a href="#l3.408"></a><span id="l3.408"> }</span>
<a href="#l3.409"></a><span id="l3.409"> </span>
<a href="#l3.410"></a><span id="l3.410"> NS_IMETHODIMP</span>
<a href="#l3.411"></a><span id="l3.411" class="difflineat">@@ -828,44 +833,44 @@ nsMsgContentPolicy::OnProgressChange(nsI</span>
<a href="#l3.412"></a><span id="l3.412">                                      int32_t aCurSelfProgress,</span>
<a href="#l3.413"></a><span id="l3.413">                                      int32_t aMaxSelfProgress,</span>
<a href="#l3.414"></a><span id="l3.414">                                      int32_t aCurTotalProgress,</span>
<a href="#l3.415"></a><span id="l3.415">                                      int32_t aMaxTotalProgress)</span>
<a href="#l3.416"></a><span id="l3.416"> {</span>
<a href="#l3.417"></a><span id="l3.417">   return NS_OK;</span>
<a href="#l3.418"></a><span id="l3.418"> }</span>
<a href="#l3.419"></a><span id="l3.419"> </span>
<a href="#l3.420"></a><span id="l3.420" class="difflineminus">-NS_IMETHODIMP </span>
<a href="#l3.421"></a><span id="l3.421" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.422"></a><span id="l3.422"> nsMsgContentPolicy::OnLocationChange(nsIWebProgress *aWebProgress,</span>
<a href="#l3.423"></a><span id="l3.423">                                      nsIRequest *aRequest, nsIURI *aLocation,</span>
<a href="#l3.424"></a><span id="l3.424">                                      uint32_t aFlags)</span>
<a href="#l3.425"></a><span id="l3.425"> {</span>
<a href="#l3.426"></a><span id="l3.426">   nsresult rv;</span>
<a href="#l3.427"></a><span id="l3.427"> </span>
<a href="#l3.428"></a><span id="l3.428">   // If anything goes wrong and/or there's no docshell associated with this</span>
<a href="#l3.429"></a><span id="l3.429" class="difflineminus">-  // request, just give up.  The behavior ends up being &quot;don't consider </span>
<a href="#l3.430"></a><span id="l3.430" class="difflineplus">+  // request, just give up.  The behavior ends up being &quot;don't consider</span>
<a href="#l3.431"></a><span id="l3.431">   // re-enabling JS on the docshell&quot;, which is the safe thing to do (and if</span>
<a href="#l3.432"></a><span id="l3.432" class="difflineminus">-  // the problem was that there's no docshell, that means that there was </span>
<a href="#l3.433"></a><span id="l3.433" class="difflineplus">+  // the problem was that there's no docshell, that means that there was</span>
<a href="#l3.434"></a><span id="l3.434">   // nowhere for any JavaScript to run, so we're already safe</span>
<a href="#l3.435"></a><span id="l3.435" class="difflineminus">-  </span>
<a href="#l3.436"></a><span id="l3.436" class="difflineplus">+</span>
<a href="#l3.437"></a><span id="l3.437">   nsCOMPtr&lt;nsIDocShell&gt; docShell = do_QueryInterface(aWebProgress, &amp;rv);</span>
<a href="#l3.438"></a><span id="l3.438">   if (NS_FAILED(rv)) {</span>
<a href="#l3.439"></a><span id="l3.439">     return NS_OK;</span>
<a href="#l3.440"></a><span id="l3.440">   }</span>
<a href="#l3.441"></a><span id="l3.441"> </span>
<a href="#l3.442"></a><span id="l3.442"> #ifdef DEBUG</span>
<a href="#l3.443"></a><span id="l3.443">   nsCOMPtr&lt;nsIChannel&gt; channel = do_QueryInterface(aRequest, &amp;rv);</span>
<a href="#l3.444"></a><span id="l3.444">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.445"></a><span id="l3.445">     nsCOMPtr&lt;nsIDocShell&gt; docShell2;</span>
<a href="#l3.446"></a><span id="l3.446">     NS_QueryNotificationCallbacks(channel, docShell2);</span>
<a href="#l3.447"></a><span id="l3.447">     NS_ASSERTION(docShell == docShell2, &quot;aWebProgress and channel callbacks&quot;</span>
<a href="#l3.448"></a><span id="l3.448">                                         &quot; do not point to the same docshell&quot;);</span>
<a href="#l3.449"></a><span id="l3.449">   }</span>
<a href="#l3.450"></a><span id="l3.450"> #endif</span>
<a href="#l3.451"></a><span id="l3.451" class="difflineminus">-  </span>
<a href="#l3.452"></a><span id="l3.452" class="difflineplus">+</span>
<a href="#l3.453"></a><span id="l3.453">   nsCOMPtr&lt;nsIMsgMessageUrl&gt; messageUrl = do_QueryInterface(aLocation, &amp;rv);</span>
<a href="#l3.454"></a><span id="l3.454"> </span>
<a href="#l3.455"></a><span id="l3.455">   if (NS_SUCCEEDED(rv)) {</span>
<a href="#l3.456"></a><span id="l3.456">     // Disable javascript on message URLs.</span>
<a href="#l3.457"></a><span id="l3.457">     rv = docShell-&gt;SetAllowJavascript(false);</span>
<a href="#l3.458"></a><span id="l3.458">     NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l3.459"></a><span id="l3.459">                  &quot;Failed to set javascript disabled on docShell&quot;);</span>
<a href="#l3.460"></a><span id="l3.460">     // Also disable plugins if the preference requires it.</span>
<a href="#l3.461"></a><span id="l3.461" class="difflineat">@@ -895,8 +900,32 @@ nsMsgContentPolicy::OnStatusChange(nsIWe</span>
<a href="#l3.462"></a><span id="l3.462"> }</span>
<a href="#l3.463"></a><span id="l3.463"> </span>
<a href="#l3.464"></a><span id="l3.464"> NS_IMETHODIMP</span>
<a href="#l3.465"></a><span id="l3.465"> nsMsgContentPolicy::OnSecurityChange(nsIWebProgress *aWebProgress,</span>
<a href="#l3.466"></a><span id="l3.466">                                      nsIRequest *aRequest, uint32_t aState)</span>
<a href="#l3.467"></a><span id="l3.467"> {</span>
<a href="#l3.468"></a><span id="l3.468">   return NS_OK;</span>
<a href="#l3.469"></a><span id="l3.469"> }</span>
<a href="#l3.470"></a><span id="l3.470" class="difflineplus">+</span>
<a href="#l3.471"></a><span id="l3.471" class="difflineplus">+/**</span>
<a href="#l3.472"></a><span id="l3.472" class="difflineplus">+ * Implementation of nsIMsgContentPolicy</span>
<a href="#l3.473"></a><span id="l3.473" class="difflineplus">+ *</span>
<a href="#l3.474"></a><span id="l3.474" class="difflineplus">+ */</span>
<a href="#l3.475"></a><span id="l3.475" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.476"></a><span id="l3.476" class="difflineplus">+nsMsgContentPolicy::AddExposedProtocol(const nsACString &amp;aScheme)</span>
<a href="#l3.477"></a><span id="l3.477" class="difflineplus">+{</span>
<a href="#l3.478"></a><span id="l3.478" class="difflineplus">+  if (mCustomExposedProtocols.Contains(nsCString(aScheme)))</span>
<a href="#l3.479"></a><span id="l3.479" class="difflineplus">+    return NS_OK;</span>
<a href="#l3.480"></a><span id="l3.480" class="difflineplus">+</span>
<a href="#l3.481"></a><span id="l3.481" class="difflineplus">+  mCustomExposedProtocols.AppendElement(aScheme);</span>
<a href="#l3.482"></a><span id="l3.482" class="difflineplus">+</span>
<a href="#l3.483"></a><span id="l3.483" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.484"></a><span id="l3.484" class="difflineplus">+}</span>
<a href="#l3.485"></a><span id="l3.485" class="difflineplus">+</span>
<a href="#l3.486"></a><span id="l3.486" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l3.487"></a><span id="l3.487" class="difflineplus">+nsMsgContentPolicy::RemoveExposedProtocol(const nsACString &amp;aScheme)</span>
<a href="#l3.488"></a><span id="l3.488" class="difflineplus">+{</span>
<a href="#l3.489"></a><span id="l3.489" class="difflineplus">+  mCustomExposedProtocols.RemoveElement(nsCString(aScheme));</span>
<a href="#l3.490"></a><span id="l3.490" class="difflineplus">+</span>
<a href="#l3.491"></a><span id="l3.491" class="difflineplus">+  return NS_OK;</span>
<a href="#l3.492"></a><span id="l3.492" class="difflineplus">+}</span>
<a href="#l3.493"></a><span id="l3.493" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mailnews/base/src/nsMsgContentPolicy.h</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgContentPolicy.h</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -17,40 +17,44 @@</span>
<a href="#l4.4"></a><span id="l4.4"> #include &quot;nsIObserver.h&quot;</span>
<a href="#l4.5"></a><span id="l4.5"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l4.6"></a><span id="l4.6"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l4.7"></a><span id="l4.7"> #include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l4.8"></a><span id="l4.8"> #include &quot;nsIWebProgressListener.h&quot;</span>
<a href="#l4.9"></a><span id="l4.9"> #include &quot;nsIMsgCompose.h&quot;</span>
<a href="#l4.10"></a><span id="l4.10"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l4.11"></a><span id="l4.11"> #include &quot;nsIPermissionManager.h&quot;</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineplus">+#include &quot;nsIMsgContentPolicy.h&quot;</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+#include &quot;nsTArray.h&quot;</span>
<a href="#l4.14"></a><span id="l4.14"> </span>
<a href="#l4.15"></a><span id="l4.15"> /* DBFCFDF0-4489-4faa-8122-190FD1EFA16C */</span>
<a href="#l4.16"></a><span id="l4.16"> #define NS_MSGCONTENTPOLICY_CID \</span>
<a href="#l4.17"></a><span id="l4.17"> { 0xdbfcfdf0, 0x4489, 0x4faa, { 0x81, 0x22, 0x19, 0xf, 0xd1, 0xef, 0xa1, 0x6c } }</span>
<a href="#l4.18"></a><span id="l4.18"> </span>
<a href="#l4.19"></a><span id="l4.19"> #define NS_MSGCONTENTPOLICY_CONTRACTID &quot;@mozilla.org/messenger/content-policy;1&quot;</span>
<a href="#l4.20"></a><span id="l4.20"> </span>
<a href="#l4.21"></a><span id="l4.21"> class nsIMsgDBHdr;</span>
<a href="#l4.22"></a><span id="l4.22"> class nsIDocShell;</span>
<a href="#l4.23"></a><span id="l4.23"> </span>
<a href="#l4.24"></a><span id="l4.24"> class nsMsgContentPolicy : public nsIContentPolicy,</span>
<a href="#l4.25"></a><span id="l4.25">                            public nsIObserver,</span>
<a href="#l4.26"></a><span id="l4.26">                            public nsIWebProgressListener,</span>
<a href="#l4.27"></a><span id="l4.27" class="difflineplus">+                           public nsIMsgContentPolicy,</span>
<a href="#l4.28"></a><span id="l4.28">                            public nsSupportsWeakReference</span>
<a href="#l4.29"></a><span id="l4.29"> {</span>
<a href="#l4.30"></a><span id="l4.30"> public:</span>
<a href="#l4.31"></a><span id="l4.31">   nsMsgContentPolicy();</span>
<a href="#l4.32"></a><span id="l4.32"> </span>
<a href="#l4.33"></a><span id="l4.33">   nsresult Init();</span>
<a href="#l4.34"></a><span id="l4.34">     </span>
<a href="#l4.35"></a><span id="l4.35">   NS_DECL_ISUPPORTS</span>
<a href="#l4.36"></a><span id="l4.36">   NS_DECL_NSICONTENTPOLICY</span>
<a href="#l4.37"></a><span id="l4.37">   NS_DECL_NSIOBSERVER</span>
<a href="#l4.38"></a><span id="l4.38">   NS_DECL_NSIWEBPROGRESSLISTENER</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+  NS_DECL_NSIMSGCONTENTPOLICY</span>
<a href="#l4.40"></a><span id="l4.40">   </span>
<a href="#l4.41"></a><span id="l4.41"> protected:</span>
<a href="#l4.42"></a><span id="l4.42">   virtual ~nsMsgContentPolicy();</span>
<a href="#l4.43"></a><span id="l4.43"> </span>
<a href="#l4.44"></a><span id="l4.44">   bool     mBlockRemoteImages;</span>
<a href="#l4.45"></a><span id="l4.45">   bool     mAllowPlugins;</span>
<a href="#l4.46"></a><span id="l4.46">   nsCString mTrustedMailDomains;</span>
<a href="#l4.47"></a><span id="l4.47">   nsCOMPtr&lt;nsIPermissionManager&gt; mPermissionManager;</span>
<a href="#l4.48"></a><span id="l4.48" class="difflineat">@@ -74,11 +78,13 @@ protected:</span>
<a href="#l4.49"></a><span id="l4.49">   already_AddRefed&lt;nsIMsgCompose&gt; GetMsgComposeForContext(nsISupports *aRequestingContext);</span>
<a href="#l4.50"></a><span id="l4.50"> </span>
<a href="#l4.51"></a><span id="l4.51">   nsresult GetRootDocShellForContext(nsISupports *aRequestingContext,</span>
<a href="#l4.52"></a><span id="l4.52">                                      nsIDocShell **aDocShell);</span>
<a href="#l4.53"></a><span id="l4.53">   nsresult GetOriginatingURIForContext(nsISupports *aRequestingContext,</span>
<a href="#l4.54"></a><span id="l4.54">                                        nsIURI **aURI);</span>
<a href="#l4.55"></a><span id="l4.55">   nsresult SetDisableItemsOnMailNewsUrlDocshells(nsIURI *aContentLocation,</span>
<a href="#l4.56"></a><span id="l4.56">                                                  nsISupports *aRequestingContext);</span>
<a href="#l4.57"></a><span id="l4.57" class="difflineplus">+</span>
<a href="#l4.58"></a><span id="l4.58" class="difflineplus">+  nsTArray&lt;nsCString&gt; mCustomExposedProtocols;</span>
<a href="#l4.59"></a><span id="l4.59"> };</span>
<a href="#l4.60"></a><span id="l4.60"> </span>
<a href="#l4.61"></a><span id="l4.61"> #endif // _nsMsgContentPolicy_H_</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1">new file mode 100644</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineminus">--- /dev/null</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgContentPolicy.js</span>
<a href="#l5.4"></a><span id="l5.4" class="difflineat">@@ -0,0 +1,63 @@</span>
<a href="#l5.5"></a><span id="l5.5" class="difflineplus">+/* -*- mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l5.6"></a><span id="l5.6" class="difflineplus">+/*</span>
<a href="#l5.7"></a><span id="l5.7" class="difflineplus">+ * Test suite for nsIMsgContentPolicy to check we could add/remove customized protocol to</span>
<a href="#l5.8"></a><span id="l5.8" class="difflineplus">+ * nsMsgContentPolicy.</span>
<a href="#l5.9"></a><span id="l5.9" class="difflineplus">+ */</span>
<a href="#l5.10"></a><span id="l5.10" class="difflineplus">+</span>
<a href="#l5.11"></a><span id="l5.11" class="difflineplus">+function makeURI(aURL) {</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineplus">+  var ioService = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+                    .getService(Ci.nsIIOService);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  return ioService.newURI(aURL, null, null);</span>
<a href="#l5.15"></a><span id="l5.15" class="difflineplus">+}</span>
<a href="#l5.16"></a><span id="l5.16" class="difflineplus">+</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+function run_test() {</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+  var content_policy = Cc[&quot;@mozilla.org/messenger/content-policy;1&quot;]</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+                         .getService(Ci.nsIContentPolicy);</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+  Assert.ok(content_policy);</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+  var msg_content_policy = content_policy.QueryInterface(Ci.nsIMsgContentPolicy);</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+  Assert.ok(msg_content_policy);</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  var req_uri = makeURI(&quot;custom-scheme://custom_url/1.emal&quot;);</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+  Assert.ok(req_uri);</span>
<a href="#l5.29"></a><span id="l5.29" class="difflineplus">+</span>
<a href="#l5.30"></a><span id="l5.30" class="difflineplus">+  var content_uri = makeURI(&quot;custom-scheme://custom_content_url/1.jsp&quot;);</span>
<a href="#l5.31"></a><span id="l5.31" class="difflineplus">+  Assert.ok(content_uri);</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+  var decision = content_policy.shouldLoad(Ci.nsIContentPolicy.TYPE_IMAGE,</span>
<a href="#l5.34"></a><span id="l5.34" class="difflineplus">+                                           content_uri,</span>
<a href="#l5.35"></a><span id="l5.35" class="difflineplus">+                                           req_uri,</span>
<a href="#l5.36"></a><span id="l5.36" class="difflineplus">+                                           null,</span>
<a href="#l5.37"></a><span id="l5.37" class="difflineplus">+                                           &quot;img/jpeg&quot;,</span>
<a href="#l5.38"></a><span id="l5.38" class="difflineplus">+                                           null);</span>
<a href="#l5.39"></a><span id="l5.39" class="difflineplus">+  Assert.notEqual(decision,</span>
<a href="#l5.40"></a><span id="l5.40" class="difflineplus">+                  Ci.nsIContentPolicy.ACCEPT,</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineplus">+                  &quot;customized protocol should not load&quot;);</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+</span>
<a href="#l5.43"></a><span id="l5.43" class="difflineplus">+  msg_content_policy.addExposedProtocol(&quot;custom-scheme&quot;);</span>
<a href="#l5.44"></a><span id="l5.44" class="difflineplus">+</span>
<a href="#l5.45"></a><span id="l5.45" class="difflineplus">+  decision = content_policy.shouldLoad(Ci.nsIContentPolicy.TYPE_IMAGE,</span>
<a href="#l5.46"></a><span id="l5.46" class="difflineplus">+                                       content_uri,</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineplus">+                                       req_uri,</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+                                       null,</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+                                       &quot;img/jpeg&quot;,</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+                                       null);</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+  Assert.equal(decision,</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+               Ci.nsIContentPolicy.ACCEPT,</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+               &quot;customized protocol should load&quot;);</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+</span>
<a href="#l5.55"></a><span id="l5.55" class="difflineplus">+  msg_content_policy.removeExposedProtocol(&quot;custom-scheme&quot;);</span>
<a href="#l5.56"></a><span id="l5.56" class="difflineplus">+</span>
<a href="#l5.57"></a><span id="l5.57" class="difflineplus">+  decision = content_policy.shouldLoad(Ci.nsIContentPolicy.TYPE_IMAGE,</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineplus">+                                       content_uri,</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineplus">+                                       req_uri,</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineplus">+                                       null,</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineplus">+                                       &quot;img/jpeg&quot;,</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineplus">+                                       null);</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineplus">+  Assert.notEqual(decision,</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineplus">+                  Ci.nsIContentPolicy.ACCEPT,</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineplus">+                  &quot;customized protocol should not load&quot;);</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineplus">+};</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/test/unit/xpcshell.ini</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/test/unit/xpcshell.ini</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -38,16 +38,17 @@ support-files = nodelist_test.xml data/*</span>
<a href="#l6.4"></a><span id="l6.4"> [test_junkWhitelisting.js]</span>
<a href="#l6.5"></a><span id="l6.5"> [test_loadVirtualFolders.js]</span>
<a href="#l6.6"></a><span id="l6.6"> [test_mailServices.js]</span>
<a href="#l6.7"></a><span id="l6.7"> [test_mimemaltdetach.js]</span>
<a href="#l6.8"></a><span id="l6.8"> [test_newMailNotification.js]</span>
<a href="#l6.9"></a><span id="l6.9"> # Not yet working for non-Mac OS</span>
<a href="#l6.10"></a><span id="l6.10"> skip-if = os != 'mac'</span>
<a href="#l6.11"></a><span id="l6.11"> </span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+[test_nsIMsgContentPolicy.js]</span>
<a href="#l6.13"></a><span id="l6.13"> [test_nsIMsgFolder.js]</span>
<a href="#l6.14"></a><span id="l6.14"> [test_nsIMsgFolderListener.js]</span>
<a href="#l6.15"></a><span id="l6.15"> [test_nsIMsgFolderListenerLocal.js]</span>
<a href="#l6.16"></a><span id="l6.16"> [test_nsIMsgTagService.js]</span>
<a href="#l6.17"></a><span id="l6.17"> [test_nsMailDirProvider.js]</span>
<a href="#l6.18"></a><span id="l6.18"> [test_nsMsgDBView.js]</span>
<a href="#l6.19"></a><span id="l6.19"> [test_nsMsgDBView_headerValues.js]</span>
<a href="#l6.20"></a><span id="l6.20"> [test_nsMsgMailSession_Alerts.js]</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

