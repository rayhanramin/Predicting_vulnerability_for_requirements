<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/4b0de666d1a4/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/4b0de666d1a4/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/4b0de666d1a4/mercurial.js"></script>

<meta property="og:image" content="/static/4b0de666d1a4/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 25889:f00a9035dd9983862585d1fe9a0556ab25ce1291</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ f00a9035dd9983862585d1fe9a0556ab25ce1291" />
<meta property="og:url" content="/comm-central/rev/f00a9035dd9983862585d1fe9a0556ab25ce1291" />
<meta property="og:description" content="Bug 1511945 - DeCOMtaminate FileLink and improve its preferences UI; r=Fallen" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/4b0de666d1a4/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / f00a9035dd9983862585d1fe9a0556ab25ce1291 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/f00a9035dd9983862585d1fe9a0556ab25ce1291">shortlog</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/f00a9035dd9983862585d1fe9a0556ab25ce1291">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291">files</a> |
changeset |
<a href="/comm-central/raw-rev/f00a9035dd9983862585d1fe9a0556ab25ce1291">raw</a>  | <a href="/comm-central/archive/f00a9035dd9983862585d1fe9a0556ab25ce1291.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
<a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1511945">Bug 1511945</a> - DeCOMtaminate FileLink and improve its preferences UI; r=Fallen
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#71;&#101;&#111;&#102;&#102;&#32;&#76;&#97;&#110;&#107;&#111;&#119;&#32;&#60;&#103;&#101;&#111;&#102;&#102;&#64;&#100;&#97;&#114;&#107;&#116;&#114;&#111;&#106;&#97;&#110;&#46;&#110;&#101;&#116;&#62;</td></tr>
<tr><td></td><td class="date age">Tue, 19 Feb 2019 11:15:04 +1300</td></tr>

<tr>
 <td>changeset 25889</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/f00a9035dd9983862585d1fe9a0556ab25ce1291">f00a9035dd9983862585d1fe9a0556ab25ce1291</a></td>
</tr>



<tr>
<td>parent 25888</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/9ac38c12b75a7938867c01c9bd556cb8c21024ca">9ac38c12b75a7938867c01c9bd556cb8c21024ca</a>
</td>
</tr>

<tr>
<td>child 25890</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/ed7032c2d636079d29a267e1b65ca3231cdbd902">ed7032c2d636079d29a267e1b65ca3231cdbd902</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=f00a9035dd9983862585d1fe9a0556ab25ce1291">15528</a></td></tr>
<tr><td>push user</td><td>geoff@darktrojan.net</td></tr>
<tr><td>push date</td><td class="date age">Mon, 18 Feb 2019 22:15:50 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@f00a9035dd99 [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f00a9035dd9983862585d1fe9a0556ab25ce1291">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=f00a9035dd9983862585d1fe9a0556ab25ce1291&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f00a9035dd9983862585d1fe9a0556ab25ce1291&newProject=comm-central&newRevision=f00a9035dd9983862585d1fe9a0556ab25ce1291&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f00a9035dd9983862585d1fe9a0556ab25ce1291&newProject=comm-central&newRevision=f00a9035dd9983862585d1fe9a0556ab25ce1291&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=f00a9035dd9983862585d1fe9a0556ab25ce1291&newProject=comm-central&newRevision=f00a9035dd9983862585d1fe9a0556ab25ce1291&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28Fallen%29&revcount=50">Fallen</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1511945">1511945</a></td></tr>




</table></div>

<div class="page_body description"><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1511945">Bug 1511945</a> - DeCOMtaminate FileLink and improve its preferences UI; r=Fallen</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/calendar/lightning/content/lightning-item-iframe.js">calendar/lightning/content/lightning-item-iframe.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/calendar/lightning/content/lightning-item-iframe.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/calendar/lightning/content/lightning-item-iframe.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/calendar/lightning/content/lightning-item-iframe.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/calendar/lightning/content/lightning-item-iframe.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/calendar/lightning/content/lightning-item-iframe.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/box.jsm">mail/components/cloudfile/box/box.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/box.jsm">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/box.jsm">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/box.jsm">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/box.jsm">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/box.jsm">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/management.js">mail/components/cloudfile/box/management.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/management.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/management.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/management.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/management.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/management.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/management.xhtml">mail/components/cloudfile/box/management.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/management.xhtml">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/management.xhtml">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/management.xhtml">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/management.xhtml">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/box/management.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/cloudFileAccounts.js">mail/components/cloudfile/cloudFileAccounts.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/cloudFileAccounts.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/cloudFileAccounts.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/cloudFileAccounts.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/cloudFileAccounts.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/cloudFileAccounts.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/cloudFileComponents.manifest">mail/components/cloudfile/cloudFileComponents.manifest</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/cloudFileComponents.manifest">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/cloudFileComponents.manifest">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/cloudFileComponents.manifest">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Box/management.js">mail/components/cloudfile/content/Box/management.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Box/management.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Box/management.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Box/management.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Box/management.xhtml">mail/components/cloudfile/content/Box/management.xhtml</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Box/management.xhtml">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Box/management.xhtml">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Box/management.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Box/settings.xhtml">mail/components/cloudfile/content/Box/settings.xhtml</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Box/settings.xhtml">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Box/settings.xhtml">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Box/settings.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/fileExceeds2GB.xul">mail/components/cloudfile/content/Hightail/fileExceeds2GB.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/fileExceeds2GB.xul">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/fileExceeds2GB.xul">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/fileExceeds2GB.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/fileExceedsLimit.xul">mail/components/cloudfile/content/Hightail/fileExceedsLimit.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/fileExceedsLimit.xul">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/fileExceedsLimit.xul">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/fileExceedsLimit.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/fileExceedsQuota.js">mail/components/cloudfile/content/Hightail/fileExceedsQuota.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/fileExceedsQuota.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/fileExceedsQuota.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/fileExceedsQuota.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/fileExceedsQuota.xul">mail/components/cloudfile/content/Hightail/fileExceedsQuota.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/fileExceedsQuota.xul">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/fileExceedsQuota.xul">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/fileExceedsQuota.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/management.js">mail/components/cloudfile/content/Hightail/management.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/management.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/management.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/management.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/management.xhtml">mail/components/cloudfile/content/Hightail/management.xhtml</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/management.xhtml">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/management.xhtml">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/management.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/settings.js">mail/components/cloudfile/content/Hightail/settings.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/settings.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/settings.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/settings.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/settings.xhtml">mail/components/cloudfile/content/Hightail/settings.xhtml</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/settings.xhtml">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/settings.xhtml">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/Hightail/settings.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/addAccountDialog.js">mail/components/cloudfile/content/addAccountDialog.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/addAccountDialog.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/addAccountDialog.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/addAccountDialog.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/addAccountDialog.xul">mail/components/cloudfile/content/addAccountDialog.xul</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/addAccountDialog.xul">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/addAccountDialog.xul">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/addAccountDialog.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/emptySettings.xhtml">mail/components/cloudfile/content/emptySettings.xhtml</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/emptySettings.xhtml">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/emptySettings.xhtml">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/content/emptySettings.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceeds2GB.xul">mail/components/cloudfile/hightail/fileExceeds2GB.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceeds2GB.xul">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceeds2GB.xul">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceeds2GB.xul">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceeds2GB.xul">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceeds2GB.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsLimit.xul">mail/components/cloudfile/hightail/fileExceedsLimit.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsLimit.xul">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsLimit.xul">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsLimit.xul">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsLimit.xul">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsLimit.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsQuota.js">mail/components/cloudfile/hightail/fileExceedsQuota.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsQuota.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsQuota.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsQuota.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsQuota.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsQuota.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsQuota.xul">mail/components/cloudfile/hightail/fileExceedsQuota.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsQuota.xul">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsQuota.xul">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsQuota.xul">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsQuota.xul">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/fileExceedsQuota.xul">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/hightail.jsm">mail/components/cloudfile/hightail/hightail.jsm</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/hightail.jsm">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/hightail.jsm">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/hightail.jsm">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/hightail.jsm">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/hightail.jsm">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/management.js">mail/components/cloudfile/hightail/management.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/management.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/management.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/management.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/management.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/management.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/management.xhtml">mail/components/cloudfile/hightail/management.xhtml</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/management.xhtml">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/management.xhtml">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/management.xhtml">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/management.xhtml">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/hightail/management.xhtml">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/jar.mn">mail/components/cloudfile/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/jar.mn">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/jar.mn">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/jar.mn">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/jar.mn">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/moz.build">mail/components/cloudfile/moz.build</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/moz.build">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/moz.build">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/moz.build">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/moz.build">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/moz.build">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/nsBox.js">mail/components/cloudfile/nsBox.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/nsBox.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/nsBox.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/nsBox.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/nsHightail.js">mail/components/cloudfile/nsHightail.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/nsHightail.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/nsHightail.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/nsHightail.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/nsIMsgCloudFileProvider.idl">mail/components/cloudfile/nsIMsgCloudFileProvider.idl</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/nsIMsgCloudFileProvider.idl">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/nsIMsgCloudFileProvider.idl">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/nsIMsgCloudFileProvider.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/.eslintrc.js">mail/components/cloudfile/test/browser/.eslintrc.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/.eslintrc.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/.eslintrc.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/.eslintrc.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/.eslintrc.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/.eslintrc.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/browser.ini">mail/components/cloudfile/test/browser/browser.ini</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/browser.ini">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/browser.ini">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/browser.ini">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/browser.ini">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/browser.ini">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/browser_manager.js">mail/components/cloudfile/test/browser/browser_manager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/browser_manager.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/browser_manager.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/browser_manager.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/browser_manager.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/browser_manager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/files/icon.svg">mail/components/cloudfile/test/browser/files/icon.svg</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/files/icon.svg">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/files/icon.svg">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/files/icon.svg">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/files/icon.svg">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/files/icon.svg">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/files/management.html">mail/components/cloudfile/test/browser/files/management.html</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/files/management.html">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/files/management.html">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/files/management.html">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/files/management.html">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/test/browser/files/management.html">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/wetransfer/background/background.js">mail/components/cloudfile/wetransfer/background/background.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/wetransfer/background/background.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/wetransfer/background/background.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/wetransfer/background/background.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/wetransfer/background/background.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/wetransfer/background/background.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/wetransfer/manifest.json">mail/components/cloudfile/wetransfer/manifest.json</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/wetransfer/manifest.json">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/wetransfer/manifest.json">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/wetransfer/manifest.json">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/wetransfer/manifest.json">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/cloudfile/wetransfer/manifest.json">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/MsgComposeCommands.js">mail/components/compose/content/MsgComposeCommands.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/MsgComposeCommands.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/MsgComposeCommands.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/MsgComposeCommands.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/MsgComposeCommands.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/MsgComposeCommands.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/bigFileObserver.js">mail/components/compose/content/bigFileObserver.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/bigFileObserver.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/bigFileObserver.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/bigFileObserver.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/bigFileObserver.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/bigFileObserver.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/cloudAttachmentLinkManager.js">mail/components/compose/content/cloudAttachmentLinkManager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/cloudAttachmentLinkManager.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/cloudAttachmentLinkManager.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/cloudAttachmentLinkManager.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/cloudAttachmentLinkManager.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/compose/content/cloudAttachmentLinkManager.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/extensions/parent/ext-cloudFile.js">mail/components/extensions/parent/ext-cloudFile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/extensions/parent/ext-cloudFile.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/extensions/parent/ext-cloudFile.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/extensions/parent/ext-cloudFile.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/extensions/parent/ext-cloudFile.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/extensions/parent/ext-cloudFile.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">mail/components/extensions/test/xpcshell/test_ext_cloudFile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/preferences/applications.inc.xul">mail/components/preferences/applications.inc.xul</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/preferences/applications.inc.xul">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/preferences/applications.inc.xul">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/preferences/applications.inc.xul">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/preferences/applications.inc.xul">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/preferences/applications.inc.xul">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/preferences/applications.js">mail/components/preferences/applications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/preferences/applications.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/preferences/applications.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/preferences/applications.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/preferences/applications.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/components/preferences/applications.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/installer/package-manifest.in">mail/installer/package-manifest.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/installer/package-manifest.in">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/installer/package-manifest.in">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/installer/package-manifest.in">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/installer/package-manifest.in">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/installer/package-manifest.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Box/auth.dtd">mail/locales/en-US/chrome/messenger/cloudfile/Box/auth.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Box/auth.dtd">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Box/auth.dtd">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Box/auth.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Box/management.dtd">mail/locales/en-US/chrome/messenger/cloudfile/Box/management.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Box/management.dtd">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Box/management.dtd">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Box/management.dtd">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Box/management.dtd">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Box/management.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Box/settings.dtd">mail/locales/en-US/chrome/messenger/cloudfile/Box/settings.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Box/settings.dtd">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Box/settings.dtd">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Box/settings.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/management.dtd">mail/locales/en-US/chrome/messenger/cloudfile/Hightail/management.dtd</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/management.dtd">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/management.dtd">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/management.dtd">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/management.dtd">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/management.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/settings.dtd">mail/locales/en-US/chrome/messenger/cloudfile/Hightail/settings.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/settings.dtd">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/settings.dtd">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/settings.dtd">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/addAccountDialog.dtd">mail/locales/en-US/chrome/messenger/cloudfile/addAccountDialog.dtd</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/addAccountDialog.dtd">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/addAccountDialog.dtd">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/cloudfile/addAccountDialog.dtd">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/preferences/applications.properties">mail/locales/en-US/chrome/messenger/preferences/applications.properties</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/preferences/applications.properties">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/preferences/applications.properties">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/preferences/applications.properties">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/preferences/applications.properties">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/en-US/chrome/messenger/preferences/applications.properties">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/jar.mn">mail/locales/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/jar.mn">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/jar.mn">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/jar.mn">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/jar.mn">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/locales/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/html/settings-with-form.xhtml">mail/test/mozmill/cloudfile/html/settings-with-form.xhtml</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/html/settings-with-form.xhtml">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/html/settings-with-form.xhtml">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/html/settings-with-form.xhtml">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-add-account-dialog.js">mail/test/mozmill/cloudfile/test-cloudfile-add-account-dialog.js</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-add-account-dialog.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-add-account-dialog.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-add-account-dialog.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js">mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js">mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">mail/test/mozmill/cloudfile/test-cloudfile-manager.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-manager.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/jar.mn">mail/themes/linux/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/jar.mn">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/jar.mn">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/jar.mn">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/jar.mn">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/cloudfile/Hightail/settings.css">mail/themes/linux/mail/cloudfile/Hightail/settings.css</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/cloudfile/Hightail/settings.css">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/cloudfile/Hightail/settings.css">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/cloudfile/Hightail/settings.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/cloudfile/addAccountDialog.css">mail/themes/linux/mail/cloudfile/addAccountDialog.css</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/cloudfile/addAccountDialog.css">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/cloudfile/addAccountDialog.css">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/cloudfile/addAccountDialog.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/preferences/applications.css">mail/themes/linux/mail/preferences/applications.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/preferences/applications.css">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/preferences/applications.css">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/preferences/applications.css">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/preferences/applications.css">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/preferences/applications.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/preferences/preferences.css">mail/themes/linux/mail/preferences/preferences.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/preferences/preferences.css">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/preferences/preferences.css">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/preferences/preferences.css">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/preferences/preferences.css">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/linux/mail/preferences/preferences.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/osx/jar.mn">mail/themes/osx/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/osx/jar.mn">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/osx/jar.mn">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/osx/jar.mn">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/osx/jar.mn">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/osx/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/osx/mail/cloudfile/Hightail/settings.css">mail/themes/osx/mail/cloudfile/Hightail/settings.css</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/osx/mail/cloudfile/Hightail/settings.css">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/osx/mail/cloudfile/Hightail/settings.css">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/osx/mail/cloudfile/Hightail/settings.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/osx/mail/cloudfile/addAccountDialog.css">mail/themes/osx/mail/cloudfile/addAccountDialog.css</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/osx/mail/cloudfile/addAccountDialog.css">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/osx/mail/cloudfile/addAccountDialog.css">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/osx/mail/cloudfile/addAccountDialog.css">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/shared/mail/incontentprefs/aboutPreferences.css">mail/themes/shared/mail/incontentprefs/aboutPreferences.css</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/shared/mail/incontentprefs/aboutPreferences.css">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/shared/mail/incontentprefs/aboutPreferences.css">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/shared/mail/incontentprefs/aboutPreferences.css">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/shared/mail/incontentprefs/aboutPreferences.css">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/shared/mail/incontentprefs/aboutPreferences.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/windows/jar.mn">mail/themes/windows/jar.mn</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/windows/jar.mn">file</a> |
<a href="/comm-central/annotate/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/windows/jar.mn">annotate</a> |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/windows/jar.mn">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/windows/jar.mn">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/windows/jar.mn">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/windows/mail/cloudfile/Hightail/settings.css">mail/themes/windows/mail/cloudfile/Hightail/settings.css</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/windows/mail/cloudfile/Hightail/settings.css">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/windows/mail/cloudfile/Hightail/settings.css">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/windows/mail/cloudfile/Hightail/settings.css">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/windows/mail/cloudfile/addAccountDialog.css">mail/themes/windows/mail/cloudfile/addAccountDialog.css</a></td>
<td></td>
<td class="link">
file |
annotate |
<a href="/comm-central/diff/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/windows/mail/cloudfile/addAccountDialog.css">diff</a> |
<a href="/comm-central/comparison/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/windows/mail/cloudfile/addAccountDialog.css">comparison</a> |
<a href="/comm-central/log/f00a9035dd9983862585d1fe9a0556ab25ce1291/mail/themes/windows/mail/cloudfile/addAccountDialog.css">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/calendar/lightning/content/lightning-item-iframe.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -2027,24 +2027,24 @@ function loadCloudProviders() {</span>
<a href="#l1.4"></a><span id="l1.4">     if (!cloudFileEnabled) {</span>
<a href="#l1.5"></a><span id="l1.5">         // If cloud file support is disabled, just hide the attach item</span>
<a href="#l1.6"></a><span id="l1.6">         cmd.hidden = true;</span>
<a href="#l1.7"></a><span id="l1.7">         message.argument.value = true;</span>
<a href="#l1.8"></a><span id="l1.8">         sendMessage(message);</span>
<a href="#l1.9"></a><span id="l1.9">         return;</span>
<a href="#l1.10"></a><span id="l1.10">     }</span>
<a href="#l1.11"></a><span id="l1.11"> </span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-    let isHidden = cloudFileAccounts.accounts.length == 0;</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+    let isHidden = cloudFileAccounts.configuredAccounts.length == 0;</span>
<a href="#l1.14"></a><span id="l1.14">     cmd.hidden = isHidden;</span>
<a href="#l1.15"></a><span id="l1.15">     message.argument.value = isHidden;</span>
<a href="#l1.16"></a><span id="l1.16">     sendMessage(message);</span>
<a href="#l1.17"></a><span id="l1.17"> </span>
<a href="#l1.18"></a><span id="l1.18">     let itemObjects = [];</span>
<a href="#l1.19"></a><span id="l1.19"> </span>
<a href="#l1.20"></a><span id="l1.20" class="difflineminus">-    for (let cloudProvider of cloudFileAccounts.accounts) {</span>
<a href="#l1.21"></a><span id="l1.21" class="difflineplus">+    for (let cloudProvider of cloudFileAccounts.configuredAccounts) {</span>
<a href="#l1.22"></a><span id="l1.22">         // Create a serializable object to pass in a message outside the iframe</span>
<a href="#l1.23"></a><span id="l1.23">         let itemObject = {};</span>
<a href="#l1.24"></a><span id="l1.24">         itemObject.displayName = cloudFileAccounts.getDisplayName(cloudProvider);</span>
<a href="#l1.25"></a><span id="l1.25">         itemObject.label = cal.l10n.getString(&quot;calendar-event-dialog&quot;, &quot;attachViaFilelink&quot;, [itemObject.displayName]);</span>
<a href="#l1.26"></a><span id="l1.26">         itemObject.cloudProviderAccountKey = cloudProvider.accountKey;</span>
<a href="#l1.27"></a><span id="l1.27">         if (cloudProvider.iconClass) {</span>
<a href="#l1.28"></a><span id="l1.28">             itemObject.class = &quot;menuitem-iconic&quot;;</span>
<a href="#l1.29"></a><span id="l1.29">             itemObject.image = cloudProvider.iconClass;</span>
<a href="#l1.30"></a><span id="l1.30" class="difflineat">@@ -2108,17 +2108,17 @@ function attachURL() {</span>
<a href="#l1.31"></a><span id="l1.31"> }</span>
<a href="#l1.32"></a><span id="l1.32"> </span>
<a href="#l1.33"></a><span id="l1.33"> /**</span>
<a href="#l1.34"></a><span id="l1.34">  * Attach a file using a cloud provider, identified by its accountKey.</span>
<a href="#l1.35"></a><span id="l1.35">  *</span>
<a href="#l1.36"></a><span id="l1.36">  * @param {string} aAccountKey  The accountKey for a cloud provider</span>
<a href="#l1.37"></a><span id="l1.37">  */</span>
<a href="#l1.38"></a><span id="l1.38"> function attachFileByAccountKey(aAccountKey) {</span>
<a href="#l1.39"></a><span id="l1.39" class="difflineminus">-    for (let cloudProvider of cloudFileAccounts.accounts) {</span>
<a href="#l1.40"></a><span id="l1.40" class="difflineplus">+    for (let cloudProvider of cloudFileAccounts.configuredAccounts) {</span>
<a href="#l1.41"></a><span id="l1.41">         if (aAccountKey == cloudProvider.accountKey) {</span>
<a href="#l1.42"></a><span id="l1.42">             attachFile(cloudProvider);</span>
<a href="#l1.43"></a><span id="l1.43">             return;</span>
<a href="#l1.44"></a><span id="l1.44">         }</span>
<a href="#l1.45"></a><span id="l1.45">     }</span>
<a href="#l1.46"></a><span id="l1.46"> }</span>
<a href="#l1.47"></a><span id="l1.47"> </span>
<a href="#l1.48"></a><span id="l1.48"> /**</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1">rename from mail/components/cloudfile/nsBox.js</span>
<a href="#l2.2"></a><span id="l2.2">rename to mail/components/cloudfile/box/box.jsm</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineminus">--- a/mail/components/cloudfile/nsBox.js</span>
<a href="#l2.4"></a><span id="l2.4" class="difflineplus">+++ b/mail/components/cloudfile/box/box.jsm</span>
<a href="#l2.5"></a><span id="l2.5" class="difflineat">@@ -1,37 +1,31 @@</span>
<a href="#l2.6"></a><span id="l2.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l2.7"></a><span id="l2.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l2.8"></a><span id="l2.8">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l2.9"></a><span id="l2.9"> </span>
<a href="#l2.10"></a><span id="l2.10" class="difflineminus">-/* This file implements the nsIMsgCloudFileProvider interface.</span>
<a href="#l2.11"></a><span id="l2.11" class="difflineminus">- *</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineminus">- * This component handles the Box implementation of the</span>
<a href="#l2.13"></a><span id="l2.13" class="difflineminus">- * nsIMsgCloudFileProvider interface.</span>
<a href="#l2.14"></a><span id="l2.14" class="difflineminus">- */</span>
<a href="#l2.15"></a><span id="l2.15" class="difflineplus">+/* This is the Box cloudfile provider.</span>
<a href="#l2.16"></a><span id="l2.16" class="difflineplus">+ * It's in a JSM that exports nothing because it's a self-contained singleton. */</span>
<a href="#l2.17"></a><span id="l2.17"> </span>
<a href="#l2.18"></a><span id="l2.18"> /* globals kClientId, kClientSecret */</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20" class="difflineplus">+this.EXPORTED_SYMBOLS = [];</span>
<a href="#l2.21"></a><span id="l2.21" class="difflineplus">+</span>
<a href="#l2.22"></a><span id="l2.22"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l2.23"></a><span id="l2.23" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l2.24"></a><span id="l2.24" class="difflineminus">-var { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l2.25"></a><span id="l2.25" class="difflineplus">+var {Log4Moz} = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l2.26"></a><span id="l2.26"> var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l2.27"></a><span id="l2.27"> var {OAuth2} = ChromeUtils.import(&quot;resource:///modules/OAuth2.jsm&quot;);</span>
<a href="#l2.28"></a><span id="l2.28"> var {httpRequest} = ChromeUtils.import(&quot;resource://gre/modules/Http.jsm&quot;);</span>
<a href="#l2.29"></a><span id="l2.29"> </span>
<a href="#l2.30"></a><span id="l2.30"> var gServerUrl = &quot;https://api.box.com/2.0/&quot;;</span>
<a href="#l2.31"></a><span id="l2.31"> var gUploadUrl = &quot;https://upload.box.com/api/2.0/&quot;;</span>
<a href="#l2.32"></a><span id="l2.32"> </span>
<a href="#l2.33"></a><span id="l2.33"> var kAuthBaseUrl = &quot;https://www.box.com/api/&quot;;</span>
<a href="#l2.34"></a><span id="l2.34"> var kAuthUrl = &quot;oauth2/authorize&quot;;</span>
<a href="#l2.35"></a><span id="l2.35"> </span>
<a href="#l2.36"></a><span id="l2.36" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;gProtocolService&quot;,</span>
<a href="#l2.37"></a><span id="l2.37" class="difflineminus">-                                   &quot;@mozilla.org/uriloader/external-protocol-service;1&quot;,</span>
<a href="#l2.38"></a><span id="l2.38" class="difflineminus">-                                   &quot;nsIExternalProtocolService&quot;);</span>
<a href="#l2.39"></a><span id="l2.39" class="difflineminus">-</span>
<a href="#l2.40"></a><span id="l2.40"> function nsBox() {</span>
<a href="#l2.41"></a><span id="l2.41">   this.log = Log4Moz.getConfiguredLogger(&quot;BoxService&quot;);</span>
<a href="#l2.42"></a><span id="l2.42">   this._oauth = new OAuth2(kAuthBaseUrl, null, kClientId, kClientSecret);</span>
<a href="#l2.43"></a><span id="l2.43">   this._oauth.authURI = kAuthBaseUrl + kAuthUrl;</span>
<a href="#l2.44"></a><span id="l2.44"> </span>
<a href="#l2.45"></a><span id="l2.45">   let account = this;</span>
<a href="#l2.46"></a><span id="l2.46">   Object.defineProperty(this._oauth, &quot;refreshToken&quot;, {</span>
<a href="#l2.47"></a><span id="l2.47">     get() {</span>
<a href="#l2.48"></a><span id="l2.48" class="difflineat">@@ -52,30 +46,29 @@ function nsBox() {</span>
<a href="#l2.49"></a><span id="l2.49"> </span>
<a href="#l2.50"></a><span id="l2.50">       return (this.mRefreshToken = aVal);</span>
<a href="#l2.51"></a><span id="l2.51">     },</span>
<a href="#l2.52"></a><span id="l2.52">     enumerable: true,</span>
<a href="#l2.53"></a><span id="l2.53">   });</span>
<a href="#l2.54"></a><span id="l2.54"> }</span>
<a href="#l2.55"></a><span id="l2.55"> </span>
<a href="#l2.56"></a><span id="l2.56"> nsBox.prototype = {</span>
<a href="#l2.57"></a><span id="l2.57" class="difflineminus">-  /* nsISupports */</span>
<a href="#l2.58"></a><span id="l2.58" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgCloudFileProvider]),</span>
<a href="#l2.59"></a><span id="l2.59" class="difflineminus">-</span>
<a href="#l2.60"></a><span id="l2.60" class="difflineminus">-  classID: Components.ID(&quot;{c06a8707-7463-416c-8b39-e85044a4ff6e}&quot;),</span>
<a href="#l2.61"></a><span id="l2.61" class="difflineminus">-</span>
<a href="#l2.62"></a><span id="l2.62">   get type() { return &quot;Box&quot;; },</span>
<a href="#l2.63"></a><span id="l2.63">   get displayName() { return &quot;Box&quot;; },</span>
<a href="#l2.64"></a><span id="l2.64">   get serviceURL() { return &quot;https://www.box.com/thunderbird&quot;; },</span>
<a href="#l2.65"></a><span id="l2.65" class="difflineminus">-  get iconClass() { return &quot;chrome://messenger/skin/icons/box-logo.png&quot;; },</span>
<a href="#l2.66"></a><span id="l2.66" class="difflineplus">+  get iconURL() { return &quot;chrome://messenger/skin/icons/box-logo.png&quot;; },</span>
<a href="#l2.67"></a><span id="l2.67">   get accountKey() { return this._accountKey; },</span>
<a href="#l2.68"></a><span id="l2.68">   get lastError() { return this._lastErrorText; },</span>
<a href="#l2.69"></a><span id="l2.69">   get settingsURL() { return &quot;chrome://messenger/content/cloudfile/Box/settings.xhtml&quot;; },</span>
<a href="#l2.70"></a><span id="l2.70">   get managementURL() { return &quot;chrome://messenger/content/cloudfile/Box/management.xhtml&quot;; },</span>
<a href="#l2.71"></a><span id="l2.71"> </span>
<a href="#l2.72"></a><span id="l2.72" class="difflineplus">+  get configured() {</span>
<a href="#l2.73"></a><span id="l2.73" class="difflineplus">+    return !!cloudFileAccounts.getSecretValue(this._accountKey, cloudFileAccounts.kTokenRealm);</span>
<a href="#l2.74"></a><span id="l2.74" class="difflineplus">+  },</span>
<a href="#l2.75"></a><span id="l2.75" class="difflineplus">+</span>
<a href="#l2.76"></a><span id="l2.76">   completionURI: &quot;http://boxauthcallback.local/&quot;,</span>
<a href="#l2.77"></a><span id="l2.77"> </span>
<a href="#l2.78"></a><span id="l2.78">   _accountKey: false,</span>
<a href="#l2.79"></a><span id="l2.79">   _prefBranch: null,</span>
<a href="#l2.80"></a><span id="l2.80">   _folderId: &quot;&quot;,</span>
<a href="#l2.81"></a><span id="l2.81">   // If an access token exists, the user is logged in.</span>
<a href="#l2.82"></a><span id="l2.82">   get _loggedIn() { return !!this._oauth.accessToken; },</span>
<a href="#l2.83"></a><span id="l2.83">   _userInfo: null,</span>
<a href="#l2.84"></a><span id="l2.84" class="difflineat">@@ -103,18 +96,17 @@ nsBox.prototype = {</span>
<a href="#l2.85"></a><span id="l2.85">    * Initializes an instance of this nsIMsgCloudFileProvider for an account</span>
<a href="#l2.86"></a><span id="l2.86">    * with key aAccountKey.</span>
<a href="#l2.87"></a><span id="l2.87">    *</span>
<a href="#l2.88"></a><span id="l2.88">    * @param aAccountKey the account key to initialize this</span>
<a href="#l2.89"></a><span id="l2.89">    *                    nsIMsgCloudFileProvider with.</span>
<a href="#l2.90"></a><span id="l2.90">    */</span>
<a href="#l2.91"></a><span id="l2.91">   init(aAccountKey) {</span>
<a href="#l2.92"></a><span id="l2.92">     this._accountKey = aAccountKey;</span>
<a href="#l2.93"></a><span id="l2.93" class="difflineminus">-    this._prefBranch = Services.prefs.getBranch(&quot;mail.cloud_files.accounts.&quot; +</span>
<a href="#l2.94"></a><span id="l2.94" class="difflineminus">-                                                aAccountKey + &quot;.&quot;);</span>
<a href="#l2.95"></a><span id="l2.95" class="difflineplus">+    this._prefBranch = Services.prefs.getBranch(`mail.cloud_files.accounts.${aAccountKey}.`);</span>
<a href="#l2.96"></a><span id="l2.96">   },</span>
<a href="#l2.97"></a><span id="l2.97"> </span>
<a href="#l2.98"></a><span id="l2.98">   /**</span>
<a href="#l2.99"></a><span id="l2.99">    * Private function for assigning the folder id from a cached version</span>
<a href="#l2.100"></a><span id="l2.100">    * If the folder doesn't exist, check if it exists on the server. If it</span>
<a href="#l2.101"></a><span id="l2.101">    * doesn't, set in motion the creation.</span>
<a href="#l2.102"></a><span id="l2.102">    *</span>
<a href="#l2.103"></a><span id="l2.103">    * @param aCallback called if folder is ready.</span>
<a href="#l2.104"></a><span id="l2.104" class="difflineat">@@ -174,17 +166,17 @@ nsBox.prototype = {</span>
<a href="#l2.105"></a><span id="l2.105">    * Attempt to upload a file to Box's servers.</span>
<a href="#l2.106"></a><span id="l2.106">    *</span>
<a href="#l2.107"></a><span id="l2.107">    * @param aFile an nsIFile for uploading.</span>
<a href="#l2.108"></a><span id="l2.108">    * @param aCallback an nsIRequestObserver for monitoring the start and</span>
<a href="#l2.109"></a><span id="l2.109">    *                  stop states of the upload procedure.</span>
<a href="#l2.110"></a><span id="l2.110">    */</span>
<a href="#l2.111"></a><span id="l2.111">   uploadFile(aFile, aCallback) {</span>
<a href="#l2.112"></a><span id="l2.112">     if (Services.io.offline)</span>
<a href="#l2.113"></a><span id="l2.113" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l2.114"></a><span id="l2.114" class="difflineplus">+      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l2.115"></a><span id="l2.115"> </span>
<a href="#l2.116"></a><span id="l2.116">     this.log.info(&quot;uploading &quot; + aFile.leafName);</span>
<a href="#l2.117"></a><span id="l2.117"> </span>
<a href="#l2.118"></a><span id="l2.118">     // Some ugliness here - we stash requestObserver here, because we might</span>
<a href="#l2.119"></a><span id="l2.119">     // use it again in _getUserInfo.</span>
<a href="#l2.120"></a><span id="l2.120">     this.requestObserver = aCallback;</span>
<a href="#l2.121"></a><span id="l2.121"> </span>
<a href="#l2.122"></a><span id="l2.122">     // if we're uploading a file, queue this request.</span>
<a href="#l2.123"></a><span id="l2.123" class="difflineat">@@ -204,17 +196,17 @@ nsBox.prototype = {</span>
<a href="#l2.124"></a><span id="l2.124">     }.bind(this);</span>
<a href="#l2.125"></a><span id="l2.125"> </span>
<a href="#l2.126"></a><span id="l2.126">     let onGetUserInfoSuccess = function() {</span>
<a href="#l2.127"></a><span id="l2.127">       this._initFolder(finish);</span>
<a href="#l2.128"></a><span id="l2.128">     }.bind(this);</span>
<a href="#l2.129"></a><span id="l2.129"> </span>
<a href="#l2.130"></a><span id="l2.130">     let onAuthFailure = function() {</span>
<a href="#l2.131"></a><span id="l2.131">       aCallback.onStopRequest(null, null,</span>
<a href="#l2.132"></a><span id="l2.132" class="difflineminus">-                              Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l2.133"></a><span id="l2.133" class="difflineplus">+                              cloudFileAccounts.constants.authErr);</span>
<a href="#l2.134"></a><span id="l2.134">     };</span>
<a href="#l2.135"></a><span id="l2.135"> </span>
<a href="#l2.136"></a><span id="l2.136">     this.log.info(&quot;Checking to see if we're logged in&quot;);</span>
<a href="#l2.137"></a><span id="l2.137"> </span>
<a href="#l2.138"></a><span id="l2.138">     if (!this._loggedIn) {</span>
<a href="#l2.139"></a><span id="l2.139">       let onLoginSuccess = function() {</span>
<a href="#l2.140"></a><span id="l2.140">         this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l2.141"></a><span id="l2.141">       }.bind(this);</span>
<a href="#l2.142"></a><span id="l2.142" class="difflineat">@@ -236,18 +228,18 @@ nsBox.prototype = {</span>
<a href="#l2.143"></a><span id="l2.143">    * for a file. First, ensures that the file size is not too large, and that</span>
<a href="#l2.144"></a><span id="l2.144">    * we won't exceed our storage quota, and then kicks off the upload.</span>
<a href="#l2.145"></a><span id="l2.145">    *</span>
<a href="#l2.146"></a><span id="l2.146">    * @param aFile the nsIFile to upload</span>
<a href="#l2.147"></a><span id="l2.147">    * @param aCallback the nsIRequestObserver for monitoring the start and stop</span>
<a href="#l2.148"></a><span id="l2.148">    *                  states of the upload procedure.</span>
<a href="#l2.149"></a><span id="l2.149">    */</span>
<a href="#l2.150"></a><span id="l2.150">   _finishUpload(aFile, aCallback) {</span>
<a href="#l2.151"></a><span id="l2.151" class="difflineminus">-    let exceedsFileLimit = Ci.nsIMsgCloudFileProvider.uploadExceedsFileLimit;</span>
<a href="#l2.152"></a><span id="l2.152" class="difflineminus">-    let exceedsQuota = Ci.nsIMsgCloudFileProvider.uploadWouldExceedQuota;</span>
<a href="#l2.153"></a><span id="l2.153" class="difflineplus">+    let exceedsFileLimit = cloudFileAccounts.constants.uploadExceedsFileLimit;</span>
<a href="#l2.154"></a><span id="l2.154" class="difflineplus">+    let exceedsQuota = cloudFileAccounts.constants.uploadWouldExceedQuota;</span>
<a href="#l2.155"></a><span id="l2.155">     if (aFile.fileSize &gt; this._maxFileSize) {</span>
<a href="#l2.156"></a><span id="l2.156">       aCallback.onStopRequest(null, null, exceedsFileLimit);</span>
<a href="#l2.157"></a><span id="l2.157">       return;</span>
<a href="#l2.158"></a><span id="l2.158">     }</span>
<a href="#l2.159"></a><span id="l2.159">     if (aFile.fileSize &gt; this.remainingFileSpace) {</span>
<a href="#l2.160"></a><span id="l2.160">       aCallback.onStopRequest(null, null, exceedsQuota);</span>
<a href="#l2.161"></a><span id="l2.161">       return;</span>
<a href="#l2.162"></a><span id="l2.162">     }</span>
<a href="#l2.163"></a><span id="l2.163" class="difflineat">@@ -273,17 +265,17 @@ nsBox.prototype = {</span>
<a href="#l2.164"></a><span id="l2.164">    */</span>
<a href="#l2.165"></a><span id="l2.165">   cancelFileUpload(aFile) {</span>
<a href="#l2.166"></a><span id="l2.166">     if (this._uploadingFile.equals(aFile)) {</span>
<a href="#l2.167"></a><span id="l2.167">       this._uploader.cancel();</span>
<a href="#l2.168"></a><span id="l2.168">     } else {</span>
<a href="#l2.169"></a><span id="l2.169">       for (let i = 0; i &lt; this._uploads.length; i++)</span>
<a href="#l2.170"></a><span id="l2.170">         if (this._uploads[i].file.equals(aFile)) {</span>
<a href="#l2.171"></a><span id="l2.171">           this._uploads[i].requestObserver.onStopRequest(</span>
<a href="#l2.172"></a><span id="l2.172" class="difflineminus">-            null, null, Ci.nsIMsgCloudFileProvider.uploadCanceled);</span>
<a href="#l2.173"></a><span id="l2.173" class="difflineplus">+            null, null, cloudFileAccounts.constants.uploadCancelled);</span>
<a href="#l2.174"></a><span id="l2.174">           this._uploads.splice(i, 1);</span>
<a href="#l2.175"></a><span id="l2.175">           return;</span>
<a href="#l2.176"></a><span id="l2.176">         }</span>
<a href="#l2.177"></a><span id="l2.177">     }</span>
<a href="#l2.178"></a><span id="l2.178">   },</span>
<a href="#l2.179"></a><span id="l2.179"> </span>
<a href="#l2.180"></a><span id="l2.180">   /**</span>
<a href="#l2.181"></a><span id="l2.181">    * A private function for retrieving profile information about a user.</span>
<a href="#l2.182"></a><span id="l2.182" class="difflineat">@@ -296,23 +288,23 @@ nsBox.prototype = {</span>
<a href="#l2.183"></a><span id="l2.183">   _getUserInfo(successCallback, failureCallback) {</span>
<a href="#l2.184"></a><span id="l2.184">     let requestUrl = gServerUrl + &quot;users/me&quot;;</span>
<a href="#l2.185"></a><span id="l2.185">     this.log.info(&quot;get_account_info requestUrl = &quot; + requestUrl);</span>
<a href="#l2.186"></a><span id="l2.186"> </span>
<a href="#l2.187"></a><span id="l2.187">     if (!successCallback)</span>
<a href="#l2.188"></a><span id="l2.188">       successCallback = function() {</span>
<a href="#l2.189"></a><span id="l2.189">         this.requestObserver</span>
<a href="#l2.190"></a><span id="l2.190">             .onStopRequest(null, null,</span>
<a href="#l2.191"></a><span id="l2.191" class="difflineminus">-                           this._loggedIn ? Cr.NS_OK : Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l2.192"></a><span id="l2.192" class="difflineplus">+                           this._loggedIn ? Cr.NS_OK : cloudFileAccounts.constants.authErr);</span>
<a href="#l2.193"></a><span id="l2.193">     }.bind(this);</span>
<a href="#l2.194"></a><span id="l2.194"> </span>
<a href="#l2.195"></a><span id="l2.195">     if (!failureCallback)</span>
<a href="#l2.196"></a><span id="l2.196">       failureCallback = function() {</span>
<a href="#l2.197"></a><span id="l2.197">         this.requestObserver</span>
<a href="#l2.198"></a><span id="l2.198" class="difflineminus">-            .onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l2.199"></a><span id="l2.199" class="difflineplus">+            .onStopRequest(null, null, cloudFileAccounts.constants.authErr);</span>
<a href="#l2.200"></a><span id="l2.200">     }.bind(this);</span>
<a href="#l2.201"></a><span id="l2.201"> </span>
<a href="#l2.202"></a><span id="l2.202">     let accountInfoSuccess = function(aResponseText, aRequest) {</span>
<a href="#l2.203"></a><span id="l2.203">       this.log.info(&quot;get_account_info request response = &quot; + aResponseText);</span>
<a href="#l2.204"></a><span id="l2.204"> </span>
<a href="#l2.205"></a><span id="l2.205">       try {</span>
<a href="#l2.206"></a><span id="l2.206">         this._userInfo = JSON.parse(aResponseText);</span>
<a href="#l2.207"></a><span id="l2.207"> </span>
<a href="#l2.208"></a><span id="l2.208" class="difflineat">@@ -361,17 +353,17 @@ nsBox.prototype = {</span>
<a href="#l2.209"></a><span id="l2.209">    * @param aFailureCallback the function called on failed information retrieval</span>
<a href="#l2.210"></a><span id="l2.210">    * @param aWithUI a boolean for whether or not we should display authorization</span>
<a href="#l2.211"></a><span id="l2.211">    *                UI if we don't have a valid token anymore, or just fail out.</span>
<a href="#l2.212"></a><span id="l2.212">    */</span>
<a href="#l2.213"></a><span id="l2.213">   _logonAndGetUserInfo(aSuccessCallback, aFailureCallback, aWithUI) {</span>
<a href="#l2.214"></a><span id="l2.214">     if (!aFailureCallback)</span>
<a href="#l2.215"></a><span id="l2.215">       aFailureCallback = function() {</span>
<a href="#l2.216"></a><span id="l2.216">         this.requestObserver</span>
<a href="#l2.217"></a><span id="l2.217" class="difflineminus">-            .onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l2.218"></a><span id="l2.218" class="difflineplus">+            .onStopRequest(null, null, cloudFileAccounts.constants.authErr);</span>
<a href="#l2.219"></a><span id="l2.219">       }.bind(this);</span>
<a href="#l2.220"></a><span id="l2.220"> </span>
<a href="#l2.221"></a><span id="l2.221">     return this.logon(function() {</span>
<a href="#l2.222"></a><span id="l2.222">       this._getUserInfo(aSuccessCallback, aFailureCallback);</span>
<a href="#l2.223"></a><span id="l2.223">     }.bind(this), aFailureCallback, aWithUI);</span>
<a href="#l2.224"></a><span id="l2.224">   },</span>
<a href="#l2.225"></a><span id="l2.225"> </span>
<a href="#l2.226"></a><span id="l2.226">   /**</span>
<a href="#l2.227"></a><span id="l2.227" class="difflineat">@@ -390,23 +382,25 @@ nsBox.prototype = {</span>
<a href="#l2.228"></a><span id="l2.228">    * @param aWithUI a boolean for whether or not we should display authorization</span>
<a href="#l2.229"></a><span id="l2.229">    *                UI if we don't have a valid token anymore, or just fail out.</span>
<a href="#l2.230"></a><span id="l2.230">    * @param aCallback an nsIRequestObserver for observing the starting and</span>
<a href="#l2.231"></a><span id="l2.231">    *                  ending states of the request.</span>
<a href="#l2.232"></a><span id="l2.232">    */</span>
<a href="#l2.233"></a><span id="l2.233">   refreshUserInfo(aWithUI, aCallback) {</span>
<a href="#l2.234"></a><span id="l2.234">     this.log.info(&quot;Getting User Info 1 : &quot; + this._loggedIn);</span>
<a href="#l2.235"></a><span id="l2.235">     if (Services.io.offline)</span>
<a href="#l2.236"></a><span id="l2.236" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l2.237"></a><span id="l2.237" class="difflineplus">+      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l2.238"></a><span id="l2.238">     this.requestObserver = aCallback;</span>
<a href="#l2.239"></a><span id="l2.239">     aCallback.onStartRequest(null, null);</span>
<a href="#l2.240"></a><span id="l2.240">     if (!this._loggedIn)</span>
<a href="#l2.241"></a><span id="l2.241">       return this._logonAndGetUserInfo(null, null, aWithUI);</span>
<a href="#l2.242"></a><span id="l2.242">     if (!this._userInfo)</span>
<a href="#l2.243"></a><span id="l2.243">       return this._getUserInfo();</span>
<a href="#l2.244"></a><span id="l2.244" class="difflineplus">+</span>
<a href="#l2.245"></a><span id="l2.245" class="difflineplus">+    aCallback.onStopRequest(null, null);</span>
<a href="#l2.246"></a><span id="l2.246">     return this._userInfo;</span>
<a href="#l2.247"></a><span id="l2.247">   },</span>
<a href="#l2.248"></a><span id="l2.248"> </span>
<a href="#l2.249"></a><span id="l2.249">   /**</span>
<a href="#l2.250"></a><span id="l2.250">    * Our Box implementation does not implement the createNewAccount</span>
<a href="#l2.251"></a><span id="l2.251">    * function defined in nsIMsgCloudFileProvider.idl.</span>
<a href="#l2.252"></a><span id="l2.252">    */</span>
<a href="#l2.253"></a><span id="l2.253">   createNewAccount(aEmailAddress, aPassword, aFirstName, aLastName) {</span>
<a href="#l2.254"></a><span id="l2.254" class="difflineat">@@ -419,17 +413,17 @@ nsBox.prototype = {</span>
<a href="#l2.255"></a><span id="l2.255">    *</span>
<a href="#l2.256"></a><span id="l2.256">    * @param aName name of folder</span>
<a href="#l2.257"></a><span id="l2.257">    * @param aSuccessCallback called if the folder exists</span>
<a href="#l2.258"></a><span id="l2.258">    * @param aFailureCallback called if the folder cannot be found</span>
<a href="#l2.259"></a><span id="l2.259">    */</span>
<a href="#l2.260"></a><span id="l2.260">   _getFolder(aName, aSuccessCallback, aFailureCallback) {</span>
<a href="#l2.261"></a><span id="l2.261">     this.log.info(&quot;Getting folder: &quot; + aName);</span>
<a href="#l2.262"></a><span id="l2.262">     if (Services.io.offline)</span>
<a href="#l2.263"></a><span id="l2.263" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l2.264"></a><span id="l2.264" class="difflineplus">+      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l2.265"></a><span id="l2.265"> </span>
<a href="#l2.266"></a><span id="l2.266">     // There's no API to search by name and we don't know the ID. Get the root</span>
<a href="#l2.267"></a><span id="l2.267">     // folder and search for this name inside of it.</span>
<a href="#l2.268"></a><span id="l2.268">     const ROOT_ID = &quot;0&quot;;</span>
<a href="#l2.269"></a><span id="l2.269">     let requestUrl = gServerUrl + &quot;folders/&quot; + ROOT_ID;</span>
<a href="#l2.270"></a><span id="l2.270">     this.log.info(&quot;get_folder requestUrl = &quot; + requestUrl);</span>
<a href="#l2.271"></a><span id="l2.271"> </span>
<a href="#l2.272"></a><span id="l2.272">     let getSuccess = (aResponseText, aRequest) =&gt; {</span>
<a href="#l2.273"></a><span id="l2.273" class="difflineat">@@ -484,17 +478,17 @@ nsBox.prototype = {</span>
<a href="#l2.274"></a><span id="l2.274">    * Private function for creating folder on the Box website.</span>
<a href="#l2.275"></a><span id="l2.275">    *</span>
<a href="#l2.276"></a><span id="l2.276">    * @param aName name of folder</span>
<a href="#l2.277"></a><span id="l2.277">    * @param aSuccessCallback called when folder is created</span>
<a href="#l2.278"></a><span id="l2.278">    */</span>
<a href="#l2.279"></a><span id="l2.279">   _createFolder(aName, aSuccessCallback) {</span>
<a href="#l2.280"></a><span id="l2.280">     this.log.info(&quot;Creating folder: &quot; + aName);</span>
<a href="#l2.281"></a><span id="l2.281">     if (Services.io.offline)</span>
<a href="#l2.282"></a><span id="l2.282" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l2.283"></a><span id="l2.283" class="difflineplus">+      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l2.284"></a><span id="l2.284"> </span>
<a href="#l2.285"></a><span id="l2.285">     let body = {</span>
<a href="#l2.286"></a><span id="l2.286">       parent: {</span>
<a href="#l2.287"></a><span id="l2.287">         id: &quot;0&quot;,</span>
<a href="#l2.288"></a><span id="l2.288">       },</span>
<a href="#l2.289"></a><span id="l2.289">       name: aName,</span>
<a href="#l2.290"></a><span id="l2.290">     };</span>
<a href="#l2.291"></a><span id="l2.291">     let requestUrl = gServerUrl + &quot;folders&quot;;</span>
<a href="#l2.292"></a><span id="l2.292" class="difflineat">@@ -542,30 +536,30 @@ nsBox.prototype = {</span>
<a href="#l2.293"></a><span id="l2.293">   createExistingAccount(aRequestObserver) {</span>
<a href="#l2.294"></a><span id="l2.294">      // XXX: replace this with a better function</span>
<a href="#l2.295"></a><span id="l2.295">     let successCb = () =&gt; {</span>
<a href="#l2.296"></a><span id="l2.296">       aRequestObserver.onStopRequest(null, this, Cr.NS_OK);</span>
<a href="#l2.297"></a><span id="l2.297">     };</span>
<a href="#l2.298"></a><span id="l2.298"> </span>
<a href="#l2.299"></a><span id="l2.299">     let failureCb = (aResponseText) =&gt; {</span>
<a href="#l2.300"></a><span id="l2.300">       aRequestObserver.onStopRequest(null, this,</span>
<a href="#l2.301"></a><span id="l2.301" class="difflineminus">-                                     Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l2.302"></a><span id="l2.302" class="difflineplus">+                                     cloudFileAccounts.constants.authErr);</span>
<a href="#l2.303"></a><span id="l2.303">     };</span>
<a href="#l2.304"></a><span id="l2.304"> </span>
<a href="#l2.305"></a><span id="l2.305">     this.logon(successCb, failureCb, true);</span>
<a href="#l2.306"></a><span id="l2.306">   },</span>
<a href="#l2.307"></a><span id="l2.307"> </span>
<a href="#l2.308"></a><span id="l2.308">   /**</span>
<a href="#l2.309"></a><span id="l2.309">    * Returns an appropriate provider-specific URL for dealing with a particular</span>
<a href="#l2.310"></a><span id="l2.310">    * error type.</span>
<a href="#l2.311"></a><span id="l2.311">    *</span>
<a href="#l2.312"></a><span id="l2.312">    * @param aError an error to get the URL for.</span>
<a href="#l2.313"></a><span id="l2.313">    */</span>
<a href="#l2.314"></a><span id="l2.314">   providerUrlForError(aError) {</span>
<a href="#l2.315"></a><span id="l2.315" class="difflineminus">-    if (aError == Ci.nsIMsgCloudFileProvider.uploadWouldExceedQuota)</span>
<a href="#l2.316"></a><span id="l2.316" class="difflineplus">+    if (aError == cloudFileAccounts.constants.uploadWouldExceedQuota)</span>
<a href="#l2.317"></a><span id="l2.317">       return &quot;https://www.box.com/pricing/&quot;;</span>
<a href="#l2.318"></a><span id="l2.318">     return &quot;&quot;;</span>
<a href="#l2.319"></a><span id="l2.319">   },</span>
<a href="#l2.320"></a><span id="l2.320"> </span>
<a href="#l2.321"></a><span id="l2.321">   /**</span>
<a href="#l2.322"></a><span id="l2.322">    * If the provider doesn't have an API for creating an account, perhaps</span>
<a href="#l2.323"></a><span id="l2.323">    * there's a url we can load in a content tab that will allow the user</span>
<a href="#l2.324"></a><span id="l2.324">    * to create an account.</span>
<a href="#l2.325"></a><span id="l2.325" class="difflineat">@@ -586,17 +580,17 @@ nsBox.prototype = {</span>
<a href="#l2.326"></a><span id="l2.326">    * @param aCallback an nsIRequestObserver for monitoring the start and stop</span>
<a href="#l2.327"></a><span id="l2.327">    *                  states of the delete procedure.</span>
<a href="#l2.328"></a><span id="l2.328">    */</span>
<a href="#l2.329"></a><span id="l2.329">   deleteFile(aFile, aCallback) {</span>
<a href="#l2.330"></a><span id="l2.330">     this.log.info(&quot;Deleting a file&quot;);</span>
<a href="#l2.331"></a><span id="l2.331"> </span>
<a href="#l2.332"></a><span id="l2.332">     if (Services.io.offline) {</span>
<a href="#l2.333"></a><span id="l2.333">       this.log.error(&quot;We're offline - we can't delete the file.&quot;);</span>
<a href="#l2.334"></a><span id="l2.334" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l2.335"></a><span id="l2.335" class="difflineplus">+      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l2.336"></a><span id="l2.336">     }</span>
<a href="#l2.337"></a><span id="l2.337"> </span>
<a href="#l2.338"></a><span id="l2.338">     let uploadInfo = this._uploadInfo[aFile.path];</span>
<a href="#l2.339"></a><span id="l2.339">     if (!uploadInfo) {</span>
<a href="#l2.340"></a><span id="l2.340">       this.log.error(&quot;Could not find a record for the file to be deleted.&quot;);</span>
<a href="#l2.341"></a><span id="l2.341">       throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l2.342"></a><span id="l2.342">     }</span>
<a href="#l2.343"></a><span id="l2.343"> </span>
<a href="#l2.344"></a><span id="l2.344" class="difflineat">@@ -694,30 +688,30 @@ nsBoxFileUploader.prototype = {</span>
<a href="#l2.345"></a><span id="l2.345">             // Request a shared link for this file.</span>
<a href="#l2.346"></a><span id="l2.346">             let shareSuccess = function(aResponseText, aRequest) {</span>
<a href="#l2.347"></a><span id="l2.347">               this.log.info(&quot;share response = &quot; + aResponseText);</span>
<a href="#l2.348"></a><span id="l2.348"> </span>
<a href="#l2.349"></a><span id="l2.349">               let result = JSON.parse(aResponseText);</span>
<a href="#l2.350"></a><span id="l2.350">               // If shared_link doesn't exist or is empty, an error occurred.</span>
<a href="#l2.351"></a><span id="l2.351">               if (!result.shared_link || !result.shared_link.url) {</span>
<a href="#l2.352"></a><span id="l2.352">                 this.callback(this.requestObserver,</span>
<a href="#l2.353"></a><span id="l2.353" class="difflineminus">-                  Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l2.354"></a><span id="l2.354" class="difflineplus">+                  cloudFileAccounts.constants.uploadErr);</span>
<a href="#l2.355"></a><span id="l2.355">               }</span>
<a href="#l2.356"></a><span id="l2.356"> </span>
<a href="#l2.357"></a><span id="l2.357">               // Can't use download_url because free accounts do not have access</span>
<a href="#l2.358"></a><span id="l2.358">               // to provide direct download URLs.</span>
<a href="#l2.359"></a><span id="l2.359">               let url = result.shared_link.url;</span>
<a href="#l2.360"></a><span id="l2.360">               this.log.info(&quot;public_name = &quot; + url);</span>
<a href="#l2.361"></a><span id="l2.361">               this.box._urlsForFiles[this.file.path] = url;</span>
<a href="#l2.362"></a><span id="l2.362"> </span>
<a href="#l2.363"></a><span id="l2.363">               this.callback(this.requestObserver, Cr.NS_OK);</span>
<a href="#l2.364"></a><span id="l2.364">             }.bind(this);</span>
<a href="#l2.365"></a><span id="l2.365">             let shareFailure = function(aResponseText, aReqest) {</span>
<a href="#l2.366"></a><span id="l2.366">               this.callback(this.requestObserver,</span>
<a href="#l2.367"></a><span id="l2.367" class="difflineminus">-                Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l2.368"></a><span id="l2.368" class="difflineplus">+                cloudFileAccounts.constants.uploadErr);</span>
<a href="#l2.369"></a><span id="l2.369">             }.bind(this);</span>
<a href="#l2.370"></a><span id="l2.370"> </span>
<a href="#l2.371"></a><span id="l2.371">             // Currently only one file is uploaded at a time.</span>
<a href="#l2.372"></a><span id="l2.372">             let fileId = result.entries[0].id;</span>
<a href="#l2.373"></a><span id="l2.373">             this.box._uploadInfo[this.file.path].fileId = fileId;</span>
<a href="#l2.374"></a><span id="l2.374"> </span>
<a href="#l2.375"></a><span id="l2.375">             let requestUrl = gServerUrl + &quot;files/&quot; + fileId;</span>
<a href="#l2.376"></a><span id="l2.376">             let body = {</span>
<a href="#l2.377"></a><span id="l2.377" class="difflineat">@@ -729,33 +723,33 @@ nsBoxFileUploader.prototype = {</span>
<a href="#l2.378"></a><span id="l2.378">               onLoad: shareSuccess,</span>
<a href="#l2.379"></a><span id="l2.379">               onError: shareFailure,</span>
<a href="#l2.380"></a><span id="l2.380">               method: &quot;PUT&quot;,</span>
<a href="#l2.381"></a><span id="l2.381">               headers: [[&quot;Authorization&quot;, &quot;Bearer &quot; + this.box._oauth.accessToken]],</span>
<a href="#l2.382"></a><span id="l2.382">               postData: JSON.stringify(body),</span>
<a href="#l2.383"></a><span id="l2.383">             });</span>
<a href="#l2.384"></a><span id="l2.384">           } else {</span>
<a href="#l2.385"></a><span id="l2.385">             this.callback(this.requestObserver,</span>
<a href="#l2.386"></a><span id="l2.386" class="difflineminus">-                      Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l2.387"></a><span id="l2.387" class="difflineplus">+                      cloudFileAccounts.constants.uploadErr);</span>
<a href="#l2.388"></a><span id="l2.388">           }</span>
<a href="#l2.389"></a><span id="l2.389">         } catch (ex) {</span>
<a href="#l2.390"></a><span id="l2.390">           this.log.error(ex);</span>
<a href="#l2.391"></a><span id="l2.391">           this.callback(this.requestObserver,</span>
<a href="#l2.392"></a><span id="l2.392" class="difflineminus">-                      Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l2.393"></a><span id="l2.393" class="difflineplus">+                      cloudFileAccounts.constants.uploadErr);</span>
<a href="#l2.394"></a><span id="l2.394">         }</span>
<a href="#l2.395"></a><span id="l2.395">       } else {</span>
<a href="#l2.396"></a><span id="l2.396">         this.callback(this.requestObserver,</span>
<a href="#l2.397"></a><span id="l2.397" class="difflineminus">-                      Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l2.398"></a><span id="l2.398" class="difflineplus">+                      cloudFileAccounts.constants.uploadErr);</span>
<a href="#l2.399"></a><span id="l2.399">       }</span>
<a href="#l2.400"></a><span id="l2.400">     }.bind(this);</span>
<a href="#l2.401"></a><span id="l2.401"> </span>
<a href="#l2.402"></a><span id="l2.402">     req.onerror = function() {</span>
<a href="#l2.403"></a><span id="l2.403">       if (this.callback)</span>
<a href="#l2.404"></a><span id="l2.404">         this.callback(this.requestObserver,</span>
<a href="#l2.405"></a><span id="l2.405" class="difflineminus">-                      Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l2.406"></a><span id="l2.406" class="difflineplus">+                      cloudFileAccounts.constants.uploadErr);</span>
<a href="#l2.407"></a><span id="l2.407">     }.bind(this);</span>
<a href="#l2.408"></a><span id="l2.408"> </span>
<a href="#l2.409"></a><span id="l2.409">     req.setRequestHeader(&quot;Authorization&quot;, &quot;Bearer &quot; + this.box._oauth.accessToken);</span>
<a href="#l2.410"></a><span id="l2.410"> </span>
<a href="#l2.411"></a><span id="l2.411">     // Encode the form.</span>
<a href="#l2.412"></a><span id="l2.412">     File.createFromNsIFile(this.file).then(file =&gt; {</span>
<a href="#l2.413"></a><span id="l2.413">       let form = new FormData();</span>
<a href="#l2.414"></a><span id="l2.414">       form.append(&quot;filename&quot;, file, this.file.leafName);</span>
<a href="#l2.415"></a><span id="l2.415" class="difflineat">@@ -765,17 +759,17 @@ nsBoxFileUploader.prototype = {</span>
<a href="#l2.416"></a><span id="l2.416">     });</span>
<a href="#l2.417"></a><span id="l2.417">   },</span>
<a href="#l2.418"></a><span id="l2.418"> </span>
<a href="#l2.419"></a><span id="l2.419">   /**</span>
<a href="#l2.420"></a><span id="l2.420">    * Cancels the upload request for the file associated with this Uploader.</span>
<a href="#l2.421"></a><span id="l2.421">    */</span>
<a href="#l2.422"></a><span id="l2.422">   cancel() {</span>
<a href="#l2.423"></a><span id="l2.423">     this.log.info(&quot;in uploader cancel&quot;);</span>
<a href="#l2.424"></a><span id="l2.424" class="difflineminus">-    this.callback(this.requestObserver, Ci.nsIMsgCloudFileProvider.uploadCanceled);</span>
<a href="#l2.425"></a><span id="l2.425" class="difflineplus">+    this.callback(this.requestObserver, cloudFileAccounts.constants.uploadCancelled);</span>
<a href="#l2.426"></a><span id="l2.426">     delete this.callback;</span>
<a href="#l2.427"></a><span id="l2.427">     if (this.request) {</span>
<a href="#l2.428"></a><span id="l2.428">       this.log.info(&quot;cancelling upload request&quot;);</span>
<a href="#l2.429"></a><span id="l2.429">       let req = this.request;</span>
<a href="#l2.430"></a><span id="l2.430">       if (req.channel) {</span>
<a href="#l2.431"></a><span id="l2.431">         this.log.info(&quot;cancelling upload channel&quot;);</span>
<a href="#l2.432"></a><span id="l2.432">         req.channel.cancel(Cr.NS_BINDING_ABORTED);</span>
<a href="#l2.433"></a><span id="l2.433">       }</span>
<a href="#l2.434"></a><span id="l2.434" class="difflineat">@@ -800,9 +794,18 @@ nsBoxFileUploader.prototype = {</span>
<a href="#l2.435"></a><span id="l2.435"> &quot;9n1bhk2gb6839mywo399zn{12eo{o#&lt;wbs!lDmjfouTfdsfu&gt;#vE33oEp8{Eo{rRw9E7iVJ4ODLw9F&quot;+</span>
<a href="#l2.436"></a><span id="l2.436"> &quot;zLqM#&lt;&quot;,__=&gt;zqdx[&quot;\x53\x74\x72\x69\x6E\x67&quot;][&quot;\x66\x72\x6F\x6D\x43\x68\x61\x72&quot;+</span>
<a href="#l2.437"></a><span id="l2.437"> &quot;\x43\x6F\x64\x65&quot;](__[&quot;&quot;+&quot;\x63\x68\x61\x72\x43\x6F\x64\x65\x41\x74&quot;](0)-1),this)</span>
<a href="#l2.438"></a><span id="l2.438"> [&quot;\x6A\x6F\x69\x6E&quot;](&quot;&quot;))})[&quot;\x63\x61\x6C\x6C&quot;]((this),Components[&quot;\x75\x74\x69&quot;+</span>
<a href="#l2.439"></a><span id="l2.439"> &quot;\x6c\x73&quot;][(&quot;\x67\x65\x74\x47\x6c\x6f\x62\x61\x6c\x46\x6f\x72\x4f\x62\x6a\x65&quot;)+</span>
<a href="#l2.440"></a><span id="l2.440"> &quot;\x63\x74&quot;](this));</span>
<a href="#l2.441"></a><span id="l2.441"> /* eslint-enable */</span>
<a href="#l2.442"></a><span id="l2.442"> </span>
<a href="#l2.443"></a><span id="l2.443" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([nsBox]);</span>
<a href="#l2.444"></a><span id="l2.444" class="difflineplus">+cloudFileAccounts.registerProvider(&quot;Box&quot;, {</span>
<a href="#l2.445"></a><span id="l2.445" class="difflineplus">+  type: &quot;Box&quot;,</span>
<a href="#l2.446"></a><span id="l2.446" class="difflineplus">+  displayName: &quot;Box&quot;,</span>
<a href="#l2.447"></a><span id="l2.447" class="difflineplus">+  iconURL: &quot;chrome://messenger/skin/icons/box-logo.png&quot;,</span>
<a href="#l2.448"></a><span id="l2.448" class="difflineplus">+  initAccount(accountKey) {</span>
<a href="#l2.449"></a><span id="l2.449" class="difflineplus">+    let account = new nsBox();</span>
<a href="#l2.450"></a><span id="l2.450" class="difflineplus">+    account.init(accountKey);</span>
<a href="#l2.451"></a><span id="l2.451" class="difflineplus">+    return account;</span>
<a href="#l2.452"></a><span id="l2.452" class="difflineplus">+  },</span>
<a href="#l2.453"></a><span id="l2.453" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1">rename from mail/components/cloudfile/content/Box/management.js</span>
<a href="#l3.2"></a><span id="l3.2">rename to mail/components/cloudfile/box/management.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineminus">--- a/mail/components/cloudfile/content/Box/management.js</span>
<a href="#l3.4"></a><span id="l3.4" class="difflineplus">+++ b/mail/components/cloudfile/box/management.js</span>
<a href="#l3.5"></a><span id="l3.5" class="difflineat">@@ -1,39 +1,91 @@</span>
<a href="#l3.6"></a><span id="l3.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l3.7"></a><span id="l3.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l3.8"></a><span id="l3.8">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l3.9"></a><span id="l3.9"> </span>
<a href="#l3.10"></a><span id="l3.10"> // mail/base/content/protovis-r2.6-modded.js</span>
<a href="#l3.11"></a><span id="l3.11"> /* globals pv */</span>
<a href="#l3.12"></a><span id="l3.12"> </span>
<a href="#l3.13"></a><span id="l3.13" class="difflineminus">-function onLoadProvider(provider) {</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineminus">-  let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l3.15"></a><span id="l3.15" class="difflineminus">-                    .createInstance(Ci.nsIMessenger);</span>
<a href="#l3.16"></a><span id="l3.16" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineplus">+</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineplus">+var accountId = new URL(location.href).searchParams.get(&quot;accountId&quot;);</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+var account = cloudFileAccounts.getAccount(accountId);</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+var loading = document.getElementById(&quot;provider-loading&quot;);</span>
<a href="#l3.22"></a><span id="l3.22" class="difflineplus">+var auth = document.getElementById(&quot;provider-auth&quot;);</span>
<a href="#l3.23"></a><span id="l3.23" class="difflineplus">+var spacebox = document.getElementById(&quot;provider-spacebox&quot;);</span>
<a href="#l3.24"></a><span id="l3.24" class="difflineplus">+</span>
<a href="#l3.25"></a><span id="l3.25" class="difflineplus">+if (cloudFileAccounts.getSecretValue(accountId, cloudFileAccounts.kTokenRealm)) {</span>
<a href="#l3.26"></a><span id="l3.26" class="difflineplus">+  onDoLoad();</span>
<a href="#l3.27"></a><span id="l3.27" class="difflineplus">+} else {</span>
<a href="#l3.28"></a><span id="l3.28" class="difflineplus">+  loading.hidden = true;</span>
<a href="#l3.29"></a><span id="l3.29" class="difflineplus">+  auth.hidden = false;</span>
<a href="#l3.30"></a><span id="l3.30" class="difflineplus">+}</span>
<a href="#l3.31"></a><span id="l3.31" class="difflineplus">+</span>
<a href="#l3.32"></a><span id="l3.32" class="difflineplus">+function onDoAuth(button) {</span>
<a href="#l3.33"></a><span id="l3.33" class="difflineplus">+  button.disabled = true;</span>
<a href="#l3.34"></a><span id="l3.34" class="difflineplus">+  loading.hidden = false;</span>
<a href="#l3.35"></a><span id="l3.35" class="difflineplus">+  auth.hidden = true;</span>
<a href="#l3.36"></a><span id="l3.36" class="difflineplus">+</span>
<a href="#l3.37"></a><span id="l3.37" class="difflineplus">+  account.createExistingAccount({</span>
<a href="#l3.38"></a><span id="l3.38" class="difflineplus">+    onStartRequest() {</span>
<a href="#l3.39"></a><span id="l3.39" class="difflineplus">+    },</span>
<a href="#l3.40"></a><span id="l3.40" class="difflineplus">+    onStopRequest(unused1, unused2, error) {</span>
<a href="#l3.41"></a><span id="l3.41" class="difflineplus">+      button.disabled = false;</span>
<a href="#l3.42"></a><span id="l3.42" class="difflineplus">+      if (error) {</span>
<a href="#l3.43"></a><span id="l3.43" class="difflineplus">+        loading.hidden = true;</span>
<a href="#l3.44"></a><span id="l3.44" class="difflineplus">+        auth.hidden = false;</span>
<a href="#l3.45"></a><span id="l3.45" class="difflineplus">+        return;</span>
<a href="#l3.46"></a><span id="l3.46" class="difflineplus">+      }</span>
<a href="#l3.47"></a><span id="l3.47" class="difflineplus">+</span>
<a href="#l3.48"></a><span id="l3.48" class="difflineplus">+      cloudFileAccounts.emit(&quot;accountConfigured&quot;, account);</span>
<a href="#l3.49"></a><span id="l3.49" class="difflineplus">+      onDoLoad();</span>
<a href="#l3.50"></a><span id="l3.50" class="difflineplus">+    },</span>
<a href="#l3.51"></a><span id="l3.51" class="difflineplus">+  }, () =&gt; {</span>
<a href="#l3.52"></a><span id="l3.52" class="difflineplus">+    button.disabled = false;</span>
<a href="#l3.53"></a><span id="l3.53" class="difflineplus">+    loading.hidden = true;</span>
<a href="#l3.54"></a><span id="l3.54" class="difflineplus">+    auth.hidden = false;</span>
<a href="#l3.55"></a><span id="l3.55" class="difflineplus">+  });</span>
<a href="#l3.56"></a><span id="l3.56" class="difflineplus">+}</span>
<a href="#l3.57"></a><span id="l3.57" class="difflineplus">+</span>
<a href="#l3.58"></a><span id="l3.58" class="difflineplus">+function onDoLoad() {</span>
<a href="#l3.59"></a><span id="l3.59" class="difflineplus">+  account.refreshUserInfo(false, {</span>
<a href="#l3.60"></a><span id="l3.60" class="difflineplus">+    onStartRequest() {</span>
<a href="#l3.61"></a><span id="l3.61" class="difflineplus">+    },</span>
<a href="#l3.62"></a><span id="l3.62" class="difflineplus">+    onStopRequest() {</span>
<a href="#l3.63"></a><span id="l3.63" class="difflineplus">+      loading.hidden = true;</span>
<a href="#l3.64"></a><span id="l3.64" class="difflineplus">+      spacebox.hidden = false;</span>
<a href="#l3.65"></a><span id="l3.65" class="difflineplus">+      onLoadProvider(account);</span>
<a href="#l3.66"></a><span id="l3.66" class="difflineplus">+    },</span>
<a href="#l3.67"></a><span id="l3.67" class="difflineplus">+  });</span>
<a href="#l3.68"></a><span id="l3.68" class="difflineplus">+}</span>
<a href="#l3.69"></a><span id="l3.69" class="difflineplus">+</span>
<a href="#l3.70"></a><span id="l3.70" class="difflineplus">+function onLoadProvider(account) {</span>
<a href="#l3.71"></a><span id="l3.71" class="difflineplus">+  let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l3.72"></a><span id="l3.72"> </span>
<a href="#l3.73"></a><span id="l3.73">   let fileSpaceUsed = document.getElementById(&quot;file-space-used&quot;);</span>
<a href="#l3.74"></a><span id="l3.74" class="difflineminus">-  fileSpaceUsed.textContent = messenger.formatFileSize(provider.fileSpaceUsed);</span>
<a href="#l3.75"></a><span id="l3.75" class="difflineplus">+  fileSpaceUsed.textContent = messenger.formatFileSize(account.fileSpaceUsed);</span>
<a href="#l3.76"></a><span id="l3.76">   let fileSpaceUsedSwatch = document.getElementById(&quot;file-space-used-swatch&quot;);</span>
<a href="#l3.77"></a><span id="l3.77">   fileSpaceUsedSwatch.style.backgroundColor = pv.Colors.category20.values[0];</span>
<a href="#l3.78"></a><span id="l3.78"> </span>
<a href="#l3.79"></a><span id="l3.79">   let remainingFileSpace = document.getElementById(&quot;remaining-file-space&quot;);</span>
<a href="#l3.80"></a><span id="l3.80" class="difflineminus">-  remainingFileSpace.textContent = messenger.formatFileSize(</span>
<a href="#l3.81"></a><span id="l3.81" class="difflineminus">-    provider.remainingFileSpace);</span>
<a href="#l3.82"></a><span id="l3.82" class="difflineplus">+  remainingFileSpace.textContent = messenger.formatFileSize(account.remainingFileSpace);</span>
<a href="#l3.83"></a><span id="l3.83">   let remainingFileSpaceSwatch = document.getElementById(&quot;remaining-file-space-swatch&quot;);</span>
<a href="#l3.84"></a><span id="l3.84">   remainingFileSpaceSwatch.style.backgroundColor = pv.Colors.category20.values[1];</span>
<a href="#l3.85"></a><span id="l3.85"> </span>
<a href="#l3.86"></a><span id="l3.86" class="difflineminus">-  let totalSpace = provider.fileSpaceUsed + provider.remainingFileSpace;</span>
<a href="#l3.87"></a><span id="l3.87" class="difflineplus">+  let totalSpace = account.fileSpaceUsed + account.remainingFileSpace;</span>
<a href="#l3.88"></a><span id="l3.88">   let pieScale = 2 * Math.PI / totalSpace;</span>
<a href="#l3.89"></a><span id="l3.89"> </span>
<a href="#l3.90"></a><span id="l3.90">   let spaceDiv = document.getElementById(&quot;provider-space-visuals&quot;);</span>
<a href="#l3.91"></a><span id="l3.91">   let vis = new pv.Panel().canvas(spaceDiv)</span>
<a href="#l3.92"></a><span id="l3.92">     .width(150)</span>
<a href="#l3.93"></a><span id="l3.93">     .height(150);</span>
<a href="#l3.94"></a><span id="l3.94">   vis.add(pv.Wedge)</span>
<a href="#l3.95"></a><span id="l3.95" class="difflineminus">-    .data([provider.fileSpaceUsed, provider.remainingFileSpace])</span>
<a href="#l3.96"></a><span id="l3.96" class="difflineplus">+    .data([account.fileSpaceUsed, account.remainingFileSpace])</span>
<a href="#l3.97"></a><span id="l3.97">     .left(75)</span>
<a href="#l3.98"></a><span id="l3.98">     .top(75)</span>
<a href="#l3.99"></a><span id="l3.99">     .innerRadius(30)</span>
<a href="#l3.100"></a><span id="l3.100">     .outerRadius(65)</span>
<a href="#l3.101"></a><span id="l3.101">     .angle(d =&gt; d * pieScale);</span>
<a href="#l3.102"></a><span id="l3.102"> </span>
<a href="#l3.103"></a><span id="l3.103">   vis.add(pv.Label)</span>
<a href="#l3.104"></a><span id="l3.104">     .left(75)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1">rename from mail/components/cloudfile/content/Box/management.xhtml</span>
<a href="#l4.2"></a><span id="l4.2">rename to mail/components/cloudfile/box/management.xhtml</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineminus">--- a/mail/components/cloudfile/content/Box/management.xhtml</span>
<a href="#l4.4"></a><span id="l4.4" class="difflineplus">+++ b/mail/components/cloudfile/box/management.xhtml</span>
<a href="#l4.5"></a><span id="l4.5" class="difflineat">@@ -8,33 +8,40 @@</span>
<a href="#l4.6"></a><span id="l4.6">   &lt;!ENTITY % managementDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/management.dtd&quot;&gt; %managementDTD;</span>
<a href="#l4.7"></a><span id="l4.7">   &lt;!ENTITY % boxDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/Box/management.dtd&quot;&gt; %boxDTD;</span>
<a href="#l4.8"></a><span id="l4.8"> ]&gt;</span>
<a href="#l4.9"></a><span id="l4.9"> &lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l4.10"></a><span id="l4.10">   &lt;head&gt;</span>
<a href="#l4.11"></a><span id="l4.11">     &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l4.12"></a><span id="l4.12">             src=&quot;chrome://messenger/content/protovis-r2.6-modded.js&quot;/&gt;</span>
<a href="#l4.13"></a><span id="l4.13">     &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineminus">-            src=&quot;chrome://messenger/content/cloudfile/Box/management.js&quot;/&gt;</span>
<a href="#l4.15"></a><span id="l4.15" class="difflineplus">+            src=&quot;chrome://messenger/content/cloudfile/Box/management.js&quot;</span>
<a href="#l4.16"></a><span id="l4.16" class="difflineplus">+            defer=&quot;true&quot;/&gt;</span>
<a href="#l4.17"></a><span id="l4.17">     &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l4.18"></a><span id="l4.18">         type=&quot;text/css&quot;</span>
<a href="#l4.19"></a><span id="l4.19">         href=&quot;chrome://messenger/skin/preferences/preferences.css&quot; /&gt;</span>
<a href="#l4.20"></a><span id="l4.20">   &lt;/head&gt;</span>
<a href="#l4.21"></a><span id="l4.21">   &lt;body id=&quot;provider-management&quot;&gt;</span>
<a href="#l4.22"></a><span id="l4.22">     &lt;div id=&quot;provider-header&quot;&gt;</span>
<a href="#l4.23"></a><span id="l4.23">       &lt;div id=&quot;provider-terms&quot;&gt;</span>
<a href="#l4.24"></a><span id="l4.24">       &lt;a href=&quot;http://www.box.com/static/html/privacy.html&quot;&gt;&amp;cloudfileMgmt.privacyPolicy;&lt;/a&gt;</span>
<a href="#l4.25"></a><span id="l4.25">       &lt;a href=&quot;https://www.box.com/static/html/terms.html&quot;&gt;&amp;cloudfileMgmt.termsOfService;&lt;/a&gt;</span>
<a href="#l4.26"></a><span id="l4.26">       &lt;/div&gt;</span>
<a href="#l4.27"></a><span id="l4.27">       &lt;div id=&quot;provider-name&quot;&gt;</span>
<a href="#l4.28"></a><span id="l4.28">       &lt;h1&gt;Box&lt;/h1&gt;</span>
<a href="#l4.29"></a><span id="l4.29">       &lt;/div&gt;</span>
<a href="#l4.30"></a><span id="l4.30">     &lt;/div&gt;</span>
<a href="#l4.31"></a><span id="l4.31"> </span>
<a href="#l4.32"></a><span id="l4.32" class="difflineminus">-    &lt;div id=&quot;provider-spacebox&quot;&gt;</span>
<a href="#l4.33"></a><span id="l4.33" class="difflineplus">+    &lt;div id=&quot;provider-loading&quot; align=&quot;center&quot;&gt;</span>
<a href="#l4.34"></a><span id="l4.34" class="difflineplus">+      &lt;img src=&quot;chrome://global/skin/icons/loading.png&quot; /&gt;</span>
<a href="#l4.35"></a><span id="l4.35" class="difflineplus">+    &lt;/div&gt;</span>
<a href="#l4.36"></a><span id="l4.36" class="difflineplus">+    &lt;div id=&quot;provider-auth&quot; align=&quot;center&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l4.37"></a><span id="l4.37" class="difflineplus">+      &lt;button onclick=&quot;onDoAuth(this)&quot;&gt;&amp;boxMgmt.doAuth;&lt;/button&gt;</span>
<a href="#l4.38"></a><span id="l4.38" class="difflineplus">+    &lt;/div&gt;</span>
<a href="#l4.39"></a><span id="l4.39" class="difflineplus">+    &lt;div id=&quot;provider-spacebox&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l4.40"></a><span id="l4.40">       &lt;div id=&quot;provider-space-visuals&quot;&gt;&lt;/div&gt;</span>
<a href="#l4.41"></a><span id="l4.41">       &lt;div id=&quot;provider-space&quot;&gt;</span>
<a href="#l4.42"></a><span id="l4.42">         &lt;div&gt;</span>
<a href="#l4.43"></a><span id="l4.43">           &lt;label&gt;&amp;cloudfileMgmt.usedSpace;&lt;/label&gt;</span>
<a href="#l4.44"></a><span id="l4.44">           &lt;span id=&quot;file-space-used&quot;/&gt;</span>
<a href="#l4.45"></a><span id="l4.45">           &lt;span id=&quot;file-space-used-swatch&quot; class=&quot;space-swatch&quot;/&gt;</span>
<a href="#l4.46"></a><span id="l4.46">         &lt;/div&gt;</span>
<a href="#l4.47"></a><span id="l4.47">         &lt;div&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/components/cloudfile/cloudFileAccounts.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/components/cloudfile/cloudFileAccounts.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -9,273 +9,218 @@ var PREF_ROOT = &quot;mail.cloud_files.&quot;;</span>
<a href="#l5.4"></a><span id="l5.4"> var ACCOUNT_ROOT = PREF_ROOT + &quot;accounts.&quot;;</span>
<a href="#l5.5"></a><span id="l5.5"> </span>
<a href="#l5.6"></a><span id="l5.6"> // The following constants are used to query and insert entries</span>
<a href="#l5.7"></a><span id="l5.7"> // into the nsILoginManager.</span>
<a href="#l5.8"></a><span id="l5.8"> var PWDMGR_HOST = &quot;chrome://messenger/cloudfile&quot;;</span>
<a href="#l5.9"></a><span id="l5.9"> var PWDMGR_REALM = &quot;BigFiles Auth Token&quot;;</span>
<a href="#l5.10"></a><span id="l5.10"> </span>
<a href="#l5.11"></a><span id="l5.11"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l5.13"></a><span id="l5.13"> var { fixIterator } = ChromeUtils.import(&quot;resource:///modules/iteratorUtils.jsm&quot;);</span>
<a href="#l5.14"></a><span id="l5.14"> var {EventEmitter} = ChromeUtils.import(&quot;resource://gre/modules/EventEmitter.jsm&quot;);</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16"> var cloudFileAccounts = new class extends EventEmitter {</span>
<a href="#l5.17"></a><span id="l5.17" class="difflineplus">+  get constants() {</span>
<a href="#l5.18"></a><span id="l5.18" class="difflineplus">+    return {</span>
<a href="#l5.19"></a><span id="l5.19" class="difflineplus">+      offlineErr: 0x80550014, // NS_MSG_ERROR_OFFLINE</span>
<a href="#l5.20"></a><span id="l5.20" class="difflineplus">+      authErr: 0x8055001e, // NS_MSG_USER_NOT_AUTHENTICATED</span>
<a href="#l5.21"></a><span id="l5.21" class="difflineplus">+      uploadErr: 0x8055311a, // NS_MSG_ERROR_ATTACHING_FILE</span>
<a href="#l5.22"></a><span id="l5.22" class="difflineplus">+      uploadWouldExceedQuota: 0x8055311b,</span>
<a href="#l5.23"></a><span id="l5.23" class="difflineplus">+      uploadExceedsFileLimit: 0x8055311c,</span>
<a href="#l5.24"></a><span id="l5.24" class="difflineplus">+      uploadCancelled: 0x8055311d,</span>
<a href="#l5.25"></a><span id="l5.25" class="difflineplus">+      uploadExceedsFileNameLimit: 0x8055311e,</span>
<a href="#l5.26"></a><span id="l5.26" class="difflineplus">+    };</span>
<a href="#l5.27"></a><span id="l5.27" class="difflineplus">+  }</span>
<a href="#l5.28"></a><span id="l5.28" class="difflineplus">+</span>
<a href="#l5.29"></a><span id="l5.29">   constructor() {</span>
<a href="#l5.30"></a><span id="l5.30">     super();</span>
<a href="#l5.31"></a><span id="l5.31">     this._providers = new Map();</span>
<a href="#l5.32"></a><span id="l5.32" class="difflineplus">+    this._accounts = new Map();</span>
<a href="#l5.33"></a><span id="l5.33" class="difflineplus">+    this._highestOrdinal = 0;</span>
<a href="#l5.34"></a><span id="l5.34">   }</span>
<a href="#l5.35"></a><span id="l5.35"> </span>
<a href="#l5.36"></a><span id="l5.36">   get kTokenRealm() {</span>
<a href="#l5.37"></a><span id="l5.37">     return PWDMGR_REALM;</span>
<a href="#l5.38"></a><span id="l5.38">   }</span>
<a href="#l5.39"></a><span id="l5.39"> </span>
<a href="#l5.40"></a><span id="l5.40">   get _accountKeys() {</span>
<a href="#l5.41"></a><span id="l5.41" class="difflineminus">-    let accountKeySet = {};</span>
<a href="#l5.42"></a><span id="l5.42" class="difflineplus">+    let accountKeySet = new Set();</span>
<a href="#l5.43"></a><span id="l5.43">     let branch = Services.prefs.getBranch(ACCOUNT_ROOT);</span>
<a href="#l5.44"></a><span id="l5.44">     let children = branch.getChildList(&quot;&quot;, {});</span>
<a href="#l5.45"></a><span id="l5.45">     for (let child of children) {</span>
<a href="#l5.46"></a><span id="l5.46">       let subbranch = child.substr(0, child.indexOf(&quot;.&quot;));</span>
<a href="#l5.47"></a><span id="l5.47" class="difflineminus">-      accountKeySet[subbranch] = 1;</span>
<a href="#l5.48"></a><span id="l5.48" class="difflineplus">+      accountKeySet.add(subbranch);</span>
<a href="#l5.49"></a><span id="l5.49" class="difflineplus">+</span>
<a href="#l5.50"></a><span id="l5.50" class="difflineplus">+      let match = /^account(\d+)$/.exec(subbranch);</span>
<a href="#l5.51"></a><span id="l5.51" class="difflineplus">+      if (match) {</span>
<a href="#l5.52"></a><span id="l5.52" class="difflineplus">+        let ordinal = parseInt(match[1], 10);</span>
<a href="#l5.53"></a><span id="l5.53" class="difflineplus">+        this._highestOrdinal = Math.max(this._highestOrdinal, ordinal);</span>
<a href="#l5.54"></a><span id="l5.54" class="difflineplus">+      }</span>
<a href="#l5.55"></a><span id="l5.55">     }</span>
<a href="#l5.56"></a><span id="l5.56"> </span>
<a href="#l5.57"></a><span id="l5.57">     // TODO: sort by ordinal</span>
<a href="#l5.58"></a><span id="l5.58" class="difflineminus">-    return Object.keys(accountKeySet);</span>
<a href="#l5.59"></a><span id="l5.59" class="difflineminus">-  }</span>
<a href="#l5.60"></a><span id="l5.60" class="difflineminus">-</span>
<a href="#l5.61"></a><span id="l5.61" class="difflineminus">-  _getInitedProviderForType(aAccountKey, aType) {</span>
<a href="#l5.62"></a><span id="l5.62" class="difflineminus">-    let provider = this.getProviderForType(aType);</span>
<a href="#l5.63"></a><span id="l5.63" class="difflineminus">-    if (provider) {</span>
<a href="#l5.64"></a><span id="l5.64" class="difflineminus">-      try {</span>
<a href="#l5.65"></a><span id="l5.65" class="difflineminus">-        provider.init(aAccountKey);</span>
<a href="#l5.66"></a><span id="l5.66" class="difflineminus">-      } catch (e) {</span>
<a href="#l5.67"></a><span id="l5.67" class="difflineminus">-        Cu.reportError(e);</span>
<a href="#l5.68"></a><span id="l5.68" class="difflineminus">-        provider = null;</span>
<a href="#l5.69"></a><span id="l5.69" class="difflineminus">-      }</span>
<a href="#l5.70"></a><span id="l5.70" class="difflineminus">-    }</span>
<a href="#l5.71"></a><span id="l5.71" class="difflineminus">-    return provider;</span>
<a href="#l5.72"></a><span id="l5.72" class="difflineminus">-  }</span>
<a href="#l5.73"></a><span id="l5.73" class="difflineminus">-</span>
<a href="#l5.74"></a><span id="l5.74" class="difflineminus">-  _createUniqueAccountKey() {</span>
<a href="#l5.75"></a><span id="l5.75" class="difflineminus">-    // Pick a unique account key (TODO: this is a dumb way to do it, probably)</span>
<a href="#l5.76"></a><span id="l5.76" class="difflineminus">-    let existingKeys = this._accountKeys;</span>
<a href="#l5.77"></a><span id="l5.77" class="difflineminus">-    for (let n = 1; ; n++) {</span>
<a href="#l5.78"></a><span id="l5.78" class="difflineminus">-      if (!existingKeys.includes(&quot;account&quot; + n))</span>
<a href="#l5.79"></a><span id="l5.79" class="difflineminus">-        return &quot;account&quot; + n;</span>
<a href="#l5.80"></a><span id="l5.80" class="difflineminus">-    }</span>
<a href="#l5.81"></a><span id="l5.81" class="difflineplus">+    return accountKeySet.keys();</span>
<a href="#l5.82"></a><span id="l5.82">   }</span>
<a href="#l5.83"></a><span id="l5.83"> </span>
<a href="#l5.84"></a><span id="l5.84">   /**</span>
<a href="#l5.85"></a><span id="l5.85">    * Ensure that we have the account key for an account. If we already have the</span>
<a href="#l5.86"></a><span id="l5.86" class="difflineminus">-   * key, just return it. If we have the nsIMsgCloudFileProvider, get the key</span>
<a href="#l5.87"></a><span id="l5.87" class="difflineminus">-   * from it.</span>
<a href="#l5.88"></a><span id="l5.88" class="difflineplus">+   * key, just return it. If we have the account, get the key from it.</span>
<a href="#l5.89"></a><span id="l5.89">    *</span>
<a href="#l5.90"></a><span id="l5.90">    * @param aKeyOrAccount the key or the account object</span>
<a href="#l5.91"></a><span id="l5.91">    * @return the account key</span>
<a href="#l5.92"></a><span id="l5.92">    */</span>
<a href="#l5.93"></a><span id="l5.93">   _ensureKey(aKeyOrAccount) {</span>
<a href="#l5.94"></a><span id="l5.94">     if (typeof aKeyOrAccount == &quot;string&quot;)</span>
<a href="#l5.95"></a><span id="l5.95">       return aKeyOrAccount;</span>
<a href="#l5.96"></a><span id="l5.96">     if (&quot;accountKey&quot; in aKeyOrAccount)</span>
<a href="#l5.97"></a><span id="l5.97">       return aKeyOrAccount.accountKey;</span>
<a href="#l5.98"></a><span id="l5.98" class="difflineminus">-    throw new Error(&quot;string or nsIMsgCloudFileProvider expected&quot;);</span>
<a href="#l5.99"></a><span id="l5.99" class="difflineplus">+    throw new Error(&quot;String or cloud file account expected&quot;);</span>
<a href="#l5.100"></a><span id="l5.100">   }</span>
<a href="#l5.101"></a><span id="l5.101"> </span>
<a href="#l5.102"></a><span id="l5.102">   /**</span>
<a href="#l5.103"></a><span id="l5.103" class="difflineminus">-   * Register a cloudfile provider, e.g. from a bootstrapped add-on. Registering can be done in two</span>
<a href="#l5.104"></a><span id="l5.104" class="difflineminus">-   * ways, either implicitly through using the &quot;cloud-files&quot; XPCOM category, or explicitly using</span>
<a href="#l5.105"></a><span id="l5.105" class="difflineminus">-   * this function.</span>
<a href="#l5.106"></a><span id="l5.106" class="difflineplus">+   * Register a cloudfile provider, e.g. from an extension.</span>
<a href="#l5.107"></a><span id="l5.107">    *</span>
<a href="#l5.108"></a><span id="l5.108" class="difflineminus">-   * @param {nsIMsgCloudFileProvider} The implementation to register</span>
<a href="#l5.109"></a><span id="l5.109" class="difflineplus">+   * @param {Object} The implementation to register</span>
<a href="#l5.110"></a><span id="l5.110">    */</span>
<a href="#l5.111"></a><span id="l5.111" class="difflineminus">-  registerProvider(aProvider) {</span>
<a href="#l5.112"></a><span id="l5.112" class="difflineminus">-    let type = aProvider.type;</span>
<a href="#l5.113"></a><span id="l5.113" class="difflineminus">-    let hasXPCOM = false;</span>
<a href="#l5.114"></a><span id="l5.114" class="difflineminus">-</span>
<a href="#l5.115"></a><span id="l5.115" class="difflineminus">-    try {</span>
<a href="#l5.116"></a><span id="l5.116" class="difflineminus">-      Services.catMan.getCategoryEntry(CATEGORY, type);</span>
<a href="#l5.117"></a><span id="l5.117" class="difflineminus">-      hasXPCOM = true;</span>
<a href="#l5.118"></a><span id="l5.118" class="difflineminus">-    } catch (ex) {</span>
<a href="#l5.119"></a><span id="l5.119" class="difflineplus">+  registerProvider(aType, aProvider) {</span>
<a href="#l5.120"></a><span id="l5.120" class="difflineplus">+    if (this._providers.has(aType)) {</span>
<a href="#l5.121"></a><span id="l5.121" class="difflineplus">+      throw new Error(`Cloudfile provider ${aType} is already registered`);</span>
<a href="#l5.122"></a><span id="l5.122">     }</span>
<a href="#l5.123"></a><span id="l5.123" class="difflineminus">-</span>
<a href="#l5.124"></a><span id="l5.124" class="difflineminus">-    if (this._providers.has(type)) {</span>
<a href="#l5.125"></a><span id="l5.125" class="difflineminus">-      throw new Error(`Cloudfile provider ${type} is already registered`);</span>
<a href="#l5.126"></a><span id="l5.126" class="difflineminus">-    } else if (hasXPCOM) {</span>
<a href="#l5.127"></a><span id="l5.127" class="difflineminus">-      throw new Error(`Cloudfile provider ${type} is already registered as an XPCOM component`);</span>
<a href="#l5.128"></a><span id="l5.128" class="difflineminus">-    }</span>
<a href="#l5.129"></a><span id="l5.129" class="difflineminus">-    this._providers.set(aProvider.type, aProvider);</span>
<a href="#l5.130"></a><span id="l5.130" class="difflineplus">+    this._providers.set(aType, aProvider);</span>
<a href="#l5.131"></a><span id="l5.131">     this.emit(&quot;providerRegistered&quot;, aProvider);</span>
<a href="#l5.132"></a><span id="l5.132">   }</span>
<a href="#l5.133"></a><span id="l5.133"> </span>
<a href="#l5.134"></a><span id="l5.134">   /**</span>
<a href="#l5.135"></a><span id="l5.135" class="difflineminus">-   * Unregister a cloudfile provider. This function will only unregister those providers registered</span>
<a href="#l5.136"></a><span id="l5.136" class="difflineminus">-   * through #registerProvider. XPCOM providers cannot be unregistered here.</span>
<a href="#l5.137"></a><span id="l5.137" class="difflineplus">+   * Unregister a cloudfile provider.</span>
<a href="#l5.138"></a><span id="l5.138">    *</span>
<a href="#l5.139"></a><span id="l5.139">    * @param {String} aType                  The provider type to unregister</span>
<a href="#l5.140"></a><span id="l5.140">    */</span>
<a href="#l5.141"></a><span id="l5.141">   unregisterProvider(aType) {</span>
<a href="#l5.142"></a><span id="l5.142">     if (!this._providers.has(aType)) {</span>
<a href="#l5.143"></a><span id="l5.143">       throw new Error(`Cloudfile provider ${aType} is not registered`);</span>
<a href="#l5.144"></a><span id="l5.144">     }</span>
<a href="#l5.145"></a><span id="l5.145"> </span>
<a href="#l5.146"></a><span id="l5.146" class="difflineplus">+    for (let account of this.getAccountsForType(aType)) {</span>
<a href="#l5.147"></a><span id="l5.147" class="difflineplus">+      this._accounts.delete(account.accountKey);</span>
<a href="#l5.148"></a><span id="l5.148" class="difflineplus">+    }</span>
<a href="#l5.149"></a><span id="l5.149" class="difflineplus">+</span>
<a href="#l5.150"></a><span id="l5.150">     this._providers.delete(aType);</span>
<a href="#l5.151"></a><span id="l5.151">     this.emit(&quot;providerUnregistered&quot;, aType);</span>
<a href="#l5.152"></a><span id="l5.152">   }</span>
<a href="#l5.153"></a><span id="l5.153"> </span>
<a href="#l5.154"></a><span id="l5.154" class="difflineminus">-  getProviderForType(aType) {</span>
<a href="#l5.155"></a><span id="l5.155" class="difflineminus">-    if (this._providers.has(aType)) {</span>
<a href="#l5.156"></a><span id="l5.156" class="difflineminus">-      return this._providers.get(aType);</span>
<a href="#l5.157"></a><span id="l5.157" class="difflineminus">-    }</span>
<a href="#l5.158"></a><span id="l5.158" class="difflineplus">+  get providers() {</span>
<a href="#l5.159"></a><span id="l5.159" class="difflineplus">+    return [...this._providers.values()];</span>
<a href="#l5.160"></a><span id="l5.160" class="difflineplus">+  }</span>
<a href="#l5.161"></a><span id="l5.161"> </span>
<a href="#l5.162"></a><span id="l5.162" class="difflineminus">-    try {</span>
<a href="#l5.163"></a><span id="l5.163" class="difflineminus">-      let className = Services.catMan.getCategoryEntry(CATEGORY, aType);</span>
<a href="#l5.164"></a><span id="l5.164" class="difflineminus">-      let provider = Cc[className].createInstance(Ci.nsIMsgCloudFileProvider);</span>
<a href="#l5.165"></a><span id="l5.165" class="difflineminus">-      return provider;</span>
<a href="#l5.166"></a><span id="l5.166" class="difflineminus">-    } catch (e) {</span>
<a href="#l5.167"></a><span id="l5.167" class="difflineminus">-      if (e.result != Cr.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l5.168"></a><span id="l5.168" class="difflineminus">-        // If a provider is not available we swallow the error message.</span>
<a href="#l5.169"></a><span id="l5.169" class="difflineminus">-        // Otherwise at least notify, so developers can fix things.</span>
<a href="#l5.170"></a><span id="l5.170" class="difflineminus">-        Cu.reportError(&quot;Getting provider for type=&quot; + aType + &quot; FAILED; &quot; + e);</span>
<a href="#l5.171"></a><span id="l5.171" class="difflineminus">-      }</span>
<a href="#l5.172"></a><span id="l5.172" class="difflineminus">-    }</span>
<a href="#l5.173"></a><span id="l5.173" class="difflineminus">-</span>
<a href="#l5.174"></a><span id="l5.174" class="difflineminus">-    return null;</span>
<a href="#l5.175"></a><span id="l5.175" class="difflineplus">+  getProviderForType(aType) {</span>
<a href="#l5.176"></a><span id="l5.176" class="difflineplus">+    return this._providers.get(aType);</span>
<a href="#l5.177"></a><span id="l5.177">   }</span>
<a href="#l5.178"></a><span id="l5.178"> </span>
<a href="#l5.179"></a><span id="l5.179">   // aExtraPrefs are prefs specific to an account provider.</span>
<a href="#l5.180"></a><span id="l5.180" class="difflineminus">-  createAccount(aType, aRequestObserver, aExtraPrefs) {</span>
<a href="#l5.181"></a><span id="l5.181" class="difflineminus">-    let key = this._createUniqueAccountKey();</span>
<a href="#l5.182"></a><span id="l5.182" class="difflineplus">+  createAccount(aType) {</span>
<a href="#l5.183"></a><span id="l5.183" class="difflineplus">+    this._highestOrdinal++;</span>
<a href="#l5.184"></a><span id="l5.184" class="difflineplus">+    let key = &quot;account&quot; + this._highestOrdinal;</span>
<a href="#l5.185"></a><span id="l5.185"> </span>
<a href="#l5.186"></a><span id="l5.186">     try {</span>
<a href="#l5.187"></a><span id="l5.187" class="difflineminus">-      Services.prefs</span>
<a href="#l5.188"></a><span id="l5.188" class="difflineminus">-              .setCharPref(ACCOUNT_ROOT + key + &quot;.type&quot;, aType);</span>
<a href="#l5.189"></a><span id="l5.189" class="difflineminus">-</span>
<a href="#l5.190"></a><span id="l5.190" class="difflineminus">-      if (aExtraPrefs !== undefined)</span>
<a href="#l5.191"></a><span id="l5.191" class="difflineminus">-        this._processExtraPrefs(key, aExtraPrefs);</span>
<a href="#l5.192"></a><span id="l5.192" class="difflineplus">+      let provider = this.getProviderForType(aType);</span>
<a href="#l5.193"></a><span id="l5.193" class="difflineplus">+      let account = provider.initAccount(key);</span>
<a href="#l5.194"></a><span id="l5.194"> </span>
<a href="#l5.195"></a><span id="l5.195" class="difflineminus">-      let provider = this._getInitedProviderForType(key, aType);</span>
<a href="#l5.196"></a><span id="l5.196" class="difflineminus">-      if (provider) {</span>
<a href="#l5.197"></a><span id="l5.197" class="difflineminus">-        provider.createExistingAccount(aRequestObserver);</span>
<a href="#l5.198"></a><span id="l5.198" class="difflineminus">-        this.emit(&quot;accountAdded&quot;, provider);</span>
<a href="#l5.199"></a><span id="l5.199" class="difflineminus">-      }</span>
<a href="#l5.200"></a><span id="l5.200" class="difflineplus">+      Services.prefs.setCharPref(ACCOUNT_ROOT + key + &quot;.type&quot;, aType);</span>
<a href="#l5.201"></a><span id="l5.201" class="difflineplus">+      Services.prefs.setCharPref(ACCOUNT_ROOT + key + &quot;.displayName&quot;, account.displayName);</span>
<a href="#l5.202"></a><span id="l5.202"> </span>
<a href="#l5.203"></a><span id="l5.203" class="difflineminus">-      return provider;</span>
<a href="#l5.204"></a><span id="l5.204" class="difflineplus">+      this._accounts.set(key, account);</span>
<a href="#l5.205"></a><span id="l5.205" class="difflineplus">+      this.emit(&quot;accountAdded&quot;, account);</span>
<a href="#l5.206"></a><span id="l5.206" class="difflineplus">+      return account;</span>
<a href="#l5.207"></a><span id="l5.207">     } catch (e) {</span>
<a href="#l5.208"></a><span id="l5.208">       Services.prefs.deleteBranch(ACCOUNT_ROOT + key);</span>
<a href="#l5.209"></a><span id="l5.209">       throw e;</span>
<a href="#l5.210"></a><span id="l5.210">     }</span>
<a href="#l5.211"></a><span id="l5.211">   }</span>
<a href="#l5.212"></a><span id="l5.212"> </span>
<a href="#l5.213"></a><span id="l5.213" class="difflineminus">-  // Set provider-specific prefs</span>
<a href="#l5.214"></a><span id="l5.214" class="difflineminus">-  _processExtraPrefs(aAccountKey, aExtraPrefs) {</span>
<a href="#l5.215"></a><span id="l5.215" class="difflineminus">-    const kFuncMap = {</span>
<a href="#l5.216"></a><span id="l5.216" class="difflineminus">-      &quot;int&quot;: &quot;setIntPref&quot;,</span>
<a href="#l5.217"></a><span id="l5.217" class="difflineminus">-      &quot;bool&quot;: &quot;setBoolPref&quot;,</span>
<a href="#l5.218"></a><span id="l5.218" class="difflineminus">-      &quot;char&quot;: &quot;setCharPref&quot;,</span>
<a href="#l5.219"></a><span id="l5.219" class="difflineminus">-    };</span>
<a href="#l5.220"></a><span id="l5.220" class="difflineminus">-</span>
<a href="#l5.221"></a><span id="l5.221" class="difflineminus">-    for (let prefKey in aExtraPrefs) {</span>
<a href="#l5.222"></a><span id="l5.222" class="difflineminus">-      let type = aExtraPrefs[prefKey].type;</span>
<a href="#l5.223"></a><span id="l5.223" class="difflineminus">-      let value = aExtraPrefs[prefKey].value;</span>
<a href="#l5.224"></a><span id="l5.224" class="difflineminus">-</span>
<a href="#l5.225"></a><span id="l5.225" class="difflineminus">-      if (!(type in kFuncMap)) {</span>
<a href="#l5.226"></a><span id="l5.226" class="difflineminus">-        Cu.reportError(&quot;Did not recognize type: &quot; + type);</span>
<a href="#l5.227"></a><span id="l5.227" class="difflineminus">-        continue;</span>
<a href="#l5.228"></a><span id="l5.228" class="difflineminus">-      }</span>
<a href="#l5.229"></a><span id="l5.229" class="difflineminus">-</span>
<a href="#l5.230"></a><span id="l5.230" class="difflineminus">-      let func = kFuncMap[type];</span>
<a href="#l5.231"></a><span id="l5.231" class="difflineminus">-      Services.prefs[func](ACCOUNT_ROOT + aAccountKey + &quot;.&quot; + prefKey,</span>
<a href="#l5.232"></a><span id="l5.232" class="difflineminus">-                           value);</span>
<a href="#l5.233"></a><span id="l5.233" class="difflineminus">-    }</span>
<a href="#l5.234"></a><span id="l5.234" class="difflineminus">-  }</span>
<a href="#l5.235"></a><span id="l5.235" class="difflineminus">-</span>
<a href="#l5.236"></a><span id="l5.236" class="difflineminus">-  * enumerateProviders() {</span>
<a href="#l5.237"></a><span id="l5.237" class="difflineminus">-    for (let [type, provider] of this._providers.entries()) {</span>
<a href="#l5.238"></a><span id="l5.238" class="difflineminus">-      yield [type, provider];</span>
<a href="#l5.239"></a><span id="l5.239" class="difflineminus">-    }</span>
<a href="#l5.240"></a><span id="l5.240" class="difflineminus">-</span>
<a href="#l5.241"></a><span id="l5.241" class="difflineminus">-    for (let {data} of Services.catMan.enumerateCategory(CATEGORY)) {</span>
<a href="#l5.242"></a><span id="l5.242" class="difflineminus">-      let provider = this.getProviderForType(data);</span>
<a href="#l5.243"></a><span id="l5.243" class="difflineminus">-      yield [data, provider];</span>
<a href="#l5.244"></a><span id="l5.244" class="difflineminus">-    }</span>
<a href="#l5.245"></a><span id="l5.245" class="difflineminus">-  }</span>
<a href="#l5.246"></a><span id="l5.246" class="difflineminus">-</span>
<a href="#l5.247"></a><span id="l5.247" class="difflineminus">-  getAccount(aKey) {</span>
<a href="#l5.248"></a><span id="l5.248" class="difflineminus">-    let type = Services.prefs.getCharPref(ACCOUNT_ROOT + aKey + &quot;.type&quot;);</span>
<a href="#l5.249"></a><span id="l5.249" class="difflineminus">-    return this._getInitedProviderForType(aKey, type);</span>
<a href="#l5.250"></a><span id="l5.250" class="difflineminus">-  }</span>
<a href="#l5.251"></a><span id="l5.251" class="difflineminus">-</span>
<a href="#l5.252"></a><span id="l5.252">   removeAccount(aKeyOrAccount) {</span>
<a href="#l5.253"></a><span id="l5.253">     let key = this._ensureKey(aKeyOrAccount);</span>
<a href="#l5.254"></a><span id="l5.254">     let type = Services.prefs.getCharPref(ACCOUNT_ROOT + key + &quot;.type&quot;);</span>
<a href="#l5.255"></a><span id="l5.255"> </span>
<a href="#l5.256"></a><span id="l5.256" class="difflineplus">+    this._accounts.delete(key);</span>
<a href="#l5.257"></a><span id="l5.257">     Services.prefs.deleteBranch(ACCOUNT_ROOT + key);</span>
<a href="#l5.258"></a><span id="l5.258"> </span>
<a href="#l5.259"></a><span id="l5.259">     // Destroy any secret tokens for this accountKey.</span>
<a href="#l5.260"></a><span id="l5.260" class="difflineminus">-    let logins = Services.logins</span>
<a href="#l5.261"></a><span id="l5.261" class="difflineminus">-                         .findLogins({}, PWDMGR_HOST, null, &quot;&quot;);</span>
<a href="#l5.262"></a><span id="l5.262" class="difflineplus">+    let logins = Services.logins.findLogins({}, PWDMGR_HOST, null, &quot;&quot;);</span>
<a href="#l5.263"></a><span id="l5.263">     for (let login of logins) {</span>
<a href="#l5.264"></a><span id="l5.264">       if (login.username == key)</span>
<a href="#l5.265"></a><span id="l5.265">         Services.logins.removeLogin(login);</span>
<a href="#l5.266"></a><span id="l5.266">     }</span>
<a href="#l5.267"></a><span id="l5.267"> </span>
<a href="#l5.268"></a><span id="l5.268">     this.emit(&quot;accountDeleted&quot;, key, type);</span>
<a href="#l5.269"></a><span id="l5.269">   }</span>
<a href="#l5.270"></a><span id="l5.270"> </span>
<a href="#l5.271"></a><span id="l5.271">   get accounts() {</span>
<a href="#l5.272"></a><span id="l5.272" class="difflineminus">-    return this._accountKeys.filter(key =&gt; this.getAccount(key) != null).</span>
<a href="#l5.273"></a><span id="l5.273" class="difflineminus">-      map(key =&gt; this.getAccount(key));</span>
<a href="#l5.274"></a><span id="l5.274" class="difflineplus">+    let arr = [];</span>
<a href="#l5.275"></a><span id="l5.275" class="difflineplus">+    for (let key of this._accountKeys) {</span>
<a href="#l5.276"></a><span id="l5.276" class="difflineplus">+      let account = this.getAccount(key);</span>
<a href="#l5.277"></a><span id="l5.277" class="difflineplus">+      if (account) {</span>
<a href="#l5.278"></a><span id="l5.278" class="difflineplus">+        arr.push(account);</span>
<a href="#l5.279"></a><span id="l5.279" class="difflineplus">+      }</span>
<a href="#l5.280"></a><span id="l5.280" class="difflineplus">+    }</span>
<a href="#l5.281"></a><span id="l5.281" class="difflineplus">+    return arr;</span>
<a href="#l5.282"></a><span id="l5.282" class="difflineplus">+  }</span>
<a href="#l5.283"></a><span id="l5.283" class="difflineplus">+</span>
<a href="#l5.284"></a><span id="l5.284" class="difflineplus">+  get configuredAccounts() {</span>
<a href="#l5.285"></a><span id="l5.285" class="difflineplus">+    return this.accounts.filter(account =&gt; account.configured);</span>
<a href="#l5.286"></a><span id="l5.286" class="difflineplus">+  }</span>
<a href="#l5.287"></a><span id="l5.287" class="difflineplus">+</span>
<a href="#l5.288"></a><span id="l5.288" class="difflineplus">+  getAccount(aKey) {</span>
<a href="#l5.289"></a><span id="l5.289" class="difflineplus">+    if (this._accounts.has(aKey)) {</span>
<a href="#l5.290"></a><span id="l5.290" class="difflineplus">+      return this._accounts.get(aKey);</span>
<a href="#l5.291"></a><span id="l5.291" class="difflineplus">+    }</span>
<a href="#l5.292"></a><span id="l5.292" class="difflineplus">+</span>
<a href="#l5.293"></a><span id="l5.293" class="difflineplus">+    let type = Services.prefs.getCharPref(ACCOUNT_ROOT + aKey + &quot;.type&quot;, &quot;&quot;);</span>
<a href="#l5.294"></a><span id="l5.294" class="difflineplus">+    if (type) {</span>
<a href="#l5.295"></a><span id="l5.295" class="difflineplus">+      let provider = this.getProviderForType(type);</span>
<a href="#l5.296"></a><span id="l5.296" class="difflineplus">+      if (provider) {</span>
<a href="#l5.297"></a><span id="l5.297" class="difflineplus">+        let account = provider.initAccount(aKey);</span>
<a href="#l5.298"></a><span id="l5.298" class="difflineplus">+        this._accounts.set(aKey, account);</span>
<a href="#l5.299"></a><span id="l5.299" class="difflineplus">+        return account;</span>
<a href="#l5.300"></a><span id="l5.300" class="difflineplus">+      }</span>
<a href="#l5.301"></a><span id="l5.301" class="difflineplus">+    }</span>
<a href="#l5.302"></a><span id="l5.302" class="difflineplus">+    return null;</span>
<a href="#l5.303"></a><span id="l5.303">   }</span>
<a href="#l5.304"></a><span id="l5.304"> </span>
<a href="#l5.305"></a><span id="l5.305">   getAccountsForType(aType) {</span>
<a href="#l5.306"></a><span id="l5.306">     let result = [];</span>
<a href="#l5.307"></a><span id="l5.307"> </span>
<a href="#l5.308"></a><span id="l5.308">     for (let accountKey of this._accountKeys) {</span>
<a href="#l5.309"></a><span id="l5.309">       let type = Services.prefs.getCharPref(ACCOUNT_ROOT + accountKey + &quot;.type&quot;);</span>
<a href="#l5.310"></a><span id="l5.310">       if (type === aType)</span>
<a href="#l5.311"></a><span id="l5.311">         result.push(this.getAccount(accountKey));</span>
<a href="#l5.312"></a><span id="l5.312">     }</span>
<a href="#l5.313"></a><span id="l5.313"> </span>
<a href="#l5.314"></a><span id="l5.314">     return result;</span>
<a href="#l5.315"></a><span id="l5.315">   }</span>
<a href="#l5.316"></a><span id="l5.316"> </span>
<a href="#l5.317"></a><span id="l5.317" class="difflineminus">-  addAccountDialog() {</span>
<a href="#l5.318"></a><span id="l5.318" class="difflineminus">-    let params = {accountKey: null};</span>
<a href="#l5.319"></a><span id="l5.319" class="difflineminus">-    Services.wm</span>
<a href="#l5.320"></a><span id="l5.320" class="difflineminus">-            .getMostRecentWindow(null)</span>
<a href="#l5.321"></a><span id="l5.321" class="difflineminus">-            .openDialog(&quot;chrome://messenger/content/cloudfile/&quot;</span>
<a href="#l5.322"></a><span id="l5.322" class="difflineminus">-                        + &quot;addAccountDialog.xul&quot;,</span>
<a href="#l5.323"></a><span id="l5.323" class="difflineminus">-                        &quot;&quot;, &quot;chrome, dialog, modal, resizable=yes&quot;,</span>
<a href="#l5.324"></a><span id="l5.324" class="difflineminus">-                        params).focus();</span>
<a href="#l5.325"></a><span id="l5.325" class="difflineminus">-    return params.accountKey;</span>
<a href="#l5.326"></a><span id="l5.326" class="difflineminus">-  }</span>
<a href="#l5.327"></a><span id="l5.327" class="difflineminus">-</span>
<a href="#l5.328"></a><span id="l5.328">   getDisplayName(aKeyOrAccount) {</span>
<a href="#l5.329"></a><span id="l5.329">     try {</span>
<a href="#l5.330"></a><span id="l5.330">       let key = this._ensureKey(aKeyOrAccount);</span>
<a href="#l5.331"></a><span id="l5.331" class="difflineminus">-      return Services.prefs.getCharPref(ACCOUNT_ROOT +</span>
<a href="#l5.332"></a><span id="l5.332" class="difflineminus">-                                        key + &quot;.displayName&quot;);</span>
<a href="#l5.333"></a><span id="l5.333" class="difflineplus">+      return Services.prefs.getCharPref(ACCOUNT_ROOT + key + &quot;.displayName&quot;);</span>
<a href="#l5.334"></a><span id="l5.334">     } catch (e) {</span>
<a href="#l5.335"></a><span id="l5.335">       // If no display name has been set, we return the empty string.</span>
<a href="#l5.336"></a><span id="l5.336">       Cu.reportError(e);</span>
<a href="#l5.337"></a><span id="l5.337">       return &quot;&quot;;</span>
<a href="#l5.338"></a><span id="l5.338">     }</span>
<a href="#l5.339"></a><span id="l5.339">   }</span>
<a href="#l5.340"></a><span id="l5.340"> </span>
<a href="#l5.341"></a><span id="l5.341">   setDisplayName(aKeyOrAccount, aDisplayName) {</span>
<a href="#l5.342"></a><span id="l5.342">     let key = this._ensureKey(aKeyOrAccount);</span>
<a href="#l5.343"></a><span id="l5.343" class="difflineminus">-    Services.prefs.setCharPref(ACCOUNT_ROOT + key +</span>
<a href="#l5.344"></a><span id="l5.344" class="difflineminus">-                               &quot;.displayName&quot;, aDisplayName);</span>
<a href="#l5.345"></a><span id="l5.345" class="difflineplus">+    Services.prefs.setCharPref(ACCOUNT_ROOT + key + &quot;.displayName&quot;, aDisplayName);</span>
<a href="#l5.346"></a><span id="l5.346">   }</span>
<a href="#l5.347"></a><span id="l5.347"> </span>
<a href="#l5.348"></a><span id="l5.348">   /**</span>
<a href="#l5.349"></a><span id="l5.349">    * Retrieve a secret value, like an authorization token, for an account.</span>
<a href="#l5.350"></a><span id="l5.350">    *</span>
<a href="#l5.351"></a><span id="l5.351" class="difflineminus">-   * @param aKeyOrAccount an nsIMsgCloudFileProvider, or an accountKey</span>
<a href="#l5.352"></a><span id="l5.352" class="difflineminus">-   *                      for a provider.</span>
<a href="#l5.353"></a><span id="l5.353" class="difflineplus">+   * @param aKeyOrAccount an account, or an accountKey for an account.</span>
<a href="#l5.354"></a><span id="l5.354">    * @param aRealm a human-readable string describing what exactly</span>
<a href="#l5.355"></a><span id="l5.355">    *               was being stored. Should match the realm used when setting</span>
<a href="#l5.356"></a><span id="l5.356">    *               the value.</span>
<a href="#l5.357"></a><span id="l5.357">    */</span>
<a href="#l5.358"></a><span id="l5.358">   getSecretValue(aKeyOrAccount, aRealm) {</span>
<a href="#l5.359"></a><span id="l5.359">     let key = this._ensureKey(aKeyOrAccount);</span>
<a href="#l5.360"></a><span id="l5.360"> </span>
<a href="#l5.361"></a><span id="l5.361">     let loginInfo = this._getLoginInfoForKey(key, aRealm);</span>
<a href="#l5.362"></a><span id="l5.362" class="difflineat">@@ -285,18 +230,17 @@ var cloudFileAccounts = new class extend</span>
<a href="#l5.363"></a><span id="l5.363"> </span>
<a href="#l5.364"></a><span id="l5.364">     return null;</span>
<a href="#l5.365"></a><span id="l5.365">   }</span>
<a href="#l5.366"></a><span id="l5.366"> </span>
<a href="#l5.367"></a><span id="l5.367">   /**</span>
<a href="#l5.368"></a><span id="l5.368">    * Store a secret value, like an authorization token, for an account</span>
<a href="#l5.369"></a><span id="l5.369">    * in nsILoginManager.</span>
<a href="#l5.370"></a><span id="l5.370">    *</span>
<a href="#l5.371"></a><span id="l5.371" class="difflineminus">-   * @param aKeyOrAccount an nsIMsgCloudFileProvider, or an accountKey</span>
<a href="#l5.372"></a><span id="l5.372" class="difflineminus">-   *                      for a provider.</span>
<a href="#l5.373"></a><span id="l5.373" class="difflineplus">+   * @param aKeyOrAccount an account, or an accountKey for an account.</span>
<a href="#l5.374"></a><span id="l5.374">    * @param aRealm a human-readable string describing what exactly</span>
<a href="#l5.375"></a><span id="l5.375">    *               is being stored here. To reduce magic strings, you can use</span>
<a href="#l5.376"></a><span id="l5.376">    *               cloudFileAccounts.kTokenRealm for simple auth tokens, and</span>
<a href="#l5.377"></a><span id="l5.377">    *               anything else for custom secret values.</span>
<a href="#l5.378"></a><span id="l5.378">    * @param aToken The token to be saved.  If this is set to null or the</span>
<a href="#l5.379"></a><span id="l5.379">    *               empty string, then the entry for this key will be removed.</span>
<a href="#l5.380"></a><span id="l5.380">    */</span>
<a href="#l5.381"></a><span id="l5.381">   setSecretValue(aKeyOrAccount, aRealm, aToken) {</span>
<a href="#l5.382"></a><span id="l5.382" class="difflineat">@@ -321,22 +265,24 @@ var cloudFileAccounts = new class extend</span>
<a href="#l5.383"></a><span id="l5.383">     else</span>
<a href="#l5.384"></a><span id="l5.384">       Services.logins.addLogin(newLoginInfo);</span>
<a href="#l5.385"></a><span id="l5.385">   }</span>
<a href="#l5.386"></a><span id="l5.386"> </span>
<a href="#l5.387"></a><span id="l5.387">   /**</span>
<a href="#l5.388"></a><span id="l5.388">    * Searches the nsILoginManager for an nsILoginInfo for BigFiles with</span>
<a href="#l5.389"></a><span id="l5.389">    * the username set to aKey, and the realm set to aRealm.</span>
<a href="#l5.390"></a><span id="l5.390">    *</span>
<a href="#l5.391"></a><span id="l5.391" class="difflineminus">-   * @param aKey a key for an nsIMsgCloudFileProvider that we're searching</span>
<a href="#l5.392"></a><span id="l5.392" class="difflineminus">-   *             for login info for.</span>
<a href="#l5.393"></a><span id="l5.393" class="difflineplus">+   * @param aKey a key for an account that we're searching for login info for.</span>
<a href="#l5.394"></a><span id="l5.394">    * @param aRealm the realm that the login info was stored under.</span>
<a href="#l5.395"></a><span id="l5.395">    */</span>
<a href="#l5.396"></a><span id="l5.396">   _getLoginInfoForKey(aKey, aRealm) {</span>
<a href="#l5.397"></a><span id="l5.397" class="difflineminus">-    let logins = Services.logins</span>
<a href="#l5.398"></a><span id="l5.398" class="difflineminus">-                         .findLogins({}, PWDMGR_HOST, null, aRealm);</span>
<a href="#l5.399"></a><span id="l5.399" class="difflineplus">+    let logins = Services.logins.findLogins({}, PWDMGR_HOST, null, aRealm);</span>
<a href="#l5.400"></a><span id="l5.400">     for (let login of logins) {</span>
<a href="#l5.401"></a><span id="l5.401">       if (login.username == aKey)</span>
<a href="#l5.402"></a><span id="l5.402">         return login;</span>
<a href="#l5.403"></a><span id="l5.403">     }</span>
<a href="#l5.404"></a><span id="l5.404">     return null;</span>
<a href="#l5.405"></a><span id="l5.405">   }</span>
<a href="#l5.406"></a><span id="l5.406"> };</span>
<a href="#l5.407"></a><span id="l5.407" class="difflineplus">+</span>
<a href="#l5.408"></a><span id="l5.408" class="difflineplus">+// These modules define and register the Box and Hightail providers. They export nothing.</span>
<a href="#l5.409"></a><span id="l5.409" class="difflineplus">+ChromeUtils.import(&quot;chrome://messenger/content/cloudfile/Box/box.jsm&quot;);</span>
<a href="#l5.410"></a><span id="l5.410" class="difflineplus">+ChromeUtils.import(&quot;chrome://messenger/content/cloudfile/Hightail/hightail.jsm&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1">deleted file mode 100644</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineminus">--- a/mail/components/cloudfile/cloudFileComponents.manifest</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineplus">+++ /dev/null</span>
<a href="#l6.4"></a><span id="l6.4" class="difflineat">@@ -1,8 +0,0 @@</span>
<a href="#l6.5"></a><span id="l6.5" class="difflineminus">-component {dd2bce44-ca71-42ce-b806-6fa4e073919c} nsHightail.js</span>
<a href="#l6.6"></a><span id="l6.6" class="difflineminus">-contract @mozilla.org/mail/hightail;1 {dd2bce44-ca71-42ce-b806-6fa4e073919c}</span>
<a href="#l6.7"></a><span id="l6.7" class="difflineminus">-# Hightail used to be named YouSendIt, which is the constant used in the prefs.</span>
<a href="#l6.8"></a><span id="l6.8" class="difflineminus">-category cloud-files YouSendIt @mozilla.org/mail/hightail;1</span>
<a href="#l6.9"></a><span id="l6.9" class="difflineminus">-</span>
<a href="#l6.10"></a><span id="l6.10" class="difflineminus">-component {c06a8707-7463-416c-8b39-e85044a4ff6e} nsBox.js</span>
<a href="#l6.11"></a><span id="l6.11" class="difflineminus">-contract @mozilla.org/mail/box;1 {c06a8707-7463-416c-8b39-e85044a4ff6e}</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineminus">-category cloud-files Box @mozilla.org/mail/box;1</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1">deleted file mode 100644</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineminus">--- a/mail/components/cloudfile/content/Box/settings.xhtml</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineplus">+++ /dev/null</span>
<a href="#l7.4"></a><span id="l7.4" class="difflineat">@@ -1,21 +0,0 @@</span>
<a href="#l7.5"></a><span id="l7.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l7.6"></a><span id="l7.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l7.7"></a><span id="l7.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l7.8"></a><span id="l7.8" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l7.9"></a><span id="l7.9" class="difflineminus">-</span>
<a href="#l7.10"></a><span id="l7.10" class="difflineminus">-&lt;!DOCTYPE html [</span>
<a href="#l7.11"></a><span id="l7.11" class="difflineminus">-  &lt;!ENTITY % htmlDTD PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;DTD/xhtml1-strict.dtd&quot;&gt; %htmlDTD;</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineminus">-  &lt;!ENTITY % boxDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/Box/settings.dtd&quot;&gt; %boxDTD;</span>
<a href="#l7.13"></a><span id="l7.13" class="difflineminus">-]&gt;</span>
<a href="#l7.14"></a><span id="l7.14" class="difflineminus">-&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l7.15"></a><span id="l7.15" class="difflineminus">-  &lt;head&gt;</span>
<a href="#l7.16"></a><span id="l7.16" class="difflineminus">-    &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l7.17"></a><span id="l7.17" class="difflineminus">-        type=&quot;text/css&quot;</span>
<a href="#l7.18"></a><span id="l7.18" class="difflineminus">-        href=&quot;chrome://messenger/skin/cloudfile/addAccountDialog.css&quot; /&gt;</span>
<a href="#l7.19"></a><span id="l7.19" class="difflineminus">-  &lt;/head&gt;</span>
<a href="#l7.20"></a><span id="l7.20" class="difflineminus">-  &lt;body id=&quot;provider-settings&quot;&gt;</span>
<a href="#l7.21"></a><span id="l7.21" class="difflineminus">-    &lt;div id=&quot;learn-more&quot;&gt;</span>
<a href="#l7.22"></a><span id="l7.22" class="difflineminus">-      &lt;a href=&quot;https://www.box.com/thunderbird&quot;&gt;&amp;boxSettings.needAnAccount;&lt;/a&gt;</span>
<a href="#l7.23"></a><span id="l7.23" class="difflineminus">-    &lt;/div&gt;</span>
<a href="#l7.24"></a><span id="l7.24" class="difflineminus">-  &lt;/body&gt;</span>
<a href="#l7.25"></a><span id="l7.25" class="difflineminus">-&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1">deleted file mode 100644</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineminus">--- a/mail/components/cloudfile/content/Hightail/settings.js</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineplus">+++ /dev/null</span>
<a href="#l8.4"></a><span id="l8.4" class="difflineat">@@ -1,10 +0,0 @@</span>
<a href="#l8.5"></a><span id="l8.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l8.6"></a><span id="l8.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l8.7"></a><span id="l8.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l8.8"></a><span id="l8.8" class="difflineminus">-</span>
<a href="#l8.9"></a><span id="l8.9" class="difflineminus">-function extraArgs() {</span>
<a href="#l8.10"></a><span id="l8.10" class="difflineminus">-  var usernameValue = document.getElementById(&quot;username&quot;).value;</span>
<a href="#l8.11"></a><span id="l8.11" class="difflineminus">-  return {</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-    &quot;username&quot;: {type: &quot;char&quot;, value: usernameValue},</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-  };</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1">deleted file mode 100644</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineminus">--- a/mail/components/cloudfile/content/Hightail/settings.xhtml</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineplus">+++ /dev/null</span>
<a href="#l9.4"></a><span id="l9.4" class="difflineat">@@ -1,30 +0,0 @@</span>
<a href="#l9.5"></a><span id="l9.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l9.6"></a><span id="l9.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l9.7"></a><span id="l9.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l9.8"></a><span id="l9.8" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l9.9"></a><span id="l9.9" class="difflineminus">-</span>
<a href="#l9.10"></a><span id="l9.10" class="difflineminus">-&lt;!DOCTYPE html [</span>
<a href="#l9.11"></a><span id="l9.11" class="difflineminus">-  &lt;!ENTITY % htmlDTD PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;DTD/xhtml1-strict.dtd&quot;&gt; %htmlDTD;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineminus">-  &lt;!ENTITY % hightailDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/Hightail/settings.dtd&quot;&gt; %hightailDTD;</span>
<a href="#l9.13"></a><span id="l9.13" class="difflineminus">-]&gt;</span>
<a href="#l9.14"></a><span id="l9.14" class="difflineminus">-&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l9.15"></a><span id="l9.15" class="difflineminus">-  &lt;head&gt;</span>
<a href="#l9.16"></a><span id="l9.16" class="difflineminus">-    &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l9.17"></a><span id="l9.17" class="difflineminus">-            src=&quot;chrome://messenger/content/cloudfile/Hightail/settings.js&quot;/&gt;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-    &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineminus">-          type=&quot;text/css&quot;</span>
<a href="#l9.20"></a><span id="l9.20" class="difflineminus">-          href=&quot;chrome://messenger/skin/cloudfile/addAccountDialog.css&quot; /&gt;</span>
<a href="#l9.21"></a><span id="l9.21" class="difflineminus">-  &lt;/head&gt;</span>
<a href="#l9.22"></a><span id="l9.22" class="difflineminus">-  &lt;body id=&quot;provider-settings&quot;&gt;</span>
<a href="#l9.23"></a><span id="l9.23" class="difflineminus">-    &lt;form id=&quot;provider-form&quot; onsubmit=&quot;return false;&quot;&gt;</span>
<a href="#l9.24"></a><span id="l9.24" class="difflineminus">-      &lt;label for=&quot;username&quot;&gt;&amp;hightailSettings.username;&lt;/label&gt;</span>
<a href="#l9.25"></a><span id="l9.25" class="difflineminus">-      &lt;input id=&quot;username&quot; type=&quot;text&quot; required=&quot;true&quot;/&gt;</span>
<a href="#l9.26"></a><span id="l9.26" class="difflineminus">-      &lt;div id=&quot;learn-more&quot; class=&quot;float-right&quot;&gt;</span>
<a href="#l9.27"></a><span id="l9.27" class="difflineminus">-        &lt;a href=&quot;https://www.hightail.com/thunderbird-about-yousendit?s=4001583&amp;amp;cid=pm-4001583&quot;&gt;&amp;hightailSettings.learnMore;&lt;/a&gt;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l9.29"></a><span id="l9.29" class="difflineminus">-      &lt;div&gt;</span>
<a href="#l9.30"></a><span id="l9.30" class="difflineminus">-        &lt;a href=&quot;https://www.hightail.com/litesignup?s=4001583&amp;amp;cid=pm-4001583&quot;&gt;&amp;hightailSettings.needAnAccount;&lt;/a&gt;</span>
<a href="#l9.31"></a><span id="l9.31" class="difflineminus">-      &lt;/div&gt;</span>
<a href="#l9.32"></a><span id="l9.32" class="difflineminus">-    &lt;/form&gt;</span>
<a href="#l9.33"></a><span id="l9.33" class="difflineminus">-  &lt;/body&gt;</span>
<a href="#l9.34"></a><span id="l9.34" class="difflineminus">-&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1">deleted file mode 100644</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineminus">--- a/mail/components/cloudfile/content/addAccountDialog.js</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineplus">+++ /dev/null</span>
<a href="#l10.4"></a><span id="l10.4" class="difflineat">@@ -1,328 +0,0 @@</span>
<a href="#l10.5"></a><span id="l10.5" class="difflineminus">-/* -*- Mode: javascript; tab-width: 8; indent-tabs-mode: nil; c-basic-offset: 2 ; js-indent-level: 2 -*- */</span>
<a href="#l10.6"></a><span id="l10.6" class="difflineminus">-/* vim: set ts=2 et sw=2 tw=80: */</span>
<a href="#l10.7"></a><span id="l10.7" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l10.8"></a><span id="l10.8" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l10.9"></a><span id="l10.9" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l10.10"></a><span id="l10.10" class="difflineminus">-</span>
<a href="#l10.11"></a><span id="l10.11" class="difflineminus">-var kFormId = &quot;provider-form&quot;;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineminus">-ChromeUtils.defineModuleGetter(this, &quot;ExtensionParent&quot;, &quot;resource://gre/modules/ExtensionParent.jsm&quot;);</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineminus">-</span>
<a href="#l10.18"></a><span id="l10.18" class="difflineminus">-function createAccountObserver() {}</span>
<a href="#l10.19"></a><span id="l10.19" class="difflineminus">-</span>
<a href="#l10.20"></a><span id="l10.20" class="difflineminus">-createAccountObserver.prototype = {</span>
<a href="#l10.21"></a><span id="l10.21" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIRequestObserver]),</span>
<a href="#l10.22"></a><span id="l10.22" class="difflineminus">-  onStartRequest(aRequest, aContext) {},</span>
<a href="#l10.23"></a><span id="l10.23" class="difflineminus">-  onStopRequest(aRequest, aContext, aStatusCode) {</span>
<a href="#l10.24"></a><span id="l10.24" class="difflineminus">-    if (aStatusCode == Cr.NS_OK</span>
<a href="#l10.25"></a><span id="l10.25" class="difflineminus">-        &amp;&amp; aContext.QueryInterface(Ci.nsIMsgCloudFileProvider)) {</span>
<a href="#l10.26"></a><span id="l10.26" class="difflineminus">-      let accountKey = aContext.accountKey;</span>
<a href="#l10.27"></a><span id="l10.27" class="difflineminus">-</span>
<a href="#l10.28"></a><span id="l10.28" class="difflineminus">-      // For now, we'll just set the display name to be the name of the service</span>
<a href="#l10.29"></a><span id="l10.29" class="difflineminus">-      cloudFileAccounts.setDisplayName(accountKey, aContext.displayName);</span>
<a href="#l10.30"></a><span id="l10.30" class="difflineminus">-</span>
<a href="#l10.31"></a><span id="l10.31" class="difflineminus">-      window.arguments[0].accountKey = aContext.accountKey;</span>
<a href="#l10.32"></a><span id="l10.32" class="difflineminus">-      window.close();</span>
<a href="#l10.33"></a><span id="l10.33" class="difflineminus">-    } else {</span>
<a href="#l10.34"></a><span id="l10.34" class="difflineminus">-      if (aContext.QueryInterface(Ci.nsIMsgCloudFileProvider)) {</span>
<a href="#l10.35"></a><span id="l10.35" class="difflineminus">-        cloudFileAccounts.removeAccount(aContext.accountKey);</span>
<a href="#l10.36"></a><span id="l10.36" class="difflineminus">-      } else {</span>
<a href="#l10.37"></a><span id="l10.37" class="difflineminus">-        // Something went seriously wrong here...</span>
<a href="#l10.38"></a><span id="l10.38" class="difflineminus">-        Cu.reportError(&quot;Cloud account creation failed, and &quot; +</span>
<a href="#l10.39"></a><span id="l10.39" class="difflineminus">-                       &quot;provider instance missing!&quot;);</span>
<a href="#l10.40"></a><span id="l10.40" class="difflineminus">-      }</span>
<a href="#l10.41"></a><span id="l10.41" class="difflineminus">-</span>
<a href="#l10.42"></a><span id="l10.42" class="difflineminus">-      addAccountDialog._accept.disabled = false;</span>
<a href="#l10.43"></a><span id="l10.43" class="difflineminus">-      addAccountDialog._messages.selectedPanel = addAccountDialog._error;</span>
<a href="#l10.44"></a><span id="l10.44" class="difflineminus">-    }</span>
<a href="#l10.45"></a><span id="l10.45" class="difflineminus">-  },</span>
<a href="#l10.46"></a><span id="l10.46" class="difflineminus">-};</span>
<a href="#l10.47"></a><span id="l10.47" class="difflineminus">-</span>
<a href="#l10.48"></a><span id="l10.48" class="difflineminus">-var addAccountDialog = {</span>
<a href="#l10.49"></a><span id="l10.49" class="difflineminus">-  _settings: null,</span>
<a href="#l10.50"></a><span id="l10.50" class="difflineminus">-  _settingsWrap: null,</span>
<a href="#l10.51"></a><span id="l10.51" class="difflineminus">-  _accountType: null,</span>
<a href="#l10.52"></a><span id="l10.52" class="difflineminus">-  _accept: null,</span>
<a href="#l10.53"></a><span id="l10.53" class="difflineminus">-  _strings: Services.strings</span>
<a href="#l10.54"></a><span id="l10.54" class="difflineminus">-                    .createBundle(&quot;chrome://messenger/locale/cloudfile/addAccountDialog.properties&quot;),</span>
<a href="#l10.55"></a><span id="l10.55" class="difflineminus">-  // This blacklist is for providers who no longer want to be offered</span>
<a href="#l10.56"></a><span id="l10.56" class="difflineminus">-  // as an option for a new Filelink provider, but still wants to</span>
<a href="#l10.57"></a><span id="l10.57" class="difflineminus">-  // exist as a Filelink provider for pre-existing users.</span>
<a href="#l10.58"></a><span id="l10.58" class="difflineminus">-  _blacklist: new Set([&quot;YouSendIt&quot;]),</span>
<a href="#l10.59"></a><span id="l10.59" class="difflineminus">-</span>
<a href="#l10.60"></a><span id="l10.60" class="difflineminus">-  onInit() {</span>
<a href="#l10.61"></a><span id="l10.61" class="difflineminus">-    this._settings = document.getElementById(&quot;accountSettings&quot;);</span>
<a href="#l10.62"></a><span id="l10.62" class="difflineminus">-    this._accountType = document.getElementById(&quot;accountType&quot;);</span>
<a href="#l10.63"></a><span id="l10.63" class="difflineminus">-    this._noAccountText = document.getElementById(&quot;noAccountText&quot;);</span>
<a href="#l10.64"></a><span id="l10.64" class="difflineminus">-    this._accept = document.documentElement.getButton(&quot;accept&quot;);</span>
<a href="#l10.65"></a><span id="l10.65" class="difflineminus">-    this._cancel = document.documentElement.getButton(&quot;cancel&quot;);</span>
<a href="#l10.66"></a><span id="l10.66" class="difflineminus">-    this._messages = document.getElementById(&quot;messages&quot;);</span>
<a href="#l10.67"></a><span id="l10.67" class="difflineminus">-    this._authSpinner = document.getElementById(&quot;authorizing&quot;);</span>
<a href="#l10.68"></a><span id="l10.68" class="difflineminus">-    this._error = document.getElementById(&quot;error&quot;);</span>
<a href="#l10.69"></a><span id="l10.69" class="difflineminus">-    this._createAccountText = document.getElementById(&quot;createAccountText&quot;);</span>
<a href="#l10.70"></a><span id="l10.70" class="difflineminus">-</span>
<a href="#l10.71"></a><span id="l10.71" class="difflineminus">-    this.removeTitleMenuItem();</span>
<a href="#l10.72"></a><span id="l10.72" class="difflineminus">-</span>
<a href="#l10.73"></a><span id="l10.73" class="difflineminus">-    // Hook up the default &quot;Learn More...&quot; link to the appropriate link.</span>
<a href="#l10.74"></a><span id="l10.74" class="difflineminus">-    let learnMore = this._settings</span>
<a href="#l10.75"></a><span id="l10.75" class="difflineminus">-                        .contentDocument</span>
<a href="#l10.76"></a><span id="l10.76" class="difflineminus">-                        .querySelector('#learn-more &gt; a[href=&quot;&quot;]');</span>
<a href="#l10.77"></a><span id="l10.77" class="difflineminus">-    if (learnMore)</span>
<a href="#l10.78"></a><span id="l10.78" class="difflineminus">-      learnMore.href = Services.prefs</span>
<a href="#l10.79"></a><span id="l10.79" class="difflineminus">-                               .getCharPref(&quot;mail.cloud_files.learn_more_url&quot;);</span>
<a href="#l10.80"></a><span id="l10.80" class="difflineminus">-</span>
<a href="#l10.81"></a><span id="l10.81" class="difflineminus">-    // Determine whether any account types were added to the menulist,</span>
<a href="#l10.82"></a><span id="l10.82" class="difflineminus">-    // if not, return early.</span>
<a href="#l10.83"></a><span id="l10.83" class="difflineminus">-    if (this.addAccountTypes() == 0)</span>
<a href="#l10.84"></a><span id="l10.84" class="difflineminus">-      return;</span>
<a href="#l10.85"></a><span id="l10.85" class="difflineminus">-</span>
<a href="#l10.86"></a><span id="l10.86" class="difflineminus">-    // Hook up the selection handler.</span>
<a href="#l10.87"></a><span id="l10.87" class="difflineminus">-    this._accountType.addEventListener(&quot;select&quot;, this);</span>
<a href="#l10.88"></a><span id="l10.88" class="difflineminus">-    // Also call it to run it for the default selection.</span>
<a href="#l10.89"></a><span id="l10.89" class="difflineminus">-    addAccountDialog.accountTypeSelected();</span>
<a href="#l10.90"></a><span id="l10.90" class="difflineminus">-</span>
<a href="#l10.91"></a><span id="l10.91" class="difflineminus">-    // The default emptySettings.xhtml is already loaded into the IFrame</span>
<a href="#l10.92"></a><span id="l10.92" class="difflineminus">-    // at this point, before we could attach our DOMContentLoaded event</span>
<a href="#l10.93"></a><span id="l10.93" class="difflineminus">-    // listener, so we'll call the function here manually.</span>
<a href="#l10.94"></a><span id="l10.94" class="difflineminus">-    this.onIFrameLoaded(null);</span>
<a href="#l10.95"></a><span id="l10.95" class="difflineminus">-</span>
<a href="#l10.96"></a><span id="l10.96" class="difflineminus">-    addAccountDialog.fitIFrame();</span>
<a href="#l10.97"></a><span id="l10.97" class="difflineminus">-  },</span>
<a href="#l10.98"></a><span id="l10.98" class="difflineminus">-</span>
<a href="#l10.99"></a><span id="l10.99" class="difflineminus">-  onUnInit() {</span>
<a href="#l10.100"></a><span id="l10.100" class="difflineminus">-    // Clean-up the event listeners.</span>
<a href="#l10.101"></a><span id="l10.101" class="difflineminus">-    this._settings.removeEventListener(&quot;DOMContentLoaded&quot;, this);</span>
<a href="#l10.102"></a><span id="l10.102" class="difflineminus">-    this._settings.removeEventListener(&quot;overflow&quot;, this);</span>
<a href="#l10.103"></a><span id="l10.103" class="difflineminus">-    this._accountType.removeEventListener(&quot;select&quot;, this);</span>
<a href="#l10.104"></a><span id="l10.104" class="difflineminus">-</span>
<a href="#l10.105"></a><span id="l10.105" class="difflineminus">-    return true;</span>
<a href="#l10.106"></a><span id="l10.106" class="difflineminus">-  },</span>
<a href="#l10.107"></a><span id="l10.107" class="difflineminus">-</span>
<a href="#l10.108"></a><span id="l10.108" class="difflineminus">-  handleEvent(aEvent) {</span>
<a href="#l10.109"></a><span id="l10.109" class="difflineminus">-    switch (aEvent.type) {</span>
<a href="#l10.110"></a><span id="l10.110" class="difflineminus">-      case &quot;DOMContentLoaded&quot;: {</span>
<a href="#l10.111"></a><span id="l10.111" class="difflineminus">-        this.onIFrameLoaded();</span>
<a href="#l10.112"></a><span id="l10.112" class="difflineminus">-        break;</span>
<a href="#l10.113"></a><span id="l10.113" class="difflineminus">-      }</span>
<a href="#l10.114"></a><span id="l10.114" class="difflineminus">-      case &quot;overflow&quot;: {</span>
<a href="#l10.115"></a><span id="l10.115" class="difflineminus">-        if (this._settings.contentDocument.body)</span>
<a href="#l10.116"></a><span id="l10.116" class="difflineminus">-          this.fitIFrame();</span>
<a href="#l10.117"></a><span id="l10.117" class="difflineminus">-        break;</span>
<a href="#l10.118"></a><span id="l10.118" class="difflineminus">-      }</span>
<a href="#l10.119"></a><span id="l10.119" class="difflineminus">-      case &quot;select&quot;: {</span>
<a href="#l10.120"></a><span id="l10.120" class="difflineminus">-        this.accountTypeSelected();</span>
<a href="#l10.121"></a><span id="l10.121" class="difflineminus">-        break;</span>
<a href="#l10.122"></a><span id="l10.122" class="difflineminus">-      }</span>
<a href="#l10.123"></a><span id="l10.123" class="difflineminus">-    }</span>
<a href="#l10.124"></a><span id="l10.124" class="difflineminus">-  },</span>
<a href="#l10.125"></a><span id="l10.125" class="difflineminus">-</span>
<a href="#l10.126"></a><span id="l10.126" class="difflineminus">-  onIFrameLoaded(aEvent) {</span>
<a href="#l10.127"></a><span id="l10.127" class="difflineminus">-    let doc = this._settings.contentDocument;</span>
<a href="#l10.128"></a><span id="l10.128" class="difflineminus">-</span>
<a href="#l10.129"></a><span id="l10.129" class="difflineminus">-    let links = doc.getElementsByTagName(&quot;a&quot;);</span>
<a href="#l10.130"></a><span id="l10.130" class="difflineminus">-</span>
<a href="#l10.131"></a><span id="l10.131" class="difflineminus">-    for (let link of links)</span>
<a href="#l10.132"></a><span id="l10.132" class="difflineminus">-      link.addEventListener(&quot;click&quot;, this.onClickLink);</span>
<a href="#l10.133"></a><span id="l10.133" class="difflineminus">-</span>
<a href="#l10.134"></a><span id="l10.134" class="difflineminus">-    let form = doc.getElementById(kFormId);</span>
<a href="#l10.135"></a><span id="l10.135" class="difflineminus">-</span>
<a href="#l10.136"></a><span id="l10.136" class="difflineminus">-    if (form)</span>
<a href="#l10.137"></a><span id="l10.137" class="difflineminus">-      form.addEventListener(&quot;input&quot;, this.onInput.bind(this));</span>
<a href="#l10.138"></a><span id="l10.138" class="difflineminus">-</span>
<a href="#l10.139"></a><span id="l10.139" class="difflineminus">-    this.onInput();</span>
<a href="#l10.140"></a><span id="l10.140" class="difflineminus">-</span>
<a href="#l10.141"></a><span id="l10.141" class="difflineminus">-    // Focus the first field in the form, if any, that does not have the</span>
<a href="#l10.142"></a><span id="l10.142" class="difflineminus">-    // class &quot;focus-filter&quot;.</span>
<a href="#l10.143"></a><span id="l10.143" class="difflineminus">-    let firstField = doc.querySelector(&quot;form:not(.filter) input:not(.hidden)&quot;);</span>
<a href="#l10.144"></a><span id="l10.144" class="difflineminus">-    if (firstField)</span>
<a href="#l10.145"></a><span id="l10.145" class="difflineminus">-      firstField.focus();</span>
<a href="#l10.146"></a><span id="l10.146" class="difflineminus">-  },</span>
<a href="#l10.147"></a><span id="l10.147" class="difflineminus">-</span>
<a href="#l10.148"></a><span id="l10.148" class="difflineminus">-  fitIFrame() {</span>
<a href="#l10.149"></a><span id="l10.149" class="difflineminus">-    // Determine the height of the accountSettings iframe, and adjust</span>
<a href="#l10.150"></a><span id="l10.150" class="difflineminus">-    // the height of the window appropriately.</span>
<a href="#l10.151"></a><span id="l10.151" class="difflineminus">-</span>
<a href="#l10.152"></a><span id="l10.152" class="difflineminus">-    // If no account is available, |.body| is undefined. In this case</span>
<a href="#l10.153"></a><span id="l10.153" class="difflineminus">-    // return a minimum height of 16px without calling sizeToContent().</span>
<a href="#l10.154"></a><span id="l10.154" class="difflineminus">-    if (!this._settings.contentDocument.body) {</span>
<a href="#l10.155"></a><span id="l10.155" class="difflineminus">-      Cu.reportError(&quot;WARNING: addAccountDialog.js: fitFrame: There is no account and this._settings.contentDocument.body is undefined.&quot;);</span>
<a href="#l10.156"></a><span id="l10.156" class="difflineminus">-      this._settings.style.height = this._settings.style.minHeight = &quot;16px&quot;;</span>
<a href="#l10.157"></a><span id="l10.157" class="difflineminus">-      return;</span>
<a href="#l10.158"></a><span id="l10.158" class="difflineminus">-    }</span>
<a href="#l10.159"></a><span id="l10.159" class="difflineminus">-    let newHeight = this._settings.contentDocument.body.offsetHeight;</span>
<a href="#l10.160"></a><span id="l10.160" class="difflineminus">-    this._settings.style.height = this._settings.style.minHeight = newHeight + &quot;px&quot;;</span>
<a href="#l10.161"></a><span id="l10.161" class="difflineminus">-    window.sizeToContent();</span>
<a href="#l10.162"></a><span id="l10.162" class="difflineminus">-  },</span>
<a href="#l10.163"></a><span id="l10.163" class="difflineminus">-</span>
<a href="#l10.164"></a><span id="l10.164" class="difflineminus">-  /**</span>
<a href="#l10.165"></a><span id="l10.165" class="difflineminus">-   * Displays the provider's settingsURL in a browser element, using a</span>
<a href="#l10.166"></a><span id="l10.166" class="difflineminus">-   * chrome-privileged browser only if necessary.</span>
<a href="#l10.167"></a><span id="l10.167" class="difflineminus">-   */</span>
<a href="#l10.168"></a><span id="l10.168" class="difflineminus">-  setIFrameSource(src) {</span>
<a href="#l10.169"></a><span id="l10.169" class="difflineminus">-    let type = src.startsWith(&quot;chrome:&quot;) ? &quot;chrome&quot; : &quot;content&quot;;</span>
<a href="#l10.170"></a><span id="l10.170" class="difflineminus">-    if (type == this._settings.getAttribute(&quot;type&quot;)) {</span>
<a href="#l10.171"></a><span id="l10.171" class="difflineminus">-      this._settings.setAttribute(&quot;src&quot;, src);</span>
<a href="#l10.172"></a><span id="l10.172" class="difflineminus">-      return;</span>
<a href="#l10.173"></a><span id="l10.173" class="difflineminus">-    }</span>
<a href="#l10.174"></a><span id="l10.174" class="difflineminus">-</span>
<a href="#l10.175"></a><span id="l10.175" class="difflineminus">-    let frame = document.createElement(&quot;browser&quot;);</span>
<a href="#l10.176"></a><span id="l10.176" class="difflineminus">-    frame.setAttribute(&quot;class&quot;, &quot;indent&quot;);</span>
<a href="#l10.177"></a><span id="l10.177" class="difflineminus">-    frame.setAttribute(&quot;allowfullscreen&quot;, &quot;false&quot;);</span>
<a href="#l10.178"></a><span id="l10.178" class="difflineminus">-    frame.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l10.179"></a><span id="l10.179" class="difflineminus">-    frame.setAttribute(&quot;type&quot;, type);</span>
<a href="#l10.180"></a><span id="l10.180" class="difflineminus">-</span>
<a href="#l10.181"></a><span id="l10.181" class="difflineminus">-    // allows keeping dialog background color without hoops</span>
<a href="#l10.182"></a><span id="l10.182" class="difflineminus">-    frame.setAttribute(&quot;transparent&quot;, &quot;true&quot;);</span>
<a href="#l10.183"></a><span id="l10.183" class="difflineminus">-</span>
<a href="#l10.184"></a><span id="l10.184" class="difflineminus">-    this._settings.parentNode.replaceChild(frame, this._settings);</span>
<a href="#l10.185"></a><span id="l10.185" class="difflineminus">-    this._settings = frame;</span>
<a href="#l10.186"></a><span id="l10.186" class="difflineminus">-</span>
<a href="#l10.187"></a><span id="l10.187" class="difflineminus">-    this._settings.addEventListener(&quot;DOMContentLoaded&quot;, this);</span>
<a href="#l10.188"></a><span id="l10.188" class="difflineminus">-    this._settings.addEventListener(&quot;overflow&quot;, this);</span>
<a href="#l10.189"></a><span id="l10.189" class="difflineminus">-</span>
<a href="#l10.190"></a><span id="l10.190" class="difflineminus">-    ExtensionParent.apiManager.emit(&quot;extension-browser-inserted&quot;, frame);</span>
<a href="#l10.191"></a><span id="l10.191" class="difflineminus">-</span>
<a href="#l10.192"></a><span id="l10.192" class="difflineminus">-    frame.setAttribute(&quot;src&quot;, src);</span>
<a href="#l10.193"></a><span id="l10.193" class="difflineminus">-  },</span>
<a href="#l10.194"></a><span id="l10.194" class="difflineminus">-</span>
<a href="#l10.195"></a><span id="l10.195" class="difflineminus">-  removeTitleMenuItem() {</span>
<a href="#l10.196"></a><span id="l10.196" class="difflineminus">-    let menuitem = this._accountType.querySelector('menuitem[value=&quot;&quot;]');</span>
<a href="#l10.197"></a><span id="l10.197" class="difflineminus">-    if (menuitem)</span>
<a href="#l10.198"></a><span id="l10.198" class="difflineminus">-      menuitem.remove();</span>
<a href="#l10.199"></a><span id="l10.199" class="difflineminus">-  },</span>
<a href="#l10.200"></a><span id="l10.200" class="difflineminus">-</span>
<a href="#l10.201"></a><span id="l10.201" class="difflineminus">-  // Return number of additions to the menulist, zero if none happened.</span>
<a href="#l10.202"></a><span id="l10.202" class="difflineminus">-  addAccountTypes() {</span>
<a href="#l10.203"></a><span id="l10.203" class="difflineminus">-    let accountTypeTotal = 0;</span>
<a href="#l10.204"></a><span id="l10.204" class="difflineminus">-    for (let [key, provider] of cloudFileAccounts.enumerateProviders()) {</span>
<a href="#l10.205"></a><span id="l10.205" class="difflineminus">-      // If we already have an account for this type, don't add it to the list.</span>
<a href="#l10.206"></a><span id="l10.206" class="difflineminus">-      // This limitation will hopefully be removed in the future.</span>
<a href="#l10.207"></a><span id="l10.207" class="difflineminus">-      if (cloudFileAccounts.getAccountsForType(key).length &gt; 0)</span>
<a href="#l10.208"></a><span id="l10.208" class="difflineminus">-        continue;</span>
<a href="#l10.209"></a><span id="l10.209" class="difflineminus">-</span>
<a href="#l10.210"></a><span id="l10.210" class="difflineminus">-      if (this._blacklist.has(key))</span>
<a href="#l10.211"></a><span id="l10.211" class="difflineminus">-        continue;</span>
<a href="#l10.212"></a><span id="l10.212" class="difflineminus">-</span>
<a href="#l10.213"></a><span id="l10.213" class="difflineminus">-      let menuitem = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l10.214"></a><span id="l10.214" class="difflineminus">-      menuitem.setAttribute(&quot;label&quot;, provider.displayName);</span>
<a href="#l10.215"></a><span id="l10.215" class="difflineminus">-      menuitem.setAttribute(&quot;value&quot;, key);</span>
<a href="#l10.216"></a><span id="l10.216" class="difflineminus">-</span>
<a href="#l10.217"></a><span id="l10.217" class="difflineminus">-      if (provider.iconClass) {</span>
<a href="#l10.218"></a><span id="l10.218" class="difflineminus">-        menuitem.setAttribute(&quot;class&quot;, &quot;menuitem-iconic menuitem-with-favicon&quot;);</span>
<a href="#l10.219"></a><span id="l10.219" class="difflineminus">-        menuitem.setAttribute(&quot;image&quot;, provider.iconClass);</span>
<a href="#l10.220"></a><span id="l10.220" class="difflineminus">-      }</span>
<a href="#l10.221"></a><span id="l10.221" class="difflineminus">-</span>
<a href="#l10.222"></a><span id="l10.222" class="difflineminus">-      this._accountType.menupopup.appendChild(menuitem);</span>
<a href="#l10.223"></a><span id="l10.223" class="difflineminus">-      accountTypeTotal++;</span>
<a href="#l10.224"></a><span id="l10.224" class="difflineminus">-    }</span>
<a href="#l10.225"></a><span id="l10.225" class="difflineminus">-</span>
<a href="#l10.226"></a><span id="l10.226" class="difflineminus">-    // This block should go away when bug 748437 gets fixed, since we'll</span>
<a href="#l10.227"></a><span id="l10.227" class="difflineminus">-    // be able to add an arbitrary number of accounts for each account type.</span>
<a href="#l10.228"></a><span id="l10.228" class="difflineminus">-    if (this._accountType.itemCount == 0) {</span>
<a href="#l10.229"></a><span id="l10.229" class="difflineminus">-      this._createAccountText.hidden = true;</span>
<a href="#l10.230"></a><span id="l10.230" class="difflineminus">-      this._accountType.hidden = true;</span>
<a href="#l10.231"></a><span id="l10.231" class="difflineminus">-      this._accept.disabled = true;</span>
<a href="#l10.232"></a><span id="l10.232" class="difflineminus">-      this._noAccountText.hidden = false;</span>
<a href="#l10.233"></a><span id="l10.233" class="difflineminus">-      this._settings.classList.remove(&quot;indent&quot;);</span>
<a href="#l10.234"></a><span id="l10.234" class="difflineminus">-      this._settings.classList.add(&quot;small-indent&quot;);</span>
<a href="#l10.235"></a><span id="l10.235" class="difflineminus">-      this._cancel.focus();</span>
<a href="#l10.236"></a><span id="l10.236" class="difflineminus">-    }</span>
<a href="#l10.237"></a><span id="l10.237" class="difflineminus">-</span>
<a href="#l10.238"></a><span id="l10.238" class="difflineminus">-    // If there's only one option, let's choose it for the user to avoid</span>
<a href="#l10.239"></a><span id="l10.239" class="difflineminus">-    // a few clicks.</span>
<a href="#l10.240"></a><span id="l10.240" class="difflineminus">-    if (this._accountType.itemCount == 1)</span>
<a href="#l10.241"></a><span id="l10.241" class="difflineminus">-      this._accountType.selectedIndex = 0;</span>
<a href="#l10.242"></a><span id="l10.242" class="difflineminus">-</span>
<a href="#l10.243"></a><span id="l10.243" class="difflineminus">-    return accountTypeTotal;</span>
<a href="#l10.244"></a><span id="l10.244" class="difflineminus">-  },</span>
<a href="#l10.245"></a><span id="l10.245" class="difflineminus">-</span>
<a href="#l10.246"></a><span id="l10.246" class="difflineminus">-  onOK() {</span>
<a href="#l10.247"></a><span id="l10.247" class="difflineminus">-    let accountType = this._accountType.value;</span>
<a href="#l10.248"></a><span id="l10.248" class="difflineminus">-    let obs = new createAccountObserver();</span>
<a href="#l10.249"></a><span id="l10.249" class="difflineminus">-</span>
<a href="#l10.250"></a><span id="l10.250" class="difflineminus">-    let extras = this.getExtraArgs();</span>
<a href="#l10.251"></a><span id="l10.251" class="difflineminus">-</span>
<a href="#l10.252"></a><span id="l10.252" class="difflineminus">-    cloudFileAccounts.createAccount(accountType, obs, extras);</span>
<a href="#l10.253"></a><span id="l10.253" class="difflineminus">-    this._accept.disabled = true;</span>
<a href="#l10.254"></a><span id="l10.254" class="difflineminus">-</span>
<a href="#l10.255"></a><span id="l10.255" class="difflineminus">-    this._messages.selectedPanel = this._authSpinner;</span>
<a href="#l10.256"></a><span id="l10.256" class="difflineminus">-</span>
<a href="#l10.257"></a><span id="l10.257" class="difflineminus">-    // Uninitialize the dialog before closing.</span>
<a href="#l10.258"></a><span id="l10.258" class="difflineminus">-    this.onUnInit();</span>
<a href="#l10.259"></a><span id="l10.259" class="difflineminus">-    return false;</span>
<a href="#l10.260"></a><span id="l10.260" class="difflineminus">-  },</span>
<a href="#l10.261"></a><span id="l10.261" class="difflineminus">-</span>
<a href="#l10.262"></a><span id="l10.262" class="difflineminus">-  getExtraArgs() {</span>
<a href="#l10.263"></a><span id="l10.263" class="difflineminus">-    if (!this._settings)</span>
<a href="#l10.264"></a><span id="l10.264" class="difflineminus">-      return {};</span>
<a href="#l10.265"></a><span id="l10.265" class="difflineminus">-</span>
<a href="#l10.266"></a><span id="l10.266" class="difflineminus">-    if (this._settings.contentDocument.location.href.startsWith(&quot;moz-extension:&quot;)) {</span>
<a href="#l10.267"></a><span id="l10.267" class="difflineminus">-      // WebExtensions use their own storage mechanism, don't use extraArgs from</span>
<a href="#l10.268"></a><span id="l10.268" class="difflineminus">-      // their content document</span>
<a href="#l10.269"></a><span id="l10.269" class="difflineminus">-      return {};</span>
<a href="#l10.270"></a><span id="l10.270" class="difflineminus">-    }</span>
<a href="#l10.271"></a><span id="l10.271" class="difflineminus">-</span>
<a href="#l10.272"></a><span id="l10.272" class="difflineminus">-    let func = this._settings.contentWindow</span>
<a href="#l10.273"></a><span id="l10.273" class="difflineminus">-                   .wrappedJSObject</span>
<a href="#l10.274"></a><span id="l10.274" class="difflineminus">-                   .extraArgs;</span>
<a href="#l10.275"></a><span id="l10.275" class="difflineminus">-    if (!func)</span>
<a href="#l10.276"></a><span id="l10.276" class="difflineminus">-      return {};</span>
<a href="#l10.277"></a><span id="l10.277" class="difflineminus">-</span>
<a href="#l10.278"></a><span id="l10.278" class="difflineminus">-    return func();</span>
<a href="#l10.279"></a><span id="l10.279" class="difflineminus">-  },</span>
<a href="#l10.280"></a><span id="l10.280" class="difflineminus">-</span>
<a href="#l10.281"></a><span id="l10.281" class="difflineminus">-  accountTypeSelected() {</span>
<a href="#l10.282"></a><span id="l10.282" class="difflineminus">-    let providerKey = this._accountType.selectedItem.value;</span>
<a href="#l10.283"></a><span id="l10.283" class="difflineminus">-    if (!providerKey)</span>
<a href="#l10.284"></a><span id="l10.284" class="difflineminus">-      return;</span>
<a href="#l10.285"></a><span id="l10.285" class="difflineminus">-</span>
<a href="#l10.286"></a><span id="l10.286" class="difflineminus">-    let provider = cloudFileAccounts.getProviderForType(providerKey);</span>
<a href="#l10.287"></a><span id="l10.287" class="difflineminus">-    if (!provider)</span>
<a href="#l10.288"></a><span id="l10.288" class="difflineminus">-      return;</span>
<a href="#l10.289"></a><span id="l10.289" class="difflineminus">-</span>
<a href="#l10.290"></a><span id="l10.290" class="difflineminus">-    // Reset the message display</span>
<a href="#l10.291"></a><span id="l10.291" class="difflineminus">-    this._messages.selectedIndex = -1;</span>
<a href="#l10.292"></a><span id="l10.292" class="difflineminus">-</span>
<a href="#l10.293"></a><span id="l10.293" class="difflineminus">-    // Load up the correct XHTML page for this provider.</span>
<a href="#l10.294"></a><span id="l10.294" class="difflineminus">-    this.setIFrameSource(provider.settingsURL);</span>
<a href="#l10.295"></a><span id="l10.295" class="difflineminus">-  },</span>
<a href="#l10.296"></a><span id="l10.296" class="difflineminus">-</span>
<a href="#l10.297"></a><span id="l10.297" class="difflineminus">-  onClickLink(e) {</span>
<a href="#l10.298"></a><span id="l10.298" class="difflineminus">-    e.preventDefault();</span>
<a href="#l10.299"></a><span id="l10.299" class="difflineminus">-    let href = e.target.getAttribute(&quot;href&quot;);</span>
<a href="#l10.300"></a><span id="l10.300" class="difflineminus">-    gProtocolService.loadURI(Services.io.newURI(href, &quot;UTF-8&quot;));</span>
<a href="#l10.301"></a><span id="l10.301" class="difflineminus">-  },</span>
<a href="#l10.302"></a><span id="l10.302" class="difflineminus">-</span>
<a href="#l10.303"></a><span id="l10.303" class="difflineminus">-  onInput() {</span>
<a href="#l10.304"></a><span id="l10.304" class="difflineminus">-    // Let's see if we have everything we need to make OK enabled...</span>
<a href="#l10.305"></a><span id="l10.305" class="difflineminus">-    if (this._accountType.selectedIndex == -1) {</span>
<a href="#l10.306"></a><span id="l10.306" class="difflineminus">-      // We have the &quot;Select a service provider&quot; menuitem selected, so we</span>
<a href="#l10.307"></a><span id="l10.307" class="difflineminus">-      // shouldn't be able to click &quot;Set up account&quot;</span>
<a href="#l10.308"></a><span id="l10.308" class="difflineminus">-      this._accept.disabled = true;</span>
<a href="#l10.309"></a><span id="l10.309" class="difflineminus">-    } else {</span>
<a href="#l10.310"></a><span id="l10.310" class="difflineminus">-      this._accept.disabled = !this.checkValidity();</span>
<a href="#l10.311"></a><span id="l10.311" class="difflineminus">-    }</span>
<a href="#l10.312"></a><span id="l10.312" class="difflineminus">-  },</span>
<a href="#l10.313"></a><span id="l10.313" class="difflineminus">-</span>
<a href="#l10.314"></a><span id="l10.314" class="difflineminus">-  checkValidity() {</span>
<a href="#l10.315"></a><span id="l10.315" class="difflineminus">-    // If there's a form in the iframe, ensure that</span>
<a href="#l10.316"></a><span id="l10.316" class="difflineminus">-    // it's checkValidity function passes.</span>
<a href="#l10.317"></a><span id="l10.317" class="difflineminus">-    let form = this._settings</span>
<a href="#l10.318"></a><span id="l10.318" class="difflineminus">-                   .contentWindow</span>
<a href="#l10.319"></a><span id="l10.319" class="difflineminus">-                   .wrappedJSObject</span>
<a href="#l10.320"></a><span id="l10.320" class="difflineminus">-                   .document</span>
<a href="#l10.321"></a><span id="l10.321" class="difflineminus">-                   .getElementById(kFormId);</span>
<a href="#l10.322"></a><span id="l10.322" class="difflineminus">-</span>
<a href="#l10.323"></a><span id="l10.323" class="difflineminus">-    if (form)</span>
<a href="#l10.324"></a><span id="l10.324" class="difflineminus">-      return form.checkValidity();</span>
<a href="#l10.325"></a><span id="l10.325" class="difflineminus">-</span>
<a href="#l10.326"></a><span id="l10.326" class="difflineminus">-    return true;</span>
<a href="#l10.327"></a><span id="l10.327" class="difflineminus">-  },</span>
<a href="#l10.328"></a><span id="l10.328" class="difflineminus">-};</span>
<a href="#l10.329"></a><span id="l10.329" class="difflineminus">-</span>
<a href="#l10.330"></a><span id="l10.330" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(this, &quot;gProtocolService&quot;,</span>
<a href="#l10.331"></a><span id="l10.331" class="difflineminus">-                                   &quot;@mozilla.org/uriloader/external-protocol-service;1&quot;,</span>
<a href="#l10.332"></a><span id="l10.332" class="difflineminus">-                                   &quot;nsIExternalProtocolService&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1">deleted file mode 100644</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineminus">--- a/mail/components/cloudfile/content/addAccountDialog.xul</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineplus">+++ /dev/null</span>
<a href="#l11.4"></a><span id="l11.4" class="difflineat">@@ -1,55 +0,0 @@</span>
<a href="#l11.5"></a><span id="l11.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l11.6"></a><span id="l11.6" class="difflineminus">-# This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l11.7"></a><span id="l11.7" class="difflineminus">-# License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l11.8"></a><span id="l11.8" class="difflineminus">-# file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l11.9"></a><span id="l11.9" class="difflineminus">-</span>
<a href="#l11.10"></a><span id="l11.10" class="difflineminus">-&lt;!DOCTYPE dialog [</span>
<a href="#l11.11"></a><span id="l11.11" class="difflineminus">-&lt;!ENTITY % brandDTD SYSTEM &quot;chrome://branding/locale/brand.dtd&quot;&gt;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineminus">-%brandDTD;</span>
<a href="#l11.13"></a><span id="l11.13" class="difflineminus">-&lt;!ENTITY % addAccountDialogDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/addAccountDialog.dtd&quot;&gt;</span>
<a href="#l11.14"></a><span id="l11.14" class="difflineminus">-%addAccountDialogDTD;</span>
<a href="#l11.15"></a><span id="l11.15" class="difflineminus">-]&gt;</span>
<a href="#l11.16"></a><span id="l11.16" class="difflineminus">-</span>
<a href="#l11.17"></a><span id="l11.17" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://global/skin/&quot;?&gt;</span>
<a href="#l11.18"></a><span id="l11.18" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/preferences/preferences.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l11.19"></a><span id="l11.19" class="difflineminus">-&lt;?xml-stylesheet href=&quot;chrome://messenger/skin/cloudfile/addAccountDialog.css&quot; type=&quot;text/css&quot;?&gt;</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineminus">-&lt;dialog id=&quot;addCloudFileAccount&quot;</span>
<a href="#l11.22"></a><span id="l11.22" class="difflineminus">-        xmlns=&quot;http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul&quot;</span>
<a href="#l11.23"></a><span id="l11.23" class="difflineminus">-        buttons=&quot;accept,cancel&quot;</span>
<a href="#l11.24"></a><span id="l11.24" class="difflineminus">-        buttonlabelaccept=&quot;&amp;addAccountDialog.acceptButton.label;&quot;</span>
<a href="#l11.25"></a><span id="l11.25" class="difflineminus">-        buttondisabledaccept=&quot;true&quot;</span>
<a href="#l11.26"></a><span id="l11.26" class="difflineminus">-        onload=&quot;return addAccountDialog.onInit();&quot;</span>
<a href="#l11.27"></a><span id="l11.27" class="difflineminus">-        ondialogaccept=&quot;return addAccountDialog.onOK();&quot;</span>
<a href="#l11.28"></a><span id="l11.28" class="difflineminus">-        ondialogcancel=&quot;return addAccountDialog.onUnInit();&quot;</span>
<a href="#l11.29"></a><span id="l11.29" class="difflineminus">-        title=&quot;&amp;addAccountDialog.title;&quot;</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineminus">-        style=&quot;&amp;addAccountDialog.style;&quot;</span>
<a href="#l11.31"></a><span id="l11.31" class="difflineminus">-        persist=&quot;screenX screenY&quot;&gt;</span>
<a href="#l11.32"></a><span id="l11.32" class="difflineminus">-</span>
<a href="#l11.33"></a><span id="l11.33" class="difflineminus">-  &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l11.34"></a><span id="l11.34" class="difflineminus">-          src=&quot;chrome://messenger/content/cloudfile/addAccountDialog.js&quot;/&gt;</span>
<a href="#l11.35"></a><span id="l11.35" class="difflineminus">-</span>
<a href="#l11.36"></a><span id="l11.36" class="difflineminus">-#ifdef XP_MACOSX</span>
<a href="#l11.37"></a><span id="l11.37" class="difflineminus">-  &lt;description id=&quot;createAccountTitle&quot;&gt;&amp;addAccountDialog.title;&lt;/description&gt;</span>
<a href="#l11.38"></a><span id="l11.38" class="difflineminus">-#endif</span>
<a href="#l11.39"></a><span id="l11.39" class="difflineminus">-  &lt;description id=&quot;createAccountText&quot;&gt;&amp;addAccountDialog.createAccountText2;&lt;/description&gt;</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineminus">-  &lt;description id=&quot;noAccountText&quot; hidden=&quot;true&quot;&gt;&amp;addAccountDialog.noAccountText;&lt;/description&gt;</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineminus">-</span>
<a href="#l11.42"></a><span id="l11.42" class="difflineminus">-  &lt;menulist id=&quot;accountType&quot; class=&quot;indent&quot;&gt;</span>
<a href="#l11.43"></a><span id="l11.43" class="difflineminus">-    &lt;menupopup&gt;</span>
<a href="#l11.44"></a><span id="l11.44" class="difflineminus">-      &lt;menuitem label=&quot;&amp;addAccountDialog.menuTitle;&quot; value=&quot;&quot;/&gt;</span>
<a href="#l11.45"></a><span id="l11.45" class="difflineminus">-    &lt;/menupopup&gt;</span>
<a href="#l11.46"></a><span id="l11.46" class="difflineminus">-  &lt;/menulist&gt;</span>
<a href="#l11.47"></a><span id="l11.47" class="difflineminus">-</span>
<a href="#l11.48"></a><span id="l11.48" class="difflineminus">-  &lt;iframe id=&quot;accountSettings&quot; class=&quot;indent&quot; flex=&quot;1&quot; src=&quot;chrome://messenger/content/cloudfile/emptySettings.xhtml&quot;/&gt;</span>
<a href="#l11.49"></a><span id="l11.49" class="difflineminus">-  &lt;deck id=&quot;messages&quot; class=&quot;indent&quot; selectedIndex=&quot;-1&quot;&gt;</span>
<a href="#l11.50"></a><span id="l11.50" class="difflineminus">-    &lt;hbox id=&quot;authorizing&quot;&gt;</span>
<a href="#l11.51"></a><span id="l11.51" class="difflineminus">-      &lt;image src=&quot;chrome://global/skin/icons/loading.png&quot;/&gt;</span>
<a href="#l11.52"></a><span id="l11.52" class="difflineminus">-      &lt;label&gt;&amp;addAccountDialog.authorizing;&lt;/label&gt;</span>
<a href="#l11.53"></a><span id="l11.53" class="difflineminus">-    &lt;/hbox&gt;</span>
<a href="#l11.54"></a><span id="l11.54" class="difflineminus">-    &lt;hbox id=&quot;error&quot;&gt;</span>
<a href="#l11.55"></a><span id="l11.55" class="difflineminus">-      &lt;image src=&quot;chrome://global/skin/icons/warning.svg&quot;/&gt;</span>
<a href="#l11.56"></a><span id="l11.56" class="difflineminus">-      &lt;label&gt;&amp;addAccountDialog.error;&lt;/label&gt;</span>
<a href="#l11.57"></a><span id="l11.57" class="difflineminus">-    &lt;/hbox&gt;</span>
<a href="#l11.58"></a><span id="l11.58" class="difflineminus">-  &lt;/deck&gt;</span>
<a href="#l11.59"></a><span id="l11.59" class="difflineminus">-&lt;/dialog&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">deleted file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- a/mail/components/cloudfile/content/emptySettings.xhtml</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ /dev/null</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -1,21 +0,0 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineminus">-</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineminus">-&lt;!DOCTYPE html [</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineminus">-  &lt;!ENTITY % htmlDTD PUBLIC &quot;-//W3C//DTD XHTML 1.0 Strict//EN&quot; &quot;DTD/xhtml1-strict.dtd&quot;&gt; %htmlDTD;</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineminus">-  &lt;!ENTITY % aadDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/addAccountDialog.dtd&quot;&gt; %aadDTD;</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineminus">-]&gt;</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineminus">-&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineminus">-  &lt;head&gt;</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineminus">-    &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineminus">-          type=&quot;text/css&quot;</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineminus">-          href=&quot;chrome://messenger/skin/cloudfile/addAccountDialog.css&quot;/&gt;</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineminus">-  &lt;/head&gt;</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineminus">-  &lt;body id=&quot;provider-settings&quot;&gt;</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineminus">-    &lt;div id=&quot;learn-more&quot;&gt;</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineminus">-      &lt;a href=&quot;&quot;&gt;&amp;addAccountDialog.learnMore;&lt;/a&gt;</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineminus">-    &lt;/div&gt;</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineminus">-  &lt;/body&gt;</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineminus">-&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1">rename from mail/components/cloudfile/content/Hightail/fileExceeds2GB.xul</span>
<a href="#l13.2"></a><span id="l13.2">rename to mail/components/cloudfile/hightail/fileExceeds2GB.xul</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1">rename from mail/components/cloudfile/content/Hightail/fileExceedsLimit.xul</span>
<a href="#l14.2"></a><span id="l14.2">rename to mail/components/cloudfile/hightail/fileExceedsLimit.xul</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1">rename from mail/components/cloudfile/content/Hightail/fileExceedsQuota.js</span>
<a href="#l15.2"></a><span id="l15.2">rename to mail/components/cloudfile/hightail/fileExceedsQuota.js</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1">rename from mail/components/cloudfile/content/Hightail/fileExceedsQuota.xul</span>
<a href="#l16.2"></a><span id="l16.2">rename to mail/components/cloudfile/hightail/fileExceedsQuota.xul</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1">rename from mail/components/cloudfile/nsHightail.js</span>
<a href="#l17.2"></a><span id="l17.2">rename to mail/components/cloudfile/hightail/hightail.jsm</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineminus">--- a/mail/components/cloudfile/nsHightail.js</span>
<a href="#l17.4"></a><span id="l17.4" class="difflineplus">+++ b/mail/components/cloudfile/hightail/hightail.jsm</span>
<a href="#l17.5"></a><span id="l17.5" class="difflineat">@@ -1,21 +1,19 @@</span>
<a href="#l17.6"></a><span id="l17.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l17.7"></a><span id="l17.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l17.8"></a><span id="l17.8">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l17.9"></a><span id="l17.9"> </span>
<a href="#l17.10"></a><span id="l17.10" class="difflineminus">-/* This file implements the nsIMsgCloudFileProvider interface.</span>
<a href="#l17.11"></a><span id="l17.11" class="difflineminus">- *</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineminus">- * This component handles the Hightail implementation of the</span>
<a href="#l17.13"></a><span id="l17.13" class="difflineminus">- * nsIMsgCloudFileProvider interface.</span>
<a href="#l17.14"></a><span id="l17.14" class="difflineminus">- */</span>
<a href="#l17.15"></a><span id="l17.15" class="difflineplus">+/* This is the Hightail cloudfile provider.</span>
<a href="#l17.16"></a><span id="l17.16" class="difflineplus">+ * It's in a JSM that exports nothing because it's a self-contained singleton. */</span>
<a href="#l17.17"></a><span id="l17.17" class="difflineplus">+</span>
<a href="#l17.18"></a><span id="l17.18" class="difflineplus">+this.EXPORTED_SYMBOLS = [];</span>
<a href="#l17.19"></a><span id="l17.19"> </span>
<a href="#l17.20"></a><span id="l17.20"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l17.21"></a><span id="l17.21" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l17.22"></a><span id="l17.22" class="difflineminus">-var { Log4Moz } = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l17.23"></a><span id="l17.23" class="difflineplus">+var {Log4Moz} = ChromeUtils.import(&quot;resource:///modules/gloda/log4moz.js&quot;);</span>
<a href="#l17.24"></a><span id="l17.24"> var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l17.25"></a><span id="l17.25"> </span>
<a href="#l17.26"></a><span id="l17.26"> var gServerUrl = &quot;https://dpi.yousendit.com&quot;; // Production url</span>
<a href="#l17.27"></a><span id="l17.27"> // test url var gServerUrl = &quot;https://test2-api.yousendit.com&quot;;</span>
<a href="#l17.28"></a><span id="l17.28"> </span>
<a href="#l17.29"></a><span id="l17.29"> var kApiKey = &quot;7spvjdt7m4kycr7jyhywrdn2&quot;;</span>
<a href="#l17.30"></a><span id="l17.30"> var kAuthPath = &quot;/dpi/v1/auth&quot;;</span>
<a href="#l17.31"></a><span id="l17.31"> var kUserInfoPath = &quot;/dpi/v2/user&quot;;</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineat">@@ -25,30 +23,29 @@ var kFolderInitUploadPath = kFolderPath </span>
<a href="#l17.33"></a><span id="l17.33"> var kFolderCommitUploadPath = kFolderPath + &quot;file/commitUpload&quot;;</span>
<a href="#l17.34"></a><span id="l17.34"> var kUrlTail = &quot;s=4001583&amp;cid=pm-4001583&quot;;</span>
<a href="#l17.35"></a><span id="l17.35"> </span>
<a href="#l17.36"></a><span id="l17.36"> function nsHightail() {</span>
<a href="#l17.37"></a><span id="l17.37">   this.log = Log4Moz.getConfiguredLogger(&quot;Hightail&quot;);</span>
<a href="#l17.38"></a><span id="l17.38"> }</span>
<a href="#l17.39"></a><span id="l17.39"> </span>
<a href="#l17.40"></a><span id="l17.40"> nsHightail.prototype = {</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-  /* nsISupports */</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgCloudFileProvider]),</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineminus">-</span>
<a href="#l17.44"></a><span id="l17.44" class="difflineminus">-  classID: Components.ID(&quot;{dd2bce44-ca71-42ce-b806-6fa4e073919c}&quot;),</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">-</span>
<a href="#l17.46"></a><span id="l17.46">   get type() { return &quot;YouSendIt&quot;; }, // Saved in prefs, cannot change!</span>
<a href="#l17.47"></a><span id="l17.47">   get displayName() { return &quot;Hightail&quot;; },</span>
<a href="#l17.48"></a><span id="l17.48">   get serviceURL() { return &quot;https://www.hightail.com&quot;; },</span>
<a href="#l17.49"></a><span id="l17.49" class="difflineminus">-  get iconClass() { return &quot;chrome://messenger/skin/icons/hightail.png&quot;; },</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineplus">+  get iconURL() { return &quot;chrome://messenger/skin/icons/hightail.png&quot;; },</span>
<a href="#l17.51"></a><span id="l17.51">   get accountKey() { return this._accountKey; },</span>
<a href="#l17.52"></a><span id="l17.52">   get lastError() { return this._lastErrorText; },</span>
<a href="#l17.53"></a><span id="l17.53">   get settingsURL() { return &quot;chrome://messenger/content/cloudfile/Hightail/settings.xhtml&quot;; },</span>
<a href="#l17.54"></a><span id="l17.54">   get managementURL() { return &quot;chrome://messenger/content/cloudfile/Hightail/management.xhtml&quot;; },</span>
<a href="#l17.55"></a><span id="l17.55"> </span>
<a href="#l17.56"></a><span id="l17.56" class="difflineplus">+  get configured() {</span>
<a href="#l17.57"></a><span id="l17.57" class="difflineplus">+    return !!cloudFileAccounts.getSecretValue(this._accountKey, cloudFileAccounts.kTokenRealm);</span>
<a href="#l17.58"></a><span id="l17.58" class="difflineplus">+  },</span>
<a href="#l17.59"></a><span id="l17.59" class="difflineplus">+</span>
<a href="#l17.60"></a><span id="l17.60">   _accountKey: false,</span>
<a href="#l17.61"></a><span id="l17.61">   _prefBranch: null,</span>
<a href="#l17.62"></a><span id="l17.62">   _userName: &quot;&quot;,</span>
<a href="#l17.63"></a><span id="l17.63">   _password: &quot;&quot;,</span>
<a href="#l17.64"></a><span id="l17.64">   _loggedIn: false,</span>
<a href="#l17.65"></a><span id="l17.65">   _userInfo: null,</span>
<a href="#l17.66"></a><span id="l17.66">   _file: null,</span>
<a href="#l17.67"></a><span id="l17.67">   _folderId: &quot;&quot;,</span>
<a href="#l17.68"></a><span id="l17.68" class="difflineat">@@ -79,18 +76,17 @@ nsHightail.prototype = {</span>
<a href="#l17.69"></a><span id="l17.69">    * Initializes an instance of this nsIMsgCloudFileProvider for an account</span>
<a href="#l17.70"></a><span id="l17.70">    * with key aAccountKey.</span>
<a href="#l17.71"></a><span id="l17.71">    *</span>
<a href="#l17.72"></a><span id="l17.72">    * @param aAccountKey the account key to initialize this</span>
<a href="#l17.73"></a><span id="l17.73">    *                    nsIMsgCloudFileProvider with.</span>
<a href="#l17.74"></a><span id="l17.74">    */</span>
<a href="#l17.75"></a><span id="l17.75">   init(aAccountKey) {</span>
<a href="#l17.76"></a><span id="l17.76">     this._accountKey = aAccountKey;</span>
<a href="#l17.77"></a><span id="l17.77" class="difflineminus">-    this._prefBranch = Services.prefs.getBranch(&quot;mail.cloud_files.accounts.&quot; +</span>
<a href="#l17.78"></a><span id="l17.78" class="difflineminus">-                                                aAccountKey + &quot;.&quot;);</span>
<a href="#l17.79"></a><span id="l17.79" class="difflineplus">+    this._prefBranch = Services.prefs.getBranch(`mail.cloud_files.accounts.${aAccountKey}.`);</span>
<a href="#l17.80"></a><span id="l17.80">     this._userName = this._prefBranch.getCharPref(&quot;username&quot;);</span>
<a href="#l17.81"></a><span id="l17.81">     this._loggedIn = this._cachedAuthToken != &quot;&quot;;</span>
<a href="#l17.82"></a><span id="l17.82">   },</span>
<a href="#l17.83"></a><span id="l17.83"> </span>
<a href="#l17.84"></a><span id="l17.84">   /**</span>
<a href="#l17.85"></a><span id="l17.85">    * Private function for retrieving or creating folder</span>
<a href="#l17.86"></a><span id="l17.86">    * on Hightail website for uploading file.</span>
<a href="#l17.87"></a><span id="l17.87">    *</span>
<a href="#l17.88"></a><span id="l17.88" class="difflineat">@@ -162,17 +158,17 @@ nsHightail.prototype = {</span>
<a href="#l17.89"></a><span id="l17.89">    * Attempt to upload a file to Hightail's servers.</span>
<a href="#l17.90"></a><span id="l17.90">    *</span>
<a href="#l17.91"></a><span id="l17.91">    * @param aFile an nsIFile for uploading.</span>
<a href="#l17.92"></a><span id="l17.92">    * @param aCallback an nsIRequestObserver for monitoring the start and</span>
<a href="#l17.93"></a><span id="l17.93">    *                  stop states of the upload procedure.</span>
<a href="#l17.94"></a><span id="l17.94">    */</span>
<a href="#l17.95"></a><span id="l17.95">   uploadFile(aFile, aCallback) {</span>
<a href="#l17.96"></a><span id="l17.96">     if (Services.io.offline)</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l17.98"></a><span id="l17.98" class="difflineplus">+      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l17.99"></a><span id="l17.99"> </span>
<a href="#l17.100"></a><span id="l17.100">     this.log.info(&quot;Preparing to upload a file&quot;);</span>
<a href="#l17.101"></a><span id="l17.101"> </span>
<a href="#l17.102"></a><span id="l17.102">     // if we're uploading a file, queue this request.</span>
<a href="#l17.103"></a><span id="l17.103">     if (this._uploadingFile &amp;&amp; this._uploadingFile != aFile) {</span>
<a href="#l17.104"></a><span id="l17.104">       this.log.info(&quot;Adding file to queue&quot;);</span>
<a href="#l17.105"></a><span id="l17.105">       let uploader = new nsHightailFileUploader(this, aFile,</span>
<a href="#l17.106"></a><span id="l17.106">                                                  this._uploaderCallback</span>
<a href="#l17.107"></a><span id="l17.107" class="difflineat">@@ -189,17 +185,17 @@ nsHightail.prototype = {</span>
<a href="#l17.108"></a><span id="l17.108">     }.bind(this);</span>
<a href="#l17.109"></a><span id="l17.109"> </span>
<a href="#l17.110"></a><span id="l17.110">     let onGetUserInfoSuccess = function() {</span>
<a href="#l17.111"></a><span id="l17.111">       this._initFolder(finish);</span>
<a href="#l17.112"></a><span id="l17.112">     }.bind(this);</span>
<a href="#l17.113"></a><span id="l17.113"> </span>
<a href="#l17.114"></a><span id="l17.114">     let onAuthFailure = function() {</span>
<a href="#l17.115"></a><span id="l17.115">       aCallback.onStopRequest(null, null,</span>
<a href="#l17.116"></a><span id="l17.116" class="difflineminus">-                              Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l17.117"></a><span id="l17.117" class="difflineplus">+                              cloudFileAccounts.constants.authErr);</span>
<a href="#l17.118"></a><span id="l17.118">     };</span>
<a href="#l17.119"></a><span id="l17.119"> </span>
<a href="#l17.120"></a><span id="l17.120">     this.log.info(&quot;Checking to see if we're logged in&quot;);</span>
<a href="#l17.121"></a><span id="l17.121"> </span>
<a href="#l17.122"></a><span id="l17.122">     if (!this._loggedIn) {</span>
<a href="#l17.123"></a><span id="l17.123">       let onLoginSuccess = function() {</span>
<a href="#l17.124"></a><span id="l17.124">         this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l17.125"></a><span id="l17.125">       }.bind(this);</span>
<a href="#l17.126"></a><span id="l17.126" class="difflineat">@@ -255,17 +251,17 @@ nsHightail.prototype = {</span>
<a href="#l17.127"></a><span id="l17.127"> </span>
<a href="#l17.128"></a><span id="l17.128">   /**</span>
<a href="#l17.129"></a><span id="l17.129">    * A private function called when upload exceeds file limit.</span>
<a href="#l17.130"></a><span id="l17.130">    *</span>
<a href="#l17.131"></a><span id="l17.131">    * @param aCallback the nsIRequestObserver for monitoring the start and stop</span>
<a href="#l17.132"></a><span id="l17.132">    *                  states of the upload procedure.</span>
<a href="#l17.133"></a><span id="l17.133">    */</span>
<a href="#l17.134"></a><span id="l17.134">   _fileExceedsLimit(aCallback, aType, aStorageSize) {</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineminus">-    let cancel = Ci.nsIMsgCloudFileProvider.uploadCanceled;</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+    let cancel = cloudFileAccounts.constants.uploadCancelled;</span>
<a href="#l17.137"></a><span id="l17.137"> </span>
<a href="#l17.138"></a><span id="l17.138">     let args = {storage: aStorageSize};</span>
<a href="#l17.139"></a><span id="l17.139">     args.wrappedJSObject = args;</span>
<a href="#l17.140"></a><span id="l17.140">     Services.ww.openWindow(null,</span>
<a href="#l17.141"></a><span id="l17.141">                            &quot;chrome://messenger/content/cloudfile/Hightail/&quot;</span>
<a href="#l17.142"></a><span id="l17.142">                            + &quot;fileExceeds&quot; + aType + &quot;.xul&quot;,</span>
<a href="#l17.143"></a><span id="l17.143">                            &quot;Hightail&quot;, &quot;chrome,centerscreen,dialog,modal,resizable=yes&quot;,</span>
<a href="#l17.144"></a><span id="l17.144">                            args).focus();</span>
<a href="#l17.145"></a><span id="l17.145" class="difflineat">@@ -282,17 +278,17 @@ nsHightail.prototype = {</span>
<a href="#l17.146"></a><span id="l17.146">     this.log.info(&quot;in cancel upload&quot;);</span>
<a href="#l17.147"></a><span id="l17.147">     if (this._uploadingFile != null &amp;&amp; this._uploader != null &amp;&amp;</span>
<a href="#l17.148"></a><span id="l17.148">         this._uploadingFile.equals(aFile)) {</span>
<a href="#l17.149"></a><span id="l17.149">       this._uploader.cancel();</span>
<a href="#l17.150"></a><span id="l17.150">     } else {</span>
<a href="#l17.151"></a><span id="l17.151">       for (let i = 0; i &lt; this._uploads.length; i++)</span>
<a href="#l17.152"></a><span id="l17.152">         if (this._uploads[i].file.equals(aFile)) {</span>
<a href="#l17.153"></a><span id="l17.153">           this._uploads[i].requestObserver.onStopRequest(</span>
<a href="#l17.154"></a><span id="l17.154" class="difflineminus">-            null, null, Ci.nsIMsgCloudFileProvider.uploadCanceled);</span>
<a href="#l17.155"></a><span id="l17.155" class="difflineplus">+            null, null, cloudFileAccounts.constants.uploadCancelled);</span>
<a href="#l17.156"></a><span id="l17.156">           this._uploads.splice(i, 1);</span>
<a href="#l17.157"></a><span id="l17.157">           return;</span>
<a href="#l17.158"></a><span id="l17.158">         }</span>
<a href="#l17.159"></a><span id="l17.159">     }</span>
<a href="#l17.160"></a><span id="l17.160">   },</span>
<a href="#l17.161"></a><span id="l17.161"> </span>
<a href="#l17.162"></a><span id="l17.162">   /**</span>
<a href="#l17.163"></a><span id="l17.163">    * A private function for dealing with stale tokens.  Attempts to refresh</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineat">@@ -403,28 +399,28 @@ nsHightail.prototype = {</span>
<a href="#l17.165"></a><span id="l17.165">    *</span>
<a href="#l17.166"></a><span id="l17.166">    * @param aWithUI a boolean for whether or not we should prompt the user for</span>
<a href="#l17.167"></a><span id="l17.167">    *                a password if we don't have a proper token.</span>
<a href="#l17.168"></a><span id="l17.168">    * @param aListener an nsIRequestObserver for monitoring the start and stop</span>
<a href="#l17.169"></a><span id="l17.169">    *                  states of fetching profile information.</span>
<a href="#l17.170"></a><span id="l17.170">    */</span>
<a href="#l17.171"></a><span id="l17.171">   refreshUserInfo(aWithUI, aListener) {</span>
<a href="#l17.172"></a><span id="l17.172">     if (Services.io.offline)</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l17.174"></a><span id="l17.174" class="difflineplus">+      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l17.175"></a><span id="l17.175"> </span>
<a href="#l17.176"></a><span id="l17.176">     aListener.onStartRequest(null, null);</span>
<a href="#l17.177"></a><span id="l17.177"> </span>
<a href="#l17.178"></a><span id="l17.178">     // Let's define some reusable callback functions...</span>
<a href="#l17.179"></a><span id="l17.179">     let onGetUserInfoSuccess = function() {</span>
<a href="#l17.180"></a><span id="l17.180">       aListener.onStopRequest(null, null, Cr.NS_OK);</span>
<a href="#l17.181"></a><span id="l17.181">     };</span>
<a href="#l17.182"></a><span id="l17.182"> </span>
<a href="#l17.183"></a><span id="l17.183">     let onAuthFailure = function() {</span>
<a href="#l17.184"></a><span id="l17.184">       aListener.onStopRequest(null, null,</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineminus">-                              Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l17.186"></a><span id="l17.186" class="difflineplus">+                              cloudFileAccounts.constants.authErr);</span>
<a href="#l17.187"></a><span id="l17.187">     };</span>
<a href="#l17.188"></a><span id="l17.188"> </span>
<a href="#l17.189"></a><span id="l17.189">     // If we're not logged in, attempt to login, and then attempt to</span>
<a href="#l17.190"></a><span id="l17.190">     // get user info if logging in is successful.</span>
<a href="#l17.191"></a><span id="l17.191">     this.log.info(&quot;Checking to see if we're logged in&quot;);</span>
<a href="#l17.192"></a><span id="l17.192">     if (!this._loggedIn) {</span>
<a href="#l17.193"></a><span id="l17.193">       let onLoginSuccess = function() {</span>
<a href="#l17.194"></a><span id="l17.194">         this._getUserInfo(onGetUserInfoSuccess, onAuthFailure);</span>
<a href="#l17.195"></a><span id="l17.195" class="difflineat">@@ -440,17 +436,17 @@ nsHightail.prototype = {</span>
<a href="#l17.196"></a><span id="l17.196">   },</span>
<a href="#l17.197"></a><span id="l17.197"> </span>
<a href="#l17.198"></a><span id="l17.198">   /**</span>
<a href="#l17.199"></a><span id="l17.199">    * Creates an account for a user.  Note that, currently, this function is</span>
<a href="#l17.200"></a><span id="l17.200">    * not being used by the UI.</span>
<a href="#l17.201"></a><span id="l17.201">    */</span>
<a href="#l17.202"></a><span id="l17.202">   createNewAccount(aEmailAddress, aPassword, aFirstName, aLastName, aRequestObserver) {</span>
<a href="#l17.203"></a><span id="l17.203">     if (Services.io.offline)</span>
<a href="#l17.204"></a><span id="l17.204" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l17.205"></a><span id="l17.205" class="difflineplus">+      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l17.206"></a><span id="l17.206"> </span>
<a href="#l17.207"></a><span id="l17.207">     let args = &quot;?email=&quot; + aEmailAddress + &quot;&amp;password=&quot; + aPassword + &quot;&amp;firstname=&quot;</span>
<a href="#l17.208"></a><span id="l17.208">                + aFirstName + &quot;&amp;lastname=&quot; + aLastName + &quot;&amp;&quot;;</span>
<a href="#l17.209"></a><span id="l17.209"> </span>
<a href="#l17.210"></a><span id="l17.210">     let req = new XMLHttpRequest();</span>
<a href="#l17.211"></a><span id="l17.211"> </span>
<a href="#l17.212"></a><span id="l17.212">     req.open(&quot;POST&quot;, gServerUrl + kUserInfoPath + args + kUrlTail, true);</span>
<a href="#l17.213"></a><span id="l17.213"> </span>
<a href="#l17.214"></a><span id="l17.214" class="difflineat">@@ -518,17 +514,17 @@ nsHightail.prototype = {</span>
<a href="#l17.215"></a><span id="l17.215">    *</span>
<a href="#l17.216"></a><span id="l17.216">    * @param aFolderId id of folder</span>
<a href="#l17.217"></a><span id="l17.217">    * @param aNotFoundCallback called if folder is not found</span>
<a href="#l17.218"></a><span id="l17.218">    * @param aFoundCallback called if folder is found</span>
<a href="#l17.219"></a><span id="l17.219">    */</span>
<a href="#l17.220"></a><span id="l17.220">   _checkFolderExist(aFolderId, aFoundCallback, aNotFoundCallback) {</span>
<a href="#l17.221"></a><span id="l17.221">     this.log.info(&quot;checkFolderExist&quot;);</span>
<a href="#l17.222"></a><span id="l17.222">     if (Services.io.offline)</span>
<a href="#l17.223"></a><span id="l17.223" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l17.224"></a><span id="l17.224" class="difflineplus">+      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l17.225"></a><span id="l17.225"> </span>
<a href="#l17.226"></a><span id="l17.226">     let args = &quot;?includeFiles=false&amp;includeFolders=true&amp;&quot;;</span>
<a href="#l17.227"></a><span id="l17.227"> </span>
<a href="#l17.228"></a><span id="l17.228">     let req = new XMLHttpRequest();</span>
<a href="#l17.229"></a><span id="l17.229"> </span>
<a href="#l17.230"></a><span id="l17.230">     req.open(&quot;GET&quot;,</span>
<a href="#l17.231"></a><span id="l17.231">              gServerUrl + kFolderPath + aFolderId + args + kUrlTail,</span>
<a href="#l17.232"></a><span id="l17.232">              true);</span>
<a href="#l17.233"></a><span id="l17.233" class="difflineat">@@ -566,17 +562,17 @@ nsHightail.prototype = {</span>
<a href="#l17.234"></a><span id="l17.234">    *</span>
<a href="#l17.235"></a><span id="l17.235">    * @param aName name of folder</span>
<a href="#l17.236"></a><span id="l17.236">    * @param aParent id of parent folder</span>
<a href="#l17.237"></a><span id="l17.237">    * @param aSuccessCallback called when folder is created</span>
<a href="#l17.238"></a><span id="l17.238">    */</span>
<a href="#l17.239"></a><span id="l17.239">   _createFolder(aName, aParent, aSuccessCallback) {</span>
<a href="#l17.240"></a><span id="l17.240">     this.log.info(&quot;Create folder: &quot; + aName);</span>
<a href="#l17.241"></a><span id="l17.241">     if (Services.io.offline)</span>
<a href="#l17.242"></a><span id="l17.242" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l17.243"></a><span id="l17.243" class="difflineplus">+      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l17.244"></a><span id="l17.244"> </span>
<a href="#l17.245"></a><span id="l17.245">     let args = &quot;?name=&quot; + aName + &quot;&amp;parentId=&quot; + aParent + &quot;&amp;&quot;;</span>
<a href="#l17.246"></a><span id="l17.246"> </span>
<a href="#l17.247"></a><span id="l17.247">     let req = new XMLHttpRequest();</span>
<a href="#l17.248"></a><span id="l17.248"> </span>
<a href="#l17.249"></a><span id="l17.249">     req.open(&quot;POST&quot;, gServerUrl + kFolderPath.replace(/\/$/, &quot;&quot;) + args + kUrlTail, true);</span>
<a href="#l17.250"></a><span id="l17.250"> </span>
<a href="#l17.251"></a><span id="l17.251">     req.onload = function() {</span>
<a href="#l17.252"></a><span id="l17.252" class="difflineat">@@ -615,30 +611,30 @@ nsHightail.prototype = {</span>
<a href="#l17.253"></a><span id="l17.253">   createExistingAccount(aRequestObserver) {</span>
<a href="#l17.254"></a><span id="l17.254">      // XXX: replace this with a better function</span>
<a href="#l17.255"></a><span id="l17.255">     let successCb = function(aResponseText, aRequest) {</span>
<a href="#l17.256"></a><span id="l17.256">       aRequestObserver.onStopRequest(null, this, Cr.NS_OK);</span>
<a href="#l17.257"></a><span id="l17.257">     }.bind(this);</span>
<a href="#l17.258"></a><span id="l17.258"> </span>
<a href="#l17.259"></a><span id="l17.259">     let failureCb = function(aResponseText, aRequest) {</span>
<a href="#l17.260"></a><span id="l17.260">       aRequestObserver.onStopRequest(null, this,</span>
<a href="#l17.261"></a><span id="l17.261" class="difflineminus">-                                     Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l17.262"></a><span id="l17.262" class="difflineplus">+                                     cloudFileAccounts.constants.authErr);</span>
<a href="#l17.263"></a><span id="l17.263">     }.bind(this);</span>
<a href="#l17.264"></a><span id="l17.264"> </span>
<a href="#l17.265"></a><span id="l17.265">     this.logon(successCb, failureCb, true);</span>
<a href="#l17.266"></a><span id="l17.266">   },</span>
<a href="#l17.267"></a><span id="l17.267"> </span>
<a href="#l17.268"></a><span id="l17.268">   /**</span>
<a href="#l17.269"></a><span id="l17.269">    * Returns an appropriate provider-specific URL for dealing with a particular</span>
<a href="#l17.270"></a><span id="l17.270">    * error type.</span>
<a href="#l17.271"></a><span id="l17.271">    *</span>
<a href="#l17.272"></a><span id="l17.272">    * @param aError an error to get the URL for.</span>
<a href="#l17.273"></a><span id="l17.273">    */</span>
<a href="#l17.274"></a><span id="l17.274">   providerUrlForError(aError) {</span>
<a href="#l17.275"></a><span id="l17.275" class="difflineminus">-    if (aError == Ci.nsIMsgCloudFileProvider.uploadExceedsFileLimit)</span>
<a href="#l17.276"></a><span id="l17.276" class="difflineplus">+    if (aError == cloudFileAccounts.constants.uploadExceedsFileLimit)</span>
<a href="#l17.277"></a><span id="l17.277">       return &quot;http://www.hightail.com&quot;;</span>
<a href="#l17.278"></a><span id="l17.278">     return &quot;&quot;;</span>
<a href="#l17.279"></a><span id="l17.279">   },</span>
<a href="#l17.280"></a><span id="l17.280"> </span>
<a href="#l17.281"></a><span id="l17.281">   /**</span>
<a href="#l17.282"></a><span id="l17.282">    * If the provider doesn't have an API for creating an account, perhaps</span>
<a href="#l17.283"></a><span id="l17.283">    * there's a url we can load in a content tab that will allow the user</span>
<a href="#l17.284"></a><span id="l17.284">    * to create an account.</span>
<a href="#l17.285"></a><span id="l17.285" class="difflineat">@@ -661,17 +657,17 @@ nsHightail.prototype = {</span>
<a href="#l17.286"></a><span id="l17.286">    * @param aCallback an nsIRequestObserver for monitoring the start and stop</span>
<a href="#l17.287"></a><span id="l17.287">    *                  states of the delete procedure.</span>
<a href="#l17.288"></a><span id="l17.288">    */</span>
<a href="#l17.289"></a><span id="l17.289">   deleteFile(aFile, aCallback) {</span>
<a href="#l17.290"></a><span id="l17.290">     this.log.info(&quot;Deleting a file&quot;);</span>
<a href="#l17.291"></a><span id="l17.291"> </span>
<a href="#l17.292"></a><span id="l17.292">     if (Services.io.offline) {</span>
<a href="#l17.293"></a><span id="l17.293">       this.log.error(&quot;We're offline - we can't delete the file.&quot;);</span>
<a href="#l17.294"></a><span id="l17.294" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l17.295"></a><span id="l17.295" class="difflineplus">+      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l17.296"></a><span id="l17.296">     }</span>
<a href="#l17.297"></a><span id="l17.297"> </span>
<a href="#l17.298"></a><span id="l17.298">     let uploadInfo = this._uploadInfo[aFile.path];</span>
<a href="#l17.299"></a><span id="l17.299">     if (!uploadInfo) {</span>
<a href="#l17.300"></a><span id="l17.300">       this.log.error(&quot;Could not find a record for the file to be deleted.&quot;);</span>
<a href="#l17.301"></a><span id="l17.301">       throw Cr.NS_ERROR_FAILURE;</span>
<a href="#l17.302"></a><span id="l17.302">     }</span>
<a href="#l17.303"></a><span id="l17.303"> </span>
<a href="#l17.304"></a><span id="l17.304" class="difflineat">@@ -703,17 +699,17 @@ nsHightail.prototype = {</span>
<a href="#l17.305"></a><span id="l17.305">           this.log.warn(&quot;Token has gone stale! Will attempt to reauth.&quot;);</span>
<a href="#l17.306"></a><span id="l17.306">           // Our token has gone stale</span>
<a href="#l17.307"></a><span id="l17.307">           let onTokenRefresh = function() {</span>
<a href="#l17.308"></a><span id="l17.308">             this.deleteFile(aFile, aCallback);</span>
<a href="#l17.309"></a><span id="l17.309">           }.bind(this);</span>
<a href="#l17.310"></a><span id="l17.310"> </span>
<a href="#l17.311"></a><span id="l17.311">           let onTokenRefreshFailure = function() {</span>
<a href="#l17.312"></a><span id="l17.312">             aCallback.onStopRequest(null, null,</span>
<a href="#l17.313"></a><span id="l17.313" class="difflineminus">-                                    Ci.nsIMsgCloudFileProvider.authErr);</span>
<a href="#l17.314"></a><span id="l17.314" class="difflineplus">+                                    cloudFileAccounts.constants.authErr);</span>
<a href="#l17.315"></a><span id="l17.315">           };</span>
<a href="#l17.316"></a><span id="l17.316">           this._handleStaleToken(onTokenRefresh, onTokenRefreshFailure);</span>
<a href="#l17.317"></a><span id="l17.317">           return;</span>
<a href="#l17.318"></a><span id="l17.318">         }</span>
<a href="#l17.319"></a><span id="l17.319"> </span>
<a href="#l17.320"></a><span id="l17.320">         this.log.error(&quot;Server has returned a failure on our delete request.&quot;);</span>
<a href="#l17.321"></a><span id="l17.321">         this.log.error(&quot;Error code: &quot; + deleteInfo.errorStatus.code);</span>
<a href="#l17.322"></a><span id="l17.322">         this.log.error(&quot;Error message: &quot; + deleteInfo.errorStatus.message);</span>
<a href="#l17.323"></a><span id="l17.323" class="difflineat">@@ -886,17 +882,17 @@ nsHightailFileUploader.prototype = {</span>
<a href="#l17.324"></a><span id="l17.324">   startUpload() {</span>
<a href="#l17.325"></a><span id="l17.325">     this.requestObserver.onStartRequest(null, null);</span>
<a href="#l17.326"></a><span id="l17.326"> </span>
<a href="#l17.327"></a><span id="l17.327">     let onSuccess = function() {</span>
<a href="#l17.328"></a><span id="l17.328">       this._uploadFile();</span>
<a href="#l17.329"></a><span id="l17.329">     }.bind(this);</span>
<a href="#l17.330"></a><span id="l17.330"> </span>
<a href="#l17.331"></a><span id="l17.331">     let onFailure = function() {</span>
<a href="#l17.332"></a><span id="l17.332" class="difflineminus">-      this.callback(this.requestObserver, Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l17.333"></a><span id="l17.333" class="difflineplus">+      this.callback(this.requestObserver, cloudFileAccounts.constants.uploadErr);</span>
<a href="#l17.334"></a><span id="l17.334">     }.bind(this);</span>
<a href="#l17.335"></a><span id="l17.335"> </span>
<a href="#l17.336"></a><span id="l17.336">     return this._prepareToSend(onSuccess, onFailure);</span>
<a href="#l17.337"></a><span id="l17.337">   },</span>
<a href="#l17.338"></a><span id="l17.338"> </span>
<a href="#l17.339"></a><span id="l17.339">   /**</span>
<a href="#l17.340"></a><span id="l17.340">    * Communicates with Hightail to get the URL that we will send the upload</span>
<a href="#l17.341"></a><span id="l17.341">    * request to.</span>
<a href="#l17.342"></a><span id="l17.342" class="difflineat">@@ -956,25 +952,25 @@ nsHightailFileUploader.prototype = {</span>
<a href="#l17.343"></a><span id="l17.343">         try {</span>
<a href="#l17.344"></a><span id="l17.344">           this.log.info(&quot;upload response = &quot; + req.responseText);</span>
<a href="#l17.345"></a><span id="l17.345">           this._commitSend();</span>
<a href="#l17.346"></a><span id="l17.346">         } catch (ex) {</span>
<a href="#l17.347"></a><span id="l17.347">           this.log.error(ex);</span>
<a href="#l17.348"></a><span id="l17.348">         }</span>
<a href="#l17.349"></a><span id="l17.349">       } else {</span>
<a href="#l17.350"></a><span id="l17.350">         this.callback(this.requestObserver,</span>
<a href="#l17.351"></a><span id="l17.351" class="difflineminus">-                      Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l17.352"></a><span id="l17.352" class="difflineplus">+                      cloudFileAccounts.constants.uploadErr);</span>
<a href="#l17.353"></a><span id="l17.353">       }</span>
<a href="#l17.354"></a><span id="l17.354">     }.bind(this);</span>
<a href="#l17.355"></a><span id="l17.355"> </span>
<a href="#l17.356"></a><span id="l17.356">     req.onerror = function() {</span>
<a href="#l17.357"></a><span id="l17.357">       this.cleanupTempFile();</span>
<a href="#l17.358"></a><span id="l17.358">       if (this.callback)</span>
<a href="#l17.359"></a><span id="l17.359">         this.callback(this.requestObserver,</span>
<a href="#l17.360"></a><span id="l17.360" class="difflineminus">-                      Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l17.361"></a><span id="l17.361" class="difflineplus">+                      cloudFileAccounts.constants.uploadErr);</span>
<a href="#l17.362"></a><span id="l17.362">     }.bind(this);</span>
<a href="#l17.363"></a><span id="l17.363"> </span>
<a href="#l17.364"></a><span id="l17.364">     req.setRequestHeader(&quot;Date&quot;, curDate);</span>
<a href="#l17.365"></a><span id="l17.365">     let boundary = &quot;------&quot; + curDate;</span>
<a href="#l17.366"></a><span id="l17.366">     let contentType = &quot;multipart/form-data; boundary=&quot; + boundary;</span>
<a href="#l17.367"></a><span id="l17.367">     req.setRequestHeader(&quot;Content-Type&quot;, contentType);</span>
<a href="#l17.368"></a><span id="l17.368"> </span>
<a href="#l17.369"></a><span id="l17.369">     let fileContents = &quot;--&quot; + boundary +</span>
<a href="#l17.370"></a><span id="l17.370" class="difflineat">@@ -1044,17 +1040,17 @@ nsHightailFileUploader.prototype = {</span>
<a href="#l17.371"></a><span id="l17.371">     }</span>
<a href="#l17.372"></a><span id="l17.372">   },</span>
<a href="#l17.373"></a><span id="l17.373"> </span>
<a href="#l17.374"></a><span id="l17.374">   /**</span>
<a href="#l17.375"></a><span id="l17.375">    * Cancels the upload request for the file associated with this Uploader.</span>
<a href="#l17.376"></a><span id="l17.376">    */</span>
<a href="#l17.377"></a><span id="l17.377">   cancel() {</span>
<a href="#l17.378"></a><span id="l17.378">     this.log.info(&quot;in uploader cancel&quot;);</span>
<a href="#l17.379"></a><span id="l17.379" class="difflineminus">-    this.callback(this.requestObserver, Ci.nsIMsgCloudFileProvider.uploadCanceled);</span>
<a href="#l17.380"></a><span id="l17.380" class="difflineplus">+    this.callback(this.requestObserver, cloudFileAccounts.constants.uploadCancelled);</span>
<a href="#l17.381"></a><span id="l17.381">     delete this.callback;</span>
<a href="#l17.382"></a><span id="l17.382">     if (this.request) {</span>
<a href="#l17.383"></a><span id="l17.383">       this.log.info(&quot;cancelling upload request&quot;);</span>
<a href="#l17.384"></a><span id="l17.384">       let req = this.request;</span>
<a href="#l17.385"></a><span id="l17.385">       if (req.channel) {</span>
<a href="#l17.386"></a><span id="l17.386">         this.log.info(&quot;cancelling upload channel&quot;);</span>
<a href="#l17.387"></a><span id="l17.387">         req.channel.cancel(Cr.NS_BINDING_ABORTED);</span>
<a href="#l17.388"></a><span id="l17.388">       }</span>
<a href="#l17.389"></a><span id="l17.389" class="difflineat">@@ -1072,33 +1068,33 @@ nsHightailFileUploader.prototype = {</span>
<a href="#l17.390"></a><span id="l17.390">                &quot;&amp;fileId=&quot; + this._urlInfo.fileId +</span>
<a href="#l17.391"></a><span id="l17.391">                &quot;&amp;parentId=&quot; + this.hightail._folderId + &quot;&amp;&quot;;</span>
<a href="#l17.392"></a><span id="l17.392"> </span>
<a href="#l17.393"></a><span id="l17.393">     req.open(&quot;POST&quot;, gServerUrl + kFolderCommitUploadPath + args + kUrlTail, true);</span>
<a href="#l17.394"></a><span id="l17.394"> </span>
<a href="#l17.395"></a><span id="l17.395">     req.onerror = function() {</span>
<a href="#l17.396"></a><span id="l17.396">       this.log.info(&quot;error in commit send&quot;);</span>
<a href="#l17.397"></a><span id="l17.397">       this.callback(this.requestObserver,</span>
<a href="#l17.398"></a><span id="l17.398" class="difflineminus">-                    Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l17.399"></a><span id="l17.399" class="difflineplus">+                    cloudFileAccounts.constants.uploadErr);</span>
<a href="#l17.400"></a><span id="l17.400">     }.bind(this);</span>
<a href="#l17.401"></a><span id="l17.401"> </span>
<a href="#l17.402"></a><span id="l17.402">     req.onload = function() {</span>
<a href="#l17.403"></a><span id="l17.403">       // Response is the URL.</span>
<a href="#l17.404"></a><span id="l17.404">       let response = req.responseText;</span>
<a href="#l17.405"></a><span id="l17.405">       this.log.info(&quot;commit response = &quot; + response);</span>
<a href="#l17.406"></a><span id="l17.406">       let uploadInfo = JSON.parse(response);</span>
<a href="#l17.407"></a><span id="l17.407"> </span>
<a href="#l17.408"></a><span id="l17.408">       let succeed = function() {</span>
<a href="#l17.409"></a><span id="l17.409">         this.callback(this.requestObserver, Cr.NS_OK);</span>
<a href="#l17.410"></a><span id="l17.410">       }.bind(this);</span>
<a href="#l17.411"></a><span id="l17.411"> </span>
<a href="#l17.412"></a><span id="l17.412">       let failed = function() {</span>
<a href="#l17.413"></a><span id="l17.413">         this.callback(this.requestObserver, this.file.leafName.length &gt; 120</span>
<a href="#l17.414"></a><span id="l17.414" class="difflineminus">-                      ? Ci.nsIMsgCloudFileProvider.uploadExceedsFileNameLimit</span>
<a href="#l17.415"></a><span id="l17.415" class="difflineminus">-                      : Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l17.416"></a><span id="l17.416" class="difflineplus">+                      ? cloudFileAccounts.constants.uploadExceedsFileNameLimit</span>
<a href="#l17.417"></a><span id="l17.417" class="difflineplus">+                      : cloudFileAccounts.constants.uploadErr);</span>
<a href="#l17.418"></a><span id="l17.418">       }.bind(this);</span>
<a href="#l17.419"></a><span id="l17.419"> </span>
<a href="#l17.420"></a><span id="l17.420">       if (uploadInfo.errorStatus) {</span>
<a href="#l17.421"></a><span id="l17.421">         this.hightail._lastErrorText = uploadInfo.errorStatus.message;</span>
<a href="#l17.422"></a><span id="l17.422">         this.hightail._lastErrorStatus = uploadInfo.errorStatus.code;</span>
<a href="#l17.423"></a><span id="l17.423">         failed();</span>
<a href="#l17.424"></a><span id="l17.424">       } else if (uploadInfo.clickableDownloadUrl) {</span>
<a href="#l17.425"></a><span id="l17.425">         // We need a kludge here because Hightail is returning URLs without the scheme...</span>
<a href="#l17.426"></a><span id="l17.426" class="difflineat">@@ -1193,9 +1189,19 @@ nsHightailFileUploader.prototype = {</span>
<a href="#l17.427"></a><span id="l17.427">       this._bufStream.close();</span>
<a href="#l17.428"></a><span id="l17.428">     if (this._fstream)</span>
<a href="#l17.429"></a><span id="l17.429">       this._fstream.close();</span>
<a href="#l17.430"></a><span id="l17.430">     if (this._tempFile)</span>
<a href="#l17.431"></a><span id="l17.431">       this._tempFile.remove(false);</span>
<a href="#l17.432"></a><span id="l17.432">   },</span>
<a href="#l17.433"></a><span id="l17.433"> };</span>
<a href="#l17.434"></a><span id="l17.434"> </span>
<a href="#l17.435"></a><span id="l17.435" class="difflineminus">-var NSGetFactory = XPCOMUtils.generateNSGetFactory([nsHightail]);</span>
<a href="#l17.436"></a><span id="l17.436" class="difflineplus">+// Hightail used to be named YouSendIt, which is the constant used in the prefs.</span>
<a href="#l17.437"></a><span id="l17.437" class="difflineplus">+cloudFileAccounts.registerProvider(&quot;YouSendIt&quot;, {</span>
<a href="#l17.438"></a><span id="l17.438" class="difflineplus">+  type: &quot;YouSendIt&quot;,</span>
<a href="#l17.439"></a><span id="l17.439" class="difflineplus">+  displayName: &quot;Hightail&quot;,</span>
<a href="#l17.440"></a><span id="l17.440" class="difflineplus">+  iconURL: &quot;chrome://messenger/skin/icons/hightail.png&quot;,</span>
<a href="#l17.441"></a><span id="l17.441" class="difflineplus">+  initAccount(accountKey) {</span>
<a href="#l17.442"></a><span id="l17.442" class="difflineplus">+    let account = new nsHightail();</span>
<a href="#l17.443"></a><span id="l17.443" class="difflineplus">+    account.init(accountKey);</span>
<a href="#l17.444"></a><span id="l17.444" class="difflineplus">+    return account;</span>
<a href="#l17.445"></a><span id="l17.445" class="difflineplus">+  },</span>
<a href="#l17.446"></a><span id="l17.446" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1">rename from mail/components/cloudfile/content/Hightail/management.js</span>
<a href="#l18.2"></a><span id="l18.2">rename to mail/components/cloudfile/hightail/management.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineminus">--- a/mail/components/cloudfile/content/Hightail/management.js</span>
<a href="#l18.4"></a><span id="l18.4" class="difflineplus">+++ b/mail/components/cloudfile/hightail/management.js</span>
<a href="#l18.5"></a><span id="l18.5" class="difflineat">@@ -1,39 +1,92 @@</span>
<a href="#l18.6"></a><span id="l18.6"> /* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l18.7"></a><span id="l18.7">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l18.8"></a><span id="l18.8">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l18.9"></a><span id="l18.9"> </span>
<a href="#l18.10"></a><span id="l18.10"> // mail/base/content/protovis-r2.6-modded.js</span>
<a href="#l18.11"></a><span id="l18.11"> /* globals pv */</span>
<a href="#l18.12"></a><span id="l18.12"> </span>
<a href="#l18.13"></a><span id="l18.13" class="difflineminus">-function onLoadProvider(provider) {</span>
<a href="#l18.14"></a><span id="l18.14" class="difflineminus">-  let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l18.15"></a><span id="l18.15" class="difflineminus">-                    .createInstance(Ci.nsIMessenger);</span>
<a href="#l18.16"></a><span id="l18.16" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l18.17"></a><span id="l18.17" class="difflineplus">+</span>
<a href="#l18.18"></a><span id="l18.18" class="difflineplus">+var accountId = new URL(location.href).searchParams.get(&quot;accountId&quot;);</span>
<a href="#l18.19"></a><span id="l18.19" class="difflineplus">+var account = cloudFileAccounts.getAccount(accountId);</span>
<a href="#l18.20"></a><span id="l18.20" class="difflineplus">+</span>
<a href="#l18.21"></a><span id="l18.21" class="difflineplus">+var loading = document.getElementById(&quot;provider-loading&quot;);</span>
<a href="#l18.22"></a><span id="l18.22" class="difflineplus">+var auth = document.getElementById(&quot;provider-auth&quot;);</span>
<a href="#l18.23"></a><span id="l18.23" class="difflineplus">+var spacebox = document.getElementById(&quot;provider-spacebox&quot;);</span>
<a href="#l18.24"></a><span id="l18.24" class="difflineplus">+</span>
<a href="#l18.25"></a><span id="l18.25" class="difflineplus">+if (cloudFileAccounts.getSecretValue(accountId, cloudFileAccounts.kTokenRealm)) {</span>
<a href="#l18.26"></a><span id="l18.26" class="difflineplus">+  onDoLoad();</span>
<a href="#l18.27"></a><span id="l18.27" class="difflineplus">+} else {</span>
<a href="#l18.28"></a><span id="l18.28" class="difflineplus">+  loading.hidden = true;</span>
<a href="#l18.29"></a><span id="l18.29" class="difflineplus">+  auth.hidden = false;</span>
<a href="#l18.30"></a><span id="l18.30" class="difflineplus">+}</span>
<a href="#l18.31"></a><span id="l18.31" class="difflineplus">+</span>
<a href="#l18.32"></a><span id="l18.32" class="difflineplus">+function onDoAuth(button) {</span>
<a href="#l18.33"></a><span id="l18.33" class="difflineplus">+  button.disabled = true;</span>
<a href="#l18.34"></a><span id="l18.34" class="difflineplus">+  loading.hidden = false;</span>
<a href="#l18.35"></a><span id="l18.35" class="difflineplus">+  auth.hidden = true;</span>
<a href="#l18.36"></a><span id="l18.36" class="difflineplus">+</span>
<a href="#l18.37"></a><span id="l18.37" class="difflineplus">+  account.createExistingAccount({</span>
<a href="#l18.38"></a><span id="l18.38" class="difflineplus">+    onStartRequest() {</span>
<a href="#l18.39"></a><span id="l18.39" class="difflineplus">+    },</span>
<a href="#l18.40"></a><span id="l18.40" class="difflineplus">+    onStopRequest(unused1, unused2, error) {</span>
<a href="#l18.41"></a><span id="l18.41" class="difflineplus">+      button.disabled = false;</span>
<a href="#l18.42"></a><span id="l18.42" class="difflineplus">+      if (error) {</span>
<a href="#l18.43"></a><span id="l18.43" class="difflineplus">+        loading.hidden = true;</span>
<a href="#l18.44"></a><span id="l18.44" class="difflineplus">+        auth.hidden = false;</span>
<a href="#l18.45"></a><span id="l18.45" class="difflineplus">+        return;</span>
<a href="#l18.46"></a><span id="l18.46" class="difflineplus">+      }</span>
<a href="#l18.47"></a><span id="l18.47" class="difflineplus">+</span>
<a href="#l18.48"></a><span id="l18.48" class="difflineplus">+      cloudFileAccounts.emit(&quot;accountConfigured&quot;, account);</span>
<a href="#l18.49"></a><span id="l18.49" class="difflineplus">+      onDoLoad();</span>
<a href="#l18.50"></a><span id="l18.50" class="difflineplus">+    },</span>
<a href="#l18.51"></a><span id="l18.51" class="difflineplus">+  }, () =&gt; {</span>
<a href="#l18.52"></a><span id="l18.52" class="difflineplus">+    button.disabled = false;</span>
<a href="#l18.53"></a><span id="l18.53" class="difflineplus">+    loading.hidden = true;</span>
<a href="#l18.54"></a><span id="l18.54" class="difflineplus">+    auth.hidden = false;</span>
<a href="#l18.55"></a><span id="l18.55" class="difflineplus">+  });</span>
<a href="#l18.56"></a><span id="l18.56" class="difflineplus">+}</span>
<a href="#l18.57"></a><span id="l18.57" class="difflineplus">+</span>
<a href="#l18.58"></a><span id="l18.58" class="difflineplus">+function onDoLoad() {</span>
<a href="#l18.59"></a><span id="l18.59" class="difflineplus">+  account.refreshUserInfo(false, {</span>
<a href="#l18.60"></a><span id="l18.60" class="difflineplus">+    onStartRequest() {</span>
<a href="#l18.61"></a><span id="l18.61" class="difflineplus">+    },</span>
<a href="#l18.62"></a><span id="l18.62" class="difflineplus">+    onStopRequest() {</span>
<a href="#l18.63"></a><span id="l18.63" class="difflineplus">+      loading.hidden = true;</span>
<a href="#l18.64"></a><span id="l18.64" class="difflineplus">+      spacebox.hidden = false;</span>
<a href="#l18.65"></a><span id="l18.65" class="difflineplus">+      onLoadProvider(account);</span>
<a href="#l18.66"></a><span id="l18.66" class="difflineplus">+    },</span>
<a href="#l18.67"></a><span id="l18.67" class="difflineplus">+  });</span>
<a href="#l18.68"></a><span id="l18.68" class="difflineplus">+}</span>
<a href="#l18.69"></a><span id="l18.69" class="difflineplus">+</span>
<a href="#l18.70"></a><span id="l18.70" class="difflineplus">+function onLoadProvider(account) {</span>
<a href="#l18.71"></a><span id="l18.71" class="difflineplus">+  let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;].createInstance(Ci.nsIMessenger);</span>
<a href="#l18.72"></a><span id="l18.72"> </span>
<a href="#l18.73"></a><span id="l18.73">   let fileSpaceUsed = document.getElementById(&quot;file-space-used&quot;);</span>
<a href="#l18.74"></a><span id="l18.74" class="difflineminus">-  fileSpaceUsed.textContent = messenger.formatFileSize(provider.fileSpaceUsed);</span>
<a href="#l18.75"></a><span id="l18.75" class="difflineplus">+  fileSpaceUsed.textContent = messenger.formatFileSize(account.fileSpaceUsed);</span>
<a href="#l18.76"></a><span id="l18.76">   let fileSpaceUsedSwatch = document.getElementById(&quot;file-space-used-swatch&quot;);</span>
<a href="#l18.77"></a><span id="l18.77">   fileSpaceUsedSwatch.style.backgroundColor = pv.Colors.category20.values[0];</span>
<a href="#l18.78"></a><span id="l18.78"> </span>
<a href="#l18.79"></a><span id="l18.79">   let remainingFileSpace = document.getElementById(&quot;remaining-file-space&quot;);</span>
<a href="#l18.80"></a><span id="l18.80">   remainingFileSpace.textContent = messenger.formatFileSize(</span>
<a href="#l18.81"></a><span id="l18.81" class="difflineminus">-    provider.remainingFileSpace);</span>
<a href="#l18.82"></a><span id="l18.82" class="difflineplus">+    account.remainingFileSpace);</span>
<a href="#l18.83"></a><span id="l18.83">   let remainingFileSpaceSwatch = document.getElementById(&quot;remaining-file-space-swatch&quot;);</span>
<a href="#l18.84"></a><span id="l18.84">   remainingFileSpaceSwatch.style.backgroundColor = pv.Colors.category20.values[1];</span>
<a href="#l18.85"></a><span id="l18.85"> </span>
<a href="#l18.86"></a><span id="l18.86" class="difflineminus">-  let totalSpace = provider.fileSpaceUsed + provider.remainingFileSpace;</span>
<a href="#l18.87"></a><span id="l18.87" class="difflineplus">+  let totalSpace = account.fileSpaceUsed + account.remainingFileSpace;</span>
<a href="#l18.88"></a><span id="l18.88">   let pieScale = 2 * Math.PI / totalSpace;</span>
<a href="#l18.89"></a><span id="l18.89"> </span>
<a href="#l18.90"></a><span id="l18.90">   let spaceDiv = document.getElementById(&quot;provider-space-visuals&quot;);</span>
<a href="#l18.91"></a><span id="l18.91">   let vis = new pv.Panel().canvas(spaceDiv)</span>
<a href="#l18.92"></a><span id="l18.92">     .width(150)</span>
<a href="#l18.93"></a><span id="l18.93">     .height(150);</span>
<a href="#l18.94"></a><span id="l18.94">   vis.add(pv.Wedge)</span>
<a href="#l18.95"></a><span id="l18.95" class="difflineminus">-    .data([provider.fileSpaceUsed, provider.remainingFileSpace])</span>
<a href="#l18.96"></a><span id="l18.96" class="difflineplus">+    .data([account.fileSpaceUsed, account.remainingFileSpace])</span>
<a href="#l18.97"></a><span id="l18.97">     .left(75)</span>
<a href="#l18.98"></a><span id="l18.98">     .top(75)</span>
<a href="#l18.99"></a><span id="l18.99">     .innerRadius(30)</span>
<a href="#l18.100"></a><span id="l18.100">     .outerRadius(65)</span>
<a href="#l18.101"></a><span id="l18.101">     .angle(d =&gt; d * pieScale);</span>
<a href="#l18.102"></a><span id="l18.102"> </span>
<a href="#l18.103"></a><span id="l18.103">   vis.add(pv.Label)</span>
<a href="#l18.104"></a><span id="l18.104">     .left(75)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1">rename from mail/components/cloudfile/content/Hightail/management.xhtml</span>
<a href="#l19.2"></a><span id="l19.2">rename to mail/components/cloudfile/hightail/management.xhtml</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineminus">--- a/mail/components/cloudfile/content/Hightail/management.xhtml</span>
<a href="#l19.4"></a><span id="l19.4" class="difflineplus">+++ b/mail/components/cloudfile/hightail/management.xhtml</span>
<a href="#l19.5"></a><span id="l19.5" class="difflineat">@@ -8,33 +8,40 @@</span>
<a href="#l19.6"></a><span id="l19.6">   &lt;!ENTITY % managementDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/management.dtd&quot;&gt; %managementDTD;</span>
<a href="#l19.7"></a><span id="l19.7">   &lt;!ENTITY % hightailDTD SYSTEM &quot;chrome://messenger/locale/cloudfile/Hightail/management.dtd&quot;&gt; %hightailDTD;</span>
<a href="#l19.8"></a><span id="l19.8"> ]&gt;</span>
<a href="#l19.9"></a><span id="l19.9"> &lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l19.10"></a><span id="l19.10">   &lt;head&gt;</span>
<a href="#l19.11"></a><span id="l19.11">     &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l19.12"></a><span id="l19.12">             src=&quot;chrome://messenger/content/protovis-r2.6-modded.js&quot;/&gt;</span>
<a href="#l19.13"></a><span id="l19.13">     &lt;script type=&quot;application/javascript&quot;</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-            src=&quot;chrome://messenger/content/cloudfile/Hightail/management.js&quot;/&gt;</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineplus">+            src=&quot;chrome://messenger/content/cloudfile/Hightail/management.js&quot;</span>
<a href="#l19.16"></a><span id="l19.16" class="difflineplus">+            defer=&quot;true&quot;/&gt;</span>
<a href="#l19.17"></a><span id="l19.17">     &lt;link rel=&quot;stylesheet&quot;</span>
<a href="#l19.18"></a><span id="l19.18">         type=&quot;text/css&quot;</span>
<a href="#l19.19"></a><span id="l19.19">         href=&quot;chrome://messenger/skin/preferences/preferences.css&quot; /&gt;</span>
<a href="#l19.20"></a><span id="l19.20">   &lt;/head&gt;</span>
<a href="#l19.21"></a><span id="l19.21">   &lt;body id=&quot;provider-management&quot;&gt;</span>
<a href="#l19.22"></a><span id="l19.22">     &lt;div id=&quot;provider-header&quot;&gt;</span>
<a href="#l19.23"></a><span id="l19.23">       &lt;div id=&quot;provider-terms&quot;&gt;</span>
<a href="#l19.24"></a><span id="l19.24">       &lt;a href=&quot;http://www.hightail.com/aboutus/legal/privacy&quot;&gt;&amp;cloudfileMgmt.privacyPolicy;&lt;/a&gt;</span>
<a href="#l19.25"></a><span id="l19.25">       &lt;a href=&quot;http://www.hightail.com/aboutus/legal/terms-of-service&quot;&gt;&amp;cloudfileMgmt.termsOfService;&lt;/a&gt;</span>
<a href="#l19.26"></a><span id="l19.26">       &lt;/div&gt;</span>
<a href="#l19.27"></a><span id="l19.27">       &lt;div id=&quot;provider-name&quot;&gt;</span>
<a href="#l19.28"></a><span id="l19.28">       &lt;h1&gt;Hightail&lt;/h1&gt;</span>
<a href="#l19.29"></a><span id="l19.29">       &lt;/div&gt;</span>
<a href="#l19.30"></a><span id="l19.30">     &lt;/div&gt;</span>
<a href="#l19.31"></a><span id="l19.31"> </span>
<a href="#l19.32"></a><span id="l19.32" class="difflineminus">-    &lt;div id=&quot;provider-spacebox&quot;&gt;</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineplus">+    &lt;div id=&quot;provider-loading&quot; align=&quot;center&quot;&gt;</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+      &lt;img src=&quot;chrome://global/skin/icons/loading.png&quot; /&gt;</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+    &lt;/div&gt;</span>
<a href="#l19.36"></a><span id="l19.36" class="difflineplus">+    &lt;div id=&quot;provider-auth&quot; align=&quot;center&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+      &lt;button onclick=&quot;onDoAuth(this)&quot;&gt;&amp;hightailMgmt.doAuth;&lt;/button&gt;</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+    &lt;/div&gt;</span>
<a href="#l19.39"></a><span id="l19.39" class="difflineplus">+    &lt;div id=&quot;provider-spacebox&quot; hidden=&quot;true&quot;&gt;</span>
<a href="#l19.40"></a><span id="l19.40">       &lt;div id=&quot;provider-space-visuals&quot;&gt;&lt;/div&gt;</span>
<a href="#l19.41"></a><span id="l19.41">       &lt;div id=&quot;provider-space&quot;&gt;</span>
<a href="#l19.42"></a><span id="l19.42">         &lt;div&gt;</span>
<a href="#l19.43"></a><span id="l19.43">           &lt;label&gt;&amp;cloudfileMgmt.usedSpace;&lt;/label&gt;</span>
<a href="#l19.44"></a><span id="l19.44">           &lt;span id=&quot;file-space-used&quot;/&gt;</span>
<a href="#l19.45"></a><span id="l19.45">           &lt;span id=&quot;file-space-used-swatch&quot; class=&quot;space-swatch&quot;/&gt;</span>
<a href="#l19.46"></a><span id="l19.46">         &lt;/div&gt;</span>
<a href="#l19.47"></a><span id="l19.47">         &lt;div&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mail/components/cloudfile/jar.mn</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mail/components/cloudfile/jar.mn</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -1,19 +1,15 @@</span>
<a href="#l20.4"></a><span id="l20.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l20.5"></a><span id="l20.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l20.6"></a><span id="l20.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l20.7"></a><span id="l20.7"> </span>
<a href="#l20.8"></a><span id="l20.8"> messenger.jar:</span>
<a href="#l20.9"></a><span id="l20.9" class="difflineminus">-*   content/messenger/cloudfile/addAccountDialog.xul (content/addAccountDialog.xul)</span>
<a href="#l20.10"></a><span id="l20.10" class="difflineminus">-    content/messenger/cloudfile/addAccountDialog.js  (content/addAccountDialog.js)</span>
<a href="#l20.11"></a><span id="l20.11" class="difflineminus">-    content/messenger/cloudfile/emptySettings.xhtml (content/emptySettings.xhtml)</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineminus">-    content/messenger/cloudfile/Box/settings.xhtml (content/Box/settings.xhtml)</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineminus">-    content/messenger/cloudfile/Box/management.xhtml (content/Box/management.xhtml)</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineminus">-    content/messenger/cloudfile/Box/management.js (content/Box/management.js)</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineminus">-    content/messenger/cloudfile/Hightail/management.xhtml (content/Hightail/management.xhtml)</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineminus">-    content/messenger/cloudfile/Hightail/management.js (content/Hightail/management.js)</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineminus">-    content/messenger/cloudfile/Hightail/settings.js (content/Hightail/settings.js)</span>
<a href="#l20.18"></a><span id="l20.18" class="difflineminus">-    content/messenger/cloudfile/Hightail/settings.xhtml (content/Hightail/settings.xhtml)</span>
<a href="#l20.19"></a><span id="l20.19" class="difflineminus">-    content/messenger/cloudfile/Hightail/fileExceedsLimit.xul (content/Hightail/fileExceedsLimit.xul)</span>
<a href="#l20.20"></a><span id="l20.20" class="difflineminus">-    content/messenger/cloudfile/Hightail/fileExceedsQuota.xul (content/Hightail/fileExceedsQuota.xul)</span>
<a href="#l20.21"></a><span id="l20.21" class="difflineminus">-    content/messenger/cloudfile/Hightail/fileExceedsQuota.js (content/Hightail/fileExceedsQuota.js)</span>
<a href="#l20.22"></a><span id="l20.22" class="difflineminus">-    content/messenger/cloudfile/Hightail/fileExceeds2GB.xul (content/Hightail/fileExceeds2GB.xul)</span>
<a href="#l20.23"></a><span id="l20.23" class="difflineplus">+    content/messenger/cloudfile/Box/box.jsm                   (box/box.jsm)</span>
<a href="#l20.24"></a><span id="l20.24" class="difflineplus">+    content/messenger/cloudfile/Box/management.xhtml          (box/management.xhtml)</span>
<a href="#l20.25"></a><span id="l20.25" class="difflineplus">+    content/messenger/cloudfile/Box/management.js             (box/management.js)</span>
<a href="#l20.26"></a><span id="l20.26" class="difflineplus">+    content/messenger/cloudfile/Hightail/hightail.jsm         (hightail/hightail.jsm)</span>
<a href="#l20.27"></a><span id="l20.27" class="difflineplus">+    content/messenger/cloudfile/Hightail/management.xhtml     (hightail/management.xhtml)</span>
<a href="#l20.28"></a><span id="l20.28" class="difflineplus">+    content/messenger/cloudfile/Hightail/management.js        (hightail/management.js)</span>
<a href="#l20.29"></a><span id="l20.29" class="difflineplus">+    content/messenger/cloudfile/Hightail/fileExceedsLimit.xul (hightail/fileExceedsLimit.xul)</span>
<a href="#l20.30"></a><span id="l20.30" class="difflineplus">+    content/messenger/cloudfile/Hightail/fileExceedsQuota.xul (hightail/fileExceedsQuota.xul)</span>
<a href="#l20.31"></a><span id="l20.31" class="difflineplus">+    content/messenger/cloudfile/Hightail/fileExceedsQuota.js  (hightail/fileExceedsQuota.js)</span>
<a href="#l20.32"></a><span id="l20.32" class="difflineplus">+    content/messenger/cloudfile/Hightail/fileExceeds2GB.xul   (hightail/fileExceeds2GB.xul)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mail/components/cloudfile/moz.build</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mail/components/cloudfile/moz.build</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -1,26 +1,17 @@</span>
<a href="#l21.4"></a><span id="l21.4"> # vim: set filetype=python:</span>
<a href="#l21.5"></a><span id="l21.5"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l21.6"></a><span id="l21.6"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l21.7"></a><span id="l21.7"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l21.8"></a><span id="l21.8"> </span>
<a href="#l21.9"></a><span id="l21.9" class="difflineminus">-XPIDL_SOURCES += [</span>
<a href="#l21.10"></a><span id="l21.10" class="difflineminus">-    'nsIMsgCloudFileProvider.idl',</span>
<a href="#l21.11"></a><span id="l21.11" class="difflineminus">-]</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-XPIDL_MODULE = 'cloudfile'</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-EXTRA_COMPONENTS += [</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-    'cloudFileComponents.manifest',</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-    'nsBox.js',</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-    'nsHightail.js',</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-]</span>
<a href="#l21.20"></a><span id="l21.20" class="difflineminus">-</span>
<a href="#l21.21"></a><span id="l21.21"> EXTRA_JS_MODULES += [</span>
<a href="#l21.22"></a><span id="l21.22">     'cloudFileAccounts.js',</span>
<a href="#l21.23"></a><span id="l21.23"> ]</span>
<a href="#l21.24"></a><span id="l21.24"> </span>
<a href="#l21.25"></a><span id="l21.25"> JAR_MANIFESTS += ['jar.mn']</span>
<a href="#l21.26"></a><span id="l21.26"> </span>
<a href="#l21.27"></a><span id="l21.27"> DIRS += [</span>
<a href="#l21.28"></a><span id="l21.28">     'wetransfer',</span>
<a href="#l21.29"></a><span id="l21.29"> ]</span>
<a href="#l21.30"></a><span id="l21.30" class="difflineplus">+BROWSER_CHROME_MANIFESTS += [</span>
<a href="#l21.31"></a><span id="l21.31" class="difflineplus">+    'test/browser/browser.ini'</span>
<a href="#l21.32"></a><span id="l21.32" class="difflineplus">+]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1">deleted file mode 100644</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineminus">--- a/mail/components/cloudfile/nsIMsgCloudFileProvider.idl</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineplus">+++ /dev/null</span>
<a href="#l22.4"></a><span id="l22.4" class="difflineat">@@ -1,139 +0,0 @@</span>
<a href="#l22.5"></a><span id="l22.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l22.6"></a><span id="l22.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l22.7"></a><span id="l22.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l22.8"></a><span id="l22.8" class="difflineminus">-</span>
<a href="#l22.9"></a><span id="l22.9" class="difflineminus">-#include &quot;nsISupports.idl&quot;</span>
<a href="#l22.10"></a><span id="l22.10" class="difflineminus">-</span>
<a href="#l22.11"></a><span id="l22.11" class="difflineminus">-interface nsIFile;</span>
<a href="#l22.12"></a><span id="l22.12" class="difflineminus">-interface nsIRequestObserver;</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineminus">-interface nsIPrefBranch;</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineminus">-[scriptable, uuid(c961919b-980b-4adc-bcfe-dabe916d1acc)]</span>
<a href="#l22.15"></a><span id="l22.15" class="difflineminus">-interface nsIMsgCloudFileProvider : nsISupports {</span>
<a href="#l22.16"></a><span id="l22.16" class="difflineminus">-  // The type is a unique string identifier used by various interface elements</span>
<a href="#l22.17"></a><span id="l22.17" class="difflineminus">-  // for styling. As such, the type should be an alphanumpheric string with</span>
<a href="#l22.18"></a><span id="l22.18" class="difflineminus">-  // no spaces.</span>
<a href="#l22.19"></a><span id="l22.19" class="difflineminus">-  readonly attribute ACString type;</span>
<a href="#l22.20"></a><span id="l22.20" class="difflineminus">-  // Unlike the type, the displayName is purely for rendering the name of</span>
<a href="#l22.21"></a><span id="l22.21" class="difflineminus">-  // a storage service provider.</span>
<a href="#l22.22"></a><span id="l22.22" class="difflineminus">-  readonly attribute ACString displayName;</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineminus">-  // A link to the homepage of the service, if applicable.</span>
<a href="#l22.24"></a><span id="l22.24" class="difflineminus">-  readonly attribute ACString serviceURL;</span>
<a href="#l22.25"></a><span id="l22.25" class="difflineminus">-  /// Some providers might want to provide an icon for the menu</span>
<a href="#l22.26"></a><span id="l22.26" class="difflineminus">-  readonly attribute ACString iconClass;</span>
<a href="#l22.27"></a><span id="l22.27" class="difflineminus">-</span>
<a href="#l22.28"></a><span id="l22.28" class="difflineminus">-  readonly attribute ACString accountKey;</span>
<a href="#l22.29"></a><span id="l22.29" class="difflineminus">-</span>
<a href="#l22.30"></a><span id="l22.30" class="difflineminus">-  readonly attribute ACString settingsURL;</span>
<a href="#l22.31"></a><span id="l22.31" class="difflineminus">-</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-  readonly attribute ACString managementURL;</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-  void init(in ACString aAccountKey);</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineminus">-</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineminus">-  /**</span>
<a href="#l22.37"></a><span id="l22.37" class="difflineminus">-   * upload the file to the cloud provider. The callback's OnStopRequest</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-   * method will be called when finished, with success or an error code.</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineminus">-   *</span>
<a href="#l22.40"></a><span id="l22.40" class="difflineminus">-   * @param aFile file to upload</span>
<a href="#l22.41"></a><span id="l22.41" class="difflineminus">-   * @param aCallback callback when finished.</span>
<a href="#l22.42"></a><span id="l22.42" class="difflineminus">-   *</span>
<a href="#l22.43"></a><span id="l22.43" class="difflineminus">-   * @throws nsIMsgCloudFileProvider.offlineErr if we are offline.</span>
<a href="#l22.44"></a><span id="l22.44" class="difflineminus">-   */</span>
<a href="#l22.45"></a><span id="l22.45" class="difflineminus">-  void uploadFile(in nsIFile aFile, in nsIRequestObserver aCallback);</span>
<a href="#l22.46"></a><span id="l22.46" class="difflineminus">-  ACString urlForFile(in nsIFile aFile);</span>
<a href="#l22.47"></a><span id="l22.47" class="difflineminus">-</span>
<a href="#l22.48"></a><span id="l22.48" class="difflineminus">-  /**</span>
<a href="#l22.49"></a><span id="l22.49" class="difflineminus">-   * Cancels the upload of the passed in file, if it hasn't finished yet.</span>
<a href="#l22.50"></a><span id="l22.50" class="difflineminus">-   * If it hasn't started yet, it will be removed from the upload queue.</span>
<a href="#l22.51"></a><span id="l22.51" class="difflineminus">-   *</span>
<a href="#l22.52"></a><span id="l22.52" class="difflineminus">-   * @param aFile file whose upload we should cancel.</span>
<a href="#l22.53"></a><span id="l22.53" class="difflineminus">-   */</span>
<a href="#l22.54"></a><span id="l22.54" class="difflineminus">-  void cancelFileUpload(in nsIFile aFile);</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-</span>
<a href="#l22.56"></a><span id="l22.56" class="difflineminus">-  /**</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-   * Refresh the user info for this account. This will fill in the quota info,</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-   * if supported by the provider.</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-   *</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-   * @param aWithUI if true, we may prompt for a password, or bring up an auth</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-   *                page. If false, we won't, and will fail if auth is required.</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-   * @param aCallback callback when finished.</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-   * @throws nsIMsgCloudFileProvider.offlineErr if we are offline.</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineminus">-   */</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineminus">-  void refreshUserInfo(in boolean aWithUI, in nsIRequestObserver aCallback);</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineminus">-</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineminus">-  /**</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineminus">-   * Delete a file that we've uploaded in this session and discarded. This</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineminus">-   * operation is asynchronous.</span>
<a href="#l22.70"></a><span id="l22.70" class="difflineminus">-   *</span>
<a href="#l22.71"></a><span id="l22.71" class="difflineminus">-   * @param aFile File we previously uploaded in this session.</span>
<a href="#l22.72"></a><span id="l22.72" class="difflineminus">-   * @param aCallback callback when finished</span>
<a href="#l22.73"></a><span id="l22.73" class="difflineminus">-   *</span>
<a href="#l22.74"></a><span id="l22.74" class="difflineminus">-   * @throws NS_ERROR_FAILURE if we don't know about the file.</span>
<a href="#l22.75"></a><span id="l22.75" class="difflineminus">-   * @throws nsIMsgCloudFileProvider.offlineErr if we are offline.</span>
<a href="#l22.76"></a><span id="l22.76" class="difflineminus">-   */</span>
<a href="#l22.77"></a><span id="l22.77" class="difflineminus">-  void deleteFile(in nsIFile aFile, in nsIRequestObserver aCallback);</span>
<a href="#l22.78"></a><span id="l22.78" class="difflineminus">-</span>
<a href="#l22.79"></a><span id="l22.79" class="difflineminus">-  /**</span>
<a href="#l22.80"></a><span id="l22.80" class="difflineminus">-   * If the provider has an API for creating an account, this will start the</span>
<a href="#l22.81"></a><span id="l22.81" class="difflineminus">-   * process of creating one. There will probably have to be some sort of</span>
<a href="#l22.82"></a><span id="l22.82" class="difflineminus">-   * validation on the part of the user before the account is created.</span>
<a href="#l22.83"></a><span id="l22.83" class="difflineminus">-   * If not, this will throw NS_ERROR_NOT_IMPLEMENTED.</span>
<a href="#l22.84"></a><span id="l22.84" class="difflineminus">-   *</span>
<a href="#l22.85"></a><span id="l22.85" class="difflineminus">-   * If the REST call succeeds, aCallback.onStopRequest will get called back</span>
<a href="#l22.86"></a><span id="l22.86" class="difflineminus">-   * with an http status. Generally, status between 200 and 300 is OK,</span>
<a href="#l22.87"></a><span id="l22.87" class="difflineminus">-   * otherwise, an error occurred which is * probably specific to the provider.</span>
<a href="#l22.88"></a><span id="l22.88" class="difflineminus">-   * If the request fails completely, onStopRequest will get called with</span>
<a href="#l22.89"></a><span id="l22.89" class="difflineminus">-   * Cr.NS_ERROR_FAILURE</span>
<a href="#l22.90"></a><span id="l22.90" class="difflineminus">-   * @throws nsIMsgCloudFileProvider.offlineErr if we are offline.</span>
<a href="#l22.91"></a><span id="l22.91" class="difflineminus">-   */</span>
<a href="#l22.92"></a><span id="l22.92" class="difflineminus">-  void createNewAccount(in ACString aEmailAddress, in ACString aPassword,</span>
<a href="#l22.93"></a><span id="l22.93" class="difflineminus">-                        in ACString aFirstName, in ACString aLastName,</span>
<a href="#l22.94"></a><span id="l22.94" class="difflineminus">-                        in nsIRequestObserver aCallback);</span>
<a href="#l22.95"></a><span id="l22.95" class="difflineminus">-</span>
<a href="#l22.96"></a><span id="l22.96" class="difflineminus">-  void createExistingAccount(in nsIRequestObserver aCallback);</span>
<a href="#l22.97"></a><span id="l22.97" class="difflineminus">-</span>
<a href="#l22.98"></a><span id="l22.98" class="difflineminus">-  /**</span>
<a href="#l22.99"></a><span id="l22.99" class="difflineminus">-   * If the provider doesn't have an API for creating an account, perhaps</span>
<a href="#l22.100"></a><span id="l22.100" class="difflineminus">-   * there's a url we can load in a content tab that will allow the user</span>
<a href="#l22.101"></a><span id="l22.101" class="difflineminus">-   * to create an account.</span>
<a href="#l22.102"></a><span id="l22.102" class="difflineminus">-   */</span>
<a href="#l22.103"></a><span id="l22.103" class="difflineminus">-  readonly attribute ACString createNewAccountUrl;</span>
<a href="#l22.104"></a><span id="l22.104" class="difflineminus">-</span>
<a href="#l22.105"></a><span id="l22.105" class="difflineminus">-  /**</span>
<a href="#l22.106"></a><span id="l22.106" class="difflineminus">-   * For some errors, the provider may have an explanatory page, or have an</span>
<a href="#l22.107"></a><span id="l22.107" class="difflineminus">-   * option to upgrade an account to handle the error. This method returns a url</span>
<a href="#l22.108"></a><span id="l22.108" class="difflineminus">-   * to a page hosted by the provider which can help with the error.</span>
<a href="#l22.109"></a><span id="l22.109" class="difflineminus">-   *</span>
<a href="#l22.110"></a><span id="l22.110" class="difflineminus">-   * @param aError e.g. uploadWouldExceedQuota or uploadExceedsFileLimit</span>
<a href="#l22.111"></a><span id="l22.111" class="difflineminus">-   * @returns provider url, if any, for the error, empty string otherwise.</span>
<a href="#l22.112"></a><span id="l22.112" class="difflineminus">-   */</span>
<a href="#l22.113"></a><span id="l22.113" class="difflineminus">-  ACString providerUrlForError(in unsigned long aError);</span>
<a href="#l22.114"></a><span id="l22.114" class="difflineminus">-</span>
<a href="#l22.115"></a><span id="l22.115" class="difflineminus">-  /**</span>
<a href="#l22.116"></a><span id="l22.116" class="difflineminus">-   * If we don't know the limit, this will return -1.</span>
<a href="#l22.117"></a><span id="l22.117" class="difflineminus">-   */</span>
<a href="#l22.118"></a><span id="l22.118" class="difflineminus">-  readonly attribute long fileUploadSizeLimit;</span>
<a href="#l22.119"></a><span id="l22.119" class="difflineminus">-</span>
<a href="#l22.120"></a><span id="l22.120" class="difflineminus">-  /// -1 if we don't have this info</span>
<a href="#l22.121"></a><span id="l22.121" class="difflineminus">-  readonly attribute long long remainingFileSpace;</span>
<a href="#l22.122"></a><span id="l22.122" class="difflineminus">-</span>
<a href="#l22.123"></a><span id="l22.123" class="difflineminus">-  /// -1 if we don't have this info</span>
<a href="#l22.124"></a><span id="l22.124" class="difflineminus">-  readonly attribute long long fileSpaceUsed;</span>
<a href="#l22.125"></a><span id="l22.125" class="difflineminus">-</span>
<a href="#l22.126"></a><span id="l22.126" class="difflineminus">-  /// This is used by our test harness to override the urls the provider uses.</span>
<a href="#l22.127"></a><span id="l22.127" class="difflineminus">-  void overrideUrls(in uint32_t aNumUrls, [array, size_is(aNumUrls)] in string aUrls);</span>
<a href="#l22.128"></a><span id="l22.128" class="difflineminus">-</span>
<a href="#l22.129"></a><span id="l22.129" class="difflineminus">-  // Error handling</span>
<a href="#l22.130"></a><span id="l22.130" class="difflineminus">-  // If the cloud provider gets textual errors back from the server,</span>
<a href="#l22.131"></a><span id="l22.131" class="difflineminus">-  // they can be retrieved here.</span>
<a href="#l22.132"></a><span id="l22.132" class="difflineminus">-  readonly attribute ACString lastError;</span>
<a href="#l22.133"></a><span id="l22.133" class="difflineminus">-  // I'm mapping these to real NS_MSG error codes where possible,</span>
<a href="#l22.134"></a><span id="l22.134" class="difflineminus">-  // but it really doesn't matter as long as we only return these</span>
<a href="#l22.135"></a><span id="l22.135" class="difflineminus">-  // errors.</span>
<a href="#l22.136"></a><span id="l22.136" class="difflineminus">-  const unsigned long offlineErr = 0x80550014; // NS_MSG_ERROR_OFFLINE</span>
<a href="#l22.137"></a><span id="l22.137" class="difflineminus">-  const unsigned long authErr = 0x8055001e; // NS_MSG_USER_NOT_AUTHENTICATED</span>
<a href="#l22.138"></a><span id="l22.138" class="difflineminus">-  const unsigned long uploadErr = 0x8055311a; // NS_MSG_ERROR_ATTACHING_FILE</span>
<a href="#l22.139"></a><span id="l22.139" class="difflineminus">-  const unsigned long uploadWouldExceedQuota = 0x8055311b;</span>
<a href="#l22.140"></a><span id="l22.140" class="difflineminus">-  const unsigned long uploadExceedsFileLimit = 0x8055311c;</span>
<a href="#l22.141"></a><span id="l22.141" class="difflineminus">-  const unsigned long uploadCanceled = 0x8055311d;</span>
<a href="#l22.142"></a><span id="l22.142" class="difflineminus">-  const unsigned long uploadExceedsFileNameLimit = 0x8055311e;</span>
<a href="#l22.143"></a><span id="l22.143" class="difflineminus">-};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1">new file mode 100644</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineminus">--- /dev/null</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineplus">+++ b/mail/components/cloudfile/test/browser/.eslintrc.js</span>
<a href="#l23.4"></a><span id="l23.4" class="difflineat">@@ -0,0 +1,10 @@</span>
<a href="#l23.5"></a><span id="l23.5" class="difflineplus">+&quot;use strict&quot;;</span>
<a href="#l23.6"></a><span id="l23.6" class="difflineplus">+</span>
<a href="#l23.7"></a><span id="l23.7" class="difflineplus">+module.exports = {</span>
<a href="#l23.8"></a><span id="l23.8" class="difflineplus">+  &quot;extends&quot;: &quot;plugin:mozilla/browser-test&quot;,</span>
<a href="#l23.9"></a><span id="l23.9" class="difflineplus">+</span>
<a href="#l23.10"></a><span id="l23.10" class="difflineplus">+  &quot;rules&quot;: {</span>
<a href="#l23.11"></a><span id="l23.11" class="difflineplus">+    &quot;func-names&quot;: &quot;off&quot;,</span>
<a href="#l23.12"></a><span id="l23.12" class="difflineplus">+    &quot;mozilla/import-headjs-globals&quot;: &quot;error&quot;,</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineplus">+  },</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1">new file mode 100644</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineminus">--- /dev/null</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineplus">+++ b/mail/components/cloudfile/test/browser/browser.ini</span>
<a href="#l24.4"></a><span id="l24.4" class="difflineat">@@ -0,0 +1,14 @@</span>
<a href="#l24.5"></a><span id="l24.5" class="difflineplus">+[DEFAULT]</span>
<a href="#l24.6"></a><span id="l24.6" class="difflineplus">+prefs =</span>
<a href="#l24.7"></a><span id="l24.7" class="difflineplus">+  ldap_2.servers.osx.description=</span>
<a href="#l24.8"></a><span id="l24.8" class="difflineplus">+  ldap_2.servers.osx.dirType=-1</span>
<a href="#l24.9"></a><span id="l24.9" class="difflineplus">+  ldap_2.servers.osx.uri=</span>
<a href="#l24.10"></a><span id="l24.10" class="difflineplus">+  mail.provider.suppress_dialog_on_startup=true</span>
<a href="#l24.11"></a><span id="l24.11" class="difflineplus">+  mail.spotlight.firstRunDone=true</span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+  mail.winsearch.firstRunDone=true</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+  mailnews.start_page.override_url=about:blank</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+  mailnews.start_page.url=about:blank</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+subsuite = thunderbird</span>
<a href="#l24.16"></a><span id="l24.16" class="difflineplus">+support-files = files/**</span>
<a href="#l24.17"></a><span id="l24.17" class="difflineplus">+</span>
<a href="#l24.18"></a><span id="l24.18" class="difflineplus">+[browser_manager.js]</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1">new file mode 100644</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineminus">--- /dev/null</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineplus">+++ b/mail/components/cloudfile/test/browser/browser_manager.js</span>
<a href="#l25.4"></a><span id="l25.4" class="difflineat">@@ -0,0 +1,253 @@</span>
<a href="#l25.5"></a><span id="l25.5" class="difflineplus">+/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l25.6"></a><span id="l25.6" class="difflineplus">+ * License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l25.7"></a><span id="l25.7" class="difflineplus">+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l25.8"></a><span id="l25.8" class="difflineplus">+</span>
<a href="#l25.9"></a><span id="l25.9" class="difflineplus">+/* import-globals-from ../../../../base/content/utilityOverlay.js */</span>
<a href="#l25.10"></a><span id="l25.10" class="difflineplus">+</span>
<a href="#l25.11"></a><span id="l25.11" class="difflineplus">+add_task(async () =&gt; {</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineplus">+  let mockPromptService = {</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+    confirmCount: 0,</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+    confirm() {</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+      this.confirmCount++;</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+      return true;</span>
<a href="#l25.17"></a><span id="l25.17" class="difflineplus">+    },</span>
<a href="#l25.18"></a><span id="l25.18" class="difflineplus">+    QueryInterface: ChromeUtils.generateQI([Ci.nsIPromptService]),</span>
<a href="#l25.19"></a><span id="l25.19" class="difflineplus">+  };</span>
<a href="#l25.20"></a><span id="l25.20" class="difflineplus">+</span>
<a href="#l25.21"></a><span id="l25.21" class="difflineplus">+  let { MockRegistrar } = ChromeUtils.import(&quot;resource://testing-common/MockRegistrar.jsm&quot;, null);</span>
<a href="#l25.22"></a><span id="l25.22" class="difflineplus">+  let mockPromptServiceCID = MockRegistrar.register(</span>
<a href="#l25.23"></a><span id="l25.23" class="difflineplus">+    &quot;@mozilla.org/embedcomp/prompt-service;1&quot;,</span>
<a href="#l25.24"></a><span id="l25.24" class="difflineplus">+    mockPromptService</span>
<a href="#l25.25"></a><span id="l25.25" class="difflineplus">+  );</span>
<a href="#l25.26"></a><span id="l25.26" class="difflineplus">+</span>
<a href="#l25.27"></a><span id="l25.27" class="difflineplus">+  registerCleanupFunction(() =&gt; {</span>
<a href="#l25.28"></a><span id="l25.28" class="difflineplus">+    MockRegistrar.unregister(mockPromptServiceCID);</span>
<a href="#l25.29"></a><span id="l25.29" class="difflineplus">+  });</span>
<a href="#l25.30"></a><span id="l25.30" class="difflineplus">+</span>
<a href="#l25.31"></a><span id="l25.31" class="difflineplus">+  let { cloudFileAccounts } = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;, null);</span>
<a href="#l25.32"></a><span id="l25.32" class="difflineplus">+  is(cloudFileAccounts.providers.length, 3);</span>
<a href="#l25.33"></a><span id="l25.33" class="difflineplus">+  is(cloudFileAccounts.accounts.length, 0);</span>
<a href="#l25.34"></a><span id="l25.34" class="difflineplus">+</span>
<a href="#l25.35"></a><span id="l25.35" class="difflineplus">+  // Load the preferences tab.</span>
<a href="#l25.36"></a><span id="l25.36" class="difflineplus">+</span>
<a href="#l25.37"></a><span id="l25.37" class="difflineplus">+  let prefsDocument = await new Promise(resolve =&gt; {</span>
<a href="#l25.38"></a><span id="l25.38" class="difflineplus">+    Services.obs.addObserver(function documentLoaded(subject) {</span>
<a href="#l25.39"></a><span id="l25.39" class="difflineplus">+      if (subject.URL == &quot;about:preferences&quot;) {</span>
<a href="#l25.40"></a><span id="l25.40" class="difflineplus">+        Services.obs.removeObserver(documentLoaded, &quot;chrome-document-loaded&quot;);</span>
<a href="#l25.41"></a><span id="l25.41" class="difflineplus">+        resolve(subject);</span>
<a href="#l25.42"></a><span id="l25.42" class="difflineplus">+      }</span>
<a href="#l25.43"></a><span id="l25.43" class="difflineplus">+    }, &quot;chrome-document-loaded&quot;);</span>
<a href="#l25.44"></a><span id="l25.44" class="difflineplus">+    openPreferencesTab(&quot;paneApplications&quot;, &quot;attachmentsOutTab&quot;);</span>
<a href="#l25.45"></a><span id="l25.45" class="difflineplus">+  });</span>
<a href="#l25.46"></a><span id="l25.46" class="difflineplus">+  ok(prefsDocument.URL == &quot;about:preferences&quot;);</span>
<a href="#l25.47"></a><span id="l25.47" class="difflineplus">+</span>
<a href="#l25.48"></a><span id="l25.48" class="difflineplus">+  let prefsWindow = prefsDocument.ownerGlobal;</span>
<a href="#l25.49"></a><span id="l25.49" class="difflineplus">+  if (prefsWindow.getCurrentPaneID() != &quot;paneApplications&quot;) {</span>
<a href="#l25.50"></a><span id="l25.50" class="difflineplus">+    await new Promise(resolve =&gt; {</span>
<a href="#l25.51"></a><span id="l25.51" class="difflineplus">+      prefsDocument.addEventListener(&quot;paneSelected&quot;, resolve, { once: true });</span>
<a href="#l25.52"></a><span id="l25.52" class="difflineplus">+    });</span>
<a href="#l25.53"></a><span id="l25.53" class="difflineplus">+  }</span>
<a href="#l25.54"></a><span id="l25.54" class="difflineplus">+  is(prefsWindow.getCurrentPaneID(), &quot;paneApplications&quot;);</span>
<a href="#l25.55"></a><span id="l25.55" class="difflineplus">+</span>
<a href="#l25.56"></a><span id="l25.56" class="difflineplus">+  // Check everything is as it should be.</span>
<a href="#l25.57"></a><span id="l25.57" class="difflineplus">+</span>
<a href="#l25.58"></a><span id="l25.58" class="difflineplus">+  let accountList = prefsDocument.getElementById(&quot;cloudFileView&quot;);</span>
<a href="#l25.59"></a><span id="l25.59" class="difflineplus">+  is(accountList.itemCount, 0);</span>
<a href="#l25.60"></a><span id="l25.60" class="difflineplus">+</span>
<a href="#l25.61"></a><span id="l25.61" class="difflineplus">+  let buttonList = prefsDocument.getElementById(&quot;addCloudFileAccountButtons&quot;);</span>
<a href="#l25.62"></a><span id="l25.62" class="difflineplus">+  is(buttonList.childElementCount, 2);</span>
<a href="#l25.63"></a><span id="l25.63" class="difflineplus">+  is(buttonList.children[0].getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l25.64"></a><span id="l25.64" class="difflineplus">+  is(buttonList.children[1].getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l25.65"></a><span id="l25.65" class="difflineplus">+</span>
<a href="#l25.66"></a><span id="l25.66" class="difflineplus">+  let removeButton = prefsDocument.getElementById(&quot;removeCloudFileAccount&quot;);</span>
<a href="#l25.67"></a><span id="l25.67" class="difflineplus">+  ok(removeButton.disabled);</span>
<a href="#l25.68"></a><span id="l25.68" class="difflineplus">+</span>
<a href="#l25.69"></a><span id="l25.69" class="difflineplus">+  let settingsDeck = prefsDocument.getElementById(&quot;cloudFileSettingsDeck&quot;);</span>
<a href="#l25.70"></a><span id="l25.70" class="difflineplus">+  is(settingsDeck.selectedPanel.id, &quot;cloudFileDefaultPanel&quot;);</span>
<a href="#l25.71"></a><span id="l25.71" class="difflineplus">+</span>
<a href="#l25.72"></a><span id="l25.72" class="difflineplus">+  let iframeWrapper = prefsDocument.getElementById(&quot;cloudFileSettingsWrapper&quot;);</span>
<a href="#l25.73"></a><span id="l25.73" class="difflineplus">+  is(iframeWrapper.childElementCount, 0);</span>
<a href="#l25.74"></a><span id="l25.74" class="difflineplus">+</span>
<a href="#l25.75"></a><span id="l25.75" class="difflineplus">+  // Register our test provider.</span>
<a href="#l25.76"></a><span id="l25.76" class="difflineplus">+</span>
<a href="#l25.77"></a><span id="l25.77" class="difflineplus">+  const ICON_URL = getRootDirectory(gTestPath) + &quot;files/icon.svg&quot;;</span>
<a href="#l25.78"></a><span id="l25.78" class="difflineplus">+  const MANAGEMENT_URL = getRootDirectory(gTestPath) + &quot;files/management.html&quot;;</span>
<a href="#l25.79"></a><span id="l25.79" class="difflineplus">+</span>
<a href="#l25.80"></a><span id="l25.80" class="difflineplus">+  let accountIsConfigured = false;</span>
<a href="#l25.81"></a><span id="l25.81" class="difflineplus">+  let provider = {</span>
<a href="#l25.82"></a><span id="l25.82" class="difflineplus">+    type: &quot;Mochitest&quot;,</span>
<a href="#l25.83"></a><span id="l25.83" class="difflineplus">+    displayName: &quot;Mochitest&quot;,</span>
<a href="#l25.84"></a><span id="l25.84" class="difflineplus">+    iconURL: ICON_URL,</span>
<a href="#l25.85"></a><span id="l25.85" class="difflineplus">+    initAccount(accountKey) {</span>
<a href="#l25.86"></a><span id="l25.86" class="difflineplus">+      return {</span>
<a href="#l25.87"></a><span id="l25.87" class="difflineplus">+        accountKey,</span>
<a href="#l25.88"></a><span id="l25.88" class="difflineplus">+        type: &quot;Mochitest&quot;,</span>
<a href="#l25.89"></a><span id="l25.89" class="difflineplus">+        get displayName() {</span>
<a href="#l25.90"></a><span id="l25.90" class="difflineplus">+          return Services.prefs.getCharPref(</span>
<a href="#l25.91"></a><span id="l25.91" class="difflineplus">+            `mail.cloud_files.accounts.${this.accountKey}.displayName`,</span>
<a href="#l25.92"></a><span id="l25.92" class="difflineplus">+            &quot;Mochitest Account&quot;</span>
<a href="#l25.93"></a><span id="l25.93" class="difflineplus">+          );</span>
<a href="#l25.94"></a><span id="l25.94" class="difflineplus">+        },</span>
<a href="#l25.95"></a><span id="l25.95" class="difflineplus">+        iconURL: ICON_URL,</span>
<a href="#l25.96"></a><span id="l25.96" class="difflineplus">+        configured: accountIsConfigured,</span>
<a href="#l25.97"></a><span id="l25.97" class="difflineplus">+        managementURL: MANAGEMENT_URL,</span>
<a href="#l25.98"></a><span id="l25.98" class="difflineplus">+      };</span>
<a href="#l25.99"></a><span id="l25.99" class="difflineplus">+    },</span>
<a href="#l25.100"></a><span id="l25.100" class="difflineplus">+  };</span>
<a href="#l25.101"></a><span id="l25.101" class="difflineplus">+  cloudFileAccounts.registerProvider(&quot;Mochitest&quot;, provider);</span>
<a href="#l25.102"></a><span id="l25.102" class="difflineplus">+  is(cloudFileAccounts.providers.length, 4);</span>
<a href="#l25.103"></a><span id="l25.103" class="difflineplus">+  is(cloudFileAccounts.accounts.length, 0);</span>
<a href="#l25.104"></a><span id="l25.104" class="difflineplus">+</span>
<a href="#l25.105"></a><span id="l25.105" class="difflineplus">+  await new Promise(resolve =&gt; prefsWindow.requestAnimationFrame(resolve));</span>
<a href="#l25.106"></a><span id="l25.106" class="difflineplus">+</span>
<a href="#l25.107"></a><span id="l25.107" class="difflineplus">+  is(buttonList.childElementCount, 3);</span>
<a href="#l25.108"></a><span id="l25.108" class="difflineplus">+  is(buttonList.children[0].getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l25.109"></a><span id="l25.109" class="difflineplus">+  is(buttonList.children[1].getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l25.110"></a><span id="l25.110" class="difflineplus">+  is(buttonList.children[2].getAttribute(&quot;value&quot;), &quot;Mochitest&quot;);</span>
<a href="#l25.111"></a><span id="l25.111" class="difflineplus">+  is(buttonList.children[2].style.listStyleImage, `url(&quot;${ICON_URL}&quot;)`);</span>
<a href="#l25.112"></a><span id="l25.112" class="difflineplus">+</span>
<a href="#l25.113"></a><span id="l25.113" class="difflineplus">+  // Create a new account.</span>
<a href="#l25.114"></a><span id="l25.114" class="difflineplus">+</span>
<a href="#l25.115"></a><span id="l25.115" class="difflineplus">+  EventUtils.synthesizeMouseAtCenter(buttonList.children[2], { clickCount: 1 }, prefsWindow);</span>
<a href="#l25.116"></a><span id="l25.116" class="difflineplus">+  is(cloudFileAccounts.accounts.length, 1);</span>
<a href="#l25.117"></a><span id="l25.117" class="difflineplus">+  is(cloudFileAccounts.configuredAccounts.length, 0);</span>
<a href="#l25.118"></a><span id="l25.118" class="difflineplus">+</span>
<a href="#l25.119"></a><span id="l25.119" class="difflineplus">+  let account = cloudFileAccounts.accounts[0];</span>
<a href="#l25.120"></a><span id="l25.120" class="difflineplus">+  let accountKey = account.accountKey;</span>
<a href="#l25.121"></a><span id="l25.121" class="difflineplus">+  is(cloudFileAccounts.accounts[0].type, &quot;Mochitest&quot;);</span>
<a href="#l25.122"></a><span id="l25.122" class="difflineplus">+</span>
<a href="#l25.123"></a><span id="l25.123" class="difflineplus">+  // Check prefs were updated.</span>
<a href="#l25.124"></a><span id="l25.124" class="difflineplus">+</span>
<a href="#l25.125"></a><span id="l25.125" class="difflineplus">+  is(Services.prefs.getCharPref(`mail.cloud_files.accounts.${accountKey}.displayName`), &quot;Mochitest Account&quot;);</span>
<a href="#l25.126"></a><span id="l25.126" class="difflineplus">+  is(Services.prefs.getCharPref(`mail.cloud_files.accounts.${accountKey}.type`), &quot;Mochitest&quot;);</span>
<a href="#l25.127"></a><span id="l25.127" class="difflineplus">+</span>
<a href="#l25.128"></a><span id="l25.128" class="difflineplus">+  // Check UI was updated.</span>
<a href="#l25.129"></a><span id="l25.129" class="difflineplus">+</span>
<a href="#l25.130"></a><span id="l25.130" class="difflineplus">+  is(accountList.itemCount, 1);</span>
<a href="#l25.131"></a><span id="l25.131" class="difflineplus">+  is(accountList.selectedIndex, 0);</span>
<a href="#l25.132"></a><span id="l25.132" class="difflineplus">+  ok(!removeButton.disabled);</span>
<a href="#l25.133"></a><span id="l25.133" class="difflineplus">+</span>
<a href="#l25.134"></a><span id="l25.134" class="difflineplus">+  let accountListItem = accountList.selectedItem;</span>
<a href="#l25.135"></a><span id="l25.135" class="difflineplus">+  is(accountListItem.getAttribute(&quot;value&quot;), accountKey);</span>
<a href="#l25.136"></a><span id="l25.136" class="difflineplus">+  is(accountListItem.style.listStyleImage, `url(&quot;${ICON_URL}&quot;)`);</span>
<a href="#l25.137"></a><span id="l25.137" class="difflineplus">+  is(accountListItem.querySelector(&quot;label&quot;).value, &quot;Mochitest Account&quot;);</span>
<a href="#l25.138"></a><span id="l25.138" class="difflineplus">+  is(accountListItem.querySelector(&quot;image.configuredWarning&quot;).hidden, false);</span>
<a href="#l25.139"></a><span id="l25.139" class="difflineplus">+</span>
<a href="#l25.140"></a><span id="l25.140" class="difflineplus">+  is(settingsDeck.selectedPanel.id, &quot;cloudFileSettingsWrapper&quot;);</span>
<a href="#l25.141"></a><span id="l25.141" class="difflineplus">+  is(iframeWrapper.childElementCount, 1);</span>
<a href="#l25.142"></a><span id="l25.142" class="difflineplus">+</span>
<a href="#l25.143"></a><span id="l25.143" class="difflineplus">+  let iframe = iframeWrapper.firstElementChild;</span>
<a href="#l25.144"></a><span id="l25.144" class="difflineplus">+  is(iframe.src, `${MANAGEMENT_URL}?accountId=${accountKey}`);</span>
<a href="#l25.145"></a><span id="l25.145" class="difflineplus">+</span>
<a href="#l25.146"></a><span id="l25.146" class="difflineplus">+  // Rename the account.</span>
<a href="#l25.147"></a><span id="l25.147" class="difflineplus">+</span>
<a href="#l25.148"></a><span id="l25.148" class="difflineplus">+  EventUtils.synthesizeMouseAtCenter(accountListItem, { clickCount: 1 }, prefsWindow);</span>
<a href="#l25.149"></a><span id="l25.149" class="difflineplus">+</span>
<a href="#l25.150"></a><span id="l25.150" class="difflineplus">+  await new Promise(resolve =&gt; prefsWindow.requestAnimationFrame(resolve));</span>
<a href="#l25.151"></a><span id="l25.151" class="difflineplus">+</span>
<a href="#l25.152"></a><span id="l25.152" class="difflineplus">+  is(prefsDocument.activeElement.closest(&quot;textbox&quot;), accountListItem.querySelector(&quot;textbox&quot;));</span>
<a href="#l25.153"></a><span id="l25.153" class="difflineplus">+  ok(accountListItem.querySelector(&quot;label&quot;).hidden);</span>
<a href="#l25.154"></a><span id="l25.154" class="difflineplus">+  ok(!accountListItem.querySelector(&quot;textbox&quot;).hidden);</span>
<a href="#l25.155"></a><span id="l25.155" class="difflineplus">+  is(accountListItem.querySelector(&quot;textbox&quot;).value, &quot;Mochitest Account&quot;);</span>
<a href="#l25.156"></a><span id="l25.156" class="difflineplus">+  EventUtils.synthesizeKey(&quot;VK_RIGHT&quot;, undefined, prefsWindow);</span>
<a href="#l25.157"></a><span id="l25.157" class="difflineplus">+  EventUtils.synthesizeKey(&quot;!&quot;, undefined, prefsWindow);</span>
<a href="#l25.158"></a><span id="l25.158" class="difflineplus">+  EventUtils.synthesizeKey(&quot;VK_RETURN&quot;, undefined, prefsWindow);</span>
<a href="#l25.159"></a><span id="l25.159" class="difflineplus">+</span>
<a href="#l25.160"></a><span id="l25.160" class="difflineplus">+  await new Promise(resolve =&gt; prefsWindow.requestAnimationFrame(resolve));</span>
<a href="#l25.161"></a><span id="l25.161" class="difflineplus">+</span>
<a href="#l25.162"></a><span id="l25.162" class="difflineplus">+  is(prefsDocument.activeElement, accountList);</span>
<a href="#l25.163"></a><span id="l25.163" class="difflineplus">+  ok(!accountListItem.querySelector(&quot;label&quot;).hidden);</span>
<a href="#l25.164"></a><span id="l25.164" class="difflineplus">+  is(accountListItem.querySelector(&quot;label&quot;).value, &quot;Mochitest Account!&quot;);</span>
<a href="#l25.165"></a><span id="l25.165" class="difflineplus">+  ok(accountListItem.querySelector(&quot;textbox&quot;).hidden);</span>
<a href="#l25.166"></a><span id="l25.166" class="difflineplus">+  is(Services.prefs.getCharPref(`mail.cloud_files.accounts.${accountKey}.displayName`), &quot;Mochitest Account!&quot;);</span>
<a href="#l25.167"></a><span id="l25.167" class="difflineplus">+</span>
<a href="#l25.168"></a><span id="l25.168" class="difflineplus">+  // Start to rename the account, but bail out.</span>
<a href="#l25.169"></a><span id="l25.169" class="difflineplus">+</span>
<a href="#l25.170"></a><span id="l25.170" class="difflineplus">+  EventUtils.synthesizeMouseAtCenter(accountListItem, { clickCount: 1 }, prefsWindow);</span>
<a href="#l25.171"></a><span id="l25.171" class="difflineplus">+</span>
<a href="#l25.172"></a><span id="l25.172" class="difflineplus">+  await new Promise(resolve =&gt; prefsWindow.requestAnimationFrame(resolve));</span>
<a href="#l25.173"></a><span id="l25.173" class="difflineplus">+</span>
<a href="#l25.174"></a><span id="l25.174" class="difflineplus">+  is(prefsDocument.activeElement.closest(&quot;textbox&quot;), accountListItem.querySelector(&quot;textbox&quot;));</span>
<a href="#l25.175"></a><span id="l25.175" class="difflineplus">+  EventUtils.synthesizeKey(&quot;O&quot;, undefined, prefsWindow);</span>
<a href="#l25.176"></a><span id="l25.176" class="difflineplus">+  EventUtils.synthesizeKey(&quot;o&quot;, undefined, prefsWindow);</span>
<a href="#l25.177"></a><span id="l25.177" class="difflineplus">+  EventUtils.synthesizeKey(&quot;p&quot;, undefined, prefsWindow);</span>
<a href="#l25.178"></a><span id="l25.178" class="difflineplus">+  EventUtils.synthesizeKey(&quot;s&quot;, undefined, prefsWindow);</span>
<a href="#l25.179"></a><span id="l25.179" class="difflineplus">+  EventUtils.synthesizeKey(&quot;VK_ESCAPE&quot;, undefined, prefsWindow);</span>
<a href="#l25.180"></a><span id="l25.180" class="difflineplus">+</span>
<a href="#l25.181"></a><span id="l25.181" class="difflineplus">+  await new Promise(resolve =&gt; prefsWindow.requestAnimationFrame(resolve));</span>
<a href="#l25.182"></a><span id="l25.182" class="difflineplus">+</span>
<a href="#l25.183"></a><span id="l25.183" class="difflineplus">+  is(prefsDocument.activeElement, accountList);</span>
<a href="#l25.184"></a><span id="l25.184" class="difflineplus">+  ok(!accountListItem.querySelector(&quot;label&quot;).hidden);</span>
<a href="#l25.185"></a><span id="l25.185" class="difflineplus">+  is(accountListItem.querySelector(&quot;label&quot;).value, &quot;Mochitest Account!&quot;);</span>
<a href="#l25.186"></a><span id="l25.186" class="difflineplus">+  ok(accountListItem.querySelector(&quot;textbox&quot;).hidden);</span>
<a href="#l25.187"></a><span id="l25.187" class="difflineplus">+  is(Services.prefs.getCharPref(`mail.cloud_files.accounts.${accountKey}.displayName`), &quot;Mochitest Account!&quot;);</span>
<a href="#l25.188"></a><span id="l25.188" class="difflineplus">+</span>
<a href="#l25.189"></a><span id="l25.189" class="difflineplus">+  // Configure the account.</span>
<a href="#l25.190"></a><span id="l25.190" class="difflineplus">+</span>
<a href="#l25.191"></a><span id="l25.191" class="difflineplus">+  account.configured = true;</span>
<a href="#l25.192"></a><span id="l25.192" class="difflineplus">+  accountIsConfigured = true;</span>
<a href="#l25.193"></a><span id="l25.193" class="difflineplus">+  cloudFileAccounts.emit(&quot;accountConfigured&quot;, account);</span>
<a href="#l25.194"></a><span id="l25.194" class="difflineplus">+</span>
<a href="#l25.195"></a><span id="l25.195" class="difflineplus">+  await new Promise(resolve =&gt; prefsWindow.requestAnimationFrame(resolve));</span>
<a href="#l25.196"></a><span id="l25.196" class="difflineplus">+</span>
<a href="#l25.197"></a><span id="l25.197" class="difflineplus">+  is(accountListItem.querySelector(&quot;image.configuredWarning&quot;).hidden, true);</span>
<a href="#l25.198"></a><span id="l25.198" class="difflineplus">+  is(cloudFileAccounts.accounts.length, 1);</span>
<a href="#l25.199"></a><span id="l25.199" class="difflineplus">+  is(cloudFileAccounts.configuredAccounts.length, 1);</span>
<a href="#l25.200"></a><span id="l25.200" class="difflineplus">+</span>
<a href="#l25.201"></a><span id="l25.201" class="difflineplus">+  // Remove the test provider. The list item, button, and iframe should disappear.</span>
<a href="#l25.202"></a><span id="l25.202" class="difflineplus">+</span>
<a href="#l25.203"></a><span id="l25.203" class="difflineplus">+  cloudFileAccounts.unregisterProvider(&quot;Mochitest&quot;);</span>
<a href="#l25.204"></a><span id="l25.204" class="difflineplus">+  is(cloudFileAccounts.providers.length, 3);</span>
<a href="#l25.205"></a><span id="l25.205" class="difflineplus">+  is(cloudFileAccounts.accounts.length, 0);</span>
<a href="#l25.206"></a><span id="l25.206" class="difflineplus">+</span>
<a href="#l25.207"></a><span id="l25.207" class="difflineplus">+  await new Promise(resolve =&gt; prefsWindow.requestAnimationFrame(resolve));</span>
<a href="#l25.208"></a><span id="l25.208" class="difflineplus">+</span>
<a href="#l25.209"></a><span id="l25.209" class="difflineplus">+  is(buttonList.childElementCount, 2);</span>
<a href="#l25.210"></a><span id="l25.210" class="difflineplus">+  is(buttonList.children[0].getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l25.211"></a><span id="l25.211" class="difflineplus">+  is(buttonList.children[1].getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l25.212"></a><span id="l25.212" class="difflineplus">+  is(accountList.itemCount, 0);</span>
<a href="#l25.213"></a><span id="l25.213" class="difflineplus">+  is(settingsDeck.selectedPanel.id, &quot;cloudFileDefaultPanel&quot;);</span>
<a href="#l25.214"></a><span id="l25.214" class="difflineplus">+  is(iframeWrapper.childElementCount, 0);</span>
<a href="#l25.215"></a><span id="l25.215" class="difflineplus">+</span>
<a href="#l25.216"></a><span id="l25.216" class="difflineplus">+  // Re-add the test provider.</span>
<a href="#l25.217"></a><span id="l25.217" class="difflineplus">+</span>
<a href="#l25.218"></a><span id="l25.218" class="difflineplus">+  cloudFileAccounts.registerProvider(&quot;Mochitest&quot;, provider);</span>
<a href="#l25.219"></a><span id="l25.219" class="difflineplus">+  is(cloudFileAccounts.providers.length, 4);</span>
<a href="#l25.220"></a><span id="l25.220" class="difflineplus">+  is(cloudFileAccounts.accounts.length, 1);</span>
<a href="#l25.221"></a><span id="l25.221" class="difflineplus">+  is(cloudFileAccounts.configuredAccounts.length, 1);</span>
<a href="#l25.222"></a><span id="l25.222" class="difflineplus">+</span>
<a href="#l25.223"></a><span id="l25.223" class="difflineplus">+  await new Promise(resolve =&gt; prefsWindow.requestAnimationFrame(resolve));</span>
<a href="#l25.224"></a><span id="l25.224" class="difflineplus">+</span>
<a href="#l25.225"></a><span id="l25.225" class="difflineplus">+  is(buttonList.childElementCount, 3);</span>
<a href="#l25.226"></a><span id="l25.226" class="difflineplus">+  is(buttonList.children[0].getAttribute(&quot;value&quot;), &quot;Box&quot;);</span>
<a href="#l25.227"></a><span id="l25.227" class="difflineplus">+  is(buttonList.children[1].getAttribute(&quot;value&quot;), &quot;ext-wetransfer@extensions.thunderbird.net&quot;);</span>
<a href="#l25.228"></a><span id="l25.228" class="difflineplus">+  is(buttonList.children[2].getAttribute(&quot;value&quot;), &quot;Mochitest&quot;);</span>
<a href="#l25.229"></a><span id="l25.229" class="difflineplus">+</span>
<a href="#l25.230"></a><span id="l25.230" class="difflineplus">+  is(accountList.itemCount, 1);</span>
<a href="#l25.231"></a><span id="l25.231" class="difflineplus">+  is(accountList.selectedIndex, -1);</span>
<a href="#l25.232"></a><span id="l25.232" class="difflineplus">+  ok(removeButton.disabled);</span>
<a href="#l25.233"></a><span id="l25.233" class="difflineplus">+</span>
<a href="#l25.234"></a><span id="l25.234" class="difflineplus">+  accountListItem = accountList.getItemAtIndex(0);</span>
<a href="#l25.235"></a><span id="l25.235" class="difflineplus">+  is(Services.prefs.getCharPref(`mail.cloud_files.accounts.${accountKey}.displayName`), &quot;Mochitest Account!&quot;);</span>
<a href="#l25.236"></a><span id="l25.236" class="difflineplus">+</span>
<a href="#l25.237"></a><span id="l25.237" class="difflineplus">+  EventUtils.synthesizeMouseAtCenter(accountList.getItemAtIndex(0), { clickCount: 1 }, prefsWindow);</span>
<a href="#l25.238"></a><span id="l25.238" class="difflineplus">+  ok(!removeButton.disabled);</span>
<a href="#l25.239"></a><span id="l25.239" class="difflineplus">+  EventUtils.synthesizeMouseAtCenter(removeButton, { clickCount: 1 }, prefsWindow);</span>
<a href="#l25.240"></a><span id="l25.240" class="difflineplus">+  is(mockPromptService.confirmCount, 1);</span>
<a href="#l25.241"></a><span id="l25.241" class="difflineplus">+</span>
<a href="#l25.242"></a><span id="l25.242" class="difflineplus">+  ok(!Services.prefs.prefHasUserValue(`mail.cloud_files.accounts.${accountKey}.displayName`));</span>
<a href="#l25.243"></a><span id="l25.243" class="difflineplus">+  ok(!Services.prefs.prefHasUserValue(`mail.cloud_files.accounts.${accountKey}.type`));</span>
<a href="#l25.244"></a><span id="l25.244" class="difflineplus">+</span>
<a href="#l25.245"></a><span id="l25.245" class="difflineplus">+  is(cloudFileAccounts.providers.length, 4);</span>
<a href="#l25.246"></a><span id="l25.246" class="difflineplus">+  is(cloudFileAccounts.accounts.length, 0);</span>
<a href="#l25.247"></a><span id="l25.247" class="difflineplus">+</span>
<a href="#l25.248"></a><span id="l25.248" class="difflineplus">+  cloudFileAccounts.unregisterProvider(&quot;Mochitest&quot;, provider);</span>
<a href="#l25.249"></a><span id="l25.249" class="difflineplus">+  is(cloudFileAccounts.providers.length, 3);</span>
<a href="#l25.250"></a><span id="l25.250" class="difflineplus">+  is(cloudFileAccounts.accounts.length, 0);</span>
<a href="#l25.251"></a><span id="l25.251" class="difflineplus">+</span>
<a href="#l25.252"></a><span id="l25.252" class="difflineplus">+  let tabmail = document.getElementById(&quot;tabmail&quot;);</span>
<a href="#l25.253"></a><span id="l25.253" class="difflineplus">+  let prefsTab = tabmail.currentTabInfo;</span>
<a href="#l25.254"></a><span id="l25.254" class="difflineplus">+  // This line is a hack to make the test pass despite bug 1519416.</span>
<a href="#l25.255"></a><span id="l25.255" class="difflineplus">+  document.querySelector(`findbar[browserid=&quot;preferencesbrowser&quot;]`)._destroyed = true;</span>
<a href="#l25.256"></a><span id="l25.256" class="difflineplus">+  tabmail.closeTab(prefsTab);</span>
<a href="#l25.257"></a><span id="l25.257" class="difflineplus">+});</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1">new file mode 100644</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineminus">--- /dev/null</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineplus">+++ b/mail/components/cloudfile/test/browser/files/icon.svg</span>
<a href="#l26.4"></a><span id="l26.4" class="difflineat">@@ -0,0 +1,7 @@</span>
<a href="#l26.5"></a><span id="l26.5" class="difflineplus">+&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<a href="#l26.6"></a><span id="l26.6" class="difflineplus">+&lt;svg xmlns=&quot;http://www.w3.org/2000/svg&quot; width=&quot;16&quot; height=&quot;16&quot;&gt;</span>
<a href="#l26.7"></a><span id="l26.7" class="difflineplus">+  &lt;circle cx=&quot;8&quot; cy=&quot;8&quot; r=&quot;7.5&quot; fill=&quot;#ffffff&quot; stroke=&quot;#00aa00&quot; stroke-width=&quot;1.5&quot;/&gt;</span>
<a href="#l26.8"></a><span id="l26.8" class="difflineplus">+  &lt;circle cx=&quot;5&quot; cy=&quot;6&quot; r=&quot;1.5&quot; fill=&quot;#00aa00&quot;/&gt;</span>
<a href="#l26.9"></a><span id="l26.9" class="difflineplus">+  &lt;circle cx=&quot;11&quot; cy=&quot;6&quot; r=&quot;1.5&quot; fill=&quot;#00aa00&quot;/&gt;</span>
<a href="#l26.10"></a><span id="l26.10" class="difflineplus">+  &lt;path d=&quot;M 12.83,9.30 C 12.24,11.48 10.26,13 8,13 5.75,13 3.74,11.48 3.17,9.29&quot; fill=&quot;none&quot; stroke=&quot;#00aa00&quot; stroke-width=&quot;1.5&quot;/&gt;</span>
<a href="#l26.11"></a><span id="l26.11" class="difflineplus">+&lt;/svg&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1">new file mode 100644</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineminus">--- /dev/null</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineplus">+++ b/mail/components/cloudfile/test/browser/files/management.html</span>
<a href="#l27.4"></a><span id="l27.4" class="difflineat">@@ -0,0 +1,10 @@</span>
<a href="#l27.5"></a><span id="l27.5" class="difflineplus">+&lt;!DOCTYPE html&gt;</span>
<a href="#l27.6"></a><span id="l27.6" class="difflineplus">+&lt;html&gt;</span>
<a href="#l27.7"></a><span id="l27.7" class="difflineplus">+&lt;head&gt;</span>
<a href="#l27.8"></a><span id="l27.8" class="difflineplus">+  &lt;meta charset=&quot;utf-8&quot;/&gt;</span>
<a href="#l27.9"></a><span id="l27.9" class="difflineplus">+  &lt;title&gt;&lt;/title&gt;</span>
<a href="#l27.10"></a><span id="l27.10" class="difflineplus">+&lt;/head&gt;</span>
<a href="#l27.11"></a><span id="l27.11" class="difflineplus">+&lt;body&gt;</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineplus">+</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+&lt;/body&gt;</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mail/components/cloudfile/wetransfer/background/background.js</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mail/components/cloudfile/wetransfer/background/background.js</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -142,15 +142,21 @@ browser.cloudFile.onFileUploadAbort.addL</span>
<a href="#l28.4"></a><span id="l28.4">   let controller = abortControllers.get(id);</span>
<a href="#l28.5"></a><span id="l28.5">   if (controller) {</span>
<a href="#l28.6"></a><span id="l28.6">     controller.abort();</span>
<a href="#l28.7"></a><span id="l28.7">   }</span>
<a href="#l28.8"></a><span id="l28.8"> });</span>
<a href="#l28.9"></a><span id="l28.9"> </span>
<a href="#l28.10"></a><span id="l28.10"> browser.cloudFile.getAllAccounts().then(async (accounts) =&gt; {</span>
<a href="#l28.11"></a><span id="l28.11">   for (let account of accounts) {</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineminus">-    await browser.cloudFile.updateAccount(account.id, { uploadSizeLimit: TWO_GB });</span>
<a href="#l28.13"></a><span id="l28.13" class="difflineplus">+    await browser.cloudFile.updateAccount(account.id, {</span>
<a href="#l28.14"></a><span id="l28.14" class="difflineplus">+      configured: true,</span>
<a href="#l28.15"></a><span id="l28.15" class="difflineplus">+      uploadSizeLimit: TWO_GB,</span>
<a href="#l28.16"></a><span id="l28.16" class="difflineplus">+    });</span>
<a href="#l28.17"></a><span id="l28.17">   }</span>
<a href="#l28.18"></a><span id="l28.18"> });</span>
<a href="#l28.19"></a><span id="l28.19"> </span>
<a href="#l28.20"></a><span id="l28.20"> browser.cloudFile.onAccountAdded.addListener(async (account) =&gt; {</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineminus">-  await browser.cloudFile.updateAccount(account.id, { uploadSizeLimit: TWO_GB });</span>
<a href="#l28.22"></a><span id="l28.22" class="difflineplus">+  await browser.cloudFile.updateAccount(account.id, {</span>
<a href="#l28.23"></a><span id="l28.23" class="difflineplus">+    configured: true,</span>
<a href="#l28.24"></a><span id="l28.24" class="difflineplus">+    uploadSizeLimit: TWO_GB,</span>
<a href="#l28.25"></a><span id="l28.25" class="difflineplus">+  });</span>
<a href="#l28.26"></a><span id="l28.26"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mail/components/cloudfile/wetransfer/manifest.json</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mail/components/cloudfile/wetransfer/manifest.json</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -15,17 +15,16 @@</span>
<a href="#l29.4"></a><span id="l29.4">     &quot;16&quot;: &quot;images/logo.svg&quot;,</span>
<a href="#l29.5"></a><span id="l29.5">     &quot;32&quot;: &quot;images/logo.svg&quot;,</span>
<a href="#l29.6"></a><span id="l29.6">     &quot;48&quot;: &quot;images/logo.svg&quot;,</span>
<a href="#l29.7"></a><span id="l29.7">     &quot;128&quot;: &quot;images/logo.svg&quot;</span>
<a href="#l29.8"></a><span id="l29.8">   },</span>
<a href="#l29.9"></a><span id="l29.9"> </span>
<a href="#l29.10"></a><span id="l29.10">   &quot;cloud_file&quot;: {</span>
<a href="#l29.11"></a><span id="l29.11">     &quot;name&quot;: &quot;__MSG_serviceName__&quot;,</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineminus">-    &quot;settings_url&quot;: &quot;/content/moments.html&quot;,</span>
<a href="#l29.13"></a><span id="l29.13">     &quot;management_url&quot;: &quot;/content/moments.html&quot;</span>
<a href="#l29.14"></a><span id="l29.14">   },</span>
<a href="#l29.15"></a><span id="l29.15"> </span>
<a href="#l29.16"></a><span id="l29.16">   &quot;background&quot;: {</span>
<a href="#l29.17"></a><span id="l29.17">     &quot;scripts&quot;: [</span>
<a href="#l29.18"></a><span id="l29.18">       &quot;background/background.js&quot;</span>
<a href="#l29.19"></a><span id="l29.19">     ]</span>
<a href="#l29.20"></a><span id="l29.20">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mail/components/compose/content/MsgComposeCommands.js</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -621,17 +621,17 @@ var defaultController = {</span>
<a href="#l30.4"></a><span id="l30.4">     },</span>
<a href="#l30.5"></a><span id="l30.5"> </span>
<a href="#l30.6"></a><span id="l30.6">     cmd_attachCloud: {</span>
<a href="#l30.7"></a><span id="l30.7">       isEnabled() {</span>
<a href="#l30.8"></a><span id="l30.8">         // Hide the command entirely if there are no cloud accounts or</span>
<a href="#l30.9"></a><span id="l30.9">         // the feature is disbled.</span>
<a href="#l30.10"></a><span id="l30.10">         let cmd = document.getElementById(&quot;cmd_attachCloud&quot;);</span>
<a href="#l30.11"></a><span id="l30.11">         cmd.hidden = !Services.prefs.getBoolPref(&quot;mail.cloud_files.enabled&quot;) ||</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineminus">-                     (cloudFileAccounts.accounts.length == 0) ||</span>
<a href="#l30.13"></a><span id="l30.13" class="difflineplus">+                     (cloudFileAccounts.configuredAccounts.length == 0) ||</span>
<a href="#l30.14"></a><span id="l30.14">                      Services.io.offline;</span>
<a href="#l30.15"></a><span id="l30.15">         return !cmd.hidden &amp;&amp; !gWindowLocked;</span>
<a href="#l30.16"></a><span id="l30.16">       },</span>
<a href="#l30.17"></a><span id="l30.17">       doCommand() {</span>
<a href="#l30.18"></a><span id="l30.18">         // We should never actually call this, since the &lt;command&gt; node calls</span>
<a href="#l30.19"></a><span id="l30.19">         // a different function.</span>
<a href="#l30.20"></a><span id="l30.20">       },</span>
<a href="#l30.21"></a><span id="l30.21">     },</span>
<a href="#l30.22"></a><span id="l30.22" class="difflineat">@@ -1088,17 +1088,17 @@ var attachmentBucketController = {</span>
<a href="#l30.23"></a><span id="l30.23"> </span>
<a href="#l30.24"></a><span id="l30.24">     cmd_convertCloud: {</span>
<a href="#l30.25"></a><span id="l30.25">       isEnabled() {</span>
<a href="#l30.26"></a><span id="l30.26">         // Hide the command entirely if Filelink is disabled, or if there are</span>
<a href="#l30.27"></a><span id="l30.27">         // no cloud accounts.</span>
<a href="#l30.28"></a><span id="l30.28">         let cmd = document.getElementById(&quot;cmd_convertCloud&quot;);</span>
<a href="#l30.29"></a><span id="l30.29"> </span>
<a href="#l30.30"></a><span id="l30.30">         cmd.hidden = (!Services.prefs.getBoolPref(&quot;mail.cloud_files.enabled&quot;) ||</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineminus">-                      cloudFileAccounts.accounts.length == 0) ||</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+                      cloudFileAccounts.configuredAccounts.length == 0) ||</span>
<a href="#l30.33"></a><span id="l30.33">                       Services.io.offline;</span>
<a href="#l30.34"></a><span id="l30.34">         if (cmd.hidden)</span>
<a href="#l30.35"></a><span id="l30.35">           return false;</span>
<a href="#l30.36"></a><span id="l30.36"> </span>
<a href="#l30.37"></a><span id="l30.37">         let bucket = document.getElementById(&quot;attachmentBucket&quot;);</span>
<a href="#l30.38"></a><span id="l30.38">         for (let item of bucket.selectedItems) {</span>
<a href="#l30.39"></a><span id="l30.39">           if (item.uploading)</span>
<a href="#l30.40"></a><span id="l30.40">             return false;</span>
<a href="#l30.41"></a><span id="l30.41" class="difflineat">@@ -1436,55 +1436,55 @@ function updateSendCommands(aHaveControl</span>
<a href="#l30.42"></a><span id="l30.42">     goSetCommandEnabled(&quot;cmd_sendWithCheck&quot;, defaultController.isCommandEnabled(&quot;cmd_sendWithCheck&quot;));</span>
<a href="#l30.43"></a><span id="l30.43">   }</span>
<a href="#l30.44"></a><span id="l30.44"> }</span>
<a href="#l30.45"></a><span id="l30.45"> </span>
<a href="#l30.46"></a><span id="l30.46"> function addAttachCloudMenuItems(aParentMenu) {</span>
<a href="#l30.47"></a><span id="l30.47">   while (aParentMenu.hasChildNodes())</span>
<a href="#l30.48"></a><span id="l30.48">     aParentMenu.lastChild.remove();</span>
<a href="#l30.49"></a><span id="l30.49"> </span>
<a href="#l30.50"></a><span id="l30.50" class="difflineminus">-  for (let cloudProvider of cloudFileAccounts.accounts) {</span>
<a href="#l30.51"></a><span id="l30.51" class="difflineplus">+  for (let cloudProvider of cloudFileAccounts.configuredAccounts) {</span>
<a href="#l30.52"></a><span id="l30.52">     let item = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l30.53"></a><span id="l30.53" class="difflineminus">-    let iconClass = cloudProvider.iconClass;</span>
<a href="#l30.54"></a><span id="l30.54" class="difflineplus">+    let iconURL = cloudProvider.iconURL;</span>
<a href="#l30.55"></a><span id="l30.55">     item.cloudProvider = cloudProvider;</span>
<a href="#l30.56"></a><span id="l30.56">     item.setAttribute(&quot;label&quot;, cloudFileAccounts.getDisplayName(cloudProvider));</span>
<a href="#l30.57"></a><span id="l30.57"> </span>
<a href="#l30.58"></a><span id="l30.58" class="difflineminus">-    if (iconClass) {</span>
<a href="#l30.59"></a><span id="l30.59" class="difflineplus">+    if (iconURL) {</span>
<a href="#l30.60"></a><span id="l30.60">       item.setAttribute(&quot;class&quot;, &quot;menu-iconic&quot;);</span>
<a href="#l30.61"></a><span id="l30.61" class="difflineminus">-      item.setAttribute(&quot;image&quot;, iconClass);</span>
<a href="#l30.62"></a><span id="l30.62" class="difflineplus">+      item.setAttribute(&quot;image&quot;, iconURL);</span>
<a href="#l30.63"></a><span id="l30.63">     }</span>
<a href="#l30.64"></a><span id="l30.64">     aParentMenu.appendChild(item);</span>
<a href="#l30.65"></a><span id="l30.65">   }</span>
<a href="#l30.66"></a><span id="l30.66"> }</span>
<a href="#l30.67"></a><span id="l30.67"> </span>
<a href="#l30.68"></a><span id="l30.68"> function addConvertCloudMenuItems(aParentMenu, aAfterNodeId, aRadioGroup) {</span>
<a href="#l30.69"></a><span id="l30.69">   let attachment = document.getElementById(&quot;attachmentBucket&quot;).selectedItem;</span>
<a href="#l30.70"></a><span id="l30.70">   let afterNode = document.getElementById(aAfterNodeId);</span>
<a href="#l30.71"></a><span id="l30.71">   while (afterNode.nextSibling)</span>
<a href="#l30.72"></a><span id="l30.72">     afterNode.nextSibling.remove();</span>
<a href="#l30.73"></a><span id="l30.73"> </span>
<a href="#l30.74"></a><span id="l30.74">   if (!attachment.sendViaCloud) {</span>
<a href="#l30.75"></a><span id="l30.75">     let item = document.getElementById(&quot;convertCloudMenuItems_popup_convertAttachment&quot;);</span>
<a href="#l30.76"></a><span id="l30.76">     item.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l30.77"></a><span id="l30.77">   }</span>
<a href="#l30.78"></a><span id="l30.78"> </span>
<a href="#l30.79"></a><span id="l30.79" class="difflineminus">-  for (let cloudProvider of cloudFileAccounts.accounts) {</span>
<a href="#l30.80"></a><span id="l30.80" class="difflineplus">+  for (let cloudProvider of cloudFileAccounts.configuredAccounts) {</span>
<a href="#l30.81"></a><span id="l30.81">     let item = document.createElement(&quot;menuitem&quot;);</span>
<a href="#l30.82"></a><span id="l30.82" class="difflineminus">-    let iconClass = cloudProvider.iconClass;</span>
<a href="#l30.83"></a><span id="l30.83" class="difflineplus">+    let iconURL = cloudProvider.iconURL;</span>
<a href="#l30.84"></a><span id="l30.84">     item.cloudProvider = cloudProvider;</span>
<a href="#l30.85"></a><span id="l30.85">     item.setAttribute(&quot;label&quot;, cloudFileAccounts.getDisplayName(cloudProvider));</span>
<a href="#l30.86"></a><span id="l30.86">     item.setAttribute(&quot;type&quot;, &quot;radio&quot;);</span>
<a href="#l30.87"></a><span id="l30.87">     item.setAttribute(&quot;name&quot;, aRadioGroup);</span>
<a href="#l30.88"></a><span id="l30.88"> </span>
<a href="#l30.89"></a><span id="l30.89">     if (attachment.cloudProvider &amp;&amp;</span>
<a href="#l30.90"></a><span id="l30.90">         attachment.cloudProvider.accountKey == cloudProvider.accountKey) {</span>
<a href="#l30.91"></a><span id="l30.91">       item.setAttribute(&quot;checked&quot;, &quot;true&quot;);</span>
<a href="#l30.92"></a><span id="l30.92" class="difflineminus">-    } else if (iconClass) {</span>
<a href="#l30.93"></a><span id="l30.93" class="difflineplus">+    } else if (iconURL) {</span>
<a href="#l30.94"></a><span id="l30.94">       item.setAttribute(&quot;class&quot;, &quot;menu-iconic&quot;);</span>
<a href="#l30.95"></a><span id="l30.95" class="difflineminus">-      item.setAttribute(&quot;image&quot;, iconClass);</span>
<a href="#l30.96"></a><span id="l30.96" class="difflineplus">+      item.setAttribute(&quot;image&quot;, iconURL);</span>
<a href="#l30.97"></a><span id="l30.97">     }</span>
<a href="#l30.98"></a><span id="l30.98"> </span>
<a href="#l30.99"></a><span id="l30.99">     aParentMenu.appendChild(item);</span>
<a href="#l30.100"></a><span id="l30.100">   }</span>
<a href="#l30.101"></a><span id="l30.101"> }</span>
<a href="#l30.102"></a><span id="l30.102"> </span>
<a href="#l30.103"></a><span id="l30.103"> function uploadListener(aAttachment, aFile, aCloudProvider) {</span>
<a href="#l30.104"></a><span id="l30.104">   this.attachment = aAttachment;</span>
<a href="#l30.105"></a><span id="l30.105" class="difflineat">@@ -1532,19 +1532,19 @@ uploadListener.prototype = {</span>
<a href="#l30.106"></a><span id="l30.106">           attachmentItem.originalUrl = originalUrl;</span>
<a href="#l30.107"></a><span id="l30.107">         attachmentItem.setAttribute(&quot;tooltiptext&quot;,</span>
<a href="#l30.108"></a><span id="l30.108">           getComposeBundle().getFormattedString(&quot;cloudFileUploadedTooltip&quot;, [</span>
<a href="#l30.109"></a><span id="l30.109">             cloudFileAccounts.getDisplayName(this.cloudProvider),</span>
<a href="#l30.110"></a><span id="l30.110">           ]));</span>
<a href="#l30.111"></a><span id="l30.111">         attachmentItem.uploading = false;</span>
<a href="#l30.112"></a><span id="l30.112"> </span>
<a href="#l30.113"></a><span id="l30.113">         // Set the icon for the attachment.</span>
<a href="#l30.114"></a><span id="l30.114" class="difflineminus">-        let iconClass = this.cloudProvider.iconClass;</span>
<a href="#l30.115"></a><span id="l30.115" class="difflineminus">-        if (iconClass) {</span>
<a href="#l30.116"></a><span id="l30.116" class="difflineminus">-          attachmentItem.image = iconClass;</span>
<a href="#l30.117"></a><span id="l30.117" class="difflineplus">+        let iconURL = this.cloudProvider.iconURL;</span>
<a href="#l30.118"></a><span id="l30.118" class="difflineplus">+        if (iconURL) {</span>
<a href="#l30.119"></a><span id="l30.119" class="difflineplus">+          attachmentItem.image = iconURL;</span>
<a href="#l30.120"></a><span id="l30.120">         } else {</span>
<a href="#l30.121"></a><span id="l30.121">           // Should we use a generic &quot;cloud&quot; icon here? Or an overlay icon?</span>
<a href="#l30.122"></a><span id="l30.122">           // I think the provider should provide an icon, end of story.</span>
<a href="#l30.123"></a><span id="l30.123">           attachmentItem.image = null;</span>
<a href="#l30.124"></a><span id="l30.124">         }</span>
<a href="#l30.125"></a><span id="l30.125">       }</span>
<a href="#l30.126"></a><span id="l30.126"> </span>
<a href="#l30.127"></a><span id="l30.127">       let event = document.createEvent(&quot;Events&quot;);</span>
<a href="#l30.128"></a><span id="l30.128" class="difflineat">@@ -1553,46 +1553,46 @@ uploadListener.prototype = {</span>
<a href="#l30.129"></a><span id="l30.129">         { bubbles: true, cancelable: true }));</span>
<a href="#l30.130"></a><span id="l30.130">     } else {</span>
<a href="#l30.131"></a><span id="l30.131">       let title;</span>
<a href="#l30.132"></a><span id="l30.132">       let msg;</span>
<a href="#l30.133"></a><span id="l30.133">       let displayName = cloudFileAccounts.getDisplayName(this.cloudProvider);</span>
<a href="#l30.134"></a><span id="l30.134">       let bundle = getComposeBundle();</span>
<a href="#l30.135"></a><span id="l30.135">       let displayError = true;</span>
<a href="#l30.136"></a><span id="l30.136">       switch (aStatusCode) {</span>
<a href="#l30.137"></a><span id="l30.137" class="difflineminus">-      case Ci.nsIMsgCloudFileProvider.authErr:</span>
<a href="#l30.138"></a><span id="l30.138" class="difflineplus">+      case cloudFileAccounts.constants.authErr:</span>
<a href="#l30.139"></a><span id="l30.139">         title = bundle.getString(&quot;errorCloudFileAuth.title&quot;);</span>
<a href="#l30.140"></a><span id="l30.140">         msg = bundle.getFormattedString(&quot;errorCloudFileAuth.message&quot;,</span>
<a href="#l30.141"></a><span id="l30.141">                                         [displayName]);</span>
<a href="#l30.142"></a><span id="l30.142">         break;</span>
<a href="#l30.143"></a><span id="l30.143" class="difflineminus">-      case Ci.nsIMsgCloudFileProvider.uploadErr:</span>
<a href="#l30.144"></a><span id="l30.144" class="difflineplus">+      case cloudFileAccounts.constants.uploadErr:</span>
<a href="#l30.145"></a><span id="l30.145">         title = bundle.getString(&quot;errorCloudFileUpload.title&quot;);</span>
<a href="#l30.146"></a><span id="l30.146">         msg = bundle.getFormattedString(&quot;errorCloudFileUpload.message&quot;,</span>
<a href="#l30.147"></a><span id="l30.147">                                         [displayName,</span>
<a href="#l30.148"></a><span id="l30.148">                                          this.attachment.name]);</span>
<a href="#l30.149"></a><span id="l30.149">         break;</span>
<a href="#l30.150"></a><span id="l30.150" class="difflineminus">-      case Ci.nsIMsgCloudFileProvider.uploadWouldExceedQuota:</span>
<a href="#l30.151"></a><span id="l30.151" class="difflineplus">+      case cloudFileAccounts.constants.uploadWouldExceedQuota:</span>
<a href="#l30.152"></a><span id="l30.152">         title = bundle.getString(&quot;errorCloudFileQuota.title&quot;);</span>
<a href="#l30.153"></a><span id="l30.153">         msg = bundle.getFormattedString(&quot;errorCloudFileQuota.message&quot;,</span>
<a href="#l30.154"></a><span id="l30.154">                                         [displayName,</span>
<a href="#l30.155"></a><span id="l30.155">                                          this.attachment.name]);</span>
<a href="#l30.156"></a><span id="l30.156">         break;</span>
<a href="#l30.157"></a><span id="l30.157" class="difflineminus">-      case Ci.nsIMsgCloudFileProvider.uploadExceedsFileNameLimit:</span>
<a href="#l30.158"></a><span id="l30.158" class="difflineplus">+      case cloudFileAccounts.constants.uploadExceedsFileNameLimit:</span>
<a href="#l30.159"></a><span id="l30.159">         title = bundle.getString(&quot;errorCloudFileNameLimit.title&quot;);</span>
<a href="#l30.160"></a><span id="l30.160">         msg = bundle.getFormattedString(&quot;errorCloudFileNameLimit.message&quot;,</span>
<a href="#l30.161"></a><span id="l30.161">                                         [displayName,</span>
<a href="#l30.162"></a><span id="l30.162">                                          this.attachment.name]);</span>
<a href="#l30.163"></a><span id="l30.163">         break;</span>
<a href="#l30.164"></a><span id="l30.164" class="difflineminus">-      case Ci.nsIMsgCloudFileProvider.uploadExceedsFileLimit:</span>
<a href="#l30.165"></a><span id="l30.165" class="difflineplus">+      case cloudFileAccounts.constants.uploadExceedsFileLimit:</span>
<a href="#l30.166"></a><span id="l30.166">         title = bundle.getString(&quot;errorCloudFileLimit.title&quot;);</span>
<a href="#l30.167"></a><span id="l30.167">         msg = bundle.getFormattedString(&quot;errorCloudFileLimit.message&quot;,</span>
<a href="#l30.168"></a><span id="l30.168">                                         [displayName,</span>
<a href="#l30.169"></a><span id="l30.169">                                          this.attachment.name]);</span>
<a href="#l30.170"></a><span id="l30.170">         break;</span>
<a href="#l30.171"></a><span id="l30.171" class="difflineminus">-      case Ci.nsIMsgCloudFileProvider.uploadCanceled:</span>
<a href="#l30.172"></a><span id="l30.172" class="difflineplus">+      case cloudFileAccounts.constants.uploadCancelled:</span>
<a href="#l30.173"></a><span id="l30.173">         displayError = false;</span>
<a href="#l30.174"></a><span id="l30.174">         break;</span>
<a href="#l30.175"></a><span id="l30.175">       default:</span>
<a href="#l30.176"></a><span id="l30.176">         title = bundle.getString(&quot;errorCloudFileOther.title&quot;);</span>
<a href="#l30.177"></a><span id="l30.177">         msg = bundle.getFormattedString(&quot;errorCloudFileOther.message&quot;,</span>
<a href="#l30.178"></a><span id="l30.178">                                         [displayName]);</span>
<a href="#l30.179"></a><span id="l30.179">         break;</span>
<a href="#l30.180"></a><span id="l30.180">       }</span>
<a href="#l30.181"></a><span id="l30.181" class="difflineat">@@ -4327,17 +4327,17 @@ function AddAttachments(aAttachments, aC</span>
<a href="#l30.182"></a><span id="l30.182">       item.setAttribute(&quot;tooltiptext&quot;, attachment.url);</span>
<a href="#l30.183"></a><span id="l30.183">     }</span>
<a href="#l30.184"></a><span id="l30.184">     item.addEventListener(&quot;command&quot;, OpenSelectedAttachment);</span>
<a href="#l30.185"></a><span id="l30.185"> </span>
<a href="#l30.186"></a><span id="l30.186">     if (attachment.sendViaCloud) {</span>
<a href="#l30.187"></a><span id="l30.187">       try {</span>
<a href="#l30.188"></a><span id="l30.188">         let cloudProvider = cloudFileAccounts.getAccount(attachment.cloudProviderKey);</span>
<a href="#l30.189"></a><span id="l30.189">         item.cloudProvider = cloudProvider;</span>
<a href="#l30.190"></a><span id="l30.190" class="difflineminus">-        item.image = cloudProvider.iconClass;</span>
<a href="#l30.191"></a><span id="l30.191" class="difflineplus">+        item.image = cloudProvider.iconURL;</span>
<a href="#l30.192"></a><span id="l30.192">         item.originalUrl = attachment.url;</span>
<a href="#l30.193"></a><span id="l30.193">       } catch (ex) {</span>
<a href="#l30.194"></a><span id="l30.194">         dump(ex);</span>
<a href="#l30.195"></a><span id="l30.195">       }</span>
<a href="#l30.196"></a><span id="l30.196">     } else {</span>
<a href="#l30.197"></a><span id="l30.197">       // For local file urls, we are better off using the full file url because</span>
<a href="#l30.198"></a><span id="l30.198">       // moz-icon will actually resolve the file url and get the right icon from</span>
<a href="#l30.199"></a><span id="l30.199">       // the file url. All other urls, we should try to extract the file name from</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mail/components/compose/content/bigFileObserver.js</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mail/components/compose/content/bigFileObserver.js</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -177,34 +177,31 @@ var gBigFileObserver = {</span>
<a href="#l31.4"></a><span id="l31.4">   openLearnMore() {</span>
<a href="#l31.5"></a><span id="l31.5">     let url = Services.prefs.getCharPref(&quot;mail.cloud_files.learn_more_url&quot;);</span>
<a href="#l31.6"></a><span id="l31.6">     openContentTab(url);</span>
<a href="#l31.7"></a><span id="l31.7">     return true;</span>
<a href="#l31.8"></a><span id="l31.8">   },</span>
<a href="#l31.9"></a><span id="l31.9"> </span>
<a href="#l31.10"></a><span id="l31.10">   convertAttachments() {</span>
<a href="#l31.11"></a><span id="l31.11">     let cloudProvider;</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineminus">-    let accounts = cloudFileAccounts.accounts;</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+    let accounts = cloudFileAccounts.configuredAccounts;</span>
<a href="#l31.14"></a><span id="l31.14"> </span>
<a href="#l31.15"></a><span id="l31.15">     if (accounts.length == 1) {</span>
<a href="#l31.16"></a><span id="l31.16">       cloudProvider = accounts[0];</span>
<a href="#l31.17"></a><span id="l31.17">     } else if (accounts.length &gt; 1) {</span>
<a href="#l31.18"></a><span id="l31.18">       let selection = {};</span>
<a href="#l31.19"></a><span id="l31.19">       let names = accounts.map(i =&gt; cloudFileAccounts.getDisplayName(i));</span>
<a href="#l31.20"></a><span id="l31.20">       if (Services.prompt.select(window,</span>
<a href="#l31.21"></a><span id="l31.21">                                  this.formatString(&quot;bigFileChooseAccount.title&quot;),</span>
<a href="#l31.22"></a><span id="l31.22">                                  this.formatString(&quot;bigFileChooseAccount.text&quot;),</span>
<a href="#l31.23"></a><span id="l31.23">                                  names.length, names, selection))</span>
<a href="#l31.24"></a><span id="l31.24">         cloudProvider = accounts[selection.value];</span>
<a href="#l31.25"></a><span id="l31.25">     } else {</span>
<a href="#l31.26"></a><span id="l31.26" class="difflineminus">-      let accountKey = cloudFileAccounts.addAccountDialog();</span>
<a href="#l31.27"></a><span id="l31.27" class="difflineminus">-      if (accountKey)</span>
<a href="#l31.28"></a><span id="l31.28" class="difflineminus">-        cloudProvider = cloudFileAccounts.getAccount(accountKey);</span>
<a href="#l31.29"></a><span id="l31.29" class="difflineminus">-      else</span>
<a href="#l31.30"></a><span id="l31.30" class="difflineminus">-        return true;</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+      openPreferencesTab(&quot;paneApplications&quot;, &quot;attachmentsOutTab&quot;);</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+      return true;</span>
<a href="#l31.33"></a><span id="l31.33">     }</span>
<a href="#l31.34"></a><span id="l31.34"> </span>
<a href="#l31.35"></a><span id="l31.35">     if (cloudProvider)</span>
<a href="#l31.36"></a><span id="l31.36">       convertToCloudAttachment(this.bigFiles, cloudProvider);</span>
<a href="#l31.37"></a><span id="l31.37"> </span>
<a href="#l31.38"></a><span id="l31.38">     return false;</span>
<a href="#l31.39"></a><span id="l31.39">   },</span>
<a href="#l31.40"></a><span id="l31.40"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mail/components/compose/content/cloudAttachmentLinkManager.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mail/components/compose/content/cloudAttachmentLinkManager.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -391,28 +391,28 @@ var gCloudAttachmentLinkManager = {</span>
<a href="#l32.4"></a><span id="l32.4">       size.style.marginLeft = &quot;5px&quot;;</span>
<a href="#l32.5"></a><span id="l32.5">       size.style.fontSize = &quot;small&quot;;</span>
<a href="#l32.6"></a><span id="l32.6">       size.style.color = &quot;grey&quot;;</span>
<a href="#l32.7"></a><span id="l32.7">       node.appendChild(size);</span>
<a href="#l32.8"></a><span id="l32.8"> </span>
<a href="#l32.9"></a><span id="l32.9">       let providerIdentity = aDocument.createElement(&quot;span&quot;);</span>
<a href="#l32.10"></a><span id="l32.10">       providerIdentity.style.cssFloat = &quot;right&quot;;</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-      if (aProvider.iconClass) {</span>
<a href="#l32.13"></a><span id="l32.13" class="difflineplus">+      if (aProvider.iconURL) {</span>
<a href="#l32.14"></a><span id="l32.14">         let providerIcon = aDocument.createElement(&quot;img&quot;);</span>
<a href="#l32.15"></a><span id="l32.15">         providerIcon.style.marginRight = &quot;5px&quot;;</span>
<a href="#l32.16"></a><span id="l32.16">         providerIdentity.appendChild(providerIcon);</span>
<a href="#l32.17"></a><span id="l32.17"> </span>
<a href="#l32.18"></a><span id="l32.18" class="difflineminus">-        if (!/^chrome:\/\//i.test(aProvider.iconClass)) {</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineminus">-          providerIcon.src = aProvider.iconClass;</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineplus">+        if (!/^chrome:\/\//i.test(aProvider.iconURL)) {</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineplus">+          providerIcon.src = aProvider.iconURL;</span>
<a href="#l32.22"></a><span id="l32.22">         } else {</span>
<a href="#l32.23"></a><span id="l32.23">           try {</span>
<a href="#l32.24"></a><span id="l32.24">             // Let's use the goodness from MsgComposeCommands.js since we're</span>
<a href="#l32.25"></a><span id="l32.25">             // sitting right in a compose window.</span>
<a href="#l32.26"></a><span id="l32.26" class="difflineminus">-            providerIcon.src = window.loadBlockedImage(aProvider.iconClass, true);</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineplus">+            providerIcon.src = window.loadBlockedImage(aProvider.iconURL, true);</span>
<a href="#l32.28"></a><span id="l32.28">           } catch (e) {</span>
<a href="#l32.29"></a><span id="l32.29">             // Couldn't load the referenced image.</span>
<a href="#l32.30"></a><span id="l32.30">             Cu.reportError(e);</span>
<a href="#l32.31"></a><span id="l32.31">           }</span>
<a href="#l32.32"></a><span id="l32.32">         }</span>
<a href="#l32.33"></a><span id="l32.33">       }</span>
<a href="#l32.34"></a><span id="l32.34"> </span>
<a href="#l32.35"></a><span id="l32.35">       if (aProvider.serviceURL) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mail/components/extensions/parent/ext-cloudFile.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mail/components/extensions/parent/ext-cloudFile.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -19,23 +19,21 @@ async function promiseFileRead(nsifile) </span>
<a href="#l33.4"></a><span id="l33.4">       resolve(reader.result);</span>
<a href="#l33.5"></a><span id="l33.5">     });</span>
<a href="#l33.6"></a><span id="l33.6">     reader.addEventListener(&quot;onerror&quot;, reject);</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8">     reader.readAsArrayBuffer(blob);</span>
<a href="#l33.9"></a><span id="l33.9">   });</span>
<a href="#l33.10"></a><span id="l33.10"> }</span>
<a href="#l33.11"></a><span id="l33.11"> </span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-class CloudFileProvider extends EventEmitter {</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineminus">-  constructor(extension) {</span>
<a href="#l33.14"></a><span id="l33.14" class="difflineminus">-    super();</span>
<a href="#l33.15"></a><span id="l33.15" class="difflineminus">-</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineplus">+class CloudFileAccount {</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+  constructor(accountKey, extension) {</span>
<a href="#l33.18"></a><span id="l33.18" class="difflineplus">+    this.accountKey = accountKey;</span>
<a href="#l33.19"></a><span id="l33.19">     this.extension = extension;</span>
<a href="#l33.20"></a><span id="l33.20" class="difflineminus">-    this.configured = false;</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineminus">-    this.accountKey = false;</span>
<a href="#l33.22"></a><span id="l33.22" class="difflineplus">+    this._configured = false;</span>
<a href="#l33.23"></a><span id="l33.23">     this.lastError = &quot;&quot;;</span>
<a href="#l33.24"></a><span id="l33.24">     this.settingsURL = this.extension.manifest.cloud_file.settings_url;</span>
<a href="#l33.25"></a><span id="l33.25">     this.managementURL = this.extension.manifest.cloud_file.management_url;</span>
<a href="#l33.26"></a><span id="l33.26">     this.quota = {</span>
<a href="#l33.27"></a><span id="l33.27">       uploadSizeLimit: -1,</span>
<a href="#l33.28"></a><span id="l33.28">       spaceRemaining: -1,</span>
<a href="#l33.29"></a><span id="l33.29">       spaceUsed: -1,</span>
<a href="#l33.30"></a><span id="l33.30">     };</span>
<a href="#l33.31"></a><span id="l33.31" class="difflineat">@@ -44,22 +42,25 @@ class CloudFileProvider extends EventEmi</span>
<a href="#l33.32"></a><span id="l33.32">     this._fileUrls = new Map();</span>
<a href="#l33.33"></a><span id="l33.33">     this._fileIds = new Map();</span>
<a href="#l33.34"></a><span id="l33.34">   }</span>
<a href="#l33.35"></a><span id="l33.35"> </span>
<a href="#l33.36"></a><span id="l33.36">   get type() {</span>
<a href="#l33.37"></a><span id="l33.37">     return `ext-${this.extension.id}`;</span>
<a href="#l33.38"></a><span id="l33.38">   }</span>
<a href="#l33.39"></a><span id="l33.39">   get displayName() {</span>
<a href="#l33.40"></a><span id="l33.40" class="difflineminus">-    return this.extension.manifest.cloud_file.name;</span>
<a href="#l33.41"></a><span id="l33.41" class="difflineplus">+    return Services.prefs.getCharPref(</span>
<a href="#l33.42"></a><span id="l33.42" class="difflineplus">+      `mail.cloud_files.accounts.${this.accountKey}.displayName`,</span>
<a href="#l33.43"></a><span id="l33.43" class="difflineplus">+      this.extension.manifest.cloud_file.name</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineplus">+    );</span>
<a href="#l33.45"></a><span id="l33.45">   }</span>
<a href="#l33.46"></a><span id="l33.46">   get serviceURL() {</span>
<a href="#l33.47"></a><span id="l33.47">     return this.extension.manifest.cloud_file.service_url;</span>
<a href="#l33.48"></a><span id="l33.48">   }</span>
<a href="#l33.49"></a><span id="l33.49" class="difflineminus">-  get iconClass() {</span>
<a href="#l33.50"></a><span id="l33.50" class="difflineplus">+  get iconURL() {</span>
<a href="#l33.51"></a><span id="l33.51">     if (this.extension.manifest.icons) {</span>
<a href="#l33.52"></a><span id="l33.52">       let { icon } = ExtensionParent.IconDetails.getPreferredIcon(</span>
<a href="#l33.53"></a><span id="l33.53">         this.extension.manifest.icons, this.extension, 32</span>
<a href="#l33.54"></a><span id="l33.54">       );</span>
<a href="#l33.55"></a><span id="l33.55">       return this.extension.getURL(icon);</span>
<a href="#l33.56"></a><span id="l33.56">     }</span>
<a href="#l33.57"></a><span id="l33.57">     return &quot;chrome://messenger/content/extension.svg&quot;;</span>
<a href="#l33.58"></a><span id="l33.58">   }</span>
<a href="#l33.59"></a><span id="l33.59" class="difflineat">@@ -67,90 +68,93 @@ class CloudFileProvider extends EventEmi</span>
<a href="#l33.60"></a><span id="l33.60">     return this.quota.uploadSizeLimit;</span>
<a href="#l33.61"></a><span id="l33.61">   }</span>
<a href="#l33.62"></a><span id="l33.62">   get remainingFileSpace() {</span>
<a href="#l33.63"></a><span id="l33.63">     return this.quota.spaceRemaining;</span>
<a href="#l33.64"></a><span id="l33.64">   }</span>
<a href="#l33.65"></a><span id="l33.65">   get fileSpaceUsed() {</span>
<a href="#l33.66"></a><span id="l33.66">     return this.quota.spaceUsed;</span>
<a href="#l33.67"></a><span id="l33.67">   }</span>
<a href="#l33.68"></a><span id="l33.68" class="difflineplus">+  get configured() {</span>
<a href="#l33.69"></a><span id="l33.69" class="difflineplus">+    return this._configured;</span>
<a href="#l33.70"></a><span id="l33.70" class="difflineplus">+  }</span>
<a href="#l33.71"></a><span id="l33.71" class="difflineplus">+  set configured(value) {</span>
<a href="#l33.72"></a><span id="l33.72" class="difflineplus">+    value = !!value;</span>
<a href="#l33.73"></a><span id="l33.73" class="difflineplus">+    if (value != this._configured) {</span>
<a href="#l33.74"></a><span id="l33.74" class="difflineplus">+      this._configured = value;</span>
<a href="#l33.75"></a><span id="l33.75" class="difflineplus">+      cloudFileAccounts.emit(&quot;accountConfigured&quot;, this);</span>
<a href="#l33.76"></a><span id="l33.76" class="difflineplus">+    }</span>
<a href="#l33.77"></a><span id="l33.77" class="difflineplus">+  }</span>
<a href="#l33.78"></a><span id="l33.78">   get createNewAccountUrl() {</span>
<a href="#l33.79"></a><span id="l33.79">     return this.extension.manifest.cloud_file.new_account_url;</span>
<a href="#l33.80"></a><span id="l33.80">   }</span>
<a href="#l33.81"></a><span id="l33.81"> </span>
<a href="#l33.82"></a><span id="l33.82" class="difflineminus">-  init(accountKey) {</span>
<a href="#l33.83"></a><span id="l33.83" class="difflineminus">-    this.accountKey = accountKey;</span>
<a href="#l33.84"></a><span id="l33.84" class="difflineminus">-    Services.prefs.setCharPref(</span>
<a href="#l33.85"></a><span id="l33.85" class="difflineminus">-      `mail.cloud_files.accounts.${accountKey}.displayName`, this.displayName</span>
<a href="#l33.86"></a><span id="l33.86" class="difflineminus">-    );</span>
<a href="#l33.87"></a><span id="l33.87" class="difflineminus">-  }</span>
<a href="#l33.88"></a><span id="l33.88" class="difflineminus">-</span>
<a href="#l33.89"></a><span id="l33.89">   async uploadFile(file, callback) {</span>
<a href="#l33.90"></a><span id="l33.90">     let id = this._nextId++;</span>
<a href="#l33.91"></a><span id="l33.91">     let results;</span>
<a href="#l33.92"></a><span id="l33.92"> </span>
<a href="#l33.93"></a><span id="l33.93">     try {</span>
<a href="#l33.94"></a><span id="l33.94">       let buffer = await promiseFileRead(file);</span>
<a href="#l33.95"></a><span id="l33.95"> </span>
<a href="#l33.96"></a><span id="l33.96">       this._fileIds.set(file.path, id);</span>
<a href="#l33.97"></a><span id="l33.97" class="difflineminus">-      results = await this.emit(&quot;uploadFile&quot;, {</span>
<a href="#l33.98"></a><span id="l33.98" class="difflineplus">+      results = await this.extension.emit(&quot;uploadFile&quot;, this, {</span>
<a href="#l33.99"></a><span id="l33.99">         id,</span>
<a href="#l33.100"></a><span id="l33.100">         name: file.leafName,</span>
<a href="#l33.101"></a><span id="l33.101">         data: buffer,</span>
<a href="#l33.102"></a><span id="l33.102">       });</span>
<a href="#l33.103"></a><span id="l33.103">     } catch (ex) {</span>
<a href="#l33.104"></a><span id="l33.104">       if (ex.result == 0x80530014) { // NS_ERROR_DOM_ABORT_ERR</span>
<a href="#l33.105"></a><span id="l33.105" class="difflineminus">-        callback.onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.uploadCanceled);</span>
<a href="#l33.106"></a><span id="l33.106" class="difflineplus">+        callback.onStopRequest(null, null, cloudFileAccounts.constants.uploadCancelled);</span>
<a href="#l33.107"></a><span id="l33.107">       } else {</span>
<a href="#l33.108"></a><span id="l33.108">         console.error(ex);</span>
<a href="#l33.109"></a><span id="l33.109" class="difflineminus">-        callback.onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l33.110"></a><span id="l33.110" class="difflineplus">+        callback.onStopRequest(null, null, cloudFileAccounts.constants.uploadErr);</span>
<a href="#l33.111"></a><span id="l33.111">       }</span>
<a href="#l33.112"></a><span id="l33.112">       return;</span>
<a href="#l33.113"></a><span id="l33.113">     }</span>
<a href="#l33.114"></a><span id="l33.114"> </span>
<a href="#l33.115"></a><span id="l33.115">     if (results &amp;&amp; results.length &gt; 0) {</span>
<a href="#l33.116"></a><span id="l33.116">       if (results[0].aborted) {</span>
<a href="#l33.117"></a><span id="l33.117" class="difflineminus">-        callback.onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.uploadCanceled);</span>
<a href="#l33.118"></a><span id="l33.118" class="difflineplus">+        callback.onStopRequest(null, null, cloudFileAccounts.constants.uploadCancelled);</span>
<a href="#l33.119"></a><span id="l33.119">         return;</span>
<a href="#l33.120"></a><span id="l33.120">       }</span>
<a href="#l33.121"></a><span id="l33.121"> </span>
<a href="#l33.122"></a><span id="l33.122">       let url = results[0].url;</span>
<a href="#l33.123"></a><span id="l33.123">       this._fileUrls.set(file.path, url);</span>
<a href="#l33.124"></a><span id="l33.124">       callback.onStopRequest(null, null, Cr.NS_OK);</span>
<a href="#l33.125"></a><span id="l33.125">     } else {</span>
<a href="#l33.126"></a><span id="l33.126" class="difflineminus">-      callback.onStopRequest(null, null, Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l33.127"></a><span id="l33.127" class="difflineplus">+      callback.onStopRequest(null, null, cloudFileAccounts.constants.uploadErr);</span>
<a href="#l33.128"></a><span id="l33.128">       throw new ExtensionUtils.ExtensionError(</span>
<a href="#l33.129"></a><span id="l33.129">         `Missing cloudFile.onFileUpload listener for ${this.extension.id}`</span>
<a href="#l33.130"></a><span id="l33.130">       );</span>
<a href="#l33.131"></a><span id="l33.131">     }</span>
<a href="#l33.132"></a><span id="l33.132">   }</span>
<a href="#l33.133"></a><span id="l33.133"> </span>
<a href="#l33.134"></a><span id="l33.134">   urlForFile(file) {</span>
<a href="#l33.135"></a><span id="l33.135">     return this._fileUrls.get(file.path);</span>
<a href="#l33.136"></a><span id="l33.136">   }</span>
<a href="#l33.137"></a><span id="l33.137"> </span>
<a href="#l33.138"></a><span id="l33.138">   cancelFileUpload(file) {</span>
<a href="#l33.139"></a><span id="l33.139" class="difflineminus">-    this.emit(&quot;uploadAbort&quot;, {</span>
<a href="#l33.140"></a><span id="l33.140" class="difflineplus">+    this.extension.emit(&quot;uploadAbort&quot;, this, {</span>
<a href="#l33.141"></a><span id="l33.141">       id: this._fileIds.get(file.path),</span>
<a href="#l33.142"></a><span id="l33.142">     });</span>
<a href="#l33.143"></a><span id="l33.143">   }</span>
<a href="#l33.144"></a><span id="l33.144"> </span>
<a href="#l33.145"></a><span id="l33.145">   refreshUserInfo(withUI, callback) {</span>
<a href="#l33.146"></a><span id="l33.146">     if (Services.io.offline) {</span>
<a href="#l33.147"></a><span id="l33.147" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l33.148"></a><span id="l33.148" class="difflineplus">+      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l33.149"></a><span id="l33.149">     }</span>
<a href="#l33.150"></a><span id="l33.150">     callback.onStopRequest(null, null, Cr.NS_OK);</span>
<a href="#l33.151"></a><span id="l33.151">   }</span>
<a href="#l33.152"></a><span id="l33.152"> </span>
<a href="#l33.153"></a><span id="l33.153">   async deleteFile(file, callback) {</span>
<a href="#l33.154"></a><span id="l33.154">     let results;</span>
<a href="#l33.155"></a><span id="l33.155">     try {</span>
<a href="#l33.156"></a><span id="l33.156">       if (this._fileIds.has(file.path)) {</span>
<a href="#l33.157"></a><span id="l33.157">         let id = this._fileIds.get(file.path);</span>
<a href="#l33.158"></a><span id="l33.158" class="difflineminus">-        results = await this.emit(&quot;deleteFile&quot;, { id });</span>
<a href="#l33.159"></a><span id="l33.159" class="difflineplus">+        results = await this.extension.emit(&quot;deleteFile&quot;, this, { id });</span>
<a href="#l33.160"></a><span id="l33.160">       }</span>
<a href="#l33.161"></a><span id="l33.161">     } catch (ex) {</span>
<a href="#l33.162"></a><span id="l33.162">       callback.onStopRequest(null, null, Cr.NS_ERROR_FAILURE);</span>
<a href="#l33.163"></a><span id="l33.163">     }</span>
<a href="#l33.164"></a><span id="l33.164"> </span>
<a href="#l33.165"></a><span id="l33.165">     if (results &amp;&amp; results.length &gt; 0) {</span>
<a href="#l33.166"></a><span id="l33.166">       callback.onStopRequest(null, null, Cr.NS_OK);</span>
<a href="#l33.167"></a><span id="l33.167">     } else {</span>
<a href="#l33.168"></a><span id="l33.168" class="difflineat">@@ -162,124 +166,132 @@ class CloudFileProvider extends EventEmi</span>
<a href="#l33.169"></a><span id="l33.169">   }</span>
<a href="#l33.170"></a><span id="l33.170"> </span>
<a href="#l33.171"></a><span id="l33.171">   createNewAccount(...args) {</span>
<a href="#l33.172"></a><span id="l33.172">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l33.173"></a><span id="l33.173">   }</span>
<a href="#l33.174"></a><span id="l33.174"> </span>
<a href="#l33.175"></a><span id="l33.175">   createExistingAccount(callback) {</span>
<a href="#l33.176"></a><span id="l33.176">     if (Services.io.offline) {</span>
<a href="#l33.177"></a><span id="l33.177" class="difflineminus">-      throw Ci.nsIMsgCloudFileProvider.offlineErr;</span>
<a href="#l33.178"></a><span id="l33.178" class="difflineplus">+      throw cloudFileAccounts.constants.offlineErr;</span>
<a href="#l33.179"></a><span id="l33.179">     }</span>
<a href="#l33.180"></a><span id="l33.180">     // We're assuming everything is ok here. Maybe expose this in the future if there is a need</span>
<a href="#l33.181"></a><span id="l33.181">     callback.onStopRequest(null, this, Cr.NS_OK);</span>
<a href="#l33.182"></a><span id="l33.182">   }</span>
<a href="#l33.183"></a><span id="l33.183"> </span>
<a href="#l33.184"></a><span id="l33.184">   providerUrlForError(error) {</span>
<a href="#l33.185"></a><span id="l33.185">     return &quot;&quot;;</span>
<a href="#l33.186"></a><span id="l33.186">   }</span>
<a href="#l33.187"></a><span id="l33.187"> </span>
<a href="#l33.188"></a><span id="l33.188">   overrideUrls(count, urls) {</span>
<a href="#l33.189"></a><span id="l33.189">   }</span>
<a href="#l33.190"></a><span id="l33.190" class="difflineminus">-</span>
<a href="#l33.191"></a><span id="l33.191" class="difflineminus">-  register() {</span>
<a href="#l33.192"></a><span id="l33.192" class="difflineminus">-    cloudFileAccounts.registerProvider(this);</span>
<a href="#l33.193"></a><span id="l33.193" class="difflineminus">-  }</span>
<a href="#l33.194"></a><span id="l33.194" class="difflineminus">-</span>
<a href="#l33.195"></a><span id="l33.195" class="difflineminus">-  unregister() {</span>
<a href="#l33.196"></a><span id="l33.196" class="difflineminus">-    cloudFileAccounts.unregisterProvider(this.type);</span>
<a href="#l33.197"></a><span id="l33.197" class="difflineminus">-  }</span>
<a href="#l33.198"></a><span id="l33.198"> }</span>
<a href="#l33.199"></a><span id="l33.199" class="difflineminus">-CloudFileProvider.prototype.QueryInterface = ChromeUtils.generateQI([Ci.nsIMsgCloudFileProvider]);</span>
<a href="#l33.200"></a><span id="l33.200"> </span>
<a href="#l33.201"></a><span id="l33.201"> function convertCloudFileAccount(nativeAccount) {</span>
<a href="#l33.202"></a><span id="l33.202">   return {</span>
<a href="#l33.203"></a><span id="l33.203">     id: nativeAccount.accountKey,</span>
<a href="#l33.204"></a><span id="l33.204">     name: nativeAccount.displayName,</span>
<a href="#l33.205"></a><span id="l33.205">     configured: nativeAccount.configured,</span>
<a href="#l33.206"></a><span id="l33.206">     uploadSizeLimit: nativeAccount.fileUploadSizeLimit,</span>
<a href="#l33.207"></a><span id="l33.207">     spaceRemaining: nativeAccount.remainingFileSpace,</span>
<a href="#l33.208"></a><span id="l33.208">     spaceUsed: nativeAccount.fileSpaceUsed,</span>
<a href="#l33.209"></a><span id="l33.209">     managementUrl: nativeAccount.managementURL,</span>
<a href="#l33.210"></a><span id="l33.210">     settingsUrl: nativeAccount.settingsURL,</span>
<a href="#l33.211"></a><span id="l33.211">   };</span>
<a href="#l33.212"></a><span id="l33.212"> }</span>
<a href="#l33.213"></a><span id="l33.213"> </span>
<a href="#l33.214"></a><span id="l33.214"> this.cloudFile = class extends ExtensionAPI {</span>
<a href="#l33.215"></a><span id="l33.215" class="difflineplus">+  get providerType() {</span>
<a href="#l33.216"></a><span id="l33.216" class="difflineplus">+    return `ext-${this.extension.id}`;</span>
<a href="#l33.217"></a><span id="l33.217" class="difflineplus">+  }</span>
<a href="#l33.218"></a><span id="l33.218" class="difflineplus">+</span>
<a href="#l33.219"></a><span id="l33.219">   onManifestEntry(entryName) {</span>
<a href="#l33.220"></a><span id="l33.220" class="difflineminus">-    if (entryName == &quot;cloud_file&quot; &amp;&amp; !this.provider) {</span>
<a href="#l33.221"></a><span id="l33.221" class="difflineminus">-      this.provider = new CloudFileProvider(this.extension);</span>
<a href="#l33.222"></a><span id="l33.222" class="difflineminus">-      this.provider.register();</span>
<a href="#l33.223"></a><span id="l33.223" class="difflineplus">+    if (entryName == &quot;cloud_file&quot;) {</span>
<a href="#l33.224"></a><span id="l33.224" class="difflineplus">+      let {extension} = this;</span>
<a href="#l33.225"></a><span id="l33.225" class="difflineplus">+      cloudFileAccounts.registerProvider(this.providerType, {</span>
<a href="#l33.226"></a><span id="l33.226" class="difflineplus">+        type: this.providerType,</span>
<a href="#l33.227"></a><span id="l33.227" class="difflineplus">+        displayName: extension.manifest.cloud_file.name,</span>
<a href="#l33.228"></a><span id="l33.228" class="difflineplus">+        get iconURL() {</span>
<a href="#l33.229"></a><span id="l33.229" class="difflineplus">+          if (extension.manifest.icons) {</span>
<a href="#l33.230"></a><span id="l33.230" class="difflineplus">+            let { icon } = ExtensionParent.IconDetails.getPreferredIcon(</span>
<a href="#l33.231"></a><span id="l33.231" class="difflineplus">+              extension.manifest.icons, extension, 32</span>
<a href="#l33.232"></a><span id="l33.232" class="difflineplus">+            );</span>
<a href="#l33.233"></a><span id="l33.233" class="difflineplus">+            return extension.getURL(icon);</span>
<a href="#l33.234"></a><span id="l33.234" class="difflineplus">+          }</span>
<a href="#l33.235"></a><span id="l33.235" class="difflineplus">+          return &quot;chrome://messenger/content/extension.svg&quot;;</span>
<a href="#l33.236"></a><span id="l33.236" class="difflineplus">+        },</span>
<a href="#l33.237"></a><span id="l33.237" class="difflineplus">+        initAccount(accountKey) {</span>
<a href="#l33.238"></a><span id="l33.238" class="difflineplus">+          return new CloudFileAccount(accountKey, extension);</span>
<a href="#l33.239"></a><span id="l33.239" class="difflineplus">+        },</span>
<a href="#l33.240"></a><span id="l33.240" class="difflineplus">+      });</span>
<a href="#l33.241"></a><span id="l33.241">     }</span>
<a href="#l33.242"></a><span id="l33.242">   }</span>
<a href="#l33.243"></a><span id="l33.243"> </span>
<a href="#l33.244"></a><span id="l33.244">   onShutdown() {</span>
<a href="#l33.245"></a><span id="l33.245" class="difflineminus">-    if (this.provider) {</span>
<a href="#l33.246"></a><span id="l33.246" class="difflineminus">-      this.provider.unregister();</span>
<a href="#l33.247"></a><span id="l33.247" class="difflineminus">-    }</span>
<a href="#l33.248"></a><span id="l33.248" class="difflineplus">+    cloudFileAccounts.unregisterProvider(this.providerType);</span>
<a href="#l33.249"></a><span id="l33.249">   }</span>
<a href="#l33.250"></a><span id="l33.250"> </span>
<a href="#l33.251"></a><span id="l33.251">   getAPI(context) {</span>
<a href="#l33.252"></a><span id="l33.252">     let self = this;</span>
<a href="#l33.253"></a><span id="l33.253">     return {</span>
<a href="#l33.254"></a><span id="l33.254">       cloudFile: {</span>
<a href="#l33.255"></a><span id="l33.255">         onFileUpload: new EventManager({</span>
<a href="#l33.256"></a><span id="l33.256">           context,</span>
<a href="#l33.257"></a><span id="l33.257">           name: &quot;cloudFile.onFileUpload&quot;,</span>
<a href="#l33.258"></a><span id="l33.258">           register: fire =&gt; {</span>
<a href="#l33.259"></a><span id="l33.259" class="difflineminus">-            let listener = (event, { id, name, data }) =&gt; {</span>
<a href="#l33.260"></a><span id="l33.260" class="difflineminus">-              let account = convertCloudFileAccount(self.provider);</span>
<a href="#l33.261"></a><span id="l33.261" class="difflineplus">+            let listener = (event, account, { id, name, data }) =&gt; {</span>
<a href="#l33.262"></a><span id="l33.262" class="difflineplus">+              account = convertCloudFileAccount(account);</span>
<a href="#l33.263"></a><span id="l33.263">               return fire.async(account, { id, name, data });</span>
<a href="#l33.264"></a><span id="l33.264">             };</span>
<a href="#l33.265"></a><span id="l33.265"> </span>
<a href="#l33.266"></a><span id="l33.266" class="difflineminus">-            self.provider.on(&quot;uploadFile&quot;, listener);</span>
<a href="#l33.267"></a><span id="l33.267" class="difflineplus">+            context.extension.on(&quot;uploadFile&quot;, listener);</span>
<a href="#l33.268"></a><span id="l33.268">             return () =&gt; {</span>
<a href="#l33.269"></a><span id="l33.269" class="difflineminus">-              self.provider.off(&quot;uploadFile&quot;, listener);</span>
<a href="#l33.270"></a><span id="l33.270" class="difflineplus">+              context.extension.off(&quot;uploadFile&quot;, listener);</span>
<a href="#l33.271"></a><span id="l33.271">             };</span>
<a href="#l33.272"></a><span id="l33.272">           },</span>
<a href="#l33.273"></a><span id="l33.273">         }).api(),</span>
<a href="#l33.274"></a><span id="l33.274"> </span>
<a href="#l33.275"></a><span id="l33.275">         onFileUploadAbort: new EventManager({</span>
<a href="#l33.276"></a><span id="l33.276">           context,</span>
<a href="#l33.277"></a><span id="l33.277">           name: &quot;cloudFile.onFileUploadAbort&quot;,</span>
<a href="#l33.278"></a><span id="l33.278">           register: fire =&gt; {</span>
<a href="#l33.279"></a><span id="l33.279" class="difflineminus">-            let listener = (event, { id }) =&gt; {</span>
<a href="#l33.280"></a><span id="l33.280" class="difflineminus">-              let account = convertCloudFileAccount(self.provider);</span>
<a href="#l33.281"></a><span id="l33.281" class="difflineplus">+            let listener = (event, account, { id }) =&gt; {</span>
<a href="#l33.282"></a><span id="l33.282" class="difflineplus">+              account = convertCloudFileAccount(account);</span>
<a href="#l33.283"></a><span id="l33.283">               return fire.async(account, id);</span>
<a href="#l33.284"></a><span id="l33.284">             };</span>
<a href="#l33.285"></a><span id="l33.285"> </span>
<a href="#l33.286"></a><span id="l33.286" class="difflineminus">-            self.provider.on(&quot;uploadAbort&quot;, listener);</span>
<a href="#l33.287"></a><span id="l33.287" class="difflineplus">+            context.extension.on(&quot;uploadAbort&quot;, listener);</span>
<a href="#l33.288"></a><span id="l33.288">             return () =&gt; {</span>
<a href="#l33.289"></a><span id="l33.289" class="difflineminus">-              self.provider.off(&quot;uploadAbort&quot;, listener);</span>
<a href="#l33.290"></a><span id="l33.290" class="difflineplus">+              context.extension.off(&quot;uploadAbort&quot;, listener);</span>
<a href="#l33.291"></a><span id="l33.291">             };</span>
<a href="#l33.292"></a><span id="l33.292">           },</span>
<a href="#l33.293"></a><span id="l33.293">         }).api(),</span>
<a href="#l33.294"></a><span id="l33.294"> </span>
<a href="#l33.295"></a><span id="l33.295">         onFileDeleted: new EventManager({</span>
<a href="#l33.296"></a><span id="l33.296">           context,</span>
<a href="#l33.297"></a><span id="l33.297">           name: &quot;cloudFile.onFileDeleted&quot;,</span>
<a href="#l33.298"></a><span id="l33.298">           register: fire =&gt; {</span>
<a href="#l33.299"></a><span id="l33.299" class="difflineminus">-            let listener = (event, { id }) =&gt; {</span>
<a href="#l33.300"></a><span id="l33.300" class="difflineminus">-              let account = convertCloudFileAccount(self.provider);</span>
<a href="#l33.301"></a><span id="l33.301" class="difflineplus">+            let listener = (event, account, { id }) =&gt; {</span>
<a href="#l33.302"></a><span id="l33.302" class="difflineplus">+              account = convertCloudFileAccount(account);</span>
<a href="#l33.303"></a><span id="l33.303">               return fire.async(account, id);</span>
<a href="#l33.304"></a><span id="l33.304">             };</span>
<a href="#l33.305"></a><span id="l33.305"> </span>
<a href="#l33.306"></a><span id="l33.306" class="difflineminus">-            self.provider.on(&quot;deleteFile&quot;, listener);</span>
<a href="#l33.307"></a><span id="l33.307" class="difflineplus">+            context.extension.on(&quot;deleteFile&quot;, listener);</span>
<a href="#l33.308"></a><span id="l33.308">             return () =&gt; {</span>
<a href="#l33.309"></a><span id="l33.309" class="difflineminus">-              self.provider.off(&quot;deleteFile&quot;, listener);</span>
<a href="#l33.310"></a><span id="l33.310" class="difflineplus">+              context.extension.off(&quot;deleteFile&quot;, listener);</span>
<a href="#l33.311"></a><span id="l33.311">             };</span>
<a href="#l33.312"></a><span id="l33.312">           },</span>
<a href="#l33.313"></a><span id="l33.313">         }).api(),</span>
<a href="#l33.314"></a><span id="l33.314"> </span>
<a href="#l33.315"></a><span id="l33.315">         onAccountAdded: new EventManager({</span>
<a href="#l33.316"></a><span id="l33.316">           context,</span>
<a href="#l33.317"></a><span id="l33.317">           name: &quot;cloudFile.onAccountAdded&quot;,</span>
<a href="#l33.318"></a><span id="l33.318">           register: fire =&gt; {</span>
<a href="#l33.319"></a><span id="l33.319">             let listener = (event, nativeAccount) =&gt; {</span>
<a href="#l33.320"></a><span id="l33.320" class="difflineminus">-              if (nativeAccount.type != this.provider.type) {</span>
<a href="#l33.321"></a><span id="l33.321" class="difflineplus">+              if (nativeAccount.type != this.providerType) {</span>
<a href="#l33.322"></a><span id="l33.322">                 return null;</span>
<a href="#l33.323"></a><span id="l33.323">               }</span>
<a href="#l33.324"></a><span id="l33.324"> </span>
<a href="#l33.325"></a><span id="l33.325">               return fire.async(convertCloudFileAccount(nativeAccount));</span>
<a href="#l33.326"></a><span id="l33.326">             };</span>
<a href="#l33.327"></a><span id="l33.327"> </span>
<a href="#l33.328"></a><span id="l33.328">             cloudFileAccounts.on(&quot;accountAdded&quot;, listener);</span>
<a href="#l33.329"></a><span id="l33.329">             return () =&gt; {</span>
<a href="#l33.330"></a><span id="l33.330" class="difflineat">@@ -288,48 +300,48 @@ this.cloudFile = class extends Extension</span>
<a href="#l33.331"></a><span id="l33.331">           },</span>
<a href="#l33.332"></a><span id="l33.332">         }).api(),</span>
<a href="#l33.333"></a><span id="l33.333"> </span>
<a href="#l33.334"></a><span id="l33.334">         onAccountDeleted: new EventManager({</span>
<a href="#l33.335"></a><span id="l33.335">           context,</span>
<a href="#l33.336"></a><span id="l33.336">           name: &quot;cloudFile.onAccountDeleted&quot;,</span>
<a href="#l33.337"></a><span id="l33.337">           register: fire =&gt; {</span>
<a href="#l33.338"></a><span id="l33.338">             let listener = (event, key, type) =&gt; {</span>
<a href="#l33.339"></a><span id="l33.339" class="difflineminus">-              if (this.provider.type != type) {</span>
<a href="#l33.340"></a><span id="l33.340" class="difflineplus">+              if (this.providerType != type) {</span>
<a href="#l33.341"></a><span id="l33.341">                 return null;</span>
<a href="#l33.342"></a><span id="l33.342">               }</span>
<a href="#l33.343"></a><span id="l33.343"> </span>
<a href="#l33.344"></a><span id="l33.344">               return fire.async(key);</span>
<a href="#l33.345"></a><span id="l33.345">             };</span>
<a href="#l33.346"></a><span id="l33.346"> </span>
<a href="#l33.347"></a><span id="l33.347">             cloudFileAccounts.on(&quot;accountDeleted&quot;, listener);</span>
<a href="#l33.348"></a><span id="l33.348">             return () =&gt; {</span>
<a href="#l33.349"></a><span id="l33.349">               cloudFileAccounts.off(&quot;accountDeleted&quot;, listener);</span>
<a href="#l33.350"></a><span id="l33.350">             };</span>
<a href="#l33.351"></a><span id="l33.351">           },</span>
<a href="#l33.352"></a><span id="l33.352">         }).api(),</span>
<a href="#l33.353"></a><span id="l33.353"> </span>
<a href="#l33.354"></a><span id="l33.354">         async getAccount(accountId) {</span>
<a href="#l33.355"></a><span id="l33.355">           let account = cloudFileAccounts.getAccount(accountId);</span>
<a href="#l33.356"></a><span id="l33.356"> </span>
<a href="#l33.357"></a><span id="l33.357" class="difflineminus">-          if (!account || account.type != self.provider.type) {</span>
<a href="#l33.358"></a><span id="l33.358" class="difflineplus">+          if (!account || account.type != self.providerType) {</span>
<a href="#l33.359"></a><span id="l33.359">             return undefined;</span>
<a href="#l33.360"></a><span id="l33.360">           }</span>
<a href="#l33.361"></a><span id="l33.361"> </span>
<a href="#l33.362"></a><span id="l33.362">           return convertCloudFileAccount(account);</span>
<a href="#l33.363"></a><span id="l33.363">         },</span>
<a href="#l33.364"></a><span id="l33.364"> </span>
<a href="#l33.365"></a><span id="l33.365">         async getAllAccounts() {</span>
<a href="#l33.366"></a><span id="l33.366" class="difflineminus">-          return cloudFileAccounts.getAccountsForType(self.provider.type).map(convertCloudFileAccount);</span>
<a href="#l33.367"></a><span id="l33.367" class="difflineplus">+          return cloudFileAccounts.getAccountsForType(self.providerType).map(convertCloudFileAccount);</span>
<a href="#l33.368"></a><span id="l33.368">         },</span>
<a href="#l33.369"></a><span id="l33.369"> </span>
<a href="#l33.370"></a><span id="l33.370">         async updateAccount(accountId, updateProperties) {</span>
<a href="#l33.371"></a><span id="l33.371">           let account = cloudFileAccounts.getAccount(accountId);</span>
<a href="#l33.372"></a><span id="l33.372"> </span>
<a href="#l33.373"></a><span id="l33.373" class="difflineminus">-          if (!account || account.type != self.provider.type) {</span>
<a href="#l33.374"></a><span id="l33.374" class="difflineplus">+          if (!account || account.type != self.providerType) {</span>
<a href="#l33.375"></a><span id="l33.375">             return undefined;</span>
<a href="#l33.376"></a><span id="l33.376">           }</span>
<a href="#l33.377"></a><span id="l33.377">           if (updateProperties.configured !== null) {</span>
<a href="#l33.378"></a><span id="l33.378">             account.configured = updateProperties.configured;</span>
<a href="#l33.379"></a><span id="l33.379">           }</span>
<a href="#l33.380"></a><span id="l33.380">           if (updateProperties.uploadSizeLimit !== null) {</span>
<a href="#l33.381"></a><span id="l33.381">             account.quota.uploadSizeLimit = updateProperties.uploadSizeLimit;</span>
<a href="#l33.382"></a><span id="l33.382">           }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mail/components/extensions/test/xpcshell/test_ext_cloudFile.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -71,17 +71,17 @@ add_task(async () =&gt; {</span>
<a href="#l34.4"></a><span id="l34.4"> </span>
<a href="#l34.5"></a><span id="l34.5">         browser.cloudFile.onAccountAdded.addListener(accountListener);</span>
<a href="#l34.6"></a><span id="l34.6">         browser.test.sendMessage(&quot;createAccount&quot;, &quot;ext-other-addon&quot;);</span>
<a href="#l34.7"></a><span id="l34.7"> </span>
<a href="#l34.8"></a><span id="l34.8">         // Resolve in the next tick</span>
<a href="#l34.9"></a><span id="l34.9">         setTimeout(() =&gt; {</span>
<a href="#l34.10"></a><span id="l34.10">           browser.cloudFile.onAccountAdded.removeListener(accountListener);</span>
<a href="#l34.11"></a><span id="l34.11">           resolve();</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-        }, 0);</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineplus">+        });</span>
<a href="#l34.14"></a><span id="l34.14">       });</span>
<a href="#l34.15"></a><span id="l34.15"> </span>
<a href="#l34.16"></a><span id="l34.16">       // Account removal</span>
<a href="#l34.17"></a><span id="l34.17">       let removedAccountId = await removeCloudfileAccount(createdAccount.id);</span>
<a href="#l34.18"></a><span id="l34.18">       browser.test.assertEq(createdAccount.id, removedAccountId);</span>
<a href="#l34.19"></a><span id="l34.19">     }</span>
<a href="#l34.20"></a><span id="l34.20"> </span>
<a href="#l34.21"></a><span id="l34.21">     async function test_getters_update() {</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineat">@@ -162,17 +162,17 @@ add_task(async () =&gt; {</span>
<a href="#l34.23"></a><span id="l34.23">             browser.test.sendMessage(&quot;cancelUpload&quot;, createdAccount.id);</span>
<a href="#l34.24"></a><span id="l34.24">           });</span>
<a href="#l34.25"></a><span id="l34.25"> </span>
<a href="#l34.26"></a><span id="l34.26">           setTimeout(resolve);</span>
<a href="#l34.27"></a><span id="l34.27">           return { aborted: true };</span>
<a href="#l34.28"></a><span id="l34.28">         }</span>
<a href="#l34.29"></a><span id="l34.29"> </span>
<a href="#l34.30"></a><span id="l34.30">         browser.cloudFile.onFileUpload.addListener(fileListener);</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineminus">-        browser.test.sendMessage(&quot;uploadFile&quot;, createdAccount.id, &quot;cloudFile2&quot;, &quot;uploadCanceled&quot;);</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+        browser.test.sendMessage(&quot;uploadFile&quot;, createdAccount.id, &quot;cloudFile2&quot;, &quot;uploadCancelled&quot;);</span>
<a href="#l34.33"></a><span id="l34.33">       });</span>
<a href="#l34.34"></a><span id="l34.34"> </span>
<a href="#l34.35"></a><span id="l34.35">       browser.test.log(&quot;test delete&quot;);</span>
<a href="#l34.36"></a><span id="l34.36">       await new Promise((resolve) =&gt; {</span>
<a href="#l34.37"></a><span id="l34.37">         function fileListener(account, id) {</span>
<a href="#l34.38"></a><span id="l34.38">           browser.cloudFile.onFileDeleted.removeListener(fileListener);</span>
<a href="#l34.39"></a><span id="l34.39">           browser.test.assertEq(account.id, createdAccount.id);</span>
<a href="#l34.40"></a><span id="l34.40">           browser.test.assertEq(id, fileId);</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineat">@@ -222,17 +222,17 @@ add_task(async () =&gt; {</span>
<a href="#l34.42"></a><span id="l34.42">   extension.onMessage(&quot;removeAccount&quot;, (id) =&gt; {</span>
<a href="#l34.43"></a><span id="l34.43">     cloudFileAccounts.removeAccount(id);</span>
<a href="#l34.44"></a><span id="l34.44">   });</span>
<a href="#l34.45"></a><span id="l34.45"> </span>
<a href="#l34.46"></a><span id="l34.46">   extension.onMessage(&quot;uploadFile&quot;, (accountId, filename, expected = Cr.NS_OK) =&gt; {</span>
<a href="#l34.47"></a><span id="l34.47">     let account = cloudFileAccounts.getAccount(accountId);</span>
<a href="#l34.48"></a><span id="l34.48"> </span>
<a href="#l34.49"></a><span id="l34.49">     if (typeof expected == &quot;string&quot;) {</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineminus">-      expected = Ci.nsIMsgCloudFileProvider[expected];</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineplus">+      expected = cloudFileAccounts.constants[expected];</span>
<a href="#l34.52"></a><span id="l34.52">     }</span>
<a href="#l34.53"></a><span id="l34.53"> </span>
<a href="#l34.54"></a><span id="l34.54">     account.uploadFile(testFiles[filename], {</span>
<a href="#l34.55"></a><span id="l34.55">       onStartRequest() {},</span>
<a href="#l34.56"></a><span id="l34.56">       onStopRequest(req, context, status) {</span>
<a href="#l34.57"></a><span id="l34.57">         Assert.equal(status, expected);</span>
<a href="#l34.58"></a><span id="l34.58">       },</span>
<a href="#l34.59"></a><span id="l34.59">     });</span>
<a href="#l34.60"></a><span id="l34.60" class="difflineat">@@ -250,14 +250,16 @@ add_task(async () =&gt; {</span>
<a href="#l34.61"></a><span id="l34.61">       onStartRequest() {},</span>
<a href="#l34.62"></a><span id="l34.62">       onStopRequest() {},</span>
<a href="#l34.63"></a><span id="l34.63">     });</span>
<a href="#l34.64"></a><span id="l34.64">   });</span>
<a href="#l34.65"></a><span id="l34.65"> </span>
<a href="#l34.66"></a><span id="l34.66">   Assert.ok(!cloudFileAccounts.getProviderForType(&quot;ext-cloudfile@xpcshell&quot;));</span>
<a href="#l34.67"></a><span id="l34.67">   await extension.startup();</span>
<a href="#l34.68"></a><span id="l34.68">   Assert.ok(cloudFileAccounts.getProviderForType(&quot;ext-cloudfile@xpcshell&quot;));</span>
<a href="#l34.69"></a><span id="l34.69" class="difflineplus">+  Assert.equal(cloudFileAccounts.accounts.length, 1);</span>
<a href="#l34.70"></a><span id="l34.70"> </span>
<a href="#l34.71"></a><span id="l34.71">   await extension.awaitFinish(&quot;cloudFile&quot;);</span>
<a href="#l34.72"></a><span id="l34.72">   await extension.unload();</span>
<a href="#l34.73"></a><span id="l34.73"> </span>
<a href="#l34.74"></a><span id="l34.74">   Assert.ok(!cloudFileAccounts.getProviderForType(&quot;ext-cloudfile@xpcshell&quot;));</span>
<a href="#l34.75"></a><span id="l34.75" class="difflineplus">+  Assert.equal(cloudFileAccounts.accounts.length, 0);</span>
<a href="#l34.76"></a><span id="l34.76"> });</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mail/components/preferences/applications.inc.xul</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mail/components/preferences/applications.inc.xul</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -148,65 +148,35 @@</span>
<a href="#l35.4"></a><span id="l35.4">                        onsyncfrompreference=&quot;return gCloudFileTab.readThreshold();&quot;</span>
<a href="#l35.5"></a><span id="l35.5">                        onsynctopreference=&quot;return gCloudFileTab.writeThreshold();&quot;/&gt;</span>
<a href="#l35.6"></a><span id="l35.6">               &lt;label control=&quot;cloudFileThreshold&quot;</span>
<a href="#l35.7"></a><span id="l35.7">                      value=&quot;&amp;enableCloudFileAccountOffer.mb;&quot;/&gt;</span>
<a href="#l35.8"></a><span id="l35.8">             &lt;/hbox&gt;</span>
<a href="#l35.9"></a><span id="l35.9">             &lt;hbox flex=&quot;1&quot;&gt;</span>
<a href="#l35.10"></a><span id="l35.10">               &lt;vbox id=&quot;provider-listing&quot;&gt;</span>
<a href="#l35.11"></a><span id="l35.11">                 &lt;richlistbox id=&quot;cloudFileView&quot; orient=&quot;vertical&quot; flex=&quot;1&quot;</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-                             seltype=&quot;single&quot;&gt;</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+                             seltype=&quot;single&quot;</span>
<a href="#l35.14"></a><span id="l35.14" class="difflineplus">+                             onselect=&quot;gCloudFileTab.onSelectionChanged(event);&quot;&gt;</span>
<a href="#l35.15"></a><span id="l35.15">                 &lt;/richlistbox&gt;</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineminus">-                &lt;separator class=&quot;thin&quot;/&gt;</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineminus">-                &lt;hbox&gt;</span>
<a href="#l35.18"></a><span id="l35.18" class="difflineminus">-                  &lt;button id=&quot;addCloudFileAccount&quot;</span>
<a href="#l35.19"></a><span id="l35.19" class="difflineminus">-                          flex=&quot;1&quot;</span>
<a href="#l35.20"></a><span id="l35.20" class="difflineminus">-                          label=&quot;&amp;addCloudFileAccount1.label;&quot;</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineminus">-                          accesskey=&quot;&amp;addCloudFileAccount1.accesskey;&quot;</span>
<a href="#l35.22"></a><span id="l35.22" class="difflineminus">-                          oncommand=&quot;gCloudFileTab.addCloudFileAccount();&quot;/&gt;</span>
<a href="#l35.23"></a><span id="l35.23" class="difflineminus">-                  &lt;button id=&quot;removeCloudFileAccount&quot;</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineminus">-                          flex=&quot;1&quot;</span>
<a href="#l35.25"></a><span id="l35.25" class="difflineminus">-                          disabled=&quot;true&quot;</span>
<a href="#l35.26"></a><span id="l35.26" class="difflineminus">-                          label=&quot;&amp;removeCloudFileAccount.label;&quot;</span>
<a href="#l35.27"></a><span id="l35.27" class="difflineminus">-                          accesskey=&quot;&amp;removeCloudFileAccount.accesskey;&quot;</span>
<a href="#l35.28"></a><span id="l35.28" class="difflineminus">-                          oncommand=&quot;gCloudFileTab.removeCloudFileAccount();&quot;/&gt;</span>
<a href="#l35.29"></a><span id="l35.29" class="difflineminus">-                &lt;/hbox&gt;</span>
<a href="#l35.30"></a><span id="l35.30" class="difflineplus">+                &lt;vbox id=&quot;addCloudFileAccountButtons&quot;&gt;</span>
<a href="#l35.31"></a><span id="l35.31" class="difflineplus">+                &lt;/vbox&gt;</span>
<a href="#l35.32"></a><span id="l35.32" class="difflineplus">+                &lt;button id=&quot;removeCloudFileAccount&quot;</span>
<a href="#l35.33"></a><span id="l35.33" class="difflineplus">+                        disabled=&quot;true&quot;</span>
<a href="#l35.34"></a><span id="l35.34" class="difflineplus">+                        label=&quot;&amp;removeCloudFileAccount.label;&quot;</span>
<a href="#l35.35"></a><span id="l35.35" class="difflineplus">+                        accesskey=&quot;&amp;removeCloudFileAccount.accesskey;&quot;</span>
<a href="#l35.36"></a><span id="l35.36" class="difflineplus">+                        oncommand=&quot;gCloudFileTab.removeCloudFileAccount();&quot;/&gt;</span>
<a href="#l35.37"></a><span id="l35.37">               &lt;/vbox&gt;</span>
<a href="#l35.38"></a><span id="l35.38" class="difflineplus">+              &lt;separator class=&quot;thin&quot; orient=&quot;vertical&quot;/&gt;</span>
<a href="#l35.39"></a><span id="l35.39">               &lt;vbox flex=&quot;1&quot;&gt;</span>
<a href="#l35.40"></a><span id="l35.40">                 &lt;deck id=&quot;cloudFileSettingsDeck&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l35.41"></a><span id="l35.41">                   &lt;vbox id=&quot;cloudFileDefaultPanel&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l35.42"></a><span id="l35.42">                     &lt;description&gt;&amp;addCloudFileAccount.description;&lt;/description&gt;</span>
<a href="#l35.43"></a><span id="l35.43">                   &lt;/vbox&gt;</span>
<a href="#l35.44"></a><span id="l35.44">                   &lt;vbox id=&quot;cloudFileSettingsWrapper&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l35.45"></a><span id="l35.45">                   &lt;/vbox&gt;</span>
<a href="#l35.46"></a><span id="l35.46" class="difflineminus">-                  &lt;vbox id=&quot;cloudFileLoadingPanel&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l35.47"></a><span id="l35.47" class="difflineminus">-                    &lt;hbox&gt;</span>
<a href="#l35.48"></a><span id="l35.48" class="difflineminus">-                      &lt;spring flex=&quot;1&quot;/&gt;</span>
<a href="#l35.49"></a><span id="l35.49" class="difflineminus">-                        &lt;image id=&quot;cloudFileLoadingSpinner&quot; /&gt;</span>
<a href="#l35.50"></a><span id="l35.50" class="difflineminus">-                      &lt;spring flex=&quot;1&quot;/&gt;</span>
<a href="#l35.51"></a><span id="l35.51" class="difflineminus">-                    &lt;/hbox&gt;</span>
<a href="#l35.52"></a><span id="l35.52" class="difflineminus">-                  &lt;/vbox&gt;</span>
<a href="#l35.53"></a><span id="l35.53" class="difflineminus">-                  &lt;vbox id=&quot;cloudFileAuthErrorPanel&quot; flex=&quot;1&quot;&gt;</span>
<a href="#l35.54"></a><span id="l35.54" class="difflineminus">-                    &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l35.55"></a><span id="l35.55" class="difflineminus">-                    &lt;hbox&gt;</span>
<a href="#l35.56"></a><span id="l35.56" class="difflineminus">-                      &lt;spring flex=&quot;1&quot;/&gt;</span>
<a href="#l35.57"></a><span id="l35.57" class="difflineminus">-                        &lt;image id=&quot;authImage&quot;/&gt;</span>
<a href="#l35.58"></a><span id="l35.58" class="difflineminus">-                      &lt;spring flex=&quot;1&quot;/&gt;</span>
<a href="#l35.59"></a><span id="l35.59" class="difflineminus">-                    &lt;/hbox&gt;</span>
<a href="#l35.60"></a><span id="l35.60" class="difflineminus">-                    &lt;description id=&quot;authMessage&quot;&gt;&amp;authRequired.description;&lt;/description&gt;</span>
<a href="#l35.61"></a><span id="l35.61" class="difflineminus">-                    &lt;hbox&gt;</span>
<a href="#l35.62"></a><span id="l35.62" class="difflineminus">-                      &lt;spring flex=&quot;1&quot;/&gt;</span>
<a href="#l35.63"></a><span id="l35.63" class="difflineminus">-                        &lt;button id=&quot;reauthCloudFileAccount&quot;</span>
<a href="#l35.64"></a><span id="l35.64" class="difflineminus">-                                label=&quot;&amp;authRequired.button.label;&quot;</span>
<a href="#l35.65"></a><span id="l35.65" class="difflineminus">-                                accesskey=&quot;&amp;authRequired.button.accesskey;&quot;</span>
<a href="#l35.66"></a><span id="l35.66" class="difflineminus">-                                oncommand=&quot;gCloudFileTab.authSelected();&quot;/&gt;</span>
<a href="#l35.67"></a><span id="l35.67" class="difflineminus">-                      &lt;spring flex=&quot;1&quot;/&gt;</span>
<a href="#l35.68"></a><span id="l35.68" class="difflineminus">-                     &lt;/hbox&gt;</span>
<a href="#l35.69"></a><span id="l35.69" class="difflineminus">-                    &lt;spacer flex=&quot;1&quot;/&gt;</span>
<a href="#l35.70"></a><span id="l35.70" class="difflineminus">-                  &lt;/vbox&gt;</span>
<a href="#l35.71"></a><span id="l35.71">                 &lt;/deck&gt;</span>
<a href="#l35.72"></a><span id="l35.72">               &lt;/vbox&gt;</span>
<a href="#l35.73"></a><span id="l35.73">             &lt;/hbox&gt;</span>
<a href="#l35.74"></a><span id="l35.74">           &lt;/vbox&gt;</span>
<a href="#l35.75"></a><span id="l35.75">         &lt;/tabpanel&gt;</span>
<a href="#l35.76"></a><span id="l35.76">       &lt;/tabpanels&gt;</span>
<a href="#l35.77"></a><span id="l35.77">     &lt;/tabbox&gt;</span>
<a href="#l35.78"></a><span id="l35.78">   &lt;/prefpane&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mail/components/preferences/applications.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mail/components/preferences/applications.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -499,24 +499,23 @@ var gApplicationsTabController = {</span>
<a href="#l36.4"></a><span id="l36.4">     gCloudFileTab.init();</span>
<a href="#l36.5"></a><span id="l36.5">   },</span>
<a href="#l36.6"></a><span id="l36.6"> };</span>
<a href="#l36.7"></a><span id="l36.7"> </span>
<a href="#l36.8"></a><span id="l36.8"> var gCloudFileTab = {</span>
<a href="#l36.9"></a><span id="l36.9">   _initialized: false,</span>
<a href="#l36.10"></a><span id="l36.10">   _initializationStarted: false,</span>
<a href="#l36.11"></a><span id="l36.11">   _list: null,</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineplus">+  _buttonContainer: null,</span>
<a href="#l36.13"></a><span id="l36.13">   _settings: null,</span>
<a href="#l36.14"></a><span id="l36.14">   _settingsDeck: null,</span>
<a href="#l36.15"></a><span id="l36.15">   _tabpanel: null,</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineminus">-  _accountCache: {},</span>
<a href="#l36.17"></a><span id="l36.17">   _settingsPanelWrap: null,</span>
<a href="#l36.18"></a><span id="l36.18">   _defaultPanel: null,</span>
<a href="#l36.19"></a><span id="l36.19" class="difflineminus">-  _loadingPanel: null,</span>
<a href="#l36.20"></a><span id="l36.20" class="difflineminus">-  _authErrorPanel: null,</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineplus">+  _blacklist: new Set([&quot;YouSendIt&quot;]),</span>
<a href="#l36.22"></a><span id="l36.22"> </span>
<a href="#l36.23"></a><span id="l36.23">   get _strings() {</span>
<a href="#l36.24"></a><span id="l36.24">     return Services.strings</span>
<a href="#l36.25"></a><span id="l36.25">                    .createBundle(&quot;chrome://messenger/locale/preferences/applications.properties&quot;);</span>
<a href="#l36.26"></a><span id="l36.26">   },</span>
<a href="#l36.27"></a><span id="l36.27"> </span>
<a href="#l36.28"></a><span id="l36.28">   init() {</span>
<a href="#l36.29"></a><span id="l36.29">     // Because this leads to another document being loaded, do it only when really necessary.</span>
<a href="#l36.30"></a><span id="l36.30" class="difflineat">@@ -529,288 +528,227 @@ var gCloudFileTab = {</span>
<a href="#l36.31"></a><span id="l36.31">     if (gApplicationsTabController.mTabBox.selectedIndex != 1) {</span>
<a href="#l36.32"></a><span id="l36.32">       return;</span>
<a href="#l36.33"></a><span id="l36.33">     }</span>
<a href="#l36.34"></a><span id="l36.34"> </span>
<a href="#l36.35"></a><span id="l36.35">     this._initializationStarted = true;</span>
<a href="#l36.36"></a><span id="l36.36">     window.removeEventListener(&quot;paneSelected&quot;, gApplicationsTabController.paneSelectionChanged);</span>
<a href="#l36.37"></a><span id="l36.37"> </span>
<a href="#l36.38"></a><span id="l36.38">     this._list = document.getElementById(&quot;cloudFileView&quot;);</span>
<a href="#l36.39"></a><span id="l36.39" class="difflineplus">+    this._buttonContainer = document.getElementById(&quot;addCloudFileAccountButtons&quot;);</span>
<a href="#l36.40"></a><span id="l36.40">     this._removeAccountButton = document.getElementById(&quot;removeCloudFileAccount&quot;);</span>
<a href="#l36.41"></a><span id="l36.41">     this._settingsDeck = document.getElementById(&quot;cloudFileSettingsDeck&quot;);</span>
<a href="#l36.42"></a><span id="l36.42">     this._defaultPanel = document.getElementById(&quot;cloudFileDefaultPanel&quot;);</span>
<a href="#l36.43"></a><span id="l36.43">     this._settingsPanelWrap = document.getElementById(&quot;cloudFileSettingsWrapper&quot;);</span>
<a href="#l36.44"></a><span id="l36.44" class="difflineminus">-    this._loadingPanel = document.getElementById(&quot;cloudFileLoadingPanel&quot;);</span>
<a href="#l36.45"></a><span id="l36.45" class="difflineminus">-    this._authErrorPanel = document.getElementById(&quot;cloudFileAuthErrorPanel&quot;);</span>
<a href="#l36.46"></a><span id="l36.46"> </span>
<a href="#l36.47"></a><span id="l36.47" class="difflineminus">-    this.onSelectionChanged = this.onSelectionChanged.bind(this);</span>
<a href="#l36.48"></a><span id="l36.48" class="difflineminus">-    this._list.addEventListener(&quot;select&quot;, this.onSelectionChanged);</span>
<a href="#l36.49"></a><span id="l36.49" class="difflineplus">+    this.updateThreshold();</span>
<a href="#l36.50"></a><span id="l36.50">     this.rebuildView();</span>
<a href="#l36.51"></a><span id="l36.51"> </span>
<a href="#l36.52"></a><span id="l36.52" class="difflineminus">-    if (this._list.itemCount &gt; 0) {</span>
<a href="#l36.53"></a><span id="l36.53" class="difflineminus">-      this._list.selectedIndex = 0;</span>
<a href="#l36.54"></a><span id="l36.54" class="difflineminus">-      this._removeAccountButton.disabled = false;</span>
<a href="#l36.55"></a><span id="l36.55" class="difflineminus">-    }</span>
<a href="#l36.56"></a><span id="l36.56" class="difflineminus">-</span>
<a href="#l36.57"></a><span id="l36.57">     window.addEventListener(&quot;unload&quot;, this, {capture: false, once: true});</span>
<a href="#l36.58"></a><span id="l36.58"> </span>
<a href="#l36.59"></a><span id="l36.59" class="difflineminus">-    this.updateThreshold();</span>
<a href="#l36.60"></a><span id="l36.60" class="difflineminus">-</span>
<a href="#l36.61"></a><span id="l36.61" class="difflineplus">+    this._onAccountConfigured = this._onAccountConfigured.bind(this);</span>
<a href="#l36.62"></a><span id="l36.62">     this._onProviderRegistered = this._onProviderRegistered.bind(this);</span>
<a href="#l36.63"></a><span id="l36.63">     this._onProviderUnregistered = this._onProviderUnregistered.bind(this);</span>
<a href="#l36.64"></a><span id="l36.64" class="difflineplus">+    cloudFileAccounts.on(&quot;accountConfigured&quot;, this._onAccountConfigured);</span>
<a href="#l36.65"></a><span id="l36.65">     cloudFileAccounts.on(&quot;providerRegistered&quot;, this._onProviderRegistered);</span>
<a href="#l36.66"></a><span id="l36.66">     cloudFileAccounts.on(&quot;providerUnregistered&quot;, this._onProviderUnregistered);</span>
<a href="#l36.67"></a><span id="l36.67"> </span>
<a href="#l36.68"></a><span id="l36.68">     this._initialized = true;</span>
<a href="#l36.69"></a><span id="l36.69">   },</span>
<a href="#l36.70"></a><span id="l36.70"> </span>
<a href="#l36.71"></a><span id="l36.71">   destroy() {</span>
<a href="#l36.72"></a><span id="l36.72">     // Remove any controllers or observers here.</span>
<a href="#l36.73"></a><span id="l36.73" class="difflineplus">+    cloudFileAccounts.off(&quot;accountConfigured&quot;, this._onAccountConfigured);</span>
<a href="#l36.74"></a><span id="l36.74">     cloudFileAccounts.off(&quot;providerRegistered&quot;, this._onProviderRegistered);</span>
<a href="#l36.75"></a><span id="l36.75">     cloudFileAccounts.off(&quot;providerUnregistered&quot;, this._onProviderUnregistered);</span>
<a href="#l36.76"></a><span id="l36.76">   },</span>
<a href="#l36.77"></a><span id="l36.77"> </span>
<a href="#l36.78"></a><span id="l36.78" class="difflineplus">+  _onAccountConfigured(event, account) {</span>
<a href="#l36.79"></a><span id="l36.79" class="difflineplus">+    for (let item of this._list.children) {</span>
<a href="#l36.80"></a><span id="l36.80" class="difflineplus">+      if (item.value == account.accountKey) {</span>
<a href="#l36.81"></a><span id="l36.81" class="difflineplus">+        item.querySelector(&quot;image.configuredWarning&quot;).hidden = account.configured;</span>
<a href="#l36.82"></a><span id="l36.82" class="difflineplus">+      }</span>
<a href="#l36.83"></a><span id="l36.83" class="difflineplus">+    }</span>
<a href="#l36.84"></a><span id="l36.84" class="difflineplus">+  },</span>
<a href="#l36.85"></a><span id="l36.85" class="difflineplus">+</span>
<a href="#l36.86"></a><span id="l36.86">   _onProviderRegistered(event, provider) {</span>
<a href="#l36.87"></a><span id="l36.87">     let accounts = cloudFileAccounts.getAccountsForType(provider.type);</span>
<a href="#l36.88"></a><span id="l36.88" class="difflineminus">-    accounts.sort(this._sortAccounts);</span>
<a href="#l36.89"></a><span id="l36.89" class="difflineplus">+    accounts.sort(this._sortDisplayNames);</span>
<a href="#l36.90"></a><span id="l36.90"> </span>
<a href="#l36.91"></a><span id="l36.91">     // Always add newly-enabled accounts to the end of the list, this makes</span>
<a href="#l36.92"></a><span id="l36.92">     // it clearer to users what's happening.</span>
<a href="#l36.93"></a><span id="l36.93">     for (let account of accounts) {</span>
<a href="#l36.94"></a><span id="l36.94">       let item = this.makeRichListItemForAccount(account);</span>
<a href="#l36.95"></a><span id="l36.95">       this._list.appendChild(item);</span>
<a href="#l36.96"></a><span id="l36.96" class="difflineminus">-      if (!(account.accountKey in this._accountCache)) {</span>
<a href="#l36.97"></a><span id="l36.97" class="difflineminus">-        let accountInfo = {</span>
<a href="#l36.98"></a><span id="l36.98" class="difflineminus">-          account,</span>
<a href="#l36.99"></a><span id="l36.99" class="difflineminus">-          listItem: item,</span>
<a href="#l36.100"></a><span id="l36.100" class="difflineminus">-          result: Cr.NS_OK,</span>
<a href="#l36.101"></a><span id="l36.101" class="difflineminus">-        };</span>
<a href="#l36.102"></a><span id="l36.102" class="difflineminus">-        this._accountCache[account.accountKey] = accountInfo;</span>
<a href="#l36.103"></a><span id="l36.103" class="difflineminus">-        this._mapResultToState(item, accountInfo.result);</span>
<a href="#l36.104"></a><span id="l36.104" class="difflineminus">-      }</span>
<a href="#l36.105"></a><span id="l36.105" class="difflineplus">+    }</span>
<a href="#l36.106"></a><span id="l36.106" class="difflineplus">+</span>
<a href="#l36.107"></a><span id="l36.107" class="difflineplus">+    if (!this._blacklist.has(provider.type)) {</span>
<a href="#l36.108"></a><span id="l36.108" class="difflineplus">+      this._buttonContainer.appendChild(this.makeButtonForProvider(provider));</span>
<a href="#l36.109"></a><span id="l36.109">     }</span>
<a href="#l36.110"></a><span id="l36.110">   },</span>
<a href="#l36.111"></a><span id="l36.111"> </span>
<a href="#l36.112"></a><span id="l36.112">   _onProviderUnregistered(event, type) {</span>
<a href="#l36.113"></a><span id="l36.113">     for (let item of this._list.children) {</span>
<a href="#l36.114"></a><span id="l36.114">       // If the provider is unregistered, getAccount returns null.</span>
<a href="#l36.115"></a><span id="l36.115">       if (!cloudFileAccounts.getAccount(item.value)) {</span>
<a href="#l36.116"></a><span id="l36.116">         if (item.hasAttribute(&quot;selected&quot;)) {</span>
<a href="#l36.117"></a><span id="l36.117">           this._settingsDeck.selectedPanel = this._defaultPanel;</span>
<a href="#l36.118"></a><span id="l36.118" class="difflineplus">+          if (this._settings) {</span>
<a href="#l36.119"></a><span id="l36.119" class="difflineplus">+            this._settings.remove();</span>
<a href="#l36.120"></a><span id="l36.120" class="difflineplus">+          }</span>
<a href="#l36.121"></a><span id="l36.121" class="difflineplus">+          this._removeAccountButton.disabled = true;</span>
<a href="#l36.122"></a><span id="l36.122">         }</span>
<a href="#l36.123"></a><span id="l36.123">         item.remove();</span>
<a href="#l36.124"></a><span id="l36.124">       }</span>
<a href="#l36.125"></a><span id="l36.125">     }</span>
<a href="#l36.126"></a><span id="l36.126" class="difflineplus">+</span>
<a href="#l36.127"></a><span id="l36.127" class="difflineplus">+    for (let button of this._buttonContainer.children) {</span>
<a href="#l36.128"></a><span id="l36.128" class="difflineplus">+      if (button.getAttribute(&quot;value&quot;) == type) {</span>
<a href="#l36.129"></a><span id="l36.129" class="difflineplus">+        button.remove();</span>
<a href="#l36.130"></a><span id="l36.130" class="difflineplus">+      }</span>
<a href="#l36.131"></a><span id="l36.131" class="difflineplus">+    }</span>
<a href="#l36.132"></a><span id="l36.132">   },</span>
<a href="#l36.133"></a><span id="l36.133"> </span>
<a href="#l36.134"></a><span id="l36.134">   makeRichListItemForAccount(aAccount) {</span>
<a href="#l36.135"></a><span id="l36.135">     let rli = document.createElement(&quot;richlistitem&quot;);</span>
<a href="#l36.136"></a><span id="l36.136">     rli.value = aAccount.accountKey;</span>
<a href="#l36.137"></a><span id="l36.137" class="difflineminus">-    rli.setAttribute(&quot;value&quot;, aAccount.accountKey);</span>
<a href="#l36.138"></a><span id="l36.138" class="difflineplus">+    rli.setAttribute(&quot;align&quot;, &quot;baseline&quot;);</span>
<a href="#l36.139"></a><span id="l36.139">     rli.setAttribute(&quot;class&quot;, &quot;cloudfileAccount&quot;);</span>
<a href="#l36.140"></a><span id="l36.140" class="difflineminus">-    rli.setAttribute(&quot;state&quot;, &quot;waiting-to-connect&quot;);</span>
<a href="#l36.141"></a><span id="l36.141" class="difflineplus">+    rli.setAttribute(&quot;value&quot;, aAccount.accountKey);</span>
<a href="#l36.142"></a><span id="l36.142"> </span>
<a href="#l36.143"></a><span id="l36.143" class="difflineminus">-    if (aAccount.iconClass)</span>
<a href="#l36.144"></a><span id="l36.144" class="difflineminus">-      rli.style.listStyleImage = &quot;url('&quot; + aAccount.iconClass + &quot;')&quot;;</span>
<a href="#l36.145"></a><span id="l36.145" class="difflineplus">+    if (aAccount.iconURL)</span>
<a href="#l36.146"></a><span id="l36.146" class="difflineplus">+      rli.style.listStyleImage = &quot;url('&quot; + aAccount.iconURL + &quot;')&quot;;</span>
<a href="#l36.147"></a><span id="l36.147"> </span>
<a href="#l36.148"></a><span id="l36.148" class="difflineminus">-    let displayName = cloudFileAccounts.getDisplayName(aAccount.accountKey);</span>
<a href="#l36.149"></a><span id="l36.149" class="difflineminus">-    // Quick and ugly - accountKey:displayName for now</span>
<a href="#l36.150"></a><span id="l36.150" class="difflineminus">-    let status = document.createElement(&quot;image&quot;);</span>
<a href="#l36.151"></a><span id="l36.151" class="difflineminus">-    status.setAttribute(&quot;class&quot;, &quot;typeIcon&quot;);</span>
<a href="#l36.152"></a><span id="l36.152" class="difflineplus">+    let icon = document.createElement(&quot;image&quot;);</span>
<a href="#l36.153"></a><span id="l36.153" class="difflineplus">+    icon.setAttribute(&quot;class&quot;, &quot;typeIcon&quot;);</span>
<a href="#l36.154"></a><span id="l36.154" class="difflineplus">+    rli.appendChild(icon);</span>
<a href="#l36.155"></a><span id="l36.155"> </span>
<a href="#l36.156"></a><span id="l36.156" class="difflineminus">-    rli.appendChild(status);</span>
<a href="#l36.157"></a><span id="l36.157" class="difflineminus">-    let descr = document.createElement(&quot;label&quot;);</span>
<a href="#l36.158"></a><span id="l36.158" class="difflineminus">-    descr.setAttribute(&quot;value&quot;, displayName);</span>
<a href="#l36.159"></a><span id="l36.159" class="difflineminus">-    rli.appendChild(descr);</span>
<a href="#l36.160"></a><span id="l36.160" class="difflineplus">+    let label = document.createElement(&quot;label&quot;);</span>
<a href="#l36.161"></a><span id="l36.161" class="difflineplus">+    label.setAttribute(&quot;crop&quot;, &quot;end&quot;);</span>
<a href="#l36.162"></a><span id="l36.162" class="difflineplus">+    label.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l36.163"></a><span id="l36.163" class="difflineplus">+    label.setAttribute(&quot;value&quot;, cloudFileAccounts.getDisplayName(aAccount.accountKey));</span>
<a href="#l36.164"></a><span id="l36.164" class="difflineplus">+    label.addEventListener(&quot;click&quot;, this, true);</span>
<a href="#l36.165"></a><span id="l36.165" class="difflineplus">+    rli.appendChild(label);</span>
<a href="#l36.166"></a><span id="l36.166"> </span>
<a href="#l36.167"></a><span id="l36.167" class="difflineminus">-    // Set the state of the richlistitem, if applicable</span>
<a href="#l36.168"></a><span id="l36.168" class="difflineminus">-    if (aAccount.accountKey in this._accountCache) {</span>
<a href="#l36.169"></a><span id="l36.169" class="difflineminus">-      let result = this._accountCache[aAccount.accountKey].result;</span>
<a href="#l36.170"></a><span id="l36.170" class="difflineminus">-      this._mapResultToState(rli, result);</span>
<a href="#l36.171"></a><span id="l36.171" class="difflineminus">-      this._accountCache[aAccount.accountKey].listItem = rli;</span>
<a href="#l36.172"></a><span id="l36.172" class="difflineplus">+    let textBox = document.createElement(&quot;textbox&quot;);</span>
<a href="#l36.173"></a><span id="l36.173" class="difflineplus">+    textBox.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l36.174"></a><span id="l36.174" class="difflineplus">+    textBox.hidden = true;</span>
<a href="#l36.175"></a><span id="l36.175" class="difflineplus">+    textBox.addEventListener(&quot;blur&quot;, this);</span>
<a href="#l36.176"></a><span id="l36.176" class="difflineplus">+    textBox.addEventListener(&quot;keypress&quot;, this);</span>
<a href="#l36.177"></a><span id="l36.177" class="difflineplus">+    rli.appendChild(textBox);</span>
<a href="#l36.178"></a><span id="l36.178" class="difflineplus">+</span>
<a href="#l36.179"></a><span id="l36.179" class="difflineplus">+    let warningIcon = document.createElement(&quot;image&quot;);</span>
<a href="#l36.180"></a><span id="l36.180" class="difflineplus">+    warningIcon.setAttribute(&quot;class&quot;, &quot;configuredWarning typeIcon&quot;);</span>
<a href="#l36.181"></a><span id="l36.181" class="difflineplus">+    warningIcon.setAttribute(&quot;src&quot;, &quot;chrome://global/skin/icons/warning.svg&quot;);</span>
<a href="#l36.182"></a><span id="l36.182" class="difflineplus">+    warningIcon.setAttribute(&quot;tooltiptext&quot;, this._strings.GetStringFromName(&quot;notConfiguredYet&quot;));</span>
<a href="#l36.183"></a><span id="l36.183" class="difflineplus">+    if (aAccount.configured) {</span>
<a href="#l36.184"></a><span id="l36.184" class="difflineplus">+      warningIcon.hidden = true;</span>
<a href="#l36.185"></a><span id="l36.185">     }</span>
<a href="#l36.186"></a><span id="l36.186" class="difflineplus">+    rli.appendChild(warningIcon);</span>
<a href="#l36.187"></a><span id="l36.187"> </span>
<a href="#l36.188"></a><span id="l36.188">     return rli;</span>
<a href="#l36.189"></a><span id="l36.189">   },</span>
<a href="#l36.190"></a><span id="l36.190"> </span>
<a href="#l36.191"></a><span id="l36.191" class="difflineminus">-  clearEntries() {</span>
<a href="#l36.192"></a><span id="l36.192" class="difflineminus">-    // Clear the list of entries.</span>
<a href="#l36.193"></a><span id="l36.193" class="difflineminus">-    while (this._list.hasChildNodes())</span>
<a href="#l36.194"></a><span id="l36.194" class="difflineminus">-      this._list.lastChild.remove();</span>
<a href="#l36.195"></a><span id="l36.195" class="difflineplus">+  makeButtonForProvider(provider) {</span>
<a href="#l36.196"></a><span id="l36.196" class="difflineplus">+    let button = document.createElement(&quot;button&quot;);</span>
<a href="#l36.197"></a><span id="l36.197" class="difflineplus">+    button.setAttribute(&quot;value&quot;, provider.type);</span>
<a href="#l36.198"></a><span id="l36.198" class="difflineplus">+    button.setAttribute(</span>
<a href="#l36.199"></a><span id="l36.199" class="difflineplus">+      &quot;label&quot;, this._strings.formatStringFromName(&quot;addProvider&quot;, [provider.displayName], 1)</span>
<a href="#l36.200"></a><span id="l36.200" class="difflineplus">+    );</span>
<a href="#l36.201"></a><span id="l36.201" class="difflineplus">+    button.setAttribute(&quot;oncommand&quot;, `gCloudFileTab.addCloudFileAccount(&quot;${provider.type}&quot;)`);</span>
<a href="#l36.202"></a><span id="l36.202" class="difflineplus">+    button.style.listStyleImage = `url(&quot;${provider.iconURL}&quot;)`;</span>
<a href="#l36.203"></a><span id="l36.203" class="difflineplus">+    return button;</span>
<a href="#l36.204"></a><span id="l36.204">   },</span>
<a href="#l36.205"></a><span id="l36.205"> </span>
<a href="#l36.206"></a><span id="l36.206">   // Sort the accounts by displayName.</span>
<a href="#l36.207"></a><span id="l36.207" class="difflineminus">-  _sortAccounts(a, b) {</span>
<a href="#l36.208"></a><span id="l36.208" class="difflineminus">-    let aName = cloudFileAccounts.getDisplayName(a.accountKey)</span>
<a href="#l36.209"></a><span id="l36.209" class="difflineminus">-                                 .toLowerCase();</span>
<a href="#l36.210"></a><span id="l36.210" class="difflineminus">-    let bName = cloudFileAccounts.getDisplayName(b.accountKey)</span>
<a href="#l36.211"></a><span id="l36.211" class="difflineminus">-                                 .toLowerCase();</span>
<a href="#l36.212"></a><span id="l36.212" class="difflineminus">-</span>
<a href="#l36.213"></a><span id="l36.213" class="difflineminus">-    if (aName &lt; bName)</span>
<a href="#l36.214"></a><span id="l36.214" class="difflineminus">-      return -1;</span>
<a href="#l36.215"></a><span id="l36.215" class="difflineminus">-    if (aName &gt; bName)</span>
<a href="#l36.216"></a><span id="l36.216" class="difflineminus">-      return 1;</span>
<a href="#l36.217"></a><span id="l36.217" class="difflineminus">-    return 0;</span>
<a href="#l36.218"></a><span id="l36.218" class="difflineplus">+  _sortDisplayNames(a, b) {</span>
<a href="#l36.219"></a><span id="l36.219" class="difflineplus">+    let aName = a.displayName.toLowerCase();</span>
<a href="#l36.220"></a><span id="l36.220" class="difflineplus">+    let bName = b.displayName.toLowerCase();</span>
<a href="#l36.221"></a><span id="l36.221" class="difflineplus">+    return aName.localeCompare(bName);</span>
<a href="#l36.222"></a><span id="l36.222">   },</span>
<a href="#l36.223"></a><span id="l36.223"> </span>
<a href="#l36.224"></a><span id="l36.224">   rebuildView() {</span>
<a href="#l36.225"></a><span id="l36.225" class="difflineminus">-    this.clearEntries();</span>
<a href="#l36.226"></a><span id="l36.226" class="difflineplus">+    // Clear the list of entries.</span>
<a href="#l36.227"></a><span id="l36.227" class="difflineplus">+    while (this._list.hasChildNodes())</span>
<a href="#l36.228"></a><span id="l36.228" class="difflineplus">+      this._list.lastChild.remove();</span>
<a href="#l36.229"></a><span id="l36.229" class="difflineplus">+</span>
<a href="#l36.230"></a><span id="l36.230">     let accounts = cloudFileAccounts.accounts;</span>
<a href="#l36.231"></a><span id="l36.231" class="difflineminus">-</span>
<a href="#l36.232"></a><span id="l36.232" class="difflineminus">-    accounts.sort(this._sortAccounts);</span>
<a href="#l36.233"></a><span id="l36.233" class="difflineplus">+    accounts.sort(this._sortDisplayNames);</span>
<a href="#l36.234"></a><span id="l36.234"> </span>
<a href="#l36.235"></a><span id="l36.235">     for (let account of accounts) {</span>
<a href="#l36.236"></a><span id="l36.236">       let rli = this.makeRichListItemForAccount(account);</span>
<a href="#l36.237"></a><span id="l36.237">       this._list.appendChild(rli);</span>
<a href="#l36.238"></a><span id="l36.238" class="difflineminus">-      if (!(account.accountKey in this._accountCache))</span>
<a href="#l36.239"></a><span id="l36.239" class="difflineminus">-        this.requestUserInfoForItem(rli, false);</span>
<a href="#l36.240"></a><span id="l36.240" class="difflineplus">+    }</span>
<a href="#l36.241"></a><span id="l36.241" class="difflineplus">+</span>
<a href="#l36.242"></a><span id="l36.242" class="difflineplus">+    while (this._buttonContainer.hasChildNodes())</span>
<a href="#l36.243"></a><span id="l36.243" class="difflineplus">+      this._buttonContainer.lastChild.remove();</span>
<a href="#l36.244"></a><span id="l36.244" class="difflineplus">+</span>
<a href="#l36.245"></a><span id="l36.245" class="difflineplus">+    let providers = cloudFileAccounts.providers;</span>
<a href="#l36.246"></a><span id="l36.246" class="difflineplus">+    providers.sort(this._sortDisplayNames);</span>
<a href="#l36.247"></a><span id="l36.247" class="difflineplus">+    for (let provider of providers) {</span>
<a href="#l36.248"></a><span id="l36.248" class="difflineplus">+      if (this._blacklist.has(provider.type)) {</span>
<a href="#l36.249"></a><span id="l36.249" class="difflineplus">+        continue;</span>
<a href="#l36.250"></a><span id="l36.250" class="difflineplus">+      }</span>
<a href="#l36.251"></a><span id="l36.251" class="difflineplus">+</span>
<a href="#l36.252"></a><span id="l36.252" class="difflineplus">+      this._buttonContainer.appendChild(this.makeButtonForProvider(provider));</span>
<a href="#l36.253"></a><span id="l36.253">     }</span>
<a href="#l36.254"></a><span id="l36.254">   },</span>
<a href="#l36.255"></a><span id="l36.255"> </span>
<a href="#l36.256"></a><span id="l36.256" class="difflineminus">-  requestUserInfoForItem(aItem, aWithUI) {</span>
<a href="#l36.257"></a><span id="l36.257" class="difflineminus">-    let accountKey = aItem.value;</span>
<a href="#l36.258"></a><span id="l36.258" class="difflineminus">-    let account = cloudFileAccounts.getAccount(accountKey);</span>
<a href="#l36.259"></a><span id="l36.259" class="difflineminus">-</span>
<a href="#l36.260"></a><span id="l36.260" class="difflineminus">-    let observer = {</span>
<a href="#l36.261"></a><span id="l36.261" class="difflineminus">-      onStopRequest(aRequest, aContext, aStatusCode) {</span>
<a href="#l36.262"></a><span id="l36.262" class="difflineminus">-        gCloudFileTab._accountCache[accountKey].result = aStatusCode;</span>
<a href="#l36.263"></a><span id="l36.263" class="difflineminus">-        gCloudFileTab.onUserInfoRequestDone(accountKey);</span>
<a href="#l36.264"></a><span id="l36.264" class="difflineminus">-      },</span>
<a href="#l36.265"></a><span id="l36.265" class="difflineminus">-      onStartRequest(aRequest, aContext) {</span>
<a href="#l36.266"></a><span id="l36.266" class="difflineminus">-        aItem.setAttribute(&quot;state&quot;, &quot;connecting&quot;);</span>
<a href="#l36.267"></a><span id="l36.267" class="difflineminus">-      },</span>
<a href="#l36.268"></a><span id="l36.268" class="difflineminus">-    };</span>
<a href="#l36.269"></a><span id="l36.269" class="difflineminus">-</span>
<a href="#l36.270"></a><span id="l36.270" class="difflineminus">-    let accountInfo = {</span>
<a href="#l36.271"></a><span id="l36.271" class="difflineminus">-      account,</span>
<a href="#l36.272"></a><span id="l36.272" class="difflineminus">-      listItem: aItem,</span>
<a href="#l36.273"></a><span id="l36.273" class="difflineminus">-      result: Cr.NS_ERROR_NOT_AVAILABLE,</span>
<a href="#l36.274"></a><span id="l36.274" class="difflineminus">-    };</span>
<a href="#l36.275"></a><span id="l36.275" class="difflineminus">-</span>
<a href="#l36.276"></a><span id="l36.276" class="difflineminus">-    this._accountCache[accountKey] = accountInfo;</span>
<a href="#l36.277"></a><span id="l36.277" class="difflineminus">-</span>
<a href="#l36.278"></a><span id="l36.278" class="difflineminus">-    this._settingsDeck.selectedPanel = this._loadingPanel;</span>
<a href="#l36.279"></a><span id="l36.279" class="difflineminus">-    account.refreshUserInfo(aWithUI, observer);</span>
<a href="#l36.280"></a><span id="l36.280" class="difflineminus">-  },</span>
<a href="#l36.281"></a><span id="l36.281" class="difflineminus">-</span>
<a href="#l36.282"></a><span id="l36.282" class="difflineminus">-  onUserInfoRequestDone(aAccountKey) {</span>
<a href="#l36.283"></a><span id="l36.283" class="difflineminus">-    this.updateRichListItem(aAccountKey);</span>
<a href="#l36.284"></a><span id="l36.284" class="difflineplus">+  onSelectionChanged(aEvent) {</span>
<a href="#l36.285"></a><span id="l36.285" class="difflineplus">+    if (!this._initialized || aEvent.target != this._list) {</span>
<a href="#l36.286"></a><span id="l36.286" class="difflineplus">+      return;</span>
<a href="#l36.287"></a><span id="l36.287" class="difflineplus">+    }</span>
<a href="#l36.288"></a><span id="l36.288"> </span>
<a href="#l36.289"></a><span id="l36.289" class="difflineminus">-    if (this._list.selectedItem &amp;&amp;</span>
<a href="#l36.290"></a><span id="l36.290" class="difflineminus">-        this._list.selectedItem.value == aAccountKey)</span>
<a href="#l36.291"></a><span id="l36.291" class="difflineminus">-      this._showAccountInfo(aAccountKey);</span>
<a href="#l36.292"></a><span id="l36.292" class="difflineminus">-  },</span>
<a href="#l36.293"></a><span id="l36.293" class="difflineminus">-</span>
<a href="#l36.294"></a><span id="l36.294" class="difflineminus">-  updateRichListItem(aAccountKey) {</span>
<a href="#l36.295"></a><span id="l36.295" class="difflineminus">-    let accountInfo = this._accountCache[aAccountKey];</span>
<a href="#l36.296"></a><span id="l36.296" class="difflineminus">-    if (!accountInfo)</span>
<a href="#l36.297"></a><span id="l36.297" class="difflineminus">-      return;</span>
<a href="#l36.298"></a><span id="l36.298" class="difflineminus">-</span>
<a href="#l36.299"></a><span id="l36.299" class="difflineminus">-    let item = accountInfo.listItem;</span>
<a href="#l36.300"></a><span id="l36.300" class="difflineminus">-    let result = accountInfo.result;</span>
<a href="#l36.301"></a><span id="l36.301" class="difflineminus">-    this._mapResultToState(item, result);</span>
<a href="#l36.302"></a><span id="l36.302" class="difflineminus">-  },</span>
<a href="#l36.303"></a><span id="l36.303" class="difflineminus">-</span>
<a href="#l36.304"></a><span id="l36.304" class="difflineminus">-  _mapResultToState(aItem, aResult) {</span>
<a href="#l36.305"></a><span id="l36.305" class="difflineminus">-    let itemState = &quot;no-connection&quot;;</span>
<a href="#l36.306"></a><span id="l36.306" class="difflineminus">-</span>
<a href="#l36.307"></a><span id="l36.307" class="difflineminus">-    if (aResult == Cr.NS_OK)</span>
<a href="#l36.308"></a><span id="l36.308" class="difflineminus">-      itemState = &quot;connected&quot;;</span>
<a href="#l36.309"></a><span id="l36.309" class="difflineminus">-    else if (aResult == Ci.nsIMsgCloudFileProvider.authErr)</span>
<a href="#l36.310"></a><span id="l36.310" class="difflineminus">-      itemState = &quot;auth-error&quot;;</span>
<a href="#l36.311"></a><span id="l36.311" class="difflineminus">-    else if (aResult == Cr.NS_ERROR_NOT_AVAILABLE)</span>
<a href="#l36.312"></a><span id="l36.312" class="difflineminus">-      itemState = &quot;no-connection&quot;;</span>
<a href="#l36.313"></a><span id="l36.313" class="difflineminus">-    // TODO: What other states are there?</span>
<a href="#l36.314"></a><span id="l36.314" class="difflineminus">-</span>
<a href="#l36.315"></a><span id="l36.315" class="difflineminus">-    aItem.setAttribute(&quot;state&quot;, itemState);</span>
<a href="#l36.316"></a><span id="l36.316" class="difflineminus">-  },</span>
<a href="#l36.317"></a><span id="l36.317" class="difflineminus">-</span>
<a href="#l36.318"></a><span id="l36.318" class="difflineminus">-  onSelectionChanged() {</span>
<a href="#l36.319"></a><span id="l36.319">     // Get the selected item</span>
<a href="#l36.320"></a><span id="l36.320">     let selection = this._list.selectedItem;</span>
<a href="#l36.321"></a><span id="l36.321">     this._removeAccountButton.disabled = !selection;</span>
<a href="#l36.322"></a><span id="l36.322" class="difflineminus">-    if (!selection)</span>
<a href="#l36.323"></a><span id="l36.323" class="difflineplus">+    if (!selection) {</span>
<a href="#l36.324"></a><span id="l36.324" class="difflineplus">+      this._settingsDeck.selectedPanel = this._defaultPanel;</span>
<a href="#l36.325"></a><span id="l36.325" class="difflineplus">+      if (this._settings) {</span>
<a href="#l36.326"></a><span id="l36.326" class="difflineplus">+        this._settings.remove();</span>
<a href="#l36.327"></a><span id="l36.327" class="difflineplus">+      }</span>
<a href="#l36.328"></a><span id="l36.328">       return;</span>
<a href="#l36.329"></a><span id="l36.329" class="difflineplus">+    }</span>
<a href="#l36.330"></a><span id="l36.330"> </span>
<a href="#l36.331"></a><span id="l36.331" class="difflineminus">-    // The selection tells us the key.  We need the actual</span>
<a href="#l36.332"></a><span id="l36.332" class="difflineminus">-    // provider here.</span>
<a href="#l36.333"></a><span id="l36.333" class="difflineminus">-    let accountKey = selection.value;</span>
<a href="#l36.334"></a><span id="l36.334" class="difflineminus">-    this._showAccountInfo(accountKey);</span>
<a href="#l36.335"></a><span id="l36.335" class="difflineplus">+    this._showAccountInfo(selection.value);</span>
<a href="#l36.336"></a><span id="l36.336">   },</span>
<a href="#l36.337"></a><span id="l36.337"> </span>
<a href="#l36.338"></a><span id="l36.338">   _showAccountInfo(aAccountKey) {</span>
<a href="#l36.339"></a><span id="l36.339" class="difflineminus">-    let account = this._accountCache[aAccountKey].account;</span>
<a href="#l36.340"></a><span id="l36.340" class="difflineminus">-    let result = this._accountCache[aAccountKey].result;</span>
<a href="#l36.341"></a><span id="l36.341" class="difflineplus">+    let account = cloudFileAccounts.getAccount(aAccountKey);</span>
<a href="#l36.342"></a><span id="l36.342" class="difflineplus">+    this._settingsDeck.selectedPanel = this._settingsPanelWrap;</span>
<a href="#l36.343"></a><span id="l36.343"> </span>
<a href="#l36.344"></a><span id="l36.344" class="difflineminus">-    if (result == Cr.NS_ERROR_NOT_AVAILABLE) {</span>
<a href="#l36.345"></a><span id="l36.345" class="difflineminus">-      this._settingsDeck.selectedPanel = this._loadingPanel;</span>
<a href="#l36.346"></a><span id="l36.346" class="difflineminus">-    } else if (result == Cr.NS_OK) {</span>
<a href="#l36.347"></a><span id="l36.347" class="difflineminus">-      this._settingsDeck.selectedPanel = this._settingsPanelWrap;</span>
<a href="#l36.348"></a><span id="l36.348" class="difflineminus">-      this._showAccountManagement(account);</span>
<a href="#l36.349"></a><span id="l36.349" class="difflineminus">-    } else if (result == Ci.nsIMsgCloudFileProvider.authErr) {</span>
<a href="#l36.350"></a><span id="l36.350" class="difflineminus">-      this._settingsDeck.selectedPanel = this._authErrorPanel;</span>
<a href="#l36.351"></a><span id="l36.351" class="difflineminus">-    } else {</span>
<a href="#l36.352"></a><span id="l36.352" class="difflineminus">-      Cu.reportError(&quot;Unexpected connection error.&quot;);</span>
<a href="#l36.353"></a><span id="l36.353" class="difflineminus">-    }</span>
<a href="#l36.354"></a><span id="l36.354" class="difflineminus">-  },</span>
<a href="#l36.355"></a><span id="l36.355" class="difflineminus">-</span>
<a href="#l36.356"></a><span id="l36.356" class="difflineminus">-  _showAccountManagement(aProvider) {</span>
<a href="#l36.357"></a><span id="l36.357" class="difflineminus">-    let url = aProvider.managementURL;</span>
<a href="#l36.358"></a><span id="l36.358" class="difflineminus">-    if (url.startsWith(&quot;moz-extension:&quot;)) {</span>
<a href="#l36.359"></a><span id="l36.359" class="difflineminus">-      // Assumes there is only one account per provider.</span>
<a href="#l36.360"></a><span id="l36.360" class="difflineminus">-      let account = cloudFileAccounts.getAccountsForType(aProvider.type)[0];</span>
<a href="#l36.361"></a><span id="l36.361" class="difflineminus">-      url += `?accountId=${account.accountKey}`;</span>
<a href="#l36.362"></a><span id="l36.362" class="difflineminus">-    }</span>
<a href="#l36.363"></a><span id="l36.363" class="difflineplus">+    let url = account.managementURL + `?accountId=${account.accountKey}`;</span>
<a href="#l36.364"></a><span id="l36.364"> </span>
<a href="#l36.365"></a><span id="l36.365">     let iframe = document.createElement(&quot;iframe&quot;);</span>
<a href="#l36.366"></a><span id="l36.366">     iframe.setAttribute(&quot;flex&quot;, &quot;1&quot;);</span>
<a href="#l36.367"></a><span id="l36.367">     // allows keeping dialog background color without hoops</span>
<a href="#l36.368"></a><span id="l36.368">     iframe.setAttribute(&quot;transparent&quot;, &quot;true&quot;);</span>
<a href="#l36.369"></a><span id="l36.369"> </span>
<a href="#l36.370"></a><span id="l36.370">     let type = url.startsWith(&quot;chrome:&quot;) ? &quot;chrome&quot; : &quot;content&quot;;</span>
<a href="#l36.371"></a><span id="l36.371">     iframe.setAttribute(&quot;type&quot;, type);</span>
<a href="#l36.372"></a><span id="l36.372">     iframe.setAttribute(&quot;src&quot;, url);</span>
<a href="#l36.373"></a><span id="l36.373"> </span>
<a href="#l36.374"></a><span id="l36.374">     // If we have a past iframe, we replace it. Else append</span>
<a href="#l36.375"></a><span id="l36.375">     // to the wrapper.</span>
<a href="#l36.376"></a><span id="l36.376" class="difflineminus">-    if (this._settings)</span>
<a href="#l36.377"></a><span id="l36.377" class="difflineplus">+    if (this._settings) {</span>
<a href="#l36.378"></a><span id="l36.378">       this._settings.remove();</span>
<a href="#l36.379"></a><span id="l36.379" class="difflineplus">+    }</span>
<a href="#l36.380"></a><span id="l36.380"> </span>
<a href="#l36.381"></a><span id="l36.381">     this._settingsPanelWrap.appendChild(iframe);</span>
<a href="#l36.382"></a><span id="l36.382">     this._settings = iframe;</span>
<a href="#l36.383"></a><span id="l36.383" class="difflineminus">-</span>
<a href="#l36.384"></a><span id="l36.384" class="difflineminus">-    // When the iframe loads, populate it with the provider.</span>
<a href="#l36.385"></a><span id="l36.385" class="difflineminus">-    this._settings.contentWindow.addEventListener(&quot;load&quot;, function() {</span>
<a href="#l36.386"></a><span id="l36.386" class="difflineminus">-      try {</span>
<a href="#l36.387"></a><span id="l36.387" class="difflineminus">-        iframe.contentWindow</span>
<a href="#l36.388"></a><span id="l36.388" class="difflineminus">-              .wrappedJSObject</span>
<a href="#l36.389"></a><span id="l36.389" class="difflineminus">-              .onLoadProvider(aProvider);</span>
<a href="#l36.390"></a><span id="l36.390" class="difflineminus">-      } catch (e) {</span>
<a href="#l36.391"></a><span id="l36.391" class="difflineminus">-        Cu.reportError(e);</span>
<a href="#l36.392"></a><span id="l36.392" class="difflineminus">-      }</span>
<a href="#l36.393"></a><span id="l36.393" class="difflineminus">-    }, {capture: false, once: true});</span>
<a href="#l36.394"></a><span id="l36.394">   },</span>
<a href="#l36.395"></a><span id="l36.395"> </span>
<a href="#l36.396"></a><span id="l36.396" class="difflineminus">-  authSelected() {</span>
<a href="#l36.397"></a><span id="l36.397" class="difflineminus">-    let item = this._list.selectedItem;</span>
<a href="#l36.398"></a><span id="l36.398" class="difflineminus">-</span>
<a href="#l36.399"></a><span id="l36.399" class="difflineminus">-    if (!item)</span>
<a href="#l36.400"></a><span id="l36.400" class="difflineplus">+  addCloudFileAccount(aType) {</span>
<a href="#l36.401"></a><span id="l36.401" class="difflineplus">+    let account = cloudFileAccounts.createAccount(aType);</span>
<a href="#l36.402"></a><span id="l36.402" class="difflineplus">+    if (!account)</span>
<a href="#l36.403"></a><span id="l36.403">       return;</span>
<a href="#l36.404"></a><span id="l36.404"> </span>
<a href="#l36.405"></a><span id="l36.405" class="difflineminus">-    this.requestUserInfoForItem(item, true);</span>
<a href="#l36.406"></a><span id="l36.406" class="difflineminus">-  },</span>
<a href="#l36.407"></a><span id="l36.407" class="difflineminus">-</span>
<a href="#l36.408"></a><span id="l36.408" class="difflineminus">-  addCloudFileAccount() {</span>
<a href="#l36.409"></a><span id="l36.409" class="difflineminus">-    let accountKey = cloudFileAccounts.addAccountDialog();</span>
<a href="#l36.410"></a><span id="l36.410" class="difflineminus">-    if (!accountKey)</span>
<a href="#l36.411"></a><span id="l36.411" class="difflineminus">-      return;</span>
<a href="#l36.412"></a><span id="l36.412" class="difflineminus">-</span>
<a href="#l36.413"></a><span id="l36.413" class="difflineminus">-    this.rebuildView();</span>
<a href="#l36.414"></a><span id="l36.414" class="difflineminus">-    let newItem = this._list.querySelector(&quot;richlistitem[value='&quot; + accountKey + &quot;']&quot;);</span>
<a href="#l36.415"></a><span id="l36.415" class="difflineminus">-    this._list.selectItem(newItem);</span>
<a href="#l36.416"></a><span id="l36.416" class="difflineplus">+    let rli = this.makeRichListItemForAccount(account);</span>
<a href="#l36.417"></a><span id="l36.417" class="difflineplus">+    this._list.appendChild(rli);</span>
<a href="#l36.418"></a><span id="l36.418" class="difflineplus">+    this._list.selectItem(rli);</span>
<a href="#l36.419"></a><span id="l36.419">     this._removeAccountButton.disabled = false;</span>
<a href="#l36.420"></a><span id="l36.420">   },</span>
<a href="#l36.421"></a><span id="l36.421"> </span>
<a href="#l36.422"></a><span id="l36.422">   removeCloudFileAccount() {</span>
<a href="#l36.423"></a><span id="l36.423">     // Get the selected account key</span>
<a href="#l36.424"></a><span id="l36.424">     let selection = this._list.selectedItem;</span>
<a href="#l36.425"></a><span id="l36.425">     if (!selection)</span>
<a href="#l36.426"></a><span id="l36.426">       return;</span>
<a href="#l36.427"></a><span id="l36.427" class="difflineat">@@ -820,47 +758,93 @@ var gCloudFileTab = {</span>
<a href="#l36.428"></a><span id="l36.428">     // Does the user really want to remove this account?</span>
<a href="#l36.429"></a><span id="l36.429">     let confirmMessage = this._strings</span>
<a href="#l36.430"></a><span id="l36.430">                              .formatStringFromName(&quot;dialog_removeAccount&quot;,</span>
<a href="#l36.431"></a><span id="l36.431">                                                    [accountName], 1);</span>
<a href="#l36.432"></a><span id="l36.432"> </span>
<a href="#l36.433"></a><span id="l36.433">     if (Services.prompt.confirm(null, &quot;&quot;, confirmMessage)) {</span>
<a href="#l36.434"></a><span id="l36.434">       this._list.clearSelection();</span>
<a href="#l36.435"></a><span id="l36.435">       cloudFileAccounts.removeAccount(accountKey);</span>
<a href="#l36.436"></a><span id="l36.436" class="difflineminus">-      this.rebuildView();</span>
<a href="#l36.437"></a><span id="l36.437" class="difflineplus">+      let rli = this._list.querySelector(&quot;richlistitem[value='&quot; + accountKey + &quot;']&quot;);</span>
<a href="#l36.438"></a><span id="l36.438" class="difflineplus">+      rli.remove();</span>
<a href="#l36.439"></a><span id="l36.439">       this._settingsDeck.selectedPanel = this._defaultPanel;</span>
<a href="#l36.440"></a><span id="l36.440" class="difflineminus">-      delete this._accountCache[accountKey];</span>
<a href="#l36.441"></a><span id="l36.441" class="difflineminus">-</span>
<a href="#l36.442"></a><span id="l36.442" class="difflineminus">-      this._removeAccountButton.disabled = (this._list.selectedCount == 0);</span>
<a href="#l36.443"></a><span id="l36.443" class="difflineplus">+      if (this._settings) {</span>
<a href="#l36.444"></a><span id="l36.444" class="difflineplus">+        this._settings.remove();</span>
<a href="#l36.445"></a><span id="l36.445" class="difflineplus">+      }</span>
<a href="#l36.446"></a><span id="l36.446">     }</span>
<a href="#l36.447"></a><span id="l36.447">   },</span>
<a href="#l36.448"></a><span id="l36.448"> </span>
<a href="#l36.449"></a><span id="l36.449">   handleEvent(aEvent) {</span>
<a href="#l36.450"></a><span id="l36.450" class="difflineminus">-    if (aEvent.type == &quot;unload&quot;)</span>
<a href="#l36.451"></a><span id="l36.451" class="difflineminus">-      this.destroy();</span>
<a href="#l36.452"></a><span id="l36.452" class="difflineplus">+    switch (aEvent.type) {</span>
<a href="#l36.453"></a><span id="l36.453" class="difflineplus">+      case &quot;unload&quot;:</span>
<a href="#l36.454"></a><span id="l36.454" class="difflineplus">+        this.destroy();</span>
<a href="#l36.455"></a><span id="l36.455" class="difflineplus">+        break;</span>
<a href="#l36.456"></a><span id="l36.456" class="difflineplus">+      case &quot;click&quot;: {</span>
<a href="#l36.457"></a><span id="l36.457" class="difflineplus">+        let label = aEvent.target;</span>
<a href="#l36.458"></a><span id="l36.458" class="difflineplus">+        let item = label.parentNode;</span>
<a href="#l36.459"></a><span id="l36.459" class="difflineplus">+        let textBox = item.querySelector(&quot;textbox&quot;);</span>
<a href="#l36.460"></a><span id="l36.460" class="difflineplus">+        if (!item.selected) {</span>
<a href="#l36.461"></a><span id="l36.461" class="difflineplus">+          return;</span>
<a href="#l36.462"></a><span id="l36.462" class="difflineplus">+        }</span>
<a href="#l36.463"></a><span id="l36.463" class="difflineplus">+        label.hidden = true;</span>
<a href="#l36.464"></a><span id="l36.464" class="difflineplus">+        textBox.value = label.value;</span>
<a href="#l36.465"></a><span id="l36.465" class="difflineplus">+        textBox.hidden = false;</span>
<a href="#l36.466"></a><span id="l36.466" class="difflineplus">+        textBox.select();</span>
<a href="#l36.467"></a><span id="l36.467" class="difflineplus">+        break;</span>
<a href="#l36.468"></a><span id="l36.468" class="difflineplus">+      }</span>
<a href="#l36.469"></a><span id="l36.469" class="difflineplus">+      case &quot;blur&quot;: {</span>
<a href="#l36.470"></a><span id="l36.470" class="difflineplus">+        let textBox = aEvent.target;</span>
<a href="#l36.471"></a><span id="l36.471" class="difflineplus">+        let item = textBox.parentNode;</span>
<a href="#l36.472"></a><span id="l36.472" class="difflineplus">+        let label = item.querySelector(&quot;label&quot;);</span>
<a href="#l36.473"></a><span id="l36.473" class="difflineplus">+        cloudFileAccounts.setDisplayName(item.value, textBox.value);</span>
<a href="#l36.474"></a><span id="l36.474" class="difflineplus">+        label.value = textBox.value;</span>
<a href="#l36.475"></a><span id="l36.475" class="difflineplus">+        label.hidden = false;</span>
<a href="#l36.476"></a><span id="l36.476" class="difflineplus">+        textBox.hidden = true;</span>
<a href="#l36.477"></a><span id="l36.477" class="difflineplus">+        break;</span>
<a href="#l36.478"></a><span id="l36.478" class="difflineplus">+      }</span>
<a href="#l36.479"></a><span id="l36.479" class="difflineplus">+      case &quot;keypress&quot;: {</span>
<a href="#l36.480"></a><span id="l36.480" class="difflineplus">+        let textBox = aEvent.target;</span>
<a href="#l36.481"></a><span id="l36.481" class="difflineplus">+        let item = textBox.parentNode;</span>
<a href="#l36.482"></a><span id="l36.482" class="difflineplus">+        let label = item.querySelector(&quot;label&quot;);</span>
<a href="#l36.483"></a><span id="l36.483" class="difflineplus">+</span>
<a href="#l36.484"></a><span id="l36.484" class="difflineplus">+        if (aEvent.key == &quot;Enter&quot;) {</span>
<a href="#l36.485"></a><span id="l36.485" class="difflineplus">+          cloudFileAccounts.setDisplayName(item.value, textBox.value);</span>
<a href="#l36.486"></a><span id="l36.486" class="difflineplus">+          label.value = textBox.value;</span>
<a href="#l36.487"></a><span id="l36.487" class="difflineplus">+          label.hidden = false;</span>
<a href="#l36.488"></a><span id="l36.488" class="difflineplus">+          textBox.hidden = true;</span>
<a href="#l36.489"></a><span id="l36.489" class="difflineplus">+          gCloudFileTab._list.focus();</span>
<a href="#l36.490"></a><span id="l36.490" class="difflineplus">+</span>
<a href="#l36.491"></a><span id="l36.491" class="difflineplus">+          aEvent.preventDefault();</span>
<a href="#l36.492"></a><span id="l36.492" class="difflineplus">+        } else if (aEvent.key == &quot;Escape&quot;) {</span>
<a href="#l36.493"></a><span id="l36.493" class="difflineplus">+          textBox.value = label.value;</span>
<a href="#l36.494"></a><span id="l36.494" class="difflineplus">+          label.hidden = false;</span>
<a href="#l36.495"></a><span id="l36.495" class="difflineplus">+          textBox.hidden = true;</span>
<a href="#l36.496"></a><span id="l36.496" class="difflineplus">+          gCloudFileTab._list.focus();</span>
<a href="#l36.497"></a><span id="l36.497" class="difflineplus">+</span>
<a href="#l36.498"></a><span id="l36.498" class="difflineplus">+          aEvent.preventDefault();</span>
<a href="#l36.499"></a><span id="l36.499" class="difflineplus">+        }</span>
<a href="#l36.500"></a><span id="l36.500" class="difflineplus">+      }</span>
<a href="#l36.501"></a><span id="l36.501" class="difflineplus">+    }</span>
<a href="#l36.502"></a><span id="l36.502">   },</span>
<a href="#l36.503"></a><span id="l36.503"> </span>
<a href="#l36.504"></a><span id="l36.504">   readThreshold() {</span>
<a href="#l36.505"></a><span id="l36.505">     let pref = document.getElementById(&quot;mail.compose.big_attachments.threshold_kb&quot;);</span>
<a href="#l36.506"></a><span id="l36.506">     return pref.value / 1024;</span>
<a href="#l36.507"></a><span id="l36.507">   },</span>
<a href="#l36.508"></a><span id="l36.508"> </span>
<a href="#l36.509"></a><span id="l36.509">   writeThreshold() {</span>
<a href="#l36.510"></a><span id="l36.510">     let threshold = document.getElementById(&quot;cloudFileThreshold&quot;);</span>
<a href="#l36.511"></a><span id="l36.511">     let intValue = parseInt(threshold.value, 10);</span>
<a href="#l36.512"></a><span id="l36.512">     return isNaN(intValue) ? 0 : intValue * 1024;</span>
<a href="#l36.513"></a><span id="l36.513">   },</span>
<a href="#l36.514"></a><span id="l36.514"> </span>
<a href="#l36.515"></a><span id="l36.515">   updateThreshold() {</span>
<a href="#l36.516"></a><span id="l36.516">     document.getElementById(&quot;cloudFileThreshold&quot;).disabled =</span>
<a href="#l36.517"></a><span id="l36.517" class="difflineminus">-    !document.getElementById(&quot;enableThreshold&quot;).checked;</span>
<a href="#l36.518"></a><span id="l36.518" class="difflineplus">+      !document.getElementById(&quot;enableThreshold&quot;).checked;</span>
<a href="#l36.519"></a><span id="l36.519">   },</span>
<a href="#l36.520"></a><span id="l36.520" class="difflineminus">-</span>
<a href="#l36.521"></a><span id="l36.521" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([&quot;nsIObserver&quot;,</span>
<a href="#l36.522"></a><span id="l36.522" class="difflineminus">-                                          &quot;nsISupportsWeakReference&quot;]),</span>
<a href="#l36.523"></a><span id="l36.523"> };</span>
<a href="#l36.524"></a><span id="l36.524"> </span>
<a href="#l36.525"></a><span id="l36.525"> // -------------------</span>
<a href="#l36.526"></a><span id="l36.526"> // Prefpane Controller</span>
<a href="#l36.527"></a><span id="l36.527"> </span>
<a href="#l36.528"></a><span id="l36.528"> var gApplicationsPane = {</span>
<a href="#l36.529"></a><span id="l36.529">   // The set of types the app knows how to handle.  A hash of HandlerInfoWrapper</span>
<a href="#l36.530"></a><span id="l36.530">   // objects, indexed by type.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mail/installer/package-manifest.in</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mail/installer/package-manifest.in</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -159,30 +159,27 @@</span>
<a href="#l37.4"></a><span id="l37.4"> ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<a href="#l37.5"></a><span id="l37.5"> @RESPATH@/defaults/messenger/mailViews.dat</span>
<a href="#l37.6"></a><span id="l37.6"> @RESPATH@/defaults/profile/prefs.js</span>
<a href="#l37.7"></a><span id="l37.7"> </span>
<a href="#l37.8"></a><span id="l37.8"> @RESPATH@/isp/*</span>
<a href="#l37.9"></a><span id="l37.9"> </span>
<a href="#l37.10"></a><span id="l37.10"> @RESPATH@/components/aboutRedirector.js</span>
<a href="#l37.11"></a><span id="l37.11"> @RESPATH@/components/activityComponents.manifest</span>
<a href="#l37.12"></a><span id="l37.12" class="difflineminus">-@RESPATH@/components/cloudFileComponents.manifest</span>
<a href="#l37.13"></a><span id="l37.13"> @RESPATH@/components/folderLookupService.js</span>
<a href="#l37.14"></a><span id="l37.14"> ; interfaces.manifest doesn't get packaged because it is dynamically</span>
<a href="#l37.15"></a><span id="l37.15"> ; re-created at packaging time when linking the xpts that will actually</span>
<a href="#l37.16"></a><span id="l37.16"> ; go into the package, so the test related interfaces aren't included.</span>
<a href="#l37.17"></a><span id="l37.17"> @RESPATH@/components/mimeJSComponents.js</span>
<a href="#l37.18"></a><span id="l37.18"> @RESPATH@/components/msgMime.manifest</span>
<a href="#l37.19"></a><span id="l37.19"> @RESPATH@/components/msgAsyncPrompter.js</span>
<a href="#l37.20"></a><span id="l37.20"> @RESPATH@/components/msgBase.manifest</span>
<a href="#l37.21"></a><span id="l37.21"> @RESPATH@/components/nsActivity.js</span>
<a href="#l37.22"></a><span id="l37.22"> @RESPATH@/components/nsActivityManager.js</span>
<a href="#l37.23"></a><span id="l37.23"> @RESPATH@/components/nsActivityManagerUI.js</span>
<a href="#l37.24"></a><span id="l37.24" class="difflineminus">-@RESPATH@/components/nsHightail.js</span>
<a href="#l37.25"></a><span id="l37.25" class="difflineminus">-@RESPATH@/components/nsBox.js</span>
<a href="#l37.26"></a><span id="l37.26"> @RESPATH@/components/nsAddrbook.manifest</span>
<a href="#l37.27"></a><span id="l37.27"> @RESPATH@/components/nsMailNewsCommandLineHandler.js</span>
<a href="#l37.28"></a><span id="l37.28"> @RESPATH@/components/nsNewsAutoCompleteSearch.js</span>
<a href="#l37.29"></a><span id="l37.29"> @RESPATH@/components/nsNewsAutoCompleteSearch.manifest</span>
<a href="#l37.30"></a><span id="l37.30"> @RESPATH@/chrome/toolkit@JAREXT@</span>
<a href="#l37.31"></a><span id="l37.31"> @RESPATH@/chrome/toolkit.manifest</span>
<a href="#l37.32"></a><span id="l37.32"> @RESPATH@/chrome/comm@JAREXT@</span>
<a href="#l37.33"></a><span id="l37.33"> @RESPATH@/chrome/comm.manifest</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1">deleted file mode 100644</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/cloudfile/Box/auth.dtd</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineplus">+++ /dev/null</span>
<a href="#l38.4"></a><span id="l38.4" class="difflineat">@@ -1,6 +0,0 @@</span>
<a href="#l38.5"></a><span id="l38.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l38.6"></a><span id="l38.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l38.7"></a><span id="l38.7" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l38.8"></a><span id="l38.8" class="difflineminus">-</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineminus">-&lt;!-- Note to localizers, Box is a brand from box.com --&gt;</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineminus">-&lt;!ENTITY auth.title   &quot;Box Authentication&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/cloudfile/Box/management.dtd</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/cloudfile/Box/management.dtd</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -1,5 +1,6 @@</span>
<a href="#l39.4"></a><span id="l39.4"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l39.5"></a><span id="l39.5">    - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l39.6"></a><span id="l39.6">    - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l39.7"></a><span id="l39.7"> </span>
<a href="#l39.8"></a><span id="l39.8" class="difflineplus">+&lt;!ENTITY boxMgmt.doAuth &quot;Connect your Box account…&quot;&gt;</span>
<a href="#l39.9"></a><span id="l39.9"> &lt;!ENTITY boxMgmt.viewSettings &quot;View my account settings on box.com&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1">deleted file mode 100644</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/cloudfile/Box/settings.dtd</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineplus">+++ /dev/null</span>
<a href="#l40.4"></a><span id="l40.4" class="difflineat">@@ -1,6 +0,0 @@</span>
<a href="#l40.5"></a><span id="l40.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l40.6"></a><span id="l40.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l40.7"></a><span id="l40.7" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l40.8"></a><span id="l40.8" class="difflineminus">-</span>
<a href="#l40.9"></a><span id="l40.9" class="difflineminus">-&lt;!-- Note to localizers, Box is a brand from box.com --&gt;</span>
<a href="#l40.10"></a><span id="l40.10" class="difflineminus">-&lt;!ENTITY boxSettings.needAnAccount &quot;Get a Box account…&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/management.dtd</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/management.dtd</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -1,4 +1,5 @@</span>
<a href="#l41.4"></a><span id="l41.4"> &lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l41.5"></a><span id="l41.5">    - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l41.6"></a><span id="l41.6">    - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l41.7"></a><span id="l41.7" class="difflineplus">+&lt;!ENTITY hightailMgmt.doAuth &quot;Connect your Hightail account…&quot;&gt;</span>
<a href="#l41.8"></a><span id="l41.8"> &lt;!ENTITY hightailMgmt.viewSettings &quot;View my account settings on hightail.com&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1">deleted file mode 100644</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/cloudfile/Hightail/settings.dtd</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineplus">+++ /dev/null</span>
<a href="#l42.4"></a><span id="l42.4" class="difflineat">@@ -1,6 +0,0 @@</span>
<a href="#l42.5"></a><span id="l42.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l42.6"></a><span id="l42.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l42.7"></a><span id="l42.7" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l42.8"></a><span id="l42.8" class="difflineminus">-&lt;!ENTITY hightailSettings.username &quot;Username:&quot;&gt;</span>
<a href="#l42.9"></a><span id="l42.9" class="difflineminus">-&lt;!ENTITY hightailSettings.needAnAccount &quot;Need an account?&quot;&gt;</span>
<a href="#l42.10"></a><span id="l42.10" class="difflineminus">-&lt;!ENTITY hightailSettings.learnMore &quot;Learn more…&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1">deleted file mode 100644</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/cloudfile/addAccountDialog.dtd</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineplus">+++ /dev/null</span>
<a href="#l43.4"></a><span id="l43.4" class="difflineat">@@ -1,13 +0,0 @@</span>
<a href="#l43.5"></a><span id="l43.5" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l43.6"></a><span id="l43.6" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l43.7"></a><span id="l43.7" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l43.8"></a><span id="l43.8" class="difflineminus">-&lt;!ENTITY addAccountDialog.title   &quot;Set up Filelink&quot;&gt;</span>
<a href="#l43.9"></a><span id="l43.9" class="difflineminus">-&lt;!ENTITY addAccountDialog.menuTitle &quot;Select an online storage service&quot;&gt;</span>
<a href="#l43.10"></a><span id="l43.10" class="difflineminus">-&lt;!ENTITY addAccountDialog.style &quot;width: 40em; min-height: 20em;&quot;&gt;</span>
<a href="#l43.11"></a><span id="l43.11" class="difflineminus">-&lt;!ENTITY addAccountDialog.accountName.label &quot;Account Name:&quot;&gt;</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-&lt;!ENTITY addAccountDialog.noAccountText &quot;We're sorry, but the current version of &amp;brandShortName; only allows one account from each online storage service.&quot;&gt;</span>
<a href="#l43.13"></a><span id="l43.13" class="difflineminus">-&lt;!ENTITY addAccountDialog.createAccountText2 &quot;You can send large attachments using one of several online storage services. Please either set up an existing account, or sign up for a new account.&quot;&gt;</span>
<a href="#l43.14"></a><span id="l43.14" class="difflineminus">-&lt;!ENTITY addAccountDialog.authorizing &quot;Checking authorization...&quot;&gt;</span>
<a href="#l43.15"></a><span id="l43.15" class="difflineminus">-&lt;!ENTITY addAccountDialog.error &quot;An error occurred while setting up the account!&quot;&gt;</span>
<a href="#l43.16"></a><span id="l43.16" class="difflineminus">-&lt;!ENTITY addAccountDialog.acceptButton.label &quot;Set up Account&quot;&gt;</span>
<a href="#l43.17"></a><span id="l43.17" class="difflineminus">-&lt;!ENTITY addAccountDialog.learnMore &quot;Learn more…&quot;&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mail/locales/en-US/chrome/messenger/preferences/applications.properties</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mail/locales/en-US/chrome/messenger/preferences/applications.properties</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -1,7 +1,13 @@</span>
<a href="#l44.4"></a><span id="l44.4"> # This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l44.5"></a><span id="l44.5"> # License, v. 2.0. If a copy of the MPL was not distributed with this</span>
<a href="#l44.6"></a><span id="l44.6"> # file, You can obtain one at http://mozilla.org/MPL/2.0/.</span>
<a href="#l44.7"></a><span id="l44.7"> </span>
<a href="#l44.8"></a><span id="l44.8"> # LOCALIZATION NOTE (dialog_removeAccount):</span>
<a href="#l44.9"></a><span id="l44.9"> # %S will be replaced with the user-defined name of a storage account.</span>
<a href="#l44.10"></a><span id="l44.10"> dialog_removeAccount=Are you sure you want to remove the account &quot;%S&quot;?</span>
<a href="#l44.11"></a><span id="l44.11" class="difflineplus">+</span>
<a href="#l44.12"></a><span id="l44.12" class="difflineplus">+# LOCALIZATION NOTE (addProvider):</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+# %S will be replace with the display name of a provider, e.g. DropBox</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+addProvider=Add %S</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+notConfiguredYet=This account has not been configured yet</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mail/locales/jar.mn</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mail/locales/jar.mn</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -139,26 +139,22 @@</span>
<a href="#l45.4"></a><span id="l45.4">   locale/@AB_CD@/messenger/addressbook/abCard.dtd                       (%chrome/messenger/addressbook/abCard.dtd)</span>
<a href="#l45.5"></a><span id="l45.5">   locale/@AB_CD@/messenger/addressbook/abResultsPane.dtd                (%chrome/messenger/addressbook/abResultsPane.dtd)</span>
<a href="#l45.6"></a><span id="l45.6">   locale/@AB_CD@/messenger/addressbook/abMailListDialog.dtd             (%chrome/messenger/addressbook/abMailListDialog.dtd)</span>
<a href="#l45.7"></a><span id="l45.7">   locale/@AB_CD@/messenger/addressbook/addressBook.properties           (%chrome/messenger/addressbook/addressBook.properties)</span>
<a href="#l45.8"></a><span id="l45.8">   locale/@AB_CD@/messenger/addressbook/ldapAutoCompErrs.properties      (%chrome/messenger/addressbook/ldapAutoCompErrs.properties)</span>
<a href="#l45.9"></a><span id="l45.9">   locale/@AB_CD@/messenger/addressbook/pref-directory.dtd               (%chrome/messenger/addressbook/pref-directory.dtd)</span>
<a href="#l45.10"></a><span id="l45.10">   locale/@AB_CD@/messenger/addressbook/pref-directory-add.dtd           (%chrome/messenger/addressbook/pref-directory-add.dtd)</span>
<a href="#l45.11"></a><span id="l45.11">   locale/@AB_CD@/messenger/addressbook/replicationProgress.properties   (%chrome/messenger/addressbook/replicationProgress.properties)</span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-  locale/@AB_CD@/messenger/cloudfile/addAccountDialog.dtd               (%chrome/messenger/cloudfile/addAccountDialog.dtd)</span>
<a href="#l45.13"></a><span id="l45.13">   locale/@AB_CD@/messenger/cloudfile/management.dtd                     (%chrome/messenger/cloudfile/management.dtd)</span>
<a href="#l45.14"></a><span id="l45.14">   locale/@AB_CD@/messenger/cloudfile/Hightail/management.dtd           (%chrome/messenger/cloudfile/Hightail/management.dtd)</span>
<a href="#l45.15"></a><span id="l45.15" class="difflineminus">-  locale/@AB_CD@/messenger/cloudfile/Hightail/settings.dtd             (%chrome/messenger/cloudfile/Hightail/settings.dtd)</span>
<a href="#l45.16"></a><span id="l45.16">   locale/@AB_CD@/messenger/cloudfile/Hightail/fileExceedsLimit.dtd     (%chrome/messenger/cloudfile/Hightail/fileExceedsLimit.dtd)</span>
<a href="#l45.17"></a><span id="l45.17">   locale/@AB_CD@/messenger/cloudfile/Hightail/fileExceedsQuota.dtd     (%chrome/messenger/cloudfile/Hightail/fileExceedsQuota.dtd)</span>
<a href="#l45.18"></a><span id="l45.18">   locale/@AB_CD@/messenger/cloudfile/Hightail/fileExceeds2GB.dtd       (%chrome/messenger/cloudfile/Hightail/fileExceeds2GB.dtd)</span>
<a href="#l45.19"></a><span id="l45.19" class="difflineminus">-  locale/@AB_CD@/messenger/cloudfile/Box/settings.dtd                   (%chrome/messenger/cloudfile/Box/settings.dtd)</span>
<a href="#l45.20"></a><span id="l45.20">   locale/@AB_CD@/messenger/cloudfile/Box/management.dtd                 (%chrome/messenger/cloudfile/Box/management.dtd)</span>
<a href="#l45.21"></a><span id="l45.21" class="difflineminus">-  locale/@AB_CD@/messenger/cloudfile/Box/auth.dtd                       (%chrome/messenger/cloudfile/Box/auth.dtd)</span>
<a href="#l45.22"></a><span id="l45.22">   locale/@AB_CD@/messenger/messengercompose/messengercompose.dtd        (%chrome/messenger/messengercompose/messengercompose.dtd)</span>
<a href="#l45.23"></a><span id="l45.23">   locale/@AB_CD@/messenger/messengercompose/addressingWidgetOverlay.dtd (%chrome/messenger/messengercompose/addressingWidgetOverlay.dtd)</span>
<a href="#l45.24"></a><span id="l45.24">   locale/@AB_CD@/messenger/messengercompose/askSendFormat.dtd           (%chrome/messenger/messengercompose/askSendFormat.dtd)</span>
<a href="#l45.25"></a><span id="l45.25">   locale/@AB_CD@/messenger/messengercompose/askSendFormat.properties    (%chrome/messenger/messengercompose/askSendFormat.properties)</span>
<a href="#l45.26"></a><span id="l45.26">   locale/@AB_CD@/messenger/messengercompose/sendProgress.dtd            (%chrome/messenger/messengercompose/sendProgress.dtd)</span>
<a href="#l45.27"></a><span id="l45.27">   locale/@AB_CD@/messenger/messengercompose/sendProgress.properties     (%chrome/messenger/messengercompose/sendProgress.properties)</span>
<a href="#l45.28"></a><span id="l45.28">   locale/@AB_CD@/messenger/messengercompose/composeMsgs.properties      (%chrome/messenger/messengercompose/composeMsgs.properties)</span>
<a href="#l45.29"></a><span id="l45.29">   locale/@AB_CD@/messenger/messengercompose/mailComposeEditorOverlay.dtd (%chrome/messenger/messengercompose/mailComposeEditorOverlay.dtd)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1">deleted file mode 100644</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineminus">--- a/mail/test/mozmill/cloudfile/html/settings-with-form.xhtml</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineplus">+++ /dev/null</span>
<a href="#l46.4"></a><span id="l46.4" class="difflineat">@@ -1,12 +0,0 @@</span>
<a href="#l46.5"></a><span id="l46.5" class="difflineminus">-&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<a href="#l46.6"></a><span id="l46.6" class="difflineminus">-&lt;!-- This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l46.7"></a><span id="l46.7" class="difflineminus">-   - License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l46.8"></a><span id="l46.8" class="difflineminus">-   - You can obtain one at http://mozilla.org/MPL/2.0/.  --&gt;</span>
<a href="#l46.9"></a><span id="l46.9" class="difflineminus">-&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</span>
<a href="#l46.10"></a><span id="l46.10" class="difflineminus">-  &lt;body id=&quot;provider-settings&quot;&gt;</span>
<a href="#l46.11"></a><span id="l46.11" class="difflineminus">-    &lt;form id=&quot;provider-form&quot; onsubmit=&quot;return false;&quot;&gt;</span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-      &lt;label for=&quot;username&quot;&gt;Username&lt;/label&gt;</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineminus">-      &lt;input id=&quot;username&quot; type=&quot;text&quot; required=&quot;true&quot;/&gt;</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineminus">-    &lt;/form&gt;</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineminus">-  &lt;/body&gt;</span>
<a href="#l46.16"></a><span id="l46.16" class="difflineminus">-&lt;/html&gt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1">deleted file mode 100644</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-add-account-dialog.js</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineplus">+++ /dev/null</span>
<a href="#l47.4"></a><span id="l47.4" class="difflineat">@@ -1,218 +0,0 @@</span>
<a href="#l47.5"></a><span id="l47.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l47.6"></a><span id="l47.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l47.7"></a><span id="l47.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l47.8"></a><span id="l47.8" class="difflineminus">-</span>
<a href="#l47.9"></a><span id="l47.9" class="difflineminus">-/**</span>
<a href="#l47.10"></a><span id="l47.10" class="difflineminus">- * Tests the 'Set up a Filelink Account' dialog</span>
<a href="#l47.11"></a><span id="l47.11" class="difflineminus">- */</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineminus">-&quot;use strict&quot;;</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineminus">-</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineminus">-var MODULE_NAME = 'test-cloudfile-add-account-dialog';</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineminus">-</span>
<a href="#l47.17"></a><span id="l47.17" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l47.18"></a><span id="l47.18" class="difflineminus">-var MODULE_REQUIRES = ['cloudfile-helpers',</span>
<a href="#l47.19"></a><span id="l47.19" class="difflineminus">-                         'dom-helpers',</span>
<a href="#l47.20"></a><span id="l47.20" class="difflineminus">-                         'folder-display-helpers',</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineminus">-                         'keyboard-helpers',</span>
<a href="#l47.22"></a><span id="l47.22" class="difflineminus">-                         'window-helpers'];</span>
<a href="#l47.23"></a><span id="l47.23" class="difflineminus">-</span>
<a href="#l47.24"></a><span id="l47.24" class="difflineminus">-var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l47.25"></a><span id="l47.25" class="difflineminus">-var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l47.26"></a><span id="l47.26" class="difflineminus">-</span>
<a href="#l47.27"></a><span id="l47.27" class="difflineminus">-var kCategory = 'cloud-files';</span>
<a href="#l47.28"></a><span id="l47.28" class="difflineminus">-var kDialogId = 'addCloudFileAccount';</span>
<a href="#l47.29"></a><span id="l47.29" class="difflineminus">-var kRootURL = collector.addHttpResource('../cloudfile/html', '');</span>
<a href="#l47.30"></a><span id="l47.30" class="difflineminus">-var kSettingsWithForm = kRootURL + 'settings-with-form.xhtml';</span>
<a href="#l47.31"></a><span id="l47.31" class="difflineminus">-</span>
<a href="#l47.32"></a><span id="l47.32" class="difflineminus">-var gOldProviders = {};</span>
<a href="#l47.33"></a><span id="l47.33" class="difflineminus">-var gOldWeTransferProvider = null;</span>
<a href="#l47.34"></a><span id="l47.34" class="difflineminus">-</span>
<a href="#l47.35"></a><span id="l47.35" class="difflineminus">-function setupModule(module) {</span>
<a href="#l47.36"></a><span id="l47.36" class="difflineminus">-  for (let lib of MODULE_REQUIRES) {</span>
<a href="#l47.37"></a><span id="l47.37" class="difflineminus">-    collector.getModule(lib).installInto(module);</span>
<a href="#l47.38"></a><span id="l47.38" class="difflineminus">-  }</span>
<a href="#l47.39"></a><span id="l47.39" class="difflineminus">-</span>
<a href="#l47.40"></a><span id="l47.40" class="difflineminus">-  // Save the old providers...</span>
<a href="#l47.41"></a><span id="l47.41" class="difflineminus">-  for (let entry of Services.catMan.enumerateCategory(kCategory)) {</span>
<a href="#l47.42"></a><span id="l47.42" class="difflineminus">-    let value = Services.catMan.getCategoryEntry(kCategory, entry.data);</span>
<a href="#l47.43"></a><span id="l47.43" class="difflineminus">-    gOldProviders[entry] = value;</span>
<a href="#l47.44"></a><span id="l47.44" class="difflineminus">-  }</span>
<a href="#l47.45"></a><span id="l47.45" class="difflineminus">-</span>
<a href="#l47.46"></a><span id="l47.46" class="difflineminus">-  // Clear out the old entries</span>
<a href="#l47.47"></a><span id="l47.47" class="difflineminus">-  Services.catMan.deleteCategory(kCategory);</span>
<a href="#l47.48"></a><span id="l47.48" class="difflineminus">-  gOldWeTransferProvider = cloudFileAccounts.getProviderForType(</span>
<a href="#l47.49"></a><span id="l47.49" class="difflineminus">-    &quot;ext-wetransfer@extensions.thunderbird.net&quot;</span>
<a href="#l47.50"></a><span id="l47.50" class="difflineminus">-  );</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineminus">-  cloudFileAccounts.unregisterProvider(gOldWeTransferProvider.type);</span>
<a href="#l47.52"></a><span id="l47.52" class="difflineminus">-}</span>
<a href="#l47.53"></a><span id="l47.53" class="difflineminus">-</span>
<a href="#l47.54"></a><span id="l47.54" class="difflineminus">-function teardownModule(module) {</span>
<a href="#l47.55"></a><span id="l47.55" class="difflineminus">-  // Clear out any leftover entries.</span>
<a href="#l47.56"></a><span id="l47.56" class="difflineminus">-  Services.catMan.deleteCategory(kCategory);</span>
<a href="#l47.57"></a><span id="l47.57" class="difflineminus">-</span>
<a href="#l47.58"></a><span id="l47.58" class="difflineminus">-  // Put the old entries back</span>
<a href="#l47.59"></a><span id="l47.59" class="difflineminus">-  for (let [key, value] of Object.entries(gOldProviders))</span>
<a href="#l47.60"></a><span id="l47.60" class="difflineminus">-    Services.catMan.addCategoryEntry(kCategory, key, value, false, true);</span>
<a href="#l47.61"></a><span id="l47.61" class="difflineminus">-  cloudFileAccounts.registerProvider(gOldWeTransferProvider);</span>
<a href="#l47.62"></a><span id="l47.62" class="difflineminus">-}</span>
<a href="#l47.63"></a><span id="l47.63" class="difflineminus">-</span>
<a href="#l47.64"></a><span id="l47.64" class="difflineminus">-/**</span>
<a href="#l47.65"></a><span id="l47.65" class="difflineminus">- * Helper function that ensures that we know the number of registered</span>
<a href="#l47.66"></a><span id="l47.66" class="difflineminus">- * Filelink service providers.</span>
<a href="#l47.67"></a><span id="l47.67" class="difflineminus">- *</span>
<a href="#l47.68"></a><span id="l47.68" class="difflineminus">- * @param aNum the number of expected registered Filelink service providers.</span>
<a href="#l47.69"></a><span id="l47.69" class="difflineminus">- */</span>
<a href="#l47.70"></a><span id="l47.70" class="difflineminus">-function assert_num_providers(aNum) {</span>
<a href="#l47.71"></a><span id="l47.71" class="difflineminus">-  let providers = Array.from(cloudFileAccounts.enumerateProviders());</span>
<a href="#l47.72"></a><span id="l47.72" class="difflineminus">-  assert_equals(aNum, providers.length,</span>
<a href="#l47.73"></a><span id="l47.73" class="difflineminus">-                'Expected ' + aNum + ' providers to be available, but ' +</span>
<a href="#l47.74"></a><span id="l47.74" class="difflineminus">-                'found ' + providers.length + ' instead.');</span>
<a href="#l47.75"></a><span id="l47.75" class="difflineminus">-}</span>
<a href="#l47.76"></a><span id="l47.76" class="difflineminus">-</span>
<a href="#l47.77"></a><span id="l47.77" class="difflineminus">-/**</span>
<a href="#l47.78"></a><span id="l47.78" class="difflineminus">- * Helper function that takes a controller for an 'Add an Account' dialog, and</span>
<a href="#l47.79"></a><span id="l47.79" class="difflineminus">- * returns the 'Set up Account' button.</span>
<a href="#l47.80"></a><span id="l47.80" class="difflineminus">- *</span>
<a href="#l47.81"></a><span id="l47.81" class="difflineminus">- * @param aController a controller for an 'Add an Account' dialog.</span>
<a href="#l47.82"></a><span id="l47.82" class="difflineminus">- */</span>
<a href="#l47.83"></a><span id="l47.83" class="difflineminus">-function get_accept_button(aController) {</span>
<a href="#l47.84"></a><span id="l47.84" class="difflineminus">-  return aController.window</span>
<a href="#l47.85"></a><span id="l47.85" class="difflineminus">-                    .document</span>
<a href="#l47.86"></a><span id="l47.86" class="difflineminus">-                    .documentElement</span>
<a href="#l47.87"></a><span id="l47.87" class="difflineminus">-                    .getButton('accept');</span>
<a href="#l47.88"></a><span id="l47.88" class="difflineminus">-}</span>
<a href="#l47.89"></a><span id="l47.89" class="difflineminus">-</span>
<a href="#l47.90"></a><span id="l47.90" class="difflineminus">-/**</span>
<a href="#l47.91"></a><span id="l47.91" class="difflineminus">- * Helper function that waits for the contents of the Filelink provider</span>
<a href="#l47.92"></a><span id="l47.92" class="difflineminus">- * settings IFrame to be fully loaded.</span>
<a href="#l47.93"></a><span id="l47.93" class="difflineminus">- *</span>
<a href="#l47.94"></a><span id="l47.94" class="difflineminus">- * @param aController a controller for an 'Add an Account' dialog</span>
<a href="#l47.95"></a><span id="l47.95" class="difflineminus">- * @param aURL the expected URL for the IFrame to load.</span>
<a href="#l47.96"></a><span id="l47.96" class="difflineminus">- */</span>
<a href="#l47.97"></a><span id="l47.97" class="difflineminus">-function wait_for_settings_loaded(aController, aURL) {</span>
<a href="#l47.98"></a><span id="l47.98" class="difflineminus">-  // Mozmill chokes horribly here, so don't look directly into the iframe.</span>
<a href="#l47.99"></a><span id="l47.99" class="difflineminus">-  aController.waitFor(() =&gt; {</span>
<a href="#l47.100"></a><span id="l47.100" class="difflineminus">-    return aController.e(&quot;accountType&quot;).nextElementSibling.src == aURL;</span>
<a href="#l47.101"></a><span id="l47.101" class="difflineminus">-  });</span>
<a href="#l47.102"></a><span id="l47.102" class="difflineminus">-}</span>
<a href="#l47.103"></a><span id="l47.103" class="difflineminus">-</span>
<a href="#l47.104"></a><span id="l47.104" class="difflineminus">-/**</span>
<a href="#l47.105"></a><span id="l47.105" class="difflineminus">- * Test that when the dialog first spawns, and the 'Select an account type'</span>
<a href="#l47.106"></a><span id="l47.106" class="difflineminus">- * menuitem is selected, that the accept button is disabled.</span>
<a href="#l47.107"></a><span id="l47.107" class="difflineminus">- */</span>
<a href="#l47.108"></a><span id="l47.108" class="difflineminus">-function test_accept_disabled_by_default() {</span>
<a href="#l47.109"></a><span id="l47.109" class="difflineminus">-  gMockCloudfileManager.register('service1');</span>
<a href="#l47.110"></a><span id="l47.110" class="difflineminus">-  gMockCloudfileManager.register('service2');</span>
<a href="#l47.111"></a><span id="l47.111" class="difflineminus">-</span>
<a href="#l47.112"></a><span id="l47.112" class="difflineminus">-  assert_num_providers(2);</span>
<a href="#l47.113"></a><span id="l47.113" class="difflineminus">-  plan_for_modal_dialog(kDialogId, subtest_accept_disabled_by_default);</span>
<a href="#l47.114"></a><span id="l47.114" class="difflineminus">-  cloudFileAccounts.addAccountDialog();</span>
<a href="#l47.115"></a><span id="l47.115" class="difflineminus">-  wait_for_modal_dialog(kDialogId);</span>
<a href="#l47.116"></a><span id="l47.116" class="difflineminus">-</span>
<a href="#l47.117"></a><span id="l47.117" class="difflineminus">-  gMockCloudfileManager.unregister('service1');</span>
<a href="#l47.118"></a><span id="l47.118" class="difflineminus">-  gMockCloudfileManager.unregister('service2');</span>
<a href="#l47.119"></a><span id="l47.119" class="difflineminus">-}</span>
<a href="#l47.120"></a><span id="l47.120" class="difflineminus">-</span>
<a href="#l47.121"></a><span id="l47.121" class="difflineminus">-function subtest_accept_disabled_by_default(aController) {</span>
<a href="#l47.122"></a><span id="l47.122" class="difflineminus">-  wait_for_element_enabled(aController, get_accept_button(aController),</span>
<a href="#l47.123"></a><span id="l47.123" class="difflineminus">-                           false);</span>
<a href="#l47.124"></a><span id="l47.124" class="difflineminus">-  close_window(aController);</span>
<a href="#l47.125"></a><span id="l47.125" class="difflineminus">-}</span>
<a href="#l47.126"></a><span id="l47.126" class="difflineminus">-</span>
<a href="#l47.127"></a><span id="l47.127" class="difflineminus">-/**</span>
<a href="#l47.128"></a><span id="l47.128" class="difflineminus">- * Test that if the dialog spawns and there are no services available,</span>
<a href="#l47.129"></a><span id="l47.129" class="difflineminus">- * then the 'sorry' text is displayed, and the accept button is disabled.</span>
<a href="#l47.130"></a><span id="l47.130" class="difflineminus">- */</span>
<a href="#l47.131"></a><span id="l47.131" class="difflineminus">-function test_accept_disabled_if_no_services() {</span>
<a href="#l47.132"></a><span id="l47.132" class="difflineminus">-  assert_num_providers(0);</span>
<a href="#l47.133"></a><span id="l47.133" class="difflineminus">-  plan_for_modal_dialog(kDialogId, subtest_accept_disabled_if_no_services);</span>
<a href="#l47.134"></a><span id="l47.134" class="difflineminus">-  cloudFileAccounts.addAccountDialog();</span>
<a href="#l47.135"></a><span id="l47.135" class="difflineminus">-  wait_for_modal_dialog(kDialogId);</span>
<a href="#l47.136"></a><span id="l47.136" class="difflineminus">-}</span>
<a href="#l47.137"></a><span id="l47.137" class="difflineminus">-</span>
<a href="#l47.138"></a><span id="l47.138" class="difflineminus">-/**</span>
<a href="#l47.139"></a><span id="l47.139" class="difflineminus">- * Subtest for test_accept_disabled_if_no_services that ensures that the</span>
<a href="#l47.140"></a><span id="l47.140" class="difflineminus">- * 'Set up Account' button is disabled, the account type menulist is</span>
<a href="#l47.141"></a><span id="l47.141" class="difflineminus">- * not visible, and the 'sorry - can't add more than one account per type'</span>
<a href="#l47.142"></a><span id="l47.142" class="difflineminus">- * is displayed.</span>
<a href="#l47.143"></a><span id="l47.143" class="difflineminus">- */</span>
<a href="#l47.144"></a><span id="l47.144" class="difflineminus">-function subtest_accept_disabled_if_no_services(aController) {</span>
<a href="#l47.145"></a><span id="l47.145" class="difflineminus">-  wait_for_element_enabled(aController, get_accept_button(aController),</span>
<a href="#l47.146"></a><span id="l47.146" class="difflineminus">-                           false);</span>
<a href="#l47.147"></a><span id="l47.147" class="difflineminus">-  assert_element_not_visible(aController.eid('accountType'),</span>
<a href="#l47.148"></a><span id="l47.148" class="difflineminus">-                             'Account type selector should be invisible.');</span>
<a href="#l47.149"></a><span id="l47.149" class="difflineminus">-  assert_element_visible(aController.eid('noAccountText'),</span>
<a href="#l47.150"></a><span id="l47.150" class="difflineminus">-                         'Should be displaying the &quot;sorry, you can only ' +</span>
<a href="#l47.151"></a><span id="l47.151" class="difflineminus">-                         'add one account for now&quot; text.');</span>
<a href="#l47.152"></a><span id="l47.152" class="difflineminus">-  close_window(aController);</span>
<a href="#l47.153"></a><span id="l47.153" class="difflineminus">-}</span>
<a href="#l47.154"></a><span id="l47.154" class="difflineminus">-</span>
<a href="#l47.155"></a><span id="l47.155" class="difflineminus">-/**</span>
<a href="#l47.156"></a><span id="l47.156" class="difflineminus">- * Test that if only a single provider is available to be added, that we</span>
<a href="#l47.157"></a><span id="l47.157" class="difflineminus">- * select it immediately.</span>
<a href="#l47.158"></a><span id="l47.158" class="difflineminus">- */</span>
<a href="#l47.159"></a><span id="l47.159" class="difflineminus">-function test_lone_provider_auto_selected() {</span>
<a href="#l47.160"></a><span id="l47.160" class="difflineminus">-  gMockCloudfileManager.register('lone-service');</span>
<a href="#l47.161"></a><span id="l47.161" class="difflineminus">-  assert_num_providers(1);</span>
<a href="#l47.162"></a><span id="l47.162" class="difflineminus">-</span>
<a href="#l47.163"></a><span id="l47.163" class="difflineminus">-  plan_for_modal_dialog(kDialogId, subtest_lone_provider_auto_selected);</span>
<a href="#l47.164"></a><span id="l47.164" class="difflineminus">-  cloudFileAccounts.addAccountDialog();</span>
<a href="#l47.165"></a><span id="l47.165" class="difflineminus">-  wait_for_modal_dialog(kDialogId);</span>
<a href="#l47.166"></a><span id="l47.166" class="difflineminus">-</span>
<a href="#l47.167"></a><span id="l47.167" class="difflineminus">-  gMockCloudfileManager.unregister('lone-service');</span>
<a href="#l47.168"></a><span id="l47.168" class="difflineminus">-}</span>
<a href="#l47.169"></a><span id="l47.169" class="difflineminus">-</span>
<a href="#l47.170"></a><span id="l47.170" class="difflineminus">-/**</span>
<a href="#l47.171"></a><span id="l47.171" class="difflineminus">- * Subtest for test_lone_provider_auto_selected, ensures that the lone provider</span>
<a href="#l47.172"></a><span id="l47.172" class="difflineminus">- * has been selected in the menulist.  For a bonus, because by default the</span>
<a href="#l47.173"></a><span id="l47.173" class="difflineminus">- * settings form for the mock provider 'validates', we also check to make sure</span>
<a href="#l47.174"></a><span id="l47.174" class="difflineminus">- * that the 'Set up Account' button is enabled.</span>
<a href="#l47.175"></a><span id="l47.175" class="difflineminus">- */</span>
<a href="#l47.176"></a><span id="l47.176" class="difflineminus">-function subtest_lone_provider_auto_selected(aController) {</span>
<a href="#l47.177"></a><span id="l47.177" class="difflineminus">-  let menulist = aController.e('accountType');</span>
<a href="#l47.178"></a><span id="l47.178" class="difflineminus">-  assert_equals(0, menulist.selectedIndex);</span>
<a href="#l47.179"></a><span id="l47.179" class="difflineminus">-  wait_for_element_enabled(aController, get_accept_button(aController),</span>
<a href="#l47.180"></a><span id="l47.180" class="difflineminus">-                           true);</span>
<a href="#l47.181"></a><span id="l47.181" class="difflineminus">-}</span>
<a href="#l47.182"></a><span id="l47.182" class="difflineminus">-</span>
<a href="#l47.183"></a><span id="l47.183" class="difflineminus">-/**</span>
<a href="#l47.184"></a><span id="l47.184" class="difflineminus">- * Test that if a provider has a settings form, that the 'Set up Account'</span>
<a href="#l47.185"></a><span id="l47.185" class="difflineminus">- * button does not become enabled until the form passes validation.</span>
<a href="#l47.186"></a><span id="l47.186" class="difflineminus">- */</span>
<a href="#l47.187"></a><span id="l47.187" class="difflineminus">-function test_accept_enabled_on_form_validation() {</span>
<a href="#l47.188"></a><span id="l47.188" class="difflineminus">-  // settings-with-form.xhtml has a form with a single text input. The form</span>
<a href="#l47.189"></a><span id="l47.189" class="difflineminus">-  // requires that there be something in the text input before it passes</span>
<a href="#l47.190"></a><span id="l47.190" class="difflineminus">-  // validation.</span>
<a href="#l47.191"></a><span id="l47.191" class="difflineminus">-  gMockCloudfileManager.register('service-with-form', {</span>
<a href="#l47.192"></a><span id="l47.192" class="difflineminus">-    settingsURL: kSettingsWithForm,</span>
<a href="#l47.193"></a><span id="l47.193" class="difflineminus">-  });</span>
<a href="#l47.194"></a><span id="l47.194" class="difflineminus">-</span>
<a href="#l47.195"></a><span id="l47.195" class="difflineminus">-  assert_num_providers(1);</span>
<a href="#l47.196"></a><span id="l47.196" class="difflineminus">-</span>
<a href="#l47.197"></a><span id="l47.197" class="difflineminus">-  plan_for_modal_dialog(kDialogId,</span>
<a href="#l47.198"></a><span id="l47.198" class="difflineminus">-                        subtest_accept_enabled_on_form_validation);</span>
<a href="#l47.199"></a><span id="l47.199" class="difflineminus">-  cloudFileAccounts.addAccountDialog();</span>
<a href="#l47.200"></a><span id="l47.200" class="difflineminus">-  wait_for_modal_dialog(kDialogId);</span>
<a href="#l47.201"></a><span id="l47.201" class="difflineminus">-</span>
<a href="#l47.202"></a><span id="l47.202" class="difflineminus">-  gMockCloudfileManager.unregister('service-with-form');</span>
<a href="#l47.203"></a><span id="l47.203" class="difflineminus">-}</span>
<a href="#l47.204"></a><span id="l47.204" class="difflineminus">-</span>
<a href="#l47.205"></a><span id="l47.205" class="difflineminus">-/**</span>
<a href="#l47.206"></a><span id="l47.206" class="difflineminus">- * Subtest for test_accept_enabled_on_form_validation. Waits for the settings</span>
<a href="#l47.207"></a><span id="l47.207" class="difflineminus">- * XHTML page to be loaded, and then ensures that when we type into the lone</span>
<a href="#l47.208"></a><span id="l47.208" class="difflineminus">- * input, that the 'Set up Account' button becomes enabled.</span>
<a href="#l47.209"></a><span id="l47.209" class="difflineminus">- */</span>
<a href="#l47.210"></a><span id="l47.210" class="difflineminus">-function subtest_accept_enabled_on_form_validation(aController) {</span>
<a href="#l47.211"></a><span id="l47.211" class="difflineminus">-  // The button should start disabled.</span>
<a href="#l47.212"></a><span id="l47.212" class="difflineminus">-  wait_for_element_enabled(aController, get_accept_button(aController),</span>
<a href="#l47.213"></a><span id="l47.213" class="difflineminus">-                           false);</span>
<a href="#l47.214"></a><span id="l47.214" class="difflineminus">-  wait_for_settings_loaded(aController, kSettingsWithForm);</span>
<a href="#l47.215"></a><span id="l47.215" class="difflineminus">-  // The lone input should automatically be focused. Let's type something</span>
<a href="#l47.216"></a><span id="l47.216" class="difflineminus">-  // into it.</span>
<a href="#l47.217"></a><span id="l47.217" class="difflineminus">-  input_value(aController, 'Fone Bone');</span>
<a href="#l47.218"></a><span id="l47.218" class="difflineminus">-</span>
<a href="#l47.219"></a><span id="l47.219" class="difflineminus">-  // The 'Set up Account' button should become enabled.</span>
<a href="#l47.220"></a><span id="l47.220" class="difflineminus">-  wait_for_element_enabled(aController, get_accept_button(aController),</span>
<a href="#l47.221"></a><span id="l47.221" class="difflineminus">-                           true);</span>
<a href="#l47.222"></a><span id="l47.222" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-attachment-item.js</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -3,26 +3,28 @@</span>
<a href="#l48.4"></a><span id="l48.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l48.5"></a><span id="l48.5"> </span>
<a href="#l48.6"></a><span id="l48.6"> /**</span>
<a href="#l48.7"></a><span id="l48.7">  * Tests Filelink attachment item behaviour.</span>
<a href="#l48.8"></a><span id="l48.8">  */</span>
<a href="#l48.9"></a><span id="l48.9"> </span>
<a href="#l48.10"></a><span id="l48.10"> &quot;use strict&quot;;</span>
<a href="#l48.11"></a><span id="l48.11"> </span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-var MODULE_NAME = 'test-cloudfile-attachment-item';</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+var MODULE_NAME = &quot;test-cloudfile-attachment-item&quot;;</span>
<a href="#l48.14"></a><span id="l48.14"> </span>
<a href="#l48.15"></a><span id="l48.15" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l48.16"></a><span id="l48.16" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l48.17"></a><span id="l48.17" class="difflineminus">-                       'compose-helpers',</span>
<a href="#l48.18"></a><span id="l48.18" class="difflineminus">-                       'cloudfile-helpers',</span>
<a href="#l48.19"></a><span id="l48.19" class="difflineminus">-                       'attachment-helpers']</span>
<a href="#l48.20"></a><span id="l48.20" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l48.21"></a><span id="l48.21" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineplus">+                       &quot;compose-helpers&quot;,</span>
<a href="#l48.23"></a><span id="l48.23" class="difflineplus">+                       &quot;cloudfile-helpers&quot;,</span>
<a href="#l48.24"></a><span id="l48.24" class="difflineplus">+                       &quot;attachment-helpers&quot;];</span>
<a href="#l48.25"></a><span id="l48.25"> </span>
<a href="#l48.26"></a><span id="l48.26"> var kAttachmentItemContextID = &quot;msgComposeAttachmentItemContext&quot;;</span>
<a href="#l48.27"></a><span id="l48.27"> </span>
<a href="#l48.28"></a><span id="l48.28" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l48.29"></a><span id="l48.29" class="difflineplus">+</span>
<a href="#l48.30"></a><span id="l48.30"> function setupModule(module) {</span>
<a href="#l48.31"></a><span id="l48.31">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l48.32"></a><span id="l48.32">     collector.getModule(lib).installInto(module);</span>
<a href="#l48.33"></a><span id="l48.33">   }</span>
<a href="#l48.34"></a><span id="l48.34"> </span>
<a href="#l48.35"></a><span id="l48.35">   gMockFilePickReg.register();</span>
<a href="#l48.36"></a><span id="l48.36">   gMockCloudfileManager.register();</span>
<a href="#l48.37"></a><span id="l48.37"> }</span>
<a href="#l48.38"></a><span id="l48.38" class="difflineat">@@ -128,18 +130,17 @@ function assert_can_cancel_upload(aContr</span>
<a href="#l48.39"></a><span id="l48.39">                                   aTargetFile) {</span>
<a href="#l48.40"></a><span id="l48.40">   let cancelled = false;</span>
<a href="#l48.41"></a><span id="l48.41"> </span>
<a href="#l48.42"></a><span id="l48.42">   // Override the provider's cancelFileUpload function.  We can do this because</span>
<a href="#l48.43"></a><span id="l48.43">   // it's assumed that the provider is a MockCloudfileAccount.</span>
<a href="#l48.44"></a><span id="l48.44">   aProvider.cancelFileUpload = function(aFileToCancel) {</span>
<a href="#l48.45"></a><span id="l48.45">     if (aTargetFile.equals(aFileToCancel)) {</span>
<a href="#l48.46"></a><span id="l48.46">       aListener.onStopRequest(null, null,</span>
<a href="#l48.47"></a><span id="l48.47" class="difflineminus">-                              Ci.nsIMsgCloudFileProvider</span>
<a href="#l48.48"></a><span id="l48.48" class="difflineminus">-                                .uploadCanceled);</span>
<a href="#l48.49"></a><span id="l48.49" class="difflineplus">+                              cloudFileAccounts.constants.uploadCancelled);</span>
<a href="#l48.50"></a><span id="l48.50">       cancelled = true;</span>
<a href="#l48.51"></a><span id="l48.51">     }</span>
<a href="#l48.52"></a><span id="l48.52">   };</span>
<a href="#l48.53"></a><span id="l48.53"> </span>
<a href="#l48.54"></a><span id="l48.54">   // Retrieve the attachment bucket index for the target file...</span>
<a href="#l48.55"></a><span id="l48.55">   let index = get_attachmentitem_index_for_file(aController,</span>
<a href="#l48.56"></a><span id="l48.56">                                                 aTargetFile);</span>
<a href="#l48.57"></a><span id="l48.57"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-attachment-urls.js</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -3,41 +3,41 @@</span>
<a href="#l49.4"></a><span id="l49.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l49.5"></a><span id="l49.5"> </span>
<a href="#l49.6"></a><span id="l49.6"> /**</span>
<a href="#l49.7"></a><span id="l49.7">  * Tests Filelink URL insertion behaviours in compose windows.</span>
<a href="#l49.8"></a><span id="l49.8">  */</span>
<a href="#l49.9"></a><span id="l49.9"> </span>
<a href="#l49.10"></a><span id="l49.10"> &quot;use strict&quot;;</span>
<a href="#l49.11"></a><span id="l49.11"> </span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-var MODULE_NAME = 'test-cloudfile-attachment-urls';</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineplus">+var MODULE_NAME = &quot;test-cloudfile-attachment-urls&quot;;</span>
<a href="#l49.14"></a><span id="l49.14"> </span>
<a href="#l49.15"></a><span id="l49.15" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineminus">-                       'compose-helpers',</span>
<a href="#l49.18"></a><span id="l49.18" class="difflineminus">-                       'cloudfile-helpers',</span>
<a href="#l49.19"></a><span id="l49.19" class="difflineminus">-                       'attachment-helpers',</span>
<a href="#l49.20"></a><span id="l49.20" class="difflineminus">-                       'dom-helpers',</span>
<a href="#l49.21"></a><span id="l49.21" class="difflineminus">-                       'window-helpers'];</span>
<a href="#l49.22"></a><span id="l49.22" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l49.23"></a><span id="l49.23" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l49.24"></a><span id="l49.24" class="difflineplus">+                       &quot;compose-helpers&quot;,</span>
<a href="#l49.25"></a><span id="l49.25" class="difflineplus">+                       &quot;cloudfile-helpers&quot;,</span>
<a href="#l49.26"></a><span id="l49.26" class="difflineplus">+                       &quot;attachment-helpers&quot;,</span>
<a href="#l49.27"></a><span id="l49.27" class="difflineplus">+                       &quot;dom-helpers&quot;,</span>
<a href="#l49.28"></a><span id="l49.28" class="difflineplus">+                       &quot;window-helpers&quot;];</span>
<a href="#l49.29"></a><span id="l49.29"> </span>
<a href="#l49.30"></a><span id="l49.30"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l49.31"></a><span id="l49.31"> var {MailServices} = ChromeUtils.import(&quot;resource:///modules/MailServices.jsm&quot;);</span>
<a href="#l49.32"></a><span id="l49.32"> </span>
<a href="#l49.33"></a><span id="l49.33"> var kUploadedFile = &quot;attachment-uploaded&quot;;</span>
<a href="#l49.34"></a><span id="l49.34"> var kHtmlPrefKey = &quot;mail.identity.default.compose_html&quot;;</span>
<a href="#l49.35"></a><span id="l49.35"> var kReplyOnTopKey = &quot;mail.identity.default.reply_on_top&quot;;</span>
<a href="#l49.36"></a><span id="l49.36"> var kReplyOnTop = 1;</span>
<a href="#l49.37"></a><span id="l49.37"> var kReplyOnBottom = 0;</span>
<a href="#l49.38"></a><span id="l49.38"> var kTextNodeType = 3;</span>
<a href="#l49.39"></a><span id="l49.39"> var kSigPrefKey = &quot;mail.identity.id1.htmlSigText&quot;;</span>
<a href="#l49.40"></a><span id="l49.40"> var kSigOnReplyKey = &quot;mail.identity.default.sig_on_reply&quot;;</span>
<a href="#l49.41"></a><span id="l49.41"> var kSigOnForwardKey = &quot;mail.identity.default.sig_on_fwd&quot;;</span>
<a href="#l49.42"></a><span id="l49.42"> var kDefaultSigKey = &quot;mail.identity.id1.htmlSigText&quot;;</span>
<a href="#l49.43"></a><span id="l49.43"> var kDefaultSig = &quot;This is my signature.\n\nCheck out my website sometime!&quot;;</span>
<a href="#l49.44"></a><span id="l49.44" class="difflineminus">-var kFiles = ['./data/testFile1', './data/testFile2'];</span>
<a href="#l49.45"></a><span id="l49.45" class="difflineplus">+var kFiles = [&quot;./data/testFile1&quot;, &quot;./data/testFile2&quot;];</span>
<a href="#l49.46"></a><span id="l49.46"> var kLines = [&quot;This is a line of text&quot;, &quot;and here's another!&quot;];</span>
<a href="#l49.47"></a><span id="l49.47"> </span>
<a href="#l49.48"></a><span id="l49.48"> var gInbox, gOldHtmlPref, gOldSigPref;</span>
<a href="#l49.49"></a><span id="l49.49"> </span>
<a href="#l49.50"></a><span id="l49.50"> function setupModule(module) {</span>
<a href="#l49.51"></a><span id="l49.51">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l49.52"></a><span id="l49.52">     collector.getModule(lib).installInto(module);</span>
<a href="#l49.53"></a><span id="l49.53">   }</span>
<a href="#l49.54"></a><span id="l49.54" class="difflineat">@@ -540,18 +540,17 @@ function subtest_adding_filelinks_to_rep</span>
<a href="#l49.55"></a><span id="l49.55"> </span>
<a href="#l49.56"></a><span id="l49.56">   let blockquote;</span>
<a href="#l49.57"></a><span id="l49.57">   if (aText.length) {</span>
<a href="#l49.58"></a><span id="l49.58">     // If there was any text inserted, check for 2 previous br nodes, and then</span>
<a href="#l49.59"></a><span id="l49.59">     // the inserted text, and then the blockquote.</span>
<a href="#l49.60"></a><span id="l49.60">     br = assert_previous_nodes(&quot;br&quot;, root, 2);</span>
<a href="#l49.61"></a><span id="l49.61">     let textNode = assert_previous_text(br.previousSibling, aText);</span>
<a href="#l49.62"></a><span id="l49.62">     blockquote = textNode.previousSibling;</span>
<a href="#l49.63"></a><span id="l49.63" class="difflineminus">-  }</span>
<a href="#l49.64"></a><span id="l49.64" class="difflineminus">-  else {</span>
<a href="#l49.65"></a><span id="l49.65" class="difflineplus">+  } else {</span>
<a href="#l49.66"></a><span id="l49.66">     // If no text was inserted, check for 1 previous br node, and then the</span>
<a href="#l49.67"></a><span id="l49.67">     // blockquote.</span>
<a href="#l49.68"></a><span id="l49.68">     br = assert_previous_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l49.69"></a><span id="l49.69">     blockquote = br.previousSibling;</span>
<a href="#l49.70"></a><span id="l49.70">   }</span>
<a href="#l49.71"></a><span id="l49.71"> </span>
<a href="#l49.72"></a><span id="l49.72">   assert_equals(blockquote.localName, &quot;blockquote&quot;,</span>
<a href="#l49.73"></a><span id="l49.73">                 &quot;The linebreak should be preceded by a blockquote.&quot;);</span>
<a href="#l49.74"></a><span id="l49.74" class="difflineat">@@ -577,18 +576,17 @@ function subtest_adding_filelinks_to_pla</span>
<a href="#l49.75"></a><span id="l49.75">   assert_next_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l49.76"></a><span id="l49.76"> </span>
<a href="#l49.77"></a><span id="l49.77">   if (aText.length) {</span>
<a href="#l49.78"></a><span id="l49.78">     br = assert_previous_nodes(&quot;br&quot;, root, 2);</span>
<a href="#l49.79"></a><span id="l49.79">     // If text was entered, make sure it matches what we expect...</span>
<a href="#l49.80"></a><span id="l49.80">     let textNode = assert_previous_text(br.previousSibling, aText);</span>
<a href="#l49.81"></a><span id="l49.81">     // And then grab the span, which should be before the final text node.</span>
<a href="#l49.82"></a><span id="l49.82">     span = textNode.previousSibling;</span>
<a href="#l49.83"></a><span id="l49.83" class="difflineminus">-  }</span>
<a href="#l49.84"></a><span id="l49.84" class="difflineminus">-  else {</span>
<a href="#l49.85"></a><span id="l49.85" class="difflineplus">+  } else {</span>
<a href="#l49.86"></a><span id="l49.86">     br = assert_previous_nodes(&quot;br&quot;, root, 1);</span>
<a href="#l49.87"></a><span id="l49.87">     // If no text was entered, just grab the last br's previous sibling - that</span>
<a href="#l49.88"></a><span id="l49.88">     // will be the span.</span>
<a href="#l49.89"></a><span id="l49.89">     span = br.previousSibling;</span>
<a href="#l49.90"></a><span id="l49.90">     // Sometimes we need to skip one more linebreak.</span>
<a href="#l49.91"></a><span id="l49.91">     if (span.localName != &quot;span&quot;)</span>
<a href="#l49.92"></a><span id="l49.92">       span = span.previousSibling;</span>
<a href="#l49.93"></a><span id="l49.93">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-backend-hightail.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -3,28 +3,29 @@</span>
<a href="#l50.4"></a><span id="l50.4">   * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l50.5"></a><span id="l50.5"> </span>
<a href="#l50.6"></a><span id="l50.6"> /**</span>
<a href="#l50.7"></a><span id="l50.7">  * Tests the Hightail Bigfile backend.</span>
<a href="#l50.8"></a><span id="l50.8">  */</span>
<a href="#l50.9"></a><span id="l50.9"> </span>
<a href="#l50.10"></a><span id="l50.10"> &quot;use strict&quot;;</span>
<a href="#l50.11"></a><span id="l50.11"> </span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-var MODULE_NAME = 'test-cloudfile-backend-hightail';</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+var MODULE_NAME = &quot;test-cloudfile-backend-hightail&quot;;</span>
<a href="#l50.14"></a><span id="l50.14"> </span>
<a href="#l50.15"></a><span id="l50.15" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l50.16"></a><span id="l50.16" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l50.17"></a><span id="l50.17" class="difflineminus">-                         'compose-helpers',</span>
<a href="#l50.18"></a><span id="l50.18" class="difflineminus">-                         'cloudfile-helpers',</span>
<a href="#l50.19"></a><span id="l50.19" class="difflineminus">-                         'cloudfile-backend-helpers',</span>
<a href="#l50.20"></a><span id="l50.20" class="difflineminus">-                         'cloudfile-hightail-helpers',</span>
<a href="#l50.21"></a><span id="l50.21" class="difflineminus">-                         'observer-helpers',</span>
<a href="#l50.22"></a><span id="l50.22" class="difflineminus">-                         'prompt-helpers',];</span>
<a href="#l50.23"></a><span id="l50.23" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l50.24"></a><span id="l50.24" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l50.25"></a><span id="l50.25" class="difflineplus">+                         &quot;compose-helpers&quot;,</span>
<a href="#l50.26"></a><span id="l50.26" class="difflineplus">+                         &quot;cloudfile-helpers&quot;,</span>
<a href="#l50.27"></a><span id="l50.27" class="difflineplus">+                         &quot;cloudfile-backend-helpers&quot;,</span>
<a href="#l50.28"></a><span id="l50.28" class="difflineplus">+                         &quot;cloudfile-hightail-helpers&quot;,</span>
<a href="#l50.29"></a><span id="l50.29" class="difflineplus">+                         &quot;observer-helpers&quot;,</span>
<a href="#l50.30"></a><span id="l50.30" class="difflineplus">+                         &quot;prompt-helpers&quot;,];</span>
<a href="#l50.31"></a><span id="l50.31"> </span>
<a href="#l50.32"></a><span id="l50.32"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l50.33"></a><span id="l50.33" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l50.34"></a><span id="l50.34"> </span>
<a href="#l50.35"></a><span id="l50.35"> var gServer, gObsManager;</span>
<a href="#l50.36"></a><span id="l50.36"> </span>
<a href="#l50.37"></a><span id="l50.37"> function setupModule(module) {</span>
<a href="#l50.38"></a><span id="l50.38">   for (let lib of MODULE_REQUIRES) {</span>
<a href="#l50.39"></a><span id="l50.39">     collector.getModule(lib).installInto(module);</span>
<a href="#l50.40"></a><span id="l50.40">   }</span>
<a href="#l50.41"></a><span id="l50.41"> </span>
<a href="#l50.42"></a><span id="l50.42" class="difflineat">@@ -40,18 +41,20 @@ function teardownModule(module) {</span>
<a href="#l50.43"></a><span id="l50.43"> </span>
<a href="#l50.44"></a><span id="l50.44"> function setupTest() {</span>
<a href="#l50.45"></a><span id="l50.45">   gServer = new MockHightailServer();</span>
<a href="#l50.46"></a><span id="l50.46">   gServer.init();</span>
<a href="#l50.47"></a><span id="l50.47">   gServer.start();</span>
<a href="#l50.48"></a><span id="l50.48"> }</span>
<a href="#l50.49"></a><span id="l50.49"> </span>
<a href="#l50.50"></a><span id="l50.50"> function teardownTest() {</span>
<a href="#l50.51"></a><span id="l50.51" class="difflineminus">-  Services.prefs.QueryInterface(Ci.nsIPrefBranch)</span>
<a href="#l50.52"></a><span id="l50.52" class="difflineminus">-          .deleteBranch(&quot;mail.cloud_files.accounts&quot;);</span>
<a href="#l50.53"></a><span id="l50.53" class="difflineplus">+  for (let account of cloudFileAccounts.accounts) {</span>
<a href="#l50.54"></a><span id="l50.54" class="difflineplus">+    cloudFileAccounts.removeAccount(account);</span>
<a href="#l50.55"></a><span id="l50.55" class="difflineplus">+  }</span>
<a href="#l50.56"></a><span id="l50.56" class="difflineplus">+</span>
<a href="#l50.57"></a><span id="l50.57">   gObsManager.check();</span>
<a href="#l50.58"></a><span id="l50.58">   gObsManager.reset();</span>
<a href="#l50.59"></a><span id="l50.59">   gServer.stop(mc);</span>
<a href="#l50.60"></a><span id="l50.60"> }</span>
<a href="#l50.61"></a><span id="l50.61"> </span>
<a href="#l50.62"></a><span id="l50.62"> function test_simple_case() {</span>
<a href="#l50.63"></a><span id="l50.63">   const kExpectedUrl = &quot;http://www.example.com/expectedUrl&quot;;</span>
<a href="#l50.64"></a><span id="l50.64">   const kTopics = [kUploadFile, kGetFileURL];</span>
<a href="#l50.65"></a><span id="l50.65" class="difflineat">@@ -65,17 +68,17 @@ function test_simple_case() {</span>
<a href="#l50.66"></a><span id="l50.66">     Services.obs.addObserver(obs, topic);</span>
<a href="#l50.67"></a><span id="l50.67">   }</span>
<a href="#l50.68"></a><span id="l50.68"> </span>
<a href="#l50.69"></a><span id="l50.69">   let requestObserver = gObsManager.create(&quot;test_simple_case - Upload 1&quot;);</span>
<a href="#l50.70"></a><span id="l50.70">   let file = getFile(&quot;./data/testFile1&quot;, __file__);</span>
<a href="#l50.71"></a><span id="l50.71">   let provider = gServer.getPreparedBackend(&quot;someAccountKey&quot;);</span>
<a href="#l50.72"></a><span id="l50.72">   provider.uploadFile(file, requestObserver);</span>
<a href="#l50.73"></a><span id="l50.73"> </span>
<a href="#l50.74"></a><span id="l50.74" class="difflineminus">-  mc.waitFor( () =&gt; requestObserver.success);</span>
<a href="#l50.75"></a><span id="l50.75" class="difflineplus">+  mc.waitFor(() =&gt; requestObserver.success);</span>
<a href="#l50.76"></a><span id="l50.76"> </span>
<a href="#l50.77"></a><span id="l50.77">   let urlForFile = provider.urlForFile(file);</span>
<a href="#l50.78"></a><span id="l50.78">   assert_equals(kExpectedUrl, urlForFile);</span>
<a href="#l50.79"></a><span id="l50.79">   assert_equals(1, obs.numSightings(kUploadFile));</span>
<a href="#l50.80"></a><span id="l50.80">   assert_equals(1, obs.numSightings(kGetFileURL));</span>
<a href="#l50.81"></a><span id="l50.81"> </span>
<a href="#l50.82"></a><span id="l50.82">   gServer.planForUploadFile(&quot;testFile1&quot;);</span>
<a href="#l50.83"></a><span id="l50.83">   gServer.planForGetFileURL(&quot;testFile1&quot;, {url: kExpectedUrl});</span>
<a href="#l50.84"></a><span id="l50.84" class="difflineat">@@ -151,45 +154,45 @@ function test_deleting_uploads() {</span>
<a href="#l50.85"></a><span id="l50.85">   let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l50.86"></a><span id="l50.86">   gServer.planForUploadFile(kFilename);</span>
<a href="#l50.87"></a><span id="l50.87">   let requestObserver = gObsManager.create(&quot;test_deleting_uploads - upload 1&quot;);</span>
<a href="#l50.88"></a><span id="l50.88">   provider.uploadFile(file, requestObserver);</span>
<a href="#l50.89"></a><span id="l50.89">   mc.waitFor(() =&gt; requestObserver.success);</span>
<a href="#l50.90"></a><span id="l50.90"> </span>
<a href="#l50.91"></a><span id="l50.91">   // Try deleting a file</span>
<a href="#l50.92"></a><span id="l50.92">   let obs = new ObservationRecorder();</span>
<a href="#l50.93"></a><span id="l50.93" class="difflineminus">-  obs.planFor(kDeleteFile)</span>
<a href="#l50.94"></a><span id="l50.94" class="difflineplus">+  obs.planFor(kDeleteFile);</span>
<a href="#l50.95"></a><span id="l50.95">   Services.obs.addObserver(obs, kDeleteFile);</span>
<a href="#l50.96"></a><span id="l50.96"> </span>
<a href="#l50.97"></a><span id="l50.97">   gServer.planForDeleteFile(kFilename);</span>
<a href="#l50.98"></a><span id="l50.98">   let deleteObserver = gObsManager.create(&quot;test_deleting_uploads - delete 1&quot;);</span>
<a href="#l50.99"></a><span id="l50.99">   provider.deleteFile(file, deleteObserver);</span>
<a href="#l50.100"></a><span id="l50.100">   mc.waitFor(() =&gt; deleteObserver.success);</span>
<a href="#l50.101"></a><span id="l50.101"> </span>
<a href="#l50.102"></a><span id="l50.102">   // Check to make sure the file was deleted on the server</span>
<a href="#l50.103"></a><span id="l50.103">   assert_equals(1, obs.numSightings(kDeleteFile));</span>
<a href="#l50.104"></a><span id="l50.104">   assert_equals(obs.data[kDeleteFile][0], kFilename);</span>
<a href="#l50.105"></a><span id="l50.105">   Services.obs.removeObserver(obs, kDeleteFile);</span>
<a href="#l50.106"></a><span id="l50.106"> }</span>
<a href="#l50.107"></a><span id="l50.107"> </span>
<a href="#l50.108"></a><span id="l50.108"> /**</span>
<a href="#l50.109"></a><span id="l50.109">  * Test that cancelling an upload causes onStopRequest to be</span>
<a href="#l50.110"></a><span id="l50.110" class="difflineminus">- * called with nsIMsgCloudFileProvider.uploadCanceled.</span>
<a href="#l50.111"></a><span id="l50.111" class="difflineplus">+ * called with cloudFileAccounts.constants.uploadCancelled.</span>
<a href="#l50.112"></a><span id="l50.112">  */</span>
<a href="#l50.113"></a><span id="l50.113"> function test_can_cancel_upload() {</span>
<a href="#l50.114"></a><span id="l50.114">   const kFilename = &quot;testFile1&quot;;</span>
<a href="#l50.115"></a><span id="l50.115">   let provider = gServer.getPreparedBackend(&quot;anAccount&quot;);</span>
<a href="#l50.116"></a><span id="l50.116">   let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l50.117"></a><span id="l50.117">   gServer.planForUploadFile(kFilename, 2000);</span>
<a href="#l50.118"></a><span id="l50.118">   assert_can_cancel_uploads(mc, provider, [file]);</span>
<a href="#l50.119"></a><span id="l50.119"> }</span>
<a href="#l50.120"></a><span id="l50.120"> </span>
<a href="#l50.121"></a><span id="l50.121"> /**</span>
<a href="#l50.122"></a><span id="l50.122">  * Test that cancelling several uploads causes onStopRequest to be</span>
<a href="#l50.123"></a><span id="l50.123" class="difflineminus">- * called with nsIMsgCloudFileProvider.uploadCanceled.</span>
<a href="#l50.124"></a><span id="l50.124" class="difflineplus">+ * called with cloudFileAccounts.constants.uploadCancelled.</span>
<a href="#l50.125"></a><span id="l50.125">  */</span>
<a href="#l50.126"></a><span id="l50.126"> function test_can_cancel_uploads() {</span>
<a href="#l50.127"></a><span id="l50.127">   const kFiles = [&quot;testFile2&quot;, &quot;testFile3&quot;, &quot;testFile4&quot;];</span>
<a href="#l50.128"></a><span id="l50.128">   let provider = gServer.getPreparedBackend(&quot;anAccount&quot;);</span>
<a href="#l50.129"></a><span id="l50.129">   let files = [];</span>
<a href="#l50.130"></a><span id="l50.130">   for (let filename of kFiles) {</span>
<a href="#l50.131"></a><span id="l50.131">     gServer.planForUploadFile(filename, 2000);</span>
<a href="#l50.132"></a><span id="l50.132">     files.push(getFile(&quot;./data/&quot; + filename, __file__));</span>
<a href="#l50.133"></a><span id="l50.133" class="difflineat">@@ -202,24 +205,24 @@ function test_can_cancel_uploads() {</span>
<a href="#l50.134"></a><span id="l50.134">  * called, and we pass the correct parameters.</span>
<a href="#l50.135"></a><span id="l50.135">  */</span>
<a href="#l50.136"></a><span id="l50.136"> function test_create_existing_account() {</span>
<a href="#l50.137"></a><span id="l50.137">   // We have to mock out the auth prompter, or else we'll lock up.</span>
<a href="#l50.138"></a><span id="l50.138">   gMockAuthPromptReg.register();</span>
<a href="#l50.139"></a><span id="l50.139">   let provider = gServer.getPreparedBackend(&quot;someNewAccount&quot;);</span>
<a href="#l50.140"></a><span id="l50.140">   let done = false;</span>
<a href="#l50.141"></a><span id="l50.141">   let myObs = {</span>
<a href="#l50.142"></a><span id="l50.142" class="difflineminus">-    onStartRequest: function(aRequest, aContext) {</span>
<a href="#l50.143"></a><span id="l50.143" class="difflineplus">+    onStartRequest(aRequest, aContext) {</span>
<a href="#l50.144"></a><span id="l50.144">     },</span>
<a href="#l50.145"></a><span id="l50.145" class="difflineminus">-    onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l50.146"></a><span id="l50.146" class="difflineminus">-      assert_true(aContext instanceof Ci.nsIMsgCloudFileProvider);</span>
<a href="#l50.147"></a><span id="l50.147" class="difflineplus">+    onStopRequest(aRequest, aContext, aStatusCode) {</span>
<a href="#l50.148"></a><span id="l50.148" class="difflineplus">+      assert_equals(aContext, provider);</span>
<a href="#l50.149"></a><span id="l50.149">       assert_equals(aStatusCode, Cr.NS_OK);</span>
<a href="#l50.150"></a><span id="l50.150">       done = true;</span>
<a href="#l50.151"></a><span id="l50.151">     },</span>
<a href="#l50.152"></a><span id="l50.152" class="difflineminus">-  }</span>
<a href="#l50.153"></a><span id="l50.153" class="difflineplus">+  };</span>
<a href="#l50.154"></a><span id="l50.154"> </span>
<a href="#l50.155"></a><span id="l50.155">   provider.createExistingAccount(myObs);</span>
<a href="#l50.156"></a><span id="l50.156">   mc.waitFor(() =&gt; done);</span>
<a href="#l50.157"></a><span id="l50.157">   gMockAuthPromptReg.unregister();</span>
<a href="#l50.158"></a><span id="l50.158"> }</span>
<a href="#l50.159"></a><span id="l50.159"> </span>
<a href="#l50.160"></a><span id="l50.160"> function test_delete_refreshes_stale_token() {</span>
<a href="#l50.161"></a><span id="l50.161">   const kFilename = &quot;testFile1&quot;;</span>
<a href="#l50.162"></a><span id="l50.162" class="difflineat">@@ -250,18 +253,17 @@ function test_delete_refreshes_stale_tok</span>
<a href="#l50.163"></a><span id="l50.163">   let file = getFile(&quot;./data/&quot; + kFilename, __file__);</span>
<a href="#l50.164"></a><span id="l50.164">   gServer.planForUploadFile(kFilename);</span>
<a href="#l50.165"></a><span id="l50.165">   let requestObserver = gObsManager.create(&quot;test_delete_refreshes_stale_token - upload 1&quot;);</span>
<a href="#l50.166"></a><span id="l50.166">   provider.uploadFile(file, requestObserver);</span>
<a href="#l50.167"></a><span id="l50.167">   mc.waitFor(() =&gt; requestObserver.success);</span>
<a href="#l50.168"></a><span id="l50.168"> </span>
<a href="#l50.169"></a><span id="l50.169">   // At this point, we should not have seen any auth attempts.</span>
<a href="#l50.170"></a><span id="l50.170">   assert_equals(gServer.auth.count, 0,</span>
<a href="#l50.171"></a><span id="l50.171" class="difflineminus">-                &quot;Should not have seen any authorization attempts &quot;</span>
<a href="#l50.172"></a><span id="l50.172" class="difflineminus">-                + &quot;yet&quot;);</span>
<a href="#l50.173"></a><span id="l50.173" class="difflineplus">+                &quot;Should not have seen any authorization attempts yet&quot;);</span>
<a href="#l50.174"></a><span id="l50.174"> </span>
<a href="#l50.175"></a><span id="l50.175">   // Now delete the file, and get the stale auth token warning.</span>
<a href="#l50.176"></a><span id="l50.176">   gServer.planForDeleteFile(kFilename);</span>
<a href="#l50.177"></a><span id="l50.177">   // We have to pass an observer, so we'll just generate a dummy one.</span>
<a href="#l50.178"></a><span id="l50.178">   let deleteObserver = new SimpleRequestObserver();</span>
<a href="#l50.179"></a><span id="l50.179">   provider.deleteFile(file, deleteObserver);</span>
<a href="#l50.180"></a><span id="l50.180"> </span>
<a href="#l50.181"></a><span id="l50.181">   // Now, since the token was stale, we should see us hit authentication</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-manager.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-manager.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -4,19 +4,19 @@</span>
<a href="#l51.4"></a><span id="l51.4"> </span>
<a href="#l51.5"></a><span id="l51.5"> /**</span>
<a href="#l51.6"></a><span id="l51.6">  * Tests the richlistbox in the manager for attachment storage</span>
<a href="#l51.7"></a><span id="l51.7">  * services</span>
<a href="#l51.8"></a><span id="l51.8">  */</span>
<a href="#l51.9"></a><span id="l51.9"> </span>
<a href="#l51.10"></a><span id="l51.10"> &quot;use strict&quot;;</span>
<a href="#l51.11"></a><span id="l51.11"> </span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-var MODULE_NAME = 'test-cloudfile-manager';</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+var MODULE_NAME = &quot;test-cloudfile-manager&quot;;</span>
<a href="#l51.14"></a><span id="l51.14"> </span>
<a href="#l51.15"></a><span id="l51.15" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l51.16"></a><span id="l51.16" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l51.17"></a><span id="l51.17"> var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l51.18"></a><span id="l51.18">                        &quot;pref-window-helpers&quot;,</span>
<a href="#l51.19"></a><span id="l51.19">                        &quot;content-tab-helpers&quot;,</span>
<a href="#l51.20"></a><span id="l51.20">                        &quot;cloudfile-helpers&quot;,</span>
<a href="#l51.21"></a><span id="l51.21">                        &quot;window-helpers&quot;];</span>
<a href="#l51.22"></a><span id="l51.22"> </span>
<a href="#l51.23"></a><span id="l51.23"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l51.24"></a><span id="l51.24"> </span>
<a href="#l51.25"></a><span id="l51.25" class="difflineat">@@ -99,19 +99,20 @@ function test_load_accounts_and_properly</span>
<a href="#l51.26"></a><span id="l51.26">  */</span>
<a href="#l51.27"></a><span id="l51.27"> test_external_link.__force_skip__ = true;</span>
<a href="#l51.28"></a><span id="l51.28"> function test_external_link() {</span>
<a href="#l51.29"></a><span id="l51.29">   gMockExtProtSvcReg.register();</span>
<a href="#l51.30"></a><span id="l51.30"> </span>
<a href="#l51.31"></a><span id="l51.31">   let prefTab = open_pref_tab(&quot;paneApplications&quot;);</span>
<a href="#l51.32"></a><span id="l51.32">   let tabbox = content_tab_e(prefTab, &quot;attachmentPrefs&quot;);</span>
<a href="#l51.33"></a><span id="l51.33">   tabbox.selectedIndex = 1;</span>
<a href="#l51.34"></a><span id="l51.34" class="difflineplus">+  content_tab_e(prefTab, &quot;cloudFileView&quot;).selectedIndex = 0;</span>
<a href="#l51.35"></a><span id="l51.35"> </span>
<a href="#l51.36"></a><span id="l51.36">   let iframe = content_tab_e(prefTab, &quot;cloudFileSettingsWrapper&quot;).firstElementChild;</span>
<a href="#l51.37"></a><span id="l51.37" class="difflineminus">-  wait_for_frame_load(iframe, kSettingsWithLink);</span>
<a href="#l51.38"></a><span id="l51.38" class="difflineplus">+  wait_for_frame_load(iframe, kSettingsWithLink + &quot;?accountId=someKey3&quot;);</span>
<a href="#l51.39"></a><span id="l51.39">   mc.click(new elementslib.ID(iframe.contentDocument, &quot;a&quot;));</span>
<a href="#l51.40"></a><span id="l51.40"> </span>
<a href="#l51.41"></a><span id="l51.41">   let targetHref = &quot;https://www.example.com/&quot;;</span>
<a href="#l51.42"></a><span id="l51.42">   mc.waitFor(</span>
<a href="#l51.43"></a><span id="l51.43">     () =&gt; gMockExtProtSvc.urlLoaded(targetHref),</span>
<a href="#l51.44"></a><span id="l51.44">     `Timed out waiting for the link ${targetHref} to be opened in the default browser.`</span>
<a href="#l51.45"></a><span id="l51.45">   );</span>
<a href="#l51.46"></a><span id="l51.46">   close_pref_tab(prefTab);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mail/test/mozmill/cloudfile/test-cloudfile-notifications.js</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -3,27 +3,28 @@</span>
<a href="#l52.4"></a><span id="l52.4">  * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l52.5"></a><span id="l52.5"> </span>
<a href="#l52.6"></a><span id="l52.6"> /**</span>
<a href="#l52.7"></a><span id="l52.7">  * Tests that the cloudfile notifications work as they should.</span>
<a href="#l52.8"></a><span id="l52.8">  */</span>
<a href="#l52.9"></a><span id="l52.9"> </span>
<a href="#l52.10"></a><span id="l52.10"> &quot;use strict&quot;;</span>
<a href="#l52.11"></a><span id="l52.11"> </span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-var MODULE_NAME = 'test-cloudfile-notifications';</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+var MODULE_NAME = &quot;test-cloudfile-notifications&quot;;</span>
<a href="#l52.14"></a><span id="l52.14"> </span>
<a href="#l52.15"></a><span id="l52.15" class="difflineminus">-var RELATIVE_ROOT = '../shared-modules';</span>
<a href="#l52.16"></a><span id="l52.16" class="difflineminus">-var MODULE_REQUIRES = ['folder-display-helpers',</span>
<a href="#l52.17"></a><span id="l52.17" class="difflineminus">-                       'compose-helpers',</span>
<a href="#l52.18"></a><span id="l52.18" class="difflineminus">-                       'cloudfile-helpers',</span>
<a href="#l52.19"></a><span id="l52.19" class="difflineminus">-                       'attachment-helpers',</span>
<a href="#l52.20"></a><span id="l52.20" class="difflineminus">-                       'prompt-helpers',</span>
<a href="#l52.21"></a><span id="l52.21" class="difflineminus">-                       'notificationbox-helpers'];</span>
<a href="#l52.22"></a><span id="l52.22" class="difflineplus">+var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l52.23"></a><span id="l52.23" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;,</span>
<a href="#l52.24"></a><span id="l52.24" class="difflineplus">+                       &quot;compose-helpers&quot;,</span>
<a href="#l52.25"></a><span id="l52.25" class="difflineplus">+                       &quot;cloudfile-helpers&quot;,</span>
<a href="#l52.26"></a><span id="l52.26" class="difflineplus">+                       &quot;attachment-helpers&quot;,</span>
<a href="#l52.27"></a><span id="l52.27" class="difflineplus">+                       &quot;prompt-helpers&quot;,</span>
<a href="#l52.28"></a><span id="l52.28" class="difflineplus">+                       &quot;notificationbox-helpers&quot;];</span>
<a href="#l52.29"></a><span id="l52.29"> </span>
<a href="#l52.30"></a><span id="l52.30"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l52.31"></a><span id="l52.31" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l52.32"></a><span id="l52.32"> </span>
<a href="#l52.33"></a><span id="l52.33"> var maxSize, oldInsertNotificationPref;</span>
<a href="#l52.34"></a><span id="l52.34"> </span>
<a href="#l52.35"></a><span id="l52.35"> var kOfferThreshold = &quot;mail.compose.big_attachments.threshold_kb&quot;;</span>
<a href="#l52.36"></a><span id="l52.36"> var kInsertNotificationPref = &quot;mail.compose.big_attachments.insert_notification&quot;;</span>
<a href="#l52.37"></a><span id="l52.37"> </span>
<a href="#l52.38"></a><span id="l52.38"> var kBoxId = &quot;attachmentNotificationBox&quot;;</span>
<a href="#l52.39"></a><span id="l52.39"> </span>
<a href="#l52.40"></a><span id="l52.40" class="difflineat">@@ -168,80 +169,80 @@ function test_no_notification_if_disable</span>
<a href="#l52.41"></a><span id="l52.41">   Services.prefs.setBoolPref(&quot;mail.cloud_files.enabled&quot;, true);</span>
<a href="#l52.42"></a><span id="l52.42"> }</span>
<a href="#l52.43"></a><span id="l52.43"> </span>
<a href="#l52.44"></a><span id="l52.44"> /**</span>
<a href="#l52.45"></a><span id="l52.45">  * Tests that if we upload a single file, we get the link insertion</span>
<a href="#l52.46"></a><span id="l52.46">  * notification bar displayed (unless preffed off).</span>
<a href="#l52.47"></a><span id="l52.47">  */</span>
<a href="#l52.48"></a><span id="l52.48"> function test_link_insertion_notification_single() {</span>
<a href="#l52.49"></a><span id="l52.49" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(['./data/testFile1'], __file__);</span>
<a href="#l52.50"></a><span id="l52.50" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile1&quot;], __file__);</span>
<a href="#l52.51"></a><span id="l52.51">   let provider = new MockCloudfileAccount();</span>
<a href="#l52.52"></a><span id="l52.52">   provider.init(&quot;aKey&quot;);</span>
<a href="#l52.53"></a><span id="l52.53"> </span>
<a href="#l52.54"></a><span id="l52.54">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l52.55"></a><span id="l52.55">   add_cloud_attachments(cwc, provider);</span>
<a href="#l52.56"></a><span id="l52.56"> </span>
<a href="#l52.57"></a><span id="l52.57">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l52.58"></a><span id="l52.58">   close_upload_notification(cwc);</span>
<a href="#l52.59"></a><span id="l52.59"> </span>
<a href="#l52.60"></a><span id="l52.60">   Services.prefs.setBoolPref(kInsertNotificationPref, false);</span>
<a href="#l52.61"></a><span id="l52.61" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(['./data/testFile2'], __file__);</span>
<a href="#l52.62"></a><span id="l52.62" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile2&quot;], __file__);</span>
<a href="#l52.63"></a><span id="l52.63">   add_cloud_attachments(cwc, provider);</span>
<a href="#l52.64"></a><span id="l52.64"> </span>
<a href="#l52.65"></a><span id="l52.65">   assert_upload_notification_displayed(cwc, false);</span>
<a href="#l52.66"></a><span id="l52.66">   Services.prefs.setBoolPref(kInsertNotificationPref, true);</span>
<a href="#l52.67"></a><span id="l52.67"> </span>
<a href="#l52.68"></a><span id="l52.68">   close_compose_window(cwc);</span>
<a href="#l52.69"></a><span id="l52.69"> }</span>
<a href="#l52.70"></a><span id="l52.70"> </span>
<a href="#l52.71"></a><span id="l52.71"> /**</span>
<a href="#l52.72"></a><span id="l52.72">  * Tests that if we upload multiple files, we get the link insertion</span>
<a href="#l52.73"></a><span id="l52.73">  * notification bar displayed (unless preffed off).</span>
<a href="#l52.74"></a><span id="l52.74">  */</span>
<a href="#l52.75"></a><span id="l52.75"> function test_link_insertion_notification_multiple() {</span>
<a href="#l52.76"></a><span id="l52.76" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(['./data/testFile1',</span>
<a href="#l52.77"></a><span id="l52.77" class="difflineminus">-                                              './data/testFile2'], __file__);</span>
<a href="#l52.78"></a><span id="l52.78" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile1&quot;,</span>
<a href="#l52.79"></a><span id="l52.79" class="difflineplus">+                                              &quot;./data/testFile2&quot;], __file__);</span>
<a href="#l52.80"></a><span id="l52.80">   let provider = new MockCloudfileAccount();</span>
<a href="#l52.81"></a><span id="l52.81">   provider.init(&quot;aKey&quot;);</span>
<a href="#l52.82"></a><span id="l52.82"> </span>
<a href="#l52.83"></a><span id="l52.83">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l52.84"></a><span id="l52.84">   add_cloud_attachments(cwc, provider);</span>
<a href="#l52.85"></a><span id="l52.85"> </span>
<a href="#l52.86"></a><span id="l52.86">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l52.87"></a><span id="l52.87">   close_upload_notification(cwc);</span>
<a href="#l52.88"></a><span id="l52.88"> </span>
<a href="#l52.89"></a><span id="l52.89">   Services.prefs.setBoolPref(kInsertNotificationPref, false);</span>
<a href="#l52.90"></a><span id="l52.90" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(['./data/testFile3',</span>
<a href="#l52.91"></a><span id="l52.91" class="difflineminus">-                                              './data/testFile4'], __file__);</span>
<a href="#l52.92"></a><span id="l52.92" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile3&quot;,</span>
<a href="#l52.93"></a><span id="l52.93" class="difflineplus">+                                              &quot;./data/testFile4&quot;], __file__);</span>
<a href="#l52.94"></a><span id="l52.94">   add_cloud_attachments(cwc, provider);</span>
<a href="#l52.95"></a><span id="l52.95"> </span>
<a href="#l52.96"></a><span id="l52.96">   assert_upload_notification_displayed(cwc, false);</span>
<a href="#l52.97"></a><span id="l52.97">   Services.prefs.setBoolPref(kInsertNotificationPref, true);</span>
<a href="#l52.98"></a><span id="l52.98"> </span>
<a href="#l52.99"></a><span id="l52.99">   close_compose_window(cwc);</span>
<a href="#l52.100"></a><span id="l52.100"> }</span>
<a href="#l52.101"></a><span id="l52.101"> </span>
<a href="#l52.102"></a><span id="l52.102"> /**</span>
<a href="#l52.103"></a><span id="l52.103">  * Tests that the link insertion notification bar goes away even</span>
<a href="#l52.104"></a><span id="l52.104">  * if we hit an uploading error.</span>
<a href="#l52.105"></a><span id="l52.105">  */</span>
<a href="#l52.106"></a><span id="l52.106"> function test_link_insertion_goes_away_on_error() {</span>
<a href="#l52.107"></a><span id="l52.107">   gMockPromptService.register();</span>
<a href="#l52.108"></a><span id="l52.108">   gMockPromptService.returnValue = false;</span>
<a href="#l52.109"></a><span id="l52.109" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(['./data/testFile1',</span>
<a href="#l52.110"></a><span id="l52.110" class="difflineminus">-                                              './data/testFile2'], __file__);</span>
<a href="#l52.111"></a><span id="l52.111" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile1&quot;,</span>
<a href="#l52.112"></a><span id="l52.112" class="difflineplus">+                                              &quot;./data/testFile2&quot;], __file__);</span>
<a href="#l52.113"></a><span id="l52.113">   let provider = new MockCloudfileAccount();</span>
<a href="#l52.114"></a><span id="l52.114">   provider.init(&quot;aKey&quot;);</span>
<a href="#l52.115"></a><span id="l52.115"> </span>
<a href="#l52.116"></a><span id="l52.116">   provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l52.117"></a><span id="l52.117">     aListener.onStartRequest(null, null);</span>
<a href="#l52.118"></a><span id="l52.118">     cwc.window.setTimeout(function() {</span>
<a href="#l52.119"></a><span id="l52.119">       aListener.onStopRequest(null, null,</span>
<a href="#l52.120"></a><span id="l52.120" class="difflineminus">-                              Ci.nsIMsgCloudFileProvider.uploadErr);</span>
<a href="#l52.121"></a><span id="l52.121" class="difflineplus">+                              cloudFileAccounts.constants.uploadErr);</span>
<a href="#l52.122"></a><span id="l52.122">     }, 500);</span>
<a href="#l52.123"></a><span id="l52.123">   };</span>
<a href="#l52.124"></a><span id="l52.124"> </span>
<a href="#l52.125"></a><span id="l52.125">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l52.126"></a><span id="l52.126">   add_cloud_attachments(cwc, provider, false);</span>
<a href="#l52.127"></a><span id="l52.127"> </span>
<a href="#l52.128"></a><span id="l52.128">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l52.129"></a><span id="l52.129">   wait_for_notification_to_stop(cwc, kBoxId, &quot;bigAttachmentUploading&quot;);</span>
<a href="#l52.130"></a><span id="l52.130" class="difflineat">@@ -250,17 +251,17 @@ function test_link_insertion_goes_away_o</span>
<a href="#l52.131"></a><span id="l52.131">   gMockPromptService.unregister();</span>
<a href="#l52.132"></a><span id="l52.132"> }</span>
<a href="#l52.133"></a><span id="l52.133"> </span>
<a href="#l52.134"></a><span id="l52.134"> /**</span>
<a href="#l52.135"></a><span id="l52.135">  * Test that we do not show the Filelink offer notification if we convert</span>
<a href="#l52.136"></a><span id="l52.136">  * a Filelink back into a normal attachment.</span>
<a href="#l52.137"></a><span id="l52.137">  */</span>
<a href="#l52.138"></a><span id="l52.138"> function test_no_offer_on_conversion() {</span>
<a href="#l52.139"></a><span id="l52.139" class="difflineminus">-  const kFiles = ['./data/testFile1', './data/testFile2'];</span>
<a href="#l52.140"></a><span id="l52.140" class="difflineplus">+  const kFiles = [&quot;./data/testFile1&quot;, &quot;./data/testFile2&quot;];</span>
<a href="#l52.141"></a><span id="l52.141">   // Set the notification threshold to 0 to ensure that we get it.</span>
<a href="#l52.142"></a><span id="l52.142">   Services.prefs.setIntPref(kOfferThreshold, 0);</span>
<a href="#l52.143"></a><span id="l52.143"> </span>
<a href="#l52.144"></a><span id="l52.144">   // Insert some Filelinks...</span>
<a href="#l52.145"></a><span id="l52.145">   gMockFilePicker.returnFiles = collectFiles(kFiles, __file__);</span>
<a href="#l52.146"></a><span id="l52.146">   let provider = new MockCloudfileAccount();</span>
<a href="#l52.147"></a><span id="l52.147">   provider.init(&quot;someKey&quot;);</span>
<a href="#l52.148"></a><span id="l52.148"> </span>
<a href="#l52.149"></a><span id="l52.149" class="difflineat">@@ -288,17 +289,17 @@ function test_no_offer_on_conversion() {</span>
<a href="#l52.150"></a><span id="l52.150">   Services.prefs.setIntPref(kOfferThreshold, maxSize);</span>
<a href="#l52.151"></a><span id="l52.151"> }</span>
<a href="#l52.152"></a><span id="l52.152"> </span>
<a href="#l52.153"></a><span id="l52.153"> /**</span>
<a href="#l52.154"></a><span id="l52.154">  * Test that when we kick off an upload via the offer notification, then</span>
<a href="#l52.155"></a><span id="l52.155">  * the upload notification is shown.</span>
<a href="#l52.156"></a><span id="l52.156">  */</span>
<a href="#l52.157"></a><span id="l52.157"> function test_offer_then_upload_notifications() {</span>
<a href="#l52.158"></a><span id="l52.158" class="difflineminus">-  const kFiles = ['./data/testFile1', './data/testFile2'];</span>
<a href="#l52.159"></a><span id="l52.159" class="difflineplus">+  const kFiles = [&quot;./data/testFile1&quot;, &quot;./data/testFile2&quot;];</span>
<a href="#l52.160"></a><span id="l52.160">   // Set the notification threshold to 0 to ensure that we get it.</span>
<a href="#l52.161"></a><span id="l52.161">   Services.prefs.setIntPref(kOfferThreshold, 0);</span>
<a href="#l52.162"></a><span id="l52.162"> </span>
<a href="#l52.163"></a><span id="l52.163">   // We're going to add attachments to the attachmentbucket, and we'll</span>
<a href="#l52.164"></a><span id="l52.164">   // use the add_attachments helper function to do it.  First, retrieve</span>
<a href="#l52.165"></a><span id="l52.165">   // some file URIs...</span>
<a href="#l52.166"></a><span id="l52.166">   let fileURIs = collectFiles(kFiles, __file__).</span>
<a href="#l52.167"></a><span id="l52.167">     map(file =&gt; Services.io.newFileURI(file).spec);</span>
<a href="#l52.168"></a><span id="l52.168" class="difflineat">@@ -341,69 +342,69 @@ function test_offer_then_upload_notifica</span>
<a href="#l52.169"></a><span id="l52.169"> </span>
<a href="#l52.170"></a><span id="l52.170"> /**</span>
<a href="#l52.171"></a><span id="l52.171">  * Test that when we first upload some files, we get the privacy warning</span>
<a href="#l52.172"></a><span id="l52.172">  * message. We should only get this the first time.</span>
<a href="#l52.173"></a><span id="l52.173">  */</span>
<a href="#l52.174"></a><span id="l52.174"> function test_privacy_warning_notification() {</span>
<a href="#l52.175"></a><span id="l52.175">   gMockPromptService.register();</span>
<a href="#l52.176"></a><span id="l52.176">   gMockPromptService.returnValue = false;</span>
<a href="#l52.177"></a><span id="l52.177" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(['./data/testFile1',</span>
<a href="#l52.178"></a><span id="l52.178" class="difflineminus">-                                              './data/testFile2'], __file__);</span>
<a href="#l52.179"></a><span id="l52.179" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile1&quot;,</span>
<a href="#l52.180"></a><span id="l52.180" class="difflineplus">+                                              &quot;./data/testFile2&quot;], __file__);</span>
<a href="#l52.181"></a><span id="l52.181">   let provider = new MockCloudfileAccount();</span>
<a href="#l52.182"></a><span id="l52.182">   provider.init(&quot;aKey&quot;);</span>
<a href="#l52.183"></a><span id="l52.183"> </span>
<a href="#l52.184"></a><span id="l52.184">   provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l52.185"></a><span id="l52.185">     aListener.onStartRequest(null, null);</span>
<a href="#l52.186"></a><span id="l52.186">     cwc.window.setTimeout(function() {</span>
<a href="#l52.187"></a><span id="l52.187">       aListener.onStopRequest(null, null,</span>
<a href="#l52.188"></a><span id="l52.188">                               Cr.NS_OK);</span>
<a href="#l52.189"></a><span id="l52.189">     }, 500);</span>
<a href="#l52.190"></a><span id="l52.190" class="difflineminus">-  }</span>
<a href="#l52.191"></a><span id="l52.191" class="difflineplus">+  };</span>
<a href="#l52.192"></a><span id="l52.192">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l52.193"></a><span id="l52.193">   add_cloud_attachments(cwc, provider);</span>
<a href="#l52.194"></a><span id="l52.194"> </span>
<a href="#l52.195"></a><span id="l52.195">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l52.196"></a><span id="l52.196">   wait_for_notification_to_stop(cwc, kBoxId, &quot;bigAttachmentUploading&quot;);</span>
<a href="#l52.197"></a><span id="l52.197"> </span>
<a href="#l52.198"></a><span id="l52.198">   // Assert that the warning is displayed.</span>
<a href="#l52.199"></a><span id="l52.199">   assert_privacy_warning_notification_displayed(cwc, true);</span>
<a href="#l52.200"></a><span id="l52.200"> </span>
<a href="#l52.201"></a><span id="l52.201">   // Close the privacy warning notification...</span>
<a href="#l52.202"></a><span id="l52.202">   close_privacy_warning_notification(cwc);</span>
<a href="#l52.203"></a><span id="l52.203"> </span>
<a href="#l52.204"></a><span id="l52.204">   // And now upload some more files. We shouldn't get the warning again.</span>
<a href="#l52.205"></a><span id="l52.205" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(['./data/testFile3',</span>
<a href="#l52.206"></a><span id="l52.206" class="difflineminus">-                                              './data/testFile4'], __file__);</span>
<a href="#l52.207"></a><span id="l52.207" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile3&quot;,</span>
<a href="#l52.208"></a><span id="l52.208" class="difflineplus">+                                              &quot;./data/testFile4&quot;], __file__);</span>
<a href="#l52.209"></a><span id="l52.209">   add_cloud_attachments(cwc, provider, false);</span>
<a href="#l52.210"></a><span id="l52.210">   assert_privacy_warning_notification_displayed(cwc, false);</span>
<a href="#l52.211"></a><span id="l52.211"> </span>
<a href="#l52.212"></a><span id="l52.212">   close_compose_window(cwc);</span>
<a href="#l52.213"></a><span id="l52.213">   gMockPromptService.unregister();</span>
<a href="#l52.214"></a><span id="l52.214"> }</span>
<a href="#l52.215"></a><span id="l52.215"> </span>
<a href="#l52.216"></a><span id="l52.216"> /**</span>
<a href="#l52.217"></a><span id="l52.217">  * Test that the privacy warning notification does not persist when closing</span>
<a href="#l52.218"></a><span id="l52.218">  * and re-opening a compose window.</span>
<a href="#l52.219"></a><span id="l52.219">  */</span>
<a href="#l52.220"></a><span id="l52.220"> function test_privacy_warning_notification_no_persist() {</span>
<a href="#l52.221"></a><span id="l52.221">   gMockPromptService.register();</span>
<a href="#l52.222"></a><span id="l52.222">   gMockPromptService.returnValue = false;</span>
<a href="#l52.223"></a><span id="l52.223" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(['./data/testFile1',</span>
<a href="#l52.224"></a><span id="l52.224" class="difflineminus">-                                              './data/testFile2'], __file__);</span>
<a href="#l52.225"></a><span id="l52.225" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile1&quot;,</span>
<a href="#l52.226"></a><span id="l52.226" class="difflineplus">+                                              &quot;./data/testFile2&quot;], __file__);</span>
<a href="#l52.227"></a><span id="l52.227">   let provider = new MockCloudfileAccount();</span>
<a href="#l52.228"></a><span id="l52.228">   provider.init(&quot;aKey&quot;);</span>
<a href="#l52.229"></a><span id="l52.229"> </span>
<a href="#l52.230"></a><span id="l52.230">   provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l52.231"></a><span id="l52.231">     aListener.onStartRequest(null, null);</span>
<a href="#l52.232"></a><span id="l52.232">     cwc.window.setTimeout(function() {</span>
<a href="#l52.233"></a><span id="l52.233">       aListener.onStopRequest(null, null,</span>
<a href="#l52.234"></a><span id="l52.234">                               Cr.NS_OK);</span>
<a href="#l52.235"></a><span id="l52.235">     }, 500);</span>
<a href="#l52.236"></a><span id="l52.236" class="difflineminus">-  }</span>
<a href="#l52.237"></a><span id="l52.237" class="difflineplus">+  };</span>
<a href="#l52.238"></a><span id="l52.238">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l52.239"></a><span id="l52.239">   add_cloud_attachments(cwc, provider, false);</span>
<a href="#l52.240"></a><span id="l52.240"> </span>
<a href="#l52.241"></a><span id="l52.241">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l52.242"></a><span id="l52.242">   wait_for_notification_to_stop(cwc, kBoxId, &quot;bigAttachmentUploading&quot;);</span>
<a href="#l52.243"></a><span id="l52.243"> </span>
<a href="#l52.244"></a><span id="l52.244">   // Assert that the warning is displayed.</span>
<a href="#l52.245"></a><span id="l52.245">   assert_privacy_warning_notification_displayed(cwc, true);</span>
<a href="#l52.246"></a><span id="l52.246" class="difflineat">@@ -423,28 +424,28 @@ function test_privacy_warning_notificati</span>
<a href="#l52.247"></a><span id="l52.247"> </span>
<a href="#l52.248"></a><span id="l52.248"> /**</span>
<a href="#l52.249"></a><span id="l52.249">  * Test that if we close the privacy warning in a composer, it will still</span>
<a href="#l52.250"></a><span id="l52.250">  * spawn in a new one.</span>
<a href="#l52.251"></a><span id="l52.251">  */</span>
<a href="#l52.252"></a><span id="l52.252"> function test_privacy_warning_notification_open_after_close() {</span>
<a href="#l52.253"></a><span id="l52.253">   gMockPromptService.register();</span>
<a href="#l52.254"></a><span id="l52.254">   gMockPromptService.returnValue = false;</span>
<a href="#l52.255"></a><span id="l52.255" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(['./data/testFile1',</span>
<a href="#l52.256"></a><span id="l52.256" class="difflineminus">-                                              './data/testFile2'], __file__);</span>
<a href="#l52.257"></a><span id="l52.257" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile1&quot;,</span>
<a href="#l52.258"></a><span id="l52.258" class="difflineplus">+                                              &quot;./data/testFile2&quot;], __file__);</span>
<a href="#l52.259"></a><span id="l52.259">   let provider = new MockCloudfileAccount();</span>
<a href="#l52.260"></a><span id="l52.260">   provider.init(&quot;aKey&quot;);</span>
<a href="#l52.261"></a><span id="l52.261"> </span>
<a href="#l52.262"></a><span id="l52.262">   provider.uploadFile = function(aFile, aListener) {</span>
<a href="#l52.263"></a><span id="l52.263">     aListener.onStartRequest(null, null);</span>
<a href="#l52.264"></a><span id="l52.264">     cwc.window.setTimeout(function() {</span>
<a href="#l52.265"></a><span id="l52.265">       aListener.onStopRequest(null, null,</span>
<a href="#l52.266"></a><span id="l52.266">                               Cr.NS_OK);</span>
<a href="#l52.267"></a><span id="l52.267">     }, 500);</span>
<a href="#l52.268"></a><span id="l52.268" class="difflineminus">-  }</span>
<a href="#l52.269"></a><span id="l52.269" class="difflineplus">+  };</span>
<a href="#l52.270"></a><span id="l52.270">   let cwc = open_compose_new_mail(mc);</span>
<a href="#l52.271"></a><span id="l52.271">   add_cloud_attachments(cwc, provider, false);</span>
<a href="#l52.272"></a><span id="l52.272"> </span>
<a href="#l52.273"></a><span id="l52.273">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l52.274"></a><span id="l52.274">   wait_for_notification_to_stop(cwc, kBoxId, &quot;bigAttachmentUploading&quot;);</span>
<a href="#l52.275"></a><span id="l52.275"> </span>
<a href="#l52.276"></a><span id="l52.276">   // Assert that the warning is displayed.</span>
<a href="#l52.277"></a><span id="l52.277">   assert_privacy_warning_notification_displayed(cwc, true);</span>
<a href="#l52.278"></a><span id="l52.278" class="difflineat">@@ -452,18 +453,18 @@ function test_privacy_warning_notificati</span>
<a href="#l52.279"></a><span id="l52.279">   // Close the privacy warning notification...</span>
<a href="#l52.280"></a><span id="l52.280">   close_privacy_warning_notification(cwc);</span>
<a href="#l52.281"></a><span id="l52.281"> </span>
<a href="#l52.282"></a><span id="l52.282">   close_compose_window(cwc);</span>
<a href="#l52.283"></a><span id="l52.283"> </span>
<a href="#l52.284"></a><span id="l52.284">   // Open a new compose window</span>
<a href="#l52.285"></a><span id="l52.285">   cwc = open_compose_new_mail(mc);</span>
<a href="#l52.286"></a><span id="l52.286"> </span>
<a href="#l52.287"></a><span id="l52.287" class="difflineminus">-  gMockFilePicker.returnFiles = collectFiles(['./data/testFile3',</span>
<a href="#l52.288"></a><span id="l52.288" class="difflineminus">-                                              './data/testFile4'], __file__);</span>
<a href="#l52.289"></a><span id="l52.289" class="difflineplus">+  gMockFilePicker.returnFiles = collectFiles([&quot;./data/testFile3&quot;,</span>
<a href="#l52.290"></a><span id="l52.290" class="difflineplus">+                                              &quot;./data/testFile4&quot;], __file__);</span>
<a href="#l52.291"></a><span id="l52.291">   add_cloud_attachments(cwc, provider);</span>
<a href="#l52.292"></a><span id="l52.292"> </span>
<a href="#l52.293"></a><span id="l52.293">   assert_upload_notification_displayed(cwc, true);</span>
<a href="#l52.294"></a><span id="l52.294">   wait_for_notification_to_stop(cwc, kBoxId, &quot;bigAttachmentUploading&quot;);</span>
<a href="#l52.295"></a><span id="l52.295"> </span>
<a href="#l52.296"></a><span id="l52.296">   // Assert that the privacy warning notification is displayed again.</span>
<a href="#l52.297"></a><span id="l52.297">   assert_privacy_warning_notification_displayed(cwc, true);</span>
<a href="#l52.298"></a><span id="l52.298"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-backend-helpers.js</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -4,16 +4,18 @@</span>
<a href="#l53.4"></a><span id="l53.4"> </span>
<a href="#l53.5"></a><span id="l53.5"> &quot;use strict&quot;;</span>
<a href="#l53.6"></a><span id="l53.6"> </span>
<a href="#l53.7"></a><span id="l53.7"> var MODULE_NAME = &quot;cloudfile-backend-helpers&quot;;</span>
<a href="#l53.8"></a><span id="l53.8"> </span>
<a href="#l53.9"></a><span id="l53.9"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l53.10"></a><span id="l53.10"> var MODULE_REQUIRES = [&quot;window-helpers&quot;];</span>
<a href="#l53.11"></a><span id="l53.11"> </span>
<a href="#l53.12"></a><span id="l53.12" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l53.13"></a><span id="l53.13" class="difflineplus">+</span>
<a href="#l53.14"></a><span id="l53.14"> var kUserAuthRequested = &quot;cloudfile:auth&quot;;</span>
<a href="#l53.15"></a><span id="l53.15"> var kUserDataRequested = &quot;cloudfile:user&quot;;</span>
<a href="#l53.16"></a><span id="l53.16"> var kUploadFile = &quot;cloudfile:uploadFile&quot;;</span>
<a href="#l53.17"></a><span id="l53.17"> var kGetFileURL = &quot;cloudfile:getFileURL&quot;;</span>
<a href="#l53.18"></a><span id="l53.18"> var kDeleteFile = &quot;cloudfile:deleteFile&quot;;</span>
<a href="#l53.19"></a><span id="l53.19"> var kLogout = &quot;cloudfile:logout&quot;;</span>
<a href="#l53.20"></a><span id="l53.20"> </span>
<a href="#l53.21"></a><span id="l53.21"> var wh;</span>
<a href="#l53.22"></a><span id="l53.22" class="difflineat">@@ -27,61 +29,61 @@ function installInto(module) {</span>
<a href="#l53.23"></a><span id="l53.23">   module.kDeleteFile = kDeleteFile;</span>
<a href="#l53.24"></a><span id="l53.24">   module.kLogout = kLogout;</span>
<a href="#l53.25"></a><span id="l53.25">   module.SimpleRequestObserverManager = SimpleRequestObserverManager;</span>
<a href="#l53.26"></a><span id="l53.26">   module.SimpleRequestObserver = SimpleRequestObserver;</span>
<a href="#l53.27"></a><span id="l53.27">   module.assert_can_cancel_uploads = assert_can_cancel_uploads;</span>
<a href="#l53.28"></a><span id="l53.28"> }</span>
<a href="#l53.29"></a><span id="l53.29"> </span>
<a href="#l53.30"></a><span id="l53.30"> function setupModule(module) {</span>
<a href="#l53.31"></a><span id="l53.31" class="difflineminus">-  wh = collector.getModule('window-helpers');</span>
<a href="#l53.32"></a><span id="l53.32" class="difflineplus">+  wh = collector.getModule(&quot;window-helpers&quot;);</span>
<a href="#l53.33"></a><span id="l53.33"> }</span>
<a href="#l53.34"></a><span id="l53.34"> </span>
<a href="#l53.35"></a><span id="l53.35"> function SimpleRequestObserverManager() {</span>
<a href="#l53.36"></a><span id="l53.36">   this._observers = [];</span>
<a href="#l53.37"></a><span id="l53.37"> }</span>
<a href="#l53.38"></a><span id="l53.38"> </span>
<a href="#l53.39"></a><span id="l53.39"> SimpleRequestObserverManager.prototype = {</span>
<a href="#l53.40"></a><span id="l53.40" class="difflineminus">-  create: function(aName) {</span>
<a href="#l53.41"></a><span id="l53.41" class="difflineplus">+  create(aName) {</span>
<a href="#l53.42"></a><span id="l53.42">     let obs = new SimpleRequestObserver(aName);</span>
<a href="#l53.43"></a><span id="l53.43">     this._observers.push(obs);</span>
<a href="#l53.44"></a><span id="l53.44">     return obs;</span>
<a href="#l53.45"></a><span id="l53.45">   },</span>
<a href="#l53.46"></a><span id="l53.46"> </span>
<a href="#l53.47"></a><span id="l53.47" class="difflineminus">-  check: function() {</span>
<a href="#l53.48"></a><span id="l53.48" class="difflineplus">+  check() {</span>
<a href="#l53.49"></a><span id="l53.49">     for (let observer of this._observers) {</span>
<a href="#l53.50"></a><span id="l53.50">       if (!observer.success)</span>
<a href="#l53.51"></a><span id="l53.51">         throw new Error(&quot;An observer named &quot; + observer.name + &quot; was leftover, &quot;</span>
<a href="#l53.52"></a><span id="l53.52">                         + &quot;with its success attribute set to: &quot;</span>
<a href="#l53.53"></a><span id="l53.53">                         + observer.success);</span>
<a href="#l53.54"></a><span id="l53.54">     }</span>
<a href="#l53.55"></a><span id="l53.55">   },</span>
<a href="#l53.56"></a><span id="l53.56"> </span>
<a href="#l53.57"></a><span id="l53.57" class="difflineminus">-  reset: function() {</span>
<a href="#l53.58"></a><span id="l53.58" class="difflineplus">+  reset() {</span>
<a href="#l53.59"></a><span id="l53.59">     this._observers = [];</span>
<a href="#l53.60"></a><span id="l53.60" class="difflineminus">-  }</span>
<a href="#l53.61"></a><span id="l53.61" class="difflineminus">-}</span>
<a href="#l53.62"></a><span id="l53.62" class="difflineplus">+  },</span>
<a href="#l53.63"></a><span id="l53.63" class="difflineplus">+};</span>
<a href="#l53.64"></a><span id="l53.64"> </span>
<a href="#l53.65"></a><span id="l53.65"> function SimpleRequestObserver(aName) {</span>
<a href="#l53.66"></a><span id="l53.66">   this.name = aName;</span>
<a href="#l53.67"></a><span id="l53.67" class="difflineminus">-};</span>
<a href="#l53.68"></a><span id="l53.68" class="difflineplus">+}</span>
<a href="#l53.69"></a><span id="l53.69"> </span>
<a href="#l53.70"></a><span id="l53.70"> SimpleRequestObserver.prototype = {</span>
<a href="#l53.71"></a><span id="l53.71">   success: null,</span>
<a href="#l53.72"></a><span id="l53.72" class="difflineminus">-  onStartRequest: function(aRequest, aContext) {},</span>
<a href="#l53.73"></a><span id="l53.73" class="difflineminus">-  onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l53.74"></a><span id="l53.74" class="difflineplus">+  onStartRequest(aRequest, aContext) {},</span>
<a href="#l53.75"></a><span id="l53.75" class="difflineplus">+  onStopRequest(aRequest, aContext, aStatusCode) {</span>
<a href="#l53.76"></a><span id="l53.76">     if (Components.isSuccessCode(aStatusCode)) {</span>
<a href="#l53.77"></a><span id="l53.77">       this.success = true;</span>
<a href="#l53.78"></a><span id="l53.78">     } else {</span>
<a href="#l53.79"></a><span id="l53.79">       this.success = false;</span>
<a href="#l53.80"></a><span id="l53.80">     }</span>
<a href="#l53.81"></a><span id="l53.81">   },</span>
<a href="#l53.82"></a><span id="l53.82">   QueryInterface: ChromeUtils.generateQI([Ci.nsIRequestObserver,</span>
<a href="#l53.83"></a><span id="l53.83">                                           Ci.nsISupportsWeakReference]),</span>
<a href="#l53.84"></a><span id="l53.84" class="difflineminus">-}</span>
<a href="#l53.85"></a><span id="l53.85" class="difflineplus">+};</span>
<a href="#l53.86"></a><span id="l53.86"> </span>
<a href="#l53.87"></a><span id="l53.87"> /**</span>
<a href="#l53.88"></a><span id="l53.88">  * This function uploads one or more files, and then proceeds to cancel</span>
<a href="#l53.89"></a><span id="l53.89">  * them.  This function assumes that the mock server for the provider</span>
<a href="#l53.90"></a><span id="l53.90">  * is prepared for the uploaded files, and will give enough time for</span>
<a href="#l53.91"></a><span id="l53.91">  * the uploads to be cancelled before they complete.</span>
<a href="#l53.92"></a><span id="l53.92">  *</span>
<a href="#l53.93"></a><span id="l53.93">  * @param aController the controller to use for waitFors.</span>
<a href="#l53.94"></a><span id="l53.94" class="difflineat">@@ -90,24 +92,24 @@ SimpleRequestObserver.prototype = {</span>
<a href="#l53.95"></a><span id="l53.95">  */</span>
<a href="#l53.96"></a><span id="l53.96"> function assert_can_cancel_uploads(aController, aProvider, aFiles) {</span>
<a href="#l53.97"></a><span id="l53.97">   let fileListenerMap = [];</span>
<a href="#l53.98"></a><span id="l53.98">   wh.plan_for_observable_event(&quot;cloudfile:uploadStarted&quot;);</span>
<a href="#l53.99"></a><span id="l53.99"> </span>
<a href="#l53.100"></a><span id="l53.100">   for (let file of aFiles) {</span>
<a href="#l53.101"></a><span id="l53.101">     let mapping = {};</span>
<a href="#l53.102"></a><span id="l53.102">     mapping.listener = {</span>
<a href="#l53.103"></a><span id="l53.103" class="difflineminus">-      onStartRequest: function(aRequest, aContext) {</span>
<a href="#l53.104"></a><span id="l53.104" class="difflineplus">+      onStartRequest(aRequest, aContext) {</span>
<a href="#l53.105"></a><span id="l53.105">         mapping.started = true;</span>
<a href="#l53.106"></a><span id="l53.106">       },</span>
<a href="#l53.107"></a><span id="l53.107" class="difflineminus">-      onStopRequest: function(aRequest, aContext, aStatusCode) {</span>
<a href="#l53.108"></a><span id="l53.108" class="difflineminus">-        if (aStatusCode == Ci.nsIMsgCloudFileProvider.uploadCanceled)</span>
<a href="#l53.109"></a><span id="l53.109" class="difflineplus">+      onStopRequest(aRequest, aContext, aStatusCode) {</span>
<a href="#l53.110"></a><span id="l53.110" class="difflineplus">+        if (aStatusCode == cloudFileAccounts.constants.uploadCancelled)</span>
<a href="#l53.111"></a><span id="l53.111">           mapping.cancelled = true;</span>
<a href="#l53.112"></a><span id="l53.112">       },</span>
<a href="#l53.113"></a><span id="l53.113" class="difflineminus">-    }</span>
<a href="#l53.114"></a><span id="l53.114" class="difflineplus">+    };</span>
<a href="#l53.115"></a><span id="l53.115"> </span>
<a href="#l53.116"></a><span id="l53.116">     aProvider.uploadFile(file, mapping.listener);</span>
<a href="#l53.117"></a><span id="l53.117">     fileListenerMap.push(mapping);</span>
<a href="#l53.118"></a><span id="l53.118">   }</span>
<a href="#l53.119"></a><span id="l53.119"> </span>
<a href="#l53.120"></a><span id="l53.120">   // Wait for the first file to start uploading...</span>
<a href="#l53.121"></a><span id="l53.121">   wh.wait_for_observable_event(&quot;cloudfile:uploadStarted&quot;);</span>
<a href="#l53.122"></a><span id="l53.122"> </span>
<a href="#l53.123"></a><span id="l53.123" class="difflineat">@@ -116,11 +118,11 @@ function assert_can_cancel_uploads(aCont</span>
<a href="#l53.124"></a><span id="l53.124">   for (let i = aFiles.length - 1; i &gt;= 0; --i) {</span>
<a href="#l53.125"></a><span id="l53.125">     aProvider.cancelFileUpload(aFiles[i]);</span>
<a href="#l53.126"></a><span id="l53.126">   }</span>
<a href="#l53.127"></a><span id="l53.127"> </span>
<a href="#l53.128"></a><span id="l53.128">   aController.waitFor(function() {</span>
<a href="#l53.129"></a><span id="l53.129">     return fileListenerMap.length == aFiles.length &amp;&amp;</span>
<a href="#l53.130"></a><span id="l53.130">            fileListenerMap.every(function(aMapping) {</span>
<a href="#l53.131"></a><span id="l53.131">              return aMapping.cancelled;</span>
<a href="#l53.132"></a><span id="l53.132" class="difflineminus">-           })</span>
<a href="#l53.133"></a><span id="l53.133" class="difflineplus">+           });</span>
<a href="#l53.134"></a><span id="l53.134">   }, &quot;Timed out waiting for cancellation to occur&quot;);</span>
<a href="#l53.135"></a><span id="l53.135"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-helpers.js</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -2,45 +2,42 @@</span>
<a href="#l54.4"></a><span id="l54.4">  * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l54.5"></a><span id="l54.5">   * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l54.6"></a><span id="l54.6"> </span>
<a href="#l54.7"></a><span id="l54.7"> &quot;use strict&quot;;</span>
<a href="#l54.8"></a><span id="l54.8"> </span>
<a href="#l54.9"></a><span id="l54.9"> var MODULE_NAME = &quot;cloudfile-helpers&quot;;</span>
<a href="#l54.10"></a><span id="l54.10"> </span>
<a href="#l54.11"></a><span id="l54.11"> var RELATIVE_ROOT = &quot;../shared-modules&quot;;</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineminus">-var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;, &quot;mock-object-helpers&quot;];</span>
<a href="#l54.13"></a><span id="l54.13" class="difflineplus">+var MODULE_REQUIRES = [&quot;folder-display-helpers&quot;];</span>
<a href="#l54.14"></a><span id="l54.14"> </span>
<a href="#l54.15"></a><span id="l54.15"> var {Services} = ChromeUtils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l54.16"></a><span id="l54.16" class="difflineminus">-var {XPCOMUtils} = ChromeUtils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l54.17"></a><span id="l54.17" class="difflineplus">+var {cloudFileAccounts} = ChromeUtils.import(&quot;resource:///modules/cloudFileAccounts.js&quot;);</span>
<a href="#l54.18"></a><span id="l54.18"> var os = ChromeUtils.import(&quot;chrome://mozmill/content/stdlib/os.jsm&quot;);</span>
<a href="#l54.19"></a><span id="l54.19"> </span>
<a href="#l54.20"></a><span id="l54.20"> var kMockContractIDPrefix = &quot;@mozilla.org/mail/mockCloudFile;1?id=&quot;;</span>
<a href="#l54.21"></a><span id="l54.21"> </span>
<a href="#l54.22"></a><span id="l54.22"> var kDefaults = {</span>
<a href="#l54.23"></a><span id="l54.23" class="difflineminus">-  iconClass: &quot;chrome://messenger/skin/icons/box-logo.png&quot;,</span>
<a href="#l54.24"></a><span id="l54.24" class="difflineplus">+  iconURL: &quot;chrome://messenger/skin/icons/box-logo.png&quot;,</span>
<a href="#l54.25"></a><span id="l54.25">   accountKey: null,</span>
<a href="#l54.26"></a><span id="l54.26">   settingsURL: &quot;&quot;,</span>
<a href="#l54.27"></a><span id="l54.27">   managementURL: &quot;&quot;,</span>
<a href="#l54.28"></a><span id="l54.28" class="difflineminus">-  authErr: Ci.nsIMsgCloudFileProvider.authErr,</span>
<a href="#l54.29"></a><span id="l54.29" class="difflineminus">-  offlineErr: Ci.nsIMsgCloudFileProvider.offlineErr,</span>
<a href="#l54.30"></a><span id="l54.30" class="difflineminus">-  uploadErr: Ci.nsIMsgCloudFileProvider.uploadErr,</span>
<a href="#l54.31"></a><span id="l54.31" class="difflineminus">-  uploadWouldExceedQuota: Ci.nsIMsgCloudFileProvider.uploadWouldExceedQuota,</span>
<a href="#l54.32"></a><span id="l54.32" class="difflineminus">-  uploadExceedsFileLimit: Ci.nsIMsgCloudFileProvider.uploadExceedsFileLimit,</span>
<a href="#l54.33"></a><span id="l54.33" class="difflineminus">-  uploadCanceled: Ci.nsIMsgCloudFileProvider.uploadCanceled,</span>
<a href="#l54.34"></a><span id="l54.34" class="difflineplus">+  authErr: cloudFileAccounts.constants.authErr,</span>
<a href="#l54.35"></a><span id="l54.35" class="difflineplus">+  offlineErr: cloudFileAccounts.constants.offlineErr,</span>
<a href="#l54.36"></a><span id="l54.36" class="difflineplus">+  uploadErr: cloudFileAccounts.constants.uploadErr,</span>
<a href="#l54.37"></a><span id="l54.37" class="difflineplus">+  uploadWouldExceedQuota: cloudFileAccounts.constants.uploadWouldExceedQuota,</span>
<a href="#l54.38"></a><span id="l54.38" class="difflineplus">+  uploadExceedsFileLimit: cloudFileAccounts.constants.uploadExceedsFileLimit,</span>
<a href="#l54.39"></a><span id="l54.39" class="difflineplus">+  uploadCancelled: cloudFileAccounts.constants.uploadCancelled,</span>
<a href="#l54.40"></a><span id="l54.40"> };</span>
<a href="#l54.41"></a><span id="l54.41"> </span>
<a href="#l54.42"></a><span id="l54.42" class="difflineminus">-var fdh, moh;</span>
<a href="#l54.43"></a><span id="l54.43" class="difflineplus">+var fdh;</span>
<a href="#l54.44"></a><span id="l54.44"> </span>
<a href="#l54.45"></a><span id="l54.45"> function setupModule(module) {</span>
<a href="#l54.46"></a><span id="l54.46">   fdh = collector.getModule(&quot;folder-display-helpers&quot;);</span>
<a href="#l54.47"></a><span id="l54.47">   fdh.installInto(module);</span>
<a href="#l54.48"></a><span id="l54.48" class="difflineminus">-</span>
<a href="#l54.49"></a><span id="l54.49" class="difflineminus">-  moh = collector.getModule(&quot;mock-object-helpers&quot;);</span>
<a href="#l54.50"></a><span id="l54.50" class="difflineminus">-  moh.installInto(module);</span>
<a href="#l54.51"></a><span id="l54.51"> }</span>
<a href="#l54.52"></a><span id="l54.52"> </span>
<a href="#l54.53"></a><span id="l54.53"> function installInto(module) {</span>
<a href="#l54.54"></a><span id="l54.54">   setupModule(module);</span>
<a href="#l54.55"></a><span id="l54.55">   module.gMockCloudfileManager = gMockCloudfileManager;</span>
<a href="#l54.56"></a><span id="l54.56">   module.MockCloudfileAccount = MockCloudfileAccount;</span>
<a href="#l54.57"></a><span id="l54.57">   module.getFile = getFile;</span>
<a href="#l54.58"></a><span id="l54.58">   module.collectFiles = collectFiles;</span>
<a href="#l54.59"></a><span id="l54.59" class="difflineat">@@ -67,128 +64,90 @@ function getFile(aFilename, aRoot) {</span>
<a href="#l54.60"></a><span id="l54.60">  * let files = collectFiles(['./data/testFile1', './data/testFile2'],</span>
<a href="#l54.61"></a><span id="l54.61">  *                          __file__);</span>
<a href="#l54.62"></a><span id="l54.62">  */</span>
<a href="#l54.63"></a><span id="l54.63"> function collectFiles(aFiles, aFileRoot) {</span>
<a href="#l54.64"></a><span id="l54.64">   return aFiles.map(filename =&gt; getFile(filename, aFileRoot));</span>
<a href="#l54.65"></a><span id="l54.65"> }</span>
<a href="#l54.66"></a><span id="l54.66"> </span>
<a href="#l54.67"></a><span id="l54.67"> function MockCloudfileAccount() {</span>
<a href="#l54.68"></a><span id="l54.68" class="difflineminus">-  for(let someDefault in kDefaults)</span>
<a href="#l54.69"></a><span id="l54.69" class="difflineplus">+  for (let someDefault in kDefaults)</span>
<a href="#l54.70"></a><span id="l54.70">     this[someDefault] = kDefaults[someDefault];</span>
<a href="#l54.71"></a><span id="l54.71"> }</span>
<a href="#l54.72"></a><span id="l54.72"> </span>
<a href="#l54.73"></a><span id="l54.73"> MockCloudfileAccount.prototype = {</span>
<a href="#l54.74"></a><span id="l54.74" class="difflineminus">-</span>
<a href="#l54.75"></a><span id="l54.75" class="difflineminus">-  QueryInterface: ChromeUtils.generateQI([Ci.nsIMsgCloudFileProvider]),</span>
<a href="#l54.76"></a><span id="l54.76" class="difflineminus">-</span>
<a href="#l54.77"></a><span id="l54.77" class="difflineminus">-  init: function MCA_init(aAccountKey) {</span>
<a href="#l54.78"></a><span id="l54.78" class="difflineplus">+  init(aAccountKey) {</span>
<a href="#l54.79"></a><span id="l54.79">     this.accountKey = aAccountKey;</span>
<a href="#l54.80"></a><span id="l54.80">   },</span>
<a href="#l54.81"></a><span id="l54.81"> </span>
<a href="#l54.82"></a><span id="l54.82" class="difflineminus">-  uploadFile: function MCA_uploadFile(aFile, aListener) {</span>
<a href="#l54.83"></a><span id="l54.83" class="difflineplus">+  uploadFile(aFile, aListener) {</span>
<a href="#l54.84"></a><span id="l54.84">     aListener.onStartRequest(null, null);</span>
<a href="#l54.85"></a><span id="l54.85">     fdh.mc.window.setTimeout(function() {</span>
<a href="#l54.86"></a><span id="l54.86">       aListener.onStopRequest(null, null, Cr.NS_OK);</span>
<a href="#l54.87"></a><span id="l54.87">     }, 0);</span>
<a href="#l54.88"></a><span id="l54.88">   },</span>
<a href="#l54.89"></a><span id="l54.89"> </span>
<a href="#l54.90"></a><span id="l54.90" class="difflineminus">-  urlForFile: function MCA_urlForFile(aFile) {</span>
<a href="#l54.91"></a><span id="l54.91" class="difflineplus">+  urlForFile(aFile) {</span>
<a href="#l54.92"></a><span id="l54.92">     return &quot;http://www.example.com/&quot; + this.accountKey + &quot;/&quot; +</span>
<a href="#l54.93"></a><span id="l54.93">            aFile.leafName;</span>
<a href="#l54.94"></a><span id="l54.94">   },</span>
<a href="#l54.95"></a><span id="l54.95"> </span>
<a href="#l54.96"></a><span id="l54.96" class="difflineminus">-  refreshUserInfo: function MCA_refreshUserInfo(aWithUI,</span>
<a href="#l54.97"></a><span id="l54.97" class="difflineminus">-                                                aCallback) {</span>
<a href="#l54.98"></a><span id="l54.98" class="difflineplus">+  refreshUserInfo(aWithUI, aCallback) {</span>
<a href="#l54.99"></a><span id="l54.99">     aCallback.onStartRequest(null, null);</span>
<a href="#l54.100"></a><span id="l54.100">     aCallback.onStopRequest(null, null, Cr.NS_OK);</span>
<a href="#l54.101"></a><span id="l54.101">   },</span>
<a href="#l54.102"></a><span id="l54.102"> </span>
<a href="#l54.103"></a><span id="l54.103" class="difflineminus">-  cancelFileUpload: function MCA_cancelFileUpload(aFile) {</span>
<a href="#l54.104"></a><span id="l54.104" class="difflineplus">+  cancelFileUpload(aFile) {</span>
<a href="#l54.105"></a><span id="l54.105">     throw Cr.NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l54.106"></a><span id="l54.106">   },</span>
<a href="#l54.107"></a><span id="l54.107"> </span>
<a href="#l54.108"></a><span id="l54.108" class="difflineminus">-  providerUrlForError: function MCA_providerUrlForError(aStatusCode) {</span>
<a href="#l54.109"></a><span id="l54.109" class="difflineplus">+  providerUrlForError(aStatusCode) {</span>
<a href="#l54.110"></a><span id="l54.110">     return &quot;&quot;;</span>
<a href="#l54.111"></a><span id="l54.111">   },</span>
<a href="#l54.112"></a><span id="l54.112"> </span>
<a href="#l54.113"></a><span id="l54.113" class="difflineminus">-  deleteFile: function MCA_deleteFile(aFile, aCallback) {</span>
<a href="#l54.114"></a><span id="l54.114" class="difflineplus">+  deleteFile(aFile, aCallback) {</span>
<a href="#l54.115"></a><span id="l54.115">     aCallback.onStartRequest(null, null);</span>
<a href="#l54.116"></a><span id="l54.116">     fdh.mc.window.setTimeout(function() {</span>
<a href="#l54.117"></a><span id="l54.117">       aCallback.onStopRequest(null, null, Cr.NS_OK);</span>
<a href="#l54.118"></a><span id="l54.118">     }, 0);</span>
<a href="#l54.119"></a><span id="l54.119">   },</span>
<a href="#l54.120"></a><span id="l54.120"> </span>
<a href="#l54.121"></a><span id="l54.121">   get displayName() {</span>
<a href="#l54.122"></a><span id="l54.122" class="difflineminus">-    return &quot;Mock Storage: &quot; + this.accountKey;</span>
<a href="#l54.123"></a><span id="l54.123" class="difflineplus">+    return cloudFileAccounts.getDisplayName(this.accountKey);</span>
<a href="#l54.124"></a><span id="l54.124">   },</span>
<a href="#l54.125"></a><span id="l54.125"> };</span>
<a href="#l54.126"></a><span id="l54.126"> </span>
<a href="#l54.127"></a><span id="l54.127" class="difflineminus">-</span>
<a href="#l54.128"></a><span id="l54.128" class="difflineminus">-function MockCloudfileProviderGenerator(aID, aOverrides) {</span>
<a href="#l54.129"></a><span id="l54.129" class="difflineminus">-  let constructor = function MockCloudfileAccount() {</span>
<a href="#l54.130"></a><span id="l54.130" class="difflineminus">-</span>
<a href="#l54.131"></a><span id="l54.131" class="difflineminus">-    for(let someDefault in kDefaults)</span>
<a href="#l54.132"></a><span id="l54.132" class="difflineminus">-      this[someDefault] = kDefaults[someDefault];</span>
<a href="#l54.133"></a><span id="l54.133" class="difflineminus">-</span>
<a href="#l54.134"></a><span id="l54.134" class="difflineminus">-    for (let override in aOverrides)</span>
<a href="#l54.135"></a><span id="l54.135" class="difflineminus">-      this[override] = aOverrides[override];</span>
<a href="#l54.136"></a><span id="l54.136" class="difflineminus">-</span>
<a href="#l54.137"></a><span id="l54.137" class="difflineminus">-    this.type = aID;</span>
<a href="#l54.138"></a><span id="l54.138" class="difflineminus">-  }</span>
<a href="#l54.139"></a><span id="l54.139" class="difflineminus">-</span>
<a href="#l54.140"></a><span id="l54.140" class="difflineminus">-  constructor.prototype = MockCloudfileAccount.prototype;</span>
<a href="#l54.141"></a><span id="l54.141" class="difflineminus">-</span>
<a href="#l54.142"></a><span id="l54.142" class="difflineminus">-  return constructor;</span>
<a href="#l54.143"></a><span id="l54.143" class="difflineminus">-}</span>
<a href="#l54.144"></a><span id="l54.144" class="difflineminus">-</span>
<a href="#l54.145"></a><span id="l54.145"> var gMockCloudfileManager = {</span>
<a href="#l54.146"></a><span id="l54.146">   _mock_map: {},</span>
<a href="#l54.147"></a><span id="l54.147"> </span>
<a href="#l54.148"></a><span id="l54.148" class="difflineminus">-  register: function MCM_register(aID, aOverrides) {</span>
<a href="#l54.149"></a><span id="l54.149" class="difflineplus">+  register(aID, aOverrides) {</span>
<a href="#l54.150"></a><span id="l54.150">     if (!aID)</span>
<a href="#l54.151"></a><span id="l54.151">       aID = &quot;default&quot;;</span>
<a href="#l54.152"></a><span id="l54.152"> </span>
<a href="#l54.153"></a><span id="l54.153" class="difflineminus">-    if (aID in this._mock_map)</span>
<a href="#l54.154"></a><span id="l54.154" class="difflineminus">-      throw Error(&quot;Already registered a mock cloudfile provider with id = &quot; +</span>
<a href="#l54.155"></a><span id="l54.155" class="difflineminus">-                  aID);</span>
<a href="#l54.156"></a><span id="l54.156" class="difflineminus">-</span>
<a href="#l54.157"></a><span id="l54.157">     if (!aOverrides)</span>
<a href="#l54.158"></a><span id="l54.158">       aOverrides = {};</span>
<a href="#l54.159"></a><span id="l54.159"> </span>
<a href="#l54.160"></a><span id="l54.160" class="difflineminus">-    let mockContractID = kMockContractIDPrefix + aID;</span>
<a href="#l54.161"></a><span id="l54.161" class="difflineminus">-    let mockID = aID;</span>
<a href="#l54.162"></a><span id="l54.162" class="difflineminus">-    let mockCID = this._generateCID();</span>
<a href="#l54.163"></a><span id="l54.163" class="difflineplus">+    cloudFileAccounts.registerProvider(aID, {</span>
<a href="#l54.164"></a><span id="l54.164" class="difflineplus">+      type: aID,</span>
<a href="#l54.165"></a><span id="l54.165" class="difflineplus">+      displayName: aID,</span>
<a href="#l54.166"></a><span id="l54.166" class="difflineplus">+      iconURL: &quot;chrome://messenger/skin/icons/box-logo.png&quot;,</span>
<a href="#l54.167"></a><span id="l54.167" class="difflineplus">+      initAccount(accountKey) {</span>
<a href="#l54.168"></a><span id="l54.168" class="difflineplus">+        let account = new MockCloudfileAccount();</span>
<a href="#l54.169"></a><span id="l54.169"> </span>
<a href="#l54.170"></a><span id="l54.170" class="difflineminus">-    let component = new moh.MockObjectRegisterer(</span>
<a href="#l54.171"></a><span id="l54.171" class="difflineminus">-      mockContractID,</span>
<a href="#l54.172"></a><span id="l54.172" class="difflineminus">-      mockCID,</span>
<a href="#l54.173"></a><span id="l54.173" class="difflineminus">-      MockCloudfileProviderGenerator(aID, aOverrides));</span>
<a href="#l54.174"></a><span id="l54.174" class="difflineplus">+        for (let someDefault in kDefaults)</span>
<a href="#l54.175"></a><span id="l54.175" class="difflineplus">+          account[someDefault] = kDefaults[someDefault];</span>
<a href="#l54.176"></a><span id="l54.176"> </span>
<a href="#l54.177"></a><span id="l54.177" class="difflineminus">-    this._mock_map[aID] = component;</span>
<a href="#l54.178"></a><span id="l54.178" class="difflineplus">+        for (let override in aOverrides)</span>
<a href="#l54.179"></a><span id="l54.179" class="difflineplus">+          account[override] = aOverrides[override];</span>
<a href="#l54.180"></a><span id="l54.180"> </span>
<a href="#l54.181"></a><span id="l54.181" class="difflineminus">-    Services.catMan.addCategoryEntry(&quot;cloud-files&quot;, mockID,</span>
<a href="#l54.182"></a><span id="l54.182" class="difflineminus">-                                     mockContractID, false, true);</span>
<a href="#l54.183"></a><span id="l54.183" class="difflineminus">-    this._mock_map[aID].register();</span>
<a href="#l54.184"></a><span id="l54.184" class="difflineplus">+        account.init(accountKey);</span>
<a href="#l54.185"></a><span id="l54.185" class="difflineplus">+        return account;</span>
<a href="#l54.186"></a><span id="l54.186" class="difflineplus">+      },</span>
<a href="#l54.187"></a><span id="l54.187" class="difflineplus">+    });</span>
<a href="#l54.188"></a><span id="l54.188">   },</span>
<a href="#l54.189"></a><span id="l54.189"> </span>
<a href="#l54.190"></a><span id="l54.190" class="difflineminus">-  unregister: function MCM_unregister(aID) {</span>
<a href="#l54.191"></a><span id="l54.191" class="difflineplus">+  unregister(aID) {</span>
<a href="#l54.192"></a><span id="l54.192">     if (!aID)</span>
<a href="#l54.193"></a><span id="l54.193">       aID = &quot;default&quot;;</span>
<a href="#l54.194"></a><span id="l54.194"> </span>
<a href="#l54.195"></a><span id="l54.195" class="difflineminus">-    if (!(aID in this._mock_map))</span>
<a href="#l54.196"></a><span id="l54.196" class="difflineminus">-      throw Error(&quot;No registered mock cloudfile provider with id = &quot; +</span>
<a href="#l54.197"></a><span id="l54.197" class="difflineminus">-                  aID);</span>
<a href="#l54.198"></a><span id="l54.198" class="difflineminus">-</span>
<a href="#l54.199"></a><span id="l54.199" class="difflineminus">-    Services.catMan.deleteCategoryEntry(&quot;cloud-files&quot;, aID, false);</span>
<a href="#l54.200"></a><span id="l54.200" class="difflineminus">-    this._mock_map[aID].unregister();</span>
<a href="#l54.201"></a><span id="l54.201" class="difflineminus">-    delete this._mock_map[aID];</span>
<a href="#l54.202"></a><span id="l54.202" class="difflineplus">+    cloudFileAccounts.unregisterProvider(aID);</span>
<a href="#l54.203"></a><span id="l54.203">   },</span>
<a href="#l54.204"></a><span id="l54.204" class="difflineminus">-</span>
<a href="#l54.205"></a><span id="l54.205" class="difflineminus">-  _generateCID: function MCM__generateCID() {</span>
<a href="#l54.206"></a><span id="l54.206" class="difflineminus">-    let uuid = this._uuidService.generateUUID().toString();</span>
<a href="#l54.207"></a><span id="l54.207" class="difflineminus">-    return uuid.replace('{', '').replace('}', '');</span>
<a href="#l54.208"></a><span id="l54.208" class="difflineminus">-  },</span>
<a href="#l54.209"></a><span id="l54.209" class="difflineminus">-}</span>
<a href="#l54.210"></a><span id="l54.210" class="difflineminus">-</span>
<a href="#l54.211"></a><span id="l54.211" class="difflineminus">-XPCOMUtils.defineLazyServiceGetter(gMockCloudfileManager, &quot;_uuidService&quot;,</span>
<a href="#l54.212"></a><span id="l54.212" class="difflineminus">-                                   &quot;@mozilla.org/uuid-generator;1&quot;,</span>
<a href="#l54.213"></a><span id="l54.213" class="difflineminus">-                                   &quot;nsIUUIDGenerator&quot;);</span>
<a href="#l54.214"></a><span id="l54.214" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mail/test/mozmill/shared-modules/test-cloudfile-hightail-helpers.js</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -21,74 +21,74 @@ var kFolderInitUploadPath = kFolderPath </span>
<a href="#l55.4"></a><span id="l55.4"> var kFolderCommitUploadPath = kFolderPath + &quot;file/commitUpload&quot;;</span>
<a href="#l55.5"></a><span id="l55.5"> var kDeletePath = kFolderPath + &quot;file&quot;;</span>
<a href="#l55.6"></a><span id="l55.6"> var kDefaultFileUploadPath = &quot;/uploads&quot;;</span>
<a href="#l55.7"></a><span id="l55.7"> var kDownloadURLPrefix = &quot;http://www.example.com/downloads&quot;;</span>
<a href="#l55.8"></a><span id="l55.8"> </span>
<a href="#l55.9"></a><span id="l55.9"> var kAuthResult = {</span>
<a href="#l55.10"></a><span id="l55.10">   authToken: &quot;someAuthToken&quot;,</span>
<a href="#l55.11"></a><span id="l55.11">   errorStatus: null,</span>
<a href="#l55.12"></a><span id="l55.12" class="difflineminus">-}</span>
<a href="#l55.13"></a><span id="l55.13" class="difflineplus">+};</span>
<a href="#l55.14"></a><span id="l55.14"> </span>
<a href="#l55.15"></a><span id="l55.15"> var kDefaultConfig = {</span>
<a href="#l55.16"></a><span id="l55.16" class="difflineminus">-  port: kDefaultServerPort</span>
<a href="#l55.17"></a><span id="l55.17" class="difflineminus">-}</span>
<a href="#l55.18"></a><span id="l55.18" class="difflineplus">+  port: kDefaultServerPort,</span>
<a href="#l55.19"></a><span id="l55.19" class="difflineplus">+};</span>
<a href="#l55.20"></a><span id="l55.20"> </span>
<a href="#l55.21"></a><span id="l55.21"> var kDefaultReturnHeader = {</span>
<a href="#l55.22"></a><span id="l55.22">   statusCode: 200,</span>
<a href="#l55.23"></a><span id="l55.23">   statusString: &quot;OK&quot;,</span>
<a href="#l55.24"></a><span id="l55.24">   contentType: &quot;text/plain&quot;,</span>
<a href="#l55.25"></a><span id="l55.25" class="difflineminus">-}</span>
<a href="#l55.26"></a><span id="l55.26" class="difflineplus">+};</span>
<a href="#l55.27"></a><span id="l55.27"> </span>
<a href="#l55.28"></a><span id="l55.28"> var kDefaultUser = {</span>
<a href="#l55.29"></a><span id="l55.29">   key: null,</span>
<a href="#l55.30"></a><span id="l55.30">   id: null,</span>
<a href="#l55.31"></a><span id="l55.31">   type: &quot;BAS&quot;,</span>
<a href="#l55.32"></a><span id="l55.32">   policy: null,</span>
<a href="#l55.33"></a><span id="l55.33">   version: &quot;v3&quot;,</span>
<a href="#l55.34"></a><span id="l55.34">   password: null,</span>
<a href="#l55.35"></a><span id="l55.35" class="difflineminus">-  role:null,</span>
<a href="#l55.36"></a><span id="l55.36" class="difflineplus">+  role: null,</span>
<a href="#l55.37"></a><span id="l55.37">   email: &quot;john@example.com&quot;,</span>
<a href="#l55.38"></a><span id="l55.38">   firstname: &quot;John&quot;,</span>
<a href="#l55.39"></a><span id="l55.39">   lastname: &quot;User&quot;,</span>
<a href="#l55.40"></a><span id="l55.40">   created: null,</span>
<a href="#l55.41"></a><span id="l55.41">   account: {</span>
<a href="#l55.42"></a><span id="l55.42">     passwordProtect: &quot;Pay-per-use&quot;,</span>
<a href="#l55.43"></a><span id="l55.43">     returnReceipt: &quot;Pay-per-use&quot;,</span>
<a href="#l55.44"></a><span id="l55.44">     availableStorage: &quot;2147483648&quot;,</span>
<a href="#l55.45"></a><span id="l55.45">     billingPlan: null,</span>
<a href="#l55.46"></a><span id="l55.46">     controlExpirationDate: null,</span>
<a href="#l55.47"></a><span id="l55.47">     dropboxUrl: null,</span>
<a href="#l55.48"></a><span id="l55.48">     knowledgeBase: &quot;Yes&quot;,</span>
<a href="#l55.49"></a><span id="l55.49">     maxDownloadBWpermonth: &quot;1073741824&quot;,</span>
<a href="#l55.50"></a><span id="l55.50">     maxFileDownloads: &quot;100&quot;,</span>
<a href="#l55.51"></a><span id="l55.51">     maxFileSize: &quot;104857600&quot;,</span>
<a href="#l55.52"></a><span id="l55.52">     premiumDelivery: null,</span>
<a href="#l55.53"></a><span id="l55.53" class="difflineminus">-    verifyRecipientIdentity: &quot;Included&quot;</span>
<a href="#l55.54"></a><span id="l55.54" class="difflineplus">+    verifyRecipientIdentity: &quot;Included&quot;,</span>
<a href="#l55.55"></a><span id="l55.55">   },</span>
<a href="#l55.56"></a><span id="l55.56">   storage: {</span>
<a href="#l55.57"></a><span id="l55.57">     currentUsage: 1045,</span>
<a href="#l55.58"></a><span id="l55.58" class="difflineminus">-    storageQuota: 2147483648</span>
<a href="#l55.59"></a><span id="l55.59" class="difflineplus">+    storageQuota: 2147483648,</span>
<a href="#l55.60"></a><span id="l55.60">   },</span>
<a href="#l55.61"></a><span id="l55.61">   status: null,</span>
<a href="#l55.62"></a><span id="l55.62">   errorStatus: null,</span>
<a href="#l55.63"></a><span id="l55.63"> };</span>
<a href="#l55.64"></a><span id="l55.64"> </span>
<a href="#l55.65"></a><span id="l55.65"> var kDefaultFilePrepare = {</span>
<a href="#l55.66"></a><span id="l55.66">   fileId: &quot;&quot;,</span>
<a href="#l55.67"></a><span id="l55.67">   uploadUrl: [</span>
<a href="#l55.68"></a><span id="l55.68">   ],</span>
<a href="#l55.69"></a><span id="l55.69">   status: null,</span>
<a href="#l55.70"></a><span id="l55.70">   errorStatus: null,</span>
<a href="#l55.71"></a><span id="l55.71" class="difflineminus">-}</span>
<a href="#l55.72"></a><span id="l55.72" class="difflineplus">+};</span>
<a href="#l55.73"></a><span id="l55.73"> </span>
<a href="#l55.74"></a><span id="l55.74"> var kDefaultCommitReturn = {</span>
<a href="#l55.75"></a><span id="l55.75">   clickableDownloadUrl: &quot;&quot;,</span>
<a href="#l55.76"></a><span id="l55.76">   errorStatus: null,</span>
<a href="#l55.77"></a><span id="l55.77" class="difflineminus">-}</span>
<a href="#l55.78"></a><span id="l55.78" class="difflineplus">+};</span>
<a href="#l55.79"></a><span id="l55.79"> </span>
<a href="#l55.80"></a><span id="l55.80"> function installInto(module) {</span>
<a href="#l55.81"></a><span id="l55.81">   module.MockHightailServer = MockHightailServer;</span>
<a href="#l55.82"></a><span id="l55.82">   module.MockHightailAuthCounter = MockHightailAuthCounter;</span>
<a href="#l55.83"></a><span id="l55.83">   module.MockHightailDeleterStaleToken = MockHightailDeleterStaleToken;</span>
<a href="#l55.84"></a><span id="l55.84">   module.remember_hightail_credentials = remember_hightail_credentials;</span>
<a href="#l55.85"></a><span id="l55.85"> }</span>
<a href="#l55.86"></a><span id="l55.86"> </span>
<a href="#l55.87"></a><span id="l55.87" class="difflineat">@@ -100,54 +100,52 @@ function MockHightailServer() {</span>
<a href="#l55.88"></a><span id="l55.88">   this.receiver = new MockHightailReceiverSimple(this);</span>
<a href="#l55.89"></a><span id="l55.89">   this.deleter = new MockHightailDeleterSimple(this);</span>
<a href="#l55.90"></a><span id="l55.90">   this.preparer = new MockHightailPrepareSimple(this);</span>
<a href="#l55.91"></a><span id="l55.91"> }</span>
<a href="#l55.92"></a><span id="l55.92"> </span>
<a href="#l55.93"></a><span id="l55.93"> MockHightailServer.prototype = {</span>
<a href="#l55.94"></a><span id="l55.94">   _server: null,</span>
<a href="#l55.95"></a><span id="l55.95"> </span>
<a href="#l55.96"></a><span id="l55.96" class="difflineminus">-  getPreparedBackend: function MDBS_getPreparedBackend(aAccountKey) {</span>
<a href="#l55.97"></a><span id="l55.97" class="difflineplus">+  getPreparedBackend(aAccountKey) {</span>
<a href="#l55.98"></a><span id="l55.98">     let username = this.userInfo.username;</span>
<a href="#l55.99"></a><span id="l55.99" class="difflineminus">-    Services.prefs.setCharPref(&quot;mail.cloud_files.accounts.&quot; + aAccountKey</span>
<a href="#l55.100"></a><span id="l55.100" class="difflineminus">-                               + &quot;.username&quot;, username);</span>
<a href="#l55.101"></a><span id="l55.101" class="difflineplus">+    Services.prefs.setCharPref(`mail.cloud_files.accounts.${aAccountKey}.type`, &quot;YouSendIt&quot;);</span>
<a href="#l55.102"></a><span id="l55.102" class="difflineplus">+    Services.prefs.setCharPref(`mail.cloud_files.accounts.${aAccountKey}.username`, username);</span>
<a href="#l55.103"></a><span id="l55.103"> </span>
<a href="#l55.104"></a><span id="l55.104">     cloudFileAccounts.setSecretValue(aAccountKey, cloudFileAccounts.kTokenRealm, &quot;someAuthToken&quot;);</span>
<a href="#l55.105"></a><span id="l55.105"> </span>
<a href="#l55.106"></a><span id="l55.106" class="difflineminus">-    let hightail = Cc[&quot;@mozilla.org/mail/hightail;1&quot;]</span>
<a href="#l55.107"></a><span id="l55.107" class="difflineminus">-                    .createInstance(Ci.nsIMsgCloudFileProvider);</span>
<a href="#l55.108"></a><span id="l55.108" class="difflineplus">+    let hightail = cloudFileAccounts.getAccount(aAccountKey);</span>
<a href="#l55.109"></a><span id="l55.109"> </span>
<a href="#l55.110"></a><span id="l55.110">     let urls = [kServerURL];</span>
<a href="#l55.111"></a><span id="l55.111">     hightail.overrideUrls(urls.length, urls);</span>
<a href="#l55.112"></a><span id="l55.112">     hightail.init(aAccountKey);</span>
<a href="#l55.113"></a><span id="l55.113"> </span>
<a href="#l55.114"></a><span id="l55.114">     return hightail;</span>
<a href="#l55.115"></a><span id="l55.115">   },</span>
<a href="#l55.116"></a><span id="l55.116"> </span>
<a href="#l55.117"></a><span id="l55.117" class="difflineminus">-  init: function MDBS_init(aConfig) {</span>
<a href="#l55.118"></a><span id="l55.118" class="difflineminus">-</span>
<a href="#l55.119"></a><span id="l55.119" class="difflineplus">+  init(aConfig) {</span>
<a href="#l55.120"></a><span id="l55.120">     this._config = overrideDefault(kDefaultConfig, aConfig);</span>
<a href="#l55.121"></a><span id="l55.121"> </span>
<a href="#l55.122"></a><span id="l55.122">     this._server = new HttpServer();</span>
<a href="#l55.123"></a><span id="l55.123">     this.auth.init(this._server);</span>
<a href="#l55.124"></a><span id="l55.124">     this.userInfo.init(this._server);</span>
<a href="#l55.125"></a><span id="l55.125">     this.registry.init(this._server);</span>
<a href="#l55.126"></a><span id="l55.126">     this.receiver.init(this._server);</span>
<a href="#l55.127"></a><span id="l55.127">     this.preparer.init(this._server);</span>
<a href="#l55.128"></a><span id="l55.128">     this.deleter.init(this._server);</span>
<a href="#l55.129"></a><span id="l55.129">     this.committer.init(this._server);</span>
<a href="#l55.130"></a><span id="l55.130"> </span>
<a href="#l55.131"></a><span id="l55.131">     this.userInfo.setupUser();</span>
<a href="#l55.132"></a><span id="l55.132">   },</span>
<a href="#l55.133"></a><span id="l55.133"> </span>
<a href="#l55.134"></a><span id="l55.134" class="difflineminus">-  start: function MDBS_start() {</span>
<a href="#l55.135"></a><span id="l55.135" class="difflineplus">+  start() {</span>
<a href="#l55.136"></a><span id="l55.136">     this._server.start(this._config.port);</span>
<a href="#l55.137"></a><span id="l55.137">   },</span>
<a href="#l55.138"></a><span id="l55.138"> </span>
<a href="#l55.139"></a><span id="l55.139" class="difflineminus">-  stop: function MDBS_stop(aController) {</span>
<a href="#l55.140"></a><span id="l55.140" class="difflineplus">+  stop(aController) {</span>
<a href="#l55.141"></a><span id="l55.141">     this.auth.shutdown();</span>
<a href="#l55.142"></a><span id="l55.142">     this.userInfo.shutdown();</span>
<a href="#l55.143"></a><span id="l55.143">     this.registry.shutdown();</span>
<a href="#l55.144"></a><span id="l55.144">     this.receiver.shutdown();</span>
<a href="#l55.145"></a><span id="l55.145">     this.preparer.shutdown();</span>
<a href="#l55.146"></a><span id="l55.146">     this.deleter.shutdown();</span>
<a href="#l55.147"></a><span id="l55.147">     this.committer.shutdown();</span>
<a href="#l55.148"></a><span id="l55.148"> </span>
<a href="#l55.149"></a><span id="l55.149" class="difflineat">@@ -155,211 +153,211 @@ MockHightailServer.prototype = {</span>
<a href="#l55.150"></a><span id="l55.150">     this._server.stop(function() {</span>
<a href="#l55.151"></a><span id="l55.151">       allDone = true;</span>
<a href="#l55.152"></a><span id="l55.152">     });</span>
<a href="#l55.153"></a><span id="l55.153">     aController.waitFor(() =&gt; allDone,</span>
<a href="#l55.154"></a><span id="l55.154">                         &quot;Timed out waiting for Hightail server to stop!&quot;,</span>
<a href="#l55.155"></a><span id="l55.155">                         10000);</span>
<a href="#l55.156"></a><span id="l55.156">   },</span>
<a href="#l55.157"></a><span id="l55.157"> </span>
<a href="#l55.158"></a><span id="l55.158" class="difflineminus">-  setupUser: function MDBS_wireUser(aData) {</span>
<a href="#l55.159"></a><span id="l55.159" class="difflineplus">+  setupUser(aData) {</span>
<a href="#l55.160"></a><span id="l55.160">     this.userInfo.shutdown();</span>
<a href="#l55.161"></a><span id="l55.161">     this.userInfo.init(this._server);</span>
<a href="#l55.162"></a><span id="l55.162">     this.userInfo.setupUser(aData);</span>
<a href="#l55.163"></a><span id="l55.163">   },</span>
<a href="#l55.164"></a><span id="l55.164"> </span>
<a href="#l55.165"></a><span id="l55.165">   /**</span>
<a href="#l55.166"></a><span id="l55.166">    * Prepare the mock server to have a file with filename aFilename be</span>
<a href="#l55.167"></a><span id="l55.167">    * uploaded.</span>
<a href="#l55.168"></a><span id="l55.168">    *</span>
<a href="#l55.169"></a><span id="l55.169">    * @param aFilename the name of the file to be uploaded.</span>
<a href="#l55.170"></a><span id="l55.170">    * @param aMSeconds an optional argument, for the amount of time the upload</span>
<a href="#l55.171"></a><span id="l55.171">    *                  should take in milliseconds.</span>
<a href="#l55.172"></a><span id="l55.172">    */</span>
<a href="#l55.173"></a><span id="l55.173" class="difflineminus">-  planForUploadFile: function MDBS_planForUploadFile(aFilename, aMSeconds) {</span>
<a href="#l55.174"></a><span id="l55.174" class="difflineplus">+  planForUploadFile(aFilename, aMSeconds) {</span>
<a href="#l55.175"></a><span id="l55.175">     this.receiver.expect(aFilename, aMSeconds);</span>
<a href="#l55.176"></a><span id="l55.176">     let downloadUrl = kDownloadURLPrefix + &quot;/&quot; + aFilename;</span>
<a href="#l55.177"></a><span id="l55.177">     this.committer.prepareDownloadURL(aFilename, downloadUrl);</span>
<a href="#l55.178"></a><span id="l55.178">   },</span>
<a href="#l55.179"></a><span id="l55.179"> </span>
<a href="#l55.180"></a><span id="l55.180" class="difflineminus">-  planForGetFileURL: function MDBS_planForGetShare(aFilename, aData) {</span>
<a href="#l55.181"></a><span id="l55.181" class="difflineplus">+  planForGetFileURL(aFilename, aData) {</span>
<a href="#l55.182"></a><span id="l55.182">     this.committer.prepareDownloadURL(aFilename, aData.url);</span>
<a href="#l55.183"></a><span id="l55.183">   },</span>
<a href="#l55.184"></a><span id="l55.184"> </span>
<a href="#l55.185"></a><span id="l55.185" class="difflineminus">-  planForDeleteFile: function MYSS_planForDeleteFile(aFilename) {</span>
<a href="#l55.186"></a><span id="l55.186" class="difflineplus">+  planForDeleteFile(aFilename) {</span>
<a href="#l55.187"></a><span id="l55.187">     this.deleter.prepareForDelete(aFilename);</span>
<a href="#l55.188"></a><span id="l55.188">   },</span>
<a href="#l55.189"></a><span id="l55.189" class="difflineminus">-}</span>
<a href="#l55.190"></a><span id="l55.190" class="difflineplus">+};</span>
<a href="#l55.191"></a><span id="l55.191"> </span>
<a href="#l55.192"></a><span id="l55.192"> /**</span>
<a href="#l55.193"></a><span id="l55.193">  * A simple authentication handler, regardless of input, returns</span>
<a href="#l55.194"></a><span id="l55.194">  * an authorization token, and fires the cloudfile:auth observable</span>
<a href="#l55.195"></a><span id="l55.195">  * topic.</span>
<a href="#l55.196"></a><span id="l55.196">  */</span>
<a href="#l55.197"></a><span id="l55.197"> function MockHightailAuthSimple(aHightail) {</span>
<a href="#l55.198"></a><span id="l55.198">   this._server = null;</span>
<a href="#l55.199"></a><span id="l55.199">   this._auth = null;</span>
<a href="#l55.200"></a><span id="l55.200"> }</span>
<a href="#l55.201"></a><span id="l55.201"> </span>
<a href="#l55.202"></a><span id="l55.202"> MockHightailAuthSimple.prototype = {</span>
<a href="#l55.203"></a><span id="l55.203" class="difflineminus">-  init: function(aServer) {</span>
<a href="#l55.204"></a><span id="l55.204" class="difflineplus">+  init(aServer) {</span>
<a href="#l55.205"></a><span id="l55.205">     this._server = aServer;</span>
<a href="#l55.206"></a><span id="l55.206">     this._auth = generateObservableRequestHandler(</span>
<a href="#l55.207"></a><span id="l55.207">         &quot;cloudfile:auth&quot;, &quot;&quot;, JSON.stringify(kAuthResult));</span>
<a href="#l55.208"></a><span id="l55.208"> </span>
<a href="#l55.209"></a><span id="l55.209">     this._server.registerPathHandler(kAuthPath, this._auth);</span>
<a href="#l55.210"></a><span id="l55.210">   },</span>
<a href="#l55.211"></a><span id="l55.211"> </span>
<a href="#l55.212"></a><span id="l55.212" class="difflineminus">-  shutdown: function() {</span>
<a href="#l55.213"></a><span id="l55.213" class="difflineplus">+  shutdown() {</span>
<a href="#l55.214"></a><span id="l55.214">     this._server.registerPathHandler(kAuthPath, null);</span>
<a href="#l55.215"></a><span id="l55.215">     this._server = null;</span>
<a href="#l55.216"></a><span id="l55.216">     this._auth = null;</span>
<a href="#l55.217"></a><span id="l55.217">   },</span>
<a href="#l55.218"></a><span id="l55.218" class="difflineminus">-}</span>
<a href="#l55.219"></a><span id="l55.219" class="difflineplus">+};</span>
<a href="#l55.220"></a><span id="l55.220"> </span>
<a href="#l55.221"></a><span id="l55.221"> function MockHightailUserInfoSimple(aHightail) {</span>
<a href="#l55.222"></a><span id="l55.222">   this._server = null;</span>
<a href="#l55.223"></a><span id="l55.223">   this._userInfo = null;</span>
<a href="#l55.224"></a><span id="l55.224"> }</span>
<a href="#l55.225"></a><span id="l55.225"> </span>
<a href="#l55.226"></a><span id="l55.226"> MockHightailUserInfoSimple.prototype = {</span>
<a href="#l55.227"></a><span id="l55.227" class="difflineminus">-  init: function(aServer) {</span>
<a href="#l55.228"></a><span id="l55.228" class="difflineplus">+  init(aServer) {</span>
<a href="#l55.229"></a><span id="l55.229">     this._server = aServer;</span>
<a href="#l55.230"></a><span id="l55.230">   },</span>
<a href="#l55.231"></a><span id="l55.231"> </span>
<a href="#l55.232"></a><span id="l55.232" class="difflineminus">-  setupUser: function(aData) {</span>
<a href="#l55.233"></a><span id="l55.233" class="difflineplus">+  setupUser(aData) {</span>
<a href="#l55.234"></a><span id="l55.234">     aData = overrideDefault(kDefaultUser, aData);</span>
<a href="#l55.235"></a><span id="l55.235"> </span>
<a href="#l55.236"></a><span id="l55.236">     this._userInfo = generateObservableRequestHandler(</span>
<a href="#l55.237"></a><span id="l55.237">         &quot;cloudfile:auth&quot;, &quot;&quot;, JSON.stringify(aData));</span>
<a href="#l55.238"></a><span id="l55.238">     this._server.registerPathHandler(kUserInfoPath, this._userInfo);</span>
<a href="#l55.239"></a><span id="l55.239">   },</span>
<a href="#l55.240"></a><span id="l55.240"> </span>
<a href="#l55.241"></a><span id="l55.241" class="difflineminus">-  shutdown: function() {</span>
<a href="#l55.242"></a><span id="l55.242" class="difflineplus">+  shutdown() {</span>
<a href="#l55.243"></a><span id="l55.243">     this._server.registerPathHandler(kUserInfoPath, null);</span>
<a href="#l55.244"></a><span id="l55.244">     this._server = null;</span>
<a href="#l55.245"></a><span id="l55.245">   },</span>
<a href="#l55.246"></a><span id="l55.246"> </span>
<a href="#l55.247"></a><span id="l55.247">   get username() {</span>
<a href="#l55.248"></a><span id="l55.248">     return kDefaultUser.email;</span>
<a href="#l55.249"></a><span id="l55.249">   },</span>
<a href="#l55.250"></a><span id="l55.250"> };</span>
<a href="#l55.251"></a><span id="l55.251"> </span>
<a href="#l55.252"></a><span id="l55.252"> function MockHightailItemIdRegistry(aHightail) {</span>
<a href="#l55.253"></a><span id="l55.253">   this._itemIdMap = {};</span>
<a href="#l55.254"></a><span id="l55.254">   this._itemIds = [];</span>
<a href="#l55.255"></a><span id="l55.255"> }</span>
<a href="#l55.256"></a><span id="l55.256"> </span>
<a href="#l55.257"></a><span id="l55.257"> MockHightailItemIdRegistry.prototype = {</span>
<a href="#l55.258"></a><span id="l55.258" class="difflineminus">-  init: function(aServer) {</span>
<a href="#l55.259"></a><span id="l55.259" class="difflineplus">+  init(aServer) {</span>
<a href="#l55.260"></a><span id="l55.260">     this._itemIdMap = {};</span>
<a href="#l55.261"></a><span id="l55.261">     this._itemIds = [];</span>
<a href="#l55.262"></a><span id="l55.262">   },</span>
<a href="#l55.263"></a><span id="l55.263"> </span>
<a href="#l55.264"></a><span id="l55.264" class="difflineminus">-  shutdown: function() {</span>
<a href="#l55.265"></a><span id="l55.265" class="difflineplus">+  shutdown() {</span>
<a href="#l55.266"></a><span id="l55.266">   },</span>
<a href="#l55.267"></a><span id="l55.267"> </span>
<a href="#l55.268"></a><span id="l55.268" class="difflineminus">-  createItemId: function createItemId() {</span>
<a href="#l55.269"></a><span id="l55.269" class="difflineplus">+  createItemId() {</span>
<a href="#l55.270"></a><span id="l55.270">     let itemId = generateUUID();</span>
<a href="#l55.271"></a><span id="l55.271">     this._itemIds.push(itemId);</span>
<a href="#l55.272"></a><span id="l55.272">     return itemId;</span>
<a href="#l55.273"></a><span id="l55.273">   },</span>
<a href="#l55.274"></a><span id="l55.274"> </span>
<a href="#l55.275"></a><span id="l55.275" class="difflineminus">-  setMapping: function setMapping(aItemId, aFilename) {</span>
<a href="#l55.276"></a><span id="l55.276" class="difflineplus">+  setMapping(aItemId, aFilename) {</span>
<a href="#l55.277"></a><span id="l55.277">     let oldItemId = this.lookupItemId(aFilename);</span>
<a href="#l55.278"></a><span id="l55.278">     if (oldItemId)</span>
<a href="#l55.279"></a><span id="l55.279" class="difflineminus">-      delete this._itemIdMap[oldItemId]</span>
<a href="#l55.280"></a><span id="l55.280" class="difflineplus">+      delete this._itemIdMap[oldItemId];</span>
<a href="#l55.281"></a><span id="l55.281"> </span>
<a href="#l55.282"></a><span id="l55.282">     if (this._itemIds.includes(aItemId)) {</span>
<a href="#l55.283"></a><span id="l55.283">       this._itemIdMap[aItemId] = aFilename;</span>
<a href="#l55.284"></a><span id="l55.284">     }</span>
<a href="#l55.285"></a><span id="l55.285">   },</span>
<a href="#l55.286"></a><span id="l55.286"> </span>
<a href="#l55.287"></a><span id="l55.287" class="difflineminus">-  lookupFilename: function lookupFilename(aItemId) {</span>
<a href="#l55.288"></a><span id="l55.288" class="difflineplus">+  lookupFilename(aItemId) {</span>
<a href="#l55.289"></a><span id="l55.289">     return this._itemIdMap[aItemId];</span>
<a href="#l55.290"></a><span id="l55.290">   },</span>
<a href="#l55.291"></a><span id="l55.291"> </span>
<a href="#l55.292"></a><span id="l55.292" class="difflineminus">-  hasItemId: function hasItemId(aItemId) {</span>
<a href="#l55.293"></a><span id="l55.293" class="difflineplus">+  hasItemId(aItemId) {</span>
<a href="#l55.294"></a><span id="l55.294">     return (aItemId in this._itemIdMap);</span>
<a href="#l55.295"></a><span id="l55.295">   },</span>
<a href="#l55.296"></a><span id="l55.296"> </span>
<a href="#l55.297"></a><span id="l55.297" class="difflineminus">-  lookupItemId: function lookupItemId(aFilename) {</span>
<a href="#l55.298"></a><span id="l55.298" class="difflineplus">+  lookupItemId(aFilename) {</span>
<a href="#l55.299"></a><span id="l55.299">     // Slow lookup</span>
<a href="#l55.300"></a><span id="l55.300">     for (let itemId in this._itemIdMap) {</span>
<a href="#l55.301"></a><span id="l55.301">       if (this._itemIdMap[itemId] == aFilename)</span>
<a href="#l55.302"></a><span id="l55.302">         return itemId;</span>
<a href="#l55.303"></a><span id="l55.303">     }</span>
<a href="#l55.304"></a><span id="l55.304">     return null;</span>
<a href="#l55.305"></a><span id="l55.305">   },</span>
<a href="#l55.306"></a><span id="l55.306" class="difflineminus">-}</span>
<a href="#l55.307"></a><span id="l55.307" class="difflineplus">+};</span>
<a href="#l55.308"></a><span id="l55.308"> </span>
<a href="#l55.309"></a><span id="l55.309"> /**</span>
<a href="#l55.310"></a><span id="l55.310">  * A simple preparation handler for a Hightail mock server. Allows</span>
<a href="#l55.311"></a><span id="l55.311">  * a client to query for a unique URL to upload to.  Redirects the actual</span>
<a href="#l55.312"></a><span id="l55.312">  * uploads to the passed receiver</span>
<a href="#l55.313"></a><span id="l55.313">  */</span>
<a href="#l55.314"></a><span id="l55.314"> function MockHightailPrepareSimple(aHightail) {</span>
<a href="#l55.315"></a><span id="l55.315">   this._server = null;</span>
<a href="#l55.316"></a><span id="l55.316">   this._hightail = aHightail;</span>
<a href="#l55.317"></a><span id="l55.317"> }</span>
<a href="#l55.318"></a><span id="l55.318"> </span>
<a href="#l55.319"></a><span id="l55.319"> MockHightailPrepareSimple.prototype = {</span>
<a href="#l55.320"></a><span id="l55.320" class="difflineminus">-  init: function(aServer) {</span>
<a href="#l55.321"></a><span id="l55.321" class="difflineplus">+  init(aServer) {</span>
<a href="#l55.322"></a><span id="l55.322">     this._server = aServer;</span>
<a href="#l55.323"></a><span id="l55.323">     this._server.registerPathHandler(kFolderInitUploadPath,</span>
<a href="#l55.324"></a><span id="l55.324">                                      this._prepare.bind(this));</span>
<a href="#l55.325"></a><span id="l55.325"> </span>
<a href="#l55.326"></a><span id="l55.326">     this._foldersId = {</span>
<a href="#l55.327"></a><span id="l55.327">       root: 0,</span>
<a href="#l55.328"></a><span id="l55.328">       Apps: this._hightail.registry.createItemId(),</span>
<a href="#l55.329"></a><span id="l55.329" class="difflineminus">-      &quot;Mozilla Thunderbird&quot; : this._hightail.registry.createItemId()</span>
<a href="#l55.330"></a><span id="l55.330" class="difflineplus">+      &quot;Mozilla Thunderbird&quot;: this._hightail.registry.createItemId(),</span>
<a href="#l55.331"></a><span id="l55.331">     };</span>
<a href="#l55.332"></a><span id="l55.332"> </span>
<a href="#l55.333"></a><span id="l55.333">     // Set up folders info</span>
<a href="#l55.334"></a><span id="l55.334">     for (let i in this._foldersId) {</span>
<a href="#l55.335"></a><span id="l55.335">       this._server.registerPathHandler(kFolderPath + this._foldersId[i],</span>
<a href="#l55.336"></a><span id="l55.336">                                        this._getFolderInfo.bind(this));</span>
<a href="#l55.337"></a><span id="l55.337">     }</span>
<a href="#l55.338"></a><span id="l55.338">   },</span>
<a href="#l55.339"></a><span id="l55.339"> </span>
<a href="#l55.340"></a><span id="l55.340" class="difflineminus">-  shutdown: function() {</span>
<a href="#l55.341"></a><span id="l55.341" class="difflineplus">+  shutdown() {</span>
<a href="#l55.342"></a><span id="l55.342">     this._server.registerPathHandler(kFolderInitUploadPath, null);</span>
<a href="#l55.343"></a><span id="l55.343">     for (let i in this._foldersId) {</span>
<a href="#l55.344"></a><span id="l55.344">       this._server.registerPathHandler(kFolderPath + this._foldersId[i],</span>
<a href="#l55.345"></a><span id="l55.345">                                        null);</span>
<a href="#l55.346"></a><span id="l55.346">     }</span>
<a href="#l55.347"></a><span id="l55.347">     this._server = null;</span>
<a href="#l55.348"></a><span id="l55.348">   },</span>
<a href="#l55.349"></a><span id="l55.349"> </span>
<a href="#l55.350"></a><span id="l55.350" class="difflineminus">-  _getFolderInfo: function(aRequest, aResponse) {</span>
<a href="#l55.351"></a><span id="l55.351" class="difflineplus">+  _getFolderInfo(aRequest, aResponse) {</span>
<a href="#l55.352"></a><span id="l55.352">     let folderId = aRequest.path.substring(kFolderPath.length);</span>
<a href="#l55.353"></a><span id="l55.353">     let nextFolder = folderId == (this._foldersId.root + &quot;&quot;)</span>
<a href="#l55.354"></a><span id="l55.354">                         ? &quot;Apps&quot;</span>
<a href="#l55.355"></a><span id="l55.355">                         : &quot;Mozilla Thunderbird&quot;;</span>
<a href="#l55.356"></a><span id="l55.356">     let response = {</span>
<a href="#l55.357"></a><span id="l55.357">       folders: {</span>
<a href="#l55.358"></a><span id="l55.358" class="difflineminus">-        folder: [{name: nextFolder, id: this._foldersId[nextFolder]}]</span>
<a href="#l55.359"></a><span id="l55.359" class="difflineplus">+        folder: [{name: nextFolder, id: this._foldersId[nextFolder]}],</span>
<a href="#l55.360"></a><span id="l55.360">       },</span>
<a href="#l55.361"></a><span id="l55.361" class="difflineminus">-      status: 200</span>
<a href="#l55.362"></a><span id="l55.362" class="difflineminus">-    }</span>
<a href="#l55.363"></a><span id="l55.363" class="difflineplus">+      status: 200,</span>
<a href="#l55.364"></a><span id="l55.364" class="difflineplus">+    };</span>
<a href="#l55.365"></a><span id="l55.365">     aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l55.366"></a><span id="l55.366">     aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l55.367"></a><span id="l55.367">     aResponse.write(JSON.stringify(response));</span>
<a href="#l55.368"></a><span id="l55.368">   },</span>
<a href="#l55.369"></a><span id="l55.369"> </span>
<a href="#l55.370"></a><span id="l55.370" class="difflineminus">-  _prepare: function(aRequest, aResponse) {</span>
<a href="#l55.371"></a><span id="l55.371" class="difflineplus">+  _prepare(aRequest, aResponse) {</span>
<a href="#l55.372"></a><span id="l55.372">     let fileId = this._hightail.registry.createItemId();</span>
<a href="#l55.373"></a><span id="l55.373">     let uploadPath = kDefaultFileUploadPath + &quot;/&quot; + fileId;</span>
<a href="#l55.374"></a><span id="l55.374"> </span>
<a href="#l55.375"></a><span id="l55.375">     let injectedData = {</span>
<a href="#l55.376"></a><span id="l55.376" class="difflineminus">-      fileId: fileId,</span>
<a href="#l55.377"></a><span id="l55.377" class="difflineplus">+      fileId,</span>
<a href="#l55.378"></a><span id="l55.378">       uploadUrl: [</span>
<a href="#l55.379"></a><span id="l55.379">         kServerURL + uploadPath,</span>
<a href="#l55.380"></a><span id="l55.380" class="difflineminus">-      ]</span>
<a href="#l55.381"></a><span id="l55.381" class="difflineminus">-    }</span>
<a href="#l55.382"></a><span id="l55.382" class="difflineplus">+      ],</span>
<a href="#l55.383"></a><span id="l55.383" class="difflineplus">+    };</span>
<a href="#l55.384"></a><span id="l55.384"> </span>
<a href="#l55.385"></a><span id="l55.385">     // Set up the path that will accept an uploaded file</span>
<a href="#l55.386"></a><span id="l55.386">     this._server.registerPathHandler(uploadPath,</span>
<a href="#l55.387"></a><span id="l55.387">                                      this._hightail.receiver.receiveUpload</span>
<a href="#l55.388"></a><span id="l55.388">                                          .bind(this._hightail.receiver));</span>
<a href="#l55.389"></a><span id="l55.389"> </span>
<a href="#l55.390"></a><span id="l55.390">     // Set up the path that will accept file deletion</span>
<a href="#l55.391"></a><span id="l55.391"> </span>
<a href="#l55.392"></a><span id="l55.392" class="difflineat">@@ -381,114 +379,114 @@ function MockHightailReceiverSimple(aHig</span>
<a href="#l55.393"></a><span id="l55.393">   this._server = null;</span>
<a href="#l55.394"></a><span id="l55.394">   this._hightail = aHightail;</span>
<a href="#l55.395"></a><span id="l55.395">   this._expectedFiles = [];</span>
<a href="#l55.396"></a><span id="l55.396">   this._mSeconds = {};</span>
<a href="#l55.397"></a><span id="l55.397">   this._timers = [];</span>
<a href="#l55.398"></a><span id="l55.398"> }</span>
<a href="#l55.399"></a><span id="l55.399"> </span>
<a href="#l55.400"></a><span id="l55.400"> MockHightailReceiverSimple.prototype = {</span>
<a href="#l55.401"></a><span id="l55.401" class="difflineminus">-  init: function(aServer) {</span>
<a href="#l55.402"></a><span id="l55.402" class="difflineplus">+  init(aServer) {</span>
<a href="#l55.403"></a><span id="l55.403">     this._server = aServer;</span>
<a href="#l55.404"></a><span id="l55.404">   },</span>
<a href="#l55.405"></a><span id="l55.405"> </span>
<a href="#l55.406"></a><span id="l55.406" class="difflineminus">-  shutdown: function() {</span>
<a href="#l55.407"></a><span id="l55.407" class="difflineplus">+  shutdown() {</span>
<a href="#l55.408"></a><span id="l55.408">     this._server = null;</span>
<a href="#l55.409"></a><span id="l55.409">     this._expectedFiles = [];</span>
<a href="#l55.410"></a><span id="l55.410">   },</span>
<a href="#l55.411"></a><span id="l55.411"> </span>
<a href="#l55.412"></a><span id="l55.412" class="difflineminus">-  receiveUpload: function(aRequest, aResponse) {</span>
<a href="#l55.413"></a><span id="l55.413" class="difflineplus">+  receiveUpload(aRequest, aResponse) {</span>
<a href="#l55.414"></a><span id="l55.414">     if (aRequest.method != &quot;POST&quot;)</span>
<a href="#l55.415"></a><span id="l55.415">       throw new Error(&quot;Uploads should occur with a POST request&quot;);</span>
<a href="#l55.416"></a><span id="l55.416"> </span>
<a href="#l55.417"></a><span id="l55.417">     let formData = parseMultipartForm(aRequest);</span>
<a href="#l55.418"></a><span id="l55.418"> </span>
<a href="#l55.419"></a><span id="l55.419">     if (!formData)</span>
<a href="#l55.420"></a><span id="l55.420">       throw new Error(&quot;Could not parse multi-part form during upload&quot;);</span>
<a href="#l55.421"></a><span id="l55.421"> </span>
<a href="#l55.422"></a><span id="l55.422" class="difflineminus">-    let filename = formData['filename'];</span>
<a href="#l55.423"></a><span id="l55.423" class="difflineplus">+    let filename = formData.filename;</span>
<a href="#l55.424"></a><span id="l55.424">     let filenameIndex = this._expectedFiles.indexOf(filename);</span>
<a href="#l55.425"></a><span id="l55.425"> </span>
<a href="#l55.426"></a><span id="l55.426">     Services.obs.notifyObservers(null, &quot;cloudfile:uploadStarted&quot;,</span>
<a href="#l55.427"></a><span id="l55.427">                                  filename);</span>
<a href="#l55.428"></a><span id="l55.428"> </span>
<a href="#l55.429"></a><span id="l55.429">     if (filename in this._mSeconds)</span>
<a href="#l55.430"></a><span id="l55.430">       aResponse.processAsync();</span>
<a href="#l55.431"></a><span id="l55.431"> </span>
<a href="#l55.432"></a><span id="l55.432">     if (filenameIndex == -1)</span>
<a href="#l55.433"></a><span id="l55.433" class="difflineminus">-      throw new Error(&quot;Unexpected file upload: &quot; + formData['filename']);</span>
<a href="#l55.434"></a><span id="l55.434" class="difflineplus">+      throw new Error(&quot;Unexpected file upload: &quot; + formData.filename);</span>
<a href="#l55.435"></a><span id="l55.435"> </span>
<a href="#l55.436"></a><span id="l55.436">     Services.obs.notifyObservers(null, &quot;cloudfile:uploadFile&quot;,</span>
<a href="#l55.437"></a><span id="l55.437">                                  filename);</span>
<a href="#l55.438"></a><span id="l55.438"> </span>
<a href="#l55.439"></a><span id="l55.439">     this._expectedFiles.splice(filenameIndex, 1);</span>
<a href="#l55.440"></a><span id="l55.440"> </span>
<a href="#l55.441"></a><span id="l55.441" class="difflineminus">-    let itemId = formData['bid'];</span>
<a href="#l55.442"></a><span id="l55.442" class="difflineplus">+    let itemId = formData.bid;</span>
<a href="#l55.443"></a><span id="l55.443">     // Tell the committer how to map the uuid to the filename</span>
<a href="#l55.444"></a><span id="l55.444">     this._hightail.registry.setMapping(itemId, filename);</span>
<a href="#l55.445"></a><span id="l55.445"> </span>
<a href="#l55.446"></a><span id="l55.446">     // De-register this URL...</span>
<a href="#l55.447"></a><span id="l55.447">     this._server.registerPathHandler(aRequest.path, null);</span>
<a href="#l55.448"></a><span id="l55.448"> </span>
<a href="#l55.449"></a><span id="l55.449">     if (filename in this._mSeconds) {</span>
<a href="#l55.450"></a><span id="l55.450">       let timer = Cc[&quot;@mozilla.org/timer;1&quot;].createInstance(Ci.nsITimer);</span>
<a href="#l55.451"></a><span id="l55.451">       let timerEvent = {</span>
<a href="#l55.452"></a><span id="l55.452" class="difflineminus">-        notify: function(aTimer) {</span>
<a href="#l55.453"></a><span id="l55.453" class="difflineplus">+        notify(aTimer) {</span>
<a href="#l55.454"></a><span id="l55.454">           aResponse.finish();</span>
<a href="#l55.455"></a><span id="l55.455">         },</span>
<a href="#l55.456"></a><span id="l55.456" class="difflineminus">-      }</span>
<a href="#l55.457"></a><span id="l55.457" class="difflineplus">+      };</span>
<a href="#l55.458"></a><span id="l55.458">       timer.initWithCallback(timerEvent, this._mSeconds[filename],</span>
<a href="#l55.459"></a><span id="l55.459">                              Ci.nsITimer.TYPE_ONE_SHOT);</span>
<a href="#l55.460"></a><span id="l55.460">       // This is kind of ridiculous, but it seems that we have to hold a</span>
<a href="#l55.461"></a><span id="l55.461">       // reference to this timer, or else it can get garbage collected before</span>
<a href="#l55.462"></a><span id="l55.462">       // it fires.</span>
<a href="#l55.463"></a><span id="l55.463">       this._timers.push(timer);</span>
<a href="#l55.464"></a><span id="l55.464">     }</span>
<a href="#l55.465"></a><span id="l55.465">   },</span>
<a href="#l55.466"></a><span id="l55.466"> </span>
<a href="#l55.467"></a><span id="l55.467" class="difflineminus">-  expect: function(aFilename, aMSeconds) {</span>
<a href="#l55.468"></a><span id="l55.468" class="difflineplus">+  expect(aFilename, aMSeconds) {</span>
<a href="#l55.469"></a><span id="l55.469">     this._expectedFiles.push(aFilename);</span>
<a href="#l55.470"></a><span id="l55.470"> </span>
<a href="#l55.471"></a><span id="l55.471">     if (aMSeconds)</span>
<a href="#l55.472"></a><span id="l55.472">       this._mSeconds[aFilename] = aMSeconds;</span>
<a href="#l55.473"></a><span id="l55.473">   },</span>
<a href="#l55.474"></a><span id="l55.474"> </span>
<a href="#l55.475"></a><span id="l55.475">   get expecting() {</span>
<a href="#l55.476"></a><span id="l55.476">     return this._expectedFiles;</span>
<a href="#l55.477"></a><span id="l55.477" class="difflineminus">-  }</span>
<a href="#l55.478"></a><span id="l55.478" class="difflineplus">+  },</span>
<a href="#l55.479"></a><span id="l55.479"> };</span>
<a href="#l55.480"></a><span id="l55.480"> </span>
<a href="#l55.481"></a><span id="l55.481"> function MockHightailCommitterSimple(aHightail) {</span>
<a href="#l55.482"></a><span id="l55.482">   this._server = null;</span>
<a href="#l55.483"></a><span id="l55.483">   this._hightail = aHightail;</span>
<a href="#l55.484"></a><span id="l55.484">   this._itemIdMap = {};</span>
<a href="#l55.485"></a><span id="l55.485">   this._filenameURLMap = {};</span>
<a href="#l55.486"></a><span id="l55.486"> }</span>
<a href="#l55.487"></a><span id="l55.487"> </span>
<a href="#l55.488"></a><span id="l55.488"> MockHightailCommitterSimple.prototype = {</span>
<a href="#l55.489"></a><span id="l55.489" class="difflineminus">-  init: function(aServer) {</span>
<a href="#l55.490"></a><span id="l55.490" class="difflineplus">+  init(aServer) {</span>
<a href="#l55.491"></a><span id="l55.491">     this._server = aServer;</span>
<a href="#l55.492"></a><span id="l55.492">     // Since fileId is in query, we need to register path only once.</span>
<a href="#l55.493"></a><span id="l55.493">     this._server.registerPathHandler(kFolderCommitUploadPath,</span>
<a href="#l55.494"></a><span id="l55.494">                                      this.commit.bind(this));</span>
<a href="#l55.495"></a><span id="l55.495">   },</span>
<a href="#l55.496"></a><span id="l55.496"> </span>
<a href="#l55.497"></a><span id="l55.497" class="difflineminus">-  shutdown: function() {</span>
<a href="#l55.498"></a><span id="l55.498" class="difflineplus">+  shutdown() {</span>
<a href="#l55.499"></a><span id="l55.499">     this._server.registerPathHandler(kFolderCommitUploadPath,</span>
<a href="#l55.500"></a><span id="l55.500">                                      null);</span>
<a href="#l55.501"></a><span id="l55.501">     this._server = null;</span>
<a href="#l55.502"></a><span id="l55.502">     this._itemIdMap = {};</span>
<a href="#l55.503"></a><span id="l55.503">     this._filenameURLMap = {};</span>
<a href="#l55.504"></a><span id="l55.504">   },</span>
<a href="#l55.505"></a><span id="l55.505"> </span>
<a href="#l55.506"></a><span id="l55.506" class="difflineminus">-  prepareDownloadURL: function(aFilename, aURL) {</span>
<a href="#l55.507"></a><span id="l55.507" class="difflineplus">+  prepareDownloadURL(aFilename, aURL) {</span>
<a href="#l55.508"></a><span id="l55.508">     this._filenameURLMap[aFilename] = aURL;</span>
<a href="#l55.509"></a><span id="l55.509">   },</span>
<a href="#l55.510"></a><span id="l55.510"> </span>
<a href="#l55.511"></a><span id="l55.511" class="difflineminus">-  commit: function(aRequest, aResponse) {</span>
<a href="#l55.512"></a><span id="l55.512" class="difflineplus">+  commit(aRequest, aResponse) {</span>
<a href="#l55.513"></a><span id="l55.513">     let fileId = aRequest.queryString;</span>
<a href="#l55.514"></a><span id="l55.514">     fileId = fileId.substring(fileId.indexOf(&quot;fileId=&quot;) + 7);</span>
<a href="#l55.515"></a><span id="l55.515">     fileId = fileId.substring(0, fileId.indexOf(&quot;&amp;&quot;));</span>
<a href="#l55.516"></a><span id="l55.516"> </span>
<a href="#l55.517"></a><span id="l55.517">     if (!this._hightail.registry.hasItemId(fileId)) {</span>
<a href="#l55.518"></a><span id="l55.518">       aResponse.setStatusLine(null, 500, &quot;Bad request&quot;);</span>
<a href="#l55.519"></a><span id="l55.519">       aResponse.write(&quot;The item ID &quot; + fileId + &quot; did not map to an item we &quot;</span>
<a href="#l55.520"></a><span id="l55.520">                       + &quot;were prepared for committing&quot;);</span>
<a href="#l55.521"></a><span id="l55.521" class="difflineat">@@ -500,17 +498,17 @@ MockHightailCommitterSimple.prototype = </span>
<a href="#l55.522"></a><span id="l55.522"> </span>
<a href="#l55.523"></a><span id="l55.523">     if (filename in this._filenameURLMap)</span>
<a href="#l55.524"></a><span id="l55.524">       url = this._filenameURLMap[filename];</span>
<a href="#l55.525"></a><span id="l55.525">     else</span>
<a href="#l55.526"></a><span id="l55.526">       url = kDownloadURLPrefix + &quot;/&quot; + filename;</span>
<a href="#l55.527"></a><span id="l55.527"> </span>
<a href="#l55.528"></a><span id="l55.528">     let injectedData = {</span>
<a href="#l55.529"></a><span id="l55.529">       clickableDownloadUrl: url,</span>
<a href="#l55.530"></a><span id="l55.530" class="difflineminus">-    }</span>
<a href="#l55.531"></a><span id="l55.531" class="difflineplus">+    };</span>
<a href="#l55.532"></a><span id="l55.532">     let data = overrideDefault(kDefaultCommitReturn, injectedData);</span>
<a href="#l55.533"></a><span id="l55.533"> </span>
<a href="#l55.534"></a><span id="l55.534">     // Return the default share URL</span>
<a href="#l55.535"></a><span id="l55.535">     aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l55.536"></a><span id="l55.536">     aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l55.537"></a><span id="l55.537">     aResponse.write(JSON.stringify(data));</span>
<a href="#l55.538"></a><span id="l55.538"> </span>
<a href="#l55.539"></a><span id="l55.539">     Services.obs.notifyObservers(null, &quot;cloudfile:getFileURL&quot;, filename);</span>
<a href="#l55.540"></a><span id="l55.540" class="difflineat">@@ -519,22 +517,22 @@ MockHightailCommitterSimple.prototype = </span>
<a href="#l55.541"></a><span id="l55.541"> </span>
<a href="#l55.542"></a><span id="l55.542"> function MockHightailDeleterSimple(aHightail) {</span>
<a href="#l55.543"></a><span id="l55.543">   this._server = null;</span>
<a href="#l55.544"></a><span id="l55.544">   this._hightail = aHightail;</span>
<a href="#l55.545"></a><span id="l55.545">   this._expectDelete = [];</span>
<a href="#l55.546"></a><span id="l55.546"> }</span>
<a href="#l55.547"></a><span id="l55.547"> </span>
<a href="#l55.548"></a><span id="l55.548"> MockHightailDeleterSimple.prototype = {</span>
<a href="#l55.549"></a><span id="l55.549" class="difflineminus">-  init: function(aServer) {</span>
<a href="#l55.550"></a><span id="l55.550" class="difflineplus">+  init(aServer) {</span>
<a href="#l55.551"></a><span id="l55.551">     this._server = aServer;</span>
<a href="#l55.552"></a><span id="l55.552">   },</span>
<a href="#l55.553"></a><span id="l55.553" class="difflineminus">-  shutdown: function() {},</span>
<a href="#l55.554"></a><span id="l55.554" class="difflineplus">+  shutdown() {},</span>
<a href="#l55.555"></a><span id="l55.555"> </span>
<a href="#l55.556"></a><span id="l55.556" class="difflineminus">-  receiveDelete: function(aRequest, aResponse) {</span>
<a href="#l55.557"></a><span id="l55.557" class="difflineplus">+  receiveDelete(aRequest, aResponse) {</span>
<a href="#l55.558"></a><span id="l55.558">     if (aRequest.method != &quot;DELETE&quot;) {</span>
<a href="#l55.559"></a><span id="l55.559">       aResponse.setStatusLine(null, 500, &quot;Bad request&quot;);</span>
<a href="#l55.560"></a><span id="l55.560">       aResponse.write(&quot;Expected a DELETE for deleting.&quot;);</span>
<a href="#l55.561"></a><span id="l55.561">       return;</span>
<a href="#l55.562"></a><span id="l55.562">     }</span>
<a href="#l55.563"></a><span id="l55.563"> </span>
<a href="#l55.564"></a><span id="l55.564"> </span>
<a href="#l55.565"></a><span id="l55.565">     let fileId = aRequest.path.substring(kDeletePath.length + 1);</span>
<a href="#l55.566"></a><span id="l55.566" class="difflineat">@@ -560,70 +558,70 @@ MockHightailDeleterSimple.prototype = {</span>
<a href="#l55.567"></a><span id="l55.567">     let response = {status: 200};</span>
<a href="#l55.568"></a><span id="l55.568">     aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l55.569"></a><span id="l55.569">     aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l55.570"></a><span id="l55.570">     aResponse.write(JSON.stringify(response));</span>
<a href="#l55.571"></a><span id="l55.571"> </span>
<a href="#l55.572"></a><span id="l55.572">     Services.obs.notifyObservers(null, &quot;cloudfile:deleteFile&quot;, filename);</span>
<a href="#l55.573"></a><span id="l55.573">     this._server.registerPathHandler(aRequest.path, null);</span>
<a href="#l55.574"></a><span id="l55.574">   },</span>
<a href="#l55.575"></a><span id="l55.575" class="difflineminus">-  prepareForDelete: function(aFilename) {</span>
<a href="#l55.576"></a><span id="l55.576" class="difflineplus">+  prepareForDelete(aFilename) {</span>
<a href="#l55.577"></a><span id="l55.577">     this._expectDelete.push(aFilename);</span>
<a href="#l55.578"></a><span id="l55.578">   },</span>
<a href="#l55.579"></a><span id="l55.579"> };</span>
<a href="#l55.580"></a><span id="l55.580"> </span>
<a href="#l55.581"></a><span id="l55.581"> function MockHightailDeleterStaleToken(aHightail) {</span>
<a href="#l55.582"></a><span id="l55.582">   this._server = null;</span>
<a href="#l55.583"></a><span id="l55.583">   this._hightail = aHightail;</span>
<a href="#l55.584"></a><span id="l55.584"> }</span>
<a href="#l55.585"></a><span id="l55.585"> </span>
<a href="#l55.586"></a><span id="l55.586"> MockHightailDeleterStaleToken.prototype = {</span>
<a href="#l55.587"></a><span id="l55.587" class="difflineminus">-  init: function(aServer) {</span>
<a href="#l55.588"></a><span id="l55.588" class="difflineplus">+  init(aServer) {</span>
<a href="#l55.589"></a><span id="l55.589">     this._server = aServer;</span>
<a href="#l55.590"></a><span id="l55.590">   },</span>
<a href="#l55.591"></a><span id="l55.591"> </span>
<a href="#l55.592"></a><span id="l55.592" class="difflineminus">-  shutdown: function() {},</span>
<a href="#l55.593"></a><span id="l55.593" class="difflineplus">+  shutdown() {},</span>
<a href="#l55.594"></a><span id="l55.594"> </span>
<a href="#l55.595"></a><span id="l55.595" class="difflineminus">-  receiveDelete: function(aRequest, aResponse) {</span>
<a href="#l55.596"></a><span id="l55.596" class="difflineplus">+  receiveDelete(aRequest, aResponse) {</span>
<a href="#l55.597"></a><span id="l55.597">     let data = { errorStatus: { code: 401, message: &quot;Invalid auth token&quot; } };</span>
<a href="#l55.598"></a><span id="l55.598"> </span>
<a href="#l55.599"></a><span id="l55.599">     aResponse.setStatusLine(null, 401, &quot;Invalid auth token&quot;);</span>
<a href="#l55.600"></a><span id="l55.600">     aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l55.601"></a><span id="l55.601">     aResponse.write(JSON.stringify(data));</span>
<a href="#l55.602"></a><span id="l55.602">   },</span>
<a href="#l55.603"></a><span id="l55.603"> </span>
<a href="#l55.604"></a><span id="l55.604" class="difflineminus">-  prepareForDelete: function(aFilename) {},</span>
<a href="#l55.605"></a><span id="l55.605" class="difflineplus">+  prepareForDelete(aFilename) {},</span>
<a href="#l55.606"></a><span id="l55.606"> };</span>
<a href="#l55.607"></a><span id="l55.607"> </span>
<a href="#l55.608"></a><span id="l55.608"> function MockHightailAuthCounter(aHightail) {</span>
<a href="#l55.609"></a><span id="l55.609">   this._server = null;</span>
<a href="#l55.610"></a><span id="l55.610">   this._hightail = aHightail;</span>
<a href="#l55.611"></a><span id="l55.611">   this.count = 0;</span>
<a href="#l55.612"></a><span id="l55.612"> }</span>
<a href="#l55.613"></a><span id="l55.613"> </span>
<a href="#l55.614"></a><span id="l55.614"> MockHightailAuthCounter.prototype = {</span>
<a href="#l55.615"></a><span id="l55.615"> </span>
<a href="#l55.616"></a><span id="l55.616" class="difflineminus">-  init: function(aServer) {</span>
<a href="#l55.617"></a><span id="l55.617" class="difflineplus">+  init(aServer) {</span>
<a href="#l55.618"></a><span id="l55.618">     this._server = aServer;</span>
<a href="#l55.619"></a><span id="l55.619">     this._server.registerPathHandler(kAuthPath, this._auth.bind(this));</span>
<a href="#l55.620"></a><span id="l55.620">   },</span>
<a href="#l55.621"></a><span id="l55.621"> </span>
<a href="#l55.622"></a><span id="l55.622" class="difflineminus">-  _auth: function(aRequest, aResponse) {</span>
<a href="#l55.623"></a><span id="l55.623" class="difflineplus">+  _auth(aRequest, aResponse) {</span>
<a href="#l55.624"></a><span id="l55.624">     this.count += 1;</span>
<a href="#l55.625"></a><span id="l55.625">     aResponse.setStatusLine(null, 200, &quot;OK&quot;);</span>
<a href="#l55.626"></a><span id="l55.626">     aResponse.setHeader(&quot;Content-Type&quot;, &quot;application/json&quot;);</span>
<a href="#l55.627"></a><span id="l55.627">     aResponse.write(JSON.stringify(kAuthResult));</span>
<a href="#l55.628"></a><span id="l55.628">   },</span>
<a href="#l55.629"></a><span id="l55.629"> </span>
<a href="#l55.630"></a><span id="l55.630" class="difflineminus">-  shutdown: function() {</span>
<a href="#l55.631"></a><span id="l55.631" class="difflineplus">+  shutdown() {</span>
<a href="#l55.632"></a><span id="l55.632">     this._server.registerPathHandler(kAuthPath, null);</span>
<a href="#l55.633"></a><span id="l55.633">     this._server = null;</span>
<a href="#l55.634"></a><span id="l55.634">     this._auth = null;</span>
<a href="#l55.635"></a><span id="l55.635">   },</span>
<a href="#l55.636"></a><span id="l55.636" class="difflineminus">-}</span>
<a href="#l55.637"></a><span id="l55.637" class="difflineplus">+};</span>
<a href="#l55.638"></a><span id="l55.638"> </span>
<a href="#l55.639"></a><span id="l55.639"> /**</span>
<a href="#l55.640"></a><span id="l55.640">  * Adds a username and password pair to nsILoginManager</span>
<a href="#l55.641"></a><span id="l55.641">  * for the Hightail provider instance to retrieve. This may</span>
<a href="#l55.642"></a><span id="l55.642">  * fail if a password already exists for aUserrname.</span>
<a href="#l55.643"></a><span id="l55.643">  *</span>
<a href="#l55.644"></a><span id="l55.644">  * @param aUsername the username to save the password for</span>
<a href="#l55.645"></a><span id="l55.645">  * @param aPassword the password to save</span>
<a href="#l55.646"></a><span id="l55.646" class="difflineat">@@ -649,17 +647,17 @@ function generateObservableRequestHandle</span>
<a href="#l55.647"></a><span id="l55.647">   subjectString.data = aString;</span>
<a href="#l55.648"></a><span id="l55.648"> </span>
<a href="#l55.649"></a><span id="l55.649">   let func = function(aMeta, aResponse) {</span>
<a href="#l55.650"></a><span id="l55.650">     aResponse.setStatusLine(null, aOptions.statusCode,</span>
<a href="#l55.651"></a><span id="l55.651">                             aOptions.statusString);</span>
<a href="#l55.652"></a><span id="l55.652">     aResponse.setHeader(&quot;Content-Type&quot;, aOptions.contentType);</span>
<a href="#l55.653"></a><span id="l55.653">     aResponse.write(aString);</span>
<a href="#l55.654"></a><span id="l55.654">     Services.obs.notifyObservers(subjectString, aKey, aValue);</span>
<a href="#l55.655"></a><span id="l55.655" class="difflineminus">-  }</span>
<a href="#l55.656"></a><span id="l55.656" class="difflineplus">+  };</span>
<a href="#l55.657"></a><span id="l55.657">   return func;</span>
<a href="#l55.658"></a><span id="l55.658"> }</span>
<a href="#l55.659"></a><span id="l55.659"> </span>
<a href="#l55.660"></a><span id="l55.660"> function overrideDefault(aDefault, aData) {</span>
<a href="#l55.661"></a><span id="l55.661">   if (aData === undefined)</span>
<a href="#l55.662"></a><span id="l55.662">     return aDefault;</span>
<a href="#l55.663"></a><span id="l55.663"> </span>
<a href="#l55.664"></a><span id="l55.664">   for (let param in aDefault) {</span>
<a href="#l55.665"></a><span id="l55.665" class="difflineat">@@ -678,43 +676,39 @@ function overrideDefault(aDefault, aData</span>
<a href="#l55.666"></a><span id="l55.666"> function generateUUID() {</span>
<a href="#l55.667"></a><span id="l55.667">   let uuidGen = Cc[&quot;@mozilla.org/uuid-generator;1&quot;]</span>
<a href="#l55.668"></a><span id="l55.668">                   .getService(Ci.nsIUUIDGenerator);</span>
<a href="#l55.669"></a><span id="l55.669">   let uuid = uuidGen.generateUUID().toString();</span>
<a href="#l55.670"></a><span id="l55.670">   return uuid.substring(1, uuid.length - 2);</span>
<a href="#l55.671"></a><span id="l55.671"> </span>
<a href="#l55.672"></a><span id="l55.672"> }</span>
<a href="#l55.673"></a><span id="l55.673"> </span>
<a href="#l55.674"></a><span id="l55.674" class="difflineminus">-function parseHeaders(data, start)</span>
<a href="#l55.675"></a><span id="l55.675" class="difflineminus">-{</span>
<a href="#l55.676"></a><span id="l55.676" class="difflineplus">+function parseHeaders(data, start) {</span>
<a href="#l55.677"></a><span id="l55.677">   let headers = {};</span>
<a href="#l55.678"></a><span id="l55.678"> </span>
<a href="#l55.679"></a><span id="l55.679">   while (true) {</span>
<a href="#l55.680"></a><span id="l55.680" class="difflineminus">-    let done = false;</span>
<a href="#l55.681"></a><span id="l55.681">     let end = data.indexOf(&quot;\r\n&quot;, start);</span>
<a href="#l55.682"></a><span id="l55.682">     if (end == -1) {</span>
<a href="#l55.683"></a><span id="l55.683" class="difflineminus">-      done = true;</span>
<a href="#l55.684"></a><span id="l55.684">       end = data.length;</span>
<a href="#l55.685"></a><span id="l55.685">     }</span>
<a href="#l55.686"></a><span id="l55.686">     let line = data.substring(start, end);</span>
<a href="#l55.687"></a><span id="l55.687">     start = end + 2;</span>
<a href="#l55.688"></a><span id="l55.688">     if (line == &quot;&quot;)</span>
<a href="#l55.689"></a><span id="l55.689">       // empty line, we're done</span>
<a href="#l55.690"></a><span id="l55.690">       break;</span>
<a href="#l55.691"></a><span id="l55.691"> </span>
<a href="#l55.692"></a><span id="l55.692" class="difflineminus">-    //XXX: this doesn't handle multi-line headers. do we care?</span>
<a href="#l55.693"></a><span id="l55.693" class="difflineminus">-    let [name, value] = line.split(':');</span>
<a href="#l55.694"></a><span id="l55.694" class="difflineminus">-    //XXX: not normalized, should probably use nsHttpHeaders or something</span>
<a href="#l55.695"></a><span id="l55.695" class="difflineplus">+    // XXX: this doesn't handle multi-line headers. do we care?</span>
<a href="#l55.696"></a><span id="l55.696" class="difflineplus">+    let [name, value] = line.split(&quot;:&quot;);</span>
<a href="#l55.697"></a><span id="l55.697" class="difflineplus">+    // XXX: not normalized, should probably use nsHttpHeaders or something</span>
<a href="#l55.698"></a><span id="l55.698">     headers[name] = value.trimLeft();</span>
<a href="#l55.699"></a><span id="l55.699">   }</span>
<a href="#l55.700"></a><span id="l55.700">   return [headers, start];</span>
<a href="#l55.701"></a><span id="l55.701"> }</span>
<a href="#l55.702"></a><span id="l55.702"> </span>
<a href="#l55.703"></a><span id="l55.703" class="difflineminus">-function parseMultipartForm(request)</span>
<a href="#l55.704"></a><span id="l55.704" class="difflineminus">-{</span>
<a href="#l55.705"></a><span id="l55.705" class="difflineplus">+function parseMultipartForm(request) {</span>
<a href="#l55.706"></a><span id="l55.706">   let boundary = null;</span>
<a href="#l55.707"></a><span id="l55.707">   // See if this is a multipart/form-data request, and if so, find the</span>
<a href="#l55.708"></a><span id="l55.708">   // boundary string</span>
<a href="#l55.709"></a><span id="l55.709">   if (request.hasHeader(&quot;Content-Type&quot;)) {</span>
<a href="#l55.710"></a><span id="l55.710">     let contenttype = request.getHeader(&quot;Content-Type&quot;);</span>
<a href="#l55.711"></a><span id="l55.711">     let bits = contenttype.split(&quot;;&quot;);</span>
<a href="#l55.712"></a><span id="l55.712">     if (bits[0] == &quot;multipart/form-data&quot;) {</span>
<a href="#l55.713"></a><span id="l55.713">       for (let i = 1; i &lt; bits.length; i++) {</span>
<a href="#l55.714"></a><span id="l55.714" class="difflineat">@@ -735,23 +729,21 @@ function parseMultipartForm(request)</span>
<a href="#l55.715"></a><span id="l55.715">   body.setInputStream(request.bodyInputStream);</span>
<a href="#l55.716"></a><span id="l55.716"> </span>
<a href="#l55.717"></a><span id="l55.717">   let avail;</span>
<a href="#l55.718"></a><span id="l55.718">   let bytes = [];</span>
<a href="#l55.719"></a><span id="l55.719">   while ((avail = body.available()) &gt; 0)</span>
<a href="#l55.720"></a><span id="l55.720">     Array.prototype.push.apply(bytes, body.readByteArray(avail));</span>
<a href="#l55.721"></a><span id="l55.721">   let data = String.fromCharCode.apply(null, bytes);</span>
<a href="#l55.722"></a><span id="l55.722">   let formData = {};</span>
<a href="#l55.723"></a><span id="l55.723" class="difflineminus">-  let done = false;</span>
<a href="#l55.724"></a><span id="l55.724">   let start = 0;</span>
<a href="#l55.725"></a><span id="l55.725">   while (true) {</span>
<a href="#l55.726"></a><span id="l55.726">     // read first line</span>
<a href="#l55.727"></a><span id="l55.727">     let end = data.indexOf(&quot;\r\n&quot;, start);</span>
<a href="#l55.728"></a><span id="l55.728">     if (end == -1) {</span>
<a href="#l55.729"></a><span id="l55.729" class="difflineminus">-      done = true;</span>
<a href="#l55.730"></a><span id="l55.730">       end = data.length;</span>
<a href="#l55.731"></a><span id="l55.731">     }</span>
<a href="#l55.732"></a><span id="l55.732"> </span>
<a href="#l55.733"></a><span id="l55.733">     let line = data.substring(start, end);</span>
<a href="#l55.734"></a><span id="l55.734">     // look for closing boundary delimiter line</span>
<a href="#l55.735"></a><span id="l55.735">     if (line == boundary + &quot;--&quot;) {</span>
<a href="#l55.736"></a><span id="l55.736">       break;</span>
<a href="#l55.737"></a><span id="l55.737">     }</span>
<a href="#l55.738"></a><span id="l55.738" class="difflineat">@@ -773,31 +765,31 @@ function parseMultipartForm(request)</span>
<a href="#l55.739"></a><span id="l55.739">       break;</span>
<a href="#l55.740"></a><span id="l55.740">     }</span>
<a href="#l55.741"></a><span id="l55.741"> </span>
<a href="#l55.742"></a><span id="l55.742">     // read part data, stick in formData using Content-Disposition header</span>
<a href="#l55.743"></a><span id="l55.743">     let part = data.substring(start, end);</span>
<a href="#l55.744"></a><span id="l55.744">     start = end + 2;</span>
<a href="#l55.745"></a><span id="l55.745"> </span>
<a href="#l55.746"></a><span id="l55.746">     if (&quot;Content-Disposition&quot; in headers) {</span>
<a href="#l55.747"></a><span id="l55.747" class="difflineminus">-      let bits = headers[&quot;Content-Disposition&quot;].split(';');</span>
<a href="#l55.748"></a><span id="l55.748" class="difflineminus">-      if (bits[0] == 'form-data') {</span>
<a href="#l55.749"></a><span id="l55.749" class="difflineplus">+      let bits = headers[&quot;Content-Disposition&quot;].split(&quot;;&quot;);</span>
<a href="#l55.750"></a><span id="l55.750" class="difflineplus">+      if (bits[0] == &quot;form-data&quot;) {</span>
<a href="#l55.751"></a><span id="l55.751">         for (let i = 0; i &lt; bits.length; i++) {</span>
<a href="#l55.752"></a><span id="l55.752">           let b = bits[i].trimLeft();</span>
<a href="#l55.753"></a><span id="l55.753" class="difflineminus">-          if (b.startsWith('name=')) {</span>
<a href="#l55.754"></a><span id="l55.754" class="difflineminus">-            //TODO: handle non-ascii here?</span>
<a href="#l55.755"></a><span id="l55.755" class="difflineplus">+          if (b.startsWith(&quot;name=&quot;)) {</span>
<a href="#l55.756"></a><span id="l55.756" class="difflineplus">+            // TODO: handle non-ascii here?</span>
<a href="#l55.757"></a><span id="l55.757">             let name = b.substring(6, b.length - 1);</span>
<a href="#l55.758"></a><span id="l55.758" class="difflineminus">-            //TODO: handle multiple-value properties?</span>
<a href="#l55.759"></a><span id="l55.759" class="difflineplus">+            // TODO: handle multiple-value properties?</span>
<a href="#l55.760"></a><span id="l55.760">             formData[name] = part;</span>
<a href="#l55.761"></a><span id="l55.761">           }</span>
<a href="#l55.762"></a><span id="l55.762" class="difflineminus">-          if (b.startsWith('filename=')) {</span>
<a href="#l55.763"></a><span id="l55.763" class="difflineplus">+          if (b.startsWith(&quot;filename=&quot;)) {</span>
<a href="#l55.764"></a><span id="l55.764">             let filename = b.substring(10, b.length - 1);</span>
<a href="#l55.765"></a><span id="l55.765" class="difflineminus">-            formData['filename'] = filename;</span>
<a href="#l55.766"></a><span id="l55.766" class="difflineplus">+            formData.filename = filename;</span>
<a href="#l55.767"></a><span id="l55.767">           }</span>
<a href="#l55.768"></a><span id="l55.768" class="difflineminus">-          //TODO: handle filename= ?</span>
<a href="#l55.769"></a><span id="l55.769" class="difflineminus">-          //TODO: handle multipart/mixed for multi-file uploads?</span>
<a href="#l55.770"></a><span id="l55.770" class="difflineplus">+          // TODO: handle filename= ?</span>
<a href="#l55.771"></a><span id="l55.771" class="difflineplus">+          // TODO: handle multipart/mixed for multi-file uploads?</span>
<a href="#l55.772"></a><span id="l55.772">         }</span>
<a href="#l55.773"></a><span id="l55.773">       }</span>
<a href="#l55.774"></a><span id="l55.774">     }</span>
<a href="#l55.775"></a><span id="l55.775">   }</span>
<a href="#l55.776"></a><span id="l55.776">   return formData;</span>
<a href="#l55.777"></a><span id="l55.777"> }</span>
<a href="#l55.778"></a><span id="l55.778"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mail/themes/linux/jar.mn</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mail/themes/linux/jar.mn</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -82,18 +82,16 @@ classic.jar:</span>
<a href="#l56.4"></a><span id="l56.4">   skin/classic/messenger/addressbook/icons/addrbook.png       (mail/addrbook/addrbook.png)</span>
<a href="#l56.5"></a><span id="l56.5">   skin/classic/messenger/addressbook/icons/ablist.png         (mail/addrbook/ablist.png)</span>
<a href="#l56.6"></a><span id="l56.6">   skin/classic/messenger/addressbook/icons/contact-generic.png             (mail/addrbook/contact-generic.png)</span>
<a href="#l56.7"></a><span id="l56.7">   skin/classic/messenger/addressbook/icons/contact-generic-tiny.png        (mail/addrbook/contact-generic-tiny.png)</span>
<a href="#l56.8"></a><span id="l56.8">   skin/classic/messenger/addressbook/icons/abcard-large.png   (mail/addrbook/abcard-large.png)</span>
<a href="#l56.9"></a><span id="l56.9">   skin/classic/messenger/addressbook/icons/remote-addrbook.png (mail/addrbook/remote-addrbook.png)</span>
<a href="#l56.10"></a><span id="l56.10">   skin/classic/messenger/addressbook/icons/remote-addrbook-error.png      (mail/addrbook/remote-addrbook-error.png)</span>
<a href="#l56.11"></a><span id="l56.11">   skin/classic/messenger/addressbook/icons/secure-remote-addrbook.png     (mail/addrbook/secure-remote-addrbook.png)</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineminus">-  skin/classic/messenger/cloudfile/addAccountDialog.css       (mail/cloudfile/addAccountDialog.css)</span>
<a href="#l56.13"></a><span id="l56.13" class="difflineminus">-  skin/classic/messenger/cloudfile/Hightail/settings.css               (mail/cloudfile/Hightail/settings.css)</span>
<a href="#l56.14"></a><span id="l56.14">   skin/classic/messenger/cloudfile/Hightail/fileExceedsLimit.css       (mail/cloudfile/Hightail/fileExceedsLimit.css)</span>
<a href="#l56.15"></a><span id="l56.15">   skin/classic/messenger/cloudfile/Hightail/check.png                  (mail/cloudfile/Hightail/check.png)</span>
<a href="#l56.16"></a><span id="l56.16">   skin/classic/messenger/messengercompose/messengercompose.css (mail/compose/messengercompose.css)</span>
<a href="#l56.17"></a><span id="l56.17">   skin/classic/messenger/messengercompose/linux-noise.png     (mail/compose/linux-noise.png)</span>
<a href="#l56.18"></a><span id="l56.18">   skin/classic/messenger/downloads/aboutDownloads.css         (mail/downloads/aboutDownloads.css)</span>
<a href="#l56.19"></a><span id="l56.19"> % skin messenger-newsblog classic/1.0 %skin/classic/messenger-newsblog/</span>
<a href="#l56.20"></a><span id="l56.20">   skin/classic/messenger-newsblog/feed-subscriptions.css      (mail/newsblog/feed-subscriptions.css)</span>
<a href="#l56.21"></a><span id="l56.21">   skin/classic/messenger-newsblog/icons/rss-feed.png          (mail/newsblog/rss-feed.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1">deleted file mode 100644</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineminus">--- a/mail/themes/linux/mail/cloudfile/Hightail/settings.css</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineplus">+++ /dev/null</span>
<a href="#l57.4"></a><span id="l57.4" class="difflineat">@@ -1,9 +0,0 @@</span>
<a href="#l57.5"></a><span id="l57.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l57.6"></a><span id="l57.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l57.7"></a><span id="l57.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l57.8"></a><span id="l57.8" class="difflineminus">-</span>
<a href="#l57.9"></a><span id="l57.9" class="difflineminus">-#username.hint {</span>
<a href="#l57.10"></a><span id="l57.10" class="difflineminus">-  color: gray;</span>
<a href="#l57.11"></a><span id="l57.11" class="difflineminus">-  font-style:italic;</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineminus">-  font-size:95%</span>
<a href="#l57.13"></a><span id="l57.13" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1">deleted file mode 100644</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineminus">--- a/mail/themes/linux/mail/cloudfile/addAccountDialog.css</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineplus">+++ /dev/null</span>
<a href="#l58.4"></a><span id="l58.4" class="difflineat">@@ -1,104 +0,0 @@</span>
<a href="#l58.5"></a><span id="l58.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l58.6"></a><span id="l58.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l58.7"></a><span id="l58.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l58.8"></a><span id="l58.8" class="difflineminus">-</span>
<a href="#l58.9"></a><span id="l58.9" class="difflineminus">-html, body {</span>
<a href="#l58.10"></a><span id="l58.10" class="difflineminus">-  font: message-box;</span>
<a href="#l58.11"></a><span id="l58.11" class="difflineminus">-  margin: 0;</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineminus">-}</span>
<a href="#l58.13"></a><span id="l58.13" class="difflineminus">-</span>
<a href="#l58.14"></a><span id="l58.14" class="difflineminus">-a {</span>
<a href="#l58.15"></a><span id="l58.15" class="difflineminus">-  color: -moz-nativehyperlinktext;</span>
<a href="#l58.16"></a><span id="l58.16" class="difflineminus">-  text-decoration: underline;</span>
<a href="#l58.17"></a><span id="l58.17" class="difflineminus">-}</span>
<a href="#l58.18"></a><span id="l58.18" class="difflineminus">-</span>
<a href="#l58.19"></a><span id="l58.19" class="difflineminus">-#addCloudFileAccount {</span>
<a href="#l58.20"></a><span id="l58.20" class="difflineminus">-  padding-left: 15px;</span>
<a href="#l58.21"></a><span id="l58.21" class="difflineminus">-  padding-right: 13px;</span>
<a href="#l58.22"></a><span id="l58.22" class="difflineminus">-  padding-top: 15px;</span>
<a href="#l58.23"></a><span id="l58.23" class="difflineminus">-  padding-bottom: 15px;</span>
<a href="#l58.24"></a><span id="l58.24" class="difflineminus">-}</span>
<a href="#l58.25"></a><span id="l58.25" class="difflineminus">-</span>
<a href="#l58.26"></a><span id="l58.26" class="difflineminus">-#createAccountText {</span>
<a href="#l58.27"></a><span id="l58.27" class="difflineminus">-  margin-bottom: 20px;</span>
<a href="#l58.28"></a><span id="l58.28" class="difflineminus">-}</span>
<a href="#l58.29"></a><span id="l58.29" class="difflineminus">-</span>
<a href="#l58.30"></a><span id="l58.30" class="difflineminus">-.indent {</span>
<a href="#l58.31"></a><span id="l58.31" class="difflineminus">-  margin-bottom: 15px;</span>
<a href="#l58.32"></a><span id="l58.32" class="difflineminus">-  margin-inline-start: 50px;</span>
<a href="#l58.33"></a><span id="l58.33" class="difflineminus">-  margin-inline-end: 50px;</span>
<a href="#l58.34"></a><span id="l58.34" class="difflineminus">-}</span>
<a href="#l58.35"></a><span id="l58.35" class="difflineminus">-</span>
<a href="#l58.36"></a><span id="l58.36" class="difflineminus">-.small-indent {</span>
<a href="#l58.37"></a><span id="l58.37" class="difflineminus">-  margin-bottom: 15px;</span>
<a href="#l58.38"></a><span id="l58.38" class="difflineminus">-  margin-inline-start: 6px;</span>
<a href="#l58.39"></a><span id="l58.39" class="difflineminus">-  margin-inline-end: 6px;</span>
<a href="#l58.40"></a><span id="l58.40" class="difflineminus">-}</span>
<a href="#l58.41"></a><span id="l58.41" class="difflineminus">-</span>
<a href="#l58.42"></a><span id="l58.42" class="difflineminus">-#accountType {</span>
<a href="#l58.43"></a><span id="l58.43" class="difflineminus">-  height: 29px;</span>
<a href="#l58.44"></a><span id="l58.44" class="difflineminus">-  /* We have to be a stickler about the width here, or else we get</span>
<a href="#l58.45"></a><span id="l58.45" class="difflineminus">-     weird issues where the menu will resize itself by a single pixel</span>
<a href="#l58.46"></a><span id="l58.46" class="difflineminus">-     when switching selections, which is distracting. */</span>
<a href="#l58.47"></a><span id="l58.47" class="difflineminus">-  min-width: 458px;</span>
<a href="#l58.48"></a><span id="l58.48" class="difflineminus">-  max-width: 458px;</span>
<a href="#l58.49"></a><span id="l58.49" class="difflineminus">-}</span>
<a href="#l58.50"></a><span id="l58.50" class="difflineminus">-</span>
<a href="#l58.51"></a><span id="l58.51" class="difflineminus">-#messages {</span>
<a href="#l58.52"></a><span id="l58.52" class="difflineminus">-  margin-top: 5px;</span>
<a href="#l58.53"></a><span id="l58.53" class="difflineminus">-}</span>
<a href="#l58.54"></a><span id="l58.54" class="difflineminus">-</span>
<a href="#l58.55"></a><span id="l58.55" class="difflineminus">-#messages #authorizing,</span>
<a href="#l58.56"></a><span id="l58.56" class="difflineminus">-#messages #error {</span>
<a href="#l58.57"></a><span id="l58.57" class="difflineminus">-  -moz-box-align: center;</span>
<a href="#l58.58"></a><span id="l58.58" class="difflineminus">-}</span>
<a href="#l58.59"></a><span id="l58.59" class="difflineminus">-</span>
<a href="#l58.60"></a><span id="l58.60" class="difflineminus">-#messages #authorizing image,</span>
<a href="#l58.61"></a><span id="l58.61" class="difflineminus">-#messages #error image {</span>
<a href="#l58.62"></a><span id="l58.62" class="difflineminus">-  max-width: 16px;</span>
<a href="#l58.63"></a><span id="l58.63" class="difflineminus">-  max-height: 16px;</span>
<a href="#l58.64"></a><span id="l58.64" class="difflineminus">-  vertical-align: middle;</span>
<a href="#l58.65"></a><span id="l58.65" class="difflineminus">-}</span>
<a href="#l58.66"></a><span id="l58.66" class="difflineminus">-</span>
<a href="#l58.67"></a><span id="l58.67" class="difflineminus">-#accountSettings {</span>
<a href="#l58.68"></a><span id="l58.68" class="difflineminus">-  overflow-x: hidden;</span>
<a href="#l58.69"></a><span id="l58.69" class="difflineminus">-  overflow-y: hidden;</span>
<a href="#l58.70"></a><span id="l58.70" class="difflineminus">-}</span>
<a href="#l58.71"></a><span id="l58.71" class="difflineminus">-</span>
<a href="#l58.72"></a><span id="l58.72" class="difflineminus">-#accountSettings body {</span>
<a href="#l58.73"></a><span id="l58.73" class="difflineminus">-  margin: 0;</span>
<a href="#l58.74"></a><span id="l58.74" class="difflineminus">-  padding: 0;</span>
<a href="#l58.75"></a><span id="l58.75" class="difflineminus">-}</span>
<a href="#l58.76"></a><span id="l58.76" class="difflineminus">-</span>
<a href="#l58.77"></a><span id="l58.77" class="difflineminus">-#provider-settings {</span>
<a href="#l58.78"></a><span id="l58.78" class="difflineminus">-  min-height: 80px;</span>
<a href="#l58.79"></a><span id="l58.79" class="difflineminus">-}</span>
<a href="#l58.80"></a><span id="l58.80" class="difflineminus">-</span>
<a href="#l58.81"></a><span id="l58.81" class="difflineminus">-#provider-form label, #provider-form input {</span>
<a href="#l58.82"></a><span id="l58.82" class="difflineminus">-  display: block;</span>
<a href="#l58.83"></a><span id="l58.83" class="difflineminus">-  margin-bottom: 5px;</span>
<a href="#l58.84"></a><span id="l58.84" class="difflineminus">-}</span>
<a href="#l58.85"></a><span id="l58.85" class="difflineminus">-</span>
<a href="#l58.86"></a><span id="l58.86" class="difflineminus">-#provider-form input {</span>
<a href="#l58.87"></a><span id="l58.87" class="difflineminus">-  box-sizing: border-box;</span>
<a href="#l58.88"></a><span id="l58.88" class="difflineminus">-  width: 100%;</span>
<a href="#l58.89"></a><span id="l58.89" class="difflineminus">-}</span>
<a href="#l58.90"></a><span id="l58.90" class="difflineminus">-</span>
<a href="#l58.91"></a><span id="l58.91" class="difflineminus">-/* Make the icons show up in the menulist */</span>
<a href="#l58.92"></a><span id="l58.92" class="difflineminus">-#accountType &gt; menupopup &gt; menuitem &gt; .menu-iconic-left {</span>
<a href="#l58.93"></a><span id="l58.93" class="difflineminus">-  padding-inline-end: 2px;</span>
<a href="#l58.94"></a><span id="l58.94" class="difflineminus">-  display: -moz-box;</span>
<a href="#l58.95"></a><span id="l58.95" class="difflineminus">-  min-width: 16px;</span>
<a href="#l58.96"></a><span id="l58.96" class="difflineminus">-}</span>
<a href="#l58.97"></a><span id="l58.97" class="difflineminus">-</span>
<a href="#l58.98"></a><span id="l58.98" class="difflineminus">-.menulist-icon {</span>
<a href="#l58.99"></a><span id="l58.99" class="difflineminus">-  width: 16px;</span>
<a href="#l58.100"></a><span id="l58.100" class="difflineminus">-}</span>
<a href="#l58.101"></a><span id="l58.101" class="difflineminus">-</span>
<a href="#l58.102"></a><span id="l58.102" class="difflineminus">-#learn-more {</span>
<a href="#l58.103"></a><span id="l58.103" class="difflineminus">-  text-align: right;</span>
<a href="#l58.104"></a><span id="l58.104" class="difflineminus">-}</span>
<a href="#l58.105"></a><span id="l58.105" class="difflineminus">-</span>
<a href="#l58.106"></a><span id="l58.106" class="difflineminus">-.float-right {</span>
<a href="#l58.107"></a><span id="l58.107" class="difflineminus">-  float: right;</span>
<a href="#l58.108"></a><span id="l58.108" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mail/themes/linux/mail/preferences/applications.css</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mail/themes/linux/mail/preferences/applications.css</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -48,33 +48,43 @@ menuitem[appHandlerIcon=&quot;save&quot;] {</span>
<a href="#l59.4"></a><span id="l59.4"> </span>
<a href="#l59.5"></a><span id="l59.5"> .actionsMenu &gt; menupopup &gt; menuitem {</span>
<a href="#l59.6"></a><span id="l59.6">   padding-inline-start: 3px;</span>
<a href="#l59.7"></a><span id="l59.7"> }</span>
<a href="#l59.8"></a><span id="l59.8"> </span>
<a href="#l59.9"></a><span id="l59.9"> /**</span>
<a href="#l59.10"></a><span id="l59.10">  * Used by the outgoing attachment manager</span>
<a href="#l59.11"></a><span id="l59.11">  */</span>
<a href="#l59.12"></a><span id="l59.12" class="difflineminus">-.cloudfileAccount[state=&quot;connecting&quot;],</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineminus">-.cloudfileAccount[state=&quot;waiting-to-connect&quot;] {</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineminus">-  list-style-image: url(&quot;chrome://global/skin/icons/loading.png&quot;) !important;</span>
<a href="#l59.15"></a><span id="l59.15" class="difflineminus">-}</span>
<a href="#l59.16"></a><span id="l59.16" class="difflineminus">-</span>
<a href="#l59.17"></a><span id="l59.17" class="difflineminus">-.cloudfileAccount[state=&quot;auth-error&quot;],</span>
<a href="#l59.18"></a><span id="l59.18" class="difflineminus">-.cloudfileAccount[state=&quot;no-connection&quot;] {</span>
<a href="#l59.19"></a><span id="l59.19" class="difflineminus">-  list-style-image: url(&quot;moz-icon://stock/gtk-dialog-error?size=menu&quot;)!important;</span>
<a href="#l59.20"></a><span id="l59.20" class="difflineplus">+.cloudfileAccount {</span>
<a href="#l59.21"></a><span id="l59.21" class="difflineplus">+  padding: 4px;</span>
<a href="#l59.22"></a><span id="l59.22"> }</span>
<a href="#l59.23"></a><span id="l59.23"> </span>
<a href="#l59.24"></a><span id="l59.24"> .cloudfileAccount .typeIcon {</span>
<a href="#l59.25"></a><span id="l59.25" class="difflineminus">-  max-height: 16px;</span>
<a href="#l59.26"></a><span id="l59.26" class="difflineminus">-  max-width: 16px;</span>
<a href="#l59.27"></a><span id="l59.27" class="difflineplus">+  height: 16px;</span>
<a href="#l59.28"></a><span id="l59.28" class="difflineplus">+  width: 16px;</span>
<a href="#l59.29"></a><span id="l59.29">   margin-top: 3px;</span>
<a href="#l59.30"></a><span id="l59.30">   margin-bottom: 3px;</span>
<a href="#l59.31"></a><span id="l59.31"> }</span>
<a href="#l59.32"></a><span id="l59.32"> </span>
<a href="#l59.33"></a><span id="l59.33" class="difflineplus">+.cloudfileAccount &gt; label {</span>
<a href="#l59.34"></a><span id="l59.34" class="difflineplus">+  /* This label needs to be the same height as the textbox. */</span>
<a href="#l59.35"></a><span id="l59.35" class="difflineplus">+  margin-top: 3px;</span>
<a href="#l59.36"></a><span id="l59.36" class="difflineplus">+  margin-bottom: 4px;</span>
<a href="#l59.37"></a><span id="l59.37" class="difflineplus">+}</span>
<a href="#l59.38"></a><span id="l59.38" class="difflineplus">+.cloudfileAccount:not([selected]) &gt; label {</span>
<a href="#l59.39"></a><span id="l59.39" class="difflineplus">+  pointer-events: none;</span>
<a href="#l59.40"></a><span id="l59.40" class="difflineplus">+}</span>
<a href="#l59.41"></a><span id="l59.41" class="difflineplus">+</span>
<a href="#l59.42"></a><span id="l59.42" class="difflineplus">+.cloudfileAccount &gt; textbox {</span>
<a href="#l59.43"></a><span id="l59.43" class="difflineplus">+  color: -moz-fieldtext !important;</span>
<a href="#l59.44"></a><span id="l59.44" class="difflineplus">+  min-height: unset;</span>
<a href="#l59.45"></a><span id="l59.45" class="difflineplus">+  margin: 0;</span>
<a href="#l59.46"></a><span id="l59.46" class="difflineplus">+  padding-inline: 4px;</span>
<a href="#l59.47"></a><span id="l59.47" class="difflineplus">+}</span>
<a href="#l59.48"></a><span id="l59.48" class="difflineplus">+</span>
<a href="#l59.49"></a><span id="l59.49"> #authMessage {</span>
<a href="#l59.50"></a><span id="l59.50">   text-align: center;</span>
<a href="#l59.51"></a><span id="l59.51">   padding: 0px 80px;</span>
<a href="#l59.52"></a><span id="l59.52"> }</span>
<a href="#l59.53"></a><span id="l59.53"> </span>
<a href="#l59.54"></a><span id="l59.54"> #authImage {</span>
<a href="#l59.55"></a><span id="l59.55">   list-style-image: url(&quot;chrome://messenger/skin/preferences/auth-error.png&quot;);</span>
<a href="#l59.56"></a><span id="l59.56">   width: 200px;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mail/themes/linux/mail/preferences/preferences.css</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mail/themes/linux/mail/preferences/preferences.css</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -168,18 +168,17 @@ a {</span>
<a href="#l60.4"></a><span id="l60.4"> #provider-space {</span>
<a href="#l60.5"></a><span id="l60.5">   text-align: right;</span>
<a href="#l60.6"></a><span id="l60.6">   margin-right: 190px;</span>
<a href="#l60.7"></a><span id="l60.7">   margin-top: 50px;</span>
<a href="#l60.8"></a><span id="l60.8">   height: 100px;</span>
<a href="#l60.9"></a><span id="l60.9"> }</span>
<a href="#l60.10"></a><span id="l60.10"> </span>
<a href="#l60.11"></a><span id="l60.11"> #cloudFileView {</span>
<a href="#l60.12"></a><span id="l60.12" class="difflineminus">-  width: 150px;</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineminus">-  overflow: hidden;</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineplus">+  overflow-x: hidden;</span>
<a href="#l60.15"></a><span id="l60.15"> }</span>
<a href="#l60.16"></a><span id="l60.16"> </span>
<a href="#l60.17"></a><span id="l60.17"> #upgrade {</span>
<a href="#l60.18"></a><span id="l60.18">   margin-top: 1em;</span>
<a href="#l60.19"></a><span id="l60.19"> }</span>
<a href="#l60.20"></a><span id="l60.20"> </span>
<a href="#l60.21"></a><span id="l60.21"> #provider-space-visuals {</span>
<a href="#l60.22"></a><span id="l60.22">   width: 150px;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mail/themes/osx/jar.mn</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mail/themes/osx/jar.mn</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -80,18 +80,16 @@ classic.jar:</span>
<a href="#l61.4"></a><span id="l61.4">   skin/classic/messenger/addressbook/icons/contact-generic@2x.png          (mail/addrbook/contact-generic@2x.png)</span>
<a href="#l61.5"></a><span id="l61.5">   skin/classic/messenger/addressbook/icons/contact-generic-tiny.png        (mail/addrbook/contact-generic-tiny.png)</span>
<a href="#l61.6"></a><span id="l61.6">   skin/classic/messenger/addressbook/icons/contact-generic-tiny@2x.png     (mail/addrbook/contact-generic-tiny@2x.png)</span>
<a href="#l61.7"></a><span id="l61.7">   skin/classic/messenger/addressbook/icons/addressbook@2x.png              (mail/addrbook/addressbook@2x.png)</span>
<a href="#l61.8"></a><span id="l61.8">   skin/classic/messenger/addressbook/icons/addrbook.png                    (mail/addrbook/addrbook.png)</span>
<a href="#l61.9"></a><span id="l61.9">   skin/classic/messenger/addressbook/icons/remote-addrbook-error.png       (mail/addrbook/remote-addrbook-error.png)</span>
<a href="#l61.10"></a><span id="l61.10">   skin/classic/messenger/addressbook/icons/remote-addrbook.png             (mail/addrbook/remote-addrbook.png)</span>
<a href="#l61.11"></a><span id="l61.11">   skin/classic/messenger/addressbook/icons/secure-remote-addrbook.png      (mail/addrbook/secure-remote-addrbook.png)</span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-  skin/classic/messenger/cloudfile/addAccountDialog.css                    (mail/cloudfile/addAccountDialog.css)</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineminus">-  skin/classic/messenger/cloudfile/Hightail/settings.css                   (mail/cloudfile/Hightail/settings.css)</span>
<a href="#l61.14"></a><span id="l61.14">   skin/classic/messenger/cloudfile/Hightail/fileExceedsLimit.css           (mail/cloudfile/Hightail/fileExceedsLimit.css)</span>
<a href="#l61.15"></a><span id="l61.15">   skin/classic/messenger/cloudfile/Hightail/check.png                      (mail/cloudfile/Hightail/check.png)</span>
<a href="#l61.16"></a><span id="l61.16">   skin/classic/messenger/messengercompose/messengercompose.css             (mail/compose/messengercompose.css)</span>
<a href="#l61.17"></a><span id="l61.17">   skin/classic/messenger/messengercompose/emoticon_cool.png                (mail/compose/emoticon_cool.png)</span>
<a href="#l61.18"></a><span id="l61.18">   skin/classic/messenger/messengercompose/emoticon_cry.png                 (mail/compose/emoticon_cry.png)</span>
<a href="#l61.19"></a><span id="l61.19">   skin/classic/messenger/messengercompose/emoticon_embarrassed.png         (mail/compose/emoticon_embarrassed.png)</span>
<a href="#l61.20"></a><span id="l61.20">   skin/classic/messenger/messengercompose/emoticon_foot_in_mouth.png       (mail/compose/emoticon_foot_in_mouth.png)</span>
<a href="#l61.21"></a><span id="l61.21">   skin/classic/messenger/messengercompose/emoticon_frown.png               (mail/compose/emoticon_frown.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1">deleted file mode 100644</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineminus">--- a/mail/themes/osx/mail/cloudfile/Hightail/settings.css</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineplus">+++ /dev/null</span>
<a href="#l62.4"></a><span id="l62.4" class="difflineat">@@ -1,9 +0,0 @@</span>
<a href="#l62.5"></a><span id="l62.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l62.6"></a><span id="l62.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l62.7"></a><span id="l62.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l62.8"></a><span id="l62.8" class="difflineminus">-</span>
<a href="#l62.9"></a><span id="l62.9" class="difflineminus">-#username.hint {</span>
<a href="#l62.10"></a><span id="l62.10" class="difflineminus">-  color: gray;</span>
<a href="#l62.11"></a><span id="l62.11" class="difflineminus">-  font-style:italic;</span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-  font-size:95%</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1">deleted file mode 100644</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineminus">--- a/mail/themes/osx/mail/cloudfile/addAccountDialog.css</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineplus">+++ /dev/null</span>
<a href="#l63.4"></a><span id="l63.4" class="difflineat">@@ -1,109 +0,0 @@</span>
<a href="#l63.5"></a><span id="l63.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l63.6"></a><span id="l63.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l63.7"></a><span id="l63.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l63.8"></a><span id="l63.8" class="difflineminus">-</span>
<a href="#l63.9"></a><span id="l63.9" class="difflineminus">-html, body {</span>
<a href="#l63.10"></a><span id="l63.10" class="difflineminus">-  font: message-box;</span>
<a href="#l63.11"></a><span id="l63.11" class="difflineminus">-  margin: 0;</span>
<a href="#l63.12"></a><span id="l63.12" class="difflineminus">-}</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineminus">-</span>
<a href="#l63.14"></a><span id="l63.14" class="difflineminus">-a {</span>
<a href="#l63.15"></a><span id="l63.15" class="difflineminus">-  color: -moz-nativehyperlinktext;</span>
<a href="#l63.16"></a><span id="l63.16" class="difflineminus">-  text-decoration: underline;</span>
<a href="#l63.17"></a><span id="l63.17" class="difflineminus">-}</span>
<a href="#l63.18"></a><span id="l63.18" class="difflineminus">-</span>
<a href="#l63.19"></a><span id="l63.19" class="difflineminus">-#addCloudFileAccount {</span>
<a href="#l63.20"></a><span id="l63.20" class="difflineminus">-  padding-left: 18px;</span>
<a href="#l63.21"></a><span id="l63.21" class="difflineminus">-  padding-right: 11px;</span>
<a href="#l63.22"></a><span id="l63.22" class="difflineminus">-  padding-bottom: 15px;</span>
<a href="#l63.23"></a><span id="l63.23" class="difflineminus">-  padding-top: 15px;</span>
<a href="#l63.24"></a><span id="l63.24" class="difflineminus">-}</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineminus">-</span>
<a href="#l63.26"></a><span id="l63.26" class="difflineminus">-#createAccountTitle {</span>
<a href="#l63.27"></a><span id="l63.27" class="difflineminus">-  font-size: 12px;</span>
<a href="#l63.28"></a><span id="l63.28" class="difflineminus">-  font-weight: bold;</span>
<a href="#l63.29"></a><span id="l63.29" class="difflineminus">-}</span>
<a href="#l63.30"></a><span id="l63.30" class="difflineminus">-</span>
<a href="#l63.31"></a><span id="l63.31" class="difflineminus">-#createAccountText {</span>
<a href="#l63.32"></a><span id="l63.32" class="difflineminus">-  margin-bottom: 20px;</span>
<a href="#l63.33"></a><span id="l63.33" class="difflineminus">-  margin-right: 3px;</span>
<a href="#l63.34"></a><span id="l63.34" class="difflineminus">-}</span>
<a href="#l63.35"></a><span id="l63.35" class="difflineminus">-</span>
<a href="#l63.36"></a><span id="l63.36" class="difflineminus">-.indent {</span>
<a href="#l63.37"></a><span id="l63.37" class="difflineminus">-  margin-bottom: 15px;</span>
<a href="#l63.38"></a><span id="l63.38" class="difflineminus">-  margin-inline-start: 50px;</span>
<a href="#l63.39"></a><span id="l63.39" class="difflineminus">-  margin-inline-end: 56px;</span>
<a href="#l63.40"></a><span id="l63.40" class="difflineminus">-}</span>
<a href="#l63.41"></a><span id="l63.41" class="difflineminus">-</span>
<a href="#l63.42"></a><span id="l63.42" class="difflineminus">-.small-indent {</span>
<a href="#l63.43"></a><span id="l63.43" class="difflineminus">-  margin-bottom: 15px;</span>
<a href="#l63.44"></a><span id="l63.44" class="difflineminus">-  margin-inline-start: 6px;</span>
<a href="#l63.45"></a><span id="l63.45" class="difflineminus">-  margin-inline-end: 6px;</span>
<a href="#l63.46"></a><span id="l63.46" class="difflineminus">-}</span>
<a href="#l63.47"></a><span id="l63.47" class="difflineminus">-</span>
<a href="#l63.48"></a><span id="l63.48" class="difflineminus">-#accountType {</span>
<a href="#l63.49"></a><span id="l63.49" class="difflineminus">-  height: 20px;</span>
<a href="#l63.50"></a><span id="l63.50" class="difflineminus">-  /* We have to be a stickler about the width here, or else we get</span>
<a href="#l63.51"></a><span id="l63.51" class="difflineminus">-     weird issues where the menu will resize itself by a single pixel</span>
<a href="#l63.52"></a><span id="l63.52" class="difflineminus">-     when switching selections, which is distracting. */</span>
<a href="#l63.53"></a><span id="l63.53" class="difflineminus">-  max-width: 310px;</span>
<a href="#l63.54"></a><span id="l63.54" class="difflineminus">-  min-width: 310px;</span>
<a href="#l63.55"></a><span id="l63.55" class="difflineminus">-}</span>
<a href="#l63.56"></a><span id="l63.56" class="difflineminus">-</span>
<a href="#l63.57"></a><span id="l63.57" class="difflineminus">-#messages {</span>
<a href="#l63.58"></a><span id="l63.58" class="difflineminus">-  margin-top: 5px;</span>
<a href="#l63.59"></a><span id="l63.59" class="difflineminus">-}</span>
<a href="#l63.60"></a><span id="l63.60" class="difflineminus">-</span>
<a href="#l63.61"></a><span id="l63.61" class="difflineminus">-#messages #authorizing,</span>
<a href="#l63.62"></a><span id="l63.62" class="difflineminus">-#messages #error {</span>
<a href="#l63.63"></a><span id="l63.63" class="difflineminus">-  -moz-box-align: center;</span>
<a href="#l63.64"></a><span id="l63.64" class="difflineminus">-}</span>
<a href="#l63.65"></a><span id="l63.65" class="difflineminus">-</span>
<a href="#l63.66"></a><span id="l63.66" class="difflineminus">-#messages #authorizing image,</span>
<a href="#l63.67"></a><span id="l63.67" class="difflineminus">-#messages #error image {</span>
<a href="#l63.68"></a><span id="l63.68" class="difflineminus">-  max-width: 16px;</span>
<a href="#l63.69"></a><span id="l63.69" class="difflineminus">-  max-height: 16px;</span>
<a href="#l63.70"></a><span id="l63.70" class="difflineminus">-  vertical-align: middle;</span>
<a href="#l63.71"></a><span id="l63.71" class="difflineminus">-}</span>
<a href="#l63.72"></a><span id="l63.72" class="difflineminus">-</span>
<a href="#l63.73"></a><span id="l63.73" class="difflineminus">-#accountSettings {</span>
<a href="#l63.74"></a><span id="l63.74" class="difflineminus">-  overflow-x: hidden;</span>
<a href="#l63.75"></a><span id="l63.75" class="difflineminus">-  overflow-y: hidden;</span>
<a href="#l63.76"></a><span id="l63.76" class="difflineminus">-}</span>
<a href="#l63.77"></a><span id="l63.77" class="difflineminus">-</span>
<a href="#l63.78"></a><span id="l63.78" class="difflineminus">-#accountSettings body {</span>
<a href="#l63.79"></a><span id="l63.79" class="difflineminus">-  margin: 0;</span>
<a href="#l63.80"></a><span id="l63.80" class="difflineminus">-  padding: 0;</span>
<a href="#l63.81"></a><span id="l63.81" class="difflineminus">-}</span>
<a href="#l63.82"></a><span id="l63.82" class="difflineminus">-</span>
<a href="#l63.83"></a><span id="l63.83" class="difflineminus">-#provider-settings {</span>
<a href="#l63.84"></a><span id="l63.84" class="difflineminus">-  min-height: 80px;</span>
<a href="#l63.85"></a><span id="l63.85" class="difflineminus">-}</span>
<a href="#l63.86"></a><span id="l63.86" class="difflineminus">-</span>
<a href="#l63.87"></a><span id="l63.87" class="difflineminus">-#provider-form label, #provider-form input {</span>
<a href="#l63.88"></a><span id="l63.88" class="difflineminus">-  display: block;</span>
<a href="#l63.89"></a><span id="l63.89" class="difflineminus">-  margin-bottom: 5px;</span>
<a href="#l63.90"></a><span id="l63.90" class="difflineminus">-}</span>
<a href="#l63.91"></a><span id="l63.91" class="difflineminus">-</span>
<a href="#l63.92"></a><span id="l63.92" class="difflineminus">-#provider-form input {</span>
<a href="#l63.93"></a><span id="l63.93" class="difflineminus">-  box-sizing: border-box;</span>
<a href="#l63.94"></a><span id="l63.94" class="difflineminus">-  width: 100%;</span>
<a href="#l63.95"></a><span id="l63.95" class="difflineminus">-}</span>
<a href="#l63.96"></a><span id="l63.96" class="difflineminus">-</span>
<a href="#l63.97"></a><span id="l63.97" class="difflineminus">-#accountType &gt; menupopup &gt; menuitem &gt; .menu-iconic-left {</span>
<a href="#l63.98"></a><span id="l63.98" class="difflineminus">-  display: -moz-box;</span>
<a href="#l63.99"></a><span id="l63.99" class="difflineminus">-  min-width: 16px;</span>
<a href="#l63.100"></a><span id="l63.100" class="difflineminus">-  padding-inline-end: 2px;</span>
<a href="#l63.101"></a><span id="l63.101" class="difflineminus">-}</span>
<a href="#l63.102"></a><span id="l63.102" class="difflineminus">-</span>
<a href="#l63.103"></a><span id="l63.103" class="difflineminus">-.menulist-icon {</span>
<a href="#l63.104"></a><span id="l63.104" class="difflineminus">-  width: 16px;</span>
<a href="#l63.105"></a><span id="l63.105" class="difflineminus">-}</span>
<a href="#l63.106"></a><span id="l63.106" class="difflineminus">-</span>
<a href="#l63.107"></a><span id="l63.107" class="difflineminus">-#learn-more {</span>
<a href="#l63.108"></a><span id="l63.108" class="difflineminus">-  text-align: right;</span>
<a href="#l63.109"></a><span id="l63.109" class="difflineminus">-}</span>
<a href="#l63.110"></a><span id="l63.110" class="difflineminus">-</span>
<a href="#l63.111"></a><span id="l63.111" class="difflineminus">-.float-right {</span>
<a href="#l63.112"></a><span id="l63.112" class="difflineminus">-  float: right;</span>
<a href="#l63.113"></a><span id="l63.113" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mail/themes/shared/mail/incontentprefs/aboutPreferences.css</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mail/themes/shared/mail/incontentprefs/aboutPreferences.css</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -331,16 +331,31 @@ listhead &gt; listheader:last-of-type:-moz-</span>
<a href="#l64.4"></a><span id="l64.4"> }</span>
<a href="#l64.5"></a><span id="l64.5"> </span>
<a href="#l64.6"></a><span id="l64.6"> /* XXX This style is for bug 740213 and should be removed once that</span>
<a href="#l64.7"></a><span id="l64.7">    bug has a solution. */</span>
<a href="#l64.8"></a><span id="l64.8"> description &gt; html|a {</span>
<a href="#l64.9"></a><span id="l64.9">   cursor: pointer;</span>
<a href="#l64.10"></a><span id="l64.10"> }</span>
<a href="#l64.11"></a><span id="l64.11"> </span>
<a href="#l64.12"></a><span id="l64.12" class="difflineplus">+#provider-listing {</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+  width: 200px;</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineplus">+}</span>
<a href="#l64.15"></a><span id="l64.15" class="difflineplus">+</span>
<a href="#l64.16"></a><span id="l64.16" class="difflineplus">+#addCloudFileAccountButtons button,</span>
<a href="#l64.17"></a><span id="l64.17" class="difflineplus">+#removeCloudFileAccount {</span>
<a href="#l64.18"></a><span id="l64.18" class="difflineplus">+  margin: 4px 0 0;</span>
<a href="#l64.19"></a><span id="l64.19" class="difflineplus">+}</span>
<a href="#l64.20"></a><span id="l64.20" class="difflineplus">+</span>
<a href="#l64.21"></a><span id="l64.21" class="difflineplus">+#addCloudFileAccountButtons button .button-icon {</span>
<a href="#l64.22"></a><span id="l64.22" class="difflineplus">+  width: 16px;</span>
<a href="#l64.23"></a><span id="l64.23" class="difflineplus">+  height: 16px;</span>
<a href="#l64.24"></a><span id="l64.24" class="difflineplus">+  margin-inline-end: 8px;</span>
<a href="#l64.25"></a><span id="l64.25" class="difflineplus">+}</span>
<a href="#l64.26"></a><span id="l64.26" class="difflineplus">+</span>
<a href="#l64.27"></a><span id="l64.27"> #paneChat {</span>
<a href="#l64.28"></a><span id="l64.28">   padding-top: 15px;</span>
<a href="#l64.29"></a><span id="l64.29">   padding-bottom: 15px;</span>
<a href="#l64.30"></a><span id="l64.30"> }</span>
<a href="#l64.31"></a><span id="l64.31"> </span>
<a href="#l64.32"></a><span id="l64.32"> tabs {</span>
<a href="#l64.33"></a><span id="l64.33">   margin-inline-end: 4px; /* add the 4px end-margin of other elements */</span>
<a href="#l64.34"></a><span id="l64.34"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mail/themes/windows/jar.mn</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mail/themes/windows/jar.mn</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -80,18 +80,16 @@ classic.jar:</span>
<a href="#l65.4"></a><span id="l65.4">   skin/classic/messenger/addressbook/icons/addrbook.png       (mail/addrbook/addrbook.png)</span>
<a href="#l65.5"></a><span id="l65.5">   skin/classic/messenger/addressbook/icons/ablist.png         (mail/addrbook/ablist.png)</span>
<a href="#l65.6"></a><span id="l65.6">   skin/classic/messenger/addressbook/icons/contact-generic.png             (mail/addrbook/contact-generic.png)</span>
<a href="#l65.7"></a><span id="l65.7">   skin/classic/messenger/addressbook/icons/contact-generic-tiny.png        (mail/addrbook/contact-generic-tiny.png)</span>
<a href="#l65.8"></a><span id="l65.8">   skin/classic/messenger/addressbook/icons/abcard-large.png                (mail/addrbook/abcard-large.png)</span>
<a href="#l65.9"></a><span id="l65.9">   skin/classic/messenger/addressbook/icons/remote-addrbook.png             (mail/addrbook/remote-addrbook.png)</span>
<a href="#l65.10"></a><span id="l65.10">   skin/classic/messenger/addressbook/icons/remote-addrbook-error.png       (mail/addrbook/remote-addrbook-error.png)</span>
<a href="#l65.11"></a><span id="l65.11">   skin/classic/messenger/addressbook/icons/secure-remote-addrbook.png      (mail/addrbook/secure-remote-addrbook.png)</span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-  skin/classic/messenger/cloudfile/addAccountDialog.css       (mail/cloudfile/addAccountDialog.css)</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineminus">-  skin/classic/messenger/cloudfile/Hightail/settings.css               (mail/cloudfile/Hightail/settings.css)</span>
<a href="#l65.14"></a><span id="l65.14">   skin/classic/messenger/cloudfile/Hightail/fileExceedsLimit.css       (mail/cloudfile/Hightail/fileExceedsLimit.css)</span>
<a href="#l65.15"></a><span id="l65.15">   skin/classic/messenger/cloudfile/Hightail/check.png                  (mail/cloudfile/Hightail/check.png)</span>
<a href="#l65.16"></a><span id="l65.16">   skin/classic/messenger/messengercompose/messengercompose.css (mail/compose/messengercompose.css)</span>
<a href="#l65.17"></a><span id="l65.17">   skin/classic/messenger/messengercompose/noise.png           (mail/compose/noise.png)</span>
<a href="#l65.18"></a><span id="l65.18">   skin/classic/messenger/downloads/aboutDownloads.css         (mail/downloads/aboutDownloads.css)</span>
<a href="#l65.19"></a><span id="l65.19">   skin/classic/messenger/preferences/aboutPreferences.css     (mail/preferences/aboutPreferences.css)</span>
<a href="#l65.20"></a><span id="l65.20">   skin/classic/messenger/preferences/alwaysAsk.png            (mail/preferences/alwaysAsk.png)</span>
<a href="#l65.21"></a><span id="l65.21">   skin/classic/messenger/preferences/application.png          (mail/preferences/application.png)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1">deleted file mode 100644</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineminus">--- a/mail/themes/windows/mail/cloudfile/Hightail/settings.css</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineplus">+++ /dev/null</span>
<a href="#l66.4"></a><span id="l66.4" class="difflineat">@@ -1,9 +0,0 @@</span>
<a href="#l66.5"></a><span id="l66.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l66.6"></a><span id="l66.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l66.7"></a><span id="l66.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l66.8"></a><span id="l66.8" class="difflineminus">-</span>
<a href="#l66.9"></a><span id="l66.9" class="difflineminus">-#username.hint {</span>
<a href="#l66.10"></a><span id="l66.10" class="difflineminus">-  color: gray;</span>
<a href="#l66.11"></a><span id="l66.11" class="difflineminus">-  font-style:italic;</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineminus">-  font-size:95%</span>
<a href="#l66.13"></a><span id="l66.13" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1">deleted file mode 100644</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineminus">--- a/mail/themes/windows/mail/cloudfile/addAccountDialog.css</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineplus">+++ /dev/null</span>
<a href="#l67.4"></a><span id="l67.4" class="difflineat">@@ -1,119 +0,0 @@</span>
<a href="#l67.5"></a><span id="l67.5" class="difflineminus">-/* This Source Code Form is subject to the terms of the Mozilla Public</span>
<a href="#l67.6"></a><span id="l67.6" class="difflineminus">- * License, v. 2.0. If a copy of the MPL was not distributed with this file,</span>
<a href="#l67.7"></a><span id="l67.7" class="difflineminus">- * You can obtain one at http://mozilla.org/MPL/2.0/. */</span>
<a href="#l67.8"></a><span id="l67.8" class="difflineminus">-</span>
<a href="#l67.9"></a><span id="l67.9" class="difflineminus">-html, body {</span>
<a href="#l67.10"></a><span id="l67.10" class="difflineminus">-  font: message-box;</span>
<a href="#l67.11"></a><span id="l67.11" class="difflineminus">-  margin: 0;</span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-}</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineminus">-</span>
<a href="#l67.14"></a><span id="l67.14" class="difflineminus">-a {</span>
<a href="#l67.15"></a><span id="l67.15" class="difflineminus">-  color: -moz-nativehyperlinktext;</span>
<a href="#l67.16"></a><span id="l67.16" class="difflineminus">-  text-decoration: underline;</span>
<a href="#l67.17"></a><span id="l67.17" class="difflineminus">-}</span>
<a href="#l67.18"></a><span id="l67.18" class="difflineminus">-</span>
<a href="#l67.19"></a><span id="l67.19" class="difflineminus">-#addCloudFileAccount {</span>
<a href="#l67.20"></a><span id="l67.20" class="difflineminus">-  padding: 15px;</span>
<a href="#l67.21"></a><span id="l67.21" class="difflineminus">-}</span>
<a href="#l67.22"></a><span id="l67.22" class="difflineminus">-</span>
<a href="#l67.23"></a><span id="l67.23" class="difflineminus">-#createAccountText {</span>
<a href="#l67.24"></a><span id="l67.24" class="difflineminus">-  margin-bottom: 20px;</span>
<a href="#l67.25"></a><span id="l67.25" class="difflineminus">-}</span>
<a href="#l67.26"></a><span id="l67.26" class="difflineminus">-</span>
<a href="#l67.27"></a><span id="l67.27" class="difflineminus">-.indent {</span>
<a href="#l67.28"></a><span id="l67.28" class="difflineminus">-  margin-bottom: 15px;</span>
<a href="#l67.29"></a><span id="l67.29" class="difflineminus">-  margin-inline-start: 50px;</span>
<a href="#l67.30"></a><span id="l67.30" class="difflineminus">-  margin-inline-end: 50px;</span>
<a href="#l67.31"></a><span id="l67.31" class="difflineminus">-}</span>
<a href="#l67.32"></a><span id="l67.32" class="difflineminus">-</span>
<a href="#l67.33"></a><span id="l67.33" class="difflineminus">-.small-indent {</span>
<a href="#l67.34"></a><span id="l67.34" class="difflineminus">-  margin-bottom: 15px;</span>
<a href="#l67.35"></a><span id="l67.35" class="difflineminus">-  margin-inline-start: 6px;</span>
<a href="#l67.36"></a><span id="l67.36" class="difflineminus">-  margin-inline-end: 6px;</span>
<a href="#l67.37"></a><span id="l67.37" class="difflineminus">-}</span>
<a href="#l67.38"></a><span id="l67.38" class="difflineminus">-</span>
<a href="#l67.39"></a><span id="l67.39" class="difflineminus">-#accountType {</span>
<a href="#l67.40"></a><span id="l67.40" class="difflineminus">-  height: 26px;</span>
<a href="#l67.41"></a><span id="l67.41" class="difflineminus">-  /* We have to be a stickler about the width here, or else we get</span>
<a href="#l67.42"></a><span id="l67.42" class="difflineminus">-     weird issues where the menu will resize itself by a single pixel</span>
<a href="#l67.43"></a><span id="l67.43" class="difflineminus">-     when switching selections, which is distracting. */</span>
<a href="#l67.44"></a><span id="l67.44" class="difflineminus">-  min-width: 310px;</span>
<a href="#l67.45"></a><span id="l67.45" class="difflineminus">-  max-width: 310px;</span>
<a href="#l67.46"></a><span id="l67.46" class="difflineminus">-}</span>
<a href="#l67.47"></a><span id="l67.47" class="difflineminus">-</span>
<a href="#l67.48"></a><span id="l67.48" class="difflineminus">-#messages {</span>
<a href="#l67.49"></a><span id="l67.49" class="difflineminus">-  margin-top: 5px;</span>
<a href="#l67.50"></a><span id="l67.50" class="difflineminus">-}</span>
<a href="#l67.51"></a><span id="l67.51" class="difflineminus">-</span>
<a href="#l67.52"></a><span id="l67.52" class="difflineminus">-#messages #authorizing,</span>
<a href="#l67.53"></a><span id="l67.53" class="difflineminus">-#messages #error {</span>
<a href="#l67.54"></a><span id="l67.54" class="difflineminus">-  -moz-box-align: center;</span>
<a href="#l67.55"></a><span id="l67.55" class="difflineminus">-}</span>
<a href="#l67.56"></a><span id="l67.56" class="difflineminus">-</span>
<a href="#l67.57"></a><span id="l67.57" class="difflineminus">-#messages #authorizing image,</span>
<a href="#l67.58"></a><span id="l67.58" class="difflineminus">-#messages #error image {</span>
<a href="#l67.59"></a><span id="l67.59" class="difflineminus">-  max-width: 16px;</span>
<a href="#l67.60"></a><span id="l67.60" class="difflineminus">-  max-height: 16px;</span>
<a href="#l67.61"></a><span id="l67.61" class="difflineminus">-  vertical-align: middle;</span>
<a href="#l67.62"></a><span id="l67.62" class="difflineminus">-}</span>
<a href="#l67.63"></a><span id="l67.63" class="difflineminus">-</span>
<a href="#l67.64"></a><span id="l67.64" class="difflineminus">-#accountSettings {</span>
<a href="#l67.65"></a><span id="l67.65" class="difflineminus">-  overflow-x: hidden;</span>
<a href="#l67.66"></a><span id="l67.66" class="difflineminus">-  overflow-y: hidden;</span>
<a href="#l67.67"></a><span id="l67.67" class="difflineminus">-}</span>
<a href="#l67.68"></a><span id="l67.68" class="difflineminus">-</span>
<a href="#l67.69"></a><span id="l67.69" class="difflineminus">-#accountSettings body {</span>
<a href="#l67.70"></a><span id="l67.70" class="difflineminus">-  margin: 0;</span>
<a href="#l67.71"></a><span id="l67.71" class="difflineminus">-  padding: 0;</span>
<a href="#l67.72"></a><span id="l67.72" class="difflineminus">-}</span>
<a href="#l67.73"></a><span id="l67.73" class="difflineminus">-</span>
<a href="#l67.74"></a><span id="l67.74" class="difflineminus">-#provider-settings {</span>
<a href="#l67.75"></a><span id="l67.75" class="difflineminus">-  min-height: 80px;</span>
<a href="#l67.76"></a><span id="l67.76" class="difflineminus">-}</span>
<a href="#l67.77"></a><span id="l67.77" class="difflineminus">-</span>
<a href="#l67.78"></a><span id="l67.78" class="difflineminus">-#provider-form label, #provider-form input {</span>
<a href="#l67.79"></a><span id="l67.79" class="difflineminus">-  display: block;</span>
<a href="#l67.80"></a><span id="l67.80" class="difflineminus">-  margin-bottom: 5px;</span>
<a href="#l67.81"></a><span id="l67.81" class="difflineminus">-}</span>
<a href="#l67.82"></a><span id="l67.82" class="difflineminus">-</span>
<a href="#l67.83"></a><span id="l67.83" class="difflineminus">-#provider-form label {</span>
<a href="#l67.84"></a><span id="l67.84" class="difflineminus">-  margin-left: 1px;</span>
<a href="#l67.85"></a><span id="l67.85" class="difflineminus">-}</span>
<a href="#l67.86"></a><span id="l67.86" class="difflineminus">-</span>
<a href="#l67.87"></a><span id="l67.87" class="difflineminus">-#provider-form input {</span>
<a href="#l67.88"></a><span id="l67.88" class="difflineminus">-  box-sizing: border-box;</span>
<a href="#l67.89"></a><span id="l67.89" class="difflineminus">-  width: 100%;</span>
<a href="#l67.90"></a><span id="l67.90" class="difflineminus">-}</span>
<a href="#l67.91"></a><span id="l67.91" class="difflineminus">-</span>
<a href="#l67.92"></a><span id="l67.92" class="difflineminus">-#accountType &gt; menupopup &gt; menuitem &gt; .menu-iconic-left {</span>
<a href="#l67.93"></a><span id="l67.93" class="difflineminus">-  display: -moz-box;</span>
<a href="#l67.94"></a><span id="l67.94" class="difflineminus">-  min-width: 16px;</span>
<a href="#l67.95"></a><span id="l67.95" class="difflineminus">-  padding-inline-end: 2px;</span>
<a href="#l67.96"></a><span id="l67.96" class="difflineminus">-}</span>
<a href="#l67.97"></a><span id="l67.97" class="difflineminus">-</span>
<a href="#l67.98"></a><span id="l67.98" class="difflineminus">-.menulist-icon {</span>
<a href="#l67.99"></a><span id="l67.99" class="difflineminus">-  width: 16px;</span>
<a href="#l67.100"></a><span id="l67.100" class="difflineminus">-}</span>
<a href="#l67.101"></a><span id="l67.101" class="difflineminus">-</span>
<a href="#l67.102"></a><span id="l67.102" class="difflineminus">-#learn-more {</span>
<a href="#l67.103"></a><span id="l67.103" class="difflineminus">-  text-align: right;</span>
<a href="#l67.104"></a><span id="l67.104" class="difflineminus">-}</span>
<a href="#l67.105"></a><span id="l67.105" class="difflineminus">-</span>
<a href="#l67.106"></a><span id="l67.106" class="difflineminus">-.float-right {</span>
<a href="#l67.107"></a><span id="l67.107" class="difflineminus">-  float: right;</span>
<a href="#l67.108"></a><span id="l67.108" class="difflineminus">-}</span>
<a href="#l67.109"></a><span id="l67.109" class="difflineminus">-</span>
<a href="#l67.110"></a><span id="l67.110" class="difflineminus">-@media (-moz-windows-default-theme) {</span>
<a href="#l67.111"></a><span id="l67.111" class="difflineminus">-  #accountType {</span>
<a href="#l67.112"></a><span id="l67.112" class="difflineminus">-    height: 26px;</span>
<a href="#l67.113"></a><span id="l67.113" class="difflineminus">-    /* We have to be a stickler about the width here, or else we get</span>
<a href="#l67.114"></a><span id="l67.114" class="difflineminus">-       weird issues where the menu will resize itself by a single pixel</span>
<a href="#l67.115"></a><span id="l67.115" class="difflineminus">-       when switching selections, which is distracting. */</span>
<a href="#l67.116"></a><span id="l67.116" class="difflineminus">-    min-width: 350px;</span>
<a href="#l67.117"></a><span id="l67.117" class="difflineminus">-    max-width: 350px;</span>
<a href="#l67.118"></a><span id="l67.118" class="difflineminus">-  }</span>
<a href="#l67.119"></a><span id="l67.119" class="difflineminus">-</span>
<a href="#l67.120"></a><span id="l67.120" class="difflineminus">-  #provider-form label {</span>
<a href="#l67.121"></a><span id="l67.121" class="difflineminus">-    margin-left: 0;</span>
<a href="#l67.122"></a><span id="l67.122" class="difflineminus">-  }</span>
<a href="#l67.123"></a><span id="l67.123" class="difflineminus">-}</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/4b0de666d1a4">4b0de666d1a4</a> at 2020-07-30T19:32:33Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

