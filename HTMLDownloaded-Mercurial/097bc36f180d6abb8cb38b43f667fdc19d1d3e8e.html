<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-US" lang="en-US">
<head>
<link rel="icon" href="/static/35f393d6769a/hgicon.png" type="image/png" />
<meta name="robots" content="index, nofollow"/>
<link rel="stylesheet" href="/static/35f393d6769a/style-gitweb.css" type="text/css" />

<style type="text/css">
div.feed {
  float: right;
}
a img {
  border-width: 0px;
}
div.log_link {
  width: 80px;
  background-color: white;
}

div.log_body {
  padding-left: 96px;
}
</style>
<script type="text/javascript" src="/static/35f393d6769a/mercurial.js"></script>

<meta property="og:image" content="/static/35f393d6769a/moz-logo-bw-rgb.svg"/>
<meta property="og:type" content="website"/>

<title>comm-central: changeset 9055:097bc36f180d6abb8cb38b43f667fdc19d1d3e8e</title>
<link rel="alternate" type="application/atom+xml"
   href="/comm-central/atom-log" title="Atom feed for comm-central"/>
<link rel="alternate" type="application/rss+xml"
   href="/comm-central/rss-log" title="RSS feed for comm-central"/>

<meta property="og:title" content="comm-central @ 097bc36f180d6abb8cb38b43f667fdc19d1d3e8e" />
<meta property="og:url" content="/comm-central/rev/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e" />
<meta property="og:description" content="fix bug 402392, add support for pluggable stores, r=standard8, sr=neil" />

</head>
<body>

<div class="page_header">
<div class="logo">
    <a href="https://developer.mozilla.org/en/docs/Mercurial">
        <img src="/static/35f393d6769a/moz-logo-bw-rgb.svg" alt="mercurial" />
    </a>
</div>
<a href="/">Mercurial</a> &gt; <a href="/comm-central">comm-central</a>  / changeset / 097bc36f180d6abb8cb38b43f667fdc19d1d3e8e 
</div>

<div class="page_nav">
<div>
<a href="/comm-central/summary">summary</a> |
<a href="/comm-central/shortlog/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e">shortlog</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e">changelog</a> |
<a href="/comm-central/pushloghtml">pushlog</a> |
<a href="/comm-central/graph/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e">graph</a> |
<a href="/comm-central/tags">tags</a> |
<a href="/comm-central/bookmarks">bookmarks</a> |
<a href="/comm-central/branches">branches</a> |
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e">files</a> |
changeset |
<a href="/comm-central/raw-rev/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e">raw</a>  | <a href="/comm-central/archive/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e.zip">zip</a>  |
<a href="/comm-central/help">help</a>
</div>

<div class="search">
<form id="searchform" action="/comm-central/log">

<input name="rev" type="text" value="" size="40" />
<div id="hint">Find changesets by keywords (author, files, the commit message), revision
number or hash, or <a href="/comm-central/help/revsets">revset expression</a>.</div>
</form>
</div>
</div>

<div class="title">
fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=402392">bug 402392</a>, add support for pluggable stores, r=standard8, sr=neil
<span class="logtags"></span>
</div>
<div class="title_text">
<table cellspacing="0">

<tr><td>author</td><td>&#68;&#97;&#118;&#105;&#100;&#32;&#66;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#32;&#60;&#98;&#105;&#101;&#110;&#118;&#101;&#110;&#117;&#64;&#110;&#118;&#101;&#110;&#116;&#117;&#114;&#101;&#46;&#99;&#111;&#109;&#62;</td></tr>
<tr><td></td><td class="date age">Sat, 24 Dec 2011 16:17:33 -0800</td></tr>

<tr>
 <td>changeset 9055</td>
 <td style="font-family:monospace"><a class="list" href="/comm-central/rev/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e">097bc36f180d6abb8cb38b43f667fdc19d1d3e8e</a></td>
</tr>



<tr>
<td>parent 9054</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/65b901f262c02a3d50abba329f07a0746aa68f69">65b901f262c02a3d50abba329f07a0746aa68f69</a>
</td>
</tr>

<tr>
<td>child 9056</td>
<td style="font-family:monospace">
<a class="list" href="/comm-central/rev/308ce8610f4ae102969ef2830ac6e7578f302652">308ce8610f4ae102969ef2830ac6e7578f302652</a>
</td>
</tr>
<tr><td>push id</td><td><a href="/comm-central/pushloghtml?changeset=097bc36f180d6abb8cb38b43f667fdc19d1d3e8e">6936</a></td></tr>
<tr><td>push user</td><td>bienvenu@nventure.com</td></tr>
<tr><td>push date</td><td class="date age">Sun, 25 Dec 2011 00:17:26 +0000</td></tr>

<tr><td>treeherder</td><td>comm-central@097bc36f180d [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=097bc36f180d6abb8cb38b43f667fdc19d1d3e8e">default view</a>] [<a href="https://treeherder.mozilla.org/#/jobs?repo=comm-central&revision=097bc36f180d6abb8cb38b43f667fdc19d1d3e8e&filter-resultStatus=testfailed&filter-resultStatus=busted&filter-resultStatus=exception">failures only]</td></tr>
<tr><td>perfherder</td><td>[<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=097bc36f180d6abb8cb38b43f667fdc19d1d3e8e&newProject=comm-central&newRevision=097bc36f180d6abb8cb38b43f667fdc19d1d3e8e&framework=1" target="_blank">talos</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=097bc36f180d6abb8cb38b43f667fdc19d1d3e8e&newProject=comm-central&newRevision=097bc36f180d6abb8cb38b43f667fdc19d1d3e8e&framework=2" target="_blank">build metrics</a>] [<a href="https://treeherder.mozilla.org/perf.html#/compare?originalProject=comm-central&originalRevision=097bc36f180d6abb8cb38b43f667fdc19d1d3e8e&newProject=comm-central&newRevision=097bc36f180d6abb8cb38b43f667fdc19d1d3e8e&framework=6" target="_blank">platform microbench</a>] (compared to previous push)</td></tr>
<tr><td>reviewers</td><td><a href="/comm-central/log?rev=reviewer%28standard8%29&revcount=50">standard8</a>, <a href="/comm-central/log?rev=reviewer%28neil%29&revcount=50">neil</a></td></tr>
<tr><td>bugs</td><td><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=402392">402392</a></td></tr>




</table></div>

<div class="page_body description">fix <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=402392">bug 402392</a>, add support for pluggable stores, r=standard8, sr=neil</div>
<div class="list_head"></div>
<div class="title_text">
<table cellspacing="0">

<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/base/content/folderPane.js">mail/base/content/folderPane.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/base/content/folderPane.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/base/content/folderPane.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/base/content/folderPane.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/base/content/folderPane.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/base/content/folderPane.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js">mail/test/mozmill/folder-display/test-invalid-db-folder-load.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/notification/test-notification.js">mail/test/mozmill/notification/test-notification.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/notification/test-notification.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/notification/test-notification.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/notification/test-notification.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/notification/test-notification.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mail/test/mozmill/notification/test-notification.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/prefs/content/accountcreation/readFromXML.js">mailnews/base/prefs/content/accountcreation/readFromXML.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/prefs/content/accountcreation/readFromXML.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/prefs/content/accountcreation/readFromXML.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/prefs/content/accountcreation/readFromXML.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/prefs/content/accountcreation/readFromXML.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/prefs/content/accountcreation/readFromXML.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/Makefile.in">mailnews/base/public/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/Makefile.in">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/Makefile.in">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/Makefile.in">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/Makefile.in">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/msgCore.h">mailnews/base/public/msgCore.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/msgCore.h">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/msgCore.h">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/msgCore.h">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/msgCore.h">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/msgCore.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgFolder.idl">mailnews/base/public/nsIMsgFolder.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgFolder.idl">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgFolder.idl">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgFolder.idl">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgFolder.idl">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgFolder.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgHdr.idl">mailnews/base/public/nsIMsgHdr.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgHdr.idl">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgHdr.idl">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgHdr.idl">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgHdr.idl">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgHdr.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgIncomingServer.idl">mailnews/base/public/nsIMsgIncomingServer.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgIncomingServer.idl">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgIncomingServer.idl">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgIncomingServer.idl">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgIncomingServer.idl">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgIncomingServer.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgPluggableStore.idl">mailnews/base/public/nsIMsgPluggableStore.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgPluggableStore.idl">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgPluggableStore.idl">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgPluggableStore.idl">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgPluggableStore.idl">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/public/nsIMsgPluggableStore.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/search/src/nsMsgSearchTerm.cpp">mailnews/base/search/src/nsMsgSearchTerm.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/search/src/nsMsgSearchTerm.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/search/src/nsMsgSearchTerm.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/search/src/nsMsgSearchTerm.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/search/src/nsMsgSearchTerm.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/search/src/nsMsgSearchTerm.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsCopyMessageStreamListener.cpp">mailnews/base/src/nsCopyMessageStreamListener.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsCopyMessageStreamListener.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsCopyMessageStreamListener.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsCopyMessageStreamListener.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsCopyMessageStreamListener.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsCopyMessageStreamListener.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgAccountManager.cpp">mailnews/base/src/nsMsgAccountManager.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgAccountManager.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgAccountManager.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgAccountManager.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgAccountManager.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgAccountManager.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgDBView.cpp">mailnews/base/src/nsMsgDBView.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgDBView.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgDBView.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgDBView.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgDBView.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgDBView.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgFolderCompactor.cpp">mailnews/base/src/nsMsgFolderCompactor.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgFolderCompactor.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgFolderCompactor.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgFolderCompactor.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgFolderCompactor.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/nsMsgFolderCompactor.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/virtualFolderWrapper.js">mailnews/base/src/virtualFolderWrapper.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/virtualFolderWrapper.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/virtualFolderWrapper.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/virtualFolderWrapper.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/virtualFolderWrapper.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/src/virtualFolderWrapper.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_bug428427.js">mailnews/base/test/unit/test_bug428427.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_bug428427.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_bug428427.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_bug428427.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_bug428427.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_bug428427.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_bug471682.js">mailnews/base/test/unit/test_bug471682.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_bug471682.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_bug471682.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_bug471682.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_bug471682.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_bug471682.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_detachToFile.js">mailnews/base/test/unit/test_detachToFile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_detachToFile.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_detachToFile.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_detachToFile.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_detachToFile.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_detachToFile.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_folderCompact.js">mailnews/base/test/unit/test_folderCompact.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_folderCompact.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_folderCompact.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_folderCompact.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_folderCompact.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_folderCompact.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_imapPump.js">mailnews/base/test/unit/test_imapPump.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_imapPump.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_imapPump.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_imapPump.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_imapPump.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_imapPump.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_loadVirtualFolders.js">mailnews/base/test/unit/test_loadVirtualFolders.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_loadVirtualFolders.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_loadVirtualFolders.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_loadVirtualFolders.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_loadVirtualFolders.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_loadVirtualFolders.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_quarantineFilterMove.js">mailnews/base/test/unit/test_quarantineFilterMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_quarantineFilterMove.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_quarantineFilterMove.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_quarantineFilterMove.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_quarantineFilterMove.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/test/unit/test_quarantineFilterMove.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgDBFolder.cpp">mailnews/base/util/nsMsgDBFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgDBFolder.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgDBFolder.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgDBFolder.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgDBFolder.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgDBFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgDBFolder.h">mailnews/base/util/nsMsgDBFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgDBFolder.h">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgDBFolder.h">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgDBFolder.h">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgDBFolder.h">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgDBFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgIncomingServer.cpp">mailnews/base/util/nsMsgIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgIncomingServer.h">mailnews/base/util/nsMsgIncomingServer.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgIncomingServer.h">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgIncomingServer.h">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgIncomingServer.h">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgIncomingServer.h">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/base/util/nsMsgIncomingServer.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/build/nsMailModule.cpp">mailnews/build/nsMailModule.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/build/nsMailModule.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/build/nsMailModule.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/build/nsMailModule.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/build/nsMailModule.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/build/nsMailModule.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_attachment.js">mailnews/compose/test/unit/test_attachment.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_attachment.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_attachment.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_attachment.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_attachment.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_attachment.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_bug474774.js">mailnews/compose/test/unit/test_bug474774.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_bug474774.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_bug474774.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_bug474774.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_bug474774.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_bug474774.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_detectAttachmentCharset.js">mailnews/compose/test/unit/test_detectAttachmentCharset.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_detectAttachmentCharset.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_detectAttachmentCharset.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_detectAttachmentCharset.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_detectAttachmentCharset.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_detectAttachmentCharset.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageFile.js">mailnews/compose/test/unit/test_sendMessageFile.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageFile.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageFile.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageFile.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageFile.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageFile.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageLater.js">mailnews/compose/test/unit/test_sendMessageLater.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageLater.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageLater.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageLater.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageLater.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageLater.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageLater3.js">mailnews/compose/test/unit/test_sendMessageLater3.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageLater3.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageLater3.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageLater3.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageLater3.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/compose/test/unit/test_sendMessageLater3.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/head_gloda.js">mailnews/db/gloda/test/unit/head_gloda.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/head_gloda.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/head_gloda.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/head_gloda.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/head_gloda.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/head_gloda.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/test_index_compaction.js">mailnews/db/gloda/test/unit/test_index_compaction.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/test_index_compaction.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/test_index_compaction.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/test_index_compaction.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/test_index_compaction.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/test_index_compaction.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/test_index_messages_local.js">mailnews/db/gloda/test/unit/test_index_messages_local.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/test_index_messages_local.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/test_index_messages_local.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/test_index_messages_local.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/test_index_messages_local.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/gloda/test/unit/test_index_messages_local.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsIMsgDatabase.idl">mailnews/db/msgdb/public/nsIMsgDatabase.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsIMsgDatabase.idl">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsIMsgDatabase.idl">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsIMsgDatabase.idl">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsIMsgDatabase.idl">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsIMsgDatabase.idl">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsImapMailDatabase.h">mailnews/db/msgdb/public/nsImapMailDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsImapMailDatabase.h">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsImapMailDatabase.h">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsImapMailDatabase.h">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsImapMailDatabase.h">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsImapMailDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsMailDatabase.h">mailnews/db/msgdb/public/nsMailDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsMailDatabase.h">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsMailDatabase.h">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsMailDatabase.h">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsMailDatabase.h">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsMailDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsMsgDatabase.h">mailnews/db/msgdb/public/nsMsgDatabase.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsMsgDatabase.h">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsMsgDatabase.h">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsMsgDatabase.h">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsMsgDatabase.h">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/public/nsMsgDatabase.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">mailnews/db/msgdb/src/nsDBFolderInfo.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsDBFolderInfo.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">mailnews/db/msgdb/src/nsImapMailDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsImapMailDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMailDatabase.cpp">mailnews/db/msgdb/src/nsMailDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMailDatabase.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMailDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMailDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMailDatabase.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMailDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMsgDatabase.cpp">mailnews/db/msgdb/src/nsMsgDatabase.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMsgDatabase.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMsgDatabase.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMsgDatabase.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMsgDatabase.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMsgDatabase.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMsgHdr.cpp">mailnews/db/msgdb/src/nsMsgHdr.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMsgHdr.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMsgHdr.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMsgHdr.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMsgHdr.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/db/msgdb/src/nsMsgHdr.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/extensions/mdn/test/unit/test_askuser.js">mailnews/extensions/mdn/test/unit/test_askuser.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/extensions/mdn/test/unit/test_askuser.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/extensions/mdn/test/unit/test_askuser.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/extensions/mdn/test/unit/test_askuser.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/extensions/mdn/test/unit/test_askuser.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/extensions/mdn/test/unit/test_askuser.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/extensions/mdn/test/unit/test_mdnFlags.js">mailnews/extensions/mdn/test/unit/test_mdnFlags.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/extensions/mdn/test/unit/test_mdnFlags.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/extensions/mdn/test/unit/test_mdnFlags.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/extensions/mdn/test/unit/test_mdnFlags.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/extensions/mdn/test/unit/test_mdnFlags.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/extensions/mdn/test/unit/test_mdnFlags.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapMailFolder.cpp">mailnews/imap/src/nsImapMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapProtocol.cpp">mailnews/imap/src/nsImapProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapProtocol.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapProtocol.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapService.cpp">mailnews/imap/src/nsImapService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapService.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapService.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapService.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapService.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/src/nsImapService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_bccProperty.js">mailnews/imap/test/unit/test_bccProperty.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_bccProperty.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_bccProperty.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_bccProperty.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_bccProperty.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_bccProperty.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_compactOfflineStore.js">mailnews/imap/test/unit/test_compactOfflineStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_compactOfflineStore.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_compactOfflineStore.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_compactOfflineStore.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_compactOfflineStore.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_compactOfflineStore.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_imapAttachmentSaves.js">mailnews/imap/test/unit/test_imapAttachmentSaves.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_imapAttachmentSaves.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_imapAttachmentSaves.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_imapAttachmentSaves.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_imapAttachmentSaves.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_imapAttachmentSaves.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_imapCopyTimeout.js">mailnews/imap/test/unit/test_imapCopyTimeout.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_imapCopyTimeout.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_imapCopyTimeout.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_imapCopyTimeout.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_imapCopyTimeout.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_imapCopyTimeout.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_largeOfflineStore.js">mailnews/imap/test/unit/test_largeOfflineStore.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_largeOfflineStore.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_largeOfflineStore.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_largeOfflineStore.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_largeOfflineStore.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_largeOfflineStore.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">mailnews/imap/test/unit/test_localToImapFilterQuarantine.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_preserveDataOnMove.js">mailnews/imap/test/unit/test_preserveDataOnMove.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_preserveDataOnMove.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_preserveDataOnMove.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_preserveDataOnMove.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_preserveDataOnMove.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/imap/test/unit/test_preserveDataOnMove.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/public/nsIMsgParseMailMsgState.idl">mailnews/local/public/nsIMsgParseMailMsgState.idl</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/public/nsIMsgParseMailMsgState.idl">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/public/nsIMsgParseMailMsgState.idl">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/public/nsIMsgParseMailMsgState.idl">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/public/nsIMsgParseMailMsgState.idl">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/public/nsIMsgParseMailMsgState.idl">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/public/nsMsgLocalCID.h">mailnews/local/public/nsMsgLocalCID.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/public/nsMsgLocalCID.h">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/public/nsMsgLocalCID.h">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/public/nsMsgLocalCID.h">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/public/nsMsgLocalCID.h">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/public/nsMsgLocalCID.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/Makefile.in">mailnews/local/src/Makefile.in</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/Makefile.in">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/Makefile.in">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/Makefile.in">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/Makefile.in">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/Makefile.in">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalMailFolder.cpp">mailnews/local/src/nsLocalMailFolder.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalMailFolder.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalMailFolder.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalMailFolder.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalMailFolder.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalMailFolder.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalMailFolder.h">mailnews/local/src/nsLocalMailFolder.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalMailFolder.h">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalMailFolder.h">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalMailFolder.h">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalMailFolder.h">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalMailFolder.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalUndoTxn.cpp">mailnews/local/src/nsLocalUndoTxn.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalUndoTxn.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalUndoTxn.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalUndoTxn.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalUndoTxn.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalUndoTxn.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalUndoTxn.h">mailnews/local/src/nsLocalUndoTxn.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalUndoTxn.h">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalUndoTxn.h">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalUndoTxn.h">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalUndoTxn.h">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsLocalUndoTxn.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxProtocol.cpp">mailnews/local/src/nsMailboxProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxProtocol.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxProtocol.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxService.cpp">mailnews/local/src/nsMailboxService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxService.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxService.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxService.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxService.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxUrl.cpp">mailnews/local/src/nsMailboxUrl.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxUrl.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxUrl.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxUrl.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxUrl.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMailboxUrl.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMovemailService.cpp">mailnews/local/src/nsMovemailService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMovemailService.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMovemailService.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMovemailService.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMovemailService.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMovemailService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgBrkMBoxStore.cpp">mailnews/local/src/nsMsgBrkMBoxStore.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgBrkMBoxStore.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgBrkMBoxStore.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgBrkMBoxStore.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgBrkMBoxStore.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgBrkMBoxStore.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgBrkMBoxStore.h">mailnews/local/src/nsMsgBrkMBoxStore.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgBrkMBoxStore.h">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgBrkMBoxStore.h">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgBrkMBoxStore.h">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgBrkMBoxStore.h">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgBrkMBoxStore.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgLocalStoreUtils.cpp">mailnews/local/src/nsMsgLocalStoreUtils.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgLocalStoreUtils.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgLocalStoreUtils.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgLocalStoreUtils.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgLocalStoreUtils.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgLocalStoreUtils.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgLocalStoreUtils.h">mailnews/local/src/nsMsgLocalStoreUtils.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgLocalStoreUtils.h">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgLocalStoreUtils.h">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgLocalStoreUtils.h">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgLocalStoreUtils.h">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgLocalStoreUtils.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgMaildirStore.cpp">mailnews/local/src/nsMsgMaildirStore.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgMaildirStore.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgMaildirStore.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgMaildirStore.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgMaildirStore.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgMaildirStore.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgMaildirStore.h">mailnews/local/src/nsMsgMaildirStore.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgMaildirStore.h">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgMaildirStore.h">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgMaildirStore.h">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgMaildirStore.h">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsMsgMaildirStore.h">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsNoIncomingServer.cpp">mailnews/local/src/nsNoIncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsNoIncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsNoIncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsNoIncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsNoIncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsNoIncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsParseMailbox.cpp">mailnews/local/src/nsParseMailbox.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsParseMailbox.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsParseMailbox.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsParseMailbox.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsParseMailbox.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsParseMailbox.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsParseMailbox.h">mailnews/local/src/nsParseMailbox.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsParseMailbox.h">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsParseMailbox.h">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsParseMailbox.h">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsParseMailbox.h">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsParseMailbox.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3IncomingServer.cpp">mailnews/local/src/nsPop3IncomingServer.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3IncomingServer.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3IncomingServer.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3IncomingServer.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3IncomingServer.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3IncomingServer.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Service.cpp">mailnews/local/src/nsPop3Service.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Service.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Service.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Service.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Service.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Service.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Sink.cpp">mailnews/local/src/nsPop3Sink.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Sink.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Sink.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Sink.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Sink.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Sink.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Sink.h">mailnews/local/src/nsPop3Sink.h</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Sink.h">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Sink.h">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Sink.h">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Sink.h">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/src/nsPop3Sink.h">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_msgCopy.js">mailnews/local/test/unit/test_msgCopy.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_msgCopy.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_msgCopy.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_msgCopy.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_msgCopy.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_msgCopy.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_over2GBMailboxes.js">mailnews/local/test/unit/test_over2GBMailboxes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_over2GBMailboxes.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_over2GBMailboxes.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_over2GBMailboxes.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_over2GBMailboxes.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_over2GBMailboxes.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_over4GBMailboxes.js">mailnews/local/test/unit/test_over4GBMailboxes.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_over4GBMailboxes.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_over4GBMailboxes.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_over4GBMailboxes.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_over4GBMailboxes.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_over4GBMailboxes.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_preview.js">mailnews/local/test/unit/test_preview.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_preview.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_preview.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_preview.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_preview.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/local/test/unit/test_preview.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/mailnews.js">mailnews/mailnews.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/mailnews.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/mailnews.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/mailnews.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/mailnews.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/mailnews.js">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/news/src/nsNNTPProtocol.cpp">mailnews/news/src/nsNNTPProtocol.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/news/src/nsNNTPProtocol.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/news/src/nsNNTPProtocol.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/news/src/nsNNTPProtocol.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/news/src/nsNNTPProtocol.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/news/src/nsNNTPProtocol.cpp">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/news/src/nsNntpService.cpp">mailnews/news/src/nsNntpService.cpp</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/news/src/nsNntpService.cpp">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/news/src/nsNntpService.cpp">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/news/src/nsNntpService.cpp">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/news/src/nsNntpService.cpp">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/news/src/nsNntpService.cpp">revisions</a>
</td>
</tr>
<tr class="parity0">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/test/fakeserver/imapd.js">mailnews/test/fakeserver/imapd.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/test/fakeserver/imapd.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/test/fakeserver/imapd.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/test/fakeserver/imapd.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/test/fakeserver/imapd.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/test/fakeserver/imapd.js">revisions</a>
</td>
</tr>
<tr class="parity1">
<td><a class="list" href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/test/resources/mailTestUtils.js">mailnews/test/resources/mailTestUtils.js</a></td>
<td></td>
<td class="link">
<a href="/comm-central/file/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/test/resources/mailTestUtils.js">file</a> |
<a href="/comm-central/annotate/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/test/resources/mailTestUtils.js">annotate</a> |
<a href="/comm-central/diff/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/test/resources/mailTestUtils.js">diff</a> |
<a href="/comm-central/comparison/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/test/resources/mailTestUtils.js">comparison</a> |
<a href="/comm-central/log/097bc36f180d6abb8cb38b43f667fdc19d1d3e8e/mailnews/test/resources/mailTestUtils.js">revisions</a>
</td>
</tr>
</table></div>

<div class="page_body diffblocks"><div class="diffblock"><pre class="sourcelines">
<a href="#l1.1"></a><span id="l1.1" class="difflineminus">--- a/mail/base/content/folderPane.js</span>
<a href="#l1.2"></a><span id="l1.2" class="difflineplus">+++ b/mail/base/content/folderPane.js</span>
<a href="#l1.3"></a><span id="l1.3" class="difflineat">@@ -1062,17 +1062,20 @@ let gFolderTreeView = {</span>
<a href="#l1.4"></a><span id="l1.4">       sortFolderItems(smartFolderItem._children);</span>
<a href="#l1.5"></a><span id="l1.5">     return smartFolderItem;</span>
<a href="#l1.6"></a><span id="l1.6">   },</span>
<a href="#l1.7"></a><span id="l1.7">   _createVFFolder: function ftv_createVFFolder(newName, parentFolder,</span>
<a href="#l1.8"></a><span id="l1.8">                                                searchFolderURIs, folderFlag)</span>
<a href="#l1.9"></a><span id="l1.9">   {</span>
<a href="#l1.10"></a><span id="l1.10">     let newFolder;</span>
<a href="#l1.11"></a><span id="l1.11">     try {</span>
<a href="#l1.12"></a><span id="l1.12" class="difflineminus">-      newFolder = parentFolder.addSubfolder(newName);</span>
<a href="#l1.13"></a><span id="l1.13" class="difflineplus">+      if (parentFolder instanceof(Components.interfaces.nsIMsgLocalMailFolder))</span>
<a href="#l1.14"></a><span id="l1.14" class="difflineplus">+        newFolder = parentFolder.createLocalSubfolder(newName);</span>
<a href="#l1.15"></a><span id="l1.15" class="difflineplus">+      else</span>
<a href="#l1.16"></a><span id="l1.16" class="difflineplus">+        newFolder = parentFolder.addSubfolder(newName);</span>
<a href="#l1.17"></a><span id="l1.17">       newFolder.setFlag(nsMsgFolderFlags.Virtual);</span>
<a href="#l1.18"></a><span id="l1.18">       // provide a way to make the top level folder just a container, not</span>
<a href="#l1.19"></a><span id="l1.19">       // a search folder</span>
<a href="#l1.20"></a><span id="l1.20">       let type = this._modes[&quot;smart&quot;].getSmartFolderTypeByName(newName);</span>
<a href="#l1.21"></a><span id="l1.21">       if (type[3]) { // isSearch</span>
<a href="#l1.22"></a><span id="l1.22">         let vfdb = newFolder.msgDatabase;</span>
<a href="#l1.23"></a><span id="l1.23">         let dbFolderInfo = vfdb.dBFolderInfo;</span>
<a href="#l1.24"></a><span id="l1.24">         // set the view string as a property of the db folder info</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l2.1"></a><span id="l2.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js</span>
<a href="#l2.2"></a><span id="l2.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-invalid-db-folder-load.js</span>
<a href="#l2.3"></a><span id="l2.3" class="difflineat">@@ -65,16 +65,17 @@ function setupModule(module) {</span>
<a href="#l2.4"></a><span id="l2.4"> /**</span>
<a href="#l2.5"></a><span id="l2.5">  *</span>
<a href="#l2.6"></a><span id="l2.6">  */</span>
<a href="#l2.7"></a><span id="l2.7"> function test_load_folder_with_invalidDB() {</span>
<a href="#l2.8"></a><span id="l2.8">   folder.msgDatabase.dBFolderInfo.sortType = nsMsgViewSortType.bySubject;</span>
<a href="#l2.9"></a><span id="l2.9">   folder.msgDatabase.summaryValid = false;</span>
<a href="#l2.10"></a><span id="l2.10">   folder.msgDatabase.ForceClosed();</span>
<a href="#l2.11"></a><span id="l2.11">   folder.msgDatabase = null;</span>
<a href="#l2.12"></a><span id="l2.12" class="difflineplus">+  dump(&quot;entering invalidmsf folder\n&quot;);</span>
<a href="#l2.13"></a><span id="l2.13">   be_in_folder(folder);</span>
<a href="#l2.14"></a><span id="l2.14"> </span>
<a href="#l2.15"></a><span id="l2.15">   assert_messages_in_view(setA);</span>
<a href="#l2.16"></a><span id="l2.16">   curMessage = select_click_row(0);</span>
<a href="#l2.17"></a><span id="l2.17">   assert_selected_and_displayed(curMessage);</span>
<a href="#l2.18"></a><span id="l2.18"> }</span>
<a href="#l2.19"></a><span id="l2.19"> </span>
<a href="#l2.20"></a><span id="l2.20"> function test_view_sort_maintained() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l3.1"></a><span id="l3.1" class="difflineminus">--- a/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js</span>
<a href="#l3.2"></a><span id="l3.2" class="difflineplus">+++ b/mail/test/mozmill/folder-display/test-savedsearch-reload-after-compact.js</span>
<a href="#l3.3"></a><span id="l3.3" class="difflineat">@@ -82,19 +82,20 @@ function test_setup_virtual_folder_and_c</span>
<a href="#l3.4"></a><span id="l3.4">     compactDone: false,</span>
<a href="#l3.5"></a><span id="l3.5"> </span>
<a href="#l3.6"></a><span id="l3.6">     OnStartRunningUrl: function (aUrl) {</span>
<a href="#l3.7"></a><span id="l3.7">     },</span>
<a href="#l3.8"></a><span id="l3.8">     OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l3.9"></a><span id="l3.9">       this.compactDone = true;</span>
<a href="#l3.10"></a><span id="l3.10">     }</span>
<a href="#l3.11"></a><span id="l3.11">   };</span>
<a href="#l3.12"></a><span id="l3.12" class="difflineminus">-  otherFolder.compactAll(urlListener, null, false);</span>
<a href="#l3.13"></a><span id="l3.13" class="difflineplus">+  if (otherFolder.msgStore.supportsCompaction) {</span>
<a href="#l3.14"></a><span id="l3.14" class="difflineplus">+    otherFolder.compactAll(urlListener, null, false);</span>
<a href="#l3.15"></a><span id="l3.15"> </span>
<a href="#l3.16"></a><span id="l3.16" class="difflineminus">-  mc.waitFor(function () urlListener.compactDone,</span>
<a href="#l3.17"></a><span id="l3.17" class="difflineminus">-             &quot;Timeout waiting for compact to complete&quot;, 10000, 100);</span>
<a href="#l3.18"></a><span id="l3.18" class="difflineminus">-</span>
<a href="#l3.19"></a><span id="l3.19" class="difflineplus">+    mc.waitFor(function () urlListener.compactDone,</span>
<a href="#l3.20"></a><span id="l3.20" class="difflineplus">+               &quot;Timeout waiting for compact to complete&quot;, 10000, 100);</span>
<a href="#l3.21"></a><span id="l3.21" class="difflineplus">+  }</span>
<a href="#l3.22"></a><span id="l3.22">   // Let the event queue clear.</span>
<a href="#l3.23"></a><span id="l3.23">   mc.sleep(0);</span>
<a href="#l3.24"></a><span id="l3.24">   // Check view is still valid</span>
<a href="#l3.25"></a><span id="l3.25">   let msgHdr = mc.dbView.getMsgHdrAt(0);</span>
<a href="#l3.26"></a><span id="l3.26"> }</span>
<a href="#l3.27"></a><span id="l3.27"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l4.1"></a><span id="l4.1" class="difflineminus">--- a/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js</span>
<a href="#l4.2"></a><span id="l4.2" class="difflineplus">+++ b/mail/test/mozmill/message-header/test-reply-to-list-from-address-selection.js</span>
<a href="#l4.3"></a><span id="l4.3" class="difflineat">@@ -110,17 +110,18 @@ var addIdentitiesAndFolder = function() </span>
<a href="#l4.4"></a><span id="l4.4">   identity2.email=&quot;tinderbox_identity1@invalid.com&quot;;</span>
<a href="#l4.5"></a><span id="l4.5"> </span>
<a href="#l4.6"></a><span id="l4.6">   var identity = acctMgr.createIdentity();</span>
<a href="#l4.7"></a><span id="l4.7">   //identity.fullName = &quot;Tinderbox_Identity1&quot;;</span>
<a href="#l4.8"></a><span id="l4.8">   identity.email = identityString1;</span>
<a href="#l4.9"></a><span id="l4.9"> </span>
<a href="#l4.10"></a><span id="l4.10">   var server = acctMgr.createIncomingServer(&quot;nobody&quot;,</span>
<a href="#l4.11"></a><span id="l4.11">                                             &quot;Test Local Folders&quot;, &quot;pop3&quot;);</span>
<a href="#l4.12"></a><span id="l4.12" class="difflineminus">-  testFolder = server.rootFolder.addSubfolder(&quot;Test Folder&quot;);</span>
<a href="#l4.13"></a><span id="l4.13" class="difflineplus">+  let localRoot = server.rootFolder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l4.14"></a><span id="l4.14" class="difflineplus">+  testFolder = localRoot.createLocalSubfolder(&quot;Test Folder&quot;);</span>
<a href="#l4.15"></a><span id="l4.15"> </span>
<a href="#l4.16"></a><span id="l4.16">   var account = acctMgr.createAccount();</span>
<a href="#l4.17"></a><span id="l4.17">   account.incomingServer = server;</span>
<a href="#l4.18"></a><span id="l4.18">   account.addIdentity(identity);</span>
<a href="#l4.19"></a><span id="l4.19">   account.addIdentity(identity2);</span>
<a href="#l4.20"></a><span id="l4.20"> }</span>
<a href="#l4.21"></a><span id="l4.21"> </span>
<a href="#l4.22"></a><span id="l4.22"> function test_Reply_To_List_From_Address() {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l5.1"></a><span id="l5.1" class="difflineminus">--- a/mail/test/mozmill/notification/test-notification.js</span>
<a href="#l5.2"></a><span id="l5.2" class="difflineplus">+++ b/mail/test/mozmill/notification/test-notification.js</span>
<a href="#l5.3"></a><span id="l5.3" class="difflineat">@@ -145,17 +145,18 @@ function setupModule(module) {</span>
<a href="#l5.4"></a><span id="l5.4">   var server = MailServices.accounts</span>
<a href="#l5.5"></a><span id="l5.5">                            .createIncomingServer(&quot;nobody&quot;,</span>
<a href="#l5.6"></a><span id="l5.6">                                                  &quot;Test Local Folders&quot;, &quot;pop3&quot;);</span>
<a href="#l5.7"></a><span id="l5.7"> </span>
<a href="#l5.8"></a><span id="l5.8">   server.performingBiff = true;</span>
<a href="#l5.9"></a><span id="l5.9"> </span>
<a href="#l5.10"></a><span id="l5.10">   // Create the target folders</span>
<a href="#l5.11"></a><span id="l5.11">   gFolder = create_folder(&quot;My Folder&quot;);</span>
<a href="#l5.12"></a><span id="l5.12" class="difflineminus">-  gFolder2 = server.rootFolder.addSubfolder(&quot;Another Folder&quot;);</span>
<a href="#l5.13"></a><span id="l5.13" class="difflineplus">+  let localRoot = server.rootFolder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l5.14"></a><span id="l5.14" class="difflineplus">+  gFolder2 = localRoot.createLocalSubfolder(&quot;Another Folder&quot;);</span>
<a href="#l5.15"></a><span id="l5.15"> </span>
<a href="#l5.16"></a><span id="l5.16">   var account = MailServices.accounts.createAccount();</span>
<a href="#l5.17"></a><span id="l5.17">   account.incomingServer = server;</span>
<a href="#l5.18"></a><span id="l5.18">   account.addIdentity(identity2);</span>
<a href="#l5.19"></a><span id="l5.19"> }</span>
<a href="#l5.20"></a><span id="l5.20"> </span>
<a href="#l5.21"></a><span id="l5.21"> function teardownModule(module) {</span>
<a href="#l5.22"></a><span id="l5.22">   put_bool_prefs_back();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l6.1"></a><span id="l6.1" class="difflineminus">--- a/mailnews/base/prefs/content/accountcreation/readFromXML.js</span>
<a href="#l6.2"></a><span id="l6.2" class="difflineplus">+++ b/mailnews/base/prefs/content/accountcreation/readFromXML.js</span>
<a href="#l6.3"></a><span id="l6.3" class="difflineat">@@ -50,16 +50,17 @@</span>
<a href="#l6.4"></a><span id="l6.4">  * @return AccountConfig   object filled with the data from XML</span>
<a href="#l6.5"></a><span id="l6.5">  */</span>
<a href="#l6.6"></a><span id="l6.6"> function readFromXML(clientConfigXML)</span>
<a href="#l6.7"></a><span id="l6.7"> {</span>
<a href="#l6.8"></a><span id="l6.8">   var exception;</span>
<a href="#l6.9"></a><span id="l6.9">   if (typeof(clientConfigXML) != &quot;xml&quot; ||</span>
<a href="#l6.10"></a><span id="l6.10">       !(&quot;emailProvider&quot; in clientConfigXML))</span>
<a href="#l6.11"></a><span id="l6.11">   {</span>
<a href="#l6.12"></a><span id="l6.12" class="difflineplus">+    dump(&quot;client config xml = &quot; + clientConfigXML + &quot;\n&quot;);</span>
<a href="#l6.13"></a><span id="l6.13">     var stringBundle = getStringBundle(</span>
<a href="#l6.14"></a><span id="l6.14">         &quot;chrome://messenger/locale/accountCreationModel.properties&quot;);</span>
<a href="#l6.15"></a><span id="l6.15">     throw stringBundle.GetStringFromName(&quot;no_emailProvider.error&quot;);</span>
<a href="#l6.16"></a><span id="l6.16">   }</span>
<a href="#l6.17"></a><span id="l6.17">   var xml = clientConfigXML.emailProvider;</span>
<a href="#l6.18"></a><span id="l6.18"> </span>
<a href="#l6.19"></a><span id="l6.19">   var d = new AccountConfig();</span>
<a href="#l6.20"></a><span id="l6.20">   d.source = AccountConfig.kSourceXML;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l7.1"></a><span id="l7.1" class="difflineminus">--- a/mailnews/base/public/Makefile.in</span>
<a href="#l7.2"></a><span id="l7.2" class="difflineplus">+++ b/mailnews/base/public/Makefile.in</span>
<a href="#l7.3"></a><span id="l7.3" class="difflineat">@@ -100,12 +100,13 @@ XPIDLSRCS	= \</span>
<a href="#l7.4"></a><span id="l7.4"> 		nsIMapiRegistry.idl \</span>
<a href="#l7.5"></a><span id="l7.5"> 		nsIMsgCustomColumnHandler.idl \</span>
<a href="#l7.6"></a><span id="l7.6"> 		nsIMsgShutdown.idl \</span>
<a href="#l7.7"></a><span id="l7.7"> 		nsMsgFolderFlags.idl \</span>
<a href="#l7.8"></a><span id="l7.8"> 		nsMsgMessageFlags.idl \</span>
<a href="#l7.9"></a><span id="l7.9"> 		nsIStopwatch.idl \</span>
<a href="#l7.10"></a><span id="l7.10"> 		nsIMsgUserFeedbackListener.idl \</span>
<a href="#l7.11"></a><span id="l7.11"> 		nsIMsgAsyncPrompter.idl \</span>
<a href="#l7.12"></a><span id="l7.12" class="difflineplus">+		nsIMsgPluggableStore.idl \</span>
<a href="#l7.13"></a><span id="l7.13"> 		$(NULL)</span>
<a href="#l7.14"></a><span id="l7.14"> </span>
<a href="#l7.15"></a><span id="l7.15"> include $(topsrcdir)/config/rules.mk</span>
<a href="#l7.16"></a><span id="l7.16"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l8.1"></a><span id="l8.1" class="difflineminus">--- a/mailnews/base/public/msgCore.h</span>
<a href="#l8.2"></a><span id="l8.2" class="difflineplus">+++ b/mailnews/base/public/msgCore.h</span>
<a href="#l8.3"></a><span id="l8.3" class="difflineat">@@ -170,34 +170,37 @@ NS_ERROR_GENERATE_FAILURE(NS_ERROR_MODUL</span>
<a href="#l8.4"></a><span id="l8.4"> </span>
<a href="#l8.5"></a><span id="l8.5"> #define NS_MSG_NEWS_ARTICLE_NOT_FOUND NS_MSG_GENERATE_FAILURE(25)</span>
<a href="#l8.6"></a><span id="l8.6"> </span>
<a href="#l8.7"></a><span id="l8.7"> #define NS_MSG_ERROR_COPY_FOLDER_ABORTED NS_MSG_GENERATE_FAILURE(26)</span>
<a href="#l8.8"></a><span id="l8.8"> // this error means a url was queued but never run because one of the urls</span>
<a href="#l8.9"></a><span id="l8.9"> // it was queued after failed. We send an OnStopRunningUrl with this error code </span>
<a href="#l8.10"></a><span id="l8.10"> // so the listeners can know that we didn't run the url.</span>
<a href="#l8.11"></a><span id="l8.11"> #define NS_MSG_ERROR_URL_ABORTED NS_MSG_GENERATE_FAILURE(27)</span>
<a href="#l8.12"></a><span id="l8.12" class="difflineminus">-/* ducarroz: error codes for message compose are defined into compose\src\nsMsgComposeStringBundle.h.</span>
<a href="#l8.13"></a><span id="l8.13" class="difflineminus">-             Message compose use the same error code space than other mailnews modules. To avoid any</span>
<a href="#l8.14"></a><span id="l8.14" class="difflineminus">-             conflict, I reserve values between 12500 and 12999 for it.</span>
<a href="#l8.15"></a><span id="l8.15" class="difflineminus">-*/</span>
<a href="#l8.16"></a><span id="l8.16"> #define NS_MSG_CUSTOM_HEADERS_OVERFLOW NS_MSG_GENERATE_FAILURE(28) //when num of custom headers exceeds 50</span>
<a href="#l8.17"></a><span id="l8.17"> #define NS_MSG_INVALID_CUSTOM_HEADER NS_MSG_GENERATE_FAILURE(29) //when custom header has invalid characters (as per rfc 2822) </span>
<a href="#l8.18"></a><span id="l8.18"> </span>
<a href="#l8.19"></a><span id="l8.19"> #define NS_MSG_USER_NOT_AUTHENTICATED NS_MSG_GENERATE_FAILURE(30) // when local caches are password protect and user isn't auth</span>
<a href="#l8.20"></a><span id="l8.20"> </span>
<a href="#l8.21"></a><span id="l8.21"> #define NS_MSG_ERROR_COPYING_FROM_TMP_DOWNLOAD NS_MSG_GENERATE_FAILURE(31) // pop3 downloaded to tmp file, and failed.</span>
<a href="#l8.22"></a><span id="l8.22"> </span>
<a href="#l8.23"></a><span id="l8.23"> // The code tried to stream a message using the aLocalOnly argument, but</span>
<a href="#l8.24"></a><span id="l8.24"> // the message was not cached locally.</span>
<a href="#l8.25"></a><span id="l8.25"> #define NS_MSG_ERROR_MSG_NOT_OFFLINE NS_MSG_GENERATE_FAILURE(32)</span>
<a href="#l8.26"></a><span id="l8.26"> </span>
<a href="#l8.27"></a><span id="l8.27"> // The imap server returned NO or BAD for an IMAP command</span>
<a href="#l8.28"></a><span id="l8.28"> #define NS_MSG_ERROR_IMAP_COMMAND_FAILED NS_MSG_GENERATE_FAILURE(33)</span>
<a href="#l8.29"></a><span id="l8.29"> </span>
<a href="#l8.30"></a><span id="l8.30" class="difflineplus">+#define NS_MSG_ERROR_INVALID_FOLDER_NAME NS_MSG_GENERATE_FAILURE(34)</span>
<a href="#l8.31"></a><span id="l8.31" class="difflineplus">+</span>
<a href="#l8.32"></a><span id="l8.32" class="difflineplus">+/* Error codes for message compose are defined in</span>
<a href="#l8.33"></a><span id="l8.33" class="difflineplus">+   compose\src\nsMsgComposeStringBundle.h. Message compose use the same error</span>
<a href="#l8.34"></a><span id="l8.34" class="difflineplus">+   code space as other mailnews modules. To avoid any conflict, values between</span>
<a href="#l8.35"></a><span id="l8.35" class="difflineplus">+   12500 and 12999 are reserved.</span>
<a href="#l8.36"></a><span id="l8.36" class="difflineplus">+*/</span>
<a href="#l8.37"></a><span id="l8.37"> #define NS_MSGCOMP_ERROR_BEGIN 12500</span>
<a href="#l8.38"></a><span id="l8.38"> /* NS_ERROR_NNTP_NO_CROSS_POSTING lives here, and not in nsMsgComposeStringBundle.h, because it is used in news and compose. */</span>
<a href="#l8.39"></a><span id="l8.39"> #define NS_ERROR_NNTP_NO_CROSS_POSTING NS_MSG_GENERATE_FAILURE(12554)</span>
<a href="#l8.40"></a><span id="l8.40"> #define NS_MSGCOMP_ERROR_END 12999</span>
<a href="#l8.41"></a><span id="l8.41"> </span>
<a href="#l8.42"></a><span id="l8.42"> #if defined(XP_WIN) || defined(XP_OS2)</span>
<a href="#l8.43"></a><span id="l8.43"> #define MSG_LINEBREAK &quot;\015\012&quot;</span>
<a href="#l8.44"></a><span id="l8.44"> #define MSG_LINEBREAK_LEN 2</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l9.1"></a><span id="l9.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l9.2"></a><span id="l9.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgFolder.idl</span>
<a href="#l9.3"></a><span id="l9.3" class="difflineat">@@ -55,22 +55,23 @@ interface nsITransport;</span>
<a href="#l9.4"></a><span id="l9.4"> interface nsIFile;</span>
<a href="#l9.5"></a><span id="l9.5"> interface nsIOutputStream;</span>
<a href="#l9.6"></a><span id="l9.6"> interface nsIInputStream;</span>
<a href="#l9.7"></a><span id="l9.7"> interface nsILocalFile;</span>
<a href="#l9.8"></a><span id="l9.8"> interface nsIMsgIdentity;</span>
<a href="#l9.9"></a><span id="l9.9"> interface nsIArray;</span>
<a href="#l9.10"></a><span id="l9.10"> interface nsIMutableArray;</span>
<a href="#l9.11"></a><span id="l9.11"> interface nsISupportsArray;</span>
<a href="#l9.12"></a><span id="l9.12" class="difflineplus">+interface nsIMsgPluggableStore;</span>
<a href="#l9.13"></a><span id="l9.13"> </span>
<a href="#l9.14"></a><span id="l9.14"> typedef long nsMsgBiffState;</span>
<a href="#l9.15"></a><span id="l9.15"> </span>
<a href="#l9.16"></a><span id="l9.16"> // enumerated type for determining if a message has been replied to, forwarded, etc.</span>
<a href="#l9.17"></a><span id="l9.17"> typedef long nsMsgDispositionState;</span>
<a href="#l9.18"></a><span id="l9.18" class="difflineminus">-[scriptable, uuid(953b7bb1-6a3e-4a5b-841f-637ac68dee0e)]</span>
<a href="#l9.19"></a><span id="l9.19" class="difflineplus">+[scriptable, uuid(8b8c5bf8-82e3-4415-bcf3-6029ab4777c5)]</span>
<a href="#l9.20"></a><span id="l9.20"> interface nsIMsgFolder : nsISupports {</span>
<a href="#l9.21"></a><span id="l9.21"> </span>
<a href="#l9.22"></a><span id="l9.22">   const nsMsgBiffState nsMsgBiffState_NewMail = 0; // User has new mail waiting.</span>
<a href="#l9.23"></a><span id="l9.23">   const nsMsgBiffState nsMsgBiffState_NoMail =  1; // No new mail is waiting.</span>
<a href="#l9.24"></a><span id="l9.24">   const nsMsgBiffState nsMsgBiffState_Unknown = 2; // We dunno whether there is new mail.</span>
<a href="#l9.25"></a><span id="l9.25"> </span>
<a href="#l9.26"></a><span id="l9.26">   /// Returns an enumerator containing the messages within the current database.</span>
<a href="#l9.27"></a><span id="l9.27">   readonly attribute nsISimpleEnumerator messages;</span>
<a href="#l9.28"></a><span id="l9.28" class="difflineat">@@ -187,16 +188,26 @@ interface nsIMsgFolder : nsISupports {</span>
<a href="#l9.29"></a><span id="l9.29"> </span>
<a href="#l9.30"></a><span id="l9.30">   void Delete ();</span>
<a href="#l9.31"></a><span id="l9.31"> </span>
<a href="#l9.32"></a><span id="l9.32">   void deleteSubFolders(in nsIArray folders, in nsIMsgWindow msgWindow);</span>
<a href="#l9.33"></a><span id="l9.33">   void propagateDelete(in nsIMsgFolder folder, in boolean deleteStorage,</span>
<a href="#l9.34"></a><span id="l9.34">                        in nsIMsgWindow msgWindow);</span>
<a href="#l9.35"></a><span id="l9.35">   void recursiveDelete(in boolean deleteStorage, in nsIMsgWindow msgWindow);</span>
<a href="#l9.36"></a><span id="l9.36"> </span>
<a href="#l9.37"></a><span id="l9.37" class="difflineplus">+  /**</span>
<a href="#l9.38"></a><span id="l9.38" class="difflineplus">+   * Create a subfolder of the current folder with the passed in name.</span>
<a href="#l9.39"></a><span id="l9.39" class="difflineplus">+   * For IMAP, this will be an async operation and the folder won't exist</span>
<a href="#l9.40"></a><span id="l9.40" class="difflineplus">+   * until it is created on the server.</span>
<a href="#l9.41"></a><span id="l9.41" class="difflineplus">+   *</span>
<a href="#l9.42"></a><span id="l9.42" class="difflineplus">+   * @param folderName name of the folder to create.</span>
<a href="#l9.43"></a><span id="l9.43" class="difflineplus">+   * @param msgWindow msgWindow to display status feedback in.</span>
<a href="#l9.44"></a><span id="l9.44" class="difflineplus">+   *</span>
<a href="#l9.45"></a><span id="l9.45" class="difflineplus">+   * @exception NS_MSG_FOLDER_EXISTS</span>
<a href="#l9.46"></a><span id="l9.46" class="difflineplus">+   */</span>
<a href="#l9.47"></a><span id="l9.47">   void createSubfolder(in AString folderName, in nsIMsgWindow msgWindow);</span>
<a href="#l9.48"></a><span id="l9.48"> </span>
<a href="#l9.49"></a><span id="l9.49">   /**</span>
<a href="#l9.50"></a><span id="l9.50">    * Adds the subfolder with the passed name to the folder hierarchy.</span>
<a href="#l9.51"></a><span id="l9.51">    * This is used internally during folder discovery; It shouldn't be</span>
<a href="#l9.52"></a><span id="l9.52">    * used to create folders since it won't create storage for the folder,</span>
<a href="#l9.53"></a><span id="l9.53">    * especially for imap. Unless you know exactly what you're doing, you</span>
<a href="#l9.54"></a><span id="l9.54">    * should be using createSubfolder + getChildNamed or createLocalSubfolder.</span>
<a href="#l9.55"></a><span id="l9.55" class="difflineat">@@ -546,19 +557,38 @@ interface nsIMsgFolder : nsISupports {</span>
<a href="#l9.56"></a><span id="l9.56">    *</span>
<a href="#l9.57"></a><span id="l9.57">    * @param aMsgKey key of message to get input stream for.</span>
<a href="#l9.58"></a><span id="l9.58">    * @param[out] aOffset filled in with the offset into the stream of the message.</span>
<a href="#l9.59"></a><span id="l9.59">    * @param[out] aSize filled in with the size of the message in the offline store.</span>
<a href="#l9.60"></a><span id="l9.60">    *</span>
<a href="#l9.61"></a><span id="l9.61">    * @returns input stream to read the message from.</span>
<a href="#l9.62"></a><span id="l9.62">    */</span>
<a href="#l9.63"></a><span id="l9.63">   nsIInputStream getOfflineFileStream(in nsMsgKey aMsgKey,</span>
<a href="#l9.64"></a><span id="l9.64" class="difflineminus">-                                      out unsigned long long aOffset,</span>
<a href="#l9.65"></a><span id="l9.65" class="difflineplus">+                                      out long long aOffset,</span>
<a href="#l9.66"></a><span id="l9.66">                                       out unsigned long aSize);</span>
<a href="#l9.67"></a><span id="l9.67" class="difflineminus">-  readonly attribute nsIOutputStream offlineStoreOutputStream;</span>
<a href="#l9.68"></a><span id="l9.68" class="difflineplus">+</span>
<a href="#l9.69"></a><span id="l9.69" class="difflineplus">+  /**</span>
<a href="#l9.70"></a><span id="l9.70" class="difflineplus">+   * Get an offline store output stream for the passed message header.</span>
<a href="#l9.71"></a><span id="l9.71" class="difflineplus">+   *</span>
<a href="#l9.72"></a><span id="l9.72" class="difflineplus">+   * @param aHdr hdr of message to get outputstream for</span>
<a href="#l9.73"></a><span id="l9.73" class="difflineplus">+   * @returns An output stream to write to.</span>
<a href="#l9.74"></a><span id="l9.74" class="difflineplus">+   */</span>
<a href="#l9.75"></a><span id="l9.75" class="difflineplus">+  nsIOutputStream getOfflineStoreOutputStream(in nsIMsgDBHdr aHdr);</span>
<a href="#l9.76"></a><span id="l9.76" class="difflineplus">+</span>
<a href="#l9.77"></a><span id="l9.77" class="difflineplus">+  /**</span>
<a href="#l9.78"></a><span id="l9.78" class="difflineplus">+   * Get an input stream for the passed message header. The stream will</span>
<a href="#l9.79"></a><span id="l9.79" class="difflineplus">+   * be positioned at the start of the message.</span>
<a href="#l9.80"></a><span id="l9.80" class="difflineplus">+   *</span>
<a href="#l9.81"></a><span id="l9.81" class="difflineplus">+   * @param aHdr hdr of message to get the input stream for.</span>
<a href="#l9.82"></a><span id="l9.82" class="difflineplus">+   * @param[out] aReusable set to true if the stream can be re-used, in which</span>
<a href="#l9.83"></a><span id="l9.83" class="difflineplus">+                           case the caller might not want to close it.</span>
<a href="#l9.84"></a><span id="l9.84" class="difflineplus">+   * @returns an input stream to read the message from</span>
<a href="#l9.85"></a><span id="l9.85" class="difflineplus">+   */</span>
<a href="#l9.86"></a><span id="l9.86" class="difflineplus">+  nsIInputStream getMsgInputStream(in nsIMsgDBHdr aHdr, out boolean aReusable);</span>
<a href="#l9.87"></a><span id="l9.87" class="difflineplus">+</span>
<a href="#l9.88"></a><span id="l9.88">   readonly attribute nsIInputStream offlineStoreInputStream;</span>
<a href="#l9.89"></a><span id="l9.89">   void DownloadMessagesForOffline(in nsIArray messages,</span>
<a href="#l9.90"></a><span id="l9.90">                                   in nsIMsgWindow window);</span>
<a href="#l9.91"></a><span id="l9.91">   nsIMsgFolder getChildWithURI(in ACString uri, in boolean deep,</span>
<a href="#l9.92"></a><span id="l9.92">                                in boolean caseInsensitive);</span>
<a href="#l9.93"></a><span id="l9.93">   void downloadAllForOffline(in nsIUrlListener listener, in nsIMsgWindow window);</span>
<a href="#l9.94"></a><span id="l9.94">   /**</span>
<a href="#l9.95"></a><span id="l9.95">    *  Turn notifications on/off for various notification types. Currently only</span>
<a href="#l9.96"></a><span id="l9.96" class="difflineat">@@ -810,9 +840,14 @@ interface nsIMsgFolder : nsISupports {</span>
<a href="#l9.97"></a><span id="l9.97">    * of inheriting from a parent folder, server, or the global</span>
<a href="#l9.98"></a><span id="l9.98">    *</span>
<a href="#l9.99"></a><span id="l9.99">    * @param propertyName      The name of the property</span>
<a href="#l9.100"></a><span id="l9.100">    *</span>
<a href="#l9.101"></a><span id="l9.101">    * @return                  true if an empty inherited property should be returned</span>
<a href="#l9.102"></a><span id="l9.102">    */</span>
<a href="#l9.103"></a><span id="l9.103">   boolean getForcePropertyEmpty(in string propertyName);</span>
<a href="#l9.104"></a><span id="l9.104"> </span>
<a href="#l9.105"></a><span id="l9.105" class="difflineplus">+  /**</span>
<a href="#l9.106"></a><span id="l9.106" class="difflineplus">+   * Pluggable store for this folder. Currently, this will always be the same</span>
<a href="#l9.107"></a><span id="l9.107" class="difflineplus">+   * as the pluggable store for the server.</span>
<a href="#l9.108"></a><span id="l9.108" class="difflineplus">+   */</span>
<a href="#l9.109"></a><span id="l9.109" class="difflineplus">+  readonly attribute nsIMsgPluggableStore msgStore;</span>
<a href="#l9.110"></a><span id="l9.110"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l10.1"></a><span id="l10.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgHdr.idl</span>
<a href="#l10.2"></a><span id="l10.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgHdr.idl</span>
<a href="#l10.3"></a><span id="l10.3" class="difflineat">@@ -79,17 +79,21 @@ interface nsIMsgDBHdr : nsISupports</span>
<a href="#l10.4"></a><span id="l10.4">     attribute nsMsgKey threadId;</span>
<a href="#l10.5"></a><span id="l10.5">     attribute nsMsgKey messageKey;</span>
<a href="#l10.6"></a><span id="l10.6">     attribute nsMsgKey threadParent;</span>
<a href="#l10.7"></a><span id="l10.7"> </span>
<a href="#l10.8"></a><span id="l10.8">     /* meta information about the message, learned from reading the message */</span>
<a href="#l10.9"></a><span id="l10.9">     attribute unsigned long messageSize;</span>
<a href="#l10.10"></a><span id="l10.10">     attribute unsigned long lineCount;</span>
<a href="#l10.11"></a><span id="l10.11">     attribute unsigned long statusOffset;</span>
<a href="#l10.12"></a><span id="l10.12" class="difflineminus">-    /// The offset into the local folder/offline store of the message.</span>
<a href="#l10.13"></a><span id="l10.13" class="difflineplus">+    /**</span>
<a href="#l10.14"></a><span id="l10.14" class="difflineplus">+     * The offset into the local folder/offline store of the message. This</span>
<a href="#l10.15"></a><span id="l10.15" class="difflineplus">+     * will be pluggable store-dependent, e.g., for mail dir it should</span>
<a href="#l10.16"></a><span id="l10.16" class="difflineplus">+     * always be 0.</span>
<a href="#l10.17"></a><span id="l10.17" class="difflineplus">+     */</span>
<a href="#l10.18"></a><span id="l10.18">     attribute unsigned long long messageOffset;</span>
<a href="#l10.19"></a><span id="l10.19">     attribute unsigned long offlineMessageSize;</span>
<a href="#l10.20"></a><span id="l10.20">     /* common headers */</span>
<a href="#l10.21"></a><span id="l10.21">     attribute PRTime date;</span>
<a href="#l10.22"></a><span id="l10.22">     readonly attribute unsigned long dateInSeconds;</span>
<a href="#l10.23"></a><span id="l10.23">     attribute string messageId;</span>
<a href="#l10.24"></a><span id="l10.24">     attribute string ccList;</span>
<a href="#l10.25"></a><span id="l10.25">     attribute string bccList;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l11.1"></a><span id="l11.1" class="difflineminus">--- a/mailnews/base/public/nsIMsgIncomingServer.idl</span>
<a href="#l11.2"></a><span id="l11.2" class="difflineplus">+++ b/mailnews/base/public/nsIMsgIncomingServer.idl</span>
<a href="#l11.3"></a><span id="l11.3" class="difflineat">@@ -47,24 +47,25 @@ interface nsIMsgFilterList;</span>
<a href="#l11.4"></a><span id="l11.4"> interface nsIMsgRetentionSettings;</span>
<a href="#l11.5"></a><span id="l11.5"> interface nsIMsgDownloadSettings;</span>
<a href="#l11.6"></a><span id="l11.6"> interface nsISpamSettings;</span>
<a href="#l11.7"></a><span id="l11.7"> interface nsIMsgFilterPlugin;</span>
<a href="#l11.8"></a><span id="l11.8"> interface nsIUrlListener;</span>
<a href="#l11.9"></a><span id="l11.9"> interface nsIMsgDBHdr;</span>
<a href="#l11.10"></a><span id="l11.10"> interface nsILocalFile;</span>
<a href="#l11.11"></a><span id="l11.11"> interface nsIURI;</span>
<a href="#l11.12"></a><span id="l11.12" class="difflineplus">+interface nsIMsgPluggableStore;</span>
<a href="#l11.13"></a><span id="l11.13"> </span>
<a href="#l11.14"></a><span id="l11.14"> /*</span>
<a href="#l11.15"></a><span id="l11.15">  * Interface for incoming mail/news host</span>
<a href="#l11.16"></a><span id="l11.16">  * this is the base interface for all mail server types (imap, pop, nntp, etc)</span>
<a href="#l11.17"></a><span id="l11.17">  * often you will want to add extra interfaces that give you server-specific</span>
<a href="#l11.18"></a><span id="l11.18">  * attributes and methods.</span>
<a href="#l11.19"></a><span id="l11.19">  */</span>
<a href="#l11.20"></a><span id="l11.20" class="difflineminus">-[scriptable, uuid(67bcc06e-88d5-4441-a987-b7590d9ce04a)]</span>
<a href="#l11.21"></a><span id="l11.21" class="difflineplus">+[scriptable, uuid(ad2637ee-6dac-4fc3-a1da-19394f66cbc2)]</span>
<a href="#l11.22"></a><span id="l11.22"> interface nsIMsgIncomingServer : nsISupports {</span>
<a href="#l11.23"></a><span id="l11.23"> </span>
<a href="#l11.24"></a><span id="l11.24">   /**</span>
<a href="#l11.25"></a><span id="l11.25">    * internal pref key - guaranteed to be unique across all servers</span>
<a href="#l11.26"></a><span id="l11.26">    */</span>
<a href="#l11.27"></a><span id="l11.27">   attribute ACString key;</span>
<a href="#l11.28"></a><span id="l11.28"> </span>
<a href="#l11.29"></a><span id="l11.29">   /**</span>
<a href="#l11.30"></a><span id="l11.30" class="difflineat">@@ -161,16 +162,19 @@ interface nsIMsgIncomingServer : nsISupp</span>
<a href="#l11.31"></a><span id="l11.31">   attribute unsigned long biffState;</span>
<a href="#l11.32"></a><span id="l11.32"> </span>
<a href="#l11.33"></a><span id="l11.33">   /* are we running a url as a result of biff going off? (different from user clicking get msg) */</span>
<a href="#l11.34"></a><span id="l11.34">   attribute boolean performingBiff; </span>
<a href="#l11.35"></a><span id="l11.35"> </span>
<a href="#l11.36"></a><span id="l11.36">   /* the on-disk path to message storage for this server */</span>
<a href="#l11.37"></a><span id="l11.37">   attribute nsILocalFile localPath;</span>
<a href="#l11.38"></a><span id="l11.38"> </span>
<a href="#l11.39"></a><span id="l11.39" class="difflineplus">+  /// message store to use for the folders under this server.</span>
<a href="#l11.40"></a><span id="l11.40" class="difflineplus">+  readonly attribute nsIMsgPluggableStore msgStore;</span>
<a href="#l11.41"></a><span id="l11.41" class="difflineplus">+</span>
<a href="#l11.42"></a><span id="l11.42">   /* the RDF URI for the root mail folder */</span>
<a href="#l11.43"></a><span id="l11.43">   readonly attribute ACString serverURI;</span>
<a href="#l11.44"></a><span id="l11.44"> </span>
<a href="#l11.45"></a><span id="l11.45">   /* the root folder for this server, even if server is deferred */</span>
<a href="#l11.46"></a><span id="l11.46">   attribute nsIMsgFolder rootFolder;</span>
<a href="#l11.47"></a><span id="l11.47"> </span>
<a href="#l11.48"></a><span id="l11.48">   /* root folder for this account </span>
<a href="#l11.49"></a><span id="l11.49">      - if account is deferred, root folder of deferred-to account */</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l12.1"></a><span id="l12.1">new file mode 100644</span>
<a href="#l12.2"></a><span id="l12.2" class="difflineminus">--- /dev/null</span>
<a href="#l12.3"></a><span id="l12.3" class="difflineplus">+++ b/mailnews/base/public/nsIMsgPluggableStore.idl</span>
<a href="#l12.4"></a><span id="l12.4" class="difflineat">@@ -0,0 +1,352 @@</span>
<a href="#l12.5"></a><span id="l12.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */</span>
<a href="#l12.6"></a><span id="l12.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l12.7"></a><span id="l12.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l12.8"></a><span id="l12.8" class="difflineplus">+ *</span>
<a href="#l12.9"></a><span id="l12.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l12.10"></a><span id="l12.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l12.11"></a><span id="l12.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l12.12"></a><span id="l12.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l12.13"></a><span id="l12.13" class="difflineplus">+ *</span>
<a href="#l12.14"></a><span id="l12.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l12.15"></a><span id="l12.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l12.16"></a><span id="l12.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l12.17"></a><span id="l12.17" class="difflineplus">+ * License.</span>
<a href="#l12.18"></a><span id="l12.18" class="difflineplus">+ *</span>
<a href="#l12.19"></a><span id="l12.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l12.20"></a><span id="l12.20" class="difflineplus">+ *</span>
<a href="#l12.21"></a><span id="l12.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l12.22"></a><span id="l12.22" class="difflineplus">+ * Mozilla Foundation.</span>
<a href="#l12.23"></a><span id="l12.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l12.24"></a><span id="l12.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l12.25"></a><span id="l12.25" class="difflineplus">+ *</span>
<a href="#l12.26"></a><span id="l12.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l12.27"></a><span id="l12.27" class="difflineplus">+ *   David Bienvenu &lt;bienvenu@mozilla.com&gt;</span>
<a href="#l12.28"></a><span id="l12.28" class="difflineplus">+ *</span>
<a href="#l12.29"></a><span id="l12.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l12.30"></a><span id="l12.30" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l12.31"></a><span id="l12.31" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l12.32"></a><span id="l12.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l12.33"></a><span id="l12.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l12.34"></a><span id="l12.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l12.35"></a><span id="l12.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l12.36"></a><span id="l12.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l12.37"></a><span id="l12.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l12.38"></a><span id="l12.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l12.39"></a><span id="l12.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l12.40"></a><span id="l12.40" class="difflineplus">+ *</span>
<a href="#l12.41"></a><span id="l12.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l12.42"></a><span id="l12.42" class="difflineplus">+</span>
<a href="#l12.43"></a><span id="l12.43" class="difflineplus">+#include &quot;nsISupports.idl&quot;</span>
<a href="#l12.44"></a><span id="l12.44" class="difflineplus">+</span>
<a href="#l12.45"></a><span id="l12.45" class="difflineplus">+interface nsILocalFile;</span>
<a href="#l12.46"></a><span id="l12.46" class="difflineplus">+interface nsIMsgFolder;</span>
<a href="#l12.47"></a><span id="l12.47" class="difflineplus">+interface nsIMsgCopyServiceListener;</span>
<a href="#l12.48"></a><span id="l12.48" class="difflineplus">+interface nsIMsgDBHdr;</span>
<a href="#l12.49"></a><span id="l12.49" class="difflineplus">+interface nsIMsgWindow;</span>
<a href="#l12.50"></a><span id="l12.50" class="difflineplus">+interface nsISimpleEnumerator;</span>
<a href="#l12.51"></a><span id="l12.51" class="difflineplus">+interface nsIOutputStream;</span>
<a href="#l12.52"></a><span id="l12.52" class="difflineplus">+interface nsIInputStream;</span>
<a href="#l12.53"></a><span id="l12.53" class="difflineplus">+interface nsIArray;</span>
<a href="#l12.54"></a><span id="l12.54" class="difflineplus">+interface nsIUrlListener;</span>
<a href="#l12.55"></a><span id="l12.55" class="difflineplus">+interface nsIMsgIncomingServer;</span>
<a href="#l12.56"></a><span id="l12.56" class="difflineplus">+interface nsIMsgDatabase;</span>
<a href="#l12.57"></a><span id="l12.57" class="difflineplus">+</span>
<a href="#l12.58"></a><span id="l12.58" class="difflineplus">+[scriptable, uuid(370f7a56-db1b-4cf9-b541-148572390416)]</span>
<a href="#l12.59"></a><span id="l12.59" class="difflineplus">+</span>
<a href="#l12.60"></a><span id="l12.60" class="difflineplus">+/**</span>
<a href="#l12.61"></a><span id="l12.61" class="difflineplus">+ * Pluggable message store interface. Each incoming server can have a different</span>
<a href="#l12.62"></a><span id="l12.62" class="difflineplus">+ * message store.</span>
<a href="#l12.63"></a><span id="l12.63" class="difflineplus">+ * All methods are synchronous unless otherwise specified.</span>
<a href="#l12.64"></a><span id="l12.64" class="difflineplus">+ */</span>
<a href="#l12.65"></a><span id="l12.65" class="difflineplus">+interface nsIMsgPluggableStore : nsISupports {</span>
<a href="#l12.66"></a><span id="l12.66" class="difflineplus">+  /**</span>
<a href="#l12.67"></a><span id="l12.67" class="difflineplus">+   * Examines the store and adds subfolders for the existing folders in the</span>
<a href="#l12.68"></a><span id="l12.68" class="difflineplus">+   * profile directory. aParentFolder-&gt;AddSubfolder is the normal way</span>
<a href="#l12.69"></a><span id="l12.69" class="difflineplus">+   * to register the subfolders. This method is expected to be synchronous.</span>
<a href="#l12.70"></a><span id="l12.70" class="difflineplus">+   * This shouldn't be confused with server folder discovery, which is allowed</span>
<a href="#l12.71"></a><span id="l12.71" class="difflineplus">+   * to be asynchronous.</span>
<a href="#l12.72"></a><span id="l12.72" class="difflineplus">+   *</span>
<a href="#l12.73"></a><span id="l12.73" class="difflineplus">+   * @param aParentFolder folder whose existing children we want to discover.</span>
<a href="#l12.74"></a><span id="l12.74" class="difflineplus">+   *                      This will be the root folder for the server object.</span>
<a href="#l12.75"></a><span id="l12.75" class="difflineplus">+   * @param aDeep true if we should discover all descendents. Would we ever</span>
<a href="#l12.76"></a><span id="l12.76" class="difflineplus">+   *              not want to do this?</span>
<a href="#l12.77"></a><span id="l12.77" class="difflineplus">+   */</span>
<a href="#l12.78"></a><span id="l12.78" class="difflineplus">+</span>
<a href="#l12.79"></a><span id="l12.79" class="difflineplus">+  void discoverSubFolders(in nsIMsgFolder aParentFolder, in boolean aDeep);</span>
<a href="#l12.80"></a><span id="l12.80" class="difflineplus">+  /**</span>
<a href="#l12.81"></a><span id="l12.81" class="difflineplus">+   * Creates storage for a new, empty folder.</span>
<a href="#l12.82"></a><span id="l12.82" class="difflineplus">+   *</span>
<a href="#l12.83"></a><span id="l12.83" class="difflineplus">+   * @param aParent parent folder</span>
<a href="#l12.84"></a><span id="l12.84" class="difflineplus">+   * @param aFolderName leaf name of folder.</span>
<a href="#l12.85"></a><span id="l12.85" class="difflineplus">+   * @return newly created folder.</span>
<a href="#l12.86"></a><span id="l12.86" class="difflineplus">+   * @exception NS_MSG_FOLDER_EXISTS If the child exists.</span>
<a href="#l12.87"></a><span id="l12.87" class="difflineplus">+   * @exception NS_MSG_CANT_CREATE_FOLDER for other errors.</span>
<a href="#l12.88"></a><span id="l12.88" class="difflineplus">+   */</span>
<a href="#l12.89"></a><span id="l12.89" class="difflineplus">+  nsIMsgFolder createFolder(in nsIMsgFolder aParent, in AString aFolderName);</span>
<a href="#l12.90"></a><span id="l12.90" class="difflineplus">+</span>
<a href="#l12.91"></a><span id="l12.91" class="difflineplus">+  /**</span>
<a href="#l12.92"></a><span id="l12.92" class="difflineplus">+   * Get an nsILocalFile corresponding to the .msf file. This allows stores</span>
<a href="#l12.93"></a><span id="l12.93" class="difflineplus">+   * to put the .msf files where they want.</span>
<a href="#l12.94"></a><span id="l12.94" class="difflineplus">+   *</span>
<a href="#l12.95"></a><span id="l12.95" class="difflineplus">+   * @param aFolder folder we want summary file for</span>
<a href="#l12.96"></a><span id="l12.96" class="difflineplus">+   * @return summary file</span>
<a href="#l12.97"></a><span id="l12.97" class="difflineplus">+   */</span>
<a href="#l12.98"></a><span id="l12.98" class="difflineplus">+  nsILocalFile getSummaryFile(in nsIMsgFolder aFolder);</span>
<a href="#l12.99"></a><span id="l12.99" class="difflineplus">+</span>
<a href="#l12.100"></a><span id="l12.100" class="difflineplus">+  /**</span>
<a href="#l12.101"></a><span id="l12.101" class="difflineplus">+   * Delete the passed in folder. This is a real delete, not a move</span>
<a href="#l12.102"></a><span id="l12.102" class="difflineplus">+   * to the trash folder.</span>
<a href="#l12.103"></a><span id="l12.103" class="difflineplus">+   *</span>
<a href="#l12.104"></a><span id="l12.104" class="difflineplus">+   * @param aFolder folder to delete</span>
<a href="#l12.105"></a><span id="l12.105" class="difflineplus">+   */</span>
<a href="#l12.106"></a><span id="l12.106" class="difflineplus">+  void deleteFolder(in nsIMsgFolder aFolder);</span>
<a href="#l12.107"></a><span id="l12.107" class="difflineplus">+</span>
<a href="#l12.108"></a><span id="l12.108" class="difflineplus">+  /**</span>
<a href="#l12.109"></a><span id="l12.109" class="difflineplus">+   * Rename storage for an existing folder.</span>
<a href="#l12.110"></a><span id="l12.110" class="difflineplus">+   *</span>
<a href="#l12.111"></a><span id="l12.111" class="difflineplus">+   * @param aFolder folder to rename</span>
<a href="#l12.112"></a><span id="l12.112" class="difflineplus">+   * @param aNewName name to give new folder</span>
<a href="#l12.113"></a><span id="l12.113" class="difflineplus">+   * @return the renamed folder object</span>
<a href="#l12.114"></a><span id="l12.114" class="difflineplus">+   */</span>
<a href="#l12.115"></a><span id="l12.115" class="difflineplus">+  nsIMsgFolder renameFolder(in nsIMsgFolder aFolder, in AString aNewName);</span>
<a href="#l12.116"></a><span id="l12.116" class="difflineplus">+</span>
<a href="#l12.117"></a><span id="l12.117" class="difflineplus">+  /**</span>
<a href="#l12.118"></a><span id="l12.118" class="difflineplus">+   * Tells if the store has the requested amount of space available in the</span>
<a href="#l12.119"></a><span id="l12.119" class="difflineplus">+   * specified folder.</span>
<a href="#l12.120"></a><span id="l12.120" class="difflineplus">+   *</span>
<a href="#l12.121"></a><span id="l12.121" class="difflineplus">+   * @param aFolder folder we want to add messages to.</span>
<a href="#l12.122"></a><span id="l12.122" class="difflineplus">+   * @param aSpaceRequested How many bytes we're trying to add to the store.</span>
<a href="#l12.123"></a><span id="l12.123" class="difflineplus">+   */</span>
<a href="#l12.124"></a><span id="l12.124" class="difflineplus">+  boolean hasSpaceAvailable(in nsIMsgFolder aFolder,</span>
<a href="#l12.125"></a><span id="l12.125" class="difflineplus">+                            in long long aSpaceRequested);</span>
<a href="#l12.126"></a><span id="l12.126" class="difflineplus">+</span>
<a href="#l12.127"></a><span id="l12.127" class="difflineplus">+  /**</span>
<a href="#l12.128"></a><span id="l12.128" class="difflineplus">+   * Move/Copy a folder to a new parent folder. This method is asynchronous.</span>
<a href="#l12.129"></a><span id="l12.129" class="difflineplus">+   * The store needs to use the aListener to notify the core code of the</span>
<a href="#l12.130"></a><span id="l12.130" class="difflineplus">+   * completion of the operation. And it must send the appropriate</span>
<a href="#l12.131"></a><span id="l12.131" class="difflineplus">+   * nsIMsgFolderNotificationService notifications.</span>
<a href="#l12.132"></a><span id="l12.132" class="difflineplus">+   *</span>
<a href="#l12.133"></a><span id="l12.133" class="difflineplus">+   * @param aSrcFolder folder to move/copy</span>
<a href="#l12.134"></a><span id="l12.134" class="difflineplus">+   * @param aDstFolder parent dest folder</span>
<a href="#l12.135"></a><span id="l12.135" class="difflineplus">+   * @param aIsMoveFolder true if move, false if copy. If move, source folder</span>
<a href="#l12.136"></a><span id="l12.136" class="difflineplus">+   *                      is deleted when copy completes.</span>
<a href="#l12.137"></a><span id="l12.137" class="difflineplus">+   * @param aMsgWindow used to display progress, may be null</span>
<a href="#l12.138"></a><span id="l12.138" class="difflineplus">+   * @param aListener - used to get notification when copy is done.</span>
<a href="#l12.139"></a><span id="l12.139" class="difflineplus">+   */</span>
<a href="#l12.140"></a><span id="l12.140" class="difflineplus">+  void copyFolder(in nsIMsgFolder aSrcFolder, in nsIMsgFolder aDstFolder,</span>
<a href="#l12.141"></a><span id="l12.141" class="difflineplus">+                  in boolean aIsMoveFolder, in nsIMsgWindow aMsgWindow,</span>
<a href="#l12.142"></a><span id="l12.142" class="difflineplus">+                  in nsIMsgCopyServiceListener aListener);</span>
<a href="#l12.143"></a><span id="l12.143" class="difflineplus">+</span>
<a href="#l12.144"></a><span id="l12.144" class="difflineplus">+  /**</span>
<a href="#l12.145"></a><span id="l12.145" class="difflineplus">+   * Get an output stream for a message in a folder.</span>
<a href="#l12.146"></a><span id="l12.146" class="difflineplus">+   *</span>
<a href="#l12.147"></a><span id="l12.147" class="difflineplus">+   * @param aFolder folder to create a message output stream for.</span>
<a href="#l12.148"></a><span id="l12.148" class="difflineplus">+   * @param aNewHdr If aNewHdr is set on input, then this is probably for</span>
<a href="#l12.149"></a><span id="l12.149" class="difflineplus">+   *                offline storage of an existing message. If null, the</span>
<a href="#l12.150"></a><span id="l12.150" class="difflineplus">+   *                this is a newly downloaded message and the store needs</span>
<a href="#l12.151"></a><span id="l12.151" class="difflineplus">+   *                to create a new header for the new message. If the db</span>
<a href="#l12.152"></a><span id="l12.152" class="difflineplus">+   *                is invalid, this can be null. But if the db is valid,</span>
<a href="#l12.153"></a><span id="l12.153" class="difflineplus">+   *                the store should create a message header with the right</span>
<a href="#l12.154"></a><span id="l12.154" class="difflineplus">+   *                message key, or whatever other property it needs to set to</span>
<a href="#l12.155"></a><span id="l12.155" class="difflineplus">+   *                be able to retrieve the message contents later. If the store</span>
<a href="#l12.156"></a><span id="l12.156" class="difflineplus">+   *                needs to base any of this on the contents of the message,</span>
<a href="#l12.157"></a><span id="l12.157" class="difflineplus">+   *                it will need remember the message header and hook into</span>
<a href="#l12.158"></a><span id="l12.158" class="difflineplus">+   *                the output stream somehow to alter the message header.</span>
<a href="#l12.159"></a><span id="l12.159" class="difflineplus">+   * @param aReusable set to true on output if the caller can reuse the</span>
<a href="#l12.160"></a><span id="l12.160" class="difflineplus">+   *                  stream for multiple messages, e.g., mbox format.</span>
<a href="#l12.161"></a><span id="l12.161" class="difflineplus">+   *                  This means the caller will likely get the same stream</span>
<a href="#l12.162"></a><span id="l12.162" class="difflineplus">+   *                  back on multiple calls to this method, and shouldn't</span>
<a href="#l12.163"></a><span id="l12.163" class="difflineplus">+   *                  close the stream in between calls if they want reuse.</span>
<a href="#l12.164"></a><span id="l12.164" class="difflineplus">+   *</span>
<a href="#l12.165"></a><span id="l12.165" class="difflineplus">+   * @return The output stream to write to. The output stream will be positioned</span>
<a href="#l12.166"></a><span id="l12.166" class="difflineplus">+   *         for writing (e.g., for berkeley mailbox, it will be at the end).</span>
<a href="#l12.167"></a><span id="l12.167" class="difflineplus">+   */</span>
<a href="#l12.168"></a><span id="l12.168" class="difflineplus">+  nsIOutputStream getNewMsgOutputStream(in nsIMsgFolder aFolder,</span>
<a href="#l12.169"></a><span id="l12.169" class="difflineplus">+                                        inout nsIMsgDBHdr aNewHdr,</span>
<a href="#l12.170"></a><span id="l12.170" class="difflineplus">+                                        out boolean aReusable);</span>
<a href="#l12.171"></a><span id="l12.171" class="difflineplus">+</span>
<a href="#l12.172"></a><span id="l12.172" class="difflineplus">+  /**</span>
<a href="#l12.173"></a><span id="l12.173" class="difflineplus">+   * Called when the current message is discarded, e.g., it is moved</span>
<a href="#l12.174"></a><span id="l12.174" class="difflineplus">+   * to an other folder as a filter action, or is deleted because it's</span>
<a href="#l12.175"></a><span id="l12.175" class="difflineplus">+   * a duplicate. This gives the berkeley mailbox store a chance to simply</span>
<a href="#l12.176"></a><span id="l12.176" class="difflineplus">+   * truncate the Inbox w/o leaving a deleted message in the store.</span>
<a href="#l12.177"></a><span id="l12.177" class="difflineplus">+   *</span>
<a href="#l12.178"></a><span id="l12.178" class="difflineplus">+   * @param aOutputStream stream we were writing the message to be discarded to</span>
<a href="#l12.179"></a><span id="l12.179" class="difflineplus">+   * @param aNewHdr header of message to discard</span>
<a href="#l12.180"></a><span id="l12.180" class="difflineplus">+   */</span>
<a href="#l12.181"></a><span id="l12.181" class="difflineplus">+  void discardNewMessage(in nsIOutputStream aOutputStream,</span>
<a href="#l12.182"></a><span id="l12.182" class="difflineplus">+                         in nsIMsgDBHdr aNewHdr);</span>
<a href="#l12.183"></a><span id="l12.183" class="difflineplus">+</span>
<a href="#l12.184"></a><span id="l12.184" class="difflineplus">+  /**</span>
<a href="#l12.185"></a><span id="l12.185" class="difflineplus">+   * Must be called by code that calls getNewMsgOutputStream to finish</span>
<a href="#l12.186"></a><span id="l12.186" class="difflineplus">+   * the process of storing a new message, if the new msg has not been</span>
<a href="#l12.187"></a><span id="l12.187" class="difflineplus">+   * discarded. Could/should this be combined with discardNewMessage?</span>
<a href="#l12.188"></a><span id="l12.188" class="difflineplus">+   *</span>
<a href="#l12.189"></a><span id="l12.189" class="difflineplus">+   * @param aOutputStream stream we were writing the message to.</span>
<a href="#l12.190"></a><span id="l12.190" class="difflineplus">+   * @param aNewHdr header of message finished.</span>
<a href="#l12.191"></a><span id="l12.191" class="difflineplus">+   */</span>
<a href="#l12.192"></a><span id="l12.192" class="difflineplus">+  void finishNewMessage(in nsIOutputStream aOutputStream,</span>
<a href="#l12.193"></a><span id="l12.193" class="difflineplus">+                         in nsIMsgDBHdr aNewHdr);</span>
<a href="#l12.194"></a><span id="l12.194" class="difflineplus">+</span>
<a href="#l12.195"></a><span id="l12.195" class="difflineplus">+  /**</span>
<a href="#l12.196"></a><span id="l12.196" class="difflineplus">+   * Called by pop3 message filters when a newly downloaded message is being</span>
<a href="#l12.197"></a><span id="l12.197" class="difflineplus">+   * moved by an incoming filter. This is called before finishNewMessage, and</span>
<a href="#l12.198"></a><span id="l12.198" class="difflineplus">+   * it allows the store to optimize that case.</span>
<a href="#l12.199"></a><span id="l12.199" class="difflineplus">+   *</span>
<a href="#l12.200"></a><span id="l12.200" class="difflineplus">+   * @param aNewHdr msg hdr of message being moved.</span>
<a href="#l12.201"></a><span id="l12.201" class="difflineplus">+   * @param aDestFolder folder to move message to, in the same store.</span>
<a href="#l12.202"></a><span id="l12.202" class="difflineplus">+   *</span>
<a href="#l12.203"></a><span id="l12.203" class="difflineplus">+   * @return true if successful, false if the store doesn't want to optimize</span>
<a href="#l12.204"></a><span id="l12.204" class="difflineplus">+   *         this.</span>
<a href="#l12.205"></a><span id="l12.205" class="difflineplus">+   * @exception If the moved failed. values TBD</span>
<a href="#l12.206"></a><span id="l12.206" class="difflineplus">+   */</span>
<a href="#l12.207"></a><span id="l12.207" class="difflineplus">+  boolean moveNewlyDownloadedMessage(in nsIMsgDBHdr aNewHdr,</span>
<a href="#l12.208"></a><span id="l12.208" class="difflineplus">+                                     in nsIMsgFolder aDestFolder);</span>
<a href="#l12.209"></a><span id="l12.209" class="difflineplus">+</span>
<a href="#l12.210"></a><span id="l12.210" class="difflineplus">+  /**</span>
<a href="#l12.211"></a><span id="l12.211" class="difflineplus">+   * Get an input stream that we can read the contents of a message from.</span>
<a href="#l12.212"></a><span id="l12.212" class="difflineplus">+   * If the input stream is reusable, and the caller is going to ask</span>
<a href="#l12.213"></a><span id="l12.213" class="difflineplus">+   * for input streams for other messages in the folder, then the caller</span>
<a href="#l12.214"></a><span id="l12.214" class="difflineplus">+   * should not close the stream until it is done with its messages.</span>
<a href="#l12.215"></a><span id="l12.215" class="difflineplus">+   *</span>
<a href="#l12.216"></a><span id="l12.216" class="difflineplus">+   * @param aMsgFolder Folder containing the message</span>
<a href="#l12.217"></a><span id="l12.217" class="difflineplus">+   * @param aMsgToken token that identifies message. This is store-dependent,</span>
<a href="#l12.218"></a><span id="l12.218" class="difflineplus">+   *                  and must be set as a string property &quot;storeToken&quot; on the</span>
<a href="#l12.219"></a><span id="l12.219" class="difflineplus">+   *                  message hdr by the store when the message is added</span>
<a href="#l12.220"></a><span id="l12.220" class="difflineplus">+   *                  to the store.</span>
<a href="#l12.221"></a><span id="l12.221" class="difflineplus">+   * @param aOffset offset in the returned stream of the message.</span>
<a href="#l12.222"></a><span id="l12.222" class="difflineplus">+   * @param[optional] aHdr msgHdr to use in case storeToken is not set. This is</span>
<a href="#l12.223"></a><span id="l12.223" class="difflineplus">+   *                  for upgrade from existing profiles.</span>
<a href="#l12.224"></a><span id="l12.224" class="difflineplus">+   * @param[optional] aReusable Is the returned stream re-usable for other</span>
<a href="#l12.225"></a><span id="l12.225" class="difflineplus">+   *                            messages' input streams?</span>
<a href="#l12.226"></a><span id="l12.226" class="difflineplus">+   */</span>
<a href="#l12.227"></a><span id="l12.227" class="difflineplus">+  nsIInputStream getMsgInputStream(in nsIMsgFolder aFolder,</span>
<a href="#l12.228"></a><span id="l12.228" class="difflineplus">+                                   in ACString aMsgToken,</span>
<a href="#l12.229"></a><span id="l12.229" class="difflineplus">+                                   out long long aOffset,</span>
<a href="#l12.230"></a><span id="l12.230" class="difflineplus">+                                   [optional] in nsIMsgDBHdr aHdr,</span>
<a href="#l12.231"></a><span id="l12.231" class="difflineplus">+                                   [optional] out boolean aReusable);</span>
<a href="#l12.232"></a><span id="l12.232" class="difflineplus">+</span>
<a href="#l12.233"></a><span id="l12.233" class="difflineplus">+  /**</span>
<a href="#l12.234"></a><span id="l12.234" class="difflineplus">+   * Delete the passed in messages. These message should all be in the</span>
<a href="#l12.235"></a><span id="l12.235" class="difflineplus">+   * same folder.</span>
<a href="#l12.236"></a><span id="l12.236" class="difflineplus">+   * @param aHdrArray array of nsIMsgDBHdr's.</span>
<a href="#l12.237"></a><span id="l12.237" class="difflineplus">+   */</span>
<a href="#l12.238"></a><span id="l12.238" class="difflineplus">+  void deleteMessages(in nsIArray aHdrArray);</span>
<a href="#l12.239"></a><span id="l12.239" class="difflineplus">+</span>
<a href="#l12.240"></a><span id="l12.240" class="difflineplus">+  /**</span>
<a href="#l12.241"></a><span id="l12.241" class="difflineplus">+   * This allows the store to handle a msg move/copy if it wants. This lets</span>
<a href="#l12.242"></a><span id="l12.242" class="difflineplus">+   * it optimize move/copies within the same store. E.g., for maildir, a</span>
<a href="#l12.243"></a><span id="l12.243" class="difflineplus">+   * msg move mostly entails moving the file containing the message, and</span>
<a href="#l12.244"></a><span id="l12.244" class="difflineplus">+   * updating the db. If the store does not want to implement this, the core</span>
<a href="#l12.245"></a><span id="l12.245" class="difflineplus">+   * code will use getMsgInputStream on the source message,</span>
<a href="#l12.246"></a><span id="l12.246" class="difflineplus">+   * getNewMsgOutputStream for the dest message, and stream the input to</span>
<a href="#l12.247"></a><span id="l12.247" class="difflineplus">+   * the output. This operation can be asynchronous.</span>
<a href="#l12.248"></a><span id="l12.248" class="difflineplus">+   * If the store does the copy, it must add the appropriate undo action,</span>
<a href="#l12.249"></a><span id="l12.249" class="difflineplus">+   * which can be store dependent. And it must send the appropriate</span>
<a href="#l12.250"></a><span id="l12.250" class="difflineplus">+   * nsIMsgFolderNotificationService notifications.</span>
<a href="#l12.251"></a><span id="l12.251" class="difflineplus">+   *</span>
<a href="#l12.252"></a><span id="l12.252" class="difflineplus">+   * @param isMove true if this is a move, false if it is a copy.</span>
<a href="#l12.253"></a><span id="l12.253" class="difflineplus">+   * @param aHdrArray array of nsIMsgDBHdr's, all in the same folder</span>
<a href="#l12.254"></a><span id="l12.254" class="difflineplus">+   * @param aDstFolder folder to move/copy the messages to.</span>
<a href="#l12.255"></a><span id="l12.255" class="difflineplus">+   * @param aListener listener to notify of copy status.</span>
<a href="#l12.256"></a><span id="l12.256" class="difflineplus">+   * @return true if messages were copied, false if the core code should</span>
<a href="#l12.257"></a><span id="l12.257" class="difflineplus">+   *         do the copy.</span>
<a href="#l12.258"></a><span id="l12.258" class="difflineplus">+   */</span>
<a href="#l12.259"></a><span id="l12.259" class="difflineplus">+  boolean copyMessages(in boolean isMove,</span>
<a href="#l12.260"></a><span id="l12.260" class="difflineplus">+                       in nsIArray aHdrArray,</span>
<a href="#l12.261"></a><span id="l12.261" class="difflineplus">+                       in nsIMsgFolder aDstFolder,</span>
<a href="#l12.262"></a><span id="l12.262" class="difflineplus">+                       in nsIMsgCopyServiceListener aListener);</span>
<a href="#l12.263"></a><span id="l12.263" class="difflineplus">+</span>
<a href="#l12.264"></a><span id="l12.264" class="difflineplus">+  /**</span>
<a href="#l12.265"></a><span id="l12.265" class="difflineplus">+   * Does this store require compaction? For example, maildir doesn't require</span>
<a href="#l12.266"></a><span id="l12.266" class="difflineplus">+   * compaction at all. Berkeley mailbox does. A sqlite store probably doesn't.</span>
<a href="#l12.267"></a><span id="l12.267" class="difflineplus">+   * This is a static property of the store. It doesn't mean that any particular</span>
<a href="#l12.268"></a><span id="l12.268" class="difflineplus">+   * folder has space that can be reclaimed via compaction. Right now, the core</span>
<a href="#l12.269"></a><span id="l12.269" class="difflineplus">+   * code keeps track of the size of messages deleted, which it can use in</span>
<a href="#l12.270"></a><span id="l12.270" class="difflineplus">+   * conjunction with this store attribute.</span>
<a href="#l12.271"></a><span id="l12.271" class="difflineplus">+   */</span>
<a href="#l12.272"></a><span id="l12.272" class="difflineplus">+  readonly attribute boolean supportsCompaction;</span>
<a href="#l12.273"></a><span id="l12.273" class="difflineplus">+</span>
<a href="#l12.274"></a><span id="l12.274" class="difflineplus">+  /**</span>
<a href="#l12.275"></a><span id="l12.275" class="difflineplus">+   * Remove deleted messages from the store, reclaiming space. Some stores</span>
<a href="#l12.276"></a><span id="l12.276" class="difflineplus">+   * won't need to do anything here (e.g., maildir), and those stores</span>
<a href="#l12.277"></a><span id="l12.277" class="difflineplus">+   * should return false for needsCompaction. This operation is asynchronous,</span>
<a href="#l12.278"></a><span id="l12.278" class="difflineplus">+   * and the passed url listener should be called when the operation is done.</span>
<a href="#l12.279"></a><span id="l12.279" class="difflineplus">+   *</span>
<a href="#l12.280"></a><span id="l12.280" class="difflineplus">+   * @param aFolder folder whose storage is to be compacted</span>
<a href="#l12.281"></a><span id="l12.281" class="difflineplus">+   * @param aListener listener notified when compaction is done.</span>
<a href="#l12.282"></a><span id="l12.282" class="difflineplus">+   * @param aMsgWindow window to display progress/status in.</span>
<a href="#l12.283"></a><span id="l12.283" class="difflineplus">+   */</span>
<a href="#l12.284"></a><span id="l12.284" class="difflineplus">+  void compactFolder(in nsIMsgFolder aFolder, in nsIUrlListener aListener,</span>
<a href="#l12.285"></a><span id="l12.285" class="difflineplus">+                     in nsIMsgWindow aMsgWindow);</span>
<a href="#l12.286"></a><span id="l12.286" class="difflineplus">+</span>
<a href="#l12.287"></a><span id="l12.287" class="difflineplus">+  /**</span>
<a href="#l12.288"></a><span id="l12.288" class="difflineplus">+   * Is the summary file for the passed folder valid? For Berkeley Mailboxes,</span>
<a href="#l12.289"></a><span id="l12.289" class="difflineplus">+   * for local mail folders, this checks the timestamp and size of the local</span>
<a href="#l12.290"></a><span id="l12.290" class="difflineplus">+   * mail folder against values stored in the db. For other stores, this may</span>
<a href="#l12.291"></a><span id="l12.291" class="difflineplus">+   * be a noop, though other stores could certainly become invalid. For</span>
<a href="#l12.292"></a><span id="l12.292" class="difflineplus">+   * Berkeley Mailboxes, this is to deal with the case of other apps altering</span>
<a href="#l12.293"></a><span id="l12.293" class="difflineplus">+   * mailboxes from outside mailnews code, and this is certainly possible</span>
<a href="#l12.294"></a><span id="l12.294" class="difflineplus">+   * with other stores.</span>
<a href="#l12.295"></a><span id="l12.295" class="difflineplus">+   *</span>
<a href="#l12.296"></a><span id="l12.296" class="difflineplus">+   * @param aFolder Folder to check if summary is valid for.</span>
<a href="#l12.297"></a><span id="l12.297" class="difflineplus">+   * @param aDB DB to check validity of.</span>
<a href="#l12.298"></a><span id="l12.298" class="difflineplus">+   *</span>
<a href="#l12.299"></a><span id="l12.299" class="difflineplus">+   * @return return true if the summary file is valid, false otherwise.</span>
<a href="#l12.300"></a><span id="l12.300" class="difflineplus">+   */</span>
<a href="#l12.301"></a><span id="l12.301" class="difflineplus">+  boolean isSummaryFileValid(in nsIMsgFolder aFolder, in nsIMsgDatabase aDB);</span>
<a href="#l12.302"></a><span id="l12.302" class="difflineplus">+</span>
<a href="#l12.303"></a><span id="l12.303" class="difflineplus">+  /**</span>
<a href="#l12.304"></a><span id="l12.304" class="difflineplus">+   * Marks the summary file for aFolder as valid or invalid. This method</span>
<a href="#l12.305"></a><span id="l12.305" class="difflineplus">+   * may not be required, since it's really used by Berkeley Mailbox code</span>
<a href="#l12.306"></a><span id="l12.306" class="difflineplus">+   * to fix the timestamp and size for a folder.</span>
<a href="#l12.307"></a><span id="l12.307" class="difflineplus">+   *</span>
<a href="#l12.308"></a><span id="l12.308" class="difflineplus">+   * @param aFolder folder whose summary file should be marked (in)valid.</span>
<a href="#l12.309"></a><span id="l12.309" class="difflineplus">+   * @param aDB db to mark valid (may not be the folder's db in odd cases</span>
<a href="#l12.310"></a><span id="l12.310" class="difflineplus">+   *            like folder compaction.</span>
<a href="#l12.311"></a><span id="l12.311" class="difflineplus">+   * @param aValid whether to mark it valid or invalid.</span>
<a href="#l12.312"></a><span id="l12.312" class="difflineplus">+   */</span>
<a href="#l12.313"></a><span id="l12.313" class="difflineplus">+  void setSummaryFileValid(in nsIMsgFolder aFolder, in nsIMsgDatabase aDB,</span>
<a href="#l12.314"></a><span id="l12.314" class="difflineplus">+                           in boolean aValid);</span>
<a href="#l12.315"></a><span id="l12.315" class="difflineplus">+</span>
<a href="#l12.316"></a><span id="l12.316" class="difflineplus">+  /**</span>
<a href="#l12.317"></a><span id="l12.317" class="difflineplus">+   * Rebuild the index from information in the store. This involves creating</span>
<a href="#l12.318"></a><span id="l12.318" class="difflineplus">+   * a new nsIMsgDatabase for the folder, adding the information for all the</span>
<a href="#l12.319"></a><span id="l12.319" class="difflineplus">+   * messages in the store, and then copying the new msg database over the</span>
<a href="#l12.320"></a><span id="l12.320" class="difflineplus">+   * existing database. For Berkeley mailbox, we try to maintain meta data</span>
<a href="#l12.321"></a><span id="l12.321" class="difflineplus">+   * stored in the existing database when possible, and other stores should do</span>
<a href="#l12.322"></a><span id="l12.322" class="difflineplus">+   * the same. Ideally, I would figure out a way of making that easy. That</span>
<a href="#l12.323"></a><span id="l12.323" class="difflineplus">+   * might entail reworking the rebuild index process into one where the store</span>
<a href="#l12.324"></a><span id="l12.324" class="difflineplus">+   * would iterate over the messages, and stream each message through the</span>
<a href="#l12.325"></a><span id="l12.325" class="difflineplus">+   * message parser, and the common code would handle maintaining the</span>
<a href="#l12.326"></a><span id="l12.326" class="difflineplus">+   * meta data. But the berkeley mailbox code needs to do some parsing because</span>
<a href="#l12.327"></a><span id="l12.327" class="difflineplus">+   * it doesn't know how big the message is (i.e., the stream can't simply be</span>
<a href="#l12.328"></a><span id="l12.328" class="difflineplus">+   * a file stream).</span>
<a href="#l12.329"></a><span id="l12.329" class="difflineplus">+   * This operation is asynchronous,</span>
<a href="#l12.330"></a><span id="l12.330" class="difflineplus">+   * and the passed url listener should be called when the operation is done.</span>
<a href="#l12.331"></a><span id="l12.331" class="difflineplus">+   *</span>
<a href="#l12.332"></a><span id="l12.332" class="difflineplus">+   * @param aFolder folder whose storage is to be compacted</span>
<a href="#l12.333"></a><span id="l12.333" class="difflineplus">+   * @param aMsgDB db to put parsed headers in.</span>
<a href="#l12.334"></a><span id="l12.334" class="difflineplus">+   * @param aMsgWindow msgWindow to use for progress updates.</span>
<a href="#l12.335"></a><span id="l12.335" class="difflineplus">+   * @param aListener listener notified when the index is rebuilt.</span>
<a href="#l12.336"></a><span id="l12.336" class="difflineplus">+   */</span>
<a href="#l12.337"></a><span id="l12.337" class="difflineplus">+  void rebuildIndex(in nsIMsgFolder aFolder, in nsIMsgDatabase aMsgDB,</span>
<a href="#l12.338"></a><span id="l12.338" class="difflineplus">+                    in nsIMsgWindow aMsgWindow, in nsIUrlListener aListener);</span>
<a href="#l12.339"></a><span id="l12.339" class="difflineplus">+</span>
<a href="#l12.340"></a><span id="l12.340" class="difflineplus">+  /**</span>
<a href="#l12.341"></a><span id="l12.341" class="difflineplus">+   * Sets/Clears the passed flags on the passed messages.</span>
<a href="#l12.342"></a><span id="l12.342" class="difflineplus">+   * @param aHdrArray array of nsIMsgDBHdr's</span>
<a href="#l12.343"></a><span id="l12.343" class="difflineplus">+   * @param aFlags flags to set/clear</span>
<a href="#l12.344"></a><span id="l12.344" class="difflineplus">+   * @param aSet true to set the flag(s), false to clear.</span>
<a href="#l12.345"></a><span id="l12.345" class="difflineplus">+   */</span>
<a href="#l12.346"></a><span id="l12.346" class="difflineplus">+  void changeFlags(in nsIArray aHdrArray, in unsigned long aFlags,</span>
<a href="#l12.347"></a><span id="l12.347" class="difflineplus">+                   in boolean aSet);</span>
<a href="#l12.348"></a><span id="l12.348" class="difflineplus">+  /**</span>
<a href="#l12.349"></a><span id="l12.349" class="difflineplus">+   *Sets/Clears the passed keywords on the passed messages.</span>
<a href="#l12.350"></a><span id="l12.350" class="difflineplus">+   * @param aHdrArray array of nsIMsgDBHdr's</span>
<a href="#l12.351"></a><span id="l12.351" class="difflineplus">+   * @param aKeywords keywords to set/clear</span>
<a href="#l12.352"></a><span id="l12.352" class="difflineplus">+   * @param aAdd true to add the keyword(s), false to remove.</span>
<a href="#l12.353"></a><span id="l12.353" class="difflineplus">+   */</span>
<a href="#l12.354"></a><span id="l12.354" class="difflineplus">+  void changeKeywords(in nsIArray aHdrArray, in ACString aKeywords,</span>
<a href="#l12.355"></a><span id="l12.355" class="difflineplus">+                      in boolean aAdd);</span>
<a href="#l12.356"></a><span id="l12.356" class="difflineplus">+};</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l13.1"></a><span id="l13.1" class="difflineminus">--- a/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l13.2"></a><span id="l13.2" class="difflineplus">+++ b/mailnews/base/search/src/nsMsgSearchTerm.cpp</span>
<a href="#l13.3"></a><span id="l13.3" class="difflineat">@@ -71,16 +71,17 @@</span>
<a href="#l13.4"></a><span id="l13.4"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l13.5"></a><span id="l13.5"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l13.6"></a><span id="l13.6"> #include &quot;nsMemory.h&quot;</span>
<a href="#l13.7"></a><span id="l13.7"> #include &lt;ctype.h&gt;</span>
<a href="#l13.8"></a><span id="l13.8"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l13.9"></a><span id="l13.9"> #include &quot;nsIMsgTagService.h&quot;</span>
<a href="#l13.10"></a><span id="l13.10"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l13.11"></a><span id="l13.11"> #include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l13.12"></a><span id="l13.12" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l13.13"></a><span id="l13.13"> #include &quot;nsAbBaseCID.h&quot;</span>
<a href="#l13.14"></a><span id="l13.14"> #include &quot;nsIAbManager.h&quot;</span>
<a href="#l13.15"></a><span id="l13.15"> </span>
<a href="#l13.16"></a><span id="l13.16"> //---------------------------------------------------------------------------</span>
<a href="#l13.17"></a><span id="l13.17"> // nsMsgSearchTerm specifies one criterion, e.g. name contains phil</span>
<a href="#l13.18"></a><span id="l13.18"> //---------------------------------------------------------------------------</span>
<a href="#l13.19"></a><span id="l13.19"> </span>
<a href="#l13.20"></a><span id="l13.20"> </span>
<a href="#l13.21"></a><span id="l13.21" class="difflineat">@@ -1892,35 +1893,19 @@ nsMsgSearchScopeTerm::GetSearchSession(n</span>
<a href="#l13.22"></a><span id="l13.22"> </span>
<a href="#l13.23"></a><span id="l13.23"> NS_IMETHODIMP</span>
<a href="#l13.24"></a><span id="l13.24"> nsMsgSearchScopeTerm::GetInputStream(nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l13.25"></a><span id="l13.25">                                      nsIInputStream **aInputStream)</span>
<a href="#l13.26"></a><span id="l13.26"> {</span>
<a href="#l13.27"></a><span id="l13.27">   NS_ENSURE_ARG_POINTER(aInputStream);</span>
<a href="#l13.28"></a><span id="l13.28">   NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l13.29"></a><span id="l13.29">   NS_ENSURE_TRUE(m_folder, NS_ERROR_NULL_POINTER);</span>
<a href="#l13.30"></a><span id="l13.30" class="difflineminus">-  nsresult rv;</span>
<a href="#l13.31"></a><span id="l13.31" class="difflineminus">-  if (!m_inputStream)</span>
<a href="#l13.32"></a><span id="l13.32" class="difflineminus">-  {</span>
<a href="#l13.33"></a><span id="l13.33" class="difflineminus">-    nsCOMPtr&lt;nsILocalFile&gt; localFile;</span>
<a href="#l13.34"></a><span id="l13.34" class="difflineminus">-    rv = m_folder-&gt;GetFilePath(getter_AddRefs(localFile));</span>
<a href="#l13.35"></a><span id="l13.35" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.36"></a><span id="l13.36" class="difflineminus">-    nsCOMPtr&lt;nsIFileInputStream&gt; fileStream = do_CreateInstance(NS_LOCALFILEINPUTSTREAM_CONTRACTID, &amp;rv);</span>
<a href="#l13.37"></a><span id="l13.37" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.38"></a><span id="l13.38" class="difflineminus">-</span>
<a href="#l13.39"></a><span id="l13.39" class="difflineminus">-    rv = fileStream-&gt;Init(localFile,  PR_RDONLY, 0664, PR_FALSE);  //just have to read the messages</span>
<a href="#l13.40"></a><span id="l13.40" class="difflineminus">-    m_inputStream = do_QueryInterface(fileStream);</span>
<a href="#l13.41"></a><span id="l13.41" class="difflineminus">-  }</span>
<a href="#l13.42"></a><span id="l13.42" class="difflineminus">-  PRUint64 offset;</span>
<a href="#l13.43"></a><span id="l13.43" class="difflineminus">-  aMsgHdr-&gt;GetMessageOffset(&amp;offset);</span>
<a href="#l13.44"></a><span id="l13.44" class="difflineminus">-  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream(do_QueryInterface(m_inputStream));</span>
<a href="#l13.45"></a><span id="l13.45" class="difflineminus">-  if (seekableStream)</span>
<a href="#l13.46"></a><span id="l13.46" class="difflineminus">-    rv = seekableStream-&gt;Seek(PR_SEEK_SET, offset);</span>
<a href="#l13.47"></a><span id="l13.47" class="difflineminus">-  NS_WARN_IF_FALSE(!seekableStream &amp;&amp; offset,</span>
<a href="#l13.48"></a><span id="l13.48" class="difflineminus">-                   &quot;non-zero offset w/ non-seekable stream&quot;);</span>
<a href="#l13.49"></a><span id="l13.49" class="difflineplus">+  bool reusable;</span>
<a href="#l13.50"></a><span id="l13.50" class="difflineplus">+  nsresult rv = m_folder-&gt;GetMsgInputStream(aMsgHdr, &amp;reusable,</span>
<a href="#l13.51"></a><span id="l13.51" class="difflineplus">+                                            getter_AddRefs(m_inputStream));</span>
<a href="#l13.52"></a><span id="l13.52">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l13.53"></a><span id="l13.53">   NS_IF_ADDREF(*aInputStream = m_inputStream);</span>
<a href="#l13.54"></a><span id="l13.54">   return rv;</span>
<a href="#l13.55"></a><span id="l13.55"> }</span>
<a href="#l13.56"></a><span id="l13.56"> </span>
<a href="#l13.57"></a><span id="l13.57"> NS_IMETHODIMP nsMsgSearchScopeTerm::CloseInputStream()</span>
<a href="#l13.58"></a><span id="l13.58"> {</span>
<a href="#l13.59"></a><span id="l13.59">   if (m_inputStream)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l14.1"></a><span id="l14.1" class="difflineminus">--- a/mailnews/base/src/nsCopyMessageStreamListener.cpp</span>
<a href="#l14.2"></a><span id="l14.2" class="difflineplus">+++ b/mailnews/base/src/nsCopyMessageStreamListener.cpp</span>
<a href="#l14.3"></a><span id="l14.3" class="difflineat">@@ -141,52 +141,45 @@ NS_IMETHODIMP nsCopyMessageStreamListene</span>
<a href="#l14.4"></a><span id="l14.4"> 		rv = mDestination-&gt;BeginCopy(message);</span>
<a href="#l14.5"></a><span id="l14.5"> </span>
<a href="#l14.6"></a><span id="l14.6">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.7"></a><span id="l14.7"> 	return rv;</span>
<a href="#l14.8"></a><span id="l14.8"> }</span>
<a href="#l14.9"></a><span id="l14.9"> </span>
<a href="#l14.10"></a><span id="l14.10"> NS_IMETHODIMP nsCopyMessageStreamListener::EndCopy(nsISupports *url, nsresult aStatus)</span>
<a href="#l14.11"></a><span id="l14.11"> {</span>
<a href="#l14.12"></a><span id="l14.12" class="difflineminus">-	nsresult rv = NS_OK;</span>
<a href="#l14.13"></a><span id="l14.13" class="difflineminus">-	nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(url, &amp;rv);</span>
<a href="#l14.14"></a><span id="l14.14" class="difflineplus">+  nsresult rv;</span>
<a href="#l14.15"></a><span id="l14.15" class="difflineplus">+  nsCOMPtr&lt;nsIURI&gt; uri = do_QueryInterface(url, &amp;rv);</span>
<a href="#l14.16"></a><span id="l14.16"> </span>
<a href="#l14.17"></a><span id="l14.17" class="difflineminus">-	if (NS_FAILED(rv)) return rv;</span>
<a href="#l14.18"></a><span id="l14.18" class="difflineminus">-	bool copySucceeded = (aStatus == NS_BINDING_SUCCEEDED);</span>
<a href="#l14.19"></a><span id="l14.19" class="difflineminus">-	rv = mDestination-&gt;EndCopy(copySucceeded);</span>
<a href="#l14.20"></a><span id="l14.20" class="difflineminus">-	//If this is a move and we finished the copy, delete the old message.</span>
<a href="#l14.21"></a><span id="l14.21" class="difflineminus">-	if(NS_SUCCEEDED(rv))</span>
<a href="#l14.22"></a><span id="l14.22" class="difflineminus">-	{</span>
<a href="#l14.23"></a><span id="l14.23" class="difflineminus">-		bool moveMessage = false;</span>
<a href="#l14.24"></a><span id="l14.24" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l14.25"></a><span id="l14.25" class="difflineplus">+  bool copySucceeded = (aStatus == NS_BINDING_SUCCEEDED);</span>
<a href="#l14.26"></a><span id="l14.26" class="difflineplus">+  rv = mDestination-&gt;EndCopy(copySucceeded);</span>
<a href="#l14.27"></a><span id="l14.27" class="difflineplus">+  //If this is a move and we finished the copy, delete the old message.</span>
<a href="#l14.28"></a><span id="l14.28" class="difflineplus">+  bool moveMessage = false;</span>
<a href="#l14.29"></a><span id="l14.29"> </span>
<a href="#l14.30"></a><span id="l14.30" class="difflineminus">-		nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailURL(do_QueryInterface(uri));</span>
<a href="#l14.31"></a><span id="l14.31" class="difflineminus">-		if(mailURL)</span>
<a href="#l14.32"></a><span id="l14.32" class="difflineminus">-			rv = mailURL-&gt;IsUrlType(nsIMsgMailNewsUrl::eMove, &amp;moveMessage);</span>
<a href="#l14.33"></a><span id="l14.33" class="difflineminus">-</span>
<a href="#l14.34"></a><span id="l14.34" class="difflineminus">-		if(NS_FAILED(rv))</span>
<a href="#l14.35"></a><span id="l14.35" class="difflineminus">-			moveMessage = PR_FALSE;</span>
<a href="#l14.36"></a><span id="l14.36" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailURL(do_QueryInterface(uri));</span>
<a href="#l14.37"></a><span id="l14.37" class="difflineplus">+  if (mailURL)</span>
<a href="#l14.38"></a><span id="l14.38" class="difflineplus">+    rv = mailURL-&gt;IsUrlType(nsIMsgMailNewsUrl::eMove, &amp;moveMessage);</span>
<a href="#l14.39"></a><span id="l14.39"> </span>
<a href="#l14.40"></a><span id="l14.40" class="difflineminus">-		// OK, this is wrong if we're moving to an imap folder, for example. This really says that</span>
<a href="#l14.41"></a><span id="l14.41" class="difflineminus">-		// we were able to pull the message from the source, NOT that we were able to</span>
<a href="#l14.42"></a><span id="l14.42" class="difflineminus">-		// put it in the destination!</span>
<a href="#l14.43"></a><span id="l14.43" class="difflineminus">-		if(moveMessage)</span>
<a href="#l14.44"></a><span id="l14.44" class="difflineminus">-		{</span>
<a href="#l14.45"></a><span id="l14.45" class="difflineminus">-			// don't do this if we're moving to an imap folder - that's handled elsewhere.</span>
<a href="#l14.46"></a><span id="l14.46" class="difflineminus">-			nsCOMPtr &lt;nsIMsgImapMailFolder&gt; destImap = do_QueryInterface(mDestination);</span>
<a href="#l14.47"></a><span id="l14.47" class="difflineminus">-			if (!destImap)</span>
<a href="#l14.48"></a><span id="l14.48" class="difflineminus">-			{</span>
<a href="#l14.49"></a><span id="l14.49" class="difflineminus">-        // if the destination is a local folder, it will handle the delete from the source in EndMove</span>
<a href="#l14.50"></a><span id="l14.50" class="difflineminus">-//				rv = DeleteMessage(uri, mSrcFolder);</span>
<a href="#l14.51"></a><span id="l14.51" class="difflineminus">-//				if(NS_SUCCEEDED(rv))</span>
<a href="#l14.52"></a><span id="l14.52" class="difflineminus">-					rv = mDestination-&gt;EndMove(copySucceeded);</span>
<a href="#l14.53"></a><span id="l14.53" class="difflineminus">-			}</span>
<a href="#l14.54"></a><span id="l14.54" class="difflineminus">-		}</span>
<a href="#l14.55"></a><span id="l14.55" class="difflineminus">-	}</span>
<a href="#l14.56"></a><span id="l14.56" class="difflineminus">-	//Even if the above actions failed we probably still want to return NS_OK.  There should probably</span>
<a href="#l14.57"></a><span id="l14.57" class="difflineminus">-	//be some error dialog if either the copy or delete failed.</span>
<a href="#l14.58"></a><span id="l14.58" class="difflineminus">-	return NS_OK;</span>
<a href="#l14.59"></a><span id="l14.59" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l14.60"></a><span id="l14.60" class="difflineplus">+    moveMessage = false;</span>
<a href="#l14.61"></a><span id="l14.61" class="difflineplus">+</span>
<a href="#l14.62"></a><span id="l14.62" class="difflineplus">+  // OK, this is wrong if we're moving to an imap folder, for example. This really says that</span>
<a href="#l14.63"></a><span id="l14.63" class="difflineplus">+  // we were able to pull the message from the source, NOT that we were able to</span>
<a href="#l14.64"></a><span id="l14.64" class="difflineplus">+  // put it in the destination!</span>
<a href="#l14.65"></a><span id="l14.65" class="difflineplus">+  if (moveMessage)</span>
<a href="#l14.66"></a><span id="l14.66" class="difflineplus">+  {</span>
<a href="#l14.67"></a><span id="l14.67" class="difflineplus">+    // don't do this if we're moving to an imap folder - that's handled elsewhere.</span>
<a href="#l14.68"></a><span id="l14.68" class="difflineplus">+    nsCOMPtr&lt;nsIMsgImapMailFolder&gt; destImap = do_QueryInterface(mDestination);</span>
<a href="#l14.69"></a><span id="l14.69" class="difflineplus">+      // if the destination is a local folder, it will handle the delete from the source in EndMove</span>
<a href="#l14.70"></a><span id="l14.70" class="difflineplus">+    if (!destImap)</span>
<a href="#l14.71"></a><span id="l14.71" class="difflineplus">+      rv = mDestination-&gt;EndMove(copySucceeded);</span>
<a href="#l14.72"></a><span id="l14.72" class="difflineplus">+  }</span>
<a href="#l14.73"></a><span id="l14.73" class="difflineplus">+  // Even if the above actions failed we probably still want to return NS_OK.</span>
<a href="#l14.74"></a><span id="l14.74" class="difflineplus">+  // There should probably be some error dialog if either the copy or delete failed.</span>
<a href="#l14.75"></a><span id="l14.75" class="difflineplus">+  return NS_OK;</span>
<a href="#l14.76"></a><span id="l14.76"> }</span>
<a href="#l14.77"></a><span id="l14.77"> </span>
<a href="#l14.78"></a><span id="l14.78"> NS_IMETHODIMP nsCopyMessageStreamListener::OnStopRequest(nsIRequest* request, nsISupports *ctxt, nsresult aStatus)</span>
<a href="#l14.79"></a><span id="l14.79"> {</span>
<a href="#l14.80"></a><span id="l14.80">   return EndCopy(ctxt, aStatus);</span>
<a href="#l14.81"></a><span id="l14.81"> }</span>
<a href="#l14.82"></a><span id="l14.82"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l15.1"></a><span id="l15.1" class="difflineminus">--- a/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l15.2"></a><span id="l15.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgAccountManager.cpp</span>
<a href="#l15.3"></a><span id="l15.3" class="difflineat">@@ -434,17 +434,24 @@ nsMsgAccountManager::CreateIncomingServe</span>
<a href="#l15.4"></a><span id="l15.4">   nsCAutoString key;</span>
<a href="#l15.5"></a><span id="l15.5">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l15.6"></a><span id="l15.6">   PRInt32 i = 1;</span>
<a href="#l15.7"></a><span id="l15.7">   do {</span>
<a href="#l15.8"></a><span id="l15.8">     key.AssignLiteral(SERVER_PREFIX);</span>
<a href="#l15.9"></a><span id="l15.9">     key.AppendInt(i++);</span>
<a href="#l15.10"></a><span id="l15.10">     m_incomingServers.Get(key, getter_AddRefs(server));</span>
<a href="#l15.11"></a><span id="l15.11">   } while (server);</span>
<a href="#l15.12"></a><span id="l15.12" class="difflineminus">-  return createKeyedServer(key, username, hostname, type, _retval);</span>
<a href="#l15.13"></a><span id="l15.13" class="difflineplus">+  rv = createKeyedServer(key, username, hostname, type, _retval);</span>
<a href="#l15.14"></a><span id="l15.14" class="difflineplus">+  if (*_retval)</span>
<a href="#l15.15"></a><span id="l15.15" class="difflineplus">+  {</span>
<a href="#l15.16"></a><span id="l15.16" class="difflineplus">+    nsCString defaultStore;</span>
<a href="#l15.17"></a><span id="l15.17" class="difflineplus">+    m_prefs-&gt;GetCharPref(&quot;mail.serverDefaultStoreContractID&quot;, getter_Copies(defaultStore));</span>
<a href="#l15.18"></a><span id="l15.18" class="difflineplus">+    (*_retval)-&gt;SetCharValue(&quot;storeContractID&quot;, defaultStore);</span>
<a href="#l15.19"></a><span id="l15.19" class="difflineplus">+  }</span>
<a href="#l15.20"></a><span id="l15.20" class="difflineplus">+  return rv;</span>
<a href="#l15.21"></a><span id="l15.21"> }</span>
<a href="#l15.22"></a><span id="l15.22"> </span>
<a href="#l15.23"></a><span id="l15.23"> NS_IMETHODIMP</span>
<a href="#l15.24"></a><span id="l15.24"> nsMsgAccountManager::GetIncomingServer(const nsACString&amp; key,</span>
<a href="#l15.25"></a><span id="l15.25">                                        nsIMsgIncomingServer **_retval)</span>
<a href="#l15.26"></a><span id="l15.26"> {</span>
<a href="#l15.27"></a><span id="l15.27">   NS_ENSURE_ARG_POINTER(_retval);</span>
<a href="#l15.28"></a><span id="l15.28">   nsresult rv;</span>
<a href="#l15.29"></a><span id="l15.29" class="difflineat">@@ -3080,17 +3087,20 @@ NS_IMETHODIMP nsMsgAccountManager::LoadV</span>
<a href="#l15.30"></a><span id="l15.30">               {</span>
<a href="#l15.31"></a><span id="l15.31">                 nsAutoString currentFolderNameStr;</span>
<a href="#l15.32"></a><span id="l15.32">                 nsCAutoString currentFolderNameCStr;</span>
<a href="#l15.33"></a><span id="l15.33">                 MsgUnescapeString(nsCString(Substring(buffer, lastSlash + 1, buffer.Length())), 0, currentFolderNameCStr);</span>
<a href="#l15.34"></a><span id="l15.34">                 CopyUTF8toUTF16(currentFolderNameCStr, currentFolderNameStr);</span>
<a href="#l15.35"></a><span id="l15.35">                 nsCOMPtr &lt;nsIMsgFolder&gt; childFolder;</span>
<a href="#l15.36"></a><span id="l15.36">                 nsCOMPtr &lt;nsIMsgDatabase&gt; db;</span>
<a href="#l15.37"></a><span id="l15.37">                 // force db to get created.</span>
<a href="#l15.38"></a><span id="l15.38" class="difflineminus">-                virtualFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l15.39"></a><span id="l15.39" class="difflineplus">+                virtualFolder-&gt;SetParent(parentFolder);</span>
<a href="#l15.40"></a><span id="l15.40" class="difflineplus">+                rv = virtualFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l15.41"></a><span id="l15.41" class="difflineplus">+                if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l15.42"></a><span id="l15.42" class="difflineplus">+                  msgDBService-&gt;CreateNewDB(virtualFolder, getter_AddRefs(db));</span>
<a href="#l15.43"></a><span id="l15.43">                 if (db)</span>
<a href="#l15.44"></a><span id="l15.44">                   rv = db-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l15.45"></a><span id="l15.45">                 else</span>
<a href="#l15.46"></a><span id="l15.46">                   break;</span>
<a href="#l15.47"></a><span id="l15.47"> </span>
<a href="#l15.48"></a><span id="l15.48">                 parentFolder-&gt;AddSubfolder(currentFolderNameStr, getter_AddRefs(childFolder));</span>
<a href="#l15.49"></a><span id="l15.49">                 virtualFolder-&gt;SetFlag(nsMsgFolderFlags::Virtual);</span>
<a href="#l15.50"></a><span id="l15.50">                 if (childFolder)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l16.1"></a><span id="l16.1" class="difflineminus">--- a/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l16.2"></a><span id="l16.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgDBView.cpp</span>
<a href="#l16.3"></a><span id="l16.3" class="difflineat">@@ -3034,58 +3034,68 @@ nsMsgDBView::ApplyCommandToIndices(nsMsg</span>
<a href="#l16.4"></a><span id="l16.4">       nsMsgKey msgKey;</span>
<a href="#l16.5"></a><span id="l16.5">       nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(messages, i);</span>
<a href="#l16.6"></a><span id="l16.6">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l16.7"></a><span id="l16.7">       if (thisIsImapFolder)</span>
<a href="#l16.8"></a><span id="l16.8">         imapUids[i] = msgKey;</span>
<a href="#l16.9"></a><span id="l16.9"> </span>
<a href="#l16.10"></a><span id="l16.10">       switch (command)</span>
<a href="#l16.11"></a><span id="l16.11">       {</span>
<a href="#l16.12"></a><span id="l16.12" class="difflineminus">-      case nsMsgViewCommandType::markMessagesRead:</span>
<a href="#l16.13"></a><span id="l16.13" class="difflineminus">-        rv = msgHdr-&gt;MarkRead(PR_TRUE);</span>
<a href="#l16.14"></a><span id="l16.14" class="difflineminus">-        break;</span>
<a href="#l16.15"></a><span id="l16.15" class="difflineminus">-      case nsMsgViewCommandType::markMessagesUnread:</span>
<a href="#l16.16"></a><span id="l16.16" class="difflineminus">-        rv = msgHdr-&gt;MarkRead(PR_FALSE);</span>
<a href="#l16.17"></a><span id="l16.17" class="difflineminus">-        break;</span>
<a href="#l16.18"></a><span id="l16.18" class="difflineminus">-      case nsMsgViewCommandType::toggleMessageRead:</span>
<a href="#l16.19"></a><span id="l16.19" class="difflineminus">-        {</span>
<a href="#l16.20"></a><span id="l16.20" class="difflineminus">-          PRUint32 msgFlags;</span>
<a href="#l16.21"></a><span id="l16.21" class="difflineminus">-          msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l16.22"></a><span id="l16.22" class="difflineminus">-          msgHdr-&gt;MarkRead(!(msgFlags &amp; nsMsgMessageFlags::Read));</span>
<a href="#l16.23"></a><span id="l16.23" class="difflineminus">-        }</span>
<a href="#l16.24"></a><span id="l16.24" class="difflineminus">-        break;</span>
<a href="#l16.25"></a><span id="l16.25" class="difflineminus">-      case nsMsgViewCommandType::unflagMessages:</span>
<a href="#l16.26"></a><span id="l16.26" class="difflineminus">-      case nsMsgViewCommandType::flagMessages:</span>
<a href="#l16.27"></a><span id="l16.27" class="difflineminus">-        {</span>
<a href="#l16.28"></a><span id="l16.28" class="difflineminus">-          nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l16.29"></a><span id="l16.29" class="difflineminus">-          rv = GetDBForHeader(msgHdr, getter_AddRefs(db));</span>
<a href="#l16.30"></a><span id="l16.30" class="difflineminus">-          NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l16.31"></a><span id="l16.31" class="difflineminus">-          db-&gt;MarkMarked(msgKey, (command == nsMsgViewCommandType::flagMessages), nsnull);</span>
<a href="#l16.32"></a><span id="l16.32" class="difflineminus">-        }</span>
<a href="#l16.33"></a><span id="l16.33" class="difflineminus">-        break;</span>
<a href="#l16.34"></a><span id="l16.34">       case nsMsgViewCommandType::junk:</span>
<a href="#l16.35"></a><span id="l16.35">         mNumMessagesRemainingInBatch++;</span>
<a href="#l16.36"></a><span id="l16.36">         mJunkHdrs-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l16.37"></a><span id="l16.37">         rv = SetMsgHdrJunkStatus(junkPlugin.get(), msgHdr,</span>
<a href="#l16.38"></a><span id="l16.38">                                  nsIJunkMailPlugin::JUNK);</span>
<a href="#l16.39"></a><span id="l16.39">         break;</span>
<a href="#l16.40"></a><span id="l16.40">       case nsMsgViewCommandType::unjunk:</span>
<a href="#l16.41"></a><span id="l16.41">         mNumMessagesRemainingInBatch++;</span>
<a href="#l16.42"></a><span id="l16.42">         mJunkHdrs-&gt;AppendElement(msgHdr, PR_FALSE);</span>
<a href="#l16.43"></a><span id="l16.43">         rv = SetMsgHdrJunkStatus(junkPlugin.get(), msgHdr,</span>
<a href="#l16.44"></a><span id="l16.44">                                  nsIJunkMailPlugin::GOOD);</span>
<a href="#l16.45"></a><span id="l16.45">         break;</span>
<a href="#l16.46"></a><span id="l16.46" class="difflineplus">+      case nsMsgViewCommandType::toggleMessageRead:</span>
<a href="#l16.47"></a><span id="l16.47">       case nsMsgViewCommandType::undeleteMsg:</span>
<a href="#l16.48"></a><span id="l16.48" class="difflineminus">-        break; // this is completely handled in the imap code below.</span>
<a href="#l16.49"></a><span id="l16.49" class="difflineplus">+      case nsMsgViewCommandType::markMessagesRead:</span>
<a href="#l16.50"></a><span id="l16.50" class="difflineplus">+      case nsMsgViewCommandType::markMessagesUnread:</span>
<a href="#l16.51"></a><span id="l16.51" class="difflineplus">+      case nsMsgViewCommandType::unflagMessages:</span>
<a href="#l16.52"></a><span id="l16.52" class="difflineplus">+      case nsMsgViewCommandType::flagMessages:</span>
<a href="#l16.53"></a><span id="l16.53" class="difflineplus">+        break; // this is completely handled in the code below.</span>
<a href="#l16.54"></a><span id="l16.54">       default:</span>
<a href="#l16.55"></a><span id="l16.55" class="difflineminus">-        NS_ASSERTION(PR_FALSE, &quot;unhandled command&quot;);</span>
<a href="#l16.56"></a><span id="l16.56" class="difflineplus">+        NS_ERROR(&quot;unhandled command&quot;);</span>
<a href="#l16.57"></a><span id="l16.57">         break;</span>
<a href="#l16.58"></a><span id="l16.58">       }</span>
<a href="#l16.59"></a><span id="l16.59">     }</span>
<a href="#l16.60"></a><span id="l16.60"> </span>
<a href="#l16.61"></a><span id="l16.61" class="difflineplus">+    switch (command)</span>
<a href="#l16.62"></a><span id="l16.62" class="difflineplus">+    {</span>
<a href="#l16.63"></a><span id="l16.63" class="difflineplus">+      case nsMsgViewCommandType::toggleMessageRead:</span>
<a href="#l16.64"></a><span id="l16.64" class="difflineplus">+      {</span>
<a href="#l16.65"></a><span id="l16.65" class="difflineplus">+        nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(messages, 0);</span>
<a href="#l16.66"></a><span id="l16.66" class="difflineplus">+        if (!msgHdr)</span>
<a href="#l16.67"></a><span id="l16.67" class="difflineplus">+          break;</span>
<a href="#l16.68"></a><span id="l16.68" class="difflineplus">+        PRUint32 msgFlags;</span>
<a href="#l16.69"></a><span id="l16.69" class="difflineplus">+        msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l16.70"></a><span id="l16.70" class="difflineplus">+        folder-&gt;MarkMessagesRead(messages,</span>
<a href="#l16.71"></a><span id="l16.71" class="difflineplus">+                                 !(msgFlags &amp; nsMsgMessageFlags::Read));</span>
<a href="#l16.72"></a><span id="l16.72" class="difflineplus">+      }</span>
<a href="#l16.73"></a><span id="l16.73" class="difflineplus">+        break;</span>
<a href="#l16.74"></a><span id="l16.74" class="difflineplus">+      case nsMsgViewCommandType::markMessagesRead:</span>
<a href="#l16.75"></a><span id="l16.75" class="difflineplus">+      case nsMsgViewCommandType::markMessagesUnread:</span>
<a href="#l16.76"></a><span id="l16.76" class="difflineplus">+        folder-&gt;MarkMessagesRead(messages,</span>
<a href="#l16.77"></a><span id="l16.77" class="difflineplus">+                                 command == nsMsgViewCommandType::markMessagesRead);</span>
<a href="#l16.78"></a><span id="l16.78" class="difflineplus">+        break;</span>
<a href="#l16.79"></a><span id="l16.79" class="difflineplus">+      case nsMsgViewCommandType::unflagMessages:</span>
<a href="#l16.80"></a><span id="l16.80" class="difflineplus">+      case nsMsgViewCommandType::flagMessages:</span>
<a href="#l16.81"></a><span id="l16.81" class="difflineplus">+        folder-&gt;MarkMessagesFlagged(messages,</span>
<a href="#l16.82"></a><span id="l16.82" class="difflineplus">+                                    command == nsMsgViewCommandType::flagMessages);</span>
<a href="#l16.83"></a><span id="l16.83" class="difflineplus">+        break;</span>
<a href="#l16.84"></a><span id="l16.84" class="difflineplus">+      default:</span>
<a href="#l16.85"></a><span id="l16.85" class="difflineplus">+        break;</span>
<a href="#l16.86"></a><span id="l16.86" class="difflineplus">+</span>
<a href="#l16.87"></a><span id="l16.87" class="difflineplus">+    }</span>
<a href="#l16.88"></a><span id="l16.88">     // Provide junk-related batch notifications</span>
<a href="#l16.89"></a><span id="l16.89">     if ((command == nsMsgViewCommandType::junk) &amp;&amp;</span>
<a href="#l16.90"></a><span id="l16.90">         (command == nsMsgViewCommandType::unjunk)) {</span>
<a href="#l16.91"></a><span id="l16.91">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt;</span>
<a href="#l16.92"></a><span id="l16.92">         notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l16.93"></a><span id="l16.93">       if (notifier)</span>
<a href="#l16.94"></a><span id="l16.94">         notifier-&gt;NotifyItemEvent(messages,</span>
<a href="#l16.95"></a><span id="l16.95">                                   NS_LITERAL_CSTRING(&quot;JunkStatusChanged&quot;),</span>
<a href="#l16.96"></a><span id="l16.96" class="difflineat">@@ -3099,36 +3109,19 @@ nsMsgDBView::ApplyCommandToIndices(nsMsg</span>
<a href="#l16.97"></a><span id="l16.97">   if (thisIsImapFolder)</span>
<a href="#l16.98"></a><span id="l16.98">   {</span>
<a href="#l16.99"></a><span id="l16.99">     imapMessageFlagsType flags = kNoImapMsgFlag;</span>
<a href="#l16.100"></a><span id="l16.100">     bool addFlags = false;</span>
<a href="#l16.101"></a><span id="l16.101">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(mMsgWindowWeak));</span>
<a href="#l16.102"></a><span id="l16.102">     switch (command)</span>
<a href="#l16.103"></a><span id="l16.103">     {</span>
<a href="#l16.104"></a><span id="l16.104">     case nsMsgViewCommandType::markThreadRead:</span>
<a href="#l16.105"></a><span id="l16.105" class="difflineminus">-    case nsMsgViewCommandType::markMessagesRead:</span>
<a href="#l16.106"></a><span id="l16.106">       flags |= kImapMsgSeenFlag;</span>
<a href="#l16.107"></a><span id="l16.107">       addFlags = PR_TRUE;</span>
<a href="#l16.108"></a><span id="l16.108">       break;</span>
<a href="#l16.109"></a><span id="l16.109" class="difflineminus">-    case nsMsgViewCommandType::markMessagesUnread:</span>
<a href="#l16.110"></a><span id="l16.110" class="difflineminus">-      flags |= kImapMsgSeenFlag;</span>
<a href="#l16.111"></a><span id="l16.111" class="difflineminus">-      addFlags = PR_FALSE;</span>
<a href="#l16.112"></a><span id="l16.112" class="difflineminus">-      break;</span>
<a href="#l16.113"></a><span id="l16.113" class="difflineminus">-    case nsMsgViewCommandType::toggleMessageRead:</span>
<a href="#l16.114"></a><span id="l16.114" class="difflineminus">-      flags |= kImapMsgSeenFlag;</span>
<a href="#l16.115"></a><span id="l16.115" class="difflineminus">-      addFlags = m_flags[indices[0]] &amp; nsMsgMessageFlags::Read;</span>
<a href="#l16.116"></a><span id="l16.116" class="difflineminus">-      break;</span>
<a href="#l16.117"></a><span id="l16.117" class="difflineminus">-    case nsMsgViewCommandType::flagMessages:</span>
<a href="#l16.118"></a><span id="l16.118" class="difflineminus">-      flags |= kImapMsgFlaggedFlag;</span>
<a href="#l16.119"></a><span id="l16.119" class="difflineminus">-      addFlags = PR_TRUE;</span>
<a href="#l16.120"></a><span id="l16.120" class="difflineminus">-      break;</span>
<a href="#l16.121"></a><span id="l16.121" class="difflineminus">-    case nsMsgViewCommandType::unflagMessages:</span>
<a href="#l16.122"></a><span id="l16.122" class="difflineminus">-      flags |= kImapMsgFlaggedFlag;</span>
<a href="#l16.123"></a><span id="l16.123" class="difflineminus">-      addFlags = PR_FALSE;</span>
<a href="#l16.124"></a><span id="l16.124" class="difflineminus">-      break;</span>
<a href="#l16.125"></a><span id="l16.125">     case nsMsgViewCommandType::undeleteMsg:</span>
<a href="#l16.126"></a><span id="l16.126">       flags = kImapMsgDeletedFlag;</span>
<a href="#l16.127"></a><span id="l16.127">       addFlags = PR_FALSE;</span>
<a href="#l16.128"></a><span id="l16.128">       break;</span>
<a href="#l16.129"></a><span id="l16.129">     case nsMsgViewCommandType::junk:</span>
<a href="#l16.130"></a><span id="l16.130">         return imapFolder-&gt;StoreCustomKeywords(msgWindow,</span>
<a href="#l16.131"></a><span id="l16.131">                     NS_LITERAL_CSTRING(&quot;Junk&quot;),</span>
<a href="#l16.132"></a><span id="l16.132">                     NS_LITERAL_CSTRING(&quot;NonJunk&quot;),</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l17.1"></a><span id="l17.1" class="difflineminus">--- a/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l17.2"></a><span id="l17.2" class="difflineplus">+++ b/mailnews/base/src/nsMsgFolderCompactor.cpp</span>
<a href="#l17.3"></a><span id="l17.3" class="difflineat">@@ -58,16 +58,17 @@</span>
<a href="#l17.4"></a><span id="l17.4"> #include &quot;prprf.h&quot;</span>
<a href="#l17.5"></a><span id="l17.5"> #include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l17.6"></a><span id="l17.6"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l17.7"></a><span id="l17.7"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l17.8"></a><span id="l17.8"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l17.9"></a><span id="l17.9"> #include &quot;nsIMsgStatusFeedback.h&quot;</span>
<a href="#l17.10"></a><span id="l17.10"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l17.11"></a><span id="l17.11"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l17.12"></a><span id="l17.12" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l17.13"></a><span id="l17.13"> #include &quot;nsMsgFolderCompactor.h&quot;</span>
<a href="#l17.14"></a><span id="l17.14"> </span>
<a href="#l17.15"></a><span id="l17.15"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.16"></a><span id="l17.16"> // nsFolderCompactState</span>
<a href="#l17.17"></a><span id="l17.17"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l17.18"></a><span id="l17.18"> </span>
<a href="#l17.19"></a><span id="l17.19"> NS_IMPL_ISUPPORTS5(nsFolderCompactState, nsIMsgFolderCompactor, nsIRequestObserver, nsIStreamListener, nsICopyMessageStreamListener, nsIUrlListener)</span>
<a href="#l17.20"></a><span id="l17.20"> </span>
<a href="#l17.21"></a><span id="l17.21" class="difflineat">@@ -130,33 +131,27 @@ nsresult</span>
<a href="#l17.22"></a><span id="l17.22"> nsFolderCompactState::InitDB(nsIMsgDatabase *db)</span>
<a href="#l17.23"></a><span id="l17.23"> {</span>
<a href="#l17.24"></a><span id="l17.24">   nsCOMPtr&lt;nsIMsgDatabase&gt; mailDBFactory;</span>
<a href="#l17.25"></a><span id="l17.25">   nsresult rv = db-&gt;ListAllKeys(m_keyArray);</span>
<a href="#l17.26"></a><span id="l17.26">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.27"></a><span id="l17.27">   m_size = m_keyArray-&gt;m_keys.Length();</span>
<a href="#l17.28"></a><span id="l17.28"> </span>
<a href="#l17.29"></a><span id="l17.29">   nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l17.30"></a><span id="l17.30" class="difflineminus">-  if (msgDBService) </span>
<a href="#l17.31"></a><span id="l17.31" class="difflineminus">-  {</span>
<a href="#l17.32"></a><span id="l17.32" class="difflineminus">-    nsresult folderOpen = msgDBService-&gt;OpenMailDBFromFile(m_file, PR_TRUE,</span>
<a href="#l17.33"></a><span id="l17.33" class="difflineminus">-                                     PR_FALSE,</span>
<a href="#l17.34"></a><span id="l17.34" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.35"></a><span id="l17.35" class="difflineplus">+  rv = msgDBService-&gt;OpenMailDBFromFile(m_file, m_folder, PR_TRUE, PR_FALSE,</span>
<a href="#l17.36"></a><span id="l17.36">                                      getter_AddRefs(m_db));</span>
<a href="#l17.37"></a><span id="l17.37"> </span>
<a href="#l17.38"></a><span id="l17.38" class="difflineminus">-    if(NS_FAILED(folderOpen) &amp;&amp;</span>
<a href="#l17.39"></a><span id="l17.39" class="difflineminus">-       folderOpen == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE || </span>
<a href="#l17.40"></a><span id="l17.40" class="difflineminus">-       folderOpen == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING )</span>
<a href="#l17.41"></a><span id="l17.41" class="difflineminus">-    {</span>
<a href="#l17.42"></a><span id="l17.42" class="difflineplus">+  if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE ||</span>
<a href="#l17.43"></a><span id="l17.43" class="difflineplus">+      rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l17.44"></a><span id="l17.44">       // if it's out of date then reopen with upgrade.</span>
<a href="#l17.45"></a><span id="l17.45" class="difflineminus">-      rv = msgDBService-&gt;OpenMailDBFromFile(m_file,</span>
<a href="#l17.46"></a><span id="l17.46" class="difflineminus">-                               PR_TRUE, PR_TRUE,</span>
<a href="#l17.47"></a><span id="l17.47" class="difflineplus">+    return msgDBService-&gt;OpenMailDBFromFile(m_file,</span>
<a href="#l17.48"></a><span id="l17.48" class="difflineplus">+                                            m_folder, PR_TRUE, PR_TRUE,</span>
<a href="#l17.49"></a><span id="l17.49">                                getter_AddRefs(m_db));</span>
<a href="#l17.50"></a><span id="l17.50" class="difflineminus">-    }</span>
<a href="#l17.51"></a><span id="l17.51" class="difflineminus">-  }</span>
<a href="#l17.52"></a><span id="l17.52" class="difflineminus">-  return rv;</span>
<a href="#l17.53"></a><span id="l17.53" class="difflineplus">+  return NS_OK;</span>
<a href="#l17.54"></a><span id="l17.54"> }</span>
<a href="#l17.55"></a><span id="l17.55"> </span>
<a href="#l17.56"></a><span id="l17.56"> NS_IMETHODIMP nsFolderCompactState::CompactFolders(nsIArray *aArrayOfFoldersToCompact,</span>
<a href="#l17.57"></a><span id="l17.57">                                                    nsIArray *aOfflineFolderArray,</span>
<a href="#l17.58"></a><span id="l17.58">                                                    nsIUrlListener *aUrlListener,</span>
<a href="#l17.59"></a><span id="l17.59">                                                    nsIMsgWindow *aMsgWindow)</span>
<a href="#l17.60"></a><span id="l17.60"> {</span>
<a href="#l17.61"></a><span id="l17.61">   m_window = aMsgWindow;</span>
<a href="#l17.62"></a><span id="l17.62" class="difflineat">@@ -259,17 +254,16 @@ nsFolderCompactState::Compact(nsIMsgFold</span>
<a href="#l17.63"></a><span id="l17.63">      nsCOMPtr &lt;nsISupports&gt; supports = do_QueryInterface(static_cast&lt;nsIMsgFolderCompactor*&gt;(this));</span>
<a href="#l17.64"></a><span id="l17.64">      m_folder-&gt;AcquireSemaphore(supports);</span>
<a href="#l17.65"></a><span id="l17.65">      return StartCompacting();</span>
<a href="#l17.66"></a><span id="l17.66">    }</span>
<a href="#l17.67"></a><span id="l17.67">    else</span>
<a href="#l17.68"></a><span id="l17.68">    {</span>
<a href="#l17.69"></a><span id="l17.69">      m_folder-&gt;NotifyCompactCompleted();</span>
<a href="#l17.70"></a><span id="l17.70">      m_folder-&gt;ThrowAlertMsg(&quot;compactFolderDeniedLock&quot;, m_window);</span>
<a href="#l17.71"></a><span id="l17.71" class="difflineminus">-     m_db = nsnull;</span>
<a href="#l17.72"></a><span id="l17.72">      CleanupTempFilesAfterError();</span>
<a href="#l17.73"></a><span id="l17.73">      if (m_compactAll)</span>
<a href="#l17.74"></a><span id="l17.74">        return CompactNextFolder();</span>
<a href="#l17.75"></a><span id="l17.75">      else</span>
<a href="#l17.76"></a><span id="l17.76">        return NS_OK;</span>
<a href="#l17.77"></a><span id="l17.77">    }</span>
<a href="#l17.78"></a><span id="l17.78"> }</span>
<a href="#l17.79"></a><span id="l17.79"> </span>
<a href="#l17.80"></a><span id="l17.80" class="difflineat">@@ -364,17 +358,24 @@ NS_IMETHODIMP nsFolderCompactState::OnSt</span>
<a href="#l17.81"></a><span id="l17.81">   {</span>
<a href="#l17.82"></a><span id="l17.82">     CompactCompleted(status);</span>
<a href="#l17.83"></a><span id="l17.83">   }</span>
<a href="#l17.84"></a><span id="l17.84">   return NS_OK;</span>
<a href="#l17.85"></a><span id="l17.85"> }</span>
<a href="#l17.86"></a><span id="l17.86"> </span>
<a href="#l17.87"></a><span id="l17.87"> nsresult nsFolderCompactState::StartCompacting()</span>
<a href="#l17.88"></a><span id="l17.88"> {</span>
<a href="#l17.89"></a><span id="l17.89" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l17.90"></a><span id="l17.90" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l17.91"></a><span id="l17.91" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l17.92"></a><span id="l17.92" class="difflineplus">+  </span>
<a href="#l17.93"></a><span id="l17.93" class="difflineplus">+  nsresult rv = m_folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l17.94"></a><span id="l17.94" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.95"></a><span id="l17.95" class="difflineplus">+  rv = server-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l17.96"></a><span id="l17.96" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.97"></a><span id="l17.97" class="difflineplus">+  </span>
<a href="#l17.98"></a><span id="l17.98">   // Notify that compaction is beginning.  We do this even if there are no</span>
<a href="#l17.99"></a><span id="l17.99">   // messages to be copied because the summary database still gets blown away</span>
<a href="#l17.100"></a><span id="l17.100">   // which is still pretty interesting.  (And we like consistency.)</span>
<a href="#l17.101"></a><span id="l17.101">   nsCOMPtr&lt;nsIMsgFolderNotificationService&gt;</span>
<a href="#l17.102"></a><span id="l17.102">     notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l17.103"></a><span id="l17.103">   if (notifier)</span>
<a href="#l17.104"></a><span id="l17.104">     notifier-&gt;NotifyItemEvent(m_folder,</span>
<a href="#l17.105"></a><span id="l17.105">                               NS_LITERAL_CSTRING(&quot;FolderCompactStart&quot;),</span>
<a href="#l17.106"></a><span id="l17.106" class="difflineat">@@ -429,17 +430,16 @@ nsFolderCompactState::FinishCompact()</span>
<a href="#l17.107"></a><span id="l17.107">   m_fileStream-&gt;Flush();</span>
<a href="#l17.108"></a><span id="l17.108">   m_fileStream-&gt;Close();</span>
<a href="#l17.109"></a><span id="l17.109">   m_fileStream = nsnull;</span>
<a href="#l17.110"></a><span id="l17.110"> </span>
<a href="#l17.111"></a><span id="l17.111">   // make sure the new database is valid.</span>
<a href="#l17.112"></a><span id="l17.112">   // Close it so we can rename the .msf file.</span>
<a href="#l17.113"></a><span id="l17.113">   if (m_db)</span>
<a href="#l17.114"></a><span id="l17.114">   {</span>
<a href="#l17.115"></a><span id="l17.115" class="difflineminus">-    m_db-&gt;SetSummaryValid(PR_TRUE);</span>
<a href="#l17.116"></a><span id="l17.116">     m_db-&gt;ForceClosed();</span>
<a href="#l17.117"></a><span id="l17.117">     m_db = nsnull;</span>
<a href="#l17.118"></a><span id="l17.118">   }</span>
<a href="#l17.119"></a><span id="l17.119"> </span>
<a href="#l17.120"></a><span id="l17.120">   nsCOMPtr &lt;nsILocalFile&gt; newSummaryFile;</span>
<a href="#l17.121"></a><span id="l17.121">   GetSummaryFileLocation(m_file, getter_AddRefs(newSummaryFile));</span>
<a href="#l17.122"></a><span id="l17.122"> </span>
<a href="#l17.123"></a><span id="l17.123">   nsCOMPtr &lt;nsIDBFolderInfo&gt; transferInfo;</span>
<a href="#l17.124"></a><span id="l17.124" class="difflineat">@@ -488,21 +488,26 @@ nsFolderCompactState::FinishCompact()</span>
<a href="#l17.125"></a><span id="l17.125">   if (!folderRenameSucceeded)</span>
<a href="#l17.126"></a><span id="l17.126">     m_file-&gt;Remove(PR_FALSE);</span>
<a href="#l17.127"></a><span id="l17.127">   if (!msfRenameSucceeded)</span>
<a href="#l17.128"></a><span id="l17.128">     newSummaryFile-&gt;Remove(PR_FALSE);</span>
<a href="#l17.129"></a><span id="l17.129">   rv = ReleaseFolderLock();</span>
<a href="#l17.130"></a><span id="l17.130">   NS_ASSERTION(NS_SUCCEEDED(rv),&quot;folder lock not released successfully&quot;);</span>
<a href="#l17.131"></a><span id="l17.131">   if (msfRenameSucceeded &amp;&amp; folderRenameSucceeded)</span>
<a href="#l17.132"></a><span id="l17.132">   {</span>
<a href="#l17.133"></a><span id="l17.133" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l17.134"></a><span id="l17.134" class="difflineplus">+      do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l17.135"></a><span id="l17.135" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l17.136"></a><span id="l17.136" class="difflineplus">+    rv = msgDBService-&gt;OpenFolderDB(m_folder, PR_TRUE, getter_AddRefs(m_db));</span>
<a href="#l17.137"></a><span id="l17.137" class="difflineplus">+    m_db-&gt;SetSummaryValid(PR_TRUE);</span>
<a href="#l17.138"></a><span id="l17.138">     m_folder-&gt;SetDBTransferInfo(transferInfo);</span>
<a href="#l17.139"></a><span id="l17.139"> </span>
<a href="#l17.140"></a><span id="l17.140" class="difflineminus">-    nsCOMPtr &lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l17.141"></a><span id="l17.141" class="difflineplus">+    nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l17.142"></a><span id="l17.142"> </span>
<a href="#l17.143"></a><span id="l17.143" class="difflineminus">-    m_folder-&gt;GetDBFolderInfoAndDB(getter_AddRefs(dbFolderInfo), getter_AddRefs(m_db));</span>
<a href="#l17.144"></a><span id="l17.144" class="difflineplus">+    m_db-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l17.145"></a><span id="l17.145"> </span>
<a href="#l17.146"></a><span id="l17.146">     // since we're transferring info from the old db, we need to reset the expunged bytes,</span>
<a href="#l17.147"></a><span id="l17.147">     // and set the summary valid again.</span>
<a href="#l17.148"></a><span id="l17.148">     if(dbFolderInfo)</span>
<a href="#l17.149"></a><span id="l17.149">       dbFolderInfo-&gt;SetExpungedBytes(0);</span>
<a href="#l17.150"></a><span id="l17.150">   }</span>
<a href="#l17.151"></a><span id="l17.151">   if (m_db)</span>
<a href="#l17.152"></a><span id="l17.152">     m_db-&gt;Close(PR_TRUE);</span>
<a href="#l17.153"></a><span id="l17.153" class="difflineat">@@ -968,16 +973,19 @@ nsOfflineStoreCompactState::OnStopReques</span>
<a href="#l17.154"></a><span id="l17.154">   rv = GetMessage(getter_AddRefs(msgHdr));</span>
<a href="#l17.155"></a><span id="l17.155">   if (NS_FAILED(rv)) goto done;</span>
<a href="#l17.156"></a><span id="l17.156"> </span>
<a href="#l17.157"></a><span id="l17.157">   if (msgHdr)</span>
<a href="#l17.158"></a><span id="l17.158">   {</span>
<a href="#l17.159"></a><span id="l17.159">     if (NS_SUCCEEDED(status))</span>
<a href="#l17.160"></a><span id="l17.160">     {</span>
<a href="#l17.161"></a><span id="l17.161">       msgHdr-&gt;SetMessageOffset(m_startOfNewMsg);</span>
<a href="#l17.162"></a><span id="l17.162" class="difflineplus">+      char storeToken[100];</span>
<a href="#l17.163"></a><span id="l17.163" class="difflineplus">+      PR_snprintf(storeToken, sizeof(storeToken), &quot;%lld&quot;, m_startOfNewMsg);</span>
<a href="#l17.164"></a><span id="l17.164" class="difflineplus">+      msgHdr-&gt;SetStringProperty(&quot;storeToken&quot;, storeToken);</span>
<a href="#l17.165"></a><span id="l17.165">       msgHdr-&gt;SetOfflineMessageSize(m_offlineMsgSize);</span>
<a href="#l17.166"></a><span id="l17.166">     }</span>
<a href="#l17.167"></a><span id="l17.167">     else</span>
<a href="#l17.168"></a><span id="l17.168">     {</span>
<a href="#l17.169"></a><span id="l17.169">       PRUint32 resultFlags;</span>
<a href="#l17.170"></a><span id="l17.170">       msgHdr-&gt;AndFlags(~nsMsgMessageFlags::Offline, &amp;resultFlags);</span>
<a href="#l17.171"></a><span id="l17.171">     }</span>
<a href="#l17.172"></a><span id="l17.172">   }</span>
<a href="#l17.173"></a><span id="l17.173" class="difflineat">@@ -1118,16 +1126,20 @@ nsFolderCompactState::EndCopy(nsISupport</span>
<a href="#l17.174"></a><span id="l17.174">     m_db-&gt;CopyHdrFromExistingHdr((nsMsgKey) m_startOfNewMsg, m_curSrcHdr, PR_TRUE,</span>
<a href="#l17.175"></a><span id="l17.175">                                getter_AddRefs(newMsgHdr));</span>
<a href="#l17.176"></a><span id="l17.176">   m_curSrcHdr = nsnull;</span>
<a href="#l17.177"></a><span id="l17.177">   if (newMsgHdr)</span>
<a href="#l17.178"></a><span id="l17.178">   {</span>
<a href="#l17.179"></a><span id="l17.179">     if ( m_statusOffset != 0)</span>
<a href="#l17.180"></a><span id="l17.180">       newMsgHdr-&gt;SetStatusOffset(m_statusOffset);</span>
<a href="#l17.181"></a><span id="l17.181">       </span>
<a href="#l17.182"></a><span id="l17.182" class="difflineplus">+    char storeToken[100];</span>
<a href="#l17.183"></a><span id="l17.183" class="difflineplus">+    PR_snprintf(storeToken, sizeof(storeToken), &quot;%lld&quot;, m_startOfNewMsg);</span>
<a href="#l17.184"></a><span id="l17.184" class="difflineplus">+    newMsgHdr-&gt;SetStringProperty(&quot;storeToken&quot;, storeToken);</span>
<a href="#l17.185"></a><span id="l17.185" class="difflineplus">+</span>
<a href="#l17.186"></a><span id="l17.186">     PRUint32 msgSize;</span>
<a href="#l17.187"></a><span id="l17.187">     (void) newMsgHdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l17.188"></a><span id="l17.188">     if (m_addedHeaderSize)</span>
<a href="#l17.189"></a><span id="l17.189">     {</span>
<a href="#l17.190"></a><span id="l17.190">       msgSize += m_addedHeaderSize;</span>
<a href="#l17.191"></a><span id="l17.191">       newMsgHdr-&gt;SetMessageSize(msgSize);</span>
<a href="#l17.192"></a><span id="l17.192">     }</span>
<a href="#l17.193"></a><span id="l17.193">     m_totalMsgSize += msgSize;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l18.1"></a><span id="l18.1" class="difflineminus">--- a/mailnews/base/src/virtualFolderWrapper.js</span>
<a href="#l18.2"></a><span id="l18.2" class="difflineplus">+++ b/mailnews/base/src/virtualFolderWrapper.js</span>
<a href="#l18.3"></a><span id="l18.3" class="difflineat">@@ -84,17 +84,16 @@ var VirtualFolderHelper = {</span>
<a href="#l18.4"></a><span id="l18.4">     msgFolder.setFlag(Ci.nsMsgFolderFlags.Virtual);</span>
<a href="#l18.5"></a><span id="l18.5"> </span>
<a href="#l18.6"></a><span id="l18.6">     let wrappedVirt = new VirtualFolderWrapper(msgFolder);</span>
<a href="#l18.7"></a><span id="l18.7">     wrappedVirt.searchTerms = aSearchTerms;</span>
<a href="#l18.8"></a><span id="l18.8">     wrappedVirt.searchFolders = aSearchFolders;</span>
<a href="#l18.9"></a><span id="l18.9">     wrappedVirt.onlineSearch = aOnlineSearch;</span>
<a href="#l18.10"></a><span id="l18.10"> </span>
<a href="#l18.11"></a><span id="l18.11">     let msgDatabase = msgFolder.msgDatabase;</span>
<a href="#l18.12"></a><span id="l18.12" class="difflineminus">-    msgDatabase.summaryValid = true;</span>
<a href="#l18.13"></a><span id="l18.13">     msgDatabase.Close(true);</span>
<a href="#l18.14"></a><span id="l18.14"> </span>
<a href="#l18.15"></a><span id="l18.15">     aParentFolder.NotifyItemAdded(msgFolder);</span>
<a href="#l18.16"></a><span id="l18.16">     Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l18.17"></a><span id="l18.17">       .getService(Ci.nsIMsgAccountManager)</span>
<a href="#l18.18"></a><span id="l18.18">       .saveVirtualFolders();</span>
<a href="#l18.19"></a><span id="l18.19"> </span>
<a href="#l18.20"></a><span id="l18.20">     return wrappedVirt;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l19.1"></a><span id="l19.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bug428427.js</span>
<a href="#l19.2"></a><span id="l19.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bug428427.js</span>
<a href="#l19.3"></a><span id="l19.3" class="difflineat">@@ -38,20 +38,16 @@</span>
<a href="#l19.4"></a><span id="l19.4"> </span>
<a href="#l19.5"></a><span id="l19.5"> const copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l19.6"></a><span id="l19.6">                       .getService(Ci.nsIMsgCopyService);</span>
<a href="#l19.7"></a><span id="l19.7"> const tagService = Cc[&quot;@mozilla.org/messenger/tagservice;1&quot;]</span>
<a href="#l19.8"></a><span id="l19.8">                      .getService(Ci.nsIMsgTagService);</span>
<a href="#l19.9"></a><span id="l19.9"> const dbviewContractId = &quot;@mozilla.org/messenger/msgdbview;1?type=&quot; + &quot;quicksearch&quot;;</span>
<a href="#l19.10"></a><span id="l19.10"> const dbView = Cc[dbviewContractId].createInstance(Ci.nsIMsgDBView);</span>
<a href="#l19.11"></a><span id="l19.11"> const bugmail1 = do_get_file(&quot;../../../data/bugmail1&quot;);</span>
<a href="#l19.12"></a><span id="l19.12" class="difflineminus">-// I'm only loading msgDBService to help load symbols for debugging</span>
<a href="#l19.13"></a><span id="l19.13" class="difflineminus">-//const msgDBService = Cc[&quot;@mozilla.org/msgDatabase/msgDBService;1&quot;]</span>
<a href="#l19.14"></a><span id="l19.14" class="difflineminus">-//                     .getService(Ci.nsIMsgDBService);</span>
<a href="#l19.15"></a><span id="l19.15" class="difflineminus">-                     </span>
<a href="#l19.16"></a><span id="l19.16"> // main test</span>
<a href="#l19.17"></a><span id="l19.17"> </span>
<a href="#l19.18"></a><span id="l19.18"> // the headers for the test messages. All messages are identical, but</span>
<a href="#l19.19"></a><span id="l19.19"> // have different properties set on them.</span>
<a href="#l19.20"></a><span id="l19.20"> var hdrs = [];</span>
<a href="#l19.21"></a><span id="l19.21"> </span>
<a href="#l19.22"></a><span id="l19.22"> // how many identical messages to load</span>
<a href="#l19.23"></a><span id="l19.23"> var messageCount = 5;</span>
<a href="#l19.24"></a><span id="l19.24" class="difflineat">@@ -83,18 +79,21 @@ var copyListener =</span>
<a href="#l19.25"></a><span id="l19.25">     hdrs.push(gLocalInboxFolder.GetMessageHeader(aKey));</span>
<a href="#l19.26"></a><span id="l19.26">   },</span>
<a href="#l19.27"></a><span id="l19.27">   SetMessageId: function(aMessageId) {},</span>
<a href="#l19.28"></a><span id="l19.28">   OnStopCopy: function(aStatus)</span>
<a href="#l19.29"></a><span id="l19.29">   {</span>
<a href="#l19.30"></a><span id="l19.30">     if (--messageCount)</span>
<a href="#l19.31"></a><span id="l19.31">       copyService.CopyFileMessage(bugmail1, gLocalInboxFolder, null, false, 0,</span>
<a href="#l19.32"></a><span id="l19.32">                                   &quot;&quot;, copyListener, null);</span>
<a href="#l19.33"></a><span id="l19.33" class="difflineminus">-    else</span>
<a href="#l19.34"></a><span id="l19.34" class="difflineplus">+    else {</span>
<a href="#l19.35"></a><span id="l19.35" class="difflineplus">+      try {</span>
<a href="#l19.36"></a><span id="l19.36">       setupVirtualFolder();</span>
<a href="#l19.37"></a><span id="l19.37" class="difflineplus">+      } catch (ex) {dump(ex);}</span>
<a href="#l19.38"></a><span id="l19.38" class="difflineplus">+    }</span>
<a href="#l19.39"></a><span id="l19.39">   }</span>
<a href="#l19.40"></a><span id="l19.40"> };</span>
<a href="#l19.41"></a><span id="l19.41"> </span>
<a href="#l19.42"></a><span id="l19.42"> var virtualFolder;</span>
<a href="#l19.43"></a><span id="l19.43"> var numTotalMessages; </span>
<a href="#l19.44"></a><span id="l19.44"> var numUnreadMessages;</span>
<a href="#l19.45"></a><span id="l19.45"> </span>
<a href="#l19.46"></a><span id="l19.46"> // virtual folder setup</span>
<a href="#l19.47"></a><span id="l19.47" class="difflineat">@@ -119,43 +118,45 @@ function setupVirtualFolder()</span>
<a href="#l19.48"></a><span id="l19.48">   for (i = 3; i &lt;= 4; i++)</span>
<a href="#l19.49"></a><span id="l19.49">     messages3to4.appendElement(hdrs[i], false);</span>
<a href="#l19.50"></a><span id="l19.50">   gLocalInboxFolder.markMessagesRead(messages3to4, true);</span>
<a href="#l19.51"></a><span id="l19.51"> </span>
<a href="#l19.52"></a><span id="l19.52">   // search will look for tag tag1 in the inbox folder</span>
<a href="#l19.53"></a><span id="l19.53">   var searchTerm = makeSearchTerm(gLocalInboxFolder, tag1, </span>
<a href="#l19.54"></a><span id="l19.54">     Ci.nsMsgSearchAttrib.Keywords, Ci.nsMsgSearchOp.Contains);</span>
<a href="#l19.55"></a><span id="l19.55">     </span>
<a href="#l19.56"></a><span id="l19.56" class="difflineplus">+  dump(&quot;creating virtual folder\n&quot;);</span>
<a href="#l19.57"></a><span id="l19.57">   var rootFolder = gLocalIncomingServer.rootMsgFolder;</span>
<a href="#l19.58"></a><span id="l19.58">   virtualFolder = CreateVirtualFolder(&quot;VfTest&quot;, rootFolder, gLocalInboxFolder.URI, searchTerm, false);</span>
<a href="#l19.59"></a><span id="l19.59">   var count= new Object;</span>
<a href="#l19.60"></a><span id="l19.60" class="difflineminus">-  </span>
<a href="#l19.61"></a><span id="l19.61">   // Setup search session. Execution continues with testVirtualFolder()</span>
<a href="#l19.62"></a><span id="l19.62">   // after search is done.</span>
<a href="#l19.63"></a><span id="l19.63">   </span>
<a href="#l19.64"></a><span id="l19.64">   var searchSession = Cc[&quot;@mozilla.org/messenger/searchSession;1&quot;]</span>
<a href="#l19.65"></a><span id="l19.65">                         .createInstance(Ci.nsIMsgSearchSession);</span>
<a href="#l19.66"></a><span id="l19.66">   searchSession.addScopeTerm(Ci.nsMsgSearchScope.offlineMail, gLocalInboxFolder);</span>
<a href="#l19.67"></a><span id="l19.67">   searchSession.appendTerm(searchTerm, false);</span>
<a href="#l19.68"></a><span id="l19.68">   searchSession.registerListener(searchListener);</span>
<a href="#l19.69"></a><span id="l19.69" class="difflineplus">+  dump(&quot;starting search of vf\n&quot;);</span>
<a href="#l19.70"></a><span id="l19.70">   searchSession.search(null);</span>
<a href="#l19.71"></a><span id="l19.71"> }</span>
<a href="#l19.72"></a><span id="l19.72"> </span>
<a href="#l19.73"></a><span id="l19.73"> // partially based on gSearchNotificationListener in searchBar.js</span>
<a href="#l19.74"></a><span id="l19.74"> // nsIMsgSearchNotify implementation</span>
<a href="#l19.75"></a><span id="l19.75"> var searchListener =</span>
<a href="#l19.76"></a><span id="l19.76"> { </span>
<a href="#l19.77"></a><span id="l19.77">   onNewSearch: function() </span>
<a href="#l19.78"></a><span id="l19.78">   {</span>
<a href="#l19.79"></a><span id="l19.79" class="difflineplus">+    dump(&quot;in onnewsearch\n&quot;);</span>
<a href="#l19.80"></a><span id="l19.80">     numTotalMessages = 0;</span>
<a href="#l19.81"></a><span id="l19.81">     numUnreadMessages = 0;</span>
<a href="#l19.82"></a><span id="l19.82">   },</span>
<a href="#l19.83"></a><span id="l19.83">   onSearchHit: function(dbHdr, folder)</span>
<a href="#l19.84"></a><span id="l19.84">   {</span>
<a href="#l19.85"></a><span id="l19.85" class="difflineminus">-    //print(&quot;Search hit, isRead is &quot; + dbHdr.isRead);</span>
<a href="#l19.86"></a><span id="l19.86" class="difflineplus">+    print(&quot;Search hit, isRead is &quot; + dbHdr.isRead);</span>
<a href="#l19.87"></a><span id="l19.87">     numTotalMessages++;</span>
<a href="#l19.88"></a><span id="l19.88">     if (!dbHdr.isRead)</span>
<a href="#l19.89"></a><span id="l19.89">       numUnreadMessages++;</span>
<a href="#l19.90"></a><span id="l19.90">   },</span>
<a href="#l19.91"></a><span id="l19.91">   onSearchDone: function(status)</span>
<a href="#l19.92"></a><span id="l19.92">   { </span>
<a href="#l19.93"></a><span id="l19.93">     print(&quot;Finished search hitCount = &quot; + numTotalMessages);</span>
<a href="#l19.94"></a><span id="l19.94">     var db = virtualFolder.msgDatabase;</span>
<a href="#l19.95"></a><span id="l19.95" class="difflineat">@@ -216,19 +217,19 @@ function CreateVirtualFolder(newName, pa</span>
<a href="#l19.96"></a><span id="l19.96">   var searchTermString = getSearchTermString(searchTerm);</span>
<a href="#l19.97"></a><span id="l19.97">   </span>
<a href="#l19.98"></a><span id="l19.98">   var dbFolderInfo = vfdb.dBFolderInfo;</span>
<a href="#l19.99"></a><span id="l19.99">   // set the view string as a property of the db folder info</span>
<a href="#l19.100"></a><span id="l19.100">   // set the original folder name as well.</span>
<a href="#l19.101"></a><span id="l19.101">   dbFolderInfo.setCharProperty(&quot;searchStr&quot;, searchTermString);</span>
<a href="#l19.102"></a><span id="l19.102">   dbFolderInfo.setCharProperty(&quot;searchFolderUri&quot;, searchFolderURIs);</span>
<a href="#l19.103"></a><span id="l19.103">   dbFolderInfo.setBooleanProperty(&quot;searchOnline&quot;, searchOnline);</span>
<a href="#l19.104"></a><span id="l19.104" class="difflineminus">-  vfdb.summaryValid = true;</span>
<a href="#l19.105"></a><span id="l19.105" class="difflineplus">+  // This fails because the folder doesn't exist - why were we doing it?</span>
<a href="#l19.106"></a><span id="l19.106" class="difflineplus">+//  vfdb.summaryValid = true;</span>
<a href="#l19.107"></a><span id="l19.107">   vfdb.Close(true);</span>
<a href="#l19.108"></a><span id="l19.108" class="difflineminus">-  </span>
<a href="#l19.109"></a><span id="l19.109">   // use acctMgr to setup the virtual folder listener</span>
<a href="#l19.110"></a><span id="l19.110">   var acctMgr = Cc[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l19.111"></a><span id="l19.111">                   .getService(Ci.nsIMsgAccountManager);</span>
<a href="#l19.112"></a><span id="l19.112">   acctMgr = acctMgr.QueryInterface(Ci.nsIFolderListener);</span>
<a href="#l19.113"></a><span id="l19.113">   //print(acctMgr);</span>
<a href="#l19.114"></a><span id="l19.114">   acctMgr.OnItemAdded(null, newFolder);</span>
<a href="#l19.115"></a><span id="l19.115">   return newFolder;</span>
<a href="#l19.116"></a><span id="l19.116"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l20.1"></a><span id="l20.1" class="difflineminus">--- a/mailnews/base/test/unit/test_bug471682.js</span>
<a href="#l20.2"></a><span id="l20.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_bug471682.js</span>
<a href="#l20.3"></a><span id="l20.3" class="difflineat">@@ -46,37 +46,45 @@ const bugmail1 = do_get_file(&quot;../../../d</span>
<a href="#l20.4"></a><span id="l20.4"> var gHdr; // header of test message in local folder</span>
<a href="#l20.5"></a><span id="l20.5"> </span>
<a href="#l20.6"></a><span id="l20.6"> loadLocalMailAccount();</span>
<a href="#l20.7"></a><span id="l20.7"> // create a subfolder as a target for copies</span>
<a href="#l20.8"></a><span id="l20.8"> var gSubfolder = gLocalInboxFolder.createLocalSubfolder(&quot;subfolder&quot;);</span>
<a href="#l20.9"></a><span id="l20.9"> </span>
<a href="#l20.10"></a><span id="l20.10"> function run_test()</span>
<a href="#l20.11"></a><span id="l20.11"> {</span>
<a href="#l20.12"></a><span id="l20.12" class="difflineplus">+  // make sure we're using berkeley mailbox format here since this test</span>
<a href="#l20.13"></a><span id="l20.13" class="difflineplus">+  // assumes berkeley mailbox format.</span>
<a href="#l20.14"></a><span id="l20.14" class="difflineplus">+  if (Services.prefs.getCharPref(&quot;mail.serverDefaultStoreContractID&quot;) !=</span>
<a href="#l20.15"></a><span id="l20.15" class="difflineplus">+      &quot;@mozilla.org/msgstore/berkeleystore;1&quot;)</span>
<a href="#l20.16"></a><span id="l20.16" class="difflineplus">+    return;</span>
<a href="#l20.17"></a><span id="l20.17" class="difflineplus">+</span>
<a href="#l20.18"></a><span id="l20.18">   do_test_pending();</span>
<a href="#l20.19"></a><span id="l20.19">   // step 1: copy a message into the local inbox</span>
<a href="#l20.20"></a><span id="l20.20">   copyService.CopyFileMessage(bugmail1, gLocalInboxFolder, null, false, 0,</span>
<a href="#l20.21"></a><span id="l20.21">                               &quot;&quot;, step2, null);</span>
<a href="#l20.22"></a><span id="l20.22">   return;</span>
<a href="#l20.23"></a><span id="l20.23"> }</span>
<a href="#l20.24"></a><span id="l20.24"> </span>
<a href="#l20.25"></a><span id="l20.25"> // step 2: copy one message into a subfolder to establish an</span>
<a href="#l20.26"></a><span id="l20.26"> //         mbox file time and size</span>
<a href="#l20.27"></a><span id="l20.27"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l20.28"></a><span id="l20.28"> var step2 = </span>
<a href="#l20.29"></a><span id="l20.29"> {</span>
<a href="#l20.30"></a><span id="l20.30">   OnStartCopy: function() {},</span>
<a href="#l20.31"></a><span id="l20.31">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l20.32"></a><span id="l20.32">   SetMessageKey: function(aKey)</span>
<a href="#l20.33"></a><span id="l20.33">   {</span>
<a href="#l20.34"></a><span id="l20.34" class="difflineplus">+    dump(&quot;in set message key\n&quot;);</span>
<a href="#l20.35"></a><span id="l20.35">     gHdr = gLocalInboxFolder.GetMessageHeader(aKey);</span>
<a href="#l20.36"></a><span id="l20.36">   },</span>
<a href="#l20.37"></a><span id="l20.37">   SetMessageId: function(aMessageId) {},</span>
<a href="#l20.38"></a><span id="l20.38">   OnStopCopy: function(aStatus)</span>
<a href="#l20.39"></a><span id="l20.39">   {</span>
<a href="#l20.40"></a><span id="l20.40" class="difflineplus">+    do_check_neq(gHdr, null);</span>
<a href="#l20.41"></a><span id="l20.41">     // copy the message into the subfolder</span>
<a href="#l20.42"></a><span id="l20.42">     var messages = Cc[&quot;@mozilla.org/array;1&quot;].createInstance(Ci.nsIMutableArray);</span>
<a href="#l20.43"></a><span id="l20.43">     messages.appendElement(gHdr, false);</span>
<a href="#l20.44"></a><span id="l20.44">     copyService.CopyMessages(gLocalInboxFolder, messages, gSubfolder, false,</span>
<a href="#l20.45"></a><span id="l20.45">                              step3, null, false);</span>
<a href="#l20.46"></a><span id="l20.46">   }</span>
<a href="#l20.47"></a><span id="l20.47"> };</span>
<a href="#l20.48"></a><span id="l20.48"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l21.1"></a><span id="l21.1" class="difflineminus">--- a/mailnews/base/test/unit/test_detachToFile.js</span>
<a href="#l21.2"></a><span id="l21.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_detachToFile.js</span>
<a href="#l21.3"></a><span id="l21.3" class="difflineat">@@ -153,16 +153,8 @@ function getContentFromMessage(aMsgHdr) </span>
<a href="#l21.4"></a><span id="l21.4">                                                         false,</span>
<a href="#l21.5"></a><span id="l21.5">                                                         &quot;&quot;,</span>
<a href="#l21.6"></a><span id="l21.6">                                                         false);</span>
<a href="#l21.7"></a><span id="l21.7">   let sis = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l21.8"></a><span id="l21.8">               .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l21.9"></a><span id="l21.9">   sis.init(streamListener.inputStream);</span>
<a href="#l21.10"></a><span id="l21.10">   return sis.read(MAX_MESSAGE_LENGTH);</span>
<a href="#l21.11"></a><span id="l21.11"> }</span>
<a href="#l21.12"></a><span id="l21.12" class="difflineminus">-</span>
<a href="#l21.13"></a><span id="l21.13" class="difflineminus">-// get the first message header found in a folder</span>
<a href="#l21.14"></a><span id="l21.14" class="difflineminus">-function firstMsgHdr(folder) {</span>
<a href="#l21.15"></a><span id="l21.15" class="difflineminus">-  let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l21.16"></a><span id="l21.16" class="difflineminus">-  if (enumerator.hasMoreElements())</span>
<a href="#l21.17"></a><span id="l21.17" class="difflineminus">-    return enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l21.18"></a><span id="l21.18" class="difflineminus">-  return null;</span>
<a href="#l21.19"></a><span id="l21.19" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l22.1"></a><span id="l22.1" class="difflineminus">--- a/mailnews/base/test/unit/test_folderCompact.js</span>
<a href="#l22.2"></a><span id="l22.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_folderCompact.js</span>
<a href="#l22.3"></a><span id="l22.3" class="difflineat">@@ -10,16 +10,19 @@</span>
<a href="#l22.4"></a><span id="l22.4">   * Test suite for folder compaction</span>
<a href="#l22.5"></a><span id="l22.5">   *</span>
<a href="#l22.6"></a><span id="l22.6">   * Currently tested:</span>
<a href="#l22.7"></a><span id="l22.7">   * - Compacting local folders</span>
<a href="#l22.8"></a><span id="l22.8">   * TODO</span>
<a href="#l22.9"></a><span id="l22.9">   * - Compacting imap offline stores.</span>
<a href="#l22.10"></a><span id="l22.10">   */</span>
<a href="#l22.11"></a><span id="l22.11"> </span>
<a href="#l22.12"></a><span id="l22.12" class="difflineplus">+Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l22.13"></a><span id="l22.13" class="difflineplus">+                           &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l22.14"></a><span id="l22.14" class="difflineplus">+</span>
<a href="#l22.15"></a><span id="l22.15"> // Globals</span>
<a href="#l22.16"></a><span id="l22.16"> var gMsgFile1, gMsgFile2, gMsgFile3;</span>
<a href="#l22.17"></a><span id="l22.17"> var gLocalFolder2;</span>
<a href="#l22.18"></a><span id="l22.18"> var gLocalFolder3;</span>
<a href="#l22.19"></a><span id="l22.19"> var gLocalTrashFolder;</span>
<a href="#l22.20"></a><span id="l22.20"> var gCurTestNum;</span>
<a href="#l22.21"></a><span id="l22.21"> // After a compact (or other operation), this is what we expect the </span>
<a href="#l22.22"></a><span id="l22.22"> // folder size to be.</span>
<a href="#l22.23"></a><span id="l22.23" class="difflineat">@@ -181,45 +184,42 @@ function run_test()</span>
<a href="#l22.24"></a><span id="l22.24"> {</span>
<a href="#l22.25"></a><span id="l22.25">   loadLocalMailAccount();</span>
<a href="#l22.26"></a><span id="l22.26">   // Load up some messages so that we can copy them in later.</span>
<a href="#l22.27"></a><span id="l22.27">   gMsgFile1 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l22.28"></a><span id="l22.28">   gMsgFile2 = do_get_file(&quot;../../../data/bugmail11&quot;);</span>
<a href="#l22.29"></a><span id="l22.29">   gMsgFile3 = do_get_file(&quot;../../../data/draft1&quot;);</span>
<a href="#l22.30"></a><span id="l22.30"> </span>
<a href="#l22.31"></a><span id="l22.31">   // Create another folder to move and copy messages around, and force initialization.</span>
<a href="#l22.32"></a><span id="l22.32" class="difflineminus">-  var rootFolder = gLocalIncomingServer.rootMsgFolder;</span>
<a href="#l22.33"></a><span id="l22.33" class="difflineminus">-  gLocalFolder2 = rootFolder.createLocalSubfolder(&quot;folder2&quot;);</span>
<a href="#l22.34"></a><span id="l22.34" class="difflineminus">-  var folderName = gLocalFolder2.prettiestName;</span>
<a href="#l22.35"></a><span id="l22.35" class="difflineplus">+  gLocalFolder2 = gLocalRootFolder.createLocalSubfolder(&quot;folder2&quot;);</span>
<a href="#l22.36"></a><span id="l22.36" class="difflineplus">+  let folderName = gLocalFolder2.prettiestName;</span>
<a href="#l22.37"></a><span id="l22.37">   // Create a third folder for more testing.</span>
<a href="#l22.38"></a><span id="l22.38" class="difflineminus">-  gLocalFolder3 = rootFolder.createLocalSubfolder(&quot;folder3&quot;);</span>
<a href="#l22.39"></a><span id="l22.39" class="difflineplus">+  gLocalFolder3 = gLocalRootFolder.createLocalSubfolder(&quot;folder3&quot;);</span>
<a href="#l22.40"></a><span id="l22.40">   folderName = gLocalFolder3.prettiestName;</span>
<a href="#l22.41"></a><span id="l22.41"> </span>
<a href="#l22.42"></a><span id="l22.42">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of all the operations.</span>
<a href="#l22.43"></a><span id="l22.43">   do_test_pending();</span>
<a href="#l22.44"></a><span id="l22.44"> </span>
<a href="#l22.45"></a><span id="l22.45"> //  do_test_finished();</span>
<a href="#l22.46"></a><span id="l22.46">   // Do the test.</span>
<a href="#l22.47"></a><span id="l22.47">   doTest(1);</span>
<a href="#l22.48"></a><span id="l22.48"> }</span>
<a href="#l22.49"></a><span id="l22.49"> </span>
<a href="#l22.50"></a><span id="l22.50"> function doTest(test)</span>
<a href="#l22.51"></a><span id="l22.51"> {</span>
<a href="#l22.52"></a><span id="l22.52">   if (test &lt;= gTestArray.length)</span>
<a href="#l22.53"></a><span id="l22.53">   {</span>
<a href="#l22.54"></a><span id="l22.54">     gCurTestNum = test;</span>
<a href="#l22.55"></a><span id="l22.55" class="difflineminus">-    </span>
<a href="#l22.56"></a><span id="l22.56">     var testFn = gTestArray[test-1];</span>
<a href="#l22.57"></a><span id="l22.57" class="difflineminus">-    // Set a limit of 10 seconds; if the notifications haven't arrived by then there's a problem.</span>
<a href="#l22.58"></a><span id="l22.58" class="difflineminus">-    do_timeout(10000, function(){</span>
<a href="#l22.59"></a><span id="l22.59" class="difflineminus">-</span>
<a href="#l22.60"></a><span id="l22.60" class="difflineminus">-        if (gCurTestNum == test)</span>
<a href="#l22.61"></a><span id="l22.61" class="difflineminus">-          do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l22.62"></a><span id="l22.62" class="difflineminus">-        }</span>
<a href="#l22.63"></a><span id="l22.63" class="difflineminus">-      );</span>
<a href="#l22.64"></a><span id="l22.64" class="difflineplus">+    // Set a limit of 10 seconds; if the notifications haven't arrived by</span>
<a href="#l22.65"></a><span id="l22.65" class="difflineplus">+    // then, there's a problem.</span>
<a href="#l22.66"></a><span id="l22.66" class="difflineplus">+    do_timeout(10000, function() {</span>
<a href="#l22.67"></a><span id="l22.67" class="difflineplus">+      if (gCurTestNum == test)</span>
<a href="#l22.68"></a><span id="l22.68" class="difflineplus">+        do_throw(&quot;Notifications not received in 10000 ms for operation &quot; + testFn.name);</span>
<a href="#l22.69"></a><span id="l22.69" class="difflineplus">+    });</span>
<a href="#l22.70"></a><span id="l22.70">     try {</span>
<a href="#l22.71"></a><span id="l22.71">     testFn();</span>
<a href="#l22.72"></a><span id="l22.72">     } catch(ex) {dump(ex);}</span>
<a href="#l22.73"></a><span id="l22.73">   }</span>
<a href="#l22.74"></a><span id="l22.74">   else</span>
<a href="#l22.75"></a><span id="l22.75">   {</span>
<a href="#l22.76"></a><span id="l22.76">     do_test_finished(); // for the one in run_test()</span>
<a href="#l22.77"></a><span id="l22.77">   }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l23.1"></a><span id="l23.1" class="difflineminus">--- a/mailnews/base/test/unit/test_imapPump.js</span>
<a href="#l23.2"></a><span id="l23.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_imapPump.js</span>
<a href="#l23.3"></a><span id="l23.3" class="difflineat">@@ -80,24 +80,16 @@ function run_test()</span>
<a href="#l23.4"></a><span id="l23.4"> {</span>
<a href="#l23.5"></a><span id="l23.5">   async_run_tests(tests);</span>
<a href="#l23.6"></a><span id="l23.6"> }</span>
<a href="#l23.7"></a><span id="l23.7"> </span>
<a href="#l23.8"></a><span id="l23.8"> /*</span>
<a href="#l23.9"></a><span id="l23.9">  * helper functions</span>
<a href="#l23.10"></a><span id="l23.10">  */</span>
<a href="#l23.11"></a><span id="l23.11"> </span>
<a href="#l23.12"></a><span id="l23.12" class="difflineminus">-// get the first message header found in a folder</span>
<a href="#l23.13"></a><span id="l23.13" class="difflineminus">-function firstMsgHdr(folder) {</span>
<a href="#l23.14"></a><span id="l23.14" class="difflineminus">-  let enumerator = folder.messages;</span>
<a href="#l23.15"></a><span id="l23.15" class="difflineminus">-  if (enumerator.hasMoreElements())</span>
<a href="#l23.16"></a><span id="l23.16" class="difflineminus">-    return enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l23.17"></a><span id="l23.17" class="difflineminus">-  return null;</span>
<a href="#l23.18"></a><span id="l23.18" class="difflineminus">-}</span>
<a href="#l23.19"></a><span id="l23.19" class="difflineminus">-</span>
<a href="#l23.20"></a><span id="l23.20"> // given a test file, return the file uri spec</span>
<a href="#l23.21"></a><span id="l23.21"> function specForFileName(aFileName)</span>
<a href="#l23.22"></a><span id="l23.22"> {</span>
<a href="#l23.23"></a><span id="l23.23">   let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l23.24"></a><span id="l23.24">   let msgfileuri = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l23.25"></a><span id="l23.25">                      .getService(Ci.nsIIOService)</span>
<a href="#l23.26"></a><span id="l23.26">                      .newFileURI(file)</span>
<a href="#l23.27"></a><span id="l23.27">                      .QueryInterface(Ci.nsIFileURL);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l24.1"></a><span id="l24.1" class="difflineminus">--- a/mailnews/base/test/unit/test_loadVirtualFolders.js</span>
<a href="#l24.2"></a><span id="l24.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_loadVirtualFolders.js</span>
<a href="#l24.3"></a><span id="l24.3" class="difflineat">@@ -36,16 +36,20 @@</span>
<a href="#l24.4"></a><span id="l24.4">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l24.5"></a><span id="l24.5"> </span>
<a href="#l24.6"></a><span id="l24.6"> // Test loading of virtualFolders.dat, including verification of the search </span>
<a href="#l24.7"></a><span id="l24.7"> // scopes, i.e., folder uri's.</span>
<a href="#l24.8"></a><span id="l24.8"> </span>
<a href="#l24.9"></a><span id="l24.9"> const am = Components.classes[&quot;@mozilla.org/messenger/account-manager;1&quot;]</span>
<a href="#l24.10"></a><span id="l24.10">                      .getService(Components.interfaces.nsIMsgAccountManager);</span>
<a href="#l24.11"></a><span id="l24.11"> </span>
<a href="#l24.12"></a><span id="l24.12" class="difflineplus">+// As currently written, this test will only work with Berkeley store.</span>
<a href="#l24.13"></a><span id="l24.13" class="difflineplus">+Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l24.14"></a><span id="l24.14" class="difflineplus">+                           &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l24.15"></a><span id="l24.15" class="difflineplus">+</span>
<a href="#l24.16"></a><span id="l24.16"> // main test</span>
<a href="#l24.17"></a><span id="l24.17"> </span>
<a href="#l24.18"></a><span id="l24.18"> function run_test()</span>
<a href="#l24.19"></a><span id="l24.19"> {</span>
<a href="#l24.20"></a><span id="l24.20">   let vfdat = do_get_file(&quot;../../../data/test_virtualFolders.dat&quot;);</span>
<a href="#l24.21"></a><span id="l24.21"> </span>
<a href="#l24.22"></a><span id="l24.22">   vfdat.copyTo(gProfileDir, &quot;virtualFolders.dat&quot;);</span>
<a href="#l24.23"></a><span id="l24.23">   loadLocalMailAccount();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l25.1"></a><span id="l25.1" class="difflineminus">--- a/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js</span>
<a href="#l25.2"></a><span id="l25.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_nsIMsgFolderListenerLocal.js</span>
<a href="#l25.3"></a><span id="l25.3" class="difflineat">@@ -262,17 +262,20 @@ const gTestArray =</span>
<a href="#l25.4"></a><span id="l25.4">   // -folder2</span>
<a href="#l25.5"></a><span id="l25.5">   // --folder3</span>
<a href="#l25.6"></a><span id="l25.6">   function deleteFolder4() {</span>
<a href="#l25.7"></a><span id="l25.7">     // Let's take a moment to re-initialize stuff that got moved</span>
<a href="#l25.8"></a><span id="l25.8">     gLocalFolder2 = gLocalTrashFolder.getChildNamed(&quot;folder2&quot;);</span>
<a href="#l25.9"></a><span id="l25.9">     gLocalFolder3 = gLocalFolder2.getChildNamed(&quot;folder3&quot;);</span>
<a href="#l25.10"></a><span id="l25.10">     deleteFolder(gLocalFolder2, gLocalFolder3); },</span>
<a href="#l25.11"></a><span id="l25.11">   function compactInbox() {</span>
<a href="#l25.12"></a><span id="l25.12" class="difflineminus">-    compactFolder(gLocalInboxFolder);</span>
<a href="#l25.13"></a><span id="l25.13" class="difflineplus">+    if (gLocalInboxFolder.msgStore.supportsCompaction)</span>
<a href="#l25.14"></a><span id="l25.14" class="difflineplus">+      compactFolder(gLocalInboxFolder);</span>
<a href="#l25.15"></a><span id="l25.15" class="difflineplus">+    else</span>
<a href="#l25.16"></a><span id="l25.16" class="difflineplus">+      doTest(++gTest);</span>
<a href="#l25.17"></a><span id="l25.17">   }</span>
<a href="#l25.18"></a><span id="l25.18"> ];</span>
<a href="#l25.19"></a><span id="l25.19">   // Folder structure should just be</span>
<a href="#l25.20"></a><span id="l25.20">   // Inbox</span>
<a href="#l25.21"></a><span id="l25.21">   // Trash</span>
<a href="#l25.22"></a><span id="l25.22"> </span>
<a href="#l25.23"></a><span id="l25.23"> function run_test()</span>
<a href="#l25.24"></a><span id="l25.24"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l26.1"></a><span id="l26.1" class="difflineminus">--- a/mailnews/base/test/unit/test_quarantineFilterMove.js</span>
<a href="#l26.2"></a><span id="l26.2" class="difflineplus">+++ b/mailnews/base/test/unit/test_quarantineFilterMove.js</span>
<a href="#l26.3"></a><span id="l26.3" class="difflineat">@@ -66,16 +66,19 @@ const gTestArray =</span>
<a href="#l26.4"></a><span id="l26.4">   },</span>
<a href="#l26.5"></a><span id="l26.5">   // just get a message into the local folder</span>
<a href="#l26.6"></a><span id="l26.6">   function getLocalMessages1() {</span>
<a href="#l26.7"></a><span id="l26.7">     gPOP3Pump.files = gFiles;</span>
<a href="#l26.8"></a><span id="l26.8">     gPOP3Pump.onDone = doTest;</span>
<a href="#l26.9"></a><span id="l26.9">     ++gCurTestNum;</span>
<a href="#l26.10"></a><span id="l26.10">     gPOP3Pump.run();</span>
<a href="#l26.11"></a><span id="l26.11">   },</span>
<a href="#l26.12"></a><span id="l26.12" class="difflineplus">+  function waitForCopyToFinish() {</span>
<a href="#l26.13"></a><span id="l26.13" class="difflineplus">+    do_timeout(1000, function() {++gCurTestNum; doTest();});</span>
<a href="#l26.14"></a><span id="l26.14" class="difflineplus">+  },</span>
<a href="#l26.15"></a><span id="l26.15">   function verifyFolders2() {</span>
<a href="#l26.16"></a><span id="l26.16">     do_check_eq(folderCount(gMoveFolder), 2);</span>
<a href="#l26.17"></a><span id="l26.17">     // the local inbox folder should now be empty, since the second</span>
<a href="#l26.18"></a><span id="l26.18">     // operation was a move</span>
<a href="#l26.19"></a><span id="l26.19">     do_check_eq(folderCount(gLocalInboxFolder), 0);</span>
<a href="#l26.20"></a><span id="l26.20"> </span>
<a href="#l26.21"></a><span id="l26.21">     // Check that the messages have content</span>
<a href="#l26.22"></a><span id="l26.22">     msgHdr = firstMsgHdr(gMoveFolder);</span>
<a href="#l26.23"></a><span id="l26.23" class="difflineat">@@ -109,17 +112,18 @@ function run_test()</span>
<a href="#l26.24"></a><span id="l26.24"> </span>
<a href="#l26.25"></a><span id="l26.25">   // quarantine messages</span>
<a href="#l26.26"></a><span id="l26.26">   let prefs = Cc[&quot;@mozilla.org/preferences-service;1&quot;]</span>
<a href="#l26.27"></a><span id="l26.27">                 .getService(Ci.nsIPrefBranch);</span>
<a href="#l26.28"></a><span id="l26.28">   prefs.setBoolPref(&quot;mailnews.downloadToTempFile&quot;, true);</span>
<a href="#l26.29"></a><span id="l26.29">   if (!gLocalInboxFolder)</span>
<a href="#l26.30"></a><span id="l26.30">     loadLocalMailAccount();</span>
<a href="#l26.31"></a><span id="l26.31"> </span>
<a href="#l26.32"></a><span id="l26.32" class="difflineminus">-  gMoveFolder = gLocalIncomingServer.rootFolder.createLocalSubfolder(&quot;MoveFolder&quot;);</span>
<a href="#l26.33"></a><span id="l26.33" class="difflineplus">+  gMoveFolder = gLocalIncomingServer.rootMsgFolder</span>
<a href="#l26.34"></a><span id="l26.34" class="difflineplus">+                  .createLocalSubfolder(&quot;MoveFolder&quot;);</span>
<a href="#l26.35"></a><span id="l26.35">   const mailSession = Cc[&quot;@mozilla.org/messenger/services/session;1&quot;]</span>
<a href="#l26.36"></a><span id="l26.36">                         .getService(Ci.nsIMsgMailSession);</span>
<a href="#l26.37"></a><span id="l26.37"> </span>
<a href="#l26.38"></a><span id="l26.38">   mailSession.AddFolderListener(FolderListener, Ci.nsIFolderListener.event |</span>
<a href="#l26.39"></a><span id="l26.39">                                                 Ci.nsIFolderListener.added |</span>
<a href="#l26.40"></a><span id="l26.40">                                                 Ci.nsIFolderListener.removed);</span>
<a href="#l26.41"></a><span id="l26.41"> </span>
<a href="#l26.42"></a><span id="l26.42">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l27.1"></a><span id="l27.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l27.2"></a><span id="l27.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.cpp</span>
<a href="#l27.3"></a><span id="l27.3" class="difflineat">@@ -351,17 +351,18 @@ NS_IMETHODIMP nsMsgDBFolder::OpenBackupM</span>
<a href="#l27.4"></a><span id="l27.4">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.5"></a><span id="l27.5">   rv = backupDBDummyFolder-&gt;Append(folderName);</span>
<a href="#l27.6"></a><span id="l27.6">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.7"></a><span id="l27.7"> </span>
<a href="#l27.8"></a><span id="l27.8">   nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l27.9"></a><span id="l27.9">       do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l27.10"></a><span id="l27.10">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.11"></a><span id="l27.11">   rv = msgDBService-&gt;OpenMailDBFromFile(</span>
<a href="#l27.12"></a><span id="l27.12" class="difflineminus">-      backupDBDummyFolder, PR_FALSE, PR_TRUE, getter_AddRefs(mBackupDatabase));</span>
<a href="#l27.13"></a><span id="l27.13" class="difflineplus">+      backupDBDummyFolder, this, PR_FALSE, PR_TRUE,</span>
<a href="#l27.14"></a><span id="l27.14" class="difflineplus">+      getter_AddRefs(mBackupDatabase));</span>
<a href="#l27.15"></a><span id="l27.15">   // we add a listener so that we can close the db during OnAnnouncerGoingAway. There should</span>
<a href="#l27.16"></a><span id="l27.16">   // not be any other calls to the listener with the backup database</span>
<a href="#l27.17"></a><span id="l27.17">   if (NS_SUCCEEDED(rv) &amp;&amp; mBackupDatabase)</span>
<a href="#l27.18"></a><span id="l27.18">     mBackupDatabase-&gt;AddListener(this);</span>
<a href="#l27.19"></a><span id="l27.19"> </span>
<a href="#l27.20"></a><span id="l27.20">   if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l27.21"></a><span id="l27.21">     // this is normal in reparsing</span>
<a href="#l27.22"></a><span id="l27.22">     rv = NS_OK;</span>
<a href="#l27.23"></a><span id="l27.23" class="difflineat">@@ -746,16 +747,33 @@ NS_IMETHODIMP nsMsgDBFolder::DownloadMes</span>
<a href="#l27.24"></a><span id="l27.24"> }</span>
<a href="#l27.25"></a><span id="l27.25"> </span>
<a href="#l27.26"></a><span id="l27.26"> NS_IMETHODIMP nsMsgDBFolder::DownloadAllForOffline(nsIUrlListener *listener, nsIMsgWindow *msgWindow)</span>
<a href="#l27.27"></a><span id="l27.27"> {</span>
<a href="#l27.28"></a><span id="l27.28">   NS_ASSERTION(PR_FALSE, &quot;imap and news need to override this&quot;);</span>
<a href="#l27.29"></a><span id="l27.29">   return NS_OK;</span>
<a href="#l27.30"></a><span id="l27.30"> }</span>
<a href="#l27.31"></a><span id="l27.31"> </span>
<a href="#l27.32"></a><span id="l27.32" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetMsgStore(nsIMsgPluggableStore **aStore)</span>
<a href="#l27.33"></a><span id="l27.33" class="difflineplus">+{</span>
<a href="#l27.34"></a><span id="l27.34" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aStore);</span>
<a href="#l27.35"></a><span id="l27.35" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l27.36"></a><span id="l27.36" class="difflineplus">+  nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l27.37"></a><span id="l27.37" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l27.38"></a><span id="l27.38" class="difflineplus">+  return server-&gt;GetMsgStore(aStore);</span>
<a href="#l27.39"></a><span id="l27.39" class="difflineplus">+}</span>
<a href="#l27.40"></a><span id="l27.40" class="difflineplus">+</span>
<a href="#l27.41"></a><span id="l27.41" class="difflineplus">+nsresult nsMsgDBFolder::GetSummaryFile(nsILocalFile** aSummaryFile)</span>
<a href="#l27.42"></a><span id="l27.42" class="difflineplus">+{</span>
<a href="#l27.43"></a><span id="l27.43" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l27.44"></a><span id="l27.44" class="difflineplus">+  nsresult rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l27.45"></a><span id="l27.45" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.46"></a><span id="l27.46" class="difflineplus">+  return msgStore-&gt;GetSummaryFile(this, aSummaryFile);</span>
<a href="#l27.47"></a><span id="l27.47" class="difflineplus">+}</span>
<a href="#l27.48"></a><span id="l27.48" class="difflineplus">+</span>
<a href="#l27.49"></a><span id="l27.49"> NS_IMETHODIMP nsMsgDBFolder::GetOfflineStoreInputStream(nsIInputStream **stream)</span>
<a href="#l27.50"></a><span id="l27.50"> {</span>
<a href="#l27.51"></a><span id="l27.51">   nsCOMPtr &lt;nsILocalFile&gt; localStore;</span>
<a href="#l27.52"></a><span id="l27.52">   nsresult rv = GetFilePath(getter_AddRefs(localStore));</span>
<a href="#l27.53"></a><span id="l27.53">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.54"></a><span id="l27.54">   return NS_NewLocalFileInputStream(stream, localStore);</span>
<a href="#l27.55"></a><span id="l27.55"> }</span>
<a href="#l27.56"></a><span id="l27.56"> </span>
<a href="#l27.57"></a><span id="l27.57" class="difflineat">@@ -776,49 +794,43 @@ bool nsMsgDBFolder::VerifyOfflineMessage</span>
<a href="#l27.58"></a><span id="l27.58">     // check if message starts with From, or is a draft and starts with FCC</span>
<a href="#l27.59"></a><span id="l27.59">     if (NS_FAILED(rv) || bytesRead != bytesToRead ||</span>
<a href="#l27.60"></a><span id="l27.60">       (strncmp(startOfMsg, &quot;From &quot;, 5) &amp;&amp; (! (mFlags &amp; nsMsgFolderFlags::Drafts) || strncmp(startOfMsg, &quot;FCC&quot;, 3))))</span>
<a href="#l27.61"></a><span id="l27.61">       return PR_FALSE;</span>
<a href="#l27.62"></a><span id="l27.62">   }</span>
<a href="#l27.63"></a><span id="l27.63">   return PR_TRUE;</span>
<a href="#l27.64"></a><span id="l27.64"> }</span>
<a href="#l27.65"></a><span id="l27.65"> </span>
<a href="#l27.66"></a><span id="l27.66" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetOfflineFileStream(nsMsgKey msgKey, PRUint64 *offset, PRUint32 *size, nsIInputStream **aFileStream)</span>
<a href="#l27.67"></a><span id="l27.67" class="difflineplus">+NS_IMETHODIMP nsMsgDBFolder::GetOfflineFileStream(nsMsgKey msgKey, PRInt64 *offset, PRUint32 *size, nsIInputStream **aFileStream)</span>
<a href="#l27.68"></a><span id="l27.68"> {</span>
<a href="#l27.69"></a><span id="l27.69">   NS_ENSURE_ARG(aFileStream);</span>
<a href="#l27.70"></a><span id="l27.70"> </span>
<a href="#l27.71"></a><span id="l27.71">   *offset = *size = 0;</span>
<a href="#l27.72"></a><span id="l27.72"> </span>
<a href="#l27.73"></a><span id="l27.73" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; localStore;</span>
<a href="#l27.74"></a><span id="l27.74" class="difflineminus">-  nsresult rv = GetFilePath(getter_AddRefs(localStore));</span>
<a href="#l27.75"></a><span id="l27.75" class="difflineplus">+  nsresult rv = GetDatabase();</span>
<a href="#l27.76"></a><span id="l27.76" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l27.77"></a><span id="l27.77" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l27.78"></a><span id="l27.78" class="difflineplus">+  rv = mDatabase-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(hdr));</span>
<a href="#l27.79"></a><span id="l27.79" class="difflineplus">+  NS_ENSURE_TRUE(hdr, NS_OK);</span>
<a href="#l27.80"></a><span id="l27.80">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.81"></a><span id="l27.81" class="difflineminus">-  if (localStore)</span>
<a href="#l27.82"></a><span id="l27.82" class="difflineplus">+  if (hdr)</span>
<a href="#l27.83"></a><span id="l27.83" class="difflineplus">+    hdr-&gt;GetOfflineMessageSize(size);</span>
<a href="#l27.84"></a><span id="l27.84" class="difflineplus">+</span>
<a href="#l27.85"></a><span id="l27.85" class="difflineplus">+  bool reusable;</span>
<a href="#l27.86"></a><span id="l27.86" class="difflineplus">+  rv = GetMsgInputStream(hdr, &amp;reusable, aFileStream);</span>
<a href="#l27.87"></a><span id="l27.87" class="difflineplus">+  // check if offline store really has the correct offset into the offline</span>
<a href="#l27.88"></a><span id="l27.88" class="difflineplus">+  // store by reading the first few bytes. If it doesn't, clear the offline</span>
<a href="#l27.89"></a><span id="l27.89" class="difflineplus">+  // flag on the msg and return false, which will fall back to reading the message</span>
<a href="#l27.90"></a><span id="l27.90" class="difflineplus">+  // from the server.</span>
<a href="#l27.91"></a><span id="l27.91" class="difflineplus">+  // We'll also advance the offset past the envelope header and</span>
<a href="#l27.92"></a><span id="l27.92" class="difflineplus">+  // X-Mozilla-Status lines.</span>
<a href="#l27.93"></a><span id="l27.93" class="difflineplus">+  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(*aFileStream);</span>
<a href="#l27.94"></a><span id="l27.94" class="difflineplus">+  if (seekableStream)</span>
<a href="#l27.95"></a><span id="l27.95">   {</span>
<a href="#l27.96"></a><span id="l27.96" class="difflineminus">-    rv = NS_NewLocalFileInputStream(aFileStream, localStore);</span>
<a href="#l27.97"></a><span id="l27.97" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l27.98"></a><span id="l27.98" class="difflineminus">-    {</span>
<a href="#l27.99"></a><span id="l27.99" class="difflineminus">-      rv = GetDatabase();</span>
<a href="#l27.100"></a><span id="l27.100" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, NS_OK);</span>
<a href="#l27.101"></a><span id="l27.101" class="difflineminus">-      nsCOMPtr&lt;nsIMsgDBHdr&gt; hdr;</span>
<a href="#l27.102"></a><span id="l27.102" class="difflineminus">-      rv = mDatabase-&gt;GetMsgHdrForKey(msgKey, getter_AddRefs(hdr));</span>
<a href="#l27.103"></a><span id="l27.103" class="difflineminus">-      if (hdr &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l27.104"></a><span id="l27.104" class="difflineminus">-      {</span>
<a href="#l27.105"></a><span id="l27.105" class="difflineminus">-        hdr-&gt;GetMessageOffset(offset);</span>
<a href="#l27.106"></a><span id="l27.106" class="difflineminus">-        hdr-&gt;GetOfflineMessageSize(size);</span>
<a href="#l27.107"></a><span id="l27.107" class="difflineminus">-      }</span>
<a href="#l27.108"></a><span id="l27.108" class="difflineminus">-      // check if offline store really has the correct offset into the offline</span>
<a href="#l27.109"></a><span id="l27.109" class="difflineminus">-      // store by reading the first few bytes. If it doesn't, clear the offline</span>
<a href="#l27.110"></a><span id="l27.110" class="difflineminus">-      // flag on the msg and return false, which will fall back to reading the message</span>
<a href="#l27.111"></a><span id="l27.111" class="difflineminus">-      // from the server.</span>
<a href="#l27.112"></a><span id="l27.112" class="difflineminus">-      // We'll also advance the offset past the envelope header and</span>
<a href="#l27.113"></a><span id="l27.113" class="difflineminus">-      // X-Mozilla-Status lines.</span>
<a href="#l27.114"></a><span id="l27.114" class="difflineminus">-      nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(*aFileStream);</span>
<a href="#l27.115"></a><span id="l27.115" class="difflineminus">-      if (seekableStream)</span>
<a href="#l27.116"></a><span id="l27.116" class="difflineminus">-      {</span>
<a href="#l27.117"></a><span id="l27.117" class="difflineminus">-        rv = seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_CUR, *offset);</span>
<a href="#l27.118"></a><span id="l27.118" class="difflineplus">+    seekableStream-&gt;Tell(offset);</span>
<a href="#l27.119"></a><span id="l27.119">         char startOfMsg[200];</span>
<a href="#l27.120"></a><span id="l27.120">         PRUint32 bytesRead = 0;</span>
<a href="#l27.121"></a><span id="l27.121">         PRUint32 bytesToRead = sizeof(startOfMsg) - 1;</span>
<a href="#l27.122"></a><span id="l27.122">         if (NS_SUCCEEDED(rv))</span>
<a href="#l27.123"></a><span id="l27.123">           rv = (*aFileStream)-&gt;Read(startOfMsg, bytesToRead, &amp;bytesRead);</span>
<a href="#l27.124"></a><span id="l27.124">         startOfMsg[bytesRead] = '\0';</span>
<a href="#l27.125"></a><span id="l27.125">         // check if message starts with From, or is a draft and starts with FCC</span>
<a href="#l27.126"></a><span id="l27.126">         if (NS_FAILED(rv) || bytesRead != bytesToRead ||</span>
<a href="#l27.127"></a><span id="l27.127" class="difflineat">@@ -851,57 +863,61 @@ NS_IMETHODIMP nsMsgDBFolder::GetOfflineF</span>
<a href="#l27.128"></a><span id="l27.128">             *offset += msgOffset;</span>
<a href="#l27.129"></a><span id="l27.129">             *size -= msgOffset;</span>
<a href="#l27.130"></a><span id="l27.130">           }</span>
<a href="#l27.131"></a><span id="l27.131">           else</span>
<a href="#l27.132"></a><span id="l27.132">           {</span>
<a href="#l27.133"></a><span id="l27.133">             rv = NS_ERROR_FAILURE;</span>
<a href="#l27.134"></a><span id="l27.134">           }</span>
<a href="#l27.135"></a><span id="l27.135">         }</span>
<a href="#l27.136"></a><span id="l27.136" class="difflineminus">-      }</span>
<a href="#l27.137"></a><span id="l27.137" class="difflineminus">-    }</span>
<a href="#l27.138"></a><span id="l27.138">     if (NS_FAILED(rv) &amp;&amp; mDatabase)</span>
<a href="#l27.139"></a><span id="l27.139">       mDatabase-&gt;MarkOffline(msgKey, PR_FALSE, nsnull);</span>
<a href="#l27.140"></a><span id="l27.140">   }</span>
<a href="#l27.141"></a><span id="l27.141">   return rv;</span>
<a href="#l27.142"></a><span id="l27.142"> }</span>
<a href="#l27.143"></a><span id="l27.143"> </span>
<a href="#l27.144"></a><span id="l27.144" class="difflineminus">-NS_IMETHODIMP nsMsgDBFolder::GetOfflineStoreOutputStream(nsIOutputStream **outputStream)</span>
<a href="#l27.145"></a><span id="l27.145" class="difflineminus">-{</span>
<a href="#l27.146"></a><span id="l27.146" class="difflineminus">-  NS_ENSURE_ARG_POINTER(outputStream);</span>
<a href="#l27.147"></a><span id="l27.147" class="difflineminus">-  nsresult rv = NS_ERROR_NULL_POINTER;</span>
<a href="#l27.148"></a><span id="l27.148" class="difflineminus">-    // the following code doesn't work for a host of reasons - the transfer offset</span>
<a href="#l27.149"></a><span id="l27.149" class="difflineminus">-    // is ignored for output streams. The buffering used by file channels does not work</span>
<a href="#l27.150"></a><span id="l27.150" class="difflineminus">-    // if transfer offsets are coerced to work, etc.</span>
<a href="#l27.151"></a><span id="l27.151" class="difflineminus">-#if 0</span>
<a href="#l27.152"></a><span id="l27.152" class="difflineminus">-    nsCOMPtr&lt;nsIFileChannel&gt; fileChannel = do_CreateInstance(NS_LOCALFILECHANNEL_CONTRACTID);</span>
<a href="#l27.153"></a><span id="l27.153" class="difflineminus">-    if (fileChannel)</span>
<a href="#l27.154"></a><span id="l27.154" class="difflineminus">-    {</span>
<a href="#l27.155"></a><span id="l27.155" class="difflineminus">-      nsCOMPtr &lt;nsILocalFile&gt; localStore;</span>
<a href="#l27.156"></a><span id="l27.156" class="difflineminus">-      rv = NS_NewLocalFile(nativePath, PR_TRUE, getter_AddRefs(localStore));</span>
<a href="#l27.157"></a><span id="l27.157" class="difflineminus">-      if (NS_SUCCEEDED(rv) &amp;&amp; localStore)</span>
<a href="#l27.158"></a><span id="l27.158" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l27.159"></a><span id="l27.159" class="difflineplus">+nsMsgDBFolder::GetOfflineStoreOutputStream(nsIMsgDBHdr *aHdr,</span>
<a href="#l27.160"></a><span id="l27.160" class="difflineplus">+                                           nsIOutputStream **aOutputStream)</span>
<a href="#l27.161"></a><span id="l27.161">       {</span>
<a href="#l27.162"></a><span id="l27.162" class="difflineminus">-        rv = fileChannel-&gt;Init(localStore, PR_CREATE_FILE | PR_RDWR, 0);</span>
<a href="#l27.163"></a><span id="l27.163" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l27.164"></a><span id="l27.164" class="difflineminus">-          return rv;</span>
<a href="#l27.165"></a><span id="l27.165" class="difflineminus">-        rv = fileChannel-&gt;Open(outputStream);</span>
<a href="#l27.166"></a><span id="l27.166" class="difflineminus">-        if (NS_FAILED(rv))</span>
<a href="#l27.167"></a><span id="l27.167" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aOutputStream);</span>
<a href="#l27.168"></a><span id="l27.168" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aHdr);</span>
<a href="#l27.169"></a><span id="l27.169" class="difflineplus">+</span>
<a href="#l27.170"></a><span id="l27.170" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; offlineStore;</span>
<a href="#l27.171"></a><span id="l27.171" class="difflineplus">+  nsresult rv = GetMsgStore(getter_AddRefs(offlineStore));</span>
<a href="#l27.172"></a><span id="l27.172" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.173"></a><span id="l27.173" class="difflineplus">+  bool reusable;</span>
<a href="#l27.174"></a><span id="l27.174" class="difflineplus">+  rv = offlineStore-&gt;GetNewMsgOutputStream(this, &amp;aHdr, &amp;reusable,</span>
<a href="#l27.175"></a><span id="l27.175" class="difflineplus">+                                           aOutputStream);</span>
<a href="#l27.176"></a><span id="l27.176" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.177"></a><span id="l27.177">           return rv;</span>
<a href="#l27.178"></a><span id="l27.178">       }</span>
<a href="#l27.179"></a><span id="l27.179" class="difflineminus">-    }</span>
<a href="#l27.180"></a><span id="l27.180" class="difflineminus">-#endif</span>
<a href="#l27.181"></a><span id="l27.181" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; localPath;</span>
<a href="#l27.182"></a><span id="l27.182" class="difflineminus">-  rv = GetFilePath(getter_AddRefs(localPath));</span>
<a href="#l27.183"></a><span id="l27.183" class="difflineplus">+</span>
<a href="#l27.184"></a><span id="l27.184" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l27.185"></a><span id="l27.185" class="difflineplus">+nsMsgDBFolder::GetMsgInputStream(nsIMsgDBHdr *aMsgHdr, bool *aReusable,</span>
<a href="#l27.186"></a><span id="l27.186" class="difflineplus">+                              nsIInputStream **aInputStream)</span>
<a href="#l27.187"></a><span id="l27.187" class="difflineplus">+{</span>
<a href="#l27.188"></a><span id="l27.188" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l27.189"></a><span id="l27.189" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aReusable);</span>
<a href="#l27.190"></a><span id="l27.190" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aInputStream);</span>
<a href="#l27.191"></a><span id="l27.191" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l27.192"></a><span id="l27.192" class="difflineplus">+  nsresult rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l27.193"></a><span id="l27.193">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.194"></a><span id="l27.194" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(outputStream, localPath, PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l27.195"></a><span id="l27.195" class="difflineplus">+  nsCString storeToken;</span>
<a href="#l27.196"></a><span id="l27.196" class="difflineplus">+  rv = aMsgHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(storeToken));</span>
<a href="#l27.197"></a><span id="l27.197">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.198"></a><span id="l27.198" class="difflineminus">-</span>
<a href="#l27.199"></a><span id="l27.199" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekable = do_QueryInterface(*outputStream);</span>
<a href="#l27.200"></a><span id="l27.200" class="difflineminus">-  if (seekable)</span>
<a href="#l27.201"></a><span id="l27.201" class="difflineminus">-    seekable-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l27.202"></a><span id="l27.202" class="difflineplus">+  PRInt64 offset;</span>
<a href="#l27.203"></a><span id="l27.203" class="difflineplus">+  rv = msgStore-&gt;GetMsgInputStream(this, storeToken, &amp;offset, aMsgHdr, aReusable,</span>
<a href="#l27.204"></a><span id="l27.204" class="difflineplus">+                                   aInputStream);</span>
<a href="#l27.205"></a><span id="l27.205" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.206"></a><span id="l27.206" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream(do_QueryInterface(*aInputStream));</span>
<a href="#l27.207"></a><span id="l27.207" class="difflineplus">+  if (seekableStream)</span>
<a href="#l27.208"></a><span id="l27.208" class="difflineplus">+    rv = seekableStream-&gt;Seek(PR_SEEK_SET, offset);</span>
<a href="#l27.209"></a><span id="l27.209" class="difflineplus">+  NS_WARN_IF_FALSE(seekableStream || !offset,</span>
<a href="#l27.210"></a><span id="l27.210" class="difflineplus">+                   &quot;non-zero offset w/ non-seekable stream&quot;);</span>
<a href="#l27.211"></a><span id="l27.211">   return rv;</span>
<a href="#l27.212"></a><span id="l27.212"> }</span>
<a href="#l27.213"></a><span id="l27.213"> </span>
<a href="#l27.214"></a><span id="l27.214"> // path coming in is the root path without the leaf name,</span>
<a href="#l27.215"></a><span id="l27.215"> // on the way out, it's the whole path.</span>
<a href="#l27.216"></a><span id="l27.216"> nsresult nsMsgDBFolder::CreateFileForDB(const nsAString&amp; userLeafName, nsILocalFile *path, nsILocalFile **dbFile)</span>
<a href="#l27.217"></a><span id="l27.217"> {</span>
<a href="#l27.218"></a><span id="l27.218">   NS_ENSURE_ARG_POINTER(dbFile);</span>
<a href="#l27.219"></a><span id="l27.219" class="difflineat">@@ -1495,16 +1511,17 @@ nsMsgDBFolder::OnStopRunningUrl(nsIURI *</span>
<a href="#l27.220"></a><span id="l27.220"> {</span>
<a href="#l27.221"></a><span id="l27.221">   NS_ENSURE_ARG_POINTER(aUrl);</span>
<a href="#l27.222"></a><span id="l27.222">   nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailUrl = do_QueryInterface(aUrl);</span>
<a href="#l27.223"></a><span id="l27.223">   if (mailUrl)</span>
<a href="#l27.224"></a><span id="l27.224">   {</span>
<a href="#l27.225"></a><span id="l27.225">     bool updatingFolder = false;</span>
<a href="#l27.226"></a><span id="l27.226">     if (NS_SUCCEEDED(mailUrl-&gt;GetUpdatingFolder(&amp;updatingFolder)) &amp;&amp; updatingFolder)</span>
<a href="#l27.227"></a><span id="l27.227">       NotifyFolderEvent(mFolderLoadedAtom);</span>
<a href="#l27.228"></a><span id="l27.228" class="difflineplus">+</span>
<a href="#l27.229"></a><span id="l27.229">     // be sure to remove ourselves as a url listener</span>
<a href="#l27.230"></a><span id="l27.230">     mailUrl-&gt;UnRegisterListener(this);</span>
<a href="#l27.231"></a><span id="l27.231">   }</span>
<a href="#l27.232"></a><span id="l27.232">   return NS_OK;</span>
<a href="#l27.233"></a><span id="l27.233"> }</span>
<a href="#l27.234"></a><span id="l27.234"> </span>
<a href="#l27.235"></a><span id="l27.235"> NS_IMETHODIMP</span>
<a href="#l27.236"></a><span id="l27.236"> nsMsgDBFolder::GetRetentionSettings(nsIMsgRetentionSettings **settings)</span>
<a href="#l27.237"></a><span id="l27.237" class="difflineat">@@ -1636,85 +1653,62 @@ NS_IMETHODIMP nsMsgDBFolder::IsCommandEn</span>
<a href="#l27.238"></a><span id="l27.238">   NS_ENSURE_ARG_POINTER(result);</span>
<a href="#l27.239"></a><span id="l27.239">   *result = PR_TRUE;</span>
<a href="#l27.240"></a><span id="l27.240">   return NS_OK;</span>
<a href="#l27.241"></a><span id="l27.241"> }</span>
<a href="#l27.242"></a><span id="l27.242"> </span>
<a href="#l27.243"></a><span id="l27.243"> nsresult nsMsgDBFolder::WriteStartOfNewLocalMessage()</span>
<a href="#l27.244"></a><span id="l27.244"> {</span>
<a href="#l27.245"></a><span id="l27.245">   nsCAutoString result;</span>
<a href="#l27.246"></a><span id="l27.246" class="difflineminus">-  char *ct;</span>
<a href="#l27.247"></a><span id="l27.247">   PRUint32 writeCount;</span>
<a href="#l27.248"></a><span id="l27.248">   time_t now = time ((time_t*) 0);</span>
<a href="#l27.249"></a><span id="l27.249" class="difflineminus">-  ct = ctime(&amp;now);</span>
<a href="#l27.250"></a><span id="l27.250" class="difflineplus">+  char *ct = ctime(&amp;now);</span>
<a href="#l27.251"></a><span id="l27.251">   ct[24] = 0;</span>
<a href="#l27.252"></a><span id="l27.252">   result = &quot;From - &quot;;</span>
<a href="#l27.253"></a><span id="l27.253">   result += ct;</span>
<a href="#l27.254"></a><span id="l27.254">   result += MSG_LINEBREAK;</span>
<a href="#l27.255"></a><span id="l27.255">   m_bytesAddedToLocalMsg = result.Length();</span>
<a href="#l27.256"></a><span id="l27.256"> </span>
<a href="#l27.257"></a><span id="l27.257">   nsCOMPtr &lt;nsISeekableStream&gt; seekable;</span>
<a href="#l27.258"></a><span id="l27.258" class="difflineminus">-  PRInt64 curStorePos;</span>
<a href="#l27.259"></a><span id="l27.259"> </span>
<a href="#l27.260"></a><span id="l27.260">   if (m_offlineHeader)</span>
<a href="#l27.261"></a><span id="l27.261">     seekable = do_QueryInterface(m_tempMessageStream);</span>
<a href="#l27.262"></a><span id="l27.262"> </span>
<a href="#l27.263"></a><span id="l27.263" class="difflineminus">-  if (seekable)</span>
<a href="#l27.264"></a><span id="l27.264" class="difflineminus">-  {</span>
<a href="#l27.265"></a><span id="l27.265" class="difflineminus">-    seekable-&gt;Tell(&amp;curStorePos);</span>
<a href="#l27.266"></a><span id="l27.266" class="difflineminus">-    m_offlineHeader-&gt;SetMessageOffset(curStorePos);</span>
<a href="#l27.267"></a><span id="l27.267" class="difflineminus">-  }</span>
<a href="#l27.268"></a><span id="l27.268">   m_tempMessageStream-&gt;Write(result.get(), result.Length(),</span>
<a href="#l27.269"></a><span id="l27.269">                              &amp;writeCount);</span>
<a href="#l27.270"></a><span id="l27.270" class="difflineminus">-  if (seekable)</span>
<a href="#l27.271"></a><span id="l27.271" class="difflineminus">-  {</span>
<a href="#l27.272"></a><span id="l27.272" class="difflineminus">-    m_tempMessageStream-&gt;Flush();</span>
<a href="#l27.273"></a><span id="l27.273" class="difflineminus">-    seekable-&gt;Tell(&amp;curStorePos);</span>
<a href="#l27.274"></a><span id="l27.274" class="difflineminus">-    m_offlineHeader-&gt;SetStatusOffset((PRUint32) curStorePos);</span>
<a href="#l27.275"></a><span id="l27.275" class="difflineminus">-  }</span>
<a href="#l27.276"></a><span id="l27.276"> </span>
<a href="#l27.277"></a><span id="l27.277">   NS_NAMED_LITERAL_CSTRING(MozillaStatus, &quot;X-Mozilla-Status: 0001&quot; MSG_LINEBREAK);</span>
<a href="#l27.278"></a><span id="l27.278">   m_tempMessageStream-&gt;Write(MozillaStatus.get(), MozillaStatus.Length(),</span>
<a href="#l27.279"></a><span id="l27.279">                              &amp;writeCount);</span>
<a href="#l27.280"></a><span id="l27.280">   m_bytesAddedToLocalMsg += writeCount;</span>
<a href="#l27.281"></a><span id="l27.281">   NS_NAMED_LITERAL_CSTRING(MozillaStatus2, &quot;X-Mozilla-Status2: 00000000&quot; MSG_LINEBREAK);</span>
<a href="#l27.282"></a><span id="l27.282">   m_bytesAddedToLocalMsg += MozillaStatus2.Length();</span>
<a href="#l27.283"></a><span id="l27.283">   return m_tempMessageStream-&gt;Write(MozillaStatus2.get(),</span>
<a href="#l27.284"></a><span id="l27.284">                                     MozillaStatus2.Length(), &amp;writeCount);</span>
<a href="#l27.285"></a><span id="l27.285"> }</span>
<a href="#l27.286"></a><span id="l27.286"> </span>
<a href="#l27.287"></a><span id="l27.287"> nsresult nsMsgDBFolder::StartNewOfflineMessage()</span>
<a href="#l27.288"></a><span id="l27.288"> {</span>
<a href="#l27.289"></a><span id="l27.289" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l27.290"></a><span id="l27.290" class="difflineminus">-  if (!m_tempMessageStream)</span>
<a href="#l27.291"></a><span id="l27.291" class="difflineminus">-  {</span>
<a href="#l27.292"></a><span id="l27.292">     bool isLocked;</span>
<a href="#l27.293"></a><span id="l27.293">     GetLocked(&amp;isLocked);</span>
<a href="#l27.294"></a><span id="l27.294">     bool hasSemaphore = false;</span>
<a href="#l27.295"></a><span id="l27.295">     if (isLocked)</span>
<a href="#l27.296"></a><span id="l27.296">     {</span>
<a href="#l27.297"></a><span id="l27.297">       // it's OK if we, the folder, have the semaphore.</span>
<a href="#l27.298"></a><span id="l27.298">       TestSemaphore(static_cast&lt;nsIMsgFolder*&gt;(this), &amp;hasSemaphore);</span>
<a href="#l27.299"></a><span id="l27.299">       if (!hasSemaphore)</span>
<a href="#l27.300"></a><span id="l27.300">       {</span>
<a href="#l27.301"></a><span id="l27.301">         NS_WARNING(&quot;folder locked trying to download offline&quot;);</span>
<a href="#l27.302"></a><span id="l27.302">         return NS_MSG_FOLDER_BUSY;</span>
<a href="#l27.303"></a><span id="l27.303">       }</span>
<a href="#l27.304"></a><span id="l27.304">     }</span>
<a href="#l27.305"></a><span id="l27.305" class="difflineminus">-    rv = GetOfflineStoreOutputStream(getter_AddRefs(m_tempMessageStream));</span>
<a href="#l27.306"></a><span id="l27.306" class="difflineplus">+  nsresult rv = GetOfflineStoreOutputStream(m_offlineHeader,</span>
<a href="#l27.307"></a><span id="l27.307" class="difflineplus">+                                     getter_AddRefs(m_tempMessageStream));</span>
<a href="#l27.308"></a><span id="l27.308">     if (NS_SUCCEEDED(rv) &amp;&amp; !hasSemaphore)</span>
<a href="#l27.309"></a><span id="l27.309">       AcquireSemaphore(static_cast&lt;nsIMsgFolder*&gt;(this));</span>
<a href="#l27.310"></a><span id="l27.310" class="difflineminus">-  }</span>
<a href="#l27.311"></a><span id="l27.311" class="difflineminus">-  else</span>
<a href="#l27.312"></a><span id="l27.312" class="difflineminus">-  {</span>
<a href="#l27.313"></a><span id="l27.313" class="difflineminus">-    nsCOMPtr &lt;nsISeekableStream&gt; seekable;</span>
<a href="#l27.314"></a><span id="l27.314" class="difflineminus">-    seekable = do_QueryInterface(m_tempMessageStream);</span>
<a href="#l27.315"></a><span id="l27.315" class="difflineminus">-    if (seekable)</span>
<a href="#l27.316"></a><span id="l27.316" class="difflineminus">-      seekable-&gt;Seek(PR_SEEK_END, 0);</span>
<a href="#l27.317"></a><span id="l27.317" class="difflineminus">-  }</span>
<a href="#l27.318"></a><span id="l27.318">   if (NS_SUCCEEDED(rv))</span>
<a href="#l27.319"></a><span id="l27.319">     WriteStartOfNewLocalMessage();</span>
<a href="#l27.320"></a><span id="l27.320">   m_numOfflineMsgLines = 0;</span>
<a href="#l27.321"></a><span id="l27.321">   return rv;</span>
<a href="#l27.322"></a><span id="l27.322"> }</span>
<a href="#l27.323"></a><span id="l27.323"> </span>
<a href="#l27.324"></a><span id="l27.324"> nsresult nsMsgDBFolder::EndNewOfflineMessage()</span>
<a href="#l27.325"></a><span id="l27.325"> {</span>
<a href="#l27.326"></a><span id="l27.326" class="difflineat">@@ -1776,17 +1770,27 @@ nsresult nsMsgDBFolder::EndNewOfflineMes</span>
<a href="#l27.327"></a><span id="l27.327"> #ifdef _DEBUG</span>
<a href="#l27.328"></a><span id="l27.328">     nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l27.329"></a><span id="l27.329">     GetOfflineStoreInputStream(getter_AddRefs(inputStream));</span>
<a href="#l27.330"></a><span id="l27.330">     if (inputStream)</span>
<a href="#l27.331"></a><span id="l27.331">       NS_ASSERTION(VerifyOfflineMessage(m_offlineHeader, inputStream),</span>
<a href="#l27.332"></a><span id="l27.332">                    &quot;offline message doesn't start with From &quot;);</span>
<a href="#l27.333"></a><span id="l27.333"> #endif</span>
<a href="#l27.334"></a><span id="l27.334">   }</span>
<a href="#l27.335"></a><span id="l27.335" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l27.336"></a><span id="l27.336" class="difflineplus">+  GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l27.337"></a><span id="l27.337" class="difflineplus">+  if (msgStore)</span>
<a href="#l27.338"></a><span id="l27.338" class="difflineplus">+    msgStore-&gt;FinishNewMessage(m_tempMessageStream, m_offlineHeader);</span>
<a href="#l27.339"></a><span id="l27.339" class="difflineplus">+</span>
<a href="#l27.340"></a><span id="l27.340">   m_offlineHeader = nsnull;</span>
<a href="#l27.341"></a><span id="l27.341" class="difflineplus">+  if (m_tempMessageStream)</span>
<a href="#l27.342"></a><span id="l27.342" class="difflineplus">+  {</span>
<a href="#l27.343"></a><span id="l27.343" class="difflineplus">+    m_tempMessageStream-&gt;Close();</span>
<a href="#l27.344"></a><span id="l27.344" class="difflineplus">+    m_tempMessageStream = nsnull;</span>
<a href="#l27.345"></a><span id="l27.345" class="difflineplus">+  }</span>
<a href="#l27.346"></a><span id="l27.346">   return NS_OK;</span>
<a href="#l27.347"></a><span id="l27.347"> }</span>
<a href="#l27.348"></a><span id="l27.348"> </span>
<a href="#l27.349"></a><span id="l27.349"> nsresult nsMsgDBFolder::CompactOfflineStore(nsIMsgWindow *inWindow, nsIUrlListener *aListener)</span>
<a href="#l27.350"></a><span id="l27.350"> {</span>
<a href="#l27.351"></a><span id="l27.351">   nsresult rv;</span>
<a href="#l27.352"></a><span id="l27.352">   nsCOMPtr &lt;nsIMsgFolderCompactor&gt; folderCompactor =  do_CreateInstance(NS_MSGOFFLINESTORECOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l27.353"></a><span id="l27.353">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.354"></a><span id="l27.354" class="difflineat">@@ -1832,16 +1836,23 @@ nsresult nsMsgDBFolder::HandleAutoCompac</span>
<a href="#l27.355"></a><span id="l27.355">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.356"></a><span id="l27.356">       nsCOMPtr&lt;nsIMutableArray&gt; offlineFolderArray = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l27.357"></a><span id="l27.357">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.358"></a><span id="l27.358">       PRInt32 totalExpungedBytes = 0;</span>
<a href="#l27.359"></a><span id="l27.359">       PRInt32 offlineExpungedBytes = 0;</span>
<a href="#l27.360"></a><span id="l27.360">       PRInt32 localExpungedBytes = 0;</span>
<a href="#l27.361"></a><span id="l27.361">       do</span>
<a href="#l27.362"></a><span id="l27.362">       {</span>
<a href="#l27.363"></a><span id="l27.363" class="difflineplus">+        nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l27.364"></a><span id="l27.364" class="difflineplus">+        rv = server-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l27.365"></a><span id="l27.365" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.366"></a><span id="l27.366" class="difflineplus">+        bool supportsCompaction;</span>
<a href="#l27.367"></a><span id="l27.367" class="difflineplus">+        msgStore-&gt;GetSupportsCompaction(&amp;supportsCompaction);</span>
<a href="#l27.368"></a><span id="l27.368" class="difflineplus">+        if (!supportsCompaction)</span>
<a href="#l27.369"></a><span id="l27.369" class="difflineplus">+          continue;</span>
<a href="#l27.370"></a><span id="l27.370">         nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l27.371"></a><span id="l27.371">         rv = server-&gt;GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l27.372"></a><span id="l27.372">         if(NS_SUCCEEDED(rv) &amp;&amp; rootFolder)</span>
<a href="#l27.373"></a><span id="l27.373">         {</span>
<a href="#l27.374"></a><span id="l27.374">           rv = server-&gt;GetOfflineSupportLevel(&amp;offlineSupportLevel);</span>
<a href="#l27.375"></a><span id="l27.375">           NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.376"></a><span id="l27.376">           nsCOMPtr&lt;nsISupportsArray&gt; allDescendents;</span>
<a href="#l27.377"></a><span id="l27.377">           NS_NewISupportsArray(getter_AddRefs(allDescendents));</span>
<a href="#l27.378"></a><span id="l27.378" class="difflineat">@@ -1876,19 +1887,19 @@ nsresult nsMsgDBFolder::HandleAutoCompac</span>
<a href="#l27.379"></a><span id="l27.379">               if (expungedBytes &gt; 0 )</span>
<a href="#l27.380"></a><span id="l27.380">               {</span>
<a href="#l27.381"></a><span id="l27.381">                 folderArray-&gt;AppendElement(folder, PR_FALSE);</span>
<a href="#l27.382"></a><span id="l27.382">                 localExpungedBytes += expungedBytes;</span>
<a href="#l27.383"></a><span id="l27.383">               }</span>
<a href="#l27.384"></a><span id="l27.384">             }</span>
<a href="#l27.385"></a><span id="l27.385">           }</span>
<a href="#l27.386"></a><span id="l27.386">         }</span>
<a href="#l27.387"></a><span id="l27.387" class="difflineminus">-        server = do_QueryElementAt(allServers, ++serverIndex);</span>
<a href="#l27.388"></a><span id="l27.388" class="difflineplus">+        server = do_QueryElementAt(allServers, serverIndex);</span>
<a href="#l27.389"></a><span id="l27.389">       }</span>
<a href="#l27.390"></a><span id="l27.390" class="difflineminus">-      while (serverIndex &lt; numServers);</span>
<a href="#l27.391"></a><span id="l27.391" class="difflineplus">+      while (++serverIndex &lt; numServers);</span>
<a href="#l27.392"></a><span id="l27.392">       totalExpungedBytes = localExpungedBytes + offlineExpungedBytes;</span>
<a href="#l27.393"></a><span id="l27.393">       PRInt32 purgeThreshold;</span>
<a href="#l27.394"></a><span id="l27.394">       rv = GetPurgeThreshold(&amp;purgeThreshold);</span>
<a href="#l27.395"></a><span id="l27.395">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.396"></a><span id="l27.396">       if (totalExpungedBytes &gt; (purgeThreshold * 1024))</span>
<a href="#l27.397"></a><span id="l27.397">       {</span>
<a href="#l27.398"></a><span id="l27.398">         bool okToCompact = false;</span>
<a href="#l27.399"></a><span id="l27.399">         nsCOMPtr&lt;nsIPrefService&gt; pref = do_GetService(NS_PREFSERVICE_CONTRACTID);</span>
<a href="#l27.400"></a><span id="l27.400" class="difflineat">@@ -1969,19 +1980,18 @@ nsresult</span>
<a href="#l27.401"></a><span id="l27.401"> nsMsgDBFolder::AutoCompact(nsIMsgWindow *aWindow)</span>
<a href="#l27.402"></a><span id="l27.402"> {</span>
<a href="#l27.403"></a><span id="l27.403">   // we don't check for null aWindow, because this routine can get called</span>
<a href="#l27.404"></a><span id="l27.404">   // in unit tests where we have no window. Just assume not OK if no window.</span>
<a href="#l27.405"></a><span id="l27.405">   bool prompt;</span>
<a href="#l27.406"></a><span id="l27.406">   nsresult rv = GetPromptPurgeThreshold(&amp;prompt);</span>
<a href="#l27.407"></a><span id="l27.407">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.408"></a><span id="l27.408">   PRTime timeNow = PR_Now();   //time in microseconds</span>
<a href="#l27.409"></a><span id="l27.409" class="difflineminus">-  PRTime timeAfterOneHourOfLastPurgeCheck;</span>
<a href="#l27.410"></a><span id="l27.410" class="difflineminus">-  LL_ADD(timeAfterOneHourOfLastPurgeCheck, gtimeOfLastPurgeCheck, oneHour);</span>
<a href="#l27.411"></a><span id="l27.411" class="difflineminus">-  if (LL_CMP(timeAfterOneHourOfLastPurgeCheck, &lt;, timeNow) &amp;&amp; prompt)</span>
<a href="#l27.412"></a><span id="l27.412" class="difflineplus">+  PRTime timeAfterOneHourOfLastPurgeCheck = gtimeOfLastPurgeCheck + oneHour;</span>
<a href="#l27.413"></a><span id="l27.413" class="difflineplus">+  if (timeAfterOneHourOfLastPurgeCheck &lt; timeNow &amp;&amp; prompt)</span>
<a href="#l27.414"></a><span id="l27.414">   {</span>
<a href="#l27.415"></a><span id="l27.415">     gtimeOfLastPurgeCheck = timeNow;</span>
<a href="#l27.416"></a><span id="l27.416">     nsCOMPtr&lt;nsIRunnable&gt; event = new AutoCompactEvent(aWindow, this);</span>
<a href="#l27.417"></a><span id="l27.417">     // Post this as an event because it can put up an alert, which</span>
<a href="#l27.418"></a><span id="l27.418">     // might cause issues depending on the stack when we are called.</span>
<a href="#l27.419"></a><span id="l27.419">     if (event)</span>
<a href="#l27.420"></a><span id="l27.420">       NS_DispatchToCurrentThread(event);</span>
<a href="#l27.421"></a><span id="l27.421">   }</span>
<a href="#l27.422"></a><span id="l27.422" class="difflineat">@@ -3401,16 +3411,24 @@ nsMsgDBFolder::GetCanCompact(bool *aResu</span>
<a href="#l27.423"></a><span id="l27.423"> {</span>
<a href="#l27.424"></a><span id="l27.424">   NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l27.425"></a><span id="l27.425">   bool isServer = false;</span>
<a href="#l27.426"></a><span id="l27.426">   nsresult rv = GetIsServer(&amp;isServer);</span>
<a href="#l27.427"></a><span id="l27.427">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l27.428"></a><span id="l27.428">   // servers cannot be compacted --&gt; 4.x</span>
<a href="#l27.429"></a><span id="l27.429">   // virtual search folders cannot be compacted</span>
<a href="#l27.430"></a><span id="l27.430">   *aResult = !isServer &amp;&amp; !(mFlags &amp; nsMsgFolderFlags::Virtual);</span>
<a href="#l27.431"></a><span id="l27.431" class="difflineplus">+  // Check if the store supports compaction</span>
<a href="#l27.432"></a><span id="l27.432" class="difflineplus">+  if (*aResult)</span>
<a href="#l27.433"></a><span id="l27.433" class="difflineplus">+  {</span>
<a href="#l27.434"></a><span id="l27.434" class="difflineplus">+    nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l27.435"></a><span id="l27.435" class="difflineplus">+    GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l27.436"></a><span id="l27.436" class="difflineplus">+    if (msgStore)</span>
<a href="#l27.437"></a><span id="l27.437" class="difflineplus">+      msgStore-&gt;GetSupportsCompaction(aResult);</span>
<a href="#l27.438"></a><span id="l27.438" class="difflineplus">+  }</span>
<a href="#l27.439"></a><span id="l27.439">   return NS_OK;</span>
<a href="#l27.440"></a><span id="l27.440"> }</span>
<a href="#l27.441"></a><span id="l27.441"> </span>
<a href="#l27.442"></a><span id="l27.442"> </span>
<a href="#l27.443"></a><span id="l27.443"> NS_IMETHODIMP nsMsgDBFolder::GetPrettyName(nsAString&amp; name)</span>
<a href="#l27.444"></a><span id="l27.444"> {</span>
<a href="#l27.445"></a><span id="l27.445">   return GetName(name);</span>
<a href="#l27.446"></a><span id="l27.446"> }</span>
<a href="#l27.447"></a><span id="l27.447" class="difflineat">@@ -3748,21 +3766,16 @@ NS_IMETHODIMP nsMsgDBFolder::AddSubfolde</span>
<a href="#l27.448"></a><span id="l27.448">   rv = rdf-&gt;GetResource(uri, getter_AddRefs(res));</span>
<a href="#l27.449"></a><span id="l27.449">   if (NS_FAILED(rv))</span>
<a href="#l27.450"></a><span id="l27.450">     return rv;</span>
<a href="#l27.451"></a><span id="l27.451"> </span>
<a href="#l27.452"></a><span id="l27.452">   nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(res, &amp;rv));</span>
<a href="#l27.453"></a><span id="l27.453">   if (NS_FAILED(rv))</span>
<a href="#l27.454"></a><span id="l27.454">     return rv;</span>
<a href="#l27.455"></a><span id="l27.455"> </span>
<a href="#l27.456"></a><span id="l27.456" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; path;</span>
<a href="#l27.457"></a><span id="l27.457" class="difflineminus">-  // we just need to do this for the parent folder, i.e., &quot;this&quot;.</span>
<a href="#l27.458"></a><span id="l27.458" class="difflineminus">-  rv = CreateDirectoryForFolder(getter_AddRefs(path));</span>
<a href="#l27.459"></a><span id="l27.459" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l27.460"></a><span id="l27.460" class="difflineminus">-</span>
<a href="#l27.461"></a><span id="l27.461">   folder-&gt;GetFlags((PRUint32 *)&amp;flags);</span>
<a href="#l27.462"></a><span id="l27.462">   flags |= nsMsgFolderFlags::Mail;</span>
<a href="#l27.463"></a><span id="l27.463">   folder-&gt;SetParent(this);</span>
<a href="#l27.464"></a><span id="l27.464"> </span>
<a href="#l27.465"></a><span id="l27.465">   bool isServer;</span>
<a href="#l27.466"></a><span id="l27.466">   rv = GetIsServer(&amp;isServer);</span>
<a href="#l27.467"></a><span id="l27.467"> </span>
<a href="#l27.468"></a><span id="l27.468">   //Only set these if these are top level children.</span>
<a href="#l27.469"></a><span id="l27.469" class="difflineat">@@ -3773,26 +3786,16 @@ NS_IMETHODIMP nsMsgDBFolder::AddSubfolde</span>
<a href="#l27.470"></a><span id="l27.470">       flags |= nsMsgFolderFlags::Inbox;</span>
<a href="#l27.471"></a><span id="l27.471">       SetBiffState(nsIMsgFolder::nsMsgBiffState_Unknown);</span>
<a href="#l27.472"></a><span id="l27.472">     }</span>
<a href="#l27.473"></a><span id="l27.473">     else if (name.LowerCaseEqualsLiteral(&quot;trash&quot;))</span>
<a href="#l27.474"></a><span id="l27.474">       flags |= nsMsgFolderFlags::Trash;</span>
<a href="#l27.475"></a><span id="l27.475">     else if (name.LowerCaseEqualsLiteral(&quot;unsent messages&quot;) ||</span>
<a href="#l27.476"></a><span id="l27.476">       name.LowerCaseEqualsLiteral(&quot;outbox&quot;))</span>
<a href="#l27.477"></a><span id="l27.477">       flags |= nsMsgFolderFlags::Queue;</span>
<a href="#l27.478"></a><span id="l27.478" class="difflineminus">-#if 0</span>
<a href="#l27.479"></a><span id="l27.479" class="difflineminus">-    // the logic for this has been moved into</span>
<a href="#l27.480"></a><span id="l27.480" class="difflineminus">-    // SetFlagsOnDefaultMailboxes()</span>
<a href="#l27.481"></a><span id="l27.481" class="difflineminus">-    else if(name.EqualsIgnoreCase(NS_LITERAL_STRING(&quot;Sent&quot;), nsCaseInsensitiveStringComparator()))</span>
<a href="#l27.482"></a><span id="l27.482" class="difflineminus">-      folder-&gt;SetFlag(nsMsgFolderFlags::SentMail);</span>
<a href="#l27.483"></a><span id="l27.483" class="difflineminus">-    else if(name.EqualsIgnoreCase(NS_LITERAL_STRING(&quot;Drafts&quot;), nsCaseInsensitiveStringComparator()))</span>
<a href="#l27.484"></a><span id="l27.484" class="difflineminus">-      folder-&gt;SetFlag(nsMsgFolderFlags::Drafts);</span>
<a href="#l27.485"></a><span id="l27.485" class="difflineminus">-    else if(name.EqualsIgnoreCase(NS_LITERAL_STRING(&quot;Templates&quot;), nsCaseInsensitiveStringComparator()))</span>
<a href="#l27.486"></a><span id="l27.486" class="difflineminus">-      folder-&gt;SetFlag(nsMsgFolderFlags::Templates);</span>
<a href="#l27.487"></a><span id="l27.487" class="difflineminus">-#endif</span>
<a href="#l27.488"></a><span id="l27.488">   }</span>
<a href="#l27.489"></a><span id="l27.489"> </span>
<a href="#l27.490"></a><span id="l27.490">   folder-&gt;SetFlags(flags);</span>
<a href="#l27.491"></a><span id="l27.491"> </span>
<a href="#l27.492"></a><span id="l27.492">   if (folder)</span>
<a href="#l27.493"></a><span id="l27.493">     mSubFolders.AppendObject(folder);</span>
<a href="#l27.494"></a><span id="l27.494"> </span>
<a href="#l27.495"></a><span id="l27.495">   folder.swap(*child);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l28.1"></a><span id="l28.1" class="difflineminus">--- a/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l28.2"></a><span id="l28.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgDBFolder.h</span>
<a href="#l28.3"></a><span id="l28.3" class="difflineat">@@ -42,16 +42,17 @@</span>
<a href="#l28.4"></a><span id="l28.4"> #include &quot;nsIMsgFolder.h&quot; </span>
<a href="#l28.5"></a><span id="l28.5"> #include &quot;nsRDFResource.h&quot;</span>
<a href="#l28.6"></a><span id="l28.6"> #include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l28.7"></a><span id="l28.7"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l28.8"></a><span id="l28.8"> #include &quot;nsIMsgIncomingServer.h&quot;</span>
<a href="#l28.9"></a><span id="l28.9"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l28.10"></a><span id="l28.10"> #include &quot;nsStaticAtom.h&quot;</span>
<a href="#l28.11"></a><span id="l28.11"> #include &quot;nsIDBChangeListener.h&quot;</span>
<a href="#l28.12"></a><span id="l28.12" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l28.13"></a><span id="l28.13"> #include &quot;nsIURL.h&quot;</span>
<a href="#l28.14"></a><span id="l28.14"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l28.15"></a><span id="l28.15"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l28.16"></a><span id="l28.16"> #include &quot;nsIMsgFilterList.h&quot;</span>
<a href="#l28.17"></a><span id="l28.17"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l28.18"></a><span id="l28.18"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l28.19"></a><span id="l28.19"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l28.20"></a><span id="l28.20"> #include &quot;nsITransport.h&quot;</span>
<a href="#l28.21"></a><span id="l28.21" class="difflineat">@@ -148,16 +149,18 @@ protected:</span>
<a href="#l28.22"></a><span id="l28.22">   nsresult CreateFileForDB(const nsAString&amp; userLeafName, nsILocalFile *baseDir,</span>
<a href="#l28.23"></a><span id="l28.23">                            nsILocalFile **dbFile);</span>
<a href="#l28.24"></a><span id="l28.24"> </span>
<a href="#l28.25"></a><span id="l28.25">   nsresult GetFolderCacheKey(nsILocalFile **aFile, bool createDBIfMissing = false);</span>
<a href="#l28.26"></a><span id="l28.26">   nsresult GetFolderCacheElemFromFile(nsILocalFile *file, nsIMsgFolderCacheElement **cacheElement);</span>
<a href="#l28.27"></a><span id="l28.27">   nsresult AddDirectorySeparator(nsILocalFile *path);</span>
<a href="#l28.28"></a><span id="l28.28">   nsresult CheckIfFolderExists(const nsAString&amp; newFolderName, nsIMsgFolder *parentFolder, nsIMsgWindow *msgWindow);</span>
<a href="#l28.29"></a><span id="l28.29"> </span>
<a href="#l28.30"></a><span id="l28.30" class="difflineplus">+  nsresult GetSummaryFile(nsILocalFile** aSummaryFile);</span>
<a href="#l28.31"></a><span id="l28.31" class="difflineplus">+</span>
<a href="#l28.32"></a><span id="l28.32">   // Returns true if: a) there is no need to prompt or b) the user is already</span>
<a href="#l28.33"></a><span id="l28.33">   // logged in or c) the user logged in successfully.</span>
<a href="#l28.34"></a><span id="l28.34">   static bool PromptForMasterPasswordIfNecessary();</span>
<a href="#l28.35"></a><span id="l28.35"> </span>
<a href="#l28.36"></a><span id="l28.36">   // offline support methods.</span>
<a href="#l28.37"></a><span id="l28.37">   nsresult StartNewOfflineMessage();</span>
<a href="#l28.38"></a><span id="l28.38">   nsresult WriteStartOfNewLocalMessage();</span>
<a href="#l28.39"></a><span id="l28.39">   nsresult EndNewOfflineMessage();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l29.1"></a><span id="l29.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l29.2"></a><span id="l29.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIncomingServer.cpp</span>
<a href="#l29.3"></a><span id="l29.3" class="difflineat">@@ -48,16 +48,17 @@</span>
<a href="#l29.4"></a><span id="l29.4"> #include &quot;nsStringGlue.h&quot;</span>
<a href="#l29.5"></a><span id="l29.5"> #include &quot;nsISupportsObsolete.h&quot;</span>
<a href="#l29.6"></a><span id="l29.6"> #include &quot;nsISupportsPrimitives.h&quot;</span>
<a href="#l29.7"></a><span id="l29.7"> </span>
<a href="#l29.8"></a><span id="l29.8"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l29.9"></a><span id="l29.9"> #include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l29.10"></a><span id="l29.10"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l29.11"></a><span id="l29.11"> #include &quot;nsIMsgFolderCache.h&quot;</span>
<a href="#l29.12"></a><span id="l29.12" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l29.13"></a><span id="l29.13"> #include &quot;nsIMsgFolderCacheElement.h&quot;</span>
<a href="#l29.14"></a><span id="l29.14"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l29.15"></a><span id="l29.15"> #include &quot;nsIMsgFilterService.h&quot;</span>
<a href="#l29.16"></a><span id="l29.16"> #include &quot;nsIMsgProtocolInfo.h&quot;</span>
<a href="#l29.17"></a><span id="l29.17"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l29.18"></a><span id="l29.18"> #include &quot;nsIRelativeFilePref.h&quot;</span>
<a href="#l29.19"></a><span id="l29.19"> #include &quot;nsIDocShell.h&quot;</span>
<a href="#l29.20"></a><span id="l29.20"> #include &quot;nsIAuthPrompt.h&quot;</span>
<a href="#l29.21"></a><span id="l29.21" class="difflineat">@@ -66,17 +67,16 @@</span>
<a href="#l29.22"></a><span id="l29.22"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l29.23"></a><span id="l29.23"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l29.24"></a><span id="l29.24"> #include &quot;nsIRDFService.h&quot;</span>
<a href="#l29.25"></a><span id="l29.25"> #include &quot;nsRDFCID.h&quot;</span>
<a href="#l29.26"></a><span id="l29.26"> #include &quot;nsIInterfaceRequestor.h&quot;</span>
<a href="#l29.27"></a><span id="l29.27"> #include &quot;nsIInterfaceRequestorUtils.h&quot;</span>
<a href="#l29.28"></a><span id="l29.28"> #include &quot;nsILoginInfo.h&quot;</span>
<a href="#l29.29"></a><span id="l29.29"> #include &quot;nsILoginManager.h&quot;</span>
<a href="#l29.30"></a><span id="l29.30" class="difflineminus">-</span>
<a href="#l29.31"></a><span id="l29.31"> #include &quot;nsIMsgAccountManager.h&quot;</span>
<a href="#l29.32"></a><span id="l29.32"> #include &quot;nsIMsgMdnGenerator.h&quot;</span>
<a href="#l29.33"></a><span id="l29.33"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l29.34"></a><span id="l29.34"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l29.35"></a><span id="l29.35"> #include &quot;nsAppDirectoryServiceDefs.h&quot;</span>
<a href="#l29.36"></a><span id="l29.36"> </span>
<a href="#l29.37"></a><span id="l29.37"> #define PORT_NOT_SET -1</span>
<a href="#l29.38"></a><span id="l29.38"> </span>
<a href="#l29.39"></a><span id="l29.39" class="difflineat">@@ -367,27 +367,30 @@ nsMsgIncomingServer::GetServerURI(nsACSt</span>
<a href="#l29.40"></a><span id="l29.40">       MsgEscapeString(hostname, nsINetUtil::ESCAPE_URL_PATH, escapedHostname);</span>
<a href="#l29.41"></a><span id="l29.41">       // not all servers have a hostname</span>
<a href="#l29.42"></a><span id="l29.42">       aResult.Append(escapedHostname);</span>
<a href="#l29.43"></a><span id="l29.43">   }</span>
<a href="#l29.44"></a><span id="l29.44">   return NS_OK;</span>
<a href="#l29.45"></a><span id="l29.45"> }</span>
<a href="#l29.46"></a><span id="l29.46"> </span>
<a href="#l29.47"></a><span id="l29.47"> // helper routine to create local folder on disk, if it doesn't exist.</span>
<a href="#l29.48"></a><span id="l29.48" class="difflineminus">-// Path must already have a LeafName for this to work...</span>
<a href="#l29.49"></a><span id="l29.49"> nsresult</span>
<a href="#l29.50"></a><span id="l29.50" class="difflineminus">-nsMsgIncomingServer::CreateLocalFolder(nsIFile *path, const nsACString&amp; folderName)</span>
<a href="#l29.51"></a><span id="l29.51" class="difflineplus">+nsMsgIncomingServer::CreateLocalFolder(const nsAString&amp; folderName)</span>
<a href="#l29.52"></a><span id="l29.52"> {</span>
<a href="#l29.53"></a><span id="l29.53" class="difflineminus">-  (void) path-&gt;SetNativeLeafName(folderName);</span>
<a href="#l29.54"></a><span id="l29.54" class="difflineminus">-  bool exists;</span>
<a href="#l29.55"></a><span id="l29.55" class="difflineminus">-  nsresult rv = path-&gt;Exists(&amp;exists);</span>
<a href="#l29.56"></a><span id="l29.56" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l29.57"></a><span id="l29.57" class="difflineplus">+  nsresult rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l29.58"></a><span id="l29.58">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.59"></a><span id="l29.59" class="difflineminus">-  if (!exists)</span>
<a href="#l29.60"></a><span id="l29.60" class="difflineminus">-    rv = path-&gt;Create(nsIFile::NORMAL_FILE_TYPE, 0644);</span>
<a href="#l29.61"></a><span id="l29.61" class="difflineminus">-  return rv;</span>
<a href="#l29.62"></a><span id="l29.62" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l29.63"></a><span id="l29.63" class="difflineplus">+  rv = rootFolder-&gt;GetChildNamed(folderName, getter_AddRefs(child));</span>
<a href="#l29.64"></a><span id="l29.64" class="difflineplus">+  if (child)</span>
<a href="#l29.65"></a><span id="l29.65" class="difflineplus">+    return NS_OK;</span>
<a href="#l29.66"></a><span id="l29.66" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l29.67"></a><span id="l29.67" class="difflineplus">+  rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l29.68"></a><span id="l29.68" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.69"></a><span id="l29.69" class="difflineplus">+  return msgStore-&gt;CreateFolder(rootFolder, folderName, getter_AddRefs(child));</span>
<a href="#l29.70"></a><span id="l29.70"> }</span>
<a href="#l29.71"></a><span id="l29.71"> </span>
<a href="#l29.72"></a><span id="l29.72"> nsresult</span>
<a href="#l29.73"></a><span id="l29.73"> nsMsgIncomingServer::CreateRootFolder()</span>
<a href="#l29.74"></a><span id="l29.74"> {</span>
<a href="#l29.75"></a><span id="l29.75">   nsresult rv;</span>
<a href="#l29.76"></a><span id="l29.76">   // get the URI from the incoming server</span>
<a href="#l29.77"></a><span id="l29.77">   nsCString serverUri;</span>
<a href="#l29.78"></a><span id="l29.78" class="difflineat">@@ -963,16 +966,46 @@ nsMsgIncomingServer::GetLocalPath(nsILoc</span>
<a href="#l29.79"></a><span id="l29.79">   rv = SetLocalPath(localPath);</span>
<a href="#l29.80"></a><span id="l29.80">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.81"></a><span id="l29.81"> </span>
<a href="#l29.82"></a><span id="l29.82">   localPath.swap(*aLocalPath);</span>
<a href="#l29.83"></a><span id="l29.83">   return NS_OK;</span>
<a href="#l29.84"></a><span id="l29.84"> }</span>
<a href="#l29.85"></a><span id="l29.85"> </span>
<a href="#l29.86"></a><span id="l29.86"> NS_IMETHODIMP</span>
<a href="#l29.87"></a><span id="l29.87" class="difflineplus">+nsMsgIncomingServer::GetMsgStore(nsIMsgPluggableStore **aMsgStore)</span>
<a href="#l29.88"></a><span id="l29.88" class="difflineplus">+{</span>
<a href="#l29.89"></a><span id="l29.89" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMsgStore);</span>
<a href="#l29.90"></a><span id="l29.90" class="difflineplus">+  if (!m_msgStore)</span>
<a href="#l29.91"></a><span id="l29.91" class="difflineplus">+  {</span>
<a href="#l29.92"></a><span id="l29.92" class="difflineplus">+    nsCString storeContractID;</span>
<a href="#l29.93"></a><span id="l29.93" class="difflineplus">+    nsresult rv;</span>
<a href="#l29.94"></a><span id="l29.94" class="difflineplus">+    // We don't want there to be a default pref, I think, since</span>
<a href="#l29.95"></a><span id="l29.95" class="difflineplus">+    // we can't change the default. We may want no pref to mean</span>
<a href="#l29.96"></a><span id="l29.96" class="difflineplus">+    // berkeley store, and then set the store pref off of some sort</span>
<a href="#l29.97"></a><span id="l29.97" class="difflineplus">+    // of default when creating a server. But we need to make sure</span>
<a href="#l29.98"></a><span id="l29.98" class="difflineplus">+    // that we do always write a store pref.</span>
<a href="#l29.99"></a><span id="l29.99" class="difflineplus">+    GetCharValue(&quot;storeContractID&quot;, storeContractID);</span>
<a href="#l29.100"></a><span id="l29.100" class="difflineplus">+    if (storeContractID.IsEmpty())</span>
<a href="#l29.101"></a><span id="l29.101" class="difflineplus">+    {</span>
<a href="#l29.102"></a><span id="l29.102" class="difflineplus">+      storeContractID.Assign(&quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l29.103"></a><span id="l29.103" class="difflineplus">+      SetCharValue(&quot;storeContractID&quot;, storeContractID);</span>
<a href="#l29.104"></a><span id="l29.104" class="difflineplus">+    }</span>
<a href="#l29.105"></a><span id="l29.105" class="difflineplus">+    // Right now, we just have one pluggable store per server. If we want</span>
<a href="#l29.106"></a><span id="l29.106" class="difflineplus">+    // to support multiple, this pref could be a list of pluggable store</span>
<a href="#l29.107"></a><span id="l29.107" class="difflineplus">+    // contract id's.</span>
<a href="#l29.108"></a><span id="l29.108" class="difflineplus">+    m_msgStore = do_CreateInstance(storeContractID.get(), &amp;rv);</span>
<a href="#l29.109"></a><span id="l29.109" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l29.110"></a><span id="l29.110" class="difflineplus">+  }</span>
<a href="#l29.111"></a><span id="l29.111" class="difflineplus">+  NS_IF_ADDREF(*aMsgStore = m_msgStore);</span>
<a href="#l29.112"></a><span id="l29.112" class="difflineplus">+  return NS_OK;</span>
<a href="#l29.113"></a><span id="l29.113" class="difflineplus">+}</span>
<a href="#l29.114"></a><span id="l29.114" class="difflineplus">+</span>
<a href="#l29.115"></a><span id="l29.115" class="difflineplus">+</span>
<a href="#l29.116"></a><span id="l29.116" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l29.117"></a><span id="l29.117"> nsMsgIncomingServer::SetLocalPath(nsILocalFile *aLocalPath)</span>
<a href="#l29.118"></a><span id="l29.118"> {</span>
<a href="#l29.119"></a><span id="l29.119">   NS_ENSURE_ARG_POINTER(aLocalPath);</span>
<a href="#l29.120"></a><span id="l29.120">   aLocalPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l29.121"></a><span id="l29.121">   return SetFileValue(&quot;directory-rel&quot;, &quot;directory&quot;, aLocalPath);</span>
<a href="#l29.122"></a><span id="l29.122"> }</span>
<a href="#l29.123"></a><span id="l29.123"> </span>
<a href="#l29.124"></a><span id="l29.124"> NS_IMETHODIMP</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l30.1"></a><span id="l30.1" class="difflineminus">--- a/mailnews/base/util/nsMsgIncomingServer.h</span>
<a href="#l30.2"></a><span id="l30.2" class="difflineplus">+++ b/mailnews/base/util/nsMsgIncomingServer.h</span>
<a href="#l30.3"></a><span id="l30.3" class="difflineat">@@ -46,16 +46,17 @@</span>
<a href="#l30.4"></a><span id="l30.4"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l30.5"></a><span id="l30.5"> #include &quot;nsILocalFile.h&quot;</span>
<a href="#l30.6"></a><span id="l30.6"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l30.7"></a><span id="l30.7"> #include &quot;nsWeakReference.h&quot;</span>
<a href="#l30.8"></a><span id="l30.8"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l30.9"></a><span id="l30.9"> #include &quot;nsISpamSettings.h&quot;</span>
<a href="#l30.10"></a><span id="l30.10"> #include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l30.11"></a><span id="l30.11"> #include &quot;nsDataHashtable.h&quot;</span>
<a href="#l30.12"></a><span id="l30.12" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l30.13"></a><span id="l30.13"> </span>
<a href="#l30.14"></a><span id="l30.14"> class nsIMsgFolderCache;</span>
<a href="#l30.15"></a><span id="l30.15"> class nsIMsgProtocolInfo;</span>
<a href="#l30.16"></a><span id="l30.16"> </span>
<a href="#l30.17"></a><span id="l30.17"> /*</span>
<a href="#l30.18"></a><span id="l30.18">  * base class for nsIMsgIncomingServer - derive your class from here</span>
<a href="#l30.19"></a><span id="l30.19">  * if you want to get some free implementation</span>
<a href="#l30.20"></a><span id="l30.20">  *</span>
<a href="#l30.21"></a><span id="l30.21" class="difflineat">@@ -83,17 +84,21 @@ protected:</span>
<a href="#l30.22"></a><span id="l30.22">   nsresult GetPasswordWithoutUI();</span>
<a href="#l30.23"></a><span id="l30.23"> </span>
<a href="#l30.24"></a><span id="l30.24">   nsresult ConfigureTemporaryReturnReceiptsFilter(nsIMsgFilterList *filterList);</span>
<a href="#l30.25"></a><span id="l30.25">   nsresult ConfigureTemporaryServerSpamFilters(nsIMsgFilterList *filterList);</span>
<a href="#l30.26"></a><span id="l30.26"> </span>
<a href="#l30.27"></a><span id="l30.27">   nsCOMPtr &lt;nsIMsgFolder&gt; m_rootFolder;</span>
<a href="#l30.28"></a><span id="l30.28">   nsCOMPtr &lt;nsIMsgDownloadSettings&gt; m_downloadSettings;</span>
<a href="#l30.29"></a><span id="l30.29"> </span>
<a href="#l30.30"></a><span id="l30.30" class="difflineminus">-  nsresult CreateLocalFolder(nsIFile *path, const nsACString&amp; folderName);</span>
<a href="#l30.31"></a><span id="l30.31" class="difflineplus">+  // For local servers, where we put messages. For imap/pop3, where we store</span>
<a href="#l30.32"></a><span id="l30.32" class="difflineplus">+  // offline messages.</span>
<a href="#l30.33"></a><span id="l30.33" class="difflineplus">+  nsCOMPtr &lt;nsIMsgPluggableStore&gt; m_msgStore;</span>
<a href="#l30.34"></a><span id="l30.34" class="difflineplus">+</span>
<a href="#l30.35"></a><span id="l30.35" class="difflineplus">+  nsresult CreateLocalFolder(const nsAString&amp; folderName);</span>
<a href="#l30.36"></a><span id="l30.36">   nsresult GetDeferredServers(nsIMsgIncomingServer *server, nsISupportsArray **_retval);</span>
<a href="#l30.37"></a><span id="l30.37"> </span>
<a href="#l30.38"></a><span id="l30.38">   nsresult CreateRootFolder();</span>
<a href="#l30.39"></a><span id="l30.39">   virtual nsresult CreateRootFolderFromUri(const nsCString &amp;serverUri,</span>
<a href="#l30.40"></a><span id="l30.40">                                            nsIMsgFolder **rootFolder) = 0;</span>
<a href="#l30.41"></a><span id="l30.41"> </span>
<a href="#l30.42"></a><span id="l30.42">   nsresult InternalSetHostName(const nsACString&amp; aHostname, const char * prefName);</span>
<a href="#l30.43"></a><span id="l30.43"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l31.1"></a><span id="l31.1" class="difflineminus">--- a/mailnews/build/nsMailModule.cpp</span>
<a href="#l31.2"></a><span id="l31.2" class="difflineplus">+++ b/mailnews/build/nsMailModule.cpp</span>
<a href="#l31.3"></a><span id="l31.3" class="difflineat">@@ -123,16 +123,18 @@</span>
<a href="#l31.4"></a><span id="l31.4"> #include &quot;nsMsgGroupView.h&quot;</span>
<a href="#l31.5"></a><span id="l31.5"> #include &quot;nsMsgOfflineManager.h&quot;</span>
<a href="#l31.6"></a><span id="l31.6"> #include &quot;nsMsgProgress.h&quot;</span>
<a href="#l31.7"></a><span id="l31.7"> #include &quot;nsSpamSettings.h&quot;</span>
<a href="#l31.8"></a><span id="l31.8"> #include &quot;nsMsgContentPolicy.h&quot;</span>
<a href="#l31.9"></a><span id="l31.9"> #include &quot;nsCidProtocolHandler.h&quot;</span>
<a href="#l31.10"></a><span id="l31.10"> #include &quot;nsRssIncomingServer.h&quot;</span>
<a href="#l31.11"></a><span id="l31.11"> #include &quot;nsRssService.h&quot;</span>
<a href="#l31.12"></a><span id="l31.12" class="difflineplus">+#include &quot;nsMsgBrkMBoxStore.h&quot;</span>
<a href="#l31.13"></a><span id="l31.13" class="difflineplus">+#include &quot;nsMsgMaildirStore.h&quot;</span>
<a href="#l31.14"></a><span id="l31.14"> #include &quot;nsMsgTagService.h&quot;</span>
<a href="#l31.15"></a><span id="l31.15"> #include &quot;nsMsgFolderNotificationService.h&quot;</span>
<a href="#l31.16"></a><span id="l31.16"> #include &quot;nsMailDirProvider.h&quot;</span>
<a href="#l31.17"></a><span id="l31.17"> </span>
<a href="#l31.18"></a><span id="l31.18"> #ifdef XP_WIN</span>
<a href="#l31.19"></a><span id="l31.19"> #include &quot;nsMessengerWinIntegration.h&quot;</span>
<a href="#l31.20"></a><span id="l31.20"> #endif</span>
<a href="#l31.21"></a><span id="l31.21"> #ifdef XP_OS2</span>
<a href="#l31.22"></a><span id="l31.22" class="difflineat">@@ -643,16 +645,18 @@ NS_GENERIC_FACTORY_CONSTRUCTOR(nsParseMa</span>
<a href="#l31.23"></a><span id="l31.23"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsPop3IncomingServer)</span>
<a href="#l31.24"></a><span id="l31.24"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsRssIncomingServer)</span>
<a href="#l31.25"></a><span id="l31.25"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsRssService)</span>
<a href="#l31.26"></a><span id="l31.26"> #ifdef HAVE_MOVEMAIL</span>
<a href="#l31.27"></a><span id="l31.27"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMovemailIncomingServer)</span>
<a href="#l31.28"></a><span id="l31.28"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMovemailService)</span>
<a href="#l31.29"></a><span id="l31.29"> #endif /* HAVE_MOVEMAIL */</span>
<a href="#l31.30"></a><span id="l31.30"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsNoIncomingServer)</span>
<a href="#l31.31"></a><span id="l31.31" class="difflineplus">+NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgBrkMBoxStore)</span>
<a href="#l31.32"></a><span id="l31.32" class="difflineplus">+NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgMaildirStore)</span>
<a href="#l31.33"></a><span id="l31.33"> </span>
<a href="#l31.34"></a><span id="l31.34"> NS_DEFINE_NAMED_CID(NS_MAILBOXURL_CID);</span>
<a href="#l31.35"></a><span id="l31.35"> NS_DEFINE_NAMED_CID(NS_MAILBOXSERVICE_CID);</span>
<a href="#l31.36"></a><span id="l31.36"> NS_DEFINE_NAMED_CID(NS_MAILBOXPARSER_CID);</span>
<a href="#l31.37"></a><span id="l31.37"> NS_DEFINE_NAMED_CID(NS_POP3URL_CID);</span>
<a href="#l31.38"></a><span id="l31.38"> NS_DEFINE_NAMED_CID(NS_POP3SERVICE_CID);</span>
<a href="#l31.39"></a><span id="l31.39"> NS_DEFINE_NAMED_CID(NS_NONESERVICE_CID);</span>
<a href="#l31.40"></a><span id="l31.40"> #ifdef HAVE_MOVEMAIL</span>
<a href="#l31.41"></a><span id="l31.41" class="difflineat">@@ -662,16 +666,18 @@ NS_DEFINE_NAMED_CID(NS_LOCALMAILFOLDERRE</span>
<a href="#l31.42"></a><span id="l31.42"> NS_DEFINE_NAMED_CID(NS_POP3INCOMINGSERVER_CID);</span>
<a href="#l31.43"></a><span id="l31.43"> #ifdef HAVE_MOVEMAIL</span>
<a href="#l31.44"></a><span id="l31.44"> NS_DEFINE_NAMED_CID(NS_MOVEMAILINCOMINGSERVER_CID);</span>
<a href="#l31.45"></a><span id="l31.45"> #endif /* HAVE_MOVEMAIL */</span>
<a href="#l31.46"></a><span id="l31.46"> NS_DEFINE_NAMED_CID(NS_NOINCOMINGSERVER_CID);</span>
<a href="#l31.47"></a><span id="l31.47"> NS_DEFINE_NAMED_CID(NS_PARSEMAILMSGSTATE_CID);</span>
<a href="#l31.48"></a><span id="l31.48"> NS_DEFINE_NAMED_CID(NS_RSSSERVICE_CID);</span>
<a href="#l31.49"></a><span id="l31.49"> NS_DEFINE_NAMED_CID(NS_RSSINCOMINGSERVER_CID);</span>
<a href="#l31.50"></a><span id="l31.50" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_BRKMBOXSTORE_CID);</span>
<a href="#l31.51"></a><span id="l31.51" class="difflineplus">+NS_DEFINE_NAMED_CID(NS_MAILDIRSTORE_CID);</span>
<a href="#l31.52"></a><span id="l31.52"> </span>
<a href="#l31.53"></a><span id="l31.53"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.54"></a><span id="l31.54"> // msgdb factories</span>
<a href="#l31.55"></a><span id="l31.55"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l31.56"></a><span id="l31.56"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMsgDBService)</span>
<a href="#l31.57"></a><span id="l31.57"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsMailDatabase)</span>
<a href="#l31.58"></a><span id="l31.58"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsNewsDatabase)</span>
<a href="#l31.59"></a><span id="l31.59"> NS_GENERIC_FACTORY_CONSTRUCTOR(nsImapMailDatabase)</span>
<a href="#l31.60"></a><span id="l31.60" class="difflineat">@@ -950,16 +956,18 @@ const mozilla::Module::CIDEntry kMailNew</span>
<a href="#l31.61"></a><span id="l31.61">   { &amp;kNS_POP3INCOMINGSERVER_CID, false, NULL, nsPop3IncomingServerConstructor },</span>
<a href="#l31.62"></a><span id="l31.62"> #ifdef HAVE_MOVEMAIL</span>
<a href="#l31.63"></a><span id="l31.63">   { &amp;kNS_MOVEMAILINCOMINGSERVER_CID, false, NULL, nsMovemailIncomingServerConstructor },</span>
<a href="#l31.64"></a><span id="l31.64"> #endif /* HAVE_MOVEMAIL */</span>
<a href="#l31.65"></a><span id="l31.65">   { &amp;kNS_NOINCOMINGSERVER_CID, false, NULL, nsNoIncomingServerConstructor },</span>
<a href="#l31.66"></a><span id="l31.66">   { &amp;kNS_PARSEMAILMSGSTATE_CID, false, NULL, nsParseMailMessageStateConstructor },</span>
<a href="#l31.67"></a><span id="l31.67">   { &amp;kNS_RSSSERVICE_CID, false, NULL, nsRssServiceConstructor },</span>
<a href="#l31.68"></a><span id="l31.68">   { &amp;kNS_RSSINCOMINGSERVER_CID, false, NULL, nsRssIncomingServerConstructor },</span>
<a href="#l31.69"></a><span id="l31.69" class="difflineplus">+  { &amp;kNS_BRKMBOXSTORE_CID, false, NULL, nsMsgBrkMBoxStoreConstructor },</span>
<a href="#l31.70"></a><span id="l31.70" class="difflineplus">+  { &amp;kNS_MAILDIRSTORE_CID, false, NULL, nsMsgMaildirStoreConstructor },</span>
<a href="#l31.71"></a><span id="l31.71">   // msgdb Entries</span>
<a href="#l31.72"></a><span id="l31.72">   { &amp;kNS_MAILDB_CID, false, NULL, nsMailDatabaseConstructor },</span>
<a href="#l31.73"></a><span id="l31.73">   { &amp;kNS_NEWSDB_CID, false, NULL, nsNewsDatabaseConstructor },</span>
<a href="#l31.74"></a><span id="l31.74">   { &amp;kNS_IMAPDB_CID, false, NULL, nsImapMailDatabaseConstructor },</span>
<a href="#l31.75"></a><span id="l31.75">   { &amp;kNS_MSG_RETENTIONSETTINGS_CID, false, NULL, nsMsgRetentionSettingsConstructor },</span>
<a href="#l31.76"></a><span id="l31.76">   { &amp;kNS_MSG_DOWNLOADSETTINGS_CID, false, NULL, nsMsgDownloadSettingsConstructor },</span>
<a href="#l31.77"></a><span id="l31.77">   { &amp;kNS_MSGDB_SERVICE_CID, false, NULL, nsMsgDBServiceConstructor },</span>
<a href="#l31.78"></a><span id="l31.78">   // Mime Entries</span>
<a href="#l31.79"></a><span id="l31.79" class="difflineat">@@ -1160,16 +1168,18 @@ const mozilla::Module::ContractIDEntry k</span>
<a href="#l31.80"></a><span id="l31.80"> #ifdef HAVE_MOVEMAIL</span>
<a href="#l31.81"></a><span id="l31.81">   { NS_MOVEMAILPROTOCOLINFO_CONTRACTID, &amp;kNS_MOVEMAILSERVICE_CID },</span>
<a href="#l31.82"></a><span id="l31.82"> #endif /* HAVE_MOVEMAIL */</span>
<a href="#l31.83"></a><span id="l31.83">   { NS_LOCALMAILFOLDERRESOURCE_CONTRACTID, &amp;kNS_LOCALMAILFOLDERRESOURCE_CID },</span>
<a href="#l31.84"></a><span id="l31.84">   { NS_POP3INCOMINGSERVER_CONTRACTID, &amp;kNS_POP3INCOMINGSERVER_CID },</span>
<a href="#l31.85"></a><span id="l31.85"> #ifdef HAVE_MOVEMAIL</span>
<a href="#l31.86"></a><span id="l31.86">   { NS_MOVEMAILINCOMINGSERVER_CONTRACTID, &amp;kNS_MOVEMAILINCOMINGSERVER_CID },</span>
<a href="#l31.87"></a><span id="l31.87"> #endif /* HAVE_MOVEMAIL */</span>
<a href="#l31.88"></a><span id="l31.88" class="difflineplus">+  { NS_BRKMBOXSTORE_CONTRACTID, &amp;kNS_BRKMBOXSTORE_CID },</span>
<a href="#l31.89"></a><span id="l31.89" class="difflineplus">+  { NS_MAILDIRSTORE_CONTRACTID, &amp;kNS_MAILDIRSTORE_CID },</span>
<a href="#l31.90"></a><span id="l31.90">   { NS_NOINCOMINGSERVER_CONTRACTID, &amp;kNS_NOINCOMINGSERVER_CID },</span>
<a href="#l31.91"></a><span id="l31.91">   { NS_PARSEMAILMSGSTATE_CONTRACTID, &amp;kNS_PARSEMAILMSGSTATE_CID },</span>
<a href="#l31.92"></a><span id="l31.92">   { NS_RSSSERVICE_CONTRACTID, &amp;kNS_RSSSERVICE_CID },</span>
<a href="#l31.93"></a><span id="l31.93">   { NS_RSSPROTOCOLINFO_CONTRACTID, &amp;kNS_RSSSERVICE_CID },</span>
<a href="#l31.94"></a><span id="l31.94">   { NS_RSSINCOMINGSERVER_CONTRACTID, &amp;kNS_RSSINCOMINGSERVER_CID },</span>
<a href="#l31.95"></a><span id="l31.95">   // msgdb Entries</span>
<a href="#l31.96"></a><span id="l31.96">   { NS_MAILBOXDB_CONTRACTID, &amp;kNS_MAILDB_CID },</span>
<a href="#l31.97"></a><span id="l31.97">   { NS_NEWSDB_CONTRACTID, &amp;kNS_NEWSDB_CID },</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l32.1"></a><span id="l32.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_attachment.js</span>
<a href="#l32.2"></a><span id="l32.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_attachment.js</span>
<a href="#l32.3"></a><span id="l32.3" class="difflineat">@@ -102,65 +102,65 @@ function createMessage(folding, input) {</span>
<a href="#l32.4"></a><span id="l32.4">   var fields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l32.5"></a><span id="l32.5">                  .createInstance(Ci.nsIMsgCompFields);</span>
<a href="#l32.6"></a><span id="l32.6">   var params = Cc[&quot;@mozilla.org/messengercompose/composeparams;1&quot;]</span>
<a href="#l32.7"></a><span id="l32.7">                  .createInstance(Ci.nsIMsgComposeParams);</span>
<a href="#l32.8"></a><span id="l32.8">   params.composeFields = fields;</span>
<a href="#l32.9"></a><span id="l32.9">   msgCompose.initialize(params);</span>
<a href="#l32.10"></a><span id="l32.10">   var identity = getSmtpIdentity(null, gSmtpServer);</span>
<a href="#l32.11"></a><span id="l32.11"> </span>
<a href="#l32.12"></a><span id="l32.12" class="difflineminus">-  var rootFolder = gLocalIncomingServer.rootMsgFolder;</span>
<a href="#l32.13"></a><span id="l32.13">   gDraftFolder = null;</span>
<a href="#l32.14"></a><span id="l32.14">   // Make sure the drafts folder is empty</span>
<a href="#l32.15"></a><span id="l32.15">   try {</span>
<a href="#l32.16"></a><span id="l32.16" class="difflineminus">-    gDraftFolder = rootFolder.getChildNamed(&quot;Drafts&quot;);</span>
<a href="#l32.17"></a><span id="l32.17" class="difflineplus">+    gDraftFolder = gLocalRootFolder.getChildNamed(&quot;Drafts&quot;);</span>
<a href="#l32.18"></a><span id="l32.18">     // try to delete</span>
<a href="#l32.19"></a><span id="l32.19" class="difflineminus">-    rootFolder.propagateDelete(gDraftFolder, true, null);</span>
<a href="#l32.20"></a><span id="l32.20" class="difflineminus">-  } catch (e) {</span>
<a href="#l32.21"></a><span id="l32.21" class="difflineplus">+    gLocalRootFolder.propagateDelete(gDraftFolder, true, null);</span>
<a href="#l32.22"></a><span id="l32.22" class="difflineplus">+  } catch (ex) {</span>
<a href="#l32.23"></a><span id="l32.23" class="difflineplus">+      dump(ex + &quot; didn't find drafts folder\n&quot;);</span>
<a href="#l32.24"></a><span id="l32.24">     // we don't have to remove the folder because it doen't exist yet</span>
<a href="#l32.25"></a><span id="l32.25">   }</span>
<a href="#l32.26"></a><span id="l32.26">   // Create a new, empty drafts folder</span>
<a href="#l32.27"></a><span id="l32.27" class="difflineminus">-  gDraftFolder = rootFolder.createLocalSubfolder(&quot;Drafts&quot;);</span>
<a href="#l32.28"></a><span id="l32.28" class="difflineplus">+  gDraftFolder = gLocalRootFolder.createLocalSubfolder(&quot;Drafts&quot;);</span>
<a href="#l32.29"></a><span id="l32.29"> </span>
<a href="#l32.30"></a><span id="l32.30">   var attachment = Cc[&quot;@mozilla.org/messengercompose/attachment;1&quot;]</span>
<a href="#l32.31"></a><span id="l32.31">                      .createInstance(Ci.nsIMsgAttachment);</span>
<a href="#l32.32"></a><span id="l32.32">   attachment.url = &quot;data:,&quot;;</span>
<a href="#l32.33"></a><span id="l32.33">   attachment.name = input;</span>
<a href="#l32.34"></a><span id="l32.34">   fields.addAttachment(attachment);</span>
<a href="#l32.35"></a><span id="l32.35"> </span>
<a href="#l32.36"></a><span id="l32.36">   var progress = Cc[&quot;@mozilla.org/messenger/progress;1&quot;]</span>
<a href="#l32.37"></a><span id="l32.37">                    .createInstance(Ci.nsIMsgProgress);</span>
<a href="#l32.38"></a><span id="l32.38">   progress.registerListener(progressListener);</span>
<a href="#l32.39"></a><span id="l32.39">   msgCompose.SendMsg(Ci.nsIMsgSend.nsMsgSaveAsDraft, identity, &quot;&quot;, null,</span>
<a href="#l32.40"></a><span id="l32.40">                      progress);</span>
<a href="#l32.41"></a><span id="l32.41"> }</span>
<a href="#l32.42"></a><span id="l32.42"> </span>
<a href="#l32.43"></a><span id="l32.43"> function checkAttachment(expectedCD, expectedCT) {</span>
<a href="#l32.44"></a><span id="l32.44" class="difflineminus">-  var fileData = loadFileToString(gDraftFolder.filePath);</span>
<a href="#l32.45"></a><span id="l32.45" class="difflineminus">-  var pos = fileData.indexOf(&quot;Content-Disposition:&quot;);</span>
<a href="#l32.46"></a><span id="l32.46" class="difflineplus">+  let msgData = loadMessageToString(gDraftFolder, firstMsgHdr(gDraftFolder));</span>
<a href="#l32.47"></a><span id="l32.47" class="difflineplus">+  let pos = msgData.indexOf(&quot;Content-Disposition:&quot;);</span>
<a href="#l32.48"></a><span id="l32.48">   do_check_neq(pos, -1);</span>
<a href="#l32.49"></a><span id="l32.49" class="difflineminus">-  var contentDisposition = fileData.substr(pos);</span>
<a href="#l32.50"></a><span id="l32.50" class="difflineplus">+  let contentDisposition = msgData.substr(pos);</span>
<a href="#l32.51"></a><span id="l32.51">   pos = 0;</span>
<a href="#l32.52"></a><span id="l32.52">   do {</span>
<a href="#l32.53"></a><span id="l32.53">     pos = contentDisposition.indexOf(&quot;\n&quot;, pos);</span>
<a href="#l32.54"></a><span id="l32.54">     do_check_neq(pos, -1);</span>
<a href="#l32.55"></a><span id="l32.55">     pos++;</span>
<a href="#l32.56"></a><span id="l32.56">   } while (contentDisposition.substr(pos, 1) == &quot; &quot;);</span>
<a href="#l32.57"></a><span id="l32.57">   contentDisposition = contentDisposition.substr(0, pos);</span>
<a href="#l32.58"></a><span id="l32.58">   do_check_eq(contentDisposition, expectedCD);</span>
<a href="#l32.59"></a><span id="l32.59"> </span>
<a href="#l32.60"></a><span id="l32.60" class="difflineminus">-  pos = fileData.indexOf(&quot;Content-Type:&quot;); // multipart</span>
<a href="#l32.61"></a><span id="l32.61" class="difflineplus">+  pos = msgData.indexOf(&quot;Content-Type:&quot;); // multipart</span>
<a href="#l32.62"></a><span id="l32.62">   do_check_neq(pos, -1);</span>
<a href="#l32.63"></a><span id="l32.63" class="difflineminus">-  fileData = fileData.substr(pos + 13);</span>
<a href="#l32.64"></a><span id="l32.64" class="difflineminus">-  pos = fileData.indexOf(&quot;Content-Type:&quot;); // body</span>
<a href="#l32.65"></a><span id="l32.65" class="difflineplus">+  msgData = msgData.substr(pos + 13);</span>
<a href="#l32.66"></a><span id="l32.66" class="difflineplus">+  pos = msgData.indexOf(&quot;Content-Type:&quot;); // body</span>
<a href="#l32.67"></a><span id="l32.67">   do_check_neq(pos, -1);</span>
<a href="#l32.68"></a><span id="l32.68" class="difflineminus">-  fileData = fileData.substr(pos + 13);</span>
<a href="#l32.69"></a><span id="l32.69" class="difflineminus">-  pos = fileData.indexOf(&quot;Content-Type:&quot;); // first attachment</span>
<a href="#l32.70"></a><span id="l32.70" class="difflineplus">+  msgData = msgData.substr(pos + 13);</span>
<a href="#l32.71"></a><span id="l32.71" class="difflineplus">+  pos = msgData.indexOf(&quot;Content-Type:&quot;); // first attachment</span>
<a href="#l32.72"></a><span id="l32.72">   do_check_neq(pos, -1);</span>
<a href="#l32.73"></a><span id="l32.73" class="difflineminus">-  var contentType = fileData.substr(pos);</span>
<a href="#l32.74"></a><span id="l32.74" class="difflineplus">+  var contentType = msgData.substr(pos);</span>
<a href="#l32.75"></a><span id="l32.75">   pos = 0;</span>
<a href="#l32.76"></a><span id="l32.76">   do {</span>
<a href="#l32.77"></a><span id="l32.77">     pos = contentType.indexOf(&quot;\n&quot;, pos);</span>
<a href="#l32.78"></a><span id="l32.78">     do_check_neq(pos, -1);</span>
<a href="#l32.79"></a><span id="l32.79">     pos++;</span>
<a href="#l32.80"></a><span id="l32.80">   } while (contentType.substr(pos, 1) == &quot; &quot;);</span>
<a href="#l32.81"></a><span id="l32.81">   contentType = contentType.substr(0, pos);</span>
<a href="#l32.82"></a><span id="l32.82">   do_check_eq(contentType, expectedCT);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l33.1"></a><span id="l33.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_bug474774.js</span>
<a href="#l33.2"></a><span id="l33.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_bug474774.js</span>
<a href="#l33.3"></a><span id="l33.3" class="difflineat">@@ -86,26 +86,26 @@ function OnStopCopy(aStatus)</span>
<a href="#l33.4"></a><span id="l33.4">     do_check_eq(msgSendLater.sendingMessages, false);</span>
<a href="#l33.5"></a><span id="l33.5"> </span>
<a href="#l33.6"></a><span id="l33.6">     let folder = msgSendLater.getUnsentMessagesFolder(identity);</span>
<a href="#l33.7"></a><span id="l33.7"> </span>
<a href="#l33.8"></a><span id="l33.8">     // Check we have a message in the unsent message folder</span>
<a href="#l33.9"></a><span id="l33.9">     do_check_eq(folder.getTotalMessages(false), 1);</span>
<a href="#l33.10"></a><span id="l33.10"> </span>
<a href="#l33.11"></a><span id="l33.11">     // Now do a comparison of what is in the sent mail folder</span>
<a href="#l33.12"></a><span id="l33.12" class="difflineminus">-    var fileData = loadFileToString(folder.filePath);</span>
<a href="#l33.13"></a><span id="l33.13" class="difflineplus">+    let msgData = loadMessageToString(folder, firstMsgHdr(folder));</span>
<a href="#l33.14"></a><span id="l33.14"> </span>
<a href="#l33.15"></a><span id="l33.15">     // Skip the headers etc that mailnews adds</span>
<a href="#l33.16"></a><span id="l33.16" class="difflineminus">-    var pos = fileData.indexOf(&quot;From:&quot;);</span>
<a href="#l33.17"></a><span id="l33.17" class="difflineplus">+    var pos = msgData.indexOf(&quot;From:&quot;);</span>
<a href="#l33.18"></a><span id="l33.18">     do_check_neq(pos, -1);</span>
<a href="#l33.19"></a><span id="l33.19"> </span>
<a href="#l33.20"></a><span id="l33.20" class="difflineminus">-    fileData = fileData.substr(pos);</span>
<a href="#l33.21"></a><span id="l33.21" class="difflineplus">+    msgData = msgData.substr(pos);</span>
<a href="#l33.22"></a><span id="l33.22"> </span>
<a href="#l33.23"></a><span id="l33.23">     // Check the data is matching.</span>
<a href="#l33.24"></a><span id="l33.24" class="difflineminus">-    do_check_eq(originalData, fileData);</span>
<a href="#l33.25"></a><span id="l33.25" class="difflineplus">+    do_check_eq(originalData, msgData);</span>
<a href="#l33.26"></a><span id="l33.26"> </span>
<a href="#l33.27"></a><span id="l33.27">     do_test_pending();</span>
<a href="#l33.28"></a><span id="l33.28">     sendMessageLater();</span>
<a href="#l33.29"></a><span id="l33.29">   } catch (e) {</span>
<a href="#l33.30"></a><span id="l33.30">     do_throw(e);</span>
<a href="#l33.31"></a><span id="l33.31">   } finally {</span>
<a href="#l33.32"></a><span id="l33.32">     server.stop();</span>
<a href="#l33.33"></a><span id="l33.33"> </span>
<a href="#l33.34"></a><span id="l33.34" class="difflineat">@@ -180,17 +180,17 @@ function run_test() {</span>
<a href="#l33.35"></a><span id="l33.35"> </span>
<a href="#l33.36"></a><span id="l33.36">   var smtpServer = getBasicSmtpServer();</span>
<a href="#l33.37"></a><span id="l33.37">   identity = getSmtpIdentity(kSender, smtpServer);</span>
<a href="#l33.38"></a><span id="l33.38"> </span>
<a href="#l33.39"></a><span id="l33.39">   account.addIdentity(identity);</span>
<a href="#l33.40"></a><span id="l33.40">   account.defaultIdentity = identity;</span>
<a href="#l33.41"></a><span id="l33.41">   account.incomingServer = incomingServer;</span>
<a href="#l33.42"></a><span id="l33.42"> </span>
<a href="#l33.43"></a><span id="l33.43" class="difflineminus">-  sentFolder = gLocalIncomingServer.rootMsgFolder.createLocalSubfolder(&quot;Sent&quot;);</span>
<a href="#l33.44"></a><span id="l33.44" class="difflineplus">+  sentFolder = gLocalRootFolder.createLocalSubfolder(&quot;Sent&quot;);</span>
<a href="#l33.45"></a><span id="l33.45"> </span>
<a href="#l33.46"></a><span id="l33.46">   identity.doFcc = false;</span>
<a href="#l33.47"></a><span id="l33.47"> </span>
<a href="#l33.48"></a><span id="l33.48">   // Now prepare to actually &quot;send&quot; the message later, i.e. dump it in the</span>
<a href="#l33.49"></a><span id="l33.49">   // unsent messages folder.</span>
<a href="#l33.50"></a><span id="l33.50"> </span>
<a href="#l33.51"></a><span id="l33.51">   var compFields = Cc[&quot;@mozilla.org/messengercompose/composefields;1&quot;]</span>
<a href="#l33.52"></a><span id="l33.52">                      .createInstance(Ci.nsIMsgCompFields);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l34.1"></a><span id="l34.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_detectAttachmentCharset.js</span>
<a href="#l34.2"></a><span id="l34.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_detectAttachmentCharset.js</span>
<a href="#l34.3"></a><span id="l34.3" class="difflineat">@@ -72,22 +72,60 @@ function createMessage(attachmentPath)</span>
<a href="#l34.4"></a><span id="l34.4">                    .createInstance(Ci.nsIMsgProgress);</span>
<a href="#l34.5"></a><span id="l34.5">   progress.registerListener(progressListener);</span>
<a href="#l34.6"></a><span id="l34.6">   msgCompose.SendMsg(Ci.nsIMsgSend.nsMsgSaveAsDraft, identity, &quot;&quot;, null,</span>
<a href="#l34.7"></a><span id="l34.7">                      progress);</span>
<a href="#l34.8"></a><span id="l34.8"> }</span>
<a href="#l34.9"></a><span id="l34.9"> </span>
<a href="#l34.10"></a><span id="l34.10"> function checkAttachment(charset)</span>
<a href="#l34.11"></a><span id="l34.11"> {</span>
<a href="#l34.12"></a><span id="l34.12" class="difflineminus">-  var fileData = loadFileToString(gDraftFolder.filePath);</span>
<a href="#l34.13"></a><span id="l34.13" class="difflineminus">-  var pos = fileData.indexOf(&quot;Content-Type: text/plain; charset=&quot; + charset + &quot;;&quot;);</span>
<a href="#l34.14"></a><span id="l34.14" class="difflineplus">+  var msgData = getContentFromMessage(firstMsgHdr(gDraftFolder));</span>
<a href="#l34.15"></a><span id="l34.15" class="difflineplus">+  var pos = msgData.indexOf(&quot;Content-Type: text/plain; charset=&quot; + charset + &quot;;&quot;);</span>
<a href="#l34.16"></a><span id="l34.16">   do_check_neq(pos, -1);</span>
<a href="#l34.17"></a><span id="l34.17">   do_timeout(0, function() {doTest(++gCurTestNum);});</span>
<a href="#l34.18"></a><span id="l34.18"> }</span>
<a href="#l34.19"></a><span id="l34.19"> </span>
<a href="#l34.20"></a><span id="l34.20" class="difflineplus">+// get the first message header found in a folder</span>
<a href="#l34.21"></a><span id="l34.21" class="difflineplus">+function firstMsgHdr(folder)</span>
<a href="#l34.22"></a><span id="l34.22" class="difflineplus">+{</span>
<a href="#l34.23"></a><span id="l34.23" class="difflineplus">+  let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l34.24"></a><span id="l34.24" class="difflineplus">+  if (enumerator.hasMoreElements())</span>
<a href="#l34.25"></a><span id="l34.25" class="difflineplus">+    return enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l34.26"></a><span id="l34.26" class="difflineplus">+  return null;</span>
<a href="#l34.27"></a><span id="l34.27" class="difflineplus">+}</span>
<a href="#l34.28"></a><span id="l34.28" class="difflineplus">+</span>
<a href="#l34.29"></a><span id="l34.29" class="difflineplus">+/*</span>
<a href="#l34.30"></a><span id="l34.30" class="difflineplus">+ * Get the full message content from a local folder.</span>
<a href="#l34.31"></a><span id="l34.31" class="difflineplus">+ *</span>
<a href="#l34.32"></a><span id="l34.32" class="difflineplus">+ * aMsgHdr: nsIMsgDBHdr object whose text body will be read</span>
<a href="#l34.33"></a><span id="l34.33" class="difflineplus">+ *          returns: string with full message contents</span>
<a href="#l34.34"></a><span id="l34.34" class="difflineplus">+ */</span>
<a href="#l34.35"></a><span id="l34.35" class="difflineplus">+function getContentFromMessage(aMsgHdr)</span>
<a href="#l34.36"></a><span id="l34.36" class="difflineplus">+{</span>
<a href="#l34.37"></a><span id="l34.37" class="difflineplus">+  const MAX_MESSAGE_LENGTH = 65536;</span>
<a href="#l34.38"></a><span id="l34.38" class="difflineplus">+  let msgFolder = aMsgHdr.folder;</span>
<a href="#l34.39"></a><span id="l34.39" class="difflineplus">+  let msgUri = msgFolder.getUriForMsg(aMsgHdr);</span>
<a href="#l34.40"></a><span id="l34.40" class="difflineplus">+</span>
<a href="#l34.41"></a><span id="l34.41" class="difflineplus">+  let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l34.42"></a><span id="l34.42" class="difflineplus">+                    .createInstance(Ci.nsIMessenger);</span>
<a href="#l34.43"></a><span id="l34.43" class="difflineplus">+  let streamListener = Cc[&quot;@mozilla.org/network/sync-stream-listener;1&quot;]</span>
<a href="#l34.44"></a><span id="l34.44" class="difflineplus">+                         .createInstance(Ci.nsISyncStreamListener);</span>
<a href="#l34.45"></a><span id="l34.45" class="difflineplus">+  messenger.messageServiceFromURI(msgUri).streamMessage(msgUri,</span>
<a href="#l34.46"></a><span id="l34.46" class="difflineplus">+                                                        streamListener,</span>
<a href="#l34.47"></a><span id="l34.47" class="difflineplus">+                                                        null,</span>
<a href="#l34.48"></a><span id="l34.48" class="difflineplus">+                                                        null,</span>
<a href="#l34.49"></a><span id="l34.49" class="difflineplus">+                                                        false,</span>
<a href="#l34.50"></a><span id="l34.50" class="difflineplus">+                                                        &quot;&quot;,</span>
<a href="#l34.51"></a><span id="l34.51" class="difflineplus">+                                                        false);</span>
<a href="#l34.52"></a><span id="l34.52" class="difflineplus">+  let sis = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l34.53"></a><span id="l34.53" class="difflineplus">+              .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l34.54"></a><span id="l34.54" class="difflineplus">+  sis.init(streamListener.inputStream);</span>
<a href="#l34.55"></a><span id="l34.55" class="difflineplus">+  return sis.read(MAX_MESSAGE_LENGTH);</span>
<a href="#l34.56"></a><span id="l34.56" class="difflineplus">+}</span>
<a href="#l34.57"></a><span id="l34.57" class="difflineplus">+</span>
<a href="#l34.58"></a><span id="l34.58"> const gTestArray =</span>
<a href="#l34.59"></a><span id="l34.59"> [</span>
<a href="#l34.60"></a><span id="l34.60">   function createMessage1() { createMessage(&quot;data/test-UTF-8.txt&quot;); },</span>
<a href="#l34.61"></a><span id="l34.61">   function checkAttachment1() { checkAttachment(&quot;UTF-8&quot;); },</span>
<a href="#l34.62"></a><span id="l34.62"> </span>
<a href="#l34.63"></a><span id="l34.63">   function createMessage2() { createMessage(&quot;data/test-UTF-16.txt&quot;); },</span>
<a href="#l34.64"></a><span id="l34.64">   function checkAttachment2() { checkAttachment(&quot;UTF-16&quot;); },</span>
<a href="#l34.65"></a><span id="l34.65"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l35.1"></a><span id="l35.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageFile.js</span>
<a href="#l35.2"></a><span id="l35.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageFile.js</span>
<a href="#l35.3"></a><span id="l35.3" class="difflineat">@@ -65,25 +65,25 @@ msl.prototype = {</span>
<a href="#l35.4"></a><span id="l35.4">   SetMessageKey: function (aKey) {</span>
<a href="#l35.5"></a><span id="l35.5">   },</span>
<a href="#l35.6"></a><span id="l35.6">   GetMessageId: function (aMessageId) {</span>
<a href="#l35.7"></a><span id="l35.7">   },</span>
<a href="#l35.8"></a><span id="l35.8">   OnStopCopy: function (aStatus) {</span>
<a href="#l35.9"></a><span id="l35.9">     do_check_eq(aStatus, 0);</span>
<a href="#l35.10"></a><span id="l35.10">     try {</span>
<a href="#l35.11"></a><span id="l35.11">       // Now do a comparison of what is in the sent mail folder</span>
<a href="#l35.12"></a><span id="l35.12" class="difflineminus">-      var fileData = loadFileToString(sentFolder.filePath);</span>
<a href="#l35.13"></a><span id="l35.13" class="difflineplus">+      let msgData = loadMessageToString(sentFolder, firstMsgHdr(sentFolder));</span>
<a href="#l35.14"></a><span id="l35.14"> </span>
<a href="#l35.15"></a><span id="l35.15">       // Skip the headers etc that mailnews adds</span>
<a href="#l35.16"></a><span id="l35.16" class="difflineminus">-      var pos = fileData.indexOf(&quot;From:&quot;);</span>
<a href="#l35.17"></a><span id="l35.17" class="difflineplus">+      var pos = msgData.indexOf(&quot;From:&quot;);</span>
<a href="#l35.18"></a><span id="l35.18">       do_check_neq(pos, -1);</span>
<a href="#l35.19"></a><span id="l35.19"> </span>
<a href="#l35.20"></a><span id="l35.20" class="difflineminus">-      fileData = fileData.substr(pos);</span>
<a href="#l35.21"></a><span id="l35.21" class="difflineplus">+      msgData = msgData.substr(pos);</span>
<a href="#l35.22"></a><span id="l35.22"> </span>
<a href="#l35.23"></a><span id="l35.23" class="difflineminus">-      do_check_eq(originalData, fileData);</span>
<a href="#l35.24"></a><span id="l35.24" class="difflineplus">+      do_check_eq(originalData, msgData);</span>
<a href="#l35.25"></a><span id="l35.25">     } catch (e) {</span>
<a href="#l35.26"></a><span id="l35.26">       do_throw(e);</span>
<a href="#l35.27"></a><span id="l35.27">     } finally {</span>
<a href="#l35.28"></a><span id="l35.28">       finished = true;</span>
<a href="#l35.29"></a><span id="l35.29">       do_test_finished();</span>
<a href="#l35.30"></a><span id="l35.30">     }</span>
<a href="#l35.31"></a><span id="l35.31">   },</span>
<a href="#l35.32"></a><span id="l35.32"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l36.1"></a><span id="l36.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageLater.js</span>
<a href="#l36.2"></a><span id="l36.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageLater.js</span>
<a href="#l36.3"></a><span id="l36.3" class="difflineat">@@ -97,26 +97,25 @@ function OnStopCopy(aStatus) {</span>
<a href="#l36.4"></a><span id="l36.4"> </span>
<a href="#l36.5"></a><span id="l36.5">     // Check we have a message in the unsent message folder</span>
<a href="#l36.6"></a><span id="l36.6">     do_check_eq(folder.getTotalMessages(false), 1);</span>
<a href="#l36.7"></a><span id="l36.7"> </span>
<a href="#l36.8"></a><span id="l36.8">     // Check that the send later service thinks we have messages to send</span>
<a href="#l36.9"></a><span id="l36.9">     do_check_eq(msgSendLater.hasUnsentMessages(identity), true);</span>
<a href="#l36.10"></a><span id="l36.10"> </span>
<a href="#l36.11"></a><span id="l36.11">     // Now do a comparison of what is in the sent mail folder</span>
<a href="#l36.12"></a><span id="l36.12" class="difflineminus">-    var fileData = loadFileToString(folder.filePath);</span>
<a href="#l36.13"></a><span id="l36.13" class="difflineminus">-</span>
<a href="#l36.14"></a><span id="l36.14" class="difflineplus">+    let msgData = loadMessageToString(folder, firstMsgHdr(folder));</span>
<a href="#l36.15"></a><span id="l36.15">     // Skip the headers etc that mailnews adds</span>
<a href="#l36.16"></a><span id="l36.16" class="difflineminus">-    var pos = fileData.indexOf(&quot;From:&quot;);</span>
<a href="#l36.17"></a><span id="l36.17" class="difflineplus">+    var pos = msgData.indexOf(&quot;From:&quot;);</span>
<a href="#l36.18"></a><span id="l36.18">     do_check_neq(pos, -1);</span>
<a href="#l36.19"></a><span id="l36.19"> </span>
<a href="#l36.20"></a><span id="l36.20" class="difflineminus">-    fileData = fileData.substr(pos);</span>
<a href="#l36.21"></a><span id="l36.21" class="difflineplus">+    msgData = msgData.substr(pos);</span>
<a href="#l36.22"></a><span id="l36.22"> </span>
<a href="#l36.23"></a><span id="l36.23">     // Check the data is matching.</span>
<a href="#l36.24"></a><span id="l36.24" class="difflineminus">-    do_check_eq(originalData, fileData);</span>
<a href="#l36.25"></a><span id="l36.25" class="difflineplus">+    do_check_eq(originalData, msgData);</span>
<a href="#l36.26"></a><span id="l36.26"> </span>
<a href="#l36.27"></a><span id="l36.27">     sendMessageLater();</span>
<a href="#l36.28"></a><span id="l36.28">   } catch (e) {</span>
<a href="#l36.29"></a><span id="l36.29">     do_throw(e);</span>
<a href="#l36.30"></a><span id="l36.30">   } finally {</span>
<a href="#l36.31"></a><span id="l36.31">     server.stop();</span>
<a href="#l36.32"></a><span id="l36.32"> </span>
<a href="#l36.33"></a><span id="l36.33">     var thread = gThreadManager.currentThread;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l37.1"></a><span id="l37.1" class="difflineminus">--- a/mailnews/compose/test/unit/test_sendMessageLater3.js</span>
<a href="#l37.2"></a><span id="l37.2" class="difflineplus">+++ b/mailnews/compose/test/unit/test_sendMessageLater3.js</span>
<a href="#l37.3"></a><span id="l37.3" class="difflineat">@@ -80,27 +80,28 @@ function OnStopCopy(aStatus) {</span>
<a href="#l37.4"></a><span id="l37.4">   let folder = msgSendLater.getUnsentMessagesFolder(identity);</span>
<a href="#l37.5"></a><span id="l37.5"> </span>
<a href="#l37.6"></a><span id="l37.6">   // Check that the send later service thinks we have messages to send.</span>
<a href="#l37.7"></a><span id="l37.7">   do_check_eq(msgSendLater.hasUnsentMessages(identity), true);</span>
<a href="#l37.8"></a><span id="l37.8"> </span>
<a href="#l37.9"></a><span id="l37.9">   // Check we have a message in the unsent message folder</span>
<a href="#l37.10"></a><span id="l37.10">   do_check_eq(folder.getTotalMessages(false), 1);</span>
<a href="#l37.11"></a><span id="l37.11"> </span>
<a href="#l37.12"></a><span id="l37.12" class="difflineplus">+  </span>
<a href="#l37.13"></a><span id="l37.13">   // Now do a comparison of what is in the unsent mail folder</span>
<a href="#l37.14"></a><span id="l37.14" class="difflineminus">-  var fileData = loadFileToString(folder.filePath);</span>
<a href="#l37.15"></a><span id="l37.15" class="difflineplus">+  let msgData = loadMessageToString(folder, firstMsgHdr(folder));</span>
<a href="#l37.16"></a><span id="l37.16"> </span>
<a href="#l37.17"></a><span id="l37.17">   // Skip the headers etc that mailnews adds</span>
<a href="#l37.18"></a><span id="l37.18" class="difflineminus">-  var pos = fileData.indexOf(&quot;From:&quot;);</span>
<a href="#l37.19"></a><span id="l37.19" class="difflineplus">+  var pos = msgData.indexOf(&quot;From:&quot;);</span>
<a href="#l37.20"></a><span id="l37.20">   do_check_neq(pos, -1);</span>
<a href="#l37.21"></a><span id="l37.21"> </span>
<a href="#l37.22"></a><span id="l37.22" class="difflineminus">-  fileData = fileData.substr(pos);</span>
<a href="#l37.23"></a><span id="l37.23" class="difflineplus">+  msgData = msgData.substr(pos);</span>
<a href="#l37.24"></a><span id="l37.24"> </span>
<a href="#l37.25"></a><span id="l37.25">   // Check the data is matching.</span>
<a href="#l37.26"></a><span id="l37.26" class="difflineminus">-  do_check_eq(originalData, fileData);</span>
<a href="#l37.27"></a><span id="l37.27" class="difflineplus">+  do_check_eq(originalData, msgData);</span>
<a href="#l37.28"></a><span id="l37.28"> </span>
<a href="#l37.29"></a><span id="l37.29">   do_timeout(0, sendMessageLater);</span>
<a href="#l37.30"></a><span id="l37.30"> }</span>
<a href="#l37.31"></a><span id="l37.31"> </span>
<a href="#l37.32"></a><span id="l37.32"> // This function does the actual send later</span>
<a href="#l37.33"></a><span id="l37.33"> function sendMessageLater()</span>
<a href="#l37.34"></a><span id="l37.34"> {</span>
<a href="#l37.35"></a><span id="l37.35">   // No server for this test, just attempt to send unsent and wait.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l38.1"></a><span id="l38.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/head_gloda.js</span>
<a href="#l38.2"></a><span id="l38.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/head_gloda.js</span>
<a href="#l38.3"></a><span id="l38.3" class="difflineat">@@ -1,4 +1,9 @@</span>
<a href="#l38.4"></a><span id="l38.4"> gDEPTH = &quot;../../../../../&quot;;</span>
<a href="#l38.5"></a><span id="l38.5"> </span>
<a href="#l38.6"></a><span id="l38.6"> // Import the required setup scripts.</span>
<a href="#l38.7"></a><span id="l38.7"> load(&quot;../../../../resources/abSetup.js&quot;);</span>
<a href="#l38.8"></a><span id="l38.8" class="difflineplus">+// Services</span>
<a href="#l38.9"></a><span id="l38.9" class="difflineplus">+Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l38.10"></a><span id="l38.10" class="difflineplus">+// MailServices</span>
<a href="#l38.11"></a><span id="l38.11" class="difflineplus">+Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l38.12"></a><span id="l38.12" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l39.1"></a><span id="l39.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_index_compaction.js</span>
<a href="#l39.2"></a><span id="l39.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_compaction.js</span>
<a href="#l39.3"></a><span id="l39.3" class="difflineat">@@ -30,16 +30,19 @@</span>
<a href="#l39.4"></a><span id="l39.4">  * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l39.5"></a><span id="l39.5">  * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l39.6"></a><span id="l39.6">  * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l39.7"></a><span id="l39.7">  * the provisions above, a recipient may use your version of this file under</span>
<a href="#l39.8"></a><span id="l39.8">  * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l39.9"></a><span id="l39.9">  *</span>
<a href="#l39.10"></a><span id="l39.10">  * ***** END LICENSE BLOCK ***** */</span>
<a href="#l39.11"></a><span id="l39.11"> </span>
<a href="#l39.12"></a><span id="l39.12" class="difflineplus">+Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l39.13"></a><span id="l39.13" class="difflineplus">+                           &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l39.14"></a><span id="l39.14" class="difflineplus">+</span>
<a href="#l39.15"></a><span id="l39.15"> /*</span>
<a href="#l39.16"></a><span id="l39.16">  * Test that gloda does the right things in terms of compaction.  Major cases:</span>
<a href="#l39.17"></a><span id="l39.17">  *</span>
<a href="#l39.18"></a><span id="l39.18">  * - Compaction occurs while we are in the process of indexing a folder.  We</span>
<a href="#l39.19"></a><span id="l39.19">  *    want to make sure we stop indexing cleanly</span>
<a href="#l39.20"></a><span id="l39.20">  *</span>
<a href="#l39.21"></a><span id="l39.21">  * - A folder that we have already indexed gets compacted.  We want to make sure</span>
<a href="#l39.22"></a><span id="l39.22">  *    that we update the message keys for all involved.  This means verifying</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l40.1"></a><span id="l40.1" class="difflineminus">--- a/mailnews/db/gloda/test/unit/test_index_messages_local.js</span>
<a href="#l40.2"></a><span id="l40.2" class="difflineplus">+++ b/mailnews/db/gloda/test/unit/test_index_messages_local.js</span>
<a href="#l40.3"></a><span id="l40.3" class="difflineat">@@ -1,11 +1,12 @@</span>
<a href="#l40.4"></a><span id="l40.4"> /*</span>
<a href="#l40.5"></a><span id="l40.5">  * Test indexing support for local messages.</span>
<a href="#l40.6"></a><span id="l40.6">  */</span>
<a href="#l40.7"></a><span id="l40.7" class="difflineplus">+</span>
<a href="#l40.8"></a><span id="l40.8"> load(&quot;base_index_messages.js&quot;);</span>
<a href="#l40.9"></a><span id="l40.9"> </span>
<a href="#l40.10"></a><span id="l40.10"> /**</span>
<a href="#l40.11"></a><span id="l40.11">  * Make sure that if we have to reparse a local folder we do not hang or</span>
<a href="#l40.12"></a><span id="l40.12">  *  anything.  (We had a regression where we would hang.)</span>
<a href="#l40.13"></a><span id="l40.13">  */</span>
<a href="#l40.14"></a><span id="l40.14"> function test_reparse_of_local_folder_works() {</span>
<a href="#l40.15"></a><span id="l40.15">   // index a folder</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l41.1"></a><span id="l41.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l41.2"></a><span id="l41.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsIMsgDatabase.idl</span>
<a href="#l41.3"></a><span id="l41.3" class="difflineat">@@ -131,17 +131,17 @@ interface nsMsgDBCommitType</span>
<a href="#l41.4"></a><span id="l41.4"> [ptr] native nsMsgKeyArrayPtr(nsTArray&lt;nsMsgKey&gt;);</span>
<a href="#l41.5"></a><span id="l41.5"> </span>
<a href="#l41.6"></a><span id="l41.6"> /**</span>
<a href="#l41.7"></a><span id="l41.7">  * A service to open mail databases and manipulate listeners automatically.</span>
<a href="#l41.8"></a><span id="l41.8">  *</span>
<a href="#l41.9"></a><span id="l41.9">  * The contract ID for this component is</span>
<a href="#l41.10"></a><span id="l41.10">  * &lt;tt&gt;\@mozilla.org/msgDatabase/msgDBService;1&lt;/tt&gt;.</span>
<a href="#l41.11"></a><span id="l41.11">  */</span>
<a href="#l41.12"></a><span id="l41.12" class="difflineminus">-[scriptable, uuid(6ddaeb28-0499-4be1-85f7-7a5d20f80256)]</span>
<a href="#l41.13"></a><span id="l41.13" class="difflineplus">+[scriptable, uuid(09f52152-a3b7-4b89-935d-4033cbaea7e0)]</span>
<a href="#l41.14"></a><span id="l41.14"> interface nsIMsgDBService : nsISupports</span>
<a href="#l41.15"></a><span id="l41.15"> {</span>
<a href="#l41.16"></a><span id="l41.16">   /**</span>
<a href="#l41.17"></a><span id="l41.17">    * Opens a database for a given folder.</span>
<a href="#l41.18"></a><span id="l41.18">    *</span>
<a href="#l41.19"></a><span id="l41.19">    * This method is preferred over nsIMsgDBService::openMailDBFromFile if the</span>
<a href="#l41.20"></a><span id="l41.20">    * caller has an actual nsIMsgFolder around. If the database detects that it</span>
<a href="#l41.21"></a><span id="l41.21">    * is unreadable or out of date (using nsIMsgDatabase::outOfDate) it will</span>
<a href="#l41.22"></a><span id="l41.22" class="difflineat">@@ -216,27 +216,29 @@ interface nsIMsgDBService : nsISupports</span>
<a href="#l41.23"></a><span id="l41.23">    * except under special circumstances.</span>
<a href="#l41.24"></a><span id="l41.24">    *</span>
<a href="#l41.25"></a><span id="l41.25">    * Unlike nsIMsgDBService::openFolderDB, there is no corresponding method to</span>
<a href="#l41.26"></a><span id="l41.26">    * create a new database if opening the database failed. However, this method</span>
<a href="#l41.27"></a><span id="l41.27">    * will never throw NS_MSG_ERROR_FOLDER_SUMMARY_MISSING, so no corresponding</span>
<a href="#l41.28"></a><span id="l41.28">    * method is needed.</span>
<a href="#l41.29"></a><span id="l41.29">    *</span>
<a href="#l41.30"></a><span id="l41.30">    * @param aFile           The file for which the database should be returned.</span>
<a href="#l41.31"></a><span id="l41.31" class="difflineplus">+   * @param aFolder         Folder the db corresponds to (may be null)</span>
<a href="#l41.32"></a><span id="l41.32">    * @param aCreate         Whether or not the file should be created.</span>
<a href="#l41.33"></a><span id="l41.33">    * @param aLeaveInvalidDB Whether or not the database should be deleted if it</span>
<a href="#l41.34"></a><span id="l41.34">    *                        is invalid.</span>
<a href="#l41.35"></a><span id="l41.35">    * @return                A new nsIMsgDatabase object encapsulating the file</span>
<a href="#l41.36"></a><span id="l41.36">    *                        passed in.</span>
<a href="#l41.37"></a><span id="l41.37">    * @exception NS_ERROR_FILE_TARGET_DOES_NOT_EXIST</span>
<a href="#l41.38"></a><span id="l41.38">    *                        The file could not be created.</span>
<a href="#l41.39"></a><span id="l41.39">    * @see nsIMsgDBService::openFolderDB</span>
<a href="#l41.40"></a><span id="l41.40">    * @see nsIMsgDatabase::Open</span>
<a href="#l41.41"></a><span id="l41.41">    */</span>
<a href="#l41.42"></a><span id="l41.42">   nsIMsgDatabase openMailDBFromFile(in nsILocalFile aFile,</span>
<a href="#l41.43"></a><span id="l41.43" class="difflineplus">+                                    in nsIMsgFolder aFolder,</span>
<a href="#l41.44"></a><span id="l41.44">                                     in boolean aCreate,</span>
<a href="#l41.45"></a><span id="l41.45">                                     in boolean aLeaveInvalidDB);</span>
<a href="#l41.46"></a><span id="l41.46">   /**</span>
<a href="#l41.47"></a><span id="l41.47">    * Adds the given listener to the listener set for the folder.</span>
<a href="#l41.48"></a><span id="l41.48">    *</span>
<a href="#l41.49"></a><span id="l41.49">    * Since the message database will likely be opened and closed many times, by</span>
<a href="#l41.50"></a><span id="l41.50">    * registering using this method, one will be guaranteed to see all subsequent</span>
<a href="#l41.51"></a><span id="l41.51">    * modifications. This will also add the listener to the database if it is</span>
<a href="#l41.52"></a><span id="l41.52" class="difflineat">@@ -261,36 +263,18 @@ interface nsIMsgDBService : nsISupports</span>
<a href="#l41.53"></a><span id="l41.53">    *</span>
<a href="#l41.54"></a><span id="l41.54">    * @param aFolder   The folder to get the cached (open) db for.</span>
<a href="#l41.55"></a><span id="l41.55">    *</span>
<a href="#l41.56"></a><span id="l41.56">    * @returns         null if the db isn't open, otherwise the db.</span>
<a href="#l41.57"></a><span id="l41.57">    */</span>
<a href="#l41.58"></a><span id="l41.58">   nsIMsgDatabase cachedDBForFolder(in nsIMsgFolder aFolder);</span>
<a href="#l41.59"></a><span id="l41.59"> };</span>
<a href="#l41.60"></a><span id="l41.60"> </span>
<a href="#l41.61"></a><span id="l41.61" class="difflineminus">-[scriptable, uuid(19719187-6a85-4807-aeb6-421115240ba1)]</span>
<a href="#l41.62"></a><span id="l41.62" class="difflineplus">+[scriptable, uuid(a3cd60ac-d279-4521-8880-2e7723315cba)]</span>
<a href="#l41.63"></a><span id="l41.63"> interface nsIMsgDatabase : nsIDBChangeAnnouncer {</span>
<a href="#l41.64"></a><span id="l41.64" class="difflineminus">-  /**</span>
<a href="#l41.65"></a><span id="l41.65" class="difflineminus">-   * Opens a database folder.</span>
<a href="#l41.66"></a><span id="l41.66" class="difflineminus">-   *</span>
<a href="#l41.67"></a><span id="l41.67" class="difflineminus">-   * @param aFolderName     The name of the folder to create.</span>
<a href="#l41.68"></a><span id="l41.68" class="difflineminus">-   * @param aCreate         Whether or not the file should be created.</span>
<a href="#l41.69"></a><span id="l41.69" class="difflineminus">-   * @param aLeaveInvalidDB Set to true if you do not want the database to be</span>
<a href="#l41.70"></a><span id="l41.70" class="difflineminus">-   *                        deleted if it is invalid.</span>
<a href="#l41.71"></a><span id="l41.71" class="difflineminus">-   * @exception NS_ERROR_FILE_TARGET_DOES_NOT_EXIST</span>
<a href="#l41.72"></a><span id="l41.72" class="difflineminus">-   *                        The file could not be created.</span>
<a href="#l41.73"></a><span id="l41.73" class="difflineminus">-   * @exception NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE</span>
<a href="#l41.74"></a><span id="l41.74" class="difflineminus">-   *                        The database is present (and was opened), but the</span>
<a href="#l41.75"></a><span id="l41.75" class="difflineminus">-   *                        summary file is out of date.</span>
<a href="#l41.76"></a><span id="l41.76" class="difflineminus">-   * @exception NS_MSG_ERROR_FOLDER_SUMMARY_MISSING</span>
<a href="#l41.77"></a><span id="l41.77" class="difflineminus">-   *                        The database is present (and was opened), but the</span>
<a href="#l41.78"></a><span id="l41.78" class="difflineminus">-   *                        summary file is missing.</span>
<a href="#l41.79"></a><span id="l41.79" class="difflineminus">-   */</span>
<a href="#l41.80"></a><span id="l41.80" class="difflineminus">-  void Open(in nsILocalFile aFolderName, in boolean aCreate,</span>
<a href="#l41.81"></a><span id="l41.81" class="difflineminus">-            in boolean aLeaveInvalidDB);</span>
<a href="#l41.82"></a><span id="l41.82">   void forceFolderDBClosed(in nsIMsgFolder aFolder);</span>
<a href="#l41.83"></a><span id="l41.83">   void Close(in boolean aForceCommit);</span>
<a href="#l41.84"></a><span id="l41.84"> </span>
<a href="#l41.85"></a><span id="l41.85">   void Commit(in nsMsgDBCommit commitType);</span>
<a href="#l41.86"></a><span id="l41.86">   // Force closed is evil, and we should see if we can do without it.</span>
<a href="#l41.87"></a><span id="l41.87">   // In 4.x, it was mainly used to remove corrupted databases.</span>
<a href="#l41.88"></a><span id="l41.88">   void ForceClosed();</span>
<a href="#l41.89"></a><span id="l41.89">   void clearCachedHdrs();</span>
<a href="#l41.90"></a><span id="l41.90" class="difflineat">@@ -300,20 +284,25 @@ interface nsIMsgDatabase : nsIDBChangeAn</span>
<a href="#l41.91"></a><span id="l41.91"> </span>
<a href="#l41.92"></a><span id="l41.92">   // get a message header for the given key. Caller must release()!</span>
<a href="#l41.93"></a><span id="l41.93"> </span>
<a href="#l41.94"></a><span id="l41.94">   nsIMsgDBHdr GetMsgHdrForKey(in nsMsgKey key);</span>
<a href="#l41.95"></a><span id="l41.95">   nsIMsgDBHdr getMsgHdrForMessageID(in string messageID);</span>
<a href="#l41.96"></a><span id="l41.96">   //Returns whether or not this database contains the given key</span>
<a href="#l41.97"></a><span id="l41.97">   boolean ContainsKey(in nsMsgKey key);</span>
<a href="#l41.98"></a><span id="l41.98"> </span>
<a href="#l41.99"></a><span id="l41.99" class="difflineminus">-   // Must call AddNewHdrToDB after creating. The idea is that you create</span>
<a href="#l41.100"></a><span id="l41.100" class="difflineminus">-  // a new header, fill in its properties, and then call AddNewHdrToDB.</span>
<a href="#l41.101"></a><span id="l41.101" class="difflineminus">-  // AddNewHdrToDB will send notifications to any listeners.</span>
<a href="#l41.102"></a><span id="l41.102" class="difflineminus">-  nsIMsgDBHdr CreateNewHdr(in nsMsgKey key);</span>
<a href="#l41.103"></a><span id="l41.103" class="difflineplus">+/**</span>
<a href="#l41.104"></a><span id="l41.104" class="difflineplus">+ * Must call AddNewHdrToDB after creating. The idea is that you create</span>
<a href="#l41.105"></a><span id="l41.105" class="difflineplus">+ * a new header, fill in its properties, and then call AddNewHdrToDB.</span>
<a href="#l41.106"></a><span id="l41.106" class="difflineplus">+ * AddNewHdrToDB will send notifications to any listeners.</span>
<a href="#l41.107"></a><span id="l41.107" class="difflineplus">+ *</span>
<a href="#l41.108"></a><span id="l41.108" class="difflineplus">+ * @param aKey msgKey for the new header. If aKey is nsMsgKey_None,</span>
<a href="#l41.109"></a><span id="l41.109" class="difflineplus">+ *             we will auto-assign a new key.</span>
<a href="#l41.110"></a><span id="l41.110" class="difflineplus">+ */</span>
<a href="#l41.111"></a><span id="l41.111" class="difflineplus">+  nsIMsgDBHdr CreateNewHdr(in nsMsgKey aKey);</span>
<a href="#l41.112"></a><span id="l41.112"> </span>
<a href="#l41.113"></a><span id="l41.113">   void AddNewHdrToDB(in nsIMsgDBHdr newHdr, in boolean notify);</span>
<a href="#l41.114"></a><span id="l41.114"> </span>
<a href="#l41.115"></a><span id="l41.115">   nsIMsgDBHdr CopyHdrFromExistingHdr(in nsMsgKey key, in nsIMsgDBHdr existingHdr, in boolean addHdrToDB);</span>
<a href="#l41.116"></a><span id="l41.116"> </span>
<a href="#l41.117"></a><span id="l41.117">   void ListAllKeys(in nsIMsgKeyArray array);</span>
<a href="#l41.118"></a><span id="l41.118"> </span>
<a href="#l41.119"></a><span id="l41.119">   nsISimpleEnumerator EnumerateMessages();</span>
<a href="#l41.120"></a><span id="l41.120" class="difflineat">@@ -546,20 +535,16 @@ interface nsIMsgDatabase : nsIDBChangeAn</span>
<a href="#l41.121"></a><span id="l41.121">   // news can be threaded by default)</span>
<a href="#l41.122"></a><span id="l41.122">   readonly attribute nsMsgViewFlagsTypeValue defaultViewFlags;</span>
<a href="#l41.123"></a><span id="l41.123">   readonly attribute nsMsgViewSortTypeValue  defaultSortType;</span>
<a href="#l41.124"></a><span id="l41.124">   readonly attribute nsMsgViewSortOrderValue defaultSortOrder;</span>
<a href="#l41.125"></a><span id="l41.125"> </span>
<a href="#l41.126"></a><span id="l41.126">   // for msg hdr hash table allocation. controllable by caller to improve folder loading preformance.</span>
<a href="#l41.127"></a><span id="l41.127">   attribute unsigned long msgHdrCacheSize;</span>
<a href="#l41.128"></a><span id="l41.128"> </span>
<a href="#l41.129"></a><span id="l41.129" class="difflineminus">-  // this is used to cache the folder stream the db reads and write. It's also an</span>
<a href="#l41.130"></a><span id="l41.130" class="difflineminus">-  // nsIInputStream, and nsISeekable.</span>
<a href="#l41.131"></a><span id="l41.131" class="difflineminus">-  attribute nsIOutputStream folderStream;</span>
<a href="#l41.132"></a><span id="l41.132" class="difflineminus">-</span>
<a href="#l41.133"></a><span id="l41.133">   /**</span>
<a href="#l41.134"></a><span id="l41.134">    * The list of messages currently in the NEW state.</span>
<a href="#l41.135"></a><span id="l41.135">    * </span>
<a href="#l41.136"></a><span id="l41.136">    * If there are no such messages, a null pointer may be returned.</span>
<a href="#l41.137"></a><span id="l41.137">    * the caller should free when done using nsMemory::Free.</span>
<a href="#l41.138"></a><span id="l41.138">    */</span>
<a href="#l41.139"></a><span id="l41.139">   void getNewList(out unsigned long count, [array, size_is(count)] out nsMsgKey newKeys);</span>
<a href="#l41.140"></a><span id="l41.140">   </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l42.1"></a><span id="l42.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsImapMailDatabase.h</span>
<a href="#l42.2"></a><span id="l42.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsImapMailDatabase.h</span>
<a href="#l42.3"></a><span id="l42.3" class="difflineat">@@ -50,35 +50,32 @@ public:</span>
<a href="#l42.4"></a><span id="l42.4">   </span>
<a href="#l42.5"></a><span id="l42.5">   NS_IMETHOD    StartBatch();</span>
<a href="#l42.6"></a><span id="l42.6">   NS_IMETHOD    EndBatch();</span>
<a href="#l42.7"></a><span id="l42.7">   NS_IMETHOD    GetSummaryValid(bool *aResult);</span>
<a href="#l42.8"></a><span id="l42.8">   NS_IMETHOD    SetSummaryValid(bool valid = true);</span>
<a href="#l42.9"></a><span id="l42.9">   virtual nsresult AdjustExpungedBytesOnDelete(nsIMsgDBHdr *msgHdr);</span>
<a href="#l42.10"></a><span id="l42.10"> </span>
<a href="#l42.11"></a><span id="l42.11">   NS_IMETHOD    ForceClosed();</span>
<a href="#l42.12"></a><span id="l42.12" class="difflineminus">-  NS_IMETHOD    SetFolderStream(nsIOutputStream *aFileStream);</span>
<a href="#l42.13"></a><span id="l42.13" class="difflineminus">-  NS_IMETHOD    GetFolderStream(nsIOutputStream **aFileStream);</span>
<a href="#l42.14"></a><span id="l42.14">   NS_IMETHOD    AddNewHdrToDB(nsIMsgDBHdr *newHdr, bool notify);</span>
<a href="#l42.15"></a><span id="l42.15">   NS_IMETHOD    SetAttributeOnPendingHdr(nsIMsgDBHdr *pendingHdr, const char *property,</span>
<a href="#l42.16"></a><span id="l42.16">                                   const char *propertyVal);</span>
<a href="#l42.17"></a><span id="l42.17">   NS_IMETHOD    SetUint32AttributeOnPendingHdr(nsIMsgDBHdr *pendingHdr, const char *property,</span>
<a href="#l42.18"></a><span id="l42.18">                                   PRUint32 propertyVal);</span>
<a href="#l42.19"></a><span id="l42.19">   NS_IMETHOD    SetUint64AttributeOnPendingHdr(nsIMsgDBHdr *aPendingHdr,</span>
<a href="#l42.20"></a><span id="l42.20">                                                const char *aProperty,</span>
<a href="#l42.21"></a><span id="l42.21">                                                PRUint64 aPropertyVal);</span>
<a href="#l42.22"></a><span id="l42.22">   NS_IMETHOD    DeleteMessages(PRUint32 aNumKeys, nsMsgKey* nsMsgKeys,</span>
<a href="#l42.23"></a><span id="l42.23">                                nsIDBChangeListener *instigator);</span>
<a href="#l42.24"></a><span id="l42.24">   NS_IMETHOD    UpdatePendingAttributes(nsIMsgDBHdr* aNewHdr);</span>
<a href="#l42.25"></a><span id="l42.25"> </span>
<a href="#l42.26"></a><span id="l42.26"> protected:</span>
<a href="#l42.27"></a><span id="l42.27">   // IMAP does not set local file flags, override does nothing</span>
<a href="#l42.28"></a><span id="l42.28">   virtual void UpdateFolderFlag(nsIMsgDBHdr *msgHdr, bool bSet,</span>
<a href="#l42.29"></a><span id="l42.29">                                 nsMsgMessageFlagType flag, nsIOutputStream **ppFileStream);</span>
<a href="#l42.30"></a><span id="l42.30" class="difflineminus">-  virtual bool SetHdrFlag(nsIMsgDBHdr *msgHdr, bool bSet, nsMsgMessageFlagType flag);</span>
<a href="#l42.31"></a><span id="l42.31"> </span>
<a href="#l42.32"></a><span id="l42.32">   nsresult      GetRowForPendingHdr(nsIMsgDBHdr *pendingHdr, nsIMdbRow **row);</span>
<a href="#l42.33"></a><span id="l42.33">   nsresult     GetAllPendingHdrsTable();</span>
<a href="#l42.34"></a><span id="l42.34">   mdb_token    m_pendingHdrsRowScopeToken;</span>
<a href="#l42.35"></a><span id="l42.35">   mdb_token    m_pendingHdrsTableKindToken;</span>
<a href="#l42.36"></a><span id="l42.36">   nsCOMPtr&lt;nsIMdbTable&gt; m_mdbAllPendingHdrsTable;</span>
<a href="#l42.37"></a><span id="l42.37"> };</span>
<a href="#l42.38"></a><span id="l42.38"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l43.1"></a><span id="l43.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMailDatabase.h</span>
<a href="#l43.2"></a><span id="l43.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMailDatabase.h</span>
<a href="#l43.3"></a><span id="l43.3" class="difflineat">@@ -48,61 +48,49 @@ class nsIOFileStream;</span>
<a href="#l43.4"></a><span id="l43.4"> class nsILocalFile;</span>
<a href="#l43.5"></a><span id="l43.5"> class nsOfflineImapOperation;</span>
<a href="#l43.6"></a><span id="l43.6"> </span>
<a href="#l43.7"></a><span id="l43.7"> class nsMailDatabase : public nsMsgDatabase</span>
<a href="#l43.8"></a><span id="l43.8"> {</span>
<a href="#l43.9"></a><span id="l43.9"> public:</span>
<a href="#l43.10"></a><span id="l43.10">   nsMailDatabase();</span>
<a href="#l43.11"></a><span id="l43.11">   virtual ~nsMailDatabase();</span>
<a href="#l43.12"></a><span id="l43.12" class="difflineminus">-  NS_IMETHOD  Open(nsILocalFile *aFolderName, bool create, bool upgrading);</span>
<a href="#l43.13"></a><span id="l43.13">   NS_IMETHOD  ForceClosed();</span>
<a href="#l43.14"></a><span id="l43.14">   NS_IMETHOD DeleteMessages(PRUint32 aNumKeys, nsMsgKey* nsMsgKeys, nsIDBChangeListener *instigator);</span>
<a href="#l43.15"></a><span id="l43.15"> </span>
<a href="#l43.16"></a><span id="l43.16">   NS_IMETHOD StartBatch();</span>
<a href="#l43.17"></a><span id="l43.17">   NS_IMETHOD EndBatch();</span>
<a href="#l43.18"></a><span id="l43.18"> </span>
<a href="#l43.19"></a><span id="l43.19" class="difflineminus">-  static  nsresult        SetFolderInfoValid(nsILocalFile *folderFile, int num, int numunread);</span>
<a href="#l43.20"></a><span id="l43.20" class="difflineminus">-  nsresult                GetFolderName(nsString &amp;folderName);</span>
<a href="#l43.21"></a><span id="l43.21" class="difflineplus">+  nsresult  Open(nsILocalFile *aSummaryFile, bool create, bool upgrading);</span>
<a href="#l43.22"></a><span id="l43.22">   virtual nsMailDatabase  *GetMailDB() {return this;}</span>
<a href="#l43.23"></a><span id="l43.23"> </span>
<a href="#l43.24"></a><span id="l43.24">   virtual PRUint32  GetCurVersion() {return kMsgDBVersion;}</span>
<a href="#l43.25"></a><span id="l43.25">   </span>
<a href="#l43.26"></a><span id="l43.26">   NS_IMETHOD  GetOfflineOpForKey(nsMsgKey opKey, bool create, nsIMsgOfflineImapOperation **op);</span>
<a href="#l43.27"></a><span id="l43.27">   NS_IMETHOD  RemoveOfflineOp(nsIMsgOfflineImapOperation *op);</span>
<a href="#l43.28"></a><span id="l43.28"> </span>
<a href="#l43.29"></a><span id="l43.29">   NS_IMETHOD  SetSummaryValid(bool valid);</span>
<a href="#l43.30"></a><span id="l43.30">   NS_IMETHOD  GetSummaryValid(bool *valid);</span>
<a href="#l43.31"></a><span id="l43.31"> 	</span>
<a href="#l43.32"></a><span id="l43.32">   NS_IMETHOD    EnumerateOfflineOps(nsISimpleEnumerator **enumerator);</span>
<a href="#l43.33"></a><span id="l43.33">   NS_IMETHOD    ListAllOfflineOpIds(nsTArray&lt;nsMsgKey&gt; *offlineOpIds);</span>
<a href="#l43.34"></a><span id="l43.34">   NS_IMETHOD    ListAllOfflineDeletes(nsTArray&lt;nsMsgKey&gt; *offlineDeletes);</span>
<a href="#l43.35"></a><span id="l43.35"> </span>
<a href="#l43.36"></a><span id="l43.36" class="difflineminus">-  NS_IMETHOD SetFolderStream(nsIOutputStream *aFileStream);</span>
<a href="#l43.37"></a><span id="l43.37" class="difflineminus">-  NS_IMETHOD GetFolderStream(nsIOutputStream **aFileStream);</span>
<a href="#l43.38"></a><span id="l43.38" class="difflineminus">-</span>
<a href="#l43.39"></a><span id="l43.39">   friend class nsMsgOfflineOpEnumerator;</span>
<a href="#l43.40"></a><span id="l43.40"> protected:</span>
<a href="#l43.41"></a><span id="l43.41"> </span>
<a href="#l43.42"></a><span id="l43.42">   nsresult        GetAllOfflineOpsTable(); // get this on demand</span>
<a href="#l43.43"></a><span id="l43.43"> </span>
<a href="#l43.44"></a><span id="l43.44">   // get the time and date of the mailbox file</span>
<a href="#l43.45"></a><span id="l43.45">   void            GetMailboxModProperties(PRInt64 *aSize, PRUint32 *aDate); </span>
<a href="#l43.46"></a><span id="l43.46"> </span>
<a href="#l43.47"></a><span id="l43.47">   nsCOMPtr &lt;nsIMdbTable&gt;  m_mdbAllOfflineOpsTable;</span>
<a href="#l43.48"></a><span id="l43.48">   mdb_token       m_offlineOpsRowScopeToken;</span>
<a href="#l43.49"></a><span id="l43.49">   mdb_token       m_offlineOpsTableKindToken;</span>
<a href="#l43.50"></a><span id="l43.50"> </span>
<a href="#l43.51"></a><span id="l43.51" class="difflineminus">-  virtual bool    SetHdrFlag(nsIMsgDBHdr *, bool bSet, nsMsgMessageFlagType flag);</span>
<a href="#l43.52"></a><span id="l43.52" class="difflineminus">-  virtual void    UpdateFolderFlag(nsIMsgDBHdr *msgHdr, bool bSet, </span>
<a href="#l43.53"></a><span id="l43.53" class="difflineminus">-                                   nsMsgMessageFlagType flag, nsIOutputStream **ppFileStream);</span>
<a href="#l43.54"></a><span id="l43.54">   virtual void    SetReparse(bool reparse);</span>
<a href="#l43.55"></a><span id="l43.55">   </span>
<a href="#l43.56"></a><span id="l43.56"> protected:</span>
<a href="#l43.57"></a><span id="l43.57" class="difflineminus">-  virtual void    GetGlobalPrefs();</span>
<a href="#l43.58"></a><span id="l43.58">   </span>
<a href="#l43.59"></a><span id="l43.59">   bool            m_reparse;</span>
<a href="#l43.60"></a><span id="l43.60" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; m_folderFile;</span>
<a href="#l43.61"></a><span id="l43.61" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; m_folderStream; 	/* this is a cache for loops which want file left open */</span>
<a href="#l43.62"></a><span id="l43.62" class="difflineminus">-  bool            m_ownFolderStream; //if we are the owner of m_folderStream</span>
<a href="#l43.63"></a><span id="l43.63"> };</span>
<a href="#l43.64"></a><span id="l43.64"> </span>
<a href="#l43.65"></a><span id="l43.65"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l44.1"></a><span id="l44.1" class="difflineminus">--- a/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l44.2"></a><span id="l44.2" class="difflineplus">+++ b/mailnews/db/msgdb/public/nsMsgDatabase.h</span>
<a href="#l44.3"></a><span id="l44.3" class="difflineat">@@ -135,22 +135,40 @@ class nsMsgDatabase : public nsIMsgDatab</span>
<a href="#l44.4"></a><span id="l44.4"> public:</span>
<a href="#l44.5"></a><span id="l44.5">   friend class nsMsgDBService;</span>
<a href="#l44.6"></a><span id="l44.6">   friend class nsMsgPropertyEnumerator; // accesses m_mdbEnv and m_mdbStore</span>
<a href="#l44.7"></a><span id="l44.7"> </span>
<a href="#l44.8"></a><span id="l44.8">   NS_DECL_ISUPPORTS</span>
<a href="#l44.9"></a><span id="l44.9">   NS_DECL_NSIDBCHANGEANNOUNCER</span>
<a href="#l44.10"></a><span id="l44.10">   NS_DECL_NSIMSGDATABASE</span>
<a href="#l44.11"></a><span id="l44.11"> </span>
<a href="#l44.12"></a><span id="l44.12" class="difflineplus">+  /**</span>
<a href="#l44.13"></a><span id="l44.13" class="difflineplus">+   * Opens a database folder.</span>
<a href="#l44.14"></a><span id="l44.14" class="difflineplus">+   *</span>
<a href="#l44.15"></a><span id="l44.15" class="difflineplus">+   * @param aFolderName     The name of the folder to create.</span>
<a href="#l44.16"></a><span id="l44.16" class="difflineplus">+   * @param aCreate         Whether or not the file should be created.</span>
<a href="#l44.17"></a><span id="l44.17" class="difflineplus">+   * @param aLeaveInvalidDB Set to true if you do not want the database to be</span>
<a href="#l44.18"></a><span id="l44.18" class="difflineplus">+   *                        deleted if it is invalid.</span>
<a href="#l44.19"></a><span id="l44.19" class="difflineplus">+   * @exception NS_ERROR_FILE_TARGET_DOES_NOT_EXIST</span>
<a href="#l44.20"></a><span id="l44.20" class="difflineplus">+   *                        The file could not be created.</span>
<a href="#l44.21"></a><span id="l44.21" class="difflineplus">+   * @exception NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE</span>
<a href="#l44.22"></a><span id="l44.22" class="difflineplus">+   *                        The database is present (and was opened), but the</span>
<a href="#l44.23"></a><span id="l44.23" class="difflineplus">+   *                        summary file is out of date.</span>
<a href="#l44.24"></a><span id="l44.24" class="difflineplus">+   * @exception NS_MSG_ERROR_FOLDER_SUMMARY_MISSING</span>
<a href="#l44.25"></a><span id="l44.25" class="difflineplus">+   *                        The database is present (and was opened), but the</span>
<a href="#l44.26"></a><span id="l44.26" class="difflineplus">+   *                        summary file is missing.</span>
<a href="#l44.27"></a><span id="l44.27" class="difflineplus">+   */</span>
<a href="#l44.28"></a><span id="l44.28" class="difflineplus">+  virtual nsresult Open(nsILocalFile *aFolderName, bool aCreate,</span>
<a href="#l44.29"></a><span id="l44.29" class="difflineplus">+                        bool aLeaveInvalidDB);</span>
<a href="#l44.30"></a><span id="l44.30">   virtual nsresult IsHeaderRead(nsIMsgDBHdr *hdr, bool *pRead);</span>
<a href="#l44.31"></a><span id="l44.31">   virtual nsresult MarkHdrReadInDB(nsIMsgDBHdr *msgHdr, bool bRead,</span>
<a href="#l44.32"></a><span id="l44.32">                                nsIDBChangeListener *instigator);</span>
<a href="#l44.33"></a><span id="l44.33">   nsresult OpenInternal(nsILocalFile *aFolderName, bool aCreate,</span>
<a href="#l44.34"></a><span id="l44.34">                         bool aLeaveInvalidDB, bool sync);</span>
<a href="#l44.35"></a><span id="l44.35" class="difflineminus">-  nsresult CheckForErrors(nsresult err, nsILocalFile *summaryFile);</span>
<a href="#l44.36"></a><span id="l44.36" class="difflineplus">+  nsresult CheckForErrors(nsresult err, bool sync, nsILocalFile *summaryFile);</span>
<a href="#l44.37"></a><span id="l44.37">   virtual nsresult OpenMDB(const char *dbName, bool create, bool sync);</span>
<a href="#l44.38"></a><span id="l44.38">   virtual nsresult CloseMDB(bool commit);</span>
<a href="#l44.39"></a><span id="l44.39">   virtual nsresult CreateMsgHdr(nsIMdbRow* hdrRow, nsMsgKey key, nsIMsgDBHdr **result);</span>
<a href="#l44.40"></a><span id="l44.40">   virtual nsresult GetThreadForMsgKey(nsMsgKey msgKey, nsIMsgThread **result);</span>
<a href="#l44.41"></a><span id="l44.41">   virtual nsresult EnumerateMessagesWithFlag(nsISimpleEnumerator* *result, PRUint32 *pFlag);</span>
<a href="#l44.42"></a><span id="l44.42">   nsresult         GetSearchResultsTable(const char *searchFolderUri, bool createIfMissing, nsIMdbTable **table);</span>
<a href="#l44.43"></a><span id="l44.43"> </span>
<a href="#l44.44"></a><span id="l44.44">   // this might just be for debugging - we'll see.</span>
<a href="#l44.45"></a><span id="l44.45" class="difflineat">@@ -251,16 +269,21 @@ protected:</span>
<a href="#l44.46"></a><span id="l44.46">   static nsTArray&lt;nsMsgDatabase*&gt;* m_dbCache;</span>
<a href="#l44.47"></a><span id="l44.47">   static nsTArray&lt;nsMsgDatabase*&gt;* GetDBCache();</span>
<a href="#l44.48"></a><span id="l44.48">   </span>
<a href="#l44.49"></a><span id="l44.49">   static void    AddToCache(nsMsgDatabase* pMessageDB) </span>
<a href="#l44.50"></a><span id="l44.50">   {</span>
<a href="#l44.51"></a><span id="l44.51"> #ifdef DEBUG_David_Bienvenu</span>
<a href="#l44.52"></a><span id="l44.52"> //    NS_ASSERTION(GetDBCache()-&gt;Length() &lt; 50, &quot;50 or more open db's&quot;);</span>
<a href="#l44.53"></a><span id="l44.53"> #endif</span>
<a href="#l44.54"></a><span id="l44.54" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l44.55"></a><span id="l44.55" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; msgDB = pMessageDB-&gt;m_folder ?</span>
<a href="#l44.56"></a><span id="l44.56" class="difflineplus">+                               dont_AddRef(FindInCache(pMessageDB-&gt;m_folder)) : nsnull;</span>
<a href="#l44.57"></a><span id="l44.57" class="difflineplus">+    NS_ASSERTION(!msgDB, &quot;shouldn't have db in cache&quot;);</span>
<a href="#l44.58"></a><span id="l44.58" class="difflineplus">+#endif</span>
<a href="#l44.59"></a><span id="l44.59">     GetDBCache()-&gt;AppendElement(pMessageDB);</span>
<a href="#l44.60"></a><span id="l44.60">   }</span>
<a href="#l44.61"></a><span id="l44.61">   static void    RemoveFromCache(nsMsgDatabase* pMessageDB);</span>
<a href="#l44.62"></a><span id="l44.62">   bool    MatchDbName(nsILocalFile *dbName);  // returns TRUE if they match</span>
<a href="#l44.63"></a><span id="l44.63"> </span>
<a href="#l44.64"></a><span id="l44.64">   // Flag handling routines</span>
<a href="#l44.65"></a><span id="l44.65">   virtual nsresult SetKeyFlag(nsMsgKey key, bool set, PRUint32 flag,</span>
<a href="#l44.66"></a><span id="l44.66">                               nsIDBChangeListener *instigator = NULL);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l45.1"></a><span id="l45.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsDBFolderInfo.cpp</span>
<a href="#l45.2"></a><span id="l45.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsDBFolderInfo.cpp</span>
<a href="#l45.3"></a><span id="l45.3" class="difflineat">@@ -303,27 +303,23 @@ nsresult nsDBFolderInfo::AddToNewMDB()</span>
<a href="#l45.4"></a><span id="l45.4">     mdb_err err = store-&gt;NewTable(m_mdb-&gt;GetEnv(), m_rowScopeToken,</span>
<a href="#l45.5"></a><span id="l45.5">       m_tableKindToken, PR_TRUE, nsnull, &amp;m_mdbTable);</span>
<a href="#l45.6"></a><span id="l45.6"> </span>
<a href="#l45.7"></a><span id="l45.7">     // make sure the oid of the table is 1.</span>
<a href="#l45.8"></a><span id="l45.8">     struct mdbOid folderInfoTableOID;</span>
<a href="#l45.9"></a><span id="l45.9">     folderInfoTableOID.mOid_Id = 1;</span>
<a href="#l45.10"></a><span id="l45.10">     folderInfoTableOID.mOid_Scope = m_rowScopeToken;</span>
<a href="#l45.11"></a><span id="l45.11"> </span>
<a href="#l45.12"></a><span id="l45.12" class="difflineminus">-    //		m_mdbTable-&gt;BecomeContent(m_mdb-&gt;GetEnv(), &amp;folderInfoTableOID);</span>
<a href="#l45.13"></a><span id="l45.13" class="difflineminus">-</span>
<a href="#l45.14"></a><span id="l45.14">     // create the singleton row for the dbFolderInfo.</span>
<a href="#l45.15"></a><span id="l45.15">     err  = store-&gt;NewRowWithOid(m_mdb-&gt;GetEnv(),</span>
<a href="#l45.16"></a><span id="l45.16">       &amp;gDBFolderInfoOID, &amp;m_mdbRow);</span>
<a href="#l45.17"></a><span id="l45.17"> </span>
<a href="#l45.18"></a><span id="l45.18">     // add the row to the singleton table.</span>
<a href="#l45.19"></a><span id="l45.19">     if (m_mdbRow &amp;&amp; NS_SUCCEEDED(err))</span>
<a href="#l45.20"></a><span id="l45.20" class="difflineminus">-    {</span>
<a href="#l45.21"></a><span id="l45.21">       err = m_mdbTable-&gt;AddRow(m_mdb-&gt;GetEnv(), m_mdbRow);</span>
<a href="#l45.22"></a><span id="l45.22" class="difflineminus">-    }</span>
<a href="#l45.23"></a><span id="l45.23"> </span>
<a href="#l45.24"></a><span id="l45.24">     ret = err;	// what are we going to do about mdb_err's?</span>
<a href="#l45.25"></a><span id="l45.25">   }</span>
<a href="#l45.26"></a><span id="l45.26">   return ret;</span>
<a href="#l45.27"></a><span id="l45.27"> }</span>
<a href="#l45.28"></a><span id="l45.28"> </span>
<a href="#l45.29"></a><span id="l45.29"> nsresult nsDBFolderInfo::InitFromExistingDB()</span>
<a href="#l45.30"></a><span id="l45.30"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l46.1"></a><span id="l46.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsImapMailDatabase.cpp</span>
<a href="#l46.2"></a><span id="l46.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsImapMailDatabase.cpp</span>
<a href="#l46.3"></a><span id="l46.3" class="difflineat">@@ -87,23 +87,16 @@ void nsImapMailDatabase::UpdateFolderFla</span>
<a href="#l46.4"></a><span id="l46.4"> </span>
<a href="#l46.5"></a><span id="l46.5"> // We override this to avoid our parent class (nsMailDatabase)'s </span>
<a href="#l46.6"></a><span id="l46.6"> // grabbing of the folder semaphore, and bailing on failure.</span>
<a href="#l46.7"></a><span id="l46.7"> NS_IMETHODIMP nsImapMailDatabase::DeleteMessages(PRUint32 aNumKeys, nsMsgKey* nsMsgKeys, nsIDBChangeListener *instigator)</span>
<a href="#l46.8"></a><span id="l46.8"> {</span>
<a href="#l46.9"></a><span id="l46.9">   return nsMsgDatabase::DeleteMessages(aNumKeys, nsMsgKeys, instigator);</span>
<a href="#l46.10"></a><span id="l46.10"> }</span>
<a href="#l46.11"></a><span id="l46.11"> </span>
<a href="#l46.12"></a><span id="l46.12" class="difflineminus">-// We override this so we won't try to change the x-mozilla-status flags</span>
<a href="#l46.13"></a><span id="l46.13" class="difflineminus">-// in the offline store.</span>
<a href="#l46.14"></a><span id="l46.14" class="difflineminus">-bool nsImapMailDatabase::SetHdrFlag(nsIMsgDBHdr *msgHdr, bool bSet, nsMsgMessageFlagType flag)</span>
<a href="#l46.15"></a><span id="l46.15" class="difflineminus">-{</span>
<a href="#l46.16"></a><span id="l46.16" class="difflineminus">-  return nsMsgDatabase::SetHdrFlag(msgHdr, bSet, flag);</span>
<a href="#l46.17"></a><span id="l46.17" class="difflineminus">-}</span>
<a href="#l46.18"></a><span id="l46.18" class="difflineminus">-</span>
<a href="#l46.19"></a><span id="l46.19"> // override so nsMailDatabase methods that deal with m_folderStream are *not* called</span>
<a href="#l46.20"></a><span id="l46.20"> NS_IMETHODIMP nsImapMailDatabase::StartBatch()</span>
<a href="#l46.21"></a><span id="l46.21"> {</span>
<a href="#l46.22"></a><span id="l46.22">   return NS_OK;</span>
<a href="#l46.23"></a><span id="l46.23"> }</span>
<a href="#l46.24"></a><span id="l46.24"> </span>
<a href="#l46.25"></a><span id="l46.25"> NS_IMETHODIMP nsImapMailDatabase::EndBatch()</span>
<a href="#l46.26"></a><span id="l46.26"> {</span>
<a href="#l46.27"></a><span id="l46.27" class="difflineat">@@ -124,27 +117,16 @@ nsresult nsImapMailDatabase::AdjustExpun</span>
<a href="#l46.28"></a><span id="l46.28"> }</span>
<a href="#l46.29"></a><span id="l46.29"> </span>
<a href="#l46.30"></a><span id="l46.30"> NS_IMETHODIMP nsImapMailDatabase::ForceClosed()</span>
<a href="#l46.31"></a><span id="l46.31"> {</span>
<a href="#l46.32"></a><span id="l46.32">   m_mdbAllPendingHdrsTable = nsnull;</span>
<a href="#l46.33"></a><span id="l46.33">   return nsMailDatabase::ForceClosed();</span>
<a href="#l46.34"></a><span id="l46.34"> }</span>
<a href="#l46.35"></a><span id="l46.35"> </span>
<a href="#l46.36"></a><span id="l46.36" class="difflineminus">-NS_IMETHODIMP nsImapMailDatabase::GetFolderStream(nsIOutputStream **aFileStream)</span>
<a href="#l46.37"></a><span id="l46.37" class="difflineminus">-{</span>
<a href="#l46.38"></a><span id="l46.38" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l46.39"></a><span id="l46.39" class="difflineminus">-}</span>
<a href="#l46.40"></a><span id="l46.40" class="difflineminus">-</span>
<a href="#l46.41"></a><span id="l46.41" class="difflineminus">-NS_IMETHODIMP nsImapMailDatabase::SetFolderStream(nsIOutputStream *aFileStream)</span>
<a href="#l46.42"></a><span id="l46.42" class="difflineminus">-{</span>
<a href="#l46.43"></a><span id="l46.43" class="difflineminus">-  NS_ERROR(&quot;Trying to set folderStream, not implemented&quot;);</span>
<a href="#l46.44"></a><span id="l46.44" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l46.45"></a><span id="l46.45" class="difflineminus">-}</span>
<a href="#l46.46"></a><span id="l46.46" class="difflineminus">-</span>
<a href="#l46.47"></a><span id="l46.47"> nsresult nsImapMailDatabase::GetAllPendingHdrsTable()</span>
<a href="#l46.48"></a><span id="l46.48"> {</span>
<a href="#l46.49"></a><span id="l46.49">   nsresult rv = NS_OK;</span>
<a href="#l46.50"></a><span id="l46.50">   if (!m_mdbAllPendingHdrsTable)</span>
<a href="#l46.51"></a><span id="l46.51">     rv = GetTableCreateIfMissing(kPendingHdrsScope, kPendingHdrsTableKind, getter_AddRefs(m_mdbAllPendingHdrsTable),</span>
<a href="#l46.52"></a><span id="l46.52">                                                 m_pendingHdrsRowScopeToken, m_pendingHdrsTableKindToken) ;</span>
<a href="#l46.53"></a><span id="l46.53">   return rv;</span>
<a href="#l46.54"></a><span id="l46.54"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l47.1"></a><span id="l47.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMailDatabase.cpp</span>
<a href="#l47.2"></a><span id="l47.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMailDatabase.cpp</span>
<a href="#l47.3"></a><span id="l47.3" class="difflineat">@@ -41,491 +41,126 @@</span>
<a href="#l47.4"></a><span id="l47.4"> #include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l47.5"></a><span id="l47.5"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l47.6"></a><span id="l47.6"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l47.7"></a><span id="l47.7"> #include &quot;nsMsgOfflineImapOperation.h&quot;</span>
<a href="#l47.8"></a><span id="l47.8"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l47.9"></a><span id="l47.9"> #include &quot;prlog.h&quot;</span>
<a href="#l47.10"></a><span id="l47.10"> #include &quot;prprf.h&quot;</span>
<a href="#l47.11"></a><span id="l47.11"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l47.12"></a><span id="l47.12" class="difflineminus">-#ifdef PUTUP_ALERT_ON_INVALID_DB</span>
<a href="#l47.13"></a><span id="l47.13" class="difflineminus">-#include &quot;nsIPrompt.h&quot;</span>
<a href="#l47.14"></a><span id="l47.14" class="difflineminus">-#include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l47.15"></a><span id="l47.15" class="difflineminus">-#endif</span>
<a href="#l47.16"></a><span id="l47.16" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l47.17"></a><span id="l47.17"> </span>
<a href="#l47.18"></a><span id="l47.18"> extern PRLogModuleInfo *IMAPOffline;</span>
<a href="#l47.19"></a><span id="l47.19"> </span>
<a href="#l47.20"></a><span id="l47.20" class="difflineminus">-const char *kOfflineOpsScope = &quot;ns:msg:db:row:scope:ops:all&quot;;	// scope for all offine ops table</span>
<a href="#l47.21"></a><span id="l47.21" class="difflineplus">+// scope for all offine ops table</span>
<a href="#l47.22"></a><span id="l47.22" class="difflineplus">+const char *kOfflineOpsScope = &quot;ns:msg:db:row:scope:ops:all&quot;;</span>
<a href="#l47.23"></a><span id="l47.23"> const char *kOfflineOpsTableKind = &quot;ns:msg:db:table:kind:ops&quot;;</span>
<a href="#l47.24"></a><span id="l47.24"> struct mdbOid gAllOfflineOpsTableOID;</span>
<a href="#l47.25"></a><span id="l47.25"> </span>
<a href="#l47.26"></a><span id="l47.26" class="difflineminus">-</span>
<a href="#l47.27"></a><span id="l47.27" class="difflineminus">-nsMailDatabase::nsMailDatabase()</span>
<a href="#l47.28"></a><span id="l47.28" class="difflineminus">-    : m_reparse(PR_FALSE), m_ownFolderStream(PR_FALSE)</span>
<a href="#l47.29"></a><span id="l47.29" class="difflineplus">+nsMailDatabase::nsMailDatabase() : m_reparse(PR_FALSE)</span>
<a href="#l47.30"></a><span id="l47.30"> {</span>
<a href="#l47.31"></a><span id="l47.31">   m_mdbAllOfflineOpsTable = nsnull;</span>
<a href="#l47.32"></a><span id="l47.32"> }</span>
<a href="#l47.33"></a><span id="l47.33"> </span>
<a href="#l47.34"></a><span id="l47.34"> nsMailDatabase::~nsMailDatabase()</span>
<a href="#l47.35"></a><span id="l47.35"> {</span>
<a href="#l47.36"></a><span id="l47.36"> }</span>
<a href="#l47.37"></a><span id="l47.37"> </span>
<a href="#l47.38"></a><span id="l47.38" class="difflineminus">-NS_IMETHODIMP nsMailDatabase::SetFolderStream(nsIOutputStream *aFileStream)</span>
<a href="#l47.39"></a><span id="l47.39" class="difflineminus">-{</span>
<a href="#l47.40"></a><span id="l47.40" class="difflineminus">-  NS_ASSERTION(!m_folderStream || !aFileStream, &quot;m_folderStream is not null and we are assigning a non null stream to it&quot;);</span>
<a href="#l47.41"></a><span id="l47.41" class="difflineminus">-  m_folderStream = aFileStream; //m_folderStream is set externally, so m_ownFolderStream is false</span>
<a href="#l47.42"></a><span id="l47.42" class="difflineminus">-  m_ownFolderStream = PR_FALSE;</span>
<a href="#l47.43"></a><span id="l47.43" class="difflineminus">-  return NS_OK;</span>
<a href="#l47.44"></a><span id="l47.44" class="difflineminus">-}</span>
<a href="#l47.45"></a><span id="l47.45" class="difflineminus">-</span>
<a href="#l47.46"></a><span id="l47.46" class="difflineminus">-NS_IMETHODIMP nsMailDatabase::GetFolderStream(nsIOutputStream **aFileStream)</span>
<a href="#l47.47"></a><span id="l47.47" class="difflineminus">-{</span>
<a href="#l47.48"></a><span id="l47.48" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aFileStream);</span>
<a href="#l47.49"></a><span id="l47.49" class="difflineminus">-  if (!m_folderStream)</span>
<a href="#l47.50"></a><span id="l47.50" class="difflineminus">-  {</span>
<a href="#l47.51"></a><span id="l47.51" class="difflineminus">-    nsresult rv = MsgGetFileStream(m_folderFile, getter_AddRefs(m_folderStream));</span>
<a href="#l47.52"></a><span id="l47.52" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l47.53"></a><span id="l47.53" class="difflineminus">-    m_ownFolderStream = PR_TRUE;</span>
<a href="#l47.54"></a><span id="l47.54" class="difflineminus">-  }</span>
<a href="#l47.55"></a><span id="l47.55" class="difflineminus">-  </span>
<a href="#l47.56"></a><span id="l47.56" class="difflineminus">-  NS_IF_ADDREF(*aFileStream = m_folderStream);</span>
<a href="#l47.57"></a><span id="l47.57" class="difflineminus">-  return NS_OK;</span>
<a href="#l47.58"></a><span id="l47.58" class="difflineminus">-}</span>
<a href="#l47.59"></a><span id="l47.59" class="difflineminus">-</span>
<a href="#l47.60"></a><span id="l47.60" class="difflineminus">-static bool gGotGlobalPrefs = false;</span>
<a href="#l47.61"></a><span id="l47.61" class="difflineminus">-static PRInt32 gTimeStampLeeway;</span>
<a href="#l47.62"></a><span id="l47.62" class="difflineminus">-</span>
<a href="#l47.63"></a><span id="l47.63" class="difflineminus">-void nsMailDatabase::GetGlobalPrefs()</span>
<a href="#l47.64"></a><span id="l47.64" class="difflineminus">-{</span>
<a href="#l47.65"></a><span id="l47.65" class="difflineminus">-  if (!gGotGlobalPrefs)</span>
<a href="#l47.66"></a><span id="l47.66" class="difflineminus">-  {</span>
<a href="#l47.67"></a><span id="l47.67" class="difflineminus">-    nsMsgDatabase::GetGlobalPrefs();</span>
<a href="#l47.68"></a><span id="l47.68" class="difflineminus">-    GetIntPref(&quot;mail.db_timestamp_leeway&quot;, &amp;gTimeStampLeeway);</span>
<a href="#l47.69"></a><span id="l47.69" class="difflineminus">-    gGotGlobalPrefs = PR_TRUE;</span>
<a href="#l47.70"></a><span id="l47.70" class="difflineminus">-  }</span>
<a href="#l47.71"></a><span id="l47.71" class="difflineminus">-}</span>
<a href="#l47.72"></a><span id="l47.72"> // caller passes in upgrading==PR_TRUE if they want back a db even if the db is out of date.</span>
<a href="#l47.73"></a><span id="l47.73"> // If so, they'll extract out the interesting info from the db, close it, delete it, and</span>
<a href="#l47.74"></a><span id="l47.74"> // then try to open the db again, prior to reparsing.</span>
<a href="#l47.75"></a><span id="l47.75" class="difflineminus">-NS_IMETHODIMP nsMailDatabase::Open(nsILocalFile *aFolderName, bool aCreate, bool aUpgrading)</span>
<a href="#l47.76"></a><span id="l47.76" class="difflineplus">+nsresult nsMailDatabase::Open(nsILocalFile *aSummaryFile, bool aCreate,</span>
<a href="#l47.77"></a><span id="l47.77" class="difflineplus">+                              bool aUpgrading)</span>
<a href="#l47.78"></a><span id="l47.78"> {</span>
<a href="#l47.79"></a><span id="l47.79" class="difflineminus">-  m_folderFile = aFolderName;</span>
<a href="#l47.80"></a><span id="l47.80" class="difflineminus">-  nsresult rv = nsMsgDatabase::Open(aFolderName, aCreate, aUpgrading);</span>
<a href="#l47.81"></a><span id="l47.81" class="difflineminus">-  return rv;</span>
<a href="#l47.82"></a><span id="l47.82" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l47.83"></a><span id="l47.83" class="difflineplus">+  nsString leafName;</span>
<a href="#l47.84"></a><span id="l47.84" class="difflineplus">+  aSummaryFile-&gt;GetLeafName(leafName);</span>
<a href="#l47.85"></a><span id="l47.85" class="difflineplus">+  if (!StringEndsWith(leafName, NS_LITERAL_STRING(&quot;.msf&quot;),</span>
<a href="#l47.86"></a><span id="l47.86" class="difflineplus">+                     nsCaseInsensitiveStringComparator()))</span>
<a href="#l47.87"></a><span id="l47.87" class="difflineplus">+    NS_ERROR(&quot;non summary file passed into open\n&quot;);</span>
<a href="#l47.88"></a><span id="l47.88" class="difflineplus">+#endif</span>
<a href="#l47.89"></a><span id="l47.89" class="difflineplus">+  return nsMsgDatabase::Open(aSummaryFile, aCreate, aUpgrading);</span>
<a href="#l47.90"></a><span id="l47.90"> }</span>
<a href="#l47.91"></a><span id="l47.91"> </span>
<a href="#l47.92"></a><span id="l47.92"> NS_IMETHODIMP nsMailDatabase::ForceClosed()</span>
<a href="#l47.93"></a><span id="l47.93"> {</span>
<a href="#l47.94"></a><span id="l47.94">   m_mdbAllOfflineOpsTable = nsnull;</span>
<a href="#l47.95"></a><span id="l47.95">   return nsMsgDatabase::ForceClosed();</span>
<a href="#l47.96"></a><span id="l47.96"> }</span>
<a href="#l47.97"></a><span id="l47.97"> </span>
<a href="#l47.98"></a><span id="l47.98"> // get this on demand so that only db's that have offline ops will</span>
<a href="#l47.99"></a><span id="l47.99" class="difflineminus">-// create the table.	</span>
<a href="#l47.100"></a><span id="l47.100" class="difflineplus">+// create the table.</span>
<a href="#l47.101"></a><span id="l47.101"> nsresult nsMailDatabase::GetAllOfflineOpsTable()</span>
<a href="#l47.102"></a><span id="l47.102"> {</span>
<a href="#l47.103"></a><span id="l47.103">   nsresult rv = NS_OK;</span>
<a href="#l47.104"></a><span id="l47.104">   if (!m_mdbAllOfflineOpsTable)</span>
<a href="#l47.105"></a><span id="l47.105">     rv = GetTableCreateIfMissing(kOfflineOpsScope, kOfflineOpsTableKind, getter_AddRefs(m_mdbAllOfflineOpsTable), </span>
<a href="#l47.106"></a><span id="l47.106">                                                 m_offlineOpsRowScopeToken, m_offlineOpsTableKindToken) ;</span>
<a href="#l47.107"></a><span id="l47.107">   return rv;</span>
<a href="#l47.108"></a><span id="l47.108"> }</span>
<a href="#l47.109"></a><span id="l47.109"> </span>
<a href="#l47.110"></a><span id="l47.110" class="difflineminus">-// cache m_folderStream to make updating mozilla status flags fast</span>
<a href="#l47.111"></a><span id="l47.111"> NS_IMETHODIMP nsMailDatabase::StartBatch()</span>
<a href="#l47.112"></a><span id="l47.112"> {</span>
<a href="#l47.113"></a><span id="l47.113" class="difflineminus">-  if (!m_folderStream &amp;&amp; m_folder)  //only if we create a stream, set m_ownFolderStream to true.</span>
<a href="#l47.114"></a><span id="l47.114" class="difflineminus">-  {</span>
<a href="#l47.115"></a><span id="l47.115" class="difflineminus">-    bool isLocked;</span>
<a href="#l47.116"></a><span id="l47.116" class="difflineminus">-    m_folder-&gt;GetLocked(&amp;isLocked);</span>
<a href="#l47.117"></a><span id="l47.117" class="difflineminus">-    if (isLocked)</span>
<a href="#l47.118"></a><span id="l47.118" class="difflineminus">-    {</span>
<a href="#l47.119"></a><span id="l47.119" class="difflineminus">-      NS_ASSERTION(PR_FALSE, &quot;Some other operation is in progress&quot;);</span>
<a href="#l47.120"></a><span id="l47.120" class="difflineminus">-      return NS_MSG_FOLDER_BUSY;</span>
<a href="#l47.121"></a><span id="l47.121" class="difflineminus">-    }</span>
<a href="#l47.122"></a><span id="l47.122" class="difflineminus">-    nsresult rv = MsgGetFileStream(m_folderFile, getter_AddRefs(m_folderStream));</span>
<a href="#l47.123"></a><span id="l47.123" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l47.124"></a><span id="l47.124" class="difflineminus">-    m_ownFolderStream = PR_TRUE;</span>
<a href="#l47.125"></a><span id="l47.125" class="difflineminus">-  }</span>
<a href="#l47.126"></a><span id="l47.126" class="difflineminus">-</span>
<a href="#l47.127"></a><span id="l47.127">   return NS_OK;</span>
<a href="#l47.128"></a><span id="l47.128"> }</span>
<a href="#l47.129"></a><span id="l47.129"> </span>
<a href="#l47.130"></a><span id="l47.130"> NS_IMETHODIMP nsMailDatabase::EndBatch()</span>
<a href="#l47.131"></a><span id="l47.131"> {</span>
<a href="#l47.132"></a><span id="l47.132" class="difflineminus">-  if (m_ownFolderStream)   //only if we own the stream, then we should close it</span>
<a href="#l47.133"></a><span id="l47.133" class="difflineminus">-  {</span>
<a href="#l47.134"></a><span id="l47.134" class="difflineminus">-    if (m_folderStream)</span>
<a href="#l47.135"></a><span id="l47.135" class="difflineminus">-    {</span>
<a href="#l47.136"></a><span id="l47.136" class="difflineminus">-      m_folderStream-&gt;Flush();</span>
<a href="#l47.137"></a><span id="l47.137" class="difflineminus">-      m_folderStream-&gt;Close();  </span>
<a href="#l47.138"></a><span id="l47.138" class="difflineminus">-    }</span>
<a href="#l47.139"></a><span id="l47.139" class="difflineminus">-    m_folderStream = nsnull;</span>
<a href="#l47.140"></a><span id="l47.140" class="difflineminus">-    m_ownFolderStream = PR_FALSE;</span>
<a href="#l47.141"></a><span id="l47.141" class="difflineminus">-  }</span>
<a href="#l47.142"></a><span id="l47.142">   SetSummaryValid(PR_TRUE);</span>
<a href="#l47.143"></a><span id="l47.143">   return NS_OK;</span>
<a href="#l47.144"></a><span id="l47.144"> }</span>
<a href="#l47.145"></a><span id="l47.145"> </span>
<a href="#l47.146"></a><span id="l47.146"> NS_IMETHODIMP nsMailDatabase::DeleteMessages(PRUint32 aNumKeys, nsMsgKey* nsMsgKeys, nsIDBChangeListener *instigator)</span>
<a href="#l47.147"></a><span id="l47.147"> {</span>
<a href="#l47.148"></a><span id="l47.148">   nsresult rv;</span>
<a href="#l47.149"></a><span id="l47.149" class="difflineminus">-  if (!m_folderStream &amp;&amp; m_folder)</span>
<a href="#l47.150"></a><span id="l47.150" class="difflineplus">+  if (m_folder)</span>
<a href="#l47.151"></a><span id="l47.151">   {</span>
<a href="#l47.152"></a><span id="l47.152">     bool isLocked;</span>
<a href="#l47.153"></a><span id="l47.153">     m_folder-&gt;GetLocked(&amp;isLocked);</span>
<a href="#l47.154"></a><span id="l47.154">     if (isLocked)</span>
<a href="#l47.155"></a><span id="l47.155">     {</span>
<a href="#l47.156"></a><span id="l47.156">       NS_ASSERTION(PR_FALSE, &quot;Some other operation is in progress&quot;);</span>
<a href="#l47.157"></a><span id="l47.157">       return NS_MSG_FOLDER_BUSY;</span>
<a href="#l47.158"></a><span id="l47.158">     }</span>
<a href="#l47.159"></a><span id="l47.159" class="difflineminus">-    rv = MsgGetFileStream(m_folderFile, getter_AddRefs(m_folderStream));</span>
<a href="#l47.160"></a><span id="l47.160" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l47.161"></a><span id="l47.161" class="difflineminus">-    m_ownFolderStream = PR_TRUE;</span>
<a href="#l47.162"></a><span id="l47.162">   }</span>
<a href="#l47.163"></a><span id="l47.163"> </span>
<a href="#l47.164"></a><span id="l47.164">   rv = nsMsgDatabase::DeleteMessages(aNumKeys, nsMsgKeys, instigator);</span>
<a href="#l47.165"></a><span id="l47.165" class="difflineminus">-  if (m_ownFolderStream)//only if we own the stream, then we should close it</span>
<a href="#l47.166"></a><span id="l47.166" class="difflineminus">-  {</span>
<a href="#l47.167"></a><span id="l47.167" class="difflineminus">-    if (m_folderStream)</span>
<a href="#l47.168"></a><span id="l47.168" class="difflineminus">-    {</span>
<a href="#l47.169"></a><span id="l47.169" class="difflineminus">-      m_folderStream-&gt;Flush(); // this does a sync</span>
<a href="#l47.170"></a><span id="l47.170" class="difflineminus">-      m_folderStream-&gt;Close();</span>
<a href="#l47.171"></a><span id="l47.171" class="difflineminus">-    }</span>
<a href="#l47.172"></a><span id="l47.172" class="difflineminus">-    m_folderStream = nsnull;</span>
<a href="#l47.173"></a><span id="l47.173" class="difflineminus">-    m_ownFolderStream = PR_FALSE;</span>
<a href="#l47.174"></a><span id="l47.174" class="difflineminus">-  }</span>
<a href="#l47.175"></a><span id="l47.175" class="difflineminus">-</span>
<a href="#l47.176"></a><span id="l47.176" class="difflineminus">-  SetFolderInfoValid(m_folderFile, 0, 0);</span>
<a href="#l47.177"></a><span id="l47.177" class="difflineplus">+  SetSummaryValid(true);</span>
<a href="#l47.178"></a><span id="l47.178">   return rv;</span>
<a href="#l47.179"></a><span id="l47.179"> }</span>
<a href="#l47.180"></a><span id="l47.180"> </span>
<a href="#l47.181"></a><span id="l47.181" class="difflineminus">-// Helper routine - lowest level of flag setting</span>
<a href="#l47.182"></a><span id="l47.182" class="difflineminus">-bool nsMailDatabase::SetHdrFlag(nsIMsgDBHdr *msgHdr, bool bSet, nsMsgMessageFlagType flag)</span>
<a href="#l47.183"></a><span id="l47.183" class="difflineminus">-{</span>
<a href="#l47.184"></a><span id="l47.184" class="difflineminus">-  nsIOutputStream *fileStream = nsnull;</span>
<a href="#l47.185"></a><span id="l47.185" class="difflineminus">-  bool ret = false;</span>
<a href="#l47.186"></a><span id="l47.186" class="difflineminus">-</span>
<a href="#l47.187"></a><span id="l47.187" class="difflineminus">-  if (!m_folderStream &amp;&amp; m_folder)  //we are going to create a stream, bail out if someone else has lock</span>
<a href="#l47.188"></a><span id="l47.188" class="difflineminus">-  {</span>
<a href="#l47.189"></a><span id="l47.189" class="difflineminus">-    bool isLocked;</span>
<a href="#l47.190"></a><span id="l47.190" class="difflineminus">-    m_folder-&gt;GetLocked(&amp;isLocked);</span>
<a href="#l47.191"></a><span id="l47.191" class="difflineminus">-    if (isLocked)</span>
<a href="#l47.192"></a><span id="l47.192" class="difflineminus">-    {</span>
<a href="#l47.193"></a><span id="l47.193" class="difflineminus">-      NS_ASSERTION(PR_FALSE, &quot;Some other operation is in progress&quot;);</span>
<a href="#l47.194"></a><span id="l47.194" class="difflineminus">-      return PR_FALSE;</span>
<a href="#l47.195"></a><span id="l47.195" class="difflineminus">-    }</span>
<a href="#l47.196"></a><span id="l47.196" class="difflineminus">-  }</span>
<a href="#l47.197"></a><span id="l47.197" class="difflineminus">-  if (nsMsgDatabase::SetHdrFlag(msgHdr, bSet, flag))</span>
<a href="#l47.198"></a><span id="l47.198" class="difflineminus">-  {</span>
<a href="#l47.199"></a><span id="l47.199" class="difflineminus">-    UpdateFolderFlag(msgHdr, bSet, flag, &amp;fileStream);</span>
<a href="#l47.200"></a><span id="l47.200" class="difflineminus">-    if (fileStream)</span>
<a href="#l47.201"></a><span id="l47.201" class="difflineminus">-    {</span>
<a href="#l47.202"></a><span id="l47.202" class="difflineminus">-      fileStream-&gt;Flush();</span>
<a href="#l47.203"></a><span id="l47.203" class="difflineminus">-      fileStream-&gt;Close();</span>
<a href="#l47.204"></a><span id="l47.204" class="difflineminus">-      NS_RELEASE(fileStream);</span>
<a href="#l47.205"></a><span id="l47.205" class="difflineminus">-      SetFolderInfoValid(m_folderFile, 0, 0);</span>
<a href="#l47.206"></a><span id="l47.206" class="difflineminus">-    }</span>
<a href="#l47.207"></a><span id="l47.207" class="difflineminus">-    ret = PR_TRUE;</span>
<a href="#l47.208"></a><span id="l47.208" class="difflineminus">-  }</span>
<a href="#l47.209"></a><span id="l47.209" class="difflineminus">-</span>
<a href="#l47.210"></a><span id="l47.210" class="difflineminus">-  return ret;</span>
<a href="#l47.211"></a><span id="l47.211" class="difflineminus">-}</span>
<a href="#l47.212"></a><span id="l47.212" class="difflineminus">-</span>
<a href="#l47.213"></a><span id="l47.213" class="difflineminus">-// ### should move this into some utils class...</span>
<a href="#l47.214"></a><span id="l47.214" class="difflineminus">-int msg_UnHex(char C)</span>
<a href="#l47.215"></a><span id="l47.215" class="difflineminus">-{</span>
<a href="#l47.216"></a><span id="l47.216" class="difflineminus">-	return ((C &gt;= '0' &amp;&amp; C &lt;= '9') ? C - '0' :</span>
<a href="#l47.217"></a><span id="l47.217" class="difflineminus">-			((C &gt;= 'A' &amp;&amp; C &lt;= 'F') ? C - 'A' + 10 :</span>
<a href="#l47.218"></a><span id="l47.218" class="difflineminus">-			 ((C &gt;= 'a' &amp;&amp; C &lt;= 'f') ? C - 'a' + 10 : 0)));</span>
<a href="#l47.219"></a><span id="l47.219" class="difflineminus">-}</span>
<a href="#l47.220"></a><span id="l47.220" class="difflineminus">-</span>
<a href="#l47.221"></a><span id="l47.221" class="difflineminus">-</span>
<a href="#l47.222"></a><span id="l47.222" class="difflineminus">-// We let the caller close the file in case he's updating a lot of flags</span>
<a href="#l47.223"></a><span id="l47.223" class="difflineminus">-// and we don't want to open and close the file every time through.</span>
<a href="#l47.224"></a><span id="l47.224" class="difflineminus">-// As an experiment, try caching the fid in the db as m_folderFile.</span>
<a href="#l47.225"></a><span id="l47.225" class="difflineminus">-// If this is set, use it but don't return *pFid.</span>
<a href="#l47.226"></a><span id="l47.226" class="difflineminus">-void nsMailDatabase::UpdateFolderFlag(nsIMsgDBHdr *mailHdr, bool bSet, </span>
<a href="#l47.227"></a><span id="l47.227" class="difflineminus">-                                      nsMsgMessageFlagType flag,</span>
<a href="#l47.228"></a><span id="l47.228" class="difflineminus">-                                      nsIOutputStream **ppFileStream)</span>
<a href="#l47.229"></a><span id="l47.229" class="difflineminus">-{</span>
<a href="#l47.230"></a><span id="l47.230" class="difflineminus">-  static char buf[50];</span>
<a href="#l47.231"></a><span id="l47.231" class="difflineminus">-  PRInt64 folderStreamPos = 0; //saves the folderStream pos in case we are sharing the stream with other code</span>
<a href="#l47.232"></a><span id="l47.232" class="difflineminus">-  nsIOutputStream *fileStream = (m_folderStream) ? m_folderStream.get() : *ppFileStream;</span>
<a href="#l47.233"></a><span id="l47.233" class="difflineminus">-  PRUint32 offset;</span>
<a href="#l47.234"></a><span id="l47.234" class="difflineminus">-  (void)mailHdr-&gt;GetStatusOffset(&amp;offset);</span>
<a href="#l47.235"></a><span id="l47.235" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream;</span>
<a href="#l47.236"></a><span id="l47.236" class="difflineminus">-  </span>
<a href="#l47.237"></a><span id="l47.237" class="difflineminus">-  nsresult rv;</span>
<a href="#l47.238"></a><span id="l47.238" class="difflineminus">-  </span>
<a href="#l47.239"></a><span id="l47.239" class="difflineminus">-  if (offset &gt; 0) </span>
<a href="#l47.240"></a><span id="l47.240" class="difflineminus">-  {</span>
<a href="#l47.241"></a><span id="l47.241" class="difflineminus">-    </span>
<a href="#l47.242"></a><span id="l47.242" class="difflineminus">-    if (fileStream == NULL) </span>
<a href="#l47.243"></a><span id="l47.243" class="difflineminus">-    {</span>
<a href="#l47.244"></a><span id="l47.244" class="difflineminus">-      rv = MsgGetFileStream(m_folderFile, &amp;fileStream);</span>
<a href="#l47.245"></a><span id="l47.245" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l47.246"></a><span id="l47.246" class="difflineminus">-        return;</span>
<a href="#l47.247"></a><span id="l47.247" class="difflineminus">-      seekableStream = do_QueryInterface(fileStream);</span>
<a href="#l47.248"></a><span id="l47.248" class="difflineminus">-    }</span>
<a href="#l47.249"></a><span id="l47.249" class="difflineminus">-    else if (!m_ownFolderStream)</span>
<a href="#l47.250"></a><span id="l47.250" class="difflineminus">-    {</span>
<a href="#l47.251"></a><span id="l47.251" class="difflineminus">-      m_folderStream-&gt;Flush();</span>
<a href="#l47.252"></a><span id="l47.252" class="difflineminus">-      seekableStream = do_QueryInterface(fileStream);</span>
<a href="#l47.253"></a><span id="l47.253" class="difflineminus">-      seekableStream-&gt;Tell(&amp;folderStreamPos);</span>
<a href="#l47.254"></a><span id="l47.254" class="difflineminus">-    }</span>
<a href="#l47.255"></a><span id="l47.255" class="difflineminus">-    else</span>
<a href="#l47.256"></a><span id="l47.256" class="difflineminus">-      seekableStream = do_QueryInterface(m_folderStream);</span>
<a href="#l47.257"></a><span id="l47.257" class="difflineminus">-      </span>
<a href="#l47.258"></a><span id="l47.258" class="difflineminus">-    if (fileStream) </span>
<a href="#l47.259"></a><span id="l47.259" class="difflineminus">-    {</span>
<a href="#l47.260"></a><span id="l47.260" class="difflineminus">-      PRUint64 msgOffset;</span>
<a href="#l47.261"></a><span id="l47.261" class="difflineminus">-      (void)mailHdr-&gt;GetMessageOffset(&amp;msgOffset);</span>
<a href="#l47.262"></a><span id="l47.262" class="difflineminus">-      PRUint64 statusPos = msgOffset + offset;</span>
<a href="#l47.263"></a><span id="l47.263" class="difflineminus">-      NS_ASSERTION(offset &lt; 10000, &quot;extremely unlikely status offset&quot;);</span>
<a href="#l47.264"></a><span id="l47.264" class="difflineminus">-      seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, statusPos);</span>
<a href="#l47.265"></a><span id="l47.265" class="difflineminus">-      buf[0] = '\0';</span>
<a href="#l47.266"></a><span id="l47.266" class="difflineminus">-      nsCOMPtr &lt;nsIInputStream&gt; inputStream = do_QueryInterface(fileStream);</span>
<a href="#l47.267"></a><span id="l47.267" class="difflineminus">-      PRUint32 bytesRead;</span>
<a href="#l47.268"></a><span id="l47.268" class="difflineminus">-      if (NS_SUCCEEDED(inputStream-&gt;Read(buf, X_MOZILLA_STATUS_LEN + 6, &amp;bytesRead)))</span>
<a href="#l47.269"></a><span id="l47.269" class="difflineminus">-      {</span>
<a href="#l47.270"></a><span id="l47.270" class="difflineminus">-        buf[bytesRead] = '\0';</span>
<a href="#l47.271"></a><span id="l47.271" class="difflineminus">-        if (strncmp(buf, X_MOZILLA_STATUS, X_MOZILLA_STATUS_LEN) == 0 &amp;&amp;</span>
<a href="#l47.272"></a><span id="l47.272" class="difflineminus">-          strncmp(buf + X_MOZILLA_STATUS_LEN, &quot;: &quot;, 2) == 0 &amp;&amp;</span>
<a href="#l47.273"></a><span id="l47.273" class="difflineminus">-          strlen(buf) &gt;= X_MOZILLA_STATUS_LEN + 6) </span>
<a href="#l47.274"></a><span id="l47.274" class="difflineminus">-        {</span>
<a href="#l47.275"></a><span id="l47.275" class="difflineminus">-          PRUint32 flags;</span>
<a href="#l47.276"></a><span id="l47.276" class="difflineminus">-          PRUint32 bytesWritten;</span>
<a href="#l47.277"></a><span id="l47.277" class="difflineminus">-          (void)mailHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l47.278"></a><span id="l47.278" class="difflineminus">-          if (!(flags &amp; nsMsgMessageFlags::Expunged))</span>
<a href="#l47.279"></a><span id="l47.279" class="difflineminus">-          {</span>
<a href="#l47.280"></a><span id="l47.280" class="difflineminus">-            int i;</span>
<a href="#l47.281"></a><span id="l47.281" class="difflineminus">-            char *p = buf + X_MOZILLA_STATUS_LEN + 2;</span>
<a href="#l47.282"></a><span id="l47.282" class="difflineminus">-            </span>
<a href="#l47.283"></a><span id="l47.283" class="difflineminus">-            for (i=0, flags = 0; i&lt;4; i++, p++)</span>
<a href="#l47.284"></a><span id="l47.284" class="difflineminus">-            {</span>
<a href="#l47.285"></a><span id="l47.285" class="difflineminus">-              flags = (flags &lt;&lt; 4) | msg_UnHex(*p);</span>
<a href="#l47.286"></a><span id="l47.286" class="difflineminus">-            }</span>
<a href="#l47.287"></a><span id="l47.287" class="difflineminus">-            </span>
<a href="#l47.288"></a><span id="l47.288" class="difflineminus">-            PRUint32 curFlags;</span>
<a href="#l47.289"></a><span id="l47.289" class="difflineminus">-            (void)mailHdr-&gt;GetFlags(&amp;curFlags);</span>
<a href="#l47.290"></a><span id="l47.290" class="difflineminus">-            flags = (flags &amp; nsMsgMessageFlags::Queued) |</span>
<a href="#l47.291"></a><span id="l47.291" class="difflineminus">-              (curFlags &amp; ~nsMsgMessageFlags::RuntimeOnly);</span>
<a href="#l47.292"></a><span id="l47.292" class="difflineminus">-          }</span>
<a href="#l47.293"></a><span id="l47.293" class="difflineminus">-          else</span>
<a href="#l47.294"></a><span id="l47.294" class="difflineminus">-          {</span>
<a href="#l47.295"></a><span id="l47.295" class="difflineminus">-            flags &amp;= ~nsMsgMessageFlags::RuntimeOnly;</span>
<a href="#l47.296"></a><span id="l47.296" class="difflineminus">-          }</span>
<a href="#l47.297"></a><span id="l47.297" class="difflineminus">-          seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, statusPos);</span>
<a href="#l47.298"></a><span id="l47.298" class="difflineminus">-          // We are filing out x-mozilla-status flags here</span>
<a href="#l47.299"></a><span id="l47.299" class="difflineminus">-          PR_snprintf(buf, sizeof(buf), X_MOZILLA_STATUS_FORMAT,</span>
<a href="#l47.300"></a><span id="l47.300" class="difflineminus">-            flags &amp; 0x0000FFFF);</span>
<a href="#l47.301"></a><span id="l47.301" class="difflineminus">-          PRInt32 lineLen = PL_strlen(buf);</span>
<a href="#l47.302"></a><span id="l47.302" class="difflineminus">-          PRUint64 status2Pos = statusPos + lineLen;</span>
<a href="#l47.303"></a><span id="l47.303" class="difflineminus">-          fileStream-&gt;Write(buf, lineLen, &amp;bytesWritten);</span>
<a href="#l47.304"></a><span id="l47.304" class="difflineminus">-</span>
<a href="#l47.305"></a><span id="l47.305" class="difflineminus">-          // time to upate x-mozilla-status2</span>
<a href="#l47.306"></a><span id="l47.306" class="difflineminus">-          // first find it by finding end of previous line, see bug 234935</span>
<a href="#l47.307"></a><span id="l47.307" class="difflineminus">-          seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, status2Pos);</span>
<a href="#l47.308"></a><span id="l47.308" class="difflineminus">-          do</span>
<a href="#l47.309"></a><span id="l47.309" class="difflineminus">-          {</span>
<a href="#l47.310"></a><span id="l47.310" class="difflineminus">-            rv = inputStream-&gt;Read(buf, 1, &amp;bytesRead);</span>
<a href="#l47.311"></a><span id="l47.311" class="difflineminus">-            status2Pos++;</span>
<a href="#l47.312"></a><span id="l47.312" class="difflineminus">-          } while (NS_SUCCEEDED(rv) &amp;&amp; (*buf == '\n' || *buf == '\r'));</span>
<a href="#l47.313"></a><span id="l47.313" class="difflineminus">-          status2Pos--;</span>
<a href="#l47.314"></a><span id="l47.314" class="difflineminus">-          seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, status2Pos);</span>
<a href="#l47.315"></a><span id="l47.315" class="difflineminus">-          if (NS_SUCCEEDED(inputStream-&gt;Read(buf, X_MOZILLA_STATUS2_LEN + 10, &amp;bytesRead)))</span>
<a href="#l47.316"></a><span id="l47.316" class="difflineminus">-          {</span>
<a href="#l47.317"></a><span id="l47.317" class="difflineminus">-            if (strncmp(buf, X_MOZILLA_STATUS2, X_MOZILLA_STATUS2_LEN) == 0 &amp;&amp;</span>
<a href="#l47.318"></a><span id="l47.318" class="difflineminus">-              strncmp(buf + X_MOZILLA_STATUS2_LEN, &quot;: &quot;, 2) == 0 &amp;&amp;</span>
<a href="#l47.319"></a><span id="l47.319" class="difflineminus">-              strlen(buf) &gt;= X_MOZILLA_STATUS2_LEN + 10) </span>
<a href="#l47.320"></a><span id="l47.320" class="difflineminus">-            {</span>
<a href="#l47.321"></a><span id="l47.321" class="difflineminus">-              PRUint32 dbFlags;</span>
<a href="#l47.322"></a><span id="l47.322" class="difflineminus">-              (void)mailHdr-&gt;GetFlags(&amp;dbFlags);</span>
<a href="#l47.323"></a><span id="l47.323" class="difflineminus">-              dbFlags &amp;= 0xFFFF0000;</span>
<a href="#l47.324"></a><span id="l47.324" class="difflineminus">-              seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, status2Pos);</span>
<a href="#l47.325"></a><span id="l47.325" class="difflineminus">-              PR_snprintf(buf, sizeof(buf), X_MOZILLA_STATUS2_FORMAT, dbFlags);</span>
<a href="#l47.326"></a><span id="l47.326" class="difflineminus">-              fileStream-&gt;Write(buf, PL_strlen(buf), &amp;bytesWritten);</span>
<a href="#l47.327"></a><span id="l47.327" class="difflineminus">-            }</span>
<a href="#l47.328"></a><span id="l47.328" class="difflineminus">-          }</span>
<a href="#l47.329"></a><span id="l47.329" class="difflineminus">-        } else </span>
<a href="#l47.330"></a><span id="l47.330" class="difflineminus">-        {</span>
<a href="#l47.331"></a><span id="l47.331" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l47.332"></a><span id="l47.332" class="difflineminus">-          printf(&quot;Didn't find %s where expected at position %ld\n&quot;</span>
<a href="#l47.333"></a><span id="l47.333" class="difflineminus">-            &quot;instead, found %s.\n&quot;,</span>
<a href="#l47.334"></a><span id="l47.334" class="difflineminus">-            X_MOZILLA_STATUS, (long) statusPos, buf);</span>
<a href="#l47.335"></a><span id="l47.335" class="difflineminus">-#endif</span>
<a href="#l47.336"></a><span id="l47.336" class="difflineminus">-          SetReparse(PR_TRUE);</span>
<a href="#l47.337"></a><span id="l47.337" class="difflineminus">-        }			</span>
<a href="#l47.338"></a><span id="l47.338" class="difflineminus">-      } </span>
<a href="#l47.339"></a><span id="l47.339" class="difflineminus">-      else </span>
<a href="#l47.340"></a><span id="l47.340" class="difflineminus">-      {</span>
<a href="#l47.341"></a><span id="l47.341" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l47.342"></a><span id="l47.342" class="difflineminus">-        printf(&quot;Couldn't read old status line at all at position %ld\n&quot;,</span>
<a href="#l47.343"></a><span id="l47.343" class="difflineminus">-          (long) statusPos);</span>
<a href="#l47.344"></a><span id="l47.344" class="difflineminus">-#endif</span>
<a href="#l47.345"></a><span id="l47.345" class="difflineminus">-        SetReparse(PR_TRUE);</span>
<a href="#l47.346"></a><span id="l47.346" class="difflineminus">-      }</span>
<a href="#l47.347"></a><span id="l47.347" class="difflineminus">-    }</span>
<a href="#l47.348"></a><span id="l47.348" class="difflineminus">-    else</span>
<a href="#l47.349"></a><span id="l47.349" class="difflineminus">-    {</span>
<a href="#l47.350"></a><span id="l47.350" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l47.351"></a><span id="l47.351" class="difflineminus">-      nsCString folderPath;</span>
<a href="#l47.352"></a><span id="l47.352" class="difflineminus">-      m_folderFile-&gt;GetNativePath(folderPath);</span>
<a href="#l47.353"></a><span id="l47.353" class="difflineminus">-      printf(&quot;Couldn't open mail folder for update%s!\n&quot;,</span>
<a href="#l47.354"></a><span id="l47.354" class="difflineminus">-        folderPath.get());</span>
<a href="#l47.355"></a><span id="l47.355" class="difflineminus">-#endif</span>
<a href="#l47.356"></a><span id="l47.356" class="difflineminus">-      PR_ASSERT(PR_FALSE);</span>
<a href="#l47.357"></a><span id="l47.357" class="difflineminus">-    }</span>
<a href="#l47.358"></a><span id="l47.358" class="difflineminus">-    if (!m_folderStream)</span>
<a href="#l47.359"></a><span id="l47.359" class="difflineminus">-      *ppFileStream = fileStream; // This tells the caller that we opened the file, and please to close it.</span>
<a href="#l47.360"></a><span id="l47.360" class="difflineminus">-    else if (!m_ownFolderStream)</span>
<a href="#l47.361"></a><span id="l47.361" class="difflineminus">-      seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, folderStreamPos);</span>
<a href="#l47.362"></a><span id="l47.362" class="difflineminus">-  }</span>
<a href="#l47.363"></a><span id="l47.363" class="difflineminus">-}</span>
<a href="#l47.364"></a><span id="l47.364" class="difflineminus">-</span>
<a href="#l47.365"></a><span id="l47.365" class="difflineminus">-// Get the current attributes of the mbox file, corrected for caching</span>
<a href="#l47.366"></a><span id="l47.366" class="difflineminus">-void nsMailDatabase::GetMailboxModProperties(PRInt64 *aSize, PRUint32 *aDate)</span>
<a href="#l47.367"></a><span id="l47.367" class="difflineminus">-{</span>
<a href="#l47.368"></a><span id="l47.368" class="difflineminus">-  // We'll simply return 0 on errors.</span>
<a href="#l47.369"></a><span id="l47.369" class="difflineminus">-  *aDate = 0;</span>
<a href="#l47.370"></a><span id="l47.370" class="difflineminus">-  *aSize = 0;</span>
<a href="#l47.371"></a><span id="l47.371" class="difflineminus">-  if (!m_folderFile)</span>
<a href="#l47.372"></a><span id="l47.372" class="difflineminus">-    return;</span>
<a href="#l47.373"></a><span id="l47.373" class="difflineminus">-</span>
<a href="#l47.374"></a><span id="l47.374" class="difflineminus">-  // clone file because nsLocalFile caches sizes and dates.</span>
<a href="#l47.375"></a><span id="l47.375" class="difflineminus">-  nsCOMPtr&lt;nsIFile&gt; copyFolderFile;</span>
<a href="#l47.376"></a><span id="l47.376" class="difflineminus">-  nsresult rv = m_folderFile-&gt;Clone(getter_AddRefs(copyFolderFile));</span>
<a href="#l47.377"></a><span id="l47.377" class="difflineminus">-  if (NS_FAILED(rv) || !copyFolderFile)</span>
<a href="#l47.378"></a><span id="l47.378" class="difflineminus">-    return;</span>
<a href="#l47.379"></a><span id="l47.379" class="difflineminus">-</span>
<a href="#l47.380"></a><span id="l47.380" class="difflineminus">-  rv = copyFolderFile-&gt;GetFileSize(aSize);</span>
<a href="#l47.381"></a><span id="l47.381" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l47.382"></a><span id="l47.382" class="difflineminus">-    return;</span>
<a href="#l47.383"></a><span id="l47.383" class="difflineminus">-</span>
<a href="#l47.384"></a><span id="l47.384" class="difflineminus">-  PRInt64 lastModTime;</span>
<a href="#l47.385"></a><span id="l47.385" class="difflineminus">-  rv = copyFolderFile-&gt;GetLastModifiedTime(&amp;lastModTime);</span>
<a href="#l47.386"></a><span id="l47.386" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l47.387"></a><span id="l47.387" class="difflineminus">-    return;</span>
<a href="#l47.388"></a><span id="l47.388" class="difflineminus">-</span>
<a href="#l47.389"></a><span id="l47.389" class="difflineminus">-  PRTime  temp64;</span>
<a href="#l47.390"></a><span id="l47.390" class="difflineminus">-  PRInt64 thousand;</span>
<a href="#l47.391"></a><span id="l47.391" class="difflineminus">-  LL_I2L(thousand, PR_MSEC_PER_SEC);</span>
<a href="#l47.392"></a><span id="l47.392" class="difflineminus">-  LL_DIV(temp64, lastModTime, thousand);</span>
<a href="#l47.393"></a><span id="l47.393" class="difflineminus">-  LL_L2UI(*aDate, temp64);</span>
<a href="#l47.394"></a><span id="l47.394" class="difflineminus">-  return;</span>
<a href="#l47.395"></a><span id="l47.395" class="difflineminus">-}</span>
<a href="#l47.396"></a><span id="l47.396" class="difflineminus">-</span>
<a href="#l47.397"></a><span id="l47.397"> NS_IMETHODIMP nsMailDatabase::GetSummaryValid(bool *aResult)</span>
<a href="#l47.398"></a><span id="l47.398"> {</span>
<a href="#l47.399"></a><span id="l47.399" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l47.400"></a><span id="l47.400" class="difflineminus">-  PRUint64 folderSize;</span>
<a href="#l47.401"></a><span id="l47.401" class="difflineminus">-  PRUint32  folderDate;</span>
<a href="#l47.402"></a><span id="l47.402" class="difflineminus">-  PRInt32 numUnreadMessages;</span>
<a href="#l47.403"></a><span id="l47.403" class="difflineminus">-  nsAutoString errorMsg;</span>
<a href="#l47.404"></a><span id="l47.404" class="difflineminus">-</span>
<a href="#l47.405"></a><span id="l47.405" class="difflineminus">-  *aResult = PR_FALSE;</span>
<a href="#l47.406"></a><span id="l47.406" class="difflineminus">-</span>
<a href="#l47.407"></a><span id="l47.407" class="difflineminus">-  if (m_folderFile &amp;&amp; m_dbFolderInfo)</span>
<a href="#l47.408"></a><span id="l47.408" class="difflineplus">+  PRUint32 version;</span>
<a href="#l47.409"></a><span id="l47.409" class="difflineplus">+  m_dbFolderInfo-&gt;GetVersion(&amp;version);</span>
<a href="#l47.410"></a><span id="l47.410" class="difflineplus">+  if (GetCurVersion() != version)</span>
<a href="#l47.411"></a><span id="l47.411">   {</span>
<a href="#l47.412"></a><span id="l47.412" class="difflineminus">-    m_dbFolderInfo-&gt;GetNumUnreadMessages(&amp;numUnreadMessages);</span>
<a href="#l47.413"></a><span id="l47.413" class="difflineminus">-    m_dbFolderInfo-&gt;GetFolderSize(&amp;folderSize);</span>
<a href="#l47.414"></a><span id="l47.414" class="difflineminus">-    m_dbFolderInfo-&gt;GetFolderDate(&amp;folderDate);</span>
<a href="#l47.415"></a><span id="l47.415" class="difflineminus">-</span>
<a href="#l47.416"></a><span id="l47.416" class="difflineminus">-    // compare current version of db versus filed out version info, </span>
<a href="#l47.417"></a><span id="l47.417" class="difflineminus">-    // and file size in db vs file size on disk.</span>
<a href="#l47.418"></a><span id="l47.418" class="difflineminus">-    PRUint32 version;</span>
<a href="#l47.419"></a><span id="l47.419" class="difflineminus">-    m_dbFolderInfo-&gt;GetVersion(&amp;version);</span>
<a href="#l47.420"></a><span id="l47.420" class="difflineminus">-</span>
<a href="#l47.421"></a><span id="l47.421" class="difflineminus">-    PRInt64 fileSize;</span>
<a href="#l47.422"></a><span id="l47.422" class="difflineminus">-    PRUint32 actualFolderTimeStamp;</span>
<a href="#l47.423"></a><span id="l47.423" class="difflineminus">-    GetMailboxModProperties(&amp;fileSize, &amp;actualFolderTimeStamp);</span>
<a href="#l47.424"></a><span id="l47.424" class="difflineminus">-</span>
<a href="#l47.425"></a><span id="l47.425" class="difflineminus">-    if (folderSize == fileSize &amp;&amp;</span>
<a href="#l47.426"></a><span id="l47.426" class="difflineminus">-        numUnreadMessages &gt;= 0 &amp;&amp; GetCurVersion() == version)</span>
<a href="#l47.427"></a><span id="l47.427" class="difflineminus">-    {</span>
<a href="#l47.428"></a><span id="l47.428" class="difflineminus">-      GetGlobalPrefs();</span>
<a href="#l47.429"></a><span id="l47.429" class="difflineminus">-      // if those values are ok, check time stamp</span>
<a href="#l47.430"></a><span id="l47.430" class="difflineminus">-      if (gTimeStampLeeway == 0)</span>
<a href="#l47.431"></a><span id="l47.431" class="difflineminus">-        *aResult = folderDate == actualFolderTimeStamp;</span>
<a href="#l47.432"></a><span id="l47.432" class="difflineminus">-      else</span>
<a href="#l47.433"></a><span id="l47.433" class="difflineminus">-        *aResult = NS_ABS((PRInt32) (actualFolderTimeStamp - folderDate)) &lt;= gTimeStampLeeway;</span>
<a href="#l47.434"></a><span id="l47.434" class="difflineminus">-#ifndef PUTUP_ALERT_ON_INVALID_DB</span>
<a href="#l47.435"></a><span id="l47.435" class="difflineminus">-    }</span>
<a href="#l47.436"></a><span id="l47.436" class="difflineplus">+    *aResult = PR_FALSE;</span>
<a href="#l47.437"></a><span id="l47.437" class="difflineplus">+    return NS_OK;</span>
<a href="#l47.438"></a><span id="l47.438">   }</span>
<a href="#l47.439"></a><span id="l47.439" class="difflineminus">-#else</span>
<a href="#l47.440"></a><span id="l47.440" class="difflineminus">-      if (!*aResult)</span>
<a href="#l47.441"></a><span id="l47.441" class="difflineminus">-      {</span>
<a href="#l47.442"></a><span id="l47.442" class="difflineminus">-        errorMsg.AppendLiteral(&quot;time stamp didn't match delta = &quot;);</span>
<a href="#l47.443"></a><span id="l47.443" class="difflineminus">-        errorMsg.AppendInt(actualFolderTimeStamp - folderDate);</span>
<a href="#l47.444"></a><span id="l47.444" class="difflineminus">-        errorMsg.AppendLiteral(&quot; leeway = &quot;);</span>
<a href="#l47.445"></a><span id="l47.445" class="difflineminus">-        errorMsg.AppendInt(gTimeStampLeeway);</span>
<a href="#l47.446"></a><span id="l47.446" class="difflineminus">-      }</span>
<a href="#l47.447"></a><span id="l47.447" class="difflineminus">-    }</span>
<a href="#l47.448"></a><span id="l47.448" class="difflineminus">-    else if (folderSize != fileSize)</span>
<a href="#l47.449"></a><span id="l47.449" class="difflineminus">-    {</span>
<a href="#l47.450"></a><span id="l47.450" class="difflineminus">-      errorMsg.AppendLiteral(&quot;folder size didn't match db size = &quot;);</span>
<a href="#l47.451"></a><span id="l47.451" class="difflineminus">-      errorMsg.AppendInt(folderSize);</span>
<a href="#l47.452"></a><span id="l47.452" class="difflineminus">-      errorMsg.AppendLiteral(&quot; actual size = &quot;);</span>
<a href="#l47.453"></a><span id="l47.453" class="difflineminus">-      errorMsg.AppendInt(fileSize);</span>
<a href="#l47.454"></a><span id="l47.454" class="difflineminus">-    }</span>
<a href="#l47.455"></a><span id="l47.455" class="difflineminus">-    else if (numUnreadMessages &lt; 0)</span>
<a href="#l47.456"></a><span id="l47.456" class="difflineminus">-    {</span>
<a href="#l47.457"></a><span id="l47.457" class="difflineminus">-      errorMsg.AppendLiteral(&quot;numUnreadMessages &lt; 0&quot;);</span>
<a href="#l47.458"></a><span id="l47.458" class="difflineminus">-    }</span>
<a href="#l47.459"></a><span id="l47.459" class="difflineminus">-  }</span>
<a href="#l47.460"></a><span id="l47.460" class="difflineminus">-  if (errorMsg.Length())</span>
<a href="#l47.461"></a><span id="l47.461" class="difflineminus">-  {</span>
<a href="#l47.462"></a><span id="l47.462" class="difflineminus">-    nsCOMPtr&lt;nsIPrompt&gt; dialog;</span>
<a href="#l47.463"></a><span id="l47.463" class="difflineminus">-</span>
<a href="#l47.464"></a><span id="l47.464" class="difflineminus">-    nsCOMPtr&lt;nsIWindowWatcher&gt; wwatch(do_GetService(NS_WINDOWWATCHER_CONTRACTID));</span>
<a href="#l47.465"></a><span id="l47.465" class="difflineminus">-    if (wwatch)</span>
<a href="#l47.466"></a><span id="l47.466" class="difflineminus">-      wwatch-&gt;GetNewPrompter(0, getter_AddRefs(dialog));</span>
<a href="#l47.467"></a><span id="l47.467" class="difflineminus">-    if (dialog)</span>
<a href="#l47.468"></a><span id="l47.468" class="difflineminus">-      dialog-&gt;Alert(nsnull, errorMsg.get());</span>
<a href="#l47.469"></a><span id="l47.469" class="difflineminus">-  }</span>
<a href="#l47.470"></a><span id="l47.470" class="difflineminus">-#endif // PUTUP_ALERT_ON_INVALID_DB</span>
<a href="#l47.471"></a><span id="l47.471" class="difflineminus">-  return NS_OK;</span>
<a href="#l47.472"></a><span id="l47.472" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l47.473"></a><span id="l47.473" class="difflineplus">+  if (!m_folder)</span>
<a href="#l47.474"></a><span id="l47.474" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l47.475"></a><span id="l47.475" class="difflineplus">+  nsresult rv = m_folder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l47.476"></a><span id="l47.476" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l47.477"></a><span id="l47.477" class="difflineplus">+  return msgStore-&gt;IsSummaryFileValid(m_folder, this, aResult);</span>
<a href="#l47.478"></a><span id="l47.478"> }</span>
<a href="#l47.479"></a><span id="l47.479"> </span>
<a href="#l47.480"></a><span id="l47.480" class="difflineminus">-NS_IMETHODIMP nsMailDatabase::SetSummaryValid(bool valid)</span>
<a href="#l47.481"></a><span id="l47.481" class="difflineplus">+NS_IMETHODIMP nsMailDatabase::SetSummaryValid(bool aValid)</span>
<a href="#l47.482"></a><span id="l47.482"> {</span>
<a href="#l47.483"></a><span id="l47.483" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l47.484"></a><span id="l47.484" class="difflineminus">-  bool exists;</span>
<a href="#l47.485"></a><span id="l47.485" class="difflineminus">-  m_folderFile-&gt;Exists(&amp;exists);</span>
<a href="#l47.486"></a><span id="l47.486" class="difflineminus">-  if (!exists) </span>
<a href="#l47.487"></a><span id="l47.487" class="difflineminus">-    return NS_MSG_ERROR_FOLDER_MISSING;</span>
<a href="#l47.488"></a><span id="l47.488" class="difflineminus">-  </span>
<a href="#l47.489"></a><span id="l47.489" class="difflineminus">-  if (m_dbFolderInfo)</span>
<a href="#l47.490"></a><span id="l47.490" class="difflineminus">-  {</span>
<a href="#l47.491"></a><span id="l47.491" class="difflineminus">-    if (valid)</span>
<a href="#l47.492"></a><span id="l47.492" class="difflineminus">-    {</span>
<a href="#l47.493"></a><span id="l47.493" class="difflineminus">-      PRUint32 actualFolderTimeStamp;</span>
<a href="#l47.494"></a><span id="l47.494" class="difflineminus">-      PRInt64 fileSize;</span>
<a href="#l47.495"></a><span id="l47.495" class="difflineminus">-      GetMailboxModProperties(&amp;fileSize, &amp;actualFolderTimeStamp);</span>
<a href="#l47.496"></a><span id="l47.496" class="difflineminus">-      m_dbFolderInfo-&gt;SetFolderSize(fileSize);</span>
<a href="#l47.497"></a><span id="l47.497" class="difflineminus">-      m_dbFolderInfo-&gt;SetFolderDate(actualFolderTimeStamp);</span>
<a href="#l47.498"></a><span id="l47.498" class="difflineminus">-      m_dbFolderInfo-&gt;SetVersion(GetCurVersion());</span>
<a href="#l47.499"></a><span id="l47.499" class="difflineminus">-    }</span>
<a href="#l47.500"></a><span id="l47.500" class="difflineminus">-    else</span>
<a href="#l47.501"></a><span id="l47.501" class="difflineminus">-    {</span>
<a href="#l47.502"></a><span id="l47.502" class="difflineminus">-      m_dbFolderInfo-&gt;SetVersion(0);	// that ought to do the trick.</span>
<a href="#l47.503"></a><span id="l47.503" class="difflineminus">-    }</span>
<a href="#l47.504"></a><span id="l47.504" class="difflineminus">-  }</span>
<a href="#l47.505"></a><span id="l47.505" class="difflineminus">-  Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l47.506"></a><span id="l47.506" class="difflineminus">-  return rv;</span>
<a href="#l47.507"></a><span id="l47.507" class="difflineplus">+  nsMsgDatabase::SetSummaryValid(aValid);</span>
<a href="#l47.508"></a><span id="l47.508" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l47.509"></a><span id="l47.509" class="difflineplus">+  if (!m_folder)</span>
<a href="#l47.510"></a><span id="l47.510" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l47.511"></a><span id="l47.511" class="difflineplus">+</span>
<a href="#l47.512"></a><span id="l47.512" class="difflineplus">+  nsresult rv = m_folder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l47.513"></a><span id="l47.513" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l47.514"></a><span id="l47.514" class="difflineplus">+  return msgStore-&gt;SetSummaryFileValid(m_folder, this, aValid);</span>
<a href="#l47.515"></a><span id="l47.515"> }</span>
<a href="#l47.516"></a><span id="l47.516"> </span>
<a href="#l47.517"></a><span id="l47.517" class="difflineminus">-nsresult nsMailDatabase::GetFolderName(nsString &amp;folderName)</span>
<a href="#l47.518"></a><span id="l47.518" class="difflineminus">-{</span>
<a href="#l47.519"></a><span id="l47.519" class="difflineminus">-  m_folderFile-&gt;GetPath(folderName);</span>
<a href="#l47.520"></a><span id="l47.520" class="difflineminus">-  return NS_OK;</span>
<a href="#l47.521"></a><span id="l47.521" class="difflineminus">-}</span>
<a href="#l47.522"></a><span id="l47.522" class="difflineminus">-</span>
<a href="#l47.523"></a><span id="l47.523" class="difflineminus">-</span>
<a href="#l47.524"></a><span id="l47.524"> NS_IMETHODIMP  nsMailDatabase::RemoveOfflineOp(nsIMsgOfflineImapOperation *op)</span>
<a href="#l47.525"></a><span id="l47.525"> {</span>
<a href="#l47.526"></a><span id="l47.526">   </span>
<a href="#l47.527"></a><span id="l47.527">   nsresult rv = GetAllOfflineOpsTable();</span>
<a href="#l47.528"></a><span id="l47.528">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l47.529"></a><span id="l47.529">   </span>
<a href="#l47.530"></a><span id="l47.530">   if (!op || !m_mdbAllOfflineOpsTable)</span>
<a href="#l47.531"></a><span id="l47.531">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l47.532"></a><span id="l47.532" class="difflineat">@@ -694,93 +329,23 @@ NS_IMETHODIMP nsMailDatabase::ListAllOff</span>
<a href="#l47.533"></a><span id="l47.533">       }</span>
<a href="#l47.534"></a><span id="l47.534">     }</span>
<a href="#l47.535"></a><span id="l47.535">     rv = (err == NS_OK) ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l47.536"></a><span id="l47.536">     rowCursor-&gt;Release();</span>
<a href="#l47.537"></a><span id="l47.537">   }</span>
<a href="#l47.538"></a><span id="l47.538">   return rv;</span>
<a href="#l47.539"></a><span id="l47.539"> }</span>
<a href="#l47.540"></a><span id="l47.540"> </span>
<a href="#l47.541"></a><span id="l47.541" class="difflineminus">-/* static */</span>
<a href="#l47.542"></a><span id="l47.542" class="difflineminus">-nsresult nsMailDatabase::SetFolderInfoValid(nsILocalFile *folderName, int num, int numunread)</span>
<a href="#l47.543"></a><span id="l47.543" class="difflineminus">-{</span>
<a href="#l47.544"></a><span id="l47.544" class="difflineminus">-  nsresult err = NS_OK;</span>
<a href="#l47.545"></a><span id="l47.545" class="difflineminus">-  bool bOpenedDB = false;</span>
<a href="#l47.546"></a><span id="l47.546" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; summaryPath;</span>
<a href="#l47.547"></a><span id="l47.547" class="difflineminus">-  GetSummaryFileLocation(folderName, getter_AddRefs(summaryPath));</span>
<a href="#l47.548"></a><span id="l47.548" class="difflineminus">-  </span>
<a href="#l47.549"></a><span id="l47.549" class="difflineminus">-  bool exists;</span>
<a href="#l47.550"></a><span id="l47.550" class="difflineminus">-  folderName-&gt;Exists(&amp;exists);</span>
<a href="#l47.551"></a><span id="l47.551" class="difflineminus">-  if (!exists)</span>
<a href="#l47.552"></a><span id="l47.552" class="difflineminus">-    return NS_MSG_ERROR_FOLDER_SUMMARY_MISSING;</span>
<a href="#l47.553"></a><span id="l47.553" class="difflineminus">-  </span>
<a href="#l47.554"></a><span id="l47.554" class="difflineminus">-  // should we have type safe downcast methods again?</span>
<a href="#l47.555"></a><span id="l47.555" class="difflineminus">-  nsMailDatabase *pMessageDB = (nsMailDatabase *) nsMailDatabase::FindInCache(summaryPath);</span>
<a href="#l47.556"></a><span id="l47.556" class="difflineminus">-  if (pMessageDB == nsnull)</span>
<a href="#l47.557"></a><span id="l47.557" class="difflineminus">-  {</span>
<a href="#l47.558"></a><span id="l47.558" class="difflineminus">-    pMessageDB = new nsMailDatabase();</span>
<a href="#l47.559"></a><span id="l47.559" class="difflineminus">-    if(!pMessageDB)</span>
<a href="#l47.560"></a><span id="l47.560" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l47.561"></a><span id="l47.561" class="difflineminus">-    </span>
<a href="#l47.562"></a><span id="l47.562" class="difflineminus">-    pMessageDB-&gt;m_folderFile = folderName;</span>
<a href="#l47.563"></a><span id="l47.563" class="difflineminus">-    </span>
<a href="#l47.564"></a><span id="l47.564" class="difflineminus">-//    *(pMessageDB-&gt;m_folderSpec) = summaryPath;</span>
<a href="#l47.565"></a><span id="l47.565" class="difflineminus">-    // ### this does later stuff (marks latered messages unread), which may be a problem</span>
<a href="#l47.566"></a><span id="l47.566" class="difflineminus">-    nsCString summaryNativePath;</span>
<a href="#l47.567"></a><span id="l47.567" class="difflineminus">-    summaryPath-&gt;GetNativePath(summaryNativePath);</span>
<a href="#l47.568"></a><span id="l47.568" class="difflineminus">-    err = pMessageDB-&gt;OpenMDB(summaryNativePath.get(), PR_FALSE, PR_TRUE);</span>
<a href="#l47.569"></a><span id="l47.569" class="difflineminus">-    if (err != NS_OK)</span>
<a href="#l47.570"></a><span id="l47.570" class="difflineminus">-    {</span>
<a href="#l47.571"></a><span id="l47.571" class="difflineminus">-      delete pMessageDB;</span>
<a href="#l47.572"></a><span id="l47.572" class="difflineminus">-      pMessageDB = nsnull;</span>
<a href="#l47.573"></a><span id="l47.573" class="difflineminus">-    }</span>
<a href="#l47.574"></a><span id="l47.574" class="difflineminus">-    bOpenedDB = PR_TRUE;</span>
<a href="#l47.575"></a><span id="l47.575" class="difflineminus">-  }</span>
<a href="#l47.576"></a><span id="l47.576" class="difflineminus">-</span>
<a href="#l47.577"></a><span id="l47.577" class="difflineminus">-  if (!pMessageDB)</span>
<a href="#l47.578"></a><span id="l47.578" class="difflineminus">-  {</span>
<a href="#l47.579"></a><span id="l47.579" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l47.580"></a><span id="l47.580" class="difflineminus">-    printf(&quot;Exception opening summary file\n&quot;);</span>
<a href="#l47.581"></a><span id="l47.581" class="difflineminus">-#endif</span>
<a href="#l47.582"></a><span id="l47.582" class="difflineminus">-    return NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l47.583"></a><span id="l47.583" class="difflineminus">-  }</span>
<a href="#l47.584"></a><span id="l47.584" class="difflineminus">-</span>
<a href="#l47.585"></a><span id="l47.585" class="difflineminus">-  {</span>
<a href="#l47.586"></a><span id="l47.586" class="difflineminus">-    pMessageDB-&gt;m_folderFile = folderName;</span>
<a href="#l47.587"></a><span id="l47.587" class="difflineminus">-    PRUint32 actualFolderTimeStamp;</span>
<a href="#l47.588"></a><span id="l47.588" class="difflineminus">-    PRInt64 fileSize;</span>
<a href="#l47.589"></a><span id="l47.589" class="difflineminus">-    pMessageDB-&gt;GetMailboxModProperties(&amp;fileSize, &amp;actualFolderTimeStamp);</span>
<a href="#l47.590"></a><span id="l47.590" class="difflineminus">-    pMessageDB-&gt;m_dbFolderInfo-&gt;SetFolderSize((PRUint32) fileSize);</span>
<a href="#l47.591"></a><span id="l47.591" class="difflineminus">-    pMessageDB-&gt;m_dbFolderInfo-&gt;SetFolderDate(actualFolderTimeStamp);</span>
<a href="#l47.592"></a><span id="l47.592" class="difflineminus">-    pMessageDB-&gt;m_dbFolderInfo-&gt;ChangeNumUnreadMessages(numunread);</span>
<a href="#l47.593"></a><span id="l47.593" class="difflineminus">-    pMessageDB-&gt;m_dbFolderInfo-&gt;ChangeNumMessages(num);</span>
<a href="#l47.594"></a><span id="l47.594" class="difflineminus">-  }</span>
<a href="#l47.595"></a><span id="l47.595" class="difflineminus">-  // if we opened the db, then we'd better close it. Otherwise, we found it in the cache,</span>
<a href="#l47.596"></a><span id="l47.596" class="difflineminus">-  // so just commit and release.</span>
<a href="#l47.597"></a><span id="l47.597" class="difflineminus">-  if (bOpenedDB)</span>
<a href="#l47.598"></a><span id="l47.598" class="difflineminus">-  {</span>
<a href="#l47.599"></a><span id="l47.599" class="difflineminus">-    pMessageDB-&gt;Close(PR_TRUE);</span>
<a href="#l47.600"></a><span id="l47.600" class="difflineminus">-  }</span>
<a href="#l47.601"></a><span id="l47.601" class="difflineminus">-  else if (pMessageDB)</span>
<a href="#l47.602"></a><span id="l47.602" class="difflineminus">-  { </span>
<a href="#l47.603"></a><span id="l47.603" class="difflineminus">-    err = pMessageDB-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l47.604"></a><span id="l47.604" class="difflineminus">-    pMessageDB-&gt;Release();</span>
<a href="#l47.605"></a><span id="l47.605" class="difflineminus">-  }</span>
<a href="#l47.606"></a><span id="l47.606" class="difflineminus">-  return err;</span>
<a href="#l47.607"></a><span id="l47.607" class="difflineminus">-}</span>
<a href="#l47.608"></a><span id="l47.608" class="difflineminus">-</span>
<a href="#l47.609"></a><span id="l47.609" class="difflineminus">-</span>
<a href="#l47.610"></a><span id="l47.610"> // This is used to remember that the db is out of sync with the mail folder</span>
<a href="#l47.611"></a><span id="l47.611"> // and needs to be regenerated.</span>
<a href="#l47.612"></a><span id="l47.612"> void nsMailDatabase::SetReparse(bool reparse)</span>
<a href="#l47.613"></a><span id="l47.613"> {</span>
<a href="#l47.614"></a><span id="l47.614">   m_reparse = reparse;</span>
<a href="#l47.615"></a><span id="l47.615"> }</span>
<a href="#l47.616"></a><span id="l47.616"> </span>
<a href="#l47.617"></a><span id="l47.617" class="difflineminus">-</span>
<a href="#l47.618"></a><span id="l47.618"> class nsMsgOfflineOpEnumerator : public nsISimpleEnumerator {</span>
<a href="#l47.619"></a><span id="l47.619"> public:</span>
<a href="#l47.620"></a><span id="l47.620">   NS_DECL_ISUPPORTS</span>
<a href="#l47.621"></a><span id="l47.621"> </span>
<a href="#l47.622"></a><span id="l47.622">   // nsISimpleEnumerator methods:</span>
<a href="#l47.623"></a><span id="l47.623">   NS_DECL_NSISIMPLEENUMERATOR</span>
<a href="#l47.624"></a><span id="l47.624"> </span>
<a href="#l47.625"></a><span id="l47.625">   nsMsgOfflineOpEnumerator(nsMailDatabase* db);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l48.1"></a><span id="l48.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l48.2"></a><span id="l48.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgDatabase.cpp</span>
<a href="#l48.3"></a><span id="l48.3" class="difflineat">@@ -41,17 +41,17 @@</span>
<a href="#l48.4"></a><span id="l48.4"> </span>
<a href="#l48.5"></a><span id="l48.5"> #ifdef MOZ_LOGGING</span>
<a href="#l48.6"></a><span id="l48.6"> #define FORCE_PR_LOG /* Allow logging in the release build */</span>
<a href="#l48.7"></a><span id="l48.7"> #endif</span>
<a href="#l48.8"></a><span id="l48.8"> #include &lt;sys/stat.h&gt;</span>
<a href="#l48.9"></a><span id="l48.9"> </span>
<a href="#l48.10"></a><span id="l48.10"> #include &quot;nscore.h&quot;</span>
<a href="#l48.11"></a><span id="l48.11"> #include &quot;msgCore.h&quot;</span>
<a href="#l48.12"></a><span id="l48.12" class="difflineminus">-#include &quot;nsMsgDatabase.h&quot;</span>
<a href="#l48.13"></a><span id="l48.13" class="difflineplus">+#include &quot;nsMailDatabase.h&quot;</span>
<a href="#l48.14"></a><span id="l48.14"> #include &quot;nsDBFolderInfo.h&quot;</span>
<a href="#l48.15"></a><span id="l48.15"> #include &quot;nsMsgKeySet.h&quot;</span>
<a href="#l48.16"></a><span id="l48.16"> #include &quot;nsIEnumerator.h&quot;</span>
<a href="#l48.17"></a><span id="l48.17"> #include &quot;nsMsgThread.h&quot;</span>
<a href="#l48.18"></a><span id="l48.18"> #include &quot;nsIMsgSearchTerm.h&quot;</span>
<a href="#l48.19"></a><span id="l48.19"> #include &quot;nsIMsgHeaderParser.h&quot;</span>
<a href="#l48.20"></a><span id="l48.20"> #include &quot;nsMsgBaseCID.h&quot;</span>
<a href="#l48.21"></a><span id="l48.21"> #include &quot;nsMorkCID.h&quot;</span>
<a href="#l48.22"></a><span id="l48.22" class="difflineat">@@ -73,16 +73,17 @@</span>
<a href="#l48.23"></a><span id="l48.23"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l48.24"></a><span id="l48.24"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l48.25"></a><span id="l48.25"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l48.26"></a><span id="l48.26"> #include &quot;nsMemory.h&quot;</span>
<a href="#l48.27"></a><span id="l48.27"> #include &quot;nsICollation.h&quot;</span>
<a href="#l48.28"></a><span id="l48.28"> #include &quot;nsCollationCID.h&quot;</span>
<a href="#l48.29"></a><span id="l48.29"> #include &quot;nsIPrefService.h&quot;</span>
<a href="#l48.30"></a><span id="l48.30"> #include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l48.31"></a><span id="l48.31" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l48.32"></a><span id="l48.32"> #include &quot;nsAlgorithm.h&quot;</span>
<a href="#l48.33"></a><span id="l48.33"> </span>
<a href="#l48.34"></a><span id="l48.34"> #if defined(DEBUG_sspitzer_) || defined(DEBUG_seth_)</span>
<a href="#l48.35"></a><span id="l48.35"> #define DEBUG_MSGKEYSET 1</span>
<a href="#l48.36"></a><span id="l48.36"> #endif</span>
<a href="#l48.37"></a><span id="l48.37"> </span>
<a href="#l48.38"></a><span id="l48.38"> #define MSG_HASH_SIZE 512</span>
<a href="#l48.39"></a><span id="l48.39"> </span>
<a href="#l48.40"></a><span id="l48.40" class="difflineat">@@ -115,52 +116,56 @@ nsMsgDBService::~nsMsgDBService()</span>
<a href="#l48.41"></a><span id="l48.41"> {</span>
<a href="#l48.42"></a><span id="l48.42"> }</span>
<a href="#l48.43"></a><span id="l48.43"> </span>
<a href="#l48.44"></a><span id="l48.44"> NS_IMETHODIMP nsMsgDBService::OpenFolderDB(nsIMsgFolder *aFolder,</span>
<a href="#l48.45"></a><span id="l48.45">                                            bool aLeaveInvalidDB,</span>
<a href="#l48.46"></a><span id="l48.46">                                            nsIMsgDatabase **_retval)</span>
<a href="#l48.47"></a><span id="l48.47"> {</span>
<a href="#l48.48"></a><span id="l48.48">   NS_ENSURE_ARG(aFolder);</span>
<a href="#l48.49"></a><span id="l48.49" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; folderPath;</span>
<a href="#l48.50"></a><span id="l48.50" class="difflineminus">-  nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l48.51"></a><span id="l48.51" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l48.52"></a><span id="l48.52" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l48.53"></a><span id="l48.53" class="difflineplus">+  nsCOMPtr &lt;nsILocalFile&gt; summaryFilePath;</span>
<a href="#l48.54"></a><span id="l48.54" class="difflineplus">+</span>
<a href="#l48.55"></a><span id="l48.55" class="difflineplus">+  nsresult rv = aFolder-&gt;GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l48.56"></a><span id="l48.56">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.57"></a><span id="l48.57" class="difflineminus">-  nsMsgDatabase *cacheDB = (nsMsgDatabase *) nsMsgDatabase::FindInCache(aFolder);</span>
<a href="#l48.58"></a><span id="l48.58" class="difflineplus">+  rv = aFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l48.59"></a><span id="l48.59" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.60"></a><span id="l48.60" class="difflineplus">+  rv = msgStore-&gt;GetSummaryFile(aFolder, getter_AddRefs(summaryFilePath));</span>
<a href="#l48.61"></a><span id="l48.61" class="difflineplus">+</span>
<a href="#l48.62"></a><span id="l48.62" class="difflineplus">+  nsMsgDatabase *cacheDB = nsMsgDatabase::FindInCache(summaryFilePath);</span>
<a href="#l48.63"></a><span id="l48.63">   if (cacheDB)</span>
<a href="#l48.64"></a><span id="l48.64">   {</span>
<a href="#l48.65"></a><span id="l48.65">     // this db could have ended up in the folder cache w/o an m_folder pointer via</span>
<a href="#l48.66"></a><span id="l48.66">     // OpenMailDBFromFile. If so, take this chance to fix the folder.</span>
<a href="#l48.67"></a><span id="l48.67">     if (!cacheDB-&gt;m_folder)</span>
<a href="#l48.68"></a><span id="l48.68">       cacheDB-&gt;m_folder = aFolder;</span>
<a href="#l48.69"></a><span id="l48.69">     *_retval = cacheDB; // FindInCache already addRefed.</span>
<a href="#l48.70"></a><span id="l48.70">     // if m_thumb is set, someone is asynchronously opening the db. But our</span>
<a href="#l48.71"></a><span id="l48.71">     // caller wants to synchronously open it, so just do it.</span>
<a href="#l48.72"></a><span id="l48.72">     if (cacheDB-&gt;m_thumb)</span>
<a href="#l48.73"></a><span id="l48.73" class="difflineminus">-      return cacheDB-&gt;Open(folderPath, PR_FALSE, aLeaveInvalidDB);</span>
<a href="#l48.74"></a><span id="l48.74" class="difflineplus">+      return cacheDB-&gt;Open(summaryFilePath, PR_FALSE, aLeaveInvalidDB);</span>
<a href="#l48.75"></a><span id="l48.75">     return NS_OK;</span>
<a href="#l48.76"></a><span id="l48.76">   }</span>
<a href="#l48.77"></a><span id="l48.77"> </span>
<a href="#l48.78"></a><span id="l48.78" class="difflineminus">-  nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l48.79"></a><span id="l48.79" class="difflineminus">-  rv = aFolder-&gt;GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l48.80"></a><span id="l48.80" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.81"></a><span id="l48.81">   nsCString localStoreType;</span>
<a href="#l48.82"></a><span id="l48.82">   incomingServer-&gt;GetLocalStoreType(localStoreType);</span>
<a href="#l48.83"></a><span id="l48.83">   nsCAutoString dbContractID(NS_MSGDB_CONTRACTID);</span>
<a href="#l48.84"></a><span id="l48.84">   dbContractID.Append(localStoreType.get());</span>
<a href="#l48.85"></a><span id="l48.85">   nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB = do_CreateInstance(dbContractID.get(), &amp;rv);</span>
<a href="#l48.86"></a><span id="l48.86">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.87"></a><span id="l48.87"> </span>
<a href="#l48.88"></a><span id="l48.88">   // Don't try to create the database yet--let the createNewDB call do that.</span>
<a href="#l48.89"></a><span id="l48.89" class="difflineminus">-  rv = msgDB-&gt;Open(folderPath, PR_FALSE, aLeaveInvalidDB);</span>
<a href="#l48.90"></a><span id="l48.90" class="difflineplus">+  nsMsgDatabase *msgDatabase = static_cast&lt;nsMsgDatabase *&gt;(msgDB.get());</span>
<a href="#l48.91"></a><span id="l48.91" class="difflineplus">+  msgDatabase-&gt;m_folder = aFolder;</span>
<a href="#l48.92"></a><span id="l48.92" class="difflineplus">+  rv = msgDatabase-&gt;Open(summaryFilePath, PR_FALSE, aLeaveInvalidDB);</span>
<a href="#l48.93"></a><span id="l48.93">   if (NS_FAILED(rv) &amp;&amp; rv != NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l48.94"></a><span id="l48.94">     return rv;</span>
<a href="#l48.95"></a><span id="l48.95"> </span>
<a href="#l48.96"></a><span id="l48.96">   NS_ADDREF(*_retval = msgDB);</span>
<a href="#l48.97"></a><span id="l48.97" class="difflineminus">-  nsMsgDatabase *msgDatabase = static_cast&lt;nsMsgDatabase *&gt;(*_retval);</span>
<a href="#l48.98"></a><span id="l48.98" class="difflineminus">-  msgDatabase-&gt;m_folder = aFolder;</span>
<a href="#l48.99"></a><span id="l48.99"> </span>
<a href="#l48.100"></a><span id="l48.100">   if (NS_FAILED(rv))</span>
<a href="#l48.101"></a><span id="l48.101">   {</span>
<a href="#l48.102"></a><span id="l48.102"> #ifdef DEBUG</span>
<a href="#l48.103"></a><span id="l48.103">     // Doing these checks for debug only as we don't want to report certain</span>
<a href="#l48.104"></a><span id="l48.104">     // errors in debug mode, but in release mode we wouldn't report them either</span>
<a href="#l48.105"></a><span id="l48.105"> </span>
<a href="#l48.106"></a><span id="l48.106">     // These errors are expected.</span>
<a href="#l48.107"></a><span id="l48.107" class="difflineat">@@ -179,43 +184,47 @@ NS_IMETHODIMP nsMsgDBService::OpenFolder</span>
<a href="#l48.108"></a><span id="l48.108"> }</span>
<a href="#l48.109"></a><span id="l48.109"> </span>
<a href="#l48.110"></a><span id="l48.110"> NS_IMETHODIMP nsMsgDBService::AsyncOpenFolderDB(nsIMsgFolder *aFolder,</span>
<a href="#l48.111"></a><span id="l48.111">                                                 bool aLeaveInvalidDB,</span>
<a href="#l48.112"></a><span id="l48.112">                                                 nsIMsgDatabase **_retval)</span>
<a href="#l48.113"></a><span id="l48.113"> {</span>
<a href="#l48.114"></a><span id="l48.114">   NS_ENSURE_ARG(aFolder);</span>
<a href="#l48.115"></a><span id="l48.115">   nsMsgDatabase *cacheDB = (nsMsgDatabase *) nsMsgDatabase::FindInCache(aFolder);</span>
<a href="#l48.116"></a><span id="l48.116" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; folderPath;</span>
<a href="#l48.117"></a><span id="l48.117" class="difflineminus">-  nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l48.118"></a><span id="l48.118" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.119"></a><span id="l48.119">   if (cacheDB)</span>
<a href="#l48.120"></a><span id="l48.120">   {</span>
<a href="#l48.121"></a><span id="l48.121">     // this db could have ended up in the folder cache w/o an m_folder pointer via</span>
<a href="#l48.122"></a><span id="l48.122">     // OpenMailDBFromFile. If so, take this chance to fix the folder.</span>
<a href="#l48.123"></a><span id="l48.123">     if (!cacheDB-&gt;m_folder)</span>
<a href="#l48.124"></a><span id="l48.124">       cacheDB-&gt;m_folder = aFolder;</span>
<a href="#l48.125"></a><span id="l48.125">     *_retval = cacheDB; // FindInCache already addRefed.</span>
<a href="#l48.126"></a><span id="l48.126">     // We don't care if an other consumer is thumbing the store. In that</span>
<a href="#l48.127"></a><span id="l48.127">     // case, they'll both thumb the store.</span>
<a href="#l48.128"></a><span id="l48.128">     return NS_OK;</span>
<a href="#l48.129"></a><span id="l48.129">   }</span>
<a href="#l48.130"></a><span id="l48.130"> </span>
<a href="#l48.131"></a><span id="l48.131" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l48.132"></a><span id="l48.132" class="difflineplus">+  nsresult rv = aFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l48.133"></a><span id="l48.133" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.134"></a><span id="l48.134" class="difflineplus">+  nsCOMPtr &lt;nsILocalFile&gt; summaryFilePath;</span>
<a href="#l48.135"></a><span id="l48.135" class="difflineplus">+  rv = msgStore-&gt;GetSummaryFile(aFolder, getter_AddRefs(summaryFilePath));</span>
<a href="#l48.136"></a><span id="l48.136" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.137"></a><span id="l48.137" class="difflineplus">+</span>
<a href="#l48.138"></a><span id="l48.138">   nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l48.139"></a><span id="l48.139">   rv = aFolder-&gt;GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l48.140"></a><span id="l48.140">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.141"></a><span id="l48.141">   nsCString localStoreType;</span>
<a href="#l48.142"></a><span id="l48.142">   incomingServer-&gt;GetLocalStoreType(localStoreType);</span>
<a href="#l48.143"></a><span id="l48.143">   nsCAutoString dbContractID(NS_MSGDB_CONTRACTID);</span>
<a href="#l48.144"></a><span id="l48.144">   dbContractID.Append(localStoreType.get());</span>
<a href="#l48.145"></a><span id="l48.145">   nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB = do_CreateInstance(dbContractID.get(), &amp;rv);</span>
<a href="#l48.146"></a><span id="l48.146">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.147"></a><span id="l48.147"> </span>
<a href="#l48.148"></a><span id="l48.148">   nsMsgDatabase *msgDatabase = static_cast&lt;nsMsgDatabase *&gt;(msgDB.get());</span>
<a href="#l48.149"></a><span id="l48.149" class="difflineminus">-  rv = msgDatabase-&gt;OpenInternal(folderPath, PR_FALSE, aLeaveInvalidDB,</span>
<a href="#l48.150"></a><span id="l48.150" class="difflineplus">+  rv = msgDatabase-&gt;OpenInternal(summaryFilePath, PR_FALSE, aLeaveInvalidDB,</span>
<a href="#l48.151"></a><span id="l48.151">                                  PR_FALSE /* open asynchronously */);</span>
<a href="#l48.152"></a><span id="l48.152"> </span>
<a href="#l48.153"></a><span id="l48.153">   NS_ADDREF(*_retval = msgDB);</span>
<a href="#l48.154"></a><span id="l48.154">   msgDatabase-&gt;m_folder = aFolder;</span>
<a href="#l48.155"></a><span id="l48.155"> </span>
<a href="#l48.156"></a><span id="l48.156">   if (NS_FAILED(rv))</span>
<a href="#l48.157"></a><span id="l48.157">   {</span>
<a href="#l48.158"></a><span id="l48.158"> #ifdef DEBUG</span>
<a href="#l48.159"></a><span id="l48.159" class="difflineat">@@ -274,17 +283,17 @@ NS_IMETHODIMP nsMsgDBService::OpenMore(n</span>
<a href="#l48.160"></a><span id="l48.160">       nsCOMPtr&lt;nsILocalFile&gt; folderPath;</span>
<a href="#l48.161"></a><span id="l48.161">       nsresult rv = msgDatabase-&gt;m_folder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l48.162"></a><span id="l48.162">       nsCOMPtr &lt;nsILocalFile&gt; summaryFile;</span>
<a href="#l48.163"></a><span id="l48.163">       rv = GetSummaryFileLocation(folderPath, getter_AddRefs(summaryFile));</span>
<a href="#l48.164"></a><span id="l48.164"> </span>
<a href="#l48.165"></a><span id="l48.165">       if (NS_SUCCEEDED(ret))</span>
<a href="#l48.166"></a><span id="l48.166">         ret = (msgDatabase-&gt;m_mdbStore) ? msgDatabase-&gt;InitExistingDB() : NS_ERROR_FAILURE;</span>
<a href="#l48.167"></a><span id="l48.167">       if (NS_SUCCEEDED(ret))</span>
<a href="#l48.168"></a><span id="l48.168" class="difflineminus">-        ret = msgDatabase-&gt;CheckForErrors(ret, summaryFile);</span>
<a href="#l48.169"></a><span id="l48.169" class="difflineplus">+        ret = msgDatabase-&gt;CheckForErrors(ret, PR_FALSE, summaryFile);</span>
<a href="#l48.170"></a><span id="l48.170"> </span>
<a href="#l48.171"></a><span id="l48.171">       FinishDBOpen(msgDatabase-&gt;m_folder, msgDatabase);</span>
<a href="#l48.172"></a><span id="l48.172">       break;</span>
<a href="#l48.173"></a><span id="l48.173">     }</span>
<a href="#l48.174"></a><span id="l48.174">   }</span>
<a href="#l48.175"></a><span id="l48.175">   while (PR_IntervalToMilliseconds(PR_IntervalNow() - startTime) &lt;= aTimeHint);</span>
<a href="#l48.176"></a><span id="l48.176">   *_retval = !msgDatabase-&gt;m_thumb;</span>
<a href="#l48.177"></a><span id="l48.177">   return ret;</span>
<a href="#l48.178"></a><span id="l48.178" class="difflineat">@@ -327,67 +336,77 @@ void nsMsgDBService::FinishDBOpen(nsIMsg</span>
<a href="#l48.179"></a><span id="l48.179">   }</span>
<a href="#l48.180"></a><span id="l48.180">   HookupPendingListeners(aMsgDB, aFolder);</span>
<a href="#l48.181"></a><span id="l48.181"> }</span>
<a href="#l48.182"></a><span id="l48.182"> </span>
<a href="#l48.183"></a><span id="l48.183"> // This method is called when the caller is trying to create a db without</span>
<a href="#l48.184"></a><span id="l48.184"> // having a corresponding nsIMsgFolder object.  This happens in a few</span>
<a href="#l48.185"></a><span id="l48.185"> // situations, including imap folder discovery, compacting local folders,</span>
<a href="#l48.186"></a><span id="l48.186"> // and copying local folders.</span>
<a href="#l48.187"></a><span id="l48.187" class="difflineminus">-NS_IMETHODIMP nsMsgDBService::OpenMailDBFromFile(nsILocalFile *aFolderName, bool aCreate, bool aLeaveInvalidDB, nsIMsgDatabase** pMessageDB)</span>
<a href="#l48.188"></a><span id="l48.188" class="difflineplus">+NS_IMETHODIMP nsMsgDBService::OpenMailDBFromFile(nsILocalFile *aFolderName,</span>
<a href="#l48.189"></a><span id="l48.189" class="difflineplus">+                                                 nsIMsgFolder *aFolder,</span>
<a href="#l48.190"></a><span id="l48.190" class="difflineplus">+                                                 bool aCreate,</span>
<a href="#l48.191"></a><span id="l48.191" class="difflineplus">+                                                 bool aLeaveInvalidDB,</span>
<a href="#l48.192"></a><span id="l48.192" class="difflineplus">+                                                 nsIMsgDatabase** pMessageDB)</span>
<a href="#l48.193"></a><span id="l48.193"> {</span>
<a href="#l48.194"></a><span id="l48.194">   if (!aFolderName)</span>
<a href="#l48.195"></a><span id="l48.195">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l48.196"></a><span id="l48.196"> </span>
<a href="#l48.197"></a><span id="l48.197">   nsCOMPtr &lt;nsILocalFile&gt;  dbPath;</span>
<a href="#l48.198"></a><span id="l48.198">   nsresult rv = GetSummaryFileLocation(aFolderName, getter_AddRefs(dbPath));</span>
<a href="#l48.199"></a><span id="l48.199">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.200"></a><span id="l48.200"> </span>
<a href="#l48.201"></a><span id="l48.201">   *pMessageDB = (nsMsgDatabase *) nsMsgDatabase::FindInCache(dbPath);</span>
<a href="#l48.202"></a><span id="l48.202">   if (*pMessageDB)</span>
<a href="#l48.203"></a><span id="l48.203">     return NS_OK;</span>
<a href="#l48.204"></a><span id="l48.204"> </span>
<a href="#l48.205"></a><span id="l48.205" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB = do_CreateInstance(NS_MAILBOXDB_CONTRACTID, &amp;rv);</span>
<a href="#l48.206"></a><span id="l48.206" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.207"></a><span id="l48.207" class="difflineminus">-  rv = msgDB-&gt;Open(aFolderName, aCreate, aLeaveInvalidDB);</span>
<a href="#l48.208"></a><span id="l48.208" class="difflineplus">+  nsRefPtr&lt;nsMailDatabase&gt; msgDB = new nsMailDatabase;</span>
<a href="#l48.209"></a><span id="l48.209" class="difflineplus">+  NS_ENSURE_TRUE(msgDB, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l48.210"></a><span id="l48.210" class="difflineplus">+  rv = msgDB-&gt;Open(dbPath, aCreate, aLeaveInvalidDB);</span>
<a href="#l48.211"></a><span id="l48.211">   if (rv == NS_ERROR_FILE_TARGET_DOES_NOT_EXIST)</span>
<a href="#l48.212"></a><span id="l48.212">     return rv;</span>
<a href="#l48.213"></a><span id="l48.213">   NS_IF_ADDREF(*pMessageDB = msgDB);</span>
<a href="#l48.214"></a><span id="l48.214">   if (aCreate &amp;&amp; msgDB &amp;&amp; rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l48.215"></a><span id="l48.215">     rv = NS_OK;</span>
<a href="#l48.216"></a><span id="l48.216" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l48.217"></a><span id="l48.217" class="difflineplus">+    msgDB-&gt;m_folder = aFolder;</span>
<a href="#l48.218"></a><span id="l48.218">   return rv;</span>
<a href="#l48.219"></a><span id="l48.219"> }</span>
<a href="#l48.220"></a><span id="l48.220"> </span>
<a href="#l48.221"></a><span id="l48.221"> NS_IMETHODIMP nsMsgDBService::CreateNewDB(nsIMsgFolder *aFolder,</span>
<a href="#l48.222"></a><span id="l48.222">                                           nsIMsgDatabase **_retval)</span>
<a href="#l48.223"></a><span id="l48.223"> {</span>
<a href="#l48.224"></a><span id="l48.224">   NS_ENSURE_ARG(aFolder);</span>
<a href="#l48.225"></a><span id="l48.225">   </span>
<a href="#l48.226"></a><span id="l48.226">   nsCOMPtr &lt;nsIMsgIncomingServer&gt; incomingServer;</span>
<a href="#l48.227"></a><span id="l48.227">   nsresult rv = aFolder-&gt;GetServer(getter_AddRefs(incomingServer));</span>
<a href="#l48.228"></a><span id="l48.228">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.229"></a><span id="l48.229"> </span>
<a href="#l48.230"></a><span id="l48.230" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l48.231"></a><span id="l48.231" class="difflineplus">+  rv = aFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l48.232"></a><span id="l48.232" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.233"></a><span id="l48.233" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; summaryFilePath;</span>
<a href="#l48.234"></a><span id="l48.234" class="difflineplus">+  rv = msgStore-&gt;GetSummaryFile(aFolder, getter_AddRefs(summaryFilePath));</span>
<a href="#l48.235"></a><span id="l48.235" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.236"></a><span id="l48.236" class="difflineplus">+</span>
<a href="#l48.237"></a><span id="l48.237">   nsCString localStoreType;</span>
<a href="#l48.238"></a><span id="l48.238">   incomingServer-&gt;GetLocalStoreType(localStoreType);</span>
<a href="#l48.239"></a><span id="l48.239">   nsCAutoString dbContractID(NS_MSGDB_CONTRACTID);</span>
<a href="#l48.240"></a><span id="l48.240">   dbContractID.Append(localStoreType.get());</span>
<a href="#l48.241"></a><span id="l48.241">   </span>
<a href="#l48.242"></a><span id="l48.242">   nsCOMPtr &lt;nsIMsgDatabase&gt; msgDB = do_CreateInstance(dbContractID.get(), &amp;rv);</span>
<a href="#l48.243"></a><span id="l48.243">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.244"></a><span id="l48.244"> </span>
<a href="#l48.245"></a><span id="l48.245" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; folderPath;</span>
<a href="#l48.246"></a><span id="l48.246" class="difflineminus">-  rv = aFolder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l48.247"></a><span id="l48.247" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l48.248"></a><span id="l48.248" class="difflineminus">-</span>
<a href="#l48.249"></a><span id="l48.249" class="difflineminus">-  rv = msgDB-&gt;Open(folderPath, PR_TRUE, PR_TRUE);</span>
<a href="#l48.250"></a><span id="l48.250" class="difflineplus">+  nsMsgDatabase *msgDatabase = static_cast&lt;nsMsgDatabase *&gt;(msgDB.get());</span>
<a href="#l48.251"></a><span id="l48.251" class="difflineplus">+</span>
<a href="#l48.252"></a><span id="l48.252" class="difflineplus">+  msgDatabase-&gt;m_folder = aFolder;</span>
<a href="#l48.253"></a><span id="l48.253" class="difflineplus">+  rv = msgDatabase-&gt;Open(summaryFilePath, PR_TRUE, PR_TRUE);</span>
<a href="#l48.254"></a><span id="l48.254">   NS_ENSURE_TRUE(rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING, rv);</span>
<a href="#l48.255"></a><span id="l48.255"> </span>
<a href="#l48.256"></a><span id="l48.256">   NS_ADDREF(*_retval = msgDB);</span>
<a href="#l48.257"></a><span id="l48.257" class="difflineminus">-  nsMsgDatabase *msgDatabase = static_cast&lt;nsMsgDatabase *&gt;(*_retval);</span>
<a href="#l48.258"></a><span id="l48.258" class="difflineminus">-  msgDatabase-&gt;m_folder = aFolder;</span>
<a href="#l48.259"></a><span id="l48.259"> </span>
<a href="#l48.260"></a><span id="l48.260">   HookupPendingListeners(msgDB, aFolder);</span>
<a href="#l48.261"></a><span id="l48.261"> </span>
<a href="#l48.262"></a><span id="l48.262">   return NS_OK;</span>
<a href="#l48.263"></a><span id="l48.263"> }</span>
<a href="#l48.264"></a><span id="l48.264"> </span>
<a href="#l48.265"></a><span id="l48.265"> /* void registerPendingListener (in nsIMsgFolder aFolder, in nsIDBChangeListener aListener); */</span>
<a href="#l48.266"></a><span id="l48.266"> NS_IMETHODIMP nsMsgDBService::RegisterPendingListener(nsIMsgFolder *aFolder, nsIDBChangeListener *aListener)</span>
<a href="#l48.267"></a><span id="l48.267" class="difflineat">@@ -487,17 +506,17 @@ nsresult nsMsgDatabase::AddHdrToCache(ns</span>
<a href="#l48.268"></a><span id="l48.268"> </span>
<a href="#l48.269"></a><span id="l48.269">   MsgHdrHashElement* element = reinterpret_cast&lt;MsgHdrHashElement*&gt;(hdr);</span>
<a href="#l48.270"></a><span id="l48.270">   if (element &amp;&amp; element-&gt;mHdr)</span>
<a href="#l48.271"></a><span id="l48.271">   {</span>
<a href="#l48.272"></a><span id="l48.272">     nsMsgHdr* msgHdr = static_cast&lt;nsMsgHdr*&gt;(element-&gt;mHdr);  // closed system, so this is ok</span>
<a href="#l48.273"></a><span id="l48.273">     // clear out m_mdbRow member variable - the db is going away, which means that this member</span>
<a href="#l48.274"></a><span id="l48.274">     // variable might very well point to a mork db that is gone.</span>
<a href="#l48.275"></a><span id="l48.275">     NS_IF_RELEASE(msgHdr-&gt;m_mdbRow);</span>
<a href="#l48.276"></a><span id="l48.276" class="difflineminus">-    msgHdr-&gt;m_mdbRow = nsnull;</span>
<a href="#l48.277"></a><span id="l48.277" class="difflineplus">+//    NS_IF_RELEASE(msgHdr-&gt;m_mdb);</span>
<a href="#l48.278"></a><span id="l48.278">   }</span>
<a href="#l48.279"></a><span id="l48.279">   return PL_DHASH_NEXT;</span>
<a href="#l48.280"></a><span id="l48.280"> }</span>
<a href="#l48.281"></a><span id="l48.281"> </span>
<a href="#l48.282"></a><span id="l48.282"> </span>
<a href="#l48.283"></a><span id="l48.283"> NS_IMETHODIMP nsMsgDatabase::SetMsgHdrCacheSize(PRUint32 aSize)</span>
<a href="#l48.284"></a><span id="l48.284"> {</span>
<a href="#l48.285"></a><span id="l48.285">   m_cacheSize = aSize;</span>
<a href="#l48.286"></a><span id="l48.286" class="difflineat">@@ -1017,16 +1036,17 @@ nsMsgDatabase::nsMsgDatabase()</span>
<a href="#l48.287"></a><span id="l48.287">         m_HeaderParser(nsnull),</span>
<a href="#l48.288"></a><span id="l48.288">         m_headersInUse(nsnull),</span>
<a href="#l48.289"></a><span id="l48.289">         m_cachedHeaders(nsnull),</span>
<a href="#l48.290"></a><span id="l48.290">         m_bCacheHeaders(PR_TRUE),</span>
<a href="#l48.291"></a><span id="l48.291">         m_cachedThreadId(nsMsgKey_None),</span>
<a href="#l48.292"></a><span id="l48.292">         m_msgReferences(nsnull),</span>
<a href="#l48.293"></a><span id="l48.293">         m_cacheSize(kMaxHdrsInCache)</span>
<a href="#l48.294"></a><span id="l48.294"> {</span>
<a href="#l48.295"></a><span id="l48.295" class="difflineplus">+  static int dbCount = 0;</span>
<a href="#l48.296"></a><span id="l48.296"> }</span>
<a href="#l48.297"></a><span id="l48.297"> </span>
<a href="#l48.298"></a><span id="l48.298"> nsMsgDatabase::~nsMsgDatabase()</span>
<a href="#l48.299"></a><span id="l48.299"> {</span>
<a href="#l48.300"></a><span id="l48.300">   //  Close(FALSE);  // better have already been closed.</span>
<a href="#l48.301"></a><span id="l48.301">   ClearCachedObjects(PR_TRUE);</span>
<a href="#l48.302"></a><span id="l48.302">   ClearEnumerators();</span>
<a href="#l48.303"></a><span id="l48.303">   delete m_cachedHeaders;</span>
<a href="#l48.304"></a><span id="l48.304" class="difflineat">@@ -1098,64 +1118,58 @@ void nsMsgDatabase::GetMDBFactory(nsIMdb</span>
<a href="#l48.305"></a><span id="l48.305">     nsCOMPtr &lt;nsIMdbFactoryService&gt; mdbFactoryService = do_GetService(NS_MORK_CONTRACTID, &amp;rv);</span>
<a href="#l48.306"></a><span id="l48.306">     if (NS_SUCCEEDED(rv) &amp;&amp; mdbFactoryService)</span>
<a href="#l48.307"></a><span id="l48.307">       mdbFactoryService-&gt;GetMdbFactory(getter_AddRefs(mMdbFactory));</span>
<a href="#l48.308"></a><span id="l48.308">   }</span>
<a href="#l48.309"></a><span id="l48.309">   NS_IF_ADDREF(*aMdbFactory = mMdbFactory);</span>
<a href="#l48.310"></a><span id="l48.310"> }</span>
<a href="#l48.311"></a><span id="l48.311"> </span>
<a href="#l48.312"></a><span id="l48.312"> // aLeaveInvalidDB: PR_TRUE if caller wants back a db even out of date.</span>
<a href="#l48.313"></a><span id="l48.313" class="difflineminus">-// If so, they'll extract out the interesting info from the db, close it, delete it, and</span>
<a href="#l48.314"></a><span id="l48.314" class="difflineminus">-// then try to open the db again, prior to reparsing.</span>
<a href="#l48.315"></a><span id="l48.315" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::Open(nsILocalFile *aFolderName, bool aCreate, bool aLeaveInvalidDB)</span>
<a href="#l48.316"></a><span id="l48.316" class="difflineplus">+// If so, they'll extract out the interesting info from the db, close it,</span>
<a href="#l48.317"></a><span id="l48.317" class="difflineplus">+// delete it, and then try to open the db again, prior to reparsing.</span>
<a href="#l48.318"></a><span id="l48.318" class="difflineplus">+nsresult nsMsgDatabase::Open(nsILocalFile *aFolderName, bool aCreate,</span>
<a href="#l48.319"></a><span id="l48.319" class="difflineplus">+                             bool aLeaveInvalidDB)</span>
<a href="#l48.320"></a><span id="l48.320"> {</span>
<a href="#l48.321"></a><span id="l48.321">   return nsMsgDatabase::OpenInternal(aFolderName, aCreate, aLeaveInvalidDB,</span>
<a href="#l48.322"></a><span id="l48.322">                                      PR_TRUE /* open synchronously */);</span>
<a href="#l48.323"></a><span id="l48.323"> }</span>
<a href="#l48.324"></a><span id="l48.324"> </span>
<a href="#l48.325"></a><span id="l48.325" class="difflineminus">-nsresult nsMsgDatabase::OpenInternal(nsILocalFile *aFolderName, bool aCreate,</span>
<a href="#l48.326"></a><span id="l48.326" class="difflineplus">+nsresult nsMsgDatabase::OpenInternal(nsILocalFile *summaryFile, bool aCreate,</span>
<a href="#l48.327"></a><span id="l48.327">                                      bool aLeaveInvalidDB, bool sync)</span>
<a href="#l48.328"></a><span id="l48.328"> {</span>
<a href="#l48.329"></a><span id="l48.329" class="difflineminus">-  if (!aFolderName)</span>
<a href="#l48.330"></a><span id="l48.330" class="difflineminus">-    return NS_ERROR_NULL_POINTER;</span>
<a href="#l48.331"></a><span id="l48.331" class="difflineminus">-</span>
<a href="#l48.332"></a><span id="l48.332" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; summaryFile;</span>
<a href="#l48.333"></a><span id="l48.333" class="difflineminus">-  nsresult err = GetSummaryFileLocation(aFolderName, getter_AddRefs(summaryFile));</span>
<a href="#l48.334"></a><span id="l48.334" class="difflineminus">-  NS_ENSURE_SUCCESS(err, err);</span>
<a href="#l48.335"></a><span id="l48.335" class="difflineminus">-</span>
<a href="#l48.336"></a><span id="l48.336">   nsCAutoString summaryFilePath;</span>
<a href="#l48.337"></a><span id="l48.337">   summaryFile-&gt;GetNativePath(summaryFilePath);</span>
<a href="#l48.338"></a><span id="l48.338"> </span>
<a href="#l48.339"></a><span id="l48.339">   PR_LOG(DBLog, PR_LOG_ALWAYS, (&quot;nsMsgDatabase::Open(%s, %s, %p, %s)\n&quot;,</span>
<a href="#l48.340"></a><span id="l48.340">     (const char*)summaryFilePath.get(), aCreate ? &quot;TRUE&quot;:&quot;FALSE&quot;,</span>
<a href="#l48.341"></a><span id="l48.341">     this, aLeaveInvalidDB ? &quot;TRUE&quot;:&quot;FALSE&quot;));</span>
<a href="#l48.342"></a><span id="l48.342"> </span>
<a href="#l48.343"></a><span id="l48.343"> </span>
<a href="#l48.344"></a><span id="l48.344" class="difflineminus">-  err = OpenMDB(summaryFilePath.get(), aCreate, sync);</span>
<a href="#l48.345"></a><span id="l48.345" class="difflineminus">-  if (NS_FAILED(err))</span>
<a href="#l48.346"></a><span id="l48.346" class="difflineminus">-    PR_LOG(DBLog, PR_LOG_ALWAYS, (&quot;error opening db %lx&quot;, err));</span>
<a href="#l48.347"></a><span id="l48.347" class="difflineplus">+  nsresult rv = OpenMDB(summaryFilePath.get(), aCreate, sync);</span>
<a href="#l48.348"></a><span id="l48.348" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l48.349"></a><span id="l48.349" class="difflineplus">+    PR_LOG(DBLog, PR_LOG_ALWAYS, (&quot;error opening db %lx&quot;, rv));</span>
<a href="#l48.350"></a><span id="l48.350"> </span>
<a href="#l48.351"></a><span id="l48.351">   if (PR_LOG_TEST(DBLog, PR_LOG_DEBUG))</span>
<a href="#l48.352"></a><span id="l48.352">     DumpCache();</span>
<a href="#l48.353"></a><span id="l48.353"> </span>
<a href="#l48.354"></a><span id="l48.354" class="difflineminus">-  if (err == NS_ERROR_FILE_TARGET_DOES_NOT_EXIST)</span>
<a href="#l48.355"></a><span id="l48.355" class="difflineminus">-    return err;</span>
<a href="#l48.356"></a><span id="l48.356" class="difflineplus">+  if (rv == NS_ERROR_FILE_TARGET_DOES_NOT_EXIST)</span>
<a href="#l48.357"></a><span id="l48.357" class="difflineplus">+    return rv;</span>
<a href="#l48.358"></a><span id="l48.358"> </span>
<a href="#l48.359"></a><span id="l48.359">   m_create = aCreate;</span>
<a href="#l48.360"></a><span id="l48.360">   m_leaveInvalidDB = aLeaveInvalidDB;</span>
<a href="#l48.361"></a><span id="l48.361" class="difflineminus">-  if (!sync &amp;&amp; NS_SUCCEEDED(err))</span>
<a href="#l48.362"></a><span id="l48.362" class="difflineplus">+  if (!sync &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l48.363"></a><span id="l48.363">   {</span>
<a href="#l48.364"></a><span id="l48.364">     AddToCache(this);</span>
<a href="#l48.365"></a><span id="l48.365">     // remember open options for when the parsing is complete.</span>
<a href="#l48.366"></a><span id="l48.366" class="difflineminus">-    return err;</span>
<a href="#l48.367"></a><span id="l48.367" class="difflineplus">+    return rv;</span>
<a href="#l48.368"></a><span id="l48.368">   }</span>
<a href="#l48.369"></a><span id="l48.369" class="difflineminus">-  return CheckForErrors(err, summaryFile);</span>
<a href="#l48.370"></a><span id="l48.370" class="difflineminus">-}</span>
<a href="#l48.371"></a><span id="l48.371" class="difflineminus">-</span>
<a href="#l48.372"></a><span id="l48.372" class="difflineminus">-nsresult nsMsgDatabase::CheckForErrors(nsresult err,</span>
<a href="#l48.373"></a><span id="l48.373" class="difflineplus">+  return CheckForErrors(rv, PR_TRUE, summaryFile);</span>
<a href="#l48.374"></a><span id="l48.374" class="difflineplus">+}</span>
<a href="#l48.375"></a><span id="l48.375" class="difflineplus">+</span>
<a href="#l48.376"></a><span id="l48.376" class="difflineplus">+nsresult nsMsgDatabase::CheckForErrors(nsresult err, bool sync,</span>
<a href="#l48.377"></a><span id="l48.377">                                        nsILocalFile *summaryFile)</span>
<a href="#l48.378"></a><span id="l48.378"> {</span>
<a href="#l48.379"></a><span id="l48.379">   nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l48.380"></a><span id="l48.380">   bool summaryFileExists;</span>
<a href="#l48.381"></a><span id="l48.381">   bool newFile = false;</span>
<a href="#l48.382"></a><span id="l48.382">   bool deleteInvalidDB = false;</span>
<a href="#l48.383"></a><span id="l48.383"> </span>
<a href="#l48.384"></a><span id="l48.384">   bool exists;</span>
<a href="#l48.385"></a><span id="l48.385" class="difflineat">@@ -1196,17 +1210,17 @@ nsresult nsMsgDatabase::CheckForErrors(n</span>
<a href="#l48.386"></a><span id="l48.386">   {</span>
<a href="#l48.387"></a><span id="l48.387">     err = NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE;</span>
<a href="#l48.388"></a><span id="l48.388">     deleteInvalidDB = PR_TRUE;</span>
<a href="#l48.389"></a><span id="l48.389">   }</span>
<a href="#l48.390"></a><span id="l48.390"> </span>
<a href="#l48.391"></a><span id="l48.391">   if (deleteInvalidDB)</span>
<a href="#l48.392"></a><span id="l48.392">   {</span>
<a href="#l48.393"></a><span id="l48.393">     // this will make the db folder info release its ref to the mail db...</span>
<a href="#l48.394"></a><span id="l48.394" class="difflineminus">-    m_dbFolderInfo = nsnull;</span>
<a href="#l48.395"></a><span id="l48.395" class="difflineplus">+    NS_IF_RELEASE(m_dbFolderInfo);</span>
<a href="#l48.396"></a><span id="l48.396">     ForceClosed();</span>
<a href="#l48.397"></a><span id="l48.397">     if (err == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l48.398"></a><span id="l48.398">       summaryFile-&gt;Remove(PR_FALSE);</span>
<a href="#l48.399"></a><span id="l48.399">   }</span>
<a href="#l48.400"></a><span id="l48.400">   if (err != NS_OK || newFile)</span>
<a href="#l48.401"></a><span id="l48.401">   {</span>
<a href="#l48.402"></a><span id="l48.402">     // if we couldn't open file, or we have a blank one, and we're supposed</span>
<a href="#l48.403"></a><span id="l48.403">     // to upgrade, updgrade it.</span>
<a href="#l48.404"></a><span id="l48.404" class="difflineat">@@ -1215,17 +1229,17 @@ nsresult nsMsgDatabase::CheckForErrors(n</span>
<a href="#l48.405"></a><span id="l48.405">       err = NS_MSG_ERROR_FOLDER_SUMMARY_MISSING;</span>
<a href="#l48.406"></a><span id="l48.406">     }</span>
<a href="#l48.407"></a><span id="l48.407">     else if (err != NS_OK &amp;&amp; err != NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE)</span>
<a href="#l48.408"></a><span id="l48.408">     {</span>
<a href="#l48.409"></a><span id="l48.409">       Close(PR_FALSE);</span>
<a href="#l48.410"></a><span id="l48.410">       summaryFile-&gt;Remove(PR_FALSE);  // blow away the db if it's corrupt.</span>
<a href="#l48.411"></a><span id="l48.411">     }</span>
<a href="#l48.412"></a><span id="l48.412">   }</span>
<a href="#l48.413"></a><span id="l48.413" class="difflineminus">-  if (err == NS_OK || err == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l48.414"></a><span id="l48.414" class="difflineplus">+  if (sync &amp;&amp; (err == NS_OK || err == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING))</span>
<a href="#l48.415"></a><span id="l48.415">     AddToCache(this);</span>
<a href="#l48.416"></a><span id="l48.416">   return (summaryFileExists) ? err : NS_MSG_ERROR_FOLDER_SUMMARY_MISSING;</span>
<a href="#l48.417"></a><span id="l48.417"> }</span>
<a href="#l48.418"></a><span id="l48.418"> </span>
<a href="#l48.419"></a><span id="l48.419"> /**</span>
<a href="#l48.420"></a><span id="l48.420">  * Open the MDB database synchronously or async based on sync argument.</span>
<a href="#l48.421"></a><span id="l48.421">  * If successful, this routine will set up the m_mdbStore and m_mdbEnv of</span>
<a href="#l48.422"></a><span id="l48.422">  * the database object so other database calls can work.</span>
<a href="#l48.423"></a><span id="l48.423" class="difflineat">@@ -2520,23 +2534,19 @@ bool nsMsgDatabase::SetHdrFlag(nsIMsgDBH</span>
<a href="#l48.424"></a><span id="l48.424">   (void)msgHdr-&gt;GetFlags(&amp;statusFlags);</span>
<a href="#l48.425"></a><span id="l48.425">   PRUint32 currentStatusFlags = GetStatusFlags(msgHdr, statusFlags);</span>
<a href="#l48.426"></a><span id="l48.426">   bool flagAlreadySet = (currentStatusFlags &amp; flag) != 0;</span>
<a href="#l48.427"></a><span id="l48.427"> </span>
<a href="#l48.428"></a><span id="l48.428">   if ((flagAlreadySet &amp;&amp; !bSet) || (!flagAlreadySet &amp;&amp; bSet))</span>
<a href="#l48.429"></a><span id="l48.429">   {</span>
<a href="#l48.430"></a><span id="l48.430">     PRUint32 resultFlags;</span>
<a href="#l48.431"></a><span id="l48.431">     if (bSet)</span>
<a href="#l48.432"></a><span id="l48.432" class="difflineminus">-    {</span>
<a href="#l48.433"></a><span id="l48.433">       msgHdr-&gt;OrFlags(flag, &amp;resultFlags);</span>
<a href="#l48.434"></a><span id="l48.434" class="difflineminus">-    }</span>
<a href="#l48.435"></a><span id="l48.435">     else</span>
<a href="#l48.436"></a><span id="l48.436" class="difflineminus">-    {</span>
<a href="#l48.437"></a><span id="l48.437">       msgHdr-&gt;AndFlags(~flag, &amp;resultFlags);</span>
<a href="#l48.438"></a><span id="l48.438" class="difflineminus">-    }</span>
<a href="#l48.439"></a><span id="l48.439">     return PR_TRUE;</span>
<a href="#l48.440"></a><span id="l48.440">   }</span>
<a href="#l48.441"></a><span id="l48.441">   return PR_FALSE;</span>
<a href="#l48.442"></a><span id="l48.442"> }</span>
<a href="#l48.443"></a><span id="l48.443"> </span>
<a href="#l48.444"></a><span id="l48.444"> </span>
<a href="#l48.445"></a><span id="l48.445"> NS_IMETHODIMP nsMsgDatabase::MarkHdrRead(nsIMsgDBHdr *msgHdr, bool bRead,</span>
<a href="#l48.446"></a><span id="l48.446">                                          nsIDBChangeListener *instigator)</span>
<a href="#l48.447"></a><span id="l48.447" class="difflineat">@@ -3327,23 +3337,36 @@ NS_IMETHODIMP nsMsgDatabase::CreateNewHd</span>
<a href="#l48.448"></a><span id="l48.448"> {</span>
<a href="#l48.449"></a><span id="l48.449">   nsresult  err = NS_OK;</span>
<a href="#l48.450"></a><span id="l48.450">   nsIMdbRow    *hdrRow;</span>
<a href="#l48.451"></a><span id="l48.451">   struct mdbOid allMsgHdrsTableOID;</span>
<a href="#l48.452"></a><span id="l48.452"> </span>
<a href="#l48.453"></a><span id="l48.453">   if (!pnewHdr || !m_mdbAllMsgHeadersTable || !m_mdbStore)</span>
<a href="#l48.454"></a><span id="l48.454">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l48.455"></a><span id="l48.455"> </span>
<a href="#l48.456"></a><span id="l48.456" class="difflineplus">+  if (key != nsMsgKey_None)</span>
<a href="#l48.457"></a><span id="l48.457" class="difflineplus">+  {</span>
<a href="#l48.458"></a><span id="l48.458">   allMsgHdrsTableOID.mOid_Scope = m_hdrRowScopeToken;</span>
<a href="#l48.459"></a><span id="l48.459">   allMsgHdrsTableOID.mOid_Id = key;  // presumes 0 is valid key value</span>
<a href="#l48.460"></a><span id="l48.460"> </span>
<a href="#l48.461"></a><span id="l48.461">   err = m_mdbStore-&gt;GetRow(GetEnv(), &amp;allMsgHdrsTableOID, &amp;hdrRow);</span>
<a href="#l48.462"></a><span id="l48.462">   if (!hdrRow)</span>
<a href="#l48.463"></a><span id="l48.463">     err  = m_mdbStore-&gt;NewRowWithOid(GetEnv(), &amp;allMsgHdrsTableOID, &amp;hdrRow);</span>
<a href="#l48.464"></a><span id="l48.464" class="difflineminus">-</span>
<a href="#l48.465"></a><span id="l48.465" class="difflineplus">+  }</span>
<a href="#l48.466"></a><span id="l48.466" class="difflineplus">+  else</span>
<a href="#l48.467"></a><span id="l48.467" class="difflineplus">+  {</span>
<a href="#l48.468"></a><span id="l48.468" class="difflineplus">+    // Mork will assign an ID to the new row, generally the next available ID.</span>
<a href="#l48.469"></a><span id="l48.469" class="difflineplus">+    err  = m_mdbStore-&gt;NewRow(GetEnv(), m_hdrRowScopeToken, &amp;hdrRow);</span>
<a href="#l48.470"></a><span id="l48.470" class="difflineplus">+    if (hdrRow)</span>
<a href="#l48.471"></a><span id="l48.471" class="difflineplus">+    {</span>
<a href="#l48.472"></a><span id="l48.472" class="difflineplus">+      struct mdbOid oid;</span>
<a href="#l48.473"></a><span id="l48.473" class="difflineplus">+      hdrRow-&gt;GetOid(GetEnv(), &amp;oid);</span>
<a href="#l48.474"></a><span id="l48.474" class="difflineplus">+      key = oid.mOid_Id;</span>
<a href="#l48.475"></a><span id="l48.475" class="difflineplus">+    }</span>
<a href="#l48.476"></a><span id="l48.476" class="difflineplus">+  }</span>
<a href="#l48.477"></a><span id="l48.477">   if (NS_FAILED(err))</span>
<a href="#l48.478"></a><span id="l48.478">     return err;</span>
<a href="#l48.479"></a><span id="l48.479">   err = CreateMsgHdr(hdrRow, key, pnewHdr);</span>
<a href="#l48.480"></a><span id="l48.480">   return err;</span>
<a href="#l48.481"></a><span id="l48.481"> }</span>
<a href="#l48.482"></a><span id="l48.482"> </span>
<a href="#l48.483"></a><span id="l48.483"> NS_IMETHODIMP nsMsgDatabase::AddNewHdrToDB(nsIMsgDBHdr *newHdr, bool notify)</span>
<a href="#l48.484"></a><span id="l48.484"> {</span>
<a href="#l48.485"></a><span id="l48.485" class="difflineat">@@ -3405,19 +3428,16 @@ NS_IMETHODIMP nsMsgDatabase::AddNewHdrTo</span>
<a href="#l48.486"></a><span id="l48.486"> }</span>
<a href="#l48.487"></a><span id="l48.487"> </span>
<a href="#l48.488"></a><span id="l48.488"> NS_IMETHODIMP nsMsgDatabase::CopyHdrFromExistingHdr(nsMsgKey key, nsIMsgDBHdr *existingHdr, bool addHdrToDB, nsIMsgDBHdr **newHdr)</span>
<a href="#l48.489"></a><span id="l48.489"> {</span>
<a href="#l48.490"></a><span id="l48.490">   nsresult  err = NS_OK;</span>
<a href="#l48.491"></a><span id="l48.491"> </span>
<a href="#l48.492"></a><span id="l48.492">   if (existingHdr)</span>
<a href="#l48.493"></a><span id="l48.493">   {</span>
<a href="#l48.494"></a><span id="l48.494" class="difflineminus">-    if (key == nsMsgKey_None)</span>
<a href="#l48.495"></a><span id="l48.495" class="difflineminus">-      return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l48.496"></a><span id="l48.496" class="difflineminus">-</span>
<a href="#l48.497"></a><span id="l48.497">     nsMsgHdr* sourceMsgHdr = static_cast&lt;nsMsgHdr*&gt;(existingHdr);      // closed system, cast ok</span>
<a href="#l48.498"></a><span id="l48.498">     nsMsgHdr *destMsgHdr = nsnull;</span>
<a href="#l48.499"></a><span id="l48.499">     CreateNewHdr(key, (nsIMsgDBHdr **) &amp;destMsgHdr);</span>
<a href="#l48.500"></a><span id="l48.500">     nsIMdbRow  *sourceRow = sourceMsgHdr-&gt;GetMDBRow();</span>
<a href="#l48.501"></a><span id="l48.501">     if (!destMsgHdr || !sourceRow)</span>
<a href="#l48.502"></a><span id="l48.502">       return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l48.503"></a><span id="l48.503"> </span>
<a href="#l48.504"></a><span id="l48.504">     nsIMdbRow  *destRow = destMsgHdr-&gt;GetMDBRow();</span>
<a href="#l48.505"></a><span id="l48.505" class="difflineat">@@ -3427,17 +3447,16 @@ NS_IMETHODIMP nsMsgDatabase::CopyHdrFrom</span>
<a href="#l48.506"></a><span id="l48.506">       // we may have gotten the header from a cache - calling SetRow</span>
<a href="#l48.507"></a><span id="l48.507">       // basically invalidates any cached values, so invalidate them.</span>
<a href="#l48.508"></a><span id="l48.508">       destMsgHdr-&gt;m_initedValues = 0;</span>
<a href="#l48.509"></a><span id="l48.509">       if(addHdrToDB)</span>
<a href="#l48.510"></a><span id="l48.510">         err = AddNewHdrToDB(destMsgHdr, PR_TRUE);</span>
<a href="#l48.511"></a><span id="l48.511">       if (NS_SUCCEEDED(err) &amp;&amp; newHdr)</span>
<a href="#l48.512"></a><span id="l48.512">         *newHdr = destMsgHdr;</span>
<a href="#l48.513"></a><span id="l48.513">     }</span>
<a href="#l48.514"></a><span id="l48.514" class="difflineminus">-</span>
<a href="#l48.515"></a><span id="l48.515">   }</span>
<a href="#l48.516"></a><span id="l48.516">   return err;</span>
<a href="#l48.517"></a><span id="l48.517"> }</span>
<a href="#l48.518"></a><span id="l48.518"> </span>
<a href="#l48.519"></a><span id="l48.519"> nsresult nsMsgDatabase::RowCellColumnTonsString(nsIMdbRow *hdrRow, mdb_token columnToken, nsAString &amp;resultStr)</span>
<a href="#l48.520"></a><span id="l48.520"> {</span>
<a href="#l48.521"></a><span id="l48.521">   nsresult  err = NS_OK;</span>
<a href="#l48.522"></a><span id="l48.522"> </span>
<a href="#l48.523"></a><span id="l48.523" class="difflineat">@@ -4005,18 +4024,17 @@ nsresult nsMsgDatabase::SetNSStringPrope</span>
<a href="#l48.524"></a><span id="l48.524"> PRUint32 nsMsgDatabase::GetCurVersion()</span>
<a href="#l48.525"></a><span id="l48.525"> {</span>
<a href="#l48.526"></a><span id="l48.526">   return kMsgDBVersion;</span>
<a href="#l48.527"></a><span id="l48.527"> }</span>
<a href="#l48.528"></a><span id="l48.528"> </span>
<a href="#l48.529"></a><span id="l48.529"> NS_IMETHODIMP nsMsgDatabase::SetSummaryValid(bool valid /* = true */)</span>
<a href="#l48.530"></a><span id="l48.530"> {</span>
<a href="#l48.531"></a><span id="l48.531">   // setting the version to 0 ought to make it pretty invalid.</span>
<a href="#l48.532"></a><span id="l48.532" class="difflineminus">-  if (!valid)</span>
<a href="#l48.533"></a><span id="l48.533" class="difflineminus">-    m_dbFolderInfo-&gt;SetVersion(0);</span>
<a href="#l48.534"></a><span id="l48.534" class="difflineplus">+  m_dbFolderInfo-&gt;SetVersion(valid ? GetCurVersion() : 0);</span>
<a href="#l48.535"></a><span id="l48.535"> </span>
<a href="#l48.536"></a><span id="l48.536">   // for default db (and news), there's no nothing to set to make it it valid</span>
<a href="#l48.537"></a><span id="l48.537">   return NS_OK;</span>
<a href="#l48.538"></a><span id="l48.538"> }</span>
<a href="#l48.539"></a><span id="l48.539"> </span>
<a href="#l48.540"></a><span id="l48.540"> </span>
<a href="#l48.541"></a><span id="l48.541"> NS_IMETHODIMP  nsMsgDatabase::GetSummaryValid(bool *aResult)</span>
<a href="#l48.542"></a><span id="l48.542"> {</span>
<a href="#l48.543"></a><span id="l48.543" class="difflineat">@@ -5570,27 +5588,16 @@ NS_IMETHODIMP nsMsgDatabase::ResetHdrCac</span>
<a href="#l48.544"></a><span id="l48.544">   if (m_cacheSize &gt; aSize)</span>
<a href="#l48.545"></a><span id="l48.545">   {</span>
<a href="#l48.546"></a><span id="l48.546">     m_cacheSize = aSize;</span>
<a href="#l48.547"></a><span id="l48.547">     ClearHdrCache(PR_FALSE);</span>
<a href="#l48.548"></a><span id="l48.548">   }</span>
<a href="#l48.549"></a><span id="l48.549">   return NS_OK;</span>
<a href="#l48.550"></a><span id="l48.550"> }</span>
<a href="#l48.551"></a><span id="l48.551"> </span>
<a href="#l48.552"></a><span id="l48.552" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::GetFolderStream(nsIOutputStream **aFileStream)</span>
<a href="#l48.553"></a><span id="l48.553" class="difflineminus">-{</span>
<a href="#l48.554"></a><span id="l48.554" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l48.555"></a><span id="l48.555" class="difflineminus">-}</span>
<a href="#l48.556"></a><span id="l48.556" class="difflineminus">-</span>
<a href="#l48.557"></a><span id="l48.557" class="difflineminus">-NS_IMETHODIMP nsMsgDatabase::SetFolderStream(nsIOutputStream *aFileStream)</span>
<a href="#l48.558"></a><span id="l48.558" class="difflineminus">-{</span>
<a href="#l48.559"></a><span id="l48.559" class="difflineminus">-  NS_ERROR(&quot;Trying to set the folderStream, not implemented&quot;);</span>
<a href="#l48.560"></a><span id="l48.560" class="difflineminus">-  return NS_ERROR_NOT_IMPLEMENTED;</span>
<a href="#l48.561"></a><span id="l48.561" class="difflineminus">-}</span>
<a href="#l48.562"></a><span id="l48.562" class="difflineminus">-</span>
<a href="#l48.563"></a><span id="l48.563"> /**</span>
<a href="#l48.564"></a><span id="l48.564">   void getNewList(out unsigned long count, [array, size_is(count)] out long newKeys);</span>
<a href="#l48.565"></a><span id="l48.565">  */</span>
<a href="#l48.566"></a><span id="l48.566"> NS_IMETHODIMP</span>
<a href="#l48.567"></a><span id="l48.567"> nsMsgDatabase::GetNewList(PRUint32 *aCount, PRUint32 **aNewKeys)</span>
<a href="#l48.568"></a><span id="l48.568"> {</span>
<a href="#l48.569"></a><span id="l48.569">     NS_ENSURE_ARG_POINTER(aCount);</span>
<a href="#l48.570"></a><span id="l48.570">     NS_ENSURE_ARG_POINTER(aNewKeys);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l49.1"></a><span id="l49.1" class="difflineminus">--- a/mailnews/db/msgdb/src/nsMsgHdr.cpp</span>
<a href="#l49.2"></a><span id="l49.2" class="difflineplus">+++ b/mailnews/db/msgdb/src/nsMsgHdr.cpp</span>
<a href="#l49.3"></a><span id="l49.3" class="difflineat">@@ -623,29 +623,21 @@ NS_IMETHODIMP nsMsgHdr::GetAccountKey(ch</span>
<a href="#l49.4"></a><span id="l49.4">   return GetStringProperty(&quot;account&quot;, aResult);</span>
<a href="#l49.5"></a><span id="l49.5"> }</span>
<a href="#l49.6"></a><span id="l49.6"> </span>
<a href="#l49.7"></a><span id="l49.7"> </span>
<a href="#l49.8"></a><span id="l49.8"> NS_IMETHODIMP nsMsgHdr::GetMessageOffset(PRUint64 *result)</span>
<a href="#l49.9"></a><span id="l49.9"> {</span>
<a href="#l49.10"></a><span id="l49.10">   NS_ENSURE_ARG(result);</span>
<a href="#l49.11"></a><span id="l49.11"> </span>
<a href="#l49.12"></a><span id="l49.12" class="difflineminus">-  // if we have the message body offline, then return the message offset column</span>
<a href="#l49.13"></a><span id="l49.13" class="difflineminus">-  // (this will only be true for news and imap messages).</span>
<a href="#l49.14"></a><span id="l49.14" class="difflineminus">-  PRUint32 rawFlags;</span>
<a href="#l49.15"></a><span id="l49.15" class="difflineminus">-  GetRawFlags(&amp;rawFlags);</span>
<a href="#l49.16"></a><span id="l49.16" class="difflineminus">-  if (rawFlags &amp; nsMsgMessageFlags::Offline)</span>
<a href="#l49.17"></a><span id="l49.17" class="difflineminus">-  {</span>
<a href="#l49.18"></a><span id="l49.18" class="difflineminus">-    return GetUInt64Column(m_mdb-&gt;m_offlineMsgOffsetColumnToken, result);</span>
<a href="#l49.19"></a><span id="l49.19" class="difflineminus">-  }</span>
<a href="#l49.20"></a><span id="l49.20" class="difflineminus">-  else</span>
<a href="#l49.21"></a><span id="l49.21" class="difflineminus">-  {</span>
<a href="#l49.22"></a><span id="l49.22" class="difflineplus">+  // if there is a message offset, use it, otherwise, we'll use the message key.</span>
<a href="#l49.23"></a><span id="l49.23" class="difflineplus">+  (void) GetUInt64Column(m_mdb-&gt;m_offlineMsgOffsetColumnToken, result, -1);</span>
<a href="#l49.24"></a><span id="l49.24" class="difflineplus">+  if (*result == -1)</span>
<a href="#l49.25"></a><span id="l49.25">     *result = m_messageKey;</span>
<a href="#l49.26"></a><span id="l49.26" class="difflineminus">-    return NS_OK;</span>
<a href="#l49.27"></a><span id="l49.27" class="difflineminus">-  }</span>
<a href="#l49.28"></a><span id="l49.28" class="difflineplus">+  return NS_OK;</span>
<a href="#l49.29"></a><span id="l49.29"> }</span>
<a href="#l49.30"></a><span id="l49.30"> </span>
<a href="#l49.31"></a><span id="l49.31"> NS_IMETHODIMP nsMsgHdr::SetMessageOffset(PRUint64 offset)</span>
<a href="#l49.32"></a><span id="l49.32"> {</span>
<a href="#l49.33"></a><span id="l49.33">   SetUInt64Column(offset, m_mdb-&gt;m_offlineMsgOffsetColumnToken);</span>
<a href="#l49.34"></a><span id="l49.34">   return NS_OK;</span>
<a href="#l49.35"></a><span id="l49.35"> }</span>
<a href="#l49.36"></a><span id="l49.36"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l50.1"></a><span id="l50.1" class="difflineminus">--- a/mailnews/extensions/mdn/test/unit/test_askuser.js</span>
<a href="#l50.2"></a><span id="l50.2" class="difflineplus">+++ b/mailnews/extensions/mdn/test/unit/test_askuser.js</span>
<a href="#l50.3"></a><span id="l50.3" class="difflineat">@@ -37,17 +37,17 @@ function run_test()</span>
<a href="#l50.4"></a><span id="l50.4">   prefs.setIntPref(&quot;mail.mdn.report.not_in_to_cc&quot;, 2);</span>
<a href="#l50.5"></a><span id="l50.5">   prefs.setIntPref(&quot;mail.mdn.report.other&quot;, 2);</span>
<a href="#l50.6"></a><span id="l50.6">   prefs.setIntPref(&quot;mail.mdn.report.outside_domain&quot;, 2);</span>
<a href="#l50.7"></a><span id="l50.7">   </span>
<a href="#l50.8"></a><span id="l50.8">   var msgFolder = gLocalInboxFolder;</span>
<a href="#l50.9"></a><span id="l50.9"> </span>
<a href="#l50.10"></a><span id="l50.10">   var msgWindow = {};</span>
<a href="#l50.11"></a><span id="l50.11">  </span>
<a href="#l50.12"></a><span id="l50.12" class="difflineminus">-  var msgHdr = gLocalInboxFolder.GetMessageHeader(0);</span>
<a href="#l50.13"></a><span id="l50.13" class="difflineplus">+  var msgHdr = firstMsgHdr(gLocalInboxFolder);</span>
<a href="#l50.14"></a><span id="l50.14"> </span>
<a href="#l50.15"></a><span id="l50.15">   // Everything looks good so far, let's generate the MDN response.</span>
<a href="#l50.16"></a><span id="l50.16">   var mdnGenerator = Components.classes[&quot;@mozilla.org/messenger-mdn/generator;1&quot;]</span>
<a href="#l50.17"></a><span id="l50.17">                                .createInstance(Components.interfaces.nsIMsgMdnGenerator);</span>
<a href="#l50.18"></a><span id="l50.18">   const MDN_DISPOSE_TYPE_DISPLAYED = 0;</span>
<a href="#l50.19"></a><span id="l50.19"> </span>
<a href="#l50.20"></a><span id="l50.20">   prefs.setIntPref(&quot;mail.mdn.report.outside_domain&quot;, 1);</span>
<a href="#l50.21"></a><span id="l50.21">   var askUser = mdnGenerator.process(MDN_DISPOSE_TYPE_DISPLAYED, msgWindow, msgFolder,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l51.1"></a><span id="l51.1" class="difflineminus">--- a/mailnews/extensions/mdn/test/unit/test_mdnFlags.js</span>
<a href="#l51.2"></a><span id="l51.2" class="difflineplus">+++ b/mailnews/extensions/mdn/test/unit/test_mdnFlags.js</span>
<a href="#l51.3"></a><span id="l51.3" class="difflineat">@@ -44,17 +44,17 @@ function run_test()</span>
<a href="#l51.4"></a><span id="l51.4">   prefs.setIntPref(&quot;mail.mdn.report.not_in_to_cc&quot;, 2);</span>
<a href="#l51.5"></a><span id="l51.5">   prefs.setIntPref(&quot;mail.mdn.report.other&quot;, 2);</span>
<a href="#l51.6"></a><span id="l51.6">   prefs.setIntPref(&quot;mail.mdn.report.outside_domain&quot;, 2);</span>
<a href="#l51.7"></a><span id="l51.7">   </span>
<a href="#l51.8"></a><span id="l51.8">   var msgFolder = gLocalInboxFolder;</span>
<a href="#l51.9"></a><span id="l51.9"> </span>
<a href="#l51.10"></a><span id="l51.10">   var msgWindow = {};</span>
<a href="#l51.11"></a><span id="l51.11">  </span>
<a href="#l51.12"></a><span id="l51.12" class="difflineminus">-  var msgHdr = gLocalInboxFolder.GetMessageHeader(0);</span>
<a href="#l51.13"></a><span id="l51.13" class="difflineplus">+  var msgHdr = firstMsgHdr(gLocalInboxFolder);</span>
<a href="#l51.14"></a><span id="l51.14"> </span>
<a href="#l51.15"></a><span id="l51.15">   // Everything looks good so far, let's generate the MDN response.</span>
<a href="#l51.16"></a><span id="l51.16">   var mdnGenerator = Components.classes[&quot;@mozilla.org/messenger-mdn/generator;1&quot;]</span>
<a href="#l51.17"></a><span id="l51.17">                                .createInstance(Components.interfaces.nsIMsgMdnGenerator);</span>
<a href="#l51.18"></a><span id="l51.18">   const MDN_DISPOSE_TYPE_DISPLAYED = 0;</span>
<a href="#l51.19"></a><span id="l51.19"> </span>
<a href="#l51.20"></a><span id="l51.20">   mdnGenerator.process(MDN_DISPOSE_TYPE_DISPLAYED, msgWindow, msgFolder,</span>
<a href="#l51.21"></a><span id="l51.21">                        msgHdr.messageKey, mimeHdr, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l52.1"></a><span id="l52.1" class="difflineminus">--- a/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l52.2"></a><span id="l52.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapMailFolder.cpp</span>
<a href="#l52.3"></a><span id="l52.3" class="difflineat">@@ -976,17 +976,18 @@ NS_IMETHODIMP nsImapMailFolder::CreateCl</span>
<a href="#l52.4"></a><span id="l52.4"> </span>
<a href="#l52.5"></a><span id="l52.5">   // warning, path will be changed</span>
<a href="#l52.6"></a><span id="l52.6">   rv = CreateFileForDB(folderNameStr, path, getter_AddRefs(dbFile));</span>
<a href="#l52.7"></a><span id="l52.7">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l52.8"></a><span id="l52.8"> </span>
<a href="#l52.9"></a><span id="l52.9">   //Now let's create the actual new folder</span>
<a href="#l52.10"></a><span id="l52.10">   rv = AddSubfolderWithPath(folderNameStr, dbFile, getter_AddRefs(child), PR_TRUE);</span>
<a href="#l52.11"></a><span id="l52.11">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.12"></a><span id="l52.12" class="difflineminus">-  rv = msgDBService-&gt;OpenMailDBFromFile(dbFile, PR_TRUE, PR_TRUE, (nsIMsgDatabase **) getter_AddRefs(unusedDB));</span>
<a href="#l52.13"></a><span id="l52.13" class="difflineplus">+  rv = msgDBService-&gt;OpenMailDBFromFile(dbFile, child, PR_TRUE, PR_TRUE,</span>
<a href="#l52.14"></a><span id="l52.14" class="difflineplus">+                                        getter_AddRefs(unusedDB));</span>
<a href="#l52.15"></a><span id="l52.15">   if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l52.16"></a><span id="l52.16">     rv = NS_OK;</span>
<a href="#l52.17"></a><span id="l52.17"> </span>
<a href="#l52.18"></a><span id="l52.18">   if (NS_SUCCEEDED(rv) &amp;&amp; unusedDB)</span>
<a href="#l52.19"></a><span id="l52.19">   {</span>
<a href="#l52.20"></a><span id="l52.20">   //need to set the folder name</span>
<a href="#l52.21"></a><span id="l52.21">     nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l52.22"></a><span id="l52.22">     rv = unusedDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l52.23"></a><span id="l52.23" class="difflineat">@@ -4536,22 +4537,16 @@ NS_IMETHODIMP nsImapMailFolder::Download</span>
<a href="#l52.24"></a><span id="l52.24">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l52.25"></a><span id="l52.25"> </span>
<a href="#l52.26"></a><span id="l52.26">   rv = AcquireSemaphore(static_cast&lt;nsIMsgFolder*&gt;(this));</span>
<a href="#l52.27"></a><span id="l52.27">   if (NS_FAILED(rv))</span>
<a href="#l52.28"></a><span id="l52.28">   {</span>
<a href="#l52.29"></a><span id="l52.29">     ThrowAlertMsg(&quot;operationFailedFolderBusy&quot;, window);</span>
<a href="#l52.30"></a><span id="l52.30">     return rv;</span>
<a href="#l52.31"></a><span id="l52.31">   }</span>
<a href="#l52.32"></a><span id="l52.32" class="difflineminus">-  rv = GetOfflineStoreOutputStream(getter_AddRefs(m_tempMessageStream));</span>
<a href="#l52.33"></a><span id="l52.33" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l52.34"></a><span id="l52.34" class="difflineminus">-  {</span>
<a href="#l52.35"></a><span id="l52.35" class="difflineminus">-    ReleaseSemaphore(static_cast&lt;nsIMsgFolder*&gt;(this));</span>
<a href="#l52.36"></a><span id="l52.36" class="difflineminus">-    return rv;</span>
<a href="#l52.37"></a><span id="l52.37" class="difflineminus">-  }</span>
<a href="#l52.38"></a><span id="l52.38">   return imapService-&gt;DownloadMessagesForOffline(messageIds, this, this, window);</span>
<a href="#l52.39"></a><span id="l52.39"> }</span>
<a href="#l52.40"></a><span id="l52.40"> </span>
<a href="#l52.41"></a><span id="l52.41"> NS_IMETHODIMP nsImapMailFolder::DownloadAllForOffline(nsIUrlListener *listener, nsIMsgWindow *msgWindow)</span>
<a href="#l52.42"></a><span id="l52.42"> {</span>
<a href="#l52.43"></a><span id="l52.43">   nsresult rv;</span>
<a href="#l52.44"></a><span id="l52.44">   nsCOMPtr &lt;nsIURI&gt; runningURI;</span>
<a href="#l52.45"></a><span id="l52.45">   bool noSelect;</span>
<a href="#l52.46"></a><span id="l52.46" class="difflineat">@@ -4567,28 +4562,23 @@ NS_IMETHODIMP nsImapMailFolder::Download</span>
<a href="#l52.47"></a><span id="l52.47"> </span>
<a href="#l52.48"></a><span id="l52.48">     rv = AcquireSemaphore(static_cast&lt;nsIMsgFolder*&gt;(this));</span>
<a href="#l52.49"></a><span id="l52.49">     if (NS_FAILED(rv))</span>
<a href="#l52.50"></a><span id="l52.50">     {</span>
<a href="#l52.51"></a><span id="l52.51">       m_downloadingFolderForOfflineUse = PR_FALSE;</span>
<a href="#l52.52"></a><span id="l52.52">       ThrowAlertMsg(&quot;operationFailedFolderBusy&quot;, msgWindow);</span>
<a href="#l52.53"></a><span id="l52.53">       return rv;</span>
<a href="#l52.54"></a><span id="l52.54">     }</span>
<a href="#l52.55"></a><span id="l52.55" class="difflineminus">-    rv = GetOfflineStoreOutputStream(getter_AddRefs(m_tempMessageStream));</span>
<a href="#l52.56"></a><span id="l52.56" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l52.57"></a><span id="l52.57" class="difflineminus">-    {</span>
<a href="#l52.58"></a><span id="l52.58" class="difflineminus">-      ReleaseSemaphore(static_cast&lt;nsIMsgFolder*&gt;(this));</span>
<a href="#l52.59"></a><span id="l52.59" class="difflineminus">-      return rv;</span>
<a href="#l52.60"></a><span id="l52.60" class="difflineminus">-    }</span>
<a href="#l52.61"></a><span id="l52.61">     nsCOMPtr&lt;nsIImapService&gt; imapService = do_GetService(NS_IMAPSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l52.62"></a><span id="l52.62">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.63"></a><span id="l52.63"> </span>
<a href="#l52.64"></a><span id="l52.64">     // Selecting the folder with nsIImapUrl::shouldStoreMsgOffline true will</span>
<a href="#l52.65"></a><span id="l52.65">     // cause us to fetch any message bodies we don't have.</span>
<a href="#l52.66"></a><span id="l52.66" class="difflineminus">-    rv = imapService-&gt;SelectFolder(m_thread, this, listener, msgWindow,</span>
<a href="#l52.67"></a><span id="l52.67" class="difflineplus">+    m_urlListener = listener;</span>
<a href="#l52.68"></a><span id="l52.68" class="difflineplus">+    rv = imapService-&gt;SelectFolder(m_thread, this, this, msgWindow,</span>
<a href="#l52.69"></a><span id="l52.69">                                    getter_AddRefs(runningURI));</span>
<a href="#l52.70"></a><span id="l52.70">     if (NS_SUCCEEDED(rv))</span>
<a href="#l52.71"></a><span id="l52.71">     {</span>
<a href="#l52.72"></a><span id="l52.72">       nsCOMPtr&lt;nsIImapUrl&gt; imapUrl(do_QueryInterface(runningURI));</span>
<a href="#l52.73"></a><span id="l52.73">       if (imapUrl)</span>
<a href="#l52.74"></a><span id="l52.74">         imapUrl-&gt;SetStoreResultsOffline(PR_TRUE);</span>
<a href="#l52.75"></a><span id="l52.75">       m_urlRunning = PR_TRUE;</span>
<a href="#l52.76"></a><span id="l52.76">     }</span>
<a href="#l52.77"></a><span id="l52.77" class="difflineat">@@ -5184,33 +5174,37 @@ nsImapMailFolder::OnStartRunningUrl(nsIU</span>
<a href="#l52.78"></a><span id="l52.78"> NS_IMETHODIMP</span>
<a href="#l52.79"></a><span id="l52.79"> nsImapMailFolder::OnStopRunningUrl(nsIURI *aUrl, nsresult aExitCode)</span>
<a href="#l52.80"></a><span id="l52.80"> {</span>
<a href="#l52.81"></a><span id="l52.81">   nsresult rv;</span>
<a href="#l52.82"></a><span id="l52.82">   bool endedOfflineDownload = false;</span>
<a href="#l52.83"></a><span id="l52.83">   nsImapAction imapAction = nsIImapUrl::nsImapTest;</span>
<a href="#l52.84"></a><span id="l52.84">   m_urlRunning = PR_FALSE;</span>
<a href="#l52.85"></a><span id="l52.85">   m_updatingFolder = PR_FALSE;</span>
<a href="#l52.86"></a><span id="l52.86" class="difflineplus">+  nsCOMPtr&lt;nsIMsgMailSession&gt; session =</span>
<a href="#l52.87"></a><span id="l52.87" class="difflineplus">+    do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l52.88"></a><span id="l52.88" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.89"></a><span id="l52.89" class="difflineplus">+  if (aUrl)</span>
<a href="#l52.90"></a><span id="l52.90" class="difflineplus">+  {</span>
<a href="#l52.91"></a><span id="l52.91">   nsCOMPtr &lt;nsIImapUrl&gt; imapUrl = do_QueryInterface(aUrl, &amp;rv);</span>
<a href="#l52.92"></a><span id="l52.92">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.93"></a><span id="l52.93">   bool downloadingForOfflineUse;</span>
<a href="#l52.94"></a><span id="l52.94">   imapUrl-&gt;GetStoreResultsOffline(&amp;downloadingForOfflineUse);</span>
<a href="#l52.95"></a><span id="l52.95" class="difflineplus">+    bool hasSemaphore = false;</span>
<a href="#l52.96"></a><span id="l52.96" class="difflineplus">+    // if we have the folder locked, clear it.</span>
<a href="#l52.97"></a><span id="l52.97" class="difflineplus">+    TestSemaphore(static_cast&lt;nsIMsgFolder*&gt;(this), &amp;hasSemaphore);</span>
<a href="#l52.98"></a><span id="l52.98" class="difflineplus">+    if (hasSemaphore)</span>
<a href="#l52.99"></a><span id="l52.99" class="difflineplus">+      ReleaseSemaphore(static_cast&lt;nsIMsgFolder*&gt;(this));</span>
<a href="#l52.100"></a><span id="l52.100">   if (downloadingForOfflineUse)</span>
<a href="#l52.101"></a><span id="l52.101">   {</span>
<a href="#l52.102"></a><span id="l52.102" class="difflineminus">-    ReleaseSemaphore(static_cast&lt;nsIMsgFolder*&gt;(this));</span>
<a href="#l52.103"></a><span id="l52.103">     endedOfflineDownload = PR_TRUE;</span>
<a href="#l52.104"></a><span id="l52.104">     EndOfflineDownload();</span>
<a href="#l52.105"></a><span id="l52.105">   }</span>
<a href="#l52.106"></a><span id="l52.106" class="difflineminus">-  nsCOMPtr&lt;nsIMsgMailSession&gt; session = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l52.107"></a><span id="l52.107" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.108"></a><span id="l52.108" class="difflineminus">-  if (aUrl)</span>
<a href="#l52.109"></a><span id="l52.109" class="difflineminus">-  {</span>
<a href="#l52.110"></a><span id="l52.110">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l52.111"></a><span id="l52.111">     nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; mailUrl = do_QueryInterface(aUrl);</span>
<a href="#l52.112"></a><span id="l52.112" class="difflineminus">-    nsCOMPtr&lt;nsIImapUrl&gt; imapUrl = do_QueryInterface(aUrl);</span>
<a href="#l52.113"></a><span id="l52.113">     bool folderOpen = false;</span>
<a href="#l52.114"></a><span id="l52.114">     if (mailUrl)</span>
<a href="#l52.115"></a><span id="l52.115">       mailUrl-&gt;GetMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l52.116"></a><span id="l52.116">     if (session)</span>
<a href="#l52.117"></a><span id="l52.117">       session-&gt;IsFolderOpenInWindow(this, &amp;folderOpen);</span>
<a href="#l52.118"></a><span id="l52.118"> #ifdef DEBUG_bienvenu1</span>
<a href="#l52.119"></a><span id="l52.119">     nsCString urlSpec;</span>
<a href="#l52.120"></a><span id="l52.120">     aUrl-&gt;GetSpec(getter_Copies(urlSpec));</span>
<a href="#l52.121"></a><span id="l52.121" class="difflineat">@@ -5218,17 +5212,17 @@ nsImapMailFolder::OnStopRunningUrl(nsIUR</span>
<a href="#l52.122"></a><span id="l52.122"> #endif</span>
<a href="#l52.123"></a><span id="l52.123"> </span>
<a href="#l52.124"></a><span id="l52.124">    if (imapUrl)</span>
<a href="#l52.125"></a><span id="l52.125">    {</span>
<a href="#l52.126"></a><span id="l52.126">       DisplayStatusMsg(imapUrl, EmptyString());</span>
<a href="#l52.127"></a><span id="l52.127">       imapUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l52.128"></a><span id="l52.128">       if (imapAction == nsIImapUrl::nsImapMsgFetch || imapAction == nsIImapUrl::nsImapMsgDownloadForOffline)</span>
<a href="#l52.129"></a><span id="l52.129">       {</span>
<a href="#l52.130"></a><span id="l52.130" class="difflineminus">-        ReleaseSemaphore(static_cast&lt;nsIMsgImapMailFolder*&gt;(this));</span>
<a href="#l52.131"></a><span id="l52.131" class="difflineplus">+        ReleaseSemaphore(static_cast&lt;nsIMsgFolder*&gt;(this));</span>
<a href="#l52.132"></a><span id="l52.132">         if (!endedOfflineDownload)</span>
<a href="#l52.133"></a><span id="l52.133">           EndOfflineDownload();</span>
<a href="#l52.134"></a><span id="l52.134">       }</span>
<a href="#l52.135"></a><span id="l52.135"> </span>
<a href="#l52.136"></a><span id="l52.136">       // Notify move, copy or delete (online operations)</span>
<a href="#l52.137"></a><span id="l52.137">       // Not sure whether nsImapDeleteMsg is even used, deletes in all three models use nsImapAddMsgFlags.</span>
<a href="#l52.138"></a><span id="l52.138">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l52.139"></a><span id="l52.139">       if (notifier &amp;&amp; m_copyState)</span>
<a href="#l52.140"></a><span id="l52.140" class="difflineat">@@ -5554,18 +5548,19 @@ nsImapMailFolder::OnStopRunningUrl(nsIUR</span>
<a href="#l52.141"></a><span id="l52.141"> </span>
<a href="#l52.142"></a><span id="l52.142">   }</span>
<a href="#l52.143"></a><span id="l52.143">   // if we're not running a url, we must not be getting new mail.</span>
<a href="#l52.144"></a><span id="l52.144">   SetGettingNewMessages(PR_FALSE);</span>
<a href="#l52.145"></a><span id="l52.145">   // don't send OnStopRunning notification if still compacting offline store.</span>
<a href="#l52.146"></a><span id="l52.146">   if (m_urlListener &amp;&amp; (imapAction != nsIImapUrl::nsImapExpungeFolder ||</span>
<a href="#l52.147"></a><span id="l52.147">                         !m_compactingOfflineStore))</span>
<a href="#l52.148"></a><span id="l52.148">   {</span>
<a href="#l52.149"></a><span id="l52.149" class="difflineminus">-    m_urlListener-&gt;OnStopRunningUrl(aUrl, aExitCode);</span>
<a href="#l52.150"></a><span id="l52.150" class="difflineplus">+    nsCOMPtr&lt;nsIUrlListener&gt; saveListener = m_urlListener;</span>
<a href="#l52.151"></a><span id="l52.151">     m_urlListener = nsnull;</span>
<a href="#l52.152"></a><span id="l52.152" class="difflineplus">+    saveListener-&gt;OnStopRunningUrl(aUrl, aExitCode);</span>
<a href="#l52.153"></a><span id="l52.153">   }</span>
<a href="#l52.154"></a><span id="l52.154">   return rv;</span>
<a href="#l52.155"></a><span id="l52.155"> }</span>
<a href="#l52.156"></a><span id="l52.156"> </span>
<a href="#l52.157"></a><span id="l52.157"> void nsImapMailFolder::UpdatePendingCounts()</span>
<a href="#l52.158"></a><span id="l52.158"> {</span>
<a href="#l52.159"></a><span id="l52.159">   if (m_copyState)</span>
<a href="#l52.160"></a><span id="l52.160">   {</span>
<a href="#l52.161"></a><span id="l52.161" class="difflineat">@@ -6803,31 +6798,31 @@ nsImapMailFolder::CopyNextStreamMessage(</span>
<a href="#l52.162"></a><span id="l52.162"> </span>
<a href="#l52.163"></a><span id="l52.163"> NS_IMETHODIMP</span>
<a href="#l52.164"></a><span id="l52.164"> nsImapMailFolder::SetUrlState(nsIImapProtocol* aProtocol,</span>
<a href="#l52.165"></a><span id="l52.165">                               nsIMsgMailNewsUrl* aUrl,</span>
<a href="#l52.166"></a><span id="l52.166">                               bool isRunning,</span>
<a href="#l52.167"></a><span id="l52.167">                               bool aSuspend,</span>
<a href="#l52.168"></a><span id="l52.168">                               nsresult statusCode)</span>
<a href="#l52.169"></a><span id="l52.169"> {</span>
<a href="#l52.170"></a><span id="l52.170" class="difflineplus">+  // If we have no path, then the folder has been shutdown, and there's</span>
<a href="#l52.171"></a><span id="l52.171" class="difflineplus">+  // no point in doing anything...</span>
<a href="#l52.172"></a><span id="l52.172" class="difflineplus">+  if (!mPath)</span>
<a href="#l52.173"></a><span id="l52.173" class="difflineplus">+    return NS_OK;</span>
<a href="#l52.174"></a><span id="l52.174">   if (!isRunning)</span>
<a href="#l52.175"></a><span id="l52.175">   {</span>
<a href="#l52.176"></a><span id="l52.176">     ProgressStatus(aProtocol, IMAP_DONE, nsnull);</span>
<a href="#l52.177"></a><span id="l52.177">     m_urlRunning = PR_FALSE;</span>
<a href="#l52.178"></a><span id="l52.178">     // if no protocol, then we're reading from the mem or disk cache</span>
<a href="#l52.179"></a><span id="l52.179">     // and we don't want to end the offline download just yet.</span>
<a href="#l52.180"></a><span id="l52.180">     if (aProtocol)</span>
<a href="#l52.181"></a><span id="l52.181">     {</span>
<a href="#l52.182"></a><span id="l52.182">       EndOfflineDownload();</span>
<a href="#l52.183"></a><span id="l52.183" class="difflineminus">-      if (m_downloadingFolderForOfflineUse)</span>
<a href="#l52.184"></a><span id="l52.184" class="difflineminus">-      {</span>
<a href="#l52.185"></a><span id="l52.185" class="difflineminus">-        ReleaseSemaphore(static_cast&lt;nsIMsgImapMailFolder*&gt;(this));</span>
<a href="#l52.186"></a><span id="l52.186">         m_downloadingFolderForOfflineUse = PR_FALSE;</span>
<a href="#l52.187"></a><span id="l52.187">       }</span>
<a href="#l52.188"></a><span id="l52.188" class="difflineminus">-    }</span>
<a href="#l52.189"></a><span id="l52.189">     nsCOMPtr&lt;nsIImapUrl&gt; imapUrl(do_QueryInterface(aUrl));</span>
<a href="#l52.190"></a><span id="l52.190">     if (imapUrl)</span>
<a href="#l52.191"></a><span id="l52.191">     {</span>
<a href="#l52.192"></a><span id="l52.192">       nsImapAction imapAction;</span>
<a href="#l52.193"></a><span id="l52.193">       imapUrl-&gt;GetImapAction(&amp;imapAction);</span>
<a href="#l52.194"></a><span id="l52.194">       // if the server doesn't support copyUID, then SetCopyResponseUid won't</span>
<a href="#l52.195"></a><span id="l52.195">       // get called, so we need to clear m_pendingOfflineMoves when the online</span>
<a href="#l52.196"></a><span id="l52.196">       // move operation has finished.</span>
<a href="#l52.197"></a><span id="l52.197" class="difflineat">@@ -7016,16 +7011,17 @@ nsresult nsImapMailFolder::CopyOfflineMs</span>
<a href="#l52.198"></a><span id="l52.198">           break;</span>
<a href="#l52.199"></a><span id="l52.199">         bytesLeft -= bytesRead;</span>
<a href="#l52.200"></a><span id="l52.200">       }</span>
<a href="#l52.201"></a><span id="l52.201">       PR_FREEIF(inputBuffer);</span>
<a href="#l52.202"></a><span id="l52.202">     }</span>
<a href="#l52.203"></a><span id="l52.203">   }</span>
<a href="#l52.204"></a><span id="l52.204">   if (NS_SUCCEEDED(rv))</span>
<a href="#l52.205"></a><span id="l52.205">   {</span>
<a href="#l52.206"></a><span id="l52.206" class="difflineplus">+    outputStream-&gt;Flush();</span>
<a href="#l52.207"></a><span id="l52.207">     PRUint32 resultFlags;</span>
<a href="#l52.208"></a><span id="l52.208">     destHdr-&gt;OrFlags(nsMsgMessageFlags::Offline, &amp;resultFlags);</span>
<a href="#l52.209"></a><span id="l52.209">     destHdr-&gt;SetOfflineMessageSize(messageSize);</span>
<a href="#l52.210"></a><span id="l52.210">   }</span>
<a href="#l52.211"></a><span id="l52.211">   return rv;</span>
<a href="#l52.212"></a><span id="l52.212"> }</span>
<a href="#l52.213"></a><span id="l52.213"> </span>
<a href="#l52.214"></a><span id="l52.214"> nsresult nsImapMailFolder::FindOpenRange(nsMsgKey &amp;fakeBase, PRUint32 srcCount)</span>
<a href="#l52.215"></a><span id="l52.215" class="difflineat">@@ -7118,36 +7114,33 @@ nsresult nsImapMailFolder::CopyMessagesO</span>
<a href="#l52.216"></a><span id="l52.216">       // end notifications to be sent.</span>
<a href="#l52.217"></a><span id="l52.217">       // We don't need to acquire the semaphor since this is synchronous</span>
<a href="#l52.218"></a><span id="l52.218">       // on the UI thread but we should check if the offline store is locked.</span>
<a href="#l52.219"></a><span id="l52.219">       bool isLocked;</span>
<a href="#l52.220"></a><span id="l52.220">       GetLocked(&amp;isLocked);</span>
<a href="#l52.221"></a><span id="l52.221">       nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l52.222"></a><span id="l52.222">       nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l52.223"></a><span id="l52.223">       // only need the output stream if we got an input stream.</span>
<a href="#l52.224"></a><span id="l52.224" class="difflineminus">-      if (NS_SUCCEEDED(srcFolder-&gt;GetOfflineStoreInputStream(</span>
<a href="#l52.225"></a><span id="l52.225" class="difflineminus">-                                    getter_AddRefs(inputStream))) &amp;&amp; !isLocked)</span>
<a href="#l52.226"></a><span id="l52.226" class="difflineminus">-        rv = GetOfflineStoreOutputStream(getter_AddRefs(outputStream));</span>
<a href="#l52.227"></a><span id="l52.227" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.228"></a><span id="l52.228" class="difflineplus">+      srcFolder-&gt;GetOfflineStoreInputStream(getter_AddRefs(inputStream));</span>
<a href="#l52.229"></a><span id="l52.229"> </span>
<a href="#l52.230"></a><span id="l52.230">       nsCString messageId;</span>
<a href="#l52.231"></a><span id="l52.231">       // put fake message in destination db, delete source if move</span>
<a href="#l52.232"></a><span id="l52.232">       for (PRUint32 sourceKeyIndex = 0; !stopit &amp;&amp; (sourceKeyIndex &lt; srcCount); sourceKeyIndex++)</span>
<a href="#l52.233"></a><span id="l52.233">       {</span>
<a href="#l52.234"></a><span id="l52.234">         bool messageReturningHome = false;</span>
<a href="#l52.235"></a><span id="l52.235">         nsCString originalSrcFolderURI;</span>
<a href="#l52.236"></a><span id="l52.236">         srcFolder-&gt;GetURI(originalSrcFolderURI);</span>
<a href="#l52.237"></a><span id="l52.237">         nsCOMPtr&lt;nsIMsgDBHdr&gt; message;</span>
<a href="#l52.238"></a><span id="l52.238">         message = do_QueryElementAt(messages, sourceKeyIndex);</span>
<a href="#l52.239"></a><span id="l52.239">         nsMsgKey originalKey;</span>
<a href="#l52.240"></a><span id="l52.240">         if (message)</span>
<a href="#l52.241"></a><span id="l52.241">           rv = message-&gt;GetMessageKey(&amp;originalKey);</span>
<a href="#l52.242"></a><span id="l52.242">         else</span>
<a href="#l52.243"></a><span id="l52.243">         {</span>
<a href="#l52.244"></a><span id="l52.244" class="difflineminus">-          NS_ASSERTION(PR_FALSE, &quot;bad msg in src array&quot;);</span>
<a href="#l52.245"></a><span id="l52.245" class="difflineplus">+          NS_ERROR(&quot;bad msg in src array&quot;);</span>
<a href="#l52.246"></a><span id="l52.246">           continue;</span>
<a href="#l52.247"></a><span id="l52.247">         }</span>
<a href="#l52.248"></a><span id="l52.248">         nsMsgKey msgKey;</span>
<a href="#l52.249"></a><span id="l52.249">         message-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l52.250"></a><span id="l52.250">         messageId.AppendInt(msgKey);</span>
<a href="#l52.251"></a><span id="l52.251">         nsCOMPtr &lt;nsIMsgOfflineImapOperation&gt; sourceOp;</span>
<a href="#l52.252"></a><span id="l52.252">         rv = sourceMailDB-&gt;GetOfflineOpForKey(originalKey, PR_TRUE, getter_AddRefs(sourceOp));</span>
<a href="#l52.253"></a><span id="l52.253">         if (NS_SUCCEEDED(rv) &amp;&amp; sourceOp)</span>
<a href="#l52.254"></a><span id="l52.254" class="difflineat">@@ -7258,18 +7251,28 @@ nsresult nsImapMailFolder::CopyMessagesO</span>
<a href="#l52.255"></a><span id="l52.255">           {</span>
<a href="#l52.256"></a><span id="l52.256">             bool hasMsgOffline = false;</span>
<a href="#l52.257"></a><span id="l52.257"> </span>
<a href="#l52.258"></a><span id="l52.258">             destMsgHdrs-&gt;AppendElement(newMailHdr, PR_FALSE);</span>
<a href="#l52.259"></a><span id="l52.259">             srcFolder-&gt;HasMsgOffline(originalKey, &amp;hasMsgOffline);</span>
<a href="#l52.260"></a><span id="l52.260">             newMailHdr-&gt;SetUint32Property(&quot;pseudoHdr&quot;, 1);</span>
<a href="#l52.261"></a><span id="l52.261"> </span>
<a href="#l52.262"></a><span id="l52.262">             if (inputStream &amp;&amp; hasMsgOffline &amp;&amp; !isLocked)</span>
<a href="#l52.263"></a><span id="l52.263" class="difflineplus">+            {</span>
<a href="#l52.264"></a><span id="l52.264" class="difflineplus">+              rv = GetOfflineStoreOutputStream(newMailHdr,</span>
<a href="#l52.265"></a><span id="l52.265" class="difflineplus">+                                               getter_AddRefs(outputStream));</span>
<a href="#l52.266"></a><span id="l52.266" class="difflineplus">+              NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.267"></a><span id="l52.267" class="difflineplus">+</span>
<a href="#l52.268"></a><span id="l52.268">               CopyOfflineMsgBody(srcFolder, newMailHdr, mailHdr, inputStream,</span>
<a href="#l52.269"></a><span id="l52.269">                                  outputStream);</span>
<a href="#l52.270"></a><span id="l52.270" class="difflineplus">+              nsCOMPtr&lt;nsIMsgPluggableStore&gt; offlineStore;</span>
<a href="#l52.271"></a><span id="l52.271" class="difflineplus">+              (void) GetMsgStore(getter_AddRefs(offlineStore));</span>
<a href="#l52.272"></a><span id="l52.272" class="difflineplus">+              if (offlineStore)</span>
<a href="#l52.273"></a><span id="l52.273" class="difflineplus">+                offlineStore-&gt;FinishNewMessage(outputStream, newMailHdr);</span>
<a href="#l52.274"></a><span id="l52.274" class="difflineplus">+            }</span>
<a href="#l52.275"></a><span id="l52.275">             else</span>
<a href="#l52.276"></a><span id="l52.276">               mDatabase-&gt;MarkOffline(fakeBase + sourceKeyIndex, PR_FALSE, nsnull);</span>
<a href="#l52.277"></a><span id="l52.277"> </span>
<a href="#l52.278"></a><span id="l52.278">             nsCOMPtr &lt;nsIMsgOfflineImapOperation&gt; destOp;</span>
<a href="#l52.279"></a><span id="l52.279">             mDatabase-&gt;GetOfflineOpForKey(fakeBase + sourceKeyIndex, PR_TRUE, getter_AddRefs(destOp));</span>
<a href="#l52.280"></a><span id="l52.280">             if (destOp)</span>
<a href="#l52.281"></a><span id="l52.281">             {</span>
<a href="#l52.282"></a><span id="l52.282">               // check if this is a move back to the original mailbox, in which case</span>
<a href="#l52.283"></a><span id="l52.283" class="difflineat">@@ -7457,23 +7460,30 @@ void nsImapMailFolder::SetPendingAttribu</span>
<a href="#l52.284"></a><span id="l52.284"> </span>
<a href="#l52.285"></a><span id="l52.285">         nsCString sourceString;</span>
<a href="#l52.286"></a><span id="l52.286">         msgDBHdr-&gt;GetStringProperty(property.get(), getter_Copies(sourceString));</span>
<a href="#l52.287"></a><span id="l52.287">         mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, property.get(), sourceString.get());</span>
<a href="#l52.288"></a><span id="l52.288">       }</span>
<a href="#l52.289"></a><span id="l52.289"> </span>
<a href="#l52.290"></a><span id="l52.290">       PRUint32 messageSize;</span>
<a href="#l52.291"></a><span id="l52.291">       PRUint64 messageOffset;</span>
<a href="#l52.292"></a><span id="l52.292" class="difflineplus">+      nsCString storeToken;</span>
<a href="#l52.293"></a><span id="l52.293">       msgDBHdr-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l52.294"></a><span id="l52.294">       msgDBHdr-&gt;GetOfflineMessageSize(&amp;messageSize);</span>
<a href="#l52.295"></a><span id="l52.295" class="difflineplus">+      msgDBHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(storeToken));</span>
<a href="#l52.296"></a><span id="l52.296">       if (messageSize)</span>
<a href="#l52.297"></a><span id="l52.297">       {</span>
<a href="#l52.298"></a><span id="l52.298" class="difflineminus">-        mDatabase-&gt;SetUint32AttributeOnPendingHdr(msgDBHdr, &quot;offlineMsgSize&quot;, messageSize);</span>
<a href="#l52.299"></a><span id="l52.299" class="difflineminus">-        mDatabase-&gt;SetUint64AttributeOnPendingHdr(msgDBHdr, &quot;msgOffset&quot;, messageOffset);</span>
<a href="#l52.300"></a><span id="l52.300" class="difflineminus">-        mDatabase-&gt;SetUint32AttributeOnPendingHdr(msgDBHdr, &quot;flags&quot;, nsMsgMessageFlags::Offline);</span>
<a href="#l52.301"></a><span id="l52.301" class="difflineplus">+        mDatabase-&gt;SetUint32AttributeOnPendingHdr(msgDBHdr, &quot;offlineMsgSize&quot;,</span>
<a href="#l52.302"></a><span id="l52.302" class="difflineplus">+                                                  messageSize);</span>
<a href="#l52.303"></a><span id="l52.303" class="difflineplus">+        mDatabase-&gt;SetUint64AttributeOnPendingHdr(msgDBHdr, &quot;msgOffset&quot;,</span>
<a href="#l52.304"></a><span id="l52.304" class="difflineplus">+                                                  messageOffset);</span>
<a href="#l52.305"></a><span id="l52.305" class="difflineplus">+        mDatabase-&gt;SetUint32AttributeOnPendingHdr(msgDBHdr, &quot;flags&quot;,</span>
<a href="#l52.306"></a><span id="l52.306" class="difflineplus">+                                                  nsMsgMessageFlags::Offline);</span>
<a href="#l52.307"></a><span id="l52.307" class="difflineplus">+        mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, &quot;storeToken&quot;,</span>
<a href="#l52.308"></a><span id="l52.308" class="difflineplus">+                                            storeToken.get());</span>
<a href="#l52.309"></a><span id="l52.309">       }</span>
<a href="#l52.310"></a><span id="l52.310">       nsMsgPriorityValue priority;</span>
<a href="#l52.311"></a><span id="l52.311">       msgDBHdr-&gt;GetPriority(&amp;priority);</span>
<a href="#l52.312"></a><span id="l52.312">       if(priority != 0)</span>
<a href="#l52.313"></a><span id="l52.313">       {</span>
<a href="#l52.314"></a><span id="l52.314">         nsCAutoString priorityStr;</span>
<a href="#l52.315"></a><span id="l52.315">         priorityStr.AppendInt(priority);</span>
<a href="#l52.316"></a><span id="l52.316">         mDatabase-&gt;SetAttributeOnPendingHdr(msgDBHdr, &quot;priority&quot;, priorityStr.get());</span>
<a href="#l52.317"></a><span id="l52.317" class="difflineat">@@ -8255,18 +8265,21 @@ nsImapMailFolder::CopyFileToOfflineStore</span>
<a href="#l52.318"></a><span id="l52.318">     nsCOMPtr&lt;nsIMsgOfflineImapOperation&gt; op;</span>
<a href="#l52.319"></a><span id="l52.319">     rv = mDatabase-&gt;GetOfflineOpForKey(msgKey, PR_TRUE, getter_AddRefs(op));</span>
<a href="#l52.320"></a><span id="l52.320">     if (NS_SUCCEEDED(rv) &amp;&amp; op)</span>
<a href="#l52.321"></a><span id="l52.321">     {</span>
<a href="#l52.322"></a><span id="l52.322">       nsCString destFolderUri;</span>
<a href="#l52.323"></a><span id="l52.323">       GetURI(destFolderUri);</span>
<a href="#l52.324"></a><span id="l52.324">       op-&gt;SetOperation(nsIMsgOfflineImapOperation::kMoveResult);</span>
<a href="#l52.325"></a><span id="l52.325">       op-&gt;SetDestinationFolderURI(destFolderUri.get());</span>
<a href="#l52.326"></a><span id="l52.326" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; fakeHdr;</span>
<a href="#l52.327"></a><span id="l52.327">       nsCOMPtr&lt;nsIOutputStream&gt; offlineStore;</span>
<a href="#l52.328"></a><span id="l52.328" class="difflineminus">-      rv = GetOfflineStoreOutputStream(getter_AddRefs(offlineStore));</span>
<a href="#l52.329"></a><span id="l52.329" class="difflineplus">+      rv = mDatabase-&gt;CreateNewHdr(msgKey, getter_AddRefs(fakeHdr));</span>
<a href="#l52.330"></a><span id="l52.330" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l52.331"></a><span id="l52.331" class="difflineplus">+      rv = GetOfflineStoreOutputStream(fakeHdr, getter_AddRefs(offlineStore));</span>
<a href="#l52.332"></a><span id="l52.332">       SetFlag(nsMsgFolderFlags::OfflineEvents);</span>
<a href="#l52.333"></a><span id="l52.333"> </span>
<a href="#l52.334"></a><span id="l52.334">       if (NS_SUCCEEDED(rv) &amp;&amp; offlineStore)</span>
<a href="#l52.335"></a><span id="l52.335">       {</span>
<a href="#l52.336"></a><span id="l52.336">         PRInt64 curOfflineStorePos = 0;</span>
<a href="#l52.337"></a><span id="l52.337">         nsCOMPtr&lt;nsISeekableStream&gt; seekable = do_QueryInterface(offlineStore);</span>
<a href="#l52.338"></a><span id="l52.338">         if (seekable)</span>
<a href="#l52.339"></a><span id="l52.339">           seekable-&gt;Tell(&amp;curOfflineStorePos);</span>
<a href="#l52.340"></a><span id="l52.340" class="difflineat">@@ -8288,18 +8301,17 @@ nsImapMailFolder::CopyFileToOfflineStore</span>
<a href="#l52.341"></a><span id="l52.341">           PRInt32 inputBufferSize = 10240;</span>
<a href="#l52.342"></a><span id="l52.342">           nsMsgLineStreamBuffer *inputStreamBuffer =</span>
<a href="#l52.343"></a><span id="l52.343">             new nsMsgLineStreamBuffer(inputBufferSize, PR_TRUE, PR_FALSE);</span>
<a href="#l52.344"></a><span id="l52.344">           PRInt64 fileSize;</span>
<a href="#l52.345"></a><span id="l52.345">           srcFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l52.346"></a><span id="l52.346">           PRUint32 bytesWritten;</span>
<a href="#l52.347"></a><span id="l52.347">           rv = NS_OK;</span>
<a href="#l52.348"></a><span id="l52.348">           msgParser-&gt;SetState(nsIMsgParseMailMsgState::ParseHeadersState);</span>
<a href="#l52.349"></a><span id="l52.349" class="difflineminus">-          // set the env pos to fake key so the msg hdr will have that for a key</span>
<a href="#l52.350"></a><span id="l52.350" class="difflineminus">-          msgParser-&gt;SetEnvelopePos(msgKey);</span>
<a href="#l52.351"></a><span id="l52.351" class="difflineplus">+          msgParser-&gt;SetNewMsgHdr(fakeHdr);</span>
<a href="#l52.352"></a><span id="l52.352">           bool needMoreData = false;</span>
<a href="#l52.353"></a><span id="l52.353">           char * newLine = nsnull;</span>
<a href="#l52.354"></a><span id="l52.354">           PRUint32 numBytesInLine = 0;</span>
<a href="#l52.355"></a><span id="l52.355">           const char *envelope = &quot;From &quot;CRLF;</span>
<a href="#l52.356"></a><span id="l52.356">           offlineStore-&gt;Write(envelope, strlen(envelope), &amp;bytesWritten);</span>
<a href="#l52.357"></a><span id="l52.357">           fileSize += bytesWritten;</span>
<a href="#l52.358"></a><span id="l52.358">           do</span>
<a href="#l52.359"></a><span id="l52.359">           {</span>
<a href="#l52.360"></a><span id="l52.360" class="difflineat">@@ -8307,43 +8319,43 @@ nsImapMailFolder::CopyFileToOfflineStore</span>
<a href="#l52.361"></a><span id="l52.361">             if (newLine)</span>
<a href="#l52.362"></a><span id="l52.362">             {</span>
<a href="#l52.363"></a><span id="l52.363">               msgParser-&gt;ParseAFolderLine(newLine, numBytesInLine);</span>
<a href="#l52.364"></a><span id="l52.364">               rv = offlineStore-&gt;Write(newLine, numBytesInLine, &amp;bytesWritten);</span>
<a href="#l52.365"></a><span id="l52.365">               NS_Free(newLine);</span>
<a href="#l52.366"></a><span id="l52.366">             }</span>
<a href="#l52.367"></a><span id="l52.367">           } while (newLine);</span>
<a href="#l52.368"></a><span id="l52.368"> </span>
<a href="#l52.369"></a><span id="l52.369" class="difflineminus">-          nsCOMPtr&lt;nsIMsgDBHdr&gt; fakeHdr;</span>
<a href="#l52.370"></a><span id="l52.370">           msgParser-&gt;FinishHeader();</span>
<a href="#l52.371"></a><span id="l52.371" class="difflineminus">-          msgParser-&gt;GetNewMsgHdr(getter_AddRefs(fakeHdr));</span>
<a href="#l52.372"></a><span id="l52.372" class="difflineminus">-          if (fakeHdr)</span>
<a href="#l52.373"></a><span id="l52.373" class="difflineminus">-          {</span>
<a href="#l52.374"></a><span id="l52.374" class="difflineminus">-            if (NS_SUCCEEDED(rv) &amp;&amp; fakeHdr)</span>
<a href="#l52.375"></a><span id="l52.375" class="difflineminus">-            {</span>
<a href="#l52.376"></a><span id="l52.376" class="difflineminus">-              PRUint32 resultFlags;</span>
<a href="#l52.377"></a><span id="l52.377" class="difflineminus">-              fakeHdr-&gt;SetMessageOffset(curOfflineStorePos);</span>
<a href="#l52.378"></a><span id="l52.378" class="difflineminus">-              fakeHdr-&gt;OrFlags(nsMsgMessageFlags::Offline | nsMsgMessageFlags::Read, &amp;resultFlags);</span>
<a href="#l52.379"></a><span id="l52.379" class="difflineminus">-              fakeHdr-&gt;SetOfflineMessageSize(fileSize);</span>
<a href="#l52.380"></a><span id="l52.380" class="difflineminus">-              fakeHdr-&gt;SetUint32Property(&quot;pseudoHdr&quot;, 1);</span>
<a href="#l52.381"></a><span id="l52.381" class="difflineminus">-              mDatabase-&gt;AddNewHdrToDB(fakeHdr, PR_TRUE /* notify */);</span>
<a href="#l52.382"></a><span id="l52.382" class="difflineminus">-              SetFlag(nsMsgFolderFlags::OfflineEvents);</span>
<a href="#l52.383"></a><span id="l52.383" class="difflineminus">-              messages-&gt;AppendElement(fakeHdr, PR_FALSE);</span>
<a href="#l52.384"></a><span id="l52.384" class="difflineminus">-              SetPendingAttributes(messages, PR_FALSE);</span>
<a href="#l52.385"></a><span id="l52.385" class="difflineminus">-              // Gloda needs this notification to index the fake message.</span>
<a href="#l52.386"></a><span id="l52.386" class="difflineminus">-              nsCOMPtr&lt;nsIMsgFolderNotificationService&gt;</span>
<a href="#l52.387"></a><span id="l52.387" class="difflineminus">-                notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l52.388"></a><span id="l52.388" class="difflineminus">-              if (notifier)</span>
<a href="#l52.389"></a><span id="l52.389" class="difflineminus">-                notifier-&gt;NotifyMsgsClassified(messages, PR_FALSE, PR_FALSE);</span>
<a href="#l52.390"></a><span id="l52.390" class="difflineminus">-            }</span>
<a href="#l52.391"></a><span id="l52.391" class="difflineminus">-          }</span>
<a href="#l52.392"></a><span id="l52.392" class="difflineplus">+          PRUint32 resultFlags;</span>
<a href="#l52.393"></a><span id="l52.393" class="difflineplus">+          fakeHdr-&gt;SetMessageOffset(curOfflineStorePos);</span>
<a href="#l52.394"></a><span id="l52.394" class="difflineplus">+          char storeToken[100];</span>
<a href="#l52.395"></a><span id="l52.395" class="difflineplus">+          PR_snprintf(storeToken, sizeof(storeToken), &quot;%lld&quot;, curOfflineStorePos);</span>
<a href="#l52.396"></a><span id="l52.396" class="difflineplus">+          fakeHdr-&gt;SetStringProperty(&quot;storeToken&quot;, storeToken);</span>
<a href="#l52.397"></a><span id="l52.397" class="difflineplus">+          fakeHdr-&gt;OrFlags(nsMsgMessageFlags::Offline | nsMsgMessageFlags::Read, &amp;resultFlags);</span>
<a href="#l52.398"></a><span id="l52.398" class="difflineplus">+          fakeHdr-&gt;SetOfflineMessageSize(fileSize);</span>
<a href="#l52.399"></a><span id="l52.399" class="difflineplus">+          fakeHdr-&gt;SetUint32Property(&quot;pseudoHdr&quot;, 1);</span>
<a href="#l52.400"></a><span id="l52.400" class="difflineplus">+          mDatabase-&gt;AddNewHdrToDB(fakeHdr, true /* notify */);</span>
<a href="#l52.401"></a><span id="l52.401" class="difflineplus">+          SetFlag(nsMsgFolderFlags::OfflineEvents);</span>
<a href="#l52.402"></a><span id="l52.402" class="difflineplus">+          messages-&gt;AppendElement(fakeHdr, false);</span>
<a href="#l52.403"></a><span id="l52.403" class="difflineplus">+          SetPendingAttributes(messages, false);</span>
<a href="#l52.404"></a><span id="l52.404" class="difflineplus">+          // Gloda needs this notification to index the fake message.</span>
<a href="#l52.405"></a><span id="l52.405" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolderNotificationService&gt;</span>
<a href="#l52.406"></a><span id="l52.406" class="difflineplus">+            notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l52.407"></a><span id="l52.407" class="difflineplus">+          if (notifier)</span>
<a href="#l52.408"></a><span id="l52.408" class="difflineplus">+            notifier-&gt;NotifyMsgsClassified(messages, false, false);</span>
<a href="#l52.409"></a><span id="l52.409">           inputStream-&gt;Close();</span>
<a href="#l52.410"></a><span id="l52.410">           inputStream = nsnull;</span>
<a href="#l52.411"></a><span id="l52.411">           delete inputStreamBuffer;</span>
<a href="#l52.412"></a><span id="l52.412" class="difflineplus">+          nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l52.413"></a><span id="l52.413" class="difflineplus">+          GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l52.414"></a><span id="l52.414" class="difflineplus">+          if (msgStore)</span>
<a href="#l52.415"></a><span id="l52.415" class="difflineplus">+            msgStore-&gt;FinishNewMessage(offlineStore, fakeHdr);</span>
<a href="#l52.416"></a><span id="l52.416">         }</span>
<a href="#l52.417"></a><span id="l52.417" class="difflineplus">+        offlineStore-&gt;Close();</span>
<a href="#l52.418"></a><span id="l52.418">       }</span>
<a href="#l52.419"></a><span id="l52.419">     }</span>
<a href="#l52.420"></a><span id="l52.420">   }</span>
<a href="#l52.421"></a><span id="l52.421">   return rv;</span>
<a href="#l52.422"></a><span id="l52.422"> }</span>
<a href="#l52.423"></a><span id="l52.423"> </span>
<a href="#l52.424"></a><span id="l52.424"> nsresult</span>
<a href="#l52.425"></a><span id="l52.425"> nsImapMailFolder::OnCopyCompleted(nsISupports *srcSupport, nsresult rv)</span>
<a href="#l52.426"></a><span id="l52.426" class="difflineat">@@ -8664,17 +8676,18 @@ NS_IMETHODIMP nsImapMailFolder::RenameCl</span>
<a href="#l52.427"></a><span id="l52.427">   nsCOMPtr&lt;nsIMsgDatabase&gt; unusedDB;</span>
<a href="#l52.428"></a><span id="l52.428">   nsCOMPtr &lt;nsILocalFile&gt; dbFile;</span>
<a href="#l52.429"></a><span id="l52.429"> </span>
<a href="#l52.430"></a><span id="l52.430">   // warning, path will be changed</span>
<a href="#l52.431"></a><span id="l52.431">   rv = CreateFileForDB(newLeafName, pathFile, getter_AddRefs(dbFile));</span>
<a href="#l52.432"></a><span id="l52.432">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l52.433"></a><span id="l52.433"> </span>
<a href="#l52.434"></a><span id="l52.434">   // Use openMailDBFromFile() and not OpenFolderDB() here, since we don't use the DB.</span>
<a href="#l52.435"></a><span id="l52.435" class="difflineminus">-  rv = msgDBService-&gt;OpenMailDBFromFile(dbFile, PR_TRUE, PR_TRUE, (nsIMsgDatabase **) getter_AddRefs(unusedDB));</span>
<a href="#l52.436"></a><span id="l52.436" class="difflineplus">+  rv = msgDBService-&gt;OpenMailDBFromFile(dbFile, nsnull, PR_TRUE, PR_TRUE,</span>
<a href="#l52.437"></a><span id="l52.437" class="difflineplus">+                                        getter_AddRefs(unusedDB));</span>
<a href="#l52.438"></a><span id="l52.438">   if (NS_SUCCEEDED(rv) &amp;&amp; unusedDB)</span>
<a href="#l52.439"></a><span id="l52.439">   {</span>
<a href="#l52.440"></a><span id="l52.440">     //need to set the folder name</span>
<a href="#l52.441"></a><span id="l52.441">     nsCOMPtr &lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l52.442"></a><span id="l52.442">     rv = unusedDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l52.443"></a><span id="l52.443"> </span>
<a href="#l52.444"></a><span id="l52.444">     //Now let's create the actual new folder</span>
<a href="#l52.445"></a><span id="l52.445">     rv = AddSubfolderWithPath(folderNameStr, dbFile, getter_AddRefs(child));</span>
<a href="#l52.446"></a><span id="l52.446" class="difflineat">@@ -9243,17 +9256,17 @@ NS_IMETHODIMP nsImapMailFolder::FetchMsg</span>
<a href="#l52.447"></a><span id="l52.447">     else // lets look in the offline store</span>
<a href="#l52.448"></a><span id="l52.448">     {</span>
<a href="#l52.449"></a><span id="l52.449">       PRUint32 msgFlags;</span>
<a href="#l52.450"></a><span id="l52.450">       msgHdr-&gt;GetFlags(&amp;msgFlags);</span>
<a href="#l52.451"></a><span id="l52.451">       nsMsgKey msgKey;</span>
<a href="#l52.452"></a><span id="l52.452">       msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l52.453"></a><span id="l52.453">       if (msgFlags &amp; nsMsgMessageFlags::Offline)</span>
<a href="#l52.454"></a><span id="l52.454">       {</span>
<a href="#l52.455"></a><span id="l52.455" class="difflineminus">-        PRUint64 messageOffset;</span>
<a href="#l52.456"></a><span id="l52.456" class="difflineplus">+        PRInt64 messageOffset;</span>
<a href="#l52.457"></a><span id="l52.457">         PRUint32 messageSize;</span>
<a href="#l52.458"></a><span id="l52.458">         GetOfflineFileStream(msgKey, &amp;messageOffset, &amp;messageSize, getter_AddRefs(inputStream));</span>
<a href="#l52.459"></a><span id="l52.459">         if (inputStream)</span>
<a href="#l52.460"></a><span id="l52.460">           rv = GetMsgPreviewTextFromStream(msgHdr, inputStream);</span>
<a href="#l52.461"></a><span id="l52.461">       }</span>
<a href="#l52.462"></a><span id="l52.462">       else if (!aLocalOnly)</span>
<a href="#l52.463"></a><span id="l52.463">         keysToFetchFromServer.AppendElement(msgKey);</span>
<a href="#l52.464"></a><span id="l52.464">     }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l53.1"></a><span id="l53.1" class="difflineminus">--- a/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l53.2"></a><span id="l53.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapProtocol.cpp</span>
<a href="#l53.3"></a><span id="l53.3" class="difflineat">@@ -5982,16 +5982,17 @@ void nsImapProtocol::UploadMessageFromFi</span>
<a href="#l53.4"></a><span id="l53.4"> </span>
<a href="#l53.5"></a><span id="l53.5">       command.Append(dateStr);</span>
<a href="#l53.6"></a><span id="l53.6">     }</span>
<a href="#l53.7"></a><span id="l53.7">     command.Append(&quot; {&quot;);</span>
<a href="#l53.8"></a><span id="l53.8"> </span>
<a href="#l53.9"></a><span id="l53.9">     dataBuffer = (char*) PR_CALLOC(COPY_BUFFER_SIZE+1);</span>
<a href="#l53.10"></a><span id="l53.10">     if (!dataBuffer) goto done;</span>
<a href="#l53.11"></a><span id="l53.11">     rv = file-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l53.12"></a><span id="l53.12" class="difflineplus">+    NS_ASSERTION(fileSize, &quot;got empty file in UploadMessageFromFile&quot;);</span>
<a href="#l53.13"></a><span id="l53.13">     if (NS_FAILED(rv) || !fileSize) goto done;</span>
<a href="#l53.14"></a><span id="l53.14">     nsCOMPtr &lt;nsILocalFile&gt; localFile = do_QueryInterface(file);</span>
<a href="#l53.15"></a><span id="l53.15">     rv = NS_NewLocalFileInputStream(getter_AddRefs(fileInputStream), localFile);</span>
<a href="#l53.16"></a><span id="l53.16">     if (NS_FAILED(rv) || !fileInputStream) goto done;</span>
<a href="#l53.17"></a><span id="l53.17">     command.AppendInt((PRInt32)fileSize);</span>
<a href="#l53.18"></a><span id="l53.18">     if (hasLiteralPlus)</span>
<a href="#l53.19"></a><span id="l53.19">       command.Append(&quot;+}&quot; CRLF);</span>
<a href="#l53.20"></a><span id="l53.20">     else</span>
<a href="#l53.21"></a><span id="l53.21" class="difflineat">@@ -9176,17 +9177,17 @@ bool nsImapMockChannel::ReadFromLocalCac</span>
<a href="#l53.22"></a><span id="l53.22">     nsCOMPtr &lt;nsIMsgFolder&gt; folder;</span>
<a href="#l53.23"></a><span id="l53.23">     rv = mailnewsUrl-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l53.24"></a><span id="l53.24">     if (folder &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l53.25"></a><span id="l53.25">     {</span>
<a href="#l53.26"></a><span id="l53.26">       // we want to create a file channel and read the msg from there.</span>
<a href="#l53.27"></a><span id="l53.27">       nsCOMPtr&lt;nsIInputStream&gt; fileStream;</span>
<a href="#l53.28"></a><span id="l53.28">       nsMsgKey msgKey = strtoul(messageIdString.get(), nsnull, 10);</span>
<a href="#l53.29"></a><span id="l53.29">       PRUint32 size;</span>
<a href="#l53.30"></a><span id="l53.30" class="difflineminus">-      PRUint64 offset;</span>
<a href="#l53.31"></a><span id="l53.31" class="difflineplus">+      PRInt64 offset;</span>
<a href="#l53.32"></a><span id="l53.32">       rv = folder-&gt;GetOfflineFileStream(msgKey, &amp;offset, &amp;size, getter_AddRefs(fileStream));</span>
<a href="#l53.33"></a><span id="l53.33">       // get the file channel from the folder, somehow (through the message or</span>
<a href="#l53.34"></a><span id="l53.34">       // folder sink?) We also need to set the transfer offset to the message offset</span>
<a href="#l53.35"></a><span id="l53.35">       if (fileStream &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l53.36"></a><span id="l53.36">       {</span>
<a href="#l53.37"></a><span id="l53.37">         // dougt - This may break the ablity to &quot;cancel&quot; a read from offline mail reading.</span>
<a href="#l53.38"></a><span id="l53.38">         // fileChannel-&gt;SetLoadGroup(m_loadGroup);</span>
<a href="#l53.39"></a><span id="l53.39">         nsImapCacheStreamListener * cacheListener = new nsImapCacheStreamListener();</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l54.1"></a><span id="l54.1" class="difflineminus">--- a/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l54.2"></a><span id="l54.2" class="difflineplus">+++ b/mailnews/imap/src/nsImapService.cpp</span>
<a href="#l54.3"></a><span id="l54.3" class="difflineat">@@ -95,16 +95,17 @@</span>
<a href="#l54.4"></a><span id="l54.4"> #include &quot;nsIWindowWatcher.h&quot;</span>
<a href="#l54.5"></a><span id="l54.5"> #include &quot;nsImapProtocol.h&quot;</span>
<a href="#l54.6"></a><span id="l54.6"> #include &quot;nsIMsgMailSession.h&quot;</span>
<a href="#l54.7"></a><span id="l54.7"> #include &quot;nsIStreamConverterService.h&quot;</span>
<a href="#l54.8"></a><span id="l54.8"> #include &quot;nsIAutoSyncManager.h&quot;</span>
<a href="#l54.9"></a><span id="l54.9"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l54.10"></a><span id="l54.10"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l54.11"></a><span id="l54.11"> #include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l54.12"></a><span id="l54.12" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l54.13"></a><span id="l54.13"> </span>
<a href="#l54.14"></a><span id="l54.14"> #define PREF_MAIL_ROOT_IMAP &quot;mail.root.imap&quot;            // old - for backward compatibility only</span>
<a href="#l54.15"></a><span id="l54.15"> #define PREF_MAIL_ROOT_IMAP_REL &quot;mail.root.imap-rel&quot;</span>
<a href="#l54.16"></a><span id="l54.16"> </span>
<a href="#l54.17"></a><span id="l54.17"> static NS_DEFINE_CID(kImapUrlCID, NS_IMAPURL_CID);</span>
<a href="#l54.18"></a><span id="l54.18"> static NS_DEFINE_CID(kCImapMockChannel, NS_IMAPMOCKCHANNEL_CID);</span>
<a href="#l54.19"></a><span id="l54.19"> static NS_DEFINE_CID(kCacheServiceCID, NS_CACHESERVICE_CID);</span>
<a href="#l54.20"></a><span id="l54.20"> </span>
<a href="#l54.21"></a><span id="l54.21" class="difflineat">@@ -1265,17 +1266,17 @@ NS_IMETHODIMP nsImapService::StreamHeade</span>
<a href="#l54.22"></a><span id="l54.22">   rv = nsParseImapMessageURI(aMessageURI, folderURI, &amp;key, getter_Copies(mimePart));</span>
<a href="#l54.23"></a><span id="l54.23">   if (NS_SUCCEEDED(rv))</span>
<a href="#l54.24"></a><span id="l54.24">   {</span>
<a href="#l54.25"></a><span id="l54.25">     nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l54.26"></a><span id="l54.26">     bool hasMsgOffline = false;</span>
<a href="#l54.27"></a><span id="l54.27">     folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l54.28"></a><span id="l54.28">     if (hasMsgOffline)</span>
<a href="#l54.29"></a><span id="l54.29">     {</span>
<a href="#l54.30"></a><span id="l54.30" class="difflineminus">-      PRUint64 messageOffset;</span>
<a href="#l54.31"></a><span id="l54.31" class="difflineplus">+      PRInt64 messageOffset;</span>
<a href="#l54.32"></a><span id="l54.32">       PRUint32 messageSize;</span>
<a href="#l54.33"></a><span id="l54.33">       folder-&gt;GetOfflineFileStream(key, &amp;messageOffset, &amp;messageSize, getter_AddRefs(inputStream));</span>
<a href="#l54.34"></a><span id="l54.34">       if (inputStream)</span>
<a href="#l54.35"></a><span id="l54.35">         return MsgStreamMsgHeaders(inputStream, aConsumer);</span>
<a href="#l54.36"></a><span id="l54.36">     }</span>
<a href="#l54.37"></a><span id="l54.37">     nsCOMPtr&lt;nsIImapUrl&gt; imapUrl;</span>
<a href="#l54.38"></a><span id="l54.38">     nsCAutoString urlSpec;</span>
<a href="#l54.39"></a><span id="l54.39">     char hierarchyDelimiter = GetHierarchyDelimiter(folder);</span>
<a href="#l54.40"></a><span id="l54.40" class="difflineat">@@ -2091,27 +2092,36 @@ nsresult nsImapService::OfflineAppendFro</span>
<a href="#l54.41"></a><span id="l54.41">     rv = destDB-&gt;GetOfflineOpForKey(fakeKey, PR_TRUE, getter_AddRefs(op));</span>
<a href="#l54.42"></a><span id="l54.42">     if (NS_SUCCEEDED(rv) &amp;&amp; op)</span>
<a href="#l54.43"></a><span id="l54.43">     {</span>
<a href="#l54.44"></a><span id="l54.44">       nsCString destFolderUri;</span>
<a href="#l54.45"></a><span id="l54.45">       aDstFolder-&gt;GetURI(destFolderUri);</span>
<a href="#l54.46"></a><span id="l54.46">       op-&gt;SetOperation(nsIMsgOfflineImapOperation::kAppendDraft); // ### do we care if it's a template?</span>
<a href="#l54.47"></a><span id="l54.47">       op-&gt;SetDestinationFolderURI(destFolderUri.get());</span>
<a href="#l54.48"></a><span id="l54.48">       nsCOMPtr &lt;nsIOutputStream&gt; offlineStore;</span>
<a href="#l54.49"></a><span id="l54.49" class="difflineminus">-      rv = aDstFolder-&gt;GetOfflineStoreOutputStream(getter_AddRefs(offlineStore));</span>
<a href="#l54.50"></a><span id="l54.50" class="difflineplus">+      nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l54.51"></a><span id="l54.51" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; dstServer;</span>
<a href="#l54.52"></a><span id="l54.52" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; newMsgHdr;</span>
<a href="#l54.53"></a><span id="l54.53" class="difflineplus">+</span>
<a href="#l54.54"></a><span id="l54.54" class="difflineplus">+      aDstFolder-&gt;GetServer(getter_AddRefs(dstServer));</span>
<a href="#l54.55"></a><span id="l54.55" class="difflineplus">+      rv = dstServer-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l54.56"></a><span id="l54.56" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l54.57"></a><span id="l54.57" class="difflineplus">+      bool reusable;</span>
<a href="#l54.58"></a><span id="l54.58" class="difflineplus">+      msgStore-&gt;GetNewMsgOutputStream(aDstFolder, getter_AddRefs(newMsgHdr),</span>
<a href="#l54.59"></a><span id="l54.59" class="difflineplus">+                                      &amp;reusable, getter_AddRefs(offlineStore));</span>
<a href="#l54.60"></a><span id="l54.60"> </span>
<a href="#l54.61"></a><span id="l54.61">       if (NS_SUCCEEDED(rv) &amp;&amp; offlineStore)</span>
<a href="#l54.62"></a><span id="l54.62">       {</span>
<a href="#l54.63"></a><span id="l54.63">         PRInt64 curOfflineStorePos = 0;</span>
<a href="#l54.64"></a><span id="l54.64">         nsCOMPtr &lt;nsISeekableStream&gt; seekable = do_QueryInterface(offlineStore);</span>
<a href="#l54.65"></a><span id="l54.65">         if (seekable)</span>
<a href="#l54.66"></a><span id="l54.66">           seekable-&gt;Tell(&amp;curOfflineStorePos);</span>
<a href="#l54.67"></a><span id="l54.67">         else</span>
<a href="#l54.68"></a><span id="l54.68">         {</span>
<a href="#l54.69"></a><span id="l54.69" class="difflineminus">-          NS_ASSERTION(PR_FALSE, &quot;needs to be a random store!&quot;);</span>
<a href="#l54.70"></a><span id="l54.70" class="difflineplus">+          NS_ERROR(&quot;needs to be a random store!&quot;);</span>
<a href="#l54.71"></a><span id="l54.71">           return NS_ERROR_FAILURE;</span>
<a href="#l54.72"></a><span id="l54.72">         }</span>
<a href="#l54.73"></a><span id="l54.73"> </span>
<a href="#l54.74"></a><span id="l54.74">         nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l54.75"></a><span id="l54.75">         nsCOMPtr &lt;nsIMsgParseMailMsgState&gt; msgParser = do_CreateInstance(NS_PARSEMAILMSGSTATE_CONTRACTID, &amp;rv);</span>
<a href="#l54.76"></a><span id="l54.76">         msgParser-&gt;SetMailDB(destDB);</span>
<a href="#l54.77"></a><span id="l54.77"> </span>
<a href="#l54.78"></a><span id="l54.78">         nsCOMPtr &lt;nsILocalFile&gt; localFile = do_QueryInterface(aFile);</span>
<a href="#l54.79"></a><span id="l54.79" class="difflineat">@@ -2125,16 +2135,17 @@ nsresult nsImapService::OfflineAppendFro</span>
<a href="#l54.80"></a><span id="l54.80">                                                                                PR_TRUE,    // allocate new lines</span>
<a href="#l54.81"></a><span id="l54.81">                                                                                PR_FALSE);  // leave CRLFs on the returned string</span>
<a href="#l54.82"></a><span id="l54.82">           PRInt64 fileSize;</span>
<a href="#l54.83"></a><span id="l54.83">           aFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l54.84"></a><span id="l54.84">           PRUint32 bytesWritten;</span>
<a href="#l54.85"></a><span id="l54.85">           rv = NS_OK;</span>
<a href="#l54.86"></a><span id="l54.86"> //        rv = inputStream-&gt;Read(inputBuffer, inputBufferSize, &amp;bytesRead);</span>
<a href="#l54.87"></a><span id="l54.87"> //        if (NS_SUCCEEDED(rv) &amp;&amp; bytesRead &gt; 0)</span>
<a href="#l54.88"></a><span id="l54.88" class="difflineplus">+          msgParser-&gt;SetNewMsgHdr(newMsgHdr);</span>
<a href="#l54.89"></a><span id="l54.89">           msgParser-&gt;SetState(nsIMsgParseMailMsgState::ParseHeadersState);</span>
<a href="#l54.90"></a><span id="l54.90">           // set the env pos to fake key so the msg hdr will have that for a key</span>
<a href="#l54.91"></a><span id="l54.91">           msgParser-&gt;SetEnvelopePos(fakeKey);</span>
<a href="#l54.92"></a><span id="l54.92">           bool needMoreData = false;</span>
<a href="#l54.93"></a><span id="l54.93">           char * newLine = nsnull;</span>
<a href="#l54.94"></a><span id="l54.94">           PRUint32 numBytesInLine = 0;</span>
<a href="#l54.95"></a><span id="l54.95">           do</span>
<a href="#l54.96"></a><span id="l54.96">           {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l55.1"></a><span id="l55.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_bccProperty.js</span>
<a href="#l55.2"></a><span id="l55.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_bccProperty.js</span>
<a href="#l55.3"></a><span id="l55.3" class="difflineat">@@ -67,16 +67,17 @@ function run_test()</span>
<a href="#l55.4"></a><span id="l55.4"> var UrlListener = </span>
<a href="#l55.5"></a><span id="l55.5"> {</span>
<a href="#l55.6"></a><span id="l55.6">   OnStartRunningUrl: function(url) { },</span>
<a href="#l55.7"></a><span id="l55.7">   OnStopRunningUrl: function(url, rc)</span>
<a href="#l55.8"></a><span id="l55.8">   {</span>
<a href="#l55.9"></a><span id="l55.9">     // Check for ok status.</span>
<a href="#l55.10"></a><span id="l55.10">     do_check_eq(rc, 0);</span>
<a href="#l55.11"></a><span id="l55.11"> </span>
<a href="#l55.12"></a><span id="l55.12" class="difflineplus">+    dump(&quot;in on stop running url\n&quot;);</span>
<a href="#l55.13"></a><span id="l55.13">     if (!gDownloadedOnce) {</span>
<a href="#l55.14"></a><span id="l55.14">       gDownloadedOnce = true;</span>
<a href="#l55.15"></a><span id="l55.15">       gIMAPInbox.downloadAllForOffline(UrlListener, null);</span>
<a href="#l55.16"></a><span id="l55.16">       return;</span>
<a href="#l55.17"></a><span id="l55.17">     }</span>
<a href="#l55.18"></a><span id="l55.18">     do_timeout(1000, endTest);</span>
<a href="#l55.19"></a><span id="l55.19">   }</span>
<a href="#l55.20"></a><span id="l55.20"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l56.1"></a><span id="l56.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_compactOfflineStore.js</span>
<a href="#l56.2"></a><span id="l56.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_compactOfflineStore.js</span>
<a href="#l56.3"></a><span id="l56.3" class="difflineat">@@ -1,14 +1,17 @@</span>
<a href="#l56.4"></a><span id="l56.4"> /* -*- Mode: Java; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l56.5"></a><span id="l56.5"> /*</span>
<a href="#l56.6"></a><span id="l56.6">  * Test to ensure that compacting offline stores works correctly with imap folders</span>
<a href="#l56.7"></a><span id="l56.7">  * and returns success.</span>
<a href="#l56.8"></a><span id="l56.8">  */</span>
<a href="#l56.9"></a><span id="l56.9"> </span>
<a href="#l56.10"></a><span id="l56.10" class="difflineplus">+Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l56.11"></a><span id="l56.11" class="difflineplus">+                           &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l56.12"></a><span id="l56.12" class="difflineplus">+</span>
<a href="#l56.13"></a><span id="l56.13"> var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l56.14"></a><span id="l56.14"> </span>
<a href="#l56.15"></a><span id="l56.15"> const gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l56.16"></a><span id="l56.16">                        .getService(Ci.nsIMsgMessageService);</span>
<a href="#l56.17"></a><span id="l56.17"> </span>
<a href="#l56.18"></a><span id="l56.18"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l56.19"></a><span id="l56.19"> </span>
<a href="#l56.20"></a><span id="l56.20"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l57.1"></a><span id="l57.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapAttachmentSaves.js</span>
<a href="#l57.2"></a><span id="l57.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapAttachmentSaves.js</span>
<a href="#l57.3"></a><span id="l57.3" class="difflineat">@@ -205,23 +205,24 @@ function getContentFromMessage(aMsgHdr) </span>
<a href="#l57.4"></a><span id="l57.4">   const MAX_MESSAGE_LENGTH = 65536;</span>
<a href="#l57.5"></a><span id="l57.5">   let msgFolder = aMsgHdr.folder;</span>
<a href="#l57.6"></a><span id="l57.6">   let msgUri = msgFolder.getUriForMsg(aMsgHdr);</span>
<a href="#l57.7"></a><span id="l57.7"> </span>
<a href="#l57.8"></a><span id="l57.8">   let messenger = Cc[&quot;@mozilla.org/messenger;1&quot;]</span>
<a href="#l57.9"></a><span id="l57.9">                     .createInstance(Ci.nsIMessenger);</span>
<a href="#l57.10"></a><span id="l57.10">   let streamListener = Cc[&quot;@mozilla.org/network/sync-stream-listener;1&quot;]</span>
<a href="#l57.11"></a><span id="l57.11">                          .createInstance(Ci.nsISyncStreamListener);</span>
<a href="#l57.12"></a><span id="l57.12" class="difflineplus">+  // pass true for aLocalOnly since message should be in offline store.</span>
<a href="#l57.13"></a><span id="l57.13">   messenger.messageServiceFromURI(msgUri).streamMessage(msgUri,</span>
<a href="#l57.14"></a><span id="l57.14">                                                         streamListener,</span>
<a href="#l57.15"></a><span id="l57.15">                                                         null,</span>
<a href="#l57.16"></a><span id="l57.16">                                                         null,</span>
<a href="#l57.17"></a><span id="l57.17">                                                         false,</span>
<a href="#l57.18"></a><span id="l57.18">                                                         &quot;&quot;,</span>
<a href="#l57.19"></a><span id="l57.19" class="difflineminus">-                                                        false);</span>
<a href="#l57.20"></a><span id="l57.20" class="difflineplus">+                                                        true);</span>
<a href="#l57.21"></a><span id="l57.21">   let sis = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l57.22"></a><span id="l57.22">               .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l57.23"></a><span id="l57.23">   sis.init(streamListener.inputStream);</span>
<a href="#l57.24"></a><span id="l57.24">   return sis.read(MAX_MESSAGE_LENGTH);</span>
<a href="#l57.25"></a><span id="l57.25"> }</span>
<a href="#l57.26"></a><span id="l57.26"> </span>
<a href="#l57.27"></a><span id="l57.27"> // get the first message header found in a folder</span>
<a href="#l57.28"></a><span id="l57.28"> function firstMsgHdr(folder) {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l58.1"></a><span id="l58.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_imapCopyTimeout.js</span>
<a href="#l58.2"></a><span id="l58.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_imapCopyTimeout.js</span>
<a href="#l58.3"></a><span id="l58.3" class="difflineat">@@ -52,16 +52,17 @@ load(&quot;../../../resources/messageGenerato</span>
<a href="#l58.4"></a><span id="l58.4"> // IMAP pump</span>
<a href="#l58.5"></a><span id="l58.5"> load(&quot;../../../resources/IMAPpump.js&quot;);</span>
<a href="#l58.6"></a><span id="l58.6"> </span>
<a href="#l58.7"></a><span id="l58.7"> // Globals</span>
<a href="#l58.8"></a><span id="l58.8"> </span>
<a href="#l58.9"></a><span id="l58.9"> setupIMAPPump();</span>
<a href="#l58.10"></a><span id="l58.10"> </span>
<a href="#l58.11"></a><span id="l58.11"> var gGotAlert = false;</span>
<a href="#l58.12"></a><span id="l58.12" class="difflineplus">+var gGotMsgAdded = false;</span>
<a href="#l58.13"></a><span id="l58.13"> </span>
<a href="#l58.14"></a><span id="l58.14"> var dummyDocShell =</span>
<a href="#l58.15"></a><span id="l58.15"> {</span>
<a href="#l58.16"></a><span id="l58.16">   getInterface: function (iid) {</span>
<a href="#l58.17"></a><span id="l58.17">     if (iid.equals(Ci.nsIAuthPrompt)) {</span>
<a href="#l58.18"></a><span id="l58.18">       return Cc[&quot;@mozilla.org/login-manager/prompter;1&quot;]</span>
<a href="#l58.19"></a><span id="l58.19">                .getService(Ci.nsIAuthPrompt);</span>
<a href="#l58.20"></a><span id="l58.20">     }</span>
<a href="#l58.21"></a><span id="l58.21" class="difflineat">@@ -71,16 +72,17 @@ var dummyDocShell =</span>
<a href="#l58.22"></a><span id="l58.22"> </span>
<a href="#l58.23"></a><span id="l58.23">   QueryInterface: XPCOMUtils.generateQI([Ci.nsIDocShell,</span>
<a href="#l58.24"></a><span id="l58.24">                                          Ci.nsIInterfaceRequestor])</span>
<a href="#l58.25"></a><span id="l58.25"> }</span>
<a href="#l58.26"></a><span id="l58.26"> </span>
<a href="#l58.27"></a><span id="l58.27"> function alert(aDialogTitle, aText) {</span>
<a href="#l58.28"></a><span id="l58.28">   do_check_eq(aText.indexOf(&quot;Connection to server Mail for  timed out.&quot;), 0);</span>
<a href="#l58.29"></a><span id="l58.29">   gGotAlert = true;</span>
<a href="#l58.30"></a><span id="l58.30" class="difflineplus">+  async_driver();</span>
<a href="#l58.31"></a><span id="l58.31"> }</span>
<a href="#l58.32"></a><span id="l58.32"> </span>
<a href="#l58.33"></a><span id="l58.33"> // Dummy message window so we can do the move as an offline operation.</span>
<a href="#l58.34"></a><span id="l58.34"> var dummyMsgWindow =</span>
<a href="#l58.35"></a><span id="l58.35"> {</span>
<a href="#l58.36"></a><span id="l58.36">   rootDocShell: dummyDocShell,</span>
<a href="#l58.37"></a><span id="l58.37">   promptDialog: alertUtilsPrompts,</span>
<a href="#l58.38"></a><span id="l58.38"> </span>
<a href="#l58.39"></a><span id="l58.39" class="difflineat">@@ -160,18 +162,19 @@ function moveMessageToTargetFolder()</span>
<a href="#l58.40"></a><span id="l58.40">   // that's played back immediately.</span>
<a href="#l58.41"></a><span id="l58.41">   copyService.CopyMessages(gIMAPInbox, messages, gTargetFolder, true,</span>
<a href="#l58.42"></a><span id="l58.42">                            CopyListener, dummyMsgWindow, true);</span>
<a href="#l58.43"></a><span id="l58.43">   yield false;</span>
<a href="#l58.44"></a><span id="l58.44"> }</span>
<a href="#l58.45"></a><span id="l58.45"> </span>
<a href="#l58.46"></a><span id="l58.46"> function waitForOfflinePlayback()</span>
<a href="#l58.47"></a><span id="l58.47"> {</span>
<a href="#l58.48"></a><span id="l58.48" class="difflineminus">-  // Offline playback starts 500MS after the offline op is run, so</span>
<a href="#l58.49"></a><span id="l58.49" class="difflineminus">-  // let's wait a second.</span>
<a href="#l58.50"></a><span id="l58.50" class="difflineplus">+  // just wait for the alert about timed out connection.</span>
<a href="#l58.51"></a><span id="l58.51" class="difflineplus">+  yield false;</span>
<a href="#l58.52"></a><span id="l58.52" class="difflineplus">+  // then, wait for a second so we don't get our next url aborted.</span>
<a href="#l58.53"></a><span id="l58.53">   do_timeout(1000, async_driver);</span>
<a href="#l58.54"></a><span id="l58.54">   yield false;</span>
<a href="#l58.55"></a><span id="l58.55"> }</span>
<a href="#l58.56"></a><span id="l58.56"> </span>
<a href="#l58.57"></a><span id="l58.57"> function updateTargetFolder()</span>
<a href="#l58.58"></a><span id="l58.58"> {</span>
<a href="#l58.59"></a><span id="l58.59">   gTargetFolder.updateFolderWithListener(null, UrlListener);</span>
<a href="#l58.60"></a><span id="l58.60">   yield false;</span>
<a href="#l58.61"></a><span id="l58.61" class="difflineat">@@ -208,37 +211,27 @@ mfnListener =</span>
<a href="#l58.62"></a><span id="l58.62">   {</span>
<a href="#l58.63"></a><span id="l58.63">     // we are only using async yield on the target folder add</span>
<a href="#l58.64"></a><span id="l58.64">     if (aFolder.name == &quot;targetFolder&quot;)</span>
<a href="#l58.65"></a><span id="l58.65">       async_driver();</span>
<a href="#l58.66"></a><span id="l58.66">   },</span>
<a href="#l58.67"></a><span id="l58.67"> </span>
<a href="#l58.68"></a><span id="l58.68">   msgAdded: function msgAdded(aMsg)</span>
<a href="#l58.69"></a><span id="l58.69">   {</span>
<a href="#l58.70"></a><span id="l58.70" class="difflineminus">-    async_driver();</span>
<a href="#l58.71"></a><span id="l58.71" class="difflineplus">+    if (!gGotMsgAdded)</span>
<a href="#l58.72"></a><span id="l58.72" class="difflineplus">+      async_driver();</span>
<a href="#l58.73"></a><span id="l58.73" class="difflineplus">+    gGotMsgAdded = true;</span>
<a href="#l58.74"></a><span id="l58.74">   },</span>
<a href="#l58.75"></a><span id="l58.75"> </span>
<a href="#l58.76"></a><span id="l58.76"> };</span>
<a href="#l58.77"></a><span id="l58.77"> </span>
<a href="#l58.78"></a><span id="l58.78"> function run_test()</span>
<a href="#l58.79"></a><span id="l58.79"> {</span>
<a href="#l58.80"></a><span id="l58.80">   // Add folder listeners that will capture async events</span>
<a href="#l58.81"></a><span id="l58.81">   const nsIMFNService = Ci.nsIMsgFolderNotificationService;</span>
<a href="#l58.82"></a><span id="l58.82">   let MFNService = Cc[&quot;@mozilla.org/messenger/msgnotificationservice;1&quot;]</span>
<a href="#l58.83"></a><span id="l58.83">                       .getService(nsIMFNService);</span>
<a href="#l58.84"></a><span id="l58.84">   let flags =</span>
<a href="#l58.85"></a><span id="l58.85">         nsIMFNService.folderAdded |</span>
<a href="#l58.86"></a><span id="l58.86">         nsIMFNService.msgAdded;</span>
<a href="#l58.87"></a><span id="l58.87">   MFNService.addListener(mfnListener, flags);</span>
<a href="#l58.88"></a><span id="l58.88">   async_run_tests(tests);</span>
<a href="#l58.89"></a><span id="l58.89"> }</span>
<a href="#l58.90"></a><span id="l58.90" class="difflineminus">-</span>
<a href="#l58.91"></a><span id="l58.91" class="difflineminus">-/*</span>
<a href="#l58.92"></a><span id="l58.92" class="difflineminus">- * helper functions</span>
<a href="#l58.93"></a><span id="l58.93" class="difflineminus">- */</span>
<a href="#l58.94"></a><span id="l58.94" class="difflineminus">-</span>
<a href="#l58.95"></a><span id="l58.95" class="difflineminus">-// get the first message header found in a folder</span>
<a href="#l58.96"></a><span id="l58.96" class="difflineminus">-function firstMsgHdr(folder) {</span>
<a href="#l58.97"></a><span id="l58.97" class="difflineminus">-  let enumerator = folder.messages;</span>
<a href="#l58.98"></a><span id="l58.98" class="difflineminus">-  if (enumerator.hasMoreElements())</span>
<a href="#l58.99"></a><span id="l58.99" class="difflineminus">-    return enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l58.100"></a><span id="l58.100" class="difflineminus">-  return null;</span>
<a href="#l58.101"></a><span id="l58.101" class="difflineminus">-}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l59.1"></a><span id="l59.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_largeOfflineStore.js</span>
<a href="#l59.2"></a><span id="l59.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_largeOfflineStore.js</span>
<a href="#l59.3"></a><span id="l59.3" class="difflineat">@@ -1,16 +1,19 @@</span>
<a href="#l59.4"></a><span id="l59.4"> /* -*- Mode: JavaScript; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l59.5"></a><span id="l59.5"> /*</span>
<a href="#l59.6"></a><span id="l59.6">  * Test to ensure that downloadAllForOffline works correctly for large imap</span>
<a href="#l59.7"></a><span id="l59.7">  * stores, i.e., &gt; 4GB.</span>
<a href="#l59.8"></a><span id="l59.8">  */</span>
<a href="#l59.9"></a><span id="l59.9"> </span>
<a href="#l59.10"></a><span id="l59.10"> var gIMAPDaemon, gServer, gIMAPIncomingServer;</span>
<a href="#l59.11"></a><span id="l59.11"> </span>
<a href="#l59.12"></a><span id="l59.12" class="difflineplus">+Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l59.13"></a><span id="l59.13" class="difflineplus">+                           &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l59.14"></a><span id="l59.14" class="difflineplus">+</span>
<a href="#l59.15"></a><span id="l59.15"> const gIMAPService = Cc[&quot;@mozilla.org/messenger/messageservice;1?type=imap&quot;]</span>
<a href="#l59.16"></a><span id="l59.16">                        .getService(Ci.nsIMsgMessageService);</span>
<a href="#l59.17"></a><span id="l59.17"> </span>
<a href="#l59.18"></a><span id="l59.18"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l59.19"></a><span id="l59.19"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l59.20"></a><span id="l59.20"> </span>
<a href="#l59.21"></a><span id="l59.21"> var gDownloadedOnce = false;</span>
<a href="#l59.22"></a><span id="l59.22"> var gIMAPInbox;</span>
<a href="#l59.23"></a><span id="l59.23" class="difflineat">@@ -87,18 +90,20 @@ function run_test()</span>
<a href="#l59.24"></a><span id="l59.24">                         null, null);</span>
<a href="#l59.25"></a><span id="l59.25">   imapMsg = new imapMessage(dataUri.spec, inbox.uidnext++, []);</span>
<a href="#l59.26"></a><span id="l59.26">   inbox.addMessage(imapMsg);</span>
<a href="#l59.27"></a><span id="l59.27"> </span>
<a href="#l59.28"></a><span id="l59.28">   // Get the IMAP inbox...</span>
<a href="#l59.29"></a><span id="l59.29">   let rootFolder = gIMAPIncomingServer.rootFolder;</span>
<a href="#l59.30"></a><span id="l59.30"> </span>
<a href="#l59.31"></a><span id="l59.31">   gIMAPInbox = rootFolder.getFolderWithFlags(Ci.nsMsgFolderFlags.Inbox);</span>
<a href="#l59.32"></a><span id="l59.32" class="difflineminus">-  let outputStream = gIMAPInbox.offlineStoreOutputStream</span>
<a href="#l59.33"></a><span id="l59.33" class="difflineplus">+  let outputStream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;].</span>
<a href="#l59.34"></a><span id="l59.34" class="difflineplus">+                       createInstance(Ci.nsIFileOutputStream)</span>
<a href="#l59.35"></a><span id="l59.35">                                .QueryInterface(Ci.nsISeekableStream);</span>
<a href="#l59.36"></a><span id="l59.36" class="difflineplus">+  outputStream.init(gIMAPInbox.filePath, -1, -1, 0);</span>
<a href="#l59.37"></a><span id="l59.37">   // seek to 15 bytes past 4GB.</span>
<a href="#l59.38"></a><span id="l59.38">   outputStream.seek(0, 0x10000000f);</span>
<a href="#l59.39"></a><span id="l59.39">   outputStream.write(&quot;from\r\n&quot;, 6);</span>
<a href="#l59.40"></a><span id="l59.40">   outputStream.close();</span>
<a href="#l59.41"></a><span id="l59.41">   gOfflineStoreSize = gIMAPInbox.filePath.fileSize;</span>
<a href="#l59.42"></a><span id="l59.42">   // ...and download for offline use.</span>
<a href="#l59.43"></a><span id="l59.43">   gIMAPInbox.downloadAllForOffline(UrlListener, null);</span>
<a href="#l59.44"></a><span id="l59.44"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l60.1"></a><span id="l60.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js</span>
<a href="#l60.2"></a><span id="l60.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_localToImapFilterQuarantine.js</span>
<a href="#l60.3"></a><span id="l60.3" class="difflineat">@@ -37,16 +37,19 @@</span>
<a href="#l60.4"></a><span id="l60.4"> /*</span>
<a href="#l60.5"></a><span id="l60.5">  * This file tests copies of multiple messages using filters</span>
<a href="#l60.6"></a><span id="l60.6">  * from incoming POP3, with filter actions copying and moving</span>
<a href="#l60.7"></a><span id="l60.7">  * messages to an IMAP folder, when the POP3 message uses</span>
<a href="#l60.8"></a><span id="l60.8">  * quarantining to help antivirus software. See bug 387361.</span>
<a href="#l60.9"></a><span id="l60.9">  *</span>
<a href="#l60.10"></a><span id="l60.10">  */</span>
<a href="#l60.11"></a><span id="l60.11"> </span>
<a href="#l60.12"></a><span id="l60.12" class="difflineplus">+Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l60.13"></a><span id="l60.13" class="difflineplus">+                           &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l60.14"></a><span id="l60.14" class="difflineplus">+</span>
<a href="#l60.15"></a><span id="l60.15"> load(&quot;../../../resources/POP3pump.js&quot;);</span>
<a href="#l60.16"></a><span id="l60.16"> </span>
<a href="#l60.17"></a><span id="l60.17"> // async support</span>
<a href="#l60.18"></a><span id="l60.18"> load(&quot;../../../resources/logHelper.js&quot;);</span>
<a href="#l60.19"></a><span id="l60.19"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l60.20"></a><span id="l60.20"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l60.21"></a><span id="l60.21"> </span>
<a href="#l60.22"></a><span id="l60.22"> // IMAP pump</span>
<a href="#l60.23"></a><span id="l60.23" class="difflineat">@@ -151,21 +154,21 @@ function updateSubfolderAndTest2() {</span>
<a href="#l60.24"></a><span id="l60.24">   // The previous function does an append, which may take a bit of time to</span>
<a href="#l60.25"></a><span id="l60.25">   // complete. Unfortunately updateFolderWithListener succeeds successfully</span>
<a href="#l60.26"></a><span id="l60.26">   // if there is a url running, but doesn't tell us that is the case. So we</span>
<a href="#l60.27"></a><span id="l60.27">   // have to run updateFolderWithListener several times to actually find out</span>
<a href="#l60.28"></a><span id="l60.28">   // when we are done.</span>
<a href="#l60.29"></a><span id="l60.29">   gFinishedRunningURL = 0;</span>
<a href="#l60.30"></a><span id="l60.30">   gSubfolder.updateFolderWithListener(null, urlListener);</span>
<a href="#l60.31"></a><span id="l60.31">   dl('wait for OnStopRunningURL');</span>
<a href="#l60.32"></a><span id="l60.32" class="difflineminus">-  do_timeout(100, checkResult);</span>
<a href="#l60.33"></a><span id="l60.33" class="difflineplus">+  do_timeout(1000, checkResult);</span>
<a href="#l60.34"></a><span id="l60.34">   yield false;</span>
<a href="#l60.35"></a><span id="l60.35"> </span>
<a href="#l60.36"></a><span id="l60.36">   // kill some time</span>
<a href="#l60.37"></a><span id="l60.37" class="difflineminus">-  do_timeout(200, async_driver);</span>
<a href="#l60.38"></a><span id="l60.38" class="difflineplus">+  do_timeout(1000, async_driver);</span>
<a href="#l60.39"></a><span id="l60.39">   yield false;</span>
<a href="#l60.40"></a><span id="l60.40"> </span>
<a href="#l60.41"></a><span id="l60.41">   //test</span>
<a href="#l60.42"></a><span id="l60.42">   listMessages(gSubfolder);</span>
<a href="#l60.43"></a><span id="l60.43">   listMessages(gLocalInboxFolder);</span>
<a href="#l60.44"></a><span id="l60.44">   do_check_eq(folderCount(gSubfolder), 3);</span>
<a href="#l60.45"></a><span id="l60.45">   do_check_eq(folderCount(gLocalInboxFolder), 3);</span>
<a href="#l60.46"></a><span id="l60.46"> }</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l61.1"></a><span id="l61.1" class="difflineminus">--- a/mailnews/imap/test/unit/test_preserveDataOnMove.js</span>
<a href="#l61.2"></a><span id="l61.2" class="difflineplus">+++ b/mailnews/imap/test/unit/test_preserveDataOnMove.js</span>
<a href="#l61.3"></a><span id="l61.3" class="difflineat">@@ -177,24 +177,16 @@ function run_test()</span>
<a href="#l61.4"></a><span id="l61.4">   MFNService.addListener(mfnListener, flags);</span>
<a href="#l61.5"></a><span id="l61.5">   async_run_tests(tests);</span>
<a href="#l61.6"></a><span id="l61.6"> }</span>
<a href="#l61.7"></a><span id="l61.7"> </span>
<a href="#l61.8"></a><span id="l61.8"> /*</span>
<a href="#l61.9"></a><span id="l61.9">  * helper functions</span>
<a href="#l61.10"></a><span id="l61.10">  */</span>
<a href="#l61.11"></a><span id="l61.11"> </span>
<a href="#l61.12"></a><span id="l61.12" class="difflineminus">-// get the first message header found in a folder</span>
<a href="#l61.13"></a><span id="l61.13" class="difflineminus">-function firstMsgHdr(folder) {</span>
<a href="#l61.14"></a><span id="l61.14" class="difflineminus">-  let enumerator = folder.messages;</span>
<a href="#l61.15"></a><span id="l61.15" class="difflineminus">-  if (enumerator.hasMoreElements())</span>
<a href="#l61.16"></a><span id="l61.16" class="difflineminus">-    return enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l61.17"></a><span id="l61.17" class="difflineminus">-  return null;</span>
<a href="#l61.18"></a><span id="l61.18" class="difflineminus">-}</span>
<a href="#l61.19"></a><span id="l61.19" class="difflineminus">-</span>
<a href="#l61.20"></a><span id="l61.20"> // given a test file, return the file uri spec</span>
<a href="#l61.21"></a><span id="l61.21"> function specForFileName(aFileName)</span>
<a href="#l61.22"></a><span id="l61.22"> {</span>
<a href="#l61.23"></a><span id="l61.23">   let file = do_get_file(&quot;../../../data/&quot; + aFileName);</span>
<a href="#l61.24"></a><span id="l61.24">   let msgfileuri = Cc[&quot;@mozilla.org/network/io-service;1&quot;]</span>
<a href="#l61.25"></a><span id="l61.25">                      .getService(Ci.nsIIOService)</span>
<a href="#l61.26"></a><span id="l61.26">                      .newFileURI(file)</span>
<a href="#l61.27"></a><span id="l61.27">                      .QueryInterface(Ci.nsIFileURL);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l62.1"></a><span id="l62.1" class="difflineminus">--- a/mailnews/local/public/nsIMsgParseMailMsgState.idl</span>
<a href="#l62.2"></a><span id="l62.2" class="difflineplus">+++ b/mailnews/local/public/nsIMsgParseMailMsgState.idl</span>
<a href="#l62.3"></a><span id="l62.3" class="difflineat">@@ -43,33 +43,33 @@ interface nsIOutputStream;</span>
<a href="#l62.4"></a><span id="l62.4"> </span>
<a href="#l62.5"></a><span id="l62.5"> %{C++</span>
<a href="#l62.6"></a><span id="l62.6"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l62.7"></a><span id="l62.7"> #include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l62.8"></a><span id="l62.8"> %}</span>
<a href="#l62.9"></a><span id="l62.9"> </span>
<a href="#l62.10"></a><span id="l62.10"> typedef long nsMailboxParseState;</span>
<a href="#l62.11"></a><span id="l62.11"> </span>
<a href="#l62.12"></a><span id="l62.12" class="difflineminus">-[scriptable, uuid(9BE9B91D-5D5B-4e85-84B2-79FBFF56F5D4)]</span>
<a href="#l62.13"></a><span id="l62.13" class="difflineplus">+[scriptable, uuid(abf6a8e2-955e-4952-a295-b71d45f770cf)]</span>
<a href="#l62.14"></a><span id="l62.14"> interface nsIMsgParseMailMsgState : nsISupports {</span>
<a href="#l62.15"></a><span id="l62.15"> </span>
<a href="#l62.16"></a><span id="l62.16">     attribute unsigned long envelopePos;</span>
<a href="#l62.17"></a><span id="l62.17">     void SetMailDB(in nsIMsgDatabase aDatabase);</span>
<a href="#l62.18"></a><span id="l62.18">     /*</span>
<a href="#l62.19"></a><span id="l62.19">      * Set a backup mail database, whose data will be read during parsing to</span>
<a href="#l62.20"></a><span id="l62.20">      * attempt to recover message metadata</span>
<a href="#l62.21"></a><span id="l62.21">      *</span>
<a href="#l62.22"></a><span id="l62.22">      * @param aDatabase   the backup database</span>
<a href="#l62.23"></a><span id="l62.23">      */</span>
<a href="#l62.24"></a><span id="l62.24">     void SetBackupMailDB(in nsIMsgDatabase aDatabase);</span>
<a href="#l62.25"></a><span id="l62.25" class="difflineminus">-    void setDBFolderStream(in nsIOutputStream fileStream);</span>
<a href="#l62.26"></a><span id="l62.26">     void Clear();</span>
<a href="#l62.27"></a><span id="l62.27"> </span>
<a href="#l62.28"></a><span id="l62.28">     void ParseAFolderLine(in string line, in unsigned long lineLength);</span>
<a href="#l62.29"></a><span id="l62.29" class="difflineminus">-    nsIMsgDBHdr GetNewMsgHdr();</span>
<a href="#l62.30"></a><span id="l62.30" class="difflineplus">+    /// db header for message we're currently parsing</span>
<a href="#l62.31"></a><span id="l62.31" class="difflineplus">+    attribute nsIMsgDBHdr newMsgHdr;</span>
<a href="#l62.32"></a><span id="l62.32">     void FinishHeader();</span>
<a href="#l62.33"></a><span id="l62.33"> </span>
<a href="#l62.34"></a><span id="l62.34">     long GetAllHeaders(out string headers);</span>
<a href="#l62.35"></a><span id="l62.35">     readonly attribute string headers;</span>
<a href="#l62.36"></a><span id="l62.36">   attribute nsMailboxParseState state;</span>
<a href="#l62.37"></a><span id="l62.37">     /* these are nsMailboxParseState */</span>
<a href="#l62.38"></a><span id="l62.38">     const long ParseEnvelopeState=0;</span>
<a href="#l62.39"></a><span id="l62.39">     const long ParseHeadersState=1;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l63.1"></a><span id="l63.1" class="difflineminus">--- a/mailnews/local/public/nsMsgLocalCID.h</span>
<a href="#l63.2"></a><span id="l63.2" class="difflineplus">+++ b/mailnews/local/public/nsMsgLocalCID.h</span>
<a href="#l63.3"></a><span id="l63.3" class="difflineat">@@ -227,9 +227,25 @@</span>
<a href="#l63.4"></a><span id="l63.4"> #define NS_RSSINCOMINGSERVER_CONTRACTID \</span>
<a href="#l63.5"></a><span id="l63.5">   NS_MSGINCOMINGSERVER_CONTRACTID_PREFIX &quot;rss&quot;</span>
<a href="#l63.6"></a><span id="l63.6"> </span>
<a href="#l63.7"></a><span id="l63.7"> #define NS_RSSINCOMINGSERVER_CID                  \</span>
<a href="#l63.8"></a><span id="l63.8"> { /* 3a874285-5520-41a0-bcda-a3dee3dbf4f3 */      \</span>
<a href="#l63.9"></a><span id="l63.9">  0x3a874285, 0x5520, 0x41a0,                      \</span>
<a href="#l63.10"></a><span id="l63.10">  {0xbc, 0xda, 0xa3, 0xde, 0xe3, 0xdb, 0xf4, 0xf3 }}</span>
<a href="#l63.11"></a><span id="l63.11"> </span>
<a href="#l63.12"></a><span id="l63.12" class="difflineplus">+#define NS_BRKMBOXSTORE_CID \</span>
<a href="#l63.13"></a><span id="l63.13" class="difflineplus">+{ /* 36358199-a0e4-4b68-929f-77c01de34c67 */ \</span>
<a href="#l63.14"></a><span id="l63.14" class="difflineplus">+ 0x36358199, 0xa0e4, 0x4b68, \</span>
<a href="#l63.15"></a><span id="l63.15" class="difflineplus">+ {0x92, 0x9f, 0x77, 0xc0, 0x1d, 0xe3, 0x4c, 0x67}}</span>
<a href="#l63.16"></a><span id="l63.16" class="difflineplus">+</span>
<a href="#l63.17"></a><span id="l63.17" class="difflineplus">+#define NS_BRKMBOXSTORE_CONTRACTID \</span>
<a href="#l63.18"></a><span id="l63.18" class="difflineplus">+  &quot;@mozilla.org/msgstore/berkeleystore;1&quot;</span>
<a href="#l63.19"></a><span id="l63.19" class="difflineplus">+</span>
<a href="#l63.20"></a><span id="l63.20" class="difflineplus">+#define NS_MAILDIRSTORE_CID \</span>
<a href="#l63.21"></a><span id="l63.21" class="difflineplus">+{ /* 1F993EDA-7DD9-11DF-819A-6257DFD72085 */ \</span>
<a href="#l63.22"></a><span id="l63.22" class="difflineplus">+ 0x1F993EDA, 0x7DD9, 0x11DF, \</span>
<a href="#l63.23"></a><span id="l63.23" class="difflineplus">+ { 0x81, 0x9A, 0x62, 0x57, 0xDF, 0xD7, 0x20, 0x85 }}</span>
<a href="#l63.24"></a><span id="l63.24" class="difflineplus">+</span>
<a href="#l63.25"></a><span id="l63.25" class="difflineplus">+#define NS_MAILDIRSTORE_CONTRACTID \</span>
<a href="#l63.26"></a><span id="l63.26" class="difflineplus">+  &quot;@mozilla.org/msgstore/maildirstore;1&quot;</span>
<a href="#l63.27"></a><span id="l63.27" class="difflineplus">+</span>
<a href="#l63.28"></a><span id="l63.28"> #endif // nsMsgLocalCID_h__</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l64.1"></a><span id="l64.1" class="difflineminus">--- a/mailnews/local/src/Makefile.in</span>
<a href="#l64.2"></a><span id="l64.2" class="difflineplus">+++ b/mailnews/local/src/Makefile.in</span>
<a href="#l64.3"></a><span id="l64.3" class="difflineat">@@ -56,16 +56,19 @@ CPPSRCS		= \</span>
<a href="#l64.4"></a><span id="l64.4"> 		nsPop3Sink.cpp \</span>
<a href="#l64.5"></a><span id="l64.5"> 		nsParseMailbox.cpp \</span>
<a href="#l64.6"></a><span id="l64.6"> 		nsMailboxProtocol.cpp \</span>
<a href="#l64.7"></a><span id="l64.7"> 		nsMailboxUrl.cpp \</span>
<a href="#l64.8"></a><span id="l64.8"> 		nsLocalMailFolder.cpp \</span>
<a href="#l64.9"></a><span id="l64.9"> 		nsMailboxService.cpp \</span>
<a href="#l64.10"></a><span id="l64.10"> 		nsPop3Service.cpp \</span>
<a href="#l64.11"></a><span id="l64.11"> 		nsMailboxServer.cpp \</span>
<a href="#l64.12"></a><span id="l64.12" class="difflineplus">+		nsMsgBrkMBoxStore.cpp \</span>
<a href="#l64.13"></a><span id="l64.13" class="difflineplus">+		nsMsgLocalStoreUtils.cpp \</span>
<a href="#l64.14"></a><span id="l64.14" class="difflineplus">+		nsMsgMaildirStore.cpp \</span>
<a href="#l64.15"></a><span id="l64.15"> 		nsPop3IncomingServer.cpp \</span>
<a href="#l64.16"></a><span id="l64.16"> 		nsLocalUtils.cpp \</span>
<a href="#l64.17"></a><span id="l64.17"> 		nsLocalUndoTxn.cpp \</span>
<a href="#l64.18"></a><span id="l64.18"> 		nsNoIncomingServer.cpp \</span>
<a href="#l64.19"></a><span id="l64.19"> 		nsNoneService.cpp       \</span>
<a href="#l64.20"></a><span id="l64.20"> 		nsRssIncomingServer.cpp \</span>
<a href="#l64.21"></a><span id="l64.21"> 		nsRssService.cpp       \</span>
<a href="#l64.22"></a><span id="l64.22"> 		$(NULL)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l65.1"></a><span id="l65.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l65.2"></a><span id="l65.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.cpp</span>
<a href="#l65.3"></a><span id="l65.3" class="difflineat">@@ -106,18 +106,16 @@</span>
<a href="#l65.4"></a><span id="l65.4"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l65.5"></a><span id="l65.5"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l65.6"></a><span id="l65.6"> #include &quot;nsReadLine.h&quot;</span>
<a href="#l65.7"></a><span id="l65.7"> #include &quot;nsLocalStrings.h&quot;</span>
<a href="#l65.8"></a><span id="l65.8"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l65.9"></a><span id="l65.9"> #include &quot;nsIMsgTraitService.h&quot;</span>
<a href="#l65.10"></a><span id="l65.10"> #include &quot;nsIStringEnumerator.h&quot;</span>
<a href="#l65.11"></a><span id="l65.11"> </span>
<a href="#l65.12"></a><span id="l65.12" class="difflineminus">-static NS_DEFINE_CID(kMailboxServiceCID,          NS_MAILBOXSERVICE_CID);</span>
<a href="#l65.13"></a><span id="l65.13" class="difflineminus">-</span>
<a href="#l65.14"></a><span id="l65.14"> //////////////////////////////////////////////////////////////////////////////</span>
<a href="#l65.15"></a><span id="l65.15"> // nsLocal</span>
<a href="#l65.16"></a><span id="l65.16"> /////////////////////////////////////////////////////////////////////////////</span>
<a href="#l65.17"></a><span id="l65.17"> </span>
<a href="#l65.18"></a><span id="l65.18"> nsLocalMailCopyState::nsLocalMailCopyState() :</span>
<a href="#l65.19"></a><span id="l65.19">   m_flags(0),</span>
<a href="#l65.20"></a><span id="l65.20">   m_curDstKey(0xffffffff),</span>
<a href="#l65.21"></a><span id="l65.21">   m_curCopyIndex(0),</span>
<a href="#l65.22"></a><span id="l65.22" class="difflineat">@@ -175,159 +173,46 @@ nsMsgLocalMailFolder::~nsMsgLocalMailFol</span>
<a href="#l65.23"></a><span id="l65.23"> </span>
<a href="#l65.24"></a><span id="l65.24"> NS_IMPL_ISUPPORTS_INHERITED2(nsMsgLocalMailFolder,</span>
<a href="#l65.25"></a><span id="l65.25">                              nsMsgDBFolder,</span>
<a href="#l65.26"></a><span id="l65.26">                              nsICopyMessageListener,</span>
<a href="#l65.27"></a><span id="l65.27">                              nsIMsgLocalMailFolder)</span>
<a href="#l65.28"></a><span id="l65.28"> </span>
<a href="#l65.29"></a><span id="l65.29"> ////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l65.30"></a><span id="l65.30"> </span>
<a href="#l65.31"></a><span id="l65.31" class="difflineminus">-static bool</span>
<a href="#l65.32"></a><span id="l65.32" class="difflineminus">-nsStringEndsWith(nsString&amp; name, const char *ending)</span>
<a href="#l65.33"></a><span id="l65.33" class="difflineminus">-{</span>
<a href="#l65.34"></a><span id="l65.34" class="difflineminus">-  PRInt32 len = name.Length();</span>
<a href="#l65.35"></a><span id="l65.35" class="difflineminus">-  if (len == 0)</span>
<a href="#l65.36"></a><span id="l65.36" class="difflineminus">-    return PR_FALSE;</span>
<a href="#l65.37"></a><span id="l65.37" class="difflineminus">-</span>
<a href="#l65.38"></a><span id="l65.38" class="difflineminus">-  PRInt32 endingLen = strlen(ending);</span>
<a href="#l65.39"></a><span id="l65.39" class="difflineminus">-  return (len &gt; endingLen &amp;&amp; name.RFind(ending, PR_TRUE) == len - endingLen);</span>
<a href="#l65.40"></a><span id="l65.40" class="difflineminus">-}</span>
<a href="#l65.41"></a><span id="l65.41" class="difflineminus">-</span>
<a href="#l65.42"></a><span id="l65.42" class="difflineminus">-static bool</span>
<a href="#l65.43"></a><span id="l65.43" class="difflineminus">-nsShouldIgnoreFile(nsString&amp; name)</span>
<a href="#l65.44"></a><span id="l65.44" class="difflineminus">-{</span>
<a href="#l65.45"></a><span id="l65.45" class="difflineminus">-  PRUnichar firstChar=name.CharAt(0);</span>
<a href="#l65.46"></a><span id="l65.46" class="difflineminus">-  if (firstChar == '.' || firstChar == '#' || name.CharAt(name.Length() - 1) == '~')</span>
<a href="#l65.47"></a><span id="l65.47" class="difflineminus">-    return PR_TRUE;</span>
<a href="#l65.48"></a><span id="l65.48" class="difflineminus">-</span>
<a href="#l65.49"></a><span id="l65.49" class="difflineminus">-  if (name.LowerCaseEqualsLiteral(&quot;msgfilterrules.dat&quot;) ||</span>
<a href="#l65.50"></a><span id="l65.50" class="difflineminus">-      name.LowerCaseEqualsLiteral(&quot;rules.dat&quot;) ||</span>
<a href="#l65.51"></a><span id="l65.51" class="difflineminus">-      name.LowerCaseEqualsLiteral(&quot;filterlog.html&quot;) ||</span>
<a href="#l65.52"></a><span id="l65.52" class="difflineminus">-      name.LowerCaseEqualsLiteral(&quot;junklog.html&quot;) ||</span>
<a href="#l65.53"></a><span id="l65.53" class="difflineminus">-      name.LowerCaseEqualsLiteral(&quot;rulesbackup.dat&quot;))</span>
<a href="#l65.54"></a><span id="l65.54" class="difflineminus">-    return PR_TRUE;</span>
<a href="#l65.55"></a><span id="l65.55" class="difflineminus">-</span>
<a href="#l65.56"></a><span id="l65.56" class="difflineminus">-</span>
<a href="#l65.57"></a><span id="l65.57" class="difflineminus">-  // don't add summary files to the list of folders;</span>
<a href="#l65.58"></a><span id="l65.58" class="difflineminus">-  // don't add popstate files to the list either, or rules (sort.dat).</span>
<a href="#l65.59"></a><span id="l65.59" class="difflineminus">-  if (nsStringEndsWith(name, &quot;.snm&quot;) ||</span>
<a href="#l65.60"></a><span id="l65.60" class="difflineminus">-      name.LowerCaseEqualsLiteral(&quot;popstate.dat&quot;) ||</span>
<a href="#l65.61"></a><span id="l65.61" class="difflineminus">-      name.LowerCaseEqualsLiteral(&quot;sort.dat&quot;) ||</span>
<a href="#l65.62"></a><span id="l65.62" class="difflineminus">-      name.LowerCaseEqualsLiteral(&quot;mailfilt.log&quot;) ||</span>
<a href="#l65.63"></a><span id="l65.63" class="difflineminus">-      name.LowerCaseEqualsLiteral(&quot;filters.js&quot;) ||</span>
<a href="#l65.64"></a><span id="l65.64" class="difflineminus">-      nsStringEndsWith(name, &quot;.toc&quot;))</span>
<a href="#l65.65"></a><span id="l65.65" class="difflineminus">-    return PR_TRUE;</span>
<a href="#l65.66"></a><span id="l65.66" class="difflineminus">-</span>
<a href="#l65.67"></a><span id="l65.67" class="difflineminus">-  // ignore RSS data source files</span>
<a href="#l65.68"></a><span id="l65.68" class="difflineminus">-  if (name.LowerCaseEqualsLiteral(&quot;feeds.rdf&quot;) ||</span>
<a href="#l65.69"></a><span id="l65.69" class="difflineminus">-      name.LowerCaseEqualsLiteral(&quot;feeditems.rdf&quot;))</span>
<a href="#l65.70"></a><span id="l65.70" class="difflineminus">-    return PR_TRUE;</span>
<a href="#l65.71"></a><span id="l65.71" class="difflineminus">-</span>
<a href="#l65.72"></a><span id="l65.72" class="difflineminus">-  // The .mozmsgs dir is for spotlight support</span>
<a href="#l65.73"></a><span id="l65.73" class="difflineminus">-    return (nsStringEndsWith(name, &quot;.mozmsgs&quot;) || nsStringEndsWith(name,&quot;.sbd&quot;) ||</span>
<a href="#l65.74"></a><span id="l65.74" class="difflineminus">-            nsStringEndsWith(name,SUMMARY_SUFFIX));</span>
<a href="#l65.75"></a><span id="l65.75" class="difflineminus">-}</span>
<a href="#l65.76"></a><span id="l65.76" class="difflineminus">-</span>
<a href="#l65.77"></a><span id="l65.77"> NS_IMETHODIMP</span>
<a href="#l65.78"></a><span id="l65.78"> nsMsgLocalMailFolder::Init(const char* aURI)</span>
<a href="#l65.79"></a><span id="l65.79"> {</span>
<a href="#l65.80"></a><span id="l65.80">   return nsMsgDBFolder::Init(aURI);</span>
<a href="#l65.81"></a><span id="l65.81"> }</span>
<a href="#l65.82"></a><span id="l65.82"> </span>
<a href="#l65.83"></a><span id="l65.83" class="difflineminus">-nsresult</span>
<a href="#l65.84"></a><span id="l65.84" class="difflineminus">-nsMsgLocalMailFolder::CreateSubFolders(nsIFile *path)</span>
<a href="#l65.85"></a><span id="l65.85" class="difflineminus">-{</span>
<a href="#l65.86"></a><span id="l65.86" class="difflineminus">-  // first find out all the current subfolders and files, before using them while</span>
<a href="#l65.87"></a><span id="l65.87" class="difflineminus">-  // creating new subfolders; we don't want to modify and iterate the same</span>
<a href="#l65.88"></a><span id="l65.88" class="difflineminus">-  // directory at once.</span>
<a href="#l65.89"></a><span id="l65.89" class="difflineminus">-  nsCOMArray&lt;nsIFile&gt; currentDirEntries;</span>
<a href="#l65.90"></a><span id="l65.90" class="difflineminus">-</span>
<a href="#l65.91"></a><span id="l65.91" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l65.92"></a><span id="l65.92" class="difflineminus">-  nsresult rv = path-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l65.93"></a><span id="l65.93" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.94"></a><span id="l65.94" class="difflineminus">-</span>
<a href="#l65.95"></a><span id="l65.95" class="difflineminus">-  bool hasMore;</span>
<a href="#l65.96"></a><span id="l65.96" class="difflineminus">-  while (NS_SUCCEEDED(directoryEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l65.97"></a><span id="l65.97" class="difflineminus">-  {</span>
<a href="#l65.98"></a><span id="l65.98" class="difflineminus">-    nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l65.99"></a><span id="l65.99" class="difflineminus">-    directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l65.100"></a><span id="l65.100" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; currentFile(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l65.101"></a><span id="l65.101" class="difflineminus">-    if (currentFile)</span>
<a href="#l65.102"></a><span id="l65.102" class="difflineminus">-      currentDirEntries.AppendObject(currentFile);</span>
<a href="#l65.103"></a><span id="l65.103" class="difflineminus">-  }</span>
<a href="#l65.104"></a><span id="l65.104" class="difflineminus">-</span>
<a href="#l65.105"></a><span id="l65.105" class="difflineminus">-  // add the folders</span>
<a href="#l65.106"></a><span id="l65.106" class="difflineminus">-  PRInt32 count = currentDirEntries.Count();</span>
<a href="#l65.107"></a><span id="l65.107" class="difflineminus">-  for (int i = 0; i &lt; count; ++i)</span>
<a href="#l65.108"></a><span id="l65.108" class="difflineminus">-  {</span>
<a href="#l65.109"></a><span id="l65.109" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; currentFile(currentDirEntries[i]);</span>
<a href="#l65.110"></a><span id="l65.110" class="difflineminus">-</span>
<a href="#l65.111"></a><span id="l65.111" class="difflineminus">-    nsAutoString leafName;</span>
<a href="#l65.112"></a><span id="l65.112" class="difflineminus">-    currentFile-&gt;GetLeafName(leafName);</span>
<a href="#l65.113"></a><span id="l65.113" class="difflineminus">-    directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l65.114"></a><span id="l65.114" class="difflineminus">-    // here we should handle the case where the current file is a .sbd directory w/o</span>
<a href="#l65.115"></a><span id="l65.115" class="difflineminus">-    // a matching folder file, or a directory w/o the name .sbd</span>
<a href="#l65.116"></a><span id="l65.116" class="difflineminus">-    if (nsShouldIgnoreFile(leafName))</span>
<a href="#l65.117"></a><span id="l65.117" class="difflineminus">-      continue;</span>
<a href="#l65.118"></a><span id="l65.118" class="difflineminus">-</span>
<a href="#l65.119"></a><span id="l65.119" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l65.120"></a><span id="l65.120" class="difflineminus">-    rv = AddSubfolder(leafName, getter_AddRefs(child));</span>
<a href="#l65.121"></a><span id="l65.121" class="difflineminus">-    if (child)</span>
<a href="#l65.122"></a><span id="l65.122" class="difflineminus">-    {</span>
<a href="#l65.123"></a><span id="l65.123" class="difflineminus">-      nsString folderName;</span>
<a href="#l65.124"></a><span id="l65.124" class="difflineminus">-      child-&gt;GetName(folderName);  // try to get it from cache/db</span>
<a href="#l65.125"></a><span id="l65.125" class="difflineminus">-      if (folderName.IsEmpty())</span>
<a href="#l65.126"></a><span id="l65.126" class="difflineminus">-        child-&gt;SetPrettyName(leafName);</span>
<a href="#l65.127"></a><span id="l65.127" class="difflineminus">-    }</span>
<a href="#l65.128"></a><span id="l65.128" class="difflineminus">-  }</span>
<a href="#l65.129"></a><span id="l65.129" class="difflineminus">-</span>
<a href="#l65.130"></a><span id="l65.130" class="difflineminus">-  return rv;</span>
<a href="#l65.131"></a><span id="l65.131" class="difflineminus">-}</span>
<a href="#l65.132"></a><span id="l65.132" class="difflineminus">-</span>
<a href="#l65.133"></a><span id="l65.133"> nsresult nsMsgLocalMailFolder::CreateChildFromURI(const nsCString &amp;uri, nsIMsgFolder **folder)</span>
<a href="#l65.134"></a><span id="l65.134"> {</span>
<a href="#l65.135"></a><span id="l65.135">   nsMsgLocalMailFolder *newFolder = new nsMsgLocalMailFolder;</span>
<a href="#l65.136"></a><span id="l65.136">   if (!newFolder)</span>
<a href="#l65.137"></a><span id="l65.137">     return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l65.138"></a><span id="l65.138"> </span>
<a href="#l65.139"></a><span id="l65.139">   NS_ADDREF(*folder = newFolder);</span>
<a href="#l65.140"></a><span id="l65.140">   newFolder-&gt;Init(uri.get());</span>
<a href="#l65.141"></a><span id="l65.141">   return NS_OK;</span>
<a href="#l65.142"></a><span id="l65.142"> }</span>
<a href="#l65.143"></a><span id="l65.143"> </span>
<a href="#l65.144"></a><span id="l65.144" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::CreateLocalSubfolder(const nsAString &amp;aName,</span>
<a href="#l65.145"></a><span id="l65.145" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::CreateLocalSubfolder(const nsAString &amp;aFolderName,</span>
<a href="#l65.146"></a><span id="l65.146">                                                          nsIMsgFolder **aChild)</span>
<a href="#l65.147"></a><span id="l65.147"> {</span>
<a href="#l65.148"></a><span id="l65.148" class="difflineminus">-  nsresult rv = CreateSubfolderInternal(aName, nsnull, aChild);</span>
<a href="#l65.149"></a><span id="l65.149" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aChild);</span>
<a href="#l65.150"></a><span id="l65.150" class="difflineplus">+  nsresult rv = CreateSubfolderInternal(aFolderName, nsnull, aChild);</span>
<a href="#l65.151"></a><span id="l65.151">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.152"></a><span id="l65.152" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l65.153"></a><span id="l65.153" class="difflineplus">+</span>
<a href="#l65.154"></a><span id="l65.154" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(</span>
<a href="#l65.155"></a><span id="l65.155" class="difflineplus">+    do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l65.156"></a><span id="l65.156">   if (notifier)</span>
<a href="#l65.157"></a><span id="l65.157">     notifier-&gt;NotifyFolderAdded(*aChild);</span>
<a href="#l65.158"></a><span id="l65.158" class="difflineminus">-  return rv;</span>
<a href="#l65.159"></a><span id="l65.159" class="difflineminus">-}</span>
<a href="#l65.160"></a><span id="l65.160" class="difflineminus">-</span>
<a href="#l65.161"></a><span id="l65.161" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::AddSubfolder(const nsAString &amp;name,</span>
<a href="#l65.162"></a><span id="l65.162" class="difflineminus">-                                                 nsIMsgFolder **child)</span>
<a href="#l65.163"></a><span id="l65.163" class="difflineminus">-{</span>
<a href="#l65.164"></a><span id="l65.164" class="difflineminus">-  nsresult rv = nsMsgDBFolder::AddSubfolder(name, child);</span>
<a href="#l65.165"></a><span id="l65.165" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.166"></a><span id="l65.166" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; path;</span>
<a href="#l65.167"></a><span id="l65.167" class="difflineminus">-  // need to make sure folder exists...</span>
<a href="#l65.168"></a><span id="l65.168" class="difflineminus">-  (*child)-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l65.169"></a><span id="l65.169" class="difflineminus">-  if (path)</span>
<a href="#l65.170"></a><span id="l65.170" class="difflineminus">-  {</span>
<a href="#l65.171"></a><span id="l65.171" class="difflineminus">-    bool exists;</span>
<a href="#l65.172"></a><span id="l65.172" class="difflineminus">-    rv = path-&gt;Exists(&amp;exists);</span>
<a href="#l65.173"></a><span id="l65.173" class="difflineminus">-    if (!exists)</span>
<a href="#l65.174"></a><span id="l65.174" class="difflineminus">-    {</span>
<a href="#l65.175"></a><span id="l65.175" class="difflineminus">-      rv = path-&gt;Create(nsIFile::NORMAL_FILE_TYPE, 0644);</span>
<a href="#l65.176"></a><span id="l65.176" class="difflineminus">-      (*child)-&gt;UpdateSummaryTotals(PR_TRUE);</span>
<a href="#l65.177"></a><span id="l65.177" class="difflineminus">-    }</span>
<a href="#l65.178"></a><span id="l65.178" class="difflineminus">-  }</span>
<a href="#l65.179"></a><span id="l65.179" class="difflineminus">-  return rv;</span>
<a href="#l65.180"></a><span id="l65.180" class="difflineplus">+</span>
<a href="#l65.181"></a><span id="l65.181" class="difflineplus">+  return NS_OK;</span>
<a href="#l65.182"></a><span id="l65.182"> }</span>
<a href="#l65.183"></a><span id="l65.183"> </span>
<a href="#l65.184"></a><span id="l65.184"> NS_IMETHODIMP nsMsgLocalMailFolder::GetManyHeadersToDownload(bool *retval)</span>
<a href="#l65.185"></a><span id="l65.185"> {</span>
<a href="#l65.186"></a><span id="l65.186">   bool isLocked;</span>
<a href="#l65.187"></a><span id="l65.187">   // if the folder is locked, we're probably reparsing - let's build the</span>
<a href="#l65.188"></a><span id="l65.188">   // view when we've finished reparsing.</span>
<a href="#l65.189"></a><span id="l65.189">   GetLocked(&amp;isLocked);</span>
<a href="#l65.190"></a><span id="l65.190" class="difflineat">@@ -336,96 +221,75 @@ NS_IMETHODIMP nsMsgLocalMailFolder::GetM</span>
<a href="#l65.191"></a><span id="l65.191">     *retval = PR_TRUE;</span>
<a href="#l65.192"></a><span id="l65.192">     return NS_OK;</span>
<a href="#l65.193"></a><span id="l65.193">   }</span>
<a href="#l65.194"></a><span id="l65.194"> </span>
<a href="#l65.195"></a><span id="l65.195">   return nsMsgDBFolder::GetManyHeadersToDownload(retval);</span>
<a href="#l65.196"></a><span id="l65.196"> }</span>
<a href="#l65.197"></a><span id="l65.197"> </span>
<a href="#l65.198"></a><span id="l65.198"> //run the url to parse the mailbox</span>
<a href="#l65.199"></a><span id="l65.199" class="difflineminus">-NS_IMETHODIMP nsMsgLocalMailFolder::ParseFolder(nsIMsgWindow *aMsgWindow, nsIUrlListener *listener)</span>
<a href="#l65.200"></a><span id="l65.200" class="difflineplus">+NS_IMETHODIMP nsMsgLocalMailFolder::ParseFolder(nsIMsgWindow *aMsgWindow,</span>
<a href="#l65.201"></a><span id="l65.201" class="difflineplus">+                                                nsIUrlListener *aListener)</span>
<a href="#l65.202"></a><span id="l65.202"> {</span>
<a href="#l65.203"></a><span id="l65.203" class="difflineminus">-  nsresult rv;</span>
<a href="#l65.204"></a><span id="l65.204" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; pathFile;</span>
<a href="#l65.205"></a><span id="l65.205" class="difflineminus">-  rv = GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l65.206"></a><span id="l65.206" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l65.207"></a><span id="l65.207" class="difflineminus">-    return rv;</span>
<a href="#l65.208"></a><span id="l65.208" class="difflineminus">-</span>
<a href="#l65.209"></a><span id="l65.209" class="difflineminus">-  nsCOMPtr&lt;nsIMailboxService&gt; mailboxService = do_GetService(kMailboxServiceCID, &amp;rv);</span>
<a href="#l65.210"></a><span id="l65.210" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.211"></a><span id="l65.211" class="difflineplus">+  nsresult rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.212"></a><span id="l65.212">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.213"></a><span id="l65.213" class="difflineminus">-</span>
<a href="#l65.214"></a><span id="l65.214" class="difflineminus">-  nsMsgMailboxParser *parser = new nsMsgMailboxParser(this);</span>
<a href="#l65.215"></a><span id="l65.215" class="difflineminus">-  NS_ENSURE_TRUE(parser, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l65.216"></a><span id="l65.216" class="difflineminus">-</span>
<a href="#l65.217"></a><span id="l65.217" class="difflineminus">-  bool isLocked;</span>
<a href="#l65.218"></a><span id="l65.218" class="difflineminus">-  nsCOMPtr &lt;nsISupports&gt; supports = do_QueryInterface(static_cast&lt;nsIMsgParseMailMsgState*&gt;(parser));</span>
<a href="#l65.219"></a><span id="l65.219" class="difflineminus">-  GetLocked(&amp;isLocked);</span>
<a href="#l65.220"></a><span id="l65.220" class="difflineminus">-  if (isLocked)</span>
<a href="#l65.221"></a><span id="l65.221" class="difflineminus">-  {</span>
<a href="#l65.222"></a><span id="l65.222" class="difflineminus">-    NS_ASSERTION(PR_FALSE, &quot;Could not get folder lock&quot;);</span>
<a href="#l65.223"></a><span id="l65.223" class="difflineminus">-    return NS_MSG_FOLDER_BUSY;</span>
<a href="#l65.224"></a><span id="l65.224" class="difflineminus">-  }</span>
<a href="#l65.225"></a><span id="l65.225" class="difflineminus">-</span>
<a href="#l65.226"></a><span id="l65.226" class="difflineminus">-  AcquireSemaphore(supports);</span>
<a href="#l65.227"></a><span id="l65.227" class="difflineminus">-</span>
<a href="#l65.228"></a><span id="l65.228" class="difflineminus">-  if (listener != this)</span>
<a href="#l65.229"></a><span id="l65.229" class="difflineminus">-    mReparseListener = listener;</span>
<a href="#l65.230"></a><span id="l65.230" class="difflineminus">-</span>
<a href="#l65.231"></a><span id="l65.231" class="difflineminus">-  rv = mailboxService-&gt;ParseMailbox(aMsgWindow, pathFile, parser, this, nsnull);</span>
<a href="#l65.232"></a><span id="l65.232" class="difflineplus">+  if (aListener != this)</span>
<a href="#l65.233"></a><span id="l65.233" class="difflineplus">+    mReparseListener = aListener;</span>
<a href="#l65.234"></a><span id="l65.234" class="difflineplus">+  // if parsing is synchronous, we need to set m_parsingFolder to</span>
<a href="#l65.235"></a><span id="l65.235" class="difflineplus">+  // true before starting. And we need to open the db before</span>
<a href="#l65.236"></a><span id="l65.236" class="difflineplus">+  // setting m_parsingFolder to true.</span>
<a href="#l65.237"></a><span id="l65.237" class="difflineplus">+//  OpenDatabase();</span>
<a href="#l65.238"></a><span id="l65.238" class="difflineplus">+  rv = msgStore-&gt;RebuildIndex(this, mDatabase, aMsgWindow, this);</span>
<a href="#l65.239"></a><span id="l65.239">   if (NS_SUCCEEDED(rv))</span>
<a href="#l65.240"></a><span id="l65.240" class="difflineminus">-    m_parsingFolder = PR_TRUE;</span>
<a href="#l65.241"></a><span id="l65.241" class="difflineplus">+    m_parsingFolder = true;</span>
<a href="#l65.242"></a><span id="l65.242">   return rv;</span>
<a href="#l65.243"></a><span id="l65.243"> }</span>
<a href="#l65.244"></a><span id="l65.244"> </span>
<a href="#l65.245"></a><span id="l65.245"> // this won't force a reparse of the folder if the db is invalid.</span>
<a href="#l65.246"></a><span id="l65.246"> NS_IMETHODIMP</span>
<a href="#l65.247"></a><span id="l65.247"> nsMsgLocalMailFolder::GetMsgDatabase(nsIMsgDatabase** aMsgDatabase)</span>
<a href="#l65.248"></a><span id="l65.248"> {</span>
<a href="#l65.249"></a><span id="l65.249">   return GetDatabaseWOReparse(aMsgDatabase);</span>
<a href="#l65.250"></a><span id="l65.250"> }</span>
<a href="#l65.251"></a><span id="l65.251"> </span>
<a href="#l65.252"></a><span id="l65.252"> NS_IMETHODIMP</span>
<a href="#l65.253"></a><span id="l65.253"> nsMsgLocalMailFolder::GetSubFolders(nsISimpleEnumerator **aResult)</span>
<a href="#l65.254"></a><span id="l65.254"> {</span>
<a href="#l65.255"></a><span id="l65.255">   bool isServer;</span>
<a href="#l65.256"></a><span id="l65.256">   nsresult rv = GetIsServer(&amp;isServer);</span>
<a href="#l65.257"></a><span id="l65.257"> </span>
<a href="#l65.258"></a><span id="l65.258" class="difflineminus">-  if (!mInitialized) {</span>
<a href="#l65.259"></a><span id="l65.259" class="difflineplus">+  if (!mInitialized)</span>
<a href="#l65.260"></a><span id="l65.260" class="difflineplus">+  {</span>
<a href="#l65.261"></a><span id="l65.261" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l65.262"></a><span id="l65.262" class="difflineplus">+    rv = GetServer(getter_AddRefs(server));</span>
<a href="#l65.263"></a><span id="l65.263" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l65.264"></a><span id="l65.264" class="difflineplus">+    nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.265"></a><span id="l65.265" class="difflineplus">+    // need to set this flag here to avoid infinite recursion</span>
<a href="#l65.266"></a><span id="l65.266" class="difflineplus">+    mInitialized = PR_TRUE;</span>
<a href="#l65.267"></a><span id="l65.267" class="difflineplus">+    rv = server-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.268"></a><span id="l65.268" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.269"></a><span id="l65.269" class="difflineplus">+    // This should add all existing folders as sub-folders of this folder.</span>
<a href="#l65.270"></a><span id="l65.270" class="difflineplus">+    rv = msgStore-&gt;DiscoverSubFolders(this, PR_TRUE);</span>
<a href="#l65.271"></a><span id="l65.271" class="difflineplus">+</span>
<a href="#l65.272"></a><span id="l65.272">     nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l65.273"></a><span id="l65.273">     rv = GetFilePath(getter_AddRefs(path));</span>
<a href="#l65.274"></a><span id="l65.274">     if (NS_FAILED(rv))</span>
<a href="#l65.275"></a><span id="l65.275">       return rv;</span>
<a href="#l65.276"></a><span id="l65.276"> </span>
<a href="#l65.277"></a><span id="l65.277">     bool exists, directory;</span>
<a href="#l65.278"></a><span id="l65.278">     path-&gt;Exists(&amp;exists);</span>
<a href="#l65.279"></a><span id="l65.279">     if (!exists)</span>
<a href="#l65.280"></a><span id="l65.280">       path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l65.281"></a><span id="l65.281"> </span>
<a href="#l65.282"></a><span id="l65.282">     path-&gt;IsDirectory(&amp;directory);</span>
<a href="#l65.283"></a><span id="l65.283" class="difflineminus">-    if (!directory)</span>
<a href="#l65.284"></a><span id="l65.284" class="difflineminus">-    {</span>
<a href="#l65.285"></a><span id="l65.285" class="difflineminus">-      nsCOMPtr &lt;nsIFile&gt; dirFile;</span>
<a href="#l65.286"></a><span id="l65.286" class="difflineminus">-      rv = path-&gt;Clone(getter_AddRefs(dirFile));</span>
<a href="#l65.287"></a><span id="l65.287" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.288"></a><span id="l65.288" class="difflineminus">-      nsAutoString leafName;</span>
<a href="#l65.289"></a><span id="l65.289" class="difflineminus">-      dirFile-&gt;GetLeafName(leafName);</span>
<a href="#l65.290"></a><span id="l65.290" class="difflineminus">-      leafName.AppendLiteral(&quot;.sbd&quot;);</span>
<a href="#l65.291"></a><span id="l65.291" class="difflineminus">-      dirFile-&gt;SetLeafName(leafName);</span>
<a href="#l65.292"></a><span id="l65.292" class="difflineminus">-      path = do_QueryInterface(dirFile);</span>
<a href="#l65.293"></a><span id="l65.293" class="difflineminus">-      path-&gt;IsDirectory(&amp;directory);</span>
<a href="#l65.294"></a><span id="l65.294" class="difflineminus">-    }</span>
<a href="#l65.295"></a><span id="l65.295" class="difflineminus">-</span>
<a href="#l65.296"></a><span id="l65.296" class="difflineminus">-    mInitialized = PR_TRUE;      // need to set this flag here to avoid infinite recursion</span>
<a href="#l65.297"></a><span id="l65.297" class="difflineminus">-    // we have to treat the root folder specially, because it's name</span>
<a href="#l65.298"></a><span id="l65.298" class="difflineminus">-    // doesn't end with .sbd</span>
<a href="#l65.299"></a><span id="l65.299" class="difflineminus">-    PRInt32 newFlags = nsMsgFolderFlags::Mail;</span>
<a href="#l65.300"></a><span id="l65.300">     if (directory)</span>
<a href="#l65.301"></a><span id="l65.301">     {</span>
<a href="#l65.302"></a><span id="l65.302" class="difflineminus">-      newFlags |= (nsMsgFolderFlags::Directory | nsMsgFolderFlags::Elided);</span>
<a href="#l65.303"></a><span id="l65.303" class="difflineminus">-      SetFlag(newFlags);</span>
<a href="#l65.304"></a><span id="l65.304" class="difflineplus">+      SetFlag(nsMsgFolderFlags::Mail | nsMsgFolderFlags::Elided |</span>
<a href="#l65.305"></a><span id="l65.305" class="difflineplus">+              nsMsgFolderFlags::Directory);</span>
<a href="#l65.306"></a><span id="l65.306"> </span>
<a href="#l65.307"></a><span id="l65.307">       bool createdDefaultMailboxes = false;</span>
<a href="#l65.308"></a><span id="l65.308">       nsCOMPtr&lt;nsILocalMailIncomingServer&gt; localMailServer;</span>
<a href="#l65.309"></a><span id="l65.309"> </span>
<a href="#l65.310"></a><span id="l65.310">       if (isServer)</span>
<a href="#l65.311"></a><span id="l65.311">       {</span>
<a href="#l65.312"></a><span id="l65.312">         nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l65.313"></a><span id="l65.313">         rv = GetServer(getter_AddRefs(server));</span>
<a href="#l65.314"></a><span id="l65.314" class="difflineat">@@ -434,39 +298,23 @@ nsMsgLocalMailFolder::GetSubFolders(nsIS</span>
<a href="#l65.315"></a><span id="l65.315">         NS_ENSURE_SUCCESS(rv, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l65.316"></a><span id="l65.316"> </span>
<a href="#l65.317"></a><span id="l65.317">         // first create the folders on disk (as empty files)</span>
<a href="#l65.318"></a><span id="l65.318">         rv = localMailServer-&gt;CreateDefaultMailboxes(path);</span>
<a href="#l65.319"></a><span id="l65.319">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.320"></a><span id="l65.320">         createdDefaultMailboxes = PR_TRUE;</span>
<a href="#l65.321"></a><span id="l65.321">       }</span>
<a href="#l65.322"></a><span id="l65.322"> </span>
<a href="#l65.323"></a><span id="l65.323" class="difflineminus">-      // now, discover those folders</span>
<a href="#l65.324"></a><span id="l65.324" class="difflineminus">-      rv = CreateSubFolders(path);</span>
<a href="#l65.325"></a><span id="l65.325" class="difflineminus">-      if (NS_FAILED(rv))</span>
<a href="#l65.326"></a><span id="l65.326" class="difflineminus">-        return rv;</span>
<a href="#l65.327"></a><span id="l65.327" class="difflineminus">-</span>
<a href="#l65.328"></a><span id="l65.328">       // must happen after CreateSubFolders, or the folders won't exist.</span>
<a href="#l65.329"></a><span id="l65.329">       if (createdDefaultMailboxes &amp;&amp; isServer)</span>
<a href="#l65.330"></a><span id="l65.330">       {</span>
<a href="#l65.331"></a><span id="l65.331">         rv = localMailServer-&gt;SetFlagsOnDefaultMailboxes();</span>
<a href="#l65.332"></a><span id="l65.332">         if (NS_FAILED(rv))</span>
<a href="#l65.333"></a><span id="l65.333">           return rv;</span>
<a href="#l65.334"></a><span id="l65.334">       }</span>
<a href="#l65.335"></a><span id="l65.335" class="difflineminus">-</span>
<a href="#l65.336"></a><span id="l65.336" class="difflineminus">-      /* we need to create all the folders at start-up because if a folder having subfolders is</span>
<a href="#l65.337"></a><span id="l65.337" class="difflineminus">-                    closed then the datasource will not ask for subfolders. For IMAP logging onto the</span>
<a href="#l65.338"></a><span id="l65.338" class="difflineminus">-                    server will create imap folders and for news we don't have any 2nd level newsgroup */</span>
<a href="#l65.339"></a><span id="l65.339" class="difflineminus">-      PRInt32 count = mSubFolders.Count();</span>
<a href="#l65.340"></a><span id="l65.340" class="difflineminus">-      nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l65.341"></a><span id="l65.341" class="difflineminus">-      for (PRInt32 i = 0; i &lt; count; i++)</span>
<a href="#l65.342"></a><span id="l65.342" class="difflineminus">-      {</span>
<a href="#l65.343"></a><span id="l65.343" class="difflineminus">-        rv = mSubFolders[i]-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l65.344"></a><span id="l65.344" class="difflineminus">-        NS_ASSERTION(NS_SUCCEEDED(rv),&quot;GetSubFolders failed&quot;);</span>
<a href="#l65.345"></a><span id="l65.345" class="difflineminus">-      }</span>
<a href="#l65.346"></a><span id="l65.346">     }</span>
<a href="#l65.347"></a><span id="l65.347">     UpdateSummaryTotals(PR_FALSE);</span>
<a href="#l65.348"></a><span id="l65.348">   }</span>
<a href="#l65.349"></a><span id="l65.349"> </span>
<a href="#l65.350"></a><span id="l65.350">   return aResult ? NS_NewArrayEnumerator(aResult, mSubFolders) : NS_ERROR_NULL_POINTER;</span>
<a href="#l65.351"></a><span id="l65.351"> }</span>
<a href="#l65.352"></a><span id="l65.352"> </span>
<a href="#l65.353"></a><span id="l65.353"> nsresult nsMsgLocalMailFolder::GetDatabase()</span>
<a href="#l65.354"></a><span id="l65.354" class="difflineat">@@ -748,76 +596,34 @@ nsresult</span>
<a href="#l65.355"></a><span id="l65.355"> nsMsgLocalMailFolder::CreateSubfolderInternal(const nsAString&amp; folderName,</span>
<a href="#l65.356"></a><span id="l65.356">                                               nsIMsgWindow *msgWindow,</span>
<a href="#l65.357"></a><span id="l65.357">                                               nsIMsgFolder **aNewFolder)</span>
<a href="#l65.358"></a><span id="l65.358"> {</span>
<a href="#l65.359"></a><span id="l65.359">   nsresult rv = CheckIfFolderExists(folderName, this, msgWindow);</span>
<a href="#l65.360"></a><span id="l65.360">   // No need for an assertion: we already throw an alert.</span>
<a href="#l65.361"></a><span id="l65.361">   if (NS_FAILED(rv))</span>
<a href="#l65.362"></a><span id="l65.362">     return rv;</span>
<a href="#l65.363"></a><span id="l65.363" class="difflineminus">-</span>
<a href="#l65.364"></a><span id="l65.364" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; path;</span>
<a href="#l65.365"></a><span id="l65.365" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l65.366"></a><span id="l65.366" class="difflineminus">-  //Get a directory based on our current path.</span>
<a href="#l65.367"></a><span id="l65.367" class="difflineminus">-  rv = CreateDirectoryForFolder(getter_AddRefs(path));</span>
<a href="#l65.368"></a><span id="l65.368" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l65.369"></a><span id="l65.369" class="difflineminus">-    return rv;</span>
<a href="#l65.370"></a><span id="l65.370" class="difflineminus">-</span>
<a href="#l65.371"></a><span id="l65.371" class="difflineminus">-  //Now we have a valid directory or we have returned.</span>
<a href="#l65.372"></a><span id="l65.372" class="difflineminus">-  //Make sure the new folder name is valid</span>
<a href="#l65.373"></a><span id="l65.373" class="difflineminus">-  nsAutoString safeFolderName(folderName);</span>
<a href="#l65.374"></a><span id="l65.374" class="difflineminus">-  NS_MsgHashIfNecessary(safeFolderName);</span>
<a href="#l65.375"></a><span id="l65.375" class="difflineminus">-  path-&gt;Append(safeFolderName);</span>
<a href="#l65.376"></a><span id="l65.376" class="difflineminus">-  bool exists;</span>
<a href="#l65.377"></a><span id="l65.377" class="difflineminus">-  path-&gt;Exists(&amp;exists);</span>
<a href="#l65.378"></a><span id="l65.378" class="difflineminus">-  if (exists) //check this because localized names are different from disk names</span>
<a href="#l65.379"></a><span id="l65.379" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.380"></a><span id="l65.380" class="difflineplus">+  rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.381"></a><span id="l65.381" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.382"></a><span id="l65.382" class="difflineplus">+  rv = msgStore-&gt;CreateFolder(this, folderName, aNewFolder);</span>
<a href="#l65.383"></a><span id="l65.383" class="difflineplus">+  if (rv == NS_MSG_ERROR_INVALID_FOLDER_NAME)</span>
<a href="#l65.384"></a><span id="l65.384" class="difflineplus">+  {</span>
<a href="#l65.385"></a><span id="l65.385" class="difflineplus">+    ThrowAlertMsg(&quot;folderCreationFailed&quot;, msgWindow);</span>
<a href="#l65.386"></a><span id="l65.386" class="difflineplus">+    // I'm returning this value so the dialog stays up</span>
<a href="#l65.387"></a><span id="l65.387" class="difflineplus">+    return NS_MSG_FOLDER_EXISTS;</span>
<a href="#l65.388"></a><span id="l65.388" class="difflineplus">+  }</span>
<a href="#l65.389"></a><span id="l65.389" class="difflineplus">+  if (rv == NS_MSG_FOLDER_EXISTS)</span>
<a href="#l65.390"></a><span id="l65.390">   {</span>
<a href="#l65.391"></a><span id="l65.391">     ThrowAlertMsg(&quot;folderExists&quot;, msgWindow);</span>
<a href="#l65.392"></a><span id="l65.392">     return NS_MSG_FOLDER_EXISTS;</span>
<a href="#l65.393"></a><span id="l65.393">   }</span>
<a href="#l65.394"></a><span id="l65.394"> </span>
<a href="#l65.395"></a><span id="l65.395" class="difflineminus">-  path-&gt;Create(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l65.396"></a><span id="l65.396" class="difflineminus">-</span>
<a href="#l65.397"></a><span id="l65.397" class="difflineminus">-  //GetFlags and SetFlags in AddSubfolder will fail because we have no db at this point but mFlags is set.</span>
<a href="#l65.398"></a><span id="l65.398" class="difflineminus">-  rv = AddSubfolder(safeFolderName, getter_AddRefs(child));</span>
<a href="#l65.399"></a><span id="l65.399" class="difflineminus">-  if (!child || NS_FAILED(rv))</span>
<a href="#l65.400"></a><span id="l65.400" class="difflineminus">-  {</span>
<a href="#l65.401"></a><span id="l65.401" class="difflineminus">-    path-&gt;Remove(PR_FALSE);</span>
<a href="#l65.402"></a><span id="l65.402" class="difflineminus">-    return rv;</span>
<a href="#l65.403"></a><span id="l65.403" class="difflineminus">-  }</span>
<a href="#l65.404"></a><span id="l65.404" class="difflineminus">-</span>
<a href="#l65.405"></a><span id="l65.405" class="difflineminus">-  // Create an empty database for this mail folder, set its name from the user</span>
<a href="#l65.406"></a><span id="l65.406" class="difflineminus">-  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l65.407"></a><span id="l65.407" class="difflineminus">-  if (msgDBService)</span>
<a href="#l65.408"></a><span id="l65.408" class="difflineminus">-  {</span>
<a href="#l65.409"></a><span id="l65.409" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDatabase&gt; unusedDB;</span>
<a href="#l65.410"></a><span id="l65.410" class="difflineminus">-    rv = msgDBService-&gt;OpenFolderDB(child, PR_TRUE, getter_AddRefs(unusedDB));</span>
<a href="#l65.411"></a><span id="l65.411" class="difflineminus">-    if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l65.412"></a><span id="l65.412" class="difflineminus">-      rv = msgDBService-&gt;CreateNewDB(child, getter_AddRefs(unusedDB));</span>
<a href="#l65.413"></a><span id="l65.413" class="difflineminus">-</span>
<a href="#l65.414"></a><span id="l65.414" class="difflineminus">-    if ((NS_SUCCEEDED(rv) || rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE) &amp;&amp;</span>
<a href="#l65.415"></a><span id="l65.415" class="difflineminus">-        unusedDB)</span>
<a href="#l65.416"></a><span id="l65.416" class="difflineminus">-    {</span>
<a href="#l65.417"></a><span id="l65.417" class="difflineminus">-      //need to set the folder name</span>
<a href="#l65.418"></a><span id="l65.418" class="difflineminus">-      nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l65.419"></a><span id="l65.419" class="difflineminus">-      rv = unusedDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l65.420"></a><span id="l65.420" class="difflineminus">-      if (NS_SUCCEEDED(rv))</span>
<a href="#l65.421"></a><span id="l65.421" class="difflineminus">-      {</span>
<a href="#l65.422"></a><span id="l65.422" class="difflineminus">-        folderInfo-&gt;SetMailboxName(safeFolderName);</span>
<a href="#l65.423"></a><span id="l65.423" class="difflineminus">-      }</span>
<a href="#l65.424"></a><span id="l65.424" class="difflineminus">-      unusedDB-&gt;SetSummaryValid(PR_TRUE);</span>
<a href="#l65.425"></a><span id="l65.425" class="difflineminus">-      unusedDB-&gt;Close(PR_TRUE);</span>
<a href="#l65.426"></a><span id="l65.426" class="difflineminus">-      UpdateSummaryTotals(PR_TRUE);</span>
<a href="#l65.427"></a><span id="l65.427" class="difflineminus">-    }</span>
<a href="#l65.428"></a><span id="l65.428" class="difflineminus">-    else</span>
<a href="#l65.429"></a><span id="l65.429" class="difflineminus">-    {</span>
<a href="#l65.430"></a><span id="l65.430" class="difflineminus">-      path-&gt;Remove(PR_FALSE);</span>
<a href="#l65.431"></a><span id="l65.431" class="difflineminus">-      rv = NS_MSG_CANT_CREATE_FOLDER;</span>
<a href="#l65.432"></a><span id="l65.432" class="difflineminus">-    }</span>
<a href="#l65.433"></a><span id="l65.433" class="difflineminus">-  }</span>
<a href="#l65.434"></a><span id="l65.434" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; child = *aNewFolder;</span>
<a href="#l65.435"></a><span id="l65.435" class="difflineplus">+</span>
<a href="#l65.436"></a><span id="l65.436">   if (NS_SUCCEEDED(rv))</span>
<a href="#l65.437"></a><span id="l65.437">   {</span>
<a href="#l65.438"></a><span id="l65.438">     //we need to notify explicitly the flag change because it failed when we did AddSubfolder</span>
<a href="#l65.439"></a><span id="l65.439">     child-&gt;OnFlagChange(mFlags);</span>
<a href="#l65.440"></a><span id="l65.440">     child-&gt;SetPrettyName(folderName);  //because empty trash will create a new trash folder</span>
<a href="#l65.441"></a><span id="l65.441">     NotifyItemAdded(child);</span>
<a href="#l65.442"></a><span id="l65.442">     if (aNewFolder)</span>
<a href="#l65.443"></a><span id="l65.443">       child.swap(*aNewFolder);</span>
<a href="#l65.444"></a><span id="l65.444" class="difflineat">@@ -829,16 +635,23 @@ NS_IMETHODIMP nsMsgLocalMailFolder::Comp</span>
<a href="#l65.445"></a><span id="l65.445">                                                nsIMsgWindow *aMsgWindow,</span>
<a href="#l65.446"></a><span id="l65.446">                                                bool aCompactOfflineAlso)</span>
<a href="#l65.447"></a><span id="l65.447"> {</span>
<a href="#l65.448"></a><span id="l65.448">   nsresult rv = NS_OK;</span>
<a href="#l65.449"></a><span id="l65.449">   nsCOMPtr&lt;nsIMutableArray&gt; folderArray;</span>
<a href="#l65.450"></a><span id="l65.450">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l65.451"></a><span id="l65.451">   nsCOMPtr&lt;nsISupportsArray&gt; allDescendents;</span>
<a href="#l65.452"></a><span id="l65.452">   rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l65.453"></a><span id="l65.453" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.454"></a><span id="l65.454" class="difflineplus">+  GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.455"></a><span id="l65.455" class="difflineplus">+  bool storeSupportsCompaction;</span>
<a href="#l65.456"></a><span id="l65.456" class="difflineplus">+  msgStore-&gt;GetSupportsCompaction(&amp;storeSupportsCompaction);</span>
<a href="#l65.457"></a><span id="l65.457" class="difflineplus">+  if (!storeSupportsCompaction)</span>
<a href="#l65.458"></a><span id="l65.458" class="difflineplus">+    return NotifyCompactCompleted();</span>
<a href="#l65.459"></a><span id="l65.459" class="difflineplus">+</span>
<a href="#l65.460"></a><span id="l65.460">   if (NS_SUCCEEDED(rv) &amp;&amp; rootFolder)</span>
<a href="#l65.461"></a><span id="l65.461">   {</span>
<a href="#l65.462"></a><span id="l65.462">     NS_NewISupportsArray(getter_AddRefs(allDescendents));</span>
<a href="#l65.463"></a><span id="l65.463">     rootFolder-&gt;ListDescendents(allDescendents);</span>
<a href="#l65.464"></a><span id="l65.464">     PRUint32 cnt =0;</span>
<a href="#l65.465"></a><span id="l65.465">     rv = allDescendents-&gt;Count(&amp;cnt);</span>
<a href="#l65.466"></a><span id="l65.466">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.467"></a><span id="l65.467">     folderArray = do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv);</span>
<a href="#l65.468"></a><span id="l65.468" class="difflineat">@@ -865,28 +678,24 @@ NS_IMETHODIMP nsMsgLocalMailFolder::Comp</span>
<a href="#l65.469"></a><span id="l65.469">   nsCOMPtr &lt;nsIMsgFolderCompactor&gt; folderCompactor =  do_CreateInstance(NS_MSGLOCALFOLDERCOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l65.470"></a><span id="l65.470">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.471"></a><span id="l65.471">   return folderCompactor-&gt;CompactFolders(folderArray, nsnull,</span>
<a href="#l65.472"></a><span id="l65.472">                                          aListener, aMsgWindow);</span>
<a href="#l65.473"></a><span id="l65.473"> }</span>
<a href="#l65.474"></a><span id="l65.474"> </span>
<a href="#l65.475"></a><span id="l65.475"> NS_IMETHODIMP nsMsgLocalMailFolder::Compact(nsIUrlListener *aListener, nsIMsgWindow *aMsgWindow)</span>
<a href="#l65.476"></a><span id="l65.476"> {</span>
<a href="#l65.477"></a><span id="l65.477" class="difflineminus">-  nsresult rv;</span>
<a href="#l65.478"></a><span id="l65.478" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolderCompactor&gt; folderCompactor =  do_CreateInstance(NS_MSGLOCALFOLDERCOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l65.479"></a><span id="l65.479" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.480"></a><span id="l65.480" class="difflineplus">+  nsresult rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.481"></a><span id="l65.481">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.482"></a><span id="l65.482" class="difflineminus">-</span>
<a href="#l65.483"></a><span id="l65.483" class="difflineminus">-  PRUint32 expungedBytes = 0;</span>
<a href="#l65.484"></a><span id="l65.484" class="difflineminus">-  GetExpungedBytes(&amp;expungedBytes);</span>
<a href="#l65.485"></a><span id="l65.485" class="difflineminus">-  // check if we need to compact the folder</span>
<a href="#l65.486"></a><span id="l65.486" class="difflineminus">-  if (expungedBytes &gt; 0)</span>
<a href="#l65.487"></a><span id="l65.487" class="difflineminus">-    rv = folderCompactor-&gt;Compact(this, PR_FALSE, aListener, aMsgWindow);</span>
<a href="#l65.488"></a><span id="l65.488" class="difflineminus">-  else</span>
<a href="#l65.489"></a><span id="l65.489" class="difflineminus">-    rv = NotifyCompactCompleted();</span>
<a href="#l65.490"></a><span id="l65.490" class="difflineminus">-  return rv;</span>
<a href="#l65.491"></a><span id="l65.491" class="difflineplus">+  bool supportsCompaction;</span>
<a href="#l65.492"></a><span id="l65.492" class="difflineplus">+  msgStore-&gt;GetSupportsCompaction(&amp;supportsCompaction);</span>
<a href="#l65.493"></a><span id="l65.493" class="difflineplus">+  if (supportsCompaction)</span>
<a href="#l65.494"></a><span id="l65.494" class="difflineplus">+    return msgStore-&gt;CompactFolder(this, aListener, aMsgWindow);</span>
<a href="#l65.495"></a><span id="l65.495" class="difflineplus">+  return NS_OK;</span>
<a href="#l65.496"></a><span id="l65.496"> }</span>
<a href="#l65.497"></a><span id="l65.497"> </span>
<a href="#l65.498"></a><span id="l65.498"> NS_IMETHODIMP nsMsgLocalMailFolder::EmptyTrash(nsIMsgWindow *msgWindow,</span>
<a href="#l65.499"></a><span id="l65.499">                                                nsIUrlListener *aListener)</span>
<a href="#l65.500"></a><span id="l65.500"> {</span>
<a href="#l65.501"></a><span id="l65.501">   nsresult rv;</span>
<a href="#l65.502"></a><span id="l65.502">   nsCOMPtr&lt;nsIMsgFolder&gt; trashFolder;</span>
<a href="#l65.503"></a><span id="l65.503">   rv = GetTrashFolder(getter_AddRefs(trashFolder));</span>
<a href="#l65.504"></a><span id="l65.504" class="difflineat">@@ -998,40 +807,34 @@ NS_IMETHODIMP nsMsgLocalMailFolder::Dele</span>
<a href="#l65.505"></a><span id="l65.505">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.506"></a><span id="l65.506">   msgDBService-&gt;CachedDBForFolder(this, getter_AddRefs(mDatabase));</span>
<a href="#l65.507"></a><span id="l65.507">   if (mDatabase)</span>
<a href="#l65.508"></a><span id="l65.508">   {</span>
<a href="#l65.509"></a><span id="l65.509">     mDatabase-&gt;ForceClosed();</span>
<a href="#l65.510"></a><span id="l65.510">     mDatabase = nsnull;</span>
<a href="#l65.511"></a><span id="l65.511">   }</span>
<a href="#l65.512"></a><span id="l65.512"> </span>
<a href="#l65.513"></a><span id="l65.513" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; pathFile;</span>
<a href="#l65.514"></a><span id="l65.514" class="difflineminus">-  rv = GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l65.515"></a><span id="l65.515" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l65.516"></a><span id="l65.516" class="difflineminus">-    return rv;</span>
<a href="#l65.517"></a><span id="l65.517" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l65.518"></a><span id="l65.518" class="difflineplus">+  rv = GetServer(getter_AddRefs(server));</span>
<a href="#l65.519"></a><span id="l65.519" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.520"></a><span id="l65.520" class="difflineplus">+</span>
<a href="#l65.521"></a><span id="l65.521" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.522"></a><span id="l65.522" class="difflineplus">+</span>
<a href="#l65.523"></a><span id="l65.523" class="difflineplus">+  rv = server-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.524"></a><span id="l65.524" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.525"></a><span id="l65.525"> </span>
<a href="#l65.526"></a><span id="l65.526">   nsCOMPtr &lt;nsILocalFile&gt; summaryFile;</span>
<a href="#l65.527"></a><span id="l65.527" class="difflineminus">-  rv = GetSummaryFileLocation(pathFile, getter_AddRefs(summaryFile));</span>
<a href="#l65.528"></a><span id="l65.528" class="difflineplus">+  rv = msgStore-&gt;GetSummaryFile(this, getter_AddRefs(summaryFile));</span>
<a href="#l65.529"></a><span id="l65.529">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.530"></a><span id="l65.530"> </span>
<a href="#l65.531"></a><span id="l65.531">   //Clean up .sbd folder if it exists.</span>
<a href="#l65.532"></a><span id="l65.532">   // Remove summary file.</span>
<a href="#l65.533"></a><span id="l65.533">   summaryFile-&gt;Remove(PR_FALSE);</span>
<a href="#l65.534"></a><span id="l65.534"> </span>
<a href="#l65.535"></a><span id="l65.535" class="difflineminus">-  //Delete mailbox</span>
<a href="#l65.536"></a><span id="l65.536" class="difflineminus">-  pathFile-&gt;Remove(PR_FALSE);</span>
<a href="#l65.537"></a><span id="l65.537" class="difflineminus">-</span>
<a href="#l65.538"></a><span id="l65.538" class="difflineminus">-  bool isDirectory = false;</span>
<a href="#l65.539"></a><span id="l65.539" class="difflineminus">-  pathFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l65.540"></a><span id="l65.540" class="difflineminus">-  if (!isDirectory)</span>
<a href="#l65.541"></a><span id="l65.541" class="difflineminus">-    AddDirectorySeparator(pathFile);</span>
<a href="#l65.542"></a><span id="l65.542" class="difflineminus">-  isDirectory = PR_FALSE;</span>
<a href="#l65.543"></a><span id="l65.543" class="difflineminus">-  pathFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l65.544"></a><span id="l65.544" class="difflineminus">-  //If this is a directory, then remove it.</span>
<a href="#l65.545"></a><span id="l65.545" class="difflineminus">-  return isDirectory ? pathFile-&gt;Remove(PR_TRUE) : NS_OK;</span>
<a href="#l65.546"></a><span id="l65.546" class="difflineplus">+  return msgStore-&gt;DeleteFolder(this);</span>
<a href="#l65.547"></a><span id="l65.547"> }</span>
<a href="#l65.548"></a><span id="l65.548"> </span>
<a href="#l65.549"></a><span id="l65.549"> NS_IMETHODIMP nsMsgLocalMailFolder::DeleteSubFolders(nsIArray *folders, nsIMsgWindow *msgWindow)</span>
<a href="#l65.550"></a><span id="l65.550"> {</span>
<a href="#l65.551"></a><span id="l65.551">   nsresult rv;</span>
<a href="#l65.552"></a><span id="l65.552">   bool isChildOfTrash;</span>
<a href="#l65.553"></a><span id="l65.553">   IsChildOfTrash(&amp;isChildOfTrash);</span>
<a href="#l65.554"></a><span id="l65.554"> </span>
<a href="#l65.555"></a><span id="l65.555" class="difflineat">@@ -1125,85 +928,39 @@ nsresult nsMsgLocalMailFolder::ConfirmFo</span>
<a href="#l65.556"></a><span id="l65.556"> }</span>
<a href="#l65.557"></a><span id="l65.557"> </span>
<a href="#l65.558"></a><span id="l65.558"> NS_IMETHODIMP nsMsgLocalMailFolder::Rename(const nsAString&amp; aNewName, nsIMsgWindow *msgWindow)</span>
<a href="#l65.559"></a><span id="l65.559"> {</span>
<a href="#l65.560"></a><span id="l65.560">   // Renaming to the same name is easy</span>
<a href="#l65.561"></a><span id="l65.561">   if (mName.Equals(aNewName))</span>
<a href="#l65.562"></a><span id="l65.562">     return NS_OK;</span>
<a href="#l65.563"></a><span id="l65.563"> </span>
<a href="#l65.564"></a><span id="l65.564" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; oldPathFile;</span>
<a href="#l65.565"></a><span id="l65.565" class="difflineminus">-  nsresult rv = GetFilePath(getter_AddRefs(oldPathFile));</span>
<a href="#l65.566"></a><span id="l65.566" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l65.567"></a><span id="l65.567" class="difflineminus">-    return rv;</span>
<a href="#l65.568"></a><span id="l65.568" class="difflineminus">-</span>
<a href="#l65.569"></a><span id="l65.569">   nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l65.570"></a><span id="l65.570" class="difflineminus">-  rv = GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l65.571"></a><span id="l65.571" class="difflineplus">+  nsresult rv = GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l65.572"></a><span id="l65.572">   if (!parentFolder)</span>
<a href="#l65.573"></a><span id="l65.573">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.574"></a><span id="l65.574"> </span>
<a href="#l65.575"></a><span id="l65.575" class="difflineminus">-  nsCOMPtr&lt;nsISupports&gt; parentSupport = do_QueryInterface(parentFolder);</span>
<a href="#l65.576"></a><span id="l65.576" class="difflineminus">-</span>
<a href="#l65.577"></a><span id="l65.577" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; oldSummaryFile;</span>
<a href="#l65.578"></a><span id="l65.578" class="difflineminus">-  rv = GetSummaryFileLocation(oldPathFile, getter_AddRefs(oldSummaryFile));</span>
<a href="#l65.579"></a><span id="l65.579" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.580"></a><span id="l65.580" class="difflineminus">-</span>
<a href="#l65.581"></a><span id="l65.581" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; dirFile;</span>
<a href="#l65.582"></a><span id="l65.582" class="difflineminus">-  PRInt32 count = mSubFolders.Count();</span>
<a href="#l65.583"></a><span id="l65.583" class="difflineminus">-</span>
<a href="#l65.584"></a><span id="l65.584" class="difflineminus">-  if (count &gt; 0)</span>
<a href="#l65.585"></a><span id="l65.585" class="difflineminus">-    rv = CreateDirectoryForFolder(getter_AddRefs(dirFile));</span>
<a href="#l65.586"></a><span id="l65.586" class="difflineminus">-</span>
<a href="#l65.587"></a><span id="l65.587" class="difflineminus">-  nsAutoString safeName(aNewName);</span>
<a href="#l65.588"></a><span id="l65.588" class="difflineminus">-  NS_MsgHashIfNecessary(safeName);</span>
<a href="#l65.589"></a><span id="l65.589" class="difflineminus">-</span>
<a href="#l65.590"></a><span id="l65.590" class="difflineminus">-  if (mName.Equals(aNewName, nsCaseInsensitiveStringComparator()))</span>
<a href="#l65.591"></a><span id="l65.591" class="difflineminus">-  {</span>
<a href="#l65.592"></a><span id="l65.592" class="difflineminus">-    if (msgWindow)</span>
<a href="#l65.593"></a><span id="l65.593" class="difflineminus">-      rv = ThrowAlertMsg(&quot;folderExists&quot;, msgWindow);</span>
<a href="#l65.594"></a><span id="l65.594" class="difflineminus">-    return NS_MSG_FOLDER_EXISTS;</span>
<a href="#l65.595"></a><span id="l65.595" class="difflineminus">-  }</span>
<a href="#l65.596"></a><span id="l65.596" class="difflineminus">-</span>
<a href="#l65.597"></a><span id="l65.597" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; parentPathFile;</span>
<a href="#l65.598"></a><span id="l65.598" class="difflineminus">-  parentFolder-&gt;GetFilePath(getter_AddRefs(parentPathFile));</span>
<a href="#l65.599"></a><span id="l65.599" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l65.600"></a><span id="l65.600" class="difflineminus">-</span>
<a href="#l65.601"></a><span id="l65.601" class="difflineminus">-  bool isDirectory = false;</span>
<a href="#l65.602"></a><span id="l65.602" class="difflineminus">-  parentPathFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l65.603"></a><span id="l65.603" class="difflineminus">-  if (!isDirectory)</span>
<a href="#l65.604"></a><span id="l65.604" class="difflineminus">-    AddDirectorySeparator(parentPathFile);</span>
<a href="#l65.605"></a><span id="l65.605" class="difflineminus">-</span>
<a href="#l65.606"></a><span id="l65.606">   rv = CheckIfFolderExists(aNewName, parentFolder, msgWindow);</span>
<a href="#l65.607"></a><span id="l65.607">   if (NS_FAILED(rv))</span>
<a href="#l65.608"></a><span id="l65.608">     return rv;</span>
<a href="#l65.609"></a><span id="l65.609"> </span>
<a href="#l65.610"></a><span id="l65.610" class="difflineminus">-  ForceDBClosed();</span>
<a href="#l65.611"></a><span id="l65.611" class="difflineminus">-  rv = oldPathFile-&gt;MoveTo(nsnull, safeName);</span>
<a href="#l65.612"></a><span id="l65.612" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.613"></a><span id="l65.613" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; newFolder;</span>
<a href="#l65.614"></a><span id="l65.614" class="difflineplus">+  rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.615"></a><span id="l65.615" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.616"></a><span id="l65.616" class="difflineplus">+  rv = msgStore-&gt;RenameFolder(this, aNewName, getter_AddRefs(newFolder));</span>
<a href="#l65.617"></a><span id="l65.617">   if (NS_FAILED(rv))</span>
<a href="#l65.618"></a><span id="l65.618">   {</span>
<a href="#l65.619"></a><span id="l65.619" class="difflineminus">-    ThrowAlertMsg(&quot;folderRenameFailed&quot;, msgWindow);</span>
<a href="#l65.620"></a><span id="l65.620" class="difflineplus">+    if (msgWindow)</span>
<a href="#l65.621"></a><span id="l65.621" class="difflineplus">+      (void) ThrowAlertMsg((rv == NS_MSG_FOLDER_EXISTS) ?</span>
<a href="#l65.622"></a><span id="l65.622" class="difflineplus">+                            &quot;folderExists&quot; : &quot;folderRenameFailed&quot;, msgWindow);</span>
<a href="#l65.623"></a><span id="l65.623">     return rv;</span>
<a href="#l65.624"></a><span id="l65.624">   }</span>
<a href="#l65.625"></a><span id="l65.625"> </span>
<a href="#l65.626"></a><span id="l65.626" class="difflineminus">-  nsAutoString summaryName(safeName);</span>
<a href="#l65.627"></a><span id="l65.627" class="difflineminus">-  summaryName.AppendLiteral(SUMMARY_SUFFIX);</span>
<a href="#l65.628"></a><span id="l65.628" class="difflineminus">-  oldSummaryFile-&gt;MoveTo(nsnull, summaryName);</span>
<a href="#l65.629"></a><span id="l65.629" class="difflineminus">-</span>
<a href="#l65.630"></a><span id="l65.630" class="difflineminus">-  if (count &gt; 0)</span>
<a href="#l65.631"></a><span id="l65.631" class="difflineminus">-  {</span>
<a href="#l65.632"></a><span id="l65.632" class="difflineminus">-    // rename &quot;*.sbd&quot; directory</span>
<a href="#l65.633"></a><span id="l65.633" class="difflineminus">-    nsAutoString newNameDirStr(safeName);</span>
<a href="#l65.634"></a><span id="l65.634" class="difflineminus">-    newNameDirStr.AppendLiteral(&quot;.sbd&quot;);</span>
<a href="#l65.635"></a><span id="l65.635" class="difflineminus">-    dirFile-&gt;MoveTo(nsnull, newNameDirStr);</span>
<a href="#l65.636"></a><span id="l65.636" class="difflineminus">-  }</span>
<a href="#l65.637"></a><span id="l65.637" class="difflineminus">-</span>
<a href="#l65.638"></a><span id="l65.638" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; newFolder;</span>
<a href="#l65.639"></a><span id="l65.639" class="difflineminus">-  if (parentSupport)</span>
<a href="#l65.640"></a><span id="l65.640" class="difflineminus">-  {</span>
<a href="#l65.641"></a><span id="l65.641" class="difflineminus">-    rv = parentFolder-&gt;AddSubfolder(safeName, getter_AddRefs(newFolder));</span>
<a href="#l65.642"></a><span id="l65.642" class="difflineplus">+  PRInt32 count = mSubFolders.Count();</span>
<a href="#l65.643"></a><span id="l65.643">     if (newFolder)</span>
<a href="#l65.644"></a><span id="l65.644">     {</span>
<a href="#l65.645"></a><span id="l65.645">       // Because we just renamed the db, w/o setting the pretty name in it,</span>
<a href="#l65.646"></a><span id="l65.646">       // we need to force the pretty name to be correct.</span>
<a href="#l65.647"></a><span id="l65.647">       // SetPrettyName won't write the name to the db if it doesn't think the</span>
<a href="#l65.648"></a><span id="l65.648">       // name has changed. This hack forces the pretty name to get set in the db.</span>
<a href="#l65.649"></a><span id="l65.649">       // We could set the new pretty name on the db before renaming the .msf file,</span>
<a href="#l65.650"></a><span id="l65.650">       // but if the rename failed, it would be out of sync.</span>
<a href="#l65.651"></a><span id="l65.651" class="difflineat">@@ -1224,24 +981,23 @@ NS_IMETHODIMP nsMsgLocalMailFolder::Rena</span>
<a href="#l65.652"></a><span id="l65.652">       newFolder-&gt;SetFlags(mFlags);</span>
<a href="#l65.653"></a><span id="l65.653">       if (parentFolder)</span>
<a href="#l65.654"></a><span id="l65.654">       {</span>
<a href="#l65.655"></a><span id="l65.655">         SetParent(nsnull);</span>
<a href="#l65.656"></a><span id="l65.656">         parentFolder-&gt;PropagateDelete(this, PR_FALSE, msgWindow);</span>
<a href="#l65.657"></a><span id="l65.657">         parentFolder-&gt;NotifyItemAdded(newFolder);</span>
<a href="#l65.658"></a><span id="l65.658">       }</span>
<a href="#l65.659"></a><span id="l65.659">       SetFilePath(nsnull); // forget our path, since this folder object renamed itself</span>
<a href="#l65.660"></a><span id="l65.660" class="difflineminus">-      nsCOMPtr&lt;nsIAtom&gt; folderRenameAtom = MsgGetAtom(&quot;RenameCompleted&quot;);</span>
<a href="#l65.661"></a><span id="l65.661" class="difflineplus">+    nsCOMPtr&lt;nsIAtom&gt; folderRenameAtom = do_GetAtom(&quot;RenameCompleted&quot;);</span>
<a href="#l65.662"></a><span id="l65.662">       newFolder-&gt;NotifyFolderEvent(folderRenameAtom);</span>
<a href="#l65.663"></a><span id="l65.663"> </span>
<a href="#l65.664"></a><span id="l65.664">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l65.665"></a><span id="l65.665">       if (notifier)</span>
<a href="#l65.666"></a><span id="l65.666">         notifier-&gt;NotifyFolderRenamed(this, newFolder);</span>
<a href="#l65.667"></a><span id="l65.667">     }</span>
<a href="#l65.668"></a><span id="l65.668" class="difflineminus">-  }</span>
<a href="#l65.669"></a><span id="l65.669">   return rv;</span>
<a href="#l65.670"></a><span id="l65.670"> }</span>
<a href="#l65.671"></a><span id="l65.671"> </span>
<a href="#l65.672"></a><span id="l65.672"> NS_IMETHODIMP nsMsgLocalMailFolder::RenameSubFolders(nsIMsgWindow *msgWindow, nsIMsgFolder *oldFolder)</span>
<a href="#l65.673"></a><span id="l65.673"> {</span>
<a href="#l65.674"></a><span id="l65.674">   nsresult rv =NS_OK;</span>
<a href="#l65.675"></a><span id="l65.675">   mInitialized = PR_TRUE;</span>
<a href="#l65.676"></a><span id="l65.676"> </span>
<a href="#l65.677"></a><span id="l65.677" class="difflineat">@@ -1305,39 +1061,42 @@ nsresult nsMsgLocalMailFolder::OpenDatab</span>
<a href="#l65.678"></a><span id="l65.678"> {</span>
<a href="#l65.679"></a><span id="l65.679">   nsresult rv;</span>
<a href="#l65.680"></a><span id="l65.680">   nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l65.681"></a><span id="l65.681">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.682"></a><span id="l65.682"> </span>
<a href="#l65.683"></a><span id="l65.683">   bool folderEmpty = false;</span>
<a href="#l65.684"></a><span id="l65.684">   nsCOMPtr &lt;nsILocalFile&gt; file;</span>
<a href="#l65.685"></a><span id="l65.685">   rv = GetFilePath(getter_AddRefs(file));</span>
<a href="#l65.686"></a><span id="l65.686" class="difflineminus">-  // check for case of trying to open db for 0 byte folder (i.e., new folder),</span>
<a href="#l65.687"></a><span id="l65.687" class="difflineminus">-  // and in that case, tell msg db to create a new db and set it valid after opening it.</span>
<a href="#l65.688"></a><span id="l65.688" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l65.689"></a><span id="l65.689" class="difflineminus">-  {</span>
<a href="#l65.690"></a><span id="l65.690" class="difflineminus">-    PRInt64 mailboxSize;</span>
<a href="#l65.691"></a><span id="l65.691" class="difflineminus">-    if (NS_SUCCEEDED(file-&gt;GetFileSize(&amp;mailboxSize)))</span>
<a href="#l65.692"></a><span id="l65.692" class="difflineminus">-      folderEmpty = !mailboxSize;</span>
<a href="#l65.693"></a><span id="l65.693" class="difflineminus">-  }</span>
<a href="#l65.694"></a><span id="l65.694"> </span>
<a href="#l65.695"></a><span id="l65.695">   rv = msgDBService-&gt;OpenFolderDB(this, PR_TRUE, getter_AddRefs(mDatabase));</span>
<a href="#l65.696"></a><span id="l65.696" class="difflineminus">-  if (folderEmpty)</span>
<a href="#l65.697"></a><span id="l65.697" class="difflineminus">-  {</span>
<a href="#l65.698"></a><span id="l65.698">     if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l65.699"></a><span id="l65.699">     {</span>
<a href="#l65.700"></a><span id="l65.700" class="difflineminus">-      rv = msgDBService-&gt;CreateNewDB(this, getter_AddRefs(mDatabase));</span>
<a href="#l65.701"></a><span id="l65.701" class="difflineminus">-      if (mDatabase)</span>
<a href="#l65.702"></a><span id="l65.702" class="difflineplus">+    // check if we're a real folder by looking at the parent folder.</span>
<a href="#l65.703"></a><span id="l65.703" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; parent;</span>
<a href="#l65.704"></a><span id="l65.704" class="difflineplus">+    GetParent(getter_AddRefs(parent));</span>
<a href="#l65.705"></a><span id="l65.705" class="difflineplus">+    if (parent)</span>
<a href="#l65.706"></a><span id="l65.706" class="difflineplus">+    {</span>
<a href="#l65.707"></a><span id="l65.707" class="difflineplus">+      // This little dance creates an empty .msf file and then checks</span>
<a href="#l65.708"></a><span id="l65.708" class="difflineplus">+      // if the db is valid - this works if the folder is empty, which</span>
<a href="#l65.709"></a><span id="l65.709" class="difflineplus">+      // we don't have a direct way of checking.</span>
<a href="#l65.710"></a><span id="l65.710" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l65.711"></a><span id="l65.711" class="difflineplus">+      rv = msgDBService-&gt;CreateNewDB(this, getter_AddRefs(db));</span>
<a href="#l65.712"></a><span id="l65.712" class="difflineplus">+      if (db)</span>
<a href="#l65.713"></a><span id="l65.713">       {</span>
<a href="#l65.714"></a><span id="l65.714" class="difflineminus">-        mDatabase-&gt;SetSummaryValid(PR_TRUE);</span>
<a href="#l65.715"></a><span id="l65.715">         UpdateSummaryTotals(PR_TRUE);</span>
<a href="#l65.716"></a><span id="l65.716" class="difflineplus">+        db-&gt;Close(PR_TRUE);</span>
<a href="#l65.717"></a><span id="l65.717" class="difflineplus">+        mDatabase = nsnull;</span>
<a href="#l65.718"></a><span id="l65.718" class="difflineplus">+        db = nsnull;</span>
<a href="#l65.719"></a><span id="l65.719" class="difflineplus">+        rv = msgDBService-&gt;OpenFolderDB(this, PR_FALSE,</span>
<a href="#l65.720"></a><span id="l65.720" class="difflineplus">+                                        getter_AddRefs(mDatabase));</span>
<a href="#l65.721"></a><span id="l65.721" class="difflineplus">+        if (NS_FAILED(rv))</span>
<a href="#l65.722"></a><span id="l65.722" class="difflineplus">+          mDatabase = nsnull;</span>
<a href="#l65.723"></a><span id="l65.723">       }</span>
<a href="#l65.724"></a><span id="l65.724">     }</span>
<a href="#l65.725"></a><span id="l65.725" class="difflineminus">-    else if (NS_FAILED(rv))</span>
<a href="#l65.726"></a><span id="l65.726" class="difflineminus">-      mDatabase = nsnull;</span>
<a href="#l65.727"></a><span id="l65.727">   }</span>
<a href="#l65.728"></a><span id="l65.728">   else if (NS_FAILED(rv))</span>
<a href="#l65.729"></a><span id="l65.729">     mDatabase = nsnull;</span>
<a href="#l65.730"></a><span id="l65.730"> </span>
<a href="#l65.731"></a><span id="l65.731">   return rv;</span>
<a href="#l65.732"></a><span id="l65.732"> }</span>
<a href="#l65.733"></a><span id="l65.733"> </span>
<a href="#l65.734"></a><span id="l65.734"> NS_IMETHODIMP</span>
<a href="#l65.735"></a><span id="l65.735" class="difflineat">@@ -1505,21 +1264,31 @@ nsMsgLocalMailFolder::DeleteMessages(nsI</span>
<a href="#l65.736"></a><span id="l65.736">     {</span>
<a href="#l65.737"></a><span id="l65.737">       if (deleteStorage &amp;&amp; isMove &amp;&amp; GetDeleteFromServerOnMove())</span>
<a href="#l65.738"></a><span id="l65.738">         MarkMsgsOnPop3Server(messages, POP3_DELETE);</span>
<a href="#l65.739"></a><span id="l65.739"> </span>
<a href="#l65.740"></a><span id="l65.740">       nsCOMPtr&lt;nsISupports&gt; msgSupport;</span>
<a href="#l65.741"></a><span id="l65.741">       rv = EnableNotifications(allMessageCountNotifications, PR_FALSE, PR_TRUE /*dbBatching*/);</span>
<a href="#l65.742"></a><span id="l65.742">       if (NS_SUCCEEDED(rv))</span>
<a href="#l65.743"></a><span id="l65.743">       {</span>
<a href="#l65.744"></a><span id="l65.744" class="difflineplus">+        nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.745"></a><span id="l65.745" class="difflineplus">+        rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.746"></a><span id="l65.746" class="difflineplus">+        if (NS_SUCCEEDED(rv))</span>
<a href="#l65.747"></a><span id="l65.747" class="difflineplus">+        {</span>
<a href="#l65.748"></a><span id="l65.748" class="difflineplus">+          rv = msgStore-&gt;DeleteMessages(messages);</span>
<a href="#l65.749"></a><span id="l65.749" class="difflineplus">+          GetDatabase();</span>
<a href="#l65.750"></a><span id="l65.750" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr;</span>
<a href="#l65.751"></a><span id="l65.751" class="difflineplus">+          if (mDatabase)</span>
<a href="#l65.752"></a><span id="l65.752" class="difflineplus">+          {</span>
<a href="#l65.753"></a><span id="l65.753">         for (PRUint32 i = 0; i &lt; messageCount; ++i)</span>
<a href="#l65.754"></a><span id="l65.754">         {</span>
<a href="#l65.755"></a><span id="l65.755" class="difflineminus">-          msgSupport = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l65.756"></a><span id="l65.756" class="difflineminus">-          if (msgSupport)</span>
<a href="#l65.757"></a><span id="l65.757" class="difflineminus">-            DeleteMessage(msgSupport, msgWindow, PR_TRUE, PR_FALSE);</span>
<a href="#l65.758"></a><span id="l65.758" class="difflineplus">+              msgDBHdr = do_QueryElementAt(messages, i, &amp;rv);</span>
<a href="#l65.759"></a><span id="l65.759" class="difflineplus">+              rv = mDatabase-&gt;DeleteHeader(msgDBHdr, nsnull, PR_FALSE, PR_TRUE);</span>
<a href="#l65.760"></a><span id="l65.760" class="difflineplus">+            }</span>
<a href="#l65.761"></a><span id="l65.761" class="difflineplus">+          }</span>
<a href="#l65.762"></a><span id="l65.762">         }</span>
<a href="#l65.763"></a><span id="l65.763">       }</span>
<a href="#l65.764"></a><span id="l65.764">       else if (rv == NS_MSG_FOLDER_BUSY)</span>
<a href="#l65.765"></a><span id="l65.765">         ThrowAlertMsg(&quot;deletingMsgsFailed&quot;, msgWindow);</span>
<a href="#l65.766"></a><span id="l65.766"> </span>
<a href="#l65.767"></a><span id="l65.767">       // we are the source folder here for a move or shift delete</span>
<a href="#l65.768"></a><span id="l65.768">       //enable notifications because that will close the file stream</span>
<a href="#l65.769"></a><span id="l65.769">       // we've been caching, mark the db as valid, and commit it.</span>
<a href="#l65.770"></a><span id="l65.770" class="difflineat">@@ -1528,25 +1297,48 @@ nsMsgLocalMailFolder::DeleteMessages(nsI</span>
<a href="#l65.771"></a><span id="l65.771">         NotifyFolderEvent(NS_SUCCEEDED(rv) ? mDeleteOrMoveMsgCompletedAtom : mDeleteOrMoveMsgFailedAtom);</span>
<a href="#l65.772"></a><span id="l65.772">       if (msgWindow &amp;&amp; !isMove)</span>
<a href="#l65.773"></a><span id="l65.773">         AutoCompact(msgWindow);</span>
<a href="#l65.774"></a><span id="l65.774">     }</span>
<a href="#l65.775"></a><span id="l65.775">   }</span>
<a href="#l65.776"></a><span id="l65.776">   return rv;</span>
<a href="#l65.777"></a><span id="l65.777"> }</span>
<a href="#l65.778"></a><span id="l65.778"> </span>
<a href="#l65.779"></a><span id="l65.779" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l65.780"></a><span id="l65.780" class="difflineplus">+nsMsgLocalMailFolder::MarkMessagesRead(nsIArray *aMessages, bool aMarkRead)</span>
<a href="#l65.781"></a><span id="l65.781" class="difflineplus">+{</span>
<a href="#l65.782"></a><span id="l65.782" class="difflineplus">+  nsresult rv = nsMsgDBFolder::MarkMessagesRead(aMessages, aMarkRead);</span>
<a href="#l65.783"></a><span id="l65.783" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.784"></a><span id="l65.784" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.785"></a><span id="l65.785" class="difflineplus">+  rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.786"></a><span id="l65.786" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.787"></a><span id="l65.787" class="difflineplus">+  return msgStore-&gt;ChangeFlags(aMessages, nsMsgMessageFlags::Read, aMarkRead);</span>
<a href="#l65.788"></a><span id="l65.788" class="difflineplus">+}</span>
<a href="#l65.789"></a><span id="l65.789" class="difflineplus">+</span>
<a href="#l65.790"></a><span id="l65.790" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l65.791"></a><span id="l65.791" class="difflineplus">+nsMsgLocalMailFolder::MarkMessagesFlagged(nsIArray *aMessages,</span>
<a href="#l65.792"></a><span id="l65.792" class="difflineplus">+                                          bool aMarkFlagged)</span>
<a href="#l65.793"></a><span id="l65.793" class="difflineplus">+{</span>
<a href="#l65.794"></a><span id="l65.794" class="difflineplus">+  nsresult rv = nsMsgDBFolder::MarkMessagesFlagged(aMessages, aMarkFlagged);</span>
<a href="#l65.795"></a><span id="l65.795" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.796"></a><span id="l65.796" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.797"></a><span id="l65.797" class="difflineplus">+  rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.798"></a><span id="l65.798" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.799"></a><span id="l65.799" class="difflineplus">+  return msgStore-&gt;ChangeFlags(aMessages, nsMsgMessageFlags::Marked,</span>
<a href="#l65.800"></a><span id="l65.800" class="difflineplus">+                               aMarkFlagged);</span>
<a href="#l65.801"></a><span id="l65.801" class="difflineplus">+}</span>
<a href="#l65.802"></a><span id="l65.802" class="difflineplus">+</span>
<a href="#l65.803"></a><span id="l65.803"> nsresult</span>
<a href="#l65.804"></a><span id="l65.804"> nsMsgLocalMailFolder::InitCopyState(nsISupports* aSupport,</span>
<a href="#l65.805"></a><span id="l65.805">                                     nsIArray* messages,</span>
<a href="#l65.806"></a><span id="l65.806">                                     bool isMove,</span>
<a href="#l65.807"></a><span id="l65.807">                                     nsIMsgCopyServiceListener* listener,</span>
<a href="#l65.808"></a><span id="l65.808">                                     nsIMsgWindow *msgWindow, bool isFolder,</span>
<a href="#l65.809"></a><span id="l65.809">                                     bool allowUndo)</span>
<a href="#l65.810"></a><span id="l65.810"> {</span>
<a href="#l65.811"></a><span id="l65.811" class="difflineminus">-  nsresult rv = NS_OK;</span>
<a href="#l65.812"></a><span id="l65.812">   nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l65.813"></a><span id="l65.813"> </span>
<a href="#l65.814"></a><span id="l65.814">   NS_ASSERTION(!mCopyState, &quot;already copying a msg into this folder&quot;);</span>
<a href="#l65.815"></a><span id="l65.815">   if (mCopyState)</span>
<a href="#l65.816"></a><span id="l65.816">     return NS_ERROR_FAILURE; // already has a  copy in progress</span>
<a href="#l65.817"></a><span id="l65.817"> </span>
<a href="#l65.818"></a><span id="l65.818">   // get mDatabase set, so we can use it to add new hdrs to this db.</span>
<a href="#l65.819"></a><span id="l65.819">   // calling GetDatabase will set mDatabase - we use the comptr</span>
<a href="#l65.820"></a><span id="l65.820" class="difflineat">@@ -1559,35 +1351,28 @@ nsMsgLocalMailFolder::InitCopyState(nsIS</span>
<a href="#l65.821"></a><span id="l65.821">   bool isLocked;</span>
<a href="#l65.822"></a><span id="l65.822"> </span>
<a href="#l65.823"></a><span id="l65.823">   GetLocked(&amp;isLocked);</span>
<a href="#l65.824"></a><span id="l65.824">   if (isLocked)</span>
<a href="#l65.825"></a><span id="l65.825">     return NS_MSG_FOLDER_BUSY;</span>
<a href="#l65.826"></a><span id="l65.826"> </span>
<a href="#l65.827"></a><span id="l65.827">   AcquireSemaphore(static_cast&lt;nsIMsgLocalMailFolder*&gt;(this));</span>
<a href="#l65.828"></a><span id="l65.828"> </span>
<a href="#l65.829"></a><span id="l65.829" class="difflineminus">-  rv = GetFilePath(getter_AddRefs(path));</span>
<a href="#l65.830"></a><span id="l65.830" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.831"></a><span id="l65.831" class="difflineminus">-</span>
<a href="#l65.832"></a><span id="l65.832">   mCopyState = new nsLocalMailCopyState();</span>
<a href="#l65.833"></a><span id="l65.833">   NS_ENSURE_TRUE(mCopyState, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l65.834"></a><span id="l65.834"> </span>
<a href="#l65.835"></a><span id="l65.835">   mCopyState-&gt;m_dataBuffer = (char*) PR_CALLOC(COPY_BUFFER_SIZE+1);</span>
<a href="#l65.836"></a><span id="l65.836">   NS_ENSURE_TRUE(mCopyState-&gt;m_dataBuffer, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l65.837"></a><span id="l65.837"> </span>
<a href="#l65.838"></a><span id="l65.838">   mCopyState-&gt;m_dataBufferSize = COPY_BUFFER_SIZE;</span>
<a href="#l65.839"></a><span id="l65.839">   mCopyState-&gt;m_destDB = msgDB;</span>
<a href="#l65.840"></a><span id="l65.840"> </span>
<a href="#l65.841"></a><span id="l65.841">   //Before we continue we should verify that there is enough diskspace.</span>
<a href="#l65.842"></a><span id="l65.842">   //XXX How do we do this?</span>
<a href="#l65.843"></a><span id="l65.843" class="difflineminus">-  rv = MsgNewBufferedFileOutputStream(getter_AddRefs(mCopyState-&gt;m_fileStream), path, PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l65.844"></a><span id="l65.844" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.845"></a><span id="l65.845" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(mCopyState-&gt;m_fileStream);</span>
<a href="#l65.846"></a><span id="l65.846" class="difflineminus">-  //The new key is the end of the file</span>
<a href="#l65.847"></a><span id="l65.847" class="difflineminus">-  seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l65.848"></a><span id="l65.848" class="difflineplus">+  nsresult rv;</span>
<a href="#l65.849"></a><span id="l65.849">   mCopyState-&gt;m_srcSupport = do_QueryInterface(aSupport, &amp;rv);</span>
<a href="#l65.850"></a><span id="l65.850">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.851"></a><span id="l65.851">   mCopyState-&gt;m_messages = messages;</span>
<a href="#l65.852"></a><span id="l65.852">   mCopyState-&gt;m_curCopyIndex = 0;</span>
<a href="#l65.853"></a><span id="l65.853">   mCopyState-&gt;m_isMove = isMove;</span>
<a href="#l65.854"></a><span id="l65.854">   mCopyState-&gt;m_isFolder = isFolder;</span>
<a href="#l65.855"></a><span id="l65.855">   mCopyState-&gt;m_allowUndo = allowUndo;</span>
<a href="#l65.856"></a><span id="l65.856">   mCopyState-&gt;m_msgWindow = msgWindow;</span>
<a href="#l65.857"></a><span id="l65.857" class="difflineat">@@ -1619,21 +1404,22 @@ nsMsgLocalMailFolder::OnCopyCompleted(ns</span>
<a href="#l65.858"></a><span id="l65.858"> </span>
<a href="#l65.859"></a><span id="l65.859">   (void) RefreshSizeOnDisk();</span>
<a href="#l65.860"></a><span id="l65.860">   // we are the destination folder for a move/copy</span>
<a href="#l65.861"></a><span id="l65.861">   bool haveSemaphore;</span>
<a href="#l65.862"></a><span id="l65.862">   nsresult rv = TestSemaphore(static_cast&lt;nsIMsgLocalMailFolder*&gt;(this), &amp;haveSemaphore);</span>
<a href="#l65.863"></a><span id="l65.863">   if (NS_SUCCEEDED(rv) &amp;&amp; haveSemaphore)</span>
<a href="#l65.864"></a><span id="l65.864">     ReleaseSemaphore(static_cast&lt;nsIMsgLocalMailFolder*&gt;(this));</span>
<a href="#l65.865"></a><span id="l65.865"> </span>
<a href="#l65.866"></a><span id="l65.866" class="difflineminus">-  if (mCopyState &amp;&amp; !mCopyState-&gt;m_newMsgKeywords.IsEmpty() &amp;&amp; mCopyState-&gt;newHdr)</span>
<a href="#l65.867"></a><span id="l65.867" class="difflineplus">+  if (mCopyState &amp;&amp; !mCopyState-&gt;m_newMsgKeywords.IsEmpty() &amp;&amp;</span>
<a href="#l65.868"></a><span id="l65.868" class="difflineplus">+      mCopyState-&gt;m_newHdr)</span>
<a href="#l65.869"></a><span id="l65.869">   {</span>
<a href="#l65.870"></a><span id="l65.870">     nsCOMPtr&lt;nsIMutableArray&gt; messageArray(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l65.871"></a><span id="l65.871">     NS_ENSURE_TRUE(messageArray, rv);</span>
<a href="#l65.872"></a><span id="l65.872" class="difflineminus">-    messageArray-&gt;AppendElement(mCopyState-&gt;newHdr, PR_FALSE);</span>
<a href="#l65.873"></a><span id="l65.873" class="difflineplus">+    messageArray-&gt;AppendElement(mCopyState-&gt;m_newHdr, PR_FALSE);</span>
<a href="#l65.874"></a><span id="l65.874">     AddKeywordsToMessages(messageArray, mCopyState-&gt;m_newMsgKeywords);</span>
<a href="#l65.875"></a><span id="l65.875">   }</span>
<a href="#l65.876"></a><span id="l65.876">   if (moveCopySucceeded &amp;&amp; mDatabase)</span>
<a href="#l65.877"></a><span id="l65.877">   {</span>
<a href="#l65.878"></a><span id="l65.878">     mDatabase-&gt;SetSummaryValid(PR_TRUE);</span>
<a href="#l65.879"></a><span id="l65.879">     (void) CloseDBIfFolderNotOpen();</span>
<a href="#l65.880"></a><span id="l65.880">   }</span>
<a href="#l65.881"></a><span id="l65.881"> </span>
<a href="#l65.882"></a><span id="l65.882" class="difflineat">@@ -1666,26 +1452,22 @@ nsMsgLocalMailFolder::SortMessagesBasedO</span>
<a href="#l65.883"></a><span id="l65.883"> }</span>
<a href="#l65.884"></a><span id="l65.884"> </span>
<a href="#l65.885"></a><span id="l65.885"> bool nsMsgLocalMailFolder::CheckIfSpaceForCopy(nsIMsgWindow *msgWindow,</span>
<a href="#l65.886"></a><span id="l65.886">                                                  nsIMsgFolder *srcFolder,</span>
<a href="#l65.887"></a><span id="l65.887">                                                  nsISupports *srcSupports,</span>
<a href="#l65.888"></a><span id="l65.888">                                                  bool isMove,</span>
<a href="#l65.889"></a><span id="l65.889">                                                  PRInt64 totalMsgSize)</span>
<a href="#l65.890"></a><span id="l65.890"> {</span>
<a href="#l65.891"></a><span id="l65.891" class="difflineminus">-  PRInt64 sizeOnDisk;</span>
<a href="#l65.892"></a><span id="l65.892" class="difflineminus">-</span>
<a href="#l65.893"></a><span id="l65.893" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; filePath;</span>
<a href="#l65.894"></a><span id="l65.894" class="difflineminus">-  nsresult rv = GetFilePath(getter_AddRefs(filePath));</span>
<a href="#l65.895"></a><span id="l65.895" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l65.896"></a><span id="l65.896" class="difflineminus">-    rv = filePath-&gt;GetFileSize(&amp;sizeOnDisk);</span>
<a href="#l65.897"></a><span id="l65.897" class="difflineminus">-</span>
<a href="#l65.898"></a><span id="l65.898" class="difflineminus">-  // check if the folder size + the size of the messages will be &gt; 4GB or so.</span>
<a href="#l65.899"></a><span id="l65.899" class="difflineminus">-  // If so, warn, and return an error.</span>
<a href="#l65.900"></a><span id="l65.900" class="difflineminus">-  if (NS_FAILED(rv) || sizeOnDisk + totalMsgSize &gt; 0xFFC00000LL)</span>
<a href="#l65.901"></a><span id="l65.901" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.902"></a><span id="l65.902" class="difflineplus">+  nsresult rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.903"></a><span id="l65.903" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.904"></a><span id="l65.904" class="difflineplus">+  bool spaceAvailable;</span>
<a href="#l65.905"></a><span id="l65.905" class="difflineplus">+  rv = msgStore-&gt;HasSpaceAvailable(this, totalMsgSize, &amp;spaceAvailable);</span>
<a href="#l65.906"></a><span id="l65.906" class="difflineplus">+  if (!spaceAvailable)</span>
<a href="#l65.907"></a><span id="l65.907">   {</span>
<a href="#l65.908"></a><span id="l65.908">     ThrowAlertMsg(&quot;mailboxTooLarge&quot;, msgWindow);</span>
<a href="#l65.909"></a><span id="l65.909">     if (isMove &amp;&amp; srcFolder)</span>
<a href="#l65.910"></a><span id="l65.910">       srcFolder-&gt;NotifyFolderEvent(mDeleteOrMoveMsgFailedAtom);</span>
<a href="#l65.911"></a><span id="l65.911">     OnCopyCompleted(srcSupports, PR_FALSE);</span>
<a href="#l65.912"></a><span id="l65.912">     return PR_FALSE;</span>
<a href="#l65.913"></a><span id="l65.913">   }</span>
<a href="#l65.914"></a><span id="l65.914">   return PR_TRUE;</span>
<a href="#l65.915"></a><span id="l65.915" class="difflineat">@@ -1749,16 +1531,27 @@ nsMsgLocalMailFolder::CopyMessages(nsIMs</span>
<a href="#l65.916"></a><span id="l65.916">       }</span>
<a href="#l65.917"></a><span id="l65.917">     }</span>
<a href="#l65.918"></a><span id="l65.918">   }</span>
<a href="#l65.919"></a><span id="l65.919"> </span>
<a href="#l65.920"></a><span id="l65.920">   if (!CheckIfSpaceForCopy(msgWindow, srcFolder, srcSupport, isMove,</span>
<a href="#l65.921"></a><span id="l65.921">                            totalMsgSize))</span>
<a href="#l65.922"></a><span id="l65.922">     return NS_OK;</span>
<a href="#l65.923"></a><span id="l65.923"> </span>
<a href="#l65.924"></a><span id="l65.924" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.925"></a><span id="l65.925" class="difflineplus">+  bool storeDidCopy = false;</span>
<a href="#l65.926"></a><span id="l65.926" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.927"></a><span id="l65.927" class="difflineplus">+  rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.928"></a><span id="l65.928" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.929"></a><span id="l65.929" class="difflineplus">+  rv = msgStore-&gt;CopyMessages(isMove, messages, this, listener, &amp;storeDidCopy);</span>
<a href="#l65.930"></a><span id="l65.930" class="difflineplus">+  if (storeDidCopy)</span>
<a href="#l65.931"></a><span id="l65.931" class="difflineplus">+    return rv;</span>
<a href="#l65.932"></a><span id="l65.932" class="difflineplus">+  // If the store doesn't do the copy, we'll stream the source messages into</span>
<a href="#l65.933"></a><span id="l65.933" class="difflineplus">+  // the target folder, using getMsgInputStream and getNewMsgOutputStream.</span>
<a href="#l65.934"></a><span id="l65.934" class="difflineplus">+</span>
<a href="#l65.935"></a><span id="l65.935">   // don't update the counts in the dest folder until it is all over</span>
<a href="#l65.936"></a><span id="l65.936">   EnableNotifications(allMessageCountNotifications, PR_FALSE, PR_FALSE /*dbBatching*/);  //dest folder doesn't need db batching</span>
<a href="#l65.937"></a><span id="l65.937"> </span>
<a href="#l65.938"></a><span id="l65.938">   // sort the message array by key</span>
<a href="#l65.939"></a><span id="l65.939">   PRUint32 numMsgs = 0;</span>
<a href="#l65.940"></a><span id="l65.940">   messages-&gt;GetLength(&amp;numMsgs);</span>
<a href="#l65.941"></a><span id="l65.941">   nsTArray&lt;nsMsgKey&gt; keyArray(numMsgs);</span>
<a href="#l65.942"></a><span id="l65.942">   if (numMsgs &gt; 1)</span>
<a href="#l65.943"></a><span id="l65.943" class="difflineat">@@ -1945,23 +1738,21 @@ nsMsgLocalMailFolder::CopyFolder( nsIMsg</span>
<a href="#l65.944"></a><span id="l65.944">   return isMoveFolder ? CopyFolderLocal(srcFolder, isMoveFolder, msgWindow, listener ) :</span>
<a href="#l65.945"></a><span id="l65.945">                       CopyFolderAcrossServer(srcFolder, msgWindow, listener );</span>
<a href="#l65.946"></a><span id="l65.946"> }</span>
<a href="#l65.947"></a><span id="l65.947"> </span>
<a href="#l65.948"></a><span id="l65.948"> NS_IMETHODIMP</span>
<a href="#l65.949"></a><span id="l65.949"> nsMsgLocalMailFolder::CopyFolderLocal(nsIMsgFolder *srcFolder,</span>
<a href="#l65.950"></a><span id="l65.950">                                       bool isMoveFolder,</span>
<a href="#l65.951"></a><span id="l65.951">                                       nsIMsgWindow *msgWindow,</span>
<a href="#l65.952"></a><span id="l65.952" class="difflineminus">-                                      nsIMsgCopyServiceListener *listener )</span>
<a href="#l65.953"></a><span id="l65.953" class="difflineplus">+                                      nsIMsgCopyServiceListener *aListener)</span>
<a href="#l65.954"></a><span id="l65.954"> {</span>
<a href="#l65.955"></a><span id="l65.955" class="difflineminus">-  nsresult rv;</span>
<a href="#l65.956"></a><span id="l65.956">   mInitialized = PR_TRUE;</span>
<a href="#l65.957"></a><span id="l65.957" class="difflineminus">-  nsCOMPtr&lt;nsIMsgFolder&gt; newMsgFolder;</span>
<a href="#l65.958"></a><span id="l65.958">   bool isChildOfTrash;</span>
<a href="#l65.959"></a><span id="l65.959" class="difflineminus">-  rv = IsChildOfTrash(&amp;isChildOfTrash);</span>
<a href="#l65.960"></a><span id="l65.960" class="difflineplus">+  nsresult rv = IsChildOfTrash(&amp;isChildOfTrash);</span>
<a href="#l65.961"></a><span id="l65.961">   if (NS_SUCCEEDED(rv) &amp;&amp; isChildOfTrash)</span>
<a href="#l65.962"></a><span id="l65.962">   {</span>
<a href="#l65.963"></a><span id="l65.963">     // do it just for the parent folder (isMoveFolder is true for parent only) if we are deleting/moving a folder tree</span>
<a href="#l65.964"></a><span id="l65.964">     // don't confirm for rss folders.</span>
<a href="#l65.965"></a><span id="l65.965">     if (isMoveFolder)</span>
<a href="#l65.966"></a><span id="l65.966">     {</span>
<a href="#l65.967"></a><span id="l65.967">       // if there's a msgWindow, confirm the deletion</span>
<a href="#l65.968"></a><span id="l65.968">       if (msgWindow) </span>
<a href="#l65.969"></a><span id="l65.969" class="difflineat">@@ -1982,198 +1773,27 @@ nsMsgLocalMailFolder::CopyFolderLocal(ns</span>
<a href="#l65.970"></a><span id="l65.970">     if (match &amp;&amp; msgWindow)</span>
<a href="#l65.971"></a><span id="l65.971">     {</span>
<a href="#l65.972"></a><span id="l65.972">       bool confirmed = false;</span>
<a href="#l65.973"></a><span id="l65.973">       srcFolder-&gt;ConfirmFolderDeletionForFilter(msgWindow, &amp;confirmed);</span>
<a href="#l65.974"></a><span id="l65.974">       if (!confirmed)</span>
<a href="#l65.975"></a><span id="l65.975">         return NS_MSG_ERROR_COPY_FOLDER_ABORTED;</span>
<a href="#l65.976"></a><span id="l65.976">     }</span>
<a href="#l65.977"></a><span id="l65.977">   }</span>
<a href="#l65.978"></a><span id="l65.978" class="difflineminus">-</span>
<a href="#l65.979"></a><span id="l65.979">   nsString folderName;</span>
<a href="#l65.980"></a><span id="l65.980">   srcFolder-&gt;GetName(folderName);</span>
<a href="#l65.981"></a><span id="l65.981" class="difflineminus">-  nsAutoString safeFolderName(folderName);</span>
<a href="#l65.982"></a><span id="l65.982" class="difflineminus">-  NS_MsgHashIfNecessary(safeFolderName);</span>
<a href="#l65.983"></a><span id="l65.983" class="difflineminus">-  nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localSrcFolder(do_QueryInterface(srcFolder));</span>
<a href="#l65.984"></a><span id="l65.984" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l65.985"></a><span id="l65.985" class="difflineminus">-  if (localSrcFolder)</span>
<a href="#l65.986"></a><span id="l65.986" class="difflineminus">-    localSrcFolder-&gt;GetDatabaseWOReparse(getter_AddRefs(srcDB));</span>
<a href="#l65.987"></a><span id="l65.987" class="difflineminus">-  bool summaryValid = (srcDB != nsnull);</span>
<a href="#l65.988"></a><span id="l65.988" class="difflineminus">-  srcDB = nsnull;</span>
<a href="#l65.989"></a><span id="l65.989" class="difflineminus">-  srcFolder-&gt;ForceDBClosed();</span>
<a href="#l65.990"></a><span id="l65.990" class="difflineminus">-</span>
<a href="#l65.991"></a><span id="l65.991" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; oldPath;</span>
<a href="#l65.992"></a><span id="l65.992" class="difflineminus">-  rv = srcFolder-&gt;GetFilePath(getter_AddRefs(oldPath));</span>
<a href="#l65.993"></a><span id="l65.993" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l65.994"></a><span id="l65.994" class="difflineminus">-</span>
<a href="#l65.995"></a><span id="l65.995" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; summaryFile;</span>
<a href="#l65.996"></a><span id="l65.996" class="difflineminus">-  GetSummaryFileLocation(oldPath, getter_AddRefs(summaryFile));</span>
<a href="#l65.997"></a><span id="l65.997" class="difflineminus">-</span>
<a href="#l65.998"></a><span id="l65.998" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; newPath;</span>
<a href="#l65.999"></a><span id="l65.999" class="difflineminus">-  rv = GetFilePath(getter_AddRefs(newPath));</span>
<a href="#l65.1000"></a><span id="l65.1000" class="difflineminus">-  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l65.1001"></a><span id="l65.1001" class="difflineminus">-</span>
<a href="#l65.1002"></a><span id="l65.1002" class="difflineminus">-  bool newPathIsDirectory = false;</span>
<a href="#l65.1003"></a><span id="l65.1003" class="difflineminus">-  newPath-&gt;IsDirectory(&amp;newPathIsDirectory);</span>
<a href="#l65.1004"></a><span id="l65.1004" class="difflineminus">-  if (!newPathIsDirectory)</span>
<a href="#l65.1005"></a><span id="l65.1005" class="difflineminus">-  {</span>
<a href="#l65.1006"></a><span id="l65.1006" class="difflineminus">-    AddDirectorySeparator(newPath);</span>
<a href="#l65.1007"></a><span id="l65.1007" class="difflineminus">-    newPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l65.1008"></a><span id="l65.1008" class="difflineminus">-  }</span>
<a href="#l65.1009"></a><span id="l65.1009" class="difflineminus">-</span>
<a href="#l65.1010"></a><span id="l65.1010">   rv = CheckIfFolderExists(folderName, this, msgWindow);</span>
<a href="#l65.1011"></a><span id="l65.1011">   if (NS_FAILED(rv))</span>
<a href="#l65.1012"></a><span id="l65.1012">     return rv;</span>
<a href="#l65.1013"></a><span id="l65.1013"> </span>
<a href="#l65.1014"></a><span id="l65.1014" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; origPath;</span>
<a href="#l65.1015"></a><span id="l65.1015" class="difflineminus">-  oldPath-&gt;Clone(getter_AddRefs(origPath));</span>
<a href="#l65.1016"></a><span id="l65.1016" class="difflineminus">-</span>
<a href="#l65.1017"></a><span id="l65.1017" class="difflineminus">-  rv = oldPath-&gt;CopyTo(newPath, EmptyString());   //copying necessary for aborting.... if failure return</span>
<a href="#l65.1018"></a><span id="l65.1018" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);      //would fail if a file by that name exists</span>
<a href="#l65.1019"></a><span id="l65.1019" class="difflineminus">-</span>
<a href="#l65.1020"></a><span id="l65.1020" class="difflineminus">-  // Copy to dir can fail if filespec does not exist. If copy fails, we test</span>
<a href="#l65.1021"></a><span id="l65.1021" class="difflineminus">-  // if the filespec exist or not, if it does not that's ok, we continue</span>
<a href="#l65.1022"></a><span id="l65.1022" class="difflineminus">-  // without copying it. If it fails and filespec exist and is not zero sized</span>
<a href="#l65.1023"></a><span id="l65.1023" class="difflineminus">-  // there is real problem</span>
<a href="#l65.1024"></a><span id="l65.1024" class="difflineminus">-  rv = summaryFile-&gt;CopyTo(newPath, EmptyString());      // Copy the file to the new dir</span>
<a href="#l65.1025"></a><span id="l65.1025" class="difflineminus">-  if (! NS_SUCCEEDED(rv))                   // Test if the copy is successfull</span>
<a href="#l65.1026"></a><span id="l65.1026" class="difflineminus">-  {</span>
<a href="#l65.1027"></a><span id="l65.1027" class="difflineminus">-    // Test if the filespec has data</span>
<a href="#l65.1028"></a><span id="l65.1028" class="difflineminus">-    bool exists;</span>
<a href="#l65.1029"></a><span id="l65.1029" class="difflineminus">-    PRInt64 fileSize;</span>
<a href="#l65.1030"></a><span id="l65.1030" class="difflineminus">-    summaryFile-&gt;Exists(&amp;exists);</span>
<a href="#l65.1031"></a><span id="l65.1031" class="difflineminus">-    summaryFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l65.1032"></a><span id="l65.1032" class="difflineminus">-    if (exists &amp;&amp; fileSize &gt; 0)</span>
<a href="#l65.1033"></a><span id="l65.1033" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);          // Yes, it should have worked !</span>
<a href="#l65.1034"></a><span id="l65.1034" class="difflineminus">-    // else case is filespec is zero sized, no need to copy it,</span>
<a href="#l65.1035"></a><span id="l65.1035" class="difflineminus">-    // not an error</span>
<a href="#l65.1036"></a><span id="l65.1036" class="difflineminus">-    // else case is filespec does not exist - not an error</span>
<a href="#l65.1037"></a><span id="l65.1037" class="difflineminus">-  }</span>
<a href="#l65.1038"></a><span id="l65.1038" class="difflineminus">-</span>
<a href="#l65.1039"></a><span id="l65.1039" class="difflineminus">-  // linux and mac are not good about maintaining the file stamp when copying folders</span>
<a href="#l65.1040"></a><span id="l65.1040" class="difflineminus">-  // around. So if the source folder db is good, set the dest db as good too.</span>
<a href="#l65.1041"></a><span id="l65.1041" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDatabase&gt; destDB;</span>
<a href="#l65.1042"></a><span id="l65.1042" class="difflineminus">-  if (summaryValid)</span>
<a href="#l65.1043"></a><span id="l65.1043" class="difflineminus">-  {</span>
<a href="#l65.1044"></a><span id="l65.1044" class="difflineminus">-    nsAutoString folderLeafName;</span>
<a href="#l65.1045"></a><span id="l65.1045" class="difflineminus">-    origPath-&gt;GetLeafName(folderLeafName);</span>
<a href="#l65.1046"></a><span id="l65.1046" class="difflineminus">-    newPath-&gt;Append(folderLeafName);</span>
<a href="#l65.1047"></a><span id="l65.1047" class="difflineminus">-    nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l65.1048"></a><span id="l65.1048" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.1049"></a><span id="l65.1049" class="difflineplus">+  rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.1050"></a><span id="l65.1050">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1051"></a><span id="l65.1051" class="difflineminus">-    rv = msgDBService-&gt;OpenMailDBFromFile(newPath, PR_FALSE, PR_TRUE, getter_AddRefs(destDB));</span>
<a href="#l65.1052"></a><span id="l65.1052" class="difflineminus">-    if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE &amp;&amp; destDB)</span>
<a href="#l65.1053"></a><span id="l65.1053" class="difflineminus">-      destDB-&gt;SetSummaryValid(PR_TRUE);</span>
<a href="#l65.1054"></a><span id="l65.1054" class="difflineminus">-  }</span>
<a href="#l65.1055"></a><span id="l65.1055" class="difflineminus">-  rv = AddSubfolder(safeFolderName, getter_AddRefs(newMsgFolder));</span>
<a href="#l65.1056"></a><span id="l65.1056" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1057"></a><span id="l65.1057" class="difflineminus">-</span>
<a href="#l65.1058"></a><span id="l65.1058" class="difflineminus">-  newMsgFolder-&gt;SetPrettyName(folderName);</span>
<a href="#l65.1059"></a><span id="l65.1059" class="difflineminus">-  PRUint32 flags;</span>
<a href="#l65.1060"></a><span id="l65.1060" class="difflineminus">-  srcFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l65.1061"></a><span id="l65.1061" class="difflineminus">-  newMsgFolder-&gt;SetFlags(flags);</span>
<a href="#l65.1062"></a><span id="l65.1062" class="difflineminus">-  bool changed = false;</span>
<a href="#l65.1063"></a><span id="l65.1063" class="difflineminus">-  rv = srcFolder-&gt;MatchOrChangeFilterDestination(newMsgFolder, PR_TRUE, &amp;changed);</span>
<a href="#l65.1064"></a><span id="l65.1064" class="difflineminus">-  if (changed)</span>
<a href="#l65.1065"></a><span id="l65.1065" class="difflineminus">-    srcFolder-&gt;AlertFilterChanged(msgWindow);</span>
<a href="#l65.1066"></a><span id="l65.1066" class="difflineminus">-</span>
<a href="#l65.1067"></a><span id="l65.1067" class="difflineminus">-  nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l65.1068"></a><span id="l65.1068" class="difflineminus">-  rv = srcFolder-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l65.1069"></a><span id="l65.1069" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1070"></a><span id="l65.1070" class="difflineminus">-</span>
<a href="#l65.1071"></a><span id="l65.1071" class="difflineminus">-  // Copy subfolders to the new location</span>
<a href="#l65.1072"></a><span id="l65.1072" class="difflineminus">-  nsresult copyStatus = NS_OK;</span>
<a href="#l65.1073"></a><span id="l65.1073" class="difflineminus">-  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localNewFolder(do_QueryInterface(newMsgFolder, &amp;rv));</span>
<a href="#l65.1074"></a><span id="l65.1074" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l65.1075"></a><span id="l65.1075" class="difflineminus">-  {</span>
<a href="#l65.1076"></a><span id="l65.1076" class="difflineminus">-    bool hasMore;</span>
<a href="#l65.1077"></a><span id="l65.1077" class="difflineminus">-    while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore &amp;&amp;</span>
<a href="#l65.1078"></a><span id="l65.1078" class="difflineminus">-           NS_SUCCEEDED(copyStatus))</span>
<a href="#l65.1079"></a><span id="l65.1079" class="difflineminus">-    {</span>
<a href="#l65.1080"></a><span id="l65.1080" class="difflineminus">-      nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l65.1081"></a><span id="l65.1081" class="difflineminus">-      enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l65.1082"></a><span id="l65.1082" class="difflineminus">-</span>
<a href="#l65.1083"></a><span id="l65.1083" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(item));</span>
<a href="#l65.1084"></a><span id="l65.1084" class="difflineminus">-      if (!folder)</span>
<a href="#l65.1085"></a><span id="l65.1085" class="difflineminus">-        continue;</span>
<a href="#l65.1086"></a><span id="l65.1086" class="difflineminus">-</span>
<a href="#l65.1087"></a><span id="l65.1087" class="difflineminus">-      // PR_FALSE needed to avoid un-necessary deletions</span>
<a href="#l65.1088"></a><span id="l65.1088" class="difflineminus">-      copyStatus = localNewFolder-&gt;CopyFolderLocal(folder, PR_FALSE, msgWindow, listener);</span>
<a href="#l65.1089"></a><span id="l65.1089" class="difflineminus">-      // Test if the call succeeded, if not we have to stop recursive call</span>
<a href="#l65.1090"></a><span id="l65.1090" class="difflineminus">-      if (NS_FAILED(copyStatus))</span>
<a href="#l65.1091"></a><span id="l65.1091" class="difflineminus">-      {</span>
<a href="#l65.1092"></a><span id="l65.1092" class="difflineminus">-        // Copy failed we have to notify caller to handle the error and stop</span>
<a href="#l65.1093"></a><span id="l65.1093" class="difflineminus">-        // moving the folders. In case this happens to the topmost level of</span>
<a href="#l65.1094"></a><span id="l65.1094" class="difflineminus">-        // recursive call, then we just need to break from the while loop and</span>
<a href="#l65.1095"></a><span id="l65.1095" class="difflineminus">-        // go to error handling code.</span>
<a href="#l65.1096"></a><span id="l65.1096" class="difflineminus">-        if (!isMoveFolder)</span>
<a href="#l65.1097"></a><span id="l65.1097" class="difflineminus">-          return copyStatus;</span>
<a href="#l65.1098"></a><span id="l65.1098" class="difflineminus">-        break;</span>
<a href="#l65.1099"></a><span id="l65.1099" class="difflineminus">-      }</span>
<a href="#l65.1100"></a><span id="l65.1100" class="difflineminus">-    }</span>
<a href="#l65.1101"></a><span id="l65.1101" class="difflineminus">-  }</span>
<a href="#l65.1102"></a><span id="l65.1102" class="difflineminus">-</span>
<a href="#l65.1103"></a><span id="l65.1103" class="difflineminus">-  if (isMoveFolder &amp;&amp; NS_SUCCEEDED(copyStatus))</span>
<a href="#l65.1104"></a><span id="l65.1104" class="difflineminus">-  {</span>
<a href="#l65.1105"></a><span id="l65.1105" class="difflineminus">-    if (localNewFolder)</span>
<a href="#l65.1106"></a><span id="l65.1106" class="difflineminus">-    {</span>
<a href="#l65.1107"></a><span id="l65.1107" class="difflineminus">-      nsCOMPtr&lt;nsISupports&gt; srcSupport(do_QueryInterface(srcFolder));</span>
<a href="#l65.1108"></a><span id="l65.1108" class="difflineminus">-      localNewFolder-&gt;OnCopyCompleted(srcSupport, PR_TRUE);</span>
<a href="#l65.1109"></a><span id="l65.1109" class="difflineminus">-    }</span>
<a href="#l65.1110"></a><span id="l65.1110" class="difflineminus">-</span>
<a href="#l65.1111"></a><span id="l65.1111" class="difflineminus">-    //notifying the &quot;folder&quot; that was dragged and dropped has been created.</span>
<a href="#l65.1112"></a><span id="l65.1112" class="difflineminus">-    //no need to do this for its subfolders - isMoveFolder will be true for &quot;folder&quot;</span>
<a href="#l65.1113"></a><span id="l65.1113" class="difflineminus">-    NotifyItemAdded(newMsgFolder);</span>
<a href="#l65.1114"></a><span id="l65.1114" class="difflineminus">-</span>
<a href="#l65.1115"></a><span id="l65.1115" class="difflineminus">-    nsCOMPtr&lt;nsIMsgFolder&gt; msgParent;</span>
<a href="#l65.1116"></a><span id="l65.1116" class="difflineminus">-    srcFolder-&gt;GetParent(getter_AddRefs(msgParent));</span>
<a href="#l65.1117"></a><span id="l65.1117" class="difflineminus">-    srcFolder-&gt;SetParent(nsnull);</span>
<a href="#l65.1118"></a><span id="l65.1118" class="difflineminus">-    if (msgParent)</span>
<a href="#l65.1119"></a><span id="l65.1119" class="difflineminus">-    {</span>
<a href="#l65.1120"></a><span id="l65.1120" class="difflineminus">-      msgParent-&gt;PropagateDelete(srcFolder, PR_FALSE, msgWindow);  // The files have already been moved, so delete storage PR_FALSE</span>
<a href="#l65.1121"></a><span id="l65.1121" class="difflineminus">-      oldPath-&gt;Remove(PR_FALSE);  //berkeley mailbox</span>
<a href="#l65.1122"></a><span id="l65.1122" class="difflineminus">-      nsCOMPtr &lt;nsIMsgDatabase&gt; srcDB; // we need to force closed the source db</span>
<a href="#l65.1123"></a><span id="l65.1123" class="difflineminus">-      srcFolder-&gt;Delete();</span>
<a href="#l65.1124"></a><span id="l65.1124" class="difflineminus">-</span>
<a href="#l65.1125"></a><span id="l65.1125" class="difflineminus">-      nsCOMPtr&lt;nsILocalFile&gt; parentPath;</span>
<a href="#l65.1126"></a><span id="l65.1126" class="difflineminus">-      rv = msgParent-&gt;GetFilePath(getter_AddRefs(parentPath));</span>
<a href="#l65.1127"></a><span id="l65.1127" class="difflineminus">-      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l65.1128"></a><span id="l65.1128" class="difflineminus">-</span>
<a href="#l65.1129"></a><span id="l65.1129" class="difflineminus">-      AddDirectorySeparator(parentPath);</span>
<a href="#l65.1130"></a><span id="l65.1130" class="difflineminus">-      nsCOMPtr &lt;nsISimpleEnumerator&gt; children;</span>
<a href="#l65.1131"></a><span id="l65.1131" class="difflineminus">-      parentPath-&gt;GetDirectoryEntries(getter_AddRefs(children));</span>
<a href="#l65.1132"></a><span id="l65.1132" class="difflineminus">-      bool more;</span>
<a href="#l65.1133"></a><span id="l65.1133" class="difflineminus">-      // checks if the directory is empty or not</span>
<a href="#l65.1134"></a><span id="l65.1134" class="difflineminus">-      if (children &amp;&amp; NS_SUCCEEDED(children-&gt;HasMoreElements(&amp;more)) &amp;&amp; !more)</span>
<a href="#l65.1135"></a><span id="l65.1135" class="difflineminus">-        parentPath-&gt;Remove(PR_TRUE);</span>
<a href="#l65.1136"></a><span id="l65.1136" class="difflineminus">-    }</span>
<a href="#l65.1137"></a><span id="l65.1137" class="difflineminus">-  }</span>
<a href="#l65.1138"></a><span id="l65.1138" class="difflineminus">-  else</span>
<a href="#l65.1139"></a><span id="l65.1139" class="difflineminus">-  {</span>
<a href="#l65.1140"></a><span id="l65.1140" class="difflineminus">-    // This is the case where the copy of a subfolder failed.</span>
<a href="#l65.1141"></a><span id="l65.1141" class="difflineminus">-    // We have to delete the newDirectory tree to make a &quot;rollback&quot;.</span>
<a href="#l65.1142"></a><span id="l65.1142" class="difflineminus">-    // Someone should add a popup to warn the user that the move was not</span>
<a href="#l65.1143"></a><span id="l65.1143" class="difflineminus">-    // possible.</span>
<a href="#l65.1144"></a><span id="l65.1144" class="difflineminus">-    if (isMoveFolder &amp;&amp; NS_FAILED(copyStatus))</span>
<a href="#l65.1145"></a><span id="l65.1145" class="difflineminus">-    {</span>
<a href="#l65.1146"></a><span id="l65.1146" class="difflineminus">-      nsCOMPtr&lt;nsIMsgFolder&gt; msgParent;</span>
<a href="#l65.1147"></a><span id="l65.1147" class="difflineminus">-      newMsgFolder-&gt;ForceDBClosed();</span>
<a href="#l65.1148"></a><span id="l65.1148" class="difflineminus">-      newMsgFolder-&gt;GetParent(getter_AddRefs(msgParent));</span>
<a href="#l65.1149"></a><span id="l65.1149" class="difflineminus">-      newMsgFolder-&gt;SetParent(nsnull);</span>
<a href="#l65.1150"></a><span id="l65.1150" class="difflineminus">-      if (msgParent)</span>
<a href="#l65.1151"></a><span id="l65.1151" class="difflineminus">-      {</span>
<a href="#l65.1152"></a><span id="l65.1152" class="difflineminus">-        msgParent-&gt;PropagateDelete(newMsgFolder, PR_FALSE, msgWindow);</span>
<a href="#l65.1153"></a><span id="l65.1153" class="difflineminus">-        newMsgFolder-&gt;Delete();</span>
<a href="#l65.1154"></a><span id="l65.1154" class="difflineminus">-        newMsgFolder-&gt;ForceDBClosed();</span>
<a href="#l65.1155"></a><span id="l65.1155" class="difflineminus">-        AddDirectorySeparator(newPath);</span>
<a href="#l65.1156"></a><span id="l65.1156" class="difflineminus">-        newPath-&gt;Remove(PR_TRUE);  //berkeley mailbox</span>
<a href="#l65.1157"></a><span id="l65.1157" class="difflineminus">-      }</span>
<a href="#l65.1158"></a><span id="l65.1158" class="difflineminus">-      return NS_ERROR_FAILURE;</span>
<a href="#l65.1159"></a><span id="l65.1159" class="difflineminus">-    }</span>
<a href="#l65.1160"></a><span id="l65.1160" class="difflineminus">-  }</span>
<a href="#l65.1161"></a><span id="l65.1161" class="difflineminus">-  return NS_OK;</span>
<a href="#l65.1162"></a><span id="l65.1162" class="difflineplus">+  return msgStore-&gt;CopyFolder(srcFolder, this, isMoveFolder, msgWindow,</span>
<a href="#l65.1163"></a><span id="l65.1163" class="difflineplus">+                              aListener);</span>
<a href="#l65.1164"></a><span id="l65.1164"> }</span>
<a href="#l65.1165"></a><span id="l65.1165"> </span>
<a href="#l65.1166"></a><span id="l65.1166"> NS_IMETHODIMP</span>
<a href="#l65.1167"></a><span id="l65.1167"> nsMsgLocalMailFolder::CopyFileMessage(nsIFile* aFile, </span>
<a href="#l65.1168"></a><span id="l65.1168">                                       nsIMsgDBHdr *msgToReplace,</span>
<a href="#l65.1169"></a><span id="l65.1169">                                       bool isDraftOrTemplate,</span>
<a href="#l65.1170"></a><span id="l65.1170">                                       PRUint32 newMsgFlags,</span>
<a href="#l65.1171"></a><span id="l65.1171">                                       const nsACString &amp;aNewMsgKeywords,</span>
<a href="#l65.1172"></a><span id="l65.1172" class="difflineat">@@ -2199,24 +1819,22 @@ nsMsgLocalMailFolder::CopyFileMessage(ns</span>
<a href="#l65.1173"></a><span id="l65.1173">   rv = InitCopyState(fileSupport, messages, msgToReplace ? PR_TRUE : PR_FALSE,</span>
<a href="#l65.1174"></a><span id="l65.1174">                      listener, msgWindow, PR_FALSE, PR_FALSE);</span>
<a href="#l65.1175"></a><span id="l65.1175">   if (NS_SUCCEEDED(rv))</span>
<a href="#l65.1176"></a><span id="l65.1176">   {</span>
<a href="#l65.1177"></a><span id="l65.1177">     if (mCopyState)</span>
<a href="#l65.1178"></a><span id="l65.1178">       mCopyState-&gt;m_newMsgKeywords = aNewMsgKeywords;</span>
<a href="#l65.1179"></a><span id="l65.1179"> </span>
<a href="#l65.1180"></a><span id="l65.1180">     parseMsgState = new nsParseMailMessageState();</span>
<a href="#l65.1181"></a><span id="l65.1181" class="difflineminus">-    if (parseMsgState)</span>
<a href="#l65.1182"></a><span id="l65.1182" class="difflineminus">-    {</span>
<a href="#l65.1183"></a><span id="l65.1183" class="difflineplus">+    NS_ENSURE_TRUE(parseMsgState, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l65.1184"></a><span id="l65.1184">       nsCOMPtr&lt;nsIMsgDatabase&gt; msgDb;</span>
<a href="#l65.1185"></a><span id="l65.1185">       mCopyState-&gt;m_parseMsgState = parseMsgState;</span>
<a href="#l65.1186"></a><span id="l65.1186">       GetDatabaseWOReparse(getter_AddRefs(msgDb));</span>
<a href="#l65.1187"></a><span id="l65.1187">       if (msgDb)</span>
<a href="#l65.1188"></a><span id="l65.1188">         parseMsgState-&gt;SetMailDB(msgDb);</span>
<a href="#l65.1189"></a><span id="l65.1189" class="difflineminus">-    }</span>
<a href="#l65.1190"></a><span id="l65.1190"> </span>
<a href="#l65.1191"></a><span id="l65.1191">     nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l65.1192"></a><span id="l65.1192">     rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), aFile);</span>
<a href="#l65.1193"></a><span id="l65.1193"> </span>
<a href="#l65.1194"></a><span id="l65.1194">     // All or none for adding a message file to the store</span>
<a href="#l65.1195"></a><span id="l65.1195">     if (NS_SUCCEEDED(rv) &amp;&amp; fileSize &gt; PR_INT32_MAX)</span>
<a href="#l65.1196"></a><span id="l65.1196">         rv = NS_ERROR_ILLEGAL_VALUE; // may need error code for max msg size</span>
<a href="#l65.1197"></a><span id="l65.1197"> </span>
<a href="#l65.1198"></a><span id="l65.1198" class="difflineat">@@ -2320,22 +1938,22 @@ NS_IMETHODIMP nsMsgLocalMailFolder::GetN</span>
<a href="#l65.1199"></a><span id="l65.1199">   return rv;</span>
<a href="#l65.1200"></a><span id="l65.1200"> }</span>
<a href="#l65.1201"></a><span id="l65.1201"> </span>
<a href="#l65.1202"></a><span id="l65.1202"> nsresult nsMsgLocalMailFolder::WriteStartOfNewMessage()</span>
<a href="#l65.1203"></a><span id="l65.1203"> {</span>
<a href="#l65.1204"></a><span id="l65.1204">   nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(mCopyState-&gt;m_fileStream);</span>
<a href="#l65.1205"></a><span id="l65.1205">   PRInt64 filePos;</span>
<a href="#l65.1206"></a><span id="l65.1206">   seekableStream-&gt;Tell(&amp;filePos);</span>
<a href="#l65.1207"></a><span id="l65.1207" class="difflineminus">-  mCopyState-&gt;m_curDstKey =(PRUint32) filePos;</span>
<a href="#l65.1208"></a><span id="l65.1208"> </span>
<a href="#l65.1209"></a><span id="l65.1209">   // CopyFileMessage() and CopyMessages() from servers other than pop3</span>
<a href="#l65.1210"></a><span id="l65.1210">   if (mCopyState-&gt;m_parseMsgState)</span>
<a href="#l65.1211"></a><span id="l65.1211">   {</span>
<a href="#l65.1212"></a><span id="l65.1212" class="difflineminus">-    mCopyState-&gt;m_parseMsgState-&gt;SetEnvelopePos(mCopyState-&gt;m_curDstKey);</span>
<a href="#l65.1213"></a><span id="l65.1213" class="difflineplus">+    mCopyState-&gt;m_parseMsgState-&gt;m_newMsgHdr-&gt;GetMessageKey(&amp;mCopyState-&gt;m_curDstKey);</span>
<a href="#l65.1214"></a><span id="l65.1214" class="difflineplus">+    mCopyState-&gt;m_parseMsgState-&gt;SetEnvelopePos(filePos);</span>
<a href="#l65.1215"></a><span id="l65.1215">     mCopyState-&gt;m_parseMsgState-&gt;SetState(nsIMsgParseMailMsgState::ParseHeadersState);</span>
<a href="#l65.1216"></a><span id="l65.1216">   }</span>
<a href="#l65.1217"></a><span id="l65.1217">   if (mCopyState-&gt;m_dummyEnvelopeNeeded)</span>
<a href="#l65.1218"></a><span id="l65.1218">   {</span>
<a href="#l65.1219"></a><span id="l65.1219">     nsCString result;</span>
<a href="#l65.1220"></a><span id="l65.1220">     nsCAutoString nowStr;</span>
<a href="#l65.1221"></a><span id="l65.1221">     MsgGenerateNowStr(nowStr);</span>
<a href="#l65.1222"></a><span id="l65.1222">     result.AppendLiteral(&quot;From - &quot;);</span>
<a href="#l65.1223"></a><span id="l65.1223" class="difflineat">@@ -2382,23 +2000,44 @@ nsresult nsMsgLocalMailFolder::WriteStar</span>
<a href="#l65.1224"></a><span id="l65.1224">   }</span>
<a href="#l65.1225"></a><span id="l65.1225">   else</span>
<a href="#l65.1226"></a><span id="l65.1226">     mCopyState-&gt;m_fromLineSeen = PR_FALSE;</span>
<a href="#l65.1227"></a><span id="l65.1227"> </span>
<a href="#l65.1228"></a><span id="l65.1228">   mCopyState-&gt;m_curCopyIndex++;</span>
<a href="#l65.1229"></a><span id="l65.1229">   return NS_OK;</span>
<a href="#l65.1230"></a><span id="l65.1230"> }</span>
<a href="#l65.1231"></a><span id="l65.1231"> </span>
<a href="#l65.1232"></a><span id="l65.1232" class="difflineplus">+nsresult nsMsgLocalMailFolder::InitCopyMsgHdrAndFileStream()</span>
<a href="#l65.1233"></a><span id="l65.1233" class="difflineplus">+{</span>
<a href="#l65.1234"></a><span id="l65.1234" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.1235"></a><span id="l65.1235" class="difflineplus">+  nsresult rv = GetMsgStore(getter_AddRefs(mCopyState-&gt;m_msgStore));</span>
<a href="#l65.1236"></a><span id="l65.1236" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1237"></a><span id="l65.1237" class="difflineplus">+  bool reusable;</span>
<a href="#l65.1238"></a><span id="l65.1238" class="difflineplus">+  rv = mCopyState-&gt;m_msgStore-&gt;</span>
<a href="#l65.1239"></a><span id="l65.1239" class="difflineplus">+         GetNewMsgOutputStream(this, getter_AddRefs(mCopyState-&gt;m_newHdr),</span>
<a href="#l65.1240"></a><span id="l65.1240" class="difflineplus">+                               &amp;reusable,</span>
<a href="#l65.1241"></a><span id="l65.1241" class="difflineplus">+                               getter_AddRefs(mCopyState-&gt;m_fileStream));</span>
<a href="#l65.1242"></a><span id="l65.1242" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1243"></a><span id="l65.1243" class="difflineplus">+  if (mCopyState-&gt;m_parseMsgState)</span>
<a href="#l65.1244"></a><span id="l65.1244" class="difflineplus">+    mCopyState-&gt;m_parseMsgState-&gt;SetNewMsgHdr(mCopyState-&gt;m_newHdr);</span>
<a href="#l65.1245"></a><span id="l65.1245" class="difflineplus">+  return rv;</span>
<a href="#l65.1246"></a><span id="l65.1246" class="difflineplus">+}</span>
<a href="#l65.1247"></a><span id="l65.1247" class="difflineplus">+</span>
<a href="#l65.1248"></a><span id="l65.1248"> //nsICopyMessageListener</span>
<a href="#l65.1249"></a><span id="l65.1249"> NS_IMETHODIMP nsMsgLocalMailFolder::BeginCopy(nsIMsgDBHdr *message)</span>
<a href="#l65.1250"></a><span id="l65.1250"> {</span>
<a href="#l65.1251"></a><span id="l65.1251">   if (!mCopyState)</span>
<a href="#l65.1252"></a><span id="l65.1252">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l65.1253"></a><span id="l65.1253"> </span>
<a href="#l65.1254"></a><span id="l65.1254">   nsresult rv;</span>
<a href="#l65.1255"></a><span id="l65.1255" class="difflineplus">+  if (!mCopyState-&gt;m_copyingMultipleMessages)</span>
<a href="#l65.1256"></a><span id="l65.1256" class="difflineplus">+  {</span>
<a href="#l65.1257"></a><span id="l65.1257" class="difflineplus">+    rv = InitCopyMsgHdrAndFileStream();</span>
<a href="#l65.1258"></a><span id="l65.1258" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1259"></a><span id="l65.1259" class="difflineplus">+  }</span>
<a href="#l65.1260"></a><span id="l65.1260">   nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(mCopyState-&gt;m_fileStream, &amp;rv);</span>
<a href="#l65.1261"></a><span id="l65.1261">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1262"></a><span id="l65.1262">   seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l65.1263"></a><span id="l65.1263"> </span>
<a href="#l65.1264"></a><span id="l65.1264">   PRInt32 messageIndex = (mCopyState-&gt;m_copyingMultipleMessages) ? mCopyState-&gt;m_curCopyIndex - 1 : mCopyState-&gt;m_curCopyIndex;</span>
<a href="#l65.1265"></a><span id="l65.1265">   NS_ASSERTION(!mCopyState-&gt;m_copyingMultipleMessages || mCopyState-&gt;m_curCopyIndex &gt;= 0, &quot;mCopyState-&gt;m_curCopyIndex invalid&quot;);</span>
<a href="#l65.1266"></a><span id="l65.1266">   // by the time we get here, m_curCopyIndex is 1 relative because WriteStartOfNewMessage increments it</span>
<a href="#l65.1267"></a><span id="l65.1267">   mCopyState-&gt;m_messages-&gt;QueryElementAt(messageIndex, NS_GET_IID(nsIMsgDBHdr),</span>
<a href="#l65.1268"></a><span id="l65.1268" class="difflineat">@@ -2517,38 +2156,47 @@ NS_IMETHODIMP nsMsgLocalMailFolder::Copy</span>
<a href="#l65.1269"></a><span id="l65.1269">   }</span>
<a href="#l65.1270"></a><span id="l65.1270">   return rv;</span>
<a href="#l65.1271"></a><span id="l65.1271"> }</span>
<a href="#l65.1272"></a><span id="l65.1272"> </span>
<a href="#l65.1273"></a><span id="l65.1273"> void nsMsgLocalMailFolder::CopyPropertiesToMsgHdr(nsIMsgDBHdr *destHdr,</span>
<a href="#l65.1274"></a><span id="l65.1274">                                                   nsIMsgDBHdr *srcHdr,</span>
<a href="#l65.1275"></a><span id="l65.1275">                                                   bool aIsMove)</span>
<a href="#l65.1276"></a><span id="l65.1276"> {</span>
<a href="#l65.1277"></a><span id="l65.1277" class="difflineminus">-  nsCOMPtr&lt;nsIUTF8StringEnumerator&gt; propertyEnumerator;</span>
<a href="#l65.1278"></a><span id="l65.1278" class="difflineminus">-  nsresult rv = srcHdr-&gt;GetPropertyEnumerator(getter_AddRefs(propertyEnumerator));</span>
<a href="#l65.1279"></a><span id="l65.1279" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l65.1280"></a><span id="l65.1280" class="difflineminus">-</span>
<a href="#l65.1281"></a><span id="l65.1281" class="difflineplus">+  nsresult rv;</span>
<a href="#l65.1282"></a><span id="l65.1282">   nsCOMPtr&lt;nsIPrefBranch&gt; prefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l65.1283"></a><span id="l65.1283">   NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l65.1284"></a><span id="l65.1284"> </span>
<a href="#l65.1285"></a><span id="l65.1285">   nsCString dontPreserve;</span>
<a href="#l65.1286"></a><span id="l65.1286"> </span>
<a href="#l65.1287"></a><span id="l65.1287">   // These preferences exist so that extensions can control which properties</span>
<a href="#l65.1288"></a><span id="l65.1288">   // are preserved in the database when a message is moved or copied. All</span>
<a href="#l65.1289"></a><span id="l65.1289">   // properties are preserved except those listed in these preferences</span>
<a href="#l65.1290"></a><span id="l65.1290">   if (aIsMove)</span>
<a href="#l65.1291"></a><span id="l65.1291">     prefBranch-&gt;GetCharPref(&quot;mailnews.database.summary.dontPreserveOnMove&quot;,</span>
<a href="#l65.1292"></a><span id="l65.1292">                             getter_Copies(dontPreserve));</span>
<a href="#l65.1293"></a><span id="l65.1293">   else</span>
<a href="#l65.1294"></a><span id="l65.1294">     prefBranch-&gt;GetCharPref(&quot;mailnews.database.summary.dontPreserveOnCopy&quot;,</span>
<a href="#l65.1295"></a><span id="l65.1295">                             getter_Copies(dontPreserve));</span>
<a href="#l65.1296"></a><span id="l65.1296"> </span>
<a href="#l65.1297"></a><span id="l65.1297" class="difflineplus">+  CopyHdrPropertiesWithSkipList(destHdr, srcHdr, dontPreserve);</span>
<a href="#l65.1298"></a><span id="l65.1298" class="difflineplus">+}</span>
<a href="#l65.1299"></a><span id="l65.1299" class="difflineplus">+</span>
<a href="#l65.1300"></a><span id="l65.1300" class="difflineplus">+void</span>
<a href="#l65.1301"></a><span id="l65.1301" class="difflineplus">+nsMsgLocalMailFolder::CopyHdrPropertiesWithSkipList(nsIMsgDBHdr *destHdr,</span>
<a href="#l65.1302"></a><span id="l65.1302" class="difflineplus">+                                                    nsIMsgDBHdr *srcHdr,</span>
<a href="#l65.1303"></a><span id="l65.1303" class="difflineplus">+                                                    const nsCString &amp;skipList)</span>
<a href="#l65.1304"></a><span id="l65.1304" class="difflineplus">+{</span>
<a href="#l65.1305"></a><span id="l65.1305" class="difflineplus">+  nsCOMPtr&lt;nsIUTF8StringEnumerator&gt; propertyEnumerator;</span>
<a href="#l65.1306"></a><span id="l65.1306" class="difflineplus">+  nsresult rv = srcHdr-&gt;GetPropertyEnumerator(getter_AddRefs(propertyEnumerator));</span>
<a href="#l65.1307"></a><span id="l65.1307" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l65.1308"></a><span id="l65.1308" class="difflineplus">+</span>
<a href="#l65.1309"></a><span id="l65.1309">   // We'll add spaces at beginning and end so we can search for space-name-space</span>
<a href="#l65.1310"></a><span id="l65.1310">   nsCString dontPreserveEx(NS_LITERAL_CSTRING(&quot; &quot;));</span>
<a href="#l65.1311"></a><span id="l65.1311" class="difflineminus">-  dontPreserveEx.Append(dontPreserve);</span>
<a href="#l65.1312"></a><span id="l65.1312" class="difflineplus">+  dontPreserveEx.Append(skipList);</span>
<a href="#l65.1313"></a><span id="l65.1313">   dontPreserveEx.AppendLiteral(&quot; &quot;);</span>
<a href="#l65.1314"></a><span id="l65.1314"> </span>
<a href="#l65.1315"></a><span id="l65.1315">   nsCAutoString property;</span>
<a href="#l65.1316"></a><span id="l65.1316">   nsCString sourceString;</span>
<a href="#l65.1317"></a><span id="l65.1317">   bool hasMore;</span>
<a href="#l65.1318"></a><span id="l65.1318">   while (NS_SUCCEEDED(propertyEnumerator-&gt;HasMore(&amp;hasMore)) &amp;&amp; hasMore)</span>
<a href="#l65.1319"></a><span id="l65.1319">   {</span>
<a href="#l65.1320"></a><span id="l65.1320">     propertyEnumerator-&gt;GetNext(property);</span>
<a href="#l65.1321"></a><span id="l65.1321" class="difflineat">@@ -2572,25 +2220,23 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndC</span>
<a href="#l65.1322"></a><span id="l65.1322">   if (!mCopyState)</span>
<a href="#l65.1323"></a><span id="l65.1323">     return NS_OK;</span>
<a href="#l65.1324"></a><span id="l65.1324"> </span>
<a href="#l65.1325"></a><span id="l65.1325">   // we are the destination folder for a move/copy</span>
<a href="#l65.1326"></a><span id="l65.1326">   nsresult rv = aCopySucceeded ? NS_OK : NS_ERROR_FAILURE;</span>
<a href="#l65.1327"></a><span id="l65.1327"> </span>
<a href="#l65.1328"></a><span id="l65.1328">   if (!aCopySucceeded || mCopyState-&gt;m_writeFailed)</span>
<a href="#l65.1329"></a><span id="l65.1329">   {</span>
<a href="#l65.1330"></a><span id="l65.1330" class="difflineplus">+    if (mCopyState-&gt;m_curDstKey != nsMsgKey_None)</span>
<a href="#l65.1331"></a><span id="l65.1331" class="difflineplus">+      mCopyState-&gt;m_msgStore-&gt;DiscardNewMessage(mCopyState-&gt;m_fileStream,</span>
<a href="#l65.1332"></a><span id="l65.1332" class="difflineplus">+                                                mCopyState-&gt;m_newHdr);</span>
<a href="#l65.1333"></a><span id="l65.1333" class="difflineplus">+</span>
<a href="#l65.1334"></a><span id="l65.1334">     if (mCopyState-&gt;m_fileStream)</span>
<a href="#l65.1335"></a><span id="l65.1335">       mCopyState-&gt;m_fileStream-&gt;Close();</span>
<a href="#l65.1336"></a><span id="l65.1336"> </span>
<a href="#l65.1337"></a><span id="l65.1337" class="difflineminus">-    nsCOMPtr &lt;nsILocalFile&gt; pathFile;</span>
<a href="#l65.1338"></a><span id="l65.1338" class="difflineminus">-    rv = GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l65.1339"></a><span id="l65.1339" class="difflineminus">-</span>
<a href="#l65.1340"></a><span id="l65.1340" class="difflineminus">-    if (NS_SUCCEEDED(rv) &amp;&amp; pathFile &amp;&amp; mCopyState-&gt;m_curDstKey != nsMsgKey_None)</span>
<a href="#l65.1341"></a><span id="l65.1341" class="difflineminus">-      pathFile-&gt;SetFileSize(mCopyState-&gt;m_curDstKey);</span>
<a href="#l65.1342"></a><span id="l65.1342" class="difflineminus">-</span>
<a href="#l65.1343"></a><span id="l65.1343">     if (!mCopyState-&gt;m_isMove)</span>
<a href="#l65.1344"></a><span id="l65.1344">     {</span>
<a href="#l65.1345"></a><span id="l65.1345">       // passing PR_TRUE because the messages that have been successfully </span>
<a href="#l65.1346"></a><span id="l65.1346">       // copied have their corresponding hdrs in place. The message that has </span>
<a href="#l65.1347"></a><span id="l65.1347">       // failed has been truncated so the msf file and berkeley mailbox </span>
<a href="#l65.1348"></a><span id="l65.1348">       // are in sync.</span>
<a href="#l65.1349"></a><span id="l65.1349">       (void) OnCopyCompleted(mCopyState-&gt;m_srcSupport, PR_TRUE);</span>
<a href="#l65.1350"></a><span id="l65.1350">       // enable the dest folder</span>
<a href="#l65.1351"></a><span id="l65.1351" class="difflineat">@@ -2619,33 +2265,63 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndC</span>
<a href="#l65.1352"></a><span id="l65.1352">       PRUint32 bytesWritten;</span>
<a href="#l65.1353"></a><span id="l65.1353">       seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l65.1354"></a><span id="l65.1354">       mCopyState-&gt;m_fileStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN, &amp;bytesWritten);</span>
<a href="#l65.1355"></a><span id="l65.1355">       if (mCopyState-&gt;m_parseMsgState)</span>
<a href="#l65.1356"></a><span id="l65.1356">         mCopyState-&gt;m_parseMsgState-&gt;ParseAFolderLine(CRLF, MSG_LINEBREAK_LEN);</span>
<a href="#l65.1357"></a><span id="l65.1357">     }</span>
<a href="#l65.1358"></a><span id="l65.1358">     // flush the copied message. We need a close at the end to get the</span>
<a href="#l65.1359"></a><span id="l65.1359">     // file size and time updated correctly.</span>
<a href="#l65.1360"></a><span id="l65.1360" class="difflineplus">+    seekableStream = do_QueryInterface(mCopyState-&gt;m_fileStream);</span>
<a href="#l65.1361"></a><span id="l65.1361" class="difflineplus">+    if (mCopyState-&gt;m_dummyEnvelopeNeeded)</span>
<a href="#l65.1362"></a><span id="l65.1362" class="difflineplus">+    {</span>
<a href="#l65.1363"></a><span id="l65.1363" class="difflineplus">+      PRUint32 bytesWritten;</span>
<a href="#l65.1364"></a><span id="l65.1364" class="difflineplus">+      seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l65.1365"></a><span id="l65.1365" class="difflineplus">+      mCopyState-&gt;m_fileStream-&gt;Write(MSG_LINEBREAK, MSG_LINEBREAK_LEN,</span>
<a href="#l65.1366"></a><span id="l65.1366" class="difflineplus">+                                      &amp;bytesWritten);</span>
<a href="#l65.1367"></a><span id="l65.1367" class="difflineplus">+      if (mCopyState-&gt;m_parseMsgState)</span>
<a href="#l65.1368"></a><span id="l65.1368" class="difflineplus">+        mCopyState-&gt;m_parseMsgState-&gt;ParseAFolderLine(CRLF, MSG_LINEBREAK_LEN);</span>
<a href="#l65.1369"></a><span id="l65.1369" class="difflineplus">+    }</span>
<a href="#l65.1370"></a><span id="l65.1370" class="difflineplus">+    // flush the copied message. We need a close at the end to get the</span>
<a href="#l65.1371"></a><span id="l65.1371" class="difflineplus">+    // file size and time updated correctly.</span>
<a href="#l65.1372"></a><span id="l65.1372" class="difflineplus">+    rv = mCopyState-&gt;m_msgStore-&gt;FinishNewMessage(mCopyState-&gt;m_fileStream,</span>
<a href="#l65.1373"></a><span id="l65.1373" class="difflineplus">+                                             mCopyState-&gt;m_newHdr);</span>
<a href="#l65.1374"></a><span id="l65.1374" class="difflineplus">+    if (NS_SUCCEEDED(rv) &amp;&amp; mCopyState-&gt;m_newHdr)</span>
<a href="#l65.1375"></a><span id="l65.1375" class="difflineplus">+      mCopyState-&gt;m_newHdr-&gt;GetMessageKey(&amp;mCopyState-&gt;m_curDstKey);</span>
<a href="#l65.1376"></a><span id="l65.1376">     if (multipleCopiesFinished)</span>
<a href="#l65.1377"></a><span id="l65.1377">       mCopyState-&gt;m_fileStream-&gt;Close();</span>
<a href="#l65.1378"></a><span id="l65.1378">     else</span>
<a href="#l65.1379"></a><span id="l65.1379">       mCopyState-&gt;m_fileStream-&gt;Flush();</span>
<a href="#l65.1380"></a><span id="l65.1380">   }</span>
<a href="#l65.1381"></a><span id="l65.1381">   //Copy the header to the new database</span>
<a href="#l65.1382"></a><span id="l65.1382">   if (mCopyState-&gt;m_message)</span>
<a href="#l65.1383"></a><span id="l65.1383">   {</span>
<a href="#l65.1384"></a><span id="l65.1384">     //  CopyMessages() goes here, and CopyFileMessages() with metadata to save;</span>
<a href="#l65.1385"></a><span id="l65.1385">     nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l65.1386"></a><span id="l65.1386">     if (!mCopyState-&gt;m_parseMsgState)</span>
<a href="#l65.1387"></a><span id="l65.1387">     {</span>
<a href="#l65.1388"></a><span id="l65.1388">       if (mCopyState-&gt;m_destDB)</span>
<a href="#l65.1389"></a><span id="l65.1389">       {</span>
<a href="#l65.1390"></a><span id="l65.1390" class="difflineplus">+        if (mCopyState-&gt;m_newHdr)</span>
<a href="#l65.1391"></a><span id="l65.1391" class="difflineplus">+        {</span>
<a href="#l65.1392"></a><span id="l65.1392" class="difflineplus">+          newHdr = mCopyState-&gt;m_newHdr;</span>
<a href="#l65.1393"></a><span id="l65.1393" class="difflineplus">+          CopyHdrPropertiesWithSkipList(newHdr, mCopyState-&gt;m_message,</span>
<a href="#l65.1394"></a><span id="l65.1394" class="difflineplus">+                                        NS_LITERAL_CSTRING(&quot;storeToken&quot;));</span>
<a href="#l65.1395"></a><span id="l65.1395" class="difflineplus">+//          UpdateNewMsgHdr(mCopyState-&gt;m_message, newHdr);</span>
<a href="#l65.1396"></a><span id="l65.1396" class="difflineplus">+          // We need to copy more than just what UpdateNewMsgHdr does. In fact,</span>
<a href="#l65.1397"></a><span id="l65.1397" class="difflineplus">+          // I think we want to copy almost every property other than</span>
<a href="#l65.1398"></a><span id="l65.1398" class="difflineplus">+          // storeToken.</span>
<a href="#l65.1399"></a><span id="l65.1399" class="difflineplus">+          mCopyState-&gt;m_destDB-&gt;AddNewHdrToDB(newHdr, PR_TRUE);</span>
<a href="#l65.1400"></a><span id="l65.1400" class="difflineplus">+        }</span>
<a href="#l65.1401"></a><span id="l65.1401" class="difflineplus">+        else</span>
<a href="#l65.1402"></a><span id="l65.1402" class="difflineplus">+        {</span>
<a href="#l65.1403"></a><span id="l65.1403">         rv = mCopyState-&gt;m_destDB-&gt;CopyHdrFromExistingHdr(mCopyState-&gt;m_curDstKey,</span>
<a href="#l65.1404"></a><span id="l65.1404">           mCopyState-&gt;m_message, PR_TRUE,</span>
<a href="#l65.1405"></a><span id="l65.1405">           getter_AddRefs(newHdr));</span>
<a href="#l65.1406"></a><span id="l65.1406" class="difflineplus">+        }</span>
<a href="#l65.1407"></a><span id="l65.1407">         PRUint32 newHdrFlags;</span>
<a href="#l65.1408"></a><span id="l65.1408">         if (newHdr)</span>
<a href="#l65.1409"></a><span id="l65.1409">         {</span>
<a href="#l65.1410"></a><span id="l65.1410">           // turn off offline flag - it's not valid for local mail folders.</span>
<a href="#l65.1411"></a><span id="l65.1411">           newHdr-&gt;AndFlags(~nsMsgMessageFlags::Offline, &amp;newHdrFlags);</span>
<a href="#l65.1412"></a><span id="l65.1412">           mCopyState-&gt;m_destMessages-&gt;AppendElement(newHdr, PR_FALSE);</span>
<a href="#l65.1413"></a><span id="l65.1413">         }</span>
<a href="#l65.1414"></a><span id="l65.1414">       }</span>
<a href="#l65.1415"></a><span id="l65.1415" class="difflineat">@@ -2681,24 +2357,23 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndC</span>
<a href="#l65.1416"></a><span id="l65.1416">     GetDatabaseWOReparse(getter_AddRefs(msgDb));</span>
<a href="#l65.1417"></a><span id="l65.1417">     if (msgDb)</span>
<a href="#l65.1418"></a><span id="l65.1418">     {</span>
<a href="#l65.1419"></a><span id="l65.1419">       nsresult result = mCopyState-&gt;m_parseMsgState-&gt;GetNewMsgHdr(getter_AddRefs(newHdr));</span>
<a href="#l65.1420"></a><span id="l65.1420">       // we need to copy newHdr because mCopyState will get cleared </span>
<a href="#l65.1421"></a><span id="l65.1421">       // in OnCopyCompleted, but we need OnCopyCompleted to know about</span>
<a href="#l65.1422"></a><span id="l65.1422">       // the newHdr, via mCopyState. And we send a notification about newHdr</span>
<a href="#l65.1423"></a><span id="l65.1423">       // after OnCopyCompleted.</span>
<a href="#l65.1424"></a><span id="l65.1424" class="difflineminus">-      mCopyState-&gt;newHdr = newHdr;</span>
<a href="#l65.1425"></a><span id="l65.1425" class="difflineplus">+      mCopyState-&gt;m_newHdr = newHdr;</span>
<a href="#l65.1426"></a><span id="l65.1426">       if (NS_SUCCEEDED(result) &amp;&amp; newHdr)</span>
<a href="#l65.1427"></a><span id="l65.1427">       {</span>
<a href="#l65.1428"></a><span id="l65.1428">         // Copy message metadata.</span>
<a href="#l65.1429"></a><span id="l65.1429">         if (mCopyState-&gt;m_message)</span>
<a href="#l65.1430"></a><span id="l65.1430">         {</span>
<a href="#l65.1431"></a><span id="l65.1431" class="difflineminus">-          // deal with propagating the new flag on an imap to local folder filter action</span>
<a href="#l65.1432"></a><span id="l65.1432" class="difflineminus">-          PRUint32 msgFlags;</span>
<a href="#l65.1433"></a><span id="l65.1433" class="difflineplus">+          // Propagate the new flag on an imap to local folder filter action</span>
<a href="#l65.1434"></a><span id="l65.1434">           // Flags may get changed when deleting the original source message in</span>
<a href="#l65.1435"></a><span id="l65.1435">           // IMAP. We have a copy of the original flags, but parseMsgState has</span>
<a href="#l65.1436"></a><span id="l65.1436">           // already tried to decide what those flags should be. Who to believe?</span>
<a href="#l65.1437"></a><span id="l65.1437">           // Let's only deal here with the flags that might get changed, Read</span>
<a href="#l65.1438"></a><span id="l65.1438">           // and New, and trust upstream code for everything else.</span>
<a href="#l65.1439"></a><span id="l65.1439">           PRUint32 readAndNew = nsMsgMessageFlags::New | nsMsgMessageFlags::Read;</span>
<a href="#l65.1440"></a><span id="l65.1440">           PRUint32 newFlags;</span>
<a href="#l65.1441"></a><span id="l65.1441">           newHdr-&gt;GetFlags(&amp;newFlags);</span>
<a href="#l65.1442"></a><span id="l65.1442" class="difflineat">@@ -2895,16 +2570,18 @@ NS_IMETHODIMP nsMsgLocalMailFolder::EndM</span>
<a href="#l65.1443"></a><span id="l65.1443"> </span>
<a href="#l65.1444"></a><span id="l65.1444"> }</span>
<a href="#l65.1445"></a><span id="l65.1445"> </span>
<a href="#l65.1446"></a><span id="l65.1446"> // this is the beginning of the next message copied</span>
<a href="#l65.1447"></a><span id="l65.1447"> NS_IMETHODIMP nsMsgLocalMailFolder::StartMessage()</span>
<a href="#l65.1448"></a><span id="l65.1448"> {</span>
<a href="#l65.1449"></a><span id="l65.1449">   // We get crashes that we don't understand (bug 284876), so stupidly prevent that.</span>
<a href="#l65.1450"></a><span id="l65.1450">   NS_ENSURE_ARG_POINTER(mCopyState);</span>
<a href="#l65.1451"></a><span id="l65.1451" class="difflineplus">+  nsresult rv = InitCopyMsgHdrAndFileStream();</span>
<a href="#l65.1452"></a><span id="l65.1452" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1453"></a><span id="l65.1453">   return WriteStartOfNewMessage();</span>
<a href="#l65.1454"></a><span id="l65.1454"> }</span>
<a href="#l65.1455"></a><span id="l65.1455"> </span>
<a href="#l65.1456"></a><span id="l65.1456"> // just finished the current message.</span>
<a href="#l65.1457"></a><span id="l65.1457"> NS_IMETHODIMP nsMsgLocalMailFolder::EndMessage(nsMsgKey key)</span>
<a href="#l65.1458"></a><span id="l65.1458"> {</span>
<a href="#l65.1459"></a><span id="l65.1459">   NS_ENSURE_ARG_POINTER(mCopyState);</span>
<a href="#l65.1460"></a><span id="l65.1460"> </span>
<a href="#l65.1461"></a><span id="l65.1461" class="difflineat">@@ -3163,17 +2840,18 @@ nsMsgLocalMailFolder::MarkMsgsOnPop3Serv</span>
<a href="#l65.1462"></a><span id="l65.1462">       {</span>
<a href="#l65.1463"></a><span id="l65.1463">         msgPop3Server-&gt;AddUidlToMark(folderScanState.m_uidl, mark);</span>
<a href="#l65.1464"></a><span id="l65.1464">         // remember this pop server in list of servers with msgs deleted</span>
<a href="#l65.1465"></a><span id="l65.1465">         if (pop3Servers.IndexOfObject(msgPop3Server) == -1)</span>
<a href="#l65.1466"></a><span id="l65.1466">           pop3Servers.AppendObject(msgPop3Server);</span>
<a href="#l65.1467"></a><span id="l65.1467">       }</span>
<a href="#l65.1468"></a><span id="l65.1468">     }</span>
<a href="#l65.1469"></a><span id="l65.1469">   }</span>
<a href="#l65.1470"></a><span id="l65.1470" class="difflineminus">-</span>
<a href="#l65.1471"></a><span id="l65.1471" class="difflineplus">+  if (folderScanState.m_inputStream)</span>
<a href="#l65.1472"></a><span id="l65.1472" class="difflineplus">+    folderScanState.m_inputStream-&gt;Close();</span>
<a href="#l65.1473"></a><span id="l65.1473">   // need to do this for all pop3 mail servers that had messages deleted.</span>
<a href="#l65.1474"></a><span id="l65.1474">   PRUint32 serverCount = pop3Servers.Count();</span>
<a href="#l65.1475"></a><span id="l65.1475">   for (PRUint32 index = 0; index &lt; serverCount; index++)</span>
<a href="#l65.1476"></a><span id="l65.1476">     pop3Servers[index]-&gt;MarkMessages();</span>
<a href="#l65.1477"></a><span id="l65.1477"> </span>
<a href="#l65.1478"></a><span id="l65.1478">   return rv;</span>
<a href="#l65.1479"></a><span id="l65.1479"> }</span>
<a href="#l65.1480"></a><span id="l65.1480"> </span>
<a href="#l65.1481"></a><span id="l65.1481" class="difflineat">@@ -3411,16 +3089,17 @@ nsMsgLocalMailFolder::OnStopRunningUrl(n</span>
<a href="#l65.1482"></a><span id="l65.1482">   nsresult rv;</span>
<a href="#l65.1483"></a><span id="l65.1483">   if (NS_SUCCEEDED(aExitCode))</span>
<a href="#l65.1484"></a><span id="l65.1484">   {</span>
<a href="#l65.1485"></a><span id="l65.1485">     nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span>
<a href="#l65.1486"></a><span id="l65.1486">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1487"></a><span id="l65.1487">     nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow;</span>
<a href="#l65.1488"></a><span id="l65.1488">     rv = mailSession-&gt;GetTopmostMsgWindow(getter_AddRefs(msgWindow));</span>
<a href="#l65.1489"></a><span id="l65.1489">     nsCAutoString aSpec;</span>
<a href="#l65.1490"></a><span id="l65.1490" class="difflineplus">+    if (aUrl)</span>
<a href="#l65.1491"></a><span id="l65.1491">     aUrl-&gt;GetSpec(aSpec);</span>
<a href="#l65.1492"></a><span id="l65.1492"> </span>
<a href="#l65.1493"></a><span id="l65.1493">     if (strstr(aSpec.get(), &quot;uidl=&quot;))</span>
<a href="#l65.1494"></a><span id="l65.1494">     {</span>
<a href="#l65.1495"></a><span id="l65.1495">       nsCOMPtr&lt;nsIPop3URL&gt; popurl = do_QueryInterface(aUrl, &amp;rv);</span>
<a href="#l65.1496"></a><span id="l65.1496">       if (NS_SUCCEEDED(rv))</span>
<a href="#l65.1497"></a><span id="l65.1497">       {</span>
<a href="#l65.1498"></a><span id="l65.1498">         nsCString messageuri;</span>
<a href="#l65.1499"></a><span id="l65.1499" class="difflineat">@@ -3783,43 +3462,31 @@ nsMsgLocalMailFolder::OnMessageClassifie</span>
<a href="#l65.1500"></a><span id="l65.1500">   return NS_OK;</span>
<a href="#l65.1501"></a><span id="l65.1501"> }</span>
<a href="#l65.1502"></a><span id="l65.1502"> </span>
<a href="#l65.1503"></a><span id="l65.1503"> NS_IMETHODIMP</span>
<a href="#l65.1504"></a><span id="l65.1504"> nsMsgLocalMailFolder::GetFolderScanState(nsLocalFolderScanState *aState)</span>
<a href="#l65.1505"></a><span id="l65.1505"> {</span>
<a href="#l65.1506"></a><span id="l65.1506">   NS_ENSURE_ARG_POINTER(aState);</span>
<a href="#l65.1507"></a><span id="l65.1507"> </span>
<a href="#l65.1508"></a><span id="l65.1508" class="difflineminus">-  nsresult rv;</span>
<a href="#l65.1509"></a><span id="l65.1509" class="difflineminus">-  GetFilePath(getter_AddRefs(aState-&gt;m_localFile));</span>
<a href="#l65.1510"></a><span id="l65.1510" class="difflineminus">-  aState-&gt;m_fileStream = do_CreateInstance(NS_LOCALFILEINPUTSTREAM_CONTRACTID, &amp;rv);</span>
<a href="#l65.1511"></a><span id="l65.1511" class="difflineplus">+  nsresult rv = GetMsgStore(getter_AddRefs(aState-&gt;m_msgStore));</span>
<a href="#l65.1512"></a><span id="l65.1512">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1513"></a><span id="l65.1513" class="difflineminus">-</span>
<a href="#l65.1514"></a><span id="l65.1514" class="difflineminus">-  rv = aState-&gt;m_fileStream-&gt;Init(aState-&gt;m_localFile, PR_RDONLY, 0664, PR_FALSE);</span>
<a href="#l65.1515"></a><span id="l65.1515" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l65.1516"></a><span id="l65.1516" class="difflineminus">-  {</span>
<a href="#l65.1517"></a><span id="l65.1517" class="difflineminus">-    aState-&gt;m_inputStream = do_QueryInterface(aState-&gt;m_fileStream);</span>
<a href="#l65.1518"></a><span id="l65.1518" class="difflineminus">-    aState-&gt;m_seekableStream = do_QueryInterface(aState-&gt;m_inputStream);</span>
<a href="#l65.1519"></a><span id="l65.1519" class="difflineminus">-    aState-&gt;m_fileLineStream = do_QueryInterface(aState-&gt;m_inputStream);</span>
<a href="#l65.1520"></a><span id="l65.1520">     aState-&gt;m_uidl = nsnull;</span>
<a href="#l65.1521"></a><span id="l65.1521" class="difflineminus">-  }</span>
<a href="#l65.1522"></a><span id="l65.1522">   return rv;</span>
<a href="#l65.1523"></a><span id="l65.1523"> }</span>
<a href="#l65.1524"></a><span id="l65.1524"> </span>
<a href="#l65.1525"></a><span id="l65.1525"> NS_IMETHODIMP</span>
<a href="#l65.1526"></a><span id="l65.1526"> nsMsgLocalMailFolder::GetUidlFromFolder(nsLocalFolderScanState *aState, nsIMsgDBHdr *aMsgDBHdr)</span>
<a href="#l65.1527"></a><span id="l65.1527"> {</span>
<a href="#l65.1528"></a><span id="l65.1528" class="difflineminus">-  nsresult rv;</span>
<a href="#l65.1529"></a><span id="l65.1529" class="difflineminus">-  PRUint64 messageOffset;</span>
<a href="#l65.1530"></a><span id="l65.1530">   bool more = false;</span>
<a href="#l65.1531"></a><span id="l65.1531">   PRUint32 size = 0, len = 0;</span>
<a href="#l65.1532"></a><span id="l65.1532">   const char *accountKey = nsnull;</span>
<a href="#l65.1533"></a><span id="l65.1533" class="difflineminus">-</span>
<a href="#l65.1534"></a><span id="l65.1534" class="difflineminus">-  aMsgDBHdr-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l65.1535"></a><span id="l65.1535" class="difflineminus">-  rv = aState-&gt;m_seekableStream-&gt;Seek(PR_SEEK_SET, messageOffset);</span>
<a href="#l65.1536"></a><span id="l65.1536" class="difflineplus">+  nsresult rv = GetMsgInputStream(aMsgDBHdr, &amp;aState-&gt;m_streamReusable,</span>
<a href="#l65.1537"></a><span id="l65.1537" class="difflineplus">+                                  getter_AddRefs(aState-&gt;m_inputStream));</span>
<a href="#l65.1538"></a><span id="l65.1538" class="difflineplus">+  aState-&gt;m_seekableStream = do_QueryInterface(aState-&gt;m_inputStream);</span>
<a href="#l65.1539"></a><span id="l65.1539">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l65.1540"></a><span id="l65.1540"> </span>
<a href="#l65.1541"></a><span id="l65.1541">   nsLineBuffer&lt;char&gt; *lineBuffer;</span>
<a href="#l65.1542"></a><span id="l65.1542"> </span>
<a href="#l65.1543"></a><span id="l65.1543">   rv = NS_InitLineBuffer(&amp;lineBuffer);</span>
<a href="#l65.1544"></a><span id="l65.1544">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1545"></a><span id="l65.1545">   aState-&gt;m_uidl = nsnull;</span>
<a href="#l65.1546"></a><span id="l65.1546"> </span>
<a href="#l65.1547"></a><span id="l65.1547" class="difflineat">@@ -3850,16 +3517,21 @@ nsMsgLocalMailFolder::GetUidlFromFolder(</span>
<a href="#l65.1548"></a><span id="l65.1548">         if (aState-&gt;m_uidl)</span>
<a href="#l65.1549"></a><span id="l65.1549">         {</span>
<a href="#l65.1550"></a><span id="l65.1550">           aState-&gt;m_uidl += X_UIDL_LEN + 2; // skip UIDL: header</span>
<a href="#l65.1551"></a><span id="l65.1551">           break;</span>
<a href="#l65.1552"></a><span id="l65.1552">         }</span>
<a href="#l65.1553"></a><span id="l65.1553">       }</span>
<a href="#l65.1554"></a><span id="l65.1554">     }</span>
<a href="#l65.1555"></a><span id="l65.1555">   }</span>
<a href="#l65.1556"></a><span id="l65.1556" class="difflineplus">+  if (!aState-&gt;m_streamReusable)</span>
<a href="#l65.1557"></a><span id="l65.1557" class="difflineplus">+  {</span>
<a href="#l65.1558"></a><span id="l65.1558" class="difflineplus">+    aState-&gt;m_inputStream-&gt;Close();</span>
<a href="#l65.1559"></a><span id="l65.1559" class="difflineplus">+    aState-&gt;m_inputStream = nsnull;</span>
<a href="#l65.1560"></a><span id="l65.1560" class="difflineplus">+  }</span>
<a href="#l65.1561"></a><span id="l65.1561">   PR_Free(lineBuffer);</span>
<a href="#l65.1562"></a><span id="l65.1562">   return rv;</span>
<a href="#l65.1563"></a><span id="l65.1563"> }</span>
<a href="#l65.1564"></a><span id="l65.1564"> </span>
<a href="#l65.1565"></a><span id="l65.1565"> // this adds a message to the end of the folder, parsing it as it goes, and</span>
<a href="#l65.1566"></a><span id="l65.1566"> // applying filters, if applicable.</span>
<a href="#l65.1567"></a><span id="l65.1567"> NS_IMETHODIMP</span>
<a href="#l65.1568"></a><span id="l65.1568"> nsMsgLocalMailFolder::AddMessage(const char *aMessage)</span>
<a href="#l65.1569"></a><span id="l65.1569" class="difflineat">@@ -3867,288 +3539,135 @@ nsMsgLocalMailFolder::AddMessage(const c</span>
<a href="#l65.1570"></a><span id="l65.1570">   const char *aMessages[] = {aMessage};</span>
<a href="#l65.1571"></a><span id="l65.1571">   return AddMessageBatch(1, aMessages);</span>
<a href="#l65.1572"></a><span id="l65.1572"> }</span>
<a href="#l65.1573"></a><span id="l65.1573"> </span>
<a href="#l65.1574"></a><span id="l65.1574"> NS_IMETHODIMP</span>
<a href="#l65.1575"></a><span id="l65.1575"> nsMsgLocalMailFolder::AddMessageBatch(PRUint32 aMessageCount,</span>
<a href="#l65.1576"></a><span id="l65.1576">                                       const char **aMessages)</span>
<a href="#l65.1577"></a><span id="l65.1577"> {</span>
<a href="#l65.1578"></a><span id="l65.1578" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l65.1579"></a><span id="l65.1579" class="difflineminus">-  nsresult rv = GetFilePath(getter_AddRefs(path));</span>
<a href="#l65.1580"></a><span id="l65.1580" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1581"></a><span id="l65.1581" class="difflineminus">-</span>
<a href="#l65.1582"></a><span id="l65.1582" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; outFileStream;</span>
<a href="#l65.1583"></a><span id="l65.1583" class="difflineminus">-  rv = MsgGetFileStream(path, getter_AddRefs(outFileStream));</span>
<a href="#l65.1584"></a><span id="l65.1584" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l65.1585"></a><span id="l65.1585" class="difflineplus">+  nsresult rv = GetServer(getter_AddRefs(server));</span>
<a href="#l65.1586"></a><span id="l65.1586">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1587"></a><span id="l65.1587"> </span>
<a href="#l65.1588"></a><span id="l65.1588" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream =</span>
<a href="#l65.1589"></a><span id="l65.1589" class="difflineminus">-    do_QueryInterface(outFileStream, &amp;rv);</span>
<a href="#l65.1590"></a><span id="l65.1590" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.1591"></a><span id="l65.1591" class="difflineplus">+  nsCOMPtr &lt;nsIOutputStream&gt; outFileStream;</span>
<a href="#l65.1592"></a><span id="l65.1592" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l65.1593"></a><span id="l65.1593" class="difflineplus">+</span>
<a href="#l65.1594"></a><span id="l65.1594" class="difflineplus">+  rv = server-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.1595"></a><span id="l65.1595">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1596"></a><span id="l65.1596" class="difflineminus">-  seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l65.1597"></a><span id="l65.1597" class="difflineminus">-</span>
<a href="#l65.1598"></a><span id="l65.1598" class="difflineminus">-  // create a new mail parser</span>
<a href="#l65.1599"></a><span id="l65.1599" class="difflineminus">-  nsRefPtr&lt;nsParseNewMailState&gt; newMailParser = new nsParseNewMailState;</span>
<a href="#l65.1600"></a><span id="l65.1600" class="difflineminus">-  if (newMailParser == nsnull)</span>
<a href="#l65.1601"></a><span id="l65.1601" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l65.1602"></a><span id="l65.1602" class="difflineminus">-  if (!mGettingNewMessages)</span>
<a href="#l65.1603"></a><span id="l65.1603" class="difflineminus">-    newMailParser-&gt;DisableFilters();</span>
<a href="#l65.1604"></a><span id="l65.1604"> </span>
<a href="#l65.1605"></a><span id="l65.1605">   nsCOMPtr&lt;nsIMsgFolder&gt; rootFolder;</span>
<a href="#l65.1606"></a><span id="l65.1606">   rv = GetRootFolder(getter_AddRefs(rootFolder));</span>
<a href="#l65.1607"></a><span id="l65.1607">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1608"></a><span id="l65.1608"> </span>
<a href="#l65.1609"></a><span id="l65.1609">   bool isLocked;</span>
<a href="#l65.1610"></a><span id="l65.1610"> </span>
<a href="#l65.1611"></a><span id="l65.1611">   GetLocked(&amp;isLocked);</span>
<a href="#l65.1612"></a><span id="l65.1612">   if (isLocked)</span>
<a href="#l65.1613"></a><span id="l65.1613">     return NS_MSG_FOLDER_BUSY;</span>
<a href="#l65.1614"></a><span id="l65.1614"> </span>
<a href="#l65.1615"></a><span id="l65.1615">   AcquireSemaphore(static_cast&lt;nsIMsgLocalMailFolder*&gt;(this));</span>
<a href="#l65.1616"></a><span id="l65.1616"> </span>
<a href="#l65.1617"></a><span id="l65.1617" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; inputStream = do_QueryInterface(outFileStream);</span>
<a href="#l65.1618"></a><span id="l65.1618" class="difflineminus">-  rv = newMailParser-&gt;Init(rootFolder, this,</span>
<a href="#l65.1619"></a><span id="l65.1619" class="difflineminus">-                           inputStream, nsnull);</span>
<a href="#l65.1620"></a><span id="l65.1620" class="difflineminus">-  // nsMailDatabase needs the stream so it can update the status flags during</span>
<a href="#l65.1621"></a><span id="l65.1621" class="difflineminus">-  // the OnStopRequest logic.</span>
<a href="#l65.1622"></a><span id="l65.1622" class="difflineminus">-  newMailParser-&gt;SetDBFolderStream(outFileStream);</span>
<a href="#l65.1623"></a><span id="l65.1623">   if (NS_SUCCEEDED(rv))</span>
<a href="#l65.1624"></a><span id="l65.1624">   {</span>
<a href="#l65.1625"></a><span id="l65.1625">     for (PRUint32 i = 0; i &lt; aMessageCount; i++)</span>
<a href="#l65.1626"></a><span id="l65.1626">     {</span>
<a href="#l65.1627"></a><span id="l65.1627" class="difflineplus">+      nsRefPtr&lt;nsParseNewMailState&gt; newMailParser = new nsParseNewMailState;</span>
<a href="#l65.1628"></a><span id="l65.1628" class="difflineplus">+      NS_ENSURE_TRUE(newMailParser, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l65.1629"></a><span id="l65.1629" class="difflineplus">+      if (!mGettingNewMessages)</span>
<a href="#l65.1630"></a><span id="l65.1630" class="difflineplus">+        newMailParser-&gt;DisableFilters();</span>
<a href="#l65.1631"></a><span id="l65.1631" class="difflineplus">+      bool reusable;</span>
<a href="#l65.1632"></a><span id="l65.1632" class="difflineplus">+      rv = msgStore-&gt;GetNewMsgOutputStream(this, getter_AddRefs(newHdr),</span>
<a href="#l65.1633"></a><span id="l65.1633" class="difflineplus">+                                      &amp;reusable,</span>
<a href="#l65.1634"></a><span id="l65.1634" class="difflineplus">+                                      getter_AddRefs(outFileStream));</span>
<a href="#l65.1635"></a><span id="l65.1635" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1636"></a><span id="l65.1636" class="difflineplus">+      rv = newMailParser-&gt;Init(rootFolder, this,</span>
<a href="#l65.1637"></a><span id="l65.1637" class="difflineplus">+                               nsnull, newHdr, outFileStream);</span>
<a href="#l65.1638"></a><span id="l65.1638" class="difflineplus">+</span>
<a href="#l65.1639"></a><span id="l65.1639">       PRUint32 bytesWritten, messageLen = strlen(aMessages[i]);</span>
<a href="#l65.1640"></a><span id="l65.1640">       outFileStream-&gt;Write(aMessages[i], messageLen, &amp;bytesWritten);</span>
<a href="#l65.1641"></a><span id="l65.1641">       newMailParser-&gt;BufferInput(aMessages[i], messageLen);</span>
<a href="#l65.1642"></a><span id="l65.1642" class="difflineminus">-      // this spits out a header.</span>
<a href="#l65.1643"></a><span id="l65.1643" class="difflineplus">+</span>
<a href="#l65.1644"></a><span id="l65.1644" class="difflineplus">+      msgStore-&gt;FinishNewMessage(outFileStream, newHdr);</span>
<a href="#l65.1645"></a><span id="l65.1645" class="difflineplus">+      outFileStream-&gt;Close();</span>
<a href="#l65.1646"></a><span id="l65.1646" class="difflineplus">+      outFileStream = nsnull;</span>
<a href="#l65.1647"></a><span id="l65.1647" class="difflineplus">+      newMailParser-&gt;EndMsgDownload();</span>
<a href="#l65.1648"></a><span id="l65.1648">       newMailParser-&gt;OnStopRequest(nsnull, nsnull, NS_OK);</span>
<a href="#l65.1649"></a><span id="l65.1649">     }</span>
<a href="#l65.1650"></a><span id="l65.1650">   }</span>
<a href="#l65.1651"></a><span id="l65.1651" class="difflineminus">-</span>
<a href="#l65.1652"></a><span id="l65.1652" class="difflineminus">-  // Flush performs an fsync and so must be done outside the loop for reasonable</span>
<a href="#l65.1653"></a><span id="l65.1653" class="difflineminus">-  // performance.</span>
<a href="#l65.1654"></a><span id="l65.1654" class="difflineminus">-  outFileStream-&gt;Flush();</span>
<a href="#l65.1655"></a><span id="l65.1655" class="difflineminus">-  // The parser tells the mail db to forget about this stream.</span>
<a href="#l65.1656"></a><span id="l65.1656" class="difflineminus">-  newMailParser-&gt;SetDBFolderStream(nsnull); // stream is going away</span>
<a href="#l65.1657"></a><span id="l65.1657" class="difflineminus">-  outFileStream-&gt;Close();</span>
<a href="#l65.1658"></a><span id="l65.1658" class="difflineminus">-  newMailParser-&gt;EndMsgDownload();</span>
<a href="#l65.1659"></a><span id="l65.1659" class="difflineminus">-  if (newMailParser-&gt;m_mailDB)</span>
<a href="#l65.1660"></a><span id="l65.1660" class="difflineminus">-    newMailParser-&gt;m_mailDB-&gt;SetSummaryValid(true);</span>
<a href="#l65.1661"></a><span id="l65.1661" class="difflineminus">-</span>
<a href="#l65.1662"></a><span id="l65.1662">   ReleaseSemaphore(static_cast&lt;nsIMsgLocalMailFolder*&gt;(this));</span>
<a href="#l65.1663"></a><span id="l65.1663">   return rv;</span>
<a href="#l65.1664"></a><span id="l65.1664"> }</span>
<a href="#l65.1665"></a><span id="l65.1665"> </span>
<a href="#l65.1666"></a><span id="l65.1666"> NS_IMETHODIMP</span>
<a href="#l65.1667"></a><span id="l65.1667"> nsMsgLocalMailFolder::WarnIfLocalFileTooBig(nsIMsgWindow *aWindow, bool *aTooBig)</span>
<a href="#l65.1668"></a><span id="l65.1668"> {</span>
<a href="#l65.1669"></a><span id="l65.1669">   NS_ENSURE_ARG_POINTER(aTooBig);</span>
<a href="#l65.1670"></a><span id="l65.1670">   *aTooBig = PR_FALSE;</span>
<a href="#l65.1671"></a><span id="l65.1671" class="difflineminus">-  PRInt64 sizeOnDisk;</span>
<a href="#l65.1672"></a><span id="l65.1672" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; filePath;</span>
<a href="#l65.1673"></a><span id="l65.1673" class="difflineminus">-  nsresult rv = GetFilePath(getter_AddRefs(filePath));</span>
<a href="#l65.1674"></a><span id="l65.1674" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.1675"></a><span id="l65.1675" class="difflineplus">+  nsresult rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.1676"></a><span id="l65.1676">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1677"></a><span id="l65.1677" class="difflineminus">-  rv = filePath-&gt;GetFileSize(&amp;sizeOnDisk);</span>
<a href="#l65.1678"></a><span id="l65.1678" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l65.1679"></a><span id="l65.1679" class="difflineminus">-  {</span>
<a href="#l65.1680"></a><span id="l65.1680" class="difflineminus">-    const PRInt64 kMaxFolderSize = 0xFFF00000;</span>
<a href="#l65.1681"></a><span id="l65.1681" class="difflineminus">-    if (sizeOnDisk &gt; kMaxFolderSize)</span>
<a href="#l65.1682"></a><span id="l65.1682" class="difflineplus">+  bool spaceAvailable;</span>
<a href="#l65.1683"></a><span id="l65.1683" class="difflineplus">+  // check if we have a reasonable amount of space left</span>
<a href="#l65.1684"></a><span id="l65.1684" class="difflineplus">+  rv = msgStore-&gt;HasSpaceAvailable(this, 0xFFFFF, &amp;spaceAvailable);</span>
<a href="#l65.1685"></a><span id="l65.1685" class="difflineplus">+  if (!spaceAvailable)</span>
<a href="#l65.1686"></a><span id="l65.1686">     {</span>
<a href="#l65.1687"></a><span id="l65.1687">       ThrowAlertMsg(&quot;mailboxTooLarge&quot;, aWindow);</span>
<a href="#l65.1688"></a><span id="l65.1688">       *aTooBig = PR_TRUE;</span>
<a href="#l65.1689"></a><span id="l65.1689">     }</span>
<a href="#l65.1690"></a><span id="l65.1690" class="difflineminus">-  }</span>
<a href="#l65.1691"></a><span id="l65.1691" class="difflineminus">-  else</span>
<a href="#l65.1692"></a><span id="l65.1692" class="difflineminus">-  {</span>
<a href="#l65.1693"></a><span id="l65.1693" class="difflineminus">-      // We are failing to obtain the size in the first place!</span>
<a href="#l65.1694"></a><span id="l65.1694" class="difflineminus">-      NS_ERROR( &quot;WarnIfLocalFileTooBig: call to GetFileSize failed&quot;);</span>
<a href="#l65.1695"></a><span id="l65.1695" class="difflineminus">-  }</span>
<a href="#l65.1696"></a><span id="l65.1696">   return NS_OK;</span>
<a href="#l65.1697"></a><span id="l65.1697"> }</span>
<a href="#l65.1698"></a><span id="l65.1698"> </span>
<a href="#l65.1699"></a><span id="l65.1699"> NS_IMETHODIMP nsMsgLocalMailFolder::FetchMsgPreviewText(nsMsgKey *aKeysToFetch, PRUint32 aNumKeys,</span>
<a href="#l65.1700"></a><span id="l65.1700">                                                  bool aLocalOnly, nsIUrlListener *aUrlListener,</span>
<a href="#l65.1701"></a><span id="l65.1701">                                                  bool *aAsyncResults)</span>
<a href="#l65.1702"></a><span id="l65.1702"> {</span>
<a href="#l65.1703"></a><span id="l65.1703">   NS_ENSURE_ARG_POINTER(aKeysToFetch);</span>
<a href="#l65.1704"></a><span id="l65.1704">   NS_ENSURE_ARG_POINTER(aAsyncResults);</span>
<a href="#l65.1705"></a><span id="l65.1705"> </span>
<a href="#l65.1706"></a><span id="l65.1706">   *aAsyncResults = PR_FALSE;</span>
<a href="#l65.1707"></a><span id="l65.1707">   nsCOMPtr &lt;nsIInputStream&gt; inputStream;</span>
<a href="#l65.1708"></a><span id="l65.1708" class="difflineminus">-</span>
<a href="#l65.1709"></a><span id="l65.1709" class="difflineminus">-  nsresult rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), mPath);</span>
<a href="#l65.1710"></a><span id="l65.1710" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.1711"></a><span id="l65.1711" class="difflineplus">+  nsresult rv = GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.1712"></a><span id="l65.1712">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1713"></a><span id="l65.1713"> </span>
<a href="#l65.1714"></a><span id="l65.1714">   for (PRUint32 i = 0; i &lt; aNumKeys; i++)</span>
<a href="#l65.1715"></a><span id="l65.1715">   {</span>
<a href="#l65.1716"></a><span id="l65.1716">     nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l65.1717"></a><span id="l65.1717">     nsCString prevBody;</span>
<a href="#l65.1718"></a><span id="l65.1718">     rv = GetMessageHeader(aKeysToFetch[i], getter_AddRefs(msgHdr));</span>
<a href="#l65.1719"></a><span id="l65.1719">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1720"></a><span id="l65.1720">     // ignore messages that already have a preview body.</span>
<a href="#l65.1721"></a><span id="l65.1721">     msgHdr-&gt;GetStringProperty(&quot;preview&quot;, getter_Copies(prevBody));</span>
<a href="#l65.1722"></a><span id="l65.1722">     if (!prevBody.IsEmpty())</span>
<a href="#l65.1723"></a><span id="l65.1723">       continue;</span>
<a href="#l65.1724"></a><span id="l65.1724" class="difflineminus">-    PRUint64 messageOffset;</span>
<a href="#l65.1725"></a><span id="l65.1725" class="difflineminus">-</span>
<a href="#l65.1726"></a><span id="l65.1726" class="difflineminus">-    msgHdr-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l65.1727"></a><span id="l65.1727" class="difflineminus">-    nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(inputStream);</span>
<a href="#l65.1728"></a><span id="l65.1728" class="difflineminus">-    if (seekableStream)</span>
<a href="#l65.1729"></a><span id="l65.1729" class="difflineminus">-      rv = seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, messageOffset);</span>
<a href="#l65.1730"></a><span id="l65.1730" class="difflineplus">+</span>
<a href="#l65.1731"></a><span id="l65.1731" class="difflineplus">+    bool reusable;</span>
<a href="#l65.1732"></a><span id="l65.1732" class="difflineplus">+    rv = GetMsgInputStream(msgHdr, &amp;reusable, getter_AddRefs(inputStream));</span>
<a href="#l65.1733"></a><span id="l65.1733">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l65.1734"></a><span id="l65.1734">     rv = GetMsgPreviewTextFromStream(msgHdr, inputStream);</span>
<a href="#l65.1735"></a><span id="l65.1735" class="difflineminus">-</span>
<a href="#l65.1736"></a><span id="l65.1736">   }</span>
<a href="#l65.1737"></a><span id="l65.1737">   return rv;</span>
<a href="#l65.1738"></a><span id="l65.1738"> }</span>
<a href="#l65.1739"></a><span id="l65.1739"> </span>
<a href="#l65.1740"></a><span id="l65.1740"> NS_IMETHODIMP nsMsgLocalMailFolder::AddKeywordsToMessages(nsIArray *aMessages, const nsACString&amp; aKeywords)</span>
<a href="#l65.1741"></a><span id="l65.1741"> {</span>
<a href="#l65.1742"></a><span id="l65.1742">   return ChangeKeywordForMessages(aMessages, aKeywords, PR_TRUE /* add */);</span>
<a href="#l65.1743"></a><span id="l65.1743"> }</span>
<a href="#l65.1744"></a><span id="l65.1744"> nsresult nsMsgLocalMailFolder::ChangeKeywordForMessages(nsIArray *aMessages, const nsACString&amp; aKeywords, bool add)</span>
<a href="#l65.1745"></a><span id="l65.1745"> {</span>
<a href="#l65.1746"></a><span id="l65.1746">   nsresult rv = (add) ? nsMsgDBFolder::AddKeywordsToMessages(aMessages, aKeywords)</span>
<a href="#l65.1747"></a><span id="l65.1747">                       : nsMsgDBFolder::RemoveKeywordsFromMessages(aMessages, aKeywords);</span>
<a href="#l65.1748"></a><span id="l65.1748"> </span>
<a href="#l65.1749"></a><span id="l65.1749" class="difflineminus">-  if (NS_SUCCEEDED(rv))</span>
<a href="#l65.1750"></a><span id="l65.1750" class="difflineminus">-  {</span>
<a href="#l65.1751"></a><span id="l65.1751" class="difflineminus">-    rv = GetDatabase();</span>
<a href="#l65.1752"></a><span id="l65.1752" class="difflineminus">-    if (!mDatabase)</span>
<a href="#l65.1753"></a><span id="l65.1753" class="difflineminus">-      return rv;</span>
<a href="#l65.1754"></a><span id="l65.1754" class="difflineminus">-</span>
<a href="#l65.1755"></a><span id="l65.1755" class="difflineminus">-    // this will fail if the folder is locked.</span>
<a href="#l65.1756"></a><span id="l65.1756" class="difflineminus">-    rv = mDatabase-&gt;StartBatch();</span>
<a href="#l65.1757"></a><span id="l65.1757" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1758"></a><span id="l65.1758" class="difflineminus">-    nsCOMPtr &lt;nsIOutputStream&gt; fileStream;</span>
<a href="#l65.1759"></a><span id="l65.1759" class="difflineminus">-    rv = mDatabase-&gt;GetFolderStream(getter_AddRefs(fileStream));</span>
<a href="#l65.1760"></a><span id="l65.1760" class="difflineminus">-    nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(fileStream);</span>
<a href="#l65.1761"></a><span id="l65.1761" class="difflineminus">-    nsCOMPtr &lt;nsIInputStream&gt; inputStream = do_QueryInterface(fileStream);</span>
<a href="#l65.1762"></a><span id="l65.1762" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1763"></a><span id="l65.1763" class="difflineminus">-    PRUint32 count, bytesWritten;</span>
<a href="#l65.1764"></a><span id="l65.1764" class="difflineminus">-    NS_ENSURE_ARG(aMessages);</span>
<a href="#l65.1765"></a><span id="l65.1765" class="difflineminus">-    nsresult rv = aMessages-&gt;GetLength(&amp;count);</span>
<a href="#l65.1766"></a><span id="l65.1766" class="difflineminus">-</span>
<a href="#l65.1767"></a><span id="l65.1767" class="difflineminus">-    nsLineBuffer&lt;char&gt; *lineBuffer;</span>
<a href="#l65.1768"></a><span id="l65.1768" class="difflineminus">-    rv = NS_InitLineBuffer(&amp;lineBuffer);</span>
<a href="#l65.1769"></a><span id="l65.1769">     NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1770"></a><span id="l65.1770" class="difflineminus">-</span>
<a href="#l65.1771"></a><span id="l65.1771" class="difflineminus">-    // for each message, we seek to the beginning of the x-mozilla-status header, and</span>
<a href="#l65.1772"></a><span id="l65.1772" class="difflineminus">-    // start reading lines, looking for x-mozilla-keys: headers; If we're adding</span>
<a href="#l65.1773"></a><span id="l65.1773" class="difflineminus">-    // the keyword and we find</span>
<a href="#l65.1774"></a><span id="l65.1774" class="difflineminus">-    // a header with the desired keyword already in it, we don't need to</span>
<a href="#l65.1775"></a><span id="l65.1775" class="difflineminus">-    // do anything. Likewise, if removing keyword and we don't find it,</span>
<a href="#l65.1776"></a><span id="l65.1776" class="difflineminus">-    // we don't need to do anything. Otherwise, if adding, we need to</span>
<a href="#l65.1777"></a><span id="l65.1777" class="difflineminus">-    // see if there's an x-mozilla-keys</span>
<a href="#l65.1778"></a><span id="l65.1778" class="difflineminus">-    // header with room for the new keyword. If so, we replace the</span>
<a href="#l65.1779"></a><span id="l65.1779" class="difflineminus">-    // corresponding number of spaces with the keyword. If no room,</span>
<a href="#l65.1780"></a><span id="l65.1780" class="difflineminus">-    // we can't do anything until the folder is compacted and another</span>
<a href="#l65.1781"></a><span id="l65.1781" class="difflineminus">-    // x-mozilla-keys header is added. In that case, we set a property</span>
<a href="#l65.1782"></a><span id="l65.1782" class="difflineminus">-    // on the header, which the compaction code will check.</span>
<a href="#l65.1783"></a><span id="l65.1783" class="difflineminus">-</span>
<a href="#l65.1784"></a><span id="l65.1784" class="difflineminus">-    // don't return out of the for loop - otherwise, we won't call EndBatch();</span>
<a href="#l65.1785"></a><span id="l65.1785" class="difflineminus">-    for (PRUint32 i = 0; i &lt; count; ++i) // for each message</span>
<a href="#l65.1786"></a><span id="l65.1786" class="difflineminus">-    {</span>
<a href="#l65.1787"></a><span id="l65.1787" class="difflineminus">-      nsCOMPtr&lt;nsIMsgDBHdr&gt; message = do_QueryElementAt(aMessages, i, &amp;rv);</span>
<a href="#l65.1788"></a><span id="l65.1788" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1789"></a><span id="l65.1789" class="difflineminus">-      PRUint64 messageOffset;</span>
<a href="#l65.1790"></a><span id="l65.1790" class="difflineminus">-      message-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l65.1791"></a><span id="l65.1791" class="difflineminus">-      PRUint32 statusOffset = 0;</span>
<a href="#l65.1792"></a><span id="l65.1792" class="difflineminus">-      (void)message-&gt;GetStatusOffset(&amp;statusOffset);</span>
<a href="#l65.1793"></a><span id="l65.1793" class="difflineminus">-      PRUint64 desiredOffset = messageOffset + statusOffset;</span>
<a href="#l65.1794"></a><span id="l65.1794" class="difflineminus">-</span>
<a href="#l65.1795"></a><span id="l65.1795" class="difflineminus">-      nsTArray&lt;nsCString&gt; keywordArray;</span>
<a href="#l65.1796"></a><span id="l65.1796" class="difflineminus">-      ParseString(aKeywords, ' ', keywordArray);</span>
<a href="#l65.1797"></a><span id="l65.1797" class="difflineminus">-      for (PRUint32 j = 0; j &lt; keywordArray.Length(); j++)</span>
<a href="#l65.1798"></a><span id="l65.1798" class="difflineminus">-      {</span>
<a href="#l65.1799"></a><span id="l65.1799" class="difflineminus">-        nsCAutoString header;</span>
<a href="#l65.1800"></a><span id="l65.1800" class="difflineminus">-        nsCAutoString keywords;</span>
<a href="#l65.1801"></a><span id="l65.1801" class="difflineminus">-        bool done = false;</span>
<a href="#l65.1802"></a><span id="l65.1802" class="difflineminus">-        PRUint32 len = 0;</span>
<a href="#l65.1803"></a><span id="l65.1803" class="difflineminus">-        nsCAutoString keywordToWrite(&quot; &quot;);</span>
<a href="#l65.1804"></a><span id="l65.1804" class="difflineminus">-</span>
<a href="#l65.1805"></a><span id="l65.1805" class="difflineminus">-        keywordToWrite.Append(keywordArray[j]);</span>
<a href="#l65.1806"></a><span id="l65.1806" class="difflineminus">-        seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, desiredOffset);</span>
<a href="#l65.1807"></a><span id="l65.1807" class="difflineminus">-        // need to reset lineBuffer, which is cheaper than creating a new one.</span>
<a href="#l65.1808"></a><span id="l65.1808" class="difflineminus">-        lineBuffer-&gt;start = lineBuffer-&gt;end = lineBuffer-&gt;buf;</span>
<a href="#l65.1809"></a><span id="l65.1809" class="difflineminus">-        bool inKeywordHeader = false;</span>
<a href="#l65.1810"></a><span id="l65.1810" class="difflineminus">-        bool foundKeyword = false;</span>
<a href="#l65.1811"></a><span id="l65.1811" class="difflineminus">-        PRUint64 offsetToAddKeyword = 0;</span>
<a href="#l65.1812"></a><span id="l65.1812" class="difflineminus">-        bool more;</span>
<a href="#l65.1813"></a><span id="l65.1813" class="difflineminus">-        message-&gt;GetMessageSize(&amp;len);</span>
<a href="#l65.1814"></a><span id="l65.1814" class="difflineminus">-        // loop through</span>
<a href="#l65.1815"></a><span id="l65.1815" class="difflineminus">-        while (!done)</span>
<a href="#l65.1816"></a><span id="l65.1816" class="difflineminus">-        {</span>
<a href="#l65.1817"></a><span id="l65.1817" class="difflineminus">-          PRInt64 lineStartPos;</span>
<a href="#l65.1818"></a><span id="l65.1818" class="difflineminus">-          seekableStream-&gt;Tell(&amp;lineStartPos);</span>
<a href="#l65.1819"></a><span id="l65.1819" class="difflineminus">-          // we need to adjust the linestart pos by how much extra the line</span>
<a href="#l65.1820"></a><span id="l65.1820" class="difflineminus">-          // buffer has read from the stream.</span>
<a href="#l65.1821"></a><span id="l65.1821" class="difflineminus">-          lineStartPos -= (lineBuffer-&gt;end - lineBuffer-&gt;start);</span>
<a href="#l65.1822"></a><span id="l65.1822" class="difflineminus">-          // NS_ReadLine doesn't return line termination chars.</span>
<a href="#l65.1823"></a><span id="l65.1823" class="difflineminus">-          nsCString keywordHeaders;</span>
<a href="#l65.1824"></a><span id="l65.1824" class="difflineminus">-          rv = NS_ReadLine(inputStream.get(), lineBuffer, keywordHeaders, &amp;more);</span>
<a href="#l65.1825"></a><span id="l65.1825" class="difflineminus">-          if (NS_SUCCEEDED(rv))</span>
<a href="#l65.1826"></a><span id="l65.1826" class="difflineminus">-          {</span>
<a href="#l65.1827"></a><span id="l65.1827" class="difflineminus">-            if (keywordHeaders.IsEmpty())</span>
<a href="#l65.1828"></a><span id="l65.1828" class="difflineminus">-              break; // passed headers; no x-mozilla-keywords header; give up.</span>
<a href="#l65.1829"></a><span id="l65.1829" class="difflineminus">-            if (StringBeginsWith(keywordHeaders, NS_LITERAL_CSTRING(HEADER_X_MOZILLA_KEYWORDS)))</span>
<a href="#l65.1830"></a><span id="l65.1830" class="difflineminus">-              inKeywordHeader = PR_TRUE;</span>
<a href="#l65.1831"></a><span id="l65.1831" class="difflineminus">-            else if (inKeywordHeader &amp;&amp; (keywordHeaders.CharAt(0) == ' ' || keywordHeaders.CharAt(0) == '\t'))</span>
<a href="#l65.1832"></a><span id="l65.1832" class="difflineminus">-              ; // continuation header line</span>
<a href="#l65.1833"></a><span id="l65.1833" class="difflineminus">-            else if (inKeywordHeader)</span>
<a href="#l65.1834"></a><span id="l65.1834" class="difflineminus">-              break;</span>
<a href="#l65.1835"></a><span id="l65.1835" class="difflineminus">-            else</span>
<a href="#l65.1836"></a><span id="l65.1836" class="difflineminus">-              continue;</span>
<a href="#l65.1837"></a><span id="l65.1837" class="difflineminus">-            PRUint32 keywordHdrLength = keywordHeaders.Length();</span>
<a href="#l65.1838"></a><span id="l65.1838" class="difflineminus">-            PRInt32 startOffset, keywordLength;</span>
<a href="#l65.1839"></a><span id="l65.1839" class="difflineminus">-            // check if we have the keyword</span>
<a href="#l65.1840"></a><span id="l65.1840" class="difflineminus">-            if (MsgFindKeyword(keywordArray[j], keywordHeaders, &amp;startOffset, &amp;keywordLength))</span>
<a href="#l65.1841"></a><span id="l65.1841" class="difflineminus">-            {</span>
<a href="#l65.1842"></a><span id="l65.1842" class="difflineminus">-              foundKeyword = PR_TRUE;</span>
<a href="#l65.1843"></a><span id="l65.1843" class="difflineminus">-              if (!add) // if we're removing, remove it, and break;</span>
<a href="#l65.1844"></a><span id="l65.1844" class="difflineminus">-              {</span>
<a href="#l65.1845"></a><span id="l65.1845" class="difflineminus">-                keywordHeaders.Cut(startOffset, keywordLength);</span>
<a href="#l65.1846"></a><span id="l65.1846" class="difflineminus">-                for (PRInt32 i = keywordLength; i &gt; 0; i--)</span>
<a href="#l65.1847"></a><span id="l65.1847" class="difflineminus">-                  keywordHeaders.Append(' ');</span>
<a href="#l65.1848"></a><span id="l65.1848" class="difflineminus">-                seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, lineStartPos);</span>
<a href="#l65.1849"></a><span id="l65.1849" class="difflineminus">-                fileStream-&gt;Write(keywordHeaders.get(), keywordHeaders.Length(), &amp;bytesWritten);</span>
<a href="#l65.1850"></a><span id="l65.1850" class="difflineminus">-              }</span>
<a href="#l65.1851"></a><span id="l65.1851" class="difflineminus">-              offsetToAddKeyword = 0;</span>
<a href="#l65.1852"></a><span id="l65.1852" class="difflineminus">-              // if adding and we already have the keyword, done</span>
<a href="#l65.1853"></a><span id="l65.1853" class="difflineminus">-              done = PR_TRUE;</span>
<a href="#l65.1854"></a><span id="l65.1854" class="difflineminus">-              break;</span>
<a href="#l65.1855"></a><span id="l65.1855" class="difflineminus">-            }</span>
<a href="#l65.1856"></a><span id="l65.1856" class="difflineminus">-            // argh, we need to check all the lines to see if we already have the</span>
<a href="#l65.1857"></a><span id="l65.1857" class="difflineminus">-            // keyword, but if we don't find it, we want to remember the line and</span>
<a href="#l65.1858"></a><span id="l65.1858" class="difflineminus">-            // position where we have room to add the keyword.</span>
<a href="#l65.1859"></a><span id="l65.1859" class="difflineminus">-            if (add)</span>
<a href="#l65.1860"></a><span id="l65.1860" class="difflineminus">-            {</span>
<a href="#l65.1861"></a><span id="l65.1861" class="difflineminus">-              nsCAutoString curKeywordHdr(keywordHeaders);</span>
<a href="#l65.1862"></a><span id="l65.1862" class="difflineminus">-              // strip off line ending spaces.</span>
<a href="#l65.1863"></a><span id="l65.1863" class="difflineminus">-              curKeywordHdr.Trim(&quot; &quot;, PR_FALSE, PR_TRUE);</span>
<a href="#l65.1864"></a><span id="l65.1864" class="difflineminus">-              if (!offsetToAddKeyword &amp;&amp; curKeywordHdr.Length() + keywordToWrite.Length() &lt; keywordHdrLength)</span>
<a href="#l65.1865"></a><span id="l65.1865" class="difflineminus">-                offsetToAddKeyword = lineStartPos + curKeywordHdr.Length();</span>
<a href="#l65.1866"></a><span id="l65.1866" class="difflineminus">-            }</span>
<a href="#l65.1867"></a><span id="l65.1867" class="difflineminus">-          }</span>
<a href="#l65.1868"></a><span id="l65.1868" class="difflineminus">-        }</span>
<a href="#l65.1869"></a><span id="l65.1869" class="difflineminus">-        if (add &amp;&amp; !foundKeyword)</span>
<a href="#l65.1870"></a><span id="l65.1870" class="difflineminus">-        {</span>
<a href="#l65.1871"></a><span id="l65.1871" class="difflineminus">-          if (!offsetToAddKeyword)</span>
<a href="#l65.1872"></a><span id="l65.1872" class="difflineminus">-           message-&gt;SetUint32Property(&quot;growKeywords&quot;, 1);</span>
<a href="#l65.1873"></a><span id="l65.1873" class="difflineminus">-          else</span>
<a href="#l65.1874"></a><span id="l65.1874" class="difflineminus">-          {</span>
<a href="#l65.1875"></a><span id="l65.1875" class="difflineminus">-            seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, offsetToAddKeyword);</span>
<a href="#l65.1876"></a><span id="l65.1876" class="difflineminus">-            fileStream-&gt;Write(keywordToWrite.get(), keywordToWrite.Length(), &amp;bytesWritten);</span>
<a href="#l65.1877"></a><span id="l65.1877" class="difflineminus">-          }</span>
<a href="#l65.1878"></a><span id="l65.1878" class="difflineminus">-        }</span>
<a href="#l65.1879"></a><span id="l65.1879" class="difflineminus">-      }</span>
<a href="#l65.1880"></a><span id="l65.1880" class="difflineminus">-    }</span>
<a href="#l65.1881"></a><span id="l65.1881" class="difflineminus">-    mDatabase-&gt;EndBatch();</span>
<a href="#l65.1882"></a><span id="l65.1882" class="difflineminus">-    PR_Free(lineBuffer);</span>
<a href="#l65.1883"></a><span id="l65.1883" class="difflineminus">-  }</span>
<a href="#l65.1884"></a><span id="l65.1884" class="difflineminus">-  return rv;</span>
<a href="#l65.1885"></a><span id="l65.1885" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l65.1886"></a><span id="l65.1886" class="difflineplus">+  GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l65.1887"></a><span id="l65.1887" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l65.1888"></a><span id="l65.1888" class="difflineplus">+  return msgStore-&gt;ChangeKeywords(aMessages, aKeywords, add);</span>
<a href="#l65.1889"></a><span id="l65.1889"> }</span>
<a href="#l65.1890"></a><span id="l65.1890"> </span>
<a href="#l65.1891"></a><span id="l65.1891"> NS_IMETHODIMP nsMsgLocalMailFolder::RemoveKeywordsFromMessages(nsIArray *aMessages, const nsACString&amp; aKeywords)</span>
<a href="#l65.1892"></a><span id="l65.1892"> {</span>
<a href="#l65.1893"></a><span id="l65.1893">   return ChangeKeywordForMessages(aMessages, aKeywords, PR_FALSE /* remove */);</span>
<a href="#l65.1894"></a><span id="l65.1894"> }</span>
<a href="#l65.1895"></a><span id="l65.1895"> </span>
<a href="#l65.1896"></a><span id="l65.1896"> NS_IMETHODIMP nsMsgLocalMailFolder::UpdateNewMsgHdr(nsIMsgDBHdr* aOldHdr, nsIMsgDBHdr* aNewHdr)</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l66.1"></a><span id="l66.1" class="difflineminus">--- a/mailnews/local/src/nsLocalMailFolder.h</span>
<a href="#l66.2"></a><span id="l66.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalMailFolder.h</span>
<a href="#l66.3"></a><span id="l66.3" class="difflineat">@@ -61,16 +61,17 @@</span>
<a href="#l66.4"></a><span id="l66.4"> class nsParseMailMessageState;</span>
<a href="#l66.5"></a><span id="l66.5"> </span>
<a href="#l66.6"></a><span id="l66.6"> struct nsLocalMailCopyState</span>
<a href="#l66.7"></a><span id="l66.7"> {</span>
<a href="#l66.8"></a><span id="l66.8">   nsLocalMailCopyState();</span>
<a href="#l66.9"></a><span id="l66.9">   virtual ~nsLocalMailCopyState();</span>
<a href="#l66.10"></a><span id="l66.10">   </span>
<a href="#l66.11"></a><span id="l66.11">   nsCOMPtr &lt;nsIOutputStream&gt; m_fileStream;</span>
<a href="#l66.12"></a><span id="l66.12" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; m_msgStore;</span>
<a href="#l66.13"></a><span id="l66.13">   nsCOMPtr&lt;nsISupports&gt; m_srcSupport;</span>
<a href="#l66.14"></a><span id="l66.14">   /// Source nsIMsgDBHdr instances.</span>
<a href="#l66.15"></a><span id="l66.15">   nsCOMPtr&lt;nsIArray&gt; m_messages;</span>
<a href="#l66.16"></a><span id="l66.16">   /// Destination nsIMsgDBHdr instances.</span>
<a href="#l66.17"></a><span id="l66.17">   nsCOMPtr&lt;nsIMutableArray&gt; m_destMessages;</span>
<a href="#l66.18"></a><span id="l66.18">   nsRefPtr&lt;nsLocalMoveCopyMsgTxn&gt; m_undoMsgTxn;</span>
<a href="#l66.19"></a><span id="l66.19">   nsCOMPtr&lt;nsIMsgDBHdr&gt; m_message; // current copy message</span>
<a href="#l66.20"></a><span id="l66.20">   nsMsgMessageFlagType m_flags; // current copy message flags</span>
<a href="#l66.21"></a><span id="l66.21" class="difflineat">@@ -97,32 +98,32 @@ struct nsLocalMailCopyState</span>
<a href="#l66.22"></a><span id="l66.22">   bool m_dummyEnvelopeNeeded;</span>
<a href="#l66.23"></a><span id="l66.23">   bool m_copyingMultipleMessages;</span>
<a href="#l66.24"></a><span id="l66.24">   bool m_fromLineSeen;</span>
<a href="#l66.25"></a><span id="l66.25">   bool m_allowUndo;</span>
<a href="#l66.26"></a><span id="l66.26">   bool m_writeFailed;</span>
<a href="#l66.27"></a><span id="l66.27">   bool m_notifyFolderLoaded;</span>
<a href="#l66.28"></a><span id="l66.28">   bool m_wholeMsgInStream;</span>
<a href="#l66.29"></a><span id="l66.29">   nsCString    m_newMsgKeywords;</span>
<a href="#l66.30"></a><span id="l66.30" class="difflineminus">-  nsCOMPtr &lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l66.31"></a><span id="l66.31" class="difflineplus">+  nsCOMPtr &lt;nsIMsgDBHdr&gt; m_newHdr;</span>
<a href="#l66.32"></a><span id="l66.32"> };</span>
<a href="#l66.33"></a><span id="l66.33"> </span>
<a href="#l66.34"></a><span id="l66.34"> struct nsLocalFolderScanState</span>
<a href="#l66.35"></a><span id="l66.35"> {</span>
<a href="#l66.36"></a><span id="l66.36">   nsLocalFolderScanState();</span>
<a href="#l66.37"></a><span id="l66.37">   ~nsLocalFolderScanState();</span>
<a href="#l66.38"></a><span id="l66.38"> </span>
<a href="#l66.39"></a><span id="l66.39" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; m_localFile;</span>
<a href="#l66.40"></a><span id="l66.40" class="difflineminus">-  nsCOMPtr&lt;nsIFileInputStream&gt; m_fileStream;</span>
<a href="#l66.41"></a><span id="l66.41">   nsCOMPtr&lt;nsIInputStream&gt; m_inputStream;</span>
<a href="#l66.42"></a><span id="l66.42">   nsCOMPtr&lt;nsISeekableStream&gt; m_seekableStream;</span>
<a href="#l66.43"></a><span id="l66.43" class="difflineminus">-  nsCOMPtr&lt;nsILineInputStream&gt; m_fileLineStream;</span>
<a href="#l66.44"></a><span id="l66.44" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; m_msgStore;</span>
<a href="#l66.45"></a><span id="l66.45">   nsCString m_header;</span>
<a href="#l66.46"></a><span id="l66.46">   nsCString m_accountKey;</span>
<a href="#l66.47"></a><span id="l66.47">   const char *m_uidl; // memory is owned by m_header</span>
<a href="#l66.48"></a><span id="l66.48" class="difflineplus">+  // false if we need a new input stream for each message</span>
<a href="#l66.49"></a><span id="l66.49" class="difflineplus">+  bool m_streamReusable;</span>
<a href="#l66.50"></a><span id="l66.50"> };</span>
<a href="#l66.51"></a><span id="l66.51"> </span>
<a href="#l66.52"></a><span id="l66.52"> class nsMsgLocalMailFolder : public nsMsgDBFolder,</span>
<a href="#l66.53"></a><span id="l66.53">                              public nsIMsgLocalMailFolder,</span>
<a href="#l66.54"></a><span id="l66.54">                              public nsICopyMessageListener</span>
<a href="#l66.55"></a><span id="l66.55"> {</span>
<a href="#l66.56"></a><span id="l66.56"> public:</span>
<a href="#l66.57"></a><span id="l66.57">   nsMsgLocalMailFolder(void);</span>
<a href="#l66.58"></a><span id="l66.58" class="difflineat">@@ -142,17 +143,16 @@ public:</span>
<a href="#l66.59"></a><span id="l66.59">   NS_IMETHOD GetSubFolders(nsISimpleEnumerator* *aResult);</span>
<a href="#l66.60"></a><span id="l66.60">   NS_IMETHOD GetMsgDatabase(nsIMsgDatabase **aMsgDatabase);</span>
<a href="#l66.61"></a><span id="l66.61"> </span>
<a href="#l66.62"></a><span id="l66.62">   NS_IMETHOD OnAnnouncerGoingAway(nsIDBChangeAnnouncer *instigator);</span>
<a href="#l66.63"></a><span id="l66.63">   NS_IMETHOD GetMessages(nsISimpleEnumerator **result);</span>
<a href="#l66.64"></a><span id="l66.64">   NS_IMETHOD UpdateFolder(nsIMsgWindow *aWindow);</span>
<a href="#l66.65"></a><span id="l66.65"> </span>
<a href="#l66.66"></a><span id="l66.66">   NS_IMETHOD CreateSubfolder(const nsAString&amp; folderName ,nsIMsgWindow *msgWindow);</span>
<a href="#l66.67"></a><span id="l66.67" class="difflineminus">-  NS_IMETHOD AddSubfolder(const nsAString&amp; folderName, nsIMsgFolder** newFolder);</span>
<a href="#l66.68"></a><span id="l66.68"> </span>
<a href="#l66.69"></a><span id="l66.69">   NS_IMETHOD Compact(nsIUrlListener *aListener, nsIMsgWindow *aMsgWindow);</span>
<a href="#l66.70"></a><span id="l66.70">   NS_IMETHOD CompactAll(nsIUrlListener *aListener, nsIMsgWindow *aMsgWindow, bool aCompactOfflineAlso);</span>
<a href="#l66.71"></a><span id="l66.71">   NS_IMETHOD EmptyTrash(nsIMsgWindow *msgWindow, nsIUrlListener *aListener);</span>
<a href="#l66.72"></a><span id="l66.72">   NS_IMETHOD Delete ();</span>
<a href="#l66.73"></a><span id="l66.73">   NS_IMETHOD DeleteSubFolders(nsIArray *folders, nsIMsgWindow *msgWindow);</span>
<a href="#l66.74"></a><span id="l66.74">   NS_IMETHOD CreateStorageIfMissing(nsIUrlListener* urlListener);</span>
<a href="#l66.75"></a><span id="l66.75">   NS_IMETHOD Rename (const nsAString&amp; aNewName, nsIMsgWindow *msgWindow);</span>
<a href="#l66.76"></a><span id="l66.76" class="difflineat">@@ -181,16 +181,18 @@ public:</span>
<a href="#l66.77"></a><span id="l66.77">   NS_IMETHOD CopyFolder(nsIMsgFolder *srcFolder, bool isMoveFolder, nsIMsgWindow *msgWindow,</span>
<a href="#l66.78"></a><span id="l66.78">                           nsIMsgCopyServiceListener* listener);</span>
<a href="#l66.79"></a><span id="l66.79">   NS_IMETHOD CopyFileMessage(nsIFile* aFile, nsIMsgDBHdr* msgToReplace,</span>
<a href="#l66.80"></a><span id="l66.80">                              bool isDraftOrTemplate, </span>
<a href="#l66.81"></a><span id="l66.81">                              PRUint32 newMsgFlags,</span>
<a href="#l66.82"></a><span id="l66.82">                              const nsACString &amp;aNewMsgKeywords,</span>
<a href="#l66.83"></a><span id="l66.83">                              nsIMsgWindow *msgWindow,</span>
<a href="#l66.84"></a><span id="l66.84">                              nsIMsgCopyServiceListener* listener);</span>
<a href="#l66.85"></a><span id="l66.85" class="difflineplus">+  NS_IMETHOD MarkMessagesRead(nsIArray *aMessages, bool aMarkRead);</span>
<a href="#l66.86"></a><span id="l66.86" class="difflineplus">+  NS_IMETHOD MarkMessagesFlagged(nsIArray *aMessages, bool aMarkFlagged);</span>
<a href="#l66.87"></a><span id="l66.87">   NS_IMETHOD GetNewMessages(nsIMsgWindow *aWindow, nsIUrlListener *aListener);</span>
<a href="#l66.88"></a><span id="l66.88">   NS_IMETHOD NotifyCompactCompleted();</span>
<a href="#l66.89"></a><span id="l66.89">   NS_IMETHOD Shutdown(bool shutdownChildren);</span>
<a href="#l66.90"></a><span id="l66.90"> </span>
<a href="#l66.91"></a><span id="l66.91">   NS_IMETHOD WriteToFolderCacheElem(nsIMsgFolderCacheElement *element);</span>
<a href="#l66.92"></a><span id="l66.92">   NS_IMETHOD ReadFromFolderCacheElem(nsIMsgFolderCacheElement *element);</span>
<a href="#l66.93"></a><span id="l66.93"> </span>
<a href="#l66.94"></a><span id="l66.94">   NS_IMETHOD GetName(nsAString&amp; aName);</span>
<a href="#l66.95"></a><span id="l66.95" class="difflineat">@@ -247,21 +249,25 @@ protected:</span>
<a href="#l66.96"></a><span id="l66.96">   // copy multiple messages at a time from this folder</span>
<a href="#l66.97"></a><span id="l66.97">   nsresult CopyMessagesTo(nsIArray *messages, nsTArray&lt;nsMsgKey&gt; &amp;keyArray,</span>
<a href="#l66.98"></a><span id="l66.98">                                        nsIMsgWindow *aMsgWindow,</span>
<a href="#l66.99"></a><span id="l66.99">                                        nsIMsgFolder *dstFolder,</span>
<a href="#l66.100"></a><span id="l66.100">                                        bool isMove);</span>
<a href="#l66.101"></a><span id="l66.101">   virtual void GetIncomingServerType(nsCString&amp; serverType);</span>
<a href="#l66.102"></a><span id="l66.102">   nsresult InitCopyState(nsISupports* aSupport, nsIArray* messages,</span>
<a href="#l66.103"></a><span id="l66.103">                          bool isMove, nsIMsgCopyServiceListener* listener, nsIMsgWindow *msgWindow, bool isMoveFolder, bool allowUndo);</span>
<a href="#l66.104"></a><span id="l66.104" class="difflineplus">+  nsresult InitCopyMsgHdrAndFileStream();</span>
<a href="#l66.105"></a><span id="l66.105">   // preserve message metadata when moving or copying messages</span>
<a href="#l66.106"></a><span id="l66.106">   void CopyPropertiesToMsgHdr(nsIMsgDBHdr *destHdr, nsIMsgDBHdr *srcHdr, bool isMove);</span>
<a href="#l66.107"></a><span id="l66.107">   virtual nsresult CreateBaseMessageURI(const nsACString&amp; aURI);</span>
<a href="#l66.108"></a><span id="l66.108">   nsresult ChangeKeywordForMessages(nsIArray *aMessages, const nsACString&amp; aKeyword, bool add);</span>
<a href="#l66.109"></a><span id="l66.109">   bool GetDeleteFromServerOnMove();</span>
<a href="#l66.110"></a><span id="l66.110" class="difflineplus">+  void CopyHdrPropertiesWithSkipList(nsIMsgDBHdr *destHdr,</span>
<a href="#l66.111"></a><span id="l66.111" class="difflineplus">+                                     nsIMsgDBHdr *srcHdr,</span>
<a href="#l66.112"></a><span id="l66.112" class="difflineplus">+                                     const nsCString &amp;skipList);</span>
<a href="#l66.113"></a><span id="l66.113"> </span>
<a href="#l66.114"></a><span id="l66.114"> protected:</span>
<a href="#l66.115"></a><span id="l66.115">   nsLocalMailCopyState *mCopyState; //We only allow one of these at a time</span>
<a href="#l66.116"></a><span id="l66.116">   nsCString mType;</span>
<a href="#l66.117"></a><span id="l66.117">   bool mHaveReadNameFromDB;</span>
<a href="#l66.118"></a><span id="l66.118">   bool mInitialized;</span>
<a href="#l66.119"></a><span id="l66.119">   bool mCheckForNewMessagesAfterParsing;</span>
<a href="#l66.120"></a><span id="l66.120">   bool m_parsingFolder;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l67.1"></a><span id="l67.1" class="difflineminus">--- a/mailnews/local/src/nsLocalUndoTxn.cpp</span>
<a href="#l67.2"></a><span id="l67.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalUndoTxn.cpp</span>
<a href="#l67.3"></a><span id="l67.3" class="difflineat">@@ -48,17 +48,20 @@</span>
<a href="#l67.4"></a><span id="l67.4"> #include &quot;nsIMsgFolderNotificationService.h&quot;</span>
<a href="#l67.5"></a><span id="l67.5"> #include &quot;nsThreadUtils.h&quot;</span>
<a href="#l67.6"></a><span id="l67.6"> #include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l67.7"></a><span id="l67.7"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l67.8"></a><span id="l67.8"> #include &quot;nsServiceManagerUtils.h&quot;</span>
<a href="#l67.9"></a><span id="l67.9"> #include &quot;nsComponentManagerUtils.h&quot;</span>
<a href="#l67.10"></a><span id="l67.10"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l67.11"></a><span id="l67.11"> </span>
<a href="#l67.12"></a><span id="l67.12" class="difflineminus">-nsLocalMoveCopyMsgTxn::nsLocalMoveCopyMsgTxn()  : m_srcIsImap4(PR_FALSE)</span>
<a href="#l67.13"></a><span id="l67.13" class="difflineplus">+NS_IMPL_ISUPPORTS_INHERITED1(nsLocalMoveCopyMsgTxn, nsMsgTxn, nsIFolderListener)</span>
<a href="#l67.14"></a><span id="l67.14" class="difflineplus">+</span>
<a href="#l67.15"></a><span id="l67.15" class="difflineplus">+nsLocalMoveCopyMsgTxn::nsLocalMoveCopyMsgTxn()  : m_srcIsImap4(PR_FALSE),</span>
<a href="#l67.16"></a><span id="l67.16" class="difflineplus">+  m_canUndelete(PR_FALSE)</span>
<a href="#l67.17"></a><span id="l67.17"> {</span>
<a href="#l67.18"></a><span id="l67.18"> }</span>
<a href="#l67.19"></a><span id="l67.19"> </span>
<a href="#l67.20"></a><span id="l67.20"> nsLocalMoveCopyMsgTxn::~nsLocalMoveCopyMsgTxn()</span>
<a href="#l67.21"></a><span id="l67.21"> {</span>
<a href="#l67.22"></a><span id="l67.22"> }</span>
<a href="#l67.23"></a><span id="l67.23"> </span>
<a href="#l67.24"></a><span id="l67.24"> nsresult</span>
<a href="#l67.25"></a><span id="l67.25" class="difflineat">@@ -192,16 +195,19 @@ nsLocalMoveCopyMsgTxn::UndoTransaction()</span>
<a href="#l67.26"></a><span id="l67.26">   nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l67.27"></a><span id="l67.27">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l67.28"></a><span id="l67.28">   nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; dstlocalMailFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l67.29"></a><span id="l67.29">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l67.30"></a><span id="l67.30">   dstlocalMailFolder-&gt;GetDatabaseWOReparse(getter_AddRefs(dstDB));</span>
<a href="#l67.31"></a><span id="l67.31"> </span>
<a href="#l67.32"></a><span id="l67.32">   if (!dstDB)</span>
<a href="#l67.33"></a><span id="l67.33">   {</span>
<a href="#l67.34"></a><span id="l67.34" class="difflineplus">+    // This will listen for the db reparse finishing, and the corresponding</span>
<a href="#l67.35"></a><span id="l67.35" class="difflineplus">+    // FolderLoadedNotification. When it gets that, it will then call</span>
<a href="#l67.36"></a><span id="l67.36" class="difflineplus">+    // UndoTransactionInternal.</span>
<a href="#l67.37"></a><span id="l67.37">     mUndoFolderListener = new nsLocalUndoFolderListener(this, dstFolder);</span>
<a href="#l67.38"></a><span id="l67.38">     if (!mUndoFolderListener)</span>
<a href="#l67.39"></a><span id="l67.39">       return NS_ERROR_OUT_OF_MEMORY; </span>
<a href="#l67.40"></a><span id="l67.40">     NS_ADDREF(mUndoFolderListener);</span>
<a href="#l67.41"></a><span id="l67.41">     </span>
<a href="#l67.42"></a><span id="l67.42">     nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = </span>
<a href="#l67.43"></a><span id="l67.43">       do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv); </span>
<a href="#l67.44"></a><span id="l67.44">     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l67.45"></a><span id="l67.45" class="difflineat">@@ -263,17 +269,17 @@ nsLocalMoveCopyMsgTxn::UndoTransactionIn</span>
<a href="#l67.46"></a><span id="l67.46">   if (m_isMove)</span>
<a href="#l67.47"></a><span id="l67.47">   {</span>
<a href="#l67.48"></a><span id="l67.48">     if (m_srcIsImap4)</span>
<a href="#l67.49"></a><span id="l67.49">     {</span>
<a href="#l67.50"></a><span id="l67.50">       bool deleteFlag = true;  //message has been deleted -we are trying to undo it</span>
<a href="#l67.51"></a><span id="l67.51">       CheckForToggleDelete(srcFolder, m_srcKeyArray[0], &amp;deleteFlag); //there could have been a toggle.</span>
<a href="#l67.52"></a><span id="l67.52">       rv = UndoImapDeleteFlag(srcFolder, m_srcKeyArray, deleteFlag);</span>
<a href="#l67.53"></a><span id="l67.53">     }</span>
<a href="#l67.54"></a><span id="l67.54" class="difflineminus">-    else</span>
<a href="#l67.55"></a><span id="l67.55" class="difflineplus">+    else if (m_canUndelete)</span>
<a href="#l67.56"></a><span id="l67.56">     {</span>
<a href="#l67.57"></a><span id="l67.57">       nsCOMPtr&lt;nsIMutableArray&gt; srcMessages =</span>
<a href="#l67.58"></a><span id="l67.58">         do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l67.59"></a><span id="l67.59">       nsCOMPtr&lt;nsIMutableArray&gt; dstMessages =</span>
<a href="#l67.60"></a><span id="l67.60">         do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l67.61"></a><span id="l67.61"> </span>
<a href="#l67.62"></a><span id="l67.62">       srcDB-&gt;StartBatch();</span>
<a href="#l67.63"></a><span id="l67.63">       for (i = 0; i &lt; count; i++)</span>
<a href="#l67.64"></a><span id="l67.64" class="difflineat">@@ -309,29 +315,54 @@ nsLocalMoveCopyMsgTxn::UndoTransactionIn</span>
<a href="#l67.65"></a><span id="l67.65">         notifier-&gt;NotifyMsgsMoveCopyCompleted(PR_TRUE, dstMessages,</span>
<a href="#l67.66"></a><span id="l67.66">                                               srcFolder, srcMessages);</span>
<a href="#l67.67"></a><span id="l67.67">       }</span>
<a href="#l67.68"></a><span id="l67.68"> </span>
<a href="#l67.69"></a><span id="l67.69">       nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(srcFolder);</span>
<a href="#l67.70"></a><span id="l67.70">       if (localFolder)</span>
<a href="#l67.71"></a><span id="l67.71">         localFolder-&gt;MarkMsgsOnPop3Server(srcMessages, POP3_NONE /*deleteMsgs*/);</span>
<a href="#l67.72"></a><span id="l67.72">     }</span>
<a href="#l67.73"></a><span id="l67.73" class="difflineplus">+    else // undoing a move means moving the messages back.</span>
<a href="#l67.74"></a><span id="l67.74" class="difflineplus">+    {</span>
<a href="#l67.75"></a><span id="l67.75" class="difflineplus">+      nsCOMPtr&lt;nsIMutableArray&gt; dstMessages =</span>
<a href="#l67.76"></a><span id="l67.76" class="difflineplus">+        do_CreateInstance(NS_ARRAY_CONTRACTID);</span>
<a href="#l67.77"></a><span id="l67.77" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; dstHdr;</span>
<a href="#l67.78"></a><span id="l67.78" class="difflineplus">+      m_numHdrsCopied = 0;</span>
<a href="#l67.79"></a><span id="l67.79" class="difflineplus">+      m_srcKeyArray.Clear();</span>
<a href="#l67.80"></a><span id="l67.80" class="difflineplus">+      for (i = 0; i &lt; count; i++)</span>
<a href="#l67.81"></a><span id="l67.81" class="difflineplus">+      {</span>
<a href="#l67.82"></a><span id="l67.82" class="difflineplus">+        dstDB-&gt;GetMsgHdrForKey(m_dstKeyArray[i], getter_AddRefs(dstHdr));</span>
<a href="#l67.83"></a><span id="l67.83" class="difflineplus">+        NS_ASSERTION(dstHdr, &quot;fatal ... cannot get old msg header\n&quot;);</span>
<a href="#l67.84"></a><span id="l67.84" class="difflineplus">+        if (dstHdr)</span>
<a href="#l67.85"></a><span id="l67.85" class="difflineplus">+        {</span>
<a href="#l67.86"></a><span id="l67.86" class="difflineplus">+          nsCString messageId;</span>
<a href="#l67.87"></a><span id="l67.87" class="difflineplus">+          dstHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l67.88"></a><span id="l67.88" class="difflineplus">+          dstMessages-&gt;AppendElement(dstHdr, PR_FALSE);</span>
<a href="#l67.89"></a><span id="l67.89" class="difflineplus">+          m_copiedMsgIds.AppendElement(messageId);</span>
<a href="#l67.90"></a><span id="l67.90" class="difflineplus">+        }</span>
<a href="#l67.91"></a><span id="l67.91" class="difflineplus">+      }</span>
<a href="#l67.92"></a><span id="l67.92" class="difflineplus">+      srcFolder-&gt;AddFolderListener(this);</span>
<a href="#l67.93"></a><span id="l67.93" class="difflineplus">+      m_undoing = PR_TRUE;</span>
<a href="#l67.94"></a><span id="l67.94" class="difflineplus">+      return srcFolder-&gt;CopyMessages(dstFolder, dstMessages,</span>
<a href="#l67.95"></a><span id="l67.95" class="difflineplus">+                                     PR_TRUE, nsnull, nsnull, PR_FALSE,</span>
<a href="#l67.96"></a><span id="l67.96" class="difflineplus">+                                     PR_FALSE);</span>
<a href="#l67.97"></a><span id="l67.97" class="difflineplus">+    }</span>
<a href="#l67.98"></a><span id="l67.98">     srcDB-&gt;SetSummaryValid(PR_TRUE);</span>
<a href="#l67.99"></a><span id="l67.99">   }</span>
<a href="#l67.100"></a><span id="l67.100"> </span>
<a href="#l67.101"></a><span id="l67.101">   dstDB-&gt;DeleteMessages(m_dstKeyArray.Length(), m_dstKeyArray.Elements(), nsnull);</span>
<a href="#l67.102"></a><span id="l67.102">   dstDB-&gt;SetSummaryValid(PR_TRUE);</span>
<a href="#l67.103"></a><span id="l67.103"> </span>
<a href="#l67.104"></a><span id="l67.104">   return rv;</span>
<a href="#l67.105"></a><span id="l67.105"> }</span>
<a href="#l67.106"></a><span id="l67.106"> </span>
<a href="#l67.107"></a><span id="l67.107"> NS_IMETHODIMP</span>
<a href="#l67.108"></a><span id="l67.108"> nsLocalMoveCopyMsgTxn::RedoTransaction()</span>
<a href="#l67.109"></a><span id="l67.109"> {</span>
<a href="#l67.110"></a><span id="l67.110" class="difflineminus">-  nsresult rv = NS_ERROR_FAILURE;</span>
<a href="#l67.111"></a><span id="l67.111" class="difflineplus">+  nsresult rv;</span>
<a href="#l67.112"></a><span id="l67.112">   nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l67.113"></a><span id="l67.113">   nsCOMPtr&lt;nsIMsgDatabase&gt; dstDB;</span>
<a href="#l67.114"></a><span id="l67.114"> </span>
<a href="#l67.115"></a><span id="l67.115">   nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder = do_QueryReferent(m_srcFolder, &amp;rv);</span>
<a href="#l67.116"></a><span id="l67.116">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l67.117"></a><span id="l67.117"> </span>
<a href="#l67.118"></a><span id="l67.118">   nsCOMPtr&lt;nsIMsgFolder&gt; dstFolder = do_QueryReferent(m_dstFolder, &amp;rv);</span>
<a href="#l67.119"></a><span id="l67.119">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l67.120"></a><span id="l67.120" class="difflineat">@@ -355,58 +386,146 @@ nsLocalMoveCopyMsgTxn::RedoTransaction()</span>
<a href="#l67.121"></a><span id="l67.121">                                 getter_AddRefs(oldHdr));</span>
<a href="#l67.122"></a><span id="l67.122">     NS_ASSERTION(oldHdr, &quot;fatal ... cannot get old msg header\n&quot;);</span>
<a href="#l67.123"></a><span id="l67.123"> </span>
<a href="#l67.124"></a><span id="l67.124">     if (NS_SUCCEEDED(rv) &amp;&amp; oldHdr)</span>
<a href="#l67.125"></a><span id="l67.125">     {</span>
<a href="#l67.126"></a><span id="l67.126">       msgSupports =do_QueryInterface(oldHdr);</span>
<a href="#l67.127"></a><span id="l67.127">       srcMessages-&gt;AppendElement(msgSupports, PR_FALSE);</span>
<a href="#l67.128"></a><span id="l67.128">       </span>
<a href="#l67.129"></a><span id="l67.129" class="difflineplus">+      if (m_canUndelete)</span>
<a href="#l67.130"></a><span id="l67.130" class="difflineplus">+      {</span>
<a href="#l67.131"></a><span id="l67.131">       rv = dstDB-&gt;CopyHdrFromExistingHdr(m_dstKeyArray[i],</span>
<a href="#l67.132"></a><span id="l67.132">                                          oldHdr, PR_TRUE,</span>
<a href="#l67.133"></a><span id="l67.133">                                          getter_AddRefs(newHdr));</span>
<a href="#l67.134"></a><span id="l67.134">       NS_ASSERTION(newHdr, &quot;fatal ... cannot get new msg header\n&quot;);</span>
<a href="#l67.135"></a><span id="l67.135">       if (NS_SUCCEEDED(rv) &amp;&amp; newHdr)</span>
<a href="#l67.136"></a><span id="l67.136">       {</span>
<a href="#l67.137"></a><span id="l67.137">         if (i &lt; m_dstSizeArray.Length())</span>
<a href="#l67.138"></a><span id="l67.138">           rv = newHdr-&gt;SetMessageSize(m_dstSizeArray[i]);</span>
<a href="#l67.139"></a><span id="l67.139">         dstDB-&gt;UndoDelete(newHdr);</span>
<a href="#l67.140"></a><span id="l67.140">       }</span>
<a href="#l67.141"></a><span id="l67.141">     }</span>
<a href="#l67.142"></a><span id="l67.142">   }</span>
<a href="#l67.143"></a><span id="l67.143" class="difflineplus">+  }</span>
<a href="#l67.144"></a><span id="l67.144">   dstDB-&gt;SetSummaryValid(PR_TRUE);</span>
<a href="#l67.145"></a><span id="l67.145"> </span>
<a href="#l67.146"></a><span id="l67.146">   if (m_isMove)</span>
<a href="#l67.147"></a><span id="l67.147">   {</span>
<a href="#l67.148"></a><span id="l67.148">     if (m_srcIsImap4)</span>
<a href="#l67.149"></a><span id="l67.149">     {</span>
<a href="#l67.150"></a><span id="l67.150">       // protect against a bogus undo txn without any source keys</span>
<a href="#l67.151"></a><span id="l67.151">       // see bug #179856 for details</span>
<a href="#l67.152"></a><span id="l67.152">       NS_ASSERTION(!m_srcKeyArray.IsEmpty(), &quot;no source keys&quot;);</span>
<a href="#l67.153"></a><span id="l67.153">       if (m_srcKeyArray.IsEmpty())</span>
<a href="#l67.154"></a><span id="l67.154">         return NS_ERROR_UNEXPECTED;</span>
<a href="#l67.155"></a><span id="l67.155">     </span>
<a href="#l67.156"></a><span id="l67.156">       bool deleteFlag = false; //message is un-deleted- we are trying to redo</span>
<a href="#l67.157"></a><span id="l67.157">       CheckForToggleDelete(srcFolder, m_srcKeyArray[0], &amp;deleteFlag); // there could have been a toggle</span>
<a href="#l67.158"></a><span id="l67.158">       rv = UndoImapDeleteFlag(srcFolder, m_srcKeyArray, deleteFlag);</span>
<a href="#l67.159"></a><span id="l67.159">     }</span>
<a href="#l67.160"></a><span id="l67.160" class="difflineminus">-    else</span>
<a href="#l67.161"></a><span id="l67.161" class="difflineplus">+    else if (m_canUndelete)</span>
<a href="#l67.162"></a><span id="l67.162">     {</span>
<a href="#l67.163"></a><span id="l67.163">       nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(srcFolder);</span>
<a href="#l67.164"></a><span id="l67.164">       if (localFolder)</span>
<a href="#l67.165"></a><span id="l67.165">         localFolder-&gt;MarkMsgsOnPop3Server(srcMessages, POP3_DELETE /*deleteMsgs*/);</span>
<a href="#l67.166"></a><span id="l67.166"> </span>
<a href="#l67.167"></a><span id="l67.167">       rv = srcDB-&gt;DeleteMessages(m_srcKeyArray.Length(), m_srcKeyArray.Elements(), nsnull);</span>
<a href="#l67.168"></a><span id="l67.168">       srcDB-&gt;SetSummaryValid(PR_TRUE);</span>
<a href="#l67.169"></a><span id="l67.169">     }</span>
<a href="#l67.170"></a><span id="l67.170" class="difflineplus">+    else</span>
<a href="#l67.171"></a><span id="l67.171" class="difflineplus">+    {</span>
<a href="#l67.172"></a><span id="l67.172" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; srcHdr;</span>
<a href="#l67.173"></a><span id="l67.173" class="difflineplus">+      m_numHdrsCopied = 0;</span>
<a href="#l67.174"></a><span id="l67.174" class="difflineplus">+      m_dstKeyArray.Clear();</span>
<a href="#l67.175"></a><span id="l67.175" class="difflineplus">+      for (i = 0; i &lt; count; i++)</span>
<a href="#l67.176"></a><span id="l67.176" class="difflineplus">+      {</span>
<a href="#l67.177"></a><span id="l67.177" class="difflineplus">+        srcDB-&gt;GetMsgHdrForKey(m_srcKeyArray[i], getter_AddRefs(srcHdr));</span>
<a href="#l67.178"></a><span id="l67.178" class="difflineplus">+        NS_ASSERTION(srcHdr, &quot;fatal ... cannot get old msg header\n&quot;);</span>
<a href="#l67.179"></a><span id="l67.179" class="difflineplus">+        if (srcHdr)</span>
<a href="#l67.180"></a><span id="l67.180" class="difflineplus">+        {</span>
<a href="#l67.181"></a><span id="l67.181" class="difflineplus">+          nsCString messageId;</span>
<a href="#l67.182"></a><span id="l67.182" class="difflineplus">+          srcHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l67.183"></a><span id="l67.183" class="difflineplus">+          m_copiedMsgIds.AppendElement(messageId);</span>
<a href="#l67.184"></a><span id="l67.184" class="difflineplus">+        }</span>
<a href="#l67.185"></a><span id="l67.185" class="difflineplus">+      }</span>
<a href="#l67.186"></a><span id="l67.186" class="difflineplus">+      dstFolder-&gt;AddFolderListener(this);</span>
<a href="#l67.187"></a><span id="l67.187" class="difflineplus">+      m_undoing = PR_FALSE;</span>
<a href="#l67.188"></a><span id="l67.188" class="difflineplus">+      return dstFolder-&gt;CopyMessages(srcFolder, srcMessages, PR_TRUE, nsnull,</span>
<a href="#l67.189"></a><span id="l67.189" class="difflineplus">+                                     nsnull, PR_FALSE, PR_FALSE);</span>
<a href="#l67.190"></a><span id="l67.190" class="difflineplus">+    }</span>
<a href="#l67.191"></a><span id="l67.191">   }</span>
<a href="#l67.192"></a><span id="l67.192"> </span>
<a href="#l67.193"></a><span id="l67.193">   return rv;</span>
<a href="#l67.194"></a><span id="l67.194"> }</span>
<a href="#l67.195"></a><span id="l67.195"> </span>
<a href="#l67.196"></a><span id="l67.196" class="difflineplus">+NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemAdded(nsIMsgFolder *parentItem, nsISupports *item)</span>
<a href="#l67.197"></a><span id="l67.197" class="difflineplus">+{</span>
<a href="#l67.198"></a><span id="l67.198" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr(do_QueryInterface(item));</span>
<a href="#l67.199"></a><span id="l67.199" class="difflineplus">+  if (msgHdr)</span>
<a href="#l67.200"></a><span id="l67.200" class="difflineplus">+  {</span>
<a href="#l67.201"></a><span id="l67.201" class="difflineplus">+    nsresult rv;</span>
<a href="#l67.202"></a><span id="l67.202" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(m_undoing ? m_srcFolder :</span>
<a href="#l67.203"></a><span id="l67.203" class="difflineplus">+                                                     m_dstFolder, &amp;rv);</span>
<a href="#l67.204"></a><span id="l67.204" class="difflineplus">+    NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l67.205"></a><span id="l67.205" class="difflineplus">+    nsCString messageId;</span>
<a href="#l67.206"></a><span id="l67.206" class="difflineplus">+    msgHdr-&gt;GetMessageId(getter_Copies(messageId));</span>
<a href="#l67.207"></a><span id="l67.207" class="difflineplus">+    if (m_copiedMsgIds.IndexOf(messageId) != kNotFound)</span>
<a href="#l67.208"></a><span id="l67.208" class="difflineplus">+    {</span>
<a href="#l67.209"></a><span id="l67.209" class="difflineplus">+      nsMsgKey msgKey;</span>
<a href="#l67.210"></a><span id="l67.210" class="difflineplus">+      msgHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l67.211"></a><span id="l67.211" class="difflineplus">+      if (m_undoing)</span>
<a href="#l67.212"></a><span id="l67.212" class="difflineplus">+        m_srcKeyArray.AppendElement(msgKey);</span>
<a href="#l67.213"></a><span id="l67.213" class="difflineplus">+      else</span>
<a href="#l67.214"></a><span id="l67.214" class="difflineplus">+        m_dstKeyArray.AppendElement(msgKey);</span>
<a href="#l67.215"></a><span id="l67.215" class="difflineplus">+      if (++m_numHdrsCopied == m_copiedMsgIds.Length())</span>
<a href="#l67.216"></a><span id="l67.216" class="difflineplus">+      {</span>
<a href="#l67.217"></a><span id="l67.217" class="difflineplus">+        folder-&gt;RemoveFolderListener(this);</span>
<a href="#l67.218"></a><span id="l67.218" class="difflineplus">+        m_copiedMsgIds.Clear();</span>
<a href="#l67.219"></a><span id="l67.219" class="difflineplus">+      }</span>
<a href="#l67.220"></a><span id="l67.220" class="difflineplus">+    }</span>
<a href="#l67.221"></a><span id="l67.221" class="difflineplus">+  }</span>
<a href="#l67.222"></a><span id="l67.222" class="difflineplus">+  return NS_OK;</span>
<a href="#l67.223"></a><span id="l67.223" class="difflineplus">+}</span>
<a href="#l67.224"></a><span id="l67.224" class="difflineplus">+</span>
<a href="#l67.225"></a><span id="l67.225" class="difflineplus">+NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemRemoved(nsIMsgFolder *parentItem, nsISupports *item)</span>
<a href="#l67.226"></a><span id="l67.226" class="difflineplus">+{</span>
<a href="#l67.227"></a><span id="l67.227" class="difflineplus">+  return NS_OK;</span>
<a href="#l67.228"></a><span id="l67.228" class="difflineplus">+}</span>
<a href="#l67.229"></a><span id="l67.229" class="difflineplus">+</span>
<a href="#l67.230"></a><span id="l67.230" class="difflineplus">+NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemPropertyChanged(nsIMsgFolder *item, nsIAtom *property, const char *oldValue, const char *newValue)</span>
<a href="#l67.231"></a><span id="l67.231" class="difflineplus">+{</span>
<a href="#l67.232"></a><span id="l67.232" class="difflineplus">+  return NS_OK;</span>
<a href="#l67.233"></a><span id="l67.233" class="difflineplus">+}</span>
<a href="#l67.234"></a><span id="l67.234" class="difflineplus">+</span>
<a href="#l67.235"></a><span id="l67.235" class="difflineplus">+NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemIntPropertyChanged(nsIMsgFolder *item, nsIAtom *property, PRInt32 oldValue, PRInt32 newValue)</span>
<a href="#l67.236"></a><span id="l67.236" class="difflineplus">+{</span>
<a href="#l67.237"></a><span id="l67.237" class="difflineplus">+  return NS_OK;</span>
<a href="#l67.238"></a><span id="l67.238" class="difflineplus">+}</span>
<a href="#l67.239"></a><span id="l67.239" class="difflineplus">+</span>
<a href="#l67.240"></a><span id="l67.240" class="difflineplus">+NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemBoolPropertyChanged(nsIMsgFolder *item, nsIAtom *property, bool oldValue, bool newValue)</span>
<a href="#l67.241"></a><span id="l67.241" class="difflineplus">+{</span>
<a href="#l67.242"></a><span id="l67.242" class="difflineplus">+  return NS_OK;</span>
<a href="#l67.243"></a><span id="l67.243" class="difflineplus">+}</span>
<a href="#l67.244"></a><span id="l67.244" class="difflineplus">+</span>
<a href="#l67.245"></a><span id="l67.245" class="difflineplus">+NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemUnicharPropertyChanged(nsIMsgFolder *item, nsIAtom *property, const PRUnichar *oldValue, const PRUnichar *newValue)</span>
<a href="#l67.246"></a><span id="l67.246" class="difflineplus">+{</span>
<a href="#l67.247"></a><span id="l67.247" class="difflineplus">+  return NS_OK;</span>
<a href="#l67.248"></a><span id="l67.248" class="difflineplus">+}</span>
<a href="#l67.249"></a><span id="l67.249" class="difflineplus">+</span>
<a href="#l67.250"></a><span id="l67.250" class="difflineplus">+NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemPropertyFlagChanged(nsIMsgDBHdr *item, nsIAtom *property, PRUint32 oldFlag, PRUint32 newFlag)</span>
<a href="#l67.251"></a><span id="l67.251" class="difflineplus">+{</span>
<a href="#l67.252"></a><span id="l67.252" class="difflineplus">+  return NS_OK;</span>
<a href="#l67.253"></a><span id="l67.253" class="difflineplus">+}</span>
<a href="#l67.254"></a><span id="l67.254" class="difflineplus">+</span>
<a href="#l67.255"></a><span id="l67.255" class="difflineplus">+NS_IMETHODIMP nsLocalMoveCopyMsgTxn::OnItemEvent(nsIMsgFolder *aItem, nsIAtom *aEvent)</span>
<a href="#l67.256"></a><span id="l67.256" class="difflineplus">+{</span>
<a href="#l67.257"></a><span id="l67.257" class="difflineplus">+  return NS_OK;</span>
<a href="#l67.258"></a><span id="l67.258" class="difflineplus">+}</span>
<a href="#l67.259"></a><span id="l67.259" class="difflineplus">+</span>
<a href="#l67.260"></a><span id="l67.260"> NS_IMPL_ISUPPORTS1(nsLocalUndoFolderListener, nsIFolderListener)</span>
<a href="#l67.261"></a><span id="l67.261"> </span>
<a href="#l67.262"></a><span id="l67.262"> nsLocalUndoFolderListener::nsLocalUndoFolderListener(nsLocalMoveCopyMsgTxn *aTxn, nsIMsgFolder *aFolder)</span>
<a href="#l67.263"></a><span id="l67.263"> {</span>
<a href="#l67.264"></a><span id="l67.264">   mTxn = aTxn;</span>
<a href="#l67.265"></a><span id="l67.265">   mFolder = aFolder;</span>
<a href="#l67.266"></a><span id="l67.266"> }</span>
<a href="#l67.267"></a><span id="l67.267"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l68.1"></a><span id="l68.1" class="difflineminus">--- a/mailnews/local/src/nsLocalUndoTxn.h</span>
<a href="#l68.2"></a><span id="l68.2" class="difflineplus">+++ b/mailnews/local/src/nsLocalUndoTxn.h</span>
<a href="#l68.3"></a><span id="l68.3" class="difflineat">@@ -46,51 +46,62 @@</span>
<a href="#l68.4"></a><span id="l68.4"> #include &quot;nsTArray.h&quot;</span>
<a href="#l68.5"></a><span id="l68.5"> #include &quot;nsCOMPtr.h&quot;</span>
<a href="#l68.6"></a><span id="l68.6"> #include &quot;nsIUrlListener.h&quot;</span>
<a href="#l68.7"></a><span id="l68.7"> #include &quot;nsIWeakReference.h&quot;</span>
<a href="#l68.8"></a><span id="l68.8"> #include &quot;nsIWeakReferenceUtils.h&quot;</span>
<a href="#l68.9"></a><span id="l68.9"> </span>
<a href="#l68.10"></a><span id="l68.10"> class nsLocalUndoFolderListener;</span>
<a href="#l68.11"></a><span id="l68.11"> </span>
<a href="#l68.12"></a><span id="l68.12" class="difflineminus">-class nsLocalMoveCopyMsgTxn : public nsMsgTxn</span>
<a href="#l68.13"></a><span id="l68.13" class="difflineplus">+class nsLocalMoveCopyMsgTxn : public nsIFolderListener, public nsMsgTxn</span>
<a href="#l68.14"></a><span id="l68.14"> {</span>
<a href="#l68.15"></a><span id="l68.15"> public:</span>
<a href="#l68.16"></a><span id="l68.16">     nsLocalMoveCopyMsgTxn();</span>
<a href="#l68.17"></a><span id="l68.17">     virtual ~nsLocalMoveCopyMsgTxn();</span>
<a href="#l68.18"></a><span id="l68.18" class="difflineplus">+    NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l68.19"></a><span id="l68.19" class="difflineplus">+    NS_DECL_NSIFOLDERLISTENER</span>
<a href="#l68.20"></a><span id="l68.20"> </span>
<a href="#l68.21"></a><span id="l68.21">     // overloading nsITransaction methods</span>
<a href="#l68.22"></a><span id="l68.22">     NS_IMETHOD UndoTransaction(void);</span>
<a href="#l68.23"></a><span id="l68.23">     NS_IMETHOD RedoTransaction(void);</span>
<a href="#l68.24"></a><span id="l68.24"> </span>
<a href="#l68.25"></a><span id="l68.25">     // helper</span>
<a href="#l68.26"></a><span id="l68.26">     nsresult AddSrcKey(nsMsgKey aKey);</span>
<a href="#l68.27"></a><span id="l68.27">     nsresult AddSrcStatusOffset(PRUint32 statusOffset);</span>
<a href="#l68.28"></a><span id="l68.28">     nsresult AddDstKey(nsMsgKey aKey);</span>
<a href="#l68.29"></a><span id="l68.29">     nsresult AddDstMsgSize(PRUint32 msgSize);</span>
<a href="#l68.30"></a><span id="l68.30">     nsresult SetSrcFolder(nsIMsgFolder* srcFolder);</span>
<a href="#l68.31"></a><span id="l68.31">     nsresult GetSrcIsImap(bool *isImap);</span>
<a href="#l68.32"></a><span id="l68.32">     nsresult SetDstFolder(nsIMsgFolder* dstFolder);</span>
<a href="#l68.33"></a><span id="l68.33">     nsresult Init(nsIMsgFolder* srcFolder,</span>
<a href="#l68.34"></a><span id="l68.34" class="difflineminus">-          nsIMsgFolder* dstFolder,</span>
<a href="#l68.35"></a><span id="l68.35" class="difflineminus">-          bool isMove);</span>
<a href="#l68.36"></a><span id="l68.36" class="difflineplus">+                  nsIMsgFolder* dstFolder, bool isMove);</span>
<a href="#l68.37"></a><span id="l68.37">     nsresult UndoImapDeleteFlag(nsIMsgFolder* aFolder,</span>
<a href="#l68.38"></a><span id="l68.38">                                 nsTArray&lt;nsMsgKey&gt;&amp; aKeyArray,</span>
<a href="#l68.39"></a><span id="l68.39">                                 bool deleteFlag);</span>
<a href="#l68.40"></a><span id="l68.40">     nsresult UndoTransactionInternal();</span>
<a href="#l68.41"></a><span id="l68.41" class="difflineplus">+    // If the store using this undo transaction can &quot;undelete&quot; a message,</span>
<a href="#l68.42"></a><span id="l68.42" class="difflineplus">+    // it will call this function on the transaction; This makes undo/redo</span>
<a href="#l68.43"></a><span id="l68.43" class="difflineplus">+    // easy because message keys don't change after undo/redo. Otherwise,</span>
<a href="#l68.44"></a><span id="l68.44" class="difflineplus">+    // we need to adjust the src or dst keys after every undo/redo action</span>
<a href="#l68.45"></a><span id="l68.45" class="difflineplus">+    // to note the new keys.</span>
<a href="#l68.46"></a><span id="l68.46" class="difflineplus">+    void SetCanUndelete(bool canUndelete) {m_canUndelete = canUndelete;}</span>
<a href="#l68.47"></a><span id="l68.47"> </span>
<a href="#l68.48"></a><span id="l68.48"> private:</span>
<a href="#l68.49"></a><span id="l68.49">     nsWeakPtr m_srcFolder;</span>
<a href="#l68.50"></a><span id="l68.50">     nsTArray&lt;nsMsgKey&gt; m_srcKeyArray; // used when src is local or imap</span>
<a href="#l68.51"></a><span id="l68.51">     nsTArray&lt;PRUint32&gt; m_srcStatusOffsetArray; // used when src is local</span>
<a href="#l68.52"></a><span id="l68.52">     nsWeakPtr m_dstFolder;</span>
<a href="#l68.53"></a><span id="l68.53">     nsTArray&lt;nsMsgKey&gt; m_dstKeyArray;</span>
<a href="#l68.54"></a><span id="l68.54">     bool m_isMove;</span>
<a href="#l68.55"></a><span id="l68.55">     bool m_srcIsImap4;</span>
<a href="#l68.56"></a><span id="l68.56" class="difflineplus">+    bool m_canUndelete;</span>
<a href="#l68.57"></a><span id="l68.57">     nsTArray&lt;PRUint32&gt; m_dstSizeArray;</span>
<a href="#l68.58"></a><span id="l68.58" class="difflineplus">+    bool m_undoing; // if false, re-doing</span>
<a href="#l68.59"></a><span id="l68.59" class="difflineplus">+    PRInt32 m_numHdrsCopied;</span>
<a href="#l68.60"></a><span id="l68.60" class="difflineplus">+    nsTArray&lt;nsCString&gt; m_copiedMsgIds;</span>
<a href="#l68.61"></a><span id="l68.61">     nsLocalUndoFolderListener *mUndoFolderListener;</span>
<a href="#l68.62"></a><span id="l68.62"> };</span>
<a href="#l68.63"></a><span id="l68.63"> </span>
<a href="#l68.64"></a><span id="l68.64"> class nsLocalUndoFolderListener : public nsIFolderListener</span>
<a href="#l68.65"></a><span id="l68.65"> {</span>
<a href="#l68.66"></a><span id="l68.66"> public:</span>
<a href="#l68.67"></a><span id="l68.67">   NS_DECL_ISUPPORTS</span>
<a href="#l68.68"></a><span id="l68.68">   NS_DECL_NSIFOLDERLISTENER</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l69.1"></a><span id="l69.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxProtocol.cpp</span>
<a href="#l69.2"></a><span id="l69.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxProtocol.cpp</span>
<a href="#l69.3"></a><span id="l69.3" class="difflineat">@@ -63,16 +63,18 @@ PRLogModuleInfo *MAILBOX;</span>
<a href="#l69.4"></a><span id="l69.4"> #include &quot;nsIFileStreams.h&quot;</span>
<a href="#l69.5"></a><span id="l69.5"> #include &quot;nsIStreamTransportService.h&quot;</span>
<a href="#l69.6"></a><span id="l69.6"> #include &quot;nsIStreamConverterService.h&quot;</span>
<a href="#l69.7"></a><span id="l69.7"> #include &quot;nsIIOService.h&quot;</span>
<a href="#l69.8"></a><span id="l69.8"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l69.9"></a><span id="l69.9"> #include &quot;nsMsgUtils.h&quot;</span>
<a href="#l69.10"></a><span id="l69.10"> #include &quot;nsIMsgWindow.h&quot;</span>
<a href="#l69.11"></a><span id="l69.11"> #include &quot;nsIMimeHeaders.h&quot;</span>
<a href="#l69.12"></a><span id="l69.12" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l69.13"></a><span id="l69.13" class="difflineplus">+#include &quot;nsISeekableStream.h&quot;</span>
<a href="#l69.14"></a><span id="l69.14"> </span>
<a href="#l69.15"></a><span id="l69.15"> #include &quot;nsIMsgMdnGenerator.h&quot;</span>
<a href="#l69.16"></a><span id="l69.16"> </span>
<a href="#l69.17"></a><span id="l69.17"> /* the output_buffer_size must be larger than the largest possible line</span>
<a href="#l69.18"></a><span id="l69.18">  * 2000 seems good for news</span>
<a href="#l69.19"></a><span id="l69.19">  *</span>
<a href="#l69.20"></a><span id="l69.20">  * jwz: I increased this to 4k since it must be big enough to hold the</span>
<a href="#l69.21"></a><span id="l69.21">  * entire button-bar HTML, and with the new &quot;mailto&quot; format, that can</span>
<a href="#l69.22"></a><span id="l69.22" class="difflineat">@@ -191,17 +193,62 @@ nsresult nsMailboxProtocol::Initialize(n</span>
<a href="#l69.23"></a><span id="l69.23">         if (RunningMultipleMsgUrl())</span>
<a href="#l69.24"></a><span id="l69.24">         {</span>
<a href="#l69.25"></a><span id="l69.25">           rv = OpenFileSocketForReuse(aURL, (PRUint32) aMsgKey, aMsgSize);</span>
<a href="#l69.26"></a><span id="l69.26">           // if we're running multiple msg url, we clear the event sink because the multiple</span>
<a href="#l69.27"></a><span id="l69.27">           // msg urls will handle setting the progress.</span>
<a href="#l69.28"></a><span id="l69.28">           mProgressEventSink = nsnull;</span>
<a href="#l69.29"></a><span id="l69.29">         }</span>
<a href="#l69.30"></a><span id="l69.30">         else</span>
<a href="#l69.31"></a><span id="l69.31" class="difflineplus">+        {</span>
<a href="#l69.32"></a><span id="l69.32" class="difflineplus">+          nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l69.33"></a><span id="l69.33" class="difflineplus">+          nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l69.34"></a><span id="l69.34" class="difflineplus">+          nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l69.35"></a><span id="l69.35" class="difflineplus">+          nsCOMPtr&lt;nsIMsgMessageUrl&gt; msgUrl = do_QueryInterface(m_runningUrl, &amp;rv);</span>
<a href="#l69.36"></a><span id="l69.36" class="difflineplus">+          NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l69.37"></a><span id="l69.37" class="difflineplus">+          rv = msgUrl-&gt;GetMessageHeader(getter_AddRefs(msgHdr));</span>
<a href="#l69.38"></a><span id="l69.38" class="difflineplus">+          if (msgHdr)</span>
<a href="#l69.39"></a><span id="l69.39" class="difflineplus">+          {</span>
<a href="#l69.40"></a><span id="l69.40" class="difflineplus">+            msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l69.41"></a><span id="l69.41" class="difflineplus">+            if (folder)</span>
<a href="#l69.42"></a><span id="l69.42" class="difflineplus">+              folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l69.43"></a><span id="l69.43" class="difflineplus">+          }</span>
<a href="#l69.44"></a><span id="l69.44" class="difflineplus">+          if (server)</span>
<a href="#l69.45"></a><span id="l69.45" class="difflineplus">+          {</span>
<a href="#l69.46"></a><span id="l69.46" class="difflineplus">+            nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l69.47"></a><span id="l69.47" class="difflineplus">+            rv = server-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l69.48"></a><span id="l69.48" class="difflineplus">+            NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.49"></a><span id="l69.49" class="difflineplus">+</span>
<a href="#l69.50"></a><span id="l69.50" class="difflineplus">+            if (NS_SUCCEEDED(rv) &amp;&amp; msgHdr)</span>
<a href="#l69.51"></a><span id="l69.51" class="difflineplus">+            {</span>
<a href="#l69.52"></a><span id="l69.52" class="difflineplus">+              nsCOMPtr&lt;nsIInputStream&gt; stream;</span>
<a href="#l69.53"></a><span id="l69.53" class="difflineplus">+              PRInt64 offset = 0;</span>
<a href="#l69.54"></a><span id="l69.54" class="difflineplus">+              bool reusable = false;</span>
<a href="#l69.55"></a><span id="l69.55" class="difflineplus">+</span>
<a href="#l69.56"></a><span id="l69.56" class="difflineplus">+              rv = folder-&gt;GetMsgInputStream(msgHdr, &amp;reusable, getter_AddRefs(stream));</span>
<a href="#l69.57"></a><span id="l69.57" class="difflineplus">+              NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.58"></a><span id="l69.58" class="difflineplus">+              nsCOMPtr&lt;nsISeekableStream&gt; seekableStream(do_QueryInterface(stream, &amp;rv));</span>
<a href="#l69.59"></a><span id="l69.59" class="difflineplus">+              NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l69.60"></a><span id="l69.60" class="difflineplus">+              seekableStream-&gt;Tell(&amp;offset);</span>
<a href="#l69.61"></a><span id="l69.61" class="difflineplus">+              // create input stream transport</span>
<a href="#l69.62"></a><span id="l69.62" class="difflineplus">+              nsCOMPtr&lt;nsIStreamTransportService&gt; sts =</span>
<a href="#l69.63"></a><span id="l69.63" class="difflineplus">+                  do_GetService(NS_STREAMTRANSPORTSERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l69.64"></a><span id="l69.64" class="difflineplus">+              if (NS_FAILED(rv)) return rv;</span>
<a href="#l69.65"></a><span id="l69.65" class="difflineplus">+              m_readCount = aMsgSize;</span>
<a href="#l69.66"></a><span id="l69.66" class="difflineplus">+              rv = sts-&gt;CreateInputTransport(stream, offset,</span>
<a href="#l69.67"></a><span id="l69.67" class="difflineplus">+                                             PRInt64(aMsgSize), PR_TRUE,</span>
<a href="#l69.68"></a><span id="l69.68" class="difflineplus">+                                             getter_AddRefs(m_transport));</span>
<a href="#l69.69"></a><span id="l69.69" class="difflineplus">+</span>
<a href="#l69.70"></a><span id="l69.70" class="difflineplus">+              m_socketIsOpen = PR_FALSE;</span>
<a href="#l69.71"></a><span id="l69.71" class="difflineplus">+             </span>
<a href="#l69.72"></a><span id="l69.72" class="difflineplus">+            }</span>
<a href="#l69.73"></a><span id="l69.73" class="difflineplus">+          }</span>
<a href="#l69.74"></a><span id="l69.74" class="difflineplus">+          else // must be a .eml file</span>
<a href="#l69.75"></a><span id="l69.75">           rv = OpenFileSocket(aURL, (PRUint32) aMsgKey, aMsgSize);</span>
<a href="#l69.76"></a><span id="l69.76" class="difflineplus">+        }</span>
<a href="#l69.77"></a><span id="l69.77">         NS_ASSERTION(NS_SUCCEEDED(rv), &quot;oops....i messed something up&quot;);</span>
<a href="#l69.78"></a><span id="l69.78">       }</span>
<a href="#l69.79"></a><span id="l69.79">     }</span>
<a href="#l69.80"></a><span id="l69.80">   }</span>
<a href="#l69.81"></a><span id="l69.81">   </span>
<a href="#l69.82"></a><span id="l69.82">   m_lineStreamBuffer = new nsMsgLineStreamBuffer(OUTPUT_BUFFER_SIZE, PR_TRUE);</span>
<a href="#l69.83"></a><span id="l69.83">   </span>
<a href="#l69.84"></a><span id="l69.84">   m_nextState = MAILBOX_READ_FOLDER;</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l70.1"></a><span id="l70.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxService.cpp</span>
<a href="#l70.2"></a><span id="l70.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxService.cpp</span>
<a href="#l70.3"></a><span id="l70.3" class="difflineat">@@ -343,17 +343,17 @@ NS_IMETHODIMP nsMailboxService::StreamHe</span>
<a href="#l70.4"></a><span id="l70.4">   nsCAutoString folderURI;</span>
<a href="#l70.5"></a><span id="l70.5">   nsMsgKey msgKey;</span>
<a href="#l70.6"></a><span id="l70.6">   nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l70.7"></a><span id="l70.7">   nsresult rv = DecomposeMailboxURI(aMessageURI, getter_AddRefs(folder), &amp;msgKey);</span>
<a href="#l70.8"></a><span id="l70.8">   if (msgKey == nsMsgKey_None)</span>
<a href="#l70.9"></a><span id="l70.9">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l70.10"></a><span id="l70.10"> </span>
<a href="#l70.11"></a><span id="l70.11">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l70.12"></a><span id="l70.12" class="difflineminus">-  PRUint64 messageOffset;</span>
<a href="#l70.13"></a><span id="l70.13" class="difflineplus">+  PRInt64 messageOffset;</span>
<a href="#l70.14"></a><span id="l70.14">   PRUint32 messageSize;</span>
<a href="#l70.15"></a><span id="l70.15">   rv = folder-&gt;GetOfflineFileStream(msgKey, &amp;messageOffset, &amp;messageSize, getter_AddRefs(inputStream));</span>
<a href="#l70.16"></a><span id="l70.16">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l70.17"></a><span id="l70.17">   return MsgStreamMsgHeaders(inputStream, aConsumer);</span>
<a href="#l70.18"></a><span id="l70.18"> }</span>
<a href="#l70.19"></a><span id="l70.19"> </span>
<a href="#l70.20"></a><span id="l70.20"> </span>
<a href="#l70.21"></a><span id="l70.21"> NS_IMETHODIMP nsMailboxService::IsMsgInMemCache(nsIURI *aUrl,</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l71.1"></a><span id="l71.1" class="difflineminus">--- a/mailnews/local/src/nsMailboxUrl.cpp</span>
<a href="#l71.2"></a><span id="l71.2" class="difflineplus">+++ b/mailnews/local/src/nsMailboxUrl.cpp</span>
<a href="#l71.3"></a><span id="l71.3" class="difflineat">@@ -216,17 +216,18 @@ nsresult nsMailboxUrl::GetMsgHdrForKey(n</span>
<a href="#l71.4"></a><span id="l71.4">   nsresult rv = NS_OK;</span>
<a href="#l71.5"></a><span id="l71.5">   if (aMsgHdr &amp;&amp; m_filePath)</span>
<a href="#l71.6"></a><span id="l71.6">   {</span>
<a href="#l71.7"></a><span id="l71.7">     nsCOMPtr&lt;nsIMsgDatabase&gt; mailDBFactory;</span>
<a href="#l71.8"></a><span id="l71.8">     nsCOMPtr&lt;nsIMsgDatabase&gt; mailDB;</span>
<a href="#l71.9"></a><span id="l71.9">     nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l71.10"></a><span id="l71.10"> </span>
<a href="#l71.11"></a><span id="l71.11">     if (msgDBService)</span>
<a href="#l71.12"></a><span id="l71.12" class="difflineminus">-      rv = msgDBService-&gt;OpenMailDBFromFile(m_filePath, PR_FALSE, PR_FALSE, (nsIMsgDatabase **) getter_AddRefs(mailDB));</span>
<a href="#l71.13"></a><span id="l71.13" class="difflineplus">+      rv = msgDBService-&gt;OpenMailDBFromFile(m_filePath, nsnull, PR_FALSE,</span>
<a href="#l71.14"></a><span id="l71.14" class="difflineplus">+                                            PR_FALSE, getter_AddRefs(mailDB));</span>
<a href="#l71.15"></a><span id="l71.15">     if (NS_SUCCEEDED(rv) &amp;&amp; mailDB) // did we get a db back?</span>
<a href="#l71.16"></a><span id="l71.16">       rv = mailDB-&gt;GetMsgHdrForKey(msgKey, aMsgHdr);</span>
<a href="#l71.17"></a><span id="l71.17">     else</span>
<a href="#l71.18"></a><span id="l71.18">     {</span>
<a href="#l71.19"></a><span id="l71.19">       nsCOMPtr&lt;nsIMsgWindow&gt; msgWindow(do_QueryReferent(m_msgWindowWeak));</span>
<a href="#l71.20"></a><span id="l71.20">       if (!msgWindow)</span>
<a href="#l71.21"></a><span id="l71.21">       {</span>
<a href="#l71.22"></a><span id="l71.22">         nsCOMPtr&lt;nsIMsgMailSession&gt; mailSession = do_GetService(NS_MSGMAILSESSION_CONTRACTID, &amp;rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l72.1"></a><span id="l72.1" class="difflineminus">--- a/mailnews/local/src/nsMovemailService.cpp</span>
<a href="#l72.2"></a><span id="l72.2" class="difflineplus">+++ b/mailnews/local/src/nsMovemailService.cpp</span>
<a href="#l72.3"></a><span id="l72.3" class="difflineat">@@ -68,16 +68,17 @@</span>
<a href="#l72.4"></a><span id="l72.4"> #include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l72.5"></a><span id="l72.5"> </span>
<a href="#l72.6"></a><span id="l72.6"> #include &quot;nsILineInputStream.h&quot;</span>
<a href="#l72.7"></a><span id="l72.7"> #include &quot;nsISeekableStream.h&quot;</span>
<a href="#l72.8"></a><span id="l72.8"> #include &quot;nsNetUtil.h&quot;</span>
<a href="#l72.9"></a><span id="l72.9"> #include &quot;nsAutoPtr.h&quot;</span>
<a href="#l72.10"></a><span id="l72.10"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l72.11"></a><span id="l72.11"> #include &quot;nsLocalStrings.h&quot;</span>
<a href="#l72.12"></a><span id="l72.12" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l72.13"></a><span id="l72.13"> </span>
<a href="#l72.14"></a><span id="l72.14"> #include &quot;prlog.h&quot;</span>
<a href="#l72.15"></a><span id="l72.15"> #if defined(PR_LOGGING)</span>
<a href="#l72.16"></a><span id="l72.16"> //</span>
<a href="#l72.17"></a><span id="l72.17"> // export NSPR_LOG_MODULES=Movemail:5</span>
<a href="#l72.18"></a><span id="l72.18"> //</span>
<a href="#l72.19"></a><span id="l72.19"> static PRLogModuleInfo *gMovemailLog = nsnull;</span>
<a href="#l72.20"></a><span id="l72.20"> #define LOG(args) PR_LOG(gMovemailLog, PR_LOG_DEBUG, args)</span>
<a href="#l72.21"></a><span id="l72.21" class="difflineat">@@ -413,47 +414,46 @@ nsMovemailService::GetNewMail(nsIMsgWind</span>
<a href="#l72.22"></a><span id="l72.22">   }</span>
<a href="#l72.23"></a><span id="l72.23"> </span>
<a href="#l72.24"></a><span id="l72.24">   // Get a line input interface for the spool file</span>
<a href="#l72.25"></a><span id="l72.25">   nsCOMPtr&lt;nsILineInputStream&gt; lineInputStream =</span>
<a href="#l72.26"></a><span id="l72.26">     do_QueryInterface(spoolInputStream, &amp;rv);</span>
<a href="#l72.27"></a><span id="l72.27">   if (!lineInputStream)</span>
<a href="#l72.28"></a><span id="l72.28">     return rv;</span>
<a href="#l72.29"></a><span id="l72.29"> </span>
<a href="#l72.30"></a><span id="l72.30" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; mailDirectory;</span>
<a href="#l72.31"></a><span id="l72.31" class="difflineminus">-  rv = in_server-&gt;GetLocalPath(getter_AddRefs(mailDirectory));</span>
<a href="#l72.32"></a><span id="l72.32" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l72.33"></a><span id="l72.33" class="difflineminus">-  mailDirectory-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Inbox&quot;));</span>
<a href="#l72.34"></a><span id="l72.34" class="difflineminus">-</span>
<a href="#l72.35"></a><span id="l72.35" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l72.36"></a><span id="l72.36" class="difflineminus">-  rv = MsgGetFileStream(mailDirectory, getter_AddRefs(outputStream));</span>
<a href="#l72.37"></a><span id="l72.37" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l72.38"></a><span id="l72.38" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; inputStream = do_QueryInterface(outputStream);</span>
<a href="#l72.39"></a><span id="l72.39" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(outputStream);</span>
<a href="#l72.40"></a><span id="l72.40" class="difflineminus">-  seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l72.41"></a><span id="l72.41">   nsCOMPtr&lt;nsIMsgFolder&gt; serverFolder;</span>
<a href="#l72.42"></a><span id="l72.42">   nsCOMPtr&lt;nsIMsgFolder&gt; inbox;</span>
<a href="#l72.43"></a><span id="l72.43">   nsCOMPtr&lt;nsIMsgFolder&gt; rootMsgFolder;</span>
<a href="#l72.44"></a><span id="l72.44"> </span>
<a href="#l72.45"></a><span id="l72.45" class="difflineminus">-  // create a new mail parser</span>
<a href="#l72.46"></a><span id="l72.46" class="difflineminus">-  nsRefPtr&lt;nsParseNewMailState&gt; newMailParser = new nsParseNewMailState;</span>
<a href="#l72.47"></a><span id="l72.47" class="difflineminus">-  if (newMailParser == nsnull)</span>
<a href="#l72.48"></a><span id="l72.48" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l72.49"></a><span id="l72.49" class="difflineminus">-</span>
<a href="#l72.50"></a><span id="l72.50">   rv = in_server-&gt;GetRootFolder(getter_AddRefs(serverFolder));</span>
<a href="#l72.51"></a><span id="l72.51">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l72.52"></a><span id="l72.52"> </span>
<a href="#l72.53"></a><span id="l72.53">   rootMsgFolder = do_QueryInterface(serverFolder, &amp;rv);</span>
<a href="#l72.54"></a><span id="l72.54">   if (!rootMsgFolder)</span>
<a href="#l72.55"></a><span id="l72.55">     return rv;</span>
<a href="#l72.56"></a><span id="l72.56">   rv = rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox,</span>
<a href="#l72.57"></a><span id="l72.57">                                          getter_AddRefs(inbox));</span>
<a href="#l72.58"></a><span id="l72.58" class="difflineplus">+</span>
<a href="#l72.59"></a><span id="l72.59">   NS_ENSURE_TRUE(inbox, NS_ERROR_FAILURE);</span>
<a href="#l72.60"></a><span id="l72.60" class="difflineplus">+  nsCOMPtr &lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l72.61"></a><span id="l72.61" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l72.62"></a><span id="l72.62" class="difflineplus">+  rv = in_server-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l72.63"></a><span id="l72.63" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l72.64"></a><span id="l72.64" class="difflineplus">+  bool reusable;</span>
<a href="#l72.65"></a><span id="l72.65" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l72.66"></a><span id="l72.66" class="difflineplus">+  msgStore-&gt;GetNewMsgOutputStream(inbox, getter_AddRefs(newHdr),</span>
<a href="#l72.67"></a><span id="l72.67" class="difflineplus">+                                  &amp;reusable, getter_AddRefs(outputStream));</span>
<a href="#l72.68"></a><span id="l72.68" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l72.69"></a><span id="l72.69" class="difflineplus">+  nsCOMPtr &lt;nsIInputStream&gt; inputStream = do_QueryInterface(outputStream);</span>
<a href="#l72.70"></a><span id="l72.70" class="difflineplus">+  // create a new mail parser</span>
<a href="#l72.71"></a><span id="l72.71" class="difflineplus">+  nsRefPtr&lt;nsParseNewMailState&gt; newMailParser = new nsParseNewMailState;</span>
<a href="#l72.72"></a><span id="l72.72" class="difflineplus">+  NS_ENSURE_TRUE(newMailParser, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l72.73"></a><span id="l72.73" class="difflineplus">+</span>
<a href="#l72.74"></a><span id="l72.74">   rv = newMailParser-&gt;Init(serverFolder, inbox,</span>
<a href="#l72.75"></a><span id="l72.75" class="difflineminus">-                           inputStream, nsnull);</span>
<a href="#l72.76"></a><span id="l72.76" class="difflineplus">+                           nsnull, newHdr, outputStream);</span>
<a href="#l72.77"></a><span id="l72.77">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l72.78"></a><span id="l72.78"> </span>
<a href="#l72.79"></a><span id="l72.79">   in_server-&gt;SetServerBusy(PR_TRUE);</span>
<a href="#l72.80"></a><span id="l72.80"> </span>
<a href="#l72.81"></a><span id="l72.81">   // Try and obtain the lock for the spool file</span>
<a href="#l72.82"></a><span id="l72.82">   bool usingLockFile;</span>
<a href="#l72.83"></a><span id="l72.83">   if (!ObtainSpoolLock(spoolPath.get(), 5, &amp;usingLockFile)) {</span>
<a href="#l72.84"></a><span id="l72.84">     nsAutoString lockFile = NS_ConvertUTF8toUTF16(spoolPath);</span>
<a href="#l72.85"></a><span id="l72.85" class="difflineat">@@ -493,17 +493,17 @@ nsMovemailService::GetNewMail(nsIMsgWind</span>
<a href="#l72.86"></a><span id="l72.86">       buffer.AssignLiteral(&quot;X-Mozilla-Status2: 00000000&quot; MSG_LINEBREAK);</span>
<a href="#l72.87"></a><span id="l72.87">       newMailParser-&gt;HandleLine(buffer.BeginWriting(), buffer.Length());</span>
<a href="#l72.88"></a><span id="l72.88">       outputStream-&gt;Write(buffer.get(), buffer.Length(), &amp;bytesWritten);</span>
<a href="#l72.89"></a><span id="l72.89">     }</span>
<a href="#l72.90"></a><span id="l72.90">   }</span>
<a href="#l72.91"></a><span id="l72.91"> </span>
<a href="#l72.92"></a><span id="l72.92">   outputStream-&gt;Flush();</span>
<a href="#l72.93"></a><span id="l72.93">   newMailParser-&gt;OnStopRequest(nsnull, nsnull, NS_OK);</span>
<a href="#l72.94"></a><span id="l72.94" class="difflineminus">-  newMailParser-&gt;SetDBFolderStream(nsnull); // stream is going away</span>
<a href="#l72.95"></a><span id="l72.95" class="difflineplus">+  msgStore-&gt;FinishNewMessage(outputStream, newHdr);</span>
<a href="#l72.96"></a><span id="l72.96">   outputStream-&gt;Close();</span>
<a href="#l72.97"></a><span id="l72.97"> </span>
<a href="#l72.98"></a><span id="l72.98">   // Truncate the spool file</span>
<a href="#l72.99"></a><span id="l72.99">   rv = spoolFile-&gt;SetFileSize(0);</span>
<a href="#l72.100"></a><span id="l72.100">   if (NS_FAILED(rv)) {</span>
<a href="#l72.101"></a><span id="l72.101">     const PRUnichar *params[] = {</span>
<a href="#l72.102"></a><span id="l72.102">       NS_ConvertUTF8toUTF16(spoolPath).get()</span>
<a href="#l72.103"></a><span id="l72.103">     };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l73.1"></a><span id="l73.1">new file mode 100644</span>
<a href="#l73.2"></a><span id="l73.2" class="difflineminus">--- /dev/null</span>
<a href="#l73.3"></a><span id="l73.3" class="difflineplus">+++ b/mailnews/local/src/nsMsgBrkMBoxStore.cpp</span>
<a href="#l73.4"></a><span id="l73.4" class="difflineat">@@ -0,0 +1,1176 @@</span>
<a href="#l73.5"></a><span id="l73.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l73.6"></a><span id="l73.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l73.7"></a><span id="l73.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l73.8"></a><span id="l73.8" class="difflineplus">+ *</span>
<a href="#l73.9"></a><span id="l73.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l73.10"></a><span id="l73.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l73.11"></a><span id="l73.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l73.12"></a><span id="l73.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l73.13"></a><span id="l73.13" class="difflineplus">+ *</span>
<a href="#l73.14"></a><span id="l73.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l73.15"></a><span id="l73.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l73.16"></a><span id="l73.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l73.17"></a><span id="l73.17" class="difflineplus">+ * License.</span>
<a href="#l73.18"></a><span id="l73.18" class="difflineplus">+ *</span>
<a href="#l73.19"></a><span id="l73.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l73.20"></a><span id="l73.20" class="difflineplus">+ *</span>
<a href="#l73.21"></a><span id="l73.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l73.22"></a><span id="l73.22" class="difflineplus">+ * Mozilla Foundation.</span>
<a href="#l73.23"></a><span id="l73.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l73.24"></a><span id="l73.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l73.25"></a><span id="l73.25" class="difflineplus">+ *</span>
<a href="#l73.26"></a><span id="l73.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l73.27"></a><span id="l73.27" class="difflineplus">+ *  David Bienvenu &lt;dbienvenu@mozilla.com&gt;</span>
<a href="#l73.28"></a><span id="l73.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l73.29"></a><span id="l73.29" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l73.30"></a><span id="l73.30" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l73.31"></a><span id="l73.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l73.32"></a><span id="l73.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l73.33"></a><span id="l73.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l73.34"></a><span id="l73.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l73.35"></a><span id="l73.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l73.36"></a><span id="l73.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l73.37"></a><span id="l73.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l73.38"></a><span id="l73.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l73.39"></a><span id="l73.39" class="difflineplus">+ *</span>
<a href="#l73.40"></a><span id="l73.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l73.41"></a><span id="l73.41" class="difflineplus">+</span>
<a href="#l73.42"></a><span id="l73.42" class="difflineplus">+/**</span>
<a href="#l73.43"></a><span id="l73.43" class="difflineplus">+   Class for handling Berkeley Mailbox stores.</span>
<a href="#l73.44"></a><span id="l73.44" class="difflineplus">+*/</span>
<a href="#l73.45"></a><span id="l73.45" class="difflineplus">+</span>
<a href="#l73.46"></a><span id="l73.46" class="difflineplus">+#include &quot;prlog.h&quot;</span>
<a href="#l73.47"></a><span id="l73.47" class="difflineplus">+#include &quot;msgCore.h&quot;</span>
<a href="#l73.48"></a><span id="l73.48" class="difflineplus">+#include &quot;nsMsgBrkMBoxStore.h&quot;</span>
<a href="#l73.49"></a><span id="l73.49" class="difflineplus">+#include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l73.50"></a><span id="l73.50" class="difflineplus">+#include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l73.51"></a><span id="l73.51" class="difflineplus">+#include &quot;nsILocalMailIncomingServer.h&quot;</span>
<a href="#l73.52"></a><span id="l73.52" class="difflineplus">+#include &quot;nsIMsgLocalMailFolder.h&quot;</span>
<a href="#l73.53"></a><span id="l73.53" class="difflineplus">+#include &quot;nsCOMArray.h&quot;</span>
<a href="#l73.54"></a><span id="l73.54" class="difflineplus">+#include &quot;nsIFile.h&quot;</span>
<a href="#l73.55"></a><span id="l73.55" class="difflineplus">+#include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l73.56"></a><span id="l73.56" class="difflineplus">+#include &quot;nsNetUtil.h&quot;</span>
<a href="#l73.57"></a><span id="l73.57" class="difflineplus">+#include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l73.58"></a><span id="l73.58" class="difflineplus">+#include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l73.59"></a><span id="l73.59" class="difflineplus">+#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l73.60"></a><span id="l73.60" class="difflineplus">+#include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l73.61"></a><span id="l73.61" class="difflineplus">+#include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l73.62"></a><span id="l73.62" class="difflineplus">+#include &quot;nsIArray.h&quot;</span>
<a href="#l73.63"></a><span id="l73.63" class="difflineplus">+#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l73.64"></a><span id="l73.64" class="difflineplus">+#include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l73.65"></a><span id="l73.65" class="difflineplus">+#include &quot;nsMailHeaders.h&quot;</span>
<a href="#l73.66"></a><span id="l73.66" class="difflineplus">+#include &quot;nsReadLine.h&quot;</span>
<a href="#l73.67"></a><span id="l73.67" class="difflineplus">+#include &quot;nsParseMailbox.h&quot;</span>
<a href="#l73.68"></a><span id="l73.68" class="difflineplus">+#include &quot;nsIMailboxService.h&quot;</span>
<a href="#l73.69"></a><span id="l73.69" class="difflineplus">+#include &quot;nsMsgLocalCID.h&quot;</span>
<a href="#l73.70"></a><span id="l73.70" class="difflineplus">+#include &quot;nsIMsgFolderCompactor.h&quot;</span>
<a href="#l73.71"></a><span id="l73.71" class="difflineplus">+#include &quot;nsIPrefService.h&quot;</span>
<a href="#l73.72"></a><span id="l73.72" class="difflineplus">+#include &quot;nsIPrefBranch.h&quot;</span>
<a href="#l73.73"></a><span id="l73.73" class="difflineplus">+#include &quot;prprf.h&quot;</span>
<a href="#l73.74"></a><span id="l73.74" class="difflineplus">+</span>
<a href="#l73.75"></a><span id="l73.75" class="difflineplus">+nsMsgBrkMBoxStore::nsMsgBrkMBoxStore()</span>
<a href="#l73.76"></a><span id="l73.76" class="difflineplus">+{</span>
<a href="#l73.77"></a><span id="l73.77" class="difflineplus">+  m_outputStreams.Init();</span>
<a href="#l73.78"></a><span id="l73.78" class="difflineplus">+}</span>
<a href="#l73.79"></a><span id="l73.79" class="difflineplus">+</span>
<a href="#l73.80"></a><span id="l73.80" class="difflineplus">+nsMsgBrkMBoxStore::~nsMsgBrkMBoxStore()</span>
<a href="#l73.81"></a><span id="l73.81" class="difflineplus">+{</span>
<a href="#l73.82"></a><span id="l73.82" class="difflineplus">+}</span>
<a href="#l73.83"></a><span id="l73.83" class="difflineplus">+</span>
<a href="#l73.84"></a><span id="l73.84" class="difflineplus">+NS_IMPL_ISUPPORTS1(nsMsgBrkMBoxStore, nsIMsgPluggableStore)</span>
<a href="#l73.85"></a><span id="l73.85" class="difflineplus">+</span>
<a href="#l73.86"></a><span id="l73.86" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::DiscoverSubFolders(nsIMsgFolder *aParentFolder,</span>
<a href="#l73.87"></a><span id="l73.87" class="difflineplus">+                                                    bool aDeep)</span>
<a href="#l73.88"></a><span id="l73.88" class="difflineplus">+{</span>
<a href="#l73.89"></a><span id="l73.89" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aParentFolder);</span>
<a href="#l73.90"></a><span id="l73.90" class="difflineplus">+  bool isServer;</span>
<a href="#l73.91"></a><span id="l73.91" class="difflineplus">+  nsresult rv = aParentFolder-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l73.92"></a><span id="l73.92" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.93"></a><span id="l73.93" class="difflineplus">+</span>
<a href="#l73.94"></a><span id="l73.94" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l73.95"></a><span id="l73.95" class="difflineplus">+  rv = aParentFolder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l73.96"></a><span id="l73.96" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l73.97"></a><span id="l73.97" class="difflineplus">+    return rv;</span>
<a href="#l73.98"></a><span id="l73.98" class="difflineplus">+</span>
<a href="#l73.99"></a><span id="l73.99" class="difflineplus">+  bool exists, directory;</span>
<a href="#l73.100"></a><span id="l73.100" class="difflineplus">+  path-&gt;Exists(&amp;exists);</span>
<a href="#l73.101"></a><span id="l73.101" class="difflineplus">+  if (!exists)</span>
<a href="#l73.102"></a><span id="l73.102" class="difflineplus">+    path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l73.103"></a><span id="l73.103" class="difflineplus">+</span>
<a href="#l73.104"></a><span id="l73.104" class="difflineplus">+  path-&gt;IsDirectory(&amp;directory);</span>
<a href="#l73.105"></a><span id="l73.105" class="difflineplus">+  if (!directory)</span>
<a href="#l73.106"></a><span id="l73.106" class="difflineplus">+  {</span>
<a href="#l73.107"></a><span id="l73.107" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; dirFile;</span>
<a href="#l73.108"></a><span id="l73.108" class="difflineplus">+    rv = path-&gt;Clone(getter_AddRefs(dirFile));</span>
<a href="#l73.109"></a><span id="l73.109" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.110"></a><span id="l73.110" class="difflineplus">+    nsAutoString leafName;</span>
<a href="#l73.111"></a><span id="l73.111" class="difflineplus">+    dirFile-&gt;GetLeafName(leafName);</span>
<a href="#l73.112"></a><span id="l73.112" class="difflineplus">+    leafName.AppendLiteral(&quot;.sbd&quot;);</span>
<a href="#l73.113"></a><span id="l73.113" class="difflineplus">+    dirFile-&gt;SetLeafName(leafName);</span>
<a href="#l73.114"></a><span id="l73.114" class="difflineplus">+    path = do_QueryInterface(dirFile);</span>
<a href="#l73.115"></a><span id="l73.115" class="difflineplus">+    path-&gt;IsDirectory(&amp;directory);</span>
<a href="#l73.116"></a><span id="l73.116" class="difflineplus">+  }</span>
<a href="#l73.117"></a><span id="l73.117" class="difflineplus">+</span>
<a href="#l73.118"></a><span id="l73.118" class="difflineplus">+  if (directory)</span>
<a href="#l73.119"></a><span id="l73.119" class="difflineplus">+  {</span>
<a href="#l73.120"></a><span id="l73.120" class="difflineplus">+    aParentFolder-&gt;SetFlag(nsMsgFolderFlags::Mail | nsMsgFolderFlags::Elided |</span>
<a href="#l73.121"></a><span id="l73.121" class="difflineplus">+                           nsMsgFolderFlags::Directory);</span>
<a href="#l73.122"></a><span id="l73.122" class="difflineplus">+</span>
<a href="#l73.123"></a><span id="l73.123" class="difflineplus">+    // now, discover those folders</span>
<a href="#l73.124"></a><span id="l73.124" class="difflineplus">+    rv = AddSubFolders(aParentFolder, path, aDeep);</span>
<a href="#l73.125"></a><span id="l73.125" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l73.126"></a><span id="l73.126" class="difflineplus">+      return rv;</span>
<a href="#l73.127"></a><span id="l73.127" class="difflineplus">+</span>
<a href="#l73.128"></a><span id="l73.128" class="difflineplus">+    bool createdDefaultMailboxes = false;</span>
<a href="#l73.129"></a><span id="l73.129" class="difflineplus">+    nsCOMPtr&lt;nsILocalMailIncomingServer&gt; localMailServer;</span>
<a href="#l73.130"></a><span id="l73.130" class="difflineplus">+</span>
<a href="#l73.131"></a><span id="l73.131" class="difflineplus">+    if (isServer)</span>
<a href="#l73.132"></a><span id="l73.132" class="difflineplus">+    {</span>
<a href="#l73.133"></a><span id="l73.133" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l73.134"></a><span id="l73.134" class="difflineplus">+      rv = aParentFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l73.135"></a><span id="l73.135" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l73.136"></a><span id="l73.136" class="difflineplus">+      localMailServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l73.137"></a><span id="l73.137" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l73.138"></a><span id="l73.138" class="difflineplus">+</span>
<a href="#l73.139"></a><span id="l73.139" class="difflineplus">+      // first create the folders on disk (as empty files)</span>
<a href="#l73.140"></a><span id="l73.140" class="difflineplus">+      rv = localMailServer-&gt;CreateDefaultMailboxes(path);</span>
<a href="#l73.141"></a><span id="l73.141" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.142"></a><span id="l73.142" class="difflineplus">+      createdDefaultMailboxes = true;</span>
<a href="#l73.143"></a><span id="l73.143" class="difflineplus">+      // now, discover those folders</span>
<a href="#l73.144"></a><span id="l73.144" class="difflineplus">+      rv = AddSubFolders(aParentFolder, path, aDeep);</span>
<a href="#l73.145"></a><span id="l73.145" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l73.146"></a><span id="l73.146" class="difflineplus">+        return rv;</span>
<a href="#l73.147"></a><span id="l73.147" class="difflineplus">+      </span>
<a href="#l73.148"></a><span id="l73.148" class="difflineplus">+      rv = localMailServer-&gt;SetFlagsOnDefaultMailboxes();</span>
<a href="#l73.149"></a><span id="l73.149" class="difflineplus">+      if (NS_FAILED(rv))</span>
<a href="#l73.150"></a><span id="l73.150" class="difflineplus">+        return rv;</span>
<a href="#l73.151"></a><span id="l73.151" class="difflineplus">+    }</span>
<a href="#l73.152"></a><span id="l73.152" class="difflineplus">+  }</span>
<a href="#l73.153"></a><span id="l73.153" class="difflineplus">+  return rv;</span>
<a href="#l73.154"></a><span id="l73.154" class="difflineplus">+}</span>
<a href="#l73.155"></a><span id="l73.155" class="difflineplus">+</span>
<a href="#l73.156"></a><span id="l73.156" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::CreateFolder(nsIMsgFolder *aParent,</span>
<a href="#l73.157"></a><span id="l73.157" class="difflineplus">+                                              const nsAString &amp;aFolderName,</span>
<a href="#l73.158"></a><span id="l73.158" class="difflineplus">+                                              nsIMsgFolder **aResult)</span>
<a href="#l73.159"></a><span id="l73.159" class="difflineplus">+{</span>
<a href="#l73.160"></a><span id="l73.160" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l73.161"></a><span id="l73.161" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l73.162"></a><span id="l73.162" class="difflineplus">+  nsresult rv = aParent-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l73.163"></a><span id="l73.163" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l73.164"></a><span id="l73.164" class="difflineplus">+    return rv;</span>
<a href="#l73.165"></a><span id="l73.165" class="difflineplus">+  //Get a directory based on our current path.</span>
<a href="#l73.166"></a><span id="l73.166" class="difflineplus">+  rv = CreateDirectoryForFolder(path);</span>
<a href="#l73.167"></a><span id="l73.167" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l73.168"></a><span id="l73.168" class="difflineplus">+    return rv;</span>
<a href="#l73.169"></a><span id="l73.169" class="difflineplus">+</span>
<a href="#l73.170"></a><span id="l73.170" class="difflineplus">+  // Now we have a valid directory or we have returned.</span>
<a href="#l73.171"></a><span id="l73.171" class="difflineplus">+  // Make sure the new folder name is valid</span>
<a href="#l73.172"></a><span id="l73.172" class="difflineplus">+  nsAutoString safeFolderName(aFolderName);</span>
<a href="#l73.173"></a><span id="l73.173" class="difflineplus">+  NS_MsgHashIfNecessary(safeFolderName);</span>
<a href="#l73.174"></a><span id="l73.174" class="difflineplus">+</span>
<a href="#l73.175"></a><span id="l73.175" class="difflineplus">+  path-&gt;Append(safeFolderName);</span>
<a href="#l73.176"></a><span id="l73.176" class="difflineplus">+  bool exists;</span>
<a href="#l73.177"></a><span id="l73.177" class="difflineplus">+  path-&gt;Exists(&amp;exists);</span>
<a href="#l73.178"></a><span id="l73.178" class="difflineplus">+  if (exists) //check this because localized names are different from disk names</span>
<a href="#l73.179"></a><span id="l73.179" class="difflineplus">+    return NS_MSG_FOLDER_EXISTS;</span>
<a href="#l73.180"></a><span id="l73.180" class="difflineplus">+</span>
<a href="#l73.181"></a><span id="l73.181" class="difflineplus">+  path-&gt;Create(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l73.182"></a><span id="l73.182" class="difflineplus">+</span>
<a href="#l73.183"></a><span id="l73.183" class="difflineplus">+  //GetFlags and SetFlags in AddSubfolder will fail because we have no db at</span>
<a href="#l73.184"></a><span id="l73.184" class="difflineplus">+  // this point but mFlags is set.</span>
<a href="#l73.185"></a><span id="l73.185" class="difflineplus">+  rv = aParent-&gt;AddSubfolder(safeFolderName, getter_AddRefs(child));</span>
<a href="#l73.186"></a><span id="l73.186" class="difflineplus">+  if (!child || NS_FAILED(rv))</span>
<a href="#l73.187"></a><span id="l73.187" class="difflineplus">+  {</span>
<a href="#l73.188"></a><span id="l73.188" class="difflineplus">+    path-&gt;Remove(false);</span>
<a href="#l73.189"></a><span id="l73.189" class="difflineplus">+    return rv;</span>
<a href="#l73.190"></a><span id="l73.190" class="difflineplus">+  }</span>
<a href="#l73.191"></a><span id="l73.191" class="difflineplus">+  // Create an empty database for this mail folder, set its name from the user</span>
<a href="#l73.192"></a><span id="l73.192" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l73.193"></a><span id="l73.193" class="difflineplus">+    do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l73.194"></a><span id="l73.194" class="difflineplus">+  if (msgDBService)</span>
<a href="#l73.195"></a><span id="l73.195" class="difflineplus">+  {</span>
<a href="#l73.196"></a><span id="l73.196" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; unusedDB;</span>
<a href="#l73.197"></a><span id="l73.197" class="difflineplus">+    rv = msgDBService-&gt;OpenFolderDB(child, true, getter_AddRefs(unusedDB));</span>
<a href="#l73.198"></a><span id="l73.198" class="difflineplus">+    if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l73.199"></a><span id="l73.199" class="difflineplus">+      rv = msgDBService-&gt;CreateNewDB(child, getter_AddRefs(unusedDB));</span>
<a href="#l73.200"></a><span id="l73.200" class="difflineplus">+</span>
<a href="#l73.201"></a><span id="l73.201" class="difflineplus">+    if ((NS_SUCCEEDED(rv) || rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE) &amp;&amp;</span>
<a href="#l73.202"></a><span id="l73.202" class="difflineplus">+        unusedDB)</span>
<a href="#l73.203"></a><span id="l73.203" class="difflineplus">+    {</span>
<a href="#l73.204"></a><span id="l73.204" class="difflineplus">+      //need to set the folder name</span>
<a href="#l73.205"></a><span id="l73.205" class="difflineplus">+      nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l73.206"></a><span id="l73.206" class="difflineplus">+      rv = unusedDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l73.207"></a><span id="l73.207" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l73.208"></a><span id="l73.208" class="difflineplus">+        folderInfo-&gt;SetMailboxName(safeFolderName);</span>
<a href="#l73.209"></a><span id="l73.209" class="difflineplus">+</span>
<a href="#l73.210"></a><span id="l73.210" class="difflineplus">+      unusedDB-&gt;SetSummaryValid(true);</span>
<a href="#l73.211"></a><span id="l73.211" class="difflineplus">+      unusedDB-&gt;Close(true);</span>
<a href="#l73.212"></a><span id="l73.212" class="difflineplus">+      aParent-&gt;UpdateSummaryTotals(true);</span>
<a href="#l73.213"></a><span id="l73.213" class="difflineplus">+    }</span>
<a href="#l73.214"></a><span id="l73.214" class="difflineplus">+    else</span>
<a href="#l73.215"></a><span id="l73.215" class="difflineplus">+    {</span>
<a href="#l73.216"></a><span id="l73.216" class="difflineplus">+      path-&gt;Remove(false);</span>
<a href="#l73.217"></a><span id="l73.217" class="difflineplus">+      rv = NS_MSG_CANT_CREATE_FOLDER;</span>
<a href="#l73.218"></a><span id="l73.218" class="difflineplus">+    }</span>
<a href="#l73.219"></a><span id="l73.219" class="difflineplus">+  }</span>
<a href="#l73.220"></a><span id="l73.220" class="difflineplus">+  child.forget(aResult);</span>
<a href="#l73.221"></a><span id="l73.221" class="difflineplus">+  return rv;</span>
<a href="#l73.222"></a><span id="l73.222" class="difflineplus">+}</span>
<a href="#l73.223"></a><span id="l73.223" class="difflineplus">+</span>
<a href="#l73.224"></a><span id="l73.224" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::GetSummaryFile(nsIMsgFolder *aFolder,</span>
<a href="#l73.225"></a><span id="l73.225" class="difflineplus">+                                                nsILocalFile **aSummaryFile)</span>
<a href="#l73.226"></a><span id="l73.226" class="difflineplus">+{</span>
<a href="#l73.227"></a><span id="l73.227" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l73.228"></a><span id="l73.228" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSummaryFile);</span>
<a href="#l73.229"></a><span id="l73.229" class="difflineplus">+</span>
<a href="#l73.230"></a><span id="l73.230" class="difflineplus">+  nsresult rv;</span>
<a href="#l73.231"></a><span id="l73.231" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; newSummaryLocation;</span>
<a href="#l73.232"></a><span id="l73.232" class="difflineplus">+  rv = aFolder-&gt;GetFilePath(getter_AddRefs(newSummaryLocation));</span>
<a href="#l73.233"></a><span id="l73.233" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.234"></a><span id="l73.234" class="difflineplus">+</span>
<a href="#l73.235"></a><span id="l73.235" class="difflineplus">+  nsString fileName;</span>
<a href="#l73.236"></a><span id="l73.236" class="difflineplus">+</span>
<a href="#l73.237"></a><span id="l73.237" class="difflineplus">+  rv = newSummaryLocation-&gt;GetLeafName(fileName);</span>
<a href="#l73.238"></a><span id="l73.238" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l73.239"></a><span id="l73.239" class="difflineplus">+    return rv;</span>
<a href="#l73.240"></a><span id="l73.240" class="difflineplus">+</span>
<a href="#l73.241"></a><span id="l73.241" class="difflineplus">+  fileName.Append(NS_LITERAL_STRING(SUMMARY_SUFFIX));</span>
<a href="#l73.242"></a><span id="l73.242" class="difflineplus">+  rv = newSummaryLocation-&gt;SetLeafName(fileName);</span>
<a href="#l73.243"></a><span id="l73.243" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.244"></a><span id="l73.244" class="difflineplus">+</span>
<a href="#l73.245"></a><span id="l73.245" class="difflineplus">+  newSummaryLocation.forget(aSummaryFile);</span>
<a href="#l73.246"></a><span id="l73.246" class="difflineplus">+  return NS_OK;</span>
<a href="#l73.247"></a><span id="l73.247" class="difflineplus">+}</span>
<a href="#l73.248"></a><span id="l73.248" class="difflineplus">+</span>
<a href="#l73.249"></a><span id="l73.249" class="difflineplus">+// Get the current attributes of the mbox file, corrected for caching</span>
<a href="#l73.250"></a><span id="l73.250" class="difflineplus">+void nsMsgBrkMBoxStore::GetMailboxModProperties(nsIMsgFolder *aFolder,</span>
<a href="#l73.251"></a><span id="l73.251" class="difflineplus">+                                                PRInt64 *aSize, PRUint32 *aDate)</span>
<a href="#l73.252"></a><span id="l73.252" class="difflineplus">+{</span>
<a href="#l73.253"></a><span id="l73.253" class="difflineplus">+  // We'll simply return 0 on errors.</span>
<a href="#l73.254"></a><span id="l73.254" class="difflineplus">+  *aDate = 0;</span>
<a href="#l73.255"></a><span id="l73.255" class="difflineplus">+  *aSize = 0;</span>
<a href="#l73.256"></a><span id="l73.256" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; pathFile;</span>
<a href="#l73.257"></a><span id="l73.257" class="difflineplus">+  nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l73.258"></a><span id="l73.258" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, );</span>
<a href="#l73.259"></a><span id="l73.259" class="difflineplus">+</span>
<a href="#l73.260"></a><span id="l73.260" class="difflineplus">+  rv = pathFile-&gt;GetFileSize(aSize);</span>
<a href="#l73.261"></a><span id="l73.261" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l73.262"></a><span id="l73.262" class="difflineplus">+    return;</span>
<a href="#l73.263"></a><span id="l73.263" class="difflineplus">+</span>
<a href="#l73.264"></a><span id="l73.264" class="difflineplus">+  PRInt64 lastModTime;</span>
<a href="#l73.265"></a><span id="l73.265" class="difflineplus">+  rv = pathFile-&gt;GetLastModifiedTime(&amp;lastModTime);</span>
<a href="#l73.266"></a><span id="l73.266" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l73.267"></a><span id="l73.267" class="difflineplus">+    return;</span>
<a href="#l73.268"></a><span id="l73.268" class="difflineplus">+</span>
<a href="#l73.269"></a><span id="l73.269" class="difflineplus">+  *aDate = (PRUint32) (lastModTime / PR_MSEC_PER_SEC);</span>
<a href="#l73.270"></a><span id="l73.270" class="difflineplus">+}</span>
<a href="#l73.271"></a><span id="l73.271" class="difflineplus">+</span>
<a href="#l73.272"></a><span id="l73.272" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::HasSpaceAvailable(nsIMsgFolder *aFolder,</span>
<a href="#l73.273"></a><span id="l73.273" class="difflineplus">+                                                   PRInt64 aSpaceRequested,</span>
<a href="#l73.274"></a><span id="l73.274" class="difflineplus">+                                                   bool *aResult)</span>
<a href="#l73.275"></a><span id="l73.275" class="difflineplus">+{</span>
<a href="#l73.276"></a><span id="l73.276" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l73.277"></a><span id="l73.277" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l73.278"></a><span id="l73.278" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; pathFile;</span>
<a href="#l73.279"></a><span id="l73.279" class="difflineplus">+  nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l73.280"></a><span id="l73.280" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.281"></a><span id="l73.281" class="difflineplus">+  PRInt64 fileSize;</span>
<a href="#l73.282"></a><span id="l73.282" class="difflineplus">+  rv = pathFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l73.283"></a><span id="l73.283" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.284"></a><span id="l73.284" class="difflineplus">+  // ### I think we're allowing mailboxes &gt; 4GB, so we should be checking</span>
<a href="#l73.285"></a><span id="l73.285" class="difflineplus">+  // for disk space here, not total file size.</span>
<a href="#l73.286"></a><span id="l73.286" class="difflineplus">+  *aResult = ((fileSize + aSpaceRequested) &lt; 0xFFC00000);</span>
<a href="#l73.287"></a><span id="l73.287" class="difflineplus">+  return NS_OK;</span>
<a href="#l73.288"></a><span id="l73.288" class="difflineplus">+}</span>
<a href="#l73.289"></a><span id="l73.289" class="difflineplus">+</span>
<a href="#l73.290"></a><span id="l73.290" class="difflineplus">+static bool gGotGlobalPrefs = false;</span>
<a href="#l73.291"></a><span id="l73.291" class="difflineplus">+static PRInt32 gTimeStampLeeway = 60;</span>
<a href="#l73.292"></a><span id="l73.292" class="difflineplus">+</span>
<a href="#l73.293"></a><span id="l73.293" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::IsSummaryFileValid(nsIMsgFolder *aFolder,</span>
<a href="#l73.294"></a><span id="l73.294" class="difflineplus">+                                                    nsIMsgDatabase *aDB,</span>
<a href="#l73.295"></a><span id="l73.295" class="difflineplus">+                                                    bool *aResult)</span>
<a href="#l73.296"></a><span id="l73.296" class="difflineplus">+{</span>
<a href="#l73.297"></a><span id="l73.297" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l73.298"></a><span id="l73.298" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDB);</span>
<a href="#l73.299"></a><span id="l73.299" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l73.300"></a><span id="l73.300" class="difflineplus">+  // We only check local folders for db validity.</span>
<a href="#l73.301"></a><span id="l73.301" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder(do_QueryInterface(aFolder));</span>
<a href="#l73.302"></a><span id="l73.302" class="difflineplus">+  if (!localFolder)</span>
<a href="#l73.303"></a><span id="l73.303" class="difflineplus">+  {</span>
<a href="#l73.304"></a><span id="l73.304" class="difflineplus">+    *aResult = true;</span>
<a href="#l73.305"></a><span id="l73.305" class="difflineplus">+    return NS_OK;</span>
<a href="#l73.306"></a><span id="l73.306" class="difflineplus">+  }</span>
<a href="#l73.307"></a><span id="l73.307" class="difflineplus">+</span>
<a href="#l73.308"></a><span id="l73.308" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; pathFile;</span>
<a href="#l73.309"></a><span id="l73.309" class="difflineplus">+  nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l73.310"></a><span id="l73.310" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.311"></a><span id="l73.311" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l73.312"></a><span id="l73.312" class="difflineplus">+  rv = aDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l73.313"></a><span id="l73.313" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.314"></a><span id="l73.314" class="difflineplus">+  PRUint64 folderSize;</span>
<a href="#l73.315"></a><span id="l73.315" class="difflineplus">+  PRUint32 folderDate;</span>
<a href="#l73.316"></a><span id="l73.316" class="difflineplus">+  PRInt32 numUnreadMessages;</span>
<a href="#l73.317"></a><span id="l73.317" class="difflineplus">+</span>
<a href="#l73.318"></a><span id="l73.318" class="difflineplus">+  *aResult = false;</span>
<a href="#l73.319"></a><span id="l73.319" class="difflineplus">+</span>
<a href="#l73.320"></a><span id="l73.320" class="difflineplus">+  folderInfo-&gt;GetNumUnreadMessages(&amp;numUnreadMessages);</span>
<a href="#l73.321"></a><span id="l73.321" class="difflineplus">+  folderInfo-&gt;GetFolderSize(&amp;folderSize);</span>
<a href="#l73.322"></a><span id="l73.322" class="difflineplus">+  folderInfo-&gt;GetFolderDate(&amp;folderDate);</span>
<a href="#l73.323"></a><span id="l73.323" class="difflineplus">+</span>
<a href="#l73.324"></a><span id="l73.324" class="difflineplus">+  PRInt64 fileSize = 0;</span>
<a href="#l73.325"></a><span id="l73.325" class="difflineplus">+  PRUint32 actualFolderTimeStamp = 0;</span>
<a href="#l73.326"></a><span id="l73.326" class="difflineplus">+  GetMailboxModProperties(aFolder, &amp;fileSize, &amp;actualFolderTimeStamp);</span>
<a href="#l73.327"></a><span id="l73.327" class="difflineplus">+</span>
<a href="#l73.328"></a><span id="l73.328" class="difflineplus">+  if (folderSize == fileSize &amp;&amp; numUnreadMessages &gt;= 0)</span>
<a href="#l73.329"></a><span id="l73.329" class="difflineplus">+  {</span>
<a href="#l73.330"></a><span id="l73.330" class="difflineplus">+    if (!folderSize)</span>
<a href="#l73.331"></a><span id="l73.331" class="difflineplus">+    {</span>
<a href="#l73.332"></a><span id="l73.332" class="difflineplus">+      *aResult = true;</span>
<a href="#l73.333"></a><span id="l73.333" class="difflineplus">+      return NS_OK;</span>
<a href="#l73.334"></a><span id="l73.334" class="difflineplus">+    }</span>
<a href="#l73.335"></a><span id="l73.335" class="difflineplus">+    if (!gGotGlobalPrefs)</span>
<a href="#l73.336"></a><span id="l73.336" class="difflineplus">+    {</span>
<a href="#l73.337"></a><span id="l73.337" class="difflineplus">+      nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID));</span>
<a href="#l73.338"></a><span id="l73.338" class="difflineplus">+      if (pPrefBranch)</span>
<a href="#l73.339"></a><span id="l73.339" class="difflineplus">+      {</span>
<a href="#l73.340"></a><span id="l73.340" class="difflineplus">+        rv = pPrefBranch-&gt;GetIntPref(&quot;mail.db_timestamp_leeway&quot;, &amp;gTimeStampLeeway);</span>
<a href="#l73.341"></a><span id="l73.341" class="difflineplus">+        gGotGlobalPrefs = true;</span>
<a href="#l73.342"></a><span id="l73.342" class="difflineplus">+      }</span>
<a href="#l73.343"></a><span id="l73.343" class="difflineplus">+    }</span>
<a href="#l73.344"></a><span id="l73.344" class="difflineplus">+    // if those values are ok, check time stamp</span>
<a href="#l73.345"></a><span id="l73.345" class="difflineplus">+    if (gTimeStampLeeway == 0)</span>
<a href="#l73.346"></a><span id="l73.346" class="difflineplus">+      *aResult = folderDate == actualFolderTimeStamp;</span>
<a href="#l73.347"></a><span id="l73.347" class="difflineplus">+    else</span>
<a href="#l73.348"></a><span id="l73.348" class="difflineplus">+      *aResult = NS_ABS((PRInt32) (actualFolderTimeStamp - folderDate)) &lt;= gTimeStampLeeway;</span>
<a href="#l73.349"></a><span id="l73.349" class="difflineplus">+  }</span>
<a href="#l73.350"></a><span id="l73.350" class="difflineplus">+  return NS_OK;</span>
<a href="#l73.351"></a><span id="l73.351" class="difflineplus">+}</span>
<a href="#l73.352"></a><span id="l73.352" class="difflineplus">+</span>
<a href="#l73.353"></a><span id="l73.353" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::SetSummaryFileValid(nsIMsgFolder *aFolder,</span>
<a href="#l73.354"></a><span id="l73.354" class="difflineplus">+                                                     nsIMsgDatabase *aDB,</span>
<a href="#l73.355"></a><span id="l73.355" class="difflineplus">+                                                     bool aValid)</span>
<a href="#l73.356"></a><span id="l73.356" class="difflineplus">+{</span>
<a href="#l73.357"></a><span id="l73.357" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l73.358"></a><span id="l73.358" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDB);</span>
<a href="#l73.359"></a><span id="l73.359" class="difflineplus">+  // We only need to do this for local folders.</span>
<a href="#l73.360"></a><span id="l73.360" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder(do_QueryInterface(aFolder));</span>
<a href="#l73.361"></a><span id="l73.361" class="difflineplus">+  if (!localFolder)</span>
<a href="#l73.362"></a><span id="l73.362" class="difflineplus">+    return NS_OK;</span>
<a href="#l73.363"></a><span id="l73.363" class="difflineplus">+</span>
<a href="#l73.364"></a><span id="l73.364" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; pathFile;</span>
<a href="#l73.365"></a><span id="l73.365" class="difflineplus">+  nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l73.366"></a><span id="l73.366" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.367"></a><span id="l73.367" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l73.368"></a><span id="l73.368" class="difflineplus">+  rv = aDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l73.369"></a><span id="l73.369" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.370"></a><span id="l73.370" class="difflineplus">+  bool exists;</span>
<a href="#l73.371"></a><span id="l73.371" class="difflineplus">+  pathFile-&gt;Exists(&amp;exists);</span>
<a href="#l73.372"></a><span id="l73.372" class="difflineplus">+  if (!exists)</span>
<a href="#l73.373"></a><span id="l73.373" class="difflineplus">+    return NS_MSG_ERROR_FOLDER_MISSING;</span>
<a href="#l73.374"></a><span id="l73.374" class="difflineplus">+</span>
<a href="#l73.375"></a><span id="l73.375" class="difflineplus">+  if (aValid)</span>
<a href="#l73.376"></a><span id="l73.376" class="difflineplus">+  {</span>
<a href="#l73.377"></a><span id="l73.377" class="difflineplus">+    PRUint32 actualFolderTimeStamp;</span>
<a href="#l73.378"></a><span id="l73.378" class="difflineplus">+    PRInt64 fileSize;</span>
<a href="#l73.379"></a><span id="l73.379" class="difflineplus">+    GetMailboxModProperties(aFolder, &amp;fileSize, &amp;actualFolderTimeStamp);</span>
<a href="#l73.380"></a><span id="l73.380" class="difflineplus">+    folderInfo-&gt;SetFolderSize(fileSize);</span>
<a href="#l73.381"></a><span id="l73.381" class="difflineplus">+    folderInfo-&gt;SetFolderDate(actualFolderTimeStamp);</span>
<a href="#l73.382"></a><span id="l73.382" class="difflineplus">+  }</span>
<a href="#l73.383"></a><span id="l73.383" class="difflineplus">+  else</span>
<a href="#l73.384"></a><span id="l73.384" class="difflineplus">+  {</span>
<a href="#l73.385"></a><span id="l73.385" class="difflineplus">+    folderInfo-&gt;SetVersion(0); // that ought to do the trick.</span>
<a href="#l73.386"></a><span id="l73.386" class="difflineplus">+  }</span>
<a href="#l73.387"></a><span id="l73.387" class="difflineplus">+  aDB-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l73.388"></a><span id="l73.388" class="difflineplus">+  return rv;</span>
<a href="#l73.389"></a><span id="l73.389" class="difflineplus">+}</span>
<a href="#l73.390"></a><span id="l73.390" class="difflineplus">+</span>
<a href="#l73.391"></a><span id="l73.391" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::DeleteFolder(nsIMsgFolder *aFolder)</span>
<a href="#l73.392"></a><span id="l73.392" class="difflineplus">+{</span>
<a href="#l73.393"></a><span id="l73.393" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l73.394"></a><span id="l73.394" class="difflineplus">+  //Delete mailbox</span>
<a href="#l73.395"></a><span id="l73.395" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; pathFile;</span>
<a href="#l73.396"></a><span id="l73.396" class="difflineplus">+  nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l73.397"></a><span id="l73.397" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.398"></a><span id="l73.398" class="difflineplus">+</span>
<a href="#l73.399"></a><span id="l73.399" class="difflineplus">+  pathFile-&gt;Remove(false);</span>
<a href="#l73.400"></a><span id="l73.400" class="difflineplus">+</span>
<a href="#l73.401"></a><span id="l73.401" class="difflineplus">+  bool isDirectory = false;</span>
<a href="#l73.402"></a><span id="l73.402" class="difflineplus">+  pathFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l73.403"></a><span id="l73.403" class="difflineplus">+  if (!isDirectory)</span>
<a href="#l73.404"></a><span id="l73.404" class="difflineplus">+  {</span>
<a href="#l73.405"></a><span id="l73.405" class="difflineplus">+    nsAutoString leafName;</span>
<a href="#l73.406"></a><span id="l73.406" class="difflineplus">+    pathFile-&gt;GetLeafName(leafName);</span>
<a href="#l73.407"></a><span id="l73.407" class="difflineplus">+    leafName.AppendLiteral(FOLDER_SUFFIX);</span>
<a href="#l73.408"></a><span id="l73.408" class="difflineplus">+    pathFile-&gt;SetLeafName(leafName);</span>
<a href="#l73.409"></a><span id="l73.409" class="difflineplus">+  }</span>
<a href="#l73.410"></a><span id="l73.410" class="difflineplus">+  isDirectory = false;</span>
<a href="#l73.411"></a><span id="l73.411" class="difflineplus">+  pathFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l73.412"></a><span id="l73.412" class="difflineplus">+  //If this is a directory, then remove it.</span>
<a href="#l73.413"></a><span id="l73.413" class="difflineplus">+  return isDirectory ? pathFile-&gt;Remove(true) : NS_OK;</span>
<a href="#l73.414"></a><span id="l73.414" class="difflineplus">+}</span>
<a href="#l73.415"></a><span id="l73.415" class="difflineplus">+</span>
<a href="#l73.416"></a><span id="l73.416" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::RenameFolder(nsIMsgFolder *aFolder,</span>
<a href="#l73.417"></a><span id="l73.417" class="difflineplus">+                                              const nsAString &amp; aNewName,</span>
<a href="#l73.418"></a><span id="l73.418" class="difflineplus">+                                              nsIMsgFolder **aNewFolder)</span>
<a href="#l73.419"></a><span id="l73.419" class="difflineplus">+{</span>
<a href="#l73.420"></a><span id="l73.420" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l73.421"></a><span id="l73.421" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNewFolder);</span>
<a href="#l73.422"></a><span id="l73.422" class="difflineplus">+</span>
<a href="#l73.423"></a><span id="l73.423" class="difflineplus">+  PRUint32 numChildren;</span>
<a href="#l73.424"></a><span id="l73.424" class="difflineplus">+  aFolder-&gt;GetNumSubFolders(&amp;numChildren);</span>
<a href="#l73.425"></a><span id="l73.425" class="difflineplus">+  nsString existingName;</span>
<a href="#l73.426"></a><span id="l73.426" class="difflineplus">+  aFolder-&gt;GetName(existingName);</span>
<a href="#l73.427"></a><span id="l73.427" class="difflineplus">+</span>
<a href="#l73.428"></a><span id="l73.428" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; oldPathFile;</span>
<a href="#l73.429"></a><span id="l73.429" class="difflineplus">+  nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(oldPathFile));</span>
<a href="#l73.430"></a><span id="l73.430" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l73.431"></a><span id="l73.431" class="difflineplus">+    return rv;</span>
<a href="#l73.432"></a><span id="l73.432" class="difflineplus">+</span>
<a href="#l73.433"></a><span id="l73.433" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l73.434"></a><span id="l73.434" class="difflineplus">+  rv = aFolder-&gt;GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l73.435"></a><span id="l73.435" class="difflineplus">+  if (!parentFolder)</span>
<a href="#l73.436"></a><span id="l73.436" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l73.437"></a><span id="l73.437" class="difflineplus">+</span>
<a href="#l73.438"></a><span id="l73.438" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; parentSupport = do_QueryInterface(parentFolder);</span>
<a href="#l73.439"></a><span id="l73.439" class="difflineplus">+</span>
<a href="#l73.440"></a><span id="l73.440" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; oldSummaryFile;</span>
<a href="#l73.441"></a><span id="l73.441" class="difflineplus">+  rv = GetSummaryFile(aFolder, getter_AddRefs(oldSummaryFile));</span>
<a href="#l73.442"></a><span id="l73.442" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.443"></a><span id="l73.443" class="difflineplus">+</span>
<a href="#l73.444"></a><span id="l73.444" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; dirFile;</span>
<a href="#l73.445"></a><span id="l73.445" class="difflineplus">+  oldPathFile-&gt;Clone(getter_AddRefs(dirFile));</span>
<a href="#l73.446"></a><span id="l73.446" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; localDirFile(do_QueryInterface(dirFile));</span>
<a href="#l73.447"></a><span id="l73.447" class="difflineplus">+</span>
<a href="#l73.448"></a><span id="l73.448" class="difflineplus">+  if (numChildren &gt; 0)</span>
<a href="#l73.449"></a><span id="l73.449" class="difflineplus">+  {</span>
<a href="#l73.450"></a><span id="l73.450" class="difflineplus">+    rv = CreateDirectoryForFolder(localDirFile);</span>
<a href="#l73.451"></a><span id="l73.451" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.452"></a><span id="l73.452" class="difflineplus">+  }</span>
<a href="#l73.453"></a><span id="l73.453" class="difflineplus">+</span>
<a href="#l73.454"></a><span id="l73.454" class="difflineplus">+  nsAutoString safeName(aNewName);</span>
<a href="#l73.455"></a><span id="l73.455" class="difflineplus">+  NS_MsgHashIfNecessary(safeName);</span>
<a href="#l73.456"></a><span id="l73.456" class="difflineplus">+</span>
<a href="#l73.457"></a><span id="l73.457" class="difflineplus">+  nsCAutoString oldLeafName;</span>
<a href="#l73.458"></a><span id="l73.458" class="difflineplus">+  oldPathFile-&gt;GetNativeLeafName(oldLeafName);</span>
<a href="#l73.459"></a><span id="l73.459" class="difflineplus">+</span>
<a href="#l73.460"></a><span id="l73.460" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; parentPathFile;</span>
<a href="#l73.461"></a><span id="l73.461" class="difflineplus">+  parentFolder-&gt;GetFilePath(getter_AddRefs(parentPathFile));</span>
<a href="#l73.462"></a><span id="l73.462" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l73.463"></a><span id="l73.463" class="difflineplus">+</span>
<a href="#l73.464"></a><span id="l73.464" class="difflineplus">+  bool isDirectory = false;</span>
<a href="#l73.465"></a><span id="l73.465" class="difflineplus">+  parentPathFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l73.466"></a><span id="l73.466" class="difflineplus">+  if (!isDirectory)</span>
<a href="#l73.467"></a><span id="l73.467" class="difflineplus">+  {</span>
<a href="#l73.468"></a><span id="l73.468" class="difflineplus">+    nsAutoString leafName;</span>
<a href="#l73.469"></a><span id="l73.469" class="difflineplus">+    parentPathFile-&gt;GetLeafName(leafName);</span>
<a href="#l73.470"></a><span id="l73.470" class="difflineplus">+    leafName.AppendLiteral(FOLDER_SUFFIX);</span>
<a href="#l73.471"></a><span id="l73.471" class="difflineplus">+    rv = parentPathFile-&gt;SetLeafName(leafName);</span>
<a href="#l73.472"></a><span id="l73.472" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.473"></a><span id="l73.473" class="difflineplus">+  }</span>
<a href="#l73.474"></a><span id="l73.474" class="difflineplus">+</span>
<a href="#l73.475"></a><span id="l73.475" class="difflineplus">+  aFolder-&gt;ForceDBClosed();</span>
<a href="#l73.476"></a><span id="l73.476" class="difflineplus">+  //save off dir name before appending .msf</span>
<a href="#l73.477"></a><span id="l73.477" class="difflineplus">+  rv = oldPathFile-&gt;MoveTo(nsnull, safeName);</span>
<a href="#l73.478"></a><span id="l73.478" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l73.479"></a><span id="l73.479" class="difflineplus">+    return rv;</span>
<a href="#l73.480"></a><span id="l73.480" class="difflineplus">+</span>
<a href="#l73.481"></a><span id="l73.481" class="difflineplus">+  nsString dbName(safeName);</span>
<a href="#l73.482"></a><span id="l73.482" class="difflineplus">+  dbName += NS_LITERAL_STRING(SUMMARY_SUFFIX);</span>
<a href="#l73.483"></a><span id="l73.483" class="difflineplus">+  oldSummaryFile-&gt;MoveTo(nsnull, dbName);</span>
<a href="#l73.484"></a><span id="l73.484" class="difflineplus">+</span>
<a href="#l73.485"></a><span id="l73.485" class="difflineplus">+  if (numChildren &gt; 0)</span>
<a href="#l73.486"></a><span id="l73.486" class="difflineplus">+  {</span>
<a href="#l73.487"></a><span id="l73.487" class="difflineplus">+    // rename &quot;*.sbd&quot; directory</span>
<a href="#l73.488"></a><span id="l73.488" class="difflineplus">+    nsAutoString newNameDirStr(safeName);</span>
<a href="#l73.489"></a><span id="l73.489" class="difflineplus">+    newNameDirStr += NS_LITERAL_STRING(&quot;.sbd&quot;);</span>
<a href="#l73.490"></a><span id="l73.490" class="difflineplus">+    localDirFile-&gt;MoveTo(nsnull, newNameDirStr);</span>
<a href="#l73.491"></a><span id="l73.491" class="difflineplus">+  }</span>
<a href="#l73.492"></a><span id="l73.492" class="difflineplus">+</span>
<a href="#l73.493"></a><span id="l73.493" class="difflineplus">+  return parentFolder-&gt;AddSubfolder(safeName, aNewFolder);</span>
<a href="#l73.494"></a><span id="l73.494" class="difflineplus">+}</span>
<a href="#l73.495"></a><span id="l73.495" class="difflineplus">+</span>
<a href="#l73.496"></a><span id="l73.496" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::CopyFolder(nsIMsgFolder *aSrcFolder,</span>
<a href="#l73.497"></a><span id="l73.497" class="difflineplus">+                                            nsIMsgFolder *aDstFolder,</span>
<a href="#l73.498"></a><span id="l73.498" class="difflineplus">+                                            bool aIsMoveFolder,</span>
<a href="#l73.499"></a><span id="l73.499" class="difflineplus">+                                            nsIMsgWindow *aMsgWindow,</span>
<a href="#l73.500"></a><span id="l73.500" class="difflineplus">+                                            nsIMsgCopyServiceListener *aListener)</span>
<a href="#l73.501"></a><span id="l73.501" class="difflineplus">+{</span>
<a href="#l73.502"></a><span id="l73.502" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSrcFolder);</span>
<a href="#l73.503"></a><span id="l73.503" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDstFolder);</span>
<a href="#l73.504"></a><span id="l73.504" class="difflineplus">+  nsString folderName;</span>
<a href="#l73.505"></a><span id="l73.505" class="difflineplus">+  aSrcFolder-&gt;GetName(folderName);</span>
<a href="#l73.506"></a><span id="l73.506" class="difflineplus">+  nsAutoString safeFolderName(folderName);</span>
<a href="#l73.507"></a><span id="l73.507" class="difflineplus">+  NS_MsgHashIfNecessary(safeFolderName);</span>
<a href="#l73.508"></a><span id="l73.508" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localSrcFolder(do_QueryInterface(aSrcFolder));</span>
<a href="#l73.509"></a><span id="l73.509" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l73.510"></a><span id="l73.510" class="difflineplus">+  if (localSrcFolder)</span>
<a href="#l73.511"></a><span id="l73.511" class="difflineplus">+    localSrcFolder-&gt;GetDatabaseWOReparse(getter_AddRefs(srcDB));</span>
<a href="#l73.512"></a><span id="l73.512" class="difflineplus">+  bool summaryValid = !!srcDB;</span>
<a href="#l73.513"></a><span id="l73.513" class="difflineplus">+  srcDB = nsnull;</span>
<a href="#l73.514"></a><span id="l73.514" class="difflineplus">+  aSrcFolder-&gt;ForceDBClosed();</span>
<a href="#l73.515"></a><span id="l73.515" class="difflineplus">+</span>
<a href="#l73.516"></a><span id="l73.516" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; oldPath;</span>
<a href="#l73.517"></a><span id="l73.517" class="difflineplus">+  nsresult rv = aSrcFolder-&gt;GetFilePath(getter_AddRefs(oldPath));</span>
<a href="#l73.518"></a><span id="l73.518" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l73.519"></a><span id="l73.519" class="difflineplus">+</span>
<a href="#l73.520"></a><span id="l73.520" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; summaryFile;</span>
<a href="#l73.521"></a><span id="l73.521" class="difflineplus">+  GetSummaryFileLocation(oldPath, getter_AddRefs(summaryFile));</span>
<a href="#l73.522"></a><span id="l73.522" class="difflineplus">+</span>
<a href="#l73.523"></a><span id="l73.523" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; newPath;</span>
<a href="#l73.524"></a><span id="l73.524" class="difflineplus">+  rv = aDstFolder-&gt;GetFilePath(getter_AddRefs(newPath));</span>
<a href="#l73.525"></a><span id="l73.525" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l73.526"></a><span id="l73.526" class="difflineplus">+</span>
<a href="#l73.527"></a><span id="l73.527" class="difflineplus">+  bool newPathIsDirectory = false;</span>
<a href="#l73.528"></a><span id="l73.528" class="difflineplus">+  newPath-&gt;IsDirectory(&amp;newPathIsDirectory);</span>
<a href="#l73.529"></a><span id="l73.529" class="difflineplus">+  if (!newPathIsDirectory)</span>
<a href="#l73.530"></a><span id="l73.530" class="difflineplus">+  {</span>
<a href="#l73.531"></a><span id="l73.531" class="difflineplus">+    AddDirectorySeparator(newPath);</span>
<a href="#l73.532"></a><span id="l73.532" class="difflineplus">+    newPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l73.533"></a><span id="l73.533" class="difflineplus">+  }</span>
<a href="#l73.534"></a><span id="l73.534" class="difflineplus">+</span>
<a href="#l73.535"></a><span id="l73.535" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; origPath;</span>
<a href="#l73.536"></a><span id="l73.536" class="difflineplus">+  oldPath-&gt;Clone(getter_AddRefs(origPath));</span>
<a href="#l73.537"></a><span id="l73.537" class="difflineplus">+</span>
<a href="#l73.538"></a><span id="l73.538" class="difflineplus">+   //copying necessary for aborting.... if failure return</span>
<a href="#l73.539"></a><span id="l73.539" class="difflineplus">+  rv = oldPath-&gt;CopyTo(newPath, EmptyString());</span>
<a href="#l73.540"></a><span id="l73.540" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv); // Will fail if a file by that name exists</span>
<a href="#l73.541"></a><span id="l73.541" class="difflineplus">+</span>
<a href="#l73.542"></a><span id="l73.542" class="difflineplus">+  // Copy to dir can fail if filespec does not exist. If copy fails, we test</span>
<a href="#l73.543"></a><span id="l73.543" class="difflineplus">+  // if the filespec exist or not, if it does not that's ok, we continue</span>
<a href="#l73.544"></a><span id="l73.544" class="difflineplus">+  // without copying it. If it fails and filespec exist and is not zero sized</span>
<a href="#l73.545"></a><span id="l73.545" class="difflineplus">+  // there is real problem</span>
<a href="#l73.546"></a><span id="l73.546" class="difflineplus">+  // Copy the file to the new dir</span>
<a href="#l73.547"></a><span id="l73.547" class="difflineplus">+  rv = summaryFile-&gt;CopyTo(newPath, EmptyString());</span>
<a href="#l73.548"></a><span id="l73.548" class="difflineplus">+  if (NS_FAILED(rv)) // Test if the copy is successful</span>
<a href="#l73.549"></a><span id="l73.549" class="difflineplus">+  {</span>
<a href="#l73.550"></a><span id="l73.550" class="difflineplus">+    // Test if the filespec has data</span>
<a href="#l73.551"></a><span id="l73.551" class="difflineplus">+    bool exists;</span>
<a href="#l73.552"></a><span id="l73.552" class="difflineplus">+    PRInt64 fileSize;</span>
<a href="#l73.553"></a><span id="l73.553" class="difflineplus">+    summaryFile-&gt;Exists(&amp;exists);</span>
<a href="#l73.554"></a><span id="l73.554" class="difflineplus">+    summaryFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l73.555"></a><span id="l73.555" class="difflineplus">+    if (exists &amp;&amp; fileSize &gt; 0)</span>
<a href="#l73.556"></a><span id="l73.556" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv); // Yes, it should have worked !</span>
<a href="#l73.557"></a><span id="l73.557" class="difflineplus">+    // else case is filespec is zero sized, no need to copy it,</span>
<a href="#l73.558"></a><span id="l73.558" class="difflineplus">+    // not an error</span>
<a href="#l73.559"></a><span id="l73.559" class="difflineplus">+  }</span>
<a href="#l73.560"></a><span id="l73.560" class="difflineplus">+</span>
<a href="#l73.561"></a><span id="l73.561" class="difflineplus">+  // linux and mac are not good about maintaining the file stamp when copying</span>
<a href="#l73.562"></a><span id="l73.562" class="difflineplus">+  // folders around. So if the source folder db is good, set the dest db as</span>
<a href="#l73.563"></a><span id="l73.563" class="difflineplus">+  // good too.</span>
<a href="#l73.564"></a><span id="l73.564" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; destDB;</span>
<a href="#l73.565"></a><span id="l73.565" class="difflineplus">+  if (summaryValid)</span>
<a href="#l73.566"></a><span id="l73.566" class="difflineplus">+  {</span>
<a href="#l73.567"></a><span id="l73.567" class="difflineplus">+    nsAutoString folderLeafName;</span>
<a href="#l73.568"></a><span id="l73.568" class="difflineplus">+    origPath-&gt;GetLeafName(folderLeafName);</span>
<a href="#l73.569"></a><span id="l73.569" class="difflineplus">+    newPath-&gt;Append(folderLeafName);</span>
<a href="#l73.570"></a><span id="l73.570" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l73.571"></a><span id="l73.571" class="difflineplus">+      do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l73.572"></a><span id="l73.572" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.573"></a><span id="l73.573" class="difflineplus">+    rv = msgDBService-&gt;OpenMailDBFromFile(newPath, aSrcFolder, false,</span>
<a href="#l73.574"></a><span id="l73.574" class="difflineplus">+                                          true, getter_AddRefs(destDB));</span>
<a href="#l73.575"></a><span id="l73.575" class="difflineplus">+    if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE &amp;&amp; destDB)</span>
<a href="#l73.576"></a><span id="l73.576" class="difflineplus">+      destDB-&gt;SetSummaryValid(true);</span>
<a href="#l73.577"></a><span id="l73.577" class="difflineplus">+  }</span>
<a href="#l73.578"></a><span id="l73.578" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; newMsgFolder;</span>
<a href="#l73.579"></a><span id="l73.579" class="difflineplus">+  rv = aDstFolder-&gt;AddSubfolder(safeFolderName, getter_AddRefs(newMsgFolder));</span>
<a href="#l73.580"></a><span id="l73.580" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.581"></a><span id="l73.581" class="difflineplus">+</span>
<a href="#l73.582"></a><span id="l73.582" class="difflineplus">+  newMsgFolder-&gt;SetPrettyName(folderName);</span>
<a href="#l73.583"></a><span id="l73.583" class="difflineplus">+  PRUint32 flags;</span>
<a href="#l73.584"></a><span id="l73.584" class="difflineplus">+  aSrcFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l73.585"></a><span id="l73.585" class="difflineplus">+  newMsgFolder-&gt;SetFlags(flags);</span>
<a href="#l73.586"></a><span id="l73.586" class="difflineplus">+  bool changed = false;</span>
<a href="#l73.587"></a><span id="l73.587" class="difflineplus">+  rv = aSrcFolder-&gt;MatchOrChangeFilterDestination(newMsgFolder, true, &amp;changed);</span>
<a href="#l73.588"></a><span id="l73.588" class="difflineplus">+  if (changed)</span>
<a href="#l73.589"></a><span id="l73.589" class="difflineplus">+    aSrcFolder-&gt;AlertFilterChanged(aMsgWindow);</span>
<a href="#l73.590"></a><span id="l73.590" class="difflineplus">+</span>
<a href="#l73.591"></a><span id="l73.591" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l73.592"></a><span id="l73.592" class="difflineplus">+  rv = aSrcFolder-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l73.593"></a><span id="l73.593" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.594"></a><span id="l73.594" class="difflineplus">+</span>
<a href="#l73.595"></a><span id="l73.595" class="difflineplus">+  // Copy subfolders to the new location</span>
<a href="#l73.596"></a><span id="l73.596" class="difflineplus">+  nsresult copyStatus = NS_OK;</span>
<a href="#l73.597"></a><span id="l73.597" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localNewFolder(do_QueryInterface(newMsgFolder, &amp;rv));</span>
<a href="#l73.598"></a><span id="l73.598" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l73.599"></a><span id="l73.599" class="difflineplus">+  {</span>
<a href="#l73.600"></a><span id="l73.600" class="difflineplus">+    bool hasMore;</span>
<a href="#l73.601"></a><span id="l73.601" class="difflineplus">+    while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore &amp;&amp;</span>
<a href="#l73.602"></a><span id="l73.602" class="difflineplus">+           NS_SUCCEEDED(copyStatus))</span>
<a href="#l73.603"></a><span id="l73.603" class="difflineplus">+    {</span>
<a href="#l73.604"></a><span id="l73.604" class="difflineplus">+      nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l73.605"></a><span id="l73.605" class="difflineplus">+      enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l73.606"></a><span id="l73.606" class="difflineplus">+</span>
<a href="#l73.607"></a><span id="l73.607" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(item));</span>
<a href="#l73.608"></a><span id="l73.608" class="difflineplus">+      if (!folder)</span>
<a href="#l73.609"></a><span id="l73.609" class="difflineplus">+        continue;</span>
<a href="#l73.610"></a><span id="l73.610" class="difflineplus">+</span>
<a href="#l73.611"></a><span id="l73.611" class="difflineplus">+      copyStatus = localNewFolder-&gt;CopyFolderLocal(folder, false,</span>
<a href="#l73.612"></a><span id="l73.612" class="difflineplus">+                                                   aMsgWindow, aListener);</span>
<a href="#l73.613"></a><span id="l73.613" class="difflineplus">+      // Test if the call succeeded, if not we have to stop recursive call</span>
<a href="#l73.614"></a><span id="l73.614" class="difflineplus">+      if (NS_FAILED(copyStatus))</span>
<a href="#l73.615"></a><span id="l73.615" class="difflineplus">+      {</span>
<a href="#l73.616"></a><span id="l73.616" class="difflineplus">+        // Copy failed we have to notify caller to handle the error and stop</span>
<a href="#l73.617"></a><span id="l73.617" class="difflineplus">+        // moving the folders. In case this happens to the topmost level of</span>
<a href="#l73.618"></a><span id="l73.618" class="difflineplus">+        // recursive call, then we just need to break from the while loop and</span>
<a href="#l73.619"></a><span id="l73.619" class="difflineplus">+        // go to error handling code.</span>
<a href="#l73.620"></a><span id="l73.620" class="difflineplus">+        if (!aIsMoveFolder)</span>
<a href="#l73.621"></a><span id="l73.621" class="difflineplus">+          return copyStatus;</span>
<a href="#l73.622"></a><span id="l73.622" class="difflineplus">+        break;</span>
<a href="#l73.623"></a><span id="l73.623" class="difflineplus">+      }</span>
<a href="#l73.624"></a><span id="l73.624" class="difflineplus">+    }</span>
<a href="#l73.625"></a><span id="l73.625" class="difflineplus">+  }</span>
<a href="#l73.626"></a><span id="l73.626" class="difflineplus">+</span>
<a href="#l73.627"></a><span id="l73.627" class="difflineplus">+  if (aIsMoveFolder &amp;&amp; NS_SUCCEEDED(copyStatus))</span>
<a href="#l73.628"></a><span id="l73.628" class="difflineplus">+  {</span>
<a href="#l73.629"></a><span id="l73.629" class="difflineplus">+    if (localNewFolder)</span>
<a href="#l73.630"></a><span id="l73.630" class="difflineplus">+    {</span>
<a href="#l73.631"></a><span id="l73.631" class="difflineplus">+      nsCOMPtr&lt;nsISupports&gt; srcSupport(do_QueryInterface(aSrcFolder));</span>
<a href="#l73.632"></a><span id="l73.632" class="difflineplus">+      localNewFolder-&gt;OnCopyCompleted(srcSupport, true);</span>
<a href="#l73.633"></a><span id="l73.633" class="difflineplus">+    }</span>
<a href="#l73.634"></a><span id="l73.634" class="difflineplus">+</span>
<a href="#l73.635"></a><span id="l73.635" class="difflineplus">+    // Notify the &quot;folder&quot; that was dragged and dropped has been created. No</span>
<a href="#l73.636"></a><span id="l73.636" class="difflineplus">+    // need to do this for its subfolders. isMoveFolder will be true for folder.</span>
<a href="#l73.637"></a><span id="l73.637" class="difflineplus">+    aDstFolder-&gt;NotifyItemAdded(newMsgFolder);</span>
<a href="#l73.638"></a><span id="l73.638" class="difflineplus">+</span>
<a href="#l73.639"></a><span id="l73.639" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; msgParent;</span>
<a href="#l73.640"></a><span id="l73.640" class="difflineplus">+    aSrcFolder-&gt;GetParent(getter_AddRefs(msgParent));</span>
<a href="#l73.641"></a><span id="l73.641" class="difflineplus">+    aSrcFolder-&gt;SetParent(nsnull);</span>
<a href="#l73.642"></a><span id="l73.642" class="difflineplus">+    if (msgParent)</span>
<a href="#l73.643"></a><span id="l73.643" class="difflineplus">+    {</span>
<a href="#l73.644"></a><span id="l73.644" class="difflineplus">+      // The files have already been moved, so delete storage false</span>
<a href="#l73.645"></a><span id="l73.645" class="difflineplus">+      msgParent-&gt;PropagateDelete(aSrcFolder, false, aMsgWindow);</span>
<a href="#l73.646"></a><span id="l73.646" class="difflineplus">+      oldPath-&gt;Remove(false);  //berkeley mailbox</span>
<a href="#l73.647"></a><span id="l73.647" class="difflineplus">+     // We need to force closed the source db</span>
<a href="#l73.648"></a><span id="l73.648" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l73.649"></a><span id="l73.649" class="difflineplus">+      aSrcFolder-&gt;Delete();</span>
<a href="#l73.650"></a><span id="l73.650" class="difflineplus">+</span>
<a href="#l73.651"></a><span id="l73.651" class="difflineplus">+      nsCOMPtr&lt;nsILocalFile&gt; parentPath;</span>
<a href="#l73.652"></a><span id="l73.652" class="difflineplus">+      rv = msgParent-&gt;GetFilePath(getter_AddRefs(parentPath));</span>
<a href="#l73.653"></a><span id="l73.653" class="difflineplus">+      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l73.654"></a><span id="l73.654" class="difflineplus">+</span>
<a href="#l73.655"></a><span id="l73.655" class="difflineplus">+      AddDirectorySeparator(parentPath);</span>
<a href="#l73.656"></a><span id="l73.656" class="difflineplus">+      nsCOMPtr&lt;nsISimpleEnumerator&gt; children;</span>
<a href="#l73.657"></a><span id="l73.657" class="difflineplus">+      parentPath-&gt;GetDirectoryEntries(getter_AddRefs(children));</span>
<a href="#l73.658"></a><span id="l73.658" class="difflineplus">+      bool more;</span>
<a href="#l73.659"></a><span id="l73.659" class="difflineplus">+      // checks if the directory is empty or not</span>
<a href="#l73.660"></a><span id="l73.660" class="difflineplus">+      if (children &amp;&amp; NS_SUCCEEDED(children-&gt;HasMoreElements(&amp;more)) &amp;&amp; !more)</span>
<a href="#l73.661"></a><span id="l73.661" class="difflineplus">+        parentPath-&gt;Remove(true);</span>
<a href="#l73.662"></a><span id="l73.662" class="difflineplus">+    }</span>
<a href="#l73.663"></a><span id="l73.663" class="difflineplus">+  }</span>
<a href="#l73.664"></a><span id="l73.664" class="difflineplus">+  else</span>
<a href="#l73.665"></a><span id="l73.665" class="difflineplus">+  {</span>
<a href="#l73.666"></a><span id="l73.666" class="difflineplus">+    // This is the case where the copy of a subfolder failed.</span>
<a href="#l73.667"></a><span id="l73.667" class="difflineplus">+    // We have to delete the newDirectory tree to make a &quot;rollback&quot;.</span>
<a href="#l73.668"></a><span id="l73.668" class="difflineplus">+    // Someone should add a popup to warn the user that the move was not</span>
<a href="#l73.669"></a><span id="l73.669" class="difflineplus">+    // possible.</span>
<a href="#l73.670"></a><span id="l73.670" class="difflineplus">+    if (aIsMoveFolder &amp;&amp; NS_FAILED(copyStatus))</span>
<a href="#l73.671"></a><span id="l73.671" class="difflineplus">+    {</span>
<a href="#l73.672"></a><span id="l73.672" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; msgParent;</span>
<a href="#l73.673"></a><span id="l73.673" class="difflineplus">+      newMsgFolder-&gt;ForceDBClosed();</span>
<a href="#l73.674"></a><span id="l73.674" class="difflineplus">+      newMsgFolder-&gt;GetParent(getter_AddRefs(msgParent));</span>
<a href="#l73.675"></a><span id="l73.675" class="difflineplus">+      newMsgFolder-&gt;SetParent(nsnull);</span>
<a href="#l73.676"></a><span id="l73.676" class="difflineplus">+      if (msgParent)</span>
<a href="#l73.677"></a><span id="l73.677" class="difflineplus">+      {</span>
<a href="#l73.678"></a><span id="l73.678" class="difflineplus">+        msgParent-&gt;PropagateDelete(newMsgFolder, false, aMsgWindow);</span>
<a href="#l73.679"></a><span id="l73.679" class="difflineplus">+        newMsgFolder-&gt;Delete();</span>
<a href="#l73.680"></a><span id="l73.680" class="difflineplus">+        newMsgFolder-&gt;ForceDBClosed();</span>
<a href="#l73.681"></a><span id="l73.681" class="difflineplus">+        AddDirectorySeparator(newPath);</span>
<a href="#l73.682"></a><span id="l73.682" class="difflineplus">+        newPath-&gt;Remove(true);  //berkeley mailbox</span>
<a href="#l73.683"></a><span id="l73.683" class="difflineplus">+      }</span>
<a href="#l73.684"></a><span id="l73.684" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l73.685"></a><span id="l73.685" class="difflineplus">+    }</span>
<a href="#l73.686"></a><span id="l73.686" class="difflineplus">+  }</span>
<a href="#l73.687"></a><span id="l73.687" class="difflineplus">+  return NS_OK;</span>
<a href="#l73.688"></a><span id="l73.688" class="difflineplus">+}</span>
<a href="#l73.689"></a><span id="l73.689" class="difflineplus">+</span>
<a href="#l73.690"></a><span id="l73.690" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l73.691"></a><span id="l73.691" class="difflineplus">+nsMsgBrkMBoxStore::GetNewMsgOutputStream(nsIMsgFolder *aFolder,</span>
<a href="#l73.692"></a><span id="l73.692" class="difflineplus">+                                         nsIMsgDBHdr **aNewMsgHdr,</span>
<a href="#l73.693"></a><span id="l73.693" class="difflineplus">+                                         bool *aReusable,</span>
<a href="#l73.694"></a><span id="l73.694" class="difflineplus">+                                         nsIOutputStream **aResult)</span>
<a href="#l73.695"></a><span id="l73.695" class="difflineplus">+{</span>
<a href="#l73.696"></a><span id="l73.696" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l73.697"></a><span id="l73.697" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNewMsgHdr);</span>
<a href="#l73.698"></a><span id="l73.698" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aReusable);</span>
<a href="#l73.699"></a><span id="l73.699" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l73.700"></a><span id="l73.700" class="difflineplus">+</span>
<a href="#l73.701"></a><span id="l73.701" class="difflineplus">+#ifdef _DEBUG</span>
<a href="#l73.702"></a><span id="l73.702" class="difflineplus">+  NS_ASSERTION(m_streamOutstandingFolder != aFolder, &quot;didn't finish prev msg&quot;);</span>
<a href="#l73.703"></a><span id="l73.703" class="difflineplus">+  m_streamOutstandingFolder = aFolder;</span>
<a href="#l73.704"></a><span id="l73.704" class="difflineplus">+#endif</span>
<a href="#l73.705"></a><span id="l73.705" class="difflineplus">+  *aReusable = true;</span>
<a href="#l73.706"></a><span id="l73.706" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; mboxFile;</span>
<a href="#l73.707"></a><span id="l73.707" class="difflineplus">+  aFolder-&gt;GetFilePath(getter_AddRefs(mboxFile));</span>
<a href="#l73.708"></a><span id="l73.708" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l73.709"></a><span id="l73.709" class="difflineplus">+  aFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l73.710"></a><span id="l73.710" class="difflineplus">+  if (!db &amp;&amp; !*aNewMsgHdr)</span>
<a href="#l73.711"></a><span id="l73.711" class="difflineplus">+    NS_WARNING(&quot;no db, and no message header&quot;);</span>
<a href="#l73.712"></a><span id="l73.712" class="difflineplus">+  bool exists;</span>
<a href="#l73.713"></a><span id="l73.713" class="difflineplus">+  PRInt64 mboxSize = 0;</span>
<a href="#l73.714"></a><span id="l73.714" class="difflineplus">+  mboxFile-&gt;Exists(&amp;exists);</span>
<a href="#l73.715"></a><span id="l73.715" class="difflineplus">+  if (!exists)</span>
<a href="#l73.716"></a><span id="l73.716" class="difflineplus">+    mboxFile-&gt;Create(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l73.717"></a><span id="l73.717" class="difflineplus">+  else</span>
<a href="#l73.718"></a><span id="l73.718" class="difflineplus">+    mboxFile-&gt;GetFileSize(&amp;mboxSize);</span>
<a href="#l73.719"></a><span id="l73.719" class="difflineplus">+  if (db &amp;&amp; !*aNewMsgHdr)</span>
<a href="#l73.720"></a><span id="l73.720" class="difflineplus">+  {</span>
<a href="#l73.721"></a><span id="l73.721" class="difflineplus">+    // if mbox is close to 4GB, auto-assign the msg key.</span>
<a href="#l73.722"></a><span id="l73.722" class="difflineplus">+    nsMsgKey key = mboxSize &gt; 0xFFFFFF00 ? nsMsgKey_None : (nsMsgKey) mboxSize;</span>
<a href="#l73.723"></a><span id="l73.723" class="difflineplus">+    db-&gt;CreateNewHdr(key, aNewMsgHdr);</span>
<a href="#l73.724"></a><span id="l73.724" class="difflineplus">+  }</span>
<a href="#l73.725"></a><span id="l73.725" class="difflineplus">+  if (*aNewMsgHdr)</span>
<a href="#l73.726"></a><span id="l73.726" class="difflineplus">+  {</span>
<a href="#l73.727"></a><span id="l73.727" class="difflineplus">+    char storeToken[100];</span>
<a href="#l73.728"></a><span id="l73.728" class="difflineplus">+    PR_snprintf(storeToken, sizeof(storeToken), &quot;%lld&quot;, mboxSize);</span>
<a href="#l73.729"></a><span id="l73.729" class="difflineplus">+    (*aNewMsgHdr)-&gt;SetMessageOffset(mboxSize);</span>
<a href="#l73.730"></a><span id="l73.730" class="difflineplus">+    (*aNewMsgHdr)-&gt;SetStringProperty(&quot;storeToken&quot;, storeToken);</span>
<a href="#l73.731"></a><span id="l73.731" class="difflineplus">+  }</span>
<a href="#l73.732"></a><span id="l73.732" class="difflineplus">+  nsCString URI;</span>
<a href="#l73.733"></a><span id="l73.733" class="difflineplus">+  aFolder-&gt;GetURI(URI);</span>
<a href="#l73.734"></a><span id="l73.734" class="difflineplus">+  nsresult rv;</span>
<a href="#l73.735"></a><span id="l73.735" class="difflineplus">+  if (m_outputStreams.Get(URI, aResult))</span>
<a href="#l73.736"></a><span id="l73.736" class="difflineplus">+  {</span>
<a href="#l73.737"></a><span id="l73.737" class="difflineplus">+    nsCOMPtr&lt;nsISeekableStream&gt; seekable(do_QueryInterface(*aResult, &amp;rv));</span>
<a href="#l73.738"></a><span id="l73.738" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.739"></a><span id="l73.739" class="difflineplus">+    rv = seekable-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l73.740"></a><span id="l73.740" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l73.741"></a><span id="l73.741" class="difflineplus">+      return NS_OK;</span>
<a href="#l73.742"></a><span id="l73.742" class="difflineplus">+    m_outputStreams.Remove(URI);</span>
<a href="#l73.743"></a><span id="l73.743" class="difflineplus">+    NS_RELEASE(*aResult);</span>
<a href="#l73.744"></a><span id="l73.744" class="difflineplus">+  }</span>
<a href="#l73.745"></a><span id="l73.745" class="difflineplus">+  rv = MsgNewBufferedFileOutputStream(aResult, mboxFile,</span>
<a href="#l73.746"></a><span id="l73.746" class="difflineplus">+                                      PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l73.747"></a><span id="l73.747" class="difflineplus">+  NS_ASSERTION(NS_SUCCEEDED(rv), &quot;failed opening offline store for output&quot;);</span>
<a href="#l73.748"></a><span id="l73.748" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l73.749"></a><span id="l73.749" class="difflineplus">+    printf(&quot;failed opening offline store for %s\n&quot;, URI.get());</span>
<a href="#l73.750"></a><span id="l73.750" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.751"></a><span id="l73.751" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekable(do_QueryInterface(*aResult, &amp;rv));</span>
<a href="#l73.752"></a><span id="l73.752" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.753"></a><span id="l73.753" class="difflineplus">+  rv = seekable-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l73.754"></a><span id="l73.754" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.755"></a><span id="l73.755" class="difflineplus">+  m_outputStreams.Put(URI, *aResult);</span>
<a href="#l73.756"></a><span id="l73.756" class="difflineplus">+  return rv;</span>
<a href="#l73.757"></a><span id="l73.757" class="difflineplus">+}</span>
<a href="#l73.758"></a><span id="l73.758" class="difflineplus">+</span>
<a href="#l73.759"></a><span id="l73.759" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l73.760"></a><span id="l73.760" class="difflineplus">+nsMsgBrkMBoxStore::DiscardNewMessage(nsIOutputStream *aOutputStream,</span>
<a href="#l73.761"></a><span id="l73.761" class="difflineplus">+                                     nsIMsgDBHdr *aNewHdr)</span>
<a href="#l73.762"></a><span id="l73.762" class="difflineplus">+{</span>
<a href="#l73.763"></a><span id="l73.763" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aOutputStream);</span>
<a href="#l73.764"></a><span id="l73.764" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNewHdr);</span>
<a href="#l73.765"></a><span id="l73.765" class="difflineplus">+#ifdef _DEBUG</span>
<a href="#l73.766"></a><span id="l73.766" class="difflineplus">+  m_streamOutstandingFolder = nsnull;</span>
<a href="#l73.767"></a><span id="l73.767" class="difflineplus">+#endif</span>
<a href="#l73.768"></a><span id="l73.768" class="difflineplus">+  PRUint64 hdrOffset;</span>
<a href="#l73.769"></a><span id="l73.769" class="difflineplus">+  aNewHdr-&gt;GetMessageOffset(&amp;hdrOffset);</span>
<a href="#l73.770"></a><span id="l73.770" class="difflineplus">+  aOutputStream-&gt;Close();</span>
<a href="#l73.771"></a><span id="l73.771" class="difflineplus">+  if (hdrOffset != 0)</span>
<a href="#l73.772"></a><span id="l73.772" class="difflineplus">+  {</span>
<a href="#l73.773"></a><span id="l73.773" class="difflineplus">+    nsCOMPtr&lt;nsILocalFile&gt; mboxFile;</span>
<a href="#l73.774"></a><span id="l73.774" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l73.775"></a><span id="l73.775" class="difflineplus">+    nsresult rv = aNewHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l73.776"></a><span id="l73.776" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.777"></a><span id="l73.777" class="difflineplus">+    folder-&gt;GetFilePath(getter_AddRefs(mboxFile));</span>
<a href="#l73.778"></a><span id="l73.778" class="difflineplus">+    rv = mboxFile-&gt;SetFileSize(hdrOffset);</span>
<a href="#l73.779"></a><span id="l73.779" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.780"></a><span id="l73.780" class="difflineplus">+  }</span>
<a href="#l73.781"></a><span id="l73.781" class="difflineplus">+  return NS_OK;</span>
<a href="#l73.782"></a><span id="l73.782" class="difflineplus">+}</span>
<a href="#l73.783"></a><span id="l73.783" class="difflineplus">+</span>
<a href="#l73.784"></a><span id="l73.784" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l73.785"></a><span id="l73.785" class="difflineplus">+nsMsgBrkMBoxStore::FinishNewMessage(nsIOutputStream *aOutputStream,</span>
<a href="#l73.786"></a><span id="l73.786" class="difflineplus">+                                     nsIMsgDBHdr *aNewHdr)</span>
<a href="#l73.787"></a><span id="l73.787" class="difflineplus">+{</span>
<a href="#l73.788"></a><span id="l73.788" class="difflineplus">+#ifdef _DEBUG</span>
<a href="#l73.789"></a><span id="l73.789" class="difflineplus">+  m_streamOutstandingFolder = nsnull;</span>
<a href="#l73.790"></a><span id="l73.790" class="difflineplus">+#endif</span>
<a href="#l73.791"></a><span id="l73.791" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aOutputStream);</span>
<a href="#l73.792"></a><span id="l73.792" class="difflineplus">+//  NS_ENSURE_ARG_POINTER(aNewHdr);</span>
<a href="#l73.793"></a><span id="l73.793" class="difflineplus">+  return NS_OK;</span>
<a href="#l73.794"></a><span id="l73.794" class="difflineplus">+}</span>
<a href="#l73.795"></a><span id="l73.795" class="difflineplus">+</span>
<a href="#l73.796"></a><span id="l73.796" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l73.797"></a><span id="l73.797" class="difflineplus">+nsMsgBrkMBoxStore::MoveNewlyDownloadedMessage(nsIMsgDBHdr *aNewHdr,</span>
<a href="#l73.798"></a><span id="l73.798" class="difflineplus">+                                              nsIMsgFolder *aDestFolder,</span>
<a href="#l73.799"></a><span id="l73.799" class="difflineplus">+                                              bool *aResult)</span>
<a href="#l73.800"></a><span id="l73.800" class="difflineplus">+{</span>
<a href="#l73.801"></a><span id="l73.801" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNewHdr);</span>
<a href="#l73.802"></a><span id="l73.802" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDestFolder);</span>
<a href="#l73.803"></a><span id="l73.803" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l73.804"></a><span id="l73.804" class="difflineplus">+  *aResult = false;</span>
<a href="#l73.805"></a><span id="l73.805" class="difflineplus">+  return NS_OK;</span>
<a href="#l73.806"></a><span id="l73.806" class="difflineplus">+}</span>
<a href="#l73.807"></a><span id="l73.807" class="difflineplus">+</span>
<a href="#l73.808"></a><span id="l73.808" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l73.809"></a><span id="l73.809" class="difflineplus">+nsMsgBrkMBoxStore::GetMsgInputStream(nsIMsgFolder *aMsgFolder,</span>
<a href="#l73.810"></a><span id="l73.810" class="difflineplus">+                                     const nsACString &amp;aMsgToken,</span>
<a href="#l73.811"></a><span id="l73.811" class="difflineplus">+                                     PRInt64 *aOffset,</span>
<a href="#l73.812"></a><span id="l73.812" class="difflineplus">+                                     nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l73.813"></a><span id="l73.813" class="difflineplus">+                                     bool *aReusable NS_OUTPARAM,</span>
<a href="#l73.814"></a><span id="l73.814" class="difflineplus">+                                     nsIInputStream **aResult NS_OUTPARAM)</span>
<a href="#l73.815"></a><span id="l73.815" class="difflineplus">+{</span>
<a href="#l73.816"></a><span id="l73.816" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMsgFolder);</span>
<a href="#l73.817"></a><span id="l73.817" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l73.818"></a><span id="l73.818" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aOffset);</span>
<a href="#l73.819"></a><span id="l73.819" class="difflineplus">+</span>
<a href="#l73.820"></a><span id="l73.820" class="difflineplus">+  // If there is no store token, then we set it to the existing message offset.</span>
<a href="#l73.821"></a><span id="l73.821" class="difflineplus">+  if (aMsgToken.IsEmpty())</span>
<a href="#l73.822"></a><span id="l73.822" class="difflineplus">+  {</span>
<a href="#l73.823"></a><span id="l73.823" class="difflineplus">+    PRUint64 offset;</span>
<a href="#l73.824"></a><span id="l73.824" class="difflineplus">+    NS_ENSURE_ARG_POINTER(aMsgHdr);</span>
<a href="#l73.825"></a><span id="l73.825" class="difflineplus">+    aMsgHdr-&gt;GetMessageOffset(&amp;offset);</span>
<a href="#l73.826"></a><span id="l73.826" class="difflineplus">+    *aOffset = PRInt64(offset);</span>
<a href="#l73.827"></a><span id="l73.827" class="difflineplus">+    char storeToken[100];</span>
<a href="#l73.828"></a><span id="l73.828" class="difflineplus">+    PR_snprintf(storeToken, sizeof(storeToken), &quot;%lld&quot;, *aOffset);</span>
<a href="#l73.829"></a><span id="l73.829" class="difflineplus">+    aMsgHdr-&gt;SetStringProperty(&quot;storeToken&quot;, storeToken);</span>
<a href="#l73.830"></a><span id="l73.830" class="difflineplus">+  }</span>
<a href="#l73.831"></a><span id="l73.831" class="difflineplus">+  else</span>
<a href="#l73.832"></a><span id="l73.832" class="difflineplus">+    *aOffset = ParseUint64Str(PromiseFlatCString(aMsgToken).get());</span>
<a href="#l73.833"></a><span id="l73.833" class="difflineplus">+  *aReusable = true;</span>
<a href="#l73.834"></a><span id="l73.834" class="difflineplus">+  nsCString URI;</span>
<a href="#l73.835"></a><span id="l73.835" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; mboxFile;</span>
<a href="#l73.836"></a><span id="l73.836" class="difflineplus">+</span>
<a href="#l73.837"></a><span id="l73.837" class="difflineplus">+  aMsgFolder-&gt;GetURI(URI);</span>
<a href="#l73.838"></a><span id="l73.838" class="difflineplus">+  aMsgFolder-&gt;GetFilePath(getter_AddRefs(mboxFile));</span>
<a href="#l73.839"></a><span id="l73.839" class="difflineplus">+  return NS_NewLocalFileInputStream(aResult, mboxFile);</span>
<a href="#l73.840"></a><span id="l73.840" class="difflineplus">+}</span>
<a href="#l73.841"></a><span id="l73.841" class="difflineplus">+</span>
<a href="#l73.842"></a><span id="l73.842" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::DeleteMessages(nsIArray *aHdrArray)</span>
<a href="#l73.843"></a><span id="l73.843" class="difflineplus">+{</span>
<a href="#l73.844"></a><span id="l73.844" class="difflineplus">+  return ChangeFlags(aHdrArray, nsMsgMessageFlags::Expunged, true);</span>
<a href="#l73.845"></a><span id="l73.845" class="difflineplus">+}</span>
<a href="#l73.846"></a><span id="l73.846" class="difflineplus">+</span>
<a href="#l73.847"></a><span id="l73.847" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l73.848"></a><span id="l73.848" class="difflineplus">+nsMsgBrkMBoxStore::CopyMessages(bool isMove, nsIArray *aHdrArray,</span>
<a href="#l73.849"></a><span id="l73.849" class="difflineplus">+                               nsIMsgFolder *aDstFolder,</span>
<a href="#l73.850"></a><span id="l73.850" class="difflineplus">+                               nsIMsgCopyServiceListener *aListener,</span>
<a href="#l73.851"></a><span id="l73.851" class="difflineplus">+                               bool *aCopyDone)</span>
<a href="#l73.852"></a><span id="l73.852" class="difflineplus">+{</span>
<a href="#l73.853"></a><span id="l73.853" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aHdrArray);</span>
<a href="#l73.854"></a><span id="l73.854" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDstFolder);</span>
<a href="#l73.855"></a><span id="l73.855" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCopyDone);</span>
<a href="#l73.856"></a><span id="l73.856" class="difflineplus">+  *aCopyDone = false;</span>
<a href="#l73.857"></a><span id="l73.857" class="difflineplus">+  return NS_OK;</span>
<a href="#l73.858"></a><span id="l73.858" class="difflineplus">+}</span>
<a href="#l73.859"></a><span id="l73.859" class="difflineplus">+</span>
<a href="#l73.860"></a><span id="l73.860" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l73.861"></a><span id="l73.861" class="difflineplus">+nsMsgBrkMBoxStore::GetSupportsCompaction(bool *aSupportsCompaction)</span>
<a href="#l73.862"></a><span id="l73.862" class="difflineplus">+{</span>
<a href="#l73.863"></a><span id="l73.863" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSupportsCompaction);</span>
<a href="#l73.864"></a><span id="l73.864" class="difflineplus">+  *aSupportsCompaction = true;</span>
<a href="#l73.865"></a><span id="l73.865" class="difflineplus">+  return NS_OK;</span>
<a href="#l73.866"></a><span id="l73.866" class="difflineplus">+}</span>
<a href="#l73.867"></a><span id="l73.867" class="difflineplus">+</span>
<a href="#l73.868"></a><span id="l73.868" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::CompactFolder(nsIMsgFolder *aFolder,</span>
<a href="#l73.869"></a><span id="l73.869" class="difflineplus">+                                               nsIUrlListener *aListener,</span>
<a href="#l73.870"></a><span id="l73.870" class="difflineplus">+                                               nsIMsgWindow *aMsgWindow)</span>
<a href="#l73.871"></a><span id="l73.871" class="difflineplus">+{</span>
<a href="#l73.872"></a><span id="l73.872" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l73.873"></a><span id="l73.873" class="difflineplus">+  nsresult rv;</span>
<a href="#l73.874"></a><span id="l73.874" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderCompactor&gt; folderCompactor =</span>
<a href="#l73.875"></a><span id="l73.875" class="difflineplus">+    do_CreateInstance(NS_MSGLOCALFOLDERCOMPACTOR_CONTRACTID, &amp;rv);</span>
<a href="#l73.876"></a><span id="l73.876" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.877"></a><span id="l73.877" class="difflineplus">+</span>
<a href="#l73.878"></a><span id="l73.878" class="difflineplus">+  PRUint32 expungedBytes = 0;</span>
<a href="#l73.879"></a><span id="l73.879" class="difflineplus">+  aFolder-&gt;GetExpungedBytes(&amp;expungedBytes);</span>
<a href="#l73.880"></a><span id="l73.880" class="difflineplus">+  // check if we need to compact the folder</span>
<a href="#l73.881"></a><span id="l73.881" class="difflineplus">+  return (expungedBytes &gt; 0) ?</span>
<a href="#l73.882"></a><span id="l73.882" class="difflineplus">+    folderCompactor-&gt;Compact(aFolder, false, aListener, aMsgWindow) :</span>
<a href="#l73.883"></a><span id="l73.883" class="difflineplus">+    aFolder-&gt;NotifyCompactCompleted();</span>
<a href="#l73.884"></a><span id="l73.884" class="difflineplus">+}</span>
<a href="#l73.885"></a><span id="l73.885" class="difflineplus">+</span>
<a href="#l73.886"></a><span id="l73.886" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::RebuildIndex(nsIMsgFolder *aFolder,</span>
<a href="#l73.887"></a><span id="l73.887" class="difflineplus">+                                              nsIMsgDatabase *aMsgDB,</span>
<a href="#l73.888"></a><span id="l73.888" class="difflineplus">+                                              nsIMsgWindow *aMsgWindow,</span>
<a href="#l73.889"></a><span id="l73.889" class="difflineplus">+                                              nsIUrlListener *aListener)</span>
<a href="#l73.890"></a><span id="l73.890" class="difflineplus">+{</span>
<a href="#l73.891"></a><span id="l73.891" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l73.892"></a><span id="l73.892" class="difflineplus">+  // We don't use aMsgDB, but I think nsMsgMailDirStore needs it.</span>
<a href="#l73.893"></a><span id="l73.893" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; pathFile;</span>
<a href="#l73.894"></a><span id="l73.894" class="difflineplus">+  nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l73.895"></a><span id="l73.895" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l73.896"></a><span id="l73.896" class="difflineplus">+    return rv;</span>
<a href="#l73.897"></a><span id="l73.897" class="difflineplus">+</span>
<a href="#l73.898"></a><span id="l73.898" class="difflineplus">+  bool isLocked;</span>
<a href="#l73.899"></a><span id="l73.899" class="difflineplus">+  aFolder-&gt;GetLocked(&amp;isLocked);</span>
<a href="#l73.900"></a><span id="l73.900" class="difflineplus">+  if (isLocked)</span>
<a href="#l73.901"></a><span id="l73.901" class="difflineplus">+  {</span>
<a href="#l73.902"></a><span id="l73.902" class="difflineplus">+    NS_ASSERTION(false, &quot;Could not get folder lock&quot;);</span>
<a href="#l73.903"></a><span id="l73.903" class="difflineplus">+    return NS_MSG_FOLDER_BUSY;</span>
<a href="#l73.904"></a><span id="l73.904" class="difflineplus">+  }</span>
<a href="#l73.905"></a><span id="l73.905" class="difflineplus">+</span>
<a href="#l73.906"></a><span id="l73.906" class="difflineplus">+  nsCOMPtr&lt;nsIMailboxService&gt; mailboxService =</span>
<a href="#l73.907"></a><span id="l73.907" class="difflineplus">+    do_GetService(NS_MAILBOXSERVICE_CONTRACTID1, &amp;rv);</span>
<a href="#l73.908"></a><span id="l73.908" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.909"></a><span id="l73.909" class="difflineplus">+</span>
<a href="#l73.910"></a><span id="l73.910" class="difflineplus">+  nsRefPtr&lt;nsMsgMailboxParser&gt; parser = new nsMsgMailboxParser(aFolder);</span>
<a href="#l73.911"></a><span id="l73.911" class="difflineplus">+  NS_ENSURE_TRUE(parser, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l73.912"></a><span id="l73.912" class="difflineplus">+  rv = parser-&gt;Init();</span>
<a href="#l73.913"></a><span id="l73.913" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.914"></a><span id="l73.914" class="difflineplus">+</span>
<a href="#l73.915"></a><span id="l73.915" class="difflineplus">+  return mailboxService-&gt;ParseMailbox(aMsgWindow, pathFile, parser, aListener,</span>
<a href="#l73.916"></a><span id="l73.916" class="difflineplus">+                                      nsnull);</span>
<a href="#l73.917"></a><span id="l73.917" class="difflineplus">+}</span>
<a href="#l73.918"></a><span id="l73.918" class="difflineplus">+</span>
<a href="#l73.919"></a><span id="l73.919" class="difflineplus">+nsresult</span>
<a href="#l73.920"></a><span id="l73.920" class="difflineplus">+nsMsgBrkMBoxStore::GetOutputStream(nsIArray *aHdrArray,</span>
<a href="#l73.921"></a><span id="l73.921" class="difflineplus">+                                   nsCOMPtr&lt;nsIOutputStream&gt; &amp;outputStream,</span>
<a href="#l73.922"></a><span id="l73.922" class="difflineplus">+                                   nsCOMPtr&lt;nsISeekableStream&gt; &amp;seekableStream,</span>
<a href="#l73.923"></a><span id="l73.923" class="difflineplus">+                                   PRInt64 &amp;restorePos)</span>
<a href="#l73.924"></a><span id="l73.924" class="difflineplus">+{</span>
<a href="#l73.925"></a><span id="l73.925" class="difflineplus">+  nsresult rv;</span>
<a href="#l73.926"></a><span id="l73.926" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(aHdrArray, 0, &amp;rv);</span>
<a href="#l73.927"></a><span id="l73.927" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.928"></a><span id="l73.928" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l73.929"></a><span id="l73.929" class="difflineplus">+  msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l73.930"></a><span id="l73.930" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.931"></a><span id="l73.931" class="difflineplus">+  nsCString URI;</span>
<a href="#l73.932"></a><span id="l73.932" class="difflineplus">+  folder-&gt;GetURI(URI);</span>
<a href="#l73.933"></a><span id="l73.933" class="difflineplus">+  restorePos = -1;</span>
<a href="#l73.934"></a><span id="l73.934" class="difflineplus">+  if (m_outputStreams.Get(URI, getter_AddRefs(outputStream)))</span>
<a href="#l73.935"></a><span id="l73.935" class="difflineplus">+  {</span>
<a href="#l73.936"></a><span id="l73.936" class="difflineplus">+    seekableStream = do_QueryInterface(outputStream);</span>
<a href="#l73.937"></a><span id="l73.937" class="difflineplus">+    rv = seekableStream-&gt;Tell(&amp;restorePos);</span>
<a href="#l73.938"></a><span id="l73.938" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l73.939"></a><span id="l73.939" class="difflineplus">+    {</span>
<a href="#l73.940"></a><span id="l73.940" class="difflineplus">+      outputStream = nsnull;</span>
<a href="#l73.941"></a><span id="l73.941" class="difflineplus">+      m_outputStreams.Remove(URI);</span>
<a href="#l73.942"></a><span id="l73.942" class="difflineplus">+    }</span>
<a href="#l73.943"></a><span id="l73.943" class="difflineplus">+  }</span>
<a href="#l73.944"></a><span id="l73.944" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; mboxFile;</span>
<a href="#l73.945"></a><span id="l73.945" class="difflineplus">+  folder-&gt;GetFilePath(getter_AddRefs(mboxFile));</span>
<a href="#l73.946"></a><span id="l73.946" class="difflineplus">+  if (!outputStream)</span>
<a href="#l73.947"></a><span id="l73.947" class="difflineplus">+  {</span>
<a href="#l73.948"></a><span id="l73.948" class="difflineplus">+    rv = MsgGetFileStream(mboxFile, getter_AddRefs(outputStream));</span>
<a href="#l73.949"></a><span id="l73.949" class="difflineplus">+    seekableStream = do_QueryInterface(outputStream);</span>
<a href="#l73.950"></a><span id="l73.950" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l73.951"></a><span id="l73.951" class="difflineplus">+      m_outputStreams.Put(URI, outputStream);</span>
<a href="#l73.952"></a><span id="l73.952" class="difflineplus">+  }</span>
<a href="#l73.953"></a><span id="l73.953" class="difflineplus">+  return rv;</span>
<a href="#l73.954"></a><span id="l73.954" class="difflineplus">+}</span>
<a href="#l73.955"></a><span id="l73.955" class="difflineplus">+</span>
<a href="#l73.956"></a><span id="l73.956" class="difflineplus">+void nsMsgBrkMBoxStore::SetDBValid(nsIMsgDBHdr *aHdr)</span>
<a href="#l73.957"></a><span id="l73.957" class="difflineplus">+{</span>
<a href="#l73.958"></a><span id="l73.958" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l73.959"></a><span id="l73.959" class="difflineplus">+  aHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l73.960"></a><span id="l73.960" class="difflineplus">+  if (folder)</span>
<a href="#l73.961"></a><span id="l73.961" class="difflineplus">+  {</span>
<a href="#l73.962"></a><span id="l73.962" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l73.963"></a><span id="l73.963" class="difflineplus">+    folder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l73.964"></a><span id="l73.964" class="difflineplus">+    if (db)</span>
<a href="#l73.965"></a><span id="l73.965" class="difflineplus">+      SetSummaryFileValid(folder, db, true);</span>
<a href="#l73.966"></a><span id="l73.966" class="difflineplus">+  }</span>
<a href="#l73.967"></a><span id="l73.967" class="difflineplus">+}</span>
<a href="#l73.968"></a><span id="l73.968" class="difflineplus">+</span>
<a href="#l73.969"></a><span id="l73.969" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::ChangeFlags(nsIArray *aHdrArray,</span>
<a href="#l73.970"></a><span id="l73.970" class="difflineplus">+                                             PRUint32 aFlags,</span>
<a href="#l73.971"></a><span id="l73.971" class="difflineplus">+                                             bool aSet)</span>
<a href="#l73.972"></a><span id="l73.972" class="difflineplus">+{</span>
<a href="#l73.973"></a><span id="l73.973" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aHdrArray);</span>
<a href="#l73.974"></a><span id="l73.974" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l73.975"></a><span id="l73.975" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream;</span>
<a href="#l73.976"></a><span id="l73.976" class="difflineplus">+  PRInt64 restoreStreamPos;</span>
<a href="#l73.977"></a><span id="l73.977" class="difflineplus">+</span>
<a href="#l73.978"></a><span id="l73.978" class="difflineplus">+  PRUint32 messageCount;</span>
<a href="#l73.979"></a><span id="l73.979" class="difflineplus">+  nsresult rv = aHdrArray-&gt;GetLength(&amp;messageCount);</span>
<a href="#l73.980"></a><span id="l73.980" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.981"></a><span id="l73.981" class="difflineplus">+  if (!messageCount)</span>
<a href="#l73.982"></a><span id="l73.982" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l73.983"></a><span id="l73.983" class="difflineplus">+</span>
<a href="#l73.984"></a><span id="l73.984" class="difflineplus">+  rv = GetOutputStream(aHdrArray, outputStream, seekableStream,</span>
<a href="#l73.985"></a><span id="l73.985" class="difflineplus">+                       restoreStreamPos);</span>
<a href="#l73.986"></a><span id="l73.986" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.987"></a><span id="l73.987" class="difflineplus">+</span>
<a href="#l73.988"></a><span id="l73.988" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l73.989"></a><span id="l73.989" class="difflineplus">+  for (PRUint32 i = 0; i &lt; messageCount; i++)</span>
<a href="#l73.990"></a><span id="l73.990" class="difflineplus">+  {</span>
<a href="#l73.991"></a><span id="l73.991" class="difflineplus">+    msgHdr = do_QueryElementAt(aHdrArray, i, &amp;rv);</span>
<a href="#l73.992"></a><span id="l73.992" class="difflineplus">+    // Seek to x-mozilla-status offset and rewrite value.</span>
<a href="#l73.993"></a><span id="l73.993" class="difflineplus">+    rv = UpdateFolderFlag(msgHdr, aSet, aFlags, outputStream);</span>
<a href="#l73.994"></a><span id="l73.994" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l73.995"></a><span id="l73.995" class="difflineplus">+    {</span>
<a href="#l73.996"></a><span id="l73.996" class="difflineplus">+      NS_WARNING(&quot;updateFolderFlag failed&quot;);</span>
<a href="#l73.997"></a><span id="l73.997" class="difflineplus">+      break;</span>
<a href="#l73.998"></a><span id="l73.998" class="difflineplus">+    }</span>
<a href="#l73.999"></a><span id="l73.999" class="difflineplus">+  }</span>
<a href="#l73.1000"></a><span id="l73.1000" class="difflineplus">+  if (restoreStreamPos != -1)</span>
<a href="#l73.1001"></a><span id="l73.1001" class="difflineplus">+    seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, restoreStreamPos);</span>
<a href="#l73.1002"></a><span id="l73.1002" class="difflineplus">+  else if (outputStream)</span>
<a href="#l73.1003"></a><span id="l73.1003" class="difflineplus">+    outputStream-&gt;Close();</span>
<a href="#l73.1004"></a><span id="l73.1004" class="difflineplus">+  if (messageCount &gt; 0)</span>
<a href="#l73.1005"></a><span id="l73.1005" class="difflineplus">+  {</span>
<a href="#l73.1006"></a><span id="l73.1006" class="difflineplus">+    msgHdr = do_QueryElementAt(aHdrArray, 0);</span>
<a href="#l73.1007"></a><span id="l73.1007" class="difflineplus">+    SetDBValid(msgHdr);</span>
<a href="#l73.1008"></a><span id="l73.1008" class="difflineplus">+  }</span>
<a href="#l73.1009"></a><span id="l73.1009" class="difflineplus">+  return NS_OK;</span>
<a href="#l73.1010"></a><span id="l73.1010" class="difflineplus">+}</span>
<a href="#l73.1011"></a><span id="l73.1011" class="difflineplus">+</span>
<a href="#l73.1012"></a><span id="l73.1012" class="difflineplus">+NS_IMETHODIMP nsMsgBrkMBoxStore::ChangeKeywords(nsIArray *aHdrArray,</span>
<a href="#l73.1013"></a><span id="l73.1013" class="difflineplus">+                                             const nsACString &amp;aKeywords,</span>
<a href="#l73.1014"></a><span id="l73.1014" class="difflineplus">+                                             bool aAdd)</span>
<a href="#l73.1015"></a><span id="l73.1015" class="difflineplus">+{</span>
<a href="#l73.1016"></a><span id="l73.1016" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aHdrArray);</span>
<a href="#l73.1017"></a><span id="l73.1017" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l73.1018"></a><span id="l73.1018" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream;</span>
<a href="#l73.1019"></a><span id="l73.1019" class="difflineplus">+  PRInt64 restoreStreamPos;</span>
<a href="#l73.1020"></a><span id="l73.1020" class="difflineplus">+</span>
<a href="#l73.1021"></a><span id="l73.1021" class="difflineplus">+  PRUint32 messageCount;</span>
<a href="#l73.1022"></a><span id="l73.1022" class="difflineplus">+  nsresult rv = aHdrArray-&gt;GetLength(&amp;messageCount);</span>
<a href="#l73.1023"></a><span id="l73.1023" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.1024"></a><span id="l73.1024" class="difflineplus">+  if (!messageCount)</span>
<a href="#l73.1025"></a><span id="l73.1025" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l73.1026"></a><span id="l73.1026" class="difflineplus">+</span>
<a href="#l73.1027"></a><span id="l73.1027" class="difflineplus">+  rv = GetOutputStream(aHdrArray, outputStream, seekableStream,</span>
<a href="#l73.1028"></a><span id="l73.1028" class="difflineplus">+                       restoreStreamPos);</span>
<a href="#l73.1029"></a><span id="l73.1029" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.1030"></a><span id="l73.1030" class="difflineplus">+</span>
<a href="#l73.1031"></a><span id="l73.1031" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; inputStream = do_QueryInterface(outputStream, &amp;rv);</span>
<a href="#l73.1032"></a><span id="l73.1032" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.1033"></a><span id="l73.1033" class="difflineplus">+</span>
<a href="#l73.1034"></a><span id="l73.1034" class="difflineplus">+  nsLineBuffer&lt;char&gt; *lineBuffer;</span>
<a href="#l73.1035"></a><span id="l73.1035" class="difflineplus">+  rv = NS_InitLineBuffer(&amp;lineBuffer);</span>
<a href="#l73.1036"></a><span id="l73.1036" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.1037"></a><span id="l73.1037" class="difflineplus">+</span>
<a href="#l73.1038"></a><span id="l73.1038" class="difflineplus">+  // For each message, we seek to the beginning of the x-mozilla-status header,</span>
<a href="#l73.1039"></a><span id="l73.1039" class="difflineplus">+  // and start reading lines, looking for x-mozilla-keys: headers; If we're</span>
<a href="#l73.1040"></a><span id="l73.1040" class="difflineplus">+  // adding the keyword and we find</span>
<a href="#l73.1041"></a><span id="l73.1041" class="difflineplus">+  // a header with the desired keyword already in it, we don't need to</span>
<a href="#l73.1042"></a><span id="l73.1042" class="difflineplus">+  // do anything. Likewise, if removing keyword and we don't find it,</span>
<a href="#l73.1043"></a><span id="l73.1043" class="difflineplus">+  // we don't need to do anything. Otherwise, if adding, we need to</span>
<a href="#l73.1044"></a><span id="l73.1044" class="difflineplus">+  // see if there's an x-mozilla-keys</span>
<a href="#l73.1045"></a><span id="l73.1045" class="difflineplus">+  // header with room for the new keyword. If so, we replace the</span>
<a href="#l73.1046"></a><span id="l73.1046" class="difflineplus">+  // corresponding number of spaces with the keyword. If no room,</span>
<a href="#l73.1047"></a><span id="l73.1047" class="difflineplus">+  // we can't do anything until the folder is compacted and another</span>
<a href="#l73.1048"></a><span id="l73.1048" class="difflineplus">+  // x-mozilla-keys header is added. In that case, we set a property</span>
<a href="#l73.1049"></a><span id="l73.1049" class="difflineplus">+  // on the header, which the compaction code will check.</span>
<a href="#l73.1050"></a><span id="l73.1050" class="difflineplus">+</span>
<a href="#l73.1051"></a><span id="l73.1051" class="difflineplus">+  nsTArray&lt;nsCString&gt; keywordArray;</span>
<a href="#l73.1052"></a><span id="l73.1052" class="difflineplus">+  ParseString(aKeywords, ' ', keywordArray);</span>
<a href="#l73.1053"></a><span id="l73.1053" class="difflineplus">+</span>
<a href="#l73.1054"></a><span id="l73.1054" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l73.1055"></a><span id="l73.1055" class="difflineplus">+  for (PRUint32 i = 0; i &lt; messageCount; ++i) // for each message</span>
<a href="#l73.1056"></a><span id="l73.1056" class="difflineplus">+  {</span>
<a href="#l73.1057"></a><span id="l73.1057" class="difflineplus">+    msgHdr = do_QueryElementAt(aHdrArray, i, &amp;rv);</span>
<a href="#l73.1058"></a><span id="l73.1058" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.1059"></a><span id="l73.1059" class="difflineplus">+    PRUint64 messageOffset;</span>
<a href="#l73.1060"></a><span id="l73.1060" class="difflineplus">+    msgHdr-&gt;GetMessageOffset(&amp;messageOffset);</span>
<a href="#l73.1061"></a><span id="l73.1061" class="difflineplus">+    PRUint32 statusOffset = 0;</span>
<a href="#l73.1062"></a><span id="l73.1062" class="difflineplus">+    (void)msgHdr-&gt;GetStatusOffset(&amp;statusOffset);</span>
<a href="#l73.1063"></a><span id="l73.1063" class="difflineplus">+    PRUint64 desiredOffset = messageOffset + statusOffset;</span>
<a href="#l73.1064"></a><span id="l73.1064" class="difflineplus">+</span>
<a href="#l73.1065"></a><span id="l73.1065" class="difflineplus">+    ChangeKeywordsHelper(msgHdr, desiredOffset, lineBuffer, keywordArray,</span>
<a href="#l73.1066"></a><span id="l73.1066" class="difflineplus">+                         aAdd, outputStream, seekableStream, inputStream);</span>
<a href="#l73.1067"></a><span id="l73.1067" class="difflineplus">+  }</span>
<a href="#l73.1068"></a><span id="l73.1068" class="difflineplus">+  PR_Free(lineBuffer);</span>
<a href="#l73.1069"></a><span id="l73.1069" class="difflineplus">+  if (restoreStreamPos != -1)</span>
<a href="#l73.1070"></a><span id="l73.1070" class="difflineplus">+    seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, restoreStreamPos);</span>
<a href="#l73.1071"></a><span id="l73.1071" class="difflineplus">+  else if (outputStream)</span>
<a href="#l73.1072"></a><span id="l73.1072" class="difflineplus">+    outputStream-&gt;Close();</span>
<a href="#l73.1073"></a><span id="l73.1073" class="difflineplus">+  if (messageCount &gt; 0)</span>
<a href="#l73.1074"></a><span id="l73.1074" class="difflineplus">+  {</span>
<a href="#l73.1075"></a><span id="l73.1075" class="difflineplus">+    msgHdr = do_QueryElementAt(aHdrArray, 0);</span>
<a href="#l73.1076"></a><span id="l73.1076" class="difflineplus">+    SetDBValid(msgHdr);</span>
<a href="#l73.1077"></a><span id="l73.1077" class="difflineplus">+  }</span>
<a href="#l73.1078"></a><span id="l73.1078" class="difflineplus">+  return NS_OK;</span>
<a href="#l73.1079"></a><span id="l73.1079" class="difflineplus">+}</span>
<a href="#l73.1080"></a><span id="l73.1080" class="difflineplus">+</span>
<a href="#l73.1081"></a><span id="l73.1081" class="difflineplus">+// Iterates over the files in the &quot;path&quot; directory, and adds subfolders to</span>
<a href="#l73.1082"></a><span id="l73.1082" class="difflineplus">+// parent for each mailbox file found.</span>
<a href="#l73.1083"></a><span id="l73.1083" class="difflineplus">+nsresult</span>
<a href="#l73.1084"></a><span id="l73.1084" class="difflineplus">+nsMsgBrkMBoxStore::AddSubFolders(nsIMsgFolder *parent, nsIFile *path,</span>
<a href="#l73.1085"></a><span id="l73.1085" class="difflineplus">+                                 bool deep)</span>
<a href="#l73.1086"></a><span id="l73.1086" class="difflineplus">+{</span>
<a href="#l73.1087"></a><span id="l73.1087" class="difflineplus">+  // first find out all the current subfolders and files, before using them</span>
<a href="#l73.1088"></a><span id="l73.1088" class="difflineplus">+  // while creating new subfolders; we don't want to modify and iterate the same</span>
<a href="#l73.1089"></a><span id="l73.1089" class="difflineplus">+  // directory at once.</span>
<a href="#l73.1090"></a><span id="l73.1090" class="difflineplus">+  nsCOMArray&lt;nsIFile&gt; currentDirEntries;</span>
<a href="#l73.1091"></a><span id="l73.1091" class="difflineplus">+  bool isDirectory;</span>
<a href="#l73.1092"></a><span id="l73.1092" class="difflineplus">+  path-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l73.1093"></a><span id="l73.1093" class="difflineplus">+  if (!isDirectory)</span>
<a href="#l73.1094"></a><span id="l73.1094" class="difflineplus">+    return NS_OK;</span>
<a href="#l73.1095"></a><span id="l73.1095" class="difflineplus">+</span>
<a href="#l73.1096"></a><span id="l73.1096" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l73.1097"></a><span id="l73.1097" class="difflineplus">+  nsresult rv = path-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l73.1098"></a><span id="l73.1098" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l73.1099"></a><span id="l73.1099" class="difflineplus">+</span>
<a href="#l73.1100"></a><span id="l73.1100" class="difflineplus">+  bool hasMore;</span>
<a href="#l73.1101"></a><span id="l73.1101" class="difflineplus">+  while (NS_SUCCEEDED(directoryEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l73.1102"></a><span id="l73.1102" class="difflineplus">+         hasMore)</span>
<a href="#l73.1103"></a><span id="l73.1103" class="difflineplus">+  {</span>
<a href="#l73.1104"></a><span id="l73.1104" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l73.1105"></a><span id="l73.1105" class="difflineplus">+    directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l73.1106"></a><span id="l73.1106" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; currentFile(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l73.1107"></a><span id="l73.1107" class="difflineplus">+    if (currentFile)</span>
<a href="#l73.1108"></a><span id="l73.1108" class="difflineplus">+      currentDirEntries.AppendObject(currentFile);</span>
<a href="#l73.1109"></a><span id="l73.1109" class="difflineplus">+  }</span>
<a href="#l73.1110"></a><span id="l73.1110" class="difflineplus">+</span>
<a href="#l73.1111"></a><span id="l73.1111" class="difflineplus">+  // add the folders</span>
<a href="#l73.1112"></a><span id="l73.1112" class="difflineplus">+  PRInt32 count = currentDirEntries.Count();</span>
<a href="#l73.1113"></a><span id="l73.1113" class="difflineplus">+  for (PRInt32 i = 0; i &lt; count; ++i)</span>
<a href="#l73.1114"></a><span id="l73.1114" class="difflineplus">+  {</span>
<a href="#l73.1115"></a><span id="l73.1115" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; currentFile(currentDirEntries[i]);</span>
<a href="#l73.1116"></a><span id="l73.1116" class="difflineplus">+</span>
<a href="#l73.1117"></a><span id="l73.1117" class="difflineplus">+    nsAutoString leafName;</span>
<a href="#l73.1118"></a><span id="l73.1118" class="difflineplus">+    currentFile-&gt;GetLeafName(leafName);</span>
<a href="#l73.1119"></a><span id="l73.1119" class="difflineplus">+    directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l73.1120"></a><span id="l73.1120" class="difflineplus">+    // here we should handle the case where the current file is a .sbd directory</span>
<a href="#l73.1121"></a><span id="l73.1121" class="difflineplus">+    // w/o a matching folder file, or a directory w/o the name .sbd</span>
<a href="#l73.1122"></a><span id="l73.1122" class="difflineplus">+    if (nsShouldIgnoreFile(leafName))</span>
<a href="#l73.1123"></a><span id="l73.1123" class="difflineplus">+      continue;</span>
<a href="#l73.1124"></a><span id="l73.1124" class="difflineplus">+</span>
<a href="#l73.1125"></a><span id="l73.1125" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l73.1126"></a><span id="l73.1126" class="difflineplus">+    rv = parent-&gt;AddSubfolder(leafName, getter_AddRefs(child));</span>
<a href="#l73.1127"></a><span id="l73.1127" class="difflineplus">+    if (child)</span>
<a href="#l73.1128"></a><span id="l73.1128" class="difflineplus">+    {</span>
<a href="#l73.1129"></a><span id="l73.1129" class="difflineplus">+      nsString folderName;</span>
<a href="#l73.1130"></a><span id="l73.1130" class="difflineplus">+      child-&gt;GetName(folderName);  // try to get it from cache/db</span>
<a href="#l73.1131"></a><span id="l73.1131" class="difflineplus">+      if (folderName.IsEmpty())</span>
<a href="#l73.1132"></a><span id="l73.1132" class="difflineplus">+        child-&gt;SetPrettyName(leafName);</span>
<a href="#l73.1133"></a><span id="l73.1133" class="difflineplus">+      if (deep)</span>
<a href="#l73.1134"></a><span id="l73.1134" class="difflineplus">+      {</span>
<a href="#l73.1135"></a><span id="l73.1135" class="difflineplus">+        nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l73.1136"></a><span id="l73.1136" class="difflineplus">+        rv = child-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l73.1137"></a><span id="l73.1137" class="difflineplus">+        AddSubFolders(child, path, true);</span>
<a href="#l73.1138"></a><span id="l73.1138" class="difflineplus">+      }</span>
<a href="#l73.1139"></a><span id="l73.1139" class="difflineplus">+    }</span>
<a href="#l73.1140"></a><span id="l73.1140" class="difflineplus">+  }</span>
<a href="#l73.1141"></a><span id="l73.1141" class="difflineplus">+  return rv;</span>
<a href="#l73.1142"></a><span id="l73.1142" class="difflineplus">+}</span>
<a href="#l73.1143"></a><span id="l73.1143" class="difflineplus">+</span>
<a href="#l73.1144"></a><span id="l73.1144" class="difflineplus">+/* Finds the directory associated with this folder.  That is if the path is</span>
<a href="#l73.1145"></a><span id="l73.1145" class="difflineplus">+   c:\Inbox, it will return c:\Inbox.sbd if it succeeds.  If that path doesn't</span>
<a href="#l73.1146"></a><span id="l73.1146" class="difflineplus">+   currently exist then it will create it. Path is strictly an out parameter.</span>
<a href="#l73.1147"></a><span id="l73.1147" class="difflineplus">+  */</span>
<a href="#l73.1148"></a><span id="l73.1148" class="difflineplus">+nsresult nsMsgBrkMBoxStore::CreateDirectoryForFolder(nsILocalFile *path)</span>
<a href="#l73.1149"></a><span id="l73.1149" class="difflineplus">+{</span>
<a href="#l73.1150"></a><span id="l73.1150" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l73.1151"></a><span id="l73.1151" class="difflineplus">+</span>
<a href="#l73.1152"></a><span id="l73.1152" class="difflineplus">+  bool pathIsDirectory = false;</span>
<a href="#l73.1153"></a><span id="l73.1153" class="difflineplus">+  path-&gt;IsDirectory(&amp;pathIsDirectory);</span>
<a href="#l73.1154"></a><span id="l73.1154" class="difflineplus">+  if (!pathIsDirectory)</span>
<a href="#l73.1155"></a><span id="l73.1155" class="difflineplus">+  {</span>
<a href="#l73.1156"></a><span id="l73.1156" class="difflineplus">+    // If the current path isn't a directory, add directory separator</span>
<a href="#l73.1157"></a><span id="l73.1157" class="difflineplus">+    // and test it out.</span>
<a href="#l73.1158"></a><span id="l73.1158" class="difflineplus">+    nsAutoString leafName;</span>
<a href="#l73.1159"></a><span id="l73.1159" class="difflineplus">+    path-&gt;GetLeafName(leafName);</span>
<a href="#l73.1160"></a><span id="l73.1160" class="difflineplus">+    leafName.AppendLiteral(FOLDER_SUFFIX);</span>
<a href="#l73.1161"></a><span id="l73.1161" class="difflineplus">+    rv = path-&gt;SetLeafName(leafName);</span>
<a href="#l73.1162"></a><span id="l73.1162" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l73.1163"></a><span id="l73.1163" class="difflineplus">+      return rv;</span>
<a href="#l73.1164"></a><span id="l73.1164" class="difflineplus">+</span>
<a href="#l73.1165"></a><span id="l73.1165" class="difflineplus">+    //If that doesn't exist, then we have to create this directory</span>
<a href="#l73.1166"></a><span id="l73.1166" class="difflineplus">+    pathIsDirectory = false;</span>
<a href="#l73.1167"></a><span id="l73.1167" class="difflineplus">+    path-&gt;IsDirectory(&amp;pathIsDirectory);</span>
<a href="#l73.1168"></a><span id="l73.1168" class="difflineplus">+    if (!pathIsDirectory)</span>
<a href="#l73.1169"></a><span id="l73.1169" class="difflineplus">+    {</span>
<a href="#l73.1170"></a><span id="l73.1170" class="difflineplus">+      bool pathExists;</span>
<a href="#l73.1171"></a><span id="l73.1171" class="difflineplus">+      path-&gt;Exists(&amp;pathExists);</span>
<a href="#l73.1172"></a><span id="l73.1172" class="difflineplus">+      //If for some reason there's a file with the directory separator</span>
<a href="#l73.1173"></a><span id="l73.1173" class="difflineplus">+      //then we are going to fail.</span>
<a href="#l73.1174"></a><span id="l73.1174" class="difflineplus">+      rv = pathExists ? NS_MSG_COULD_NOT_CREATE_DIRECTORY :</span>
<a href="#l73.1175"></a><span id="l73.1175" class="difflineplus">+             path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l73.1176"></a><span id="l73.1176" class="difflineplus">+    }</span>
<a href="#l73.1177"></a><span id="l73.1177" class="difflineplus">+  }</span>
<a href="#l73.1178"></a><span id="l73.1178" class="difflineplus">+  return rv;</span>
<a href="#l73.1179"></a><span id="l73.1179" class="difflineplus">+}</span>
<a href="#l73.1180"></a><span id="l73.1180" class="difflineplus">+</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l74.1"></a><span id="l74.1">new file mode 100644</span>
<a href="#l74.2"></a><span id="l74.2" class="difflineminus">--- /dev/null</span>
<a href="#l74.3"></a><span id="l74.3" class="difflineplus">+++ b/mailnews/local/src/nsMsgBrkMBoxStore.h</span>
<a href="#l74.4"></a><span id="l74.4" class="difflineat">@@ -0,0 +1,82 @@</span>
<a href="#l74.5"></a><span id="l74.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l74.6"></a><span id="l74.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l74.7"></a><span id="l74.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l74.8"></a><span id="l74.8" class="difflineplus">+ *</span>
<a href="#l74.9"></a><span id="l74.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l74.10"></a><span id="l74.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l74.11"></a><span id="l74.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l74.12"></a><span id="l74.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l74.13"></a><span id="l74.13" class="difflineplus">+ *</span>
<a href="#l74.14"></a><span id="l74.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l74.15"></a><span id="l74.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l74.16"></a><span id="l74.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l74.17"></a><span id="l74.17" class="difflineplus">+ * License.</span>
<a href="#l74.18"></a><span id="l74.18" class="difflineplus">+ *</span>
<a href="#l74.19"></a><span id="l74.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l74.20"></a><span id="l74.20" class="difflineplus">+ *</span>
<a href="#l74.21"></a><span id="l74.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l74.22"></a><span id="l74.22" class="difflineplus">+ * Mozilla Foundation.</span>
<a href="#l74.23"></a><span id="l74.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l74.24"></a><span id="l74.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l74.25"></a><span id="l74.25" class="difflineplus">+ *</span>
<a href="#l74.26"></a><span id="l74.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l74.27"></a><span id="l74.27" class="difflineplus">+ *</span>
<a href="#l74.28"></a><span id="l74.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l74.29"></a><span id="l74.29" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l74.30"></a><span id="l74.30" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l74.31"></a><span id="l74.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l74.32"></a><span id="l74.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l74.33"></a><span id="l74.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l74.34"></a><span id="l74.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l74.35"></a><span id="l74.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l74.36"></a><span id="l74.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l74.37"></a><span id="l74.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l74.38"></a><span id="l74.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l74.39"></a><span id="l74.39" class="difflineplus">+ *</span>
<a href="#l74.40"></a><span id="l74.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l74.41"></a><span id="l74.41" class="difflineplus">+</span>
<a href="#l74.42"></a><span id="l74.42" class="difflineplus">+/**</span>
<a href="#l74.43"></a><span id="l74.43" class="difflineplus">+   Class for handling Berkeley Mailbox stores.</span>
<a href="#l74.44"></a><span id="l74.44" class="difflineplus">+*/</span>
<a href="#l74.45"></a><span id="l74.45" class="difflineplus">+</span>
<a href="#l74.46"></a><span id="l74.46" class="difflineplus">+#ifndef nsMsgBrkMboxStore_h__</span>
<a href="#l74.47"></a><span id="l74.47" class="difflineplus">+#define nsMsgBrkMboxStore_h__</span>
<a href="#l74.48"></a><span id="l74.48" class="difflineplus">+</span>
<a href="#l74.49"></a><span id="l74.49" class="difflineplus">+#include &quot;nsMsgLocalStoreUtils.h&quot;</span>
<a href="#l74.50"></a><span id="l74.50" class="difflineplus">+#include &quot;nsILocalFile.h&quot;</span>
<a href="#l74.51"></a><span id="l74.51" class="difflineplus">+#include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l74.52"></a><span id="l74.52" class="difflineplus">+#include &quot;nsISeekableStream.h&quot;</span>
<a href="#l74.53"></a><span id="l74.53" class="difflineplus">+</span>
<a href="#l74.54"></a><span id="l74.54" class="difflineplus">+class nsMsgBrkMBoxStore : public nsMsgLocalStoreUtils, nsIMsgPluggableStore</span>
<a href="#l74.55"></a><span id="l74.55" class="difflineplus">+{</span>
<a href="#l74.56"></a><span id="l74.56" class="difflineplus">+public:</span>
<a href="#l74.57"></a><span id="l74.57" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l74.58"></a><span id="l74.58" class="difflineplus">+  NS_DECL_NSIMSGPLUGGABLESTORE</span>
<a href="#l74.59"></a><span id="l74.59" class="difflineplus">+</span>
<a href="#l74.60"></a><span id="l74.60" class="difflineplus">+  nsMsgBrkMBoxStore();</span>
<a href="#l74.61"></a><span id="l74.61" class="difflineplus">+</span>
<a href="#l74.62"></a><span id="l74.62" class="difflineplus">+private:</span>
<a href="#l74.63"></a><span id="l74.63" class="difflineplus">+  ~nsMsgBrkMBoxStore();</span>
<a href="#l74.64"></a><span id="l74.64" class="difflineplus">+</span>
<a href="#l74.65"></a><span id="l74.65" class="difflineplus">+protected:</span>
<a href="#l74.66"></a><span id="l74.66" class="difflineplus">+  nsresult AddSubFolders(nsIMsgFolder *parent, nsIFile *path, bool deep);</span>
<a href="#l74.67"></a><span id="l74.67" class="difflineplus">+  nsresult CreateDirectoryForFolder(nsILocalFile *path);</span>
<a href="#l74.68"></a><span id="l74.68" class="difflineplus">+  nsresult GetOutputStream(nsIArray *aHdrArray,</span>
<a href="#l74.69"></a><span id="l74.69" class="difflineplus">+                           nsCOMPtr&lt;nsIOutputStream&gt; &amp;outputStream,</span>
<a href="#l74.70"></a><span id="l74.70" class="difflineplus">+                           nsCOMPtr&lt;nsISeekableStream&gt; &amp;seekableStream,</span>
<a href="#l74.71"></a><span id="l74.71" class="difflineplus">+                           PRInt64 &amp;restorePos);</span>
<a href="#l74.72"></a><span id="l74.72" class="difflineplus">+  void GetMailboxModProperties(nsIMsgFolder *aFolder,</span>
<a href="#l74.73"></a><span id="l74.73" class="difflineplus">+                               PRInt64 *aSize, PRUint32 *aDate);</span>
<a href="#l74.74"></a><span id="l74.74" class="difflineplus">+  void SetDBValid(nsIMsgDBHdr *aHdr);</span>
<a href="#l74.75"></a><span id="l74.75" class="difflineplus">+  // We don't want to keep re-opening an output stream when downloading</span>
<a href="#l74.76"></a><span id="l74.76" class="difflineplus">+  // multiple pop3 messages, or adjusting x-mozilla-status headers, so</span>
<a href="#l74.77"></a><span id="l74.77" class="difflineplus">+  // we cache output streams based on folder uri's. If the caller has closed</span>
<a href="#l74.78"></a><span id="l74.78" class="difflineplus">+  // the stream, we'll get a new one.</span>
<a href="#l74.79"></a><span id="l74.79" class="difflineplus">+  nsInterfaceHashtable&lt;nsCStringHashKey, nsIOutputStream&gt; m_outputStreams;</span>
<a href="#l74.80"></a><span id="l74.80" class="difflineplus">+</span>
<a href="#l74.81"></a><span id="l74.81" class="difflineplus">+#ifdef _DEBUG</span>
<a href="#l74.82"></a><span id="l74.82" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_streamOutstandingFolder;</span>
<a href="#l74.83"></a><span id="l74.83" class="difflineplus">+#endif</span>
<a href="#l74.84"></a><span id="l74.84" class="difflineplus">+};</span>
<a href="#l74.85"></a><span id="l74.85" class="difflineplus">+</span>
<a href="#l74.86"></a><span id="l74.86" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l75.1"></a><span id="l75.1">new file mode 100644</span>
<a href="#l75.2"></a><span id="l75.2" class="difflineminus">--- /dev/null</span>
<a href="#l75.3"></a><span id="l75.3" class="difflineplus">+++ b/mailnews/local/src/nsMsgLocalStoreUtils.cpp</span>
<a href="#l75.4"></a><span id="l75.4" class="difflineat">@@ -0,0 +1,316 @@</span>
<a href="#l75.5"></a><span id="l75.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l75.6"></a><span id="l75.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l75.7"></a><span id="l75.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l75.8"></a><span id="l75.8" class="difflineplus">+ *</span>
<a href="#l75.9"></a><span id="l75.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l75.10"></a><span id="l75.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l75.11"></a><span id="l75.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l75.12"></a><span id="l75.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l75.13"></a><span id="l75.13" class="difflineplus">+ *</span>
<a href="#l75.14"></a><span id="l75.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l75.15"></a><span id="l75.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l75.16"></a><span id="l75.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l75.17"></a><span id="l75.17" class="difflineplus">+ * License.</span>
<a href="#l75.18"></a><span id="l75.18" class="difflineplus">+ *</span>
<a href="#l75.19"></a><span id="l75.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l75.20"></a><span id="l75.20" class="difflineplus">+ *</span>
<a href="#l75.21"></a><span id="l75.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l75.22"></a><span id="l75.22" class="difflineplus">+ * Mozilla Foundation.</span>
<a href="#l75.23"></a><span id="l75.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l75.24"></a><span id="l75.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l75.25"></a><span id="l75.25" class="difflineplus">+ *</span>
<a href="#l75.26"></a><span id="l75.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l75.27"></a><span id="l75.27" class="difflineplus">+ *   David Bienvenu &lt;dbienvenu@mozilla.com&gt;</span>
<a href="#l75.28"></a><span id="l75.28" class="difflineplus">+ *</span>
<a href="#l75.29"></a><span id="l75.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l75.30"></a><span id="l75.30" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l75.31"></a><span id="l75.31" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l75.32"></a><span id="l75.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l75.33"></a><span id="l75.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l75.34"></a><span id="l75.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l75.35"></a><span id="l75.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l75.36"></a><span id="l75.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l75.37"></a><span id="l75.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l75.38"></a><span id="l75.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l75.39"></a><span id="l75.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l75.40"></a><span id="l75.40" class="difflineplus">+ *</span>
<a href="#l75.41"></a><span id="l75.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l75.42"></a><span id="l75.42" class="difflineplus">+ </span>
<a href="#l75.43"></a><span id="l75.43" class="difflineplus">+#include &quot;msgCore.h&quot;    // precompiled header...</span>
<a href="#l75.44"></a><span id="l75.44" class="difflineplus">+#include &quot;nsMsgLocalStoreUtils.h&quot;</span>
<a href="#l75.45"></a><span id="l75.45" class="difflineplus">+#include &quot;nsILocalFile.h&quot;</span>
<a href="#l75.46"></a><span id="l75.46" class="difflineplus">+#include &quot;prprf.h&quot;</span>
<a href="#l75.47"></a><span id="l75.47" class="difflineplus">+</span>
<a href="#l75.48"></a><span id="l75.48" class="difflineplus">+nsMsgLocalStoreUtils::nsMsgLocalStoreUtils()</span>
<a href="#l75.49"></a><span id="l75.49" class="difflineplus">+{</span>
<a href="#l75.50"></a><span id="l75.50" class="difflineplus">+}</span>
<a href="#l75.51"></a><span id="l75.51" class="difflineplus">+</span>
<a href="#l75.52"></a><span id="l75.52" class="difflineplus">+nsresult</span>
<a href="#l75.53"></a><span id="l75.53" class="difflineplus">+nsMsgLocalStoreUtils::AddDirectorySeparator(nsILocalFile *path)</span>
<a href="#l75.54"></a><span id="l75.54" class="difflineplus">+{</span>
<a href="#l75.55"></a><span id="l75.55" class="difflineplus">+  nsAutoString leafName;</span>
<a href="#l75.56"></a><span id="l75.56" class="difflineplus">+  path-&gt;GetLeafName(leafName);</span>
<a href="#l75.57"></a><span id="l75.57" class="difflineplus">+  leafName.AppendLiteral(FOLDER_SUFFIX);</span>
<a href="#l75.58"></a><span id="l75.58" class="difflineplus">+  return path-&gt;SetLeafName(leafName);</span>
<a href="#l75.59"></a><span id="l75.59" class="difflineplus">+}</span>
<a href="#l75.60"></a><span id="l75.60" class="difflineplus">+</span>
<a href="#l75.61"></a><span id="l75.61" class="difflineplus">+bool</span>
<a href="#l75.62"></a><span id="l75.62" class="difflineplus">+nsMsgLocalStoreUtils::nsShouldIgnoreFile(nsAString&amp; name)</span>
<a href="#l75.63"></a><span id="l75.63" class="difflineplus">+{</span>
<a href="#l75.64"></a><span id="l75.64" class="difflineplus">+  PRUnichar firstChar = name.First();</span>
<a href="#l75.65"></a><span id="l75.65" class="difflineplus">+  if (firstChar == '.' || firstChar == '#' ||</span>
<a href="#l75.66"></a><span id="l75.66" class="difflineplus">+      name.CharAt(name.Length() - 1) == '~')</span>
<a href="#l75.67"></a><span id="l75.67" class="difflineplus">+    return PR_TRUE;</span>
<a href="#l75.68"></a><span id="l75.68" class="difflineplus">+</span>
<a href="#l75.69"></a><span id="l75.69" class="difflineplus">+  if (name.LowerCaseEqualsLiteral(&quot;msgfilterrules.dat&quot;) ||</span>
<a href="#l75.70"></a><span id="l75.70" class="difflineplus">+      name.LowerCaseEqualsLiteral(&quot;rules.dat&quot;) ||</span>
<a href="#l75.71"></a><span id="l75.71" class="difflineplus">+      name.LowerCaseEqualsLiteral(&quot;filterlog.html&quot;) ||</span>
<a href="#l75.72"></a><span id="l75.72" class="difflineplus">+      name.LowerCaseEqualsLiteral(&quot;junklog.html&quot;) ||</span>
<a href="#l75.73"></a><span id="l75.73" class="difflineplus">+      name.LowerCaseEqualsLiteral(&quot;rulesbackup.dat&quot;))</span>
<a href="#l75.74"></a><span id="l75.74" class="difflineplus">+    return PR_TRUE;</span>
<a href="#l75.75"></a><span id="l75.75" class="difflineplus">+</span>
<a href="#l75.76"></a><span id="l75.76" class="difflineplus">+  // don't add summary files to the list of folders;</span>
<a href="#l75.77"></a><span id="l75.77" class="difflineplus">+  // don't add popstate files to the list either, or rules (sort.dat).</span>
<a href="#l75.78"></a><span id="l75.78" class="difflineplus">+  if (StringEndsWith(name, NS_LITERAL_STRING(&quot;.snm&quot;)) ||</span>
<a href="#l75.79"></a><span id="l75.79" class="difflineplus">+      name.LowerCaseEqualsLiteral(&quot;popstate.dat&quot;) ||</span>
<a href="#l75.80"></a><span id="l75.80" class="difflineplus">+      name.LowerCaseEqualsLiteral(&quot;sort.dat&quot;) ||</span>
<a href="#l75.81"></a><span id="l75.81" class="difflineplus">+      name.LowerCaseEqualsLiteral(&quot;mailfilt.log&quot;) ||</span>
<a href="#l75.82"></a><span id="l75.82" class="difflineplus">+      name.LowerCaseEqualsLiteral(&quot;filters.js&quot;) ||</span>
<a href="#l75.83"></a><span id="l75.83" class="difflineplus">+      StringEndsWith(name, NS_LITERAL_STRING(&quot;.toc&quot;)))</span>
<a href="#l75.84"></a><span id="l75.84" class="difflineplus">+    return PR_TRUE;</span>
<a href="#l75.85"></a><span id="l75.85" class="difflineplus">+</span>
<a href="#l75.86"></a><span id="l75.86" class="difflineplus">+  // ignore RSS data source files</span>
<a href="#l75.87"></a><span id="l75.87" class="difflineplus">+  if (name.LowerCaseEqualsLiteral(&quot;feeds.rdf&quot;) ||</span>
<a href="#l75.88"></a><span id="l75.88" class="difflineplus">+      name.LowerCaseEqualsLiteral(&quot;feeditems.rdf&quot;))</span>
<a href="#l75.89"></a><span id="l75.89" class="difflineplus">+    return PR_TRUE;</span>
<a href="#l75.90"></a><span id="l75.90" class="difflineplus">+</span>
<a href="#l75.91"></a><span id="l75.91" class="difflineplus">+  // The .mozmsgs dir is for spotlight support</span>
<a href="#l75.92"></a><span id="l75.92" class="difflineplus">+    return (StringEndsWith(name, NS_LITERAL_STRING(&quot;.mozmsgs&quot;)) ||</span>
<a href="#l75.93"></a><span id="l75.93" class="difflineplus">+            StringEndsWith(name, NS_LITERAL_STRING(&quot;.sbd&quot;)) ||</span>
<a href="#l75.94"></a><span id="l75.94" class="difflineplus">+            StringEndsWith(name, NS_LITERAL_STRING(SUMMARY_SUFFIX)));</span>
<a href="#l75.95"></a><span id="l75.95" class="difflineplus">+}</span>
<a href="#l75.96"></a><span id="l75.96" class="difflineplus">+</span>
<a href="#l75.97"></a><span id="l75.97" class="difflineplus">+/**</span>
<a href="#l75.98"></a><span id="l75.98" class="difflineplus">+ * We're passed a stream positioned at the start of the message.</span>
<a href="#l75.99"></a><span id="l75.99" class="difflineplus">+ * We start reading lines, looking for x-mozilla-keys: headers; If we're</span>
<a href="#l75.100"></a><span id="l75.100" class="difflineplus">+ * adding the keyword and we find a header with the desired keyword already</span>
<a href="#l75.101"></a><span id="l75.101" class="difflineplus">+ * in it, we don't need to do anything. Likewise, if removing keyword and we</span>
<a href="#l75.102"></a><span id="l75.102" class="difflineplus">+ * don't find it,we don't need to do anything. Otherwise, if adding, we need</span>
<a href="#l75.103"></a><span id="l75.103" class="difflineplus">+ * to see if there's an x-mozilla-keys header with room for the new keyword.</span>
<a href="#l75.104"></a><span id="l75.104" class="difflineplus">+ *  If so, we replace the corresponding number of spaces with the keyword.</span>
<a href="#l75.105"></a><span id="l75.105" class="difflineplus">+ * If no room, we can't do anything until the folder is compacted and another</span>
<a href="#l75.106"></a><span id="l75.106" class="difflineplus">+ * x-mozilla-keys header is added. In that case, we set a property</span>
<a href="#l75.107"></a><span id="l75.107" class="difflineplus">+ * on the header, which the compaction code will check.</span>
<a href="#l75.108"></a><span id="l75.108" class="difflineplus">+ * This is not true for maildir, however, since it won't require compaction.</span>
<a href="#l75.109"></a><span id="l75.109" class="difflineplus">+ */</span>
<a href="#l75.110"></a><span id="l75.110" class="difflineplus">+</span>
<a href="#l75.111"></a><span id="l75.111" class="difflineplus">+void</span>
<a href="#l75.112"></a><span id="l75.112" class="difflineplus">+nsMsgLocalStoreUtils::ChangeKeywordsHelper(nsIMsgDBHdr *message,</span>
<a href="#l75.113"></a><span id="l75.113" class="difflineplus">+                                           PRUint64 desiredOffset,</span>
<a href="#l75.114"></a><span id="l75.114" class="difflineplus">+                                           nsLineBuffer&lt;char&gt; *lineBuffer,</span>
<a href="#l75.115"></a><span id="l75.115" class="difflineplus">+                                           nsTArray&lt;nsCString&gt; &amp;keywordArray,</span>
<a href="#l75.116"></a><span id="l75.116" class="difflineplus">+                                           bool aAdd,</span>
<a href="#l75.117"></a><span id="l75.117" class="difflineplus">+                                           nsIOutputStream *outputStream,</span>
<a href="#l75.118"></a><span id="l75.118" class="difflineplus">+                                           nsISeekableStream *seekableStream,</span>
<a href="#l75.119"></a><span id="l75.119" class="difflineplus">+                                           nsIInputStream *inputStream)</span>
<a href="#l75.120"></a><span id="l75.120" class="difflineplus">+{</span>
<a href="#l75.121"></a><span id="l75.121" class="difflineplus">+  PRUint32 bytesWritten;</span>
<a href="#l75.122"></a><span id="l75.122" class="difflineplus">+</span>
<a href="#l75.123"></a><span id="l75.123" class="difflineplus">+  for (PRUint32 i = 0; i &lt; keywordArray.Length(); i++)</span>
<a href="#l75.124"></a><span id="l75.124" class="difflineplus">+  {</span>
<a href="#l75.125"></a><span id="l75.125" class="difflineplus">+    nsCAutoString header;</span>
<a href="#l75.126"></a><span id="l75.126" class="difflineplus">+    nsCAutoString keywords;</span>
<a href="#l75.127"></a><span id="l75.127" class="difflineplus">+    bool done = false;</span>
<a href="#l75.128"></a><span id="l75.128" class="difflineplus">+    PRUint32 len = 0;</span>
<a href="#l75.129"></a><span id="l75.129" class="difflineplus">+    nsCAutoString keywordToWrite(&quot; &quot;);</span>
<a href="#l75.130"></a><span id="l75.130" class="difflineplus">+</span>
<a href="#l75.131"></a><span id="l75.131" class="difflineplus">+    keywordToWrite.Append(keywordArray[i]);</span>
<a href="#l75.132"></a><span id="l75.132" class="difflineplus">+    seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, desiredOffset);</span>
<a href="#l75.133"></a><span id="l75.133" class="difflineplus">+    // need to reset lineBuffer, which is cheaper than creating a new one.</span>
<a href="#l75.134"></a><span id="l75.134" class="difflineplus">+    lineBuffer-&gt;start = lineBuffer-&gt;end = lineBuffer-&gt;buf;</span>
<a href="#l75.135"></a><span id="l75.135" class="difflineplus">+    bool inKeywordHeader = false;</span>
<a href="#l75.136"></a><span id="l75.136" class="difflineplus">+    bool foundKeyword = false;</span>
<a href="#l75.137"></a><span id="l75.137" class="difflineplus">+    PRInt64 offsetToAddKeyword = 0;</span>
<a href="#l75.138"></a><span id="l75.138" class="difflineplus">+    bool more;</span>
<a href="#l75.139"></a><span id="l75.139" class="difflineplus">+    message-&gt;GetMessageSize(&amp;len);</span>
<a href="#l75.140"></a><span id="l75.140" class="difflineplus">+    // loop through</span>
<a href="#l75.141"></a><span id="l75.141" class="difflineplus">+    while (!done)</span>
<a href="#l75.142"></a><span id="l75.142" class="difflineplus">+    {</span>
<a href="#l75.143"></a><span id="l75.143" class="difflineplus">+      PRInt64 lineStartPos;</span>
<a href="#l75.144"></a><span id="l75.144" class="difflineplus">+      seekableStream-&gt;Tell(&amp;lineStartPos);</span>
<a href="#l75.145"></a><span id="l75.145" class="difflineplus">+      // we need to adjust the linestart pos by how much extra the line</span>
<a href="#l75.146"></a><span id="l75.146" class="difflineplus">+      // buffer has read from the stream.</span>
<a href="#l75.147"></a><span id="l75.147" class="difflineplus">+      lineStartPos -= (lineBuffer-&gt;end - lineBuffer-&gt;start);</span>
<a href="#l75.148"></a><span id="l75.148" class="difflineplus">+      // NS_ReadLine doesn't return line termination chars.</span>
<a href="#l75.149"></a><span id="l75.149" class="difflineplus">+      nsCString keywordHeaders;</span>
<a href="#l75.150"></a><span id="l75.150" class="difflineplus">+      nsresult rv = NS_ReadLine(inputStream, lineBuffer, keywordHeaders, &amp;more);</span>
<a href="#l75.151"></a><span id="l75.151" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l75.152"></a><span id="l75.152" class="difflineplus">+      {</span>
<a href="#l75.153"></a><span id="l75.153" class="difflineplus">+        if (keywordHeaders.IsEmpty())</span>
<a href="#l75.154"></a><span id="l75.154" class="difflineplus">+          break; // passed headers; no x-mozilla-keywords header; give up.</span>
<a href="#l75.155"></a><span id="l75.155" class="difflineplus">+        if (StringBeginsWith(keywordHeaders,</span>
<a href="#l75.156"></a><span id="l75.156" class="difflineplus">+                             NS_LITERAL_CSTRING(HEADER_X_MOZILLA_KEYWORDS)))</span>
<a href="#l75.157"></a><span id="l75.157" class="difflineplus">+          inKeywordHeader = PR_TRUE;</span>
<a href="#l75.158"></a><span id="l75.158" class="difflineplus">+        else if (inKeywordHeader &amp;&amp; (keywordHeaders.CharAt(0) == ' ' ||</span>
<a href="#l75.159"></a><span id="l75.159" class="difflineplus">+                                     keywordHeaders.CharAt(0) == '\t'))</span>
<a href="#l75.160"></a><span id="l75.160" class="difflineplus">+          ; // continuation header line</span>
<a href="#l75.161"></a><span id="l75.161" class="difflineplus">+        else if (inKeywordHeader)</span>
<a href="#l75.162"></a><span id="l75.162" class="difflineplus">+          break;</span>
<a href="#l75.163"></a><span id="l75.163" class="difflineplus">+        else</span>
<a href="#l75.164"></a><span id="l75.164" class="difflineplus">+          continue;</span>
<a href="#l75.165"></a><span id="l75.165" class="difflineplus">+        PRUint32 keywordHdrLength = keywordHeaders.Length();</span>
<a href="#l75.166"></a><span id="l75.166" class="difflineplus">+        PRInt32 startOffset, keywordLength;</span>
<a href="#l75.167"></a><span id="l75.167" class="difflineplus">+        // check if we have the keyword</span>
<a href="#l75.168"></a><span id="l75.168" class="difflineplus">+        if (MsgFindKeyword(keywordArray[i], keywordHeaders, &amp;startOffset,</span>
<a href="#l75.169"></a><span id="l75.169" class="difflineplus">+                           &amp;keywordLength))</span>
<a href="#l75.170"></a><span id="l75.170" class="difflineplus">+        {</span>
<a href="#l75.171"></a><span id="l75.171" class="difflineplus">+          foundKeyword = PR_TRUE;</span>
<a href="#l75.172"></a><span id="l75.172" class="difflineplus">+          if (!aAdd) // if we're removing, remove it, and break;</span>
<a href="#l75.173"></a><span id="l75.173" class="difflineplus">+          {</span>
<a href="#l75.174"></a><span id="l75.174" class="difflineplus">+            keywordHeaders.Cut(startOffset, keywordLength);</span>
<a href="#l75.175"></a><span id="l75.175" class="difflineplus">+            for (PRInt32 j = keywordLength; j &gt; 0; j--)</span>
<a href="#l75.176"></a><span id="l75.176" class="difflineplus">+              keywordHeaders.Append(' ');</span>
<a href="#l75.177"></a><span id="l75.177" class="difflineplus">+            seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, lineStartPos);</span>
<a href="#l75.178"></a><span id="l75.178" class="difflineplus">+            outputStream-&gt;Write(keywordHeaders.get(), keywordHeaders.Length(),</span>
<a href="#l75.179"></a><span id="l75.179" class="difflineplus">+                                &amp;bytesWritten);</span>
<a href="#l75.180"></a><span id="l75.180" class="difflineplus">+          }</span>
<a href="#l75.181"></a><span id="l75.181" class="difflineplus">+          offsetToAddKeyword = 0;</span>
<a href="#l75.182"></a><span id="l75.182" class="difflineplus">+          // if adding and we already have the keyword, done</span>
<a href="#l75.183"></a><span id="l75.183" class="difflineplus">+          done = PR_TRUE;</span>
<a href="#l75.184"></a><span id="l75.184" class="difflineplus">+          break;</span>
<a href="#l75.185"></a><span id="l75.185" class="difflineplus">+        }</span>
<a href="#l75.186"></a><span id="l75.186" class="difflineplus">+        // argh, we need to check all the lines to see if we already have the</span>
<a href="#l75.187"></a><span id="l75.187" class="difflineplus">+        // keyword, but if we don't find it, we want to remember the line and</span>
<a href="#l75.188"></a><span id="l75.188" class="difflineplus">+        // position where we have room to add the keyword.</span>
<a href="#l75.189"></a><span id="l75.189" class="difflineplus">+        if (aAdd)</span>
<a href="#l75.190"></a><span id="l75.190" class="difflineplus">+        {</span>
<a href="#l75.191"></a><span id="l75.191" class="difflineplus">+          nsCAutoString curKeywordHdr(keywordHeaders);</span>
<a href="#l75.192"></a><span id="l75.192" class="difflineplus">+          // strip off line ending spaces.</span>
<a href="#l75.193"></a><span id="l75.193" class="difflineplus">+          curKeywordHdr.Trim(&quot; &quot;, PR_FALSE, PR_TRUE);</span>
<a href="#l75.194"></a><span id="l75.194" class="difflineplus">+          if (!offsetToAddKeyword &amp;&amp; curKeywordHdr.Length() +</span>
<a href="#l75.195"></a><span id="l75.195" class="difflineplus">+                keywordToWrite.Length() &lt; keywordHdrLength)</span>
<a href="#l75.196"></a><span id="l75.196" class="difflineplus">+            offsetToAddKeyword = lineStartPos + curKeywordHdr.Length();</span>
<a href="#l75.197"></a><span id="l75.197" class="difflineplus">+        }</span>
<a href="#l75.198"></a><span id="l75.198" class="difflineplus">+      }</span>
<a href="#l75.199"></a><span id="l75.199" class="difflineplus">+    }</span>
<a href="#l75.200"></a><span id="l75.200" class="difflineplus">+    if (aAdd &amp;&amp; !foundKeyword)</span>
<a href="#l75.201"></a><span id="l75.201" class="difflineplus">+    {</span>
<a href="#l75.202"></a><span id="l75.202" class="difflineplus">+      if (!offsetToAddKeyword)</span>
<a href="#l75.203"></a><span id="l75.203" class="difflineplus">+        message-&gt;SetUint32Property(&quot;growKeywords&quot;, 1);</span>
<a href="#l75.204"></a><span id="l75.204" class="difflineplus">+      else</span>
<a href="#l75.205"></a><span id="l75.205" class="difflineplus">+      {</span>
<a href="#l75.206"></a><span id="l75.206" class="difflineplus">+        seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET,</span>
<a href="#l75.207"></a><span id="l75.207" class="difflineplus">+                             offsetToAddKeyword);</span>
<a href="#l75.208"></a><span id="l75.208" class="difflineplus">+        outputStream-&gt;Write(keywordToWrite.get(), keywordToWrite.Length(),</span>
<a href="#l75.209"></a><span id="l75.209" class="difflineplus">+                            &amp;bytesWritten);</span>
<a href="#l75.210"></a><span id="l75.210" class="difflineplus">+      }</span>
<a href="#l75.211"></a><span id="l75.211" class="difflineplus">+    }</span>
<a href="#l75.212"></a><span id="l75.212" class="difflineplus">+  }</span>
<a href="#l75.213"></a><span id="l75.213" class="difflineplus">+}</span>
<a href="#l75.214"></a><span id="l75.214" class="difflineplus">+</span>
<a href="#l75.215"></a><span id="l75.215" class="difflineplus">+nsresult</span>
<a href="#l75.216"></a><span id="l75.216" class="difflineplus">+nsMsgLocalStoreUtils::UpdateFolderFlag(nsIMsgDBHdr *mailHdr, bool bSet,</span>
<a href="#l75.217"></a><span id="l75.217" class="difflineplus">+                                       nsMsgMessageFlagType flag,</span>
<a href="#l75.218"></a><span id="l75.218" class="difflineplus">+                                       nsIOutputStream *fileStream)</span>
<a href="#l75.219"></a><span id="l75.219" class="difflineplus">+{</span>
<a href="#l75.220"></a><span id="l75.220" class="difflineplus">+  PRUint32 statusOffset;</span>
<a href="#l75.221"></a><span id="l75.221" class="difflineplus">+  PRUint64 msgOffset;</span>
<a href="#l75.222"></a><span id="l75.222" class="difflineplus">+  (void) mailHdr-&gt;GetStatusOffset(&amp;statusOffset);</span>
<a href="#l75.223"></a><span id="l75.223" class="difflineplus">+  // This probably means there's no x-mozilla-status header, so</span>
<a href="#l75.224"></a><span id="l75.224" class="difflineplus">+  // we just ignore this.</span>
<a href="#l75.225"></a><span id="l75.225" class="difflineplus">+  if (statusOffset == 0)</span>
<a href="#l75.226"></a><span id="l75.226" class="difflineplus">+    return NS_OK;</span>
<a href="#l75.227"></a><span id="l75.227" class="difflineplus">+  (void)mailHdr-&gt;GetMessageOffset(&amp;msgOffset);</span>
<a href="#l75.228"></a><span id="l75.228" class="difflineplus">+  PRUint64 statusPos = msgOffset + statusOffset;</span>
<a href="#l75.229"></a><span id="l75.229" class="difflineplus">+  nsresult rv;</span>
<a href="#l75.230"></a><span id="l75.230" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream(do_QueryInterface(fileStream, &amp;rv));</span>
<a href="#l75.231"></a><span id="l75.231" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.232"></a><span id="l75.232" class="difflineplus">+  rv = seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, statusPos);</span>
<a href="#l75.233"></a><span id="l75.233" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.234"></a><span id="l75.234" class="difflineplus">+  char buf[50];</span>
<a href="#l75.235"></a><span id="l75.235" class="difflineplus">+  buf[0] = '\0';</span>
<a href="#l75.236"></a><span id="l75.236" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; inputStream = do_QueryInterface(fileStream, &amp;rv);</span>
<a href="#l75.237"></a><span id="l75.237" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l75.238"></a><span id="l75.238" class="difflineplus">+  PRUint32 bytesRead;</span>
<a href="#l75.239"></a><span id="l75.239" class="difflineplus">+  if (NS_SUCCEEDED(inputStream-&gt;Read(buf, X_MOZILLA_STATUS_LEN + 6,</span>
<a href="#l75.240"></a><span id="l75.240" class="difflineplus">+                                     &amp;bytesRead)))</span>
<a href="#l75.241"></a><span id="l75.241" class="difflineplus">+  {</span>
<a href="#l75.242"></a><span id="l75.242" class="difflineplus">+    buf[bytesRead] = '\0';</span>
<a href="#l75.243"></a><span id="l75.243" class="difflineplus">+    if (strncmp(buf, X_MOZILLA_STATUS, X_MOZILLA_STATUS_LEN) == 0 &amp;&amp;</span>
<a href="#l75.244"></a><span id="l75.244" class="difflineplus">+      strncmp(buf + X_MOZILLA_STATUS_LEN, &quot;: &quot;, 2) == 0 &amp;&amp;</span>
<a href="#l75.245"></a><span id="l75.245" class="difflineplus">+      strlen(buf) &gt;= X_MOZILLA_STATUS_LEN + 6)</span>
<a href="#l75.246"></a><span id="l75.246" class="difflineplus">+    {</span>
<a href="#l75.247"></a><span id="l75.247" class="difflineplus">+      PRUint32 flags;</span>
<a href="#l75.248"></a><span id="l75.248" class="difflineplus">+      PRUint32 bytesWritten;</span>
<a href="#l75.249"></a><span id="l75.249" class="difflineplus">+      (void)mailHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l75.250"></a><span id="l75.250" class="difflineplus">+      if (!(flags &amp; nsMsgMessageFlags::Expunged))</span>
<a href="#l75.251"></a><span id="l75.251" class="difflineplus">+      {</span>
<a href="#l75.252"></a><span id="l75.252" class="difflineplus">+        char *p = buf + X_MOZILLA_STATUS_LEN + 2;</span>
<a href="#l75.253"></a><span id="l75.253" class="difflineplus">+</span>
<a href="#l75.254"></a><span id="l75.254" class="difflineplus">+        nsresult errorCode = NS_OK;</span>
<a href="#l75.255"></a><span id="l75.255" class="difflineplus">+        flags = nsDependentCString(p).ToInteger(&amp;errorCode, 16);</span>
<a href="#l75.256"></a><span id="l75.256" class="difflineplus">+</span>
<a href="#l75.257"></a><span id="l75.257" class="difflineplus">+        PRUint32 curFlags;</span>
<a href="#l75.258"></a><span id="l75.258" class="difflineplus">+        (void)mailHdr-&gt;GetFlags(&amp;curFlags);</span>
<a href="#l75.259"></a><span id="l75.259" class="difflineplus">+        flags = (flags &amp; nsMsgMessageFlags::Queued) |</span>
<a href="#l75.260"></a><span id="l75.260" class="difflineplus">+          (curFlags &amp; ~nsMsgMessageFlags::RuntimeOnly);</span>
<a href="#l75.261"></a><span id="l75.261" class="difflineplus">+        if (bSet)</span>
<a href="#l75.262"></a><span id="l75.262" class="difflineplus">+          flags |= flag;</span>
<a href="#l75.263"></a><span id="l75.263" class="difflineplus">+        else</span>
<a href="#l75.264"></a><span id="l75.264" class="difflineplus">+          flags &amp;= ~flag;</span>
<a href="#l75.265"></a><span id="l75.265" class="difflineplus">+      }</span>
<a href="#l75.266"></a><span id="l75.266" class="difflineplus">+      else</span>
<a href="#l75.267"></a><span id="l75.267" class="difflineplus">+      {</span>
<a href="#l75.268"></a><span id="l75.268" class="difflineplus">+        flags &amp;= ~nsMsgMessageFlags::RuntimeOnly;</span>
<a href="#l75.269"></a><span id="l75.269" class="difflineplus">+      }</span>
<a href="#l75.270"></a><span id="l75.270" class="difflineplus">+      seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, statusPos);</span>
<a href="#l75.271"></a><span id="l75.271" class="difflineplus">+      // We are filing out x-mozilla-status flags here</span>
<a href="#l75.272"></a><span id="l75.272" class="difflineplus">+      PR_snprintf(buf, sizeof(buf), X_MOZILLA_STATUS_FORMAT,</span>
<a href="#l75.273"></a><span id="l75.273" class="difflineplus">+        flags &amp; 0x0000FFFF);</span>
<a href="#l75.274"></a><span id="l75.274" class="difflineplus">+      PRInt32 lineLen = PL_strlen(buf);</span>
<a href="#l75.275"></a><span id="l75.275" class="difflineplus">+      PRUint64 status2Pos = statusPos + lineLen;</span>
<a href="#l75.276"></a><span id="l75.276" class="difflineplus">+      fileStream-&gt;Write(buf, lineLen, &amp;bytesWritten);</span>
<a href="#l75.277"></a><span id="l75.277" class="difflineplus">+</span>
<a href="#l75.278"></a><span id="l75.278" class="difflineplus">+      if (flag &amp; 0xFFFF0000)</span>
<a href="#l75.279"></a><span id="l75.279" class="difflineplus">+      {</span>
<a href="#l75.280"></a><span id="l75.280" class="difflineplus">+        // time to upate x-mozilla-status2</span>
<a href="#l75.281"></a><span id="l75.281" class="difflineplus">+        // first find it by finding end of previous line, see bug 234935</span>
<a href="#l75.282"></a><span id="l75.282" class="difflineplus">+        seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, status2Pos);</span>
<a href="#l75.283"></a><span id="l75.283" class="difflineplus">+        do</span>
<a href="#l75.284"></a><span id="l75.284" class="difflineplus">+        {</span>
<a href="#l75.285"></a><span id="l75.285" class="difflineplus">+          rv = inputStream-&gt;Read(buf, 1, &amp;bytesRead);</span>
<a href="#l75.286"></a><span id="l75.286" class="difflineplus">+          status2Pos++;</span>
<a href="#l75.287"></a><span id="l75.287" class="difflineplus">+        } while (NS_SUCCEEDED(rv) &amp;&amp; (*buf == '\n' || *buf == '\r'));</span>
<a href="#l75.288"></a><span id="l75.288" class="difflineplus">+        status2Pos--;</span>
<a href="#l75.289"></a><span id="l75.289" class="difflineplus">+        seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, status2Pos);</span>
<a href="#l75.290"></a><span id="l75.290" class="difflineplus">+        if (NS_SUCCEEDED(inputStream-&gt;Read(buf, X_MOZILLA_STATUS2_LEN + 10,</span>
<a href="#l75.291"></a><span id="l75.291" class="difflineplus">+                                           &amp;bytesRead)))</span>
<a href="#l75.292"></a><span id="l75.292" class="difflineplus">+        {</span>
<a href="#l75.293"></a><span id="l75.293" class="difflineplus">+          if (strncmp(buf, X_MOZILLA_STATUS2, X_MOZILLA_STATUS2_LEN) == 0 &amp;&amp;</span>
<a href="#l75.294"></a><span id="l75.294" class="difflineplus">+            strncmp(buf + X_MOZILLA_STATUS2_LEN, &quot;: &quot;, 2) == 0 &amp;&amp;</span>
<a href="#l75.295"></a><span id="l75.295" class="difflineplus">+            strlen(buf) &gt;= X_MOZILLA_STATUS2_LEN + 10)</span>
<a href="#l75.296"></a><span id="l75.296" class="difflineplus">+          {</span>
<a href="#l75.297"></a><span id="l75.297" class="difflineplus">+            PRUint32 dbFlags;</span>
<a href="#l75.298"></a><span id="l75.298" class="difflineplus">+            (void)mailHdr-&gt;GetFlags(&amp;dbFlags);</span>
<a href="#l75.299"></a><span id="l75.299" class="difflineplus">+            dbFlags &amp;= 0xFFFF0000;</span>
<a href="#l75.300"></a><span id="l75.300" class="difflineplus">+            seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, status2Pos);</span>
<a href="#l75.301"></a><span id="l75.301" class="difflineplus">+            PR_snprintf(buf, sizeof(buf), X_MOZILLA_STATUS2_FORMAT, dbFlags);</span>
<a href="#l75.302"></a><span id="l75.302" class="difflineplus">+            fileStream-&gt;Write(buf, PL_strlen(buf), &amp;bytesWritten);</span>
<a href="#l75.303"></a><span id="l75.303" class="difflineplus">+          }</span>
<a href="#l75.304"></a><span id="l75.304" class="difflineplus">+        }</span>
<a href="#l75.305"></a><span id="l75.305" class="difflineplus">+      }</span>
<a href="#l75.306"></a><span id="l75.306" class="difflineplus">+    }</span>
<a href="#l75.307"></a><span id="l75.307" class="difflineplus">+    else</span>
<a href="#l75.308"></a><span id="l75.308" class="difflineplus">+    {</span>
<a href="#l75.309"></a><span id="l75.309" class="difflineplus">+#ifdef DEBUG</span>
<a href="#l75.310"></a><span id="l75.310" class="difflineplus">+      printf(&quot;Didn't find %s where expected at position %ld\n&quot;</span>
<a href="#l75.311"></a><span id="l75.311" class="difflineplus">+        &quot;instead, found %s.\n&quot;,</span>
<a href="#l75.312"></a><span id="l75.312" class="difflineplus">+        X_MOZILLA_STATUS, (long) statusPos, buf);</span>
<a href="#l75.313"></a><span id="l75.313" class="difflineplus">+#endif</span>
<a href="#l75.314"></a><span id="l75.314" class="difflineplus">+      rv = NS_ERROR_FAILURE;</span>
<a href="#l75.315"></a><span id="l75.315" class="difflineplus">+    }</span>
<a href="#l75.316"></a><span id="l75.316" class="difflineplus">+  }</span>
<a href="#l75.317"></a><span id="l75.317" class="difflineplus">+  else</span>
<a href="#l75.318"></a><span id="l75.318" class="difflineplus">+    rv = NS_ERROR_FAILURE;</span>
<a href="#l75.319"></a><span id="l75.319" class="difflineplus">+  return rv;</span>
<a href="#l75.320"></a><span id="l75.320" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l76.1"></a><span id="l76.1">new file mode 100644</span>
<a href="#l76.2"></a><span id="l76.2" class="difflineminus">--- /dev/null</span>
<a href="#l76.3"></a><span id="l76.3" class="difflineplus">+++ b/mailnews/local/src/nsMsgLocalStoreUtils.h</span>
<a href="#l76.4"></a><span id="l76.4" class="difflineat">@@ -0,0 +1,78 @@</span>
<a href="#l76.5"></a><span id="l76.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l76.6"></a><span id="l76.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l76.7"></a><span id="l76.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l76.8"></a><span id="l76.8" class="difflineplus">+ *</span>
<a href="#l76.9"></a><span id="l76.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l76.10"></a><span id="l76.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l76.11"></a><span id="l76.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l76.12"></a><span id="l76.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l76.13"></a><span id="l76.13" class="difflineplus">+ *</span>
<a href="#l76.14"></a><span id="l76.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l76.15"></a><span id="l76.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l76.16"></a><span id="l76.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l76.17"></a><span id="l76.17" class="difflineplus">+ * License.</span>
<a href="#l76.18"></a><span id="l76.18" class="difflineplus">+ *</span>
<a href="#l76.19"></a><span id="l76.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l76.20"></a><span id="l76.20" class="difflineplus">+ *</span>
<a href="#l76.21"></a><span id="l76.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l76.22"></a><span id="l76.22" class="difflineplus">+ * Mozilla Foundation.</span>
<a href="#l76.23"></a><span id="l76.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l76.24"></a><span id="l76.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l76.25"></a><span id="l76.25" class="difflineplus">+ *</span>
<a href="#l76.26"></a><span id="l76.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l76.27"></a><span id="l76.27" class="difflineplus">+ *</span>
<a href="#l76.28"></a><span id="l76.28" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l76.29"></a><span id="l76.29" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l76.30"></a><span id="l76.30" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l76.31"></a><span id="l76.31" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l76.32"></a><span id="l76.32" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l76.33"></a><span id="l76.33" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l76.34"></a><span id="l76.34" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l76.35"></a><span id="l76.35" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l76.36"></a><span id="l76.36" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l76.37"></a><span id="l76.37" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l76.38"></a><span id="l76.38" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l76.39"></a><span id="l76.39" class="difflineplus">+ *</span>
<a href="#l76.40"></a><span id="l76.40" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l76.41"></a><span id="l76.41" class="difflineplus">+#ifndef nsMsgLocalStoreUtils_h__</span>
<a href="#l76.42"></a><span id="l76.42" class="difflineplus">+#define nsMsgLocalStoreUtils_h__</span>
<a href="#l76.43"></a><span id="l76.43" class="difflineplus">+</span>
<a href="#l76.44"></a><span id="l76.44" class="difflineplus">+#include &quot;msgCore.h&quot;</span>
<a href="#l76.45"></a><span id="l76.45" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l76.46"></a><span id="l76.46" class="difflineplus">+#include &quot;nsStringGlue.h&quot;</span>
<a href="#l76.47"></a><span id="l76.47" class="difflineplus">+#include &quot;nsReadLine.h&quot;</span>
<a href="#l76.48"></a><span id="l76.48" class="difflineplus">+#include &quot;nsISeekableStream.h&quot;</span>
<a href="#l76.49"></a><span id="l76.49" class="difflineplus">+#include &quot;nsIMsgHdr.h&quot;</span>
<a href="#l76.50"></a><span id="l76.50" class="difflineplus">+#include &quot;nsMsgLocalFolderHdrs.h&quot;</span>
<a href="#l76.51"></a><span id="l76.51" class="difflineplus">+#include &quot;nsMailHeaders.h&quot;</span>
<a href="#l76.52"></a><span id="l76.52" class="difflineplus">+#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l76.53"></a><span id="l76.53" class="difflineplus">+#include &quot;nsIOutputStream.h&quot;</span>
<a href="#l76.54"></a><span id="l76.54" class="difflineplus">+#include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l76.55"></a><span id="l76.55" class="difflineplus">+</span>
<a href="#l76.56"></a><span id="l76.56" class="difflineplus">+/**</span>
<a href="#l76.57"></a><span id="l76.57" class="difflineplus">+ * Utility Class for handling local mail stores. Berkeley Mailbox</span>
<a href="#l76.58"></a><span id="l76.58" class="difflineplus">+ * and MailDir stores inherit from this class to share some code.</span>
<a href="#l76.59"></a><span id="l76.59" class="difflineplus">+*/</span>
<a href="#l76.60"></a><span id="l76.60" class="difflineplus">+</span>
<a href="#l76.61"></a><span id="l76.61" class="difflineplus">+class nsMsgLocalStoreUtils</span>
<a href="#l76.62"></a><span id="l76.62" class="difflineplus">+{</span>
<a href="#l76.63"></a><span id="l76.63" class="difflineplus">+public:</span>
<a href="#l76.64"></a><span id="l76.64" class="difflineplus">+  nsMsgLocalStoreUtils();</span>
<a href="#l76.65"></a><span id="l76.65" class="difflineplus">+</span>
<a href="#l76.66"></a><span id="l76.66" class="difflineplus">+  static nsresult AddDirectorySeparator(nsILocalFile *path);</span>
<a href="#l76.67"></a><span id="l76.67" class="difflineplus">+  static bool nsShouldIgnoreFile(nsAString&amp; name);</span>
<a href="#l76.68"></a><span id="l76.68" class="difflineplus">+  static void ChangeKeywordsHelper(nsIMsgDBHdr *message,</span>
<a href="#l76.69"></a><span id="l76.69" class="difflineplus">+                            PRUint64 desiredOffset,</span>
<a href="#l76.70"></a><span id="l76.70" class="difflineplus">+                            nsLineBuffer&lt;char&gt; *lineBuffer,</span>
<a href="#l76.71"></a><span id="l76.71" class="difflineplus">+                            nsTArray&lt;nsCString&gt; &amp;keywordArray,</span>
<a href="#l76.72"></a><span id="l76.72" class="difflineplus">+                            bool aAdd,</span>
<a href="#l76.73"></a><span id="l76.73" class="difflineplus">+                            nsIOutputStream *outputStream,</span>
<a href="#l76.74"></a><span id="l76.74" class="difflineplus">+                            nsISeekableStream *seekableStream,</span>
<a href="#l76.75"></a><span id="l76.75" class="difflineplus">+                            nsIInputStream *inputStream);</span>
<a href="#l76.76"></a><span id="l76.76" class="difflineplus">+</span>
<a href="#l76.77"></a><span id="l76.77" class="difflineplus">+  nsresult UpdateFolderFlag(nsIMsgDBHdr *mailHdr, bool bSet,</span>
<a href="#l76.78"></a><span id="l76.78" class="difflineplus">+                            nsMsgMessageFlagType flag,</span>
<a href="#l76.79"></a><span id="l76.79" class="difflineplus">+                            nsIOutputStream *fileStream);</span>
<a href="#l76.80"></a><span id="l76.80" class="difflineplus">+};</span>
<a href="#l76.81"></a><span id="l76.81" class="difflineplus">+</span>
<a href="#l76.82"></a><span id="l76.82" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l77.1"></a><span id="l77.1">new file mode 100644</span>
<a href="#l77.2"></a><span id="l77.2" class="difflineminus">--- /dev/null</span>
<a href="#l77.3"></a><span id="l77.3" class="difflineplus">+++ b/mailnews/local/src/nsMsgMaildirStore.cpp</span>
<a href="#l77.4"></a><span id="l77.4" class="difflineat">@@ -0,0 +1,1336 @@</span>
<a href="#l77.5"></a><span id="l77.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l77.6"></a><span id="l77.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l77.7"></a><span id="l77.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l77.8"></a><span id="l77.8" class="difflineplus">+ *</span>
<a href="#l77.9"></a><span id="l77.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l77.10"></a><span id="l77.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l77.11"></a><span id="l77.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l77.12"></a><span id="l77.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l77.13"></a><span id="l77.13" class="difflineplus">+ *</span>
<a href="#l77.14"></a><span id="l77.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l77.15"></a><span id="l77.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l77.16"></a><span id="l77.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l77.17"></a><span id="l77.17" class="difflineplus">+ * License.</span>
<a href="#l77.18"></a><span id="l77.18" class="difflineplus">+ *</span>
<a href="#l77.19"></a><span id="l77.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l77.20"></a><span id="l77.20" class="difflineplus">+ *</span>
<a href="#l77.21"></a><span id="l77.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l77.22"></a><span id="l77.22" class="difflineplus">+ * Mozilla Foundation.</span>
<a href="#l77.23"></a><span id="l77.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l77.24"></a><span id="l77.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l77.25"></a><span id="l77.25" class="difflineplus">+ *</span>
<a href="#l77.26"></a><span id="l77.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l77.27"></a><span id="l77.27" class="difflineplus">+ *  Andrey Terentyev &lt;andreycpp@gmail.com&gt;</span>
<a href="#l77.28"></a><span id="l77.28" class="difflineplus">+ *  David Bienvenu &lt;dbienvenu@mozilla.com&gt;</span>
<a href="#l77.29"></a><span id="l77.29" class="difflineplus">+ *</span>
<a href="#l77.30"></a><span id="l77.30" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l77.31"></a><span id="l77.31" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l77.32"></a><span id="l77.32" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l77.33"></a><span id="l77.33" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l77.34"></a><span id="l77.34" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l77.35"></a><span id="l77.35" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l77.36"></a><span id="l77.36" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l77.37"></a><span id="l77.37" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l77.38"></a><span id="l77.38" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l77.39"></a><span id="l77.39" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l77.40"></a><span id="l77.40" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l77.41"></a><span id="l77.41" class="difflineplus">+ *</span>
<a href="#l77.42"></a><span id="l77.42" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l77.43"></a><span id="l77.43" class="difflineplus">+</span>
<a href="#l77.44"></a><span id="l77.44" class="difflineplus">+/**</span>
<a href="#l77.45"></a><span id="l77.45" class="difflineplus">+   Class for handling Maildir stores.</span>
<a href="#l77.46"></a><span id="l77.46" class="difflineplus">+*/</span>
<a href="#l77.47"></a><span id="l77.47" class="difflineplus">+</span>
<a href="#l77.48"></a><span id="l77.48" class="difflineplus">+#include &quot;prprf.h&quot;</span>
<a href="#l77.49"></a><span id="l77.49" class="difflineplus">+#include &quot;prlog.h&quot;</span>
<a href="#l77.50"></a><span id="l77.50" class="difflineplus">+#include &quot;msgCore.h&quot;</span>
<a href="#l77.51"></a><span id="l77.51" class="difflineplus">+#include &quot;nsMsgMaildirStore.h&quot;</span>
<a href="#l77.52"></a><span id="l77.52" class="difflineplus">+#include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l77.53"></a><span id="l77.53" class="difflineplus">+#include &quot;nsISimpleEnumerator.h&quot;</span>
<a href="#l77.54"></a><span id="l77.54" class="difflineplus">+#include &quot;nsMsgFolderFlags.h&quot;</span>
<a href="#l77.55"></a><span id="l77.55" class="difflineplus">+#include &quot;nsILocalMailIncomingServer.h&quot;</span>
<a href="#l77.56"></a><span id="l77.56" class="difflineplus">+#include &quot;nsCOMArray.h&quot;</span>
<a href="#l77.57"></a><span id="l77.57" class="difflineplus">+#include &quot;nsIFile.h&quot;</span>
<a href="#l77.58"></a><span id="l77.58" class="difflineplus">+#include &quot;nsNetUtil.h&quot;</span>
<a href="#l77.59"></a><span id="l77.59" class="difflineplus">+#include &quot;nsIMsgDatabase.h&quot;</span>
<a href="#l77.60"></a><span id="l77.60" class="difflineplus">+#include &quot;nsNativeCharsetUtils.h&quot;</span>
<a href="#l77.61"></a><span id="l77.61" class="difflineplus">+#include &quot;nsMsgUtils.h&quot;</span>
<a href="#l77.62"></a><span id="l77.62" class="difflineplus">+#include &quot;nsMsgDBCID.h&quot;</span>
<a href="#l77.63"></a><span id="l77.63" class="difflineplus">+#include &quot;nsIDBFolderInfo.h&quot;</span>
<a href="#l77.64"></a><span id="l77.64" class="difflineplus">+#include &quot;nsIMutableArray.h&quot;</span>
<a href="#l77.65"></a><span id="l77.65" class="difflineplus">+#include &quot;nsArrayUtils.h&quot;</span>
<a href="#l77.66"></a><span id="l77.66" class="difflineplus">+#include &quot;nsMailHeaders.h&quot;</span>
<a href="#l77.67"></a><span id="l77.67" class="difflineplus">+#include &quot;nsParseMailbox.h&quot;</span>
<a href="#l77.68"></a><span id="l77.68" class="difflineplus">+#include &quot;nsIMailboxService.h&quot;</span>
<a href="#l77.69"></a><span id="l77.69" class="difflineplus">+#include &quot;nsMsgLocalCID.h&quot;</span>
<a href="#l77.70"></a><span id="l77.70" class="difflineplus">+#include &quot;nsIMsgLocalMailFolder.h&quot;</span>
<a href="#l77.71"></a><span id="l77.71" class="difflineplus">+#include &quot;nsITimer.h&quot;</span>
<a href="#l77.72"></a><span id="l77.72" class="difflineplus">+#include &quot;nsIMailboxUrl.h&quot;</span>
<a href="#l77.73"></a><span id="l77.73" class="difflineplus">+#include &quot;nsIMsgMailNewsUrl.h&quot;</span>
<a href="#l77.74"></a><span id="l77.74" class="difflineplus">+#include &quot;nsLocalUndoTxn.h&quot;</span>
<a href="#l77.75"></a><span id="l77.75" class="difflineplus">+#include &quot;nsIMessenger.h&quot;</span>
<a href="#l77.76"></a><span id="l77.76" class="difflineplus">+</span>
<a href="#l77.77"></a><span id="l77.77" class="difflineplus">+static PRLogModuleInfo* MailDirLog;</span>
<a href="#l77.78"></a><span id="l77.78" class="difflineplus">+</span>
<a href="#l77.79"></a><span id="l77.79" class="difflineplus">+nsMsgMaildirStore::nsMsgMaildirStore()</span>
<a href="#l77.80"></a><span id="l77.80" class="difflineplus">+{</span>
<a href="#l77.81"></a><span id="l77.81" class="difflineplus">+  MailDirLog = PR_NewLogModule(&quot;MailDirStore&quot;);</span>
<a href="#l77.82"></a><span id="l77.82" class="difflineplus">+}</span>
<a href="#l77.83"></a><span id="l77.83" class="difflineplus">+</span>
<a href="#l77.84"></a><span id="l77.84" class="difflineplus">+nsMsgMaildirStore::~nsMsgMaildirStore()</span>
<a href="#l77.85"></a><span id="l77.85" class="difflineplus">+{</span>
<a href="#l77.86"></a><span id="l77.86" class="difflineplus">+}</span>
<a href="#l77.87"></a><span id="l77.87" class="difflineplus">+</span>
<a href="#l77.88"></a><span id="l77.88" class="difflineplus">+NS_IMPL_ISUPPORTS1(nsMsgMaildirStore, nsIMsgPluggableStore)</span>
<a href="#l77.89"></a><span id="l77.89" class="difflineplus">+</span>
<a href="#l77.90"></a><span id="l77.90" class="difflineplus">+// Iterates over the folders in the &quot;path&quot; directory, and adds subfolders to</span>
<a href="#l77.91"></a><span id="l77.91" class="difflineplus">+// parent for each Maildir folder found.</span>
<a href="#l77.92"></a><span id="l77.92" class="difflineplus">+nsresult nsMsgMaildirStore::AddSubFolders(nsIMsgFolder *parent, nsIFile *path,</span>
<a href="#l77.93"></a><span id="l77.93" class="difflineplus">+                                          bool deep)</span>
<a href="#l77.94"></a><span id="l77.94" class="difflineplus">+{</span>
<a href="#l77.95"></a><span id="l77.95" class="difflineplus">+  nsCOMArray&lt;nsIFile&gt; currentDirEntries;</span>
<a href="#l77.96"></a><span id="l77.96" class="difflineplus">+</span>
<a href="#l77.97"></a><span id="l77.97" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l77.98"></a><span id="l77.98" class="difflineplus">+  nsresult rv = path-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l77.99"></a><span id="l77.99" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.100"></a><span id="l77.100" class="difflineplus">+</span>
<a href="#l77.101"></a><span id="l77.101" class="difflineplus">+  bool hasMore;</span>
<a href="#l77.102"></a><span id="l77.102" class="difflineplus">+  while (NS_SUCCEEDED(directoryEnumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp;</span>
<a href="#l77.103"></a><span id="l77.103" class="difflineplus">+         hasMore)</span>
<a href="#l77.104"></a><span id="l77.104" class="difflineplus">+  {</span>
<a href="#l77.105"></a><span id="l77.105" class="difflineplus">+    nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l77.106"></a><span id="l77.106" class="difflineplus">+    directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l77.107"></a><span id="l77.107" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; currentFile(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l77.108"></a><span id="l77.108" class="difflineplus">+    if (currentFile) {</span>
<a href="#l77.109"></a><span id="l77.109" class="difflineplus">+      nsAutoString leafName;</span>
<a href="#l77.110"></a><span id="l77.110" class="difflineplus">+      currentFile-&gt;GetLeafName(leafName);</span>
<a href="#l77.111"></a><span id="l77.111" class="difflineplus">+      bool isDirectory = false;</span>
<a href="#l77.112"></a><span id="l77.112" class="difflineplus">+      currentFile-&gt;IsDirectory(&amp;isDirectory);</span>
<a href="#l77.113"></a><span id="l77.113" class="difflineplus">+      // Make sure this really is a mail folder dir (i.e., a directory that</span>
<a href="#l77.114"></a><span id="l77.114" class="difflineplus">+      // contains cur and tmp sub-dirs, and not a .sbd or .mozmsgs dir).</span>
<a href="#l77.115"></a><span id="l77.115" class="difflineplus">+      if (isDirectory &amp;&amp; !nsShouldIgnoreFile(leafName))</span>
<a href="#l77.116"></a><span id="l77.116" class="difflineplus">+        currentDirEntries.AppendObject(currentFile);</span>
<a href="#l77.117"></a><span id="l77.117" class="difflineplus">+    }</span>
<a href="#l77.118"></a><span id="l77.118" class="difflineplus">+  }</span>
<a href="#l77.119"></a><span id="l77.119" class="difflineplus">+</span>
<a href="#l77.120"></a><span id="l77.120" class="difflineplus">+  // add the folders</span>
<a href="#l77.121"></a><span id="l77.121" class="difflineplus">+  PRInt32 count = currentDirEntries.Count();</span>
<a href="#l77.122"></a><span id="l77.122" class="difflineplus">+  for (PRInt32 i = 0; i &lt; count; ++i)</span>
<a href="#l77.123"></a><span id="l77.123" class="difflineplus">+  {</span>
<a href="#l77.124"></a><span id="l77.124" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; currentFile(currentDirEntries[i]);</span>
<a href="#l77.125"></a><span id="l77.125" class="difflineplus">+</span>
<a href="#l77.126"></a><span id="l77.126" class="difflineplus">+    nsAutoString leafName;</span>
<a href="#l77.127"></a><span id="l77.127" class="difflineplus">+    currentFile-&gt;GetLeafName(leafName);</span>
<a href="#l77.128"></a><span id="l77.128" class="difflineplus">+</span>
<a href="#l77.129"></a><span id="l77.129" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l77.130"></a><span id="l77.130" class="difflineplus">+    rv = parent-&gt;AddSubfolder(leafName, getter_AddRefs(child));</span>
<a href="#l77.131"></a><span id="l77.131" class="difflineplus">+    if (child)</span>
<a href="#l77.132"></a><span id="l77.132" class="difflineplus">+    {</span>
<a href="#l77.133"></a><span id="l77.133" class="difflineplus">+      nsString folderName;</span>
<a href="#l77.134"></a><span id="l77.134" class="difflineplus">+      child-&gt;GetName(folderName);  // try to get it from cache/db</span>
<a href="#l77.135"></a><span id="l77.135" class="difflineplus">+      if (folderName.IsEmpty())</span>
<a href="#l77.136"></a><span id="l77.136" class="difflineplus">+        child-&gt;SetPrettyName(leafName);</span>
<a href="#l77.137"></a><span id="l77.137" class="difflineplus">+      if (deep)</span>
<a href="#l77.138"></a><span id="l77.138" class="difflineplus">+      {</span>
<a href="#l77.139"></a><span id="l77.139" class="difflineplus">+        nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l77.140"></a><span id="l77.140" class="difflineplus">+        rv = child-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l77.141"></a><span id="l77.141" class="difflineplus">+        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.142"></a><span id="l77.142" class="difflineplus">+</span>
<a href="#l77.143"></a><span id="l77.143" class="difflineplus">+        // Construct the .sbd directory path for the possible children of the</span>
<a href="#l77.144"></a><span id="l77.144" class="difflineplus">+        // folder.</span>
<a href="#l77.145"></a><span id="l77.145" class="difflineplus">+        GetDirectoryForFolder(path);</span>
<a href="#l77.146"></a><span id="l77.146" class="difflineplus">+        bool directory = false;</span>
<a href="#l77.147"></a><span id="l77.147" class="difflineplus">+        // Check that &lt;folder&gt;.sbd really is a directory.</span>
<a href="#l77.148"></a><span id="l77.148" class="difflineplus">+        path-&gt;IsDirectory(&amp;directory);</span>
<a href="#l77.149"></a><span id="l77.149" class="difflineplus">+        if (directory)</span>
<a href="#l77.150"></a><span id="l77.150" class="difflineplus">+          AddSubFolders(child, path, true);</span>
<a href="#l77.151"></a><span id="l77.151" class="difflineplus">+      }</span>
<a href="#l77.152"></a><span id="l77.152" class="difflineplus">+    }</span>
<a href="#l77.153"></a><span id="l77.153" class="difflineplus">+  }</span>
<a href="#l77.154"></a><span id="l77.154" class="difflineplus">+  return rv;</span>
<a href="#l77.155"></a><span id="l77.155" class="difflineplus">+}</span>
<a href="#l77.156"></a><span id="l77.156" class="difflineplus">+</span>
<a href="#l77.157"></a><span id="l77.157" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::DiscoverSubFolders(nsIMsgFolder *aParentFolder,</span>
<a href="#l77.158"></a><span id="l77.158" class="difflineplus">+                                                    bool aDeep)</span>
<a href="#l77.159"></a><span id="l77.159" class="difflineplus">+{</span>
<a href="#l77.160"></a><span id="l77.160" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aParentFolder);</span>
<a href="#l77.161"></a><span id="l77.161" class="difflineplus">+</span>
<a href="#l77.162"></a><span id="l77.162" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l77.163"></a><span id="l77.163" class="difflineplus">+  nsresult rv = aParentFolder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l77.164"></a><span id="l77.164" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.165"></a><span id="l77.165" class="difflineplus">+</span>
<a href="#l77.166"></a><span id="l77.166" class="difflineplus">+  bool isServer, directory = false;</span>
<a href="#l77.167"></a><span id="l77.167" class="difflineplus">+  aParentFolder-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l77.168"></a><span id="l77.168" class="difflineplus">+  if (!isServer)</span>
<a href="#l77.169"></a><span id="l77.169" class="difflineplus">+    GetDirectoryForFolder(path);</span>
<a href="#l77.170"></a><span id="l77.170" class="difflineplus">+</span>
<a href="#l77.171"></a><span id="l77.171" class="difflineplus">+  path-&gt;IsDirectory(&amp;directory);</span>
<a href="#l77.172"></a><span id="l77.172" class="difflineplus">+</span>
<a href="#l77.173"></a><span id="l77.173" class="difflineplus">+  if (directory)</span>
<a href="#l77.174"></a><span id="l77.174" class="difflineplus">+  {</span>
<a href="#l77.175"></a><span id="l77.175" class="difflineplus">+    aParentFolder-&gt;SetFlag(nsMsgFolderFlags::Mail | nsMsgFolderFlags::Elided |</span>
<a href="#l77.176"></a><span id="l77.176" class="difflineplus">+                           nsMsgFolderFlags::Directory);</span>
<a href="#l77.177"></a><span id="l77.177" class="difflineplus">+</span>
<a href="#l77.178"></a><span id="l77.178" class="difflineplus">+    // discover existing folders</span>
<a href="#l77.179"></a><span id="l77.179" class="difflineplus">+    rv = AddSubFolders(aParentFolder, path, aDeep);</span>
<a href="#l77.180"></a><span id="l77.180" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.181"></a><span id="l77.181" class="difflineplus">+</span>
<a href="#l77.182"></a><span id="l77.182" class="difflineplus">+    // if this is root folder - attempt to create default folders</span>
<a href="#l77.183"></a><span id="l77.183" class="difflineplus">+    if (isServer)</span>
<a href="#l77.184"></a><span id="l77.184" class="difflineplus">+    {</span>
<a href="#l77.185"></a><span id="l77.185" class="difflineplus">+      nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l77.186"></a><span id="l77.186" class="difflineplus">+      rv = aParentFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l77.187"></a><span id="l77.187" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l77.188"></a><span id="l77.188" class="difflineplus">+      nsCOMPtr&lt;nsILocalMailIncomingServer&gt; localMailServer;</span>
<a href="#l77.189"></a><span id="l77.189" class="difflineplus">+      localMailServer = do_QueryInterface(server, &amp;rv);</span>
<a href="#l77.190"></a><span id="l77.190" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, NS_MSG_INVALID_OR_MISSING_SERVER);</span>
<a href="#l77.191"></a><span id="l77.191" class="difflineplus">+</span>
<a href="#l77.192"></a><span id="l77.192" class="difflineplus">+      // first create the folders on disk</span>
<a href="#l77.193"></a><span id="l77.193" class="difflineplus">+      rv = localMailServer-&gt;CreateDefaultMailboxes(path);</span>
<a href="#l77.194"></a><span id="l77.194" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.195"></a><span id="l77.195" class="difflineplus">+      // now, discover those folders</span>
<a href="#l77.196"></a><span id="l77.196" class="difflineplus">+      rv = AddSubFolders(aParentFolder, path, aDeep);</span>
<a href="#l77.197"></a><span id="l77.197" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.198"></a><span id="l77.198" class="difflineplus">+      // and add flags on them</span>
<a href="#l77.199"></a><span id="l77.199" class="difflineplus">+      rv = localMailServer-&gt;SetFlagsOnDefaultMailboxes();</span>
<a href="#l77.200"></a><span id="l77.200" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.201"></a><span id="l77.201" class="difflineplus">+    }</span>
<a href="#l77.202"></a><span id="l77.202" class="difflineplus">+  }</span>
<a href="#l77.203"></a><span id="l77.203" class="difflineplus">+  return rv;</span>
<a href="#l77.204"></a><span id="l77.204" class="difflineplus">+}</span>
<a href="#l77.205"></a><span id="l77.205" class="difflineplus">+</span>
<a href="#l77.206"></a><span id="l77.206" class="difflineplus">+/**</span>
<a href="#l77.207"></a><span id="l77.207" class="difflineplus">+ *Create a Maildir-style folder with &quot;tmp&quot;, &quot; and &quot;cur&quot; subfolders</span>
<a href="#l77.208"></a><span id="l77.208" class="difflineplus">+ * but no &quot;new&quot; subfolder, because it's not sensical in the mail client context.</span>
<a href="#l77.209"></a><span id="l77.209" class="difflineplus">+ (&quot;new&quot; directory is for messages on the server that haven't been seen by a</span>
<a href="#l77.210"></a><span id="l77.210" class="difflineplus">+*  mail client).</span>
<a href="#l77.211"></a><span id="l77.211" class="difflineplus">+ * aFolderName is already &quot;safe&quot; - it has been through NS_MsgHashIfNecessary</span>
<a href="#l77.212"></a><span id="l77.212" class="difflineplus">+ */</span>
<a href="#l77.213"></a><span id="l77.213" class="difflineplus">+nsresult nsMsgMaildirStore::CreateMaildir(nsILocalFile *path)</span>
<a href="#l77.214"></a><span id="l77.214" class="difflineplus">+{</span>
<a href="#l77.215"></a><span id="l77.215" class="difflineplus">+  nsresult rv = path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l77.216"></a><span id="l77.216" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.217"></a><span id="l77.217" class="difflineplus">+</span>
<a href="#l77.218"></a><span id="l77.218" class="difflineplus">+  // Create tmp, new, cur leaves</span>
<a href="#l77.219"></a><span id="l77.219" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; leaf(do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv));</span>
<a href="#l77.220"></a><span id="l77.220" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.221"></a><span id="l77.221" class="difflineplus">+</span>
<a href="#l77.222"></a><span id="l77.222" class="difflineplus">+  leaf-&gt;InitWithFile(path);</span>
<a href="#l77.223"></a><span id="l77.223" class="difflineplus">+</span>
<a href="#l77.224"></a><span id="l77.224" class="difflineplus">+  leaf-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;tmp&quot;));</span>
<a href="#l77.225"></a><span id="l77.225" class="difflineplus">+  rv = leaf-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l77.226"></a><span id="l77.226" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.227"></a><span id="l77.227" class="difflineplus">+</span>
<a href="#l77.228"></a><span id="l77.228" class="difflineplus">+  leaf-&gt;SetNativeLeafName(NS_LITERAL_CSTRING(&quot;cur&quot;));</span>
<a href="#l77.229"></a><span id="l77.229" class="difflineplus">+  rv = leaf-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l77.230"></a><span id="l77.230" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.231"></a><span id="l77.231" class="difflineplus">+</span>
<a href="#l77.232"></a><span id="l77.232" class="difflineplus">+  return NS_OK;</span>
<a href="#l77.233"></a><span id="l77.233" class="difflineplus">+}</span>
<a href="#l77.234"></a><span id="l77.234" class="difflineplus">+</span>
<a href="#l77.235"></a><span id="l77.235" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::CreateFolder(nsIMsgFolder *aParent,</span>
<a href="#l77.236"></a><span id="l77.236" class="difflineplus">+                                              const nsAString &amp;aFolderName,</span>
<a href="#l77.237"></a><span id="l77.237" class="difflineplus">+                                              nsIMsgFolder **aResult)</span>
<a href="#l77.238"></a><span id="l77.238" class="difflineplus">+{</span>
<a href="#l77.239"></a><span id="l77.239" class="difflineplus">+  nsCOMPtr &lt;nsILocalFile&gt; path;</span>
<a href="#l77.240"></a><span id="l77.240" class="difflineplus">+  nsresult rv = aParent-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l77.241"></a><span id="l77.241" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.242"></a><span id="l77.242" class="difflineplus">+</span>
<a href="#l77.243"></a><span id="l77.243" class="difflineplus">+  // Get a directory based on our current path</span>
<a href="#l77.244"></a><span id="l77.244" class="difflineplus">+  bool isServer;</span>
<a href="#l77.245"></a><span id="l77.245" class="difflineplus">+  aParent-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l77.246"></a><span id="l77.246" class="difflineplus">+  rv = CreateDirectoryForFolder(path, isServer);</span>
<a href="#l77.247"></a><span id="l77.247" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.248"></a><span id="l77.248" class="difflineplus">+</span>
<a href="#l77.249"></a><span id="l77.249" class="difflineplus">+  // Make sure the new folder name is valid</span>
<a href="#l77.250"></a><span id="l77.250" class="difflineplus">+  nsAutoString safeFolderName(aFolderName);</span>
<a href="#l77.251"></a><span id="l77.251" class="difflineplus">+  NS_MsgHashIfNecessary(safeFolderName);</span>
<a href="#l77.252"></a><span id="l77.252" class="difflineplus">+</span>
<a href="#l77.253"></a><span id="l77.253" class="difflineplus">+  path-&gt;Append(safeFolderName);</span>
<a href="#l77.254"></a><span id="l77.254" class="difflineplus">+</span>
<a href="#l77.255"></a><span id="l77.255" class="difflineplus">+  rv = CreateMaildir(path);</span>
<a href="#l77.256"></a><span id="l77.256" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.257"></a><span id="l77.257" class="difflineplus">+</span>
<a href="#l77.258"></a><span id="l77.258" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; child;</span>
<a href="#l77.259"></a><span id="l77.259" class="difflineplus">+  // GetFlags and SetFlags in AddSubfolder will fail because we have no db at</span>
<a href="#l77.260"></a><span id="l77.260" class="difflineplus">+  // this point but mFlags is set.</span>
<a href="#l77.261"></a><span id="l77.261" class="difflineplus">+  rv = aParent-&gt;AddSubfolder(safeFolderName, getter_AddRefs(child));</span>
<a href="#l77.262"></a><span id="l77.262" class="difflineplus">+  if (!child || NS_FAILED(rv))</span>
<a href="#l77.263"></a><span id="l77.263" class="difflineplus">+  {</span>
<a href="#l77.264"></a><span id="l77.264" class="difflineplus">+    path-&gt;Remove(true); // recursive</span>
<a href="#l77.265"></a><span id="l77.265" class="difflineplus">+    return rv;</span>
<a href="#l77.266"></a><span id="l77.266" class="difflineplus">+  }</span>
<a href="#l77.267"></a><span id="l77.267" class="difflineplus">+</span>
<a href="#l77.268"></a><span id="l77.268" class="difflineplus">+  // Create an empty database for this mail folder, set its name from the user</span>
<a href="#l77.269"></a><span id="l77.269" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService =</span>
<a href="#l77.270"></a><span id="l77.270" class="difflineplus">+    do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l77.271"></a><span id="l77.271" class="difflineplus">+  if (msgDBService)</span>
<a href="#l77.272"></a><span id="l77.272" class="difflineplus">+  {</span>
<a href="#l77.273"></a><span id="l77.273" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDatabase&gt; unusedDB;</span>
<a href="#l77.274"></a><span id="l77.274" class="difflineplus">+    rv = msgDBService-&gt;OpenFolderDB(child, true, getter_AddRefs(unusedDB));</span>
<a href="#l77.275"></a><span id="l77.275" class="difflineplus">+    if (rv == NS_MSG_ERROR_FOLDER_SUMMARY_MISSING)</span>
<a href="#l77.276"></a><span id="l77.276" class="difflineplus">+      rv = msgDBService-&gt;CreateNewDB(child, getter_AddRefs(unusedDB));</span>
<a href="#l77.277"></a><span id="l77.277" class="difflineplus">+</span>
<a href="#l77.278"></a><span id="l77.278" class="difflineplus">+    if ((NS_SUCCEEDED(rv) || rv == NS_MSG_ERROR_FOLDER_SUMMARY_OUT_OF_DATE) &amp;&amp;</span>
<a href="#l77.279"></a><span id="l77.279" class="difflineplus">+        unusedDB)</span>
<a href="#l77.280"></a><span id="l77.280" class="difflineplus">+    {</span>
<a href="#l77.281"></a><span id="l77.281" class="difflineplus">+      //need to set the folder name</span>
<a href="#l77.282"></a><span id="l77.282" class="difflineplus">+      nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l77.283"></a><span id="l77.283" class="difflineplus">+      rv = unusedDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l77.284"></a><span id="l77.284" class="difflineplus">+      if (NS_SUCCEEDED(rv))</span>
<a href="#l77.285"></a><span id="l77.285" class="difflineplus">+        folderInfo-&gt;SetMailboxName(safeFolderName);</span>
<a href="#l77.286"></a><span id="l77.286" class="difflineplus">+</span>
<a href="#l77.287"></a><span id="l77.287" class="difflineplus">+      unusedDB-&gt;SetSummaryValid(true);</span>
<a href="#l77.288"></a><span id="l77.288" class="difflineplus">+      unusedDB-&gt;Close(true);</span>
<a href="#l77.289"></a><span id="l77.289" class="difflineplus">+      aParent-&gt;UpdateSummaryTotals(true);</span>
<a href="#l77.290"></a><span id="l77.290" class="difflineplus">+    }</span>
<a href="#l77.291"></a><span id="l77.291" class="difflineplus">+    else</span>
<a href="#l77.292"></a><span id="l77.292" class="difflineplus">+    {</span>
<a href="#l77.293"></a><span id="l77.293" class="difflineplus">+      PR_LOG(MailDirLog, PR_LOG_ALWAYS,</span>
<a href="#l77.294"></a><span id="l77.294" class="difflineplus">+            (&quot;CreateFolder - failed creating db for new folder\n&quot;));</span>
<a href="#l77.295"></a><span id="l77.295" class="difflineplus">+      path-&gt;Remove(true); // recursive</span>
<a href="#l77.296"></a><span id="l77.296" class="difflineplus">+      rv = NS_MSG_CANT_CREATE_FOLDER;</span>
<a href="#l77.297"></a><span id="l77.297" class="difflineplus">+    }</span>
<a href="#l77.298"></a><span id="l77.298" class="difflineplus">+  }</span>
<a href="#l77.299"></a><span id="l77.299" class="difflineplus">+  child.swap(*aResult);</span>
<a href="#l77.300"></a><span id="l77.300" class="difflineplus">+  return rv;</span>
<a href="#l77.301"></a><span id="l77.301" class="difflineplus">+}</span>
<a href="#l77.302"></a><span id="l77.302" class="difflineplus">+</span>
<a href="#l77.303"></a><span id="l77.303" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::HasSpaceAvailable(nsIMsgFolder *aFolder,</span>
<a href="#l77.304"></a><span id="l77.304" class="difflineplus">+                                                   PRInt64 aSpaceRequested,</span>
<a href="#l77.305"></a><span id="l77.305" class="difflineplus">+                                                   bool *aResult)</span>
<a href="#l77.306"></a><span id="l77.306" class="difflineplus">+{</span>
<a href="#l77.307"></a><span id="l77.307" class="difflineplus">+  // This should probably check disk space available, though the caller</span>
<a href="#l77.308"></a><span id="l77.308" class="difflineplus">+  // might be doing that as well.</span>
<a href="#l77.309"></a><span id="l77.309" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l77.310"></a><span id="l77.310" class="difflineplus">+  *aResult = true;</span>
<a href="#l77.311"></a><span id="l77.311" class="difflineplus">+  return NS_OK;</span>
<a href="#l77.312"></a><span id="l77.312" class="difflineplus">+}</span>
<a href="#l77.313"></a><span id="l77.313" class="difflineplus">+</span>
<a href="#l77.314"></a><span id="l77.314" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::IsSummaryFileValid(nsIMsgFolder *aFolder,</span>
<a href="#l77.315"></a><span id="l77.315" class="difflineplus">+                                                    nsIMsgDatabase *aDB,</span>
<a href="#l77.316"></a><span id="l77.316" class="difflineplus">+                                                    bool *aResult)</span>
<a href="#l77.317"></a><span id="l77.317" class="difflineplus">+{</span>
<a href="#l77.318"></a><span id="l77.318" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l77.319"></a><span id="l77.319" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDB);</span>
<a href="#l77.320"></a><span id="l77.320" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l77.321"></a><span id="l77.321" class="difflineplus">+  *aResult = true;</span>
<a href="#l77.322"></a><span id="l77.322" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l77.323"></a><span id="l77.323" class="difflineplus">+  aDB-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l77.324"></a><span id="l77.324" class="difflineplus">+  nsresult rv = dbFolderInfo-&gt;GetBooleanProperty(&quot;maildirValid&quot;, false,</span>
<a href="#l77.325"></a><span id="l77.325" class="difflineplus">+                                                 aResult);</span>
<a href="#l77.326"></a><span id="l77.326" class="difflineplus">+  if (!*aResult)</span>
<a href="#l77.327"></a><span id="l77.327" class="difflineplus">+  {</span>
<a href="#l77.328"></a><span id="l77.328" class="difflineplus">+    nsCOMPtr&lt;nsILocalFile&gt; newFile;</span>
<a href="#l77.329"></a><span id="l77.329" class="difflineplus">+    rv = aFolder-&gt;GetFilePath(getter_AddRefs(newFile));</span>
<a href="#l77.330"></a><span id="l77.330" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.331"></a><span id="l77.331" class="difflineplus">+    newFile-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l77.332"></a><span id="l77.332" class="difflineplus">+</span>
<a href="#l77.333"></a><span id="l77.333" class="difflineplus">+    // If the &quot;cur&quot; sub-dir doesn't exist, and there are no messages</span>
<a href="#l77.334"></a><span id="l77.334" class="difflineplus">+    // in the db, then the folder is probably new and the db is valid.</span>
<a href="#l77.335"></a><span id="l77.335" class="difflineplus">+    bool exists;</span>
<a href="#l77.336"></a><span id="l77.336" class="difflineplus">+    newFile-&gt;Exists(&amp;exists);</span>
<a href="#l77.337"></a><span id="l77.337" class="difflineplus">+    if (!exists)</span>
<a href="#l77.338"></a><span id="l77.338" class="difflineplus">+    {</span>
<a href="#l77.339"></a><span id="l77.339" class="difflineplus">+      PRInt32 numMessages;</span>
<a href="#l77.340"></a><span id="l77.340" class="difflineplus">+      dbFolderInfo-&gt;GetNumMessages(&amp;numMessages);</span>
<a href="#l77.341"></a><span id="l77.341" class="difflineplus">+      if (!numMessages)</span>
<a href="#l77.342"></a><span id="l77.342" class="difflineplus">+        *aResult = true;</span>
<a href="#l77.343"></a><span id="l77.343" class="difflineplus">+    }</span>
<a href="#l77.344"></a><span id="l77.344" class="difflineplus">+  }</span>
<a href="#l77.345"></a><span id="l77.345" class="difflineplus">+  return rv;</span>
<a href="#l77.346"></a><span id="l77.346" class="difflineplus">+}</span>
<a href="#l77.347"></a><span id="l77.347" class="difflineplus">+</span>
<a href="#l77.348"></a><span id="l77.348" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::SetSummaryFileValid(nsIMsgFolder *aFolder,</span>
<a href="#l77.349"></a><span id="l77.349" class="difflineplus">+                                                     nsIMsgDatabase *aDB,</span>
<a href="#l77.350"></a><span id="l77.350" class="difflineplus">+                                                     bool aValid)</span>
<a href="#l77.351"></a><span id="l77.351" class="difflineplus">+{</span>
<a href="#l77.352"></a><span id="l77.352" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l77.353"></a><span id="l77.353" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDB);</span>
<a href="#l77.354"></a><span id="l77.354" class="difflineplus">+  nsCOMPtr&lt;nsIDBFolderInfo&gt; dbFolderInfo;</span>
<a href="#l77.355"></a><span id="l77.355" class="difflineplus">+  aDB-&gt;GetDBFolderInfo(getter_AddRefs(dbFolderInfo));</span>
<a href="#l77.356"></a><span id="l77.356" class="difflineplus">+  return dbFolderInfo-&gt;SetBooleanProperty(&quot;maildirValid&quot;, aValid);</span>
<a href="#l77.357"></a><span id="l77.357" class="difflineplus">+}</span>
<a href="#l77.358"></a><span id="l77.358" class="difflineplus">+</span>
<a href="#l77.359"></a><span id="l77.359" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::GetSummaryFile(nsIMsgFolder *aFolder,</span>
<a href="#l77.360"></a><span id="l77.360" class="difflineplus">+                                                nsILocalFile **aSummaryFile)</span>
<a href="#l77.361"></a><span id="l77.361" class="difflineplus">+{</span>
<a href="#l77.362"></a><span id="l77.362" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l77.363"></a><span id="l77.363" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSummaryFile);</span>
<a href="#l77.364"></a><span id="l77.364" class="difflineplus">+</span>
<a href="#l77.365"></a><span id="l77.365" class="difflineplus">+  nsresult rv;</span>
<a href="#l77.366"></a><span id="l77.366" class="difflineplus">+  nsCOMPtr &lt;nsILocalFile&gt; newSummaryLocation =</span>
<a href="#l77.367"></a><span id="l77.367" class="difflineplus">+    do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l77.368"></a><span id="l77.368" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.369"></a><span id="l77.369" class="difflineplus">+</span>
<a href="#l77.370"></a><span id="l77.370" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; pathFile;</span>
<a href="#l77.371"></a><span id="l77.371" class="difflineplus">+  rv = aFolder-&gt;GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l77.372"></a><span id="l77.372" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.373"></a><span id="l77.373" class="difflineplus">+</span>
<a href="#l77.374"></a><span id="l77.374" class="difflineplus">+  newSummaryLocation-&gt;InitWithFile(pathFile);</span>
<a href="#l77.375"></a><span id="l77.375" class="difflineplus">+  nsString fileName;</span>
<a href="#l77.376"></a><span id="l77.376" class="difflineplus">+</span>
<a href="#l77.377"></a><span id="l77.377" class="difflineplus">+  rv = newSummaryLocation-&gt;GetLeafName(fileName);</span>
<a href="#l77.378"></a><span id="l77.378" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l77.379"></a><span id="l77.379" class="difflineplus">+    return rv;</span>
<a href="#l77.380"></a><span id="l77.380" class="difflineplus">+  fileName.Append(NS_LITERAL_STRING(SUMMARY_SUFFIX));</span>
<a href="#l77.381"></a><span id="l77.381" class="difflineplus">+  rv = newSummaryLocation-&gt;SetLeafName(fileName);</span>
<a href="#l77.382"></a><span id="l77.382" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.383"></a><span id="l77.383" class="difflineplus">+</span>
<a href="#l77.384"></a><span id="l77.384" class="difflineplus">+  NS_IF_ADDREF(*aSummaryFile = newSummaryLocation);</span>
<a href="#l77.385"></a><span id="l77.385" class="difflineplus">+  return NS_OK;</span>
<a href="#l77.386"></a><span id="l77.386" class="difflineplus">+}</span>
<a href="#l77.387"></a><span id="l77.387" class="difflineplus">+</span>
<a href="#l77.388"></a><span id="l77.388" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::DeleteFolder(nsIMsgFolder *aFolder)</span>
<a href="#l77.389"></a><span id="l77.389" class="difflineplus">+{</span>
<a href="#l77.390"></a><span id="l77.390" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l77.391"></a><span id="l77.391" class="difflineplus">+</span>
<a href="#l77.392"></a><span id="l77.392" class="difflineplus">+  // Delete Maildir structure</span>
<a href="#l77.393"></a><span id="l77.393" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; pathFile;</span>
<a href="#l77.394"></a><span id="l77.394" class="difflineplus">+  nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(pathFile));</span>
<a href="#l77.395"></a><span id="l77.395" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.396"></a><span id="l77.396" class="difflineplus">+</span>
<a href="#l77.397"></a><span id="l77.397" class="difflineplus">+  rv = pathFile-&gt;Remove(true); // recursive</span>
<a href="#l77.398"></a><span id="l77.398" class="difflineplus">+  AddDirectorySeparator(pathFile);</span>
<a href="#l77.399"></a><span id="l77.399" class="difflineplus">+  bool exists;</span>
<a href="#l77.400"></a><span id="l77.400" class="difflineplus">+  pathFile-&gt;Exists(&amp;exists);</span>
<a href="#l77.401"></a><span id="l77.401" class="difflineplus">+  if (exists)</span>
<a href="#l77.402"></a><span id="l77.402" class="difflineplus">+    pathFile-&gt;Remove(true);</span>
<a href="#l77.403"></a><span id="l77.403" class="difflineplus">+  return rv;</span>
<a href="#l77.404"></a><span id="l77.404" class="difflineplus">+}</span>
<a href="#l77.405"></a><span id="l77.405" class="difflineplus">+</span>
<a href="#l77.406"></a><span id="l77.406" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::RenameFolder(nsIMsgFolder *aFolder,</span>
<a href="#l77.407"></a><span id="l77.407" class="difflineplus">+                                              const nsAString &amp; aNewName,</span>
<a href="#l77.408"></a><span id="l77.408" class="difflineplus">+                                              nsIMsgFolder **aNewFolder)</span>
<a href="#l77.409"></a><span id="l77.409" class="difflineplus">+{</span>
<a href="#l77.410"></a><span id="l77.410" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l77.411"></a><span id="l77.411" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNewFolder);</span>
<a href="#l77.412"></a><span id="l77.412" class="difflineplus">+</span>
<a href="#l77.413"></a><span id="l77.413" class="difflineplus">+  // old path</span>
<a href="#l77.414"></a><span id="l77.414" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; oldPathFile;</span>
<a href="#l77.415"></a><span id="l77.415" class="difflineplus">+  nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(oldPathFile));</span>
<a href="#l77.416"></a><span id="l77.416" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.417"></a><span id="l77.417" class="difflineplus">+</span>
<a href="#l77.418"></a><span id="l77.418" class="difflineplus">+  // old sbd directory</span>
<a href="#l77.419"></a><span id="l77.419" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; sbdPathFile;</span>
<a href="#l77.420"></a><span id="l77.420" class="difflineplus">+  PRUint32 numChildren;</span>
<a href="#l77.421"></a><span id="l77.421" class="difflineplus">+  aFolder-&gt;GetNumSubFolders(&amp;numChildren);</span>
<a href="#l77.422"></a><span id="l77.422" class="difflineplus">+  if (numChildren &gt; 0)</span>
<a href="#l77.423"></a><span id="l77.423" class="difflineplus">+  {</span>
<a href="#l77.424"></a><span id="l77.424" class="difflineplus">+    sbdPathFile = do_CreateInstance(NS_LOCAL_FILE_CONTRACTID, &amp;rv);</span>
<a href="#l77.425"></a><span id="l77.425" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.426"></a><span id="l77.426" class="difflineplus">+    rv = sbdPathFile-&gt;InitWithFile(oldPathFile);</span>
<a href="#l77.427"></a><span id="l77.427" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.428"></a><span id="l77.428" class="difflineplus">+    GetDirectoryForFolder(sbdPathFile);</span>
<a href="#l77.429"></a><span id="l77.429" class="difflineplus">+  }</span>
<a href="#l77.430"></a><span id="l77.430" class="difflineplus">+</span>
<a href="#l77.431"></a><span id="l77.431" class="difflineplus">+  // old summary</span>
<a href="#l77.432"></a><span id="l77.432" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; oldSummaryFile;</span>
<a href="#l77.433"></a><span id="l77.433" class="difflineplus">+  rv = GetSummaryFile(aFolder, getter_AddRefs(oldSummaryFile));</span>
<a href="#l77.434"></a><span id="l77.434" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.435"></a><span id="l77.435" class="difflineplus">+</span>
<a href="#l77.436"></a><span id="l77.436" class="difflineplus">+  // Validate new name</span>
<a href="#l77.437"></a><span id="l77.437" class="difflineplus">+  nsAutoString safeName(aNewName);</span>
<a href="#l77.438"></a><span id="l77.438" class="difflineplus">+  NS_MsgHashIfNecessary(safeName);</span>
<a href="#l77.439"></a><span id="l77.439" class="difflineplus">+</span>
<a href="#l77.440"></a><span id="l77.440" class="difflineplus">+  aFolder-&gt;ForceDBClosed();</span>
<a href="#l77.441"></a><span id="l77.441" class="difflineplus">+</span>
<a href="#l77.442"></a><span id="l77.442" class="difflineplus">+  // rename folder</span>
<a href="#l77.443"></a><span id="l77.443" class="difflineplus">+  rv = oldPathFile-&gt;MoveTo(nsnull, safeName);</span>
<a href="#l77.444"></a><span id="l77.444" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.445"></a><span id="l77.445" class="difflineplus">+</span>
<a href="#l77.446"></a><span id="l77.446" class="difflineplus">+  if (numChildren &gt; 0)</span>
<a href="#l77.447"></a><span id="l77.447" class="difflineplus">+  {</span>
<a href="#l77.448"></a><span id="l77.448" class="difflineplus">+    // rename &quot;*.sbd&quot; directory</span>
<a href="#l77.449"></a><span id="l77.449" class="difflineplus">+    nsAutoString sbdName = safeName;</span>
<a href="#l77.450"></a><span id="l77.450" class="difflineplus">+    sbdName += NS_LITERAL_STRING(FOLDER_SUFFIX);</span>
<a href="#l77.451"></a><span id="l77.451" class="difflineplus">+    sbdPathFile-&gt;MoveTo(nsnull, sbdName);</span>
<a href="#l77.452"></a><span id="l77.452" class="difflineplus">+  }</span>
<a href="#l77.453"></a><span id="l77.453" class="difflineplus">+</span>
<a href="#l77.454"></a><span id="l77.454" class="difflineplus">+  // rename summary</span>
<a href="#l77.455"></a><span id="l77.455" class="difflineplus">+  safeName += NS_LITERAL_STRING(SUMMARY_SUFFIX);</span>
<a href="#l77.456"></a><span id="l77.456" class="difflineplus">+  oldSummaryFile-&gt;MoveTo(nsnull, safeName);</span>
<a href="#l77.457"></a><span id="l77.457" class="difflineplus">+</span>
<a href="#l77.458"></a><span id="l77.458" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l77.459"></a><span id="l77.459" class="difflineplus">+  rv = aFolder-&gt;GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l77.460"></a><span id="l77.460" class="difflineplus">+  if (!parentFolder)</span>
<a href="#l77.461"></a><span id="l77.461" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l77.462"></a><span id="l77.462" class="difflineplus">+</span>
<a href="#l77.463"></a><span id="l77.463" class="difflineplus">+  return parentFolder-&gt;AddSubfolder(safeName, aNewFolder);</span>
<a href="#l77.464"></a><span id="l77.464" class="difflineplus">+}</span>
<a href="#l77.465"></a><span id="l77.465" class="difflineplus">+</span>
<a href="#l77.466"></a><span id="l77.466" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::CopyFolder(nsIMsgFolder *aSrcFolder,</span>
<a href="#l77.467"></a><span id="l77.467" class="difflineplus">+                                            nsIMsgFolder *aDstFolder,</span>
<a href="#l77.468"></a><span id="l77.468" class="difflineplus">+                                            bool aIsMoveFolder,</span>
<a href="#l77.469"></a><span id="l77.469" class="difflineplus">+                                            nsIMsgWindow *aMsgWindow,</span>
<a href="#l77.470"></a><span id="l77.470" class="difflineplus">+                                            nsIMsgCopyServiceListener *aListener)</span>
<a href="#l77.471"></a><span id="l77.471" class="difflineplus">+{</span>
<a href="#l77.472"></a><span id="l77.472" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSrcFolder);</span>
<a href="#l77.473"></a><span id="l77.473" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDstFolder);</span>
<a href="#l77.474"></a><span id="l77.474" class="difflineplus">+  nsString folderName;</span>
<a href="#l77.475"></a><span id="l77.475" class="difflineplus">+  aSrcFolder-&gt;GetName(folderName);</span>
<a href="#l77.476"></a><span id="l77.476" class="difflineplus">+  nsAutoString safeFolderName(folderName);</span>
<a href="#l77.477"></a><span id="l77.477" class="difflineplus">+  NS_MsgHashIfNecessary(safeFolderName);</span>
<a href="#l77.478"></a><span id="l77.478" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localSrcFolder(do_QueryInterface(aSrcFolder));</span>
<a href="#l77.479"></a><span id="l77.479" class="difflineplus">+  aSrcFolder-&gt;ForceDBClosed();</span>
<a href="#l77.480"></a><span id="l77.480" class="difflineplus">+</span>
<a href="#l77.481"></a><span id="l77.481" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; oldPath;</span>
<a href="#l77.482"></a><span id="l77.482" class="difflineplus">+  nsresult rv = aSrcFolder-&gt;GetFilePath(getter_AddRefs(oldPath));</span>
<a href="#l77.483"></a><span id="l77.483" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l77.484"></a><span id="l77.484" class="difflineplus">+</span>
<a href="#l77.485"></a><span id="l77.485" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; summaryFile;</span>
<a href="#l77.486"></a><span id="l77.486" class="difflineplus">+  GetSummaryFileLocation(oldPath, getter_AddRefs(summaryFile));</span>
<a href="#l77.487"></a><span id="l77.487" class="difflineplus">+</span>
<a href="#l77.488"></a><span id="l77.488" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; newPath;</span>
<a href="#l77.489"></a><span id="l77.489" class="difflineplus">+  rv = aDstFolder-&gt;GetFilePath(getter_AddRefs(newPath));</span>
<a href="#l77.490"></a><span id="l77.490" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.491"></a><span id="l77.491" class="difflineplus">+</span>
<a href="#l77.492"></a><span id="l77.492" class="difflineplus">+  // create target directory based on our current path</span>
<a href="#l77.493"></a><span id="l77.493" class="difflineplus">+  bool isServer;</span>
<a href="#l77.494"></a><span id="l77.494" class="difflineplus">+  aDstFolder-&gt;GetIsServer(&amp;isServer);</span>
<a href="#l77.495"></a><span id="l77.495" class="difflineplus">+  rv = CreateDirectoryForFolder(newPath, isServer);</span>
<a href="#l77.496"></a><span id="l77.496" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.497"></a><span id="l77.497" class="difflineplus">+</span>
<a href="#l77.498"></a><span id="l77.498" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; origPath;</span>
<a href="#l77.499"></a><span id="l77.499" class="difflineplus">+  oldPath-&gt;Clone(getter_AddRefs(origPath));</span>
<a href="#l77.500"></a><span id="l77.500" class="difflineplus">+</span>
<a href="#l77.501"></a><span id="l77.501" class="difflineplus">+  rv = oldPath-&gt;CopyTo(newPath, EmptyString());</span>
<a href="#l77.502"></a><span id="l77.502" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv); //will fail if a file by that name exists</span>
<a href="#l77.503"></a><span id="l77.503" class="difflineplus">+</span>
<a href="#l77.504"></a><span id="l77.504" class="difflineplus">+  // Copy to dir can fail if file does not exist. If copy fails, we test</span>
<a href="#l77.505"></a><span id="l77.505" class="difflineplus">+  // if the file exists or not, if it does not that's ok, we continue</span>
<a href="#l77.506"></a><span id="l77.506" class="difflineplus">+  // without copying it. If it fails and file exist and is not zero sized</span>
<a href="#l77.507"></a><span id="l77.507" class="difflineplus">+  // there is real problem.</span>
<a href="#l77.508"></a><span id="l77.508" class="difflineplus">+  rv = summaryFile-&gt;CopyTo(newPath, EmptyString());</span>
<a href="#l77.509"></a><span id="l77.509" class="difflineplus">+  if (!NS_SUCCEEDED(rv))</span>
<a href="#l77.510"></a><span id="l77.510" class="difflineplus">+  {</span>
<a href="#l77.511"></a><span id="l77.511" class="difflineplus">+    // Test if the file is not empty</span>
<a href="#l77.512"></a><span id="l77.512" class="difflineplus">+    bool exists;</span>
<a href="#l77.513"></a><span id="l77.513" class="difflineplus">+    PRInt64 fileSize;</span>
<a href="#l77.514"></a><span id="l77.514" class="difflineplus">+    summaryFile-&gt;Exists(&amp;exists);</span>
<a href="#l77.515"></a><span id="l77.515" class="difflineplus">+    summaryFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l77.516"></a><span id="l77.516" class="difflineplus">+    if (exists &amp;&amp; fileSize &gt; 0)</span>
<a href="#l77.517"></a><span id="l77.517" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv); // Yes, it should have worked!</span>
<a href="#l77.518"></a><span id="l77.518" class="difflineplus">+    // else case is file is zero sized, no need to copy it,</span>
<a href="#l77.519"></a><span id="l77.519" class="difflineplus">+    // not an error</span>
<a href="#l77.520"></a><span id="l77.520" class="difflineplus">+    // else case is file does not exist - not an error</span>
<a href="#l77.521"></a><span id="l77.521" class="difflineplus">+  }</span>
<a href="#l77.522"></a><span id="l77.522" class="difflineplus">+</span>
<a href="#l77.523"></a><span id="l77.523" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; newMsgFolder;</span>
<a href="#l77.524"></a><span id="l77.524" class="difflineplus">+  rv = aDstFolder-&gt;AddSubfolder(safeFolderName, getter_AddRefs(newMsgFolder));</span>
<a href="#l77.525"></a><span id="l77.525" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.526"></a><span id="l77.526" class="difflineplus">+</span>
<a href="#l77.527"></a><span id="l77.527" class="difflineplus">+  newMsgFolder-&gt;SetPrettyName(folderName);</span>
<a href="#l77.528"></a><span id="l77.528" class="difflineplus">+  PRUint32 flags;</span>
<a href="#l77.529"></a><span id="l77.529" class="difflineplus">+  aSrcFolder-&gt;GetFlags(&amp;flags);</span>
<a href="#l77.530"></a><span id="l77.530" class="difflineplus">+  newMsgFolder-&gt;SetFlags(flags);</span>
<a href="#l77.531"></a><span id="l77.531" class="difflineplus">+  bool changed = false;</span>
<a href="#l77.532"></a><span id="l77.532" class="difflineplus">+  rv = aSrcFolder-&gt;MatchOrChangeFilterDestination(newMsgFolder, true, &amp;changed);</span>
<a href="#l77.533"></a><span id="l77.533" class="difflineplus">+  if (changed)</span>
<a href="#l77.534"></a><span id="l77.534" class="difflineplus">+    aSrcFolder-&gt;AlertFilterChanged(aMsgWindow);</span>
<a href="#l77.535"></a><span id="l77.535" class="difflineplus">+</span>
<a href="#l77.536"></a><span id="l77.536" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; enumerator;</span>
<a href="#l77.537"></a><span id="l77.537" class="difflineplus">+  rv = aSrcFolder-&gt;GetSubFolders(getter_AddRefs(enumerator));</span>
<a href="#l77.538"></a><span id="l77.538" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.539"></a><span id="l77.539" class="difflineplus">+</span>
<a href="#l77.540"></a><span id="l77.540" class="difflineplus">+  // Copy subfolders to the new location</span>
<a href="#l77.541"></a><span id="l77.541" class="difflineplus">+  nsresult copyStatus = NS_OK;</span>
<a href="#l77.542"></a><span id="l77.542" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localNewFolder(do_QueryInterface(newMsgFolder, &amp;rv));</span>
<a href="#l77.543"></a><span id="l77.543" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l77.544"></a><span id="l77.544" class="difflineplus">+  {</span>
<a href="#l77.545"></a><span id="l77.545" class="difflineplus">+    bool hasMore;</span>
<a href="#l77.546"></a><span id="l77.546" class="difflineplus">+    while (NS_SUCCEEDED(enumerator-&gt;HasMoreElements(&amp;hasMore)) &amp;&amp; hasMore &amp;&amp;</span>
<a href="#l77.547"></a><span id="l77.547" class="difflineplus">+           NS_SUCCEEDED(copyStatus))</span>
<a href="#l77.548"></a><span id="l77.548" class="difflineplus">+    {</span>
<a href="#l77.549"></a><span id="l77.549" class="difflineplus">+      nsCOMPtr&lt;nsISupports&gt; item;</span>
<a href="#l77.550"></a><span id="l77.550" class="difflineplus">+      enumerator-&gt;GetNext(getter_AddRefs(item));</span>
<a href="#l77.551"></a><span id="l77.551" class="difflineplus">+</span>
<a href="#l77.552"></a><span id="l77.552" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; folder(do_QueryInterface(item));</span>
<a href="#l77.553"></a><span id="l77.553" class="difflineplus">+      if (!folder)</span>
<a href="#l77.554"></a><span id="l77.554" class="difflineplus">+        continue;</span>
<a href="#l77.555"></a><span id="l77.555" class="difflineplus">+</span>
<a href="#l77.556"></a><span id="l77.556" class="difflineplus">+      copyStatus = localNewFolder-&gt;CopyFolderLocal(folder, false, aMsgWindow,</span>
<a href="#l77.557"></a><span id="l77.557" class="difflineplus">+                                                   aListener);</span>
<a href="#l77.558"></a><span id="l77.558" class="difflineplus">+      // Test if the call succeeded, if not we have to stop recursive call</span>
<a href="#l77.559"></a><span id="l77.559" class="difflineplus">+      if (NS_FAILED(copyStatus))</span>
<a href="#l77.560"></a><span id="l77.560" class="difflineplus">+      {</span>
<a href="#l77.561"></a><span id="l77.561" class="difflineplus">+        // Copy failed we have to notify caller to handle the error and stop</span>
<a href="#l77.562"></a><span id="l77.562" class="difflineplus">+        // moving the folders. In case this happens to the topmost level of</span>
<a href="#l77.563"></a><span id="l77.563" class="difflineplus">+        // recursive call, then we just need to break from the while loop and</span>
<a href="#l77.564"></a><span id="l77.564" class="difflineplus">+        // go to error handling code.</span>
<a href="#l77.565"></a><span id="l77.565" class="difflineplus">+        if (!aIsMoveFolder)</span>
<a href="#l77.566"></a><span id="l77.566" class="difflineplus">+          return copyStatus;</span>
<a href="#l77.567"></a><span id="l77.567" class="difflineplus">+        break;</span>
<a href="#l77.568"></a><span id="l77.568" class="difflineplus">+      }</span>
<a href="#l77.569"></a><span id="l77.569" class="difflineplus">+    }</span>
<a href="#l77.570"></a><span id="l77.570" class="difflineplus">+  }</span>
<a href="#l77.571"></a><span id="l77.571" class="difflineplus">+</span>
<a href="#l77.572"></a><span id="l77.572" class="difflineplus">+  if (aIsMoveFolder &amp;&amp; NS_SUCCEEDED(copyStatus))</span>
<a href="#l77.573"></a><span id="l77.573" class="difflineplus">+  {</span>
<a href="#l77.574"></a><span id="l77.574" class="difflineplus">+    if (localNewFolder)</span>
<a href="#l77.575"></a><span id="l77.575" class="difflineplus">+    {</span>
<a href="#l77.576"></a><span id="l77.576" class="difflineplus">+      nsCOMPtr&lt;nsISupports&gt; srcSupport(do_QueryInterface(aSrcFolder));</span>
<a href="#l77.577"></a><span id="l77.577" class="difflineplus">+      localNewFolder-&gt;OnCopyCompleted(srcSupport, true);</span>
<a href="#l77.578"></a><span id="l77.578" class="difflineplus">+    }</span>
<a href="#l77.579"></a><span id="l77.579" class="difflineplus">+</span>
<a href="#l77.580"></a><span id="l77.580" class="difflineplus">+    // Notify that the folder that was dragged and dropped has been created.</span>
<a href="#l77.581"></a><span id="l77.581" class="difflineplus">+    // No need to do this for its subfolders - isMoveFolder will be true for folder.</span>
<a href="#l77.582"></a><span id="l77.582" class="difflineplus">+    aDstFolder-&gt;NotifyItemAdded(newMsgFolder);</span>
<a href="#l77.583"></a><span id="l77.583" class="difflineplus">+</span>
<a href="#l77.584"></a><span id="l77.584" class="difflineplus">+    nsCOMPtr&lt;nsIMsgFolder&gt; msgParent;</span>
<a href="#l77.585"></a><span id="l77.585" class="difflineplus">+    aSrcFolder-&gt;GetParent(getter_AddRefs(msgParent));</span>
<a href="#l77.586"></a><span id="l77.586" class="difflineplus">+    aSrcFolder-&gt;SetParent(nsnull);</span>
<a href="#l77.587"></a><span id="l77.587" class="difflineplus">+    if (msgParent)</span>
<a href="#l77.588"></a><span id="l77.588" class="difflineplus">+    {</span>
<a href="#l77.589"></a><span id="l77.589" class="difflineplus">+      // The files have already been moved, so delete storage false</span>
<a href="#l77.590"></a><span id="l77.590" class="difflineplus">+      msgParent-&gt;PropagateDelete(aSrcFolder, false, aMsgWindow);</span>
<a href="#l77.591"></a><span id="l77.591" class="difflineplus">+      oldPath-&gt;Remove(true);</span>
<a href="#l77.592"></a><span id="l77.592" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB; // we need to force closed the source db</span>
<a href="#l77.593"></a><span id="l77.593" class="difflineplus">+      aSrcFolder-&gt;Delete();</span>
<a href="#l77.594"></a><span id="l77.594" class="difflineplus">+</span>
<a href="#l77.595"></a><span id="l77.595" class="difflineplus">+      nsCOMPtr&lt;nsILocalFile&gt; parentPath;</span>
<a href="#l77.596"></a><span id="l77.596" class="difflineplus">+      rv = msgParent-&gt;GetFilePath(getter_AddRefs(parentPath));</span>
<a href="#l77.597"></a><span id="l77.597" class="difflineplus">+      NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l77.598"></a><span id="l77.598" class="difflineplus">+</span>
<a href="#l77.599"></a><span id="l77.599" class="difflineplus">+      AddDirectorySeparator(parentPath);</span>
<a href="#l77.600"></a><span id="l77.600" class="difflineplus">+      nsCOMPtr&lt;nsISimpleEnumerator&gt; children;</span>
<a href="#l77.601"></a><span id="l77.601" class="difflineplus">+      parentPath-&gt;GetDirectoryEntries(getter_AddRefs(children));</span>
<a href="#l77.602"></a><span id="l77.602" class="difflineplus">+      bool more;</span>
<a href="#l77.603"></a><span id="l77.603" class="difflineplus">+      // checks if the directory is empty or not</span>
<a href="#l77.604"></a><span id="l77.604" class="difflineplus">+      if (children &amp;&amp; NS_SUCCEEDED(children-&gt;HasMoreElements(&amp;more)) &amp;&amp; !more)</span>
<a href="#l77.605"></a><span id="l77.605" class="difflineplus">+        parentPath-&gt;Remove(true);</span>
<a href="#l77.606"></a><span id="l77.606" class="difflineplus">+    }</span>
<a href="#l77.607"></a><span id="l77.607" class="difflineplus">+  }</span>
<a href="#l77.608"></a><span id="l77.608" class="difflineplus">+  else</span>
<a href="#l77.609"></a><span id="l77.609" class="difflineplus">+  {</span>
<a href="#l77.610"></a><span id="l77.610" class="difflineplus">+    // This is the case where the copy of a subfolder failed.</span>
<a href="#l77.611"></a><span id="l77.611" class="difflineplus">+    // We have to delete the newDirectory tree to make a &quot;rollback&quot;.</span>
<a href="#l77.612"></a><span id="l77.612" class="difflineplus">+    // Someone should add a popup to warn the user that the move was not</span>
<a href="#l77.613"></a><span id="l77.613" class="difflineplus">+    // possible.</span>
<a href="#l77.614"></a><span id="l77.614" class="difflineplus">+    if (aIsMoveFolder &amp;&amp; NS_FAILED(copyStatus))</span>
<a href="#l77.615"></a><span id="l77.615" class="difflineplus">+    {</span>
<a href="#l77.616"></a><span id="l77.616" class="difflineplus">+      nsCOMPtr&lt;nsIMsgFolder&gt; msgParent;</span>
<a href="#l77.617"></a><span id="l77.617" class="difflineplus">+      newMsgFolder-&gt;ForceDBClosed();</span>
<a href="#l77.618"></a><span id="l77.618" class="difflineplus">+      newMsgFolder-&gt;GetParent(getter_AddRefs(msgParent));</span>
<a href="#l77.619"></a><span id="l77.619" class="difflineplus">+      newMsgFolder-&gt;SetParent(nsnull);</span>
<a href="#l77.620"></a><span id="l77.620" class="difflineplus">+      if (msgParent)</span>
<a href="#l77.621"></a><span id="l77.621" class="difflineplus">+      {</span>
<a href="#l77.622"></a><span id="l77.622" class="difflineplus">+        msgParent-&gt;PropagateDelete(newMsgFolder, false, aMsgWindow);</span>
<a href="#l77.623"></a><span id="l77.623" class="difflineplus">+        newMsgFolder-&gt;Delete();</span>
<a href="#l77.624"></a><span id="l77.624" class="difflineplus">+        newMsgFolder-&gt;ForceDBClosed();</span>
<a href="#l77.625"></a><span id="l77.625" class="difflineplus">+        AddDirectorySeparator(newPath);</span>
<a href="#l77.626"></a><span id="l77.626" class="difflineplus">+        newPath-&gt;Remove(true); //berkeley mailbox</span>
<a href="#l77.627"></a><span id="l77.627" class="difflineplus">+      }</span>
<a href="#l77.628"></a><span id="l77.628" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l77.629"></a><span id="l77.629" class="difflineplus">+    }</span>
<a href="#l77.630"></a><span id="l77.630" class="difflineplus">+  }</span>
<a href="#l77.631"></a><span id="l77.631" class="difflineplus">+  return NS_OK;</span>
<a href="#l77.632"></a><span id="l77.632" class="difflineplus">+}</span>
<a href="#l77.633"></a><span id="l77.633" class="difflineplus">+</span>
<a href="#l77.634"></a><span id="l77.634" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l77.635"></a><span id="l77.635" class="difflineplus">+nsMsgMaildirStore::GetNewMsgOutputStream(nsIMsgFolder *aFolder,</span>
<a href="#l77.636"></a><span id="l77.636" class="difflineplus">+                                         nsIMsgDBHdr **aNewMsgHdr,</span>
<a href="#l77.637"></a><span id="l77.637" class="difflineplus">+                                         bool *aReusable,</span>
<a href="#l77.638"></a><span id="l77.638" class="difflineplus">+                                         nsIOutputStream **aResult)</span>
<a href="#l77.639"></a><span id="l77.639" class="difflineplus">+{</span>
<a href="#l77.640"></a><span id="l77.640" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l77.641"></a><span id="l77.641" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNewMsgHdr);</span>
<a href="#l77.642"></a><span id="l77.642" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aReusable);</span>
<a href="#l77.643"></a><span id="l77.643" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l77.644"></a><span id="l77.644" class="difflineplus">+</span>
<a href="#l77.645"></a><span id="l77.645" class="difflineplus">+  *aReusable = false; // message per file</span>
<a href="#l77.646"></a><span id="l77.646" class="difflineplus">+</span>
<a href="#l77.647"></a><span id="l77.647" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l77.648"></a><span id="l77.648" class="difflineplus">+  aFolder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l77.649"></a><span id="l77.649" class="difflineplus">+  if (!db)</span>
<a href="#l77.650"></a><span id="l77.650" class="difflineplus">+    NS_ERROR(&quot;no db&quot;);</span>
<a href="#l77.651"></a><span id="l77.651" class="difflineplus">+</span>
<a href="#l77.652"></a><span id="l77.652" class="difflineplus">+  nsresult rv;</span>
<a href="#l77.653"></a><span id="l77.653" class="difflineplus">+</span>
<a href="#l77.654"></a><span id="l77.654" class="difflineplus">+  if (!*aNewMsgHdr)</span>
<a href="#l77.655"></a><span id="l77.655" class="difflineplus">+  {</span>
<a href="#l77.656"></a><span id="l77.656" class="difflineplus">+    rv = db-&gt;CreateNewHdr(nsMsgKey_None, aNewMsgHdr);</span>
<a href="#l77.657"></a><span id="l77.657" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.658"></a><span id="l77.658" class="difflineplus">+</span>
<a href="#l77.659"></a><span id="l77.659" class="difflineplus">+    (*aNewMsgHdr)-&gt;SetMessageOffset(0);</span>
<a href="#l77.660"></a><span id="l77.660" class="difflineplus">+  }</span>
<a href="#l77.661"></a><span id="l77.661" class="difflineplus">+  // path to the message download folder</span>
<a href="#l77.662"></a><span id="l77.662" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; newFile;</span>
<a href="#l77.663"></a><span id="l77.663" class="difflineplus">+  rv = aFolder-&gt;GetFilePath(getter_AddRefs(newFile));</span>
<a href="#l77.664"></a><span id="l77.664" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.665"></a><span id="l77.665" class="difflineplus">+  newFile-&gt;Append(NS_LITERAL_STRING(&quot;tmp&quot;));</span>
<a href="#l77.666"></a><span id="l77.666" class="difflineplus">+</span>
<a href="#l77.667"></a><span id="l77.667" class="difflineplus">+  // let's check if the folder exists</span>
<a href="#l77.668"></a><span id="l77.668" class="difflineplus">+  bool exists;</span>
<a href="#l77.669"></a><span id="l77.669" class="difflineplus">+  newFile-&gt;Exists(&amp;exists);</span>
<a href="#l77.670"></a><span id="l77.670" class="difflineplus">+  if (!exists) {</span>
<a href="#l77.671"></a><span id="l77.671" class="difflineplus">+    PR_LOG(MailDirLog, PR_LOG_ALWAYS,</span>
<a href="#l77.672"></a><span id="l77.672" class="difflineplus">+           (&quot;GetNewMsgOutputStream - tmp subfolder does not exist!!\n&quot;));</span>
<a href="#l77.673"></a><span id="l77.673" class="difflineplus">+    rv = newFile-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l77.674"></a><span id="l77.674" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.675"></a><span id="l77.675" class="difflineplus">+  }</span>
<a href="#l77.676"></a><span id="l77.676" class="difflineplus">+</span>
<a href="#l77.677"></a><span id="l77.677" class="difflineplus">+  // generate new file name</span>
<a href="#l77.678"></a><span id="l77.678" class="difflineplus">+  nsCAutoString newName;</span>
<a href="#l77.679"></a><span id="l77.679" class="difflineplus">+  newName.AppendInt(PR_Now());</span>
<a href="#l77.680"></a><span id="l77.680" class="difflineplus">+  newFile-&gt;AppendNative(newName);</span>
<a href="#l77.681"></a><span id="l77.681" class="difflineplus">+  // CreateUnique, in case we get more than one message per millisecond :-)</span>
<a href="#l77.682"></a><span id="l77.682" class="difflineplus">+  newFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l77.683"></a><span id="l77.683" class="difflineplus">+  newFile-&gt;GetNativeLeafName(newName);</span>
<a href="#l77.684"></a><span id="l77.684" class="difflineplus">+  // save the file name in the message header - otherwise no way to retrieve it</span>
<a href="#l77.685"></a><span id="l77.685" class="difflineplus">+  (*aNewMsgHdr)-&gt;SetStringProperty(&quot;storeToken&quot;, newName.get());</span>
<a href="#l77.686"></a><span id="l77.686" class="difflineplus">+  return MsgNewBufferedFileOutputStream(aResult, newFile,</span>
<a href="#l77.687"></a><span id="l77.687" class="difflineplus">+                                        PR_WRONLY | PR_CREATE_FILE, 00600);</span>
<a href="#l77.688"></a><span id="l77.688" class="difflineplus">+}</span>
<a href="#l77.689"></a><span id="l77.689" class="difflineplus">+</span>
<a href="#l77.690"></a><span id="l77.690" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l77.691"></a><span id="l77.691" class="difflineplus">+nsMsgMaildirStore::DiscardNewMessage(nsIOutputStream *aOutputStream,</span>
<a href="#l77.692"></a><span id="l77.692" class="difflineplus">+                                     nsIMsgDBHdr *aNewHdr)</span>
<a href="#l77.693"></a><span id="l77.693" class="difflineplus">+{</span>
<a href="#l77.694"></a><span id="l77.694" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aOutputStream);</span>
<a href="#l77.695"></a><span id="l77.695" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNewHdr);</span>
<a href="#l77.696"></a><span id="l77.696" class="difflineplus">+</span>
<a href="#l77.697"></a><span id="l77.697" class="difflineplus">+  aOutputStream-&gt;Close();</span>
<a href="#l77.698"></a><span id="l77.698" class="difflineplus">+  // file path is stored in message header property &quot;storeToken&quot;</span>
<a href="#l77.699"></a><span id="l77.699" class="difflineplus">+  nsCAutoString fileName;</span>
<a href="#l77.700"></a><span id="l77.700" class="difflineplus">+  aNewHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(fileName));</span>
<a href="#l77.701"></a><span id="l77.701" class="difflineplus">+  if (fileName.IsEmpty())</span>
<a href="#l77.702"></a><span id="l77.702" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l77.703"></a><span id="l77.703" class="difflineplus">+</span>
<a href="#l77.704"></a><span id="l77.704" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l77.705"></a><span id="l77.705" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l77.706"></a><span id="l77.706" class="difflineplus">+  nsresult rv = aNewHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l77.707"></a><span id="l77.707" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.708"></a><span id="l77.708" class="difflineplus">+  rv = folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l77.709"></a><span id="l77.709" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.710"></a><span id="l77.710" class="difflineplus">+</span>
<a href="#l77.711"></a><span id="l77.711" class="difflineplus">+  // path to the message download folder</span>
<a href="#l77.712"></a><span id="l77.712" class="difflineplus">+  path-&gt;Append(NS_LITERAL_STRING(&quot;tmp&quot;));</span>
<a href="#l77.713"></a><span id="l77.713" class="difflineplus">+  path-&gt;AppendNative(fileName);</span>
<a href="#l77.714"></a><span id="l77.714" class="difflineplus">+</span>
<a href="#l77.715"></a><span id="l77.715" class="difflineplus">+  return path-&gt;Remove(false);</span>
<a href="#l77.716"></a><span id="l77.716" class="difflineplus">+}</span>
<a href="#l77.717"></a><span id="l77.717" class="difflineplus">+</span>
<a href="#l77.718"></a><span id="l77.718" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l77.719"></a><span id="l77.719" class="difflineplus">+nsMsgMaildirStore::FinishNewMessage(nsIOutputStream *aOutputStream,</span>
<a href="#l77.720"></a><span id="l77.720" class="difflineplus">+                                    nsIMsgDBHdr *aNewHdr)</span>
<a href="#l77.721"></a><span id="l77.721" class="difflineplus">+{</span>
<a href="#l77.722"></a><span id="l77.722" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aOutputStream);</span>
<a href="#l77.723"></a><span id="l77.723" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNewHdr);</span>
<a href="#l77.724"></a><span id="l77.724" class="difflineplus">+</span>
<a href="#l77.725"></a><span id="l77.725" class="difflineplus">+  aOutputStream-&gt;Close();</span>
<a href="#l77.726"></a><span id="l77.726" class="difflineplus">+</span>
<a href="#l77.727"></a><span id="l77.727" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; folderPath;</span>
<a href="#l77.728"></a><span id="l77.728" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l77.729"></a><span id="l77.729" class="difflineplus">+  nsresult rv = aNewHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l77.730"></a><span id="l77.730" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.731"></a><span id="l77.731" class="difflineplus">+  rv = folder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l77.732"></a><span id="l77.732" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.733"></a><span id="l77.733" class="difflineplus">+</span>
<a href="#l77.734"></a><span id="l77.734" class="difflineplus">+  // file path is stored in message header property</span>
<a href="#l77.735"></a><span id="l77.735" class="difflineplus">+  nsCAutoString fileName;</span>
<a href="#l77.736"></a><span id="l77.736" class="difflineplus">+  aNewHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(fileName));</span>
<a href="#l77.737"></a><span id="l77.737" class="difflineplus">+  if (fileName.IsEmpty())</span>
<a href="#l77.738"></a><span id="l77.738" class="difflineplus">+  {</span>
<a href="#l77.739"></a><span id="l77.739" class="difflineplus">+    NS_ERROR(&quot;FinishNewMessage - no storeToken in msg hdr!!\n&quot;);</span>
<a href="#l77.740"></a><span id="l77.740" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l77.741"></a><span id="l77.741" class="difflineplus">+  }</span>
<a href="#l77.742"></a><span id="l77.742" class="difflineplus">+</span>
<a href="#l77.743"></a><span id="l77.743" class="difflineplus">+  // path to the downloaded message</span>
<a href="#l77.744"></a><span id="l77.744" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; fromPath;</span>
<a href="#l77.745"></a><span id="l77.745" class="difflineplus">+  folderPath-&gt;Clone(getter_AddRefs(fromPath));</span>
<a href="#l77.746"></a><span id="l77.746" class="difflineplus">+  fromPath-&gt;Append(NS_LITERAL_STRING(&quot;tmp&quot;));</span>
<a href="#l77.747"></a><span id="l77.747" class="difflineplus">+  fromPath-&gt;AppendNative(fileName);</span>
<a href="#l77.748"></a><span id="l77.748" class="difflineplus">+</span>
<a href="#l77.749"></a><span id="l77.749" class="difflineplus">+  // let's check if the tmp file exists</span>
<a href="#l77.750"></a><span id="l77.750" class="difflineplus">+  bool exists;</span>
<a href="#l77.751"></a><span id="l77.751" class="difflineplus">+  fromPath-&gt;Exists(&amp;exists);</span>
<a href="#l77.752"></a><span id="l77.752" class="difflineplus">+  if (!exists)</span>
<a href="#l77.753"></a><span id="l77.753" class="difflineplus">+  {</span>
<a href="#l77.754"></a><span id="l77.754" class="difflineplus">+    NS_ERROR(&quot;FinishNewMessage - oops! file does not exist!&quot;);</span>
<a href="#l77.755"></a><span id="l77.755" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l77.756"></a><span id="l77.756" class="difflineplus">+  }</span>
<a href="#l77.757"></a><span id="l77.757" class="difflineplus">+</span>
<a href="#l77.758"></a><span id="l77.758" class="difflineplus">+  // move to the &quot;cur&quot; subfolder</span>
<a href="#l77.759"></a><span id="l77.759" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; toPath;</span>
<a href="#l77.760"></a><span id="l77.760" class="difflineplus">+  folderPath-&gt;Clone(getter_AddRefs(toPath));</span>
<a href="#l77.761"></a><span id="l77.761" class="difflineplus">+  toPath-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l77.762"></a><span id="l77.762" class="difflineplus">+</span>
<a href="#l77.763"></a><span id="l77.763" class="difflineplus">+  // let's check if the folder exists</span>
<a href="#l77.764"></a><span id="l77.764" class="difflineplus">+  toPath-&gt;Exists(&amp;exists);</span>
<a href="#l77.765"></a><span id="l77.765" class="difflineplus">+  if (!exists)</span>
<a href="#l77.766"></a><span id="l77.766" class="difflineplus">+  {</span>
<a href="#l77.767"></a><span id="l77.767" class="difflineplus">+    rv = toPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l77.768"></a><span id="l77.768" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.769"></a><span id="l77.769" class="difflineplus">+  }</span>
<a href="#l77.770"></a><span id="l77.770" class="difflineplus">+</span>
<a href="#l77.771"></a><span id="l77.771" class="difflineplus">+  return fromPath-&gt;MoveToNative(toPath, fileName);</span>
<a href="#l77.772"></a><span id="l77.772" class="difflineplus">+}</span>
<a href="#l77.773"></a><span id="l77.773" class="difflineplus">+</span>
<a href="#l77.774"></a><span id="l77.774" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l77.775"></a><span id="l77.775" class="difflineplus">+nsMsgMaildirStore::MoveNewlyDownloadedMessage(nsIMsgDBHdr *aNewHdr,</span>
<a href="#l77.776"></a><span id="l77.776" class="difflineplus">+                                              nsIMsgFolder *aDestFolder,</span>
<a href="#l77.777"></a><span id="l77.777" class="difflineplus">+                                              bool *aResult)</span>
<a href="#l77.778"></a><span id="l77.778" class="difflineplus">+{</span>
<a href="#l77.779"></a><span id="l77.779" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aNewHdr);</span>
<a href="#l77.780"></a><span id="l77.780" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDestFolder);</span>
<a href="#l77.781"></a><span id="l77.781" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l77.782"></a><span id="l77.782" class="difflineplus">+</span>
<a href="#l77.783"></a><span id="l77.783" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; folderPath;</span>
<a href="#l77.784"></a><span id="l77.784" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l77.785"></a><span id="l77.785" class="difflineplus">+  nsresult rv = aNewHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l77.786"></a><span id="l77.786" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.787"></a><span id="l77.787" class="difflineplus">+  rv = folder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l77.788"></a><span id="l77.788" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.789"></a><span id="l77.789" class="difflineplus">+</span>
<a href="#l77.790"></a><span id="l77.790" class="difflineplus">+  // file path is stored in message header property</span>
<a href="#l77.791"></a><span id="l77.791" class="difflineplus">+  nsCAutoString fileName;</span>
<a href="#l77.792"></a><span id="l77.792" class="difflineplus">+  aNewHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(fileName));</span>
<a href="#l77.793"></a><span id="l77.793" class="difflineplus">+  if (fileName.IsEmpty())</span>
<a href="#l77.794"></a><span id="l77.794" class="difflineplus">+  {</span>
<a href="#l77.795"></a><span id="l77.795" class="difflineplus">+    NS_ERROR(&quot;FinishNewMessage - no storeToken in msg hdr!!\n&quot;);</span>
<a href="#l77.796"></a><span id="l77.796" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l77.797"></a><span id="l77.797" class="difflineplus">+  }</span>
<a href="#l77.798"></a><span id="l77.798" class="difflineplus">+</span>
<a href="#l77.799"></a><span id="l77.799" class="difflineplus">+  // path to the downloaded message</span>
<a href="#l77.800"></a><span id="l77.800" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; fromPath;</span>
<a href="#l77.801"></a><span id="l77.801" class="difflineplus">+  folderPath-&gt;Clone(getter_AddRefs(fromPath));</span>
<a href="#l77.802"></a><span id="l77.802" class="difflineplus">+  fromPath-&gt;Append(NS_LITERAL_STRING(&quot;tmp&quot;));</span>
<a href="#l77.803"></a><span id="l77.803" class="difflineplus">+  fromPath-&gt;AppendNative(fileName);</span>
<a href="#l77.804"></a><span id="l77.804" class="difflineplus">+</span>
<a href="#l77.805"></a><span id="l77.805" class="difflineplus">+  // let's check if the tmp file exists</span>
<a href="#l77.806"></a><span id="l77.806" class="difflineplus">+  bool exists;</span>
<a href="#l77.807"></a><span id="l77.807" class="difflineplus">+  fromPath-&gt;Exists(&amp;exists);</span>
<a href="#l77.808"></a><span id="l77.808" class="difflineplus">+  if (!exists)</span>
<a href="#l77.809"></a><span id="l77.809" class="difflineplus">+  {</span>
<a href="#l77.810"></a><span id="l77.810" class="difflineplus">+    NS_ERROR(&quot;FinishNewMessage - oops! file does not exist!&quot;);</span>
<a href="#l77.811"></a><span id="l77.811" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l77.812"></a><span id="l77.812" class="difflineplus">+  }</span>
<a href="#l77.813"></a><span id="l77.813" class="difflineplus">+</span>
<a href="#l77.814"></a><span id="l77.814" class="difflineplus">+  // move to the &quot;cur&quot; subfolder</span>
<a href="#l77.815"></a><span id="l77.815" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; toPath;</span>
<a href="#l77.816"></a><span id="l77.816" class="difflineplus">+  aDestFolder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l77.817"></a><span id="l77.817" class="difflineplus">+  folderPath-&gt;Clone(getter_AddRefs(toPath));</span>
<a href="#l77.818"></a><span id="l77.818" class="difflineplus">+  toPath-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l77.819"></a><span id="l77.819" class="difflineplus">+</span>
<a href="#l77.820"></a><span id="l77.820" class="difflineplus">+  // let's check if the folder exists</span>
<a href="#l77.821"></a><span id="l77.821" class="difflineplus">+  toPath-&gt;Exists(&amp;exists);</span>
<a href="#l77.822"></a><span id="l77.822" class="difflineplus">+  if (!exists)</span>
<a href="#l77.823"></a><span id="l77.823" class="difflineplus">+  {</span>
<a href="#l77.824"></a><span id="l77.824" class="difflineplus">+    rv = toPath-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l77.825"></a><span id="l77.825" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.826"></a><span id="l77.826" class="difflineplus">+  }</span>
<a href="#l77.827"></a><span id="l77.827" class="difflineplus">+</span>
<a href="#l77.828"></a><span id="l77.828" class="difflineplus">+  rv = fromPath-&gt;MoveToNative(toPath, fileName);</span>
<a href="#l77.829"></a><span id="l77.829" class="difflineplus">+  *aResult = NS_SUCCEEDED(rv);</span>
<a href="#l77.830"></a><span id="l77.830" class="difflineplus">+  return rv;</span>
<a href="#l77.831"></a><span id="l77.831" class="difflineplus">+}</span>
<a href="#l77.832"></a><span id="l77.832" class="difflineplus">+</span>
<a href="#l77.833"></a><span id="l77.833" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l77.834"></a><span id="l77.834" class="difflineplus">+nsMsgMaildirStore::GetMsgInputStream(nsIMsgFolder *aMsgFolder,</span>
<a href="#l77.835"></a><span id="l77.835" class="difflineplus">+                                     const nsACString &amp;aMsgToken,</span>
<a href="#l77.836"></a><span id="l77.836" class="difflineplus">+                                     PRInt64 *aOffset,</span>
<a href="#l77.837"></a><span id="l77.837" class="difflineplus">+                                     nsIMsgDBHdr *aMsgHdr,</span>
<a href="#l77.838"></a><span id="l77.838" class="difflineplus">+                                     bool *aReusable NS_OUTPARAM,</span>
<a href="#l77.839"></a><span id="l77.839" class="difflineplus">+                                     nsIInputStream **aResult NS_OUTPARAM)</span>
<a href="#l77.840"></a><span id="l77.840" class="difflineplus">+{</span>
<a href="#l77.841"></a><span id="l77.841" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aMsgFolder);</span>
<a href="#l77.842"></a><span id="l77.842" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aOffset);</span>
<a href="#l77.843"></a><span id="l77.843" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aResult);</span>
<a href="#l77.844"></a><span id="l77.844" class="difflineplus">+</span>
<a href="#l77.845"></a><span id="l77.845" class="difflineplus">+  *aReusable = false; // message per file</span>
<a href="#l77.846"></a><span id="l77.846" class="difflineplus">+  *aOffset = 0;</span>
<a href="#l77.847"></a><span id="l77.847" class="difflineplus">+</span>
<a href="#l77.848"></a><span id="l77.848" class="difflineplus">+  // construct path to file</span>
<a href="#l77.849"></a><span id="l77.849" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l77.850"></a><span id="l77.850" class="difflineplus">+  nsresult rv = aMsgFolder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l77.851"></a><span id="l77.851" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.852"></a><span id="l77.852" class="difflineplus">+</span>
<a href="#l77.853"></a><span id="l77.853" class="difflineplus">+  if (aMsgToken.IsEmpty())</span>
<a href="#l77.854"></a><span id="l77.854" class="difflineplus">+  {</span>
<a href="#l77.855"></a><span id="l77.855" class="difflineplus">+    PR_LOG(MailDirLog, PR_LOG_ALWAYS,</span>
<a href="#l77.856"></a><span id="l77.856" class="difflineplus">+           (&quot;GetMsgInputStream - empty storeToken!!\n&quot;));</span>
<a href="#l77.857"></a><span id="l77.857" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l77.858"></a><span id="l77.858" class="difflineplus">+  }</span>
<a href="#l77.859"></a><span id="l77.859" class="difflineplus">+</span>
<a href="#l77.860"></a><span id="l77.860" class="difflineplus">+  path-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l77.861"></a><span id="l77.861" class="difflineplus">+  path-&gt;AppendNative(aMsgToken);</span>
<a href="#l77.862"></a><span id="l77.862" class="difflineplus">+</span>
<a href="#l77.863"></a><span id="l77.863" class="difflineplus">+  // let's check if the folder exists</span>
<a href="#l77.864"></a><span id="l77.864" class="difflineplus">+  bool exists;</span>
<a href="#l77.865"></a><span id="l77.865" class="difflineplus">+  path-&gt;Exists(&amp;exists);</span>
<a href="#l77.866"></a><span id="l77.866" class="difflineplus">+  if (!exists) {</span>
<a href="#l77.867"></a><span id="l77.867" class="difflineplus">+    PR_LOG(MailDirLog, PR_LOG_ALWAYS,</span>
<a href="#l77.868"></a><span id="l77.868" class="difflineplus">+           (&quot;GetMsgInputStream - oops! cur subfolder does not exist!\n&quot;));</span>
<a href="#l77.869"></a><span id="l77.869" class="difflineplus">+    rv = path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0755);</span>
<a href="#l77.870"></a><span id="l77.870" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.871"></a><span id="l77.871" class="difflineplus">+  }</span>
<a href="#l77.872"></a><span id="l77.872" class="difflineplus">+</span>
<a href="#l77.873"></a><span id="l77.873" class="difflineplus">+  return NS_NewLocalFileInputStream(aResult, path);</span>
<a href="#l77.874"></a><span id="l77.874" class="difflineplus">+}</span>
<a href="#l77.875"></a><span id="l77.875" class="difflineplus">+</span>
<a href="#l77.876"></a><span id="l77.876" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::DeleteMessages(nsIArray *aHdrArray)</span>
<a href="#l77.877"></a><span id="l77.877" class="difflineplus">+{</span>
<a href="#l77.878"></a><span id="l77.878" class="difflineplus">+  PRUint32 messageCount;</span>
<a href="#l77.879"></a><span id="l77.879" class="difflineplus">+  nsresult rv = aHdrArray-&gt;GetLength(&amp;messageCount);</span>
<a href="#l77.880"></a><span id="l77.880" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.881"></a><span id="l77.881" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l77.882"></a><span id="l77.882" class="difflineplus">+</span>
<a href="#l77.883"></a><span id="l77.883" class="difflineplus">+  for (PRUint32 i = 0; i &lt; messageCount; i++)</span>
<a href="#l77.884"></a><span id="l77.884" class="difflineplus">+  {</span>
<a href="#l77.885"></a><span id="l77.885" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(aHdrArray, i, &amp;rv);</span>
<a href="#l77.886"></a><span id="l77.886" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l77.887"></a><span id="l77.887" class="difflineplus">+      continue;</span>
<a href="#l77.888"></a><span id="l77.888" class="difflineplus">+    msgHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l77.889"></a><span id="l77.889" class="difflineplus">+    nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l77.890"></a><span id="l77.890" class="difflineplus">+    rv = folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l77.891"></a><span id="l77.891" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.892"></a><span id="l77.892" class="difflineplus">+    nsCAutoString fileName;</span>
<a href="#l77.893"></a><span id="l77.893" class="difflineplus">+    msgHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(fileName));</span>
<a href="#l77.894"></a><span id="l77.894" class="difflineplus">+    if (fileName.IsEmpty())</span>
<a href="#l77.895"></a><span id="l77.895" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l77.896"></a><span id="l77.896" class="difflineplus">+</span>
<a href="#l77.897"></a><span id="l77.897" class="difflineplus">+    if (fileName.IsEmpty())</span>
<a href="#l77.898"></a><span id="l77.898" class="difflineplus">+    {</span>
<a href="#l77.899"></a><span id="l77.899" class="difflineplus">+      PR_LOG(MailDirLog, PR_LOG_ALWAYS,</span>
<a href="#l77.900"></a><span id="l77.900" class="difflineplus">+             (&quot;GetMsgInputStream - empty storeToken!!\n&quot;));</span>
<a href="#l77.901"></a><span id="l77.901" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l77.902"></a><span id="l77.902" class="difflineplus">+    }</span>
<a href="#l77.903"></a><span id="l77.903" class="difflineplus">+</span>
<a href="#l77.904"></a><span id="l77.904" class="difflineplus">+    path-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l77.905"></a><span id="l77.905" class="difflineplus">+    path-&gt;AppendNative(fileName);</span>
<a href="#l77.906"></a><span id="l77.906" class="difflineplus">+</span>
<a href="#l77.907"></a><span id="l77.907" class="difflineplus">+    // let's check if the folder exists</span>
<a href="#l77.908"></a><span id="l77.908" class="difflineplus">+    bool exists;</span>
<a href="#l77.909"></a><span id="l77.909" class="difflineplus">+    path-&gt;Exists(&amp;exists);</span>
<a href="#l77.910"></a><span id="l77.910" class="difflineplus">+    path-&gt;Remove(false);</span>
<a href="#l77.911"></a><span id="l77.911" class="difflineplus">+  }</span>
<a href="#l77.912"></a><span id="l77.912" class="difflineplus">+  return NS_OK;</span>
<a href="#l77.913"></a><span id="l77.913" class="difflineplus">+}</span>
<a href="#l77.914"></a><span id="l77.914" class="difflineplus">+</span>
<a href="#l77.915"></a><span id="l77.915" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l77.916"></a><span id="l77.916" class="difflineplus">+nsMsgMaildirStore::CopyMessages(bool aIsMove, nsIArray *aHdrArray,</span>
<a href="#l77.917"></a><span id="l77.917" class="difflineplus">+                               nsIMsgFolder *aDstFolder,</span>
<a href="#l77.918"></a><span id="l77.918" class="difflineplus">+                               nsIMsgCopyServiceListener *aListener,</span>
<a href="#l77.919"></a><span id="l77.919" class="difflineplus">+                               bool *aCopyDone)</span>
<a href="#l77.920"></a><span id="l77.920" class="difflineplus">+{</span>
<a href="#l77.921"></a><span id="l77.921" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aHdrArray);</span>
<a href="#l77.922"></a><span id="l77.922" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aDstFolder);</span>
<a href="#l77.923"></a><span id="l77.923" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aCopyDone);</span>
<a href="#l77.924"></a><span id="l77.924" class="difflineplus">+  PRUint32 messageCount;</span>
<a href="#l77.925"></a><span id="l77.925" class="difflineplus">+  nsresult rv = aHdrArray-&gt;GetLength(&amp;messageCount);</span>
<a href="#l77.926"></a><span id="l77.926" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.927"></a><span id="l77.927" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; srcFolder;</span>
<a href="#l77.928"></a><span id="l77.928" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; destFolderPath;</span>
<a href="#l77.929"></a><span id="l77.929" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; destDB;</span>
<a href="#l77.930"></a><span id="l77.930" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; srcDB;</span>
<a href="#l77.931"></a><span id="l77.931" class="difflineplus">+  aDstFolder-&gt;GetMsgDatabase(getter_AddRefs(destDB));</span>
<a href="#l77.932"></a><span id="l77.932" class="difflineplus">+  aDstFolder-&gt;GetFilePath(getter_AddRefs(destFolderPath));</span>
<a href="#l77.933"></a><span id="l77.933" class="difflineplus">+  destFolderPath-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l77.934"></a><span id="l77.934" class="difflineplus">+</span>
<a href="#l77.935"></a><span id="l77.935" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(aHdrArray, 0, &amp;rv);</span>
<a href="#l77.936"></a><span id="l77.936" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.937"></a><span id="l77.937" class="difflineplus">+  rv = msgHdr-&gt;GetFolder(getter_AddRefs(srcFolder));</span>
<a href="#l77.938"></a><span id="l77.938" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.939"></a><span id="l77.939" class="difflineplus">+  srcFolder-&gt;GetMsgDatabase(getter_AddRefs(srcDB));</span>
<a href="#l77.940"></a><span id="l77.940" class="difflineplus">+  nsRefPtr&lt;nsLocalMoveCopyMsgTxn&gt; msgTxn = new nsLocalMoveCopyMsgTxn;</span>
<a href="#l77.941"></a><span id="l77.941" class="difflineplus">+  if (msgTxn &amp;&amp; NS_SUCCEEDED(msgTxn-&gt;Init(srcFolder, aDstFolder, aIsMove)))</span>
<a href="#l77.942"></a><span id="l77.942" class="difflineplus">+  {</span>
<a href="#l77.943"></a><span id="l77.943" class="difflineplus">+    if (aIsMove)</span>
<a href="#l77.944"></a><span id="l77.944" class="difflineplus">+      msgTxn-&gt;SetTransactionType(nsIMessenger::eMoveMsg);</span>
<a href="#l77.945"></a><span id="l77.945" class="difflineplus">+    else</span>
<a href="#l77.946"></a><span id="l77.946" class="difflineplus">+      msgTxn-&gt;SetTransactionType(nsIMessenger::eCopyMsg);</span>
<a href="#l77.947"></a><span id="l77.947" class="difflineplus">+  }</span>
<a href="#l77.948"></a><span id="l77.948" class="difflineplus">+</span>
<a href="#l77.949"></a><span id="l77.949" class="difflineplus">+  nsCOMPtr&lt;nsIMutableArray&gt; dstHdrs(do_CreateInstance(NS_ARRAY_CONTRACTID, &amp;rv));</span>
<a href="#l77.950"></a><span id="l77.950" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.951"></a><span id="l77.951" class="difflineplus">+  for (PRUint32 i = 0; i &lt; messageCount; i++)</span>
<a href="#l77.952"></a><span id="l77.952" class="difflineplus">+  {</span>
<a href="#l77.953"></a><span id="l77.953" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(aHdrArray, i, &amp;rv);</span>
<a href="#l77.954"></a><span id="l77.954" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l77.955"></a><span id="l77.955" class="difflineplus">+      continue;</span>
<a href="#l77.956"></a><span id="l77.956" class="difflineplus">+    nsMsgKey srcKey;</span>
<a href="#l77.957"></a><span id="l77.957" class="difflineplus">+    msgHdr-&gt;GetMessageKey(&amp;srcKey);</span>
<a href="#l77.958"></a><span id="l77.958" class="difflineplus">+    msgTxn-&gt;AddSrcKey(srcKey);</span>
<a href="#l77.959"></a><span id="l77.959" class="difflineplus">+    msgHdr-&gt;GetFolder(getter_AddRefs(srcFolder));</span>
<a href="#l77.960"></a><span id="l77.960" class="difflineplus">+    nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l77.961"></a><span id="l77.961" class="difflineplus">+    rv = srcFolder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l77.962"></a><span id="l77.962" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.963"></a><span id="l77.963" class="difflineplus">+    nsCAutoString fileName;</span>
<a href="#l77.964"></a><span id="l77.964" class="difflineplus">+    msgHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(fileName));</span>
<a href="#l77.965"></a><span id="l77.965" class="difflineplus">+    if (fileName.IsEmpty())</span>
<a href="#l77.966"></a><span id="l77.966" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l77.967"></a><span id="l77.967" class="difflineplus">+</span>
<a href="#l77.968"></a><span id="l77.968" class="difflineplus">+    if (fileName.IsEmpty())</span>
<a href="#l77.969"></a><span id="l77.969" class="difflineplus">+    {</span>
<a href="#l77.970"></a><span id="l77.970" class="difflineplus">+      PR_LOG(MailDirLog, PR_LOG_ALWAYS,</span>
<a href="#l77.971"></a><span id="l77.971" class="difflineplus">+             (&quot;GetMsgInputStream - empty storeToken!!\n&quot;));</span>
<a href="#l77.972"></a><span id="l77.972" class="difflineplus">+      return NS_ERROR_FAILURE;</span>
<a href="#l77.973"></a><span id="l77.973" class="difflineplus">+    }</span>
<a href="#l77.974"></a><span id="l77.974" class="difflineplus">+</span>
<a href="#l77.975"></a><span id="l77.975" class="difflineplus">+    path-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l77.976"></a><span id="l77.976" class="difflineplus">+    path-&gt;AppendNative(fileName);</span>
<a href="#l77.977"></a><span id="l77.977" class="difflineplus">+</span>
<a href="#l77.978"></a><span id="l77.978" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; destFile;</span>
<a href="#l77.979"></a><span id="l77.979" class="difflineplus">+    destFolderPath-&gt;Clone(getter_AddRefs(destFile));</span>
<a href="#l77.980"></a><span id="l77.980" class="difflineplus">+    destFile-&gt;AppendNative(fileName);</span>
<a href="#l77.981"></a><span id="l77.981" class="difflineplus">+    bool exists;</span>
<a href="#l77.982"></a><span id="l77.982" class="difflineplus">+    destFile-&gt;Exists(&amp;exists);</span>
<a href="#l77.983"></a><span id="l77.983" class="difflineplus">+    if (exists)</span>
<a href="#l77.984"></a><span id="l77.984" class="difflineplus">+    {</span>
<a href="#l77.985"></a><span id="l77.985" class="difflineplus">+      rv = destFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 0600);</span>
<a href="#l77.986"></a><span id="l77.986" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.987"></a><span id="l77.987" class="difflineplus">+      destFile-&gt;GetNativeLeafName(fileName);</span>
<a href="#l77.988"></a><span id="l77.988" class="difflineplus">+    }</span>
<a href="#l77.989"></a><span id="l77.989" class="difflineplus">+    if (aIsMove)</span>
<a href="#l77.990"></a><span id="l77.990" class="difflineplus">+      path-&gt;MoveToNative(destFolderPath, fileName);</span>
<a href="#l77.991"></a><span id="l77.991" class="difflineplus">+    else</span>
<a href="#l77.992"></a><span id="l77.992" class="difflineplus">+      path-&gt;CopyToNative(destFolderPath, fileName);</span>
<a href="#l77.993"></a><span id="l77.993" class="difflineplus">+</span>
<a href="#l77.994"></a><span id="l77.994" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; destHdr;</span>
<a href="#l77.995"></a><span id="l77.995" class="difflineplus">+    if (destDB)</span>
<a href="#l77.996"></a><span id="l77.996" class="difflineplus">+    {</span>
<a href="#l77.997"></a><span id="l77.997" class="difflineplus">+      rv = destDB-&gt;CopyHdrFromExistingHdr(srcKey, msgHdr, true, getter_AddRefs(destHdr));</span>
<a href="#l77.998"></a><span id="l77.998" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.999"></a><span id="l77.999" class="difflineplus">+      destHdr-&gt;SetStringProperty(&quot;storeToken&quot;, fileName.get());</span>
<a href="#l77.1000"></a><span id="l77.1000" class="difflineplus">+      dstHdrs-&gt;AppendElement(destHdr, false);</span>
<a href="#l77.1001"></a><span id="l77.1001" class="difflineplus">+    }</span>
<a href="#l77.1002"></a><span id="l77.1002" class="difflineplus">+  }</span>
<a href="#l77.1003"></a><span id="l77.1003" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l77.1004"></a><span id="l77.1004" class="difflineplus">+  if (notifier)</span>
<a href="#l77.1005"></a><span id="l77.1005" class="difflineplus">+    notifier-&gt;NotifyMsgsMoveCopyCompleted(aIsMove, aHdrArray, aDstFolder,</span>
<a href="#l77.1006"></a><span id="l77.1006" class="difflineplus">+                                          dstHdrs);</span>
<a href="#l77.1007"></a><span id="l77.1007" class="difflineplus">+  if (aIsMove)</span>
<a href="#l77.1008"></a><span id="l77.1008" class="difflineplus">+  {</span>
<a href="#l77.1009"></a><span id="l77.1009" class="difflineplus">+    for (PRUint32 i = 0; i &lt; messageCount; ++i)</span>
<a href="#l77.1010"></a><span id="l77.1010" class="difflineplus">+    {</span>
<a href="#l77.1011"></a><span id="l77.1011" class="difflineplus">+      nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr(do_QueryElementAt(aHdrArray, i, &amp;rv));</span>
<a href="#l77.1012"></a><span id="l77.1012" class="difflineplus">+      rv = srcDB-&gt;DeleteHeader(msgDBHdr, nsnull, false, true);</span>
<a href="#l77.1013"></a><span id="l77.1013" class="difflineplus">+    }</span>
<a href="#l77.1014"></a><span id="l77.1014" class="difflineplus">+  }</span>
<a href="#l77.1015"></a><span id="l77.1015" class="difflineplus">+  *aCopyDone = true;</span>
<a href="#l77.1016"></a><span id="l77.1016" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; srcSupports(srcFolder);</span>
<a href="#l77.1017"></a><span id="l77.1017" class="difflineplus">+  nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localDest(do_QueryInterface(aDstFolder));</span>
<a href="#l77.1018"></a><span id="l77.1018" class="difflineplus">+  if (localDest)</span>
<a href="#l77.1019"></a><span id="l77.1019" class="difflineplus">+    localDest-&gt;OnCopyCompleted(srcSupports, true);</span>
<a href="#l77.1020"></a><span id="l77.1020" class="difflineplus">+  if (aListener)</span>
<a href="#l77.1021"></a><span id="l77.1021" class="difflineplus">+    aListener-&gt;OnStopCopy(NS_OK);</span>
<a href="#l77.1022"></a><span id="l77.1022" class="difflineplus">+</span>
<a href="#l77.1023"></a><span id="l77.1023" class="difflineplus">+  return NS_OK;</span>
<a href="#l77.1024"></a><span id="l77.1024" class="difflineplus">+}</span>
<a href="#l77.1025"></a><span id="l77.1025" class="difflineplus">+</span>
<a href="#l77.1026"></a><span id="l77.1026" class="difflineplus">+NS_IMETHODIMP</span>
<a href="#l77.1027"></a><span id="l77.1027" class="difflineplus">+nsMsgMaildirStore::GetSupportsCompaction(bool *aSupportsCompaction)</span>
<a href="#l77.1028"></a><span id="l77.1028" class="difflineplus">+{</span>
<a href="#l77.1029"></a><span id="l77.1029" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aSupportsCompaction);</span>
<a href="#l77.1030"></a><span id="l77.1030" class="difflineplus">+  *aSupportsCompaction = false;</span>
<a href="#l77.1031"></a><span id="l77.1031" class="difflineplus">+  return NS_OK;</span>
<a href="#l77.1032"></a><span id="l77.1032" class="difflineplus">+}</span>
<a href="#l77.1033"></a><span id="l77.1033" class="difflineplus">+</span>
<a href="#l77.1034"></a><span id="l77.1034" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::CompactFolder(nsIMsgFolder *aFolder,</span>
<a href="#l77.1035"></a><span id="l77.1035" class="difflineplus">+                                               nsIUrlListener *aListener,</span>
<a href="#l77.1036"></a><span id="l77.1036" class="difflineplus">+                                               nsIMsgWindow *aMsgWindow)</span>
<a href="#l77.1037"></a><span id="l77.1037" class="difflineplus">+{</span>
<a href="#l77.1038"></a><span id="l77.1038" class="difflineplus">+  return NS_OK;</span>
<a href="#l77.1039"></a><span id="l77.1039" class="difflineplus">+}</span>
<a href="#l77.1040"></a><span id="l77.1040" class="difflineplus">+</span>
<a href="#l77.1041"></a><span id="l77.1041" class="difflineplus">+class MaildirStoreParser</span>
<a href="#l77.1042"></a><span id="l77.1042" class="difflineplus">+{</span>
<a href="#l77.1043"></a><span id="l77.1043" class="difflineplus">+public:</span>
<a href="#l77.1044"></a><span id="l77.1044" class="difflineplus">+  MaildirStoreParser(nsIMsgFolder *aFolder, nsIMsgDatabase *aMsgDB,</span>
<a href="#l77.1045"></a><span id="l77.1045" class="difflineplus">+                     nsISimpleEnumerator *aDirectoryEnumerator,</span>
<a href="#l77.1046"></a><span id="l77.1046" class="difflineplus">+                     nsIUrlListener *aUrlListener);</span>
<a href="#l77.1047"></a><span id="l77.1047" class="difflineplus">+  virtual ~MaildirStoreParser();</span>
<a href="#l77.1048"></a><span id="l77.1048" class="difflineplus">+</span>
<a href="#l77.1049"></a><span id="l77.1049" class="difflineplus">+  nsresult ParseNextMessage(nsIFile *aFile);</span>
<a href="#l77.1050"></a><span id="l77.1050" class="difflineplus">+  static void TimerCallback(nsITimer *aTimer, void *aClosure);</span>
<a href="#l77.1051"></a><span id="l77.1051" class="difflineplus">+  nsresult StartTimer();</span>
<a href="#l77.1052"></a><span id="l77.1052" class="difflineplus">+</span>
<a href="#l77.1053"></a><span id="l77.1053" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; m_directoryEnumerator;</span>
<a href="#l77.1054"></a><span id="l77.1054" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l77.1055"></a><span id="l77.1055" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; m_db;</span>
<a href="#l77.1056"></a><span id="l77.1056" class="difflineplus">+  nsCOMPtr&lt;nsITimer&gt; m_timer;</span>
<a href="#l77.1057"></a><span id="l77.1057" class="difflineplus">+  nsCOMPtr&lt;nsIUrlListener&gt; m_listener;</span>
<a href="#l77.1058"></a><span id="l77.1058" class="difflineplus">+};</span>
<a href="#l77.1059"></a><span id="l77.1059" class="difflineplus">+</span>
<a href="#l77.1060"></a><span id="l77.1060" class="difflineplus">+MaildirStoreParser::MaildirStoreParser(nsIMsgFolder *aFolder,</span>
<a href="#l77.1061"></a><span id="l77.1061" class="difflineplus">+                                       nsIMsgDatabase *aMsgDB,</span>
<a href="#l77.1062"></a><span id="l77.1062" class="difflineplus">+                                       nsISimpleEnumerator *aDirEnum,</span>
<a href="#l77.1063"></a><span id="l77.1063" class="difflineplus">+                                       nsIUrlListener *aUrlListener)</span>
<a href="#l77.1064"></a><span id="l77.1064" class="difflineplus">+{</span>
<a href="#l77.1065"></a><span id="l77.1065" class="difflineplus">+  m_folder = aFolder;</span>
<a href="#l77.1066"></a><span id="l77.1066" class="difflineplus">+  m_db = aMsgDB;</span>
<a href="#l77.1067"></a><span id="l77.1067" class="difflineplus">+  m_directoryEnumerator = aDirEnum;</span>
<a href="#l77.1068"></a><span id="l77.1068" class="difflineplus">+  m_listener = aUrlListener;</span>
<a href="#l77.1069"></a><span id="l77.1069" class="difflineplus">+}</span>
<a href="#l77.1070"></a><span id="l77.1070" class="difflineplus">+</span>
<a href="#l77.1071"></a><span id="l77.1071" class="difflineplus">+MaildirStoreParser::~MaildirStoreParser()</span>
<a href="#l77.1072"></a><span id="l77.1072" class="difflineplus">+{</span>
<a href="#l77.1073"></a><span id="l77.1073" class="difflineplus">+}</span>
<a href="#l77.1074"></a><span id="l77.1074" class="difflineplus">+</span>
<a href="#l77.1075"></a><span id="l77.1075" class="difflineplus">+nsresult MaildirStoreParser::ParseNextMessage(nsIFile *aFile)</span>
<a href="#l77.1076"></a><span id="l77.1076" class="difflineplus">+{</span>
<a href="#l77.1077"></a><span id="l77.1077" class="difflineplus">+  nsresult rv;</span>
<a href="#l77.1078"></a><span id="l77.1078" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l77.1079"></a><span id="l77.1079" class="difflineplus">+  nsCOMPtr&lt;nsIMsgParseMailMsgState&gt; msgParser =</span>
<a href="#l77.1080"></a><span id="l77.1080" class="difflineplus">+    do_CreateInstance(NS_PARSEMAILMSGSTATE_CONTRACTID, &amp;rv);</span>
<a href="#l77.1081"></a><span id="l77.1081" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1082"></a><span id="l77.1082" class="difflineplus">+  msgParser-&gt;SetMailDB(m_db);</span>
<a href="#l77.1083"></a><span id="l77.1083" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; newMsgHdr;</span>
<a href="#l77.1084"></a><span id="l77.1084" class="difflineplus">+  rv = m_db-&gt;CreateNewHdr(nsMsgKey_None, getter_AddRefs(newMsgHdr));</span>
<a href="#l77.1085"></a><span id="l77.1085" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1086"></a><span id="l77.1086" class="difflineplus">+</span>
<a href="#l77.1087"></a><span id="l77.1087" class="difflineplus">+  newMsgHdr-&gt;SetMessageOffset(0);</span>
<a href="#l77.1088"></a><span id="l77.1088" class="difflineplus">+</span>
<a href="#l77.1089"></a><span id="l77.1089" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; localFile = do_QueryInterface(aFile);</span>
<a href="#l77.1090"></a><span id="l77.1090" class="difflineplus">+  if (NS_SUCCEEDED(rv))</span>
<a href="#l77.1091"></a><span id="l77.1091" class="difflineplus">+    rv = NS_NewLocalFileInputStream(getter_AddRefs(inputStream), localFile);</span>
<a href="#l77.1092"></a><span id="l77.1092" class="difflineplus">+  if (NS_SUCCEEDED(rv) &amp;&amp; inputStream)</span>
<a href="#l77.1093"></a><span id="l77.1093" class="difflineplus">+  {</span>
<a href="#l77.1094"></a><span id="l77.1094" class="difflineplus">+    PRInt32 inputBufferSize = 10240;</span>
<a href="#l77.1095"></a><span id="l77.1095" class="difflineplus">+    nsMsgLineStreamBuffer *inputStreamBuffer =</span>
<a href="#l77.1096"></a><span id="l77.1096" class="difflineplus">+      new nsMsgLineStreamBuffer(inputBufferSize, true, false);</span>
<a href="#l77.1097"></a><span id="l77.1097" class="difflineplus">+    PRInt64 fileSize;</span>
<a href="#l77.1098"></a><span id="l77.1098" class="difflineplus">+    aFile-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l77.1099"></a><span id="l77.1099" class="difflineplus">+    msgParser-&gt;SetNewMsgHdr(newMsgHdr);</span>
<a href="#l77.1100"></a><span id="l77.1100" class="difflineplus">+    msgParser-&gt;SetState(nsIMsgParseMailMsgState::ParseHeadersState);</span>
<a href="#l77.1101"></a><span id="l77.1101" class="difflineplus">+    msgParser-&gt;SetEnvelopePos(0);</span>
<a href="#l77.1102"></a><span id="l77.1102" class="difflineplus">+    bool needMoreData = false;</span>
<a href="#l77.1103"></a><span id="l77.1103" class="difflineplus">+    char * newLine = nsnull;</span>
<a href="#l77.1104"></a><span id="l77.1104" class="difflineplus">+    PRUint32 numBytesInLine = 0;</span>
<a href="#l77.1105"></a><span id="l77.1105" class="difflineplus">+    // we only have to read the headers, because we know the message size</span>
<a href="#l77.1106"></a><span id="l77.1106" class="difflineplus">+    // from the file size. So we can do this in one time slice.</span>
<a href="#l77.1107"></a><span id="l77.1107" class="difflineplus">+    do</span>
<a href="#l77.1108"></a><span id="l77.1108" class="difflineplus">+    {</span>
<a href="#l77.1109"></a><span id="l77.1109" class="difflineplus">+      newLine = inputStreamBuffer-&gt;ReadNextLine(inputStream, numBytesInLine,</span>
<a href="#l77.1110"></a><span id="l77.1110" class="difflineplus">+                                                needMoreData);</span>
<a href="#l77.1111"></a><span id="l77.1111" class="difflineplus">+      if (newLine)</span>
<a href="#l77.1112"></a><span id="l77.1112" class="difflineplus">+      {</span>
<a href="#l77.1113"></a><span id="l77.1113" class="difflineplus">+        msgParser-&gt;ParseAFolderLine(newLine, numBytesInLine);</span>
<a href="#l77.1114"></a><span id="l77.1114" class="difflineplus">+        NS_Free(newLine);</span>
<a href="#l77.1115"></a><span id="l77.1115" class="difflineplus">+      }</span>
<a href="#l77.1116"></a><span id="l77.1116" class="difflineplus">+    } while (newLine &amp;&amp; numBytesInLine &gt; 0);</span>
<a href="#l77.1117"></a><span id="l77.1117" class="difflineplus">+</span>
<a href="#l77.1118"></a><span id="l77.1118" class="difflineplus">+    msgParser-&gt;FinishHeader();</span>
<a href="#l77.1119"></a><span id="l77.1119" class="difflineplus">+    // A single message needs to be less than 4GB</span>
<a href="#l77.1120"></a><span id="l77.1120" class="difflineplus">+    newMsgHdr-&gt;SetMessageSize((PRUint32) fileSize);</span>
<a href="#l77.1121"></a><span id="l77.1121" class="difflineplus">+    m_db-&gt;AddNewHdrToDB(newMsgHdr, true);</span>
<a href="#l77.1122"></a><span id="l77.1122" class="difflineplus">+    nsCAutoString storeToken;</span>
<a href="#l77.1123"></a><span id="l77.1123" class="difflineplus">+    localFile-&gt;GetNativeLeafName(storeToken);</span>
<a href="#l77.1124"></a><span id="l77.1124" class="difflineplus">+    newMsgHdr-&gt;SetStringProperty(&quot;storeToken&quot;, storeToken.get());</span>
<a href="#l77.1125"></a><span id="l77.1125" class="difflineplus">+  }</span>
<a href="#l77.1126"></a><span id="l77.1126" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1127"></a><span id="l77.1127" class="difflineplus">+  return rv;</span>
<a href="#l77.1128"></a><span id="l77.1128" class="difflineplus">+}</span>
<a href="#l77.1129"></a><span id="l77.1129" class="difflineplus">+</span>
<a href="#l77.1130"></a><span id="l77.1130" class="difflineplus">+void MaildirStoreParser::TimerCallback(nsITimer *aTimer, void *aClosure)</span>
<a href="#l77.1131"></a><span id="l77.1131" class="difflineplus">+{</span>
<a href="#l77.1132"></a><span id="l77.1132" class="difflineplus">+  MaildirStoreParser *parser = (MaildirStoreParser *) aClosure;</span>
<a href="#l77.1133"></a><span id="l77.1133" class="difflineplus">+  bool hasMore;</span>
<a href="#l77.1134"></a><span id="l77.1134" class="difflineplus">+  parser-&gt;m_directoryEnumerator-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l77.1135"></a><span id="l77.1135" class="difflineplus">+  if (!hasMore)</span>
<a href="#l77.1136"></a><span id="l77.1136" class="difflineplus">+  {</span>
<a href="#l77.1137"></a><span id="l77.1137" class="difflineplus">+    nsCOMPtr&lt;nsIMsgPluggableStore&gt; store;</span>
<a href="#l77.1138"></a><span id="l77.1138" class="difflineplus">+    parser-&gt;m_folder-&gt;GetMsgStore(getter_AddRefs(store));</span>
<a href="#l77.1139"></a><span id="l77.1139" class="difflineplus">+    parser-&gt;m_timer-&gt;Cancel();</span>
<a href="#l77.1140"></a><span id="l77.1140" class="difflineplus">+    parser-&gt;m_db-&gt;SetSummaryValid(true);</span>
<a href="#l77.1141"></a><span id="l77.1141" class="difflineplus">+//    store-&gt;SetSummaryFileValid(parser-&gt;m_folder, parser-&gt;m_db, true);</span>
<a href="#l77.1142"></a><span id="l77.1142" class="difflineplus">+    if (parser-&gt;m_listener)</span>
<a href="#l77.1143"></a><span id="l77.1143" class="difflineplus">+    {</span>
<a href="#l77.1144"></a><span id="l77.1144" class="difflineplus">+      nsresult rv;</span>
<a href="#l77.1145"></a><span id="l77.1145" class="difflineplus">+      nsCOMPtr&lt;nsIMailboxUrl&gt; mailboxurl =</span>
<a href="#l77.1146"></a><span id="l77.1146" class="difflineplus">+        do_CreateInstance(NS_MAILBOXURL_CONTRACTID, &amp;rv);</span>
<a href="#l77.1147"></a><span id="l77.1147" class="difflineplus">+      if (NS_SUCCEEDED(rv) &amp;&amp; mailboxurl)</span>
<a href="#l77.1148"></a><span id="l77.1148" class="difflineplus">+      {</span>
<a href="#l77.1149"></a><span id="l77.1149" class="difflineplus">+        nsCOMPtr&lt;nsIMsgMailNewsUrl&gt; url = do_QueryInterface(mailboxurl);</span>
<a href="#l77.1150"></a><span id="l77.1150" class="difflineplus">+        url-&gt;SetUpdatingFolder(true);</span>
<a href="#l77.1151"></a><span id="l77.1151" class="difflineplus">+        nsCAutoString uriSpec(&quot;mailbox://&quot;);</span>
<a href="#l77.1152"></a><span id="l77.1152" class="difflineplus">+        url-&gt;SetSpec(uriSpec);</span>
<a href="#l77.1153"></a><span id="l77.1153" class="difflineplus">+        parser-&gt;m_listener-&gt;OnStopRunningUrl(url, NS_OK);</span>
<a href="#l77.1154"></a><span id="l77.1154" class="difflineplus">+      }</span>
<a href="#l77.1155"></a><span id="l77.1155" class="difflineplus">+    }</span>
<a href="#l77.1156"></a><span id="l77.1156" class="difflineplus">+    return;</span>
<a href="#l77.1157"></a><span id="l77.1157" class="difflineplus">+  }</span>
<a href="#l77.1158"></a><span id="l77.1158" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l77.1159"></a><span id="l77.1159" class="difflineplus">+  parser-&gt;m_directoryEnumerator-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l77.1160"></a><span id="l77.1160" class="difflineplus">+  nsresult rv;</span>
<a href="#l77.1161"></a><span id="l77.1161" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; currentFile(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l77.1162"></a><span id="l77.1162" class="difflineplus">+  NS_ENSURE_SUCCESS(rv,);</span>
<a href="#l77.1163"></a><span id="l77.1163" class="difflineplus">+  parser-&gt;ParseNextMessage(currentFile);</span>
<a href="#l77.1164"></a><span id="l77.1164" class="difflineplus">+  // ### TODO - what if this fails?</span>
<a href="#l77.1165"></a><span id="l77.1165" class="difflineplus">+}</span>
<a href="#l77.1166"></a><span id="l77.1166" class="difflineplus">+</span>
<a href="#l77.1167"></a><span id="l77.1167" class="difflineplus">+nsresult MaildirStoreParser::StartTimer()</span>
<a href="#l77.1168"></a><span id="l77.1168" class="difflineplus">+{</span>
<a href="#l77.1169"></a><span id="l77.1169" class="difflineplus">+  nsresult rv;</span>
<a href="#l77.1170"></a><span id="l77.1170" class="difflineplus">+  m_timer = do_CreateInstance(&quot;@mozilla.org/timer;1&quot;, &amp;rv);</span>
<a href="#l77.1171"></a><span id="l77.1171" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1172"></a><span id="l77.1172" class="difflineplus">+  m_timer-&gt;InitWithFuncCallback(TimerCallback, (void *) this, 0,</span>
<a href="#l77.1173"></a><span id="l77.1173" class="difflineplus">+                                          nsITimer::TYPE_REPEATING_SLACK);</span>
<a href="#l77.1174"></a><span id="l77.1174" class="difflineplus">+  return NS_OK;</span>
<a href="#l77.1175"></a><span id="l77.1175" class="difflineplus">+}</span>
<a href="#l77.1176"></a><span id="l77.1176" class="difflineplus">+</span>
<a href="#l77.1177"></a><span id="l77.1177" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::RebuildIndex(nsIMsgFolder *aFolder,</span>
<a href="#l77.1178"></a><span id="l77.1178" class="difflineplus">+                                              nsIMsgDatabase *aMsgDB,</span>
<a href="#l77.1179"></a><span id="l77.1179" class="difflineplus">+                                              nsIMsgWindow *aMsgWindow,</span>
<a href="#l77.1180"></a><span id="l77.1180" class="difflineplus">+                                              nsIUrlListener *aListener)</span>
<a href="#l77.1181"></a><span id="l77.1181" class="difflineplus">+{</span>
<a href="#l77.1182"></a><span id="l77.1182" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aFolder);</span>
<a href="#l77.1183"></a><span id="l77.1183" class="difflineplus">+  // This code needs to iterate over the maildir files, and parse each</span>
<a href="#l77.1184"></a><span id="l77.1184" class="difflineplus">+  // file and add a msg hdr to the db for the file.</span>
<a href="#l77.1185"></a><span id="l77.1185" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l77.1186"></a><span id="l77.1186" class="difflineplus">+  nsresult rv = aFolder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l77.1187"></a><span id="l77.1187" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1188"></a><span id="l77.1188" class="difflineplus">+  path-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l77.1189"></a><span id="l77.1189" class="difflineplus">+</span>
<a href="#l77.1190"></a><span id="l77.1190" class="difflineplus">+  nsCOMPtr&lt;nsISimpleEnumerator&gt; directoryEnumerator;</span>
<a href="#l77.1191"></a><span id="l77.1191" class="difflineplus">+  rv = path-&gt;GetDirectoryEntries(getter_AddRefs(directoryEnumerator));</span>
<a href="#l77.1192"></a><span id="l77.1192" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1193"></a><span id="l77.1193" class="difflineplus">+</span>
<a href="#l77.1194"></a><span id="l77.1194" class="difflineplus">+  MaildirStoreParser *fileParser = new MaildirStoreParser(aFolder, aMsgDB,</span>
<a href="#l77.1195"></a><span id="l77.1195" class="difflineplus">+                                                          directoryEnumerator,</span>
<a href="#l77.1196"></a><span id="l77.1196" class="difflineplus">+                                                          aListener);</span>
<a href="#l77.1197"></a><span id="l77.1197" class="difflineplus">+  NS_ENSURE_TRUE(fileParser, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l77.1198"></a><span id="l77.1198" class="difflineplus">+  fileParser-&gt;StartTimer();</span>
<a href="#l77.1199"></a><span id="l77.1199" class="difflineplus">+  return NS_OK;</span>
<a href="#l77.1200"></a><span id="l77.1200" class="difflineplus">+}</span>
<a href="#l77.1201"></a><span id="l77.1201" class="difflineplus">+</span>
<a href="#l77.1202"></a><span id="l77.1202" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::ChangeFlags(nsIArray *aHdrArray,</span>
<a href="#l77.1203"></a><span id="l77.1203" class="difflineplus">+                                             PRUint32 aFlags,</span>
<a href="#l77.1204"></a><span id="l77.1204" class="difflineplus">+                                             bool aSet)</span>
<a href="#l77.1205"></a><span id="l77.1205" class="difflineplus">+{</span>
<a href="#l77.1206"></a><span id="l77.1206" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aHdrArray);</span>
<a href="#l77.1207"></a><span id="l77.1207" class="difflineplus">+</span>
<a href="#l77.1208"></a><span id="l77.1208" class="difflineplus">+  PRUint32 messageCount;</span>
<a href="#l77.1209"></a><span id="l77.1209" class="difflineplus">+  nsresult rv = aHdrArray-&gt;GetLength(&amp;messageCount);</span>
<a href="#l77.1210"></a><span id="l77.1210" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1211"></a><span id="l77.1211" class="difflineplus">+</span>
<a href="#l77.1212"></a><span id="l77.1212" class="difflineplus">+  for (PRUint32 i = 0; i &lt; messageCount; i++)</span>
<a href="#l77.1213"></a><span id="l77.1213" class="difflineplus">+  {</span>
<a href="#l77.1214"></a><span id="l77.1214" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = do_QueryElementAt(aHdrArray, i, &amp;rv);</span>
<a href="#l77.1215"></a><span id="l77.1215" class="difflineplus">+    // get output stream for header</span>
<a href="#l77.1216"></a><span id="l77.1216" class="difflineplus">+    nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l77.1217"></a><span id="l77.1217" class="difflineplus">+    rv = GetOutputStream(msgHdr, outputStream);</span>
<a href="#l77.1218"></a><span id="l77.1218" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1219"></a><span id="l77.1219" class="difflineplus">+    // Seek to x-mozilla-status offset and rewrite value.</span>
<a href="#l77.1220"></a><span id="l77.1220" class="difflineplus">+    rv = UpdateFolderFlag(msgHdr, aSet, aFlags, outputStream);</span>
<a href="#l77.1221"></a><span id="l77.1221" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l77.1222"></a><span id="l77.1222" class="difflineplus">+      NS_WARNING(&quot;updateFolderFlag failed&quot;);</span>
<a href="#l77.1223"></a><span id="l77.1223" class="difflineplus">+  }</span>
<a href="#l77.1224"></a><span id="l77.1224" class="difflineplus">+  return NS_OK;</span>
<a href="#l77.1225"></a><span id="l77.1225" class="difflineplus">+}</span>
<a href="#l77.1226"></a><span id="l77.1226" class="difflineplus">+</span>
<a href="#l77.1227"></a><span id="l77.1227" class="difflineplus">+// get output stream from header</span>
<a href="#l77.1228"></a><span id="l77.1228" class="difflineplus">+nsresult</span>
<a href="#l77.1229"></a><span id="l77.1229" class="difflineplus">+nsMsgMaildirStore::GetOutputStream(nsIMsgDBHdr *aHdr,</span>
<a href="#l77.1230"></a><span id="l77.1230" class="difflineplus">+                                   nsCOMPtr&lt;nsIOutputStream&gt; &amp;aOutputStream)</span>
<a href="#l77.1231"></a><span id="l77.1231" class="difflineplus">+{</span>
<a href="#l77.1232"></a><span id="l77.1232" class="difflineplus">+  // file name is stored in message header property &quot;storeToken&quot;</span>
<a href="#l77.1233"></a><span id="l77.1233" class="difflineplus">+  nsCAutoString fileName;</span>
<a href="#l77.1234"></a><span id="l77.1234" class="difflineplus">+  aHdr-&gt;GetStringProperty(&quot;storeToken&quot;, getter_Copies(fileName));</span>
<a href="#l77.1235"></a><span id="l77.1235" class="difflineplus">+  if (fileName.IsEmpty())</span>
<a href="#l77.1236"></a><span id="l77.1236" class="difflineplus">+    return NS_ERROR_FAILURE;</span>
<a href="#l77.1237"></a><span id="l77.1237" class="difflineplus">+</span>
<a href="#l77.1238"></a><span id="l77.1238" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder;</span>
<a href="#l77.1239"></a><span id="l77.1239" class="difflineplus">+  nsresult rv = aHdr-&gt;GetFolder(getter_AddRefs(folder));</span>
<a href="#l77.1240"></a><span id="l77.1240" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1241"></a><span id="l77.1241" class="difflineplus">+</span>
<a href="#l77.1242"></a><span id="l77.1242" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; folderPath;</span>
<a href="#l77.1243"></a><span id="l77.1243" class="difflineplus">+  rv = folder-&gt;GetFilePath(getter_AddRefs(folderPath));</span>
<a href="#l77.1244"></a><span id="l77.1244" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1245"></a><span id="l77.1245" class="difflineplus">+</span>
<a href="#l77.1246"></a><span id="l77.1246" class="difflineplus">+  nsCOMPtr&lt;nsIFile&gt; maildirFile;</span>
<a href="#l77.1247"></a><span id="l77.1247" class="difflineplus">+  folderPath-&gt;Clone(getter_AddRefs(maildirFile));</span>
<a href="#l77.1248"></a><span id="l77.1248" class="difflineplus">+  maildirFile-&gt;Append(NS_LITERAL_STRING(&quot;cur&quot;));</span>
<a href="#l77.1249"></a><span id="l77.1249" class="difflineplus">+  maildirFile-&gt;AppendNative(fileName);</span>
<a href="#l77.1250"></a><span id="l77.1250" class="difflineplus">+</span>
<a href="#l77.1251"></a><span id="l77.1251" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; localFile = do_QueryInterface(maildirFile);</span>
<a href="#l77.1252"></a><span id="l77.1252" class="difflineplus">+  return MsgGetFileStream(localFile, getter_AddRefs(aOutputStream));</span>
<a href="#l77.1253"></a><span id="l77.1253" class="difflineplus">+}</span>
<a href="#l77.1254"></a><span id="l77.1254" class="difflineplus">+</span>
<a href="#l77.1255"></a><span id="l77.1255" class="difflineplus">+NS_IMETHODIMP nsMsgMaildirStore::ChangeKeywords(nsIArray *aHdrArray,</span>
<a href="#l77.1256"></a><span id="l77.1256" class="difflineplus">+                                             const nsACString &amp;aKeywords,</span>
<a href="#l77.1257"></a><span id="l77.1257" class="difflineplus">+                                             bool aAdd)</span>
<a href="#l77.1258"></a><span id="l77.1258" class="difflineplus">+{</span>
<a href="#l77.1259"></a><span id="l77.1259" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aHdrArray);</span>
<a href="#l77.1260"></a><span id="l77.1260" class="difflineplus">+  NS_ENSURE_ARG_POINTER(aHdrArray);</span>
<a href="#l77.1261"></a><span id="l77.1261" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l77.1262"></a><span id="l77.1262" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableStream;</span>
<a href="#l77.1263"></a><span id="l77.1263" class="difflineplus">+</span>
<a href="#l77.1264"></a><span id="l77.1264" class="difflineplus">+  PRUint32 messageCount;</span>
<a href="#l77.1265"></a><span id="l77.1265" class="difflineplus">+  nsresult rv = aHdrArray-&gt;GetLength(&amp;messageCount);</span>
<a href="#l77.1266"></a><span id="l77.1266" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1267"></a><span id="l77.1267" class="difflineplus">+  if (!messageCount)</span>
<a href="#l77.1268"></a><span id="l77.1268" class="difflineplus">+    return NS_ERROR_INVALID_ARG;</span>
<a href="#l77.1269"></a><span id="l77.1269" class="difflineplus">+</span>
<a href="#l77.1270"></a><span id="l77.1270" class="difflineplus">+  nsLineBuffer&lt;char&gt; *lineBuffer;</span>
<a href="#l77.1271"></a><span id="l77.1271" class="difflineplus">+  rv = NS_InitLineBuffer(&amp;lineBuffer);</span>
<a href="#l77.1272"></a><span id="l77.1272" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1273"></a><span id="l77.1273" class="difflineplus">+</span>
<a href="#l77.1274"></a><span id="l77.1274" class="difflineplus">+  nsTArray&lt;nsCString&gt; keywordArray;</span>
<a href="#l77.1275"></a><span id="l77.1275" class="difflineplus">+  ParseString(aKeywords, ' ', keywordArray);</span>
<a href="#l77.1276"></a><span id="l77.1276" class="difflineplus">+</span>
<a href="#l77.1277"></a><span id="l77.1277" class="difflineplus">+  for (PRUint32 i = 0; i &lt; messageCount; ++i) // for each message</span>
<a href="#l77.1278"></a><span id="l77.1278" class="difflineplus">+  {</span>
<a href="#l77.1279"></a><span id="l77.1279" class="difflineplus">+    nsCOMPtr&lt;nsIMsgDBHdr&gt; message = do_QueryElementAt(aHdrArray, i, &amp;rv);</span>
<a href="#l77.1280"></a><span id="l77.1280" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1281"></a><span id="l77.1281" class="difflineplus">+    // get output stream for header</span>
<a href="#l77.1282"></a><span id="l77.1282" class="difflineplus">+    nsCOMPtr&lt;nsIOutputStream&gt; outputStream;</span>
<a href="#l77.1283"></a><span id="l77.1283" class="difflineplus">+    rv = GetOutputStream(message, outputStream);</span>
<a href="#l77.1284"></a><span id="l77.1284" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1285"></a><span id="l77.1285" class="difflineplus">+    nsCOMPtr &lt;nsIInputStream&gt; inputStream = do_QueryInterface(outputStream, &amp;rv);</span>
<a href="#l77.1286"></a><span id="l77.1286" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1287"></a><span id="l77.1287" class="difflineplus">+    nsCOMPtr &lt;nsISeekableStream&gt; seekableStream(do_QueryInterface(inputStream, &amp;rv));</span>
<a href="#l77.1288"></a><span id="l77.1288" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1289"></a><span id="l77.1289" class="difflineplus">+    PRUint32 statusOffset = 0;</span>
<a href="#l77.1290"></a><span id="l77.1290" class="difflineplus">+    (void)message-&gt;GetStatusOffset(&amp;statusOffset);</span>
<a href="#l77.1291"></a><span id="l77.1291" class="difflineplus">+    PRUint64 desiredOffset = statusOffset;</span>
<a href="#l77.1292"></a><span id="l77.1292" class="difflineplus">+</span>
<a href="#l77.1293"></a><span id="l77.1293" class="difflineplus">+    ChangeKeywordsHelper(message, desiredOffset, lineBuffer, keywordArray,</span>
<a href="#l77.1294"></a><span id="l77.1294" class="difflineplus">+                         aAdd, outputStream, seekableStream, inputStream);</span>
<a href="#l77.1295"></a><span id="l77.1295" class="difflineplus">+    if (inputStream)</span>
<a href="#l77.1296"></a><span id="l77.1296" class="difflineplus">+      inputStream-&gt;Close();</span>
<a href="#l77.1297"></a><span id="l77.1297" class="difflineplus">+    // ### TODO - if growKeywords property is set on the message header,</span>
<a href="#l77.1298"></a><span id="l77.1298" class="difflineplus">+    // we need to rewrite the message file with extra room for the keywords,</span>
<a href="#l77.1299"></a><span id="l77.1299" class="difflineplus">+    // or schedule some sort of background task to do this.</span>
<a href="#l77.1300"></a><span id="l77.1300" class="difflineplus">+  }</span>
<a href="#l77.1301"></a><span id="l77.1301" class="difflineplus">+  PR_Free(lineBuffer);</span>
<a href="#l77.1302"></a><span id="l77.1302" class="difflineplus">+  return NS_OK;</span>
<a href="#l77.1303"></a><span id="l77.1303" class="difflineplus">+}</span>
<a href="#l77.1304"></a><span id="l77.1304" class="difflineplus">+</span>
<a href="#l77.1305"></a><span id="l77.1305" class="difflineplus">+/**</span>
<a href="#l77.1306"></a><span id="l77.1306" class="difflineplus">+ * Finds the directory associated with this folder. That is if the path is</span>
<a href="#l77.1307"></a><span id="l77.1307" class="difflineplus">+ * c:\Inbox, it will return c:\Inbox.sbd if it succeeds. Path is strictly</span>
<a href="#l77.1308"></a><span id="l77.1308" class="difflineplus">+ * an out parameter.</span>
<a href="#l77.1309"></a><span id="l77.1309" class="difflineplus">+ */</span>
<a href="#l77.1310"></a><span id="l77.1310" class="difflineplus">+nsresult nsMsgMaildirStore::GetDirectoryForFolder(nsILocalFile *path)</span>
<a href="#l77.1311"></a><span id="l77.1311" class="difflineplus">+{</span>
<a href="#l77.1312"></a><span id="l77.1312" class="difflineplus">+  // add directory separator to the path</span>
<a href="#l77.1313"></a><span id="l77.1313" class="difflineplus">+  nsAutoString leafName;</span>
<a href="#l77.1314"></a><span id="l77.1314" class="difflineplus">+  path-&gt;GetLeafName(leafName);</span>
<a href="#l77.1315"></a><span id="l77.1315" class="difflineplus">+  leafName.AppendLiteral(FOLDER_SUFFIX);</span>
<a href="#l77.1316"></a><span id="l77.1316" class="difflineplus">+  return path-&gt;SetLeafName(leafName);</span>
<a href="#l77.1317"></a><span id="l77.1317" class="difflineplus">+}</span>
<a href="#l77.1318"></a><span id="l77.1318" class="difflineplus">+</span>
<a href="#l77.1319"></a><span id="l77.1319" class="difflineplus">+nsresult nsMsgMaildirStore::CreateDirectoryForFolder(nsILocalFile *path,</span>
<a href="#l77.1320"></a><span id="l77.1320" class="difflineplus">+                                                     bool aIsServer)</span>
<a href="#l77.1321"></a><span id="l77.1321" class="difflineplus">+{</span>
<a href="#l77.1322"></a><span id="l77.1322" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l77.1323"></a><span id="l77.1323" class="difflineplus">+  if (!aIsServer)</span>
<a href="#l77.1324"></a><span id="l77.1324" class="difflineplus">+  {</span>
<a href="#l77.1325"></a><span id="l77.1325" class="difflineplus">+    rv = GetDirectoryForFolder(path);</span>
<a href="#l77.1326"></a><span id="l77.1326" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l77.1327"></a><span id="l77.1327" class="difflineplus">+  }</span>
<a href="#l77.1328"></a><span id="l77.1328" class="difflineplus">+  bool pathIsDirectory = false;</span>
<a href="#l77.1329"></a><span id="l77.1329" class="difflineplus">+  path-&gt;IsDirectory(&amp;pathIsDirectory);</span>
<a href="#l77.1330"></a><span id="l77.1330" class="difflineplus">+  if (!pathIsDirectory)</span>
<a href="#l77.1331"></a><span id="l77.1331" class="difflineplus">+  {</span>
<a href="#l77.1332"></a><span id="l77.1332" class="difflineplus">+    bool pathExists;</span>
<a href="#l77.1333"></a><span id="l77.1333" class="difflineplus">+    path-&gt;Exists(&amp;pathExists);</span>
<a href="#l77.1334"></a><span id="l77.1334" class="difflineplus">+    //If for some reason there's a file with the directory separator</span>
<a href="#l77.1335"></a><span id="l77.1335" class="difflineplus">+    //then we are going to fail.</span>
<a href="#l77.1336"></a><span id="l77.1336" class="difflineplus">+    rv = pathExists ? NS_MSG_COULD_NOT_CREATE_DIRECTORY :</span>
<a href="#l77.1337"></a><span id="l77.1337" class="difflineplus">+         path-&gt;Create(nsIFile::DIRECTORY_TYPE, 0700);</span>
<a href="#l77.1338"></a><span id="l77.1338" class="difflineplus">+  }</span>
<a href="#l77.1339"></a><span id="l77.1339" class="difflineplus">+  return rv;</span>
<a href="#l77.1340"></a><span id="l77.1340" class="difflineplus">+}</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l78.1"></a><span id="l78.1">new file mode 100644</span>
<a href="#l78.2"></a><span id="l78.2" class="difflineminus">--- /dev/null</span>
<a href="#l78.3"></a><span id="l78.3" class="difflineplus">+++ b/mailnews/local/src/nsMsgMaildirStore.h</span>
<a href="#l78.4"></a><span id="l78.4" class="difflineat">@@ -0,0 +1,72 @@</span>
<a href="#l78.5"></a><span id="l78.5" class="difflineplus">+/* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l78.6"></a><span id="l78.6" class="difflineplus">+/* ***** BEGIN LICENSE BLOCK *****</span>
<a href="#l78.7"></a><span id="l78.7" class="difflineplus">+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1</span>
<a href="#l78.8"></a><span id="l78.8" class="difflineplus">+ *</span>
<a href="#l78.9"></a><span id="l78.9" class="difflineplus">+ * The contents of this file are subject to the Mozilla Public License Version</span>
<a href="#l78.10"></a><span id="l78.10" class="difflineplus">+ * 1.1 (the &quot;License&quot;); you may not use this file except in compliance with</span>
<a href="#l78.11"></a><span id="l78.11" class="difflineplus">+ * the License. You may obtain a copy of the License at</span>
<a href="#l78.12"></a><span id="l78.12" class="difflineplus">+ * http://www.mozilla.org/MPL/</span>
<a href="#l78.13"></a><span id="l78.13" class="difflineplus">+ *</span>
<a href="#l78.14"></a><span id="l78.14" class="difflineplus">+ * Software distributed under the License is distributed on an &quot;AS IS&quot; basis,</span>
<a href="#l78.15"></a><span id="l78.15" class="difflineplus">+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License</span>
<a href="#l78.16"></a><span id="l78.16" class="difflineplus">+ * for the specific language governing rights and limitations under the</span>
<a href="#l78.17"></a><span id="l78.17" class="difflineplus">+ * License.</span>
<a href="#l78.18"></a><span id="l78.18" class="difflineplus">+ *</span>
<a href="#l78.19"></a><span id="l78.19" class="difflineplus">+ * The Original Code is mozilla.org code.</span>
<a href="#l78.20"></a><span id="l78.20" class="difflineplus">+ *</span>
<a href="#l78.21"></a><span id="l78.21" class="difflineplus">+ * The Initial Developer of the Original Code is</span>
<a href="#l78.22"></a><span id="l78.22" class="difflineplus">+ * Mozilla Foundation.</span>
<a href="#l78.23"></a><span id="l78.23" class="difflineplus">+ * Portions created by the Initial Developer are Copyright (C) 2011</span>
<a href="#l78.24"></a><span id="l78.24" class="difflineplus">+ * the Initial Developer. All Rights Reserved.</span>
<a href="#l78.25"></a><span id="l78.25" class="difflineplus">+ *</span>
<a href="#l78.26"></a><span id="l78.26" class="difflineplus">+ * Contributor(s):</span>
<a href="#l78.27"></a><span id="l78.27" class="difflineplus">+ *   dbienvenu@mozilla.com</span>
<a href="#l78.28"></a><span id="l78.28" class="difflineplus">+ *</span>
<a href="#l78.29"></a><span id="l78.29" class="difflineplus">+ * Alternatively, the contents of this file may be used under the terms of</span>
<a href="#l78.30"></a><span id="l78.30" class="difflineplus">+ * either of the GNU General Public License Version 2 or later (the &quot;GPL&quot;),</span>
<a href="#l78.31"></a><span id="l78.31" class="difflineplus">+ * or the GNU Lesser General Public License Version 2.1 or later (the &quot;LGPL&quot;),</span>
<a href="#l78.32"></a><span id="l78.32" class="difflineplus">+ * in which case the provisions of the GPL or the LGPL are applicable instead</span>
<a href="#l78.33"></a><span id="l78.33" class="difflineplus">+ * of those above. If you wish to allow use of your version of this file only</span>
<a href="#l78.34"></a><span id="l78.34" class="difflineplus">+ * under the terms of either the GPL or the LGPL, and not to allow others to</span>
<a href="#l78.35"></a><span id="l78.35" class="difflineplus">+ * use your version of this file under the terms of the MPL, indicate your</span>
<a href="#l78.36"></a><span id="l78.36" class="difflineplus">+ * decision by deleting the provisions above and replace them with the notice</span>
<a href="#l78.37"></a><span id="l78.37" class="difflineplus">+ * and other provisions required by the GPL or the LGPL. If you do not delete</span>
<a href="#l78.38"></a><span id="l78.38" class="difflineplus">+ * the provisions above, a recipient may use your version of this file under</span>
<a href="#l78.39"></a><span id="l78.39" class="difflineplus">+ * the terms of any one of the MPL, the GPL or the LGPL.</span>
<a href="#l78.40"></a><span id="l78.40" class="difflineplus">+ *</span>
<a href="#l78.41"></a><span id="l78.41" class="difflineplus">+ * ***** END LICENSE BLOCK ***** */</span>
<a href="#l78.42"></a><span id="l78.42" class="difflineplus">+</span>
<a href="#l78.43"></a><span id="l78.43" class="difflineplus">+/**</span>
<a href="#l78.44"></a><span id="l78.44" class="difflineplus">+   Class for handling Maildir stores.</span>
<a href="#l78.45"></a><span id="l78.45" class="difflineplus">+*/</span>
<a href="#l78.46"></a><span id="l78.46" class="difflineplus">+</span>
<a href="#l78.47"></a><span id="l78.47" class="difflineplus">+#ifndef nsMsgMaildirStore_h__</span>
<a href="#l78.48"></a><span id="l78.48" class="difflineplus">+#define nsMsgMaildirStore_h__</span>
<a href="#l78.49"></a><span id="l78.49" class="difflineplus">+</span>
<a href="#l78.50"></a><span id="l78.50" class="difflineplus">+#include &quot;nsMsgLocalStoreUtils.h&quot;</span>
<a href="#l78.51"></a><span id="l78.51" class="difflineplus">+#include &quot;nsILocalFile.h&quot;</span>
<a href="#l78.52"></a><span id="l78.52" class="difflineplus">+#include &quot;nsInterfaceHashtable.h&quot;</span>
<a href="#l78.53"></a><span id="l78.53" class="difflineplus">+#include &quot;nsMsgMessageFlags.h&quot;</span>
<a href="#l78.54"></a><span id="l78.54" class="difflineplus">+</span>
<a href="#l78.55"></a><span id="l78.55" class="difflineplus">+class nsMsgMaildirStore : public nsMsgLocalStoreUtils, nsIMsgPluggableStore</span>
<a href="#l78.56"></a><span id="l78.56" class="difflineplus">+{</span>
<a href="#l78.57"></a><span id="l78.57" class="difflineplus">+public:</span>
<a href="#l78.58"></a><span id="l78.58" class="difflineplus">+  NS_DECL_ISUPPORTS</span>
<a href="#l78.59"></a><span id="l78.59" class="difflineplus">+  NS_DECL_NSIMSGPLUGGABLESTORE</span>
<a href="#l78.60"></a><span id="l78.60" class="difflineplus">+</span>
<a href="#l78.61"></a><span id="l78.61" class="difflineplus">+  nsMsgMaildirStore();</span>
<a href="#l78.62"></a><span id="l78.62" class="difflineplus">+</span>
<a href="#l78.63"></a><span id="l78.63" class="difflineplus">+private:</span>
<a href="#l78.64"></a><span id="l78.64" class="difflineplus">+  ~nsMsgMaildirStore();</span>
<a href="#l78.65"></a><span id="l78.65" class="difflineplus">+</span>
<a href="#l78.66"></a><span id="l78.66" class="difflineplus">+protected:</span>
<a href="#l78.67"></a><span id="l78.67" class="difflineplus">+  nsresult GetDirectoryForFolder(nsILocalFile *path);</span>
<a href="#l78.68"></a><span id="l78.68" class="difflineplus">+  nsresult CreateDirectoryForFolder(nsILocalFile *path, bool aIsServer);</span>
<a href="#l78.69"></a><span id="l78.69" class="difflineplus">+</span>
<a href="#l78.70"></a><span id="l78.70" class="difflineplus">+  nsresult CreateMaildir(nsILocalFile *path);</span>
<a href="#l78.71"></a><span id="l78.71" class="difflineplus">+  nsresult AddSubFolders(nsIMsgFolder *parent, nsIFile *path, bool deep);</span>
<a href="#l78.72"></a><span id="l78.72" class="difflineplus">+  nsresult GetOutputStream(nsIMsgDBHdr *aHdr,</span>
<a href="#l78.73"></a><span id="l78.73" class="difflineplus">+                           nsCOMPtr&lt;nsIOutputStream&gt; &amp;aOutputStream);</span>
<a href="#l78.74"></a><span id="l78.74" class="difflineplus">+</span>
<a href="#l78.75"></a><span id="l78.75" class="difflineplus">+};</span>
<a href="#l78.76"></a><span id="l78.76" class="difflineplus">+#endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l79.1"></a><span id="l79.1" class="difflineminus">--- a/mailnews/local/src/nsNoIncomingServer.cpp</span>
<a href="#l79.2"></a><span id="l79.2" class="difflineplus">+++ b/mailnews/local/src/nsNoIncomingServer.cpp</span>
<a href="#l79.3"></a><span id="l79.3" class="difflineat">@@ -175,29 +175,29 @@ NS_IMETHODIMP nsNoIncomingServer::Create</span>
<a href="#l79.4"></a><span id="l79.4">   nsresult rv = aPath-&gt;Clone(getter_AddRefs(path));</span>
<a href="#l79.5"></a><span id="l79.5">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.6"></a><span id="l79.6"> </span>
<a href="#l79.7"></a><span id="l79.7">   // notice, no Inbox, unless we're deferred to...</span>
<a href="#l79.8"></a><span id="l79.8">    // need to have a leaf to start with</span>
<a href="#l79.9"></a><span id="l79.9">   rv = path-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Trash&quot;));</span>
<a href="#l79.10"></a><span id="l79.10">   bool isDeferredTo;</span>
<a href="#l79.11"></a><span id="l79.11">   if (NS_SUCCEEDED(GetIsDeferredTo(&amp;isDeferredTo)) &amp;&amp; isDeferredTo)</span>
<a href="#l79.12"></a><span id="l79.12" class="difflineminus">-    CreateLocalFolder(path, NS_LITERAL_CSTRING(&quot;Inbox&quot;));</span>
<a href="#l79.13"></a><span id="l79.13" class="difflineminus">-  CreateLocalFolder(path, NS_LITERAL_CSTRING(&quot;Trash&quot;));</span>
<a href="#l79.14"></a><span id="l79.14" class="difflineplus">+    CreateLocalFolder(NS_LITERAL_STRING(&quot;Inbox&quot;));</span>
<a href="#l79.15"></a><span id="l79.15" class="difflineplus">+  CreateLocalFolder(NS_LITERAL_STRING(&quot;Trash&quot;));</span>
<a href="#l79.16"></a><span id="l79.16">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.17"></a><span id="l79.17"> </span>
<a href="#l79.18"></a><span id="l79.18">   // copy the default templates into the Templates folder</span>
<a href="#l79.19"></a><span id="l79.19">   nsCOMPtr&lt;nsIFile&gt; parentDir;</span>
<a href="#l79.20"></a><span id="l79.20">   rv = path-&gt;GetParent(getter_AddRefs(parentDir));</span>
<a href="#l79.21"></a><span id="l79.21">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.22"></a><span id="l79.22">   nsCOMPtr &lt;nsILocalFile&gt; parent = do_QueryInterface(parentDir);</span>
<a href="#l79.23"></a><span id="l79.23">   rv = CopyDefaultMessages(&quot;Templates&quot;, parent);</span>
<a href="#l79.24"></a><span id="l79.24">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l79.25"></a><span id="l79.25"> </span>
<a href="#l79.26"></a><span id="l79.26" class="difflineminus">-  (void ) CreateLocalFolder(path, NS_LITERAL_CSTRING(&quot;Unsent Messages&quot;));</span>
<a href="#l79.27"></a><span id="l79.27" class="difflineplus">+  (void ) CreateLocalFolder(NS_LITERAL_STRING(&quot;Unsent Messages&quot;));</span>
<a href="#l79.28"></a><span id="l79.28">   return NS_OK;</span>
<a href="#l79.29"></a><span id="l79.29"> }</span>
<a href="#l79.30"></a><span id="l79.30"> </span>
<a href="#l79.31"></a><span id="l79.31"> NS_IMETHODIMP</span>
<a href="#l79.32"></a><span id="l79.32"> nsNoIncomingServer::GetNewMail(nsIMsgWindow *aMsgWindow, nsIUrlListener *aUrlListener, nsIMsgFolder *aInbox, nsIURI **aResult)</span>
<a href="#l79.33"></a><span id="l79.33"> {</span>
<a href="#l79.34"></a><span id="l79.34">   nsCOMPtr &lt;nsISupportsArray&gt; deferredServers;</span>
<a href="#l79.35"></a><span id="l79.35">   nsresult rv = GetDeferredServers(this, getter_AddRefs(deferredServers));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l80.1"></a><span id="l80.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l80.2"></a><span id="l80.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.cpp</span>
<a href="#l80.3"></a><span id="l80.3" class="difflineat">@@ -88,16 +88,17 @@</span>
<a href="#l80.4"></a><span id="l80.4"> #include &quot;nsICryptoHash.h&quot;</span>
<a href="#l80.5"></a><span id="l80.5"> #include &quot;nsIStringBundle.h&quot;</span>
<a href="#l80.6"></a><span id="l80.6"> #include &quot;nsLocalStrings.h&quot;</span>
<a href="#l80.7"></a><span id="l80.7"> #include &quot;nsIMsgFilterPlugin.h&quot;</span>
<a href="#l80.8"></a><span id="l80.8"> #include &quot;nsIMutableArray.h&quot;</span>
<a href="#l80.9"></a><span id="l80.9"> #include &quot;nsArrayUtils.h&quot;</span>
<a href="#l80.10"></a><span id="l80.10"> #include &quot;nsIMsgFilterCustomAction.h&quot;</span>
<a href="#l80.11"></a><span id="l80.11"> #include &lt;ctype.h&gt;</span>
<a href="#l80.12"></a><span id="l80.12" class="difflineplus">+#include &quot;nsIMsgPluggableStore.h&quot;</span>
<a href="#l80.13"></a><span id="l80.13"> </span>
<a href="#l80.14"></a><span id="l80.14"> static NS_DEFINE_CID(kCMailDB, NS_MAILDB_CID);</span>
<a href="#l80.15"></a><span id="l80.15"> static NS_DEFINE_CID(kRDFServiceCID, NS_RDFSERVICE_CID);</span>
<a href="#l80.16"></a><span id="l80.16"> </span>
<a href="#l80.17"></a><span id="l80.17"> /* the following macros actually implement addref, release and query interface for our component. */</span>
<a href="#l80.18"></a><span id="l80.18"> NS_IMPL_ISUPPORTS_INHERITED2(nsMsgMailboxParser,</span>
<a href="#l80.19"></a><span id="l80.19">                              nsParseMailMessageState,</span>
<a href="#l80.20"></a><span id="l80.20">                              nsIStreamListener,</span>
<a href="#l80.21"></a><span id="l80.21" class="difflineat">@@ -289,31 +290,31 @@ nsParseMailMessageState::OnJunkScoreChan</span>
<a href="#l80.22"></a><span id="l80.22"> </span>
<a href="#l80.23"></a><span id="l80.23"> nsMsgMailboxParser::nsMsgMailboxParser() : nsMsgLineBuffer(nsnull, PR_FALSE)</span>
<a href="#l80.24"></a><span id="l80.24"> {</span>
<a href="#l80.25"></a><span id="l80.25">   Init();</span>
<a href="#l80.26"></a><span id="l80.26"> }</span>
<a href="#l80.27"></a><span id="l80.27"> </span>
<a href="#l80.28"></a><span id="l80.28"> nsMsgMailboxParser::nsMsgMailboxParser(nsIMsgFolder *aFolder) : nsMsgLineBuffer(nsnull, PR_FALSE)</span>
<a href="#l80.29"></a><span id="l80.29"> {</span>
<a href="#l80.30"></a><span id="l80.30" class="difflineminus">-  Init();</span>
<a href="#l80.31"></a><span id="l80.31">   m_folder = do_GetWeakReference(aFolder);</span>
<a href="#l80.32"></a><span id="l80.32"> }</span>
<a href="#l80.33"></a><span id="l80.33"> </span>
<a href="#l80.34"></a><span id="l80.34"> nsMsgMailboxParser::~nsMsgMailboxParser()</span>
<a href="#l80.35"></a><span id="l80.35"> {</span>
<a href="#l80.36"></a><span id="l80.36">   ReleaseFolderLock();</span>
<a href="#l80.37"></a><span id="l80.37"> }</span>
<a href="#l80.38"></a><span id="l80.38"> </span>
<a href="#l80.39"></a><span id="l80.39" class="difflineminus">-void nsMsgMailboxParser::Init()</span>
<a href="#l80.40"></a><span id="l80.40" class="difflineplus">+nsresult nsMsgMailboxParser::Init()</span>
<a href="#l80.41"></a><span id="l80.41"> {</span>
<a href="#l80.42"></a><span id="l80.42">   m_obuffer = nsnull;</span>
<a href="#l80.43"></a><span id="l80.43">   m_obuffer_size = 0;</span>
<a href="#l80.44"></a><span id="l80.44">   m_graph_progress_total = 0;</span>
<a href="#l80.45"></a><span id="l80.45">   m_graph_progress_received = 0;</span>
<a href="#l80.46"></a><span id="l80.46" class="difflineplus">+  return AcquireFolderLock();</span>
<a href="#l80.47"></a><span id="l80.47"> }</span>
<a href="#l80.48"></a><span id="l80.48"> </span>
<a href="#l80.49"></a><span id="l80.49"> void nsMsgMailboxParser::UpdateStatusText (PRUint32 stringID)</span>
<a href="#l80.50"></a><span id="l80.50"> {</span>
<a href="#l80.51"></a><span id="l80.51">   if (m_statusFeedback)</span>
<a href="#l80.52"></a><span id="l80.52">   {</span>
<a href="#l80.53"></a><span id="l80.53">     nsresult rv;</span>
<a href="#l80.54"></a><span id="l80.54">     nsCOMPtr&lt;nsIStringBundleService&gt; bundleService(do_GetService(&quot;@mozilla.org/intl/stringbundle;1&quot;, &amp;rv));</span>
<a href="#l80.55"></a><span id="l80.55" class="difflineat">@@ -417,16 +418,20 @@ void nsMsgMailboxParser::UpdateDBFolderI</span>
<a href="#l80.56"></a><span id="l80.56"> }</span>
<a href="#l80.57"></a><span id="l80.57"> </span>
<a href="#l80.58"></a><span id="l80.58"> // Tell the world about the message header (add to db, and view, if any)</span>
<a href="#l80.59"></a><span id="l80.59"> PRInt32 nsMsgMailboxParser::PublishMsgHeader(nsIMsgWindow *msgWindow)</span>
<a href="#l80.60"></a><span id="l80.60"> {</span>
<a href="#l80.61"></a><span id="l80.61">   FinishHeader();</span>
<a href="#l80.62"></a><span id="l80.62">   if (m_newMsgHdr)</span>
<a href="#l80.63"></a><span id="l80.63">   {</span>
<a href="#l80.64"></a><span id="l80.64" class="difflineplus">+    char storeToken[100];</span>
<a href="#l80.65"></a><span id="l80.65" class="difflineplus">+    PR_snprintf(storeToken, sizeof(storeToken), &quot;%lld&quot;, m_envelope_pos);</span>
<a href="#l80.66"></a><span id="l80.66" class="difflineplus">+    m_newMsgHdr-&gt;SetStringProperty(&quot;storeToken&quot;, storeToken);</span>
<a href="#l80.67"></a><span id="l80.67" class="difflineplus">+</span>
<a href="#l80.68"></a><span id="l80.68">     PRUint32 flags;</span>
<a href="#l80.69"></a><span id="l80.69">     (void)m_newMsgHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l80.70"></a><span id="l80.70">     if (flags &amp; nsMsgMessageFlags::Expunged)</span>
<a href="#l80.71"></a><span id="l80.71">     {</span>
<a href="#l80.72"></a><span id="l80.72">       nsCOMPtr&lt;nsIDBFolderInfo&gt; folderInfo;</span>
<a href="#l80.73"></a><span id="l80.73">       m_mailDB-&gt;GetDBFolderInfo(getter_AddRefs(folderInfo));</span>
<a href="#l80.74"></a><span id="l80.74">       PRUint32 size;</span>
<a href="#l80.75"></a><span id="l80.75">       (void)m_newMsgHdr-&gt;GetMessageSize(&amp;size);</span>
<a href="#l80.76"></a><span id="l80.76" class="difflineat">@@ -454,16 +459,22 @@ PRInt32 nsMsgMailboxParser::PublishMsgHe</span>
<a href="#l80.77"></a><span id="l80.77"> }</span>
<a href="#l80.78"></a><span id="l80.78"> </span>
<a href="#l80.79"></a><span id="l80.79"> void nsMsgMailboxParser::AbortNewHeader()</span>
<a href="#l80.80"></a><span id="l80.80"> {</span>
<a href="#l80.81"></a><span id="l80.81">   if (m_newMsgHdr &amp;&amp; m_mailDB)</span>
<a href="#l80.82"></a><span id="l80.82">     m_newMsgHdr = nsnull;</span>
<a href="#l80.83"></a><span id="l80.83"> }</span>
<a href="#l80.84"></a><span id="l80.84"> </span>
<a href="#l80.85"></a><span id="l80.85" class="difflineplus">+void nsMsgMailboxParser::OnNewMessage(nsIMsgWindow *msgWindow)</span>
<a href="#l80.86"></a><span id="l80.86" class="difflineplus">+{</span>
<a href="#l80.87"></a><span id="l80.87" class="difflineplus">+  PublishMsgHeader(msgWindow);</span>
<a href="#l80.88"></a><span id="l80.88" class="difflineplus">+  Clear();</span>
<a href="#l80.89"></a><span id="l80.89" class="difflineplus">+}</span>
<a href="#l80.90"></a><span id="l80.90" class="difflineplus">+</span>
<a href="#l80.91"></a><span id="l80.91"> PRInt32 nsMsgMailboxParser::HandleLine(char *line, PRUint32 lineLength)</span>
<a href="#l80.92"></a><span id="l80.92"> {</span>
<a href="#l80.93"></a><span id="l80.93">   int status = 0;</span>
<a href="#l80.94"></a><span id="l80.94"> </span>
<a href="#l80.95"></a><span id="l80.95">   /* If this is the very first line of a non-empty folder, make sure it's an envelope */</span>
<a href="#l80.96"></a><span id="l80.96">   if (m_graph_progress_received == 0)</span>
<a href="#l80.97"></a><span id="l80.97">   {</span>
<a href="#l80.98"></a><span id="l80.98">     /* This is the first block from the file.  Check to see if this</span>
<a href="#l80.99"></a><span id="l80.99" class="difflineat">@@ -493,18 +504,17 @@ PRInt32 nsMsgMailboxParser::HandleLine(c</span>
<a href="#l80.100"></a><span id="l80.100">     // **** I am not sure this is a right thing to do. This happens when</span>
<a href="#l80.101"></a><span id="l80.101">     // going online, downloading a message while playing back append</span>
<a href="#l80.102"></a><span id="l80.102">     // draft/template offline operation. We are mixing</span>
<a href="#l80.103"></a><span id="l80.103">         // nsMailboxParseBodyState &amp;&amp;</span>
<a href="#l80.104"></a><span id="l80.104">     // nsMailboxParseHeadersState. David I need your help here too. **** jt</span>
<a href="#l80.105"></a><span id="l80.105"> </span>
<a href="#l80.106"></a><span id="l80.106">     NS_ASSERTION (m_state == nsIMsgParseMailMsgState::ParseBodyState ||</span>
<a href="#l80.107"></a><span id="l80.107">            m_state == nsIMsgParseMailMsgState::ParseHeadersState, &quot;invalid parse state&quot;); /* else folder corrupted */</span>
<a href="#l80.108"></a><span id="l80.108" class="difflineminus">-    PublishMsgHeader(nsnull);</span>
<a href="#l80.109"></a><span id="l80.109" class="difflineminus">-    Clear();</span>
<a href="#l80.110"></a><span id="l80.110" class="difflineplus">+    OnNewMessage(nsnull);</span>
<a href="#l80.111"></a><span id="l80.111">     status = StartNewEnvelope(line, lineLength);</span>
<a href="#l80.112"></a><span id="l80.112">     NS_ASSERTION(status &gt;= 0, &quot; error starting envelope parsing mailbox&quot;);</span>
<a href="#l80.113"></a><span id="l80.113">     // at the start of each new message, update the progress bar</span>
<a href="#l80.114"></a><span id="l80.114">     UpdateProgressPercent();</span>
<a href="#l80.115"></a><span id="l80.115">     if (status &lt; 0)</span>
<a href="#l80.116"></a><span id="l80.116">       return status;</span>
<a href="#l80.117"></a><span id="l80.117">   }</span>
<a href="#l80.118"></a><span id="l80.118">   // otherwise, the message parser can handle it completely.</span>
<a href="#l80.119"></a><span id="l80.119" class="difflineat">@@ -523,18 +533,27 @@ nsMsgMailboxParser::ReleaseFolderLock()</span>
<a href="#l80.120"></a><span id="l80.120">   nsresult result;</span>
<a href="#l80.121"></a><span id="l80.121">   nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(m_folder);</span>
<a href="#l80.122"></a><span id="l80.122">   if (!folder)</span>
<a href="#l80.123"></a><span id="l80.123">     return;</span>
<a href="#l80.124"></a><span id="l80.124">   bool haveSemaphore;</span>
<a href="#l80.125"></a><span id="l80.125">   nsCOMPtr &lt;nsISupports&gt; supports = do_QueryInterface(static_cast&lt;nsIMsgParseMailMsgState*&gt;(this));</span>
<a href="#l80.126"></a><span id="l80.126">   result = folder-&gt;TestSemaphore(supports, &amp;haveSemaphore);</span>
<a href="#l80.127"></a><span id="l80.127">   if(NS_SUCCEEDED(result) &amp;&amp; haveSemaphore)</span>
<a href="#l80.128"></a><span id="l80.128" class="difflineminus">-    result = folder-&gt;ReleaseSemaphore(supports);</span>
<a href="#l80.129"></a><span id="l80.129" class="difflineminus">-  return;</span>
<a href="#l80.130"></a><span id="l80.130" class="difflineplus">+    (void) folder-&gt;ReleaseSemaphore(supports);</span>
<a href="#l80.131"></a><span id="l80.131" class="difflineplus">+}</span>
<a href="#l80.132"></a><span id="l80.132" class="difflineplus">+</span>
<a href="#l80.133"></a><span id="l80.133" class="difflineplus">+nsresult</span>
<a href="#l80.134"></a><span id="l80.134" class="difflineplus">+nsMsgMailboxParser::AcquireFolderLock()</span>
<a href="#l80.135"></a><span id="l80.135" class="difflineplus">+{</span>
<a href="#l80.136"></a><span id="l80.136" class="difflineplus">+  nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryReferent(m_folder);</span>
<a href="#l80.137"></a><span id="l80.137" class="difflineplus">+  if (!folder)</span>
<a href="#l80.138"></a><span id="l80.138" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l80.139"></a><span id="l80.139" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; supports = do_QueryObject(this);</span>
<a href="#l80.140"></a><span id="l80.140" class="difflineplus">+  return folder-&gt;AcquireSemaphore(supports);</span>
<a href="#l80.141"></a><span id="l80.141"> }</span>
<a href="#l80.142"></a><span id="l80.142"> </span>
<a href="#l80.143"></a><span id="l80.143"> NS_IMPL_ISUPPORTS2(nsParseMailMessageState, nsIMsgParseMailMsgState, nsIDBChangeListener)</span>
<a href="#l80.144"></a><span id="l80.144"> </span>
<a href="#l80.145"></a><span id="l80.145"> nsParseMailMessageState::nsParseMailMessageState()</span>
<a href="#l80.146"></a><span id="l80.146"> {</span>
<a href="#l80.147"></a><span id="l80.147">   m_position = 0;</span>
<a href="#l80.148"></a><span id="l80.148">   m_IgnoreXMozillaStatus = PR_FALSE;</span>
<a href="#l80.149"></a><span id="l80.149" class="difflineat">@@ -654,16 +673,22 @@ NS_IMETHODIMP nsParseMailMessageState::S</span>
<a href="#l80.150"></a><span id="l80.150"> </span>
<a href="#l80.151"></a><span id="l80.151"> NS_IMETHODIMP nsParseMailMessageState::GetNewMsgHdr(nsIMsgDBHdr ** aMsgHeader)</span>
<a href="#l80.152"></a><span id="l80.152"> {</span>
<a href="#l80.153"></a><span id="l80.153">   NS_ENSURE_ARG_POINTER(aMsgHeader);</span>
<a href="#l80.154"></a><span id="l80.154">   NS_IF_ADDREF(*aMsgHeader = m_newMsgHdr);</span>
<a href="#l80.155"></a><span id="l80.155">   return m_newMsgHdr ? NS_OK : NS_ERROR_NULL_POINTER;</span>
<a href="#l80.156"></a><span id="l80.156"> }</span>
<a href="#l80.157"></a><span id="l80.157"> </span>
<a href="#l80.158"></a><span id="l80.158" class="difflineplus">+NS_IMETHODIMP nsParseMailMessageState::SetNewMsgHdr(nsIMsgDBHdr *aMsgHeader)</span>
<a href="#l80.159"></a><span id="l80.159" class="difflineplus">+{</span>
<a href="#l80.160"></a><span id="l80.160" class="difflineplus">+  m_newMsgHdr = aMsgHeader;</span>
<a href="#l80.161"></a><span id="l80.161" class="difflineplus">+  return NS_OK;</span>
<a href="#l80.162"></a><span id="l80.162" class="difflineplus">+}</span>
<a href="#l80.163"></a><span id="l80.163" class="difflineplus">+</span>
<a href="#l80.164"></a><span id="l80.164"> NS_IMETHODIMP nsParseMailMessageState::ParseAFolderLine(const char *line, PRUint32 lineLength)</span>
<a href="#l80.165"></a><span id="l80.165"> {</span>
<a href="#l80.166"></a><span id="l80.166">   ParseFolderLine(line, lineLength);</span>
<a href="#l80.167"></a><span id="l80.167">   return NS_OK;</span>
<a href="#l80.168"></a><span id="l80.168"> }</span>
<a href="#l80.169"></a><span id="l80.169"> </span>
<a href="#l80.170"></a><span id="l80.170"> PRInt32 nsParseMailMessageState::ParseFolderLine(const char *line, PRUint32 lineLength)</span>
<a href="#l80.171"></a><span id="l80.171"> {</span>
<a href="#l80.172"></a><span id="l80.172" class="difflineat">@@ -712,24 +737,16 @@ NS_IMETHODIMP nsParseMailMessageState::S</span>
<a href="#l80.173"></a><span id="l80.173"> NS_IMETHODIMP nsParseMailMessageState::SetBackupMailDB(nsIMsgDatabase *aBackupMailDB)</span>
<a href="#l80.174"></a><span id="l80.174"> {</span>
<a href="#l80.175"></a><span id="l80.175">   m_backupMailDB = aBackupMailDB;</span>
<a href="#l80.176"></a><span id="l80.176">   if (m_backupMailDB)</span>
<a href="#l80.177"></a><span id="l80.177">     m_backupMailDB-&gt;AddListener(this);</span>
<a href="#l80.178"></a><span id="l80.178">   return NS_OK;</span>
<a href="#l80.179"></a><span id="l80.179"> }</span>
<a href="#l80.180"></a><span id="l80.180"> </span>
<a href="#l80.181"></a><span id="l80.181" class="difflineminus">-NS_IMETHODIMP nsParseMailMessageState::SetDBFolderStream(nsIOutputStream *fileStream)</span>
<a href="#l80.182"></a><span id="l80.182" class="difflineminus">-{</span>
<a href="#l80.183"></a><span id="l80.183" class="difflineminus">-  NS_ASSERTION(m_mailDB, &quot;m_mailDB is not set&quot;);</span>
<a href="#l80.184"></a><span id="l80.184" class="difflineminus">-  if (m_mailDB)</span>
<a href="#l80.185"></a><span id="l80.185" class="difflineminus">-    m_mailDB-&gt;SetFolderStream(fileStream);</span>
<a href="#l80.186"></a><span id="l80.186" class="difflineminus">-  return NS_OK;</span>
<a href="#l80.187"></a><span id="l80.187" class="difflineminus">-}</span>
<a href="#l80.188"></a><span id="l80.188" class="difflineminus">-</span>
<a href="#l80.189"></a><span id="l80.189"> /* #define STRICT_ENVELOPE */</span>
<a href="#l80.190"></a><span id="l80.190"> </span>
<a href="#l80.191"></a><span id="l80.191"> bool</span>
<a href="#l80.192"></a><span id="l80.192"> nsParseMailMessageState::IsEnvelopeLine(const char *buf, PRInt32 buf_size)</span>
<a href="#l80.193"></a><span id="l80.193"> {</span>
<a href="#l80.194"></a><span id="l80.194"> #ifdef STRICT_ENVELOPE</span>
<a href="#l80.195"></a><span id="l80.195">   /* The required format is</span>
<a href="#l80.196"></a><span id="l80.196">      From jwz  Fri Jul  1 09:13:09 1994</span>
<a href="#l80.197"></a><span id="l80.197" class="difflineat">@@ -817,27 +834,25 @@ nsParseMailMessageState::IsEnvelopeLine(</span>
<a href="#l80.198"></a><span id="l80.198">   if (*buf != 'F') return PR_FALSE;</span>
<a href="#l80.199"></a><span id="l80.199">   if (strncmp(buf, &quot;From &quot;, 5)) return PR_FALSE;</span>
<a href="#l80.200"></a><span id="l80.200"> </span>
<a href="#l80.201"></a><span id="l80.201"> #endif /* !STRICT_ENVELOPE */</span>
<a href="#l80.202"></a><span id="l80.202"> </span>
<a href="#l80.203"></a><span id="l80.203">   return PR_TRUE;</span>
<a href="#l80.204"></a><span id="l80.204"> }</span>
<a href="#l80.205"></a><span id="l80.205"> </span>
<a href="#l80.206"></a><span id="l80.206" class="difflineminus">-</span>
<a href="#l80.207"></a><span id="l80.207"> // We've found the start of the next message, so finish this one off.</span>
<a href="#l80.208"></a><span id="l80.208"> NS_IMETHODIMP nsParseMailMessageState::FinishHeader()</span>
<a href="#l80.209"></a><span id="l80.209"> {</span>
<a href="#l80.210"></a><span id="l80.210">   if (m_newMsgHdr)</span>
<a href="#l80.211"></a><span id="l80.211">   {</span>
<a href="#l80.212"></a><span id="l80.212" class="difflineminus">-    m_newMsgHdr-&gt;SetMessageKey(m_envelope_pos);</span>
<a href="#l80.213"></a><span id="l80.213" class="difflineminus">-    m_newMsgHdr-&gt;SetMessageSize(m_position - m_envelope_pos);  // dmb - no longer number of lines.</span>
<a href="#l80.214"></a><span id="l80.214" class="difflineplus">+    m_newMsgHdr-&gt;SetMessageOffset(m_envelope_pos);</span>
<a href="#l80.215"></a><span id="l80.215" class="difflineplus">+    m_newMsgHdr-&gt;SetMessageSize(m_position - m_envelope_pos);</span>
<a href="#l80.216"></a><span id="l80.216">     m_newMsgHdr-&gt;SetLineCount(m_body_lines);</span>
<a href="#l80.217"></a><span id="l80.217">   }</span>
<a href="#l80.218"></a><span id="l80.218" class="difflineminus">-</span>
<a href="#l80.219"></a><span id="l80.219">   return NS_OK;</span>
<a href="#l80.220"></a><span id="l80.220"> }</span>
<a href="#l80.221"></a><span id="l80.221"> </span>
<a href="#l80.222"></a><span id="l80.222"> NS_IMETHODIMP nsParseMailMessageState::GetAllHeaders(char ** pHeaders, PRInt32 *pHeadersSize)</span>
<a href="#l80.223"></a><span id="l80.223"> {</span>
<a href="#l80.224"></a><span id="l80.224">   if (!pHeaders || !pHeadersSize)</span>
<a href="#l80.225"></a><span id="l80.225">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l80.226"></a><span id="l80.226">   *pHeaders = m_headers.GetBuffer();</span>
<a href="#l80.227"></a><span id="l80.227" class="difflineat">@@ -1365,27 +1380,30 @@ int nsParseMailMessageState::FinalizeHea</span>
<a href="#l80.228"></a><span id="l80.228">         rawMsgId.Assign(id-&gt;value);</span>
<a href="#l80.229"></a><span id="l80.229">     }</span>
<a href="#l80.230"></a><span id="l80.230"> </span>
<a href="#l80.231"></a><span id="l80.231">     /*</span>
<a href="#l80.232"></a><span id="l80.232">      * Try to copy the data from the backup database, referencing the MessageID</span>
<a href="#l80.233"></a><span id="l80.233">      * If that fails, just create a new header</span>
<a href="#l80.234"></a><span id="l80.234">      */</span>
<a href="#l80.235"></a><span id="l80.235">     nsCOMPtr&lt;nsIMsgDBHdr&gt; oldHeader;</span>
<a href="#l80.236"></a><span id="l80.236" class="difflineminus">-    nsresult ret = NS_ERROR_FAILURE;</span>
<a href="#l80.237"></a><span id="l80.237" class="difflineplus">+    nsresult ret = NS_OK;</span>
<a href="#l80.238"></a><span id="l80.238"> </span>
<a href="#l80.239"></a><span id="l80.239">     if (m_backupMailDB &amp;&amp; !rawMsgId.IsEmpty())</span>
<a href="#l80.240"></a><span id="l80.240">       ret = m_backupMailDB-&gt;GetMsgHdrForMessageID(</span>
<a href="#l80.241"></a><span id="l80.241">               rawMsgId.get(), getter_AddRefs(oldHeader));</span>
<a href="#l80.242"></a><span id="l80.242"> </span>
<a href="#l80.243"></a><span id="l80.243">     if (NS_SUCCEEDED(ret) &amp;&amp; oldHeader)</span>
<a href="#l80.244"></a><span id="l80.244">         ret = m_mailDB-&gt;CopyHdrFromExistingHdr(m_envelope_pos,</span>
<a href="#l80.245"></a><span id="l80.245">                 oldHeader, PR_FALSE, getter_AddRefs(m_newMsgHdr));</span>
<a href="#l80.246"></a><span id="l80.246" class="difflineminus">-    else</span>
<a href="#l80.247"></a><span id="l80.247" class="difflineplus">+    else if (!m_newMsgHdr)</span>
<a href="#l80.248"></a><span id="l80.248" class="difflineplus">+    {</span>
<a href="#l80.249"></a><span id="l80.249" class="difflineplus">+      // Should assert that this is not a local message</span>
<a href="#l80.250"></a><span id="l80.250">       ret = m_mailDB-&gt;CreateNewHdr(m_envelope_pos, getter_AddRefs(m_newMsgHdr));</span>
<a href="#l80.251"></a><span id="l80.251" class="difflineplus">+    }</span>
<a href="#l80.252"></a><span id="l80.252"> </span>
<a href="#l80.253"></a><span id="l80.253">     if (NS_SUCCEEDED(ret) &amp;&amp; m_newMsgHdr)</span>
<a href="#l80.254"></a><span id="l80.254">     {</span>
<a href="#l80.255"></a><span id="l80.255">       PRUint32 origFlags;</span>
<a href="#l80.256"></a><span id="l80.256">       (void)m_newMsgHdr-&gt;GetFlags(&amp;origFlags);</span>
<a href="#l80.257"></a><span id="l80.257">       if (origFlags &amp; nsMsgMessageFlags::HasRe)</span>
<a href="#l80.258"></a><span id="l80.258">         flags |= nsMsgMessageFlags::HasRe;</span>
<a href="#l80.259"></a><span id="l80.259">       else</span>
<a href="#l80.260"></a><span id="l80.260" class="difflineat">@@ -1468,17 +1486,17 @@ int nsParseMailMessageState::FinalizeHea</span>
<a href="#l80.261"></a><span id="l80.261">       {</span>
<a href="#l80.262"></a><span id="l80.262">         PRUint32 numAddresses;</span>
<a href="#l80.263"></a><span id="l80.263">         char  *names;</span>
<a href="#l80.264"></a><span id="l80.264">         char  *addresses;</span>
<a href="#l80.265"></a><span id="l80.265"> </span>
<a href="#l80.266"></a><span id="l80.266">         ret = m_HeaderAddressParser-&gt;ParseHeaderAddresses(ccList-&gt;value,</span>
<a href="#l80.267"></a><span id="l80.267">                                                           &amp;names, &amp;addresses,</span>
<a href="#l80.268"></a><span id="l80.268">                                                           &amp;numAddresses);</span>
<a href="#l80.269"></a><span id="l80.269" class="difflineminus">-        if (ret == NS_OK)</span>
<a href="#l80.270"></a><span id="l80.270" class="difflineplus">+        if (NS_SUCCEEDED(ret) &amp;&amp; numAddresses &gt; 0)</span>
<a href="#l80.271"></a><span id="l80.271">         {</span>
<a href="#l80.272"></a><span id="l80.272">           m_newMsgHdr-&gt;SetCCListArray(names, addresses, numAddresses);</span>
<a href="#l80.273"></a><span id="l80.273">           PR_Free(addresses);</span>
<a href="#l80.274"></a><span id="l80.274">           PR_Free(names);</span>
<a href="#l80.275"></a><span id="l80.275">         }</span>
<a href="#l80.276"></a><span id="l80.276">         else  // hmm, should we just use the original string?</span>
<a href="#l80.277"></a><span id="l80.277">           m_newMsgHdr-&gt;SetCcList(ccList-&gt;value);</span>
<a href="#l80.278"></a><span id="l80.278">       }</span>
<a href="#l80.279"></a><span id="l80.279" class="difflineat">@@ -1692,41 +1710,36 @@ int nsParseMailMessageState::FinalizeHea</span>
<a href="#l80.280"></a><span id="l80.280">   PR_Free(tmp);</span>
<a href="#l80.281"></a><span id="l80.281"> </span>
<a href="#l80.282"></a><span id="l80.282">   return status;</span>
<a href="#l80.283"></a><span id="l80.283"> }</span>
<a href="#l80.284"></a><span id="l80.284"> </span>
<a href="#l80.285"></a><span id="l80.285"> nsParseNewMailState::nsParseNewMailState()</span>
<a href="#l80.286"></a><span id="l80.286">     : m_disableFilters(PR_FALSE)</span>
<a href="#l80.287"></a><span id="l80.287"> {</span>
<a href="#l80.288"></a><span id="l80.288" class="difflineminus">-  m_inboxFileStream = nsnull;</span>
<a href="#l80.289"></a><span id="l80.289">   m_ibuffer = nsnull;</span>
<a href="#l80.290"></a><span id="l80.290">   m_ibuffer_size = 0;</span>
<a href="#l80.291"></a><span id="l80.291">   m_ibuffer_fp = 0;</span>
<a href="#l80.292"></a><span id="l80.292">   m_numNotNewMessages = 0;</span>
<a href="#l80.293"></a><span id="l80.293">  }</span>
<a href="#l80.294"></a><span id="l80.294"> </span>
<a href="#l80.295"></a><span id="l80.295"> NS_IMPL_ISUPPORTS_INHERITED1(nsParseNewMailState, nsMsgMailboxParser, nsIMsgFilterHitNotify)</span>
<a href="#l80.296"></a><span id="l80.296"> </span>
<a href="#l80.297"></a><span id="l80.297"> nsresult</span>
<a href="#l80.298"></a><span id="l80.298"> nsParseNewMailState::Init(nsIMsgFolder *serverFolder, nsIMsgFolder *downloadFolder,</span>
<a href="#l80.299"></a><span id="l80.299" class="difflineminus">-                          nsIInputStream *inboxFileStream, nsIMsgWindow *aMsgWindow)</span>
<a href="#l80.300"></a><span id="l80.300" class="difflineplus">+                          nsIMsgWindow *aMsgWindow, nsIMsgDBHdr *aHdr,</span>
<a href="#l80.301"></a><span id="l80.301" class="difflineplus">+                          nsIOutputStream *aOutputStream)</span>
<a href="#l80.302"></a><span id="l80.302"> {</span>
<a href="#l80.303"></a><span id="l80.303">   nsresult rv;</span>
<a href="#l80.304"></a><span id="l80.304" class="difflineminus">-  PRInt64 folderSize;</span>
<a href="#l80.305"></a><span id="l80.305" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; folder;</span>
<a href="#l80.306"></a><span id="l80.306" class="difflineminus">-  downloadFolder-&gt;GetFilePath(getter_AddRefs(folder));</span>
<a href="#l80.307"></a><span id="l80.307" class="difflineminus">-  folder-&gt;GetFileSize(&amp;folderSize);</span>
<a href="#l80.308"></a><span id="l80.308" class="difflineminus">-  m_position = folderSize;</span>
<a href="#l80.309"></a><span id="l80.309">   m_rootFolder = serverFolder;</span>
<a href="#l80.310"></a><span id="l80.310" class="difflineminus">-  m_inboxFile = folder;</span>
<a href="#l80.311"></a><span id="l80.311" class="difflineminus">-  m_inboxFileStream = inboxFileStream;</span>
<a href="#l80.312"></a><span id="l80.312">   m_msgWindow = aMsgWindow;</span>
<a href="#l80.313"></a><span id="l80.313">   m_downloadFolder = downloadFolder;</span>
<a href="#l80.314"></a><span id="l80.314"> </span>
<a href="#l80.315"></a><span id="l80.315" class="difflineplus">+  m_newMsgHdr = aHdr;</span>
<a href="#l80.316"></a><span id="l80.316" class="difflineplus">+  m_outputStream = aOutputStream;</span>
<a href="#l80.317"></a><span id="l80.317">   // the new mail parser isn't going to get the stream input, it seems, so we can't use</span>
<a href="#l80.318"></a><span id="l80.318">   // the OnStartRequest mechanism the mailbox parser uses. So, let's open the db right now.</span>
<a href="#l80.319"></a><span id="l80.319">   nsCOMPtr&lt;nsIMsgDBService&gt; msgDBService = do_GetService(NS_MSGDB_SERVICE_CONTRACTID, &amp;rv);</span>
<a href="#l80.320"></a><span id="l80.320">   if (msgDBService)</span>
<a href="#l80.321"></a><span id="l80.321">     rv = msgDBService-&gt;OpenFolderDB(downloadFolder, PR_FALSE,</span>
<a href="#l80.322"></a><span id="l80.322">                                     getter_AddRefs(m_mailDB));</span>
<a href="#l80.323"></a><span id="l80.323">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l80.324"></a><span id="l80.324">   nsCOMPtr &lt;nsIMsgFolder&gt; rootMsgFolder = do_QueryInterface(serverFolder, &amp;rv);</span>
<a href="#l80.325"></a><span id="l80.325" class="difflineat">@@ -1734,19 +1747,17 @@ nsParseNewMailState::Init(nsIMsgFolder *</span>
<a href="#l80.326"></a><span id="l80.326"> </span>
<a href="#l80.327"></a><span id="l80.327">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l80.328"></a><span id="l80.328">   rv = rootMsgFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l80.329"></a><span id="l80.329">   if (NS_SUCCEEDED(rv))</span>
<a href="#l80.330"></a><span id="l80.330">   {</span>
<a href="#l80.331"></a><span id="l80.331">     rv = server-&gt;GetFilterList(aMsgWindow, getter_AddRefs(m_filterList));</span>
<a href="#l80.332"></a><span id="l80.332"> </span>
<a href="#l80.333"></a><span id="l80.333">     if (m_filterList)</span>
<a href="#l80.334"></a><span id="l80.334" class="difflineminus">-    {</span>
<a href="#l80.335"></a><span id="l80.335">       rv = server-&gt;ConfigureTemporaryFilters(m_filterList);</span>
<a href="#l80.336"></a><span id="l80.336" class="difflineminus">-    }</span>
<a href="#l80.337"></a><span id="l80.337">     // check if this server defers to another server, in which case</span>
<a href="#l80.338"></a><span id="l80.338">     // we'll use that server's filters as well.</span>
<a href="#l80.339"></a><span id="l80.339">     nsCOMPtr &lt;nsIMsgFolder&gt; deferredToRootFolder;</span>
<a href="#l80.340"></a><span id="l80.340">     server-&gt;GetRootMsgFolder(getter_AddRefs(deferredToRootFolder));</span>
<a href="#l80.341"></a><span id="l80.341">     if (rootMsgFolder != deferredToRootFolder)</span>
<a href="#l80.342"></a><span id="l80.342">     {</span>
<a href="#l80.343"></a><span id="l80.343">       nsCOMPtr &lt;nsIMsgIncomingServer&gt; deferredToServer;</span>
<a href="#l80.344"></a><span id="l80.344">       deferredToRootFolder-&gt;GetServer(getter_AddRefs(deferredToServer));</span>
<a href="#l80.345"></a><span id="l80.345" class="difflineat">@@ -1794,34 +1805,34 @@ void nsParseNewMailState::DoneParsingFol</span>
<a href="#l80.346"></a><span id="l80.346">     /* We're done reading the folder - we don't need these things</span>
<a href="#l80.347"></a><span id="l80.347">    any more. */</span>
<a href="#l80.348"></a><span id="l80.348">   PR_FREEIF (m_ibuffer);</span>
<a href="#l80.349"></a><span id="l80.349">   m_ibuffer_size = 0;</span>
<a href="#l80.350"></a><span id="l80.350">   PR_FREEIF (m_obuffer);</span>
<a href="#l80.351"></a><span id="l80.351">   m_obuffer_size = 0;</span>
<a href="#l80.352"></a><span id="l80.352"> }</span>
<a href="#l80.353"></a><span id="l80.353"> </span>
<a href="#l80.354"></a><span id="l80.354" class="difflineplus">+void nsParseNewMailState::OnNewMessage(nsIMsgWindow *msgWindow)</span>
<a href="#l80.355"></a><span id="l80.355" class="difflineplus">+{</span>
<a href="#l80.356"></a><span id="l80.356" class="difflineplus">+}</span>
<a href="#l80.357"></a><span id="l80.357" class="difflineplus">+</span>
<a href="#l80.358"></a><span id="l80.358"> PRInt32 nsParseNewMailState::PublishMsgHeader(nsIMsgWindow *msgWindow)</span>
<a href="#l80.359"></a><span id="l80.359"> {</span>
<a href="#l80.360"></a><span id="l80.360">   bool moved = false;</span>
<a href="#l80.361"></a><span id="l80.361">   FinishHeader();</span>
<a href="#l80.362"></a><span id="l80.362"> </span>
<a href="#l80.363"></a><span id="l80.363">   if (m_newMsgHdr)</span>
<a href="#l80.364"></a><span id="l80.364">   {</span>
<a href="#l80.365"></a><span id="l80.365">     PRUint32 newFlags, oldFlags;</span>
<a href="#l80.366"></a><span id="l80.366">     m_newMsgHdr-&gt;GetFlags(&amp;oldFlags);</span>
<a href="#l80.367"></a><span id="l80.367">     if (!(oldFlags &amp; nsMsgMessageFlags::Read)) // don't mark read messages as new.</span>
<a href="#l80.368"></a><span id="l80.368">       m_newMsgHdr-&gt;OrFlags(nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l80.369"></a><span id="l80.369"> </span>
<a href="#l80.370"></a><span id="l80.370">     if (!m_disableFilters)</span>
<a href="#l80.371"></a><span id="l80.371">     {</span>
<a href="#l80.372"></a><span id="l80.372" class="difflineminus">-      // seems like the code that's writing to disk should do</span>
<a href="#l80.373"></a><span id="l80.373" class="difflineminus">-      // the flushing...</span>
<a href="#l80.374"></a><span id="l80.374" class="difflineminus">-      // flush the inbox because filters will read from disk</span>
<a href="#l80.375"></a><span id="l80.375" class="difflineminus">-      // m_inboxFileStream-&gt;Flush();</span>
<a href="#l80.376"></a><span id="l80.376">       PRUint64 msgOffset;</span>
<a href="#l80.377"></a><span id="l80.377">       (void) m_newMsgHdr-&gt;GetMessageOffset(&amp;msgOffset);</span>
<a href="#l80.378"></a><span id="l80.378">       m_curHdrOffset = msgOffset;</span>
<a href="#l80.379"></a><span id="l80.379"> </span>
<a href="#l80.380"></a><span id="l80.380">       nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l80.381"></a><span id="l80.381">       nsresult rv = m_rootFolder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l80.382"></a><span id="l80.382">       NS_ENSURE_SUCCESS(rv, 0);</span>
<a href="#l80.383"></a><span id="l80.383">       PRInt32 duplicateAction;</span>
<a href="#l80.384"></a><span id="l80.384" class="difflineat">@@ -1834,49 +1845,47 @@ PRInt32 nsParseNewMailState::PublishMsgH</span>
<a href="#l80.385"></a><span id="l80.385">         {</span>
<a href="#l80.386"></a><span id="l80.386">           // we want to do something similar to applying filter hits.</span>
<a href="#l80.387"></a><span id="l80.387">           // if a dup is marked read, it shouldn't trigger biff.</span>
<a href="#l80.388"></a><span id="l80.388">           // Same for deleting it or moving it to trash.</span>
<a href="#l80.389"></a><span id="l80.389">           switch (duplicateAction)</span>
<a href="#l80.390"></a><span id="l80.390">           {</span>
<a href="#l80.391"></a><span id="l80.391">             case nsIMsgIncomingServer::deleteDups:</span>
<a href="#l80.392"></a><span id="l80.392">               {</span>
<a href="#l80.393"></a><span id="l80.393" class="difflineminus">-                m_inboxFileStream-&gt;Close();</span>
<a href="#l80.394"></a><span id="l80.394" class="difflineminus">-</span>
<a href="#l80.395"></a><span id="l80.395" class="difflineminus">-                nsresult truncRet = m_inboxFile-&gt;SetFileSize(msgOffset);</span>
<a href="#l80.396"></a><span id="l80.396" class="difflineminus">-                NS_ASSERTION(NS_SUCCEEDED(truncRet), &quot;unable to truncate file&quot;);</span>
<a href="#l80.397"></a><span id="l80.397" class="difflineminus">-                if (NS_FAILED(truncRet))</span>
<a href="#l80.398"></a><span id="l80.398" class="difflineplus">+              nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l80.399"></a><span id="l80.399" class="difflineplus">+              nsresult rv =</span>
<a href="#l80.400"></a><span id="l80.400" class="difflineplus">+                m_downloadFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l80.401"></a><span id="l80.401" class="difflineplus">+              if (NS_SUCCEEDED(rv))</span>
<a href="#l80.402"></a><span id="l80.402" class="difflineplus">+              {</span>
<a href="#l80.403"></a><span id="l80.403" class="difflineplus">+                rv = msgStore-&gt;DiscardNewMessage(m_outputStream, m_newMsgHdr);</span>
<a href="#l80.404"></a><span id="l80.404" class="difflineplus">+                if (NS_FAILED(rv))</span>
<a href="#l80.405"></a><span id="l80.405">                   m_rootFolder-&gt;ThrowAlertMsg(&quot;dupDeleteFolderTruncateFailed&quot;, msgWindow);</span>
<a href="#l80.406"></a><span id="l80.406" class="difflineminus">-</span>
<a href="#l80.407"></a><span id="l80.407" class="difflineminus">-                MsgReopenFileStream(m_inboxFile, m_inboxFileStream);</span>
<a href="#l80.408"></a><span id="l80.408" class="difflineminus">-</span>
<a href="#l80.409"></a><span id="l80.409" class="difflineminus">-                nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(m_inboxFileStream);</span>
<a href="#l80.410"></a><span id="l80.410" class="difflineminus">-                if (seekableStream)</span>
<a href="#l80.411"></a><span id="l80.411" class="difflineminus">-                  seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l80.412"></a><span id="l80.412" class="difflineminus">-</span>
<a href="#l80.413"></a><span id="l80.413" class="difflineplus">+              }</span>
<a href="#l80.414"></a><span id="l80.414">                 m_mailDB-&gt;RemoveHeaderMdbRow(m_newMsgHdr);</span>
<a href="#l80.415"></a><span id="l80.415" class="difflineminus">-                // tell parser we've truncated the inbox.</span>
<a href="#l80.416"></a><span id="l80.416" class="difflineminus">-                nsParseMailMessageState::Init(msgOffset);</span>
<a href="#l80.417"></a><span id="l80.417" class="difflineminus">-</span>
<a href="#l80.418"></a><span id="l80.418">               }</span>
<a href="#l80.419"></a><span id="l80.419">               break;</span>
<a href="#l80.420"></a><span id="l80.420">             case nsIMsgIncomingServer::moveDupsToTrash:</span>
<a href="#l80.421"></a><span id="l80.421">               {</span>
<a href="#l80.422"></a><span id="l80.422">                 nsCOMPtr &lt;nsIMsgFolder&gt; trash;</span>
<a href="#l80.423"></a><span id="l80.423">                 GetTrashFolder(getter_AddRefs(trash));</span>
<a href="#l80.424"></a><span id="l80.424">                 if (trash)</span>
<a href="#l80.425"></a><span id="l80.425">                 {</span>
<a href="#l80.426"></a><span id="l80.426">                   PRUint32 newFlags;</span>
<a href="#l80.427"></a><span id="l80.427" class="difflineplus">+                bool msgMoved;</span>
<a href="#l80.428"></a><span id="l80.428">                   m_newMsgHdr-&gt;AndFlags(~nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l80.429"></a><span id="l80.429" class="difflineminus">-                  // save off m_newMsgHdr because MoveIncorporatedMessage </span>
<a href="#l80.430"></a><span id="l80.430" class="difflineminus">-                  // clears it by calling nsParseMailMessageState::Init</span>
<a href="#l80.431"></a><span id="l80.431" class="difflineminus">-                  nsCOMPtr&lt;nsIMsgDBHdr&gt; msgHdr = m_newMsgHdr;</span>
<a href="#l80.432"></a><span id="l80.432" class="difflineplus">+                nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l80.433"></a><span id="l80.433" class="difflineplus">+                rv = m_downloadFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l80.434"></a><span id="l80.434" class="difflineplus">+                if (NS_SUCCEEDED(rv))</span>
<a href="#l80.435"></a><span id="l80.435" class="difflineplus">+                  msgStore-&gt;MoveNewlyDownloadedMessage(m_newMsgHdr, trash, &amp;msgMoved);</span>
<a href="#l80.436"></a><span id="l80.436" class="difflineplus">+                if (!msgMoved)</span>
<a href="#l80.437"></a><span id="l80.437" class="difflineplus">+                {</span>
<a href="#l80.438"></a><span id="l80.438">                   MoveIncorporatedMessage(m_newMsgHdr, m_mailDB, trash,</span>
<a href="#l80.439"></a><span id="l80.439">                                                           nsnull, msgWindow);</span>
<a href="#l80.440"></a><span id="l80.440" class="difflineminus">-                  m_mailDB-&gt;RemoveHeaderMdbRow(msgHdr);</span>
<a href="#l80.441"></a><span id="l80.441" class="difflineplus">+                  m_mailDB-&gt;RemoveHeaderMdbRow(m_newMsgHdr);</span>
<a href="#l80.442"></a><span id="l80.442" class="difflineplus">+                }</span>
<a href="#l80.443"></a><span id="l80.443">                 }</span>
<a href="#l80.444"></a><span id="l80.444">               }</span>
<a href="#l80.445"></a><span id="l80.445">               break;</span>
<a href="#l80.446"></a><span id="l80.446">             case nsIMsgIncomingServer::markDupsRead:</span>
<a href="#l80.447"></a><span id="l80.447">               MarkFilteredMessageRead(m_newMsgHdr);</span>
<a href="#l80.448"></a><span id="l80.448">               break;</span>
<a href="#l80.449"></a><span id="l80.449">           }</span>
<a href="#l80.450"></a><span id="l80.450">           PRInt32 numNewMessages;</span>
<a href="#l80.451"></a><span id="l80.451" class="difflineat">@@ -1905,16 +1914,27 @@ PRInt32 nsParseNewMailState::PublishMsgH</span>
<a href="#l80.452"></a><span id="l80.452">            msgKey, nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l80.453"></a><span id="l80.453">       }</span>
<a href="#l80.454"></a><span id="l80.454">     } // if it was moved by imap filter, m_parseMsgState-&gt;m_newMsgHdr == nsnull</span>
<a href="#l80.455"></a><span id="l80.455">     m_newMsgHdr = nsnull;</span>
<a href="#l80.456"></a><span id="l80.456">   }</span>
<a href="#l80.457"></a><span id="l80.457">   return 0;</span>
<a href="#l80.458"></a><span id="l80.458"> }</span>
<a href="#l80.459"></a><span id="l80.459"> </span>
<a href="#l80.460"></a><span id="l80.460" class="difflineplus">+// We've found the start of the next message, so finish this one off.</span>
<a href="#l80.461"></a><span id="l80.461" class="difflineplus">+NS_IMETHODIMP nsParseNewMailState::FinishHeader()</span>
<a href="#l80.462"></a><span id="l80.462" class="difflineplus">+{</span>
<a href="#l80.463"></a><span id="l80.463" class="difflineplus">+  if (m_newMsgHdr)</span>
<a href="#l80.464"></a><span id="l80.464" class="difflineplus">+  {</span>
<a href="#l80.465"></a><span id="l80.465" class="difflineplus">+    m_newMsgHdr-&gt;SetMessageSize(m_position - m_envelope_pos);</span>
<a href="#l80.466"></a><span id="l80.466" class="difflineplus">+    m_newMsgHdr-&gt;SetLineCount(m_body_lines);</span>
<a href="#l80.467"></a><span id="l80.467" class="difflineplus">+  }</span>
<a href="#l80.468"></a><span id="l80.468" class="difflineplus">+  return NS_OK;</span>
<a href="#l80.469"></a><span id="l80.469" class="difflineplus">+}</span>
<a href="#l80.470"></a><span id="l80.470" class="difflineplus">+</span>
<a href="#l80.471"></a><span id="l80.471"> nsresult nsParseNewMailState::GetTrashFolder(nsIMsgFolder **pTrashFolder)</span>
<a href="#l80.472"></a><span id="l80.472"> {</span>
<a href="#l80.473"></a><span id="l80.473">   nsresult rv=NS_ERROR_UNEXPECTED;</span>
<a href="#l80.474"></a><span id="l80.474">   if (!pTrashFolder)</span>
<a href="#l80.475"></a><span id="l80.475">     return NS_ERROR_NULL_POINTER;</span>
<a href="#l80.476"></a><span id="l80.476"> </span>
<a href="#l80.477"></a><span id="l80.477">   if(m_downloadFolder)</span>
<a href="#l80.478"></a><span id="l80.478">   {</span>
<a href="#l80.479"></a><span id="l80.479" class="difflineat">@@ -1948,22 +1968,25 @@ void nsParseNewMailState::ApplyFilters(b</span>
<a href="#l80.480"></a><span id="l80.480">         rootMsgFolder-&gt;GetFolderWithFlags(nsMsgFolderFlags::Inbox,</span>
<a href="#l80.481"></a><span id="l80.481">                                           getter_AddRefs(downloadFolder));</span>
<a href="#l80.482"></a><span id="l80.482">       if (downloadFolder)</span>
<a href="#l80.483"></a><span id="l80.483">         downloadFolder-&gt;GetURI(m_inboxUri);</span>
<a href="#l80.484"></a><span id="l80.484">       char * headers = m_headers.GetBuffer();</span>
<a href="#l80.485"></a><span id="l80.485">       PRUint32 headersSize = m_headers.GetBufferPos();</span>
<a href="#l80.486"></a><span id="l80.486">       nsresult matchTermStatus;</span>
<a href="#l80.487"></a><span id="l80.487">       if (m_filterList)</span>
<a href="#l80.488"></a><span id="l80.488" class="difflineminus">-        matchTermStatus = m_filterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::InboxRule,</span>
<a href="#l80.489"></a><span id="l80.489" class="difflineminus">-                    msgHdr, downloadFolder, m_mailDB, headers, headersSize, this, msgWindow);</span>
<a href="#l80.490"></a><span id="l80.490" class="difflineplus">+        matchTermStatus =</span>
<a href="#l80.491"></a><span id="l80.491" class="difflineplus">+          m_filterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::InboxRule, msgHdr,</span>
<a href="#l80.492"></a><span id="l80.492" class="difflineplus">+                                          downloadFolder, m_mailDB, headers,</span>
<a href="#l80.493"></a><span id="l80.493" class="difflineplus">+                                          headersSize, this, msgWindow);</span>
<a href="#l80.494"></a><span id="l80.494">       if (!m_msgMovedByFilter &amp;&amp; m_deferredToServerFilterList)</span>
<a href="#l80.495"></a><span id="l80.495">       {</span>
<a href="#l80.496"></a><span id="l80.496" class="difflineminus">-        matchTermStatus = m_deferredToServerFilterList-&gt;ApplyFiltersToHdr(nsMsgFilterType::InboxRule,</span>
<a href="#l80.497"></a><span id="l80.497" class="difflineminus">-                    msgHdr, downloadFolder, m_mailDB, headers, headersSize, this, msgWindow);</span>
<a href="#l80.498"></a><span id="l80.498" class="difflineplus">+        matchTermStatus = m_deferredToServerFilterList-&gt;</span>
<a href="#l80.499"></a><span id="l80.499" class="difflineplus">+          ApplyFiltersToHdr(nsMsgFilterType::InboxRule, msgHdr, downloadFolder,</span>
<a href="#l80.500"></a><span id="l80.500" class="difflineplus">+                            m_mailDB, headers, headersSize, this, msgWindow);</span>
<a href="#l80.501"></a><span id="l80.501">       }</span>
<a href="#l80.502"></a><span id="l80.502">     }</span>
<a href="#l80.503"></a><span id="l80.503">   }</span>
<a href="#l80.504"></a><span id="l80.504">   if (pMoved)</span>
<a href="#l80.505"></a><span id="l80.505">     *pMoved = m_msgMovedByFilter;</span>
<a href="#l80.506"></a><span id="l80.506"> }</span>
<a href="#l80.507"></a><span id="l80.507"> </span>
<a href="#l80.508"></a><span id="l80.508"> NS_IMETHODIMP nsParseNewMailState::ApplyFilterHit(nsIMsgFilter *filter, nsIMsgWindow *msgWindow, bool *applyMore)</span>
<a href="#l80.509"></a><span id="l80.509" class="difflineat">@@ -2037,17 +2060,17 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l80.510"></a><span id="l80.510">           nsCOMPtr&lt;nsIRDFResource&gt; res;</span>
<a href="#l80.511"></a><span id="l80.511">           err = rdf-&gt;GetResource(actionTargetFolderUri, getter_AddRefs(res));</span>
<a href="#l80.512"></a><span id="l80.512">           if (NS_FAILED(err))</span>
<a href="#l80.513"></a><span id="l80.513">             return err;</span>
<a href="#l80.514"></a><span id="l80.514"> </span>
<a href="#l80.515"></a><span id="l80.515">           nsCOMPtr&lt;nsIMsgFolder&gt; destIFolder(do_QueryInterface(res, &amp;err));</span>
<a href="#l80.516"></a><span id="l80.516">           if (NS_FAILED(err))</span>
<a href="#l80.517"></a><span id="l80.517">             return err;</span>
<a href="#l80.518"></a><span id="l80.518" class="difflineminus">-</span>
<a href="#l80.519"></a><span id="l80.519" class="difflineplus">+          bool msgMoved = false;</span>
<a href="#l80.520"></a><span id="l80.520">           // if we're moving to an imap folder, or this message has already </span>
<a href="#l80.521"></a><span id="l80.521">           // has a pending copy action, use the imap coalescer so that</span>
<a href="#l80.522"></a><span id="l80.522">           // we won't truncate the inbox before the copy fires.</span>
<a href="#l80.523"></a><span id="l80.523">           if (m_msgCopiedByFilter ||</span>
<a href="#l80.524"></a><span id="l80.524">               StringBeginsWith(actionTargetFolderUri, NS_LITERAL_CSTRING(&quot;imap:&quot;)))</span>
<a href="#l80.525"></a><span id="l80.525">           {</span>
<a href="#l80.526"></a><span id="l80.526">             if (!m_moveCoalescer)</span>
<a href="#l80.527"></a><span id="l80.527">               m_moveCoalescer = new nsImapMoveCoalescer(m_downloadFolder, m_msgWindow);</span>
<a href="#l80.528"></a><span id="l80.528" class="difflineat">@@ -2057,23 +2080,28 @@ NS_IMETHODIMP nsParseNewMailState::Apply</span>
<a href="#l80.529"></a><span id="l80.529">             m_moveCoalescer-&gt;AddMove(destIFolder , msgKey);</span>
<a href="#l80.530"></a><span id="l80.530">             if (loggingEnabled)</span>
<a href="#l80.531"></a><span id="l80.531">               (void)filter-&gt;LogRuleHit(filterAction, msgHdr);</span>
<a href="#l80.532"></a><span id="l80.532">             err = NS_OK;</span>
<a href="#l80.533"></a><span id="l80.533">             msgIsNew = PR_FALSE;</span>
<a href="#l80.534"></a><span id="l80.534">           }</span>
<a href="#l80.535"></a><span id="l80.535">           else</span>
<a href="#l80.536"></a><span id="l80.536">           {</span>
<a href="#l80.537"></a><span id="l80.537" class="difflineminus">-            err = MoveIncorporatedMessage(msgHdr, m_mailDB, destIFolder, filter, msgWindow);</span>
<a href="#l80.538"></a><span id="l80.538" class="difflineplus">+            nsCOMPtr&lt;nsIMsgPluggableStore&gt; msgStore;</span>
<a href="#l80.539"></a><span id="l80.539" class="difflineplus">+            err = m_downloadFolder-&gt;GetMsgStore(getter_AddRefs(msgStore));</span>
<a href="#l80.540"></a><span id="l80.540" class="difflineplus">+            if (NS_SUCCEEDED(err))</span>
<a href="#l80.541"></a><span id="l80.541" class="difflineplus">+              msgStore-&gt;MoveNewlyDownloadedMessage(msgHdr, destIFolder, &amp;msgMoved);</span>
<a href="#l80.542"></a><span id="l80.542" class="difflineplus">+            if (!msgMoved)</span>
<a href="#l80.543"></a><span id="l80.543" class="difflineplus">+              err = MoveIncorporatedMessage(msgHdr, m_mailDB, destIFolder,</span>
<a href="#l80.544"></a><span id="l80.544" class="difflineplus">+                                            filter, msgWindow);</span>
<a href="#l80.545"></a><span id="l80.545">             m_msgMovedByFilter = NS_SUCCEEDED(err);</span>
<a href="#l80.546"></a><span id="l80.546">             if (m_msgMovedByFilter)</span>
<a href="#l80.547"></a><span id="l80.547">             {</span>
<a href="#l80.548"></a><span id="l80.548">               if (loggingEnabled)</span>
<a href="#l80.549"></a><span id="l80.549">                 (void)filter-&gt;LogRuleHit(filterAction, msgHdr);</span>
<a href="#l80.550"></a><span id="l80.550" class="difflineminus">-              m_mailDB-&gt;RemoveHeaderMdbRow(msgHdr);</span>
<a href="#l80.551"></a><span id="l80.551">             }</span>
<a href="#l80.552"></a><span id="l80.552">           }</span>
<a href="#l80.553"></a><span id="l80.553">         }</span>
<a href="#l80.554"></a><span id="l80.554">         *applyMore = PR_FALSE;</span>
<a href="#l80.555"></a><span id="l80.555">         break;</span>
<a href="#l80.556"></a><span id="l80.556">         case nsMsgFilterAction::CopyToFolder:</span>
<a href="#l80.557"></a><span id="l80.557">         {</span>
<a href="#l80.558"></a><span id="l80.558">           nsCString uri;</span>
<a href="#l80.559"></a><span id="l80.559" class="difflineat">@@ -2374,39 +2402,30 @@ nsresult nsParseNewMailState::EndMsgDown</span>
<a href="#l80.560"></a><span id="l80.560">         }</span>
<a href="#l80.561"></a><span id="l80.561">       }</span>
<a href="#l80.562"></a><span id="l80.562">     }</span>
<a href="#l80.563"></a><span id="l80.563">   }</span>
<a href="#l80.564"></a><span id="l80.564">   m_filterTargetFolders.Clear();</span>
<a href="#l80.565"></a><span id="l80.565">   return rv;</span>
<a href="#l80.566"></a><span id="l80.566"> }</span>
<a href="#l80.567"></a><span id="l80.567"> </span>
<a href="#l80.568"></a><span id="l80.568" class="difflineminus">-nsresult nsParseNewMailState::AppendMsgFromFile(nsIInputStream *fileStream,</span>
<a href="#l80.569"></a><span id="l80.569" class="difflineminus">-                                                PRUint32 offset, PRUint32 length,</span>
<a href="#l80.570"></a><span id="l80.570" class="difflineminus">-                                                nsILocalFile *destFile)</span>
<a href="#l80.571"></a><span id="l80.571" class="difflineplus">+nsresult nsParseNewMailState::AppendMsgFromStream(nsIInputStream *fileStream,</span>
<a href="#l80.572"></a><span id="l80.572" class="difflineplus">+                                                  nsIMsgDBHdr *aHdr,</span>
<a href="#l80.573"></a><span id="l80.573" class="difflineplus">+                                                  PRUint32 length,</span>
<a href="#l80.574"></a><span id="l80.574" class="difflineplus">+                                                  nsIMsgFolder *destFolder)</span>
<a href="#l80.575"></a><span id="l80.575"> {</span>
<a href="#l80.576"></a><span id="l80.576">   nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(fileStream);</span>
<a href="#l80.577"></a><span id="l80.577" class="difflineminus">-  seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, offset);</span>
<a href="#l80.578"></a><span id="l80.578" class="difflineminus">-</span>
<a href="#l80.579"></a><span id="l80.579" class="difflineminus">-  nsCOMPtr &lt;nsIOutputStream&gt; destFileStream;</span>
<a href="#l80.580"></a><span id="l80.580" class="difflineminus">-  MsgNewBufferedFileOutputStream(getter_AddRefs(destFileStream), destFile, PR_RDWR | PR_CREATE_FILE, 00600);</span>
<a href="#l80.581"></a><span id="l80.581" class="difflineminus">-</span>
<a href="#l80.582"></a><span id="l80.582" class="difflineminus">-  if (!destFileStream)</span>
<a href="#l80.583"></a><span id="l80.583" class="difflineminus">-  {</span>
<a href="#l80.584"></a><span id="l80.584" class="difflineminus">-#ifdef DEBUG_bienvenu</span>
<a href="#l80.585"></a><span id="l80.585" class="difflineminus">-    NS_ASSERTION(PR_FALSE, &quot;out of memory&quot;);</span>
<a href="#l80.586"></a><span id="l80.586" class="difflineminus">-#endif</span>
<a href="#l80.587"></a><span id="l80.587" class="difflineminus">-    return  NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l80.588"></a><span id="l80.588" class="difflineminus">-  }</span>
<a href="#l80.589"></a><span id="l80.589" class="difflineminus">-</span>
<a href="#l80.590"></a><span id="l80.590" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableDestStream = do_QueryInterface(destFileStream);</span>
<a href="#l80.591"></a><span id="l80.591" class="difflineminus">-  seekableDestStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l80.592"></a><span id="l80.592" class="difflineminus">-  PRInt64 filePos;</span>
<a href="#l80.593"></a><span id="l80.593" class="difflineminus">-  seekableDestStream-&gt;Tell(&amp;filePos);</span>
<a href="#l80.594"></a><span id="l80.594" class="difflineminus">-  PRUint32 newMsgPos = filePos;</span>
<a href="#l80.595"></a><span id="l80.595" class="difflineplus">+  nsCOMPtr&lt;nsIMsgPluggableStore&gt; store;</span>
<a href="#l80.596"></a><span id="l80.596" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; destOutputStream;</span>
<a href="#l80.597"></a><span id="l80.597" class="difflineplus">+  nsresult rv = destFolder-&gt;GetMsgStore(getter_AddRefs(store));</span>
<a href="#l80.598"></a><span id="l80.598" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l80.599"></a><span id="l80.599" class="difflineplus">+  bool reusable;</span>
<a href="#l80.600"></a><span id="l80.600" class="difflineplus">+  rv = store-&gt;GetNewMsgOutputStream(destFolder, &amp;aHdr, &amp;reusable,</span>
<a href="#l80.601"></a><span id="l80.601" class="difflineplus">+                                    getter_AddRefs(destOutputStream));</span>
<a href="#l80.602"></a><span id="l80.602" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l80.603"></a><span id="l80.603"> </span>
<a href="#l80.604"></a><span id="l80.604">   if (!m_ibuffer)</span>
<a href="#l80.605"></a><span id="l80.605">     m_ibuffer_size = 10240;</span>
<a href="#l80.606"></a><span id="l80.606">   m_ibuffer_fp = 0;</span>
<a href="#l80.607"></a><span id="l80.607"> </span>
<a href="#l80.608"></a><span id="l80.608">   while (!m_ibuffer &amp;&amp; (m_ibuffer_size &gt;= 512))</span>
<a href="#l80.609"></a><span id="l80.609">   {</span>
<a href="#l80.610"></a><span id="l80.610">     m_ibuffer = (char *) PR_Malloc(m_ibuffer_size);</span>
<a href="#l80.611"></a><span id="l80.611" class="difflineat">@@ -2417,42 +2436,42 @@ nsresult nsParseNewMailState::AppendMsgF</span>
<a href="#l80.612"></a><span id="l80.612">   while ((length &gt; 0) &amp;&amp; m_ibuffer)</span>
<a href="#l80.613"></a><span id="l80.613">   {</span>
<a href="#l80.614"></a><span id="l80.614">     PRUint32 nRead;</span>
<a href="#l80.615"></a><span id="l80.615">     fileStream-&gt;Read (m_ibuffer, length &gt; m_ibuffer_size ? m_ibuffer_size  : length, &amp;nRead);</span>
<a href="#l80.616"></a><span id="l80.616">     if (nRead == 0)</span>
<a href="#l80.617"></a><span id="l80.617">       break;</span>
<a href="#l80.618"></a><span id="l80.618"> </span>
<a href="#l80.619"></a><span id="l80.619">     PRUint32 bytesWritten;</span>
<a href="#l80.620"></a><span id="l80.620" class="difflineminus">-    // we must monitor the number of bytes actually written to the file. (mscott)</span>
<a href="#l80.621"></a><span id="l80.621" class="difflineminus">-    destFileStream-&gt;Write(m_ibuffer, nRead, &amp;bytesWritten);</span>
<a href="#l80.622"></a><span id="l80.622" class="difflineplus">+    // Check the number of bytes actually written to the stream.</span>
<a href="#l80.623"></a><span id="l80.623" class="difflineplus">+    destOutputStream-&gt;Write(m_ibuffer, nRead, &amp;bytesWritten);</span>
<a href="#l80.624"></a><span id="l80.624">     if (bytesWritten != nRead)</span>
<a href="#l80.625"></a><span id="l80.625">     {</span>
<a href="#l80.626"></a><span id="l80.626" class="difflineminus">-      destFileStream-&gt;Close();</span>
<a href="#l80.627"></a><span id="l80.627" class="difflineminus">-</span>
<a href="#l80.628"></a><span id="l80.628" class="difflineminus">-      // truncate  destination file in case message was partially written</span>
<a href="#l80.629"></a><span id="l80.629" class="difflineminus">-      // ### how to do this with a stream?</span>
<a href="#l80.630"></a><span id="l80.630" class="difflineminus">-      destFile-&gt;SetFileSize(newMsgPos);</span>
<a href="#l80.631"></a><span id="l80.631" class="difflineplus">+      destOutputStream-&gt;Close();</span>
<a href="#l80.632"></a><span id="l80.632">       return NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l80.633"></a><span id="l80.633">     }</span>
<a href="#l80.634"></a><span id="l80.634"> </span>
<a href="#l80.635"></a><span id="l80.635">     length -= nRead;</span>
<a href="#l80.636"></a><span id="l80.636">   }</span>
<a href="#l80.637"></a><span id="l80.637"> </span>
<a href="#l80.638"></a><span id="l80.638">   NS_ASSERTION(length == 0, &quot;didn't read all of original message in filter move&quot;);</span>
<a href="#l80.639"></a><span id="l80.639" class="difflineminus">-  return NS_OK;</span>
<a href="#l80.640"></a><span id="l80.640" class="difflineplus">+</span>
<a href="#l80.641"></a><span id="l80.641" class="difflineplus">+  // non-reusable streams will get closed by the store.</span>
<a href="#l80.642"></a><span id="l80.642" class="difflineplus">+  if (reusable)</span>
<a href="#l80.643"></a><span id="l80.643" class="difflineplus">+    destOutputStream-&gt;Close();</span>
<a href="#l80.644"></a><span id="l80.644" class="difflineplus">+  return store-&gt;FinishNewMessage(destOutputStream, aHdr);</span>
<a href="#l80.645"></a><span id="l80.645"> }</span>
<a href="#l80.646"></a><span id="l80.646"> </span>
<a href="#l80.647"></a><span id="l80.647"> nsresult nsParseNewMailState::MoveIncorporatedMessage(nsIMsgDBHdr *mailHdr,</span>
<a href="#l80.648"></a><span id="l80.648">                                                       nsIMsgDatabase *sourceDB,</span>
<a href="#l80.649"></a><span id="l80.649">                                                       nsIMsgFolder *destIFolder,</span>
<a href="#l80.650"></a><span id="l80.650">                                                       nsIMsgFilter *filter,</span>
<a href="#l80.651"></a><span id="l80.651">                                                       nsIMsgWindow *msgWindow)</span>
<a href="#l80.652"></a><span id="l80.652"> {</span>
<a href="#l80.653"></a><span id="l80.653" class="difflineminus">-  nsresult err = 0;</span>
<a href="#l80.654"></a><span id="l80.654" class="difflineplus">+  nsresult rv = NS_OK;</span>
<a href="#l80.655"></a><span id="l80.655"> </span>
<a href="#l80.656"></a><span id="l80.656">   // check if the destination is a real folder (by checking for null parent)</span>
<a href="#l80.657"></a><span id="l80.657">   // and if it can file messages (e.g., servers or news folders can't file messages).</span>
<a href="#l80.658"></a><span id="l80.658">   // Or read only imap folders...</span>
<a href="#l80.659"></a><span id="l80.659">   bool canFileMessages = true;</span>
<a href="#l80.660"></a><span id="l80.660">   nsCOMPtr&lt;nsIMsgFolder&gt; parentFolder;</span>
<a href="#l80.661"></a><span id="l80.661">   destIFolder-&gt;GetParent(getter_AddRefs(parentFolder));</span>
<a href="#l80.662"></a><span id="l80.662">   if (parentFolder)</span>
<a href="#l80.663"></a><span id="l80.663" class="difflineat">@@ -2473,63 +2492,56 @@ nsresult nsParseNewMailState::MoveIncorp</span>
<a href="#l80.664"></a><span id="l80.664">   nsCOMPtr &lt;nsIMsgLocalMailFolder&gt; destLocalFolder = do_QueryInterface(destIFolder);</span>
<a href="#l80.665"></a><span id="l80.665">   if (destLocalFolder)</span>
<a href="#l80.666"></a><span id="l80.666">   {</span>
<a href="#l80.667"></a><span id="l80.667">     bool destFolderTooBig;</span>
<a href="#l80.668"></a><span id="l80.668">     destLocalFolder-&gt;WarnIfLocalFileTooBig(msgWindow, &amp;destFolderTooBig);</span>
<a href="#l80.669"></a><span id="l80.669">     if (destFolderTooBig)</span>
<a href="#l80.670"></a><span id="l80.670">       return NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l80.671"></a><span id="l80.671">   }</span>
<a href="#l80.672"></a><span id="l80.672" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt; destFolderFile;</span>
<a href="#l80.673"></a><span id="l80.673" class="difflineminus">-  destIFolder-&gt;GetFilePath(getter_AddRefs(destFolderFile));</span>
<a href="#l80.674"></a><span id="l80.674" class="difflineminus">-</span>
<a href="#l80.675"></a><span id="l80.675" class="difflineminus">-  if (NS_FAILED(err))</span>
<a href="#l80.676"></a><span id="l80.676" class="difflineminus">-    return err;</span>
<a href="#l80.677"></a><span id="l80.677" class="difflineplus">+  nsCOMPtr&lt;nsISupports&gt; myISupports =</span>
<a href="#l80.678"></a><span id="l80.678" class="difflineplus">+    do_QueryInterface(static_cast&lt;nsIMsgParseMailMsgState*&gt;(this));</span>
<a href="#l80.679"></a><span id="l80.679"> </span>
<a href="#l80.680"></a><span id="l80.680" class="difflineminus">-  nsCOMPtr &lt;nsISupports&gt; myISupports = do_QueryInterface(static_cast&lt;nsIMsgParseMailMsgState*&gt;(this));</span>
<a href="#l80.681"></a><span id="l80.681" class="difflineminus">-</span>
<a href="#l80.682"></a><span id="l80.682" class="difflineminus">-  //  NS_RELEASE(myThis);</span>
<a href="#l80.683"></a><span id="l80.683">   // Make sure no one else is writing into this folder</span>
<a href="#l80.684"></a><span id="l80.684" class="difflineminus">-  if (destIFolder &amp;&amp; (err = destIFolder-&gt;AcquireSemaphore (myISupports)) != 0)</span>
<a href="#l80.685"></a><span id="l80.685" class="difflineplus">+  if (destIFolder &amp;&amp;</span>
<a href="#l80.686"></a><span id="l80.686" class="difflineplus">+      NS_FAILED(rv = destIFolder-&gt;AcquireSemaphore (myISupports)))</span>
<a href="#l80.687"></a><span id="l80.687">   {</span>
<a href="#l80.688"></a><span id="l80.688">     destIFolder-&gt;ThrowAlertMsg(&quot;filterFolderDeniedLocked&quot;, msgWindow);</span>
<a href="#l80.689"></a><span id="l80.689" class="difflineminus">-    return err;</span>
<a href="#l80.690"></a><span id="l80.690" class="difflineplus">+    return rv;</span>
<a href="#l80.691"></a><span id="l80.691">   }</span>
<a href="#l80.692"></a><span id="l80.692" class="difflineminus">-</span>
<a href="#l80.693"></a><span id="l80.693" class="difflineminus">-  NS_ASSERTION(m_inboxFileStream != 0, &quot;no input file stream&quot;);</span>
<a href="#l80.694"></a><span id="l80.694" class="difflineminus">-  if (m_inboxFileStream == 0)</span>
<a href="#l80.695"></a><span id="l80.695" class="difflineplus">+  nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l80.696"></a><span id="l80.696" class="difflineplus">+  bool reusable;</span>
<a href="#l80.697"></a><span id="l80.697" class="difflineplus">+  rv = m_downloadFolder-&gt;GetMsgInputStream(mailHdr, &amp;reusable, getter_AddRefs(inputStream));</span>
<a href="#l80.698"></a><span id="l80.698" class="difflineplus">+  if (!inputStream)</span>
<a href="#l80.699"></a><span id="l80.699">   {</span>
<a href="#l80.700"></a><span id="l80.700" class="difflineminus">-#ifdef DEBUG_bienvenu</span>
<a href="#l80.701"></a><span id="l80.701" class="difflineminus">-    NS_ASSERTION(PR_FALSE, &quot;couldn't get source file in move filter&quot;);</span>
<a href="#l80.702"></a><span id="l80.702" class="difflineminus">-#endif</span>
<a href="#l80.703"></a><span id="l80.703" class="difflineplus">+    NS_ERROR(&quot;couldn't get source msg input stream in move filter&quot;);</span>
<a href="#l80.704"></a><span id="l80.704">     if (destIFolder)</span>
<a href="#l80.705"></a><span id="l80.705">       destIFolder-&gt;ReleaseSemaphore (myISupports);</span>
<a href="#l80.706"></a><span id="l80.706"> </span>
<a href="#l80.707"></a><span id="l80.707">     return NS_MSG_FOLDER_UNREADABLE;  // ### dmb</span>
<a href="#l80.708"></a><span id="l80.708">   }</span>
<a href="#l80.709"></a><span id="l80.709" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(m_inboxFileStream);</span>
<a href="#l80.710"></a><span id="l80.710" class="difflineminus">-  seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, m_curHdrOffset);</span>
<a href="#l80.711"></a><span id="l80.711" class="difflineminus">-  PRInt64 destFolderSize;</span>
<a href="#l80.712"></a><span id="l80.712" class="difflineminus">-  destFolderFile-&gt;GetFileSize(&amp;destFolderSize);</span>
<a href="#l80.713"></a><span id="l80.713" class="difflineminus">-  PRUint32 newMsgPos = destFolderSize;</span>
<a href="#l80.714"></a><span id="l80.714"> </span>
<a href="#l80.715"></a><span id="l80.715">   nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(destIFolder);</span>
<a href="#l80.716"></a><span id="l80.716">   nsCOMPtr&lt;nsIMsgDatabase&gt; destMailDB;</span>
<a href="#l80.717"></a><span id="l80.717"> </span>
<a href="#l80.718"></a><span id="l80.718">   if (!localFolder)</span>
<a href="#l80.719"></a><span id="l80.719">     return NS_MSG_POP_FILTER_TARGET_ERROR;</span>
<a href="#l80.720"></a><span id="l80.720"> </span>
<a href="#l80.721"></a><span id="l80.721" class="difflineminus">-  nsresult rv = localFolder-&gt;GetDatabaseWOReparse(getter_AddRefs(destMailDB));</span>
<a href="#l80.722"></a><span id="l80.722" class="difflineplus">+  rv = localFolder-&gt;GetDatabaseWOReparse(getter_AddRefs(destMailDB));</span>
<a href="#l80.723"></a><span id="l80.723">   NS_ASSERTION(destMailDB, &quot;failed to open mail db parsing folder&quot;);</span>
<a href="#l80.724"></a><span id="l80.724" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l80.725"></a><span id="l80.725">   // don't force upgrade in place - open the db here before we start writing to the</span>
<a href="#l80.726"></a><span id="l80.726">   // destination file because XP_Stat can return file size including bytes written...</span>
<a href="#l80.727"></a><span id="l80.727"> </span>
<a href="#l80.728"></a><span id="l80.728" class="difflineplus">+  destMailDB-&gt;CopyHdrFromExistingHdr(nsMsgKey_None, mailHdr, PR_TRUE,</span>
<a href="#l80.729"></a><span id="l80.729" class="difflineplus">+                                     getter_AddRefs(newHdr));</span>
<a href="#l80.730"></a><span id="l80.730">   PRUint32 messageLength;</span>
<a href="#l80.731"></a><span id="l80.731">   mailHdr-&gt;GetMessageSize(&amp;messageLength);</span>
<a href="#l80.732"></a><span id="l80.732" class="difflineminus">-  rv = AppendMsgFromFile(m_inboxFileStream, m_curHdrOffset, messageLength, destFolderFile);</span>
<a href="#l80.733"></a><span id="l80.733" class="difflineplus">+  rv = AppendMsgFromStream(inputStream, newHdr, messageLength,</span>
<a href="#l80.734"></a><span id="l80.734" class="difflineplus">+                           destIFolder);</span>
<a href="#l80.735"></a><span id="l80.735"> </span>
<a href="#l80.736"></a><span id="l80.736">   if (NS_FAILED(rv))</span>
<a href="#l80.737"></a><span id="l80.737">   {</span>
<a href="#l80.738"></a><span id="l80.738">     if (destMailDB)</span>
<a href="#l80.739"></a><span id="l80.739">       destMailDB-&gt;Close(PR_TRUE);</span>
<a href="#l80.740"></a><span id="l80.740"> </span>
<a href="#l80.741"></a><span id="l80.741">     if (destIFolder)</span>
<a href="#l80.742"></a><span id="l80.742">     {</span>
<a href="#l80.743"></a><span id="l80.743" class="difflineat">@@ -2539,72 +2551,44 @@ nsresult nsParseNewMailState::MoveIncorp</span>
<a href="#l80.744"></a><span id="l80.744">     return NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l80.745"></a><span id="l80.745">   }</span>
<a href="#l80.746"></a><span id="l80.746"> </span>
<a href="#l80.747"></a><span id="l80.747">   bool movedMsgIsNew = false;</span>
<a href="#l80.748"></a><span id="l80.748">   // if we have made it this far then the message has successfully been written to the new folder</span>
<a href="#l80.749"></a><span id="l80.749">   // now add the header to the destMailDB.</span>
<a href="#l80.750"></a><span id="l80.750">   if (NS_SUCCEEDED(rv) &amp;&amp; destMailDB)</span>
<a href="#l80.751"></a><span id="l80.751">   {</span>
<a href="#l80.752"></a><span id="l80.752" class="difflineminus">-    nsCOMPtr &lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l80.753"></a><span id="l80.753" class="difflineminus">-</span>
<a href="#l80.754"></a><span id="l80.754" class="difflineminus">-    nsresult msgErr = destMailDB-&gt;CopyHdrFromExistingHdr(newMsgPos, mailHdr, PR_FALSE, getter_AddRefs(newHdr));</span>
<a href="#l80.755"></a><span id="l80.755" class="difflineminus">-    if (NS_SUCCEEDED(msgErr) &amp;&amp; newHdr)</span>
<a href="#l80.756"></a><span id="l80.756" class="difflineminus">-    {</span>
<a href="#l80.757"></a><span id="l80.757">       PRUint32 newFlags;</span>
<a href="#l80.758"></a><span id="l80.758" class="difflineminus">-      // set new byte offset, since the offset in the old file is certainly wrong</span>
<a href="#l80.759"></a><span id="l80.759" class="difflineminus">-      newHdr-&gt;SetMessageKey (newMsgPos);</span>
<a href="#l80.760"></a><span id="l80.760">       newHdr-&gt;GetFlags(&amp;newFlags);</span>
<a href="#l80.761"></a><span id="l80.761" class="difflineplus">+    nsMsgKey msgKey;</span>
<a href="#l80.762"></a><span id="l80.762" class="difflineplus">+    newHdr-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l80.763"></a><span id="l80.763">       if (! (newFlags &amp; nsMsgMessageFlags::Read))</span>
<a href="#l80.764"></a><span id="l80.764">       {</span>
<a href="#l80.765"></a><span id="l80.765">         nsCString junkScoreStr;</span>
<a href="#l80.766"></a><span id="l80.766">         (void) newHdr-&gt;GetStringProperty(&quot;junkscore&quot;, getter_Copies(junkScoreStr));</span>
<a href="#l80.767"></a><span id="l80.767">         if (atoi(junkScoreStr.get()) == nsIJunkMailPlugin::IS_HAM_SCORE)</span>
<a href="#l80.768"></a><span id="l80.768">         {</span>
<a href="#l80.769"></a><span id="l80.769">           newHdr-&gt;OrFlags(nsMsgMessageFlags::New, &amp;newFlags);</span>
<a href="#l80.770"></a><span id="l80.770" class="difflineminus">-          destMailDB-&gt;AddToNewList(newMsgPos);</span>
<a href="#l80.771"></a><span id="l80.771" class="difflineplus">+        destMailDB-&gt;AddToNewList(msgKey);</span>
<a href="#l80.772"></a><span id="l80.772">           movedMsgIsNew = PR_TRUE;</span>
<a href="#l80.773"></a><span id="l80.773">         }</span>
<a href="#l80.774"></a><span id="l80.774">       }</span>
<a href="#l80.775"></a><span id="l80.775" class="difflineminus">-      destMailDB-&gt;AddNewHdrToDB(newHdr, PR_TRUE);</span>
<a href="#l80.776"></a><span id="l80.776">       nsCOMPtr&lt;nsIMsgFolderNotificationService&gt; notifier(do_GetService(NS_MSGNOTIFICATIONSERVICE_CONTRACTID));</span>
<a href="#l80.777"></a><span id="l80.777">       if (notifier)</span>
<a href="#l80.778"></a><span id="l80.778">         notifier-&gt;NotifyMsgAdded(newHdr);</span>
<a href="#l80.779"></a><span id="l80.779">       // mark the header as not yet reported classified</span>
<a href="#l80.780"></a><span id="l80.780">       destIFolder-&gt;OrProcessingFlags(</span>
<a href="#l80.781"></a><span id="l80.781" class="difflineminus">-        newMsgPos, nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l80.782"></a><span id="l80.782" class="difflineplus">+      msgKey, nsMsgProcessingFlags::NotReportedClassified);</span>
<a href="#l80.783"></a><span id="l80.783">       m_msgToForwardOrReply = newHdr;</span>
<a href="#l80.784"></a><span id="l80.784">     }</span>
<a href="#l80.785"></a><span id="l80.785" class="difflineminus">-  }</span>
<a href="#l80.786"></a><span id="l80.786" class="difflineminus">-  else</span>
<a href="#l80.787"></a><span id="l80.787" class="difflineminus">-  {</span>
<a href="#l80.788"></a><span id="l80.788" class="difflineminus">-    if (destMailDB)</span>
<a href="#l80.789"></a><span id="l80.789">       destMailDB = nsnull;</span>
<a href="#l80.790"></a><span id="l80.790" class="difflineminus">-  }</span>
<a href="#l80.791"></a><span id="l80.791">   if (movedMsgIsNew)</span>
<a href="#l80.792"></a><span id="l80.792">     destIFolder-&gt;SetHasNewMessages(PR_TRUE);</span>
<a href="#l80.793"></a><span id="l80.793">   if (m_filterTargetFolders.IndexOf(destIFolder) == -1)</span>
<a href="#l80.794"></a><span id="l80.794">     m_filterTargetFolders.AppendObject(destIFolder);</span>
<a href="#l80.795"></a><span id="l80.795" class="difflineminus">-  m_inboxFileStream-&gt;Close();</span>
<a href="#l80.796"></a><span id="l80.796" class="difflineminus">-</span>
<a href="#l80.797"></a><span id="l80.797" class="difflineminus">-  nsresult truncRet = m_inboxFile-&gt;SetFileSize(m_curHdrOffset);</span>
<a href="#l80.798"></a><span id="l80.798" class="difflineminus">-  NS_ASSERTION(NS_SUCCEEDED(truncRet), &quot;unable to truncate file&quot;);</span>
<a href="#l80.799"></a><span id="l80.799" class="difflineminus">-  if (NS_FAILED(truncRet))</span>
<a href="#l80.800"></a><span id="l80.800" class="difflineminus">-   destIFolder-&gt;ThrowAlertMsg(&quot;filterFolderTruncateFailed&quot;, msgWindow);</span>
<a href="#l80.801"></a><span id="l80.801" class="difflineminus">-  else</span>
<a href="#l80.802"></a><span id="l80.802" class="difflineminus">-    // tell parser that we've truncated the Inbox</span>
<a href="#l80.803"></a><span id="l80.803" class="difflineminus">-    nsParseMailMessageState::Init(m_curHdrOffset);</span>
<a href="#l80.804"></a><span id="l80.804" class="difflineminus">-</span>
<a href="#l80.805"></a><span id="l80.805" class="difflineminus">-  MsgReopenFileStream(m_inboxFile, m_inboxFileStream);</span>
<a href="#l80.806"></a><span id="l80.806" class="difflineminus">-</span>
<a href="#l80.807"></a><span id="l80.807" class="difflineminus">-  seekableStream = do_QueryInterface(m_inboxFileStream);</span>
<a href="#l80.808"></a><span id="l80.808" class="difflineminus">-  PRInt64 inboxFileSize;</span>
<a href="#l80.809"></a><span id="l80.809" class="difflineminus">-  m_inboxFile-&gt;GetFileSize(&amp;inboxFileSize);</span>
<a href="#l80.810"></a><span id="l80.810" class="difflineminus">- if (seekableStream)</span>
<a href="#l80.811"></a><span id="l80.811" class="difflineminus">-    seekableStream-&gt;Seek(nsISeekableStream::NS_SEEK_SET, inboxFileSize);</span>
<a href="#l80.812"></a><span id="l80.812"> </span>
<a href="#l80.813"></a><span id="l80.813">   if (destIFolder)</span>
<a href="#l80.814"></a><span id="l80.814">     destIFolder-&gt;ReleaseSemaphore (myISupports);</span>
<a href="#l80.815"></a><span id="l80.815"> </span>
<a href="#l80.816"></a><span id="l80.816"> </span>
<a href="#l80.817"></a><span id="l80.817">   (void) localFolder-&gt;RefreshSizeOnDisk();</span>
<a href="#l80.818"></a><span id="l80.818">   if (destIFolder)</span>
<a href="#l80.819"></a><span id="l80.819">     destIFolder-&gt;SetFlag(nsMsgFolderFlags::GotNew);</span>
<a href="#l80.820"></a><span id="l80.820" class="difflineat">@@ -2613,11 +2597,11 @@ nsresult nsParseNewMailState::MoveIncorp</span>
<a href="#l80.821"></a><span id="l80.821">   {</span>
<a href="#l80.822"></a><span id="l80.822">     // update the folder size so we won't reparse.</span>
<a href="#l80.823"></a><span id="l80.823">     UpdateDBFolderInfo(destMailDB);</span>
<a href="#l80.824"></a><span id="l80.824">     if (destIFolder != nsnull)</span>
<a href="#l80.825"></a><span id="l80.825">       destIFolder-&gt;UpdateSummaryTotals(PR_TRUE);</span>
<a href="#l80.826"></a><span id="l80.826"> </span>
<a href="#l80.827"></a><span id="l80.827">     destMailDB-&gt;Commit(nsMsgDBCommitType::kLargeCommit);</span>
<a href="#l80.828"></a><span id="l80.828">   }</span>
<a href="#l80.829"></a><span id="l80.829" class="difflineminus">-  return err;</span>
<a href="#l80.830"></a><span id="l80.830" class="difflineplus">+  return rv;</span>
<a href="#l80.831"></a><span id="l80.831"> }</span>
<a href="#l80.832"></a><span id="l80.832"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l81.1"></a><span id="l81.1" class="difflineminus">--- a/mailnews/local/src/nsParseMailbox.h</span>
<a href="#l81.2"></a><span id="l81.2" class="difflineplus">+++ b/mailnews/local/src/nsParseMailbox.h</span>
<a href="#l81.3"></a><span id="l81.3" class="difflineat">@@ -100,17 +100,17 @@ public:</span>
<a href="#l81.4"></a><span id="l81.4"> </span>
<a href="#l81.5"></a><span id="l81.5">   nsCOMPtr&lt;nsIMsgHeaderParser&gt; m_HeaderAddressParser;</span>
<a href="#l81.6"></a><span id="l81.6"> </span>
<a href="#l81.7"></a><span id="l81.7">   nsCOMPtr&lt;nsIMsgDBHdr&gt; m_newMsgHdr; /* current message header we're building */</span>
<a href="#l81.8"></a><span id="l81.8">   nsCOMPtr&lt;nsIMsgDatabase&gt;  m_mailDB;</span>
<a href="#l81.9"></a><span id="l81.9">   nsCOMPtr&lt;nsIMsgDatabase&gt; m_backupMailDB;</span>
<a href="#l81.10"></a><span id="l81.10"> </span>
<a href="#l81.11"></a><span id="l81.11">   nsMailboxParseState   m_state;</span>
<a href="#l81.12"></a><span id="l81.12" class="difflineminus">-  PRUint64              m_position;</span>
<a href="#l81.13"></a><span id="l81.13" class="difflineplus">+  PRInt64              m_position;</span>
<a href="#l81.14"></a><span id="l81.14">   PRUint64              m_envelope_pos;</span>
<a href="#l81.15"></a><span id="l81.15">   PRUint64              m_headerstartpos;</span>
<a href="#l81.16"></a><span id="l81.16"> </span>
<a href="#l81.17"></a><span id="l81.17">   nsByteArray           m_headers;</span>
<a href="#l81.18"></a><span id="l81.18"> </span>
<a href="#l81.19"></a><span id="l81.19">   nsByteArray           m_envelope;</span>
<a href="#l81.20"></a><span id="l81.20"> </span>
<a href="#l81.21"></a><span id="l81.21">   struct message_header m_message_id;</span>
<a href="#l81.22"></a><span id="l81.22" class="difflineat">@@ -169,16 +169,17 @@ inline int nsParseMailMessageState::msg_</span>
<a href="#l81.23"></a><span id="l81.23"> </span>
<a href="#l81.24"></a><span id="l81.24"> // This class is part of the mailbox parsing state machine</span>
<a href="#l81.25"></a><span id="l81.25"> class nsMsgMailboxParser : public nsIStreamListener, public nsParseMailMessageState, public nsMsgLineBuffer</span>
<a href="#l81.26"></a><span id="l81.26"> {</span>
<a href="#l81.27"></a><span id="l81.27"> public:</span>
<a href="#l81.28"></a><span id="l81.28">   nsMsgMailboxParser(nsIMsgFolder *);</span>
<a href="#l81.29"></a><span id="l81.29">   nsMsgMailboxParser();</span>
<a href="#l81.30"></a><span id="l81.30">   virtual ~nsMsgMailboxParser();</span>
<a href="#l81.31"></a><span id="l81.31" class="difflineplus">+  nsresult Init();</span>
<a href="#l81.32"></a><span id="l81.32"> </span>
<a href="#l81.33"></a><span id="l81.33">   bool    IsRunningUrl() { return m_urlInProgress;} // returns true if we are currently running a url and false otherwise...</span>
<a href="#l81.34"></a><span id="l81.34">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l81.35"></a><span id="l81.35"> </span>
<a href="#l81.36"></a><span id="l81.36">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l81.37"></a><span id="l81.37">   // we suppport the nsIStreamListener interface</span>
<a href="#l81.38"></a><span id="l81.38">   ////////////////////////////////////////////////////////////////////////////////////////</span>
<a href="#l81.39"></a><span id="l81.39">   NS_DECL_NSIREQUESTOBSERVER</span>
<a href="#l81.40"></a><span id="l81.40" class="difflineat">@@ -196,16 +197,17 @@ public:</span>
<a href="#l81.41"></a><span id="l81.41">   virtual PRInt32 HandleLine(char *line, PRUint32 line_length);</span>
<a href="#l81.42"></a><span id="l81.42"> </span>
<a href="#l81.43"></a><span id="l81.43">   void  UpdateDBFolderInfo();</span>
<a href="#l81.44"></a><span id="l81.44">   void  UpdateDBFolderInfo(nsIMsgDatabase *mailDB);</span>
<a href="#l81.45"></a><span id="l81.45">   void  UpdateStatusText (PRUint32 stringID);</span>
<a href="#l81.46"></a><span id="l81.46"> </span>
<a href="#l81.47"></a><span id="l81.47">   // Update the progress bar based on what we know.</span>
<a href="#l81.48"></a><span id="l81.48">   virtual void    UpdateProgressPercent ();</span>
<a href="#l81.49"></a><span id="l81.49" class="difflineplus">+  virtual void OnNewMessage(nsIMsgWindow *msgWindow);</span>
<a href="#l81.50"></a><span id="l81.50"> </span>
<a href="#l81.51"></a><span id="l81.51"> protected:</span>
<a href="#l81.52"></a><span id="l81.52">   nsCOMPtr&lt;nsIMsgStatusFeedback&gt; m_statusFeedback;</span>
<a href="#l81.53"></a><span id="l81.53"> </span>
<a href="#l81.54"></a><span id="l81.54">   virtual PRInt32     PublishMsgHeader(nsIMsgWindow *msgWindow);</span>
<a href="#l81.55"></a><span id="l81.55">   void                FreeBuffers();</span>
<a href="#l81.56"></a><span id="l81.56"> </span>
<a href="#l81.57"></a><span id="l81.57">   // data</span>
<a href="#l81.58"></a><span id="l81.58" class="difflineat">@@ -218,48 +220,53 @@ protected:</span>
<a href="#l81.59"></a><span id="l81.59">   PRUint32        m_graph_progress_received;</span>
<a href="#l81.60"></a><span id="l81.60">   bool            m_parsingDone;</span>
<a href="#l81.61"></a><span id="l81.61">   PRTime          m_startTime;</span>
<a href="#l81.62"></a><span id="l81.62"> private:</span>
<a href="#l81.63"></a><span id="l81.63">   // the following flag is used to determine when a url is currently being run. It is cleared on calls</span>
<a href="#l81.64"></a><span id="l81.64">   // to ::StopBinding and it is set whenever we call Load on a url</span>
<a href="#l81.65"></a><span id="l81.65">   bool      m_urlInProgress;</span>
<a href="#l81.66"></a><span id="l81.66">   nsWeakPtr m_folder;</span>
<a href="#l81.67"></a><span id="l81.67" class="difflineminus">-  void Init();</span>
<a href="#l81.68"></a><span id="l81.68">   void ReleaseFolderLock();</span>
<a href="#l81.69"></a><span id="l81.69" class="difflineplus">+  nsresult AcquireFolderLock();</span>
<a href="#l81.70"></a><span id="l81.70"> </span>
<a href="#l81.71"></a><span id="l81.71"> };</span>
<a href="#l81.72"></a><span id="l81.72"> </span>
<a href="#l81.73"></a><span id="l81.73"> class nsParseNewMailState : public nsMsgMailboxParser</span>
<a href="#l81.74"></a><span id="l81.74"> , public nsIMsgFilterHitNotify</span>
<a href="#l81.75"></a><span id="l81.75"> {</span>
<a href="#l81.76"></a><span id="l81.76"> public:</span>
<a href="#l81.77"></a><span id="l81.77">   nsParseNewMailState();</span>
<a href="#l81.78"></a><span id="l81.78">   virtual ~nsParseNewMailState();</span>
<a href="#l81.79"></a><span id="l81.79">   NS_DECL_ISUPPORTS_INHERITED</span>
<a href="#l81.80"></a><span id="l81.80" class="difflineplus">+</span>
<a href="#l81.81"></a><span id="l81.81" class="difflineplus">+  NS_IMETHOD FinishHeader();</span>
<a href="#l81.82"></a><span id="l81.82" class="difflineplus">+</span>
<a href="#l81.83"></a><span id="l81.83">   nsresult Init(nsIMsgFolder *rootFolder, nsIMsgFolder *downloadFolder,</span>
<a href="#l81.84"></a><span id="l81.84" class="difflineminus">-                nsIInputStream *inboxFileStream, nsIMsgWindow *aMsgWindow);</span>
<a href="#l81.85"></a><span id="l81.85" class="difflineplus">+                nsIMsgWindow *aMsgWindow, nsIMsgDBHdr *aHdr,</span>
<a href="#l81.86"></a><span id="l81.86" class="difflineplus">+                nsIOutputStream *aOutputStream);</span>
<a href="#l81.87"></a><span id="l81.87"> </span>
<a href="#l81.88"></a><span id="l81.88">   virtual void  DoneParsingFolder(nsresult status);</span>
<a href="#l81.89"></a><span id="l81.89"> </span>
<a href="#l81.90"></a><span id="l81.90">   void DisableFilters() {m_disableFilters = PR_TRUE;}</span>
<a href="#l81.91"></a><span id="l81.91"> </span>
<a href="#l81.92"></a><span id="l81.92">   NS_DECL_NSIMSGFILTERHITNOTIFY</span>
<a href="#l81.93"></a><span id="l81.93"> </span>
<a href="#l81.94"></a><span id="l81.94">   nsOutputFileStream *GetLogFile();</span>
<a href="#l81.95"></a><span id="l81.95">   virtual PRInt32 PublishMsgHeader(nsIMsgWindow *msgWindow);</span>
<a href="#l81.96"></a><span id="l81.96">   void            GetMsgWindow(nsIMsgWindow **aMsgWindow);</span>
<a href="#l81.97"></a><span id="l81.97">   nsresult EndMsgDownload();</span>
<a href="#l81.98"></a><span id="l81.98"> </span>
<a href="#l81.99"></a><span id="l81.99" class="difflineminus">-  nsresult AppendMsgFromFile(nsIInputStream *fileStream, PRUint32 offset,</span>
<a href="#l81.100"></a><span id="l81.100" class="difflineminus">-                             PRUint32 length, nsILocalFile *destFile);</span>
<a href="#l81.101"></a><span id="l81.101" class="difflineplus">+  nsresult AppendMsgFromStream(nsIInputStream *fileStream, nsIMsgDBHdr *aHdr,</span>
<a href="#l81.102"></a><span id="l81.102" class="difflineplus">+                               PRUint32 length, nsIMsgFolder *destFolder);</span>
<a href="#l81.103"></a><span id="l81.103"> </span>
<a href="#l81.104"></a><span id="l81.104">   virtual void ApplyFilters(bool *pMoved, nsIMsgWindow *msgWindow,</span>
<a href="#l81.105"></a><span id="l81.105">                              PRUint32 msgOffset);</span>
<a href="#l81.106"></a><span id="l81.106">   nsresult    ApplyForwardAndReplyFilter(nsIMsgWindow *msgWindow);</span>
<a href="#l81.107"></a><span id="l81.107" class="difflineplus">+  virtual void OnNewMessage(nsIMsgWindow *msgWindow);</span>
<a href="#l81.108"></a><span id="l81.108"> </span>
<a href="#l81.109"></a><span id="l81.109">   // this keeps track of how many messages we downloaded that</span>
<a href="#l81.110"></a><span id="l81.110">   // aren't new - e.g., marked read, or moved to an other server.</span>
<a href="#l81.111"></a><span id="l81.111">   PRInt32     m_numNotNewMessages;</span>
<a href="#l81.112"></a><span id="l81.112"> protected:</span>
<a href="#l81.113"></a><span id="l81.113">   virtual nsresult GetTrashFolder(nsIMsgFolder **pTrashFolder);</span>
<a href="#l81.114"></a><span id="l81.114">   virtual nsresult MoveIncorporatedMessage(nsIMsgDBHdr *mailHdr,</span>
<a href="#l81.115"></a><span id="l81.115">                                           nsIMsgDatabase *sourceDB,</span>
<a href="#l81.116"></a><span id="l81.116" class="difflineat">@@ -270,26 +277,24 @@ protected:</span>
<a href="#l81.117"></a><span id="l81.117">   virtual void     MarkFilteredMessageUnread(nsIMsgDBHdr *msgHdr);</span>
<a href="#l81.118"></a><span id="l81.118">   void             LogRuleHit(nsIMsgFilter *filter, nsIMsgDBHdr *msgHdr);</span>
<a href="#l81.119"></a><span id="l81.119"> </span>
<a href="#l81.120"></a><span id="l81.120">   nsCOMPtr &lt;nsIMsgFilterList&gt; m_filterList;</span>
<a href="#l81.121"></a><span id="l81.121">   nsCOMPtr &lt;nsIMsgFilterList&gt; m_deferredToServerFilterList;</span>
<a href="#l81.122"></a><span id="l81.122">   nsCOMPtr &lt;nsIMsgFolder&gt; m_rootFolder;</span>
<a href="#l81.123"></a><span id="l81.123">   nsCOMPtr &lt;nsIMsgWindow&gt; m_msgWindow;</span>
<a href="#l81.124"></a><span id="l81.124">   nsCOMPtr &lt;nsIMsgFolder&gt; m_downloadFolder;</span>
<a href="#l81.125"></a><span id="l81.125" class="difflineplus">+  nsCOMPtr&lt;nsIOutputStream&gt; m_outputStream;</span>
<a href="#l81.126"></a><span id="l81.126">   nsCOMArray &lt;nsIMsgFolder&gt; m_filterTargetFolders;</span>
<a href="#l81.127"></a><span id="l81.127"> </span>
<a href="#l81.128"></a><span id="l81.128">   nsRefPtr&lt;nsImapMoveCoalescer&gt; m_moveCoalescer;</span>
<a href="#l81.129"></a><span id="l81.129"> </span>
<a href="#l81.130"></a><span id="l81.130">   bool          m_msgMovedByFilter;</span>
<a href="#l81.131"></a><span id="l81.131">   bool          m_msgCopiedByFilter;</span>
<a href="#l81.132"></a><span id="l81.132" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt;  m_inboxFileStream;</span>
<a href="#l81.133"></a><span id="l81.133" class="difflineminus">-  nsCOMPtr &lt;nsILocalFile&gt;    m_inboxFile;</span>
<a href="#l81.134"></a><span id="l81.134">   bool          m_disableFilters;</span>
<a href="#l81.135"></a><span id="l81.135" class="difflineminus">-  bool          m_downloadingToTempFile;</span>
<a href="#l81.136"></a><span id="l81.136">   PRUint32      m_ibuffer_fp;</span>
<a href="#l81.137"></a><span id="l81.137">   char          *m_ibuffer;</span>
<a href="#l81.138"></a><span id="l81.138">   PRUint32      m_ibuffer_size;</span>
<a href="#l81.139"></a><span id="l81.139">   // used for applying move filters, because in the case of using a temporary</span>
<a href="#l81.140"></a><span id="l81.140">   // download file, the offset/key in the msg hdr is not right.</span>
<a href="#l81.141"></a><span id="l81.141">   PRUint64      m_curHdrOffset;</span>
<a href="#l81.142"></a><span id="l81.142"> </span>
<a href="#l81.143"></a><span id="l81.143">   // we have to apply the reply/forward filters in a second pass, after</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l82.1"></a><span id="l82.1" class="difflineminus">--- a/mailnews/local/src/nsPop3IncomingServer.cpp</span>
<a href="#l82.2"></a><span id="l82.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3IncomingServer.cpp</span>
<a href="#l82.3"></a><span id="l82.3" class="difflineat">@@ -472,25 +472,19 @@ nsPop3IncomingServer::SetFlagsOnDefaultM</span>
<a href="#l82.4"></a><span id="l82.4">                                           nsMsgFolderFlags::Trash |</span>
<a href="#l82.5"></a><span id="l82.5">                                           nsMsgFolderFlags::Junk);</span>
<a href="#l82.6"></a><span id="l82.6">   return NS_OK;</span>
<a href="#l82.7"></a><span id="l82.7"> }</span>
<a href="#l82.8"></a><span id="l82.8"> </span>
<a href="#l82.9"></a><span id="l82.9"> </span>
<a href="#l82.10"></a><span id="l82.10"> NS_IMETHODIMP nsPop3IncomingServer::CreateDefaultMailboxes(nsIFile *aPath)</span>
<a href="#l82.11"></a><span id="l82.11"> {</span>
<a href="#l82.12"></a><span id="l82.12" class="difflineminus">-  NS_ENSURE_ARG_POINTER(aPath);</span>
<a href="#l82.13"></a><span id="l82.13" class="difflineminus">-  nsCOMPtr &lt;nsIFile&gt; path;</span>
<a href="#l82.14"></a><span id="l82.14" class="difflineminus">-  nsresult rv = aPath-&gt;Clone(getter_AddRefs(path));</span>
<a href="#l82.15"></a><span id="l82.15" class="difflineplus">+  nsresult rv = CreateLocalFolder(NS_LITERAL_STRING(&quot;Inbox&quot;));</span>
<a href="#l82.16"></a><span id="l82.16">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l82.17"></a><span id="l82.17" class="difflineminus">-</span>
<a href="#l82.18"></a><span id="l82.18" class="difflineminus">-  (void) path-&gt;AppendNative(NS_LITERAL_CSTRING(&quot;Inbox&quot;));</span>
<a href="#l82.19"></a><span id="l82.19" class="difflineminus">-  rv = CreateLocalFolder(path, NS_LITERAL_CSTRING(&quot;Inbox&quot;));</span>
<a href="#l82.20"></a><span id="l82.20" class="difflineminus">-  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l82.21"></a><span id="l82.21" class="difflineminus">-  return CreateLocalFolder(path, NS_LITERAL_CSTRING(&quot;Trash&quot;));</span>
<a href="#l82.22"></a><span id="l82.22" class="difflineplus">+  return CreateLocalFolder(NS_LITERAL_STRING(&quot;Trash&quot;));</span>
<a href="#l82.23"></a><span id="l82.23"> }</span>
<a href="#l82.24"></a><span id="l82.24"> </span>
<a href="#l82.25"></a><span id="l82.25"> // override this so we can say that deferred accounts can't have messages</span>
<a href="#l82.26"></a><span id="l82.26"> // filed to them, which will remove them as targets of all the move/copy</span>
<a href="#l82.27"></a><span id="l82.27"> // menu items.</span>
<a href="#l82.28"></a><span id="l82.28"> NS_IMETHODIMP</span>
<a href="#l82.29"></a><span id="l82.29"> nsPop3IncomingServer::GetCanFileMessagesOnServer(bool *aCanFileMessagesOnServer)</span>
<a href="#l82.30"></a><span id="l82.30"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l83.1"></a><span id="l83.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Service.cpp</span>
<a href="#l83.2"></a><span id="l83.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Service.cpp</span>
<a href="#l83.3"></a><span id="l83.3" class="difflineat">@@ -362,21 +362,16 @@ NS_IMETHODIMP nsPop3Service::NewURI(cons</span>
<a href="#l83.4"></a><span id="l83.4">     nsCOMPtr&lt;nsIMsgFolder&gt; folder = do_QueryInterface(resource, &amp;rv);</span>
<a href="#l83.5"></a><span id="l83.5">     if (NS_FAILED(rv)) return rv;</span>
<a href="#l83.6"></a><span id="l83.6">     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l83.7"></a><span id="l83.7"> </span>
<a href="#l83.8"></a><span id="l83.8">     nsLocalFolderScanState folderScanState;</span>
<a href="#l83.9"></a><span id="l83.9">     nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(folder);</span>
<a href="#l83.10"></a><span id="l83.10">     nsCOMPtr &lt;nsIMailboxUrl&gt; mailboxUrl = do_QueryInterface(aBaseURI);</span>
<a href="#l83.11"></a><span id="l83.11"> </span>
<a href="#l83.12"></a><span id="l83.12" class="difflineminus">-    nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l83.13"></a><span id="l83.13" class="difflineminus">-    rv = folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l83.14"></a><span id="l83.14" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l83.15"></a><span id="l83.15" class="difflineminus">-</span>
<a href="#l83.16"></a><span id="l83.16" class="difflineminus">-    folderScanState.m_localFile = path;</span>
<a href="#l83.17"></a><span id="l83.17">     if (mailboxUrl &amp;&amp; localFolder)</span>
<a href="#l83.18"></a><span id="l83.18">     {</span>
<a href="#l83.19"></a><span id="l83.19">       rv = localFolder-&gt;GetFolderScanState(&amp;folderScanState);</span>
<a href="#l83.20"></a><span id="l83.20">       NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l83.21"></a><span id="l83.21">       nsCOMPtr &lt;nsIMsgDBHdr&gt; msgHdr;</span>
<a href="#l83.22"></a><span id="l83.22">       nsMsgKey msgKey;</span>
<a href="#l83.23"></a><span id="l83.23">       mailboxUrl-&gt;GetMessageKey(&amp;msgKey);</span>
<a href="#l83.24"></a><span id="l83.24">       folder-&gt;GetMessageHeader(msgKey, getter_AddRefs(msgHdr));</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l84.1"></a><span id="l84.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Sink.cpp</span>
<a href="#l84.2"></a><span id="l84.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Sink.cpp</span>
<a href="#l84.3"></a><span id="l84.3" class="difflineat">@@ -87,36 +87,32 @@ nsPop3Sink::nsPop3Sink()</span>
<a href="#l84.4"></a><span id="l84.4">     m_accountUrl = nsnull;</span>
<a href="#l84.5"></a><span id="l84.5">     m_biffState = 0;</span>
<a href="#l84.6"></a><span id="l84.6">     m_numNewMessages = 0;</span>
<a href="#l84.7"></a><span id="l84.7">     m_numNewMessagesInFolder = 0;</span>
<a href="#l84.8"></a><span id="l84.8">     m_numMsgsDownloaded = 0;</span>
<a href="#l84.9"></a><span id="l84.9">     m_senderAuthed = PR_FALSE;</span>
<a href="#l84.10"></a><span id="l84.10">     m_outputBuffer = nsnull;</span>
<a href="#l84.11"></a><span id="l84.11">     m_outputBufferSize = 0;</span>
<a href="#l84.12"></a><span id="l84.12" class="difflineminus">-    m_newMailParser = nsnull;</span>
<a href="#l84.13"></a><span id="l84.13" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l84.14"></a><span id="l84.14" class="difflineminus">-    m_fileCounter = 0;</span>
<a href="#l84.15"></a><span id="l84.15" class="difflineminus">-#endif</span>
<a href="#l84.16"></a><span id="l84.16">     m_popServer = nsnull;</span>
<a href="#l84.17"></a><span id="l84.17">     m_outFileStream = nsnull;</span>
<a href="#l84.18"></a><span id="l84.18" class="difflineplus">+    m_uidlDownload = PR_FALSE;</span>
<a href="#l84.19"></a><span id="l84.19">     m_buildMessageUri = PR_FALSE;</span>
<a href="#l84.20"></a><span id="l84.20">     if (!POP3LOGMODULE)</span>
<a href="#l84.21"></a><span id="l84.21">       POP3LOGMODULE = PR_NewLogModule(&quot;POP3&quot;);</span>
<a href="#l84.22"></a><span id="l84.22"> </span>
<a href="#l84.23"></a><span id="l84.23"> }</span>
<a href="#l84.24"></a><span id="l84.24"> </span>
<a href="#l84.25"></a><span id="l84.25"> nsPop3Sink::~nsPop3Sink()</span>
<a href="#l84.26"></a><span id="l84.26"> {</span>
<a href="#l84.27"></a><span id="l84.27">     PR_Free(m_accountUrl);</span>
<a href="#l84.28"></a><span id="l84.28">     PR_Free(m_outputBuffer);</span>
<a href="#l84.29"></a><span id="l84.29">     NS_IF_RELEASE(m_popServer);</span>
<a href="#l84.30"></a><span id="l84.30">     PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;Calling ReleaseFolderLock from ~nsPop3Sink&quot;));</span>
<a href="#l84.31"></a><span id="l84.31">     ReleaseFolderLock();</span>
<a href="#l84.32"></a><span id="l84.32" class="difflineminus">-    NS_IF_RELEASE(m_newMailParser);</span>
<a href="#l84.33"></a><span id="l84.33"> }</span>
<a href="#l84.34"></a><span id="l84.34"> </span>
<a href="#l84.35"></a><span id="l84.35"> nsresult</span>
<a href="#l84.36"></a><span id="l84.36"> nsPop3Sink::SetUserAuthenticated(bool authed)</span>
<a href="#l84.37"></a><span id="l84.37"> {</span>
<a href="#l84.38"></a><span id="l84.38">   m_authed = authed;</span>
<a href="#l84.39"></a><span id="l84.39">   m_popServer-&gt;SetAuthenticated(authed);</span>
<a href="#l84.40"></a><span id="l84.40">   return NS_OK;</span>
<a href="#l84.41"></a><span id="l84.41" class="difflineat">@@ -146,17 +142,18 @@ nsPop3Sink::SetMailAccountURL(const char</span>
<a href="#l84.42"></a><span id="l84.42"> </span>
<a href="#l84.43"></a><span id="l84.43">   return NS_OK;</span>
<a href="#l84.44"></a><span id="l84.44"> }</span>
<a href="#l84.45"></a><span id="l84.45"> </span>
<a href="#l84.46"></a><span id="l84.46"> nsresult</span>
<a href="#l84.47"></a><span id="l84.47"> nsPop3Sink::GetMailAccountURL(char* *urlString)</span>
<a href="#l84.48"></a><span id="l84.48"> {</span>
<a href="#l84.49"></a><span id="l84.49">   NS_ASSERTION(urlString, &quot;null getter in getMailAccountURL&quot;);</span>
<a href="#l84.50"></a><span id="l84.50" class="difflineminus">-  if (!urlString) return NS_ERROR_NULL_POINTER;</span>
<a href="#l84.51"></a><span id="l84.51" class="difflineplus">+  if (!urlString)</span>
<a href="#l84.52"></a><span id="l84.52" class="difflineplus">+    return NS_ERROR_NULL_POINTER;</span>
<a href="#l84.53"></a><span id="l84.53"> </span>
<a href="#l84.54"></a><span id="l84.54">   *urlString = strdup(m_accountUrl);</span>
<a href="#l84.55"></a><span id="l84.55">   return NS_OK;</span>
<a href="#l84.56"></a><span id="l84.56"> }</span>
<a href="#l84.57"></a><span id="l84.57"> </span>
<a href="#l84.58"></a><span id="l84.58"> partialRecord::partialRecord() :</span>
<a href="#l84.59"></a><span id="l84.59">   m_msgDBHdr(nsnull)</span>
<a href="#l84.60"></a><span id="l84.60"> {</span>
<a href="#l84.61"></a><span id="l84.61" class="difflineat">@@ -167,45 +164,43 @@ partialRecord::~partialRecord()</span>
<a href="#l84.62"></a><span id="l84.62"> }</span>
<a href="#l84.63"></a><span id="l84.63"> </span>
<a href="#l84.64"></a><span id="l84.64"> // Walk through all the messages in this folder and look for any</span>
<a href="#l84.65"></a><span id="l84.65"> // PARTIAL messages. For each of those, dig thru the mailbox and</span>
<a href="#l84.66"></a><span id="l84.66"> // find the Account that the message belongs to. If that Account</span>
<a href="#l84.67"></a><span id="l84.67"> // matches the current Account, then look for the Uidl and save</span>
<a href="#l84.68"></a><span id="l84.68"> // this message for later processing.</span>
<a href="#l84.69"></a><span id="l84.69"> nsresult</span>
<a href="#l84.70"></a><span id="l84.70" class="difflineminus">-nsPop3Sink::FindPartialMessages(nsILocalFile *folderFile)</span>
<a href="#l84.71"></a><span id="l84.71" class="difflineplus">+nsPop3Sink::FindPartialMessages()</span>
<a href="#l84.72"></a><span id="l84.72"> {</span>
<a href="#l84.73"></a><span id="l84.73" class="difflineminus">-  nsresult rv;</span>
<a href="#l84.74"></a><span id="l84.74" class="difflineminus">-</span>
<a href="#l84.75"></a><span id="l84.75">   nsCOMPtr&lt;nsISimpleEnumerator&gt; messages;</span>
<a href="#l84.76"></a><span id="l84.76">   bool hasMore = false;</span>
<a href="#l84.77"></a><span id="l84.77">   bool isOpen = false;</span>
<a href="#l84.78"></a><span id="l84.78">   nsLocalFolderScanState folderScanState;</span>
<a href="#l84.79"></a><span id="l84.79" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDatabase&gt; db;</span>
<a href="#l84.80"></a><span id="l84.80">   nsCOMPtr&lt;nsIMsgLocalMailFolder&gt; localFolder = do_QueryInterface(m_folder);</span>
<a href="#l84.81"></a><span id="l84.81" class="difflineminus">-</span>
<a href="#l84.82"></a><span id="l84.82" class="difflineminus">-  if (!localFolder)</span>
<a href="#l84.83"></a><span id="l84.83" class="difflineplus">+  m_folder-&gt;GetMsgDatabase(getter_AddRefs(db));</span>
<a href="#l84.84"></a><span id="l84.84" class="difflineplus">+  if (!localFolder || !db)</span>
<a href="#l84.85"></a><span id="l84.85">     return NS_ERROR_FAILURE;  // we need it to grub thru the folder</span>
<a href="#l84.86"></a><span id="l84.86"> </span>
<a href="#l84.87"></a><span id="l84.87" class="difflineminus">-  rv = m_newMailParser-&gt;m_mailDB-&gt;EnumerateMessages(getter_AddRefs(messages));</span>
<a href="#l84.88"></a><span id="l84.88" class="difflineplus">+  nsresult rv = db-&gt;EnumerateMessages(getter_AddRefs(messages));</span>
<a href="#l84.89"></a><span id="l84.89">   if (messages)</span>
<a href="#l84.90"></a><span id="l84.90">     messages-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l84.91"></a><span id="l84.91">   while(hasMore &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l84.92"></a><span id="l84.92">   {</span>
<a href="#l84.93"></a><span id="l84.93">     nsCOMPtr&lt;nsISupports&gt; aSupport;</span>
<a href="#l84.94"></a><span id="l84.94">     PRUint32 flags = 0;</span>
<a href="#l84.95"></a><span id="l84.95">     rv = messages-&gt;GetNext(getter_AddRefs(aSupport));</span>
<a href="#l84.96"></a><span id="l84.96">     nsCOMPtr&lt;nsIMsgDBHdr&gt; msgDBHdr(do_QueryInterface(aSupport, &amp;rv));</span>
<a href="#l84.97"></a><span id="l84.97">     msgDBHdr-&gt;GetFlags(&amp;flags);</span>
<a href="#l84.98"></a><span id="l84.98">     if (flags &amp; nsMsgMessageFlags::Partial)</span>
<a href="#l84.99"></a><span id="l84.99">     {</span>
<a href="#l84.100"></a><span id="l84.100">       // Open the various streams we need to seek and read from the mailbox</span>
<a href="#l84.101"></a><span id="l84.101">       if (!isOpen)</span>
<a href="#l84.102"></a><span id="l84.102">       {</span>
<a href="#l84.103"></a><span id="l84.103" class="difflineminus">-        folderScanState.m_localFile = folderFile;</span>
<a href="#l84.104"></a><span id="l84.104">         rv = localFolder-&gt;GetFolderScanState(&amp;folderScanState);</span>
<a href="#l84.105"></a><span id="l84.105">         if (NS_SUCCEEDED(rv))</span>
<a href="#l84.106"></a><span id="l84.106">           isOpen = PR_TRUE;</span>
<a href="#l84.107"></a><span id="l84.107">         else</span>
<a href="#l84.108"></a><span id="l84.108">           break;</span>
<a href="#l84.109"></a><span id="l84.109">       }</span>
<a href="#l84.110"></a><span id="l84.110">       rv = localFolder-&gt;GetUidlFromFolder(&amp;folderScanState, msgDBHdr);</span>
<a href="#l84.111"></a><span id="l84.111">       if (!NS_SUCCEEDED(rv))</span>
<a href="#l84.112"></a><span id="l84.112" class="difflineat">@@ -223,17 +218,17 @@ nsPop3Sink::FindPartialMessages(nsILocal</span>
<a href="#l84.113"></a><span id="l84.113">           partialMsg-&gt;m_msgDBHdr = msgDBHdr;</span>
<a href="#l84.114"></a><span id="l84.114">           m_partialMsgsArray.AppendElement(partialMsg);</span>
<a href="#l84.115"></a><span id="l84.115">         }</span>
<a href="#l84.116"></a><span id="l84.116">       }</span>
<a href="#l84.117"></a><span id="l84.117">     }</span>
<a href="#l84.118"></a><span id="l84.118">     messages-&gt;HasMoreElements(&amp;hasMore);</span>
<a href="#l84.119"></a><span id="l84.119">   }</span>
<a href="#l84.120"></a><span id="l84.120">   if (isOpen)</span>
<a href="#l84.121"></a><span id="l84.121" class="difflineminus">-    folderScanState.m_fileStream-&gt;Close();</span>
<a href="#l84.122"></a><span id="l84.122" class="difflineplus">+    folderScanState.m_inputStream-&gt;Close();</span>
<a href="#l84.123"></a><span id="l84.123">   return rv;</span>
<a href="#l84.124"></a><span id="l84.124"> }</span>
<a href="#l84.125"></a><span id="l84.125"> </span>
<a href="#l84.126"></a><span id="l84.126"> // For all the partial messages saved by FindPartialMessages,</span>
<a href="#l84.127"></a><span id="l84.127"> // ask the protocol handler if they still exist on the server.</span>
<a href="#l84.128"></a><span id="l84.128"> // Any messages that don't exist any more are deleted from the</span>
<a href="#l84.129"></a><span id="l84.129"> // msgDB.</span>
<a href="#l84.130"></a><span id="l84.130"> void</span>
<a href="#l84.131"></a><span id="l84.131" class="difflineat">@@ -262,26 +257,24 @@ nsPop3Sink::CheckPartialMessages(nsIPop3</span>
<a href="#l84.132"></a><span id="l84.132">     if (localFolder)</span>
<a href="#l84.133"></a><span id="l84.133">       localFolder-&gt;NotifyDelete();</span>
<a href="#l84.134"></a><span id="l84.134">   }</span>
<a href="#l84.135"></a><span id="l84.135"> }</span>
<a href="#l84.136"></a><span id="l84.136"> </span>
<a href="#l84.137"></a><span id="l84.137"> nsresult</span>
<a href="#l84.138"></a><span id="l84.138"> nsPop3Sink::BeginMailDelivery(bool uidlDownload, nsIMsgWindow *aMsgWindow, bool* aBool)</span>
<a href="#l84.139"></a><span id="l84.139"> {</span>
<a href="#l84.140"></a><span id="l84.140" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l84.141"></a><span id="l84.141" class="difflineminus">-  m_fileCounter++;</span>
<a href="#l84.142"></a><span id="l84.142" class="difflineminus">-#endif</span>
<a href="#l84.143"></a><span id="l84.143" class="difflineminus">-</span>
<a href="#l84.144"></a><span id="l84.144">   nsresult rv;</span>
<a href="#l84.145"></a><span id="l84.145"> </span>
<a href="#l84.146"></a><span id="l84.146">   nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_popServer);</span>
<a href="#l84.147"></a><span id="l84.147">   if (!server)</span>
<a href="#l84.148"></a><span id="l84.148">     return NS_ERROR_UNEXPECTED;</span>
<a href="#l84.149"></a><span id="l84.149"> </span>
<a href="#l84.150"></a><span id="l84.150" class="difflineplus">+  m_window = aMsgWindow;</span>
<a href="#l84.151"></a><span id="l84.151" class="difflineplus">+</span>
<a href="#l84.152"></a><span id="l84.152">   nsCOMPtr &lt;nsIMsgAccountManager&gt; acctMgr = do_GetService(NS_MSGACCOUNTMANAGER_CONTRACTID, &amp;rv);</span>
<a href="#l84.153"></a><span id="l84.153">   nsCOMPtr &lt;nsIMsgAccount&gt; account;</span>
<a href="#l84.154"></a><span id="l84.154">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l84.155"></a><span id="l84.155">   acctMgr-&gt;FindAccountForServer(server, getter_AddRefs(account));</span>
<a href="#l84.156"></a><span id="l84.156">   if (account)</span>
<a href="#l84.157"></a><span id="l84.157">     account-&gt;GetKey(m_accountKey);</span>
<a href="#l84.158"></a><span id="l84.158"> </span>
<a href="#l84.159"></a><span id="l84.159">   bool isLocked;</span>
<a href="#l84.160"></a><span id="l84.160" class="difflineat">@@ -292,109 +285,19 @@ nsPop3Sink::BeginMailDelivery(bool uidlD</span>
<a href="#l84.161"></a><span id="l84.161">     PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;BeginMailDelivery acquiring semaphore&quot;));</span>
<a href="#l84.162"></a><span id="l84.162">     m_folder-&gt;AcquireSemaphore(supports);</span>
<a href="#l84.163"></a><span id="l84.163">   }</span>
<a href="#l84.164"></a><span id="l84.164">   else</span>
<a href="#l84.165"></a><span id="l84.165">   {</span>
<a href="#l84.166"></a><span id="l84.166">     PR_LOG(POP3LOGMODULE, PR_LOG_MAX, (&quot;BeginMailDelivery folder locked&quot;));</span>
<a href="#l84.167"></a><span id="l84.167">     return NS_MSG_FOLDER_BUSY;</span>
<a href="#l84.168"></a><span id="l84.168">   }</span>
<a href="#l84.169"></a><span id="l84.169" class="difflineminus">-</span>
<a href="#l84.170"></a><span id="l84.170" class="difflineminus">-  nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l84.171"></a><span id="l84.171" class="difflineminus">-</span>
<a href="#l84.172"></a><span id="l84.172" class="difflineminus">-  m_folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l84.173"></a><span id="l84.173" class="difflineminus">-  nsCOMPtr &lt;nsIInputStream&gt; inboxInputStream;</span>
<a href="#l84.174"></a><span id="l84.174" class="difflineminus">-</span>
<a href="#l84.175"></a><span id="l84.175" class="difflineminus">-  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l84.176"></a><span id="l84.176" class="difflineminus">-  if (pPrefBranch)</span>
<a href="#l84.177"></a><span id="l84.177" class="difflineminus">-     pPrefBranch-&gt;GetBoolPref(&quot;mailnews.downloadToTempFile&quot;, &amp;m_downloadingToTempFile);</span>
<a href="#l84.178"></a><span id="l84.178" class="difflineminus">-</span>
<a href="#l84.179"></a><span id="l84.179" class="difflineminus">-  if (m_downloadingToTempFile)</span>
<a href="#l84.180"></a><span id="l84.180" class="difflineminus">-  {</span>
<a href="#l84.181"></a><span id="l84.181" class="difflineminus">-    // need to create an nsIOFileStream from a temp file...</span>
<a href="#l84.182"></a><span id="l84.182" class="difflineminus">-    nsCOMPtr&lt;nsIFile&gt; tmpDownloadFile;</span>
<a href="#l84.183"></a><span id="l84.183" class="difflineminus">-    rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l84.184"></a><span id="l84.184" class="difflineminus">-                                         &quot;newmsg&quot;,</span>
<a href="#l84.185"></a><span id="l84.185" class="difflineminus">-                                         getter_AddRefs(tmpDownloadFile));</span>
<a href="#l84.186"></a><span id="l84.186" class="difflineminus">-</span>
<a href="#l84.187"></a><span id="l84.187" class="difflineminus">-    NS_ASSERTION(NS_SUCCEEDED(rv),&quot;writing tmp pop3 download file: failed to append filename&quot;);</span>
<a href="#l84.188"></a><span id="l84.188" class="difflineminus">-    if (NS_FAILED(rv))</span>
<a href="#l84.189"></a><span id="l84.189" class="difflineminus">-      return rv;</span>
<a href="#l84.190"></a><span id="l84.190" class="difflineminus">-</span>
<a href="#l84.191"></a><span id="l84.191" class="difflineminus">-    rv = tmpDownloadFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);  //need a unique tmp file to prevent dataloss in multiuser environment</span>
<a href="#l84.192"></a><span id="l84.192" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l84.193"></a><span id="l84.193" class="difflineminus">-</span>
<a href="#l84.194"></a><span id="l84.194" class="difflineminus">-    m_tmpDownloadFile = do_QueryInterface(tmpDownloadFile, &amp;rv);</span>
<a href="#l84.195"></a><span id="l84.195" class="difflineminus">-    if (NS_SUCCEEDED(rv))</span>
<a href="#l84.196"></a><span id="l84.196" class="difflineminus">-    {</span>
<a href="#l84.197"></a><span id="l84.197" class="difflineminus">-      rv = MsgGetFileStream(m_tmpDownloadFile, getter_AddRefs(m_outFileStream));</span>
<a href="#l84.198"></a><span id="l84.198" class="difflineminus">-      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l84.199"></a><span id="l84.199" class="difflineminus">-    }</span>
<a href="#l84.200"></a><span id="l84.200" class="difflineminus">-    rv = MsgGetFileStream(path, getter_AddRefs(m_inboxOutputStream));</span>
<a href="#l84.201"></a><span id="l84.201" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l84.202"></a><span id="l84.202" class="difflineminus">-    inboxInputStream = do_QueryInterface(m_inboxOutputStream);</span>
<a href="#l84.203"></a><span id="l84.203" class="difflineminus">-  }</span>
<a href="#l84.204"></a><span id="l84.204" class="difflineminus">-  else</span>
<a href="#l84.205"></a><span id="l84.205" class="difflineminus">-  {</span>
<a href="#l84.206"></a><span id="l84.206" class="difflineminus">-    rv = MsgGetFileStream(path, getter_AddRefs(m_outFileStream));</span>
<a href="#l84.207"></a><span id="l84.207" class="difflineminus">-    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l84.208"></a><span id="l84.208" class="difflineminus">-    inboxInputStream = do_QueryInterface(m_outFileStream);</span>
<a href="#l84.209"></a><span id="l84.209" class="difflineminus">-  }</span>
<a href="#l84.210"></a><span id="l84.210" class="difflineminus">-  // The following (!m_outFileStream etc) was added to make sure that we don't write somewhere</span>
<a href="#l84.211"></a><span id="l84.211" class="difflineminus">-  // where for some reason or another we can't write to and lose the messages</span>
<a href="#l84.212"></a><span id="l84.212" class="difflineminus">-  // See bug 62480</span>
<a href="#l84.213"></a><span id="l84.213" class="difflineminus">-  if (!m_outFileStream)</span>
<a href="#l84.214"></a><span id="l84.214" class="difflineminus">-      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l84.215"></a><span id="l84.215" class="difflineminus">-</span>
<a href="#l84.216"></a><span id="l84.216" class="difflineminus">-  nsCOMPtr &lt;nsISeekableStream&gt; seekableOutStream = do_QueryInterface(m_outFileStream);</span>
<a href="#l84.217"></a><span id="l84.217" class="difflineminus">-  seekableOutStream-&gt;Seek(nsISeekableStream::NS_SEEK_END, 0);</span>
<a href="#l84.218"></a><span id="l84.218" class="difflineminus">-</span>
<a href="#l84.219"></a><span id="l84.219" class="difflineminus">-  // create a new mail parser</span>
<a href="#l84.220"></a><span id="l84.220" class="difflineminus">-  m_newMailParser = new nsParseNewMailState;</span>
<a href="#l84.221"></a><span id="l84.221" class="difflineminus">-  NS_IF_ADDREF(m_newMailParser);</span>
<a href="#l84.222"></a><span id="l84.222" class="difflineminus">-  if (m_newMailParser == nsnull)</span>
<a href="#l84.223"></a><span id="l84.223" class="difflineminus">-    return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l84.224"></a><span id="l84.224" class="difflineminus">-</span>
<a href="#l84.225"></a><span id="l84.225" class="difflineminus">-  m_folder-&gt;GetNumNewMessages(PR_FALSE, &amp;m_numNewMessagesInFolder);</span>
<a href="#l84.226"></a><span id="l84.226" class="difflineminus">-  nsCOMPtr &lt;nsIMsgFolder&gt; serverFolder;</span>
<a href="#l84.227"></a><span id="l84.227" class="difflineminus">-  rv = GetServerFolder(getter_AddRefs(serverFolder));</span>
<a href="#l84.228"></a><span id="l84.228" class="difflineminus">-  if (NS_FAILED(rv)) return rv;</span>
<a href="#l84.229"></a><span id="l84.229" class="difflineminus">-</span>
<a href="#l84.230"></a><span id="l84.230" class="difflineminus">-  rv = m_newMailParser-&gt;Init(serverFolder, m_folder,</span>
<a href="#l84.231"></a><span id="l84.231" class="difflineminus">-                             inboxInputStream, aMsgWindow);</span>
<a href="#l84.232"></a><span id="l84.232" class="difflineminus">-  // If we failed to initialize the parser, then just don't use it!!!</span>
<a href="#l84.233"></a><span id="l84.233" class="difflineminus">-  // We can still continue without one.</span>
<a href="#l84.234"></a><span id="l84.234" class="difflineminus">-</span>
<a href="#l84.235"></a><span id="l84.235" class="difflineminus">-  if (NS_FAILED(rv))</span>
<a href="#l84.236"></a><span id="l84.236" class="difflineminus">-  {</span>
<a href="#l84.237"></a><span id="l84.237" class="difflineminus">-    NS_IF_RELEASE(m_newMailParser);</span>
<a href="#l84.238"></a><span id="l84.238" class="difflineminus">-    rv = NS_OK;</span>
<a href="#l84.239"></a><span id="l84.239" class="difflineminus">-  }</span>
<a href="#l84.240"></a><span id="l84.240" class="difflineminus">-  else</span>
<a href="#l84.241"></a><span id="l84.241" class="difflineminus">-  {</span>
<a href="#l84.242"></a><span id="l84.242" class="difflineminus">-    // Share the inbox fileStream so that moz-status-line flags can be set in the Inbox</span>
<a href="#l84.243"></a><span id="l84.243" class="difflineminus">-    m_newMailParser-&gt;SetDBFolderStream(m_outFileStream);</span>
<a href="#l84.244"></a><span id="l84.244" class="difflineminus">-    if (m_downloadingToTempFile)</span>
<a href="#l84.245"></a><span id="l84.245" class="difflineminus">-    {</span>
<a href="#l84.246"></a><span id="l84.246" class="difflineminus">-      // Tell the parser to use the offset that will be in the dest folder,</span>
<a href="#l84.247"></a><span id="l84.247" class="difflineminus">-      // not the temp folder, so that the msg hdr will start off with</span>
<a href="#l84.248"></a><span id="l84.248" class="difflineminus">-      // the correct mdb oid</span>
<a href="#l84.249"></a><span id="l84.249" class="difflineminus">-      PRInt64 fileSize;</span>
<a href="#l84.250"></a><span id="l84.250" class="difflineminus">-      path-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l84.251"></a><span id="l84.251" class="difflineminus">-      m_newMailParser-&gt;SetEnvelopePos((PRUint32) fileSize);</span>
<a href="#l84.252"></a><span id="l84.252" class="difflineminus">-    }</span>
<a href="#l84.253"></a><span id="l84.253" class="difflineminus">-  }</span>
<a href="#l84.254"></a><span id="l84.254" class="difflineminus">-  if (m_newMailParser)</span>
<a href="#l84.255"></a><span id="l84.255" class="difflineminus">-  {</span>
<a href="#l84.256"></a><span id="l84.256" class="difflineminus">-    if (uidlDownload)</span>
<a href="#l84.257"></a><span id="l84.257" class="difflineminus">-      m_newMailParser-&gt;DisableFilters();</span>
<a href="#l84.258"></a><span id="l84.258" class="difflineminus">-    else</span>
<a href="#l84.259"></a><span id="l84.259" class="difflineminus">-      FindPartialMessages(path);</span>
<a href="#l84.260"></a><span id="l84.260" class="difflineminus">-  }</span>
<a href="#l84.261"></a><span id="l84.261" class="difflineminus">-</span>
<a href="#l84.262"></a><span id="l84.262" class="difflineplus">+  m_uidlDownload = uidlDownload;</span>
<a href="#l84.263"></a><span id="l84.263" class="difflineplus">+  if (!uidlDownload)</span>
<a href="#l84.264"></a><span id="l84.264" class="difflineplus">+    FindPartialMessages();</span>
<a href="#l84.265"></a><span id="l84.265"> </span>
<a href="#l84.266"></a><span id="l84.266"> #ifdef DEBUG</span>
<a href="#l84.267"></a><span id="l84.267">   printf(&quot;Begin mail message delivery.\n&quot;);</span>
<a href="#l84.268"></a><span id="l84.268"> #endif</span>
<a href="#l84.269"></a><span id="l84.269">   nsCOMPtr&lt;nsIPop3Service&gt; pop3Service(do_GetService(NS_POP3SERVICE_CONTRACTID1, &amp;rv));</span>
<a href="#l84.270"></a><span id="l84.270">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l84.271"></a><span id="l84.271">   pop3Service-&gt;NotifyDownloadStarted(m_folder);</span>
<a href="#l84.272"></a><span id="l84.272">   if (aBool)</span>
<a href="#l84.273"></a><span id="l84.273" class="difflineat">@@ -407,17 +310,16 @@ nsPop3Sink::EndMailDelivery(nsIPop3Proto</span>
<a href="#l84.274"></a><span id="l84.274"> {</span>
<a href="#l84.275"></a><span id="l84.275">   CheckPartialMessages(protocol);</span>
<a href="#l84.276"></a><span id="l84.276"> </span>
<a href="#l84.277"></a><span id="l84.277">   if (m_newMailParser)</span>
<a href="#l84.278"></a><span id="l84.278">   {</span>
<a href="#l84.279"></a><span id="l84.279">     if (m_outFileStream)</span>
<a href="#l84.280"></a><span id="l84.280">       m_outFileStream-&gt;Flush();  // try this.</span>
<a href="#l84.281"></a><span id="l84.281">     m_newMailParser-&gt;OnStopRequest(nsnull, nsnull, NS_OK);</span>
<a href="#l84.282"></a><span id="l84.282" class="difflineminus">-    m_newMailParser-&gt;SetDBFolderStream(nsnull); // stream is going away</span>
<a href="#l84.283"></a><span id="l84.283">     m_newMailParser-&gt;EndMsgDownload();</span>
<a href="#l84.284"></a><span id="l84.284">   }</span>
<a href="#l84.285"></a><span id="l84.285">   if (m_outFileStream)</span>
<a href="#l84.286"></a><span id="l84.286">   {</span>
<a href="#l84.287"></a><span id="l84.287">     m_outFileStream-&gt;Close();</span>
<a href="#l84.288"></a><span id="l84.288">     m_outFileStream = 0;</span>
<a href="#l84.289"></a><span id="l84.289">   }</span>
<a href="#l84.290"></a><span id="l84.290">   if (m_inboxOutputStream)</span>
<a href="#l84.291"></a><span id="l84.291" class="difflineat">@@ -539,18 +441,17 @@ nsPop3Sink::ReleaseFolderLock()</span>
<a href="#l84.292"></a><span id="l84.292">   return result;</span>
<a href="#l84.293"></a><span id="l84.293"> }</span>
<a href="#l84.294"></a><span id="l84.294"> </span>
<a href="#l84.295"></a><span id="l84.295"> nsresult</span>
<a href="#l84.296"></a><span id="l84.296"> nsPop3Sink::AbortMailDelivery(nsIPop3Protocol *protocol)</span>
<a href="#l84.297"></a><span id="l84.297"> {</span>
<a href="#l84.298"></a><span id="l84.298">   CheckPartialMessages(protocol);</span>
<a href="#l84.299"></a><span id="l84.299"> </span>
<a href="#l84.300"></a><span id="l84.300" class="difflineminus">-  if (m_newMailParser)</span>
<a href="#l84.301"></a><span id="l84.301" class="difflineminus">-    m_newMailParser-&gt;SetDBFolderStream(nsnull); //stream is going away</span>
<a href="#l84.302"></a><span id="l84.302" class="difflineplus">+  // ### PS TODO - discard any new message?</span>
<a href="#l84.303"></a><span id="l84.303"> </span>
<a href="#l84.304"></a><span id="l84.304">   if (m_outFileStream)</span>
<a href="#l84.305"></a><span id="l84.305">   {</span>
<a href="#l84.306"></a><span id="l84.306">     m_outFileStream-&gt;Close();</span>
<a href="#l84.307"></a><span id="l84.307">     m_outFileStream = 0;</span>
<a href="#l84.308"></a><span id="l84.308">   }</span>
<a href="#l84.309"></a><span id="l84.309">   if (m_inboxOutputStream)</span>
<a href="#l84.310"></a><span id="l84.310">   {</span>
<a href="#l84.311"></a><span id="l84.311" class="difflineat">@@ -585,27 +486,122 @@ nsPop3Sink::IncorporateBegin(const char*</span>
<a href="#l84.312"></a><span id="l84.312">                              PRUint32 flags,</span>
<a href="#l84.313"></a><span id="l84.313">                              void** closure)</span>
<a href="#l84.314"></a><span id="l84.314"> {</span>
<a href="#l84.315"></a><span id="l84.315"> #ifdef DEBUG</span>
<a href="#l84.316"></a><span id="l84.316">     printf(&quot;Incorporate message begin:\n&quot;);</span>
<a href="#l84.317"></a><span id="l84.317">     if (uidlString)</span>
<a href="#l84.318"></a><span id="l84.318">         printf(&quot;uidl string: %s\n&quot;, uidlString);</span>
<a href="#l84.319"></a><span id="l84.319"> #endif</span>
<a href="#l84.320"></a><span id="l84.320" class="difflineplus">+  nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l84.321"></a><span id="l84.321" class="difflineplus">+</span>
<a href="#l84.322"></a><span id="l84.322" class="difflineplus">+  m_folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l84.323"></a><span id="l84.323" class="difflineplus">+</span>
<a href="#l84.324"></a><span id="l84.324" class="difflineplus">+  nsresult rv;</span>
<a href="#l84.325"></a><span id="l84.325" class="difflineplus">+  nsCOMPtr&lt;nsIPrefBranch&gt; pPrefBranch(do_GetService(NS_PREFSERVICE_CONTRACTID, &amp;rv));</span>
<a href="#l84.326"></a><span id="l84.326" class="difflineplus">+  if (pPrefBranch)</span>
<a href="#l84.327"></a><span id="l84.327" class="difflineplus">+  {</span>
<a href="#l84.328"></a><span id="l84.328" class="difflineplus">+    nsCOMPtr&lt;nsIMsgIncomingServer&gt; server;</span>
<a href="#l84.329"></a><span id="l84.329" class="difflineplus">+    m_folder-&gt;GetServer(getter_AddRefs(server));</span>
<a href="#l84.330"></a><span id="l84.330" class="difflineplus">+    nsCString plugStoreContract;</span>
<a href="#l84.331"></a><span id="l84.331" class="difflineplus">+    server-&gt;GetCharValue(&quot;storeContractID&quot;, plugStoreContract);</span>
<a href="#l84.332"></a><span id="l84.332" class="difflineplus">+    // Maildir doesn't care about quaranting, but other stores besides berkeley</span>
<a href="#l84.333"></a><span id="l84.333" class="difflineplus">+    // mailbox might. We should probably make this an attribute on the pluggable</span>
<a href="#l84.334"></a><span id="l84.334" class="difflineplus">+    // store, though.</span>
<a href="#l84.335"></a><span id="l84.335" class="difflineplus">+    if (plugStoreContract.Equals(</span>
<a href="#l84.336"></a><span id="l84.336" class="difflineplus">+          NS_LITERAL_CSTRING(&quot;@mozilla.org/msgstore/berkeleystore;1&quot;)))</span>
<a href="#l84.337"></a><span id="l84.337" class="difflineplus">+      pPrefBranch-&gt;GetBoolPref(&quot;mailnews.downloadToTempFile&quot;, &amp;m_downloadingToTempFile);</span>
<a href="#l84.338"></a><span id="l84.338" class="difflineplus">+  }</span>
<a href="#l84.339"></a><span id="l84.339" class="difflineplus">+</span>
<a href="#l84.340"></a><span id="l84.340" class="difflineplus">+  nsCOMPtr&lt;nsIMsgDBHdr&gt; newHdr;</span>
<a href="#l84.341"></a><span id="l84.341" class="difflineplus">+</span>
<a href="#l84.342"></a><span id="l84.342" class="difflineplus">+  nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_popServer);</span>
<a href="#l84.343"></a><span id="l84.343" class="difflineplus">+  if (!server)</span>
<a href="#l84.344"></a><span id="l84.344" class="difflineplus">+    return NS_ERROR_UNEXPECTED;</span>
<a href="#l84.345"></a><span id="l84.345" class="difflineplus">+</span>
<a href="#l84.346"></a><span id="l84.346" class="difflineplus">+  if (m_downloadingToTempFile)</span>
<a href="#l84.347"></a><span id="l84.347" class="difflineplus">+  {</span>
<a href="#l84.348"></a><span id="l84.348" class="difflineplus">+    // need to create an nsIOFileStream from a temp file...</span>
<a href="#l84.349"></a><span id="l84.349" class="difflineplus">+    nsCOMPtr&lt;nsIFile&gt; tmpDownloadFile;</span>
<a href="#l84.350"></a><span id="l84.350" class="difflineplus">+    rv = GetSpecialDirectoryWithFileName(NS_OS_TEMP_DIR,</span>
<a href="#l84.351"></a><span id="l84.351" class="difflineplus">+                                         &quot;newmsg&quot;,</span>
<a href="#l84.352"></a><span id="l84.352" class="difflineplus">+                                         getter_AddRefs(tmpDownloadFile));</span>
<a href="#l84.353"></a><span id="l84.353" class="difflineplus">+</span>
<a href="#l84.354"></a><span id="l84.354" class="difflineplus">+    NS_ASSERTION(NS_SUCCEEDED(rv),</span>
<a href="#l84.355"></a><span id="l84.355" class="difflineplus">+                 &quot;writing tmp pop3 download file: failed to append filename&quot;);</span>
<a href="#l84.356"></a><span id="l84.356" class="difflineplus">+    if (NS_FAILED(rv))</span>
<a href="#l84.357"></a><span id="l84.357" class="difflineplus">+      return rv;</span>
<a href="#l84.358"></a><span id="l84.358" class="difflineplus">+</span>
<a href="#l84.359"></a><span id="l84.359" class="difflineplus">+    //need a unique tmp file to prevent dataloss in multiuser environment</span>
<a href="#l84.360"></a><span id="l84.360" class="difflineplus">+    rv = tmpDownloadFile-&gt;CreateUnique(nsIFile::NORMAL_FILE_TYPE, 00600);</span>
<a href="#l84.361"></a><span id="l84.361" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l84.362"></a><span id="l84.362" class="difflineplus">+</span>
<a href="#l84.363"></a><span id="l84.363" class="difflineplus">+    m_tmpDownloadFile = do_QueryInterface(tmpDownloadFile, &amp;rv);</span>
<a href="#l84.364"></a><span id="l84.364" class="difflineplus">+    if (NS_SUCCEEDED(rv))</span>
<a href="#l84.365"></a><span id="l84.365" class="difflineplus">+    {</span>
<a href="#l84.366"></a><span id="l84.366" class="difflineplus">+      rv = MsgGetFileStream(m_tmpDownloadFile, getter_AddRefs(m_outFileStream));</span>
<a href="#l84.367"></a><span id="l84.367" class="difflineplus">+      NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l84.368"></a><span id="l84.368" class="difflineplus">+    }</span>
<a href="#l84.369"></a><span id="l84.369" class="difflineplus">+  }</span>
<a href="#l84.370"></a><span id="l84.370" class="difflineplus">+  else</span>
<a href="#l84.371"></a><span id="l84.371" class="difflineplus">+  {</span>
<a href="#l84.372"></a><span id="l84.372" class="difflineplus">+    rv = server-&gt;GetMsgStore(getter_AddRefs(m_msgStore));</span>
<a href="#l84.373"></a><span id="l84.373" class="difflineplus">+    bool reusable;</span>
<a href="#l84.374"></a><span id="l84.374" class="difflineplus">+    NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l84.375"></a><span id="l84.375" class="difflineplus">+    m_msgStore-&gt;GetNewMsgOutputStream(m_folder, getter_AddRefs(newHdr),</span>
<a href="#l84.376"></a><span id="l84.376" class="difflineplus">+                                      &amp;reusable, getter_AddRefs(m_outFileStream));</span>
<a href="#l84.377"></a><span id="l84.377" class="difflineplus">+  }</span>
<a href="#l84.378"></a><span id="l84.378" class="difflineplus">+  // The following (!m_outFileStream etc) was added to make sure that we don't</span>
<a href="#l84.379"></a><span id="l84.379" class="difflineplus">+  // write somewhere where for some reason or another we can't write to and</span>
<a href="#l84.380"></a><span id="l84.380" class="difflineplus">+  // lose the messages. See bug 62480</span>
<a href="#l84.381"></a><span id="l84.381" class="difflineplus">+  if (!m_outFileStream)</span>
<a href="#l84.382"></a><span id="l84.382" class="difflineplus">+      return NS_ERROR_OUT_OF_MEMORY;</span>
<a href="#l84.383"></a><span id="l84.383" class="difflineplus">+</span>
<a href="#l84.384"></a><span id="l84.384" class="difflineplus">+  nsCOMPtr&lt;nsISeekableStream&gt; seekableOutStream = do_QueryInterface(m_outFileStream);</span>
<a href="#l84.385"></a><span id="l84.385" class="difflineplus">+</span>
<a href="#l84.386"></a><span id="l84.386" class="difflineplus">+  // create a new mail parser</span>
<a href="#l84.387"></a><span id="l84.387" class="difflineplus">+  m_newMailParser = new nsParseNewMailState;</span>
<a href="#l84.388"></a><span id="l84.388" class="difflineplus">+  NS_ENSURE_TRUE(m_newMailParser, NS_ERROR_OUT_OF_MEMORY);</span>
<a href="#l84.389"></a><span id="l84.389" class="difflineplus">+  if (m_uidlDownload)</span>
<a href="#l84.390"></a><span id="l84.390" class="difflineplus">+    m_newMailParser-&gt;DisableFilters();</span>
<a href="#l84.391"></a><span id="l84.391" class="difflineplus">+</span>
<a href="#l84.392"></a><span id="l84.392" class="difflineplus">+  m_folder-&gt;GetNumNewMessages(PR_FALSE, &amp;m_numNewMessagesInFolder);</span>
<a href="#l84.393"></a><span id="l84.393" class="difflineplus">+  nsCOMPtr &lt;nsIMsgFolder&gt; serverFolder;</span>
<a href="#l84.394"></a><span id="l84.394" class="difflineplus">+  rv = GetServerFolder(getter_AddRefs(serverFolder));</span>
<a href="#l84.395"></a><span id="l84.395" class="difflineplus">+  if (NS_FAILED(rv)) return rv;</span>
<a href="#l84.396"></a><span id="l84.396" class="difflineplus">+</span>
<a href="#l84.397"></a><span id="l84.397" class="difflineplus">+  rv = m_newMailParser-&gt;Init(serverFolder, m_folder,</span>
<a href="#l84.398"></a><span id="l84.398" class="difflineplus">+                             m_window, newHdr, m_outFileStream);</span>
<a href="#l84.399"></a><span id="l84.399" class="difflineplus">+  // If we failed to initialize the parser, then just don't use it!!!</span>
<a href="#l84.400"></a><span id="l84.400" class="difflineplus">+  // We can still continue without one.</span>
<a href="#l84.401"></a><span id="l84.401" class="difflineplus">+</span>
<a href="#l84.402"></a><span id="l84.402" class="difflineplus">+  if (NS_FAILED(rv))</span>
<a href="#l84.403"></a><span id="l84.403" class="difflineplus">+  {</span>
<a href="#l84.404"></a><span id="l84.404" class="difflineplus">+    m_newMailParser = nsnull;</span>
<a href="#l84.405"></a><span id="l84.405" class="difflineplus">+    rv = NS_OK;</span>
<a href="#l84.406"></a><span id="l84.406" class="difflineplus">+  }</span>
<a href="#l84.407"></a><span id="l84.407" class="difflineplus">+  else</span>
<a href="#l84.408"></a><span id="l84.408" class="difflineplus">+  {</span>
<a href="#l84.409"></a><span id="l84.409" class="difflineplus">+    if (m_downloadingToTempFile)</span>
<a href="#l84.410"></a><span id="l84.410" class="difflineplus">+    {</span>
<a href="#l84.411"></a><span id="l84.411" class="difflineplus">+      // Tell the parser to use the offset that will be in the dest folder,</span>
<a href="#l84.412"></a><span id="l84.412" class="difflineplus">+      // not the temp folder, so that the msg hdr will start off with</span>
<a href="#l84.413"></a><span id="l84.413" class="difflineplus">+      // the correct mdb oid</span>
<a href="#l84.414"></a><span id="l84.414" class="difflineplus">+      PRInt64 fileSize;</span>
<a href="#l84.415"></a><span id="l84.415" class="difflineplus">+      path-&gt;GetFileSize(&amp;fileSize);</span>
<a href="#l84.416"></a><span id="l84.416" class="difflineplus">+      m_newMailParser-&gt;SetEnvelopePos((PRUint32) fileSize);</span>
<a href="#l84.417"></a><span id="l84.417" class="difflineplus">+    }</span>
<a href="#l84.418"></a><span id="l84.418" class="difflineplus">+  }</span>
<a href="#l84.419"></a><span id="l84.419">     if (closure)</span>
<a href="#l84.420"></a><span id="l84.420">         *closure = (void*) this;</span>
<a href="#l84.421"></a><span id="l84.421" class="difflineminus">-    nsCOMPtr &lt;nsISeekableStream&gt; seekableStream = do_QueryInterface(m_outFileStream);</span>
<a href="#l84.422"></a><span id="l84.422" class="difflineminus">-    PRInt64 filePos;</span>
<a href="#l84.423"></a><span id="l84.423" class="difflineminus">-    seekableStream-&gt;Tell(&amp;filePos);</span>
<a href="#l84.424"></a><span id="l84.424" class="difflineminus">-    m_msgOffset = (PRUint32) filePos;</span>
<a href="#l84.425"></a><span id="l84.425"> </span>
<a href="#l84.426"></a><span id="l84.426">     char *dummyEnvelope = GetDummyEnvelope();</span>
<a href="#l84.427"></a><span id="l84.427"> </span>
<a href="#l84.428"></a><span id="l84.428" class="difflineminus">-    nsresult rv = WriteLineToMailbox(dummyEnvelope);</span>
<a href="#l84.429"></a><span id="l84.429" class="difflineminus">-    if (NS_FAILED(rv)) return rv;</span>
<a href="#l84.430"></a><span id="l84.430" class="difflineplus">+  rv = WriteLineToMailbox(dummyEnvelope);</span>
<a href="#l84.431"></a><span id="l84.431" class="difflineplus">+  NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l84.432"></a><span id="l84.432">     // write out account-key before UIDL so the code that looks for</span>
<a href="#l84.433"></a><span id="l84.433">     // UIDL will find the account first and know it can stop looking</span>
<a href="#l84.434"></a><span id="l84.434">     // once it finds the UIDL line.</span>
<a href="#l84.435"></a><span id="l84.435">     if (!m_accountKey.IsEmpty())</span>
<a href="#l84.436"></a><span id="l84.436">     {</span>
<a href="#l84.437"></a><span id="l84.437">       nsCAutoString outputString;</span>
<a href="#l84.438"></a><span id="l84.438">       outputString.AssignLiteral(HEADER_X_MOZILLA_ACCOUNT_KEY &quot;: &quot;);</span>
<a href="#l84.439"></a><span id="l84.439">       outputString.Append(m_accountKey);</span>
<a href="#l84.440"></a><span id="l84.440" class="difflineat">@@ -864,51 +860,47 @@ nsPop3Sink::IncorporateComplete(nsIMsgWi</span>
<a href="#l84.441"></a><span id="l84.441">       if (!exists)</span>
<a href="#l84.442"></a><span id="l84.442">         return HandleTempDownloadFailed(aMsgWindow);</span>
<a href="#l84.443"></a><span id="l84.443"> </span>
<a href="#l84.444"></a><span id="l84.444">       nsCOMPtr &lt;nsIInputStream&gt; inboxInputStream = do_QueryInterface(m_outFileStream);</span>
<a href="#l84.445"></a><span id="l84.445">       rv = MsgReopenFileStream(m_tmpDownloadFile, inboxInputStream);</span>
<a href="#l84.446"></a><span id="l84.446">       NS_ENSURE_SUCCESS(rv, HandleTempDownloadFailed(aMsgWindow));</span>
<a href="#l84.447"></a><span id="l84.447">       if (m_outFileStream)</span>
<a href="#l84.448"></a><span id="l84.448">       {</span>
<a href="#l84.449"></a><span id="l84.449" class="difflineminus">-        nsCOMPtr&lt;nsILocalFile&gt; path;</span>
<a href="#l84.450"></a><span id="l84.450" class="difflineminus">-</span>
<a href="#l84.451"></a><span id="l84.451" class="difflineminus">-        PRInt64 folderSize, tmpDownloadFileSize;</span>
<a href="#l84.452"></a><span id="l84.452" class="difflineminus">-        m_folder-&gt;GetFilePath(getter_AddRefs(path));</span>
<a href="#l84.453"></a><span id="l84.453" class="difflineminus">-        path-&gt;GetFileSize(&amp;folderSize);</span>
<a href="#l84.454"></a><span id="l84.454" class="difflineminus">-        PRUint32 newMsgPos = (PRUint32) folderSize;</span>
<a href="#l84.455"></a><span id="l84.455" class="difflineplus">+        PRInt64 tmpDownloadFileSize;</span>
<a href="#l84.456"></a><span id="l84.456">         PRUint32 msgSize;</span>
<a href="#l84.457"></a><span id="l84.457">         hdr-&gt;GetMessageSize(&amp;msgSize);</span>
<a href="#l84.458"></a><span id="l84.458" class="difflineminus">-        hdr-&gt;SetMessageKey(newMsgPos);</span>
<a href="#l84.459"></a><span id="l84.459">         // we need to clone because nsLocalFileUnix caches its stat result,</span>
<a href="#l84.460"></a><span id="l84.460">         // so it doesn't realize the file has changed size.</span>
<a href="#l84.461"></a><span id="l84.461">         nsCOMPtr &lt;nsIFile&gt; tmpClone;</span>
<a href="#l84.462"></a><span id="l84.462">         rv = m_tmpDownloadFile-&gt;Clone(getter_AddRefs(tmpClone));</span>
<a href="#l84.463"></a><span id="l84.463">         NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l84.464"></a><span id="l84.464">         tmpClone-&gt;GetFileSize(&amp;tmpDownloadFileSize);</span>
<a href="#l84.465"></a><span id="l84.465"> </span>
<a href="#l84.466"></a><span id="l84.466">         if (msgSize &gt; tmpDownloadFileSize)</span>
<a href="#l84.467"></a><span id="l84.467">           rv = NS_MSG_ERROR_WRITING_MAIL_FOLDER;</span>
<a href="#l84.468"></a><span id="l84.468">         else</span>
<a href="#l84.469"></a><span id="l84.469" class="difflineminus">-          rv = m_newMailParser-&gt;AppendMsgFromFile(inboxInputStream, 0, msgSize, path);</span>
<a href="#l84.470"></a><span id="l84.470" class="difflineplus">+          rv = m_newMailParser-&gt;AppendMsgFromStream(inboxInputStream, hdr,</span>
<a href="#l84.471"></a><span id="l84.471" class="difflineplus">+                                                    msgSize, m_folder);</span>
<a href="#l84.472"></a><span id="l84.472">         if (NS_FAILED(rv))</span>
<a href="#l84.473"></a><span id="l84.473">           return HandleTempDownloadFailed(aMsgWindow);</span>
<a href="#l84.474"></a><span id="l84.474"> </span>
<a href="#l84.475"></a><span id="l84.475">         m_outFileStream-&gt;Close(); // close so we can truncate.</span>
<a href="#l84.476"></a><span id="l84.476">         m_tmpDownloadFile-&gt;SetFileSize(0);</span>
<a href="#l84.477"></a><span id="l84.477" class="difflineminus">-        rv = MsgReopenFileStream(m_tmpDownloadFile, inboxInputStream);</span>
<a href="#l84.478"></a><span id="l84.478" class="difflineminus">-        NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l84.479"></a><span id="l84.479">       }</span>
<a href="#l84.480"></a><span id="l84.480">       else</span>
<a href="#l84.481"></a><span id="l84.481">       {</span>
<a href="#l84.482"></a><span id="l84.482">           return HandleTempDownloadFailed(aMsgWindow);</span>
<a href="#l84.483"></a><span id="l84.483">         // need to give an error here.</span>
<a href="#l84.484"></a><span id="l84.484">       }</span>
<a href="#l84.485"></a><span id="l84.485">     }</span>
<a href="#l84.486"></a><span id="l84.486" class="difflineminus">-</span>
<a href="#l84.487"></a><span id="l84.487" class="difflineplus">+    else</span>
<a href="#l84.488"></a><span id="l84.488" class="difflineplus">+    {</span>
<a href="#l84.489"></a><span id="l84.489" class="difflineplus">+      m_msgStore-&gt;FinishNewMessage(m_outFileStream, hdr);</span>
<a href="#l84.490"></a><span id="l84.490" class="difflineplus">+    }</span>
<a href="#l84.491"></a><span id="l84.491">     m_newMailParser-&gt;PublishMsgHeader(aMsgWindow);</span>
<a href="#l84.492"></a><span id="l84.492">     // run any reply/forward filter after we've finished with the</span>
<a href="#l84.493"></a><span id="l84.493">     // temp quarantine file, and/or moved the message to another folder.</span>
<a href="#l84.494"></a><span id="l84.494">     m_newMailParser-&gt;ApplyForwardAndReplyFilter(aMsgWindow);</span>
<a href="#l84.495"></a><span id="l84.495">     if (aSize)</span>
<a href="#l84.496"></a><span id="l84.496">       hdr-&gt;SetUint32Property(&quot;onlineSize&quot;, aSize);</span>
<a href="#l84.497"></a><span id="l84.497"> </span>
<a href="#l84.498"></a><span id="l84.498">     // if DeleteDownloadMsg requested it, select the new message</span>
<a href="#l84.499"></a><span id="l84.499" class="difflineat">@@ -923,36 +915,21 @@ nsPop3Sink::IncorporateComplete(nsIMsgWi</span>
<a href="#l84.500"></a><span id="l84.500">   NS_ENSURE_SUCCESS(rv, rv);</span>
<a href="#l84.501"></a><span id="l84.501">   pop3Service-&gt;NotifyDownloadProgress(m_folder, ++m_numMsgsDownloaded, m_numNewMessages);</span>
<a href="#l84.502"></a><span id="l84.502">   return NS_OK;</span>
<a href="#l84.503"></a><span id="l84.503"> }</span>
<a href="#l84.504"></a><span id="l84.504"> </span>
<a href="#l84.505"></a><span id="l84.505"> NS_IMETHODIMP</span>
<a href="#l84.506"></a><span id="l84.506"> nsPop3Sink::IncorporateAbort(bool uidlDownload)</span>
<a href="#l84.507"></a><span id="l84.507"> {</span>
<a href="#l84.508"></a><span id="l84.508" class="difflineminus">-  nsresult rv;</span>
<a href="#l84.509"></a><span id="l84.509" class="difflineminus">-  rv = m_outFileStream-&gt;Close();   //need to close so that the file can be truncated.</span>
<a href="#l84.510"></a><span id="l84.510" class="difflineplus">+  nsresult rv = m_outFileStream-&gt;Close();</span>
<a href="#l84.511"></a><span id="l84.511">   NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l84.512"></a><span id="l84.512" class="difflineminus">-  if (m_msgOffset &gt;= 0 &amp;&amp; !m_downloadingToTempFile)</span>
<a href="#l84.513"></a><span id="l84.513" class="difflineminus">-  {</span>
<a href="#l84.514"></a><span id="l84.514" class="difflineminus">-     nsCOMPtr&lt;nsIMsgIncomingServer&gt; server = do_QueryInterface(m_popServer);</span>
<a href="#l84.515"></a><span id="l84.515" class="difflineminus">-     NS_ASSERTION(server, &quot;Could not get the pop server !!&quot;);</span>
<a href="#l84.516"></a><span id="l84.516" class="difflineminus">-     nsCOMPtr&lt;nsILocalFile&gt; mailDirectory;</span>
<a href="#l84.517"></a><span id="l84.517" class="difflineminus">-     if (uidlDownload)</span>
<a href="#l84.518"></a><span id="l84.518" class="difflineminus">-        m_folder-&gt;GetFilePath(getter_AddRefs(mailDirectory));</span>
<a href="#l84.519"></a><span id="l84.519" class="difflineminus">-     else</span>
<a href="#l84.520"></a><span id="l84.520" class="difflineminus">-     {</span>
<a href="#l84.521"></a><span id="l84.521" class="difflineminus">-       rv = server-&gt;GetLocalPath(getter_AddRefs(mailDirectory));</span>
<a href="#l84.522"></a><span id="l84.522" class="difflineminus">-       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l84.523"></a><span id="l84.523" class="difflineminus">-       rv = mailDirectory-&gt;AppendRelativePath(NS_LITERAL_STRING(&quot;Inbox&quot;));</span>
<a href="#l84.524"></a><span id="l84.524" class="difflineminus">-       NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l84.525"></a><span id="l84.525" class="difflineminus">-     }</span>
<a href="#l84.526"></a><span id="l84.526" class="difflineminus">-     rv = mailDirectory-&gt;SetFileSize(m_msgOffset);</span>
<a href="#l84.527"></a><span id="l84.527" class="difflineminus">-     NS_ENSURE_SUCCESS(rv,rv);</span>
<a href="#l84.528"></a><span id="l84.528" class="difflineminus">-  }</span>
<a href="#l84.529"></a><span id="l84.529" class="difflineplus">+  if (!m_downloadingToTempFile &amp;&amp; m_msgStore)</span>
<a href="#l84.530"></a><span id="l84.530" class="difflineplus">+      m_msgStore-&gt;DiscardNewMessage(m_outFileStream,</span>
<a href="#l84.531"></a><span id="l84.531" class="difflineplus">+                                    m_newMailParser-&gt;m_newMsgHdr);</span>
<a href="#l84.532"></a><span id="l84.532"> #ifdef DEBUG</span>
<a href="#l84.533"></a><span id="l84.533">     printf(&quot;Incorporate message abort.\n&quot;);</span>
<a href="#l84.534"></a><span id="l84.534"> #endif</span>
<a href="#l84.535"></a><span id="l84.535">     return rv;</span>
<a href="#l84.536"></a><span id="l84.536"> }</span>
<a href="#l84.537"></a><span id="l84.537"> </span>
<a href="#l84.538"></a><span id="l84.538"> nsresult</span>
<a href="#l84.539"></a><span id="l84.539"> nsPop3Sink::BiffGetNewMail()</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l85.1"></a><span id="l85.1" class="difflineminus">--- a/mailnews/local/src/nsPop3Sink.h</span>
<a href="#l85.2"></a><span id="l85.2" class="difflineplus">+++ b/mailnews/local/src/nsPop3Sink.h</span>
<a href="#l85.3"></a><span id="l85.3" class="difflineat">@@ -41,16 +41,17 @@</span>
<a href="#l85.4"></a><span id="l85.4"> #include &quot;nsIURL.h&quot;</span>
<a href="#l85.5"></a><span id="l85.5"> #include &quot;nsIPop3Sink.h&quot;</span>
<a href="#l85.6"></a><span id="l85.6"> #include &quot;nsIOutputStream.h&quot;</span>
<a href="#l85.7"></a><span id="l85.7"> #include &quot;prmem.h&quot;</span>
<a href="#l85.8"></a><span id="l85.8"> #include &quot;prio.h&quot;</span>
<a href="#l85.9"></a><span id="l85.9"> #include &quot;plstr.h&quot;</span>
<a href="#l85.10"></a><span id="l85.10"> #include &quot;prenv.h&quot;</span>
<a href="#l85.11"></a><span id="l85.11"> #include &quot;nsIMsgFolder.h&quot;</span>
<a href="#l85.12"></a><span id="l85.12" class="difflineplus">+#include &quot;nsAutoPtr.h&quot;</span>
<a href="#l85.13"></a><span id="l85.13"> </span>
<a href="#l85.14"></a><span id="l85.14"> class nsParseNewMailState;</span>
<a href="#l85.15"></a><span id="l85.15"> class nsIMsgFolder;</span>
<a href="#l85.16"></a><span id="l85.16"> </span>
<a href="#l85.17"></a><span id="l85.17"> struct partialRecord</span>
<a href="#l85.18"></a><span id="l85.18"> {</span>
<a href="#l85.19"></a><span id="l85.19">   partialRecord();</span>
<a href="#l85.20"></a><span id="l85.20">   ~partialRecord();</span>
<a href="#l85.21"></a><span id="l85.21" class="difflineat">@@ -63,50 +64,48 @@ class nsPop3Sink : public nsIPop3Sink</span>
<a href="#l85.22"></a><span id="l85.22"> {</span>
<a href="#l85.23"></a><span id="l85.23"> public:</span>
<a href="#l85.24"></a><span id="l85.24">     nsPop3Sink();</span>
<a href="#l85.25"></a><span id="l85.25">     virtual ~nsPop3Sink();</span>
<a href="#l85.26"></a><span id="l85.26"> </span>
<a href="#l85.27"></a><span id="l85.27">     NS_DECL_ISUPPORTS</span>
<a href="#l85.28"></a><span id="l85.28">     NS_DECL_NSIPOP3SINK</span>
<a href="#l85.29"></a><span id="l85.29">     nsresult GetServerFolder(nsIMsgFolder **aFolder);</span>
<a href="#l85.30"></a><span id="l85.30" class="difflineminus">-    nsresult FindPartialMessages(nsILocalFile *folderFile);</span>
<a href="#l85.31"></a><span id="l85.31" class="difflineplus">+    nsresult FindPartialMessages();</span>
<a href="#l85.32"></a><span id="l85.32">     void CheckPartialMessages(nsIPop3Protocol *protocol);</span>
<a href="#l85.33"></a><span id="l85.33"> </span>
<a href="#l85.34"></a><span id="l85.34">     static char*  GetDummyEnvelope(void);</span>
<a href="#l85.35"></a><span id="l85.35"> </span>
<a href="#l85.36"></a><span id="l85.36"> protected:</span>
<a href="#l85.37"></a><span id="l85.37"> </span>
<a href="#l85.38"></a><span id="l85.38">     nsresult WriteLineToMailbox(const char *buffer);</span>
<a href="#l85.39"></a><span id="l85.39">     nsresult ReleaseFolderLock();</span>
<a href="#l85.40"></a><span id="l85.40">     nsresult HandleTempDownloadFailed(nsIMsgWindow *msgWindow);</span>
<a href="#l85.41"></a><span id="l85.41"> </span>
<a href="#l85.42"></a><span id="l85.42">     bool m_authed;</span>
<a href="#l85.43"></a><span id="l85.43" class="difflineminus">-    PRInt64 m_msgOffset;</span>
<a href="#l85.44"></a><span id="l85.44">     char* m_accountUrl;</span>
<a href="#l85.45"></a><span id="l85.45">     PRUint32 m_biffState;</span>
<a href="#l85.46"></a><span id="l85.46">     PRInt32 m_numNewMessages;</span>
<a href="#l85.47"></a><span id="l85.47">     PRInt32 m_numNewMessagesInFolder;</span>
<a href="#l85.48"></a><span id="l85.48">     PRInt32 m_numMsgsDownloaded;</span>
<a href="#l85.49"></a><span id="l85.49">     bool m_senderAuthed;</span>
<a href="#l85.50"></a><span id="l85.50">     char* m_outputBuffer;</span>
<a href="#l85.51"></a><span id="l85.51">     PRInt32 m_outputBufferSize;</span>
<a href="#l85.52"></a><span id="l85.52">     nsIPop3IncomingServer *m_popServer;</span>
<a href="#l85.53"></a><span id="l85.53">     //Currently the folder we want to update about biff info</span>
<a href="#l85.54"></a><span id="l85.54">     nsCOMPtr&lt;nsIMsgFolder&gt; m_folder;</span>
<a href="#l85.55"></a><span id="l85.55" class="difflineminus">-    nsParseNewMailState  *m_newMailParser;</span>
<a href="#l85.56"></a><span id="l85.56" class="difflineminus">-#ifdef DEBUG</span>
<a href="#l85.57"></a><span id="l85.57" class="difflineminus">-    PRInt32 m_fileCounter;</span>
<a href="#l85.58"></a><span id="l85.58" class="difflineminus">-#endif</span>
<a href="#l85.59"></a><span id="l85.59" class="difflineplus">+    nsRefPtr&lt;nsParseNewMailState&gt; m_newMailParser;</span>
<a href="#l85.60"></a><span id="l85.60">     nsCOMPtr &lt;nsIOutputStream&gt; m_outFileStream; // the file we write to, which may be temporary</span>
<a href="#l85.61"></a><span id="l85.61" class="difflineplus">+    nsCOMPtr&lt;nsIMsgPluggableStore&gt; m_msgStore;</span>
<a href="#l85.62"></a><span id="l85.62">     nsCOMPtr &lt;nsIOutputStream&gt; m_inboxOutputStream; // the actual mailbox</span>
<a href="#l85.63"></a><span id="l85.63" class="difflineminus">-</span>
<a href="#l85.64"></a><span id="l85.64" class="difflineplus">+    bool m_uidlDownload;</span>
<a href="#l85.65"></a><span id="l85.65">     bool m_buildMessageUri;</span>
<a href="#l85.66"></a><span id="l85.66">     bool m_downloadingToTempFile;</span>
<a href="#l85.67"></a><span id="l85.67">     nsCOMPtr &lt;nsILocalFile&gt; m_tmpDownloadFile;</span>
<a href="#l85.68"></a><span id="l85.68" class="difflineplus">+    nsCOMPtr&lt;nsIMsgWindow&gt; m_window;</span>
<a href="#l85.69"></a><span id="l85.69">     nsCString m_messageUri;</span>
<a href="#l85.70"></a><span id="l85.70">     nsCString m_baseMessageUri;</span>
<a href="#l85.71"></a><span id="l85.71">     nsCString m_origMessageUri;</span>
<a href="#l85.72"></a><span id="l85.72">     nsCString m_accountKey;</span>
<a href="#l85.73"></a><span id="l85.73">     nsTArray&lt;partialRecord*&gt; m_partialMsgsArray;</span>
<a href="#l85.74"></a><span id="l85.74"> };</span>
<a href="#l85.75"></a><span id="l85.75"> </span>
<a href="#l85.76"></a><span id="l85.76"> #endif</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l86.1"></a><span id="l86.1" class="difflineminus">--- a/mailnews/local/test/unit/test_msgCopy.js</span>
<a href="#l86.2"></a><span id="l86.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_msgCopy.js</span>
<a href="#l86.3"></a><span id="l86.3" class="difflineat">@@ -61,20 +61,25 @@ function run_test()</span>
<a href="#l86.4"></a><span id="l86.4"> </span>
<a href="#l86.5"></a><span id="l86.5"> // nsIMsgCopyServiceListener implementation</span>
<a href="#l86.6"></a><span id="l86.6"> var copyListener = </span>
<a href="#l86.7"></a><span id="l86.7"> {</span>
<a href="#l86.8"></a><span id="l86.8">   OnStartCopy: function() {},</span>
<a href="#l86.9"></a><span id="l86.9">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l86.10"></a><span id="l86.10">   SetMessageKey: function(aKey)</span>
<a href="#l86.11"></a><span id="l86.11">   {</span>
<a href="#l86.12"></a><span id="l86.12" class="difflineminus">-    hdrs.push(gLocalInboxFolder.GetMessageHeader(aKey));</span>
<a href="#l86.13"></a><span id="l86.13" class="difflineplus">+    try {</span>
<a href="#l86.14"></a><span id="l86.14" class="difflineplus">+      hdrs.push(aKey);</span>
<a href="#l86.15"></a><span id="l86.15" class="difflineplus">+    } catch (ex) {dump(ex);}</span>
<a href="#l86.16"></a><span id="l86.16">   },</span>
<a href="#l86.17"></a><span id="l86.17">   SetMessageId: function(aMessageId) {},</span>
<a href="#l86.18"></a><span id="l86.18">   OnStopCopy: function(aStatus)</span>
<a href="#l86.19"></a><span id="l86.19">   {</span>
<a href="#l86.20"></a><span id="l86.20" class="difflineplus">+    try {</span>
<a href="#l86.21"></a><span id="l86.21">     var copiedMessage = gLocalInboxFolder.GetMessageHeader(hdrs[0]);</span>
<a href="#l86.22"></a><span id="l86.22">     do_check_eq(copiedMessage.getStringProperty(&quot;keywords&quot;), tag1);</span>
<a href="#l86.23"></a><span id="l86.23">     hdrs = null;</span>
<a href="#l86.24"></a><span id="l86.24" class="difflineplus">+    }</span>
<a href="#l86.25"></a><span id="l86.25" class="difflineplus">+    catch (ex) {dump(ex);}</span>
<a href="#l86.26"></a><span id="l86.26">     do_test_finished();</span>
<a href="#l86.27"></a><span id="l86.27">   }</span>
<a href="#l86.28"></a><span id="l86.28"> };</span>
<a href="#l86.29"></a><span id="l86.29"> </span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l87.1"></a><span id="l87.1" class="difflineminus">--- a/mailnews/local/test/unit/test_over2GBMailboxes.js</span>
<a href="#l87.2"></a><span id="l87.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_over2GBMailboxes.js</span>
<a href="#l87.3"></a><span id="l87.3" class="difflineat">@@ -1,40 +1,46 @@</span>
<a href="#l87.4"></a><span id="l87.4"> /* -*- Mode: C++; tab-width: 2; indent-tabs-mode: nil; c-basic-offset: 2 -*- */</span>
<a href="#l87.5"></a><span id="l87.5"> </span>
<a href="#l87.6"></a><span id="l87.6"> /* Test of accessing over 2GB local folder */</span>
<a href="#l87.7"></a><span id="l87.7"> </span>
<a href="#l87.8"></a><span id="l87.8" class="difflineplus">+Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l87.9"></a><span id="l87.9" class="difflineplus">+                           &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l87.10"></a><span id="l87.10" class="difflineplus">+</span>
<a href="#l87.11"></a><span id="l87.11"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l87.12"></a><span id="l87.12"> const bugmail10 = do_get_file(&quot;../../../data/bugmail10&quot;);</span>
<a href="#l87.13"></a><span id="l87.13"> </span>
<a href="#l87.14"></a><span id="l87.14"> var gLocalTrashFolder;</span>
<a href="#l87.15"></a><span id="l87.15"> var gCopyService;</span>
<a href="#l87.16"></a><span id="l87.16"> </span>
<a href="#l87.17"></a><span id="l87.17"> function run_test()</span>
<a href="#l87.18"></a><span id="l87.18"> {</span>
<a href="#l87.19"></a><span id="l87.19">   loadLocalMailAccount();</span>
<a href="#l87.20"></a><span id="l87.20"> </span>
<a href="#l87.21"></a><span id="l87.21">   // &quot;Trash&quot; folder</span>
<a href="#l87.22"></a><span id="l87.22">   gLocalTrashFolder = gLocalIncomingServer.rootMsgFolder.getChildNamed(&quot;Trash&quot;);</span>
<a href="#l87.23"></a><span id="l87.23">   gCopyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;].getService(Ci.nsIMsgCopyService);</span>
<a href="#l87.24"></a><span id="l87.24"> </span>
<a href="#l87.25"></a><span id="l87.25" class="difflineminus">-  var freeDiskSpace = gLocalInboxFolder.filePath.diskSpaceAvailable;</span>
<a href="#l87.26"></a><span id="l87.26" class="difflineplus">+  let inboxFile = gLocalInboxFolder.filePath.clone();</span>
<a href="#l87.27"></a><span id="l87.27" class="difflineplus">+  var freeDiskSpace = inboxFile.diskSpaceAvailable;</span>
<a href="#l87.28"></a><span id="l87.28">   if (freeDiskSpace &lt; 0x100000000) {</span>
<a href="#l87.29"></a><span id="l87.29">     dump(&quot;not enough free disk space: &quot; + freeDiskSpace + &quot;\n&quot;);</span>
<a href="#l87.30"></a><span id="l87.30">     do_test_finished();</span>
<a href="#l87.31"></a><span id="l87.31">     return;</span>
<a href="#l87.32"></a><span id="l87.32">   }</span>
<a href="#l87.33"></a><span id="l87.33"> </span>
<a href="#l87.34"></a><span id="l87.34">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l87.35"></a><span id="l87.35">   // all the operations.</span>
<a href="#l87.36"></a><span id="l87.36">   do_test_pending();</span>
<a href="#l87.37"></a><span id="l87.37"> </span>
<a href="#l87.38"></a><span id="l87.38">   // extend local folder to over 2GB</span>
<a href="#l87.39"></a><span id="l87.39" class="difflineminus">-  let outputStream = gLocalInboxFolder.offlineStoreOutputStream</span>
<a href="#l87.40"></a><span id="l87.40" class="difflineplus">+  let outputStream = Cc[&quot;@mozilla.org/network/file-output-stream;1&quot;].</span>
<a href="#l87.41"></a><span id="l87.41" class="difflineplus">+                       createInstance(Ci.nsIFileOutputStream)</span>
<a href="#l87.42"></a><span id="l87.42">                                .QueryInterface(Ci.nsISeekableStream);</span>
<a href="#l87.43"></a><span id="l87.43" class="difflineplus">+  outputStream.init(inboxFile, -1, -1, 0);</span>
<a href="#l87.44"></a><span id="l87.44">   // seek past 2GB.</span>
<a href="#l87.45"></a><span id="l87.45">   outputStream.seek(0, 0x80000010);</span>
<a href="#l87.46"></a><span id="l87.46">   outputStream.write(&quot; &quot;, 1);</span>
<a href="#l87.47"></a><span id="l87.47">   outputStream.close();</span>
<a href="#l87.48"></a><span id="l87.48"> </span>
<a href="#l87.49"></a><span id="l87.49">   // add mail data to over 2GB position for over 2G msgkey</span>
<a href="#l87.50"></a><span id="l87.50">   gCopyService.CopyFileMessage(bugmail10, gLocalInboxFolder, null, false, 0,</span>
<a href="#l87.51"></a><span id="l87.51">                                &quot;&quot;, copyListener, null);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l88.1"></a><span id="l88.1" class="difflineminus">--- a/mailnews/local/test/unit/test_over4GBMailboxes.js</span>
<a href="#l88.2"></a><span id="l88.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_over4GBMailboxes.js</span>
<a href="#l88.3"></a><span id="l88.3" class="difflineat">@@ -6,16 +6,19 @@</span>
<a href="#l88.4"></a><span id="l88.4">  */</span>
<a href="#l88.5"></a><span id="l88.5"> </span>
<a href="#l88.6"></a><span id="l88.6"> load(&quot;../../../resources/mailTestUtils.js&quot;);</span>
<a href="#l88.7"></a><span id="l88.7"> load(&quot;../../../resources/asyncTestUtils.js&quot;);</span>
<a href="#l88.8"></a><span id="l88.8"> load(&quot;../../../resources/alertTestUtils.js&quot;);</span>
<a href="#l88.9"></a><span id="l88.9"> Components.utils.import(&quot;resource://gre/modules/XPCOMUtils.jsm&quot;);</span>
<a href="#l88.10"></a><span id="l88.10"> load(&quot;../../../resources/messageGenerator.js&quot;);</span>
<a href="#l88.11"></a><span id="l88.11"> </span>
<a href="#l88.12"></a><span id="l88.12" class="difflineplus">+Services.prefs.setCharPref(&quot;mail.serverDefaultStoreContractID&quot;,</span>
<a href="#l88.13"></a><span id="l88.13" class="difflineplus">+                           &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l88.14"></a><span id="l88.14" class="difflineplus">+</span>
<a href="#l88.15"></a><span id="l88.15"> var gLocalInboxSize;</span>
<a href="#l88.16"></a><span id="l88.16"> </span>
<a href="#l88.17"></a><span id="l88.17"> var gGotAlert = false;</span>
<a href="#l88.18"></a><span id="l88.18"> </span>
<a href="#l88.19"></a><span id="l88.19"> var dummyDocShell =</span>
<a href="#l88.20"></a><span id="l88.20"> {</span>
<a href="#l88.21"></a><span id="l88.21">   getInterface: function (iid) {</span>
<a href="#l88.22"></a><span id="l88.22">     if (iid.equals(Ci.nsIAuthPrompt)) {</span>
<a href="#l88.23"></a><span id="l88.23" class="difflineat">@@ -61,49 +64,54 @@ var copyListener = {</span>
<a href="#l88.24"></a><span id="l88.24"> // block size might help, though it will slow the test down and consume</span>
<a href="#l88.25"></a><span id="l88.25"> // more disk space.</span>
<a href="#l88.26"></a><span id="l88.26"> const kSparseBlockSize = 102400000;</span>
<a href="#l88.27"></a><span id="l88.27"> </span>
<a href="#l88.28"></a><span id="l88.28"> function run_test()</span>
<a href="#l88.29"></a><span id="l88.29"> {</span>
<a href="#l88.30"></a><span id="l88.30">   loadLocalMailAccount();</span>
<a href="#l88.31"></a><span id="l88.31"> </span>
<a href="#l88.32"></a><span id="l88.32" class="difflineminus">-  let inboxFile = gLocalInboxFolder.filePath.clone();</span>
<a href="#l88.33"></a><span id="l88.33">   // put a single message in the Inbox.</span>
<a href="#l88.34"></a><span id="l88.34">   let messageGenerator = new MessageGenerator();</span>
<a href="#l88.35"></a><span id="l88.35">   let message = messageGenerator.makeMessage();</span>
<a href="#l88.36"></a><span id="l88.36">   let localInbox = gLocalInboxFolder.QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l88.37"></a><span id="l88.37">   localInbox.addMessage(message.toMboxString());</span>
<a href="#l88.38"></a><span id="l88.38"> </span>
<a href="#l88.39"></a><span id="l88.39">   // On Windows, check whether the drive is NTFS. If it is, mark the file as</span>
<a href="#l88.40"></a><span id="l88.40">   // sparse. If it isn't, then bail out now, because in all probability it is</span>
<a href="#l88.41"></a><span id="l88.41">   // FAT32, which doesn't support file sizes greater than 4 GB.</span>
<a href="#l88.42"></a><span id="l88.42">   if (&quot;@mozilla.org/windows-registry-key;1&quot; in Cc &amp;&amp;</span>
<a href="#l88.43"></a><span id="l88.43" class="difflineminus">-      get_file_system(inboxFile) != &quot;NTFS&quot;)</span>
<a href="#l88.44"></a><span id="l88.44" class="difflineplus">+      get_file_system(gLocalInboxFolder.filePath) != &quot;NTFS&quot;)</span>
<a href="#l88.45"></a><span id="l88.45">   {</span>
<a href="#l88.46"></a><span id="l88.46">     dump(&quot;On Windows, this test only works on NTFS volumes.\n&quot;);</span>
<a href="#l88.47"></a><span id="l88.47">     endTest();</span>
<a href="#l88.48"></a><span id="l88.48">     return;</span>
<a href="#l88.49"></a><span id="l88.49">   }</span>
<a href="#l88.50"></a><span id="l88.50" class="difflineminus">-  if (inboxFile.diskSpaceAvailable &lt; 0x1100000000)</span>
<a href="#l88.51"></a><span id="l88.51" class="difflineplus">+  if (gLocalInboxFolder.filePath.clone().diskSpaceAvailable &lt; 0x110000000)</span>
<a href="#l88.52"></a><span id="l88.52">   {</span>
<a href="#l88.53"></a><span id="l88.53">     dump(&quot;this test needs &gt;4 GB of free disk space.\n&quot;);</span>
<a href="#l88.54"></a><span id="l88.54">     endTest();</span>
<a href="#l88.55"></a><span id="l88.55">     return;</span>
<a href="#l88.56"></a><span id="l88.56">   }</span>
<a href="#l88.57"></a><span id="l88.57" class="difflineplus">+  let plugStore = gLocalInboxFolder.msgStore;</span>
<a href="#l88.58"></a><span id="l88.58">   do {</span>
<a href="#l88.59"></a><span id="l88.59" class="difflineminus">-    let nextOffset = gLocalInboxFolder.filePath.fileSize + kSparseBlockSize;</span>
<a href="#l88.60"></a><span id="l88.60" class="difflineminus">-    mark_file_region_sparse(inboxFile, gLocalInboxFolder.filePath.fileSize,</span>
<a href="#l88.61"></a><span id="l88.61" class="difflineplus">+    let inboxFile = gLocalInboxFolder.filePath.clone();</span>
<a href="#l88.62"></a><span id="l88.62" class="difflineplus">+    let nextOffset = inboxFile.fileSize + kSparseBlockSize;</span>
<a href="#l88.63"></a><span id="l88.63" class="difflineplus">+    mark_file_region_sparse(inboxFile, inboxFile.fileSize,</span>
<a href="#l88.64"></a><span id="l88.64">                             kSparseBlockSize);</span>
<a href="#l88.65"></a><span id="l88.65" class="difflineminus">-    let outputStream = gLocalInboxFolder.offlineStoreOutputStream</span>
<a href="#l88.66"></a><span id="l88.66" class="difflineminus">-      .QueryInterface(Ci.nsISeekableStream);</span>
<a href="#l88.67"></a><span id="l88.67" class="difflineplus">+    let reusable = new Object;</span>
<a href="#l88.68"></a><span id="l88.68" class="difflineplus">+    let newMsgHdr = new Object;</span>
<a href="#l88.69"></a><span id="l88.69" class="difflineplus">+    let outputStream = plugStore.getNewMsgOutputStream(gLocalInboxFolder,</span>
<a href="#l88.70"></a><span id="l88.70" class="difflineplus">+                                                       newMsgHdr, reusable).</span>
<a href="#l88.71"></a><span id="l88.71" class="difflineplus">+                         QueryInterface(Ci.nsISeekableStream);</span>
<a href="#l88.72"></a><span id="l88.72">     outputStream.seek(0, nextOffset);</span>
<a href="#l88.73"></a><span id="l88.73">     let mboxString = &quot;\r\n&quot; + message.toMboxString();</span>
<a href="#l88.74"></a><span id="l88.74">     outputStream.write(mboxString, mboxString.length);</span>
<a href="#l88.75"></a><span id="l88.75">     outputStream.close();</span>
<a href="#l88.76"></a><span id="l88.76" class="difflineplus">+    plugStore.finishNewMessage(outputStream, newMsgHdr);</span>
<a href="#l88.77"></a><span id="l88.77">   }</span>
<a href="#l88.78"></a><span id="l88.78">   while (gLocalInboxFolder.filePath.fileSize &lt; 0x100000000)</span>
<a href="#l88.79"></a><span id="l88.79"> </span>
<a href="#l88.80"></a><span id="l88.80">   gLocalInboxSize = gLocalInboxFolder.filePath.fileSize;</span>
<a href="#l88.81"></a><span id="l88.81"> </span>
<a href="#l88.82"></a><span id="l88.82">   // &quot;Master&quot; do_test_pending(), paired with a do_test_finished() at the end of</span>
<a href="#l88.83"></a><span id="l88.83">   // all the operations.</span>
<a href="#l88.84"></a><span id="l88.84">   do_test_pending();</span>
<a href="#l88.85"></a><span id="l88.85" class="difflineat">@@ -112,16 +120,19 @@ function run_test()</span>
<a href="#l88.86"></a><span id="l88.86">   let copyService = Cc[&quot;@mozilla.org/messenger/messagecopyservice;1&quot;]</span>
<a href="#l88.87"></a><span id="l88.87">                       .getService(Ci.nsIMsgCopyService);</span>
<a href="#l88.88"></a><span id="l88.88"> </span>
<a href="#l88.89"></a><span id="l88.89">   try {</span>
<a href="#l88.90"></a><span id="l88.90">     copyService.CopyFileMessage(file, gLocalInboxFolder, null, false, 0,</span>
<a href="#l88.91"></a><span id="l88.91">                                 &quot;&quot;, copyListener, dummyMsgWindow);</span>
<a href="#l88.92"></a><span id="l88.92">   } catch (ex) {</span>
<a href="#l88.93"></a><span id="l88.93">   }</span>
<a href="#l88.94"></a><span id="l88.94" class="difflineplus">+  // Force the db closed, so that getDatabaseWithReparse will notice</span>
<a href="#l88.95"></a><span id="l88.95" class="difflineplus">+  // that it's out of date.</span>
<a href="#l88.96"></a><span id="l88.96" class="difflineplus">+  gLocalInboxFolder.msgDatabase.ForceClosed();</span>
<a href="#l88.97"></a><span id="l88.97">   gLocalInboxFolder.msgDatabase = null;</span>
<a href="#l88.98"></a><span id="l88.98">   try {</span>
<a href="#l88.99"></a><span id="l88.99">     gLocalInboxFolder.getDatabaseWithReparse(ParseListener, dummyMsgWindow);</span>
<a href="#l88.100"></a><span id="l88.100">   } catch (ex) {</span>
<a href="#l88.101"></a><span id="l88.101">     do_check_true(ex.result == Cr.NS_ERROR_NOT_INITIALIZED);</span>
<a href="#l88.102"></a><span id="l88.102">   }</span>
<a href="#l88.103"></a><span id="l88.103"> }</span>
<a href="#l88.104"></a><span id="l88.104"> </span>
<a href="#l88.105"></a><span id="l88.105" class="difflineat">@@ -142,17 +153,17 @@ function testCompact()</span>
<a href="#l88.106"></a><span id="l88.106">   gLocalInboxFolder.compact(CompactListener, null);</span>
<a href="#l88.107"></a><span id="l88.107"> }</span>
<a href="#l88.108"></a><span id="l88.108"> </span>
<a href="#l88.109"></a><span id="l88.109"> var ParseListener =</span>
<a href="#l88.110"></a><span id="l88.110"> {</span>
<a href="#l88.111"></a><span id="l88.111">   OnStartRunningUrl: function (aUrl) {</span>
<a href="#l88.112"></a><span id="l88.112">   },</span>
<a href="#l88.113"></a><span id="l88.113">   OnStopRunningUrl: function (aUrl, aExitCode) {</span>
<a href="#l88.114"></a><span id="l88.114" class="difflineminus">-    // Check: message successfully copied.</span>
<a href="#l88.115"></a><span id="l88.115" class="difflineplus">+    // Check: reparse successful</span>
<a href="#l88.116"></a><span id="l88.116">     do_check_eq(aExitCode, 0);</span>
<a href="#l88.117"></a><span id="l88.117">     do_check_true(gLocalInboxFolder.msgDatabase.summaryValid);</span>
<a href="#l88.118"></a><span id="l88.118">     testCompact();</span>
<a href="#l88.119"></a><span id="l88.119">   }</span>
<a href="#l88.120"></a><span id="l88.120"> };</span>
<a href="#l88.121"></a><span id="l88.121"> </span>
<a href="#l88.122"></a><span id="l88.122"> var CompactListener =</span>
<a href="#l88.123"></a><span id="l88.123"> {</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l89.1"></a><span id="l89.1" class="difflineminus">--- a/mailnews/local/test/unit/test_preview.js</span>
<a href="#l89.2"></a><span id="l89.2" class="difflineplus">+++ b/mailnews/local/test/unit/test_preview.js</span>
<a href="#l89.3"></a><span id="l89.3" class="difflineat">@@ -43,16 +43,18 @@ var copyListener2 =</span>
<a href="#l89.4"></a><span id="l89.4">   OnProgress: function(aProgress, aProgressMax) {},</span>
<a href="#l89.5"></a><span id="l89.5">   SetMessageKey: function(aKey)</span>
<a href="#l89.6"></a><span id="l89.6">   {</span>
<a href="#l89.7"></a><span id="l89.7">     hdrs.push(aKey);</span>
<a href="#l89.8"></a><span id="l89.8">   },</span>
<a href="#l89.9"></a><span id="l89.9">   SetMessageId: function(aMessageId) {},</span>
<a href="#l89.10"></a><span id="l89.10">   OnStopCopy: function(aStatus)</span>
<a href="#l89.11"></a><span id="l89.11">   {</span>
<a href="#l89.12"></a><span id="l89.12" class="difflineplus">+    try {</span>
<a href="#l89.13"></a><span id="l89.13">     gLocalInboxFolder.fetchMsgPreviewText(hdrs, hdrs.length, false, null);</span>
<a href="#l89.14"></a><span id="l89.14">     do_check_eq(gLocalInboxFolder.GetMessageHeader(hdrs[0]).getStringProperty('preview'),</span>
<a href="#l89.15"></a><span id="l89.15">                 bugmail10_preview);</span>
<a href="#l89.16"></a><span id="l89.16">     do_check_eq(gLocalInboxFolder.GetMessageHeader(hdrs[1]).getStringProperty('preview'),</span>
<a href="#l89.17"></a><span id="l89.17">                 bugmail11_preview);</span>
<a href="#l89.18"></a><span id="l89.18" class="difflineplus">+    } catch(ex) {dump(ex); do_throw(e) }</span>
<a href="#l89.19"></a><span id="l89.19">     do_test_finished();</span>
<a href="#l89.20"></a><span id="l89.20">   }</span>
<a href="#l89.21"></a><span id="l89.21"> };</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l90.1"></a><span id="l90.1" class="difflineminus">--- a/mailnews/mailnews.js</span>
<a href="#l90.2"></a><span id="l90.2" class="difflineplus">+++ b/mailnews/mailnews.js</span>
<a href="#l90.3"></a><span id="l90.3" class="difflineat">@@ -473,16 +473,20 @@ pref(&quot;mail.server.default.inhibitWhiteLi</span>
<a href="#l90.4"></a><span id="l90.4"> </span>
<a href="#l90.5"></a><span id="l90.5"> // to activate auto-sync feature (preemptive message download for imap) by default</span>
<a href="#l90.6"></a><span id="l90.6"> pref(&quot;mail.server.default.autosync_offline_stores&quot;,true);</span>
<a href="#l90.7"></a><span id="l90.7"> pref(&quot;mail.server.default.offline_download&quot;,true);</span>
<a href="#l90.8"></a><span id="l90.8"> </span>
<a href="#l90.9"></a><span id="l90.9"> // -1 means no limit, no purging of offline stores.</span>
<a href="#l90.10"></a><span id="l90.10"> pref(&quot;mail.server.default.autosync_max_age_days&quot;, -1);</span>
<a href="#l90.11"></a><span id="l90.11"> </span>
<a href="#l90.12"></a><span id="l90.12" class="difflineplus">+// This is the default store contractID for newly created servers.</span>
<a href="#l90.13"></a><span id="l90.13" class="difflineplus">+// We don't use mail.server.default because we want to ensure that the</span>
<a href="#l90.14"></a><span id="l90.14" class="difflineplus">+// store contract id is always written out to prefs.js</span>
<a href="#l90.15"></a><span id="l90.15" class="difflineplus">+pref(&quot;mail.serverDefaultStoreContractID&quot;, &quot;@mozilla.org/msgstore/berkeleystore;1&quot;);</span>
<a href="#l90.16"></a><span id="l90.16"> // the probablilty threshold over which messages are classified as junk</span>
<a href="#l90.17"></a><span id="l90.17"> // this number is divided by 100 before it is used. The classifier can be fine tuned</span>
<a href="#l90.18"></a><span id="l90.18"> // by changing this pref. Typical values are .99, .95, .90, .5, etc.</span>
<a href="#l90.19"></a><span id="l90.19"> pref(&quot;mail.adaptivefilters.junk_threshold&quot;, 90);</span>
<a href="#l90.20"></a><span id="l90.20"> pref(&quot;mail.spam.version&quot;, 0); // used to determine when to migrate global spam settings</span>
<a href="#l90.21"></a><span id="l90.21"> pref(&quot;mail.spam.logging.enabled&quot;, false);</span>
<a href="#l90.22"></a><span id="l90.22"> pref(&quot;mail.spam.manualMark&quot;, false);</span>
<a href="#l90.23"></a><span id="l90.23"> pref(&quot;mail.spam.markAsReadOnSpam&quot;, false);</span>
<a href="#l90.24"></a><span id="l90.24" class="difflineat">@@ -787,23 +791,23 @@ pref(&quot;mailnews.auto_config_url&quot;, &quot;https:</span>
<a href="#l90.25"></a><span id="l90.25"> // Added in bug 551519. Remove when bug 545866 is fixed.</span>
<a href="#l90.26"></a><span id="l90.26"> pref(&quot;mailnews.mx_service_url&quot;, &quot;https://live.mozillamessaging.com/dns/mx/&quot;);</span>
<a href="#l90.27"></a><span id="l90.27"> </span>
<a href="#l90.28"></a><span id="l90.28"> // -- Summary Database options</span>
<a href="#l90.29"></a><span id="l90.29"> // dontPreserveOnCopy: a space separated list of properties that are not</span>
<a href="#l90.30"></a><span id="l90.30"> //                     copied to the new nsIMsgHdr when a message is copied.</span>
<a href="#l90.31"></a><span id="l90.31"> //                     Allows extensions to control preservation of properties.</span>
<a href="#l90.32"></a><span id="l90.32"> pref(&quot;mailnews.database.summary.dontPreserveOnCopy&quot;,</span>
<a href="#l90.33"></a><span id="l90.33" class="difflineminus">-  &quot;account msgOffset threadParent msgThreadId statusOfset flags size numLines ProtoThreadFlags label gloda-id gloda-dirty&quot;);</span>
<a href="#l90.34"></a><span id="l90.34" class="difflineplus">+  &quot;account msgOffset threadParent msgThreadId statusOfset flags size numLines ProtoThreadFlags label gloda-id gloda-dirty storeToken&quot;);</span>
<a href="#l90.35"></a><span id="l90.35"> </span>
<a href="#l90.36"></a><span id="l90.36"> // dontPreserveOnMove: a space separated list of properties that are not</span>
<a href="#l90.37"></a><span id="l90.37"> //                     copied to the new nsIMsgHdr when a message is moved.</span>
<a href="#l90.38"></a><span id="l90.38"> //                     Allows extensions to control preservation of properties.</span>
<a href="#l90.39"></a><span id="l90.39"> pref(&quot;mailnews.database.summary.dontPreserveOnMove&quot;,</span>
<a href="#l90.40"></a><span id="l90.40" class="difflineminus">-  &quot;account msgOffset threadParent msgThreadId statusOfset flags size numLines ProtoThreadFlags label&quot;);</span>
<a href="#l90.41"></a><span id="l90.41" class="difflineplus">+  &quot;account msgOffset threadParent msgThreadId statusOfset flags size numLines ProtoThreadFlags label storeToken&quot;);</span>
<a href="#l90.42"></a><span id="l90.42"> </span>
<a href="#l90.43"></a><span id="l90.43"> // -- Global Database (gloda) options</span>
<a href="#l90.44"></a><span id="l90.44"> // Should the indexer be enabled?</span>
<a href="#l90.45"></a><span id="l90.45"> pref(&quot;mailnews.database.global.indexer.enabled&quot;, false);</span>
<a href="#l90.46"></a><span id="l90.46"> // Should we output warnings and errors to the &quot;error console&quot;?</span>
<a href="#l90.47"></a><span id="l90.47"> pref(&quot;mailnews.database.global.logging.console&quot;, false);</span>
<a href="#l90.48"></a><span id="l90.48"> // Should we output all output levels to stdout via dump?</span>
<a href="#l90.49"></a><span id="l90.49"> pref(&quot;mailnews.database.global.logging.dump&quot;, false);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l91.1"></a><span id="l91.1" class="difflineminus">--- a/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l91.2"></a><span id="l91.2" class="difflineplus">+++ b/mailnews/news/src/nsNNTPProtocol.cpp</span>
<a href="#l91.3"></a><span id="l91.3" class="difflineat">@@ -801,17 +801,17 @@ bool nsNNTPProtocol::ReadFromLocalCache(</span>
<a href="#l91.4"></a><span id="l91.4"> </span>
<a href="#l91.5"></a><span id="l91.5">   if (msgIsInLocalCache)</span>
<a href="#l91.6"></a><span id="l91.6">   {</span>
<a href="#l91.7"></a><span id="l91.7">     nsCOMPtr &lt;nsIMsgFolder&gt; folder = do_QueryInterface(m_newsFolder);</span>
<a href="#l91.8"></a><span id="l91.8">     if (folder &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l91.9"></a><span id="l91.9">     {</span>
<a href="#l91.10"></a><span id="l91.10">     // we want to create a file channel and read the msg from there.</span>
<a href="#l91.11"></a><span id="l91.11">       nsCOMPtr&lt;nsIInputStream&gt; fileStream;</span>
<a href="#l91.12"></a><span id="l91.12" class="difflineminus">-      PRUint64 offset=0;</span>
<a href="#l91.13"></a><span id="l91.13" class="difflineplus">+      PRInt64 offset=0;</span>
<a href="#l91.14"></a><span id="l91.14">       PRUint32 size=0;</span>
<a href="#l91.15"></a><span id="l91.15">       rv = folder-&gt;GetOfflineFileStream(m_key, &amp;offset, &amp;size, getter_AddRefs(fileStream));</span>
<a href="#l91.16"></a><span id="l91.16"> </span>
<a href="#l91.17"></a><span id="l91.17">       // get the file stream from the folder, somehow (through the message or</span>
<a href="#l91.18"></a><span id="l91.18">       // folder sink?) We also need to set the transfer offset to the message offset</span>
<a href="#l91.19"></a><span id="l91.19">       if (fileStream &amp;&amp; NS_SUCCEEDED(rv))</span>
<a href="#l91.20"></a><span id="l91.20">       {</span>
<a href="#l91.21"></a><span id="l91.21">         // dougt - This may break the ablity to &quot;cancel&quot; a read from offline mail reading.</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l92.1"></a><span id="l92.1" class="difflineminus">--- a/mailnews/news/src/nsNntpService.cpp</span>
<a href="#l92.2"></a><span id="l92.2" class="difflineplus">+++ b/mailnews/news/src/nsNntpService.cpp</span>
<a href="#l92.3"></a><span id="l92.3" class="difflineat">@@ -1534,17 +1534,17 @@ NS_IMETHODIMP nsNntpService::StreamHeade</span>
<a href="#l92.4"></a><span id="l92.4">   if (key == nsMsgKey_None)</span>
<a href="#l92.5"></a><span id="l92.5">     return NS_MSG_MESSAGE_NOT_FOUND;</span>
<a href="#l92.6"></a><span id="l92.6"> </span>
<a href="#l92.7"></a><span id="l92.7">   nsCOMPtr&lt;nsIInputStream&gt; inputStream;</span>
<a href="#l92.8"></a><span id="l92.8">   bool hasMsgOffline = false;</span>
<a href="#l92.9"></a><span id="l92.9">   folder-&gt;HasMsgOffline(key, &amp;hasMsgOffline);</span>
<a href="#l92.10"></a><span id="l92.10">   if (hasMsgOffline)</span>
<a href="#l92.11"></a><span id="l92.11">   {</span>
<a href="#l92.12"></a><span id="l92.12" class="difflineminus">-    PRUint64 messageOffset;</span>
<a href="#l92.13"></a><span id="l92.13" class="difflineplus">+    PRInt64 messageOffset;</span>
<a href="#l92.14"></a><span id="l92.14">     PRUint32 messageSize;</span>
<a href="#l92.15"></a><span id="l92.15">     folder-&gt;GetOfflineFileStream(key, &amp;messageOffset, &amp;messageSize, getter_AddRefs(inputStream));</span>
<a href="#l92.16"></a><span id="l92.16">     if (inputStream)</span>
<a href="#l92.17"></a><span id="l92.17">       return MsgStreamMsgHeaders(inputStream, aConsumer);</span>
<a href="#l92.18"></a><span id="l92.18">   }</span>
<a href="#l92.19"></a><span id="l92.19">   nsCAutoString urlStr;</span>
<a href="#l92.20"></a><span id="l92.20">   rv = CreateMessageIDURL(folder, key, getter_Copies(urlStr));</span>
<a href="#l92.21"></a><span id="l92.21">   NS_ENSURE_SUCCESS(rv, rv);</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l93.1"></a><span id="l93.1" class="difflineminus">--- a/mailnews/test/fakeserver/imapd.js</span>
<a href="#l93.2"></a><span id="l93.2" class="difflineplus">+++ b/mailnews/test/fakeserver/imapd.js</span>
<a href="#l93.3"></a><span id="l93.3" class="difflineat">@@ -660,16 +660,17 @@ IMAP_RFC3501_handler.prototype = {</span>
<a href="#l93.4"></a><span id="l93.4">   kUidCommands : [&quot;FETCH&quot;, &quot;STORE&quot;, &quot;SEARCH&quot;, &quot;COPY&quot;],</span>
<a href="#l93.5"></a><span id="l93.5"> </span>
<a href="#l93.6"></a><span id="l93.6">   resetTest : function() {</span>
<a href="#l93.7"></a><span id="l93.7">     this._state = IMAP_STATE_NOT_AUTHED;</span>
<a href="#l93.8"></a><span id="l93.8">     this._multiline = false;</span>
<a href="#l93.9"></a><span id="l93.9">     this._nextAuthFunction = undefined; // should be in RFC2195_ext, but too lazy</span>
<a href="#l93.10"></a><span id="l93.10">   },</span>
<a href="#l93.11"></a><span id="l93.11">   onStartup : function () {</span>
<a href="#l93.12"></a><span id="l93.12" class="difflineplus">+    this._state = IMAP_STATE_NOT_AUTHED;</span>
<a href="#l93.13"></a><span id="l93.13">     return &quot;* OK IMAP4rev1 Fakeserver started up&quot;;</span>
<a href="#l93.14"></a><span id="l93.14">   },</span>
<a href="#l93.15"></a><span id="l93.15"> </span>
<a href="#l93.16"></a><span id="l93.16">   ////////////////////////////////////</span>
<a href="#l93.17"></a><span id="l93.17">   // CENTRALIZED DISPATCH FUNCTIONS //</span>
<a href="#l93.18"></a><span id="l93.18">   ////////////////////////////////////</span>
<a href="#l93.19"></a><span id="l93.19"> </span>
<a href="#l93.20"></a><span id="l93.20">   // IMAP sends commands in the form of &quot;tag command args&quot;, but fakeserver</span></pre></div><div class="diffblock"><pre class="sourcelines">
<a href="#l94.1"></a><span id="l94.1" class="difflineminus">--- a/mailnews/test/resources/mailTestUtils.js</span>
<a href="#l94.2"></a><span id="l94.2" class="difflineplus">+++ b/mailnews/test/resources/mailTestUtils.js</span>
<a href="#l94.3"></a><span id="l94.3" class="difflineat">@@ -50,38 +50,39 @@ Components.utils.import(&quot;resource://gre/</span>
<a href="#l94.4"></a><span id="l94.4"> // Services</span>
<a href="#l94.5"></a><span id="l94.5"> Components.utils.import(&quot;resource://gre/modules/Services.jsm&quot;);</span>
<a href="#l94.6"></a><span id="l94.6"> // MailServices</span>
<a href="#l94.7"></a><span id="l94.7"> Components.utils.import(&quot;resource:///modules/mailServices.js&quot;);</span>
<a href="#l94.8"></a><span id="l94.8"> </span>
<a href="#l94.9"></a><span id="l94.9"> // Local Mail Folders. Requires prior setup of profile directory</span>
<a href="#l94.10"></a><span id="l94.10"> </span>
<a href="#l94.11"></a><span id="l94.11"> var gLocalIncomingServer;</span>
<a href="#l94.12"></a><span id="l94.12" class="difflineplus">+var gLocalRootFolder;</span>
<a href="#l94.13"></a><span id="l94.13"> var gLocalMsgAccount;</span>
<a href="#l94.14"></a><span id="l94.14"> var gLocalInboxFolder;</span>
<a href="#l94.15"></a><span id="l94.15"> var _localAccountInitialized = false;</span>
<a href="#l94.16"></a><span id="l94.16"> </span>
<a href="#l94.17"></a><span id="l94.17"> function loadLocalMailAccount()</span>
<a href="#l94.18"></a><span id="l94.18"> {</span>
<a href="#l94.19"></a><span id="l94.19">   // This function is idempotent</span>
<a href="#l94.20"></a><span id="l94.20">   if (_localAccountInitialized)</span>
<a href="#l94.21"></a><span id="l94.21">     return;</span>
<a href="#l94.22"></a><span id="l94.22">   </span>
<a href="#l94.23"></a><span id="l94.23">   MailServices.accounts.createLocalMailAccount();</span>
<a href="#l94.24"></a><span id="l94.24"> </span>
<a href="#l94.25"></a><span id="l94.25">   gLocalIncomingServer = MailServices.accounts.localFoldersServer;</span>
<a href="#l94.26"></a><span id="l94.26">   gLocalMsgAccount = MailServices.accounts.FindAccountForServer(</span>
<a href="#l94.27"></a><span id="l94.27">     gLocalIncomingServer);</span>
<a href="#l94.28"></a><span id="l94.28"> </span>
<a href="#l94.29"></a><span id="l94.29" class="difflineminus">-  var rootFolder = gLocalIncomingServer.rootMsgFolder</span>
<a href="#l94.30"></a><span id="l94.30" class="difflineplus">+  gLocalRootFolder = gLocalIncomingServer.rootMsgFolder</span>
<a href="#l94.31"></a><span id="l94.31">                      .QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l94.32"></a><span id="l94.32"> </span>
<a href="#l94.33"></a><span id="l94.33">   // Note: Inbox is not created automatically when there is no deferred server,</span>
<a href="#l94.34"></a><span id="l94.34">   // so we need to create it.</span>
<a href="#l94.35"></a><span id="l94.35" class="difflineminus">-  gLocalInboxFolder = rootFolder.createLocalSubfolder(&quot;Inbox&quot;)</span>
<a href="#l94.36"></a><span id="l94.36" class="difflineplus">+  gLocalInboxFolder = gLocalRootFolder.createLocalSubfolder(&quot;Inbox&quot;)</span>
<a href="#l94.37"></a><span id="l94.37">                        .QueryInterface(Ci.nsIMsgLocalMailFolder);</span>
<a href="#l94.38"></a><span id="l94.38">   // a local inbox should have a Mail flag!</span>
<a href="#l94.39"></a><span id="l94.39">   gLocalInboxFolder.setFlag(Ci.nsMsgFolderFlags.Mail);</span>
<a href="#l94.40"></a><span id="l94.40"> </span>
<a href="#l94.41"></a><span id="l94.41">   // Force an initialization of the Inbox folder database.</span>
<a href="#l94.42"></a><span id="l94.42">   var folderName = gLocalInboxFolder.prettiestName;</span>
<a href="#l94.43"></a><span id="l94.43"> </span>
<a href="#l94.44"></a><span id="l94.44">   _localAccountInitialized = true;</span>
<a href="#l94.45"></a><span id="l94.45" class="difflineat">@@ -223,68 +224,16 @@ var btoa = IOUtils.btoa;</span>
<a href="#l94.46"></a><span id="l94.46"> function firstMsgHdr(folder)</span>
<a href="#l94.47"></a><span id="l94.47"> {</span>
<a href="#l94.48"></a><span id="l94.48">   let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l94.49"></a><span id="l94.49">   if (enumerator.hasMoreElements())</span>
<a href="#l94.50"></a><span id="l94.50">     return enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l94.51"></a><span id="l94.51">   return null;</span>
<a href="#l94.52"></a><span id="l94.52"> }</span>
<a href="#l94.53"></a><span id="l94.53"> </span>
<a href="#l94.54"></a><span id="l94.54" class="difflineminus">-// Loads a message to a string</span>
<a href="#l94.55"></a><span id="l94.55" class="difflineminus">-// If aCharset is specified, treats the file as being of that charset</span>
<a href="#l94.56"></a><span id="l94.56" class="difflineminus">-function loadMessageToString(aFolder, aMsgHdr, aCharset)</span>
<a href="#l94.57"></a><span id="l94.57" class="difflineminus">-{</span>
<a href="#l94.58"></a><span id="l94.58" class="difflineminus">-  var data = &quot;&quot;;</span>
<a href="#l94.59"></a><span id="l94.59" class="difflineminus">-  let offset = aMsgHdr.messageOffset;</span>
<a href="#l94.60"></a><span id="l94.60" class="difflineminus">-  let bytesLeft = aMsgHdr.messageSize;</span>
<a href="#l94.61"></a><span id="l94.61" class="difflineminus">-  var fstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l94.62"></a><span id="l94.62" class="difflineminus">-                  .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l94.63"></a><span id="l94.63" class="difflineminus">-  fstream.init(aFolder.filePath, -1, 0, 0);</span>
<a href="#l94.64"></a><span id="l94.64" class="difflineminus">-  let seekableStream = fstream.QueryInterface(Ci.nsISeekableStream);</span>
<a href="#l94.65"></a><span id="l94.65" class="difflineminus">-  seekableStream.seek(Ci.nsISeekableStream.NS_SEEK_SET, offset);</span>
<a href="#l94.66"></a><span id="l94.66" class="difflineminus">-  if (aCharset)</span>
<a href="#l94.67"></a><span id="l94.67" class="difflineminus">-  {</span>
<a href="#l94.68"></a><span id="l94.68" class="difflineminus">-    let cstream = Cc[&quot;@mozilla.org/intl/converter-input-stream;1&quot;]</span>
<a href="#l94.69"></a><span id="l94.69" class="difflineminus">-                    .createInstance(Ci.nsIConverterInputStream);</span>
<a href="#l94.70"></a><span id="l94.70" class="difflineminus">-    cstream.init(stream, aCharset, 4096, 0x0000);</span>
<a href="#l94.71"></a><span id="l94.71" class="difflineminus">-    let str = {};</span>
<a href="#l94.72"></a><span id="l94.72" class="difflineminus">-    let bytesToRead = Math.min(bytesLeft, 4096);</span>
<a href="#l94.73"></a><span id="l94.73" class="difflineminus">-    while (cstream.readString(bytesToRead, str) != 0) {</span>
<a href="#l94.74"></a><span id="l94.74" class="difflineminus">-      data += str.value;</span>
<a href="#l94.75"></a><span id="l94.75" class="difflineminus">-      bytesLeft -= bytesToRead;</span>
<a href="#l94.76"></a><span id="l94.76" class="difflineminus">-      if (bytesLeft &lt;= 0)</span>
<a href="#l94.77"></a><span id="l94.77" class="difflineminus">-        break;</span>
<a href="#l94.78"></a><span id="l94.78" class="difflineminus">-      bytesToRead = Math.min(bytesLeft, 4096);</span>
<a href="#l94.79"></a><span id="l94.79" class="difflineminus">-    }</span>
<a href="#l94.80"></a><span id="l94.80" class="difflineminus">-    cstream.close();</span>
<a href="#l94.81"></a><span id="l94.81" class="difflineminus">-  }</span>
<a href="#l94.82"></a><span id="l94.82" class="difflineminus">-  else</span>
<a href="#l94.83"></a><span id="l94.83" class="difflineminus">-  {</span>
<a href="#l94.84"></a><span id="l94.84" class="difflineminus">-    var sstream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l94.85"></a><span id="l94.85" class="difflineminus">-                    .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l94.86"></a><span id="l94.86" class="difflineminus">-</span>
<a href="#l94.87"></a><span id="l94.87" class="difflineminus">-    sstream.init(fstream);</span>
<a href="#l94.88"></a><span id="l94.88" class="difflineminus">-</span>
<a href="#l94.89"></a><span id="l94.89" class="difflineminus">-    let bytesToRead = Math.min(bytesLeft, 4096);</span>
<a href="#l94.90"></a><span id="l94.90" class="difflineminus">-    var str = sstream.read(bytesToRead);</span>
<a href="#l94.91"></a><span id="l94.91" class="difflineminus">-    bytesLeft -= bytesToRead;</span>
<a href="#l94.92"></a><span id="l94.92" class="difflineminus">-    while (str.length &gt; 0) {</span>
<a href="#l94.93"></a><span id="l94.93" class="difflineminus">-      data += str;</span>
<a href="#l94.94"></a><span id="l94.94" class="difflineminus">-      if (bytesLeft &lt;= 0)</span>
<a href="#l94.95"></a><span id="l94.95" class="difflineminus">-        break;</span>
<a href="#l94.96"></a><span id="l94.96" class="difflineminus">-      bytesToRead = Math.min(bytesLeft, 4096);</span>
<a href="#l94.97"></a><span id="l94.97" class="difflineminus">-      str = sstream.read(bytesToRead);</span>
<a href="#l94.98"></a><span id="l94.98" class="difflineminus">-      bytesLeft -= bytesToRead;</span>
<a href="#l94.99"></a><span id="l94.99" class="difflineminus">-    }</span>
<a href="#l94.100"></a><span id="l94.100" class="difflineminus">-    sstream.close();</span>
<a href="#l94.101"></a><span id="l94.101" class="difflineminus">-  }</span>
<a href="#l94.102"></a><span id="l94.102" class="difflineminus">-  fstream.close();</span>
<a href="#l94.103"></a><span id="l94.103" class="difflineminus">-  return data;</span>
<a href="#l94.104"></a><span id="l94.104" class="difflineminus">-}</span>
<a href="#l94.105"></a><span id="l94.105" class="difflineminus">-</span>
<a href="#l94.106"></a><span id="l94.106"> // Loads a file to a string</span>
<a href="#l94.107"></a><span id="l94.107"> // If aCharset is specified, treats the file as being of that charset</span>
<a href="#l94.108"></a><span id="l94.108"> function loadFileToString(aFile, aCharset) {</span>
<a href="#l94.109"></a><span id="l94.109">   var data = &quot;&quot;;</span>
<a href="#l94.110"></a><span id="l94.110">   var fstream = Cc[&quot;@mozilla.org/network/file-input-stream;1&quot;]</span>
<a href="#l94.111"></a><span id="l94.111">                   .createInstance(Ci.nsIFileInputStream);</span>
<a href="#l94.112"></a><span id="l94.112">   fstream.init(aFile, -1, 0, 0);</span>
<a href="#l94.113"></a><span id="l94.113"> </span>
<a href="#l94.114"></a><span id="l94.114" class="difflineat">@@ -315,16 +264,74 @@ function loadFileToString(aFile, aCharse</span>
<a href="#l94.115"></a><span id="l94.115">     sstream.close();</span>
<a href="#l94.116"></a><span id="l94.116">   }</span>
<a href="#l94.117"></a><span id="l94.117"> </span>
<a href="#l94.118"></a><span id="l94.118">   fstream.close();</span>
<a href="#l94.119"></a><span id="l94.119"> </span>
<a href="#l94.120"></a><span id="l94.120">   return data;</span>
<a href="#l94.121"></a><span id="l94.121"> }</span>
<a href="#l94.122"></a><span id="l94.122"> </span>
<a href="#l94.123"></a><span id="l94.123" class="difflineplus">+// Gets the first message header in a folder.</span>
<a href="#l94.124"></a><span id="l94.124" class="difflineplus">+function firstMsgHdr(folder)</span>
<a href="#l94.125"></a><span id="l94.125" class="difflineplus">+{</span>
<a href="#l94.126"></a><span id="l94.126" class="difflineplus">+  let enumerator = folder.msgDatabase.EnumerateMessages();</span>
<a href="#l94.127"></a><span id="l94.127" class="difflineplus">+  if (enumerator.hasMoreElements())</span>
<a href="#l94.128"></a><span id="l94.128" class="difflineplus">+    return enumerator.getNext().QueryInterface(Ci.nsIMsgDBHdr);</span>
<a href="#l94.129"></a><span id="l94.129" class="difflineplus">+  return null;</span>
<a href="#l94.130"></a><span id="l94.130" class="difflineplus">+}</span>
<a href="#l94.131"></a><span id="l94.131" class="difflineplus">+</span>
<a href="#l94.132"></a><span id="l94.132" class="difflineplus">+// Loads a message to a string</span>
<a href="#l94.133"></a><span id="l94.133" class="difflineplus">+// If aCharset is specified, treats the file as being of that charset</span>
<a href="#l94.134"></a><span id="l94.134" class="difflineplus">+function loadMessageToString(aFolder, aMsgHdr, aCharset)</span>
<a href="#l94.135"></a><span id="l94.135" class="difflineplus">+{</span>
<a href="#l94.136"></a><span id="l94.136" class="difflineplus">+  var data = &quot;&quot;;</span>
<a href="#l94.137"></a><span id="l94.137" class="difflineplus">+  let reusable = new Object;</span>
<a href="#l94.138"></a><span id="l94.138" class="difflineplus">+  let bytesLeft = aMsgHdr.messageSize;</span>
<a href="#l94.139"></a><span id="l94.139" class="difflineplus">+  let stream = aFolder.getMsgInputStream(aMsgHdr, reusable);</span>
<a href="#l94.140"></a><span id="l94.140" class="difflineplus">+  if (aCharset)</span>
<a href="#l94.141"></a><span id="l94.141" class="difflineplus">+  {</span>
<a href="#l94.142"></a><span id="l94.142" class="difflineplus">+    let cstream = Cc[&quot;@mozilla.org/intl/converter-input-stream;1&quot;]</span>
<a href="#l94.143"></a><span id="l94.143" class="difflineplus">+                    .createInstance(Ci.nsIConverterInputStream);</span>
<a href="#l94.144"></a><span id="l94.144" class="difflineplus">+    cstream.init(stream, aCharset, 4096, 0x0000);</span>
<a href="#l94.145"></a><span id="l94.145" class="difflineplus">+    let str = {};</span>
<a href="#l94.146"></a><span id="l94.146" class="difflineplus">+    let bytesToRead = Math.min(bytesLeft, 4096);</span>
<a href="#l94.147"></a><span id="l94.147" class="difflineplus">+    while (cstream.readString(bytesToRead, str) != 0) {</span>
<a href="#l94.148"></a><span id="l94.148" class="difflineplus">+      data += str.value;</span>
<a href="#l94.149"></a><span id="l94.149" class="difflineplus">+      bytesLeft -= bytesToRead;</span>
<a href="#l94.150"></a><span id="l94.150" class="difflineplus">+      if (bytesLeft &lt;= 0)</span>
<a href="#l94.151"></a><span id="l94.151" class="difflineplus">+        break;</span>
<a href="#l94.152"></a><span id="l94.152" class="difflineplus">+      bytesToRead = Math.min(bytesLeft, 4096);</span>
<a href="#l94.153"></a><span id="l94.153" class="difflineplus">+    }</span>
<a href="#l94.154"></a><span id="l94.154" class="difflineplus">+    cstream.close();</span>
<a href="#l94.155"></a><span id="l94.155" class="difflineplus">+  }</span>
<a href="#l94.156"></a><span id="l94.156" class="difflineplus">+  else</span>
<a href="#l94.157"></a><span id="l94.157" class="difflineplus">+  {</span>
<a href="#l94.158"></a><span id="l94.158" class="difflineplus">+    var sstream = Cc[&quot;@mozilla.org/scriptableinputstream;1&quot;]</span>
<a href="#l94.159"></a><span id="l94.159" class="difflineplus">+                    .createInstance(Ci.nsIScriptableInputStream);</span>
<a href="#l94.160"></a><span id="l94.160" class="difflineplus">+</span>
<a href="#l94.161"></a><span id="l94.161" class="difflineplus">+    sstream.init(stream);</span>
<a href="#l94.162"></a><span id="l94.162" class="difflineplus">+</span>
<a href="#l94.163"></a><span id="l94.163" class="difflineplus">+    let bytesToRead = Math.min(bytesLeft, 4096);</span>
<a href="#l94.164"></a><span id="l94.164" class="difflineplus">+    var str = sstream.read(bytesToRead);</span>
<a href="#l94.165"></a><span id="l94.165" class="difflineplus">+    bytesLeft -= bytesToRead;</span>
<a href="#l94.166"></a><span id="l94.166" class="difflineplus">+    while (str.length &gt; 0) {</span>
<a href="#l94.167"></a><span id="l94.167" class="difflineplus">+      data += str;</span>
<a href="#l94.168"></a><span id="l94.168" class="difflineplus">+      if (bytesLeft &lt;= 0)</span>
<a href="#l94.169"></a><span id="l94.169" class="difflineplus">+        break;</span>
<a href="#l94.170"></a><span id="l94.170" class="difflineplus">+      bytesToRead = Math.min(bytesLeft, 4096);</span>
<a href="#l94.171"></a><span id="l94.171" class="difflineplus">+      str = sstream.read(bytesToRead);</span>
<a href="#l94.172"></a><span id="l94.172" class="difflineplus">+      bytesLeft -= bytesToRead;</span>
<a href="#l94.173"></a><span id="l94.173" class="difflineplus">+    }</span>
<a href="#l94.174"></a><span id="l94.174" class="difflineplus">+    sstream.close();</span>
<a href="#l94.175"></a><span id="l94.175" class="difflineplus">+  }</span>
<a href="#l94.176"></a><span id="l94.176" class="difflineplus">+  stream.close();</span>
<a href="#l94.177"></a><span id="l94.177" class="difflineplus">+</span>
<a href="#l94.178"></a><span id="l94.178" class="difflineplus">+  return data;</span>
<a href="#l94.179"></a><span id="l94.179" class="difflineplus">+}</span>
<a href="#l94.180"></a><span id="l94.180" class="difflineplus">+</span>
<a href="#l94.181"></a><span id="l94.181"> /**</span>
<a href="#l94.182"></a><span id="l94.182">  * Return the file system a particular file is on. Currently only supported on</span>
<a href="#l94.183"></a><span id="l94.183">  * Windows.</span>
<a href="#l94.184"></a><span id="l94.184">  *</span>
<a href="#l94.185"></a><span id="l94.185">  * @param aFile The file to get the file system for.</span>
<a href="#l94.186"></a><span id="l94.186">  */</span>
<a href="#l94.187"></a><span id="l94.187"> function get_file_system(aFile) {</span>
<a href="#l94.188"></a><span id="l94.188">   if (!(&quot;@mozilla.org/windows-registry-key;1&quot; in Cc))</span></pre></div></div>

<div class="page_footer">
<div class="page_footer_text">comm-central</div>
<div class="page_footer_text" style="padding-left: 10px">Deployed from <a href="https://hg.mozilla.org/hgcustom/version-control-tools/rev/35f393d6769a">35f393d6769a</a> at 2020-07-16T17:23:43Z.</div>
<div class="rss_logo">
<a href="/comm-central/rss-log">RSS</a>
<a href="/comm-central/atom-log">Atom</a>
</div>
<br />

</div>
</body>
</html>

